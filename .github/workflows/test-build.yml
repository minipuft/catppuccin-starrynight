name: ğŸ§ª Test Build

on:
  workflow_dispatch:

jobs:
  test-build:
    name: ğŸ§ª Test Build Process
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
          
          # Check installations
          echo "âœ… Node version: $(node --version)"
          echo "âœ… NPM version: $(npm --version)"
          echo "âœ… SASS version: $(npx sass --version)"
          
          # Check key files exist
          echo "ğŸ” Checking key files:"
          ls -la app.scss || echo "âŒ Missing app.scss"
          ls -la package.json || echo "âŒ Missing package.json"
          ls -la src-js/theme.entry.ts || echo "âŒ Missing theme.entry.ts"
      
      - name: ğŸ—ï¸ Test Build Components
        run: |
          echo "ğŸ—ï¸ Testing build components separately..."
          
          # Test CSS build
          echo "ğŸ¨ Testing CSS build..."
          if npx sass app.scss user.css --style=compressed; then
            echo "âœ… CSS build successful"
            ls -la user.css
          else
            echo "âŒ CSS build failed"
            exit 1
          fi
          
          # Test TypeScript check
          echo "ğŸ” Testing TypeScript check..."
          if npm run typecheck; then
            echo "âœ… TypeScript check successful"
          else
            echo "âŒ TypeScript check failed"
            exit 1
          fi
          
          # Test JavaScript build
          echo "ğŸ“¦ Testing JavaScript build..."
          if npx esbuild src-js/theme.entry.ts --bundle --outfile=theme.js --format=iife --target=es2020 --external:react --external:react-dom --loader:.fs=text; then
            echo "âœ… JavaScript build successful"
            ls -la theme.js
          else
            echo "âŒ JavaScript build failed"
            exit 1
          fi
      
      - name: ğŸ¯ Test Full Build
        run: |
          echo "ğŸ¯ Testing full build command..."
          rm -f theme.js user.css
          
          if npm run build:ci; then
            echo "âœ… Full build successful"
            echo "ğŸ“Š Build artifacts:"
            ls -la theme.js user.css
            echo "ğŸ“ File sizes:"
            du -h theme.js user.css
          else
            echo "âŒ Full build failed"
            exit 1
          fi