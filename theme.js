"use strict";(()=>{var Po=Object.create;var la=Object.defineProperty;var xo=Object.getOwnPropertyDescriptor;var Ao=Object.getOwnPropertyNames;var Io=Object.getPrototypeOf,Do=Object.prototype.hasOwnProperty;var Yr=(l=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(l,{get:(t,e)=>(typeof require<"u"?require:t)[e]}):l)(function(l){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+l+'" is not supported')});var y=(l,t)=>()=>(l&&(t=l(l=0)),t);var te=(l,t)=>{for(var e in t)la(l,e,{get:t[e],enumerable:!0})},Lo=(l,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of Ao(t))!Do.call(l,a)&&a!==e&&la(l,a,{get:()=>t[a],enumerable:!(i=xo(t,a))||i.enumerable});return l};var jr=(l,t,e)=>(e=l!=null?Po(Io(l)):{},Lo(t||!l||!l.__esModule?la(e,"default",{value:l,enumerable:!0}):e,l));var Kr,Qr,lt,ca=y(()=>{"use strict";Kr={latte:{name:"Latte",base:"#eff1f5",text:"#4c4f69",isDark:!1},frappe:{name:"Frapp\xE9",base:"#303446",text:"#c6d0f5",isDark:!0},macchiato:{name:"Macchiato",base:"#24273a",text:"#cad3f5",isDark:!0},mocha:{name:"Mocha",base:"#1e1e2e",text:"#cdd6f4",isDark:!0}},Qr=["rosewater","flamingo","pink","mauve","red","maroon","peach","yellow","green","teal","sky","sapphire","blue","lavender","text","none"],lt={flavor:l=>typeof l=="string"&&l in Kr,accentColor:l=>typeof l=="string"&&Qr.includes(l),brightnessMode:l=>typeof l=="string"&&["bright","balanced","dark"].includes(l),paletteSystem:l=>typeof l=="string"&&["catppuccin","year3000"].includes(l),gradientIntensity:l=>typeof l=="string"&&["disabled","minimal","balanced","intense"].includes(l),glassmorphismLevel:l=>typeof l=="string"&&["disabled","minimal","moderate","intense"].includes(l),webglEnabled:l=>typeof l=="boolean"||typeof l=="string"&&["true","false"].includes(l),animationQuality:l=>typeof l=="string"&&["auto","low","high"].includes(l),webglQuality:l=>typeof l=="string"&&["low","medium","high"].includes(l)}});var vt,ua,ma,ct,Xt=y(()=>{"use strict";vt={"analogous-flow":{rule:"analogous",angle:30,description:"Flowing cinematic gradients with adjacent hues"},"triadic-trinity":{rule:"triadic",angle:120,description:"Dramatic three-color gradient dynamics"},"complementary-yin-yang":{rule:"complementary",angle:180,description:"Electric contrast gradients with opposing forces"},"tetradic-advanced-cross":{rule:"tetradic",angle:90,description:"Complex four-color gradient matrix"},"split-complementary-spectrum":{rule:"split-complementary",angle:150,description:"Spectrum-like gradient flows with polar contrasts"},"monochromatic-calm":{rule:"monochromatic",angle:0,description:"Intense single-hue gradient depth"}},ua={energyScaling:{low:.8,medium:1.2,high:1.8},valenceScaling:{sad:1,neutral:1.2,happy:1.6},danceabilityEffects:{enable:!0,animationSpeedMultiplier:1.5,blurVariation:.3}},ma={enable:!0,useSmartCalculation:!0,useRealisticData:!0,danceabilityEstimation:{highDance:{min:120,max:140,value:.8},mediumDance:{min:100,max:160,value:.6},lowMediumDance:{min:80,max:180,value:.4},lowDance:{value:.2}},energyEstimation:{tempoWeight:.6,loudnessWeight:.4,tempoRange:{min:60,max:180},loudnessRange:{min:-60,max:0}},danceabilityThresholds:{high:.7,low:.3},energyMultiplierRange:{min:.8,max:1.4},tempoMultipliers:{highDance:1,mediumDance:.75,lowDance:.5},fallbacks:{tempo:120,loudness:-10,danceability:.5,energy:.5,key:0,timeSignature:4}},ct={...vt,"tetradic-cosmic-cross":vt["tetradic-advanced-cross"],"split-complementary-aurora":vt["split-complementary-spectrum"],"monochromatic-meditation":vt["monochromatic-calm"]}});var Le,Zt=y(()=>{"use strict";Le={"corporate-safe":{displayName:"Corporate Safe",description:"Subtle gradient elegance with professional restraint and refined color transitions",philosophy:"Gentle gradient flows that maintain workspace harmony while providing sophisticated visual depth",multipliers:{opacity:.2,saturation:1.15,brightness:1.08,contrast:1.05,musicEnergyBoost:.4,animationIntensity:.3,timeBasedEffectFactor:.2,interactionStrength:.2,advancedAnimations:!1,visualIntensityBase:.9,kineticIntensity:.3,timeBasedPlayFactor:.2,aestheticGravityStrength:.2,emergentChoreography:!1},features:{rippleEffects:!1,timeBasedEcho:!1,particleStreams:!1,predictiveHighlights:!0,glassEffects:!0,beatSync:!1,colorHarmony:!1,userInteractions:!1,aestheticGravity:!1},performance:{maxParticles:0,animationThrottle:32,enableGPUAcceleration:!1,reducedMotion:!0}},"artist-vision":{displayName:"Artist Vision",description:"Cinematic gradient expression with vibrant, flowing color transitions",philosophy:"Dramatic gradient harmonies that create depth and emotional resonance through bold color interactions",multipliers:{opacity:.35,saturation:1.45,brightness:1.25,contrast:1.3,musicEnergyBoost:1.2,animationIntensity:.8,timeBasedEffectFactor:.7,interactionStrength:.6,advancedAnimations:!0,visualIntensityBase:1.2,kineticIntensity:.8,timeBasedPlayFactor:.7,aestheticGravityStrength:.6,emergentChoreography:!0},features:{rippleEffects:!0,timeBasedEcho:!0,particleStreams:!0,predictiveHighlights:!0,glassEffects:!0,beatSync:!0,colorHarmony:!0,userInteractions:!0,aestheticGravity:!0},performance:{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1}},"advanced-maximum":{displayName:"Advanced Maximum",description:"Ultra-intense cinematic gradients with maximum color saturation and fluid dynamics",philosophy:"Maximum gradient intensity through electric color combinations that create immersive visual landscapes",multipliers:{opacity:.55,saturation:1.65,brightness:1.35,contrast:1.5,musicEnergyBoost:2.5,animationIntensity:2,timeBasedEffectFactor:3,interactionStrength:2,advancedAnimations:!0,visualIntensityBase:1.8,kineticIntensity:2,timeBasedPlayFactor:3,aestheticGravityStrength:2,emergentChoreography:!0},features:{rippleEffects:!0,timeBasedEcho:!0,particleStreams:!0,predictiveHighlights:!0,glassEffects:!0,beatSync:!0,colorHarmony:!0,userInteractions:!0,aestheticGravity:!0},performance:{maxParticles:50,animationThrottle:30,enableGPUAcceleration:!0,reducedMotion:!1}}};Le["cosmic-maximum"]={...Le["advanced-maximum"],displayName:"Cosmic Maximum",description:"Ultra-intense cinematic gradients with maximum color saturation and fluid dynamics",philosophy:"Maximum gradient intensity through electric color combinations that create immersive visual landscapes"}});var Jt,da,ha=y(()=>{"use strict";Jt={low:{maxParticles:15,animationThrottle:32,enableGPUAcceleration:!1,enableAdvancedShaders:!1,textureResolution:.5},balanced:{maxParticles:40,animationThrottle:16,enableGPUAcceleration:!0,enableAdvancedShaders:!1,textureResolution:1},high:{maxParticles:75,animationThrottle:16,enableGPUAcceleration:!0,enableAdvancedShaders:!0,textureResolution:1},ultra:{maxParticles:150,animationThrottle:8,enableGPUAcceleration:!0,enableAdvancedShaders:!0,textureResolution:2}},da={level:"info",performance:{enableFrameBudgetWarnings:!0,throttleWarnings:!0,throttleInterval:5e3,enableAdaptiveDegradation:!0}}});var Xr,Zr,Jr,ei=y(()=>{"use strict";Xr="sn-harmonic-intensity",Zr="sn-harmonic-evolution",Jr="sn-glassmorphism-level"});function ti(l,t){return be[l].validator(t)}function ii(l,t){let e=be[l];return e.parser?e.parser(t):e.validator(t)?t:null}function ga(l,t){let e=be[l];return e.serializer?e.serializer(t):String(t)}function ai(l){return be[l].defaultValue}function Ct(){return Object.keys(be)}function ri(l){return l in be}var be,pa=y(()=>{"use strict";Xt();Zt();ca();be={"catppuccin-flavor":{defaultValue:"mocha",validator:lt.flavor,description:"Catppuccin color theme variant",category:"core"},"catppuccin-accentColor":{defaultValue:"mauve",validator:lt.accentColor,description:"Primary accent color for UI elements",category:"core"},"sn-brightness-mode":{defaultValue:"bright",validator:lt.brightnessMode,description:"Overall theme brightness level",category:"core"},"sn-palette-system":{defaultValue:"catppuccin",validator:lt.paletteSystem,description:"Color palette system (Catppuccin or Year 3000)",category:"advanced"},"sn-artistic-mode":{defaultValue:"artist-vision",validator:l=>typeof l=="string"&&l in Le,description:"Visual intensity and behavior preset",category:"advanced"},"sn-current-harmonic-mode":{defaultValue:"analogous-flow",validator:l=>typeof l=="string"&&l in ct,description:"Color harmony rule for music synchronization",category:"advanced"},"sn-harmonic-intensity":{defaultValue:.7,validator:l=>typeof l=="number"&&l>=0&&l<=1,parser:l=>{let t=parseFloat(l);return!isNaN(t)&&t>=0&&t<=1?t:null},serializer:l=>l.toString(),description:"Intensity of color harmony effects (0-1)",category:"advanced"},"sn-harmonic-evolution":{defaultValue:!0,validator:l=>typeof l=="boolean",parser:l=>l==="true"?!0:l==="false"?!1:null,serializer:l=>l.toString(),description:"Enable dynamic color harmony evolution",category:"advanced"},"sn-gradient-intensity":{defaultValue:"balanced",validator:l=>typeof l=="string"&&["disabled","minimal","balanced","intense"].includes(l),description:"Master control for all gradient background effects",category:"visual"},"sn-glassmorphism-level":{defaultValue:"balanced",validator:l=>typeof l=="string"&&["disabled","minimal","balanced","intense"].includes(l),description:"Glass-like transparency effects intensity",category:"visual"},"sn-webgl-enabled":{defaultValue:!0,validator:l=>typeof l=="boolean",parser:l=>l==="true"?!0:l==="false"?!1:null,serializer:l=>l.toString(),description:"Enable WebGL-accelerated visual effects",category:"performance"},"sn-animation-quality":{defaultValue:"auto",validator:l=>typeof l=="string"&&["auto","low","high"].includes(l),description:"Animation performance vs quality balance",category:"performance"},"sn-webgl-quality":{defaultValue:"medium",validator:l=>typeof l=="string"&&["low","medium","high"].includes(l),description:"WebGL rendering quality level",category:"performance"}}});var Et,fa=y(()=>{"use strict";pa();Et=class{constructor(t){this.changeListeners=new Set;this.cache=new Map;this.storage=t}get(t){if(this.cache.has(t))return this.cache.get(t);let e=be[t],i=this.storage.get(t);if(i==null){let r=e.defaultValue;return this.cache.set(t,r),r}let a=ii(t,i);if(a===null){console.warn(`[TypedSettingsManager] Invalid stored value for ${t}: "${i}", using default`);let r=e.defaultValue;return this.cache.set(t,r),r}return this.cache.set(t,a),a}set(t,e){if(!ti(t,e))return console.error(`[TypedSettingsManager] Invalid value for ${t}:`,e),!1;let i=this.cache.get(t)??this.get(t),a=ga(t,e),r=this.storage.set(t,a);if(r){this.cache.set(t,e);let n={settingKey:t,oldValue:i,newValue:e,timestamp:Date.now()};this.notifyChangeListeners(n)}return r}getMultiple(t){let e={};for(let i of t)e[i]=this.get(i);return e}setMultiple(t){let e={};for(let[i,a]of Object.entries(t))ri(i)&&(e[i]=this.set(i,a));return e}getAllSettings(){let t={};for(let e of Ct())t[e]=this.get(e);return t}reset(t){let e=ai(t);return this.set(t,e)}resetAll(){let t={};for(let e of Ct())t[e]=this.reset(e);return t}exists(t){return this.storage.get(t)!==null}remove(t){let e=this.storage.remove(t);return e&&this.cache.delete(t),e}clearCache(){this.cache.clear()}onChange(t){this.changeListeners.add(t)}offChange(t){this.changeListeners.delete(t)}notifyChangeListeners(t){for(let e of this.changeListeners)try{e(t)}catch(i){console.error("[TypedSettingsManager] Error in change listener:",i)}}validateAllSettings(){let t={valid:0,invalid:[],missing:[]};for(let e of Ct()){let i=this.storage.get(e);if(i===null){t.missing.push({key:e,usingDefault:ai(e)});continue}ii(e,i)===null?t.invalid.push({key:e,value:i,error:"Failed to parse or validate value"}):t.valid++}return t}export(){return this.getAllSettings()}import(t){let e={imported:0,failed:[]};for(let[i,a]of Object.entries(t)){if(!ri(i)){e.failed.push({key:i,error:"Unknown setting key"});continue}if(!ti(i,a)){e.failed.push({key:i,error:"Invalid value for setting"});continue}this.set(i,a)?e.imported++:e.failed.push({key:i,error:"Failed to store setting"})}return e}}});function ya(){return new Ze}var Ze,ba=y(()=>{"use strict";Ze=class{constructor(){this._available=null}isAvailable(){if(this._available!==null)return this._available;try{return this._available=typeof Spicetify<"u"&&typeof Spicetify.LocalStorage?.get=="function"&&typeof Spicetify.LocalStorage?.set=="function",this._available&&Spicetify.LocalStorage.get("__test__"),this._available}catch(t){return console.warn("[SpicetifyStorageAdapter] Spicetify.LocalStorage not available:",t),this._available=!1,!1}}get(t){if(!this.isAvailable())return console.warn(`[SpicetifyStorageAdapter] Cannot get ${t}: Spicetify not available`),null;try{return Spicetify.LocalStorage.get(t)}catch(e){return console.error(`[SpicetifyStorageAdapter] Error reading key ${t}:`,e),null}}set(t,e){if(!this.isAvailable())return console.warn(`[SpicetifyStorageAdapter] Cannot set ${t}: Spicetify not available`),!1;try{return Spicetify.LocalStorage.set(t,e),!0}catch(i){return console.error(`[SpicetifyStorageAdapter] Error setting key ${t}:`,i),!1}}remove(t){if(!this.isAvailable())return console.warn(`[SpicetifyStorageAdapter] Cannot remove ${t}: Spicetify not available`),!1;try{return typeof Spicetify.LocalStorage.remove=="function"?Spicetify.LocalStorage.remove(t):Spicetify.LocalStorage.set(t,null),!0}catch(e){return console.error(`[SpicetifyStorageAdapter] Error removing key ${t}:`,e),!1}}healthCheck(){let t={available:!1,readable:!1,writable:!1,issues:[]};if(t.available=this.isAvailable(),!t.available)return t.issues.push("Spicetify.LocalStorage not available"),t;try{this.get("__health_check_read__"),t.readable=!0}catch(e){t.issues.push(`Read test failed: ${e}`)}try{let e="__health_check_write__",i="test_"+Date.now();this.set(e,i)?this.get(e)===i?(t.writable=!0,this.remove(e)):t.issues.push("Write-read consistency test failed"):t.issues.push("Write operation failed")}catch(e){t.issues.push(`Write test failed: ${e}`)}return t}getDiagnostics(){let t=[];return typeof Spicetify<"u"&&Spicetify.LocalStorage&&t.push(...Object.getOwnPropertyNames(Spicetify.LocalStorage)),{spicetifyVersion:typeof Spicetify<"u"?Spicetify.version:void 0,apiMethods:t,testResults:this.healthCheck()}}}});function Sa(l){return new ut(l)}var ut,va=y(()=>{"use strict";ut=class{constructor(t="sn-"){this.prefix=t}getPrefixedKey(t){return t.startsWith(this.prefix)?t:`${this.prefix}${t}`}isAvailable(){try{return typeof localStorage<"u"&&localStorage!==null}catch{return!1}}get(t){if(!this.isAvailable())return console.warn(`[BrowserStorageAdapter] localStorage not available for key: ${t}`),null;try{return localStorage.getItem(this.getPrefixedKey(t))}catch(e){return console.error(`[BrowserStorageAdapter] Error reading key ${t}:`,e),null}}set(t,e){if(!this.isAvailable())return console.warn(`[BrowserStorageAdapter] localStorage not available for key: ${t}`),!1;try{return localStorage.setItem(this.getPrefixedKey(t),e),!0}catch(i){return console.error(`[BrowserStorageAdapter] Error setting key ${t}:`,i),!1}}remove(t){if(!this.isAvailable())return console.warn(`[BrowserStorageAdapter] localStorage not available for key: ${t}`),!1;try{return localStorage.removeItem(this.getPrefixedKey(t)),!0}catch(e){return console.error(`[BrowserStorageAdapter] Error removing key ${t}:`,e),!1}}getAllKeys(){if(!this.isAvailable())return[];let t=[];try{for(let e=0;e<localStorage.length;e++){let i=localStorage.key(e);i&&i.startsWith(this.prefix)&&t.push(i.substring(this.prefix.length))}}catch(e){console.error("[BrowserStorageAdapter] Error enumerating keys:",e)}return t}clear(){if(!this.isAvailable())return!1;try{let t=this.getAllKeys();for(let e of t)localStorage.removeItem(this.getPrefixedKey(e));return!0}catch(t){return console.error("[BrowserStorageAdapter] Error clearing storage:",t),!1}}getUsageStats(){let t={totalKeys:0,totalSize:0,avgKeySize:0};if(!this.isAvailable())return t;try{let e=this.getAllKeys();t.totalKeys=e.length;for(let i of e){let a=this.get(i);a!==null&&(t.totalSize+=i.length+a.length)}t.avgKeySize=t.totalKeys>0?t.totalSize/t.totalKeys:0,typeof navigator<"u"&&"storage"in navigator&&"estimate"in navigator.storage&&navigator.storage.estimate().then(i=>{i.quota!==void 0&&(t.availableQuota=i.quota)}).catch(()=>{})}catch(e){console.error("[BrowserStorageAdapter] Error calculating usage stats:",e)}return t}}});function en(){return Ca||(Ca=new ni),Ca}function Je(){return en().getSettings()}var ni,Ca,x,tn=y(()=>{"use strict";fa();ba();va();ni=class{constructor(t){this.storageAdapter=t||this.detectBestStorage(),this.settingsManager=new Et(this.storageAdapter)}detectBestStorage(){let t=ya(),e=t.healthCheck();if(e.available&&e.readable&&e.writable)return console.log("[SettingsProvider] Using Spicetify storage adapter"),t;let i=Sa();return console.log("[SettingsProvider] Using browser storage adapter (localStorage)"),i}getSettings(){return this.settingsManager}getStorage(){return this.storageAdapter}getDiagnostics(){let t=this.storageAdapter instanceof Ze?"spicetify":this.storageAdapter instanceof ut?"browser":"unknown",e=null;return this.storageAdapter instanceof Ze&&(e=this.storageAdapter.healthCheck()),{storageType:t,storageHealth:e,settingsValidation:this.settingsManager.validateAllSettings(),totalSettings:Object.keys(this.settingsManager.getAllSettings()).length}}async migrateFromLegacyStorage(t){console.log("[SettingsProvider] Starting legacy settings migration...");let e=this.settingsManager.import(t);return e.imported>0&&console.log(`[SettingsProvider] Successfully migrated ${e.imported} settings`),e.failed.length>0&&console.warn(`[SettingsProvider] Failed to migrate ${e.failed.length} settings:`,e.failed),{migrated:e.imported,failed:e.failed}}healthCheck(){let t=this.getDiagnostics(),e=t.settingsValidation,i={overall:"healthy",storage:{type:t.storageType,available:!0,issues:[]},settings:{valid:e.valid,invalid:e.invalid.length,missing:e.missing.length},recommendations:[]};return t.storageHealth&&(i.storage.available=t.storageHealth.available,t.storageHealth.issues&&(i.storage.issues=t.storageHealth.issues)),!i.storage.available||i.storage.issues.length>0?(i.overall="unhealthy",i.recommendations.push("Storage system needs attention")):i.settings.invalid>0?(i.overall="degraded",i.recommendations.push("Some settings have invalid values")):i.settings.missing>5&&(i.overall="degraded",i.recommendations.push("Many settings are using defaults")),i.settings.invalid>0&&i.recommendations.push("Run settings validation and repair"),t.storageType==="browser"&&i.recommendations.push("Consider using in Spicetify environment for better integration"),i}},Ca=null;x={get:l=>Je().get(l),set:(l,t)=>Je().set(l,t),reset:l=>Je().reset(l),onChange:l=>Je().onChange(l),export:()=>Je().export(),import:l=>Je().import(l)}});var Se=y(()=>{"use strict";ca();Xt();Zt();ha();ei();fa();pa();tn();ba();va();Se()});var ve,et,M,G=y(()=>{"use strict";Se();Xt();Zt();ha();ve=ct,et=Le,M={enableDebug:!0,enableContextualIntelligence:!0,paletteSystem:"catppuccin",performanceProfiles:Jt,logging:da,healthCheckInterval:1e4,visual:{lightweightParticleSystem:{mode:"artist-vision"},spatialNexusSystem:{mode:"artist-vision"},dataGlyphSystem:{mode:"artist-vision"},beatSyncVisualSystem:{mode:"artist-vision"},behavioralPredictionEngine:{mode:"artist-vision"},predictiveMaterializationSystem:{mode:"artist-vision"},sidebarVisualStateSystem:{mode:"artist-vision"}},enableColorExtraction:!0,enableMusicAnalysis:!0,enableAdvancedSync:!0,musicModulationIntensity:.4,artisticMode:"artist-vision",boundGetCurrentMultipliers:null,boundGetCurrentFeatures:null,boundGetCurrentPerformanceSettings:null,_pendingArtisticMode:null,init(){return this.boundGetCurrentMultipliers=this.getCurrentMultipliers.bind(this),this.boundGetCurrentFeatures=this.getCurrentFeatures.bind(this),this.boundGetCurrentPerformanceSettings=this.getCurrentPerformanceSettings.bind(this),!this.artisticMode||!this.paletteSystem?(this.enableDebug&&console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Loading preferences (current: artistic=${this.artisticMode}, palette=${this.paletteSystem})`),this.loadArtisticPreference()):this.enableDebug&&console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Skipping preference load (current: artistic=${this.artisticMode}, palette=${this.paletteSystem})`),this._pendingArtisticMode&&this.isFullyInitialized()&&(this.enableDebug&&console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Applying pending artistic mode: ${this._pendingArtisticMode}`),this.setArtisticMode(this._pendingArtisticMode),this._pendingArtisticMode=null),this.enableDebug&&console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Initialized with context-bound methods"),this},currentColorHarmonyMode:"analogous-flow",colorHarmonyBaseColor:null,colorHarmonyIntensity:.85,colorHarmonyEvolution:!0,musicVisualSync:{...ua,enhancedBPM:ma},getCurrentModeProfile(){let l=this.artisticMode||"artist-vision";return et[l]||et["artist-vision"]},getCurrentMultipliers(){try{if(typeof this.getCurrentModeProfile!="function")return console.warn("[ADVANCED_SYSTEM_CONFIG] getCurrentModeProfile method not available, using fallback multipliers"),this.artisticMultipliers;let l=this.getCurrentModeProfile();return!l||!l.multipliers?(console.warn("[ADVANCED_SYSTEM_CONFIG] Invalid profile or missing multipliers, using fallback"),this.artisticMultipliers):l.multipliers}catch(l){return console.error("[ADVANCED_SYSTEM_CONFIG] Error in getCurrentMultipliers:",l),this.artisticMultipliers}},getCurrentFeatures(){try{if(typeof this.getCurrentModeProfile!="function")return console.warn("[ADVANCED_SYSTEM_CONFIG] getCurrentModeProfile method not available, using fallback features"),{enableAdvancedEffects:!0,enableHarmony:!0,beatSync:!0,colorHarmony:!0};let l=this.getCurrentModeProfile();return!l||!l.features?(console.warn("[ADVANCED_SYSTEM_CONFIG] Invalid profile or missing features, using fallback"),{enableAdvancedEffects:!0,enableHarmony:!0,beatSync:!0,colorHarmony:!0}):l.features}catch(l){return console.error("[ADVANCED_SYSTEM_CONFIG] Error in getCurrentFeatures:",l),{enableAdvancedEffects:!0,enableHarmony:!0,beatSync:!0,colorHarmony:!0}}},getCurrentPerformanceSettings(){try{if(typeof this.getCurrentModeProfile!="function")return console.warn("[ADVANCED_SYSTEM_CONFIG] getCurrentModeProfile method not available, using fallback performance settings"),{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1};let l=this.getCurrentModeProfile();return!l||!l.performance?(console.warn("[ADVANCED_SYSTEM_CONFIG] Invalid profile or missing performance settings, using fallback"),{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1}):l.performance}catch(l){return console.error("[ADVANCED_SYSTEM_CONFIG] Error in getCurrentPerformanceSettings:",l),{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1}}},isFullyInitialized(){return["setArtisticMode","getCurrentModeProfile","getCurrentMultipliers","getCurrentFeatures","getCurrentPerformanceSettings"].every(t=>typeof this[t]=="function")},safeSetArtisticMode(l){return this.isFullyInitialized()?this.setArtisticMode(l):(console.warn("[ADVANCED_SYSTEM_CONFIG] Not fully initialized, deferring artistic mode change"),this._pendingArtisticMode=l,!1)},setArtisticMode(l){let t=Object.keys(et);if(t.includes(l)){let e=this.artisticMode;return this.artisticMode=l,this.enableDebug&&(console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Artistic mode changed: ${e} \u2192 ${l}`),console.log("\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] New profile:",this.getCurrentModeProfile())),typeof document<"u"&&document.dispatchEvent(new CustomEvent("year3000ArtisticModeChanged",{detail:{previousMode:e,newMode:l,profile:this.getCurrentModeProfile()}})),typeof globalThis.year3000System<"u"&&globalThis.year3000System.setGradientParameters&&globalThis.year3000System.setGradientParameters(document.documentElement),!0}return console.warn(`[ADVANCED_SYSTEM_CONFIG] Invalid artistic mode: ${l}. Valid modes:`,t),!1},setLoggingLevel(l){let t=["off","error","warn","info","debug","verbose"];return t.includes(l)?(this.logging.level=l,l!=="off"&&console.log(`\u{1F527} [ADVANCED_SYSTEM_CONFIG] Logging level set to: ${l}`),!0):(console.warn(`[ADVANCED_SYSTEM_CONFIG] Invalid logging level: ${l}. Valid levels:`,t),!1)},disablePerformanceWarnings(){this.logging.performance.enableFrameBudgetWarnings=!1,console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Performance warnings disabled")},enablePerformanceWarnings(){this.logging.performance.enableFrameBudgetWarnings=!0,console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Performance warnings enabled")},setPerformanceWarningThrottle(l){return typeof l=="number"&&l>=0?(this.logging.performance.throttleInterval=l,this.logging.performance.throttleWarnings=l>0,console.log(`\u{1F527} [ADVANCED_SYSTEM_CONFIG] Performance warning throttle set to: ${l}ms`),!0):(console.warn("[ADVANCED_SYSTEM_CONFIG] Invalid throttle interval. Must be a non-negative number."),!1)},setupForProduction(){this.setLoggingLevel("warn"),this.disablePerformanceWarnings(),this.logging.performance.enableAdaptiveDegradation=!0,console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Configured for production environment")},setupForDevelopment(){this.setLoggingLevel("debug"),this.enablePerformanceWarnings(),this.setPerformanceWarningThrottle(2e3),this.logging.performance.enableAdaptiveDegradation=!0,console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Configured for development environment")},setupForDebugging(){this.setLoggingLevel("verbose"),this.enablePerformanceWarnings(),this.setPerformanceWarningThrottle(500),this.logging.performance.enableAdaptiveDegradation=!1,console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Configured for debugging environment")},validateConfigHealth(){let l=[],t={healthy:!0,system:"AdvancedSystemConfig",details:"Configuration health validation",issues:[],metrics:{}},i=Object.keys(this).filter(r=>typeof this[r]=="function");for(let r of i)this.hasOwnProperty(r)||l.push({key:String(r),severity:"warning",message:`Method ${r} is not an own property, may indicate prototype chain issues.`});let a=r=>{if(!et[r]){l.push({key:`artisticMode:${r}`,severity:"critical",message:`Artistic mode profile for '${r}' is missing.`});return}t.metrics[`${r}Profile`]="ok"};return a(this.artisticMode),a("artist-vision"),a("corporate-safe"),l.length>0&&(t.healthy=!1,t.issues=l.map(r=>`[${r.severity.toUpperCase()}] ${r.key}: ${r.message}`),t.details=l.some(r=>r.severity==="critical")?"Critical configuration issues detected":"Configuration issues detected"),this.enableDebug&&console.log("[ADVANCED_SYSTEM_CONFIG] Health Check Report:",t),t},loadArtisticPreference(){try{let l=x.get("sn-artistic-mode"),t=Object.keys(et);l&&t.includes(String(l))&&this.artisticMode!==l?(this.artisticMode=String(l),this.enableDebug&&console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Updated artistic mode from storage: ${l}`)):!l&&this.artisticMode!=="artist-vision"&&(this.artisticMode="artist-vision",this.enableDebug&&console.log("\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Reset artistic mode to default: artist-vision"));let e=x.get("sn-palette-system");e&&["catppuccin","year3000"].includes(String(e))&&this.paletteSystem!==e?(this.paletteSystem=String(e),this.enableDebug&&console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Updated palette system from storage: ${e}`)):!e&&this.paletteSystem!=="catppuccin"&&(this.paletteSystem="catppuccin",this.enableDebug&&console.log("\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Reset palette system to default: catppuccin")),this.enableDebug&&(console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Current artistic preference: ${this.artisticMode}`),console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Current palette system: ${this.paletteSystem}`))}catch(l){this.enableDebug&&console.warn("\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Failed to load preferences:",l),this.artisticMode="artist-vision",this.paletteSystem="catppuccin"}}};typeof M.init=="function"&&M.init()});var ue,u,an,A=y(()=>{"use strict";G();ue=class l{constructor(t={}){this.registeredSystems=new Map;this.reportHistory=[];this.monitoring=!1;this.monitoringInterval=null;this.performanceMetrics=new Map;this.config={enableConsoleReporting:M.enableDebug,reportingInterval:3e4,enablePerformanceTracking:!0,enableSystemHealthMonitoring:!0,maxHistoryEntries:50,verboseLogging:M.enableDebug,...t},this.config.enableConsoleReporting&&console.log("\u{1F527} [UnifiedDebugManager] Debug system initialized")}static getInstance(t){return l.instance||(l.instance=new l(t)),l.instance}registerSystem(t,e,i="unified"){let a={name:t,type:i,initialized:e.initialized||!1,healthy:!0,lastUpdate:Date.now(),issues:[],metrics:{}};this.registeredSystems.set(t,a),this.config.verboseLogging&&console.log(`\u{1F527} [UnifiedDebugManager] Registered system: ${t} (${i})`),this.registeredSystems.size===1&&!this.monitoring&&this.startMonitoring()}unregisterSystem(t){this.registeredSystems.delete(t),this.performanceMetrics.delete(t),this.config.verboseLogging&&console.log(`\u{1F527} [UnifiedDebugManager] Unregistered system: ${t}`),this.registeredSystems.size===0&&this.stopMonitoring()}updateSystem(t,e){let i=this.registeredSystems.get(t);i&&(Object.assign(i,e,{lastUpdate:Date.now()}),this.registeredSystems.set(t,i))}recordMetric(t,e,i){if(!this.config.enablePerformanceTracking)return;let a=this.registeredSystems.get(t);a&&(a.metrics[e]=i,a.lastUpdate=Date.now());let r=`${t}_${e}`,n=this.performanceMetrics.get(r)||[];n.push(i),n.length>100&&n.splice(0,n.length-100),this.performanceMetrics.set(r,n)}recordIssue(t,e){let i=this.registeredSystems.get(t);i&&(i.issues.push(e),i.healthy=!1,i.lastUpdate=Date.now(),this.config.verboseLogging&&console.warn(`\u26A0\uFE0F [${t}] ${e}`))}async performHealthCheck(){let t=Date.now(),e=[],i=0,a=0,r=0,n=0,s=0;for(let[h,g]of this.registeredSystems)try{let f=null,v=g.initialized,C=globalThis.year3000System;if(C){if(C.facadeCoordinator){try{f=C.facadeCoordinator.getCachedNonVisualSystem?.(h)||await C.facadeCoordinator.getNonVisualSystem?.(h)}catch{}if(!f)try{f=C.facadeCoordinator.getVisualSystem?.(h)}catch{}}if(!f){let w=h.charAt(0).toLowerCase()+h.slice(1);f=C[w]||C[h]}}if(f||(f=globalThis[h]),f){if(typeof f.initialized=="boolean")v=f.initialized;else if(typeof f.isInitialized=="function")try{v=await f.isInitialized()}catch{}else if(typeof f.getInitializationStatus=="function")try{let w=await f.getInitializationStatus();v=w?.initialized??w?.ready??!1}catch{}}let T=g.initialized;if(g.initialized=v,g.lastUpdate=t,this.config.verboseLogging&&T!==v&&console.log(`\u{1F527} [UnifiedDebugManager] ${h} initialization status updated: ${T} \u2192 ${v}`),f&&typeof f.healthCheck=="function"){let w=await f.healthCheck();g.healthy=w.healthy??w.ok,w.ok?g.issues=[]:g.issues=[w.details||"Health check failed"]}else g.healthy=v,v?g.issues=[]:g.issues=["System not initialized"];g.frameTime&&(r+=g.frameTime,s++),g.memoryUsage&&(n+=g.memoryUsage),g.healthy?i++:a+=g.issues.length,e.push({...g})}catch(f){g.healthy=!1,g.issues=[`Health check error: ${f}`],a++,this.config.verboseLogging&&console.error(`\u274C [${h}] Health check failed:`,f)}let o=this.registeredSystems.size>0?i/this.registeredSystems.size:1,c;if(o>=.9?c="excellent":o>=.7?c="good":o>=.5?c="degraded":c="critical",this.config.verboseLogging){console.log("\u{1F527} [UnifiedDebugManager] System initialization status for recommendations:");for(let h of e)console.log(`   ${h.name}: ${h.initialized?"\u2705":"\u274C"} initialized`)}let m=this.generateRecommendations(e,c),d={timestamp:t,overallHealth:c,systemCount:this.registeredSystems.size,healthySystems:i,totalIssues:a,systemDetails:e,performance:{avgFrameTime:s>0?r/s:0,totalMemoryMB:n,cpuUsageEstimate:this.estimateCPUUsage()},recommendations:m};return this.reportHistory.push(d),this.reportHistory.length>this.config.maxHistoryEntries&&this.reportHistory.splice(0,this.reportHistory.length-this.config.maxHistoryEntries),d}generateRecommendations(t,e){let i=[];e==="critical"&&i.push("\u{1F6A8} Critical: Multiple systems failing - check console for errors");let a=t.filter(s=>!s.initialized);a.length>0&&i.push(`\u26A0\uFE0F ${a.length} systems not initialized: ${a.map(s=>s.name).join(", ")}`);let r=t.filter(s=>s.frameTime&&s.frameTime>16.67);r.length>0&&i.push(`\u{1F40C} Performance: ${r.length} systems exceeding 16.67ms frame time`);let n=t.filter(s=>s.memoryUsage&&s.memoryUsage>50);return n.length>0&&i.push(`\u{1F4BE} Memory: ${n.length} systems using >50MB`),i.length===0&&i.push("\u2705 All systems operating within normal parameters"),i}estimateCPUUsage(){let t=0,e=0;for(let a of this.registeredSystems.values())a.frameTime&&(t+=a.frameTime,e++);if(e===0)return 0;let i=t/e;return Math.min(100,i/16.67*5)}startMonitoring(){this.monitoring||(this.monitoring=!0,this.monitoringInterval=window.setInterval(()=>{this.performHealthCheck().then(t=>{this.config.enableConsoleReporting&&this.logHealthReport(t)})},this.config.reportingInterval),this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] Monitoring started"))}stopMonitoring(){this.monitoring&&(this.monitoring=!1,this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] Monitoring stopped"))}logHealthReport(t){if(!t){this.performHealthCheck().then(i=>this.logHealthReport(i));return}let e={excellent:"\u{1F31F}",good:"\u2705",degraded:"\u26A0\uFE0F",critical:"\u{1F6A8}"}[t.overallHealth];console.group(`${e} Year 3000 System Health Report - ${new Date().toLocaleTimeString()}`),console.log(`\u{1F4CA} Overall: ${t.overallHealth.toUpperCase()} (${t.healthySystems}/${t.systemCount} healthy)`),t.totalIssues>0&&console.log(`\u{1F6A8} Issues: ${t.totalIssues} total`),console.log(`\u26A1 Performance: ${t.performance.avgFrameTime.toFixed(2)}ms avg frame, ${t.performance.totalMemoryMB.toFixed(1)}MB memory, ~${t.performance.cpuUsageEstimate.toFixed(1)}% CPU`),t.systemDetails.length>0&&(console.group("\u{1F527} System Details"),t.systemDetails.forEach(i=>{let a=i.healthy?"\u2705":"\u274C",r=i.frameTime?` (${i.frameTime.toFixed(2)}ms)`:"";console.log(`${a} ${i.name} [${i.type}]${r}`),i.issues.length>0&&i.issues.forEach(n=>{console.log(`    \u26A0\uFE0F ${n}`)})}),console.groupEnd()),t.recommendations.length>0&&(console.group("\u{1F4A1} Recommendations"),t.recommendations.forEach(i=>console.log(`  ${i}`)),console.groupEnd()),console.groupEnd()}getLatestReport(){return this.reportHistory[this.reportHistory.length-1]||null}getReportHistory(){return[...this.reportHistory]}getSystemInfo(t){return this.registeredSystems.get(t)||null}getAllSystems(){return Array.from(this.registeredSystems.values())}async checkHealth(){let t=await this.performHealthCheck();this.logHealthReport(t)}updateConfig(t){this.config={...this.config,...t},this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] Configuration updated:",t)}reset(){this.stopMonitoring(),this.registeredSystems.clear(),this.reportHistory=[],this.performanceMetrics.clear(),this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] System reset")}destroy(){this.reset(),l.instance=null}},u={debug:{log:(l,t,...e)=>{M?.enableDebug&&console.log(`[${l}] ${t}`,...e)},error:(l,t,e)=>{console.error(`[${l}] ${t}`,e),ue.getInstance().recordIssue(l,`${t}${e?`: ${e}`:""}`)},warn:(l,t,...e)=>{console.warn(`[${l}] ${t}`,...e),ue.getInstance().recordIssue(l,t)},metric:(l,t,e)=>{ue.getInstance().recordMetric(l,t,e)},register:(l,t,e)=>{ue.getInstance().registerSystem(l,t,e)},unregister:l=>{ue.getInstance().unregisterSystem(l)},checkHealth:()=>ue.getInstance().checkHealth(),getReport:()=>ue.getInstance().getLatestReport()}};typeof window<"u"&&(window.UnifiedDebugManager=ue,window.Y3K=u,console.log("\u{1F527} [UnifiedDebugManager] Global debug interface available:"),console.log("  Y3K.debug.checkHealth() - Check system health"),console.log("  Y3K.debug.getReport() - Get latest debug report"),console.log("  UnifiedDebugManager.getInstance() - Get debug manager"));an=ue});var ke,si=y(()=>{"use strict";A();ke=class{constructor(t,e=null,i=null,a=null){this.musicSyncService=null;this.emotionalGradientMapper=null;this.settingsManager=null;this.currentGenre="unknown";this.genreConfidence=0;this.genreHistory=[];this.maxHistorySize=30;this.genreAnalysisBuffer=[];this.bufferSize=10;this.isActive=!1;this.boundSpectralHandler=null;this.boundEmotionalHandler=null;this.genreProfiles={electronic:{bassEmphasis:.8,midFrequencyPattern:.6,trebleSharpness:.9,dynamicRange:.7,rhythmComplexity:.6,syncopation:.4,grooveWeight:.7,tempoVariability:.3,musicalComplexity:.5,harmonicComplexity:.5,dissonanceTolerance:.6,modalInfluence:.4,microtonal:.2,compression:.8,saturation:.6,stereoWidth:.8,artificialProcessing:.9,smoothness:.2,accessibility:.6,experimentalFactor:.7,emotionalRange:.6},rock:{bassEmphasis:.7,midFrequencyPattern:.8,trebleSharpness:.7,dynamicRange:.8,rhythmComplexity:.6,syncopation:.3,grooveWeight:.8,tempoVariability:.4,musicalComplexity:.6,harmonicComplexity:.6,dissonanceTolerance:.5,modalInfluence:.3,microtonal:.1,compression:.6,saturation:.7,stereoWidth:.7,artificialProcessing:.4,smoothness:.6,accessibility:.8,experimentalFactor:.4,emotionalRange:.8},classical:{bassEmphasis:.5,midFrequencyPattern:.7,trebleSharpness:.6,dynamicRange:.9,rhythmComplexity:.8,syncopation:.2,grooveWeight:.4,tempoVariability:.7,musicalComplexity:.9,harmonicComplexity:.9,dissonanceTolerance:.4,modalInfluence:.6,microtonal:.3,compression:.3,saturation:.2,stereoWidth:.8,artificialProcessing:.1,smoothness:.9,accessibility:.4,experimentalFactor:.6,emotionalRange:.9},jazz:{bassEmphasis:.6,midFrequencyPattern:.8,trebleSharpness:.5,dynamicRange:.8,rhythmComplexity:.9,syncopation:.8,grooveWeight:.9,tempoVariability:.6,musicalComplexity:.9,harmonicComplexity:.9,dissonanceTolerance:.7,modalInfluence:.8,microtonal:.4,compression:.4,saturation:.3,stereoWidth:.7,artificialProcessing:.2,smoothness:.8,accessibility:.5,experimentalFactor:.8,emotionalRange:.8},"hip-hop":{bassEmphasis:.9,midFrequencyPattern:.7,trebleSharpness:.8,dynamicRange:.6,rhythmComplexity:.7,syncopation:.6,grooveWeight:.9,tempoVariability:.3,musicalComplexity:.4,harmonicComplexity:.4,dissonanceTolerance:.5,modalInfluence:.3,microtonal:.1,compression:.8,saturation:.6,stereoWidth:.6,artificialProcessing:.7,smoothness:.4,accessibility:.8,experimentalFactor:.5,emotionalRange:.7},ambient:{bassEmphasis:.4,midFrequencyPattern:.5,trebleSharpness:.3,dynamicRange:.9,rhythmComplexity:.2,syncopation:.1,grooveWeight:.2,tempoVariability:.8,musicalComplexity:.6,harmonicComplexity:.6,dissonanceTolerance:.6,modalInfluence:.7,microtonal:.5,compression:.5,saturation:.4,stereoWidth:.9,artificialProcessing:.6,smoothness:.7,accessibility:.3,experimentalFactor:.8,emotionalRange:.6},pop:{bassEmphasis:.6,midFrequencyPattern:.8,trebleSharpness:.7,dynamicRange:.6,rhythmComplexity:.4,syncopation:.3,grooveWeight:.7,tempoVariability:.2,musicalComplexity:.5,harmonicComplexity:.5,dissonanceTolerance:.3,modalInfluence:.2,microtonal:.1,compression:.8,saturation:.5,stereoWidth:.6,artificialProcessing:.5,smoothness:.5,accessibility:.9,experimentalFactor:.2,emotionalRange:.7},metal:{bassEmphasis:.8,midFrequencyPattern:.7,trebleSharpness:.9,dynamicRange:.7,rhythmComplexity:.7,syncopation:.4,grooveWeight:.8,tempoVariability:.3,musicalComplexity:.6,harmonicComplexity:.6,dissonanceTolerance:.8,modalInfluence:.5,microtonal:.2,compression:.7,saturation:.9,stereoWidth:.7,artificialProcessing:.6,smoothness:.4,accessibility:.6,experimentalFactor:.5,emotionalRange:.8},folk:{bassEmphasis:.4,midFrequencyPattern:.7,trebleSharpness:.5,dynamicRange:.7,rhythmComplexity:.4,syncopation:.2,grooveWeight:.6,tempoVariability:.5,musicalComplexity:.5,harmonicComplexity:.5,dissonanceTolerance:.3,modalInfluence:.6,microtonal:.2,compression:.3,saturation:.2,stereoWidth:.5,artificialProcessing:.1,smoothness:.9,accessibility:.7,experimentalFactor:.3,emotionalRange:.7},funk:{bassEmphasis:.9,midFrequencyPattern:.8,trebleSharpness:.6,dynamicRange:.7,rhythmComplexity:.8,syncopation:.9,grooveWeight:1,tempoVariability:.4,musicalComplexity:.6,harmonicComplexity:.6,dissonanceTolerance:.5,modalInfluence:.4,microtonal:.2,compression:.6,saturation:.5,stereoWidth:.6,artificialProcessing:.3,smoothness:.7,accessibility:.7,experimentalFactor:.4,emotionalRange:.6},indie:{bassEmphasis:.5,midFrequencyPattern:.7,trebleSharpness:.6,dynamicRange:.7,rhythmComplexity:.6,syncopation:.4,grooveWeight:.6,tempoVariability:.5,musicalComplexity:.6,harmonicComplexity:.6,dissonanceTolerance:.5,modalInfluence:.5,microtonal:.3,compression:.5,saturation:.4,stereoWidth:.7,artificialProcessing:.3,smoothness:.7,accessibility:.6,experimentalFactor:.6,emotionalRange:.7},reggae:{bassEmphasis:.8,midFrequencyPattern:.6,trebleSharpness:.5,dynamicRange:.6,rhythmComplexity:.5,syncopation:.7,grooveWeight:.8,tempoVariability:.3,musicalComplexity:.4,harmonicComplexity:.4,dissonanceTolerance:.3,modalInfluence:.4,microtonal:.2,compression:.6,saturation:.4,stereoWidth:.6,artificialProcessing:.3,smoothness:.6,accessibility:.7,experimentalFactor:.3,emotionalRange:.6},blues:{bassEmphasis:.6,midFrequencyPattern:.8,trebleSharpness:.6,dynamicRange:.8,rhythmComplexity:.5,syncopation:.4,grooveWeight:.8,tempoVariability:.6,musicalComplexity:.6,harmonicComplexity:.6,dissonanceTolerance:.4,modalInfluence:.7,microtonal:.3,compression:.4,saturation:.5,stereoWidth:.5,artificialProcessing:.2,smoothness:.8,accessibility:.7,experimentalFactor:.4,emotionalRange:.8},country:{bassEmphasis:.5,midFrequencyPattern:.7,trebleSharpness:.6,dynamicRange:.7,rhythmComplexity:.4,syncopation:.3,grooveWeight:.6,tempoVariability:.4,musicalComplexity:.4,harmonicComplexity:.4,dissonanceTolerance:.2,modalInfluence:.3,microtonal:.1,compression:.5,saturation:.3,stereoWidth:.6,artificialProcessing:.2,smoothness:.8,accessibility:.8,experimentalFactor:.2,emotionalRange:.7},techno:{bassEmphasis:.9,midFrequencyPattern:.5,trebleSharpness:.8,dynamicRange:.5,rhythmComplexity:.6,syncopation:.3,grooveWeight:.8,tempoVariability:.2,musicalComplexity:.4,harmonicComplexity:.4,dissonanceTolerance:.6,modalInfluence:.3,microtonal:.3,compression:.9,saturation:.7,stereoWidth:.8,artificialProcessing:1,smoothness:.1,accessibility:.5,experimentalFactor:.6,emotionalRange:.5},house:{bassEmphasis:.8,midFrequencyPattern:.6,trebleSharpness:.7,dynamicRange:.6,rhythmComplexity:.5,syncopation:.4,grooveWeight:.9,tempoVariability:.2,musicalComplexity:.5,harmonicComplexity:.5,dissonanceTolerance:.4,modalInfluence:.3,microtonal:.2,compression:.8,saturation:.6,stereoWidth:.7,artificialProcessing:.8,smoothness:.3,accessibility:.8,experimentalFactor:.4,emotionalRange:.6},trance:{bassEmphasis:.7,midFrequencyPattern:.7,trebleSharpness:.8,dynamicRange:.8,rhythmComplexity:.5,syncopation:.2,grooveWeight:.7,tempoVariability:.3,musicalComplexity:.6,harmonicComplexity:.6,dissonanceTolerance:.5,modalInfluence:.4,microtonal:.3,compression:.7,saturation:.5,stereoWidth:.9,artificialProcessing:.8,smoothness:.2,accessibility:.6,experimentalFactor:.5,emotionalRange:.8},dubstep:{bassEmphasis:1,midFrequencyPattern:.5,trebleSharpness:.9,dynamicRange:.9,rhythmComplexity:.7,syncopation:.6,grooveWeight:.8,tempoVariability:.4,musicalComplexity:.4,harmonicComplexity:.4,dissonanceTolerance:.8,modalInfluence:.3,microtonal:.4,compression:.8,saturation:.8,stereoWidth:.8,artificialProcessing:.9,smoothness:.1,accessibility:.4,experimentalFactor:.7,emotionalRange:.6},unknown:{bassEmphasis:.5,midFrequencyPattern:.5,trebleSharpness:.5,dynamicRange:.5,rhythmComplexity:.5,syncopation:.5,grooveWeight:.5,tempoVariability:.5,musicalComplexity:.5,harmonicComplexity:.5,dissonanceTolerance:.5,modalInfluence:.5,microtonal:.5,compression:.5,saturation:.5,stereoWidth:.5,artificialProcessing:.5,smoothness:.5,accessibility:.5,experimentalFactor:.5,emotionalRange:.5}};this.genreVisualStyles={electronic:{primaryHueRange:[180,270],saturationProfile:[.8,.3],brightnessProfile:[1.1,.4],contrastLevel:.8,gradientComplexity:.8,shapeGeometry:"geometric",edgeSharpness:.9,symmetryLevel:.7,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"linear",transitionCharacter:"mechanical",layerBlending:"contrasting",depthIllusion:.6,particleInfluence:.8,nebulaCharacter:"structured",memoryInfluence:.3,adaptationSpeed:.8,stabilityPreference:.6,emergencePattern:"sudden"},rock:{primaryHueRange:[330,30],saturationProfile:[1.2,.5],brightnessProfile:[1.2,.3],contrastLevel:.9,gradientComplexity:.7,shapeGeometry:"hybrid",edgeSharpness:.7,symmetryLevel:.5,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"sharp",layerBlending:"harmonious",depthIllusion:.7,particleInfluence:.6,nebulaCharacter:"dense",memoryInfluence:.4,adaptationSpeed:.7,stabilityPreference:.7,emergencePattern:"gradual"},classical:{primaryHueRange:[45,135],saturationProfile:[.6,.4],brightnessProfile:[1,.5],contrastLevel:.6,gradientComplexity:.9,shapeGeometry:"smooth",edgeSharpness:.3,symmetryLevel:.8,animationStyle:"smooth",pulseBehavior:"subtle",flowDirection:"spiral",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.9,particleInfluence:.4,nebulaCharacter:"ethereal",memoryInfluence:.8,adaptationSpeed:.3,stabilityPreference:.9,emergencePattern:"progressive"},jazz:{primaryHueRange:[30,90],saturationProfile:[.7,.6],brightnessProfile:[.9,.6],contrastLevel:.7,gradientComplexity:.8,shapeGeometry:"abstract",edgeSharpness:.5,symmetryLevel:.3,animationStyle:"chaotic",pulseBehavior:"syncopated",flowDirection:"random",transitionCharacter:"smooth",layerBlending:"complementary",depthIllusion:.8,particleInfluence:.7,nebulaCharacter:"wispy",memoryInfluence:.6,adaptationSpeed:.6,stabilityPreference:.4,emergencePattern:"cyclical"},"hip-hop":{primaryHueRange:[270,330],saturationProfile:[1,.4],brightnessProfile:[1.1,.3],contrastLevel:.8,gradientComplexity:.6,shapeGeometry:"geometric",edgeSharpness:.8,symmetryLevel:.6,animationStyle:"rhythmic",pulseBehavior:"syncopated",flowDirection:"linear",transitionCharacter:"sharp",layerBlending:"contrasting",depthIllusion:.5,particleInfluence:.9,nebulaCharacter:"structured",memoryInfluence:.2,adaptationSpeed:.9,stabilityPreference:.5,emergencePattern:"sudden"},ambient:{primaryHueRange:[180,240],saturationProfile:[.4,.3],brightnessProfile:[.8,.4],contrastLevel:.3,gradientComplexity:.9,shapeGeometry:"smooth",edgeSharpness:.2,symmetryLevel:.4,animationStyle:"minimal",pulseBehavior:"subtle",flowDirection:"spiral",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.9,particleInfluence:.3,nebulaCharacter:"ethereal",memoryInfluence:.9,adaptationSpeed:.1,stabilityPreference:.9,emergencePattern:"gradual"},pop:{primaryHueRange:[300,60],saturationProfile:[1.1,.3],brightnessProfile:[1.2,.2],contrastLevel:.7,gradientComplexity:.6,shapeGeometry:"hybrid",edgeSharpness:.6,symmetryLevel:.7,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.6,particleInfluence:.5,nebulaCharacter:"dense",memoryInfluence:.5,adaptationSpeed:.7,stabilityPreference:.8,emergencePattern:"gradual"},metal:{primaryHueRange:[0,30],saturationProfile:[.9,.4],brightnessProfile:[.7,.4],contrastLevel:1,gradientComplexity:.7,shapeGeometry:"geometric",edgeSharpness:.9,symmetryLevel:.6,animationStyle:"chaotic",pulseBehavior:"irregular",flowDirection:"radial",transitionCharacter:"sharp",layerBlending:"clashing",depthIllusion:.8,particleInfluence:.7,nebulaCharacter:"dense",memoryInfluence:.3,adaptationSpeed:.8,stabilityPreference:.3,emergencePattern:"sudden"},folk:{primaryHueRange:[60,120],saturationProfile:[.6,.3],brightnessProfile:[.9,.3],contrastLevel:.5,gradientComplexity:.5,shapeGeometry:"smooth",edgeSharpness:.3,symmetryLevel:.5,animationStyle:"smooth",pulseBehavior:"subtle",flowDirection:"spiral",transitionCharacter:"smooth",layerBlending:"harmonious",depthIllusion:.6,particleInfluence:.3,nebulaCharacter:"wispy",memoryInfluence:.7,adaptationSpeed:.4,stabilityPreference:.8,emergencePattern:"progressive"},funk:{primaryHueRange:[30,90],saturationProfile:[1,.5],brightnessProfile:[1,.4],contrastLevel:.8,gradientComplexity:.7,shapeGeometry:"abstract",edgeSharpness:.6,symmetryLevel:.4,animationStyle:"rhythmic",pulseBehavior:"syncopated",flowDirection:"random",transitionCharacter:"smooth",layerBlending:"complementary",depthIllusion:.7,particleInfluence:.8,nebulaCharacter:"wispy",memoryInfluence:.4,adaptationSpeed:.8,stabilityPreference:.5,emergencePattern:"cyclical"},indie:{primaryHueRange:[120,240],saturationProfile:[.7,.4],brightnessProfile:[.9,.4],contrastLevel:.6,gradientComplexity:.7,shapeGeometry:"hybrid",edgeSharpness:.4,symmetryLevel:.5,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"spiral",transitionCharacter:"fluid",layerBlending:"complementary",depthIllusion:.7,particleInfluence:.5,nebulaCharacter:"wispy",memoryInfluence:.6,adaptationSpeed:.5,stabilityPreference:.7,emergencePattern:"progressive"},reggae:{primaryHueRange:[90,150],saturationProfile:[.8,.3],brightnessProfile:[1,.3],contrastLevel:.6,gradientComplexity:.5,shapeGeometry:"smooth",edgeSharpness:.4,symmetryLevel:.6,animationStyle:"rhythmic",pulseBehavior:"syncopated",flowDirection:"linear",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.5,particleInfluence:.4,nebulaCharacter:"wispy",memoryInfluence:.6,adaptationSpeed:.5,stabilityPreference:.7,emergencePattern:"cyclical"},blues:{primaryHueRange:[200,260],saturationProfile:[.6,.4],brightnessProfile:[.8,.4],contrastLevel:.6,gradientComplexity:.6,shapeGeometry:"smooth",edgeSharpness:.4,symmetryLevel:.4,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.7,particleInfluence:.4,nebulaCharacter:"ethereal",memoryInfluence:.7,adaptationSpeed:.4,stabilityPreference:.8,emergencePattern:"progressive"},country:{primaryHueRange:[30,90],saturationProfile:[.7,.3],brightnessProfile:[1,.3],contrastLevel:.5,gradientComplexity:.5,shapeGeometry:"smooth",edgeSharpness:.3,symmetryLevel:.6,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"smooth",layerBlending:"harmonious",depthIllusion:.5,particleInfluence:.3,nebulaCharacter:"wispy",memoryInfluence:.7,adaptationSpeed:.4,stabilityPreference:.8,emergencePattern:"gradual"},techno:{primaryHueRange:[240,300],saturationProfile:[1,.4],brightnessProfile:[1.1,.3],contrastLevel:.9,gradientComplexity:.6,shapeGeometry:"geometric",edgeSharpness:1,symmetryLevel:.8,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"linear",transitionCharacter:"mechanical",layerBlending:"contrasting",depthIllusion:.5,particleInfluence:.9,nebulaCharacter:"structured",memoryInfluence:.2,adaptationSpeed:.9,stabilityPreference:.4,emergencePattern:"sudden"},house:{primaryHueRange:[300,360],saturationProfile:[.9,.3],brightnessProfile:[1.1,.3],contrastLevel:.7,gradientComplexity:.6,shapeGeometry:"hybrid",edgeSharpness:.7,symmetryLevel:.7,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.6,particleInfluence:.7,nebulaCharacter:"dense",memoryInfluence:.4,adaptationSpeed:.7,stabilityPreference:.6,emergencePattern:"gradual"},trance:{primaryHueRange:[180,270],saturationProfile:[.8,.5],brightnessProfile:[1,.5],contrastLevel:.7,gradientComplexity:.8,shapeGeometry:"abstract",edgeSharpness:.5,symmetryLevel:.6,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"spiral",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.8,particleInfluence:.6,nebulaCharacter:"ethereal",memoryInfluence:.6,adaptationSpeed:.5,stabilityPreference:.7,emergencePattern:"progressive"},dubstep:{primaryHueRange:[120,180],saturationProfile:[1.2,.6],brightnessProfile:[1.1,.6],contrastLevel:1,gradientComplexity:.8,shapeGeometry:"geometric",edgeSharpness:.9,symmetryLevel:.5,animationStyle:"chaotic",pulseBehavior:"irregular",flowDirection:"random",transitionCharacter:"sharp",layerBlending:"clashing",depthIllusion:.7,particleInfluence:1,nebulaCharacter:"structured",memoryInfluence:.2,adaptationSpeed:1,stabilityPreference:.2,emergencePattern:"sudden"},unknown:{primaryHueRange:[0,360],saturationProfile:[.7,.3],brightnessProfile:[1,.3],contrastLevel:.6,gradientComplexity:.6,shapeGeometry:"hybrid",edgeSharpness:.5,symmetryLevel:.5,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.6,particleInfluence:.5,nebulaCharacter:"wispy",memoryInfluence:.5,adaptationSpeed:.5,stabilityPreference:.6,emergencePattern:"gradual"}};this.cssVariableController=t,this.musicSyncService=e,this.emotionalGradientMapper=i,this.settingsManager=a,this.boundSpectralHandler=this.handleSpectralData.bind(this),this.boundEmotionalHandler=this.handleEmotionalData.bind(this)}async initialize(){this.boundSpectralHandler&&document.addEventListener("music-sync:spectral-data",this.boundSpectralHandler),this.boundEmotionalHandler&&document.addEventListener("emotional-gradient:profile-updated",this.boundEmotionalHandler),this.isActive=!0,u?.debug?.log("GenreGradientEvolution","Genre-responsive gradient evolution system initialized")}handleSpectralData(t){if(!this.isActive)return;let i=t.detail;i&&(this.genreAnalysisBuffer.push(i),this.genreAnalysisBuffer.length>this.bufferSize&&this.genreAnalysisBuffer.shift(),this.genreAnalysisBuffer.length>=this.bufferSize&&this.analyzeGenre())}handleEmotionalData(t){this.isActive&&this.updateVisualEvolution()}analyzeGenre(){if(this.genreAnalysisBuffer.length===0)return;let t=this.calculateAverageMusicData(),e={};for(let r of Object.keys(this.genreProfiles))e[r]=this.calculateGenreSimilarity(t,this.genreProfiles[r]);let a=Object.entries(e).sort(([,r],[,n])=>n-r)[0];if(a){let[r,n]=a;this.updateGenreDetection(r,n)}}calculateAverageMusicData(){let t=this.genreAnalysisBuffer.reduce((i,a)=>({energy:(i.energy||0)+(a.energy||0),valence:(i.valence||0)+(a.valence||0),danceability:(i.danceability||0)+(a.danceability||0),tempo:(i.tempo||0)+(a.tempo||0),loudness:(i.loudness||0)+(a.loudness||0),acousticness:(i.acousticness||0)+(a.acousticness||0),instrumentalness:(i.instrumentalness||0)+(a.instrumentalness||0),speechiness:(i.speechiness||0)+(a.speechiness||0),mode:a.mode!==void 0?a.mode:i.mode||0,key:(i.key||0)+(a.key||0),genre:a.genre||i.genre||"unknown"}),{energy:0,valence:0,danceability:0,tempo:0,loudness:0,acousticness:0,instrumentalness:0,speechiness:0,mode:0,key:0,genre:"unknown"}),e=this.genreAnalysisBuffer.length;return{energy:(t.energy||0)/e,valence:(t.valence||0)/e,danceability:(t.danceability||0)/e,tempo:(t.tempo||0)/e,loudness:(t.loudness||0)/e,acousticness:(t.acousticness||0)/e,instrumentalness:(t.instrumentalness||0)/e,speechiness:(t.speechiness||0)/e,mode:t.mode||0,key:(t.key||0)/e,genre:t.genre||"unknown"}}calculateGenreSimilarity(t,e){let i={energy:.25,valence:.2,danceability:.2,acousticness:.15,tempo:.1,speechiness:.05,instrumentalness:.05},a=1-Math.abs((t.energy||.5)-(e.dynamicRange*.5+e.rhythmComplexity*.5)),r=1-Math.abs((t.valence||.5)-(e.accessibility*.6+e.emotionalRange*.4)),n=1-Math.abs((t.danceability||.5)-(e.grooveWeight*.7+(1-e.syncopation)*.3)),s=1-Math.abs((t.acousticness||.5)-(e.smoothness*.8+(1-e.artificialProcessing)*.2)),o=60+e.rhythmComplexity*80+e.grooveWeight*60,c=1-Math.min(1,Math.abs((t.tempo||120)-o)/100),m=1-Math.abs((t.speechiness||.1)-(e.artificialProcessing*.3+e.accessibility*.1)),d=1-Math.abs((t.instrumentalness||.5)-(e.experimentalFactor*.6+(e.musicalComplexity||e.harmonicComplexity||.5)*.4));return a*i.energy+r*i.valence+n*i.danceability+s*i.acousticness+c*i.tempo+m*i.speechiness+d*i.instrumentalness}updateGenreDetection(t,e){let i=performance.now();this.genreHistory.push({genre:t,confidence:e,timestamp:i}),this.genreHistory.length>this.maxHistorySize&&this.genreHistory.shift();let a=this.genreHistory.slice(-10),r=this.calculateGenreConsensus(a);r.confidence>.6&&(r.genre!==this.currentGenre||r.confidence>this.genreConfidence)&&(this.currentGenre=r.genre,this.genreConfidence=r.confidence,u?.debug?.log("GenreGradientEvolution",`Genre detected: ${this.currentGenre} (confidence: ${this.genreConfidence.toFixed(2)})`),this.updateVisualEvolution(),document.dispatchEvent(new CustomEvent("genre-gradient:genre-detected",{detail:{genre:this.currentGenre,confidence:this.genreConfidence}})))}calculateGenreConsensus(t){let e={};t.forEach((r,n)=>{let s=(n+1)/t.length,o=r.confidence*s;e[r.genre]=(e[r.genre]||0)+o});let i="unknown",a=0;for(let[r,n]of Object.entries(e))n!==void 0&&n>a&&(a=n,i=r);return{genre:i,confidence:a/t.length}}updateVisualEvolution(){if(this.currentGenre==="unknown")return;let t=this.genreVisualStyles[this.currentGenre],e=this.emotionalGradientMapper?.getCurrentEmotionalProfile()||null;this.applyGenreVisualStyle(t,e)}applyGenreVisualStyle(t,e){let i=t.primaryHueRange[1]-t.primaryHueRange[0],a=t.primaryHueRange[0]+i*.5,r=e?(e.valence-.5)*i*.3:0;this.cssVariableController.setProperty("--sn-genre-base-hue",`${a+r}deg`),this.cssVariableController.setProperty("--sn-genre-hue-range",`${i}deg`);let n=e?e.arousal*.3:0,s=e?e.energy*.2:0;this.cssVariableController.setProperty("--sn-genre-saturation-base",(t.saturationProfile[0]+n).toString()),this.cssVariableController.setProperty("--sn-genre-saturation-variation",t.saturationProfile[1].toString()),this.cssVariableController.setProperty("--sn-genre-brightness-base",(t.brightnessProfile[0]+s).toString()),this.cssVariableController.setProperty("--sn-genre-brightness-variation",t.brightnessProfile[1].toString()),this.cssVariableController.setProperty("--sn-genre-contrast-level",t.contrastLevel.toString()),this.cssVariableController.setProperty("--sn-genre-edge-sharpness",t.edgeSharpness.toString()),this.cssVariableController.setProperty("--sn-genre-gradient-complexity",t.gradientComplexity.toString());let o=e?.5+e.energy:1;this.cssVariableController.setProperty("--sn-genre-animation-speed",o.toString()),this.cssVariableController.setProperty("--sn-genre-pulse-intensity",t.depthIllusion.toString());let c=this.mapLayerBlending(t.layerBlending);this.cssVariableController.setProperty("--sn-genre-layer-harmony",c.toString()),this.cssVariableController.setProperty("--sn-genre-depth-illusion",t.depthIllusion.toString()),this.cssVariableController.setProperty("--sn-genre-particle-influence",t.particleInfluence.toString()),this.cssVariableController.setProperty("--sn-genre-memory-influence",t.memoryInfluence.toString()),this.cssVariableController.setProperty("--sn-genre-adaptation-speed",t.adaptationSpeed.toString()),this.cssVariableController.setProperty("--sn-genre-stability-preference",t.stabilityPreference.toString()),this.cssVariableController.setProperty("--sn-current-genre",this.currentGenre),this.cssVariableController.setProperty("--sn-genre-confidence",this.genreConfidence.toString()),this.updateGenreGradientCoordination(t,e)}updateGenreGradientCoordination(t,e){let i=getComputedStyle(document.documentElement),a=i.getPropertyValue("--sn-bg-gradient-primary").trim(),r=i.getPropertyValue("--sn-bg-gradient-secondary").trim(),n=i.getPropertyValue("--sn-bg-gradient-accent").trim();if(a||r||n){let s=e?.5+e.energy:1,o=this.calculateGenreAngle(t);this.cssVariableController.setProperty("--sn-bg-gradient-angle",`${o}deg`);let c=this.calculateGenreOpacity(t,e);this.cssVariableController.setProperty("--sn-bg-gradient-opacity",c.toString());let m=Math.max(60,120*(1-t.edgeSharpness));this.cssVariableController.setProperty("--sn-bg-gradient-blur",`${m}px`);let d=e?e.arousal*.3:0,h=e?e.energy*.2:0;this.cssVariableController.setProperty("--sn-bg-gradient-saturation",(t.saturationProfile[0]+d).toString()),this.cssVariableController.setProperty("--sn-bg-gradient-brightness",(t.brightnessProfile[0]+h).toString()),this.cssVariableController.setProperty("--sn-bg-gradient-contrast",t.contrastLevel.toString()),u?.debug?.log("GenreGradientEvolution",`Coordinated genre "${this.currentGenre}" modifications with gradient system: angle=${o}\xB0, opacity=${c}`)}}calculateGenreAngle(t){return{electronic:135,rock:45,classical:90,jazz:120,"hip-hop":0,ambient:180,pop:315,metal:225,folk:60,funk:30,indie:150,reggae:210,blues:270,country:45,techno:135,house:315,trance:90,dubstep:180,unknown:45}[this.currentGenre]||45}calculateGenreOpacity(t,e){let i=.8;switch(this.currentGenre){case"ambient":case"classical":i=.6;break;case"metal":case"rock":case"dubstep":i=.9;break;case"jazz":case"blues":i=.75;break;default:i=.8}return e&&(i*=.7+e.energy*.3),Math.max(.3,Math.min(1,i))}mapLayerBlending(t){switch(t){case"harmonious":return .9;case"complementary":return .7;case"contrasting":return .5;case"clashing":return .3;default:return .7}}getCurrentGenre(){return this.currentGenre}getGenreConfidence(){return this.genreConfidence}getGenreHistory(){return[...this.genreHistory]}setGenreOverride(t,e=1e4){this.currentGenre=t,this.genreConfidence=1,this.updateVisualEvolution(),u?.debug?.log("GenreGradientEvolution",`Genre override: ${t} for ${e}ms`),setTimeout(()=>{this.genreConfidence=0,u?.debug?.log("GenreGradientEvolution","Genre override expired, returning to automatic detection")},e)}getGenreCharacteristics(t){return this.genreProfiles[t||this.currentGenre]}getGenreVisualStyle(t){return this.genreVisualStyles[t||this.currentGenre]}destroy(){this.isActive=!1,this.boundSpectralHandler&&document.removeEventListener("music-sync:data-updated",this.boundSpectralHandler),this.boundEmotionalHandler&&document.removeEventListener("emotional-gradient:profile-updated",this.boundEmotionalHandler),this.genreAnalysisBuffer=[],this.genreHistory=[],u?.debug?.log("GenreGradientEvolution","Genre evolution system destroyed")}}});var Re,Ea,p,k=y(()=>{"use strict";A();Re=class Re{constructor(){this.subscriptions=new Map;this.eventMetrics={totalEvents:0,totalSubscriptions:0,activeSubscriptions:0,eventsPerSecond:0,topEvents:[],memoryUsage:0};this.eventQueue=[];this.processingQueue=!1;this.maxQueueSize=1e3;this.subscriptionCleanupInterval=null;this.metricsUpdateInterval=null;this.startMetricsMonitoring(),this.startSubscriptionCleanup(),u?.debug?.log("UnifiedEventBus","Unified event bus initialized")}static getInstance(){return Re.instance||(Re.instance=new Re),Re.instance}subscribe(t,e,i="anonymous",a={}){let r=this.generateSubscriptionId();this.subscriptions.has(t)||this.subscriptions.set(t,new Map);let n={id:r,eventName:t,handler:e,subscriberName:i,once:a.once||!1,createdAt:Date.now(),triggerCount:0};return this.subscriptions.get(t).set(r,n),this.eventMetrics.totalSubscriptions++,this.eventMetrics.activeSubscriptions++,u?.debug?.log("UnifiedEventBus",`Subscription added: ${i} -> ${t}`,{subscriptionId:r,totalSubscriptions:this.eventMetrics.activeSubscriptions}),r}once(t,e,i="anonymous"){return this.subscribe(t,e,i,{once:!0})}unsubscribe(t){for(let[e,i]of this.subscriptions.entries())if(i.has(t)){let a=i.get(t);return i.delete(t),i.size===0&&this.subscriptions.delete(e),this.eventMetrics.activeSubscriptions--,u?.debug?.log("UnifiedEventBus",`Subscription removed: ${a.subscriberName} -> ${e}`,{subscriptionId:t,remainingSubscriptions:this.eventMetrics.activeSubscriptions}),!0}return!1}unsubscribeAll(t){let e=0;for(let[i,a]of this.subscriptions.entries()){let r=Array.from(a.values()).filter(n=>n.subscriberName===t);for(let n of r)a.delete(n.id),e++,this.eventMetrics.activeSubscriptions--;a.size===0&&this.subscriptions.delete(i)}return e>0&&u?.debug?.log("UnifiedEventBus",`Removed ${e} subscriptions for: ${t}`),e}async emit(t,e){let i=Date.now();if(this.processingQueue||this.eventQueue.length>0){if(this.eventQueue.length>=this.maxQueueSize){u?.debug?.warn("UnifiedEventBus",`Event queue full, dropping event: ${t}`);return}this.eventQueue.push({eventName:t,data:e,timestamp:i}),this.processEventQueue();return}await this.processEvent(t,e,i)}emitSync(t,e){let i=Date.now();this.processEventSync(t,e,i)}async processEvent(t,e,i){let a=this.subscriptions.get(t);if(!a||a.size===0)return;this.eventMetrics.totalEvents++;let r=[],n=[];for(let[o,c]of a.entries())r.push({subscription:c,handler:c.handler}),c.once&&n.push(o),c.lastTriggered=i,c.triggerCount++;let s=r.map(async({subscription:o,handler:c})=>{try{await c(e)}catch(m){u?.debug?.error("UnifiedEventBus",`Handler error in ${o.subscriberName} for ${t}:`,m),this.emitSync("system:error",{systemName:o.subscriberName,error:m instanceof Error?m.message:"Unknown error",severity:"error",timestamp:Date.now()})}});await Promise.all(s);for(let o of n)a.delete(o),this.eventMetrics.activeSubscriptions--;a.size===0&&this.subscriptions.delete(t),u?.debug?.log("UnifiedEventBus",`Event processed: ${t}`,{handlerCount:r.length,processingTime:Date.now()-i})}processEventSync(t,e,i){let a=this.subscriptions.get(t);if(!a||a.size===0)return;this.eventMetrics.totalEvents++;let r=[];for(let[n,s]of a.entries())try{s.handler(e),s.lastTriggered=i,s.triggerCount++,s.once&&r.push(n)}catch(o){u?.debug?.error("UnifiedEventBus",`Sync handler error in ${s.subscriberName} for ${t}:`,o)}for(let n of r)a.delete(n),this.eventMetrics.activeSubscriptions--;a.size===0&&this.subscriptions.delete(t)}async processEventQueue(){if(!this.processingQueue){for(this.processingQueue=!0;this.eventQueue.length>0;){let t=this.eventQueue.shift();await this.processEvent(t.eventName,t.data,t.timestamp)}this.processingQueue=!1}}getMetrics(){return{...this.eventMetrics}}getActiveSubscriptions(){let t=[];for(let[e,i]of this.subscriptions.entries())for(let[a,r]of i.entries())t.push({eventName:e,subscriberName:r.subscriberName,subscriptionId:a,createdAt:r.createdAt,triggerCount:r.triggerCount});return t.sort((e,i)=>i.createdAt-e.createdAt)}startMetricsMonitoring(){this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},5e3)}startSubscriptionCleanup(){this.subscriptionCleanupInterval=window.setInterval(()=>{this.cleanupAbandonedSubscriptions()},6e4)}updateMetrics(){let t=Date.now(),e=this.eventMetrics.totalEvents,i=new Map;for(let[a,r]of this.subscriptions.entries()){let n=0;for(let s of r.values())n+=s.triggerCount;i.set(a,n)}this.eventMetrics.topEvents=Array.from(i.entries()).sort((a,r)=>r[1]-a[1]).slice(0,10).map(([a,r])=>({eventName:a,count:r})),this.eventMetrics.memoryUsage=this.eventMetrics.activeSubscriptions*256}cleanupAbandonedSubscriptions(){let t=Date.now()-3e5,e=0;for(let[i,a]of this.subscriptions.entries()){let r=Array.from(a.values()).filter(n=>!n.lastTriggered&&n.createdAt<t);for(let n of r)a.delete(n.id),e++,this.eventMetrics.activeSubscriptions--;a.size===0&&this.subscriptions.delete(i)}e>0&&u?.debug?.log("UnifiedEventBus",`Cleaned up ${e} abandoned subscriptions`)}generateSubscriptionId(){return`sub_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}destroy(){this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this.subscriptionCleanupInterval&&(clearInterval(this.subscriptionCleanupInterval),this.subscriptionCleanupInterval=null),this.subscriptions.clear(),this.eventQueue=[],this.eventMetrics={totalEvents:0,totalSubscriptions:0,activeSubscriptions:0,eventsPerSecond:0,topEvents:[],memoryUsage:0},u?.debug?.log("UnifiedEventBus","Unified event bus destroyed"),Re.instance=null}};Re.instance=null;Ea=Re,p=Ea.getInstance()});var oi,rn=y(()=>{"use strict";oi=l=>({version:"1.0.0",userId:l,createdAt:Date.now(),lastModified:Date.now(),colorMemories:new Map,rhythmicPreferences:new Map,emotionalResonanceProfile:{},evolutionaryTrajectory:{adaptability:.5,explorationFactor:.5,lastUpdate:Date.now()}})});function ko(){return nn||(nn=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Ro(){return sn||(sn=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}function Vo(l){let t=new Promise((e,i)=>{let a=()=>{l.removeEventListener("success",r),l.removeEventListener("error",n)},r=()=>{e(tt(l.result)),a()},n=()=>{i(l.error),a()};l.addEventListener("success",r),l.addEventListener("error",n)});return li.set(t,l),t}function Bo(l){if(Pa.has(l))return;let t=new Promise((e,i)=>{let a=()=>{l.removeEventListener("complete",r),l.removeEventListener("error",n),l.removeEventListener("abort",n)},r=()=>{e(),a()},n=()=>{i(l.error||new DOMException("AbortError","AbortError")),a()};l.addEventListener("complete",r),l.addEventListener("error",n),l.addEventListener("abort",n)});Pa.set(l,t)}function un(l){xa=l(xa)}function Fo(l){return Ro().includes(l)?function(...t){return l.apply(Aa(this),t),tt(this.request)}:function(...t){return tt(l.apply(Aa(this),t))}}function Go(l){return typeof l=="function"?Fo(l):(l instanceof IDBTransaction&&Bo(l),Ta(l,ko())?new Proxy(l,xa):l)}function tt(l){if(l instanceof IDBRequest)return Vo(l);if(Ma.has(l))return Ma.get(l);let t=Go(l);return t!==l&&(Ma.set(l,t),li.set(t,l)),t}function mn(l,t,{blocked:e,upgrade:i,blocking:a,terminated:r}={}){let n=indexedDB.open(l,t),s=tt(n);return i&&n.addEventListener("upgradeneeded",o=>{i(tt(n.result),o.oldVersion,o.newVersion,tt(n.transaction),o)}),e&&n.addEventListener("blocked",o=>e(o.oldVersion,o.newVersion,o)),s.then(o=>{r&&o.addEventListener("close",()=>r()),a&&o.addEventListener("versionchange",c=>a(c.oldVersion,c.newVersion,c))}).catch(()=>{}),s}function on(l,t){if(!(l instanceof IDBDatabase&&!(t in l)&&typeof t=="string"))return;if(wa.get(t))return wa.get(t);let e=t.replace(/FromIndex$/,""),i=t!==e,a=Ho.includes(e);if(!(e in(i?IDBIndex:IDBObjectStore).prototype)||!(a||_o.includes(e)))return;let r=async function(n,...s){let o=this.transaction(n,a?"readwrite":"readonly"),c=o.store;return i&&(c=c.index(s.shift())),(await Promise.all([c[e](...s),a&&o.done]))[0]};return wa.set(t,r),r}async function*Oo(...l){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...l)),!t)return;t=t;let e=new Proxy(t,Uo);for(dn.set(e,t),li.set(e,Aa(t));t;)yield e,t=await(Ia.get(e)||t.continue()),Ia.delete(e)}function cn(l,t){return t===Symbol.asyncIterator&&Ta(l,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&Ta(l,[IDBIndex,IDBObjectStore])}var Ta,nn,sn,Pa,Ma,li,xa,Aa,_o,Ho,wa,zo,ln,Ia,dn,Uo,hn=y(()=>{Ta=(l,t)=>t.some(e=>l instanceof e);Pa=new WeakMap,Ma=new WeakMap,li=new WeakMap;xa={get(l,t,e){if(l instanceof IDBTransaction){if(t==="done")return Pa.get(l);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return tt(l[t])},set(l,t,e){return l[t]=e,!0},has(l,t){return l instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in l}};Aa=l=>li.get(l);_o=["get","getKey","getAll","getAllKeys","count"],Ho=["put","add","delete","clear"],wa=new Map;un(l=>({...l,get:(t,e,i)=>on(t,e)||l.get(t,e,i),has:(t,e)=>!!on(t,e)||l.has(t,e)}));zo=["continue","continuePrimaryKey","advance"],ln={},Ia=new WeakMap,dn=new WeakMap,Uo={get(l,t){if(!zo.includes(t))return l[t];let e=ln[t];return e||(e=ln[t]=function(...i){Ia.set(this,dn.get(this)[t](...i))}),e}};un(l=>({...l,get(t,e,i){return cn(t,e)?Oo:l.get(t,e,i)},has(t,e){return cn(t,e)||l.has(t,e)}}))});var No,$o,ci,gn,Da,Mt,pn=y(()=>{"use strict";rn();hn();No="Year3000-TemporalMemory",$o=1,ci="aestheticSignatures",gn="currentUser",Da=class{constructor(){this.dbPromise=mn(No,$o,{upgrade(t){t.objectStoreNames.contains(ci)||t.createObjectStore(ci)}})}async getSignature(t="defaultUser"){try{let i=await(await this.dbPromise).get(ci,gn);if(i)return i;{let a=oi(t);return await this.saveSignature(a),a}}catch(e){return console.error("[TemporalMemoryService] Failed to get signature from IndexedDB. Returning default.",e),oi(t)}}async saveSignature(t){try{let e=await this.dbPromise;t.lastModified=Date.now(),await e.put(ci,t,gn)}catch(e){console.error("[TemporalMemoryService] Failed to save signature to IndexedDB.",e)}}async resetSignature(t="defaultUser"){let e=oi(t);return await this.saveSignature(e),console.log("[TemporalMemoryService] Aesthetic signature has been reset."),e}async getSignatureTrends(t){if(!t)return null;let e={dominantColor:null,dominantRhythm:null,avgEnergy:0,avgValence:0},i=null;t.colorMemories.forEach((s,o)=>{(!i||s.count>i.count)&&(i={hex:o,count:s.count}),e.avgValence+=s.emotionalValence*s.count});let a=0;t.colorMemories.forEach(s=>a+=s.count),a>0&&(e.avgValence/=a),e.dominantColor=i;let r=null;t.rhythmicPreferences.forEach((s,o)=>{(!r||s.count>r.count)&&(r={id:o,count:s.count}),e.avgEnergy+=s.associatedEnergy*s.count});let n=0;return t.rhythmicPreferences.forEach(s=>n+=s.count),n>0&&(e.avgEnergy/=n),e.dominantRhythm=r,e}},Mt=new Da});var Ce,he,ui=y(()=>{"use strict";k();pn();Ce=class Ce{constructor(t,e,i,a){this.performanceCoordinator=null;this.cssAnimationManager=null;this.animations=new Map;this.frameCallbacks=new Map;this.callbackCounter=0;this.animationFrameId=null;this.isRunning=!1;this.isPaused=!1;this.lastTimestamp=0;this.frameCount=0;this.startTime=0;this.frameTimeBudget=16;this.metrics={totalFrames:0,droppedFrames:0,averageFrameTime:0,maxFrameTime:0,performanceMode:"quality",activeAnimations:0,activeCallbacks:0,frameRate:60,lastOptimization:0};this.frameContext={timestamp:0,deltaMs:0,performanceMode:"quality",frameBudget:16,beatIntensity:0,scrollRatio:0,tiltXY:{x:0,y:0}};this.performanceHistory=[];this.MAX_HISTORY_SIZE=60;this.cssVariableManager=null;this.cssAnimationStates=new Map;this.activeCSSAnimations=new Map;this.cssAnimationObservers=new Map;this.beatSyncState={intensity:0,tempo:120,phase:0,lastBeatTime:0,avgBeatInterval:500};this.lerpOperations=new Map;this.CSS_ANIMATION_CONFIGS={visualEffectsGentleBreathing:{name:"visualEffects-gentle-animation",duration:4e3,easing:"ease-in-out",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},energeticPulse:{name:"energetic-pulse-animation",duration:1200,easing:"cubic-bezier(0.23, 1, 0.32, 1)",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"alternate"},meditativeFlow:{name:"meditative-flow-animation",duration:8e3,easing:"ease-in-out",iterations:"infinite",fillMode:"both",playState:"running",delay:0,direction:"normal"}};this.signature=null;this.saveInterval=null;this.currentBpm=120;this.currentIntensity=.5;this.emergentEventSubscriptions=[];this.animate=()=>{if(!this.isRunning)return;let t=performance.now(),e=t-this.lastTimestamp;if(this.isPaused){this.animationFrameId=requestAnimationFrame(this.animate);return}this.frameContext.timestamp=t,this.frameContext.deltaMs=e;let i=performance.now(),a=this.frameTimeBudget,r=performance.now();this.executeFrameCallbacks(e,t);let n=performance.now()-r,s=a-n;s>2?this.executeAnimationSystemsWithBudget(e,t,s):(this.metrics.droppedFrames++,this.config.enableDebug&&Math.random()<.1&&console.warn(`[EnhancedMasterAnimationCoordinator] Skipped animation systems - budget exceeded: ${n.toFixed(2)}ms`));let o=performance.now()-i;o<a*.7&&this.updateConsolidatedAnimations(t,e),o<a*.8&&this.processEmergentTick(e);let c=performance.now()-i;this.updatePerformanceMetrics(c),this.performanceCoordinator&&this.performanceCoordinator.trackSubsystem("MasterAnimationCoordinator",{frameTime:c,fps:this.metrics.frameRate,memoryUsage:performance.memory?.usedJSHeapSize||0,cpuUsage:c>this.frameTimeBudget?c/this.frameTimeBudget*10:0}),this.lastTimestamp=t,this.frameCount++,c>a*1.5?setTimeout(()=>{this.animationFrameId=requestAnimationFrame(this.animate)},4):this.animationFrameId=requestAnimationFrame(this.animate)};this.config=t,this.eventBus=p,this.performanceCoordinator=e||null,this.cssAnimationManager=i||null,this.cssVariableManager=a||null,this.startTime=performance.now(),this.lastTimestamp=this.startTime,this.currentMultipliers=this.config.cosmicMultipliers,this.initializeConsolidatedSystems(),this.subscribeToEvents(),this.initializeEmergentChoreography(),this.updateFrameBudget(),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Initialized with unified animation coordination, CSS management, and LERP orchestration")}coordinateVisualEffectsPulsing(t){if(!this.cssAnimationManager)return;let e=t.energy||t.intensity||.5,i=t.bpm||this.currentBpm||120;if(Math.abs(e-this.currentIntensity)<.1&&Math.abs(i-this.currentBpm)<5)return;let r=document.querySelectorAll(".Root__main-view::before, .Root__main-view, [data-visual-effects-pulsing]");r.length>0&&(this.triggerConsciousnessBreathing(r,e,i),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Visual effects pulsing coordinated - Energy: ${e.toFixed(2)}, Tempo: ${i} BPM`)),this.currentIntensity=e,this.currentBpm=i}static getInstance(t,e,i){if(!Ce.instance){if(!t)throw new Error("EnhancedMasterAnimationCoordinator requires config for first initialization");Ce.instance=new Ce(t,e,i)}return Ce.instance}registerCSSAnimationManager(t){this.cssAnimationManager=t,this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] CSSAnimationManager registered for pulsing coordination")}registerAnimationSystem(t,e,i="normal",a=60){if(this.animations.has(t))return this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] Animation system ${t} already registered`),!1;let r={name:t,system:e,priority:i,targetFPS:a,type:"animation",enabled:!0,frameInterval:1e3/a,lastUpdate:0,frameCount:0,totalTime:0,averageFrameTime:0,maxFrameTime:0,skippedFrames:0};return this.animations.set(t,r),this.isRunning||this.startMasterAnimationLoop(),this.updateMetrics(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Registered animation system: ${t} (priority: ${i}, fps: ${a})`),!0}registerVisualSystem(t,e="normal"){if(this.animations.has(t.systemName))return this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] Visual system ${t.systemName} already registered`),!1;let i={name:t.systemName,system:t,priority:e,targetFPS:60,type:"visual",enabled:!0,frameInterval:16.67,lastUpdate:0,frameCount:0,totalTime:0,averageFrameTime:0,maxFrameTime:0,skippedFrames:0};return this.animations.set(t.systemName,i),this.isRunning||this.startMasterAnimationLoop(),this.updateMetrics(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Registered visual system: ${t.systemName} (priority: ${e})`),!0}registerFrameCallback(t,e="normal",i){let a=`callback_${++this.callbackCounter}`,r={id:a,callback:t,priority:e,system:i||void 0,enabled:!0,frameCount:0,totalTime:0,lastExecution:0};return this.frameCallbacks.set(a,r),this.isRunning||this.startMasterAnimationLoop(),this.updateMetrics(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Registered frame callback: ${a} (priority: ${e})`),a}unregisterAnimationSystem(t){let e=this.animations.delete(t);return e&&(this.updateMetrics(),this.animations.size===0&&this.frameCallbacks.size===0&&this.stopMasterAnimationLoop(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Unregistered animation system: ${t}`)),e}unregisterFrameCallback(t){let e=this.frameCallbacks.delete(t);return e&&(this.updateMetrics(),this.animations.size===0&&this.frameCallbacks.size===0&&this.stopMasterAnimationLoop(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Unregistered frame callback: ${t}`)),e}startMasterAnimationLoop(){this.isRunning||(this.isRunning=!0,this.isPaused=!1,this.lastTimestamp=performance.now(),this.frameCount=0,this.animate(),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Master animation loop started"))}stopMasterAnimationLoop(){this.isRunning&&(this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Master animation loop stopped"))}pauseAnimationLoop(){this.isPaused=!0,this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Animation loop paused")}resumeAnimationLoop(){this.isPaused&&(this.isPaused=!1,this.lastTimestamp=performance.now(),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Animation loop resumed"))}setPerformanceMode(t){this.metrics.performanceMode=t,this.frameContext.performanceMode=t,this.frameTimeBudget=t==="performance"?8:16,this.frameContext.frameBudget=this.frameTimeBudget;for(let e of this.animations.values())e.system.onPerformanceModeChange&&e.system.onPerformanceModeChange(t);this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Performance mode set to: ${t}`)}getPerformanceMetrics(){return{...this.metrics}}getRegisteredSystems(){return{animations:new Map(this.animations),callbacks:new Map(this.frameCallbacks)}}setSystemEnabled(t,e){let i=this.animations.get(t);return i?(i.enabled=e,this.updateMetrics(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] System ${t} ${e?"enabled":"disabled"}`),!0):!1}getCurrentMultipliers(){return this.currentMultipliers}async updateEvolutionaryTrajectory(){await this._updateEvolutionaryTrajectory()}destroy(){this.stopMasterAnimationLoop(),this.destroyConsolidatedSystems(),this.destroyEmergentChoreography();for(let t of this.animations.values())if(t.type==="visual"&&"destroy"in t.system)try{t.system.destroy()}catch(e){console.error(`[EnhancedMasterAnimationCoordinator] Error destroying system ${t.name}:`,e)}this.animations.clear(),this.frameCallbacks.clear(),Ce.instance===this&&(Ce.instance=null),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Destroyed")}executeFrameCallbacks(t,e){let i=Array.from(this.frameCallbacks.values()).filter(a=>a.enabled).sort((a,r)=>{let n={critical:0,normal:1,background:2};return n[a.priority]-n[r.priority]});for(let a of i){let r=performance.now();try{a.callback(t,e);let n=performance.now()-r;a.totalTime+=n,a.frameCount++,a.lastExecution=e,n>this.frameTimeBudget*.5&&this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] Callback ${a.id} exceeded budget: ${n.toFixed(2)}ms`)}catch(n){console.error(`[EnhancedMasterAnimationCoordinator] Error in callback ${a.id}:`,n)}}}executeAnimationSystems(t,e){let i=Array.from(this.animations.values()).filter(a=>a.enabled).sort((a,r)=>{let n={critical:0,normal:1,background:2};return n[a.priority]-n[r.priority]});for(let a of i){if(e-a.lastUpdate<a.frameInterval){a.skippedFrames++;continue}let r=performance.now();try{if(a.type==="visual")a.system.onAnimate(t,this.frameContext);else{let s=a.system;s.onAnimate&&s.onAnimate(t),s.updateAnimation&&s.updateAnimation(e,t)}let n=performance.now()-r;a.totalTime+=n,a.frameCount++,a.lastUpdate=e,a.averageFrameTime=a.totalTime/a.frameCount,a.maxFrameTime=Math.max(a.maxFrameTime,n),n>this.frameTimeBudget*.8&&this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] System ${a.name} exceeded budget: ${n.toFixed(2)}ms`)}catch(n){console.error(`[EnhancedMasterAnimationCoordinator] Error in system ${a.name}:`,n)}}}executeAnimationSystemsWithBudget(t,e,i){let a=performance.now(),r=Array.from(this.animations.values()).filter(c=>c.enabled).sort((c,m)=>{let d={critical:0,normal:1,background:2};return d[c.priority]-d[m.priority]}),n=0,s=0;for(let c of r){if(performance.now()-a>=i*.9){s=r.length-n,this.config.enableDebug&&s>0&&console.warn(`[EnhancedMasterAnimationCoordinator] Budget exhausted: skipped ${s} systems`);break}if(e-c.lastUpdate<c.frameInterval){c.skippedFrames++;continue}let d=performance.now();try{if(c.type==="visual")c.system.onAnimate(t,this.frameContext);else{let g=c.system;g.onAnimate&&g.onAnimate(t),g.updateAnimation&&g.updateAnimation(e,t)}let h=performance.now()-d;c.totalTime+=h,c.frameCount++,c.lastUpdate=e,c.averageFrameTime=c.totalTime/c.frameCount,c.maxFrameTime=Math.max(c.maxFrameTime,h),n++,h>i*.3&&this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] System ${c.name} consuming excessive budget: ${h.toFixed(2)}ms`)}catch(h){console.error(`[EnhancedMasterAnimationCoordinator] Error in system ${c.name}:`,h),n++}}let o=performance.now()-a;s>0&&(this.metrics.droppedFrames+=s),this.config.enableDebug&&Math.random()<.02&&console.log(`[EnhancedMasterAnimationCoordinator] Budget usage: ${o.toFixed(2)}ms/${i.toFixed(2)}ms, processed: ${n}/${r.length}`)}updatePerformanceMetrics(t){this.metrics.totalFrames++,this.metrics.maxFrameTime=Math.max(this.metrics.maxFrameTime,t),this.performanceHistory.push(t),this.performanceHistory.length>this.MAX_HISTORY_SIZE&&this.performanceHistory.shift(),this.metrics.averageFrameTime=this.performanceHistory.reduce((e,i)=>e+i,0)/this.performanceHistory.length,this.metrics.frameRate=this.performanceHistory.length>0?1e3/this.metrics.averageFrameTime:60,t>this.frameTimeBudget*1.5&&this.metrics.droppedFrames++,this.metrics.averageFrameTime>this.frameTimeBudget*1.2&&this.metrics.performanceMode==="quality"?(this.setPerformanceMode("performance"),this.metrics.lastOptimization=Date.now()):this.metrics.averageFrameTime<this.frameTimeBudget*.8&&this.metrics.performanceMode==="performance"&&Date.now()-this.metrics.lastOptimization>5e3&&this.setPerformanceMode("quality")}updateFrameBudget(){this.frameTimeBudget=this.metrics.performanceMode==="performance"?8:16,this.frameContext.frameBudget=this.frameTimeBudget}updateMetrics(){this.metrics.activeAnimations=Array.from(this.animations.values()).filter(t=>t.enabled).length,this.metrics.activeCallbacks=Array.from(this.frameCallbacks.values()).filter(t=>t.enabled).length}subscribeToEvents(){this.eventBus.subscribe("music:beat",t=>{this.frameContext.beatIntensity=t.intensity||0,this.coordinateVisualEffectsPulsing(t)},"EnhancedMasterAnimationCoordinator"),this.eventBus.subscribe("performance:frame",t=>{if(t.fps<45){for(let e of this.animations.values())e.frameInterval=Math.min(e.frameInterval*1.5,33.33);this.setPerformanceMode("performance")}else t.fps>55&&this.setPerformanceMode("quality")},"EnhancedMasterAnimationCoordinator")}async initializeEmergentChoreography(){try{this.signature=await Mt.getSignature(),this.registerEmergentEventListeners(),this.saveInterval=setInterval(()=>{this.signature&&Mt.saveSignature(this.signature)},3e4),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Emergent choreography initialized")}catch(t){console.error("[EnhancedMasterAnimationCoordinator] Failed to initialize adaptive choreography:",t)}}registerEmergentEventListeners(){let t=this.eventBus.subscribe("music:beat",r=>this.handleBeatFrame(r),"EnhancedMasterAnimationCoordinator"),e=this.eventBus.subscribe("colors:harmonized",r=>this.handleHarmonyFrame(r),"EnhancedMasterAnimationCoordinator"),i=this.eventBus.subscribe("music:energy",r=>{this.currentBpm=r.tempo},"EnhancedMasterAnimationCoordinator"),a=this.eventBus.subscribe("music:beat",r=>{this.currentIntensity=r.intensity},"EnhancedMasterAnimationCoordinator");this.emergentEventSubscriptions.push(t,e,i,a)}handleBeatFrame(t){this.signature&&(this.signature.lastModified=Date.now(),this.coordinateVisualEffectsPulsing({intensity:t.intensity||this.currentIntensity,energy:t.energy||this.currentIntensity,bpm:this.currentBpm}))}handleHarmonyFrame(t){if(!this.signature)return;let{kineticState:e}=t;this.signature.lastModified=Date.now()}async _updateEvolutionaryTrajectory(){if(!this.signature)return;let t=await Mt.getSignatureTrends(this.signature);if(!t)return;let{avgEnergy:e,avgValence:i}=t,a=.5+(e-.5)*.2;this.signature.evolutionaryTrajectory.explorationFactor=Math.max(.1,Math.min(.9,a));let r=.5+(Math.abs(i)-.2)*.3;this.signature.evolutionaryTrajectory.adaptability=Math.max(.1,Math.min(.9,r)),this.signature.evolutionaryTrajectory.lastUpdate=Date.now()}_calculateVisualPulse(t){let e=6e4/this.currentBpm,i=performance.now()%e/e,a=Math.sin(i*2*Math.PI+Math.PI/2)*15*this.currentIntensity;return{timestamp:performance.now(),bpm:this.currentBpm,intensity:this.currentIntensity,phase:i,hueShift:a}}_calculateAdaptiveCoefficients(){if(!this.signature)return;let{adaptability:t,explorationFactor:e}=this.signature.evolutionaryTrajectory,i=.5+t*.5,a=.8+e*.4;this.currentMultipliers={...this.config.cosmicMultipliers,kineticIntensity:i,visualIntensityBase:a}}processEmergentTick(t){if(!this.signature)return;this._calculateAdaptiveCoefficients(),this.signature&&Date.now()-this.signature.evolutionaryTrajectory.lastUpdate>6e4&&this._updateEvolutionaryTrajectory();let e=this._calculateVisualPulse(t),i={timestamp:performance.now(),deltaMs:t}}destroyEmergentChoreography(){this.signature&&Mt.saveSignature(this.signature),this.saveInterval&&(clearInterval(this.saveInterval),this.saveInterval=null),this.emergentEventSubscriptions.forEach(t=>this.eventBus.unsubscribe(t)),this.emergentEventSubscriptions=[],this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Emergent choreography destroyed")}initializeConsolidatedSystems(){this.cssAnimationStates.set("default",{rippleActive:!1,bloomActive:!1,refractActive:!1,oscillateActive:!1,harmonizeActive:!1,timeBasedEchoActive:!1,gravityActive:!1,beatSyncEnabled:!0,intensityLevel:.5,tempoMultiplier:1});try{this.eventBus.subscribe("music:beat",t=>{this.onBeatDetected(t)}),this.eventBus.subscribe("music:energy",t=>{this.onMusicalAnalysis(t)})}catch{console.warn("[EnhancedMasterAnimationCoordinator] Event subscription failed, using manual coordination")}this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Consolidated systems initialized")}static calculateMusicalLerp(t,e="flow",i){let a=Math.max(.3,Math.min(2,t.tempo/120)),r=Math.max(.1,Math.min(1,t.energy)),n=i||16.67*(2-r)*(1/a),s={flow:{intensityMod:.7,easingPower:1.2},pulse:{intensityMod:1.3,easingPower:2},smooth:{intensityMod:.5,easingPower:.8},sharp:{intensityMod:1.1,easingPower:3}},o=s[e]||s.flow,c=r*o.intensityMod;return{halfLife:n,intensity:c,easing:d=>Math.pow(d,o.easingPower)}}createCSSAnimation(t,e,i){try{let a=i?.animate?.({},{duration:e.duration,easing:e.easing,iterations:e.iterations==="infinite"?1/0:e.iterations,fill:e.fillMode,delay:e.delay,direction:e.direction});a&&(this.activeCSSAnimations.set(t,a),this.cssVariableManager&&this.cssVariableManager.batchSetVariables({[`--sn-animation-${t}-duration`]:`${e.duration}ms`,[`--sn-animation-${t}-easing`]:e.easing,[`--sn-animation-${t}-delay`]:`${e.delay}ms`}))}catch(a){console.warn(`[EnhancedMasterAnimationCoordinator] Failed to create CSS animation ${t}:`,a)}}createMusicalLerp(t,e,i,a,r){let n={id:t,startValue:e,targetValue:i,startTime:performance.now(),duration:a,easing:r.easing||(s=>s),onUpdate:r.onUpdate};r.musicalContext&&(n.musicalContext=r.musicalContext),r.onComplete&&(n.onComplete=r.onComplete),this.lerpOperations.set(t,n),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Created musical LERP: ${t}`)}onBeatDetected(t){this.beatSyncState.intensity=t.intensity||.5,this.beatSyncState.tempo=t.bpm||120,this.beatSyncState.lastBeatTime=performance.now(),this.cssVariableManager&&this.cssVariableManager.batchSetVariables({"--sn-beat-intensity":this.beatSyncState.intensity.toString(),"--sn-beat-tempo":this.beatSyncState.tempo.toString(),"--sn-beat-phase":(performance.now()%1e3/1e3).toString()}),this.triggerBeatSyncAnimations()}onMusicalAnalysis(t){let e={tempo:t.bpm||120,energy:t.energy||.5,valence:t.valence||.5,danceability:t.danceability||.5,emotionalTemperature:t.emotionalTemperature||4e3,beatPhase:t.beatPhase||"sustain",beatConfidence:t.beatConfidence||.5,beatInterval:t.beatInterval||500,timeSinceLastBeat:t.timeSinceLastBeat||0,bpm:t.bpm||120,beat:t.beat||0,energyLevel:t.energy||.5,harmonicContent:t.harmonic||.5,rhythmicStability:t.stability||.8,harmonicComplexity:t.harmonicComplexity||.5,rhythmicDensity:t.rhythmicDensity||.5,spectralCentroid:t.spectralCentroid||.5};this.lerpOperations.forEach((i,a)=>{i.musicalContext&&(i.musicalContext={...i.musicalContext,...e})})}triggerBeatSyncAnimations(){this.cssAnimationStates.forEach((t,e)=>{if(t.beatSyncEnabled){let i=this.beatSyncState.intensity*t.intensityLevel,a=this.beatSyncState.tempo*t.tempoMultiplier;this.cssVariableManager&&this.cssVariableManager.batchSetVariables({[`--sn-${e}-beat-intensity`]:i.toString(),[`--sn-${e}-beat-tempo`]:a.toString()})}})}processLerpOperations(t){let e=[];this.lerpOperations.forEach((i,a)=>{let r=t-i.startTime,n=Math.min(r/i.duration,1),s=i.easing(n),o=i.startValue+(i.targetValue-i.startValue)*s,c=o;if(i.musicalContext){let m=Math.sin(t*.001*i.musicalContext.bpm/60)*.1;c=o+m*i.musicalContext.energyLevel}i.onUpdate(c),n>=1&&(i.onComplete&&i.onComplete(),e.push(a))}),e.forEach(i=>this.lerpOperations.delete(i))}updateConsolidatedAnimations(t,e){if(this.processLerpOperations(t),this.updateCSSAnimationSync(t,e),this.beatSyncState.tempo>0){let i=6e4/this.beatSyncState.tempo,a=(t-this.beatSyncState.lastBeatTime)/i;this.cssVariableManager&&this.cssVariableManager.setVariable("--sn-beat-phase",(a%1).toString())}}updateCSSAnimationSync(t,e){this.activeCSSAnimations.forEach((i,a)=>{if(i.playState==="running"){let r=this.cssAnimationStates.get(a);if(r?.beatSyncEnabled){let n=this.beatSyncState.tempo/120;i.playbackRate=n*r.tempoMultiplier}}})}getConsolidatedMetrics(){return{...this.metrics,activeCSSAnimations:this.activeCSSAnimations.size,activeLerpOperations:this.lerpOperations.size,beatSyncState:{...this.beatSyncState},cssAnimationStates:this.cssAnimationStates.size}}destroyConsolidatedSystems(){this.activeCSSAnimations.forEach(t=>t.cancel()),this.activeCSSAnimations.clear(),this.lerpOperations.clear(),this.cssAnimationStates.clear(),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Consolidated systems destroyed")}triggerConsciousnessBreathing(t,e=.5,i=120){if(!t)return;(Array.isArray(t)?t:t instanceof NodeList?Array.from(t):[t]).forEach(r=>{if(r instanceof Element){this.cssVariableManager&&this.cssVariableManager.batchSetVariables({"--sn-consciousness-energy":e.toString(),"--sn-consciousness-tempo":i.toString(),"--sn-consciousness-duration":`${Math.max(1e3,4e3/Math.max(.5,e))}ms`,"--sn-consciousness-active":"1"}),r.classList.add("sn-consciousness-breathing");let n=Math.max(1e3,4e3/Math.max(.5,e));setTimeout(()=>{r.classList.remove("sn-consciousness-breathing")},n)}}),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Triggered consciousness breathing - Energy: ${e.toFixed(2)}, Tempo: ${i} BPM`)}stopConsciousnessBreathing(){document.querySelectorAll(".sn-consciousness-breathing").forEach(e=>{e.classList.remove("sn-consciousness-breathing")}),this.cssVariableManager&&this.cssVariableManager.batchSetVariables({"--sn-consciousness-active":"0","--sn-consciousness-energy":"0","--sn-consciousness-tempo":"120"}),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Stopped consciousness breathing")}triggerRipple(t,e=.5){!t||!(t instanceof Element)||(this.cssVariableManager&&this.cssVariableManager.batchSetVariables({"--sn-ripple-intensity":e.toString(),"--sn-ripple-active":"1"}),t.classList.add("sn-ripple-effect"),setTimeout(()=>{t.classList.remove("sn-ripple-effect"),this.cssVariableManager&&this.cssVariableManager.setVariable("--sn-ripple-active","0")},1e3))}getCSSAnimationManagerInterface(){return{triggerConsciousnessBreathing:this.triggerConsciousnessBreathing.bind(this),stopConsciousnessBreathing:this.stopConsciousnessBreathing.bind(this),triggerRipple:this.triggerRipple.bind(this)}}};Ce.instance=null;he=Ce});var D={};te(D,{adjustColor:()=>pl,bpmToAnimationFrameRate:()=>Zo,bpmToInterval:()=>wt,calculateBreathingScale:()=>rl,calculateContrastRatio:()=>jo,calculateNavigationScale:()=>nl,calculateOklabDerivedProperties:()=>ol,calculateRhythmPhase:()=>al,colorDifference:()=>ul,debounce:()=>qo,easeBeatAnimation:()=>il,findRequiredLuminance:()=>hl,generateHarmonicOklabColors:()=>ll,getBeatPhase:()=>el,getCanonicalAccent:()=>fl,getHealthMonitor:()=>dl,getNextBeatTime:()=>tl,getRootStyle:()=>fn,hexToRgb:()=>se,hslToRgb:()=>bn,intervalToBpm:()=>Xo,isOnBeat:()=>Jo,isValidHexColor:()=>yn,lerp:()=>cl,lerpSmooth:()=>R,lerpSmoothMusical:()=>Sn,lerpSmoothMusicalPerformance:()=>Ko,lerpSmoothSimpleMusical:()=>Qo,oklabToRgb:()=>sl,processOklabColor:()=>Va,rgbToHex:()=>it,rgbToHsl:()=>Ra,rgbToOklab:()=>La,sanitizeColorMap:()=>Yo,sleep:()=>gl,throttle:()=>Wo});function fn(){return document.documentElement}function Wo(l,t){let e;return function(...a){e||(l(...a),e=!0,setTimeout(()=>e=!1,t))}}function qo(l,t){let e;return function(...a){clearTimeout(e),e=window.setTimeout(()=>l(...a),t)}}function yn(l){if(typeof l!="string")return!1;let t=l.trim(),e=t.startsWith("#")?t:`#${t}`;return/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/.test(e)}function se(l){if(typeof l!="string")return{r:0,g:0,b:0};if(!yn(l))return{r:0,g:0,b:0};let t=l.trim(),e=t.startsWith("#")?t:`#${t}`;e=e.replace(/##+/g,"#"),e.length===4&&(e=`#${e[1]}${e[1]}${e[2]}${e[2]}${e[3]}${e[3]}`);let i=/^#([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(i)try{return{r:parseInt(i[1]||"0",16),g:parseInt(i[2]||"0",16),b:parseInt(i[3]||"0",16)}}catch{return{r:0,g:0,b:0}}else return{r:0,g:0,b:0}}function Yo(l){console.log("\u{1F3A8} [ThemeUtilities] sanitizeColorMap input:",{input:l,inputKeys:l?Object.keys(l):[],inputEntries:l?Object.entries(l):[]});let t=/^#?[0-9a-fA-F]{3}(?:[0-9a-fA-F]{3})?$/,e={};if(!l||typeof l!="object")return console.warn("\u{1F3A8} [ThemeUtilities] sanitizeColorMap: Invalid input type"),e;let i=[];return Object.entries(l).forEach(([a,r])=>{if(typeof r!="string"){i.push([a,r]),console.warn(`\u{1F3A8} [ThemeUtilities] Dropped non-string color: ${a} = ${r} (type: ${typeof r})`);return}let n=r.trim();if(!n||n==="undefined"){i.push([a,r]),console.warn(`\u{1F3A8} [ThemeUtilities] Dropped empty/undefined color: ${a} = "${r}"`);return}if(!t.test(n)){i.push([a,r]),console.warn(`\u{1F3A8} [ThemeUtilities] Dropped invalid hex color: ${a} = "${r}"`);return}let s=n.startsWith("#")?n:`#${n}`;e[a]=s}),console.log("\u{1F3A8} [ThemeUtilities] sanitizeColorMap output:",{sanitized:e,sanitizedKeys:Object.keys(e),sanitizedEntries:Object.entries(e),droppedCount:i.length,droppedEntries:i}),M?.enableDebug&&Object.keys(l).length!==Object.keys(e).length&&console.warn(`[StarryNight sanitizeColorMap] Dropped ${Object.keys(l).length-Object.keys(e).length} invalid colour entries.`),e}function Ra(l,t,e){l/=255,t/=255,e/=255;let i=Math.max(l,t,e),a=Math.min(l,t,e),r=0,n=0,s=(i+a)/2;if(i!==a){let o=i-a;switch(n=s>.5?o/(2-i-a):o/(i+a),i){case l:r=(t-e)/o+(t<e?6:0);break;case t:r=(e-l)/o+2;break;case e:r=(l-t)/o+4;break}r/=6}return{h:r*360,s:n*100,l:s*100}}function bn(l,t,e){l/=360,t/=100,e/=100;let i=(s,o,c)=>(c<0&&(c+=1),c>1&&(c-=1),c<1/6?s+(o-s)*6*c:c<1/2?o:c<2/3?s+(o-s)*(2/3-c)*6:s),a,r,n;if(t===0)a=r=n=e;else{let s=e<.5?e*(1+t):e+t-e*t,o=2*e-s;a=i(o,s,l+1/3),r=i(o,s,l),n=i(o,s,l-1/3)}return{r:Math.round(a*255),g:Math.round(r*255),b:Math.round(n*255)}}function it(l,t,e){let i=s=>{if(!Number.isFinite(s))return 0;let o=s<=1?s*255:s;return Math.min(255,Math.max(0,Math.round(o)))},[a,r,n]=[i(l),i(t),i(e)];return"#"+[a,r,n].map(s=>s.toString(16).padStart(2,"0")).join("")}function jo(l,t){let e=c=>{let[m=0,d=0,h=0]=[c.r,c.g,c.b].map(g=>(g=g/255,g<=.03928?g/12.92:Math.pow((g+.055)/1.055,2.4)));return .2126*m+.7152*d+.0722*h},i=se(l),a=se(t);if(!i||!a)return 1;let r=e(i),n=e(a),s=Math.max(r,n),o=Math.min(r,n);return(s+.05)/(o+.05)}function R(l,t,e,i){return i<=1e-5||e<=0?(M?.enableDebug&&i<=1e-5,t):t+(l-t)*Math.pow(2,-e/i)}function Sn(l,t,e,i,a="flow",r){let n=he.calculateMusicalLerp(i,a,r);return R(l,t,e,n.halfLife)}function Ko(l,t,e,i,a,r="flow",n){return a?.calculatePerformanceAwareMusicalLerp?a.calculatePerformanceAwareMusicalLerp(l,t,e,i,r,n):Sn(l,t,e,i,r,n)}function Qo(l,t,e,i=120,a=.5,r=.15){let n=Math.pow(i/120,.3),s=1+a*.3,o=r/n*s;return R(l,t,e,o)}function wt(l){return!l||l<=0?500:6e4/l}function Xo(l){return!l||l<=0?120:6e4/l}function Zo(l,t=4){return wt(l)/t}function Jo(l,t,e,i=50){let a=wt(e),n=(l-t)%a;return n<=i||n>=a-i}function el(l,t,e){let i=wt(e);return(l-t)%i/i}function tl(l,t,e){let i=wt(e),a=l-t,r=Math.floor(a/i);return t+(r+1)*i}function il(l,t="ease-out"){switch(t){case"ease-in":return l*l;case"linear":return l;case"ease-out":default:return l*(2-l)}}function al(l,t=1){let e=.001*t;return l*e%(2*Math.PI)}function rl(l,t=.5){let i=.02*t;return 1+Math.sin(l)*i}function nl(l=.5,t="neutral"){let i=t==="energetic"?1.2:t==="calm"?.8:1;return 1+.05*l*i}function La(l,t,e){let i=l/255,a=t/255,r=e/255,n=.4122214708*i+.5363325363*a+.0514459929*r,s=.2119034982*i+.6806995451*a+.1073969566*r,o=.0883024619*i+.2817188376*a+.6299787005*r,c=Math.cbrt(n),m=Math.cbrt(s),d=Math.cbrt(o);return{L:.2104542553*c+.793617785*m-.0040720468*d,a:1.9779984951*c-2.428592205*m+.4505937099*d,b:.0259040371*c+.7827717662*m-.808675766*d}}function sl(l,t,e){let i=l+.3963377774*t+.2158037573*e,a=l-.1055613458*t-.0638541728*e,r=l-.0894841775*t-1.291485548*e,n=i*i*i,s=a*a*a,o=r*r*r,c=4.0767416621*n-3.3077115913*s+.2309699292*o,m=-1.2684380046*n+2.6097574011*s-.3413193965*o,d=-.0041960863*n-.7034186147*s+1.707614701*o;return c=Math.round(Math.max(0,Math.min(1,c))*255),m=Math.round(Math.max(0,Math.min(1,m))*255),d=Math.round(Math.max(0,Math.min(1,d))*255),{r:c,g:m,b:d}}function Va(l,t={}){let{L:e,a:i,b:a}=l,r=Math.sqrt(i*i+a*a),n=Math.atan2(a,i);n<0&&(n+=2*Math.PI);let s=n*(180/Math.PI),{energy:o=.5,valence:c=.5,artisticMode:m="artist-vision"}=t,d=M.getCurrentMultipliers(),h=e*(1+(c-.5)*.1),g=r*(1+(o-.5)*.2)*(d?.saturation||1);return h=Math.max(0,Math.min(1,h*(d?.brightness||1))),{L:h,C:g,h:r>.001?s:null}}function ol(l){let{L:t,C:e,h:i}=Va(l),a=i!==null?i>=0&&i<90||i>=270&&i<=360:!1,r=i!==null?i>=90&&i<270:!1,n="neutral";return t>.7&&e>.1?n="bright":t<.4?n="dark":a&&e>.1?n="warm":r&&e>.1&&(n="cool"),{lightness:t,chroma:e,hue:i,isWarm:a,isCool:r,mood:n}}function ll(l,t="analogous",e=30){let i=Va(l);if(i.h===null)return[l];let a=(c,m,d)=>{let h=d*(Math.PI/180),g=m*Math.cos(h),f=m*Math.sin(h);return{L:c,a:g,b:f}},r=[l],{L:n,C:s,h:o}=i;switch(t){case"complementary":r.push(a(n,s,(o+180)%360));break;case"analogous":r.push(a(n,s,(o+e)%360)),r.push(a(n,s,(o-e+360)%360));break;case"triadic":r.push(a(n,s,(o+120)%360)),r.push(a(n,s,(o+240)%360));break;case"tetradic":r.push(a(n,s,(o+90)%360)),r.push(a(n,s,(o+180)%360)),r.push(a(n,s,(o+270)%360));break;case"split-complementary":r.push(a(n,s,(o+180-e)%360)),r.push(a(n,s,(o+180+e)%360));break;case"monochromatic":r.push({L:Math.max(0,n-.2),a:l.a,b:l.b}),r.push({L:Math.min(1,n+.2),a:l.a,b:l.b});break}return r}function cl(l,t,e){return(1-e)*l+e*t}function ul(l,t){let e=La(l.r,l.g,l.b),i=La(t.r,t.g,t.b),a=e.L-i.L,r=e.a-i.a,n=e.b-i.b;return Math.sqrt(a*a+r*r+n*n)}function dl(){return ml}function hl(l,t,e){let i=c=>{let[m=0,d=0,h=0]=[c.r,c.g,c.b].map(g=>(g=g/255,g<=.03928?g/12.92:Math.pow((g+.055)/1.055,2.4)));return .2126*m+.7152*d+.0722*h},a=i(t),r;r=e*(a+.05)-.05;let n=Ra(l.r,l.g,l.b),s=i(l),o=r/s;return n.l}function gl(l){return new Promise(t=>setTimeout(t,l))}function pl(l,{brightness:t=1,saturation:e=1,hue:i=0}){let a=Ra(l.r,l.g,l.b);return a.h=(a.h+i)%360,a.s=Math.max(0,Math.min(100,a.s*e)),a.l=Math.max(0,Math.min(100,a.l*t)),bn(a.h,a.s,a.l)}function fl(){let l=fn(),t=getComputedStyle(l),e=t.getPropertyValue("--sn-accent-hex").trim(),i=t.getPropertyValue("--sn-accent-rgb").trim();if(!e&&i){let[a="0",r="0",n="0"]=i.split(/\s*,\s*/),s=parseInt(a,10)||0,o=parseInt(r,10)||0,c=parseInt(n,10)||0;e=it(s,o,c)}if(!i&&e){let a=se(e);a&&(i=`${a.r},${a.g},${a.b}`)}return{hex:e,rgb:i}}var ka,ml,Z=y(()=>{"use strict";G();ui();ka=class{registerSystem(t,e){}updateSystemMetrics(t,e){}},ml=new ka});var Ee,E,ie=y(()=>{"use strict";A();Z();Ee=class Ee{constructor(t=!1){this.utils=D;this.debugEnabled=t}processColor(t,e=Ee.PRESETS.STANDARD){let i=performance.now(),a=null;try{if(a=this.utils.hexToRgb(t),!a)throw new Error(`Invalid hex color: ${t}`);let r=this.utils.rgbToOklab(a.r,a.g,a.b),n=this.enhanceOKLABColor(r,e),s=this.generateShadowColor(r,e),o=this.utils.oklabToRgb(n.L,n.a,n.b),c=this.utils.oklabToRgb(s.L,s.a,s.b),m=this.utils.rgbToHex(o.r,o.g,o.b),d=this.utils.rgbToHex(c.r,c.g,c.b),h=this.convertOklabToOklch(n),g=performance.now()-i,f={originalHex:t,originalRgb:a,enhancedHex:m,enhancedRgb:o,shadowHex:d,shadowRgb:c,oklabOriginal:r,oklabEnhanced:n,oklabShadow:s,oklchEnhanced:h,processingTime:g};return this.debugEnabled&&u?.debug?.log("OKLABColorProcessor","Color processed:",{input:t,enhanced:m,shadow:d,preset:e.name,processingTime:`${g.toFixed(2)}ms`}),f}catch(r){this.debugEnabled&&u?.debug?.error("OKLABColorProcessor","Color processing failed:",r);let n=a||{r:124,g:58,b:237};return this.createFallbackResult(t,n)}}processColorPalette(t,e=Ee.PRESETS.STANDARD){let i={};return Object.entries(t).forEach(([a,r])=>{r&&this.utils.hexToRgb(r)&&(i[a]=this.processColor(r,e))}),i}generateCSSVariables(t,e="sn-oklab"){let i={};return i[`--${e}-enhanced-hex`]=t.enhancedHex,i[`--${e}-enhanced-rgb`]=`${t.enhancedRgb.r},${t.enhancedRgb.g},${t.enhancedRgb.b}`,i[`--${e}-enhanced-r`]=Math.round(t.enhancedRgb.r).toString(),i[`--${e}-enhanced-g`]=Math.round(t.enhancedRgb.g).toString(),i[`--${e}-enhanced-b`]=Math.round(t.enhancedRgb.b).toString(),i[`--${e}-shadow-hex`]=t.shadowHex,i[`--${e}-shadow-rgb`]=`${t.shadowRgb.r},${t.shadowRgb.g},${t.shadowRgb.b}`,i[`--${e}-lightness`]=t.oklabEnhanced.L.toFixed(3),i[`--${e}-chroma-a`]=t.oklabEnhanced.a.toFixed(3),i[`--${e}-chroma-b`]=t.oklabEnhanced.b.toFixed(3),i[`--${e}-oklch-l`]=t.oklchEnhanced.L.toFixed(3),i[`--${e}-oklch-c`]=t.oklchEnhanced.C.toFixed(3),i[`--${e}-oklch-h`]=t.oklchEnhanced.H.toFixed(1),i}interpolateOKLAB(t,e,i,a=Ee.PRESETS.STANDARD){let r=this.utils.hexToRgb(t),n=this.utils.hexToRgb(e);if(!r||!n)throw new Error("Invalid hex colors for interpolation");let s=this.utils.rgbToOklab(r.r,r.g,r.b),o=this.utils.rgbToOklab(n.r,n.g,n.b),c={L:s.L+(o.L-s.L)*i,a:s.a+(o.a-s.a)*i,b:s.b+(o.b-s.b)*i},m=this.utils.oklabToRgb(c.L,c.a,c.b),d=this.utils.rgbToHex(m.r,m.g,m.b);return this.processColor(d,a)}generateOKLABGradient(t,e,i=5,a=Ee.PRESETS.STANDARD){let r=[];for(let n=0;n<i;n++){let s=n/(i-1),o=this.interpolateOKLAB(t,e,s,a);r.push(o)}return r}enhanceOKLABColor(t,e){let i=Math.sqrt(t.a*t.a+t.b*t.b),a=Math.min(1,Math.max(0,t.L*e.lightnessBoost)),r=i>e.vibrantThreshold?e.chromaBoost:1,n=t.a*r,s=t.b*r;return{L:a,a:n,b:s}}generateShadowColor(t,e){return{L:Math.max(.02,t.L*e.shadowReduction),a:t.a*.8,b:t.b*.8}}convertOklabToOklch(t){let e=t.L,i=Math.sqrt(t.a*t.a+t.b*t.b),a=Math.atan2(t.b,t.a)*(180/Math.PI);return a<0&&(a+=360),{L:e,C:i,H:a}}createFallbackResult(t,e){let i=this.utils.rgbToOklab(e.r,e.g,e.b);return{originalHex:t,originalRgb:e,enhancedHex:t,enhancedRgb:e,shadowHex:"#000000",shadowRgb:{r:0,g:0,b:0},oklabOriginal:i,oklabEnhanced:i,oklabShadow:{L:.05,a:0,b:0},oklchEnhanced:this.convertOklabToOklch(i),processingTime:0}}static getPreset(t){return Ee.PRESETS[t.toUpperCase()]||Ee.PRESETS.STANDARD}static createCustomPreset(t,e,i,a,r=.3,n=.1){return{name:t,description:e,lightnessBoost:Math.max(.5,Math.min(1.5,i)),chromaBoost:Math.max(.5,Math.min(2,a)),shadowReduction:Math.max(.1,Math.min(.5,r)),vibrantThreshold:Math.max(.05,Math.min(.2,n))}}};Ee.PRESETS={SUBTLE:{name:"Subtle Enhancement",description:"Minimal color enhancement for conservative aesthetics",lightnessBoost:1.05,chromaBoost:1.1,shadowReduction:.4,vibrantThreshold:.08},STANDARD:{name:"Standard Enhancement",description:"Balanced color enhancement for general use",lightnessBoost:1.1,chromaBoost:1.15,shadowReduction:.3,vibrantThreshold:.1},VIBRANT:{name:"Vibrant Enhancement",description:"Enhanced vibrancy for dynamic color experiences",lightnessBoost:1.15,chromaBoost:1.25,shadowReduction:.25,vibrantThreshold:.12},COSMIC:{name:"Cosmic Enhancement",description:"Maximum enhancement for Year 3000 visual-effects experiences",lightnessBoost:1.1,chromaBoost:1.2,shadowReduction:.2,vibrantThreshold:.15}};E=Ee});var mi,J,Me=y(()=>{"use strict";ie();mi={calm:{temperatureRange:[2700,4e3],baseTemperature:3200,characteristics:{energy:[0,.3],valence:[.4,.8],intensity:.6},cssClass:"smooth-emotion-calm",description:"Warm, soothing, meditative states",oklabBaseColor:"#89b4fa",oklabPreset:"SUBTLE",perceptualCharacteristics:{lightness:[.6,.8],chromaBoost:.9,hueShift:15}},melancholy:{temperatureRange:[2200,3500],baseTemperature:2800,characteristics:{energy:[0,.4],valence:[0,.4],intensity:.8},cssClass:"smooth-emotion-melancholy",description:"Deep, introspective, amber-golden tones",oklabBaseColor:"#f9e2af",oklabPreset:"STANDARD",perceptualCharacteristics:{lightness:[.4,.6],chromaBoost:1.1,hueShift:-10}},energetic:{temperatureRange:[5500,7500],baseTemperature:6500,characteristics:{energy:[.6,1],valence:[.5,1],intensity:1},cssClass:"smooth-emotion-energetic",description:"Bright, vibrant, high-energy states",oklabBaseColor:"#a6e3a1",oklabPreset:"VIBRANT",perceptualCharacteristics:{lightness:[.7,.9],chromaBoost:1.3,hueShift:5}},aggressive:{temperatureRange:[8e3,12e3],baseTemperature:1e4,characteristics:{energy:[.7,1],valence:[0,.6],intensity:1.2},cssClass:"smooth-emotion-aggressive",description:"Cool, intense, high-energy negative valence",oklabBaseColor:"#f38ba8",oklabPreset:"COSMIC",perceptualCharacteristics:{lightness:[.5,.7],chromaBoost:1.4,hueShift:-5}},happy:{temperatureRange:[4500,6500],baseTemperature:5500,characteristics:{energy:[.4,.8],valence:[.6,1],intensity:.9},cssClass:"smooth-emotion-happy",description:"Balanced, joyful, warm-white tones",oklabBaseColor:"#fab387",oklabPreset:"STANDARD",perceptualCharacteristics:{lightness:[.75,.85],chromaBoost:1.15,hueShift:8}},romantic:{temperatureRange:[2500,3500],baseTemperature:3e3,characteristics:{energy:[.2,.6],valence:[.5,.9],intensity:.7},cssClass:"smooth-emotion-romantic",description:"Soft, intimate, warm tones with pink accent",oklabBaseColor:"#f5c2e7",oklabPreset:"SUBTLE",perceptualCharacteristics:{lightness:[.65,.8],chromaBoost:1,hueShift:12}},mysterious:{temperatureRange:[1800,2800],baseTemperature:2300,characteristics:{energy:[.1,.5],valence:[.1,.5],intensity:.9},cssClass:"smooth-emotion-mysterious",description:"Deep, enigmatic, low temperature with purple accent",oklabBaseColor:"#cba6f7",oklabPreset:"VIBRANT",perceptualCharacteristics:{lightness:[.3,.5],chromaBoost:1.2,hueShift:-15}},epic:{temperatureRange:[7e3,15e3],baseTemperature:11e3,characteristics:{energy:[.6,1],valence:[.3,.8],intensity:1.3},cssClass:"smooth-emotion-epic",description:"Grand, cinematic, high contrast blue-gold",oklabBaseColor:"#74c7ec",oklabPreset:"COSMIC",perceptualCharacteristics:{lightness:[.6,.9],chromaBoost:1.35,hueShift:20}},ambient:{temperatureRange:[3e3,5e3],baseTemperature:4e3,characteristics:{energy:[.1,.4],valence:[.3,.7],intensity:.5},cssClass:"smooth-emotion-ambient",description:"Atmospheric, floating, neutral temperature",oklabBaseColor:"#94e2d5",oklabPreset:"SUBTLE",perceptualCharacteristics:{lightness:[.5,.7],chromaBoost:.8,hueShift:0}}},J=class{constructor(t=!1){this.enableDebug=t,this.oklabProcessor=new E(t)}mapMusicToEmotionalTemperature(t){let{energy:e=.5,valence:i=.5,danceability:a=.5,tempo:r=120,mode:n=1}=t,s,o,c=1;if(e>=.6&&i>=.6?(s=a>.7?"energetic":"happy",e>.8&&i>.8&&(o="epic",c=.7)):e>=.6&&i<.5?(s=e>.8?"aggressive":"epic",i<.3&&(o="mysterious",c=.8)):e<.4&&i>=.5?(s=i>.7?"calm":"romantic",e<.2&&(o="ambient",c=.6)):(s=i<.3?"melancholy":"mysterious",e<.2&&i<.2&&(o="ambient",c=.8)),t.genre){let I=this.getGenreEmotionalAdjustment(t.genre,s);I&&(I.override&&(s=I.override),I.secondary&&(o=I.secondary,c=I.blendRatio||.7))}let m=mi[s].characteristics.intensity,d=e*.3,h=Math.abs(i-.5)*.2,g=r>140?.1:r<80?-.1:0,f=Math.max(.1,Math.min(1.5,m+d+h+g)),v=mi[s],[C,T]=v.temperatureRange,w=e*.6+i*.4,V=C+(T-C)*w,W=E.getPreset(v.oklabPreset),$,_;try{let I=this.createContextualOKLABPreset(v,f,e,i);$=this.oklabProcessor.processColor(v.oklabBaseColor,I),_=$.enhancedHex,this.enableDebug&&console.log("\u{1F321}\uFE0F [EmotionalTemperatureMapper] OKLAB processing:",{emotion:s,baseColor:v.oklabBaseColor,preset:I.name,enhanced:_,oklabCoords:$.oklabEnhanced})}catch(I){this.enableDebug&&console.warn("\u{1F321}\uFE0F [EmotionalTemperatureMapper] OKLAB processing failed:",I),_=v.oklabBaseColor}let j=this.generateEmotionalCSSVariables(s,o,f,V,c,$,_),z={primaryEmotion:s,...o&&{secondaryEmotion:o},intensity:f,temperature:Math.round(V),blendRatio:c,cssClass:v.cssClass,cssVariables:j,oklabPreset:W,...$&&{oklabResult:$},..._&&{perceptualColorHex:_}};return this.enableDebug&&console.log("\u{1F321}\uFE0F [EmotionalTemperatureMapper] Music analysis result:",{input:{energy:e,valence:i,genre:t.genre},output:z,reasoning:{energyValenceQuadrant:this.getEnergyValenceQuadrant(e,i),genreInfluence:t.genre,intensityFactors:{baseIntensity:m,energyBoost:d,valenceInfluence:h,tempoInfluence:g}}}),z}createContextualOKLABPreset(t,e,i,a){let r=E.getPreset(t.oklabPreset),n=t.perceptualCharacteristics,s=i*.5+a*.3+.2,o=n.lightness[0]+(n.lightness[1]-n.lightness[0])*s,c=n.chromaBoost*e*(.8+i*.4);return E.createCustomPreset(`${t.cssClass}-contextual`,`Contextual ${r.description} for ${t.description}`,o/.5,c,r.shadowReduction,r.vibrantThreshold)}getGenreEmotionalAdjustment(t,e){let i={edm:{secondary:"energetic",blendRatio:.8},house:{secondary:"energetic",blendRatio:.7},ambient:{override:"ambient"},downtempo:{override:"calm",secondary:"ambient",blendRatio:.6},metal:{override:"aggressive"},"hard-rock":{secondary:"aggressive",blendRatio:.8},alternative:{secondary:"epic",blendRatio:.7},classical:{override:"epic",secondary:"calm",blendRatio:.6},soundtrack:{override:"epic"},orchestral:{override:"epic"},jazz:{override:"mysterious",secondary:"romantic",blendRatio:.7},blues:{override:"melancholy"},soul:{secondary:"romantic",blendRatio:.6},folk:{override:"calm",secondary:"melancholy",blendRatio:.6},acoustic:{override:"romantic",secondary:"calm",blendRatio:.7},"hip-hop":{secondary:"aggressive",blendRatio:.8},trap:{secondary:"aggressive",blendRatio:.9},pop:{secondary:"happy",blendRatio:.7},"indie-pop":{secondary:"happy",blendRatio:.6}},a=t.toLowerCase().replace(/[\s-_]/g,"-");return i[a]||null}getEnergyValenceQuadrant(t,e){return t>=.5&&e>=.5?"High Energy + Positive":t>=.5&&e<.5?"High Energy + Negative":t<.5&&e>=.5?"Low Energy + Positive":"Low Energy + Negative"}generateEmotionalCSSVariables(t,e,i,a,r,n,s){let o={};o["--smooth-current-emotion"]=t,o["--smooth-emotional-intensity"]=i.toString(),o["--smooth-current-temperature"]=a.toString(),o["--smooth-emotion-primary"]=t,e&&(o["--smooth-emotion-secondary"]=e,o["--smooth-emotion-blend-ratio"]=r.toString()),o["--smooth-emotional-saturation"]=Math.max(.5,i).toString(),o["--smooth-cinematic-contrast"]=Math.max(.8,i*1.2).toString(),o["--smooth-warmth"]=this.calculateWarmth(a).toString();let c=this.calculatePulsingSpeed(t,i);o["--smooth-pulsing-cycle"]=`${c}s`;let m=this.calculateTemperatureFilters(a,i);return Object.assign(o,m),n&&s&&(o["--smooth-emotion-oklab-hex"]=s,o["--smooth-emotion-oklab-rgb"]=`${n.enhancedRgb.r},${n.enhancedRgb.g},${n.enhancedRgb.b}`,o["--smooth-emotion-oklab-l"]=n.oklabEnhanced.L.toFixed(3),o["--smooth-emotion-oklab-a"]=n.oklabEnhanced.a.toFixed(3),o["--smooth-emotion-oklab-b"]=n.oklabEnhanced.b.toFixed(3),o["--smooth-emotion-oklch-l"]=n.oklchEnhanced.L.toFixed(3),o["--smooth-emotion-oklch-c"]=n.oklchEnhanced.C.toFixed(3),o["--smooth-emotion-oklch-h"]=n.oklchEnhanced.H.toFixed(1),o["--smooth-emotion-oklab-shadow-hex"]=n.shadowHex,o["--smooth-emotion-oklab-shadow-rgb"]=`${n.shadowRgb.r},${n.shadowRgb.g},${n.shadowRgb.b}`,o["--smooth-perceptual-emotion-color"]=s,o["--smooth-perceptual-emotion-rgb"]=`${n.enhancedRgb.r},${n.enhancedRgb.g},${n.enhancedRgb.b}`,this.enableDebug&&console.log("\u{1F3A8} [EmotionalTemperatureMapper] Generated OKLAB CSS variables:",{emotion:t,perceptualColor:s,oklabCoords:n.oklabEnhanced,oklchCoords:n.oklchEnhanced})),o}calculateWarmth(t){return t<=4e3?.7+(4e3-t)/2200*.3:t>=7e3?Math.max(.2,.7-(t-7e3)/8e3*.5):.5+(7e3-t)/3e3*.2}calculatePulsingSpeed(t,e){let a={calm:6,melancholy:8,energetic:2,aggressive:1.5,happy:3,romantic:5,mysterious:7,epic:2.5,ambient:10}[t],r=Math.max(.5,Math.min(2,2-e));return a*r}calculateTemperatureFilters(t,e){let i={},a=this.mapTemperatureToHue(t);i["--smooth-temperature-hue-shift"]=`${a}deg`;let r=Math.max(.8,Math.min(1.5,1+(e-.5)*.4));i["--smooth-temperature-saturation"]=r.toString();let n=this.mapTemperatureToBrightness(t);return i["--smooth-temperature-brightness"]=n.toString(),i}mapTemperatureToHue(t){return t<=4e3?-15+(4e3-t)/2e3*-15:t>=8e3?10+(t-8e3)/7e3*20:-5+(t-4e3)/4e3*15}mapTemperatureToBrightness(t){return .9+(t-2e3)/13e3*.3}applyEmotionalTemperature(t,e){let i=Array.from(t.classList).filter(a=>a.startsWith("smooth-emotion-"));t.classList.remove(...i),t.classList.add(e.cssClass),e.secondaryEmotion&&t.classList.add(`smooth-emotion-blend-${e.secondaryEmotion}`),Object.entries(e.cssVariables).forEach(([a,r])=>{t.style.setProperty(a,r)}),this.enableDebug&&console.log("\u{1F3A8} [EmotionalTemperatureMapper] Applied emotional temperature:",{element:t.tagName,emotion:e.primaryEmotion,secondary:e.secondaryEmotion,intensity:e.intensity,temperature:e.temperature})}static getAvailableEmotions(){return Object.keys(mi)}static getEmotionCharacteristics(t){return mi[t]}}});function b(l,t,e,i){let a=parseInt(l.slice(1,3),16),r=parseInt(l.slice(3,5),16),n=parseInt(l.slice(5,7),16),s=(.299*a+.587*r+.114*n)/255;return{hex:l,rgb:`${a}, ${r}, ${n}`,hsl:[t,e,i],brightness:s}}function vn(l,t){let e=Ve[l],i=yl[t];switch(t){case"bright":return l==="latte"?e.surface2:e.surface1;case"balanced":return l==="latte"?e.surface0:e.base;case"dark":return e.mantle;default:return e.base}}function Cn(l,t){let e=Ve[l];switch(t){case"bright":return e.surface2;case"balanced":return e.surface1;case"dark":return e.surface0;default:return e.surface1}}function En(l,t){return Ve[l][t]}function Mn(l){let t=Ve[l];return l==="latte"?t.blue:t.mauve}var Ve,yl,Ba=y(()=>{"use strict";Ve={mocha:{rosewater:b("#f5e0dc",10,56,91),flamingo:b("#f2cdcd",0,59,88),pink:b("#f5c2e7",316,72,86),mauve:b("#cba6f7",267,84,81),red:b("#f38ba8",343,81,75),maroon:b("#eba0ac",350,65,77),peach:b("#fab387",23,92,75),yellow:b("#f9e2af",41,86,83),green:b("#a6e3a1",115,54,76),teal:b("#94e2d5",174,57,73),sky:b("#89dceb",189,71,73),sapphire:b("#74c7ec",199,76,69),blue:b("#89b4fa",217,92,76),lavender:b("#b4befe",232,97,85),text:b("#cdd6f4",226,64,88),subtext1:b("#bac2de",227,35,80),subtext0:b("#a6adc8",228,24,72),overlay2:b("#9399b2",228,17,64),overlay1:b("#7f849c",230,13,55),overlay0:b("#6c7086",231,11,47),surface2:b("#585b70",233,12,39),surface1:b("#45475a",234,13,31),surface0:b("#313244",237,16,23),base:b("#1e1e2e",240,21,15),mantle:b("#181825",240,18,13),crust:b("#11111b",240,23,9)},latte:{rosewater:b("#dc8a78",11,59,67),flamingo:b("#dd7878",0,60,67),pink:b("#ea76cb",316,73,69),mauve:b("#8839ef",266,85,58),red:b("#d20f39",347,87,44),maroon:b("#e64553",355,76,59),peach:b("#fe640b",22,99,52),yellow:b("#df8e1d",35,77,49),green:b("#40a02b",109,58,40),teal:b("#179299",183,74,35),sky:b("#04a5e5",197,97,46),sapphire:b("#209fb5",189,70,42),blue:b("#1e66f5",220,91,54),lavender:b("#7287fd",231,97,72),text:b("#4c4f69",234,16,35),subtext1:b("#5c5f77",233,13,41),subtext0:b("#6c6f85",233,10,47),overlay2:b("#7c7f93",232,10,53),overlay1:b("#8c8fa1",231,10,59),overlay0:b("#9ca0b0",228,11,65),surface2:b("#acb0be",227,12,71),surface1:b("#bcc0cc",226,14,77),surface0:b("#ccd0da",225,16,83),base:b("#eff1f5",220,23,95),mantle:b("#e6e9ef",220,22,92),crust:b("#dce0e8",220,21,89)},frappe:{rosewater:b("#f2d5cf",10,57,88),flamingo:b("#eebebe",0,58,84),pink:b("#f4b8e4",316,73,84),mauve:b("#ca9ee6",277,59,76),red:b("#e78284",359,68,71),maroon:b("#ea999c",358,56,76),peach:b("#ef9f76",20,79,70),yellow:b("#e5c890",40,62,73),green:b("#a6d189",96,44,68),teal:b("#81c8be",172,39,65),sky:b("#99d1db",189,48,73),sapphire:b("#85c1dc",199,55,69),blue:b("#8caaee",222,74,74),lavender:b("#babbf1",239,66,84),text:b("#c6d0f5",227,70,87),subtext1:b("#b5bfe2",229,44,80),subtext0:b("#a5adce",230,34,72),overlay2:b("#949cbb",231,19,64),overlay1:b("#838ba7",232,16,56),overlay0:b("#737994",232,13,49),surface2:b("#626880",233,16,42),surface1:b("#51576d",234,16,35),surface0:b("#414559",235,16,30),base:b("#303446",229,19,23),mantle:b("#292c3c",231,19,20),crust:b("#232634",229,20,17)},macchiato:{rosewater:b("#f4dbd6",10,58,90),flamingo:b("#f0c6c6",0,58,86),pink:b("#f5bde6",316,74,85),mauve:b("#c6a0f6",267,83,79),red:b("#ed8796",351,74,73),maroon:b("#ee99a0",357,70,77),peach:b("#f5a97f",21,86,73),yellow:b("#eed49f",42,79,78),green:b("#a6da95",105,48,72),teal:b("#8bd5ca",172,47,69),sky:b("#91d7e3",189,59,73),sapphire:b("#7dc4e4",199,66,69),blue:b("#8aadf4",220,83,75),lavender:b("#b7bdf8",238,82,84),text:b("#cad3f5",227,68,88),subtext1:b("#b8c0e0",228,39,81),subtext0:b("#a5adcb",227,27,72),overlay2:b("#939ab7",228,20,64),overlay1:b("#8087a2",230,15,56),overlay0:b("#6e738d",230,12,48),surface2:b("#5b6078",233,16,40),surface1:b("#494d64",234,15,33),surface0:b("#363a4f",235,16,26),base:b("#24273a",232,23,19),mantle:b("#1e2030",233,23,16),crust:b("#181926",236,23,13)}},yl={bright:{baseColorTarget:.25,surfaceColorTarget:.35,textContrastMin:4.5},balanced:{baseColorTarget:.15,surfaceColorTarget:.25,textContrastMin:4.5},dark:{baseColorTarget:.08,surfaceColorTarget:.15,textContrastMin:3}}});function S(l,t,e,i){let a=parseInt(l.slice(1,3),16),r=parseInt(l.slice(3,5),16),n=parseInt(l.slice(5,7),16),s=(.299*a+.587*r+.114*n)/255;return{hex:l,rgb:`${a}, ${r}, ${n}`,hsl:[t,e,i],brightness:s}}function wn(l,t){let e=Be[l],i=Sl[t];switch(t){case"bright":return e.surface1;case"balanced":return e.surface0;case"dark":return e.base;default:return e.base}}function Tn(l,t){let e=Be[l];switch(t){case"bright":return e.surface2;case"balanced":return e.surface1;case"dark":return e.surface0;default:return e.surface1}}function Pn(l,t){return Be[l][t]}function xn(l){return Be[l].mauve}function An(l,t="medium"){let e=Be[l];switch(t){case"low":return[e.mauve,e.blue];case"medium":return[e.pink,e.peach];case"high":return[e.red,e.teal];default:return[e.mauve,e.pink]}}function In(l){let t=Be[l];return{primary:t.mauve,secondary:t.pink,tertiary:t.sky,atmosphere:t.base}}var Be,Sl,Fa=y(()=>{"use strict";Be={subtle:{rosewater:S("#e8d5d1",15,45,85),flamingo:S("#e5c3c3",0,45,82),pink:S("#d8a8cc",316,40,75),mauve:S("#9d7bc7",267,45,65),red:S("#c85a7a",343,45,60),maroon:S("#c27882",350,35,65),peach:S("#d18a5f",23,50,60),yellow:S("#d4c285",41,45,70),green:S("#8cc98a",115,35,65),teal:S("#7bc5b8",174,35,65),sky:S("#7ab5c7",189,40,65),sapphire:S("#6baac7",199,45,60),blue:S("#7d9dd4",217,50,65),lavender:S("#a8aed9",232,45,75),text:S("#c2c8d4",226,25,80),subtext1:S("#b2b8c8",227,20,72),subtext0:S("#9ca4b8",228,15,65),overlay2:S("#868ea8",228,12,58),overlay1:S("#757d95",230,10,52),overlay0:S("#656c82",231,8,45),surface2:S("#555c70",233,8,38),surface1:S("#454c5a",234,8,32),surface0:S("#353a46",237,10,25),base:S("#252832",240,12,17),mantle:S("#1f222a",240,10,15),crust:S("#181b22",240,15,12)},balanced:{rosewater:S("#f2d8d3",15,60,88),flamingo:S("#eec6c6",0,60,85),pink:S("#e8b3d8",316,55,80),mauve:S("#b388d6",267,55,70),red:S("#d16b8a",343,55,65),maroon:S("#d08692",350,45,70),peach:S("#e59a6f",23,65,65),yellow:S("#e0d295",41,55,75),green:S("#9cd49a",115,40,70),teal:S("#8bd0c3",174,40,70),sky:S("#8ac0d2",189,50,70),sapphire:S("#7bb5d2",199,55,65),blue:S("#8da8e0",217,60,70),lavender:S("#b8bee5",232,55,80),text:S("#ced4e0",226,35,85),subtext1:S("#bec4d3",227,25,77),subtext0:S("#a8b0c3",228,20,70),overlay2:S("#929ab3",228,15,63),overlay1:S("#8289a0",230,12,57),overlay0:S("#72798f",231,10,50),surface2:S("#62697d",233,10,43),surface1:S("#525968",234,10,37),surface0:S("#424954",237,12,30),base:S("#2f323e",240,15,22),mantle:S("#282b36",240,12,19),crust:S("#21242e",240,18,16)},cinematic:{rosewater:S("#fce0db",15,85,92),flamingo:S("#f5c9c9",0,85,88),pink:S("#ff6b9d",316,100,70),mauve:S("#6c5ce7",267,85,65),red:S("#ff4757",343,100,65),maroon:S("#e84393",350,80,70),peach:S("#fd7f28",23,95,58),yellow:S("#f39c12",41,88,52),green:S("#a6e3a1",115,54,76),teal:S("#00cec9",174,100,40),sky:S("#74b9ff",189,100,72),sapphire:S("#0984e3",199,100,46),blue:S("#a29bfe",217,95,80),lavender:S("#c77dff",232,100,75),text:S("#e8f0ff",226,100,95),subtext1:S("#d0d8f0",227,65,88),subtext0:S("#b8c0d8",228,45,80),overlay2:S("#a0a8c0",228,30,70),overlay1:S("#8890a8",230,20,60),overlay0:S("#707890",231,15,50),surface2:S("#586078",233,15,42),surface1:S("#485060",234,15,35),surface0:S("#384048",237,18,28),base:S("#202030",240,25,16),mantle:S("#181828",240,22,13),crust:S("#101020",240,30,9)},maximum:{rosewater:S("#ffe5e0",15,100,95),flamingo:S("#ffcccc",0,100,90),pink:S("#ff3d7f",316,100,62),mauve:S("#5a4fcf",267,100,55),red:S("#ff2942",343,100,58),maroon:S("#e6337a",350,90,65),peach:S("#ff6500",23,100,50),yellow:S("#f1c40f",48,89,50),green:S("#00ff88",150,100,50),teal:S("#00ffff",180,100,50),sky:S("#4da6ff",189,100,65),sapphire:S("#0066ff",199,100,50),blue:S("#8a7fff",217,100,75),lavender:S("#b347ff",232,100,65),text:S("#ffffff",0,0,100),subtext1:S("#e8e8ff",240,100,95),subtext0:S("#d0d0ff",240,100,90),overlay2:S("#b8b8ff",240,100,85),overlay1:S("#a0a0ff",240,100,80),overlay0:S("#8888ff",240,100,75),surface2:S("#4040aa",240,60,45),surface1:S("#303088",240,65,35),surface0:S("#202066",240,70,25),base:S("#0f0f33",240,70,13),mantle:S("#0a0a22",240,75,10),crust:S("#050511",240,80,5)}},Sl={bright:{baseColorTarget:.25,surfaceColorTarget:.35,textContrastMin:4.5},balanced:{baseColorTarget:.15,surfaceColorTarget:.25,textContrastMin:4.5},dark:{baseColorTarget:.08,surfaceColorTarget:.15,textContrastMin:3}}});function Dn(l,t="balanced"){return K.getBrightnessAdjustedBaseColor(l,t)}function Ln(l,t="balanced"){return K.getBrightnessAdjustedSurfaceColor(l,t)}function _a(l){return K.getDefaultAccentColor(l)}function kn(l,t){return K.getAccentColor(l,t)}var Ga,K,Tt=y(()=>{"use strict";G();Ba();Fa();Ba();Fa();Ga=class l{constructor(){}static getInstance(){return l.instance||(l.instance=new l),l.instance}getCurrentPaletteSystem(){return M.paletteSystem||"catppuccin"}getCurrentPalette(){return this.getCurrentPaletteSystem()==="year3000"?Be:Ve}getCurrentDefaultFlavor(){return this.getCurrentPaletteSystem()==="year3000"?"balanced":"mocha"}getBrightnessAdjustedBaseColor(t,e="balanced"){let i=this.getCurrentPaletteSystem(),a=t||this.getCurrentDefaultFlavor();return i==="year3000"?wn(a,e):vn(a,e)}getBrightnessAdjustedSurfaceColor(t,e="balanced"){let i=this.getCurrentPaletteSystem(),a=t||this.getCurrentDefaultFlavor();return i==="year3000"?Tn(a,e):Cn(a,e)}getDefaultAccentColor(t){let e=this.getCurrentPaletteSystem(),i=t||this.getCurrentDefaultFlavor();return e==="year3000"?xn(i):Mn(i)}getAccentColor(t,e){let i=this.getCurrentPaletteSystem(),a=e||this.getCurrentDefaultFlavor();return i==="year3000"?Pn(a,t):En(a,t)}getCinematicGradientPair(t,e="medium"){let i=this.getCurrentPaletteSystem(),a=t||this.getCurrentDefaultFlavor();if(i==="year3000")return An(a,e);{let r=Ve[a];switch(e){case"low":return[r.mauve,r.blue];case"medium":return[r.pink,r.peach];case"high":return[r.red,r.teal];default:return[r.mauve,r.pink]}}}getAnimatedFlowColors(t){let e=this.getCurrentPaletteSystem(),i=t||this.getCurrentDefaultFlavor();if(e==="year3000")return In(i);{let a=Ve[i];return{primary:a.mauve,secondary:a.pink,tertiary:a.blue,atmosphere:a.base}}}supportsCinematicFeatures(){return this.getCurrentPaletteSystem()==="year3000"}getPaletteSystemDisplayName(){return this.getCurrentPaletteSystem()==="year3000"?"Year 3000 Cinematic":"Catppuccin Classic"}},K=Ga.getInstance()});var di,hi,Rn=y(()=>{"use strict";di={jazz:{temperatureShift:15,saturationBoost:1.1,warmth:.8},electronic:{temperatureShift:-10,saturationBoost:1.2,warmth:.2},classical:{temperatureShift:5,saturationBoost:.9,warmth:.6},rock:{temperatureShift:0,saturationBoost:1.15,warmth:.5},ambient:{temperatureShift:-5,saturationBoost:.8,warmth:.3},hiphop:{temperatureShift:8,saturationBoost:1.25,warmth:.7},pop:{temperatureShift:0,saturationBoost:1,warmth:.5},metal:{temperatureShift:-15,saturationBoost:1.3,warmth:.1},indie:{temperatureShift:10,saturationBoost:.95,warmth:.6},default:{temperatureShift:0,saturationBoost:1,warmth:.5}},hi=class{constructor(t,e){this.paletteCache={};this.cacheTTL=3e5;this.maxCacheSize=50;this.config=t,this.utils=e}async loadCustomPalette(t,e){let i=this.paletteCache[t];if(i&&Date.now()-i.timestamp<this.cacheTTL&&i.isValid)return this.config.enableDebug&&console.log(`[PaletteExtensionManager] Cache hit for palette: ${t}`),i.palette;try{let a=this.generateFallbackPalette(t);if(this.validatePalette(a))return this.cachePalette(t,a,!0),a}catch(a){this.config.enableDebug&&console.warn(`[PaletteExtensionManager] Failed to load palette ${t}:`,a)}return null}generateFallbackPalette(t){let e=this.utils.getRootStyle(),i=getComputedStyle(e),a=i.getPropertyValue("--spice-main").trim()||i.getPropertyValue("--spice-base").trim()||"#1e1e2e",r=i.getPropertyValue("--sn-gradient-accent").trim()||i.getPropertyValue("--spice-button").trim()||i.getPropertyValue("--sn-dynamic-accent").trim()||i.getPropertyValue("--spice-accent").trim()||"#8caaee",n=this.utils.hexToRgb(a.startsWith("#")?a:`#${a}`),s=this.utils.hexToRgb(r.startsWith("#")?r:`#${r}`);if(!n||!s){let m=i.getPropertyValue("--sn-dynamic-accent").trim(),d=i.getPropertyValue("--spice-base").trim();return{name:t,version:"1.0.0",accents:{mauve:m||"#ca9ee6",pink:"#f4b8e4",blue:m||"#8caaee",sapphire:"#85c1dc",sky:"#99d1db",teal:"#81c8be",green:"#a6d189",yellow:"#e5c890",peach:"#ef9f76",red:"#e78284",lavender:"#babbf1"},neutrals:{base:d||"#1e1e2e",surface0:"#313244",surface1:"#45475a",surface2:"#585b70",overlay0:"#6c7086",overlay1:"#7f849c",overlay2:"#9399b2",text:"#cdd6f4"},metadata:{author:"PaletteExtensionManager",description:`Generated fallback for ${t}`,temperature:"neutral"}}}let o=this.utils.rgbToHsl(n.r,n.g,n.b),c=this.utils.rgbToHsl(s.r,s.g,s.b);return{name:t,version:"1.0.0",accents:this.generateAccentVariations(c),neutrals:this.generateNeutralVariations(o),metadata:{author:"PaletteExtensionManager",description:`Generated palette for ${t}`,temperature:this.detectTemperature(o,c)}}}applyGenreAwareModifications(t,e){let i=di[e]||di.default;this.config.enableDebug&&console.log(`[PaletteExtensionManager] Applying ${e} hints to palette:`,i);let a={...t,accents:{},neutrals:{},metadata:{...t.metadata,genre:[...t.metadata?.genre||[],e]}};for(let[r,n]of Object.entries(t.accents))a.accents[r]=this.applyGenreColorModification(n,i.temperatureShift,i.saturationBoost);for(let[r,n]of Object.entries(t.neutrals))a.neutrals[r]=this.applyGenreColorModification(n,i.temperatureShift*.3,i.saturationBoost*.7);return a}validatePalette(t){if(!t||typeof t!="object"||!t.name||typeof t.name!="string"||!t.version||typeof t.version!="string"||!t.accents||typeof t.accents!="object"||!t.neutrals||typeof t.neutrals!="object")return!1;let e=[...Object.values(t.accents),...Object.values(t.neutrals)];for(let i of e)if(typeof i!="string"||!this.isValidHexColor(i))return!1;return!0}cachePalette(t,e,i){if(Object.keys(this.paletteCache).length>=this.maxCacheSize){let r=Object.entries(this.paletteCache).sort(([,n],[,s])=>n.timestamp-s.timestamp)[0]?.[0];r&&this.paletteCache[r]&&delete this.paletteCache[r]}this.paletteCache[t]={palette:e,timestamp:Date.now(),isValid:i}}generateAccentVariations(t){let e={},i=[0,30,60,120,180,210,240,300,330,45,90],a=["primary","secondary","tertiary","complement","opposite","warm1","cool1","accent1","accent2","highlight","emphasis"];return i.forEach((r,n)=>{let s=a[n]||`variant${n}`,o=(t.h+r)%360,c=this.utils.hslToRgb(o,t.s,t.l);c&&(e[s]=this.utils.rgbToHex(c.r,c.g,c.b))}),e}generateNeutralVariations(t){let e={};return[{name:"base",l:t.l},{name:"surface0",l:Math.min(95,t.l+10)},{name:"surface1",l:Math.min(90,t.l+20)},{name:"surface2",l:Math.min(85,t.l+30)},{name:"overlay0",l:Math.min(80,t.l+40)},{name:"overlay1",l:Math.min(75,t.l+50)},{name:"text",l:Math.min(95,t.l+60)}].forEach(a=>{let r=this.utils.hslToRgb(t.h,Math.max(0,t.s-20),a.l);r&&(e[a.name]=this.utils.rgbToHex(r.r,r.g,r.b))}),e}detectTemperature(t,e){let i=(t.h+e.h)/2;return i>=0&&i<=60||i>=300&&i<=360?"warm":i>=120&&i<=240?"cool":"neutral"}applyGenreColorModification(t,e,i){let a=this.utils.hexToRgb(t);if(!a)return t;let r=this.utils.rgbToHsl(a.r,a.g,a.b),n=(r.h+e+360)%360,s=Math.max(0,Math.min(100,r.s*i)),o=this.utils.hslToRgb(n,s,r.l);return o?this.utils.rgbToHex(o.r,o.g,o.b):t}isValidHexColor(t){return/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(t)}getGenreHints(t){return di[t]||di.default}clearCache(){this.paletteCache={},this.config.enableDebug&&console.log("[PaletteExtensionManager] Palette cache cleared")}}});var Pt,ge,gi,Vn=y(()=>{"use strict";k();Pt=new Set(["--sn-beat-pulse-intensity","--sn-animation-scale","--sn-accent-hex","--sn-accent-rgb","--sn.music.beat.pulse.intensity","--sn.music.animation.scale","--sn.music.rhythm.phase","--sn.music.spectrum.phase","--sn.color.accent.hex","--sn.color.accent.rgb","--sn.bg.webgl.ready","--sn.bg.active-backend"]),ge=class ge{constructor(t,e){this.initialized=!1;this.cssVariableQueue=new Map;this.batchUpdateTimer=null;this.rafHandle=null;this.microtaskScheduled=!1;this.pendingTransactions=new Map;this.transactionCounter=0;this.updateQueue=new Map;this.flushTimer=null;this.currentDeviceCapabilities=null;this.currentPerformanceMode=null;this.lastCSSUpdate=0;this.cssUpdateThrottle=100;this.appliedClasses=new Set;this.visualEffectsState=null;this.visualEffectsUpdateTimer=null;this.lastVisualEffectsUpdate=0;this.optimizedConfig={};this.lastFPSCheck=0;this.currentPerformanceLevel="good";this.adaptiveThrottleLevel=1;this.priorityQueues=new Map;this.adaptiveMonitoringInterval=null;this.frameContextUnsubscribe=null;this.reduceMotionMQ=null;this.mqHandler=null;this.performanceMetrics={totalBatches:0,totalUpdates:0,totalBatchTime:0,maxBatchTime:0,averageBatchSize:0,overBudgetBatches:0,conflictResolutions:0,transactionCount:0,visualEffectsUpdates:0};this.PRIORITY_WEIGHTS={low:1,normal:2,high:3,critical:4};this.config=t,this.performanceCoordinator=e,this.eventBus=p,this.cssConfig={batchIntervalMs:0,maxBatchSize:50,enableDebug:t.enableDebug,useCssTextFastPath:!1,autoHijack:!0,enableAdaptiveOptimization:!0,enableThermalThrottling:!0,enableBatteryOptimization:!0,enableDeviceTierOptimization:!0,debugPerformanceClasses:t.enableDebug,enableVisualEffectsIntegration:!0,visualEffectsUpdateInterval:16,enableMusicVisualEffects:!0,enableAestheticVisualEffects:!0,enableAdaptiveThrottling:!0,priorityMappings:{critical:["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift"],high:["--sn-gradient-primary","--sn-gradient-secondary","--sn-gradient-accent"],normal:["--sn-gradient-","--sn-rs-"],low:["--sn-debug-","--sn-dev-"]},thresholds:{excellentFPS:55,goodFPS:45,poorFPS:30}},this.optimizedConfig=this.cssConfig,this.currentDeviceCapabilities=this.performanceCoordinator.getDeviceCapabilities(),this.currentPerformanceMode=this.performanceCoordinator.getCurrentPerformanceMode(),this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Created with visual-effects-driven CSS management")}async initialize(){this.initialized||(this.subscribeToEvents(),this.applyInitialOptimizations(),this.cssConfig.enableVisualEffectsIntegration&&this.startVisualEffectsIntegration(),this.cssConfig.autoHijack&&this.enableGlobalHijack(),this.initializeOptimizedFeatures(),this.initializeFrameContextIntegration(),this.initialized=!0,this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Initialized with device tier:",this.currentDeviceCapabilities?.performanceTier))}updateAnimation(t){}async healthCheck(){let t=this.cssVariableQueue.size+this.updateQueue.size,e=this.pendingTransactions.size,i=t<=1e3&&e<=100;return{system:"UnifiedCSSVariableManager",healthy:i,ok:i,details:i?"CSS visual-effects controller operating normally":"High queue size or pending transactions",metrics:{queueSize:t,pendingTransactions:e,performanceMetrics:this.performanceMetrics,visualEffectsActive:this.visualEffectsState!==null,deviceTier:this.currentDeviceCapabilities?.performanceTier,performanceMode:this.currentPerformanceMode?.name}}}forceRepaint(t){this.flushCSSVariableBatch(),this.config.enableDebug&&t&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Force repaint: ${t}`)}queueCSSVariableUpdate(t,e,i=null,a="normal",r="unknown"){let n=i||document.documentElement,s=this.optimizedConfig.enableAdaptiveThrottling?this.determineVariablePriority(t,a):a;if(s==="critical"||Pt.has(t)){this.applyCriticalUpdate(t,e,n);return}if(this.optimizedConfig.enableAdaptiveThrottling&&this.priorityQueues.size>0){this.queueByPriority(t,e,n,s,r);return}let c=`${i?`element_${i.id||i.className||"unnamed"}`:"root"}:${t}`,m={element:n,property:t,value:e,timestamp:performance.now(),priority:s,source:r},d=this.cssVariableQueue.get(c);d?this.shouldReplaceUpdate(d,m)&&(this.cssVariableQueue.set(c,m),this.performanceMetrics.conflictResolutions++):this.cssVariableQueue.set(c,m),this.performanceMetrics.totalUpdates++,this.scheduleFlush(s),(s==="critical"||this.cssVariableQueue.size>=this.cssConfig.maxBatchSize)&&this.flushCSSVariableBatch()}updateVariables(t,e="normal",i="unknown"){let a=`tx_${++this.transactionCounter}`,r=new Map(Object.entries(t)),n={id:a,variables:r,timestamp:performance.now(),priority:e,completed:!1};this.pendingTransactions.set(a,n);for(let[s,o]of r)this.queueCSSVariableUpdate(s,o,null,e,`${i}:${a}`);this.performanceMetrics.transactionCount++,this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Transaction ${a} queued with ${r.size} variables`)}updateVisualEffectsVariables(t){if(!this.cssConfig.enableVisualEffectsIntegration)return;this.visualEffectsState=t,this.performanceMetrics.visualEffectsUpdates++;let e={};t.musicState&&this.cssConfig.enableMusicVisualEffects&&(e["--sn.music.beat.pulse.intensity"]=t.musicState.intensity.toString(),e["--sn.music.tempo.bpm"]=t.musicState.bpm.toString(),e["--sn.music.rhythm.phase"]=`${t.musicState.rhythmPhase}deg`,e["--sn.music.animation.scale"]=t.musicState.animationScale.toString(),e["--sn.music.energy.level"]=t.musicState.energy.toString(),e["--sn.music.valence"]=t.musicState.valence.toString()),t.aestheticState&&this.cssConfig.enableAestheticVisualEffects&&(e["--sn.aesthetic.harmony.level"]=t.aestheticState.harmonyLevel.toString(),e["--sn.aesthetic.evolution.factor"]=t.aestheticState.evolutionFactor.toString(),e["--sn.color.temperature"]=t.aestheticState.colorTemperature.toString()),t.performanceState&&(e["--sn.performance.mode"]=t.performanceState.mode,e["--sn.device.tier"]=t.performanceState.deviceTier,e["--sn.performance.optimization.level"]=t.performanceState.optimizationLevel.toString()),this.updateVariables(e,"high","visual-effects-system"),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Consciousness state updated with ${Object.keys(e).length} variables`)}applyPerformanceOptimizations(t){if(!this.cssConfig.enableAdaptiveOptimization)return;this.currentPerformanceMode=t;let e={"--sn.performance.mode":t.name,"--sn.performance.quality.level":t.qualityLevel.toString(),"--sn.performance.fps.target":t.frameRate.toString(),"--sn.performance.frame.budget":(1e3/t.frameRate).toString(),"--sn.performance.optimization.level":t.optimizationLevel.toString(),"--sn.performance.blur.quality":t.blurQuality.toString(),"--sn.performance.shadow.quality":t.shadowQuality.toString(),"--sn.performance.animation.quality":t.animationQuality.toString(),"--sn.performance.effect.quality":t.effectQuality.toString()};this.updateVariables(e,"high","performance-coordinator"),this.applyPerformanceModeOptimizations(),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Performance optimizations applied for mode: ${t.name}`)}getVariable(t){return getComputedStyle(document.documentElement).getPropertyValue(t).trim()||null}flushUpdates(){this.flushCSSVariableBatch()}flushCSSVariableBatch(){if(this.cssVariableQueue.size===0)return;let t=performance.now(),e=8,i=Array.from(this.cssVariableQueue.values());this.cssVariableQueue.clear(),this.rafHandle!==null&&(cancelAnimationFrame(this.rafHandle),this.rafHandle=null),this.microtaskScheduled=!1;try{let a=new Map;for(let n of i)a.has(n.element)||a.set(n.element,[]),a.get(n.element).push(n);for(let[n,s]of a.entries()){if(performance.now()-t>e){for(let o of s){let c=`${o.element.id||"root"}:${o.property}`;this.cssVariableQueue.set(c,o)}this.scheduleFlush("high");break}if(s.length>=3)this.applyCSSTextBatch(n,s);else for(let o of s)ge.nativeSetProperty?ge.nativeSetProperty.call(n.style,o.property,o.value):n.style.setProperty(o.property,o.value)}let r=performance.now()-t;this.updatePerformanceMetrics(r,i.length),r>e&&this.config.enableDebug?console.warn(`\u{1F30C} [UnifiedCSSVariableManager] CSS batch exceeded frame budget: ${r.toFixed(2)}ms (${i.length} updates)`):this.config.enableDebug&&Math.random()<.05&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Efficient CSS batch: ${i.length} updates in ${r.toFixed(2)}ms`)}catch(a){console.error("[UnifiedCSSVariableManager] Error in optimized CSS batch processing:",a),this.applyUpdatesWithFallback(i)}}applyCSSTextBatch(t,e){try{let i=t.style.cssText,a=new Map;if(i){let n=i.split(";");for(let s of n){let o=s.indexOf(":");if(o>0){let c=s.slice(0,o).trim(),m=s.slice(o+1).trim();c&&m&&a.set(c,m)}}}for(let n of e)a.set(n.property,n.value);let r=[];for(let[n,s]of a)r.push(`${n}:${s}`);t.style.cssText=r.join(";")}catch{for(let a of e)try{t.style.setProperty(a.property,a.value)}catch(r){console.warn(`Failed to apply ${a.property}:`,r)}}}applyUpdatesWithFallback(t){for(let e of t)try{ge.nativeSetProperty?ge.nativeSetProperty.call(e.element.style,e.property,e.value):e.element.style.setProperty(e.property,e.value)}catch(i){console.warn(`[UnifiedCSSVariableManager] Failed to apply CSS property ${e.property}:`,i)}}setMusicMetrics(t){let e={};t.beatIntensity!==void 0&&(e["--sn.music.beat.pulse.intensity"]=t.beatIntensity.toString()),t.rhythmPhase!==void 0&&(e["--sn.music.rhythm.phase"]=`${t.rhythmPhase}deg`),t.animationScale!==void 0&&(e["--sn.music.animation.scale"]=t.animationScale.toString()),t.spectrumPhase!==void 0&&(e["--sn.music.spectrum.phase"]=`${t.spectrumPhase}deg`),t.energy!==void 0&&(e["--sn.music.energy.level"]=t.energy.toString()),t.valence!==void 0&&(e["--sn.music.valence"]=t.valence.toString()),t.bpm!==void 0&&(e["--sn.music.tempo.bpm"]=t.bpm.toString()),this.updateVariables(e,"critical","music-system")}setColorTokens(t){let e={};t.accentHex&&(e["--sn.color.accent.hex"]=t.accentHex),t.accentRgb&&(e["--sn.color.accent.rgb"]=t.accentRgb),t.primaryRgb&&(e["--sn.bg.gradient.primary.rgb"]=t.primaryRgb),t.secondaryRgb&&(e["--sn.bg.gradient.secondary.rgb"]=t.secondaryRgb),t.gradientOpacity!==void 0&&(e["--sn.bg.gradient.opacity"]=t.gradientOpacity.toString()),t.gradientBlur&&(e["--sn.bg.gradient.blur"]=t.gradientBlur),this.updateVariables(e,"high","color-system")}setPerformanceTokens(t){let e={};t.webglReady!==void 0&&(e["--sn.bg.webgl.ready"]=t.webglReady?"1":"0"),t.activeBackend&&(e["--sn.bg.active-backend"]=t.activeBackend),t.qualityLevel&&(e["--sn.perf.quality.level"]=t.qualityLevel),t.reducedMotion!==void 0&&(e["--sn.anim.motion.reduced"]=t.reducedMotion?"1":"0"),t.gpuAcceleration!==void 0&&(e["--sn.perf.gpu.acceleration.enabled"]=t.gpuAcceleration?"1":"0"),this.updateVariables(e,"high","performance-system")}setProperty(t,e,i=null){if(t.startsWith("--spice-")&&this.config.enableSpiceVariableDebug){let a=new Error().stack?.split(`
`)[2]?.trim().replace(/^\s*at\s+/,"")||"unknown";console.log(`\u{1F527} [CSS Debug] Setting ${t} = ${e} (from: ${a})`)}this.queueCSSVariableUpdate(t,e,i)}applyDeviceOptimizations(){if(!this.cssConfig.enableDeviceTierOptimization||!this.currentDeviceCapabilities)return;this.removeClassesByPrefix("device-tier-"),this.removeClassesByPrefix("device-mobile-"),this.removeClassesByPrefix("device-gpu-");let t=`device-tier-${this.currentDeviceCapabilities.performanceTier}`;this.addCSSClass(t),this.currentDeviceCapabilities.isMobile&&this.addCSSClass("device-mobile-optimized"),this.currentDeviceCapabilities.gpuAcceleration?this.addCSSClass("device-gpu-accelerated"):this.addCSSClass("device-gpu-fallback");let e=this.getMemoryTier(this.currentDeviceCapabilities.memoryGB);this.addCSSClass(`device-memory-${e}`)}applyPerformanceModeOptimizations(){if(!this.currentPerformanceMode)return;this.removeClassesByPrefix("performance-mode-");let t=`performance-mode-${this.currentPerformanceMode.name}`;this.addCSSClass(t);let e=`optimization-level-${this.currentPerformanceMode.optimizationLevel}`;this.addCSSClass(e)}getPerformanceReport(){let t=this.performanceMetrics.totalBatches>0?this.performanceMetrics.totalBatchTime/this.performanceMetrics.totalBatches:0;return{enabled:!0,pendingUpdates:this.cssVariableQueue.size+this.updateQueue.size,totalUpdates:this.performanceMetrics.totalUpdates,totalBatches:this.performanceMetrics.totalBatches,averageBatchSize:Math.round(this.performanceMetrics.averageBatchSize*10)/10,averageBatchTime:Math.round(t*100)/100,maxBatchTime:Math.round(this.performanceMetrics.maxBatchTime*100)/100,overBudgetBatches:this.performanceMetrics.overBudgetBatches,conflictResolutions:this.performanceMetrics.conflictResolutions,transactionCount:this.performanceMetrics.transactionCount,visualEffectsUpdates:this.performanceMetrics.visualEffectsUpdates,visualEffectsActive:this.visualEffectsState!==null,deviceTier:this.currentDeviceCapabilities?.performanceTier,performanceMode:this.currentPerformanceMode?.name}}subscribeToEvents(){this.eventBus.subscribe("performance:tier-changed",t=>{this.currentPerformanceMode=this.performanceCoordinator.getCurrentPerformanceMode(),this.applyPerformanceModeOptimizations(),this.updateCSSPerformanceVariables()},"UnifiedCSSVariableManager"),this.eventBus.subscribe("performance:frame",t=>{t.temperature&&t.temperature>80&&this.applyThermalOptimizations(t.temperature)},"UnifiedCSSVariableManager")}applyInitialOptimizations(){try{this.applyDeviceOptimizations(),this.applyPerformanceModeOptimizations(),this.updateCSSPerformanceVariables(),this.cssConfig.debugPerformanceClasses&&this.addCSSClass("debug-performance")}catch(t){this.config.enableDebug&&console.warn("[UnifiedCSSVariableManager] Error applying initial optimizations:",t)}}applyCurrentOptimizations(){this.applyDeviceOptimizations(),this.applyPerformanceModeOptimizations();let t=this.performanceCoordinator.getBatteryState(),e=this.performanceCoordinator.getThermalState();t&&this.applyBatteryOptimizations(t.level,t.charging);let i=e.temperature||"normal";this.applyThermalOptimizations(i)}updateCSSPerformanceVariables(){let t=Date.now();if(!(t-this.lastCSSUpdate<this.cssUpdateThrottle)&&(this.lastCSSUpdate=t,!(!this.currentPerformanceMode||!this.currentDeviceCapabilities)))try{let e={"--sn.performance.mode":this.currentPerformanceMode.name||"balanced","--sn.performance.quality.level":(this.currentPerformanceMode.qualityLevel??.8).toString(),"--sn.performance.fps.target":(this.currentPerformanceMode.frameRate??60).toString(),"--sn.performance.frame.budget":(1e3/(this.currentPerformanceMode.frameRate??60)).toString(),"--sn.performance.optimization.level":(this.currentPerformanceMode.optimizationLevel??1).toString(),"--sn.device.tier":this.currentDeviceCapabilities.performanceTier??"mid","--sn.device.memory":(this.currentDeviceCapabilities.memoryGB??8).toString(),"--sn.device.gpu":this.currentDeviceCapabilities.gpuAcceleration??!0?"1":"0","--sn.device.mobile":this.currentDeviceCapabilities.isMobile??!1?"1":"0","--sn.performance.blur.quality":(this.currentPerformanceMode.blurQuality??.8).toString(),"--sn.performance.shadow.quality":(this.currentPerformanceMode.shadowQuality??.8).toString(),"--sn.performance.animation.quality":(this.currentPerformanceMode.animationQuality??.8).toString(),"--sn.performance.effect.quality":(this.currentPerformanceMode.effectQuality??.8).toString()};this.updateVariables(e,"high","performance-coordinator")}catch(e){this.config.enableDebug&&console.warn("[UnifiedCSSVariableManager] Error updating CSS performance variables:",e)}}startVisualEffectsIntegration(){if(this.visualEffectsUpdateTimer)return;let t=()=>{let e=performance.now();e-this.lastVisualEffectsUpdate>=this.cssConfig.visualEffectsUpdateInterval&&(this.lastVisualEffectsUpdate=e,this.visualEffectsState&&this.updateVisualEffectsVariables(this.visualEffectsState)),this.visualEffectsUpdateTimer=setTimeout(t,this.cssConfig.visualEffectsUpdateInterval)};t()}shouldReplaceUpdate(t,e){let i=this.PRIORITY_WEIGHTS[t.priority],a=this.PRIORITY_WEIGHTS[e.priority];return a>i?!0:a===i?e.timestamp>t.timestamp:!1}scheduleFlush(t){if(this.rafHandle!==null||this.microtaskScheduled)return;let e=()=>{this.rafHandle=null,this.microtaskScheduled=!1,this.flushCSSVariableBatch()};typeof document<"u"&&document.visibilityState==="hidden"?(this.microtaskScheduled=!0,queueMicrotask(e)):typeof requestAnimationFrame=="function"?this.rafHandle=requestAnimationFrame(e):setTimeout(e,0)}updatePerformanceMetrics(t,e){this.performanceMetrics.totalBatches++,this.performanceMetrics.totalBatchTime+=t,this.performanceMetrics.maxBatchTime=Math.max(this.performanceMetrics.maxBatchTime,t),this.performanceMetrics.averageBatchSize=(this.performanceMetrics.averageBatchSize*(this.performanceMetrics.totalBatches-1)+e)/this.performanceMetrics.totalBatches,t>8&&(this.performanceMetrics.overBudgetBatches++,this.config.enableDebug&&console.warn(`[UnifiedCSSVariableManager] CSS batch took ${t.toFixed(2)}ms for ${e} updates`))}enableGlobalHijack(){if(ge.hijackEnabled)return;let t=CSSStyleDeclaration.prototype.setProperty;ge.nativeSetProperty=t;let e=this;CSSStyleDeclaration.prototype.setProperty=function(i,a,r){i&&(i.startsWith("--sn-")||i.startsWith("--sn."))&&e?e.queueCSSVariableUpdate(i,String(a??"")):t.call(this,i,a,r)},ge.hijackEnabled=!0,this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Global setProperty hijack enabled (--sn- and --sn. namespaces)")}addCSSClass(t){this.appliedClasses.has(t)||(document.body.classList.add(t),this.appliedClasses.add(t))}removeCSSClass(t){this.appliedClasses.has(t)&&(document.body.classList.remove(t),this.appliedClasses.delete(t))}removeClassesByPrefix(t){let e=Array.from(this.appliedClasses).filter(i=>i.startsWith(t));for(let i of e)this.removeCSSClass(i)}getMemoryTier(t){return t>=16?"high":t>=8?"medium":t>=4?"low":"minimal"}applyThermalOptimizations(t){if(!this.cssConfig.enableThermalThrottling)return;this.removeClassesByPrefix("thermal-");let e=`thermal-${t}`;this.addCSSClass(e)}applyBatteryOptimizations(t,e){this.cssConfig.enableBatteryOptimization&&(this.removeClassesByPrefix("battery-"),t<.2?this.addCSSClass("battery-low"):t<.5?this.addCSSClass("battery-medium"):this.addCSSClass("battery-high"),e&&this.addCSSClass("battery-charging"))}updateMusicVariables(t){let e={};for(let[i,a]of Object.entries(t))if(a!==void 0){let r=`--sn-music-${i.replace(/\./g,"-")}`;e[r]=String(a)}this.updateVariables(e,"critical","music-system")}updateColorVariables(t){let e={};for(let[i,a]of Object.entries(t))if(a!==void 0){let r=`--sn-color-${i.replace(/\./g,"-")}`;e[r]=String(a)}this.updateVariables(e,"high","color-system")}updateAnimationVariables(t){let e={};for(let[i,a]of Object.entries(t))if(a!==void 0){let r=`--sn-anim-${i.replace(/\./g,"-")}`;e[r]=typeof a=="boolean"?a?"1":"0":String(a)}this.updateVariables(e,"normal","animation-system")}updatePerformanceVariables(t){let e={};for(let[i,a]of Object.entries(t))if(a!==void 0){let r=`--sn-performance-${i.replace(/\./g,"-")}`;e[r]=typeof a=="boolean"?a?"1":"0":String(a)}this.updateVariables(e,"high","performance-system")}updateUtilityVariables(t){let e={};for(let[i,a]of Object.entries(t))if(a!==void 0){let r=`--sn-${i.replace(/\./g,"-")}`;e[r]=typeof a=="boolean"?a?"1":"0":String(a)}this.updateVariables(e,"low","utility-system")}queueUpdate(t,e,i="normal",a="unknown"){this.queueCSSVariableUpdate(t,e,null,i,a)}queueTransaction(t,e="normal",i="unknown"){let a=`tx_${++this.transactionCounter}`,r=new Map(Object.entries(t)),n={id:a,variables:r,timestamp:performance.now(),priority:e,completed:!1};this.pendingTransactions.set(a,n);for(let[s,o]of r)this.queueUpdate(s,o,e,`${i}:${a}`);return this.performanceMetrics.transactionCount++,this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Transaction ${a} queued with ${r.size} variables`),a}forceFlush(){this.flushCSSVariableBatch()}registerVariableGroup(t,e="normal",i=50,a=16){this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Variable group registration: ${t} (handled internally)`)}updateVariableGroup(t,e,i="unknown"){this.updateVariables(e,"normal",`group:${t}:${i}`)}updateConfig(t){this.cssConfig={...this.cssConfig,...t},this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Configuration updated:",t)}flushNow(){this.flushCSSVariableBatch()}setBatchingEnabled(t){this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Batching ${t?"enabled":"disabled"}`)}addCriticalVariable(t){Pt.add(t),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Added critical variable: ${t}`)}removeCriticalVariable(t){Pt.delete(t),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Removed critical variable: ${t}`)}isCriticalVariable(t){return Pt.has(t)}getCriticalVariables(){return Array.from(Pt)}updateVisualEffectsIntensity(t,e,i){let a=Math.max(0,Math.min(1,t));this.queueCSSVariableUpdate("--visual-effects-intensity",a.toString(),null,"high",`visual-effects-${e}`),this.eventBus&&this.eventBus.emitSync("visual-effects:intensity-changed",{intensity:a,userEngagement:.5,timestamp:Date.now(),sourceStrategy:e,musicEnergy:i??0}),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Consciousness intensity updated by ${e}: ${a}`)}updateCrossfadeOpacity(t,e,i){let a=Math.max(0,Math.min(1,t));i||(a=0),this.queueCSSVariableUpdate("--sn-gradient-crossfade-opacity",a.toString(),null,"high",`crossfade-${e}`),this.eventBus&&this.eventBus.emitSync("gradient:crossfade-changed",{opacity:a,sourceStrategy:e,webglEnabled:i,timestamp:Date.now()}),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Crossfade opacity updated by ${e}: ${a} (WebGL: ${i})`)}subscribeToVisualEffectsChanges(t){if(!this.eventBus)return console.warn("[UnifiedCSSVariableManager] No UnifiedEventBus available for visual-effects subscriptions"),()=>{};let e=this.eventBus.subscribe("visual-effects:intensity-changed",t,"UnifiedCSSVariableManager");return()=>this.eventBus?.unsubscribe(e)}subscribeToCrossfadeChanges(t){if(!this.eventBus)return console.warn("[UnifiedCSSVariableManager] No UnifiedEventBus available for crossfade subscriptions"),()=>{};let e=this.eventBus.subscribe("gradient:crossfade-changed",t,"UnifiedCSSVariableManager");return()=>this.eventBus?.unsubscribe(e)}setVariable(t,e,i,a,r){let n,s,o,c;arguments.length>=4?(n=e,s=i,o=a||"normal",c=`${t}${r?`:${r}`:""}`):(n=t,s=e,o=i||"normal",c="legacy-api");let m=o||"normal";this.queueCSSVariableUpdate(n,s,null,m,c)}batchSetVariables(t,e,i,a){let r,n,s;typeof t=="string"?(r=e,n=i||"normal",s=`${t}${a?`:${a}`:""}`):(r=t,n=e||"normal",s="legacy-batch-api");let o=n||"normal";this.updateVariables(r,o,s)}initializeOptimizedFeatures(){this.currentDeviceCapabilities?.performanceTier,this.config.enableDebug&&console.log("[UnifiedCSSVariableManager] Optimized features initialized")}initializeFrameContextIntegration(){this.config.enableDebug&&console.log("[UnifiedCSSVariableManager] Frame context integration initialized")}determineVariablePriority(t,e){return t.includes("sn-critical")||t.includes("spice-main")?"critical":t.includes("music")||t.includes("beat")||t.includes("energy")?"high":t.includes("color")||t.includes("accent")?"normal":e||"low"}applyCriticalUpdate(t,e,i){let a=i||document.documentElement;try{a.style.setProperty(t,e),this.config.enableDebug&&console.log(`[UnifiedCSSVariableManager] Critical update applied: ${t} = ${e}`)}catch(r){console.warn("[UnifiedCSSVariableManager] Critical update failed:",r)}}queueByPriority(t,e,i,a,r){this.priorityQueues.has(a)||this.priorityQueues.set(a,new Map),this.priorityQueues.get(a).set(t,{property:t,value:e,timestamp:Date.now()}),(a==="critical"||a==="high")&&this.flushCSSVariableBatch()}destroyFrameContextIntegration(){this.config.enableDebug&&console.log("[UnifiedCSSVariableManager] Frame context integration destroyed")}destroy(){this.adaptiveMonitoringInterval&&(clearInterval(this.adaptiveMonitoringInterval),this.adaptiveMonitoringInterval=null),this.destroyFrameContextIntegration(),this.priorityQueues.clear(),this.visualEffectsUpdateTimer&&(clearTimeout(this.visualEffectsUpdateTimer),this.visualEffectsUpdateTimer=null),this.cssVariableQueue.clear(),p.unsubscribeAll("UnifiedCSSVariableManager"),this.initialized=!1}};ge.hijackEnabled=!1;gi=ge});function za(l){Ha=l,console.log("\u{1F504} [OptimizedCSSVariableManager] Global compatibility layer instance set")}function P(){if(!Ha)throw console.warn("[OptimizedCSSVariableManager] Global instance not initialized yet. This may indicate an initialization order issue."),new Error("Global OptimizedCSSVariableManager not initialized. Call setGlobalOptimizedCSSController() first.");return Ha}var me,Ha,U=y(()=>{"use strict";Vn();me=class l extends gi{constructor(t,e,i={}){let a={enableAdaptiveThrottling:i.enableAdaptiveThrottling??!0,priorityMappings:i.priorityMappings??{critical:["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift"],high:["--sn-gradient-primary","--sn-gradient-secondary","--sn-gradient-accent"],normal:["--sn-gradient-","--sn-rs-"],low:["--sn-debug-","--sn-dev-"]},thresholds:i.thresholds??{excellentFPS:55,goodFPS:45,poorFPS:30}};super(t,e),this.legacyConfig={batchIntervalMs:i.batchIntervalMs??16,maxBatchSize:i.maxBatchSize??50,enableDebug:t.enableDebug,enableAdaptiveThrottling:a.enableAdaptiveThrottling,priorityMappings:a.priorityMappings,thresholds:a.thresholds,...i},t.enableDebug&&console.log("\u{1F504} [OptimizedCSSVariableManager] Compatibility layer active - delegating to UnifiedCSSVariableManager")}getMedianFPS(){return this.performanceCoordinator&&this.performanceCoordinator.getCurrentPerformanceMode()?.frameRate||60}updateConfig(t){Object.assign(this.legacyConfig,t),t.batchIntervalMs||t.maxBatchSize}setVariable(t,e,i,a,r){super.setVariable(t,e,i,a,r)}batchSetVariables(t,e,i,a){super.batchSetVariables(t,e,i,a)}static getGlobalInstance(){let t=P();if(t instanceof l)return t;throw new Error("Global OptimizedCSSVariableManager not properly initialized")}},Ha=null});function Bn(){return typeof window<"u"&&window.Spicetify?window.Spicetify:null}function Cl(){return!!Bn()?.Platform}var Fe,mt,Ua=y(()=>{"use strict";U();k();Z();Fe=class Fe{constructor(t={}){this.colorCache=new Map;this.lastCacheUpdate=0;this.initialized=!1;this.eventSubscriptionIds=[];this.lastColorUpdate=0;this.colorUpdateCount=0;this.config={enableDebug:!1,fallbackToSpiceColors:!0,cacheDuration:5e3,...t}}async initialize(t){if(this.initialized){console.warn("[SemanticColorManager] Already initialized, skipping");return}try{this.cssController=t||P(),this.setupEventSubscriptions(),this.initialized=!0,this.lastColorUpdate=Date.now(),this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Initialized as IManagedSystem with",{mappings:Fe.SEMANTIC_MAPPINGS.length,batcherAvailable:!!this.cssController,spicetifyAvailable:this.isSpicetifyAvailable(),eventSubscriptions:this.eventSubscriptionIds.length}),p.emitSync("system:initialized",{systemName:"SemanticColorManager",timestamp:Date.now(),metadata:{mappings:Fe.SEMANTIC_MAPPINGS.length,spicetifyAvailable:this.isSpicetifyAvailable()?1:0}})}catch(e){throw console.error("[SemanticColorManager] Initialization failed:",e),p.emitSync("system:error",{systemName:"SemanticColorManager",error:e instanceof Error?e.message:"Initialization failed",severity:"critical",timestamp:Date.now()}),e}}async updateSemanticColors(){if(!this.initialized){console.warn("[SemanticColorManager] Not initialized, cannot update colors");return}let t=Date.now();if(!(t-this.lastCacheUpdate<(this.config.cacheDuration||5e3))){console.log("\u{1F3A8} [SemanticColorManager] Starting semantic color update...");try{let e={},i={},a={};for(let r of Fe.SEMANTIC_MAPPINGS){let n=await this.getSemanticColor(r.semanticColor);e[r.cssVariable]={semanticColor:r.semanticColor,retrievedColor:n,fallbackColor:r.fallbackColor,description:r.description},i[r.cssVariable]=n;let s=se(n);if(s){let o=r.cssVariable.replace("--spice-","--spice-rgb-");a[o]=`${s.r},${s.g},${s.b}`,e[o]=`${s.r},${s.g},${s.b}`}}this.cssController.batchSetVariables("SemanticColorManager",i,"high","semantic-color-update"),this.cssController.batchSetVariables("SemanticColorManager",a,"high","semantic-rgb-update"),console.log("\u{1F3A8} [SemanticColorManager] Color update complete:",e),this.lastCacheUpdate=t,this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Updated all semantic colors")}catch(e){console.error("[SemanticColorManager] Failed to update semantic colors:",e)}}}async getSemanticColor(t){let e=this.colorCache.get(t);if(e&&Date.now()-this.lastCacheUpdate<(this.config.cacheDuration||5e3))return e;let i;try{let a=Bn();this.isSpicetifyAvailable()&&a?.Platform?.getSemanticColors?(i=(await a.Platform.getSemanticColors())[t],console.log(`\u{1F3A8} [SemanticColorManager] Spicetify returned for ${t}:`,{rawValue:i,type:typeof i,isWhite:i==="#ffffff"||i==="#fff"||i==="white",isInvalid:!i||i==="undefined"||i==="null"})):(console.warn(`\u{1F3A8} [SemanticColorManager] Spicetify not available, using fallback for ${t}`),i=this.getFallbackColor(t))}catch(a){this.config.enableDebug&&console.warn(`[SemanticColorManager] Failed to get semantic color ${t}:`,a),i=this.getFallbackColor(t)}return i=this.validateColor(i,t),this.colorCache.set(t,i),i}validateColor(t,e){let i=t?.toLowerCase().trim();if(!i||["#ffffff","#fff","white","#000000","#000","black","","undefined","null","transparent"].includes(i)){let r=this.getFallbackColor(e);return this.config.enableDebug&&console.warn(`\u{1F527} [SemanticColorManager] Invalid color "${t}" for ${e}, using fallback: ${r}`),r}if(!i.match(/^#[0-9a-f]{6}$/i)&&!i.match(/^#[0-9a-f]{3}$/i)){let r=this.getFallbackColor(e);return this.config.enableDebug&&console.warn(`\u{1F527} [SemanticColorManager] Malformed color "${t}" for ${e}, using fallback: ${r}`),r}return t}getFallbackColor(t){let e=Fe.SEMANTIC_MAPPINGS.find(i=>i.semanticColor===t);return e?e.fallbackColor:t.startsWith("text")?"#cad3f5":t.startsWith("background")?"#24273a":t.startsWith("essential")?"#c6a0f6":t.startsWith("decorative")?"#939ab7":"#cad3f5"}applyColorToCSS(t,e,i="normal",a="semantic-color-manager"){this.cssController.setVariable("SemanticColorManager",t,e,i,a)}isSpicetifyAvailable(){return Cl()}flushUpdates(){this.cssController&&this.cssController.flushUpdates()}clearCache(){this.colorCache.clear(),this.lastCacheUpdate=0}updateWithAlbumColors(t){if(!this.initialized){console.warn("[SemanticColorManager] Not initialized, cannot update with album colors");return}try{let e=t.OKLAB_PRIMARY||t.VIBRANT||t.PRIMARY,i=t.OKLAB_ACCENT||t.LIGHT_VIBRANT||t.SECONDARY,a=t.OKLAB_SHADOW||t.DARK_VIBRANT||t.DARK,r=t.OKLAB_HIGHLIGHT||t.VIBRANT_NON_ALARMING||t.LIGHT;if(!e){console.warn("[SemanticColorManager] No primary color found in OKLAB result, skipping update");return}let n=this.generateIntelligentColorDistribution(e,i,a,r),s=this.convertColorsToRgb(n),o={"--spice-accent":n.primary,"--spice-rgb-accent":s.primary,"--spice-surface1":n.surface1,"--spice-rgb-surface1":s.surface1,"--spice-button-active":n.primary,"--spice-rgb-button-active":s.primary,"--spice-highlight":n.highlight,"--spice-rgb-highlight":s.highlight,"--spice-press":n.shadow,"--spice-rgb-press":s.shadow},c={"--spice-surface0":n.surface0,"--spice-rgb-surface0":s.surface0,"--spice-surface2":n.surface2,"--spice-rgb-surface2":s.surface2,"--spice-base":n.base,"--spice-rgb-base":s.base},m={"--spice-main":n.base,"--spice-rgb-main":s.base,"--spice-main-elevated":n.surface0,"--spice-rgb-main-elevated":s.surface0,"--spice-sidebar":n.surface1,"--spice-rgb-sidebar":s.surface1,"--spice-text":this.generateTextColor(n.base),"--spice-rgb-text":this.hexToRgb(this.generateTextColor(n.base)),"--spice-subtext":this.generateSubtextColor(n.base),"--spice-rgb-subtext":this.hexToRgb(this.generateSubtextColor(n.base)),"--spice-highlight-elevated":n.surface2,"--spice-rgb-highlight-elevated":s.surface2,"--spice-overlay0":this.generateOverlayColor(n.base,.04),"--spice-rgb-overlay0":this.hexToRgb(this.generateOverlayColor(n.base,.04)),"--spice-overlay1":this.generateOverlayColor(n.base,.08),"--spice-rgb-overlay1":this.hexToRgb(this.generateOverlayColor(n.base,.08)),"--spice-overlay2":this.generateOverlayColor(n.base,.12),"--spice-rgb-overlay2":this.hexToRgb(this.generateOverlayColor(n.base,.12)),"--spice-crust":this.generateCrustColor(n.base),"--spice-rgb-crust":this.hexToRgb(this.generateCrustColor(n.base)),"--spice-mantle":this.generateMantleColor(n.base),"--spice-rgb-mantle":this.hexToRgb(this.generateMantleColor(n.base))},d={"--spice-blue":n.harmonyPrimary,"--spice-rgb-blue":s.harmonyPrimary,"--spice-mauve":n.harmonySecondary,"--spice-rgb-mauve":s.harmonySecondary,"--spice-teal":n.harmonyTertiary,"--spice-rgb-teal":s.harmonyTertiary,"--spice-flamingo":this.generateZoneColor(n.primary,"flamingo"),"--spice-rgb-flamingo":this.hexToRgb(this.generateZoneColor(n.primary,"flamingo")),"--spice-lavender":this.generateZoneColor(n.highlight,"lavender"),"--spice-rgb-lavender":this.hexToRgb(this.generateZoneColor(n.highlight,"lavender")),"--spice-peach":this.generateZoneColor(n.surface2,"peach"),"--spice-rgb-peach":this.hexToRgb(this.generateZoneColor(n.surface2,"peach")),"--spice-rosewater":this.generateZoneColor(n.surface1,"rosewater"),"--spice-rgb-rosewater":this.hexToRgb(this.generateZoneColor(n.surface1,"rosewater")),"--spice-sapphire":this.generateZoneColor(n.harmonyPrimary,"sapphire"),"--spice-rgb-sapphire":this.hexToRgb(this.generateZoneColor(n.harmonyPrimary,"sapphire"))},h={"--spice-pink":this.generatePaletteColor(n.primary,"pink"),"--spice-rgb-pink":this.hexToRgb(this.generatePaletteColor(n.primary,"pink")),"--spice-sky":this.generatePaletteColor(n.harmonyPrimary,"sky"),"--spice-rgb-sky":this.hexToRgb(this.generatePaletteColor(n.harmonyPrimary,"sky")),"--spice-red":this.generatePaletteColor(n.highlight,"red"),"--spice-rgb-red":this.hexToRgb(this.generatePaletteColor(n.highlight,"red")),"--spice-maroon":this.generatePaletteColor(n.shadow,"maroon"),"--spice-rgb-maroon":this.hexToRgb(this.generatePaletteColor(n.shadow,"maroon")),"--spice-yellow":this.generatePaletteColor(n.surface2,"yellow"),"--spice-rgb-yellow":this.hexToRgb(this.generatePaletteColor(n.surface2,"yellow")),"--spice-green":this.generatePaletteColor(n.harmonyTertiary,"green"),"--spice-rgb-green":this.hexToRgb(this.generatePaletteColor(n.harmonyTertiary,"green")),"--spice-misc":n.surface1,"--spice-rgb-misc":s.surface1},g={"--spice-shimmer-primary":n.harmonyPrimary,"--spice-rgb-shimmer-primary":s.harmonyPrimary,"--spice-shimmer-secondary":n.harmonySecondary,"--spice-rgb-shimmer-secondary":s.harmonySecondary,"--spice-shimmer-tertiary":n.harmonyTertiary,"--spice-rgb-shimmer-tertiary":s.harmonyTertiary,"--spice-shimmer-quaternary":n.primary,"--spice-rgb-shimmer-quaternary":s.primary,"--spice-particle-glow":n.highlight,"--spice-rgb-particle-glow":s.highlight,"--spice-particle-core":n.primary,"--spice-rgb-particle-core":s.primary,"--spice-particle-trail":n.shadow,"--spice-rgb-particle-trail":s.shadow,"--spice-cinematic-red":this.generateCinematicRed(n.primary),"--spice-rgb-cinematic-red":this.hexToRgb(this.generateCinematicRed(n.primary)),"--spice-cinematic-cyan":this.generateCinematicCyan(n.primary),"--spice-rgb-cinematic-cyan":this.hexToRgb(this.generateCinematicCyan(n.primary)),"--spice-cinematic-yellow":this.generateCinematicYellow(n.highlight),"--spice-rgb-cinematic-yellow":this.hexToRgb(this.generateCinematicYellow(n.highlight)),"--spice-holographic-primary":this.generateHolographicPrimary(n.primary),"--spice-rgb-holographic-primary":this.hexToRgb(this.generateHolographicPrimary(n.primary)),"--spice-holographic-accent":this.generateHolographicAccent(n.harmonyPrimary),"--spice-rgb-holographic-accent":this.hexToRgb(this.generateHolographicAccent(n.harmonyPrimary)),"--spice-holographic-glow":this.generateHolographicGlow(n.highlight),"--spice-rgb-holographic-glow":this.hexToRgb(this.generateHolographicGlow(n.highlight))},f={...o,...c,...m,...d,...h,...g};this.cssController.batchSetVariables("SemanticColorManager",f,"critical","album-spicetify-update");let v={"--sn-bg-gradient-accent":n.primary,"--sn-bg-gradient-accent-rgb":s.primary,"--sn-bg-gradient-primary":n.primary,"--sn-bg-gradient-primary-rgb":s.primary,"--sn-bg-gradient-secondary":n.surface1,"--sn-bg-gradient-secondary-rgb":s.surface1};this.cssController.batchSetVariables("SemanticColorManager",v,"critical","album-starrynight-update");let C={"--sn-color-accent-hex":n.primary,"--sn-color-accent-rgb":s.primary,"--sn-accent-hex":n.primary,"--sn-accent-rgb":s.primary,"--sn-color-extracted-primary-rgb":s.primary,"--sn-color-extracted-secondary-rgb":s.surface1,"--sn-color-harmony-complementary-rgb":s.shadow,"--sn-color-harmony-analogous-rgb":s.highlight,"--sn-color-harmony-triadic-rgb":s.harmonyPrimary};this.cssController.batchSetVariables("SemanticColorManager",C,"critical","album-y3k-integration-update"),this.clearCache(),this.lastColorUpdate=Date.now(),this.colorUpdateCount++;let T=Object.keys(f).length+Object.keys(v).length+Object.keys(C).length;p.emitSync("colors:applied",{cssVariables:{...f,...v,...C},accentHex:n.primary,accentRgb:s.primary,appliedAt:this.lastColorUpdate}),this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Comprehensive Spicetify variable update with OKLAB album colors:",{primaryColor:n.primary,accentColor:n.surface1,shadowColor:n.shadow,highlightColor:n.highlight,surfaceProgression:[n.base,n.surface0,n.surface1,n.surface2],harmonyColors:[n.harmonyPrimary,n.harmonySecondary,n.harmonyTertiary],effectColors:{shimmerColors:4,particleColors:3,cinematicColors:3,holographicColors:3},totalSpicetifyVariablesUpdated:Object.keys(f).length,coreLayoutVariablesUpdated:Object.keys(m).length,starryNightVariablesUpdated:Object.keys(v).length,snColorVariablesUpdated:Object.keys(C).length,effectVariablesAdded:Object.keys(g).length,eventEmitted:!0,totalVariablesUpdated:T})}catch(e){console.error("[SemanticColorManager] Failed to update with album colors:",e)}}generateIntelligentColorDistribution(t,e,i,a){let r=t,n=e||t,s=i||this.generateDarkerVariant(t,.3),o=a||this.generateLighterVariant(t,.2),c=this.generateDarkerVariant(t,.6),m=this.generateDarkerVariant(t,.4),d=n,h=this.generateLighterVariant(n,.15),g=this.generateHueRotatedColor(t,120),f=this.generateHueRotatedColor(t,-60),v=this.generateHueRotatedColor(t,180);return{primary:r,surface0:m,surface1:d,surface2:h,base:c,shadow:s,highlight:o,harmonyPrimary:g,harmonySecondary:f,harmonyTertiary:v}}convertColorsToRgb(t){let e={};return Object.entries(t).forEach(([i,a])=>{e[i]=this.hexToRgb(a)}),e}generateDarkerVariant(t,e){try{let i=this.hexToRgbObject(t);if(!i)return t;let a=Math.max(0,Math.round(i.r*(1-e))),r=Math.max(0,Math.round(i.g*(1-e))),n=Math.max(0,Math.round(i.b*(1-e)));return this.rgbToHex(a,r,n)}catch(i){return console.warn("[SemanticColorManager] Failed to generate darker variant:",i),t}}generateLighterVariant(t,e){try{let i=this.hexToRgbObject(t);if(!i)return t;let a=Math.min(255,Math.round(i.r+(255-i.r)*e)),r=Math.min(255,Math.round(i.g+(255-i.g)*e)),n=Math.min(255,Math.round(i.b+(255-i.b)*e));return this.rgbToHex(a,r,n)}catch(i){return console.warn("[SemanticColorManager] Failed to generate lighter variant:",i),t}}generateHueRotatedColor(t,e){try{let i=this.hexToRgbObject(t);if(!i)return t;let a=this.rgbToHsl(i.r,i.g,i.b);a.h=(a.h+e)%360,a.h<0&&(a.h+=360);let r=this.hslToRgb(a.h,a.s,a.l);return this.rgbToHex(r.r,r.g,r.b)}catch(i){return console.warn("[SemanticColorManager] Failed to generate hue-rotated color:",i),t}}hexToRgbObject(t){let e=t.replace("#","");if(e.length!==6)return null;let i=parseInt(e.substring(0,2),16),a=parseInt(e.substring(2,4),16),r=parseInt(e.substring(4,6),16);return{r:i,g:a,b:r}}rgbToHex(t,e,i){let a=r=>{let n=Math.round(Math.max(0,Math.min(255,r))).toString(16);return n.length===1?"0"+n:n};return`#${a(t)}${a(e)}${a(i)}`}rgbToHsl(t,e,i){t/=255,e/=255,i/=255;let a=Math.max(t,e,i),r=Math.min(t,e,i),n=0,s=0,o=(a+r)/2;if(a===r)n=s=0;else{let c=a-r;switch(s=o>.5?c/(2-a-r):c/(a+r),a){case t:n=(e-i)/c+(e<i?6:0);break;case e:n=(i-t)/c+2;break;case i:n=(t-e)/c+4;break}n/=6}return{h:n*360,s:s*100,l:o*100}}hslToRgb(t,e,i){t/=360,e/=100,i/=100;let a=(o,c,m)=>(m<0&&(m+=1),m>1&&(m-=1),m<1/6?o+(c-o)*6*m:m<1/2?c:m<2/3?o+(c-o)*(2/3-m)*6:o),r,n,s;if(e===0)r=n=s=i;else{let o=i<.5?i*(1+e):i+e-i*e,c=2*i-o;r=a(c,o,t+1/3),n=a(c,o,t),s=a(c,o,t-1/3)}return{r:Math.round(r*255),g:Math.round(n*255),b:Math.round(s*255)}}hexToRgb(t){let e=t.replace("#",""),i=parseInt(e.substring(0,2),16),a=parseInt(e.substring(2,4),16),r=parseInt(e.substring(4,6),16);return`${i}, ${a}, ${r}`}getColorMappings(){return Fe.SEMANTIC_MAPPINGS}generateCinematicRed(t){try{let e=this.hexToRgbObject(t);if(!e)return"#FF0000";let i=Math.min(255,e.r+100),a=Math.max(0,Math.min(e.g*.3,100)),r=Math.max(0,Math.min(e.b*.2,80));return this.rgbToHex(i,a,r)}catch(e){return console.warn("[SemanticColorManager] Failed to generate cinematic red:",e),"#FF0000"}}generateCinematicCyan(t){try{let e=this.hexToRgbObject(t);if(!e)return"#00FFFF";let i=Math.min(255,e.g+120),a=Math.min(255,e.b+140),r=Math.max(0,Math.min(e.r*.2,60));return this.rgbToHex(r,i,a)}catch(e){return console.warn("[SemanticColorManager] Failed to generate cinematic cyan:",e),"#00FFFF"}}generateCinematicYellow(t){try{let e=this.hexToRgbObject(t);if(!e)return"#FFFF00";let i=Math.min(255,e.r+80),a=Math.min(255,e.g+100),r=Math.max(0,Math.min(e.b*.3,120));return this.rgbToHex(i,a,r)}catch(e){return console.warn("[SemanticColorManager] Failed to generate cinematic yellow:",e),"#FFFF00"}}generateHolographicPrimary(t){try{let e=this.hexToRgbObject(t);if(!e)return"#8A2BE2";let i=this.rgbToHsl(e.r,e.g,e.b),a=Math.min(1,i.s+.3),r=Math.min(.8,Math.max(.4,i.l+.1)),n=this.hslToRgb(i.h,a,r);return this.rgbToHex(n.r,n.g,n.b)}catch(e){return console.warn("[SemanticColorManager] Failed to generate holographic primary:",e),"#8A2BE2"}}generateHolographicAccent(t){try{return this.generateHueRotatedColor(t,45)}catch(e){return console.warn("[SemanticColorManager] Failed to generate holographic accent:",e),"#FF00FF"}}generateHolographicGlow(t){try{let e=this.hexToRgbObject(t);if(!e)return"#E0E0FF";let i=.7,a=Math.min(255,e.r+(255-e.r)*i),r=Math.min(255,e.g+(255-e.g)*i),n=Math.min(255,e.b+(255-e.b)*i);return this.rgbToHex(a,r,n)}catch(e){return console.warn("[SemanticColorManager] Failed to generate holographic glow:",e),"#E0E0FF"}}generateTextColor(t){try{let e=this.hexToRgbObject(t);return e&&(.299*e.r+.587*e.g+.114*e.b)/255>.5?"#24273A":"#CAD3F5"}catch(e){return console.warn("[SemanticColorManager] Failed to generate text color:",e),"#CAD3F5"}}generateSubtextColor(t){try{let e=this.hexToRgbObject(t);return e&&(.299*e.r+.587*e.g+.114*e.b)/255>.5?"#5B6078":"#A5ADCB"}catch(e){return console.warn("[SemanticColorManager] Failed to generate subtext color:",e),"#A5ADCB"}}generateOverlayColor(t,e){try{let i=this.hexToRgbObject(t);if(!i)return`rgba(88,91,112,${e})`;if((.299*i.r+.587*i.g+.114*i.b)/255>.5){let r=1-e*2,n=Math.max(0,Math.round(i.r*r)),s=Math.max(0,Math.round(i.g*r)),o=Math.max(0,Math.round(i.b*r));return this.rgbToHex(n,s,o)}else{let r=e*255,n=Math.min(255,Math.round(i.r+r)),s=Math.min(255,Math.round(i.g+r)),o=Math.min(255,Math.round(i.b+r));return this.rgbToHex(n,s,o)}}catch(i){return console.warn("[SemanticColorManager] Failed to generate overlay color:",i),`rgba(88,91,112,${e})`}}generateCrustColor(t){try{let e=this.hexToRgbObject(t);if(!e)return"#232634";if((.299*e.r+.587*e.g+.114*e.b)/255>.5){let a=Math.max(0,Math.round(e.r*.8)),r=Math.max(0,Math.round(e.g*.8)),n=Math.max(0,Math.round(e.b*.8));return this.rgbToHex(a,r,n)}else{let a=Math.min(255,Math.round(e.r+20)),r=Math.min(255,Math.round(e.g+20)),n=Math.min(255,Math.round(e.b+20));return this.rgbToHex(a,r,n)}}catch(e){return console.warn("[SemanticColorManager] Failed to generate crust color:",e),"#232634"}}generateMantleColor(t){try{let e=this.hexToRgbObject(t);if(!e)return"#1e2030";if((.299*e.r+.587*e.g+.114*e.b)/255>.5){let a=Math.max(0,Math.round(e.r*.95)),r=Math.max(0,Math.round(e.g*.95)),n=Math.max(0,Math.round(e.b*.95));return this.rgbToHex(a,r,n)}else{let a=Math.min(255,Math.round(e.r+10)),r=Math.min(255,Math.round(e.g+10)),n=Math.min(255,Math.round(e.b+10));return this.rgbToHex(a,r,n)}}catch(e){return console.warn("[SemanticColorManager] Failed to generate mantle color:",e),"#1e2030"}}generateZoneColor(t,e){try{let i=se(t);if(!i)return console.warn(`\u{1F527} [SemanticColorManager] Failed to parse RGB from ${t}`),t;let r={flamingo:{rAdjust:20,gAdjust:-10,bAdjust:-5},lavender:{rAdjust:10,gAdjust:-5,bAdjust:15},peach:{rAdjust:25,gAdjust:10,bAdjust:-15},rosewater:{rAdjust:15,gAdjust:-8,bAdjust:0},sapphire:{rAdjust:-20,gAdjust:-10,bAdjust:25}}[e],n=Math.max(0,Math.min(255,i.r+r.rAdjust)),s=Math.max(0,Math.min(255,i.g+r.gAdjust)),o=Math.max(0,Math.min(255,i.b+r.bAdjust)),c=it(n,s,o);return this.config.enableDebug&&console.log(`\u{1F3A8} [SemanticColorManager] Generated ${e} color: ${t} \u2192 ${c} (RGB: ${i.r},${i.g},${i.b} \u2192 ${n},${s},${o})`),c}catch(i){return console.warn(`\u{1F527} [SemanticColorManager] Failed to generate ${e} color for "${t}":`,i),t}}generatePaletteColor(t,e){try{let i=se(t);if(!i)return console.warn(`\u{1F527} [SemanticColorManager] Failed to parse RGB from ${t}`),t;let r={pink:{rAdjust:30,gAdjust:-20,bAdjust:-10},sky:{rAdjust:-30,gAdjust:10,bAdjust:30},red:{rAdjust:35,gAdjust:-25,bAdjust:-15},maroon:{rAdjust:25,gAdjust:-15,bAdjust:-10},yellow:{rAdjust:30,gAdjust:25,bAdjust:-30},green:{rAdjust:-25,gAdjust:30,bAdjust:-20}}[e],n=Math.max(0,Math.min(255,i.r+r.rAdjust)),s=Math.max(0,Math.min(255,i.g+r.gAdjust)),o=Math.max(0,Math.min(255,i.b+r.bAdjust)),c=it(n,s,o);return this.config.enableDebug&&console.log(`\u{1F3A8} [SemanticColorManager] Generated ${e} color: ${t} \u2192 ${c} (RGB: ${i.r},${i.g},${i.b} \u2192 ${n},${s},${o})`),c}catch(i){return console.warn(`\u{1F527} [SemanticColorManager] Failed to generate ${e} color for "${t}":`,i),t}}destroy(){try{this.cleanupEventSubscriptions(),this.clearCache(),this.cssController=null,this.initialized=!1,this.lastColorUpdate=0,this.colorUpdateCount=0,p.emitSync("system:destroyed",{systemName:"SemanticColorManager",timestamp:Date.now(),reason:"Manual destruction"}),this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] System destroyed and cleaned up")}catch(t){console.error("[SemanticColorManager] Error during destruction:",t)}}updateAnimation(t){}async healthCheck(){let t={system:"SemanticColorManager",healthy:!0,details:"SemanticColorManager operational",issues:[],metrics:{initialized:this.initialized,spicetifyAvailable:this.isSpicetifyAvailable(),cssControllerAvailable:!!this.cssController,lastColorUpdate:this.lastColorUpdate,colorUpdateCount:this.colorUpdateCount,eventSubscriptions:this.eventSubscriptionIds.length,cacheSize:this.colorCache.size,lastCacheUpdate:this.lastCacheUpdate}};return this.initialized||(t.healthy=!1,t.issues.push("System not initialized")),this.isSpicetifyAvailable()||(t.healthy=!1,t.issues.push("Spicetify API not available")),this.colorUpdateCount===0&&this.initialized&&t.issues.push("No color updates performed since initialization"),this.eventSubscriptionIds.length===0&&this.initialized&&t.issues.push("No event subscriptions active"),t.issues.length>0&&(t.details=`Issues detected: ${t.issues.join(", ")}`,t.issues.length>=2&&(t.healthy=!1)),t}setupEventSubscriptions(){let t=p.subscribe("music:track-changed",async i=>{this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Track changed, preparing for color refresh:",i.trackUri),this.clearCache()},"SemanticColorManager"),e=p.subscribe("settings:changed",async i=>{(i.settingKey.includes("color")||i.settingKey.includes("theme"))&&(this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Color-related setting changed:",i.settingKey),this.clearCache())},"SemanticColorManager");this.eventSubscriptionIds=[t,e],this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Event subscriptions established:",this.eventSubscriptionIds.length)}cleanupEventSubscriptions(){for(let t of this.eventSubscriptionIds)p.unsubscribe(t);this.eventSubscriptionIds=[],this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Event subscriptions cleaned up")}getSystemMetrics(){return{initialized:this.initialized,lastColorUpdate:this.lastColorUpdate,colorUpdateCount:this.colorUpdateCount,eventSubscriptions:this.eventSubscriptionIds.length,cacheSize:this.colorCache.size,spicetifyAvailable:this.isSpicetifyAvailable()}}};Fe.SEMANTIC_MAPPINGS=[{semanticColor:"textBase",cssVariable:"--spice-text",fallbackColor:"#cad3f5",description:"Primary text color"},{semanticColor:"textSubdued",cssVariable:"--spice-subtext",fallbackColor:"#a5adcb",description:"Secondary text color"},{semanticColor:"textBrightAccent",cssVariable:"--spice-accent",fallbackColor:"#c6a0f6",description:"Accent text color"},{semanticColor:"textNegative",cssVariable:"--spice-red",fallbackColor:"#ed8796",description:"Error text color"},{semanticColor:"textWarning",cssVariable:"--spice-yellow",fallbackColor:"#eed49f",description:"Warning text color"},{semanticColor:"textPositive",cssVariable:"--spice-green",fallbackColor:"#a6da95",description:"Success text color"},{semanticColor:"textAnnouncement",cssVariable:"--spice-blue",fallbackColor:"#8aadf4",description:"Info text color"},{semanticColor:"essentialBase",cssVariable:"--spice-button",fallbackColor:"#cad3f5",description:"Primary button color"},{semanticColor:"essentialSubdued",cssVariable:"--spice-button-disabled",fallbackColor:"#6e738d",description:"Disabled button color"},{semanticColor:"essentialBrightAccent",cssVariable:"--spice-button-active",fallbackColor:"#c6a0f6",description:"Active button color"},{semanticColor:"essentialNegative",cssVariable:"--spice-notification-error",fallbackColor:"#ed8796",description:"Error button color"},{semanticColor:"essentialWarning",cssVariable:"--spice-notification-warning",fallbackColor:"#eed49f",description:"Warning button color"},{semanticColor:"essentialPositive",cssVariable:"--spice-notification-success",fallbackColor:"#a6da95",description:"Success button color"},{semanticColor:"backgroundBase",cssVariable:"--spice-main",fallbackColor:"#24273a",description:"Main background color"},{semanticColor:"backgroundHighlight",cssVariable:"--spice-highlight",fallbackColor:"#363a4f",description:"Highlight background color"},{semanticColor:"backgroundPress",cssVariable:"--spice-press",fallbackColor:"#494d64",description:"Press state background color"},{semanticColor:"backgroundElevatedBase",cssVariable:"--spice-card",fallbackColor:"#1e2030",description:"Card background color"},{semanticColor:"backgroundElevatedHighlight",cssVariable:"--spice-card-highlight",fallbackColor:"#363a4f",description:"Card highlight background"},{semanticColor:"backgroundTintedBase",cssVariable:"--spice-sidebar",fallbackColor:"#363a4f",description:"Sidebar background color"},{semanticColor:"backgroundTintedHighlight",cssVariable:"--spice-sidebar-highlight",fallbackColor:"#494d64",description:"Sidebar highlight background"},{semanticColor:"decorativeBase",cssVariable:"--spice-decorative",fallbackColor:"#cad3f5",description:"Decorative element color"},{semanticColor:"decorativeSubdued",cssVariable:"--spice-decorative-subdued",fallbackColor:"#939ab7",description:"Subdued decorative color"}];mt=Fe});function Gn(){try{let t=document.createElement("canvas").getContext("webgl2");if(!t)return!1;let e=t.getExtension("EXT_color_buffer_float")!==null;return!0}catch{return!1}}function El(l,t){try{let e={alpha:t.alpha??!0,antialias:t.antialias??!0,preserveDrawingBuffer:t.preserveDrawingBuffer??!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1},i=l.getContext("webgl2",e);if(!i)return null;let a=i.getParameter(i.MAX_TEXTURE_SIZE);return{canvas:l,ctx:i,type:"webgl2",capabilities:{supportsGPUAcceleration:!0,supports3D:!0,maxTextureSize:a}}}catch(e){return console.warn("[VisualCanvasFactory] WebGL2 context creation failed:",e),null}}function Fn(l,t){let e={alpha:t.alpha??!0,desynchronized:!0},i=l.getContext("2d",e);return{canvas:l,ctx:i,type:"2d",capabilities:{supportsGPUAcceleration:!1,supports3D:!1}}}async function _n(l){let t=document.createElement("canvas");t.id=l.id,t.width=l.width??window.innerWidth,t.height=l.height??window.innerHeight;let e=l.fallbackChain??["webgl2","2d"];if(l.preferredType){let i=[l.preferredType,...e.filter(a=>a!==l.preferredType)];e.splice(0,e.length,...i)}for(let i of e){let a=null;switch(i){case"webgl2":Gn()&&(a=El(t,l));break;case"2d":a=Fn(t,l);break}if(a)return a}return Fn(t,l)}function Hn(){let l=Gn(),t="2d";return l&&(t="webgl2"),{webgl2:l,recommendedType:t}}var zn=y(()=>{"use strict"});function Un(l,t,e={}){let{trace:i}=e;if(!t||typeof t!="object")return i?.("[visualPerformance] No performanceProfiles provided \u2013 skipping selection"),null;let a=t[l];if(a||(i?.(`[visualPerformance] Profile '${l}' not found, falling back to 'balanced'`),a=t.balanced),!a){let r=Object.keys(t)[0];a=t[r],i?.(`[visualPerformance] Using first available profile '${r}' as fallback`)}return a}var On=y(()=>{"use strict"});var N,ne=y(()=>{"use strict";G();zn();Z();On();N=class{constructor(t=M,e=D,i,a,r){this.canvasCapabilities=null;this.activeCanvasResults=new Map;this.config=t,this.utils=e,this.performanceMonitor=i,this.musicSyncService=a,this.settingsManager=r,this.systemName=this.constructor.name,this.initialized=!1,this.isActive=!1,this.currentPerformanceProfile={},this.metrics={initializationTime:0,updates:0,errors:0},this._resizeHandler=null,this.boundHandleSettingsChange=this.handleSettingsChange.bind(this),this.config.enableDebug&&console.log(`[${this.systemName}] Constructor`)}async initialize(){let t=this.config.enableDebug?performance.now():0;if(this.config.enableDebug&&console.log(`[${this.systemName}] Initializing...`),this.settingsManager){document.addEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange);try{let e=globalThis.year3000System?.deviceCapabilityDetector,i="balanced";e?.isInitialized&&(i=e.recommendPerformanceQuality()),this.config.enableDebug&&console.log(`[${this.systemName}] Auto-selected performance quality '${i}' based on device capability.`),this._applyPerformanceProfile(i)}catch(e){this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Device capability detection failed; defaulting to 'balanced'.`,e),this._applyPerformanceProfile("balanced")}}if(await this._performSystemSpecificInitialization(),this.initialized=!0,this.isActive=!0,this.musicSyncService&&(this._validateDependenciesForSubscription()?(this.musicSyncService.subscribe(this,this.systemName),this.config.enableDebug&&console.log(`[${this.systemName}] Subscribed to MusicSyncService.`)):console.warn(`[${this.systemName}] Dependency validation failed; subscription skipped.`)),this.config.enableDebug){let e=performance.now()-t;console.log(`[${this.systemName}] Initialization complete in ${e.toFixed(2)}ms`)}}async _performSystemSpecificInitialization(){this.canvasCapabilities=Hn(),this.canvasCapabilities&&this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Canvas capabilities detected: WebGL2=${this.canvasCapabilities.webgl2}, Recommended=${this.canvasCapabilities.recommendedType}`)}_validateDependenciesForSubscription(){return typeof this.updateFromMusicAnalysis!="function"?(console.error(`[${this.systemName}] Missing updateFromMusicAnalysis method.`),!1):this.initialized?this._performAdditionalDependencyValidation():(console.warn(`[${this.systemName}] System not initialized.`),!1)}_performAdditionalDependencyValidation(){return!0}destroy(){this.config.enableDebug&&console.log(`[${this.systemName}] Destroying...`);try{this.initialized=!1,this.isActive=!1,this.musicSyncService&&this.musicSyncService.unsubscribe(this.systemName),this.settingsManager&&this.boundHandleSettingsChange&&document.removeEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange),this._resizeHandler&&(window.removeEventListener("resize",this._resizeHandler),this._resizeHandler=null),this._performSystemSpecificCleanup()}catch(t){console.error(`[${this.systemName}] Error during destruction:`,t),this.metrics.errors++}}_performSystemSpecificCleanup(){for(let[t,e]of this.activeCanvasResults){let i=e.canvas;i.parentNode&&i.parentNode.removeChild(i),this.config.enableDebug&&console.log(`[${this.systemName}] Cleaned up canvas: ${t} (type: ${e.type})`)}this.activeCanvasResults.clear()}updateFromMusicAnalysis(t,...e){}onAnimate(t){}updateAnimation(t){this.onAnimate(t)}async healthCheck(){let t=this.initialized&&this.isActive&&this.metrics.errors===0;return{system:this.systemName,healthy:t,metrics:{initialized:this.initialized,active:this.isActive,errors:this.metrics.errors,updates:this.metrics.updates,initializationTime:this.metrics.initializationTime},issues:t?[]:[...this.initialized?[]:["System not initialized"],...this.isActive?[]:["System not active"],...this.metrics.errors===0?[]:[`${this.metrics.errors} errors detected`]]}}updateModeConfiguration(t){}handleSettingsChange(t){}_applyPerformanceProfile(t){if(!this.config?.performanceProfiles){this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Performance profiles not found in config.`);return}let e=Un(t,this.config.performanceProfiles,{trace:i=>this.performanceMonitor?.emitTrace(i)});e?(this.currentPerformanceProfile=e,this.performanceMonitor?.emitTrace?.(`[BaseVisualSystem (${this.systemName})] Applied performance profile '${t}'`,e)):this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Performance profile '${t}' not found.`)}getCosmicState(){if(typeof document>"u")return{};let t=document.documentElement,e=getComputedStyle(t);return{energy:parseFloat(e.getPropertyValue("--sn-kinetic-energy"))||.5,valence:parseFloat(e.getPropertyValue("--sn-kinetic-valence"))||.5,bpm:parseFloat(e.getPropertyValue("--sn-kinetic-bpm"))||120,tempoMultiplier:parseFloat(e.getPropertyValue("--sn-kinetic-tempo-multiplier"))||1,beatPhase:parseFloat(e.getPropertyValue("--sn-kinetic-beat-phase"))||0,beatPulse:parseFloat(e.getPropertyValue("--sn-kinetic-beat-pulse"))||0}}async _createOptimizedKineticCanvas(t,e=5,i="screen",a="pulse"){let r=document.getElementById(t);r&&r.remove();let n="2d";this.canvasCapabilities&&this.currentPerformanceProfile&&(this.currentPerformanceProfile.quality||"balanced")!=="low"&&this.canvasCapabilities.webgl2&&(n="webgl2");let s=await _n({id:t,width:window.innerWidth,height:window.innerHeight,alpha:!0,antialias:!0,preferredType:n}),o=s.canvas;o.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: ${e};
      pointer-events: none;
      mix-blend-mode: ${i};
    `,o.classList.add("year3000-kinetic-canvas"),o.dataset.kineticMode=a,o.dataset.systemName=this.systemName,o.dataset.canvasType=s.type;let c=this._getKineticStyles(a);return Object.assign(o.style,c),document.body.appendChild(o),this.activeCanvasResults.set(t,s),this._resizeHandler=()=>{o.width=window.innerWidth,o.height=window.innerHeight,typeof this.handleResize=="function"&&this.handleResize()},window.addEventListener("resize",this._resizeHandler),this._resizeHandler(),this.config.enableDebug&&console.log(`[BaseVisualSystem (${this.systemName})] Created optimized kinetic canvas: ${s.type} (mode: ${a})`),s}getCanvasCapabilities(){return this.canvasCapabilities}hasGPUAcceleration(){return this.canvasCapabilities?.webgl2||!1}_createKineticCanvas(t,e=5,i="screen",a="pulse"){let r=this._createCanvasElement(t,e,i);r.classList.add("year3000-kinetic-canvas"),r.dataset.kineticMode=a,r.dataset.systemName=this.systemName;let n=this._getKineticStyles(a);return Object.assign(r.style,n),this.config.enableDebug&&console.log(`[BaseVisualSystem (${this.systemName})] Created kinetic canvas with mode: ${a}`),r}_getKineticStyles(t){let e={transition:"all 150ms cubic-bezier(0.25, 0.46, 0.45, 0.94)"};switch(t){case"pulse":return{...e,animation:"year3000-pulse calc(var(--sn-kinetic-tempo-multiplier, 1) * 1s) ease-in-out infinite"};case"breathe":return{...e,animation:"year3000-breathe calc(var(--sn-kinetic-tempo-multiplier, 1) * 4s) ease-in-out infinite"};case"flow":return{...e,animation:"year3000-flow calc(var(--sn-kinetic-tempo-multiplier, 1) * 8s) linear infinite"};default:return e}}_createCanvasElement(t,e,i){let a=document.getElementById(t);a&&a.remove();let r=document.createElement("canvas");return r.id=t,r.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: ${e};
      pointer-events: none;
      mix-blend-mode: ${i};
    `,document.body.appendChild(r),this._resizeHandler=()=>{r.width=window.innerWidth,r.height=window.innerHeight,typeof this.handleResize=="function"&&this.handleResize()},window.addEventListener("resize",this._resizeHandler),this._resizeHandler(),r}applyPerformanceSettings(t){this.currentPerformanceProfile=t,t.quality&&typeof this._applyPerformanceProfile=="function"&&this._applyPerformanceProfile?.(t.quality),this.config.enableDebug&&this.performanceMonitor?.emitTrace?.(`[BaseVisualSystem (${this.systemName})] Performance settings applied`,t)}applyUpdatedSettings(t,e){let i=new CustomEvent("year3000SystemSettingsChanged",{detail:{key:t,value:e}});try{this.handleSettingsChange(i)}catch(a){this.config.enableDebug&&console.warn(`[BaseVisualSystem] ${this.systemName} applyUpdatedSettings error`,a)}}forceRepaint(t){this.config.enableDebug&&console.log(`[${this.systemName}] Force repaint requested: ${t||"Unknown reason"}`)}}});var dt,Oa,Na,$a,Wa,qa=y(()=>{"use strict";dt=class{constructor(t={}){this.initialized=!1;this.emotionHistory=[];this.currentEmotion=null;this.emotionCache=new Map;this.emotionSubscribers=new Set;this.config={emotionSensitivity:.7,confidenceThreshold:.6,smoothingFactor:.3,memoryDecay:.1,visualEffectsAwareness:!0,smoothFlowDetection:!0,cinematicAnalysis:!0,analysisInterval:500,cacheSize:100,...t},this.valenceEnergyMapper=new Oa,this.audioFeatureAnalyzer=new Na,this.temperatureCalculator=new $a,this.visualEffectsDetector=new Wa}async initialize(){if(!this.initialized)try{await this.valenceEnergyMapper.initialize(),await this.audioFeatureAnalyzer.initialize(),await this.temperatureCalculator.initialize(),this.config.visualEffectsAwareness&&await this.visualEffectsDetector.initialize(),this.initialized=!0,console.log("\u{1F3B5} MusicEmotionAnalyzer initialized with visual effects awareness")}catch(t){throw console.error("\u274C Failed to initialize MusicEmotionAnalyzer:",t),t}}updateAnimation(t){}async healthCheck(){let t=[];return this.initialized||t.push("MusicEmotionAnalyzer not initialized"),this.emotionHistory.length===0&&t.push("No emotion analysis history available"),this.currentEmotion&&this.currentEmotion.confidence<this.config.confidenceThreshold&&t.push(`Low emotion confidence: ${this.currentEmotion.confidence.toFixed(2)}`),{healthy:t.length===0,issues:t,metrics:{emotionHistorySize:this.emotionHistory.length,currentConfidence:this.currentEmotion?.confidence??0,subscriberCount:this.emotionSubscribers.size,cacheSize:this.emotionCache.size}}}destroy(){this.emotionSubscribers.clear(),this.emotionHistory=[],this.emotionCache.clear(),this.currentEmotion=null,this.initialized=!1}async analyzeEmotion(t,e){if(!this.initialized)throw new Error("MusicEmotionAnalyzer must be initialized before analysis");try{let i=this.createCacheKey(t);if(this.emotionCache.has(i)){let r=this.emotionCache.get(i);if(r)return this.updateCurrentEmotion(r),r}let a=await this.performEmotionAnalysis(t,e);return this.cacheEmotion(i,a),this.updateCurrentEmotion(a),this.notifyEmotionUpdate(a),a}catch(i){return console.error("\u274C Error analyzing emotion:",i),this.createNeutralEmotion(t)}}getCurrentEmotion(){return this.currentEmotion}getEmotionHistory(t){return t?this.emotionHistory.slice(-t):[...this.emotionHistory]}onEmotionUpdate(t){return this.emotionSubscribers.add(t),()=>{this.emotionSubscribers.delete(t)}}updateConfig(t){this.config={...this.config,...t}}async performEmotionAnalysis(t,e){let i=this.audioFeatureAnalyzer.extractCharacteristics(t),a=this.valenceEnergyMapper.mapToEmotion(t.valence,t.energy,i),r=this.temperatureCalculator.calculateTemperature(a,i),n={};this.config.visualEffectsAwareness&&(n=await this.visualEffectsDetector.analyze(t,i,e));let s=this.applyTemporalSmoothing(a,i);return{primary:s.primary,secondary:s.secondary,intensity:s.intensity,confidence:s.confidence,valence:t.valence,arousal:t.energy,dominance:this.calculateDominance(t,i),colorTemperature:r,timestamp:Date.now(),duration:this.calculateEmotionDuration(s,i),musicalCharacteristics:{...i,smoothFlow:n.smoothFlow??i.smoothFlow,cinematicDepth:n.cinematicDepth??i.cinematicDepth,visualEffectsResonance:n.visualEffectsResonance??.5}}}applyTemporalSmoothing(t,e){if(!this.currentEmotion||this.config.smoothingFactor===0)return t;let i=this.config.smoothingFactor,a=t.intensity*(1-i)+this.currentEmotion.intensity*i,r=t.confidence*(1-i)+this.currentEmotion.confidence*i;return{primary:t.confidence>this.config.confidenceThreshold?t.primary:this.currentEmotion.primary,secondary:t.secondary,intensity:a,confidence:r}}calculateDominance(t,e){let i=Math.min(e.tempo/140,1),a=t.energy,r=Math.min((t.loudness+60)/60,1);return i*.3+a*.4+r*.3}calculateEmotionDuration(t,e){let a=6e4/e.tempo,r=t.confidence*2;return Math.min(2e3*a*r,1e4)}createCacheKey(t){return[Math.round(t.valence*100),Math.round(t.energy*100),Math.round(t.danceability*100),Math.round(t.acousticness*100),t.key,t.mode].join("-")}cacheEmotion(t,e){if(this.emotionCache.size>=this.config.cacheSize){let i=this.emotionCache.keys().next().value;i!==void 0&&this.emotionCache.delete(i)}this.emotionCache.set(t,e)}updateCurrentEmotion(t){this.currentEmotion=t,this.emotionHistory.push(t),this.emotionHistory.length>1e3&&(this.emotionHistory=this.emotionHistory.slice(-500))}notifyEmotionUpdate(t){this.emotionSubscribers.forEach(e=>{try{e(t)}catch(i){console.error("\u274C Error in emotion subscriber callback:",i)}})}createNeutralEmotion(t){return{primary:"serenity",secondary:[],intensity:.5,confidence:.3,valence:t.valence??.5,arousal:t.energy??.5,dominance:.5,colorTemperature:6500,timestamp:Date.now(),duration:3e3,musicalCharacteristics:this.audioFeatureAnalyzer.extractCharacteristics(t)}}},Oa=class{async initialize(){}mapToEmotion(t,e,i){let a,r=[],n,s=.8;return t>=.6&&e>=.6?(a=i.danceability>.7?"excitement":"joy",r=["joy","excitement"],n=Math.min(t+e-.2,1)):t>=.6&&e<.4?(a=i.acousticness>.6?"serenity":"love",r=["serenity","love"],n=t*.8):t<.4&&e>=.6?(a=i.mode===0?"anger":"fear",r=["anger","fear"],n=e):t<.4&&e<.4?(a=i.acousticness>.5?"melancholy":"sadness",r=["sadness","melancholy"],n=(1-t)*.8):(i.instrumentalness>.8?(a="transcendence",r=["transcendence","visual-effects"]):(a="nostalgia",r=["nostalgia"]),n=Math.abs(t-.5)+Math.abs(e-.5),s=.6),i.smoothFlow>.8&&r.push("smooth-flow"),i.visualEffectsResonance>.7&&r.push("visual-effects"),{primary:a,secondary:r,intensity:n,confidence:s}}},Na=class{async initialize(){}extractCharacteristics(t){return{tempo:t.tempo,key:t.key,mode:t.mode,timeSignature:t.timeSignature,energy:t.energy,danceability:t.danceability,acousticness:t.acousticness,instrumentalness:t.instrumentalness,liveness:t.liveness,speechiness:t.speechiness,smoothFlow:this.calculateSmoothFlow(t),cinematicDepth:this.calculateCinematicDepth(t),visualEffectsResonance:this.calculateVisualEffectsResonance(t)}}calculateSmoothFlow(t){let e=t.acousticness*.4,i=(1-Math.min(t.tempo/140,1))*.3,a=(1-t.energy)*.2,r=t.danceability*.1;return Math.min(e+i+a+r,1)}calculateCinematicDepth(t){let e=t.instrumentalness*.4,i=(1-t.liveness)*.2,a=(1-t.speechiness)*.2,r=Math.abs(t.energy-.5)*.2;return Math.min(e+i+a+r,1)}calculateVisualEffectsResonance(t){let e=1-Math.abs(t.valence-.5)*2,i=1-Math.abs(t.energy-.4)*2,a=t.instrumentalness*.3,r=t.acousticness*.2;return Math.max(0,(e+i)*.5+a+r)}},$a=class{async initialize(){}calculateTemperature(t,e){let i;switch(t.primary){case"joy":case"excitement":i=8e3;break;case"love":case"serenity":i=3e3;break;case"anger":i=15e3;break;case"fear":i=12e3;break;case"sadness":case"melancholy":i=2e3;break;case"nostalgia":i=2500;break;case"transcendence":case"visual-effects":i=6500;break;case"smooth-flow":i=4e3;break;default:i=6500}let a=(t.intensity-.5)*2e3,r=(e.tempo-120)*10,n=(e.energy-.5)*1e3,s=i+a+r+n;return Math.max(1e3,Math.min(2e4,s))}},Wa=class{async initialize(){}async analyze(t,e,i){let a=e.smoothFlow,r=e.cinematicDepth,n=e.visualEffectsResonance;if(i?.waveform){let s=this.analyzeWaveformPatterns(i.waveform);a=Math.min(1,a+s.smoothness*.2),r=Math.min(1,r+s.dynamicRange*.3),n=Math.min(1,n+s.harmonicComplexity*.2)}return{smoothFlow:a,cinematicDepth:r,visualEffectsResonance:n}}analyzeWaveformPatterns(t){let e=0,i=0,a=0;if(t.length>1){let r=0;for(let o=1;o<t.length;o++){let c=t[o],m=t[o-1];c!==void 0&&m!==void 0&&(r+=Math.abs(c-m))}e=1-Math.min(r/t.length,1);let n=Math.max(...t),s=Math.min(...t);i=n-s,a=Math.min(this.estimateHarmonicContent(t),1)}return{smoothness:e,dynamicRange:i,harmonicComplexity:a}}estimateHarmonicContent(t){let e=0;for(let i=1;i<t.length;i++){let a=t[i],r=t[i-1];a!==void 0&&r!==void 0&&a>=0!=r>=0&&e++}return Math.min(e/(t.length*.1),1)}}});var Ge,at,Ya=y(()=>{"use strict";ei();si();k();A();Me();ie();Tt();Rn();Z();Ua();ne();qa();Ge=class Ge extends N{constructor(e,i,a,r){super(e,i||D,a,null,r||null);this.animationEngine=null;this.userIntensity=.7;this.evolutionEnabled=!0;this._evolutionTimer=null;this._pendingPaletteRefresh=null;this._lastGenre=null;this.systemName="ColorHarmonyEngine",this.paletteExtensionManager=new hi(this.config,this.utils),this.semanticColorManager=new mt({enableDebug:this.config.enableDebug,fallbackToSpiceColors:!0,cacheDuration:5e3}),this.currentTheme=this.detectCurrentTheme();let n=e;if(n&&typeof n.colorHarmonyIntensity=="number"&&Number.isFinite(n.colorHarmonyIntensity)){let s=Math.max(0,Math.min(1,n.colorHarmonyIntensity));this.userIntensity=s}this.harmonyMetrics={totalHarmonyCalculations:0,musicInfluencedAdjustments:0,temporalMemoryEvents:0,performance:[]},this.musicalMemory={recentTracks:[],userColorPreferences:new Map,energyHistory:[],maxMemorySize:50},this.kineticState={currentPulse:0,animationPhase:0,lastBeatTime:0,visualMomentum:0},this.catppuccinPalettes={frappe:{accents:{rosewater:"#f2d5cf",flamingo:"#eebebe",pink:"#ff6b9d",mauve:"#c77dff",red:"#ff4757",maroon:"#ea999c",peach:"#ff7675",yellow:"#fdcb6e",green:"#6c5ce7",teal:"#00cec9",sky:"#74b9ff",sapphire:"#0984e3",blue:"#a29bfe",lavender:"#fd79a8"},neutrals:{base:"#303446",surface0:"#414559",surface1:"#51576d",surface2:"#626880"}},latte:{accents:{rosewater:"#dc8a78",flamingo:"#dd7878",pink:"#e84393",mauve:"#a55eea",red:"#fd79a8",maroon:"#e64553",peach:"#fd7f28",yellow:"#f39c12",green:"#00b894",teal:"#00cec9",sky:"#0984e3",sapphire:"#6c5ce7",blue:"#74b9ff",lavender:"#a29bfe"},neutrals:{base:"#eff1f5",surface0:"#e6e9ef",surface1:"#dce0e8",surface2:"#c5c9d1"}},macchiato:{accents:{rosewater:"#f4dbd6",flamingo:"#f0c6c6",pink:"#ff6b9d",mauve:"#c77dff",red:"#ff4757",maroon:"#ee99a0",peach:"#ff7675",yellow:"#fdcb6e",green:"#6c5ce7",teal:"#00cec9",sky:"#74b9ff",sapphire:"#0984e3",blue:"#a29bfe",lavender:"#fd79a8"},neutrals:{base:"#24273a",surface0:"#363a4f",surface1:"#494d64",surface2:"#5b6078"}},mocha:{accents:{rosewater:"#f5e0dc",flamingo:"#f2cdcd",pink:"#ff6b9d",mauve:"#c77dff",red:"#ff4757",maroon:"#eba0ac",peach:"#ff7675",yellow:"#fdcb6e",green:"#6c5ce7",teal:"#00cec9",sky:"#74b9ff",sapphire:"#0984e3",blue:"#a29bfe",lavender:"#fd79a8"},neutrals:{base:"#1e1e2e",surface0:"#313244",surface1:"#45475a",surface2:"#585b70"}}},this.vibrancyConfig={defaultBlendRatio:.75,minimumSaturation:.6,maximumDesaturation:.1,contrastBoostIntensity:1.4,harmonyTolerance:.3,artisticSaturationBoost:1.35,enhancedLuminanceBoost:1.25,energyResponsiveness:.8,getBlendRatio(s="artist-vision"){return{"corporate-safe":.6,"artist-vision":.75,"advanced-maximum":.85,"cosmic-maximum":.85}[s]||this.defaultBlendRatio}},this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Initialized with Year 3000 Quantum Empathy"),e&&typeof e.colorHarmonyEvolution=="boolean"?this.evolutionEnabled=e.colorHarmonyEvolution:e&&typeof e.harmonicEvolution=="boolean"&&(this.evolutionEnabled=e.harmonicEvolution),this.emotionalTemperatureMapper=new J(this.config.enableDebug),this.oklabProcessor=new E(this.config.enableDebug),this.musicEmotionAnalyzer=new dt({emotionSensitivity:.7,confidenceThreshold:.6,visualEffectsAwareness:!0,smoothFlowDetection:!0,cinematicAnalysis:!0,analysisInterval:500}),this.genreGradientEvolution=new ke(void 0,null,null,this.settingsManager),this.oklabState={currentPreset:E.PRESETS.STANDARD,processedPalette:{},perceptualGradientCache:new Map,colorHarmonyCache:new Map,lastProcessingTime:0},this.emotionalState={currentEmotion:null,emotionHistory:[],lastEmotionUpdate:0,emotionInfluenceIntensity:.8},this.genreState={currentGenre:"unknown",genreConfidence:0,genreHistory:[],lastGenreUpdate:0,genreInfluenceIntensity:.7},this._boundSettingsChangeHandler=this._handleSettingsChange.bind(this),this._boundArtisticModeHandler=this._handleArtisticModeChanged.bind(this),document.addEventListener("year3000SystemSettingsChanged",this._boundSettingsChangeHandler),document.addEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),this.evolutionEnabled&&this._startEvolutionLoop()}getCurrentActivePalette(){try{if(K.getCurrentPaletteSystem()==="year3000"){let i=K.getCurrentPalette(),a=K.getCurrentDefaultFlavor(),r=i[a];if(!r)throw new Error(`No palette found for flavor: ${a}`);let n={},s={};return Object.entries(r).forEach(([o,c])=>{["base","surface0","surface1","surface2","mantle","crust"].includes(o)?s[o]=c.hex:n[o]=c.hex}),{accents:n,neutrals:s}}else return this.catppuccinPalettes[this.currentTheme]}catch(e){return console.warn("[ColorHarmonyEngine] Failed to get active palette, using fallback:",e),this.catppuccinPalettes[this.currentTheme]}}updateAnimation(e,i){let a=i??e;this.onAnimate(a)}onAnimate(e){this._updateCSSVariables(e),this._calculateBeatPulse(e),p.emitSync("performance:frame",{deltaTime:e,fps:60,memoryUsage:performance.memory?.usedJSHeapSize||0,timestamp:performance.now()})}_updateCSSVariables(e){let i={"--sn-harmony-energy":this.kineticState.visualMomentum.toFixed(3),"--sn-harmony-pulse":this.kineticState.currentPulse.toFixed(3),"--sn-harmony-animation-phase":(Math.sin(this.kineticState.animationPhase)*.5+.5).toFixed(3)};this.kineticState.musicIntensityMultiplier!==void 0&&(i["--sn-harmony-intensity"]=this.kineticState.musicIntensityMultiplier.toFixed(3)),this.kineticState.valenceGravity!==void 0&&(i["--sn-harmony-valence"]=this.kineticState.valenceGravity.toFixed(3)),this.kineticState.beatPhase!==void 0&&(i["--sn-harmony-beat-phase"]=this.kineticState.beatPhase.toFixed(3)),this.kineticState.hueShift!==void 0&&(i["--sn-harmony-hue-shift"]=`${this.kineticState.hueShift.toFixed(1)}deg`);let a=Math.max(0,Math.min(1,this.kineticState.currentPulse*1.2));i["--sn-text-glow-intensity"]=a.toFixed(3),p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:i,timestamp:Date.now()})}_calculateBeatPulse(e){this.kineticState.currentPulse*=Math.pow(.95,e/16.67),this.kineticState.animationPhase+=e/1e3*.5,this.kineticState.animationPhase>2*Math.PI&&(this.kineticState.animationPhase-=2*Math.PI),this._emitGradientAnimationEvents(e)}_emitGradientAnimationEvents(e){let i=this._calculateCurrentEnergyLevel(),a=this._detectBeatFromAudioAnalysis();Math.random()<.1&&p.emit("music:energy",{energy:i.energy,valence:i.valence,tempo:120,timestamp:performance.now()}),a.detected&&p.emit("music:beat",{intensity:a.intensity,confidence:a.confidence,timestamp:performance.now(),bpm:120})}_calculateCurrentEnergyLevel(){let e=.5+Math.sin(this.kineticState.animationPhase)*.3;return{energy:Math.max(.2,e),valence:.5+this.kineticState.currentPulse*.3,arousal:.4+this.kineticState.currentPulse*.4}}_detectBeatFromAudioAnalysis(){let i=this.kineticState.currentPulse;return i>.3?{detected:!0,intensity:Math.min(1,i*1.5),confidence:Math.min(1,(i-.3)/(1-.3))}:Math.sin(this.kineticState.animationPhase)>.8?{detected:!0,intensity:.4,confidence:.6}:{detected:!1,intensity:0,confidence:0}}async initialize(){await super.initialize();let e=this.performanceMonitor?this.performanceMonitor.cssVisualEffectsController:void 0;this.semanticColorManager.initialize(e),p.subscribe("colors:extracted",this.handleColorExtraction.bind(this),"ColorHarmonyEngine"),this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Initialized as independent OKLAB color processor.");try{await this.musicEmotionAnalyzer.initialize(),this.musicEmotionAnalyzer.onEmotionUpdate(i=>{this.handleEmotionUpdate(i)}),this.config.enableDebug&&console.log("\u{1F3AD} [ColorHarmonyEngine] MusicEmotionAnalyzer initialized with audioAnalysis awareness")}catch(i){console.warn("\u{1F3AD} [ColorHarmonyEngine] Failed to initialize MusicEmotionAnalyzer:",i)}try{await this.genreGradientEvolution.initialize(),this.config.enableDebug&&console.log("\u{1F3B6} [ColorHarmonyEngine] GenreGradientEvolution initialized with aesthetic intelligence")}catch(i){console.warn("\u{1F3B6} [ColorHarmonyEngine] Failed to initialize GenreGradientEvolution:",i)}this.config.enableDebug&&(console.log("\u{1F3A8} [ColorHarmonyEngine] Initialized with Year 3000 Quantum Empathy via BaseVisualSystem and SemanticColorManager."),console.log("\u{1F3A8} [ColorHarmonyEngine] Subscribed to 'colors/extracted' events for strategy pattern processing.")),this.initialized=!0}handleEmotionUpdate(e){if(this.initialized)try{this.emotionalState.currentEmotion=e,this.emotionalState.emotionHistory.push(e),this.emotionalState.lastEmotionUpdate=Date.now(),this.emotionalState.emotionHistory.length>50&&(this.emotionalState.emotionHistory=this.emotionalState.emotionHistory.slice(-25)),p.emit("music:emotion-analyzed",{emotion:e,colorTemperature:e.colorTemperature,visualEffectsLevel:e.musicalCharacteristics.visualEffectsResonance,smoothFlow:e.musicalCharacteristics.smoothFlow,cinematicDepth:e.musicalCharacteristics.cinematicDepth,timestamp:e.timestamp}),this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Emotion updated: ${e.primary} (intensity: ${e.intensity.toFixed(2)}, confidence: ${e.confidence.toFixed(2)})`),this.triggerEmotionalColorUpdate(e)}catch(i){console.error("\u{1F3AD} [ColorHarmonyEngine] Error handling emotion update:",i)}}triggerEmotionalColorUpdate(e){this.emotionalState.emotionInfluenceIntensity>0&&e.confidence>.6&&(this._pendingPaletteRefresh&&clearTimeout(this._pendingPaletteRefresh),this._pendingPaletteRefresh=setTimeout(()=>{this.refreshPaletteWithEmotion(e),this._pendingPaletteRefresh=null},100))}async refreshPaletteWithEmotion(e){try{let i={primaryEmotion:e.primary,emotionIntensity:e.intensity,colorTemperature:e.colorTemperature,valence:e.valence,arousal:e.arousal,dominance:e.dominance,smoothFlow:e.musicalCharacteristics.smoothFlow,cinematicDepth:e.musicalCharacteristics.cinematicDepth,visualEffectsResonance:e.musicalCharacteristics.visualEffectsResonance};p.emit("music:emotional-context-updated",i),this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Refreshing colors with ${e.primary} emotion influence`)}catch(i){console.error("\u{1F3AD} [ColorHarmonyEngine] Error refreshing palette with emotion:",i)}}async healthCheck(){return this.getCurrentActivePalette()?{healthy:!0,ok:!0,details:"Palettes are loaded correctly.",issues:[],system:"ColorHarmonyEngine"}:{healthy:!1,ok:!1,details:`Current theme '${this.currentTheme}' not found in palettes.`,issues:[`Current theme '${this.currentTheme}' not found in palettes.`],system:"ColorHarmonyEngine"}}async processColors(e){let i=performance.now();try{let{rawColors:a,trackUri:r,musicData:n}=e,s=this.determineOptimalOKLABPreset(e);this.oklabState.currentPreset=s;let o=await this.analyzeGenreAesthetics(n,a),c=await this.getAdvancedEmotionalTemperature(n,a),m=await this.blendWithAdvancedOKLAB(a,n,c,o||void 0),d=m.VIBRANT||m.PROMINENT||Object.values(m)[0]||"#a6adc8",h=this.utils.hexToRgb(d),g=h?`${h.r},${h.g},${h.b}`:"166,173,200";try{let T={processedColors:m,accentHex:d,accentRgb:g,originalColors:a,trackUri:r,musicData:n,timestamp:Date.now(),strategies:["ColorHarmonyEngine"],processingTime:performance.now()-i,coordinationMetrics:{detectedGenre:o?.genre||"unknown",genreConfidence:o?.confidence||0,emotionalState:this.emotionalState.currentEmotion?.primary||"neutral",oklabPreset:s?.name||"standard",coordinationStrategy:"genre-emotion-color-unified",musicInfluenceStrength:this.genreState.genreInfluenceIntensity}};p.emitSync("colors:harmonized",T),this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Emitted colors:harmonized via UnifiedEventBus (facade pattern):",{processedColors:Object.keys(m),accentHex:d,noDomEvents:"correct architecture"})}catch(T){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Failed to emit colors:harmonized event:",T)}let f=performance.now()-i;this.harmonyMetrics.totalHarmonyCalculations++,this.harmonyMetrics.performance.push(f);let v={processedColors:m,accentHex:d,accentRgb:g,metadata:{strategy:"CatppuccinHarmony",processingTime:f,cacheKey:`catppuccin-${r}-${this.currentTheme}`,colorHarmonyIntensity:this.userIntensity},context:e},C=this.generateAdvancedOKLABCSSVariables(v);return this.applyCSSVariablesToDOM(C),this.generatePerceptualGradientData(v),this.updateAdvancedHarmonyMetrics(v,f),p.emitSync("colors:harmonized",{processedColors:v.processedColors,accentHex:v.accentHex,accentRgb:v.accentRgb,strategies:v.metadata?.strategy?[v.metadata.strategy]:["ColorHarmonyEngine"],processingTime:f,trackUri:v.context.trackUri}),this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Processed colors via strategy pattern in ${f.toFixed(2)}ms`,{accentHex:d,strategy:"CatppuccinHarmony",cssVariablesCount:Object.keys(C).length}),v}catch(a){return console.error("[ColorHarmonyEngine] Strategy processing failed:",a),{processedColors:{VIBRANT:"#a6adc8"},accentHex:"#a6adc8",accentRgb:"166,173,200",metadata:{strategy:"CatppuccinHarmony",processingTime:performance.now()-i,error:String(a)},context:e}}}getStrategyName(){return"CatppuccinHarmony"}canProcess(e){return e&&e.rawColors&&Object.keys(e.rawColors).length>0}getEstimatedProcessingTime(e){let a=Object.keys(e.rawColors||{}).length;return 5*Math.max(1,a/5)}async handleColorExtraction(e){try{if(!this.initialized){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Received color extraction event but not initialized");return}let i={rawColors:e.rawColors,trackUri:e.trackUri,timestamp:e.timestamp,colorHarmonyMode:this.currentTheme,harmonicMode:this.currentTheme,musicData:e.musicData,performanceHints:{preferLightweight:!1,enableAdvancedBlending:!0,maxProcessingTime:100}};this.canProcess(i)?await this.processColors(i):this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Cannot process color context:",i)}catch(i){console.error("[ColorHarmonyEngine] Error handling color extraction event:",i)}}generateCSSVariables(e){let i={};i["--sn-accent-hex"]=e.accentHex,i["--sn-accent-rgb"]=e.accentRgb,i[Ge.CANONICAL_HEX_VAR]=e.accentHex,i[Ge.CANONICAL_RGB_VAR]=e.accentRgb;let a=e.processedColors,r=a.VIBRANT||a.PROMINENT||e.accentHex,n=a.DARK_VIBRANT||a.DESATURATED||r,s=a.VIBRANT_NON_ALARMING||a.LIGHT_VIBRANT||r;i["--sn-bg-gradient-primary"]=r,i["--sn-bg-gradient-secondary"]=n,i["--sn-bg-gradient-accent"]=s;let o=this.utils.hexToRgb(r),c=this.utils.hexToRgb(n),m=this.utils.hexToRgb(s);return o&&(i["--sn-bg-gradient-primary-rgb"]=`${o.r},${o.g},${o.b}`),c&&(i["--sn-bg-gradient-secondary-rgb"]=`${c.r},${c.g},${c.b}`),m&&(i["--sn-bg-gradient-accent-rgb"]=`${m.r},${m.g},${m.b}`),this.generateOKLABVariables(i,e),this.config.enableDebug&&console.log("\u{1F527} [ColorHarmonyEngine] Generated background gradient CSS variables:",{primary:`${r} -> ${i["--sn-bg-gradient-primary-rgb"]}`,secondary:`${n} -> ${i["--sn-bg-gradient-secondary-rgb"]}`,accent:`${s} -> ${i["--sn-bg-gradient-accent-rgb"]}`,totalVariables:Object.keys(i).length,note:"CSS mapping automatically updates --sn-gradient-* variables"}),i}generateOKLABVariables(e,i){try{let a=i.accentHex,r=i.processedColors,n=r.DARK_VIBRANT||r.DESATURATED||a,s=this.utils.hexToRgb(a),o=this.utils.hexToRgb(n);if(s){let c=this.utils.rgbToOklab(s.r,s.g,s.b),m={L:Math.min(1,c.L*1.1),a:c.a*1.15,b:c.b*1.15},d=this.utils.oklabToRgb(m.L,m.a,m.b);e["--sn-color-oklab-bright-highlight-rgb"]=`${d.r},${d.g},${d.b}`,e["--sn-color-oklab-primary-r"]=Math.round(d.r).toString(),e["--sn-color-oklab-primary-g"]=Math.round(d.g).toString(),e["--sn-color-oklab-primary-b"]=Math.round(d.b).toString(),e["--sn-color-oklab-accent-r"]=Math.round(d.r).toString(),e["--sn-color-oklab-accent-g"]=Math.round(d.g).toString(),e["--sn-color-oklab-accent-b"]=Math.round(d.b).toString(),e["--sn-color-oklab-accent-luminance"]=m.L.toFixed(3);let h=this.convertOklabToOklch(m);e["--sn-color-oklch-accent-l"]=h.L.toFixed(3),e["--sn-color-oklch-accent-c"]=h.C.toFixed(3),e["--sn-color-oklch-accent-h"]=h.H.toFixed(1),e["--sn-color-oklch-primary-l"]=h.L.toFixed(3),e["--sn-color-oklch-primary-c"]=h.C.toFixed(3),e["--sn-color-oklch-primary-h"]=h.H.toFixed(1)}if(o){let c=this.utils.rgbToOklab(o.r,o.g,o.b),m={L:Math.max(.05,c.L*.3),a:c.a*.8,b:c.b*.8},d=this.utils.oklabToRgb(m.L,m.a,m.b);e["--sn-color-oklab-dynamic-shadow-rgb"]=`${d.r},${d.g},${d.b}`,e["--sn-color-oklab-base-luminance"]=m.L.toFixed(3)}this.config.enableDebug&&console.log("\u{1F52C} [ColorHarmonyEngine] Generated OKLAB-processed variables:",{primaryColor:a,secondaryColor:n,oklabVariablesCount:Object.keys(e).filter(c=>c.includes("oklab")).length,oklchVariablesCount:Object.keys(e).filter(c=>c.includes("oklch")).length})}catch(a){this.config.enableDebug&&console.warn("\u{1F52C} [ColorHarmonyEngine] OKLAB processing failed, using fallbacks:",a);let r=this.utils.hexToRgb(i.accentHex);r&&(e["--sn-color-oklab-bright-highlight-rgb"]=`${r.r},${r.g},${r.b}`,e["--sn-color-oklab-dynamic-shadow-rgb"]=`${Math.round(r.r*.3)},${Math.round(r.g*.3)},${Math.round(r.b*.3)}`)}}convertOklabToOklch(e){let i=e.L,a=Math.sqrt(e.a*e.a+e.b*e.b),r=Math.atan2(e.b,e.a)*(180/Math.PI);return r<0&&(r+=360),{L:i,C:a,H:r}}detectCurrentTheme(){let e=this.utils.getRootStyle();if(!e)return console.warn("[ColorHarmonyEngine detectCurrentTheme] Root element not found. Defaulting to mocha."),"mocha";let a=getComputedStyle(e).getPropertyValue("--spice-main").trim(),r=a.startsWith("#")?a.substring(1).toUpperCase():a.toUpperCase(),s={303446:"frappe",EFF1F5:"latte","24273A":"macchiato","1E1E2E":"mocha"}[r];if(s)return this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Detected Catppuccin theme: ${s}`),s;this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Unknown theme detected (${r}), attempting to generate fallback`);let o=`custom-${r.toLowerCase()}`;try{let c=this.paletteExtensionManager.generateFallbackPalette(o);this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Generated fallback palette for theme: ${o}`,c)}catch(c){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Failed to generate fallback palette:",c)}return this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Falling back to mocha theme for unknown base color: ${r}`),"mocha"}async _getGenreAwarePalette(e){let i=this.getCurrentActivePalette();if(!e||!i)return i;try{let a={name:this.currentTheme,version:"1.0.0",accents:i.accents,neutrals:i.neutrals,metadata:{author:"Catppuccin",description:`${this.currentTheme} flavor`,temperature:"neutral"}},r=this.paletteExtensionManager.applyGenreAwareModifications(a,e);return{accents:r.accents,neutrals:r.neutrals}}catch(a){return this.config.enableDebug&&console.warn(`[ColorHarmonyEngine] Failed to apply genre modifications for ${e}:`,a),i}}getMusicIntensityMultiplier(e=.5,i=.5){let a=this.config.getCurrentMultipliers().musicEnergyBoost,r=e>.7?1.3:e>.4?1:.8,n=i>.6?1.2:i<.4?.9:1;return a*r*n}validateColorHarmony(e,i="general"){let a=performance.now();this.harmonyMetrics.totalHarmonyCalculations++;let r={general:{minContrast:1.8,minHarmony:this.vibrancyConfig.harmonyTolerance},search:{minContrast:2.8,minHarmony:.4},navigation:{minContrast:2.5,minHarmony:.45},text:{minContrast:4.5,minHarmony:.6},accent:{minContrast:1.5,minHarmony:.3}},n=r[i]||r.general,s=this.getCurrentActivePalette();if(!s?.neutrals?.base){let T=`[StarryNight] Catppuccin palette or base neutral not found for theme: ${this.currentTheme}`;return console.error(T),{isValid:!1,error:"Palette configuration error.",contrastRatio:0,harmonyScore:0,meetsContrast:!1,isHarmonious:!1,artisticMode:this.config.artisticMode,adjustedRequirements:n,recommendations:[]}}let o=s.neutrals.base,c=this.utils.rgbToHex(e.r,e.g,e.b),m=this.utils.calculateContrastRatio(c,o),d=this.calculateHarmonyScore(e,s),h=this.config.artisticMode,g={...n};h==="advanced-maximum"||h==="cosmic-maximum"?(g.minContrast*=.7,g.minHarmony*=.6):h==="artist-vision"&&(g.minContrast*=.85,g.minHarmony*=.8);let f=m>=g.minContrast,v=d>=g.minHarmony,C=performance.now();return this.harmonyMetrics.performance.push(C-a),{isValid:f&&v,contrastRatio:m,harmonyScore:d,meetsContrast:f,isHarmonious:v,artisticMode:h,adjustedRequirements:g,recommendations:this.generateRecommendations(e,m,d,g)}}calculateHarmonyScore(e,i){let a=this.utils.rgbToHsl(e.r,e.g,e.b),r=0,n=Object.values(i.accents);for(let s of n){let o=this.utils.hexToRgb(s);if(!o)continue;let c=this.utils.rgbToHsl(o.r,o.g,o.b),m=Math.abs(a.h-c.h),d=Math.min(m,360-m),h=[0,30,60,90,120,150,180,210,240,270,300,330];if(h.some(f=>Math.abs(d-f)<20)){let f=1-Math.min(...h.map(v=>Math.abs(d-v)))/20;r=Math.max(r,f)}}return r}findBestHarmoniousAccent(e,i){let a={name:"mauve",hex:this.utils.getRootStyle()?.style.getPropertyValue("--sn-dynamic-accent")?.trim()||this.utils.getRootStyle()?.style.getPropertyValue("--spice-accent")?.trim()||"#cba6f7",rgb:{r:203,g:166,b:247}},r=["mauve","lavender","blue","sapphire","sky","pink","peach","teal"],n=-1,s=this.utils.rgbToHsl(e.r,e.g,e.b);for(let o of r){let c=i.accents[o];if(c){let m=this.utils.hexToRgb(c);if(!m)continue;let d=this.utils.rgbToHsl(m.r,m.g,m.b),h=Math.abs(s.h-d.h),f=1-Math.min(h,360-h)/180,v=d.s*.3,C=f+v;C>n&&(n=C,a={name:o,hex:c,rgb:m})}}return a}blendColors(e,i,a=this.vibrancyConfig.defaultBlendRatio){let r=Math.max(0,Math.min(1,a)),n=this.utils.rgbToOklab(e.r,e.g,e.b),s=this.utils.rgbToOklab(i.r,i.g,i.b),o=(V,W)=>V*r+W*(1-r),c={L:o(n.L,s.L),a:o(n.a,s.a),b:o(n.b,s.b)},m=this.utils.oklabToRgb(c.L,c.a,c.b),d=this.utils.rgbToHsl(m.r,m.g,m.b),h=this.config?.artisticMode??"artist-vision",g=this.animationEngine?.getCurrentMultipliers?.()||void 0,f=(h==="advanced-maximum"||h==="cosmic-maximum")&&!!g,v=g||{},C=f?(v.visualIntensityBase||1)*1.25:this.vibrancyConfig.artisticSaturationBoost,T=f?(v.aestheticGravityStrength||1)*1.15:this.vibrancyConfig.enhancedLuminanceBoost;d.s=Math.max(d.s,this.vibrancyConfig.minimumSaturation*100),d.s=Math.min(100,d.s*C),h!=="corporate-safe"&&(d.l=Math.min(95,d.l*T));let w=this.utils.hslToRgb(d.h,d.s,d.l);return{r:w.r,g:w.g,b:w.b}}blendWithCatppuccin(e,i=null){this.performanceMonitor?.emitTrace?.("[ColorHarmonyEngine] Starting blendWithCatppuccin");let a=null;if(i)try{let s={energy:i.energy||.5,valence:i.valence||.5,danceability:i.danceability,tempo:i.enhancedBPM||i.tempo,loudness:i.loudness,acousticness:i.acousticness,instrumentalness:i.instrumentalness,speechiness:i.speechiness,mode:i.mode,key:i.key,genre:i.genre};a=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(s),a&&(p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:a.cssVariables,timestamp:Date.now()}),document.body.classList.remove(...Array.from(document.body.classList).filter(o=>o.startsWith("smooth-emotion-"))),document.body.classList.add(a.cssClass),a.secondaryEmotion&&document.body.classList.add(`smooth-emotion-blend-${a.secondaryEmotion}`)),this.config.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Applied emotional temperature:",a)}catch(s){this.config.enableDebug&&console.warn("\u{1F321}\uFE0F [ColorHarmonyEngine] Failed to apply emotional temperature:",s)}this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] blendWithCatppuccin debug:",{extractedColors:e,musicContext:i,emotionalTemperature:a,currentTheme:this.currentTheme,vibrancyConfig:this.vibrancyConfig,userIntensity:this.userIntensity});let r=this.getCurrentActivePalette();if(!r)return console.error(`[StarryNight] Catppuccin palette not found for theme: ${this.currentTheme}`),e;let n={};for(let[s,o]of Object.entries(e)){if(!o)continue;let c=this.utils.hexToRgb(o);if(!c){this.config.enableDebug&&console.warn(`\u{1F3A8} [ColorHarmonyEngine] Failed to parse color for role ${s}: ${o}`),n[s]=o;continue}let m=this.utils.rgbToHsl(c.r,c.g,c.b),d=m.s>=this.vibrancyConfig.minimumSaturation*100;this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Processing color ${s}:`,{originalColor:o,rgb:c,hsl:m,saturationCheck:d,minimumSaturationRequired:this.vibrancyConfig.minimumSaturation*100,actualSaturation:m.s});let h=this.findBestHarmoniousAccent(c,r);if(!h?.rgb){console.warn(`[StarryNight] Could not find a valid harmonious accent for role: ${s}. Using original color.`),n[s]=o;continue}let g=this.vibrancyConfig.getBlendRatio(this.config.artisticMode);if(a){let C=a.intensity;g*=C*this.userIntensity;let T=this.calculateTemperatureBlendInfluence(a.temperature);g*=T,g=Math.max(0,Math.min(1,g)),this.config.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Emotional temperature blend adjustment:",{originalRatio:this.vibrancyConfig.getBlendRatio(this.config.artisticMode),emotionalIntensity:C,temperatureInfluence:T,finalBlendRatio:g,temperature:a.temperature})}else if(i){let C=this.getMusicIntensityMultiplier(i.energy,i.valence);g*=C*this.userIntensity,g=Math.max(0,Math.min(1,g))}this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Blending ${s}:`,{extractedRgb:c,bestAccent:h.hex,blendRatio:g,artisticMode:this.config.artisticMode});let f=this.blendColors(c,h.rgb,g),v=this.utils.rgbToHex(f.r,f.g,f.b);n[s]=v,this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Final color for ${s}: ${o} \u2192 ${v}`)}return this.harmonyMetrics.musicInfluencedAdjustments++,this.performanceMonitor?.emitTrace?.("[ColorHarmonyEngine] Completed blendWithCatppuccin"),this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Final harmonized result:",{inputColors:e,outputColors:n,colorCount:Object.keys(n).length}),this.updateSemanticColorsWithHarmonizedPalette(n),n}updateSemanticColorsWithHarmonizedPalette(e){if(this.semanticColorManager)try{this.semanticColorManager.updateWithAlbumColors(e);let i=e.VIBRANT||e.PRIMARY,a=e.DARK_VIBRANT||e.SECONDARY,r=e.VIBRANT_NON_ALARMING||e.LIGHT_VIBRANT;i&&this.semanticColorManager.getSemanticColor("essentialBrightAccent").then(n=>{let s=this.blendWithSemanticColor(i,n,.7);this.applyCSSVariable("--spice-accent",s),this.applyCSSVariable("--spice-button-active",s)}),a&&this.semanticColorManager.getSemanticColor("backgroundElevatedHighlight").then(n=>{let s=this.blendWithSemanticColor(a,n,.5);this.applyCSSVariable("--spice-highlight",s)}),r&&this.semanticColorManager.getSemanticColor("textBrightAccent").then(n=>{let s=this.blendWithSemanticColor(r,n,.6);this.applyCSSVariable("--spice-text-accent",s)}),this.semanticColorManager.flushUpdates()}catch(i){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Failed to update semantic colors:",i)}}blendWithSemanticColor(e,i,a){let r=this.utils.hexToRgb(e),n=this.utils.hexToRgb(i);if(!r||!n)return e;let s=this.blendColors(r,n,a);return this.utils.rgbToHex(s.r,s.g,s.b)}applyCSSVariable(e,i){p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:{[e]:i},timestamp:Date.now()})}applyCSSVariablesToDOM(e){let i=globalThis.year3000System,a=i?.cssVisualEffectsController||this.performanceMonitor?.cssVisualEffectsController||i?.facadeCoordinator?.getCachedNonVisualSystem?.("UnifiedCSSVariableManager"),r=this.enhanceCSSVariablesForUIComponents(e);if(a&&typeof a.batchSetVariables=="function")try{a.batchSetVariables("ColorHarmonyEngine",r,"high","color-harmony-oklab-processing"),this.config.enableDebug&&console.log("\u{1F527} [ColorHarmonyEngine] Applied CSS variables via cssVisualEffectsController batcher")}catch(n){this.config.enableDebug&&console.warn("\u{1F527} [ColorHarmonyEngine] cssVisualEffectsController.batchSetVariables failed, using direct application:",n),this.applyVariablesDirectly(r)}else this.config.enableDebug&&console.log("\u{1F527} [ColorHarmonyEngine] cssVisualEffectsController not available, using direct DOM application"),this.applyVariablesDirectly(r);p.emitSync("colors:applied",{cssVariables:r,accentHex:r["--sn-accent-hex"]||"#a6adc8",accentRgb:r["--sn-accent-rgb"]||"166,173,200",appliedAt:Date.now()}),this.config.enableDebug&&console.log("\u{1F52C} [ColorHarmonyEngine] Applied enhanced CSS variables to DOM:",{totalVariables:Object.keys(r).length,oklabVariables:Object.keys(r).filter(n=>n.includes("oklab")).length,oklchVariables:Object.keys(r).filter(n=>n.includes("oklch")).length,gradientVariables:Object.keys(r).filter(n=>n.includes("gradient")).length,spiceVariables:Object.keys(r).filter(n=>n.includes("spice")).length,sidebarVariables:Object.keys(r).filter(n=>n.includes("sidebar")).length,cssVisualEffectsControllerUsed:!!a})}enhanceCSSVariablesForUIComponents(e){let i={...e},a=i["--sn-accent-hex"]||i[Ge.CANONICAL_HEX_VAR],r=i["--sn-accent-rgb"]||i[Ge.CANONICAL_RGB_VAR],n=i["--sn-bg-gradient-primary"],s=i["--sn-bg-gradient-primary-rgb"],o=i["--sn-bg-gradient-secondary"],c=i["--sn-bg-gradient-secondary-rgb"];a&&r&&(i["--spice-accent"]=a,i["--spice-button"]=a,i["--spice-button-active"]=a,i["--spice-rgb-accent"]=r,i["--spice-rgb-button"]=r,i["--spice-text-accent"]=a,i["--sn-sidebar-entanglement-color-rgb"]=r,i["--sn-sidebar-accent-color"]=a,i["--sn-sidebar-accent-rgb"]=r,i["--sn-sidebar-dynamic-accent"]=a,i["--sn-nowplaying-accent-color"]=a,i["--sn-nowplaying-accent-rgb"]=r,i["--sn-nowplaying-primary-color"]=a,i["--sn-nowplaying-primary-rgb"]=r,i["--sn-main-feed-accent-color"]=a,i["--sn-main-feed-accent-rgb"]=r,i["--sn-content-accent-color"]=a,i["--sn-content-accent-rgb"]=r),n&&s&&(i["--sn-primary-gradient-color"]=n,i["--sn-primary-gradient-rgb"]=s,i["--sn-main-feed-primary-color"]=n,i["--sn-main-feed-primary-rgb"]=s),o&&c&&(i["--sn-secondary-gradient-color"]=o,i["--sn-secondary-gradient-rgb"]=c,i["--sn-main-feed-secondary-color"]=o,i["--sn-main-feed-secondary-rgb"]=c);let m=i["--sn-color-oklab-bright-highlight-rgb"];m&&(i["--sn-audioAnalysis-bright-accent-rgb"]=m,i["--sn-layered-accent-rgb"]=m,i["--smooth-layered-rgb"]=m,i["--sn-holographic-accent-rgb"]=m,i["--smooth-holographic-rgb"]=m);let d=i["--sn-color-oklab-dynamic-shadow-rgb"];return d&&(i["--sn-audioAnalysis-shadow-rgb"]=d,i["--sn-depth-shadow-rgb"]=d),i}applyVariablesDirectly(e){p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:e,timestamp:Date.now()})}generateRecommendations(e,i,a,r){let n=[],s=this.getCurrentActivePalette(),o=this.utils.hexToRgb(s?.neutrals?.base||"#1e1e2e");if(!o)return[];if(i<r.minContrast){let c=this.utils.findRequiredLuminance(e,o,r.minContrast),m=this.utils.rgbToHsl(e.r,e.g,e.b),d=this.utils.hslToRgb(m.h,m.s,c),h={r:d.r,g:d.g,b:d.b};n.push({type:"contrast",suggestion:`Adjust luminance to meet contrast of ${r.minContrast}`,recommendedColor:this.utils.rgbToHex(h.r,h.g,h.b)})}if(a<r.minHarmony){let c=this.findBestHarmoniousAccent(e,s),m=this.blendColors(e,c.rgb,.5);n.push({type:"harmony",suggestion:`Blend with harmonious accent color to improve score to at least ${r.minHarmony}`,recommendedColor:this.utils.rgbToHex(m.r,m.g,m.b)})}return n}getPerformanceReport(){return{system:this.systemName,metrics:this.harmonyMetrics,kineticState:this.kineticState,musicalMemorySize:this.musicalMemory.recentTracks.length,currentTheme:this.currentTheme}}updateFromMusicAnalysis(e,i,a){if(!e)return;let r=e.genre;r&&r!==this._lastGenre&&this._applyGenrePalette(r).then(()=>{this._lastGenre=r,this._forcePaletteRepaint()}),this._updateMusicalMemory(e,a),this._updateKineticState(e),this._applyAestheticGravity(e),this._calculateMusicAwareDynamics(e)}_calculateMusicAwareDynamics(e){let{energy:i=.5,valence:a=.5,enhancedBPM:r=120,beatOccurred:n=!1}=e,s=this._calculateMusicIntensityMultiplier(i,a),o=this._calculateBeatPhase(r),c=(a-.5)*2,m=this._calculateHueShift(n,i,o);this.kineticState={...this.kineticState,musicIntensityMultiplier:s,beatPhase:o,valenceGravity:c,hueShift:m}}_calculateMusicIntensityMultiplier(e,i){let a=e*.7+i*.3,r=Math.abs(i-.5)*.4;return Math.max(.1,Math.min(2,a+r))}_calculateBeatPhase(e){let i=performance.now(),a=6e4/e;return i%a/a}_calculateHueShift(e,i,a){if(window.matchMedia("(prefers-reduced-motion: reduce)").matches)return 0;let r=this.config.artisticMode,n=r==="advanced-maximum"||r==="cosmic-maximum"?8:5,s=Math.sin(a*2*Math.PI)*n;e&&(s+=i*(r==="advanced-maximum"||r==="cosmic-maximum"?12:10));let o=r==="advanced-maximum"||r==="cosmic-maximum"?25:15;return Math.max(-o,Math.min(o,s))}_updateMusicalMemory(e,i){this.musicalMemory.recentTracks.unshift({trackUri:i,...e,timestamp:Date.now()}),this.musicalMemory.recentTracks.length>this.musicalMemory.maxMemorySize&&this.musicalMemory.recentTracks.pop(),this.musicalMemory.energyHistory.unshift(e.energy),this.musicalMemory.energyHistory.length>20&&this.musicalMemory.energyHistory.pop(),this.harmonyMetrics.temporalMemoryEvents++}_updateKineticState(e){let{energy:i,enhancedBPM:a,beatOccurred:r}=e,n=performance.now();r?(this.kineticState.lastBeatTime=n,this.kineticState.currentPulse=1):this.kineticState.currentPulse*=.95;let s=n-this.kineticState.lastBeatTime,o=6e4/(a||120);this.kineticState.animationPhase=s%o/o*2*Math.PI,this.kineticState.visualMomentum=this.utils.lerp(this.kineticState.visualMomentum,i,.1)}_applyAestheticGravity(e){let{visualIntensity:i,valence:a,energy:r}=e,n=(a-.5)*2,s=(r-.5)*2,o=i;p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:{"--sn-gravity-x":n.toFixed(3),"--sn-gravity-y":s.toFixed(3),"--sn-gravity-strength":o.toFixed(3)},timestamp:Date.now()})}generateHarmonicVariations(e){let i=this.utils.rgbToOklab(e.r,e.g,e.b),a=Math.max(0,Math.min(1,i.L*.75)),r=this.utils.oklabToRgb(a,i.a,i.b),n=Math.max(0,Math.min(1,i.L*1.25)),s=this.utils.oklabToRgb(n,i.a,i.b);return{darkVibrantHex:this.utils.rgbToHex(r.r,r.g,r.b),lightVibrantHex:this.utils.rgbToHex(s.r,s.g,s.b)}}getCurrentGradient(e=5){try{if(!this.getCurrentActivePalette())return null;let a=this.utils.getRootStyle();if(!a)return this.generateFallbackGradient(e);let r=getComputedStyle(a),n=this.getInheritedGradientColors(r);if(!n)return u?.debug?.warn("ColorHarmonyEngine","Failed to inherit processed gradient variables, using fallback"),this.generateFallbackGradient(e);let s=[],o=this.kineticState.musicIntensityMultiplier||1,c=this.kineticState.hueShift||0,m=this.kineticState.valenceGravity||.5,d=this.emotionalState?.currentEmotion?.colorTemperature||.5,{primary:h,secondary:g,accent:f,emotional:v,tertiary:C}=n,T=[h,g,f,v,C];for(let w=0;w<e;w++){let V=w/(e-1),W;if(e===1)W=f;else{let _=V*(T.length-1),j=Math.floor(_),z=Math.min(j+1,T.length-1),I=_-j,re=Math.sin(d*Math.PI)*.3,De=Math.max(0,Math.min(1,I+re)),ye=T[j],ot=T[z];ye&&ot?W={r:ye.r+(ot.r-ye.r)*De,g:ye.g+(ot.g-ye.g)*De,b:ye.b+(ot.b-ye.b)*De}:W=f}let $=this._applyVisualEffectsModulation(W,{musicInfluence:o,valenceGravity:m,hueShift:c,emotionalTemperature:d,position:V});s.push({r:Math.round(Math.max(0,Math.min(255,$.r))),g:Math.round(Math.max(0,Math.min(255,$.g))),b:Math.round(Math.max(0,Math.min(255,$.b)))})}return this.config?.enableDebug&&console.log(`[ColorHarmonyEngine] Generated gradient with ${e} stops:`,s),s}catch(i){let a=i instanceof Error?i.message:"Unknown error",r={method:"getCurrentGradient",stopCount:e,currentTheme:this.currentTheme,kineticState:this.kineticState,timestamp:Date.now(),error:a};u?.debug?.error("ColorHarmonyEngine","Failed to generate gradient colors",r),p.emit("system:error",{systemName:"ColorHarmonyEngine",error:`Gradient generation failed: ${a}`,severity:"error",timestamp:Date.now()});try{let n=this.generateFallbackGradient(e);if(n&&n.length>0)return u?.debug?.warn("ColorHarmonyEngine","Using fallback gradient after error",{fallbackColorCount:n.length}),n}catch(n){u?.debug?.error("ColorHarmonyEngine","Fallback gradient generation also failed",n)}return null}}getInheritedGradientColors(e){try{let i=this.parseRGBVariable(e,"--sn-oklab-processed-primary-rgb")||this.parseRGBVariable(e,"--sn-bg-gradient-primary-rgb")||this.parseRGBVariable(e,"--sn-musical-harmony-primary-rgb"),a=this.parseRGBVariable(e,"--sn-oklab-processed-secondary-rgb")||this.parseRGBVariable(e,"--sn-bg-gradient-secondary-rgb")||this.parseRGBVariable(e,"--sn-musical-harmony-secondary-rgb"),r=this.parseRGBVariable(e,"--sn-oklab-processed-accent-rgb")||this.parseRGBVariable(e,"--sn-bg-gradient-accent-rgb")||this.parseRGBVariable(e,"--sn-color-accent-rgb"),n=this.parseRGBVariable(e,"--sn-oklab-emotional-temperature-rgb")||this.parseRGBVariable(e,"--sn-emotional-temperature-warm-rgb")||r,s=this.parseRGBVariable(e,"--sn-oklab-processed-bright-highlight-rgb")||this.parseRGBVariable(e,"--sn-audioAnalysis-flow-rgb")||this.parseRGBVariable(e,"--sn-musical-harmony-tertiary-rgb");return!i||!r?(u?.debug?.warn("ColorHarmonyEngine","Missing essential inherited colors",{hasPrimary:!!i,hasAccent:!!r}),null):{primary:i,secondary:a||i,accent:r,emotional:n||r,tertiary:s||r}}catch(i){return u?.debug?.error("ColorHarmonyEngine","Failed to inherit gradient colors:",i),null}}parseRGBVariable(e,i){try{let a=e.getPropertyValue(i).trim();if(!a)return null;let r=a.match(/(\d+),\s*(\d+),\s*(\d+)/);return r&&r[1]&&r[2]&&r[3]?{r:parseInt(r[1],10),g:parseInt(r[2],10),b:parseInt(r[3],10)}:null}catch{return null}}interpolateOKLABColors(e,i,a){let n=Math.pow(e.r/255,2.2),s=Math.pow(e.g/255,2.2),o=Math.pow(e.b/255,2.2),c=Math.pow(i.r/255,2.2),m=Math.pow(i.g/255,2.2),d=Math.pow(i.b/255,2.2),h=n+(c-n)*a,g=s+(m-s)*a,f=o+(d-o)*a;return{r:Math.round(Math.pow(h,1/2.2)*255),g:Math.round(Math.pow(g,1/2.2)*255),b:Math.round(Math.pow(f,1/2.2)*255)}}_applyVisualEffectsModulation(e,i){try{let a=this.utils.rgbToHsl(e.r,e.g,e.b),{h:r,s:n,l:s}=a;n=Math.max(0,Math.min(1,n*(.7+i.musicInfluence*.6))),r=(r+i.hueShift+(i.emotionalTemperature-.5)*60)%360;let o=i.valenceGravity*.2*Math.sin(i.position*Math.PI);s=Math.max(.1,Math.min(.9,s+o));let c=this.utils.hslToRgb(r,n,s);return{r:c.r,g:c.g,b:c.b}}catch{return e}}generateFallbackGradient(e){try{let i=["#1e1e2e","#313244","#45475a","#585b70","#cba6f7","#f5c2e7","#fab387"];(e<2||e>i.length)&&(u?.debug?.warn("ColorHarmonyEngine",`Invalid fallback stopCount: ${e}, using default`),e=Math.min(Math.max(e,2),i.length));let a=[];for(let r=0;r<e;r++){let n=Math.floor(r/(e-1)*(i.length-1)),s=i[n],o=s?this.utils.hexToRgb(s):null;o?a.push(o):a.push({r:203,g:166,b:247})}return a.length<2&&a.push({r:30,g:30,b:46},{r:203,g:166,b:247}),u?.debug?.log("ColorHarmonyEngine",`Generated fallback gradient with ${a.length} colors`,a),a}catch(i){return u?.debug?.error("ColorHarmonyEngine","Critical error in fallback gradient generation",i),null}}async analyzeMusicEmotion(e,i){if(!this.initialized||!this.musicEmotionAnalyzer)return this.config.enableDebug&&console.warn("\u{1F3AD} [ColorHarmonyEngine] Cannot analyze music emotion: not initialized"),null;try{let a=await this.musicEmotionAnalyzer.analyzeEmotion(e,i);return this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Analyzed music emotion: ${a.primary} (${a.intensity.toFixed(2)} intensity, ${a.confidence.toFixed(2)} confidence)`),a}catch(a){return console.error("\u{1F3AD} [ColorHarmonyEngine] Error analyzing music emotion:",a),null}}getCurrentEmotion(){return this.emotionalState?.currentEmotion||null}getEmotionHistory(e=10){return this.emotionalState?.emotionHistory?this.emotionalState.emotionHistory.slice(-e):[]}setEmotionInfluenceIntensity(e){this.emotionalState&&(this.emotionalState.emotionInfluenceIntensity=Math.max(0,Math.min(1,e)),this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Emotion influence intensity set to ${this.emotionalState.emotionInfluenceIntensity}`))}_createVariant(e,i,a,r){let n=this.utils.rgbToOklab(e.r,e.g,e.b),s=Math.max(0,Math.min(1,n.L+i*.2)),o=.8+a*.4,c=n.a*o,m=n.b*o,d=r*.1,h=c*Math.cos(d)-m*Math.sin(d),g=c*Math.sin(d)+m*Math.cos(d);return this.utils.oklabToRgb(s,h,g)}_applyMusicInfluence(e,i,a){let r=1+Math.sin(a*Math.PI)*.2,n=Math.max(.7,Math.min(1.3,i*r));return{r:e.r*n,g:e.g*n,b:e.b*n}}setIntensity(e){let i=Math.max(0,Math.min(1,e));this.userIntensity=i,this.config?.enableDebug&&console.log(`[ColorHarmonyEngine] User color harmony intensity set to ${i}`)}updatePalette(e){e?.length&&(this.config?.enableDebug&&console.log("[ColorHarmonyEngine] updatePalette invoked",{count:e.length}),this.forceRepaint("external-palette"))}_handleSettingsChange(e){let{key:i,value:a}=e.detail||{};switch(i){case Xr:{let r=parseFloat(a);Number.isNaN(r)||this.setIntensity(r);break}case Zr:{let r=a==="true"||a===!0;this._setEvolutionEnabled(r);break}}}_handleArtisticModeChanged(){this.currentTheme=this.detectCurrentTheme(),this._pendingPaletteRefresh||(this._pendingPaletteRefresh=setTimeout(()=>{this._pendingPaletteRefresh=null,this.refreshPalette()},80))}_forcePaletteRepaint(){this.kineticState.hueShift=(this.kineticState.hueShift||0)+.01}_startEvolutionLoop(){if(this._evolutionTimer)return;let i=3e4/Math.max(.1,this.userIntensity);this._evolutionTimer=setInterval(()=>{let a=2*this.userIntensity,r=this.kineticState.hueShift??0;this.kineticState.hueShift=(r+a+360)%360-180},i)}_stopEvolutionLoop(){this._evolutionTimer&&(clearInterval(this._evolutionTimer),this._evolutionTimer=null)}_setEvolutionEnabled(e){this.evolutionEnabled!==e&&(this.evolutionEnabled=e,e?this._startEvolutionLoop():this._stopEvolutionLoop())}destroy(){this._stopEvolutionLoop(),document.removeEventListener("year3000SystemSettingsChanged",this._boundSettingsChangeHandler),document.removeEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),this.semanticColorManager&&this.semanticColorManager.destroy(),this.musicEmotionAnalyzer&&this.musicEmotionAnalyzer.destroy(),this.emotionalState&&(this.emotionalState.currentEmotion=null,this.emotionalState.emotionHistory=[]),super.destroy?.()}async refreshPalette(){try{let e=globalThis.year3000System;if(e?.updateColorsFromCurrentTrack){await e.updateColorsFromCurrentTrack();return}let i=this.utils.getRootStyle();if(!i)return;let r=getComputedStyle(i).getPropertyValue("--sn-gradient-primary").trim();if(r){let n=this.utils.hexToRgb(r),s={"--sn-bg-gradient-primary":r};n&&(s["--sn-bg-gradient-primary-rgb"]=`${n.r},${n.g},${n.b}`),p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:s,timestamp:Date.now()})}}catch(e){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] refreshPalette failed",e)}}async _applyGenrePalette(e){try{let i=await this._getGenreAwarePalette(e);if(!i)return;this.catppuccinPalettes[this.currentTheme]=i,await this.refreshPalette(),this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Genre changed to: ${e}`)}catch(i){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] _applyGenrePalette failed",i)}}setEmergentEngine(e){this.animationEngine=e}calculateTemperatureBlendInfluence(e){let i=Math.max(0,Math.min(1,(e-1e3)/19e3));return e<=4e3?1+(4e3-e)/3e3*.3:e>=8e3?1.1+(e-8e3)/12e3*.2:.9+Math.abs(e-6e3)/2e3*.2}forceRepaint(e="settings-change"){this.refreshPalette?.()}determineOptimalOKLABPreset(e){let i=e.musicData,a=E.PRESETS.STANDARD;if(i){let{energy:r=.5,valence:n=.5}=i;r>.8&&n>.7?a=E.PRESETS.COSMIC:r>.7&&n<.4?a=E.PRESETS.VIBRANT:r<.3&&(a=E.PRESETS.SUBTLE)}return e.performanceHints?.preferLightweight&&(a=E.PRESETS.SUBTLE),this.config?.enableDebug&&console.log("\u{1F52C} [ColorHarmonyEngine] OKLAB preset selection:",{energy:i?.energy,valence:i?.valence,selectedPreset:a.name,reason:this.getPresetSelectionReason(i,e)}),a}async getAdvancedEmotionalTemperature(e,i){if(!this.emotionalTemperatureMapper||!e)return null;try{let a={energy:e.energy||.5,valence:e.valence||.5,danceability:e.danceability,tempo:e.tempo,loudness:e.loudness,acousticness:e.acousticness,instrumentalness:e.instrumentalness,speechiness:e.speechiness,mode:e.mode,key:e.key,genre:e.genre},r=await this.enhanceWithAlbumArtPsychology(a,i),n=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(r);return this.config?.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Advanced emotional temperature with album art enhancement:",{input:a,enhanced:r,albumArtInfluence:i?Object.keys(i).length+" colors":"None",emotion:n.primaryEmotion,secondaryEmotion:n.secondaryEmotion,intensity:n.intensity,temperature:n.temperature,oklabPreset:n.oklabPreset.name,perceptualColor:n.perceptualColorHex}),n}catch(a){return console.warn("[ColorHarmonyEngine] Advanced emotional temperature analysis failed:",a),null}}async enhanceWithAlbumArtPsychology(e,i){if(!i||Object.keys(i).length===0)return e;try{let a=this.analyzeAlbumArtPsychology(i),r={...e},n=r.energy||.5,s=r.valence||.5;if(a.warmth>.6&&(r.energy=Math.min(1,n*(1+a.warmth*.3)),r.valence=Math.min(1,s+a.warmth*.2)),a.coolness>.6&&(r.energy=Math.max(0,n*(1-a.coolness*.2)),a.saturation>.5&&(r.valence=Math.min(1,s+a.coolness*.15))),a.saturation>.7&&(r.energy=Math.min(1,n+a.saturation*.2)),a.saturation<.3&&(r.valence=Math.max(0,s-.15),r.energy=Math.max(0,n-.1)),a.darkness>.7){let o=r.energy||n;o>.6?r.energy=Math.min(1,o+.1):r.valence=Math.max(0,(r.valence||s)-.2)}return a.brightness>.8&&(r.valence=Math.min(1,(r.valence||s)+a.brightness*.2)),a.harmony>.8?r.valence=Math.min(1,(r.valence||s)+.1):a.harmony<.3&&(r.energy=Math.min(1,(r.energy||n)+.15)),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Album art psychology enhancement:",{original:{energy:e.energy||.5,valence:e.valence||.5},enhanced:{energy:r.energy||.5,valence:r.valence||.5},colorPsychology:a,adjustments:{energyChange:(r.energy||.5)-(e.energy||.5),valenceChange:(r.valence||.5)-(e.valence||.5)}}),r}catch(a){return console.warn("[ColorHarmonyEngine] Album art psychology enhancement failed:",a),e}}analyzeAlbumArtPsychology(e){try{let i=Object.values(e);if(i.length===0)return{warmth:.5,coolness:.5,saturation:.5,brightness:.5,darkness:.5,harmony:.5,dominantHue:180,emotionalIntensity:.5,genreIndicators:{electronicLikelihood:.5,smoothLikelihood:.5,metalHardcoreLikelihood:.5,popCommercialLikelihood:.5,jazzClassicalLikelihood:.5,folkAcousticLikelihood:.5},artistAwareness:{visualSophistication:.5,artisticIntention:.5,culturalIndicators:[],emotionalDepth:.5}};let a=0,r=0,n=0,s=0,o=0,c=[];for(let $ of i){let _=this.utils.hexToRgb($);if(!_)continue;let j=this.utils.rgbToHsl(_.r,_.g,_.b),{h:z,s:I,l:re}=j;c.push(z),z>=0&&z<=60||z>=300&&z<=360?a+=I*re:z>=120&&z<=240&&(r+=I*re),n+=I,s+=re,o+=1-re}let m=i.length,d=a/m,h=r/m,g=n/m,f=s/m,v=o/m,C=this.calculateColorHarmony(c),T=this.calculateDominantHue(c),w=Math.min(1,(g+this.calculateContrast(i))/2),V=this._analyzeGenreIndicatorsFromColors({warmth:Math.min(1,d),coolness:Math.min(1,h),saturation:g,brightness:f,darkness:v,harmony:C,dominantHue:T,emotionalIntensity:w}),W=this._analyzeArtistAwareness(i,{avgSaturation:g,avgBrightness:f,harmony:C,emotionalIntensity:w,colorCount:i.length});return{warmth:Math.min(1,d),coolness:Math.min(1,h),saturation:g,brightness:f,darkness:v,harmony:C,dominantHue:T,emotionalIntensity:w,genreIndicators:V,artistAwareness:W}}catch(i){return console.warn("[ColorHarmonyEngine] Album art psychology analysis failed:",i),{warmth:.5,coolness:.5,saturation:.5,brightness:.5,darkness:.5,harmony:.5,dominantHue:180,emotionalIntensity:.5,genreIndicators:{electronicLikelihood:.5,smoothLikelihood:.5,metalHardcoreLikelihood:.5,popCommercialLikelihood:.5,jazzClassicalLikelihood:.5,folkAcousticLikelihood:.5},artistAwareness:{visualSophistication:.5,artisticIntention:.5,culturalIndicators:[],emotionalDepth:.5}}}}calculateColorHarmony(e){if(e.length<=1)return 1;let i=0,a=[60,120,30,90];for(let n=0;n<e.length;n++)for(let s=n+1;s<e.length;s++){let o=e[n],c=e[s];if(o===void 0||c===void 0)continue;let m=Math.abs(o-c),d=Math.min(m,360-m);for(let h of a)Math.abs(d-h)<=15&&(i+=1)}let r=e.length*(e.length-1)/2;return Math.min(1,i/r)}calculateDominantHue(e){if(e.length===0)return 180;let i=new Array(12).fill(0);for(let r of e){let n=Math.floor(r/30);i[n]++}return i.indexOf(Math.max(...i))*30+15}calculateContrast(e){if(e.length<=1)return 0;let i=0,a=0;for(let r=0;r<e.length;r++)for(let n=r+1;n<e.length;n++){let s=e[r],o=e[n];if(!s||!o)continue;let c=this.utils.hexToRgb(s),m=this.utils.hexToRgb(o);if(c&&m){let d=(c.r*.299+c.g*.587+c.b*.114)/255,h=(m.r*.299+m.g*.587+m.b*.114)/255;i+=Math.abs(d-h),a++}}return a>0?i/a:0}async blendWithAdvancedOKLAB(e,i,a,r){let n={...e};try{let s=a?.oklabPreset||this.oklabState.currentPreset,o=s;r&&r.confidence>.5&&this.genreState.genreInfluenceIntensity>0&&(o=this.applyGenreColorAesthetics(s,r));let c=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let d of c){let h=e[d];if(h&&this.isValidHex(h))try{let g=r?`-${r.genre}`:"",f=`${h}-${o.name}${g}`;if(this.oklabState.processedPalette[f]){n[d]=this.oklabState.processedPalette[f].enhancedHex;continue}let v=this.applyBrightnessModeMultipliers(h),C=this.oklabProcessor.processColor(v,o);n[d]=C.enhancedHex,this.oklabState.processedPalette[f]=C,this.config?.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] OKLAB enhanced ${d}:`,{original:h,enhanced:C.enhancedHex,preset:s.name,processingTime:C.processingTime})}catch(g){console.warn(`[ColorHarmonyEngine] OKLAB processing failed for ${d}:`,g)}}if(a?.perceptualColorHex&&n.PRIMARY)try{let d=this.oklabProcessor.interpolateOKLAB(n.PRIMARY,a.perceptualColorHex,a.intensity*.3,s);n.EMOTIONAL_BLEND=d.enhancedHex,this.config?.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Emotional color blending:",{primary:n.PRIMARY,emotionalColor:a.perceptualColorHex,blendFactor:a.intensity*.3,result:d.enhancedHex})}catch(d){console.warn("[ColorHarmonyEngine] Emotional color blending failed:",d)}this.oklabState.lastProcessingTime=Date.now();let m=this.getAlbumArtInfluenceSetting();if(m>0&&e&&Object.keys(e).length>0)try{let d=await this._applyDirectAlbumColorBlending(n,e,m,o);Object.assign(n,d),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Applied direct album color blending:",{albumInfluence:(m*100).toFixed(1)+"%",blendedKeys:Object.keys(d),note:"album colors now directly influence final UI colors"})}catch(d){console.warn("[ColorHarmonyEngine] Direct album color blending failed:",d)}if(this.semanticColorManager)try{this.semanticColorManager.updateWithAlbumColors(n),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Applied comprehensive Spicetify variable updates via strategy pattern:",{processedColorCount:Object.keys(n).length,methodUsed:"blendWithAdvancedOKLAB"})}catch(d){console.warn("[ColorHarmonyEngine] Failed to update Spicetify variables via strategy pattern:",d)}}catch(s){console.error("[ColorHarmonyEngine] Advanced OKLAB blending failed:",s)}return n}applyProgressiveResistance(e,i,a,r=0){let n=(e-r)/(a-r);if(i>=1){let s=Math.pow(n,2),o=1+(i-1)*(1-s),c=e*o;return Math.max(r,Math.min(c,a))}else{let s=Math.pow(1-n,2),o=1-(1-i)*(1-s),c=e*o;return Math.max(r,Math.min(c,a))}}applyBrightnessModeMultipliers(e){try{let i=getComputedStyle(document.documentElement),a=parseFloat(i.getPropertyValue("--sn-bg-gradient-saturation"))||1,r=parseFloat(i.getPropertyValue("--sn-bg-gradient-brightness"))||1,n=parseFloat(i.getPropertyValue("--sn-bg-gradient-contrast"))||1;if(a===1&&r===1&&n===1)return e;let s=this.utils.hexToRgb(e);if(!s)return e;let o=this.utils.rgbToHsl(s.r,s.g,s.b);if(!o)return e;let c={h:o.h,s:this.applyProgressiveResistance(o.s,a,85,0),l:this.applyProgressiveResistance(o.l,r,75,15)},m=this.utils.hslToRgb(c.h,c.s,c.l),d=m?this.utils.rgbToHex(m.r,m.g,m.b):e;return this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Applied brightness mode multipliers:",{original:e,adjusted:d,multipliers:{saturation:a,brightness:r,contrast:n},hslChange:{from:o,to:c}}),d}catch(i){return console.warn("[ColorHarmonyEngine] Failed to apply brightness mode multipliers:",i),e}}generateAdvancedOKLABCSSVariables(e){let i={};try{if(Object.entries(e.processedColors).forEach(([a,r])=>{r&&typeof r=="string"&&(i[`--sn-processed-${a.toLowerCase()}`]=r)}),Object.entries(this.oklabState.processedPalette).forEach(([a,r])=>{let[n,s]=a.split("-");if(n&&s){let o=`sn-oklab-${s.toLowerCase()}`,c=this.oklabProcessor.generateCSSVariables(r,o);Object.assign(i,c)}}),this.oklabState.perceptualGradientCache.size>0){let a=Array.from(this.oklabState.perceptualGradientCache.entries()),[r,n]=a[0]||[];if(n&&n.length>0){n.forEach((o,c)=>{let m=c/(n.length-1)*100;i[`--sn-oklab-gradient-stop-${c}`]=o.enhancedHex,i[`--sn-oklab-gradient-stop-${c}-rgb`]=`${o.enhancedRgb.r},${o.enhancedRgb.g},${o.enhancedRgb.b}`,i[`--sn-oklab-gradient-stop-${c}-pos`]=`${m}%`});let s=n.map((o,c)=>{let m=c/(n.length-1)*100;return`${o.enhancedHex} ${m}%`}).join(", ");i["--sn-oklab-perceptual-gradient"]=`linear-gradient(135deg, ${s})`,i["--sn-oklab-gradient-stop-count"]=n.length.toString()}}if(e.processedColors.EMOTIONAL_BLEND){i["--sn-audioAnalysis-emotional-color"]=e.processedColors.EMOTIONAL_BLEND;let a=se(e.processedColors.EMOTIONAL_BLEND);a&&(i["--sn-audioAnalysis-emotional-rgb"]=`${a.r},${a.g},${a.b}`)}i["--sn-oklab-preset-active"]=this.oklabState.currentPreset.name,i["--sn-oklab-cache-size"]=Object.keys(this.oklabState.processedPalette).length.toString(),i["--sn-oklab-last-processing"]=this.oklabState.lastProcessingTime.toString(),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Generated advanced OKLAB CSS variables:",{totalVariables:Object.keys(i).length,gradientStops:this.oklabState.perceptualGradientCache.size,oklabProcessedColors:Object.keys(this.oklabState.processedPalette).length})}catch(a){console.error("[ColorHarmonyEngine] Advanced OKLAB CSS variable generation failed:",a)}return i}generatePerceptualGradientData(e){try{let i=e.processedColors.PRIMARY,a=e.processedColors.SECONDARY||e.processedColors.EMOTIONAL_BLEND;if(!i||!this.isValidHex(i))return;let r=i,n=a&&this.isValidHex(a)?a:this.generateComplementaryColor(i),s=`${r}-${n}-${this.oklabState.currentPreset.name}`;if(this.oklabState.perceptualGradientCache.has(s))return;let o=7,c=this.oklabProcessor.generateOKLABGradient(r,n,o,this.oklabState.currentPreset);if(this.oklabState.perceptualGradientCache.set(s,c),this.oklabState.perceptualGradientCache.size>10){let m=this.oklabState.perceptualGradientCache.keys().next().value;m&&this.oklabState.perceptualGradientCache.delete(m)}this.config?.enableDebug&&console.log("\u{1F308} [ColorHarmonyEngine] Generated perceptual gradient data:",{startColor:r,endColor:n,stopCount:o,preset:this.oklabState.currentPreset.name,cacheKey:s,cacheSize:this.oklabState.perceptualGradientCache.size})}catch(i){console.error("[ColorHarmonyEngine] Perceptual gradient generation failed:",i)}}updateAdvancedHarmonyMetrics(e,i){try{let a=e.processedColors.PRIMARY,r=e.processedColors.SECONDARY,n=.5;if(a&&this.isValidHex(a)){let o=se(a);if(o){let c=this.calculateColorVibrancy(o);n=Math.min(1,c*.8+.2)}}let s={processingTime:i,harmonyScore:n,oklabProcessedColors:Object.keys(this.oklabState.processedPalette).length,perceptualGradientsCached:this.oklabState.perceptualGradientCache.size,currentPreset:this.oklabState.currentPreset.name,lastUpdate:Date.now()};e.metadata&&(e.metadata.advancedHarmonyMetrics=s),this.config?.enableDebug&&console.log("\u{1F4CA} [ColorHarmonyEngine] Advanced harmony metrics updated:",s)}catch(a){console.error("[ColorHarmonyEngine] Advanced harmony metrics update failed:",a)}}getPresetSelectionReason(e,i){if(!e)return"No music data available";let{energy:a=.5,valence:r=.5}=e;return i.performanceHints?.preferLightweight?"Performance optimization requested":a>.8&&r>.7?"High energy + positive valence":a>.7&&r<.4?"High energy + negative valence":a<.3?"Low energy music":"Standard balanced processing"}generateComplementaryColor(e){try{let i=se(e);if(!i)return e;let a=this.rgbToHsl(i.r,i.g,i.b),r=(a.h+180)%360,n=this.hslToRgb(r,a.s,a.l);return it(n.r,n.g,n.b)}catch(i){return console.warn("[ColorHarmonyEngine] Complementary color generation failed:",i),e}}calculateColorVibrancy(e){let i=Math.max(e.r,e.g,e.b),a=Math.min(e.r,e.g,e.b),r=i-a;if(i===0)return 0;let n=r/i,s=i/255,o=1-Math.abs(s-.5)*2;return n*o}isValidHex(e){return/^#[0-9A-Fa-f]{6}$/.test(e)}rgbToHsl(e,i,a){e/=255,i/=255,a/=255;let r=Math.max(e,i,a),n=Math.min(e,i,a),s=r-n,o=0,c=0,m=(r+n)/2;if(s!==0){switch(c=m>.5?s/(2-r-n):s/(r+n),r){case e:o=(i-a)/s+(i<a?6:0);break;case i:o=(a-e)/s+2;break;case a:o=(e-i)/s+4;break}o/=6}return{h:o*360,s:c,l:m}}hslToRgb(e,i,a){e/=360;let r=(c,m,d)=>(d<0&&(d+=1),d>1&&(d-=1),d<1/6?c+(m-c)*6*d:d<1/2?m:d<2/3?c+(m-c)*(2/3-d)*6:c),n,s,o;if(i===0)n=s=o=a;else{let c=a<.5?a*(1+i):a+i-a*i,m=2*a-c;n=r(m,c,e+1/3),s=r(m,c,e),o=r(m,c,e-1/3)}return{r:Math.round(n*255),g:Math.round(s*255),b:Math.round(o*255)}}async analyzeGenreAesthetics(e,i){try{if(!this.genreGradientEvolution)return null;let a=this.genreGradientEvolution.getCurrentGenre(),r=this.genreGradientEvolution.getGenreConfidence();if(r<.3)return null;let n=this.genreGradientEvolution.getGenreCharacteristics(a),s=this.genreGradientEvolution.getGenreVisualStyle(a),o=1,c=r;if(i&&Object.keys(i).length>0)try{o=this._analyzeAlbumGenreHarmony(i,a,n).harmonyScore,c=r*o,this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Album-Genre harmony analysis:",{genre:a,originalConfidence:(r*100).toFixed(1)+"%",harmonyScore:(o*100).toFixed(1)+"%",validatedConfidence:(c*100).toFixed(1)+"%",albumColorCount:Object.keys(i).length})}catch(m){console.warn("[ColorHarmonyEngine] Album-genre harmony analysis failed:",m)}return this.genreState.currentGenre=a,this.genreState.genreConfidence=c,this.genreState.lastGenreUpdate=Date.now(),this.genreState.genreHistory.unshift({genre:a,confidence:c,timestamp:Date.now()}),this.genreState.genreHistory.length>10&&(this.genreState.genreHistory=this.genreState.genreHistory.slice(0,10)),this.config.enableDebug&&console.log(`\u{1F3B6} [ColorHarmonyEngine] Genre aesthetic analysis: ${a} (${(c*100).toFixed(1)}% album-validated confidence)`),{genre:a,confidence:c,characteristics:n,visualStyle:s}}catch(a){return console.warn("[ColorHarmonyEngine] Error analyzing genre aesthetics:",a),null}}applyGenreColorAesthetics(e,i){let{characteristics:a,visualStyle:r,confidence:n}=i,s={...e,name:`${e.name}-${i.genre}`,description:`${e.description} with ${i.genre} aesthetic characteristics`},o=n*this.genreState.genreInfluenceIntensity;return a.saturation>.7?s.chromaBoost=Math.min(2,e.chromaBoost+.3*o):a.saturation<.3&&(s.chromaBoost=Math.max(.8,e.chromaBoost-.2*o)),a.musicalComplexity>.7?s.vibrantThreshold=Math.max(.05,e.vibrantThreshold-.05*o):a.musicalComplexity<.3&&(s.vibrantThreshold=Math.min(.2,e.vibrantThreshold+.03*o)),a.emotionalRange>.7&&a.smoothness>.6?s.lightnessBoost=Math.max(.9,e.lightnessBoost-.1*o):a.artificialProcessing>.7&&(s.lightnessBoost=Math.min(1.4,e.lightnessBoost+.2*o)),r.contrastLevel>.7?s.shadowReduction=Math.max(.1,e.shadowReduction-.1*o):a.smoothness>.6&&(s.shadowReduction=Math.min(.5,e.shadowReduction+.1*o)),this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Applied ${i.genre} aesthetics to ${e.name} preset:`,{chromaBoost:`${e.chromaBoost} \u2192 ${s.chromaBoost}`,lightnessBoost:`${e.lightnessBoost} \u2192 ${s.lightnessBoost}`,vibrantThreshold:`${e.vibrantThreshold} \u2192 ${s.vibrantThreshold}`,genreInfluence:`${(o*100).toFixed(1)}%`}),s}_analyzeAlbumGenreHarmony(e,i,a){try{let r=1,n=[],s=Object.entries(e).map(([z,I])=>{let re=this.utils.hexToRgb(I);return re?this.utils.rgbToHsl(re.r,re.g,re.b):null}).filter(z=>z!==null);if(s.length===0)return{harmonyScore:1,explanation:"No valid album colors found"};let o=s.reduce((z,I)=>z+I.s,0)/s.length,c=a.saturation||.5,m=Math.abs(o/100-c);m<.2?(r*=1.1,n.push(`album saturation matches genre (\xB1${(m*100).toFixed(1)}%)`)):m>.4&&(r*=.85,n.push(`album saturation differs from genre expectations (${(m*100).toFixed(1)}% diff)`));let d=s.reduce((z,I)=>z+I.h,0)/s.length,h=d>=15&&d<=45||d>=315&&d<=345,g=d>=180&&d<=270,f=a.energyLevel||.5;f>.6&&h?(r*=1.15,n.push("warm album colors match high-energy genre")):f<.4&&g?(r*=1.1,n.push("cool album colors match low-energy genre")):(f>.6&&g||f<.4&&h)&&(r*=.9,n.push("album color temperature differs from genre energy"));let v=s.reduce((z,I)=>z+I.l,0)/s.length,C=v<40,T=v>70;i.includes("metal")||i.includes("goth")||i.includes("dark")?C?(r*=1.2,n.push("dark album aesthetic matches genre")):T&&(r*=.8,n.push("bright album conflicts with dark genre aesthetic")):(i.includes("pop")||i.includes("dance")||i.includes("electronic"))&&T&&(r*=1.15,n.push("bright album aesthetic matches energetic genre"));let w=s.map(z=>z.h),V=Math.max(...w)-Math.min(...w),W=V<30,$=V>120,_=a.musicalComplexity||a.harmonicComplexity||.5;_>.7&&$?(r*=1.1,n.push("diverse album colors match complex genre")):_<.3&&W&&(r*=1.1,n.push("unified album colors match simple genre")),r=Math.max(.7,Math.min(1.3,r));let j=n.length>0?n.join("; "):"album colors analyzed for genre harmony";return{harmonyScore:r,explanation:j}}catch(r){return console.warn("[ColorHarmonyEngine] Album-genre harmony analysis error:",r),{harmonyScore:1,explanation:"harmony analysis failed, using default confidence"}}}getAlbumArtInfluenceSetting(){return .5}async _applyDirectAlbumColorBlending(e,i,a,r){let n={};try{let s=this._extractDominantAlbumColors(i);if(s.length===0)return{};let o=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING"];for(let c of o){let m=e[c];if(!(!m||!this.isValidHex(m)))try{let d=this._selectHarmoniousAlbumColor(m,s);if(d){let h=this.oklabProcessor.interpolateOKLAB(m,d,a*.6,r);n[c]=h.enhancedHex,this.config?.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Album-blended ${c}:`,{original:m,albumColor:d,blended:h.enhancedHex,blendFactor:(a*.6).toFixed(2)})}}catch(d){console.warn(`[ColorHarmonyEngine] Album blending failed for ${c}:`,d)}}if(s.length>0&&a>.3)try{let c=this._selectMostVibrantColor(s);if(c){let m=this.oklabProcessor.processColor(c,r);n.ALBUM_ACCENT=m.enhancedHex,this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Created ALBUM_ACCENT:",{source:c,enhanced:m.enhancedHex})}}catch(c){console.warn("[ColorHarmonyEngine] Album accent creation failed:",c)}return n}catch(s){return console.error("[ColorHarmonyEngine] Direct album color blending error:",s),{}}}_extractDominantAlbumColors(e){let i=[],a=["VIBRANT","DOMINANT","PRIMARY","PROMINENT","LIGHT_VIBRANT","DARK_VIBRANT"];for(let r of a){let n=e[r];n&&this.isValidHex(n)&&i.push(n)}return i.length<3&&Object.values(e).forEach(r=>{r&&this.isValidHex(r)&&!i.includes(r)&&i.push(r)}),i.slice(0,5)}_selectHarmoniousAlbumColor(e,i){if(i.length===0)return null;try{let a=this.utils.hexToRgb(e);if(!a)return i[0]||null;let r=this.utils.rgbToHsl(a.r,a.g,a.b),n=i[0]||null,s=0;for(let o of i){let c=this.utils.hexToRgb(o);if(!c)continue;let m=this.utils.rgbToHsl(c.r,c.g,c.b),d=Math.abs(r.h-m.h),h=Math.min(d,360-d),g=0;h<30?g=.9:h>150&&h<210?g=.8:h>90&&h<150?g=.6:g=.4,Math.abs(r.s-m.s)<20&&(g+=.1),g>s&&(s=g,n=o)}return n}catch(a){return console.warn("[ColorHarmonyEngine] Harmonious color selection failed:",a),i[0]||null}}_selectMostVibrantColor(e){if(e.length===0)return null;try{let i=e[0]||null,a=0;for(let r of e){let n=this.utils.hexToRgb(r);if(!n)continue;let s=this.utils.rgbToHsl(n.r,n.g,n.b),o=s.s/100*(1-Math.abs(s.l-50)/50);o>a&&(a=o,i=r)}return i}catch(i){return console.warn("[ColorHarmonyEngine] Most vibrant color selection failed:",i),e[0]||null}}_analyzeGenreIndicatorsFromColors(e){let{warmth:i,coolness:a,saturation:r,brightness:n,darkness:s,harmony:o,dominantHue:c,emotionalIntensity:m}=e,d=Math.min(1,r*.4+a*.3+(n>.7||s<.3?.2:0)+(c>=180&&c<=270?.1:0)),h=Math.min(1,(i>a?i:0)*.3+(r>=.3&&r<=.7?.3:0)+(n>=.4&&n<=.7?.2:0)+o*.2),g=Math.min(1,s*.4+m*.3+(c>=0&&c<=30||c>=330?.2:0)+(r>.6||r<.2?.1:0)),f=Math.min(1,(n>.6?n*.3:0)+r*.3+(i>.5?i*.2:0)+(m>.5?.2:0)),v=Math.min(1,o*.4+(r>=.4&&r<=.8?.3:0)+(n>=.3&&n<=.8?.2:0)+(i+a)/2*.1),C=Math.min(1,i*.4+(r>=.2&&r<=.6?.3:0)+o*.2+(c>=15&&c<=60?.1:0));return{electronicLikelihood:d,smoothLikelihood:h,metalHardcoreLikelihood:g,popCommercialLikelihood:f,jazzClassicalLikelihood:v,folkAcousticLikelihood:C}}_analyzeArtistAwareness(e,i){let{avgSaturation:a,avgBrightness:r,harmony:n,emotionalIntensity:s,colorCount:o}=i,c=Math.min(1,n*.4+(o>2&&o<=5?.3:.1)+(a>=.3&&a<=.8?.2:0)+(r>=.2&&r<=.8?.1:0)),m=Math.min(1,n*.5+s*.3+(o>=2&&o<=4?.2:0)),d=[];a>.8&&s>.7&&d.push("high-energy-culture"),n>.7&&a<.6&&d.push("minimalist-aesthetic"),r<.3&&s>.6&&d.push("dark-artistic"),r>.7&&a>.6&&d.push("commercial-pop");let h=Math.min(1,s*.5+(a>.4?.2:0)+(n>.5?.2:0)+(o>=3?.1:0));return{visualSophistication:c,artisticIntention:m,culturalIndicators:d,emotionalDepth:h}}};Ge.CANONICAL_HEX_VAR="--sn-accent-hex",Ge.CANONICAL_RGB_VAR="--sn-accent-rgb";at=Ge});var ht,Nn=y(()=>{"use strict";ht=class{static async getAudioData(){try{return typeof Spicetify<"u"&&Spicetify.getAudioData?await Spicetify.getAudioData():(console.warn("[SpicetifyCompat] Spicetify.getAudioData not available"),null)}catch(t){return console.error("[SpicetifyCompat] Error fetching audio data:",t),null}}static isAvailable(){return typeof Spicetify<"u"&&!!Spicetify.getAudioData}static async getAudioDataWithRetry(t=200,e=10){for(let i=0;i<e;i++)try{let a=await this.getAudioData();if(a)return a}catch(a){i<e-1?(console.log(`[SpicetifyCompat] Retrying audio data fetch (${i+1}/${e})...`),await new Promise(r=>setTimeout(r,t))):console.warn(`[SpicetifyCompat] Audio data fetch failed after ${e} attempts:`,a)}return null}}});var rt,_e,pi=y(()=>{"use strict";G();ie();rt={electronic:{energyBoost:1.1,beatEmphasis:1.2,precision:.9,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"dynamic"}},dance:{energyBoost:1.2,beatEmphasis:1.25,precision:.95,oklabPreset:"COSMIC",colorCharacteristics:{vibrancyLevel:"cosmic",emotionalRange:"extreme",colorTemperature:"dynamic"}},house:{energyBoost:1.2,beatEmphasis:1.25,precision:.95,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"warm"}},techno:{energyBoost:1.15,beatEmphasis:1.3,precision:1,oklabPreset:"COSMIC",colorCharacteristics:{vibrancyLevel:"cosmic",emotionalRange:"extreme",colorTemperature:"cool"}},trance:{energyBoost:1.15,beatEmphasis:1.1,precision:.85,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"dynamic"}},rock:{energyBoost:1.05,intensityMultiplier:1.1,dynamicRange:1.1,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"warm"}},metal:{energyBoost:1.15,intensityMultiplier:1.2,dynamicRange:1.2,oklabPreset:"COSMIC",colorCharacteristics:{vibrancyLevel:"cosmic",emotionalRange:"extreme",colorTemperature:"cool"}},punk:{energyBoost:1.2,intensityMultiplier:1.1,precision:.8,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"dynamic"}},hiphop:{beatEmphasis:1.3,grooveFactor:1.2,tempoMultiplier:.95,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"warm"}},rap:{beatEmphasis:1.3,grooveFactor:1.2,tempoMultiplier:.95,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"}},jazz:{adaptiveVariation:!0,complexity:1.2,smoothingFactor:1.3,oklabPreset:"SUBTLE",colorCharacteristics:{vibrancyLevel:"subtle",emotionalRange:"wide",colorTemperature:"warm"}},classical:{gentleMode:!0,dynamicRange:1.4,tempoVariationHandling:"adaptive",oklabPreset:"SUBTLE",colorCharacteristics:{vibrancyLevel:"subtle",emotionalRange:"extreme",colorTemperature:"neutral"}},ambient:{subtleMode:!0,intensityReduction:.7,smoothingFactor:1.5,oklabPreset:"SUBTLE",colorCharacteristics:{vibrancyLevel:"subtle",emotionalRange:"narrow",colorTemperature:"cool"}},pop:{energyBoost:1.05,beatEmphasis:1.1,precision:.85,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"warm"}},rnb:{grooveFactor:1.25,smoothingFactor:1.1,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"warm"}},soul:{grooveFactor:1.3,smoothingFactor:1.15,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"wide",colorTemperature:"warm"}},default:{balanced:!0,energyBoost:1,beatEmphasis:1,precision:1,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"}}},_e=class{constructor(t={}){this.config=t.ADVANCED_SYSTEM_CONFIG||t.YEAR3000_CONFIG||M,this.config.enableDebug&&console.log("\u{1F9EC} [GenreProfileManager] Initialized")}_getGenreFromAudioFeatures(t){if(!t)return"default";let{danceability:e=.5,energy:i=.5,acousticness:a=.5,instrumentalness:r=.5,tempo:n=120}=t;return r>.6&&a<.2&&i>.6?n>120?"techno":"electronic":e>.7&&i>.7?"dance":a>.7&&i<.4?"classical":a>.5&&r<.1?"jazz":i>.7&&r<.1&&e>.5?"rock":e>.7&&r<.2&&i>.5&&n<110?"hiphop":"default"}getProfileForTrack(t){let e=this._getGenreFromAudioFeatures(t),i=rt[e];if(this.config.enableDebug&&console.log(`[GenreProfileManager] Detected genre: '${e}'. Applying profile.`),i)return i;let a=rt.default;if(a)return a;throw new Error("[GenreProfileManager] Critical: Default genre profile is missing.")}detectGenre(t){return this._getGenreFromAudioFeatures(t)}getOKLABPresetForGenre(t){let e=rt[t]||rt.default,i=e.oklabPreset||"STANDARD";try{let a=E.getPreset(i);return this.config.enableDebug&&console.log(`\u{1F9EC} [GenreProfileManager] OKLAB preset for genre '${t}':`,{genre:t,preset:i,colorCharacteristics:e.colorCharacteristics}),a}catch(a){return this.config.enableDebug&&console.warn(`\u{1F9EC} [GenreProfileManager] Failed to get OKLAB preset '${i}' for genre '${t}', using STANDARD:`,a),E.getPreset("STANDARD")}}getOKLABPresetForTrack(t){let e=this.detectGenre(t);return this.getOKLABPresetForGenre(e)}getColorCharacteristicsForGenre(t){let i=(rt[t]||rt.default).colorCharacteristics||{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"};return this.config.enableDebug&&console.log(`\u{1F9EC} [GenreProfileManager] Color characteristics for genre '${t}':`,i),i}getColorCharacteristicsForTrack(t){let e=this.detectGenre(t);return this.getColorCharacteristicsForGenre(e)}createContextualOKLABPreset(t,e=1,i="contextual"){let a=this.detectGenre(t),r=this.getOKLABPresetForGenre(a),n=this.getColorCharacteristicsForGenre(a),s=t.energy||.5,o=t.danceability||.5,c=(s+o)/2*e,m=r.chromaBoost*(.8+c*.4),d=r.lightnessBoost*(.9+c*.2),h=E.createCustomPreset(`${a}-${i}`,`Contextual ${r.description} for ${a}`,d,m,r.shadowReduction,r.vibrantThreshold);return this.config.enableDebug&&console.log("\u{1F9EC} [GenreProfileManager] Created contextual OKLAB preset:",{genre:a,basePreset:r.name,contextualPreset:h.name,adjustments:{chromaBoost:`${r.chromaBoost} \u2192 ${m}`,lightnessBoost:`${r.lightnessBoost} \u2192 ${d}`,intensityMultiplier:e,combinedIntensity:c}}),h}getAllGenreOKLABMappings(){let t={};return Object.entries(rt).forEach(([e,i])=>{t[e]={preset:i.oklabPreset||"STANDARD",characteristics:i.colorCharacteristics}}),this.config.enableDebug&&console.log("\u{1F9EC} [GenreProfileManager] All genre-OKLAB mappings:",t),t}}});function He(){return typeof window<"u"&&window.Spicetify?window.Spicetify:null}function Ml(){return!!He()?.CosmosAsync}var Y,we,fi=y(()=>{"use strict";G();k();Z();Nn();Se();pi();ie();Me();Y={enableDebug:!0,enableBeatSynchronization:!0,enableGenreAnalysis:!0,enableMoodAdaptation:!0,bpmCalculation:{useEnhancedAlgorithm:!0,danceabilityWeight:.9,energyWeight:.6,bpmWeight:.6,energyThreshold:.5,danceabilityThreshold:.5,bpmThreshold:.8,maxBPM:180,minBPM:60},performance:{cacheSize:100,cacheTTL:3e5,maxRetries:10,retryDelay:200,enableMetrics:!0,processingTimeTarget:50},synchronization:{beatAccuracyTarget:50,maxSyncDelay:1e3,adaptiveQuality:!0,predictiveCaching:!0,debounceRapidChanges:200},genreProfiles:{electronic:{intensityMultiplier:1.2,precisionBoost:1.1},jazz:{smoothingFactor:1.3,adaptiveVariation:!0},classical:{gentleMode:!0,tempoVariationHandling:"adaptive"},rock:{energyBoost:1.15,consistentTiming:!0},ambient:{subtleMode:!0,intensityReduction:.7},hiphop:{beatEmphasis:1.25,rhythmPrecision:"high"},default:{balanced:!0}},musicVisualSync:{enhancedBPM:{fallbacks:{tempo:120,loudness:-5,key:0,timeSignature:4},danceabilityEstimation:{highDance:{min:125,max:145,value:.8},mediumDance:{min:100,max:124,value:.7},lowMediumDance:{min:80,max:99,value:.6},lowDance:{value:.5}},energyEstimation:{tempoRange:{min:80,max:160},loudnessRange:{min:-15,max:0},tempoWeight:.6,loudnessWeight:.4}}}},we=class{constructor(t={}){this.isInitialized=!1;this.currentTrack=null;this.audioData=null;this.currentTrackUri=null;this.latestProcessedData=null;this.beatSchedulerTimer=null;this.songChangeDebounceTimer=null;this.nextBeatIndex=0;this.currentSongBeats=[];this.songStartTimestamp=0;this.metrics={bpmCalculations:0,beatSyncs:0,cacheHits:0,cacheMisses:0,avgProcessingTime:0,performance:[],errors:0,updates:0};this.unifiedCache=new Map;this.subscribers=new Map;this.beatSync={lastBeatTime:0,nextBeatTime:0,beatInterval:0,confidence:0,isActive:!1};this.performanceInterval=null;this.cacheCleanupInterval=null;this.CACHE_KEY_VERSION_PREFIX="v3";this.eventProcessingState={isProcessingEvent:!1,eventChain:[],lastEventTime:0,consecutiveEvents:0};this.MAX_CONSECUTIVE_EVENTS=5;this.EVENT_RESET_TIMEOUT=3e3;this.currentBeatVector={x:0,y:0};this.config=t.ADVANCED_SYSTEM_CONFIG||t.YEAR3000_CONFIG||M,this.utils=t.ThemeUtilities||D,this.settingsManager=t.settingsManager||null,this.year3000System=t.year3000System||null,this.genreProfileManager=t.genreProfileManager||new _e({ADVANCED_SYSTEM_CONFIG:this.config}),this.oklabProcessor=new E(this.config.enableDebug),this.emotionalTemperatureMapper=new J(this.config.enableDebug),this.cacheTTL=Y.performance.cacheTTL,this.userPreferences=this.loadUserPreferences(),this.config.enableDebug&&(console.log("\u{1F3B5} MusicSyncService constructor called"),console.log("\u{1F3B5} [MusicSyncService] Initialized with GenreProfileManager support"))}get initialized(){return this.isInitialized}async initialize(){try{this.config.enableDebug&&console.log("\u{1F3B5} Initializing unified MusicSyncService..."),ht.isAvailable()||console.warn("[MusicSyncService] Spicetify audio data API not available at initialization. Some features may be limited."),this.setupCacheManagement(),Y.performance.enableMetrics&&this.setupPerformanceMonitoring(),this.isInitialized=!0,this.config.enableDebug&&console.log("\u{1F31F} MusicSyncService initialized successfully!")}catch(t){console.error("\u274C MusicSyncService initialization failed:",t),this.metrics.errors++}}subscribe(t,e){if(!t||typeof t.updateFromMusicAnalysis!="function"){console.warn(`[MusicSyncService] Invalid system or missing updateFromMusicAnalysis method: ${e}`);return}if(this.subscribers.has(e)){this.config.enableDebug&&console.warn(`[MusicSyncService] System ${e} already subscribed.`);return}if(this.subscribers.set(e,t),this.config.enableDebug&&console.log(`[MusicSyncService] System subscribed: ${e}`),this.latestProcessedData&&t.initialized)try{t.updateFromMusicAnalysis(this.latestProcessedData,null,this.currentTrackUri)}catch(i){console.error(`[MusicSyncService] Error notifying new subscriber ${e}:`,i)}}unsubscribe(t){this.subscribers.has(t)&&(this.subscribers.delete(t),this.config.enableDebug&&console.log(`[MusicSyncService] System unsubscribed: ${t}`))}notifySubscribers(t,e,i){if(!this.isInitialized){console.warn("[MusicSyncService] Not initialized, cannot notify subscribers.");return}this.latestProcessedData=t;for(let[a,r]of this.subscribers)try{r.initialized&&typeof r.updateFromMusicAnalysis=="function"&&r.updateFromMusicAnalysis(t,e,i)}catch(n){console.error(`[MusicSyncService] Error notifying subscriber ${a}:`,n),this.metrics.errors++}}async fetchAudioData(t={}){let{retryDelay:e=Y.performance.retryDelay,maxRetries:i=Y.performance.maxRetries}=t,r=He()?.Player?.data?.item?.uri;if(!r)return this.config.enableDebug&&console.warn("[MusicSyncService] No current track URI to fetch audio data."),null;let n=this.generateCacheKey(r,"audioData"),s=this.getFromCache(n);if(s?.audioData){if(this.isValidAudioData(s.audioData))return this.metrics.cacheHits++,this.config.enableDebug&&console.log(`[MusicSyncService] Cache hit for audioData: ${n}`),s.audioData;this.unifiedCache.delete(n)}this.metrics.cacheMisses++;for(let o=0;o<i;o++){try{let c=await ht.getAudioData();if(!c)continue;let m=this.convertSpicetifyToAudioData(c);if(this.isValidAudioData(m))return this.setInCache(n,{audioData:m}),m;this.config.enableDebug&&console.log(`[MusicSyncService] Audio analysis unavailable (attempt ${o+1}/${i}). Retrying\u2026`)}catch(c){if(o===i-1){this.config.enableDebug&&console.warn("[MusicSyncService] Audio data fetch error on final attempt:",c),this.metrics.errors++;let m={tempo:120,energy:.5,valence:.5,loudness:-10,key:0,time_signature:4,danceability:.5,acousticness:.5,instrumentalness:0,speechiness:.05,liveness:.2,mode:1};return this.config.enableDebug&&console.warn("[MusicSyncService] All audio-data attempts failed \u2013 using fallback defaults"),m}}await new Promise(c=>setTimeout(c,e))}return null}async getAudioFeatures(){try{let e=He()?.Player?.data?.item;if(!e?.uri)return null;let i=e.uri.split(":")[2]||"fallback",a=this.generateCacheKey(i,"features"),r=this.getFromCache(a);if(r?.audioFeatures)return this.metrics.cacheHits++,this.config.enableDebug&&console.log(`[MusicSyncService] Cache hit for audioFeatures: ${a}`),r.audioFeatures;this.metrics.cacheMisses++;let n=He();if(!Ml()||!n?.CosmosAsync)throw new Error("CosmosAsync not available");let s=await n.CosmosAsync.get(`https://api.spotify.com/v1/audio-features/${i}`),o={danceability:s.danceability,energy:s.energy,valence:s.valence,acousticness:s.acousticness,instrumentalness:s.instrumentalness,tempo:s.tempo};return this.setInCache(a,{audioFeatures:o}),o}catch(t){return this.config.enableDebug&&console.warn("[MusicSyncService] Could not fetch audio features:",t),null}}generateCacheKey(t,e="default"){return`${this.CACHE_KEY_VERSION_PREFIX}-${t}-${e}`}getFromCache(t){let e=this.unifiedCache.get(t);return e&&Date.now()-e.timestamp<this.cacheTTL?e.data:(e&&this.unifiedCache.delete(t),null)}setInCache(t,e){this.unifiedCache.set(t,{data:e,timestamp:Date.now()})}async calculateEnhancedBPM(t,e={}){let i=performance.now();try{if(!t?.tempo)return this.config.enableDebug&&console.warn("[MusicSyncService] No BPM data available for track"),this.getFallbackBPM();let a=t.tempo,r={...Y.bpmCalculation,...e},n=await this.getAudioFeatures();if(!n)return this.config.enableDebug&&console.log("[MusicSyncService] Using basic BPM calculation"),this.validateBPM(a);let{danceability:s,energy:o,valence:c=.5}=n;this.config.enableDebug&&console.log(`[MusicSyncService] Audio features - Danceability: ${s}, Energy: ${o}, Valence: ${c}`);let m=this.genreProfileManager.getProfileForTrack(n||void 0),d=this.genreProfileManager.detectGenre(n||void 0),h=this.computeAdvancedBPM({trackBPM:a,danceability:s,energy:o,valence:c,config:r,profile:m}),g=He(),v=(g?.Player?.data?.item||g?.Player?.data)?.uri?.split(":")??[],C=v.length>2&&v[2]?v[2]:"fallback",T=this.generateCacheKey(C,"bpm");return this.setInCache(T,{bpm:h,audioFeatures:n}),this.metrics.bpmCalculations++,this.config.enableDebug&&console.log(`[MusicSyncService] Enhanced BPM: ${h} (original: ${a})`),h}catch(a){return console.error("[MusicSyncService] BPM calculation failed:",a),this.metrics.errors++,this.getFallbackBPM()}}computeAdvancedBPM(t){let{trackBPM:e,danceability:i,energy:a,valence:r,config:n,profile:s}=t,{danceabilityWeight:o,energyWeight:c,bpmWeight:m,energyThreshold:d,danceabilityThreshold:h,bpmThreshold:g,maxBPM:f,minBPM:v}=n,C=Math.min(e/120,2),T=o,w=c,V=m;i<h&&(T*=i),a<d&&(w*=a),C<g&&(V=.9);let W=1;r>.6?W=1.05:r<.4&&a<.5&&(W=.95);let $=T+w+V,j=(i*T+a*w+C*V)/$*120*W;return s.beatEmphasis&&(j*=s.beatEmphasis),j=Math.max(v,Math.min(f,j)),Math.round(j*100)/100}validateBPM(t){let{minBPM:e,maxBPM:i}=Y.bpmCalculation;return Math.max(e,Math.min(i*2,Math.round(t*100)/100))}getFallbackBPM(){return 75}estimateDanceabilityFromTempo(t){let e=Y.musicVisualSync.enhancedBPM.danceabilityEstimation;return t>=e.highDance.min&&t<=e.highDance.max?e.highDance.value:t>=e.mediumDance.min&&t<=e.mediumDance.max?e.mediumDance.value:t>=e.lowMediumDance.min&&t<=e.lowMediumDance.max?e.lowMediumDance.value:e.lowDance.value}estimateEnergyFromTempoLoudness(t,e){let i=Y.musicVisualSync.enhancedBPM.energyEstimation,a=Math.max(0,Math.min(1,(t-i.tempoRange.min)/(i.tempoRange.max-i.tempoRange.min))),r=Math.max(0,Math.min(1,(e-i.loudnessRange.min)/(i.loudnessRange.max-i.loudnessRange.min)));return a*i.tempoWeight+r*i.loudnessWeight}estimateValenceFromKey(t){return[0,2,4,5,7,9,11].includes(t)?.6:.4}getFallbackProcessedData(t){let e=Y.musicVisualSync.enhancedBPM.fallbacks,i=6e4/e.tempo;return{trackUri:t,timestamp:Date.now(),tempo:e.tempo,loudness:e.loudness,key:e.key,timeSignature:e.timeSignature,estimatedDanceability:this.estimateDanceabilityFromTempo(e.tempo),estimatedEnergy:this.estimateEnergyFromTempoLoudness(e.tempo,e.loudness),estimatedValence:.5,energy:.5,valence:.5,processedEnergy:.5,visualIntensity:.5,moodIdentifier:"neutral",baseBPM:e.tempo,enhancedBPM:e.tempo,beatInterval:i,bmpCalculationMethod:"fallback",dataSource:"fallback"}}async createOKLABEnhancedFallbackColors(t){let e={VIBRANT:"#f2cdcd",DARK_VIBRANT:"#cba6f7",LIGHT_VIBRANT:"#f5c2e7",PROMINENT:"#cba6f7",VIBRANT_NON_ALARMING:"#f2cdcd",DESATURATED:"#9399b2"};if(!t||typeof t.energy!="number"||typeof t.valence!="number"){let s=E.getPreset("STANDARD"),o={};for(let[c,m]of Object.entries(e))try{let d=this.oklabProcessor.processColor(m,s);o[c]=d.enhancedHex}catch(d){this.config.enableDebug&&console.warn(`\u{1F3A8} [MusicSyncService] OKLAB processing failed for ${c}:`,d),o[c]=m}return o}let i={energy:t.energy,valence:t.valence,danceability:t.danceability,tempo:t.tempo,mode:t.mode,genre:this.genreProfileManager.detectGenre(t)},a=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(i),r;a.intensity>=1?r=E.getPreset("COSMIC"):a.intensity>=.7?r=E.getPreset("VIBRANT"):a.intensity>=.5?r=E.getPreset("STANDARD"):r=E.getPreset("SUBTLE");let n={};for(let[s,o]of Object.entries(e))try{let c=this.oklabProcessor.processColor(o,r);n[s]=c.enhancedHex}catch(c){this.config.enableDebug&&console.warn(`\u{1F3A8} [MusicSyncService] OKLAB processing failed for ${s}:`,c),n[s]=o}return n["--sn-emotional-primary"]=a.perceptualColorHex||a.primaryEmotion,n["--sn-emotional-intensity"]=a.intensity.toString(),n["--sn-emotional-preset"]=r.name,this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Created OKLAB-enhanced fallback colors:",{emotion:a.primaryEmotion,intensity:a.intensity,preset:r.name,oklabCoordination:n,musicContext:{energy:t.energy,valence:t.valence}}),n}async enhanceExtractedColorsWithOKLAB(t,e){let i={},a=E.getPreset("STANDARD");if(e&&typeof e.energy=="number"&&typeof e.valence=="number"){let r={energy:e.energy,valence:e.valence,danceability:e.danceability,tempo:e.tempo,mode:e.mode,genre:this.genreProfileManager.detectGenre(e)},n=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(r);n.intensity>=1?a=E.getPreset("COSMIC"):n.intensity>=.7?a=E.getPreset("VIBRANT"):n.intensity>=.5?a=E.getPreset("STANDARD"):a=E.getPreset("SUBTLE"),i["--sn-emotional-primary"]=n.perceptualColorHex||`oklabColorProcessor-${n.primaryEmotion}`,i["--sn-emotional-intensity"]=n.intensity.toString(),i["--sn-emotional-temperature"]=n.temperature.toString(),this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Applying OKLAB enhancement with emotional context:",{emotion:n.primaryEmotion,intensity:n.intensity,preset:a.name,colorCount:Object.keys(t).length})}for(let[r,n]of Object.entries(t)){if(!n||typeof n!="string"||!n.startsWith("#")){i[r]=n;continue}try{let s=this.oklabProcessor.processColor(n,a);i[r]=s.enhancedHex,i[`${r}-oklab-l`]=s.oklabEnhanced.L.toFixed(3),i[`${r}-oklab-a`]=s.oklabEnhanced.a.toFixed(3),i[`${r}-oklab-b`]=s.oklabEnhanced.b.toFixed(3),i[`${r}-oklch-c`]=s.oklchEnhanced.C.toFixed(3),i[`${r}-oklch-h`]=s.oklchEnhanced.H.toFixed(1)}catch(s){this.config.enableDebug&&console.warn(`\u{1F3A8} [MusicSyncService] OKLAB processing failed for ${r} (${n}):`,s),i[r]=n}}return i["--sn-oklab-preset"]=a.name,i["--sn-oklab-enhanced"]="true",this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] OKLAB color enhancement completed:",{originalCount:Object.keys(t).length,enhancedCount:Object.keys(i).length,preset:a.name,sampleEnhanced:{original:t.VIBRANT||t[Object.keys(t)[0]||""],enhanced:i.VIBRANT||i[Object.keys(i)[0]||""]}}),i}async processAudioFeatures(t,e,i){if(!this.isInitialized){console.warn("[MusicSyncService] Not initialized, skipping processing.");return}this.stopBeatScheduler(),this.currentTrackUri=e;let a=this.generateCacheKey(e,"processed"),r=this.getFromCache(a);if(r?.processedData){this.notifySubscribers(r.processedData,null,e);return}try{let n=t;if(n||(n=await this.fetchAudioData()),!n)throw new Error("Failed to fetch or receive audio data.");n.beats&&n.beats.length>0&&(this.currentSongBeats=n.beats,this.songStartTimestamp=Date.now(),this.nextBeatIndex=0,this.scheduleNextBeatEvent());let s=await this.calculateEnhancedBPM(n),o=s>0?6e4/s:0,c=n,{tempo:m=Y.musicVisualSync.enhancedBPM.fallbacks.tempo,loudness:d=Y.musicVisualSync.enhancedBPM.fallbacks.loudness,key:h=Y.musicVisualSync.enhancedBPM.fallbacks.key,time_signature:g=Y.musicVisualSync.enhancedBPM.fallbacks.timeSignature}=c,f=await this.getAudioFeatures(),v=f?.danceability??this.estimateDanceabilityFromTempo(m),C=f?.energy??this.estimateEnergyFromTempoLoudness(m,d),T=f?.valence??this.estimateValenceFromKey(h),w=this.config.getCurrentMultipliers?.()||{musicEnergyBoost:1,visualIntensityBase:1},V=Math.max(.1,Math.min(1,C*(w.musicEnergyBoost||1))),$=(C*.6+v*.4)*(w.visualIntensityBase||1),_="neutral";T>.6&&C>.6?_="energetic-happy":T>.6&&C<=.6?_="calm-happy":T<=.4&&C>.6?_="intense-moody":T<=.4&&C<=.4&&(_="calm-melancholy");let j=Math.max(.5,.8+$*.4),z=this.genreProfileManager.detectGenre(f||void 0),I={trackUri:e,timestamp:Date.now(),tempo:m,loudness:d,key:h,timeSignature:g,duration:i,estimatedDanceability:v,estimatedEnergy:C,estimatedValence:T,energy:C,valence:T,processedEnergy:V,visualIntensity:$,moodIdentifier:_,baseBPM:m,enhancedBPM:s,beatInterval:o,bmpCalculationMethod:"unified-service",dataSource:"unified-music-sync-service",beatOccurred:!1,animationSpeedFactor:j,genre:z};this.setInCache(a,{processedData:I}),this.latestProcessedData=I,this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] Processed music data:",{baseTempo:m,enhancedBPM:s,mood:_,energy:C.toFixed(2),visualIntensity:$.toFixed(2)}),this.notifySubscribers(I,t,e),p.emitSync("music:beat",{bpm:I.enhancedBPM,intensity:I.visualIntensity,timestamp:performance.now(),confidence:.8}),p.emitSync("music:energy",{energy:I.energy||.5,valence:I.valence||.5,tempo:I.enhancedBPM,timestamp:performance.now()}),p.emitSync("performance:frame",{deltaTime:16,fps:60,memoryUsage:performance.memory?.usedJSHeapSize||0,timestamp:performance.now()}),this.config.enableDebug&&console.log("[MusicSyncService] Successfully processed audio features.",{baseTempo:m,enhancedBPM:s,mood:_,energy:C.toFixed(2),visualIntensity:$.toFixed(2)})}catch(n){console.error("[MusicSyncService] Processing failed:",n),this.metrics.errors++;let s=this.getFallbackProcessedData(e);this.latestProcessedData=s,this.notifySubscribers(s,null,e)}}async processSongUpdate(t=!1){let i=He()?.Player?.data?.item?.uri;if(i&&!(!t&&i===this.currentTrackUri)){if(this.songChangeDebounceTimer&&clearTimeout(this.songChangeDebounceTimer),t){await this._processSongUpdateInternal(i);return}this.songChangeDebounceTimer=setTimeout(async()=>{this.songChangeDebounceTimer=null,await this._processSongUpdateInternal(i)},Y.synchronization.debounceRapidChanges)}}async _processSongUpdateInternal(t){if(this.eventProcessingState.isProcessingEvent){this.config.enableDebug&&console.warn("\u{1F504} [MusicSyncService] Already processing song update - skipping to prevent recursion");return}if(this.eventProcessingState.isProcessingEvent=!0,this.eventProcessingState.lastEventTime=Date.now(),this.eventProcessingState.consecutiveEvents++,this.eventProcessingState.eventChain.push("_processSongUpdateInternal"),this.eventProcessingState.consecutiveEvents>this.MAX_CONSECUTIVE_EVENTS){console.error("\u{1F504} [MusicSyncService] CRITICAL: Too many consecutive events - circuit breaker activated",{consecutiveEvents:this.eventProcessingState.consecutiveEvents,eventChain:this.eventProcessingState.eventChain}),this._resetEventProcessingState();return}let e=setTimeout(()=>{this.config.enableDebug&&console.warn("\u{1F504} [MusicSyncService] Event processing timeout - resetting state"),this._resetEventProcessingState()},this.EVENT_RESET_TIMEOUT);try{this.invalidateTrackCaches(t);let a=He()?.Player?.data?.item?.duration||0,r=await Promise.allSettled([this.getAudioFeatures(),this.robustColorExtraction(t)]),n=r[0].status==="fulfilled"?r[0].value:null,s=r[1].status==="fulfilled"?r[1].value:null;if(r[0].status==="rejected"&&this.config.enableDebug&&console.warn("[MusicSyncService] Audio features retrieval failed, continuing without music analysis:",r[0].reason),r[1].status==="rejected"&&this.config.enableDebug&&console.warn("[MusicSyncService] Color extraction failed, continuing without color processing:",r[1].reason),this.config.enableDebug){let g=(n?1:0)+(s?1:0);g===1?console.log(`[MusicSyncService] Graceful degradation: Continuing with ${n?"audio features only":"color extraction only"}`):g===2?console.log("[MusicSyncService] Full feature extraction successful"):console.warn("[MusicSyncService] Both strategies failed, will use fallback data")}console.log("\u{1F3A8} [MusicSyncService] Raw colors BEFORE sanitization:",{rawColors:s,rawColorType:typeof s,rawColorKeys:s?Object.keys(s):[],rawColorEntries:s?Object.entries(s):[]});let o=this.utils.sanitizeColorMap(s||{});console.log("\u{1F3A8} [MusicSyncService] Colors AFTER sanitization:",{sanitizedColors:o,sanitizedColorType:typeof o,sanitizedColorKeys:Object.keys(o),sanitizedColorEntries:Object.entries(o),colorCount:Object.keys(o).length,droppedCount:s?Object.keys(s).length-Object.keys(o).length:0}),this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Color extraction debug:",{trackUri:t,rawColorsReceived:s,sanitizedColors:o,colorCount:Object.keys(o).length,colorExtractorFailed:r[1].status==="rejected"});let c=o,m=!1;if(Object.keys(o).length>0)try{c=await this.enhanceExtractedColorsWithOKLAB(o,n),this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Successfully enhanced extracted colors with OKLAB processing")}catch(g){this.config.enableDebug&&console.warn("\u{1F3A8} [MusicSyncService] OKLAB enhancement failed, using original extracted colors:",g),c=o}if(Object.keys(o).length===0)try{c=await this.createOKLABEnhancedFallbackColors(n),m=!0,this.config.enableDebug&&console.warn("\u{1F3A8} [MusicSyncService] Color extraction failed, using OKLAB-enhanced Catppuccin fallback colors with emotional context")}catch(g){this.config.enableDebug&&console.warn("\u{1F3A8} [MusicSyncService] OKLAB fallback processing failed, using static fallback colors:",g),c={VIBRANT:"#f2cdcd",DARK_VIBRANT:"#cba6f7",LIGHT_VIBRANT:"#f5c2e7",PROMINENT:"#cba6f7",VIBRANT_NON_ALARMING:"#f2cdcd",DESATURATED:"#9399b2"},m=!0}let d={rawColors:c,trackUri:t,timestamp:Date.now(),colorHarmonyMode:this.config.currentColorHarmonyMode||"catppuccin",harmonicMode:this.config.currentColorHarmonyMode||"catppuccin",musicData:n?{energy:n.energy,valence:n.valence,tempo:n.tempo,genre:this.genreProfileManager.detectGenre(n)}:void 0,performanceHints:{preferLightweight:!1,enableAdvancedBlending:!0,maxProcessingTime:100}};console.log("\u{1F3A8} [MusicSyncService] FINAL colors before event emission:",{finalColors:c,finalColorKeys:Object.keys(c),finalColorEntries:Object.entries(c),usingFallback:m,extractionFailed:Object.keys(o).length===0});let h={rawColors:d.rawColors,trackUri:d.trackUri,timestamp:Date.now()};if(d.musicData&&(h.musicData=d.musicData),console.log("\u{1F3A8} [MusicSyncService] Emitting colors:extracted event with data:",{eventData:h,rawColorKeys:h.rawColors?Object.keys(h.rawColors):[],rawColorEntries:h.rawColors?Object.entries(h.rawColors):[]}),p.emitSync("colors:extracted",h),this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] Emitted colors:extracted event for strategy processing",{trackUri:t,colorCount:Object.keys(c).length,usingFallback:m,extractionFailed:Object.keys(o).length===0}),n){let g=this.convertFeaturesToAudioData(n);await this.processAudioFeatures(g,t,a)}(async()=>{let g=await this.fetchAudioData();this.isValidAudioData(g)&&await this.processAudioFeatures(g,t,a)})()}catch(i){console.error(`[MusicSyncService] Error processing song update for ${t}:`,i),this.metrics.errors++}finally{clearTimeout(e),this._resetEventProcessingState();let i=this.eventProcessingState.eventChain.indexOf("_processSongUpdateInternal");i>-1&&this.eventProcessingState.eventChain.splice(i,1)}}_resetEventProcessingState(){this.eventProcessingState.isProcessingEvent=!1,this.eventProcessingState.eventChain=[];let e=Date.now()-this.eventProcessingState.lastEventTime;if(e>this.EVENT_RESET_TIMEOUT)this.eventProcessingState.consecutiveEvents=0;else{let i=Math.min(1,e/this.EVENT_RESET_TIMEOUT);this.eventProcessingState.consecutiveEvents=Math.floor(this.eventProcessingState.consecutiveEvents*(1-i))}this.config.enableDebug&&this.eventProcessingState.consecutiveEvents>0&&console.log("\u{1F504} [MusicSyncService] Event processing state reset",{consecutiveEvents:this.eventProcessingState.consecutiveEvents,timeSinceLastEvent:e})}setupCacheManagement(){this.cacheCleanupInterval=setInterval(()=>{let t=Date.now();for(let[e,i]of this.unifiedCache.entries())t-i.timestamp>this.cacheTTL&&this.unifiedCache.delete(e)},this.cacheTTL)}setupPerformanceMonitoring(){this.performanceInterval=setInterval(()=>{if(this.metrics.performance.length>0){let t=this.metrics.performance.reduce((e,i)=>e+i,0)/this.metrics.performance.length;this.metrics.avgProcessingTime=t,this.metrics.performance=[]}},6e4)}loadUserPreferences(){try{return{enableMusicSync:!0,audioAnalysisQuality:x.get("sn-webgl-quality")||"medium",gradientIntensity:x.get("sn-gradient-intensity")||"balanced",artisticMode:x.get("sn-artistic-mode")||"artist-vision"}}catch{return{enableMusicSync:!0,audioAnalysisQuality:"medium",gradientIntensity:"balanced",artisticMode:"artist-vision"}}}saveUserPreferences(){try{this.config.enableDebug&&console.log("[MusicSyncService] User preferences updated via settings system")}catch(t){this.config.enableDebug&&console.warn("[MusicSyncService] Could not save user preferences:",t)}}updateConfiguration(t){let e={...Y};Object.assign(Y,t),this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] Configuration updated",{from:e,to:Y}),this.cacheTTL=Y.performance.cacheTTL,e.performance.enableMetrics!==Y.performance.enableMetrics&&(Y.performance.enableMetrics?this.setupPerformanceMonitoring():this.performanceInterval&&(clearInterval(this.performanceInterval),this.performanceInterval=null))}destroy(){this.songChangeDebounceTimer&&(clearTimeout(this.songChangeDebounceTimer),this.songChangeDebounceTimer=null),this.stopBeatScheduler(),this.performanceInterval&&clearInterval(this.performanceInterval),this.cacheCleanupInterval&&clearInterval(this.cacheCleanupInterval),this.subscribers.clear(),this.unifiedCache.clear(),this.isInitialized=!1,this.latestProcessedData=null,this.metrics={bpmCalculations:0,beatSyncs:0,cacheHits:0,cacheMisses:0,avgProcessingTime:0,performance:[],errors:0,updates:0},this.cacheCleanupInterval=null}setColorHarmonyEngine(t){this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] setColorHarmonyEngine called - now using event-driven pattern instead of direct dependency.")}getLatestProcessedData(){return this.latestProcessedData}getCurrentBeatVector(){return{...this.currentBeatVector}}stopBeatScheduler(){this.beatSchedulerTimer&&(clearTimeout(this.beatSchedulerTimer),this.beatSchedulerTimer=null)}triggerBeatEvent(){let e=this.nextBeatIndex*.61803398875%1*Math.PI*2;if(this.currentBeatVector={x:Math.cos(e),y:Math.sin(e)},this.latestProcessedData){let i={...this.latestProcessedData,beatOccurred:!0,beatVector:this.currentBeatVector};this.notifySubscribers(i,null,this.currentTrackUri)}this.nextBeatIndex++,this.scheduleNextBeatEvent()}scheduleNextBeatEvent(){if(this.nextBeatIndex>=this.currentSongBeats.length)return;let t=this.currentSongBeats[this.nextBeatIndex];if(!t)return;let e=Date.now()-this.songStartTimestamp,i=t.start*1e3-e;i>=0?this.beatSchedulerTimer=setTimeout(()=>this.triggerBeatEvent(),i):(this.nextBeatIndex++,this.scheduleNextBeatEvent())}isValidAudioData(t){return!!t&&typeof t.tempo=="number"&&t.tempo>0}invalidateTrackCaches(t){if(t)for(let e of this.unifiedCache.keys())e.includes(t)&&this.unifiedCache.delete(e)}convertFeaturesToAudioData(t){let e=Y.musicVisualSync.enhancedBPM.fallbacks;return{tempo:t.tempo,energy:t.energy,valence:t.valence,loudness:e.loudness,key:e.key,time_signature:e.timeSignature,danceability:t.danceability,acousticness:t.acousticness,instrumentalness:t.instrumentalness,speechiness:0,liveness:0,mode:0}}convertSpicetifyToAudioData(t){return{tempo:t.tempo,energy:t.energy,valence:t.valence,loudness:t.loudness,key:t.key,time_signature:t.time_signature||t.timeSignature,danceability:t.danceability,acousticness:t.acousticness,instrumentalness:t.instrumentalness,speechiness:t.speechiness,liveness:t.liveness,mode:t.mode}}async robustColorExtraction(t,e=3){console.log("\u{1F3A8} [MusicSyncService] Starting robust color extraction:",{trackUri:t,maxRetries:e,timestamp:Date.now()});for(let i=1;i<=e;i++)try{if(!t)return console.warn("\u{1F3A8} [MusicSyncService] Empty trackUri provided to color extraction"),null;console.log(`\u{1F3A8} [MusicSyncService] Calling Spicetify.colorExtractor (attempt ${i})...`);let a=He();if(!a?.colorExtractor)throw new Error("colorExtractor not available");let r=await a.colorExtractor(t);if(console.log(`\u{1F3A8} [MusicSyncService] Raw color extraction result (attempt ${i}):`,{trackUri:t,success:!!r,colorsType:typeof r,colorsIsNull:r===null,colorsIsUndefined:r===void 0,colorCount:r?Object.keys(r).length:0,rawColors:r,colorKeys:r?Object.keys(r):[],colorValues:r?Object.values(r):[]}),r&&typeof r=="object"&&Object.keys(r).length>0)return Object.entries(r).forEach(([n,s])=>{console.log(`\u{1F3A8} [MusicSyncService] Extracted color: ${n} = ${s}`)}),r;console.warn(`\u{1F3A8} [MusicSyncService] Color extraction returned empty/invalid data on attempt ${i}`)}catch(a){if(console.error(`\u{1F3A8} [MusicSyncService] Color extraction attempt ${i} failed with error:`,a,{errorMessage:a instanceof Error?a.message:String(a),errorStack:a instanceof Error?a.stack:void 0}),i<e){let r=100*i;console.log(`\u{1F3A8} [MusicSyncService] Waiting ${r}ms before retry...`),await new Promise(n=>setTimeout(n,r))}}return console.error(`\u{1F3A8} [MusicSyncService] CRITICAL: All color extraction attempts failed for ${t}`),null}updateMetrics(t){this.latestProcessedData=t}getCurrentMusicState(){return!this.latestProcessedData||!this.audioData?null:{emotion:this.latestProcessedData.emotion||null,beat:{tempo:this.latestProcessedData.bpm||this.audioData.tempo||120,energy:this.latestProcessedData.energy||this.audioData.energy||.5,timestamp:Date.now()},intensity:this.latestProcessedData.intensity||this.audioData.energy||.5}}async healthCheck(){try{let t=ht.isAvailable(),e=this.subscribers.size>0,i=this.latestProcessedData!==null,a=this.metrics.bpmCalculations+this.metrics.beatSyncs+this.metrics.cacheHits+this.metrics.cacheMisses,r=a>0?this.metrics.errors/a:0;return this.isInitialized?t?r>.5?{status:"degraded",message:`High error rate detected: ${(r*100).toFixed(1)}%`,details:{initialized:this.isInitialized,spicetifyAvailable:t,subscribers:e,recentData:i,errorRate:r,errors:this.metrics.errors,totalOperations:a}}:{status:"healthy",message:"Music sync service operational",details:{initialized:this.isInitialized,spicetifyAvailable:t,subscribers:e,subscriberCount:this.subscribers.size,recentData:i,errorRate:r,bpmCalculations:this.metrics.bpmCalculations,beatSyncs:this.metrics.beatSyncs,cacheHits:this.metrics.cacheHits,cacheMisses:this.metrics.cacheMisses,avgProcessingTime:this.metrics.avgProcessingTime,errors:this.metrics.errors,updates:this.metrics.updates}}:{status:"degraded",message:"Spicetify audio data API not available - running in limited mode",details:{initialized:this.isInitialized,spicetifyAvailable:t,subscribers:e,recentData:i,errorRate:r}}:{status:"critical",message:"System not initialized",details:{initialized:this.isInitialized,spicetifyAvailable:t}}}catch(t){return{status:"critical",message:`Health check failed: ${t instanceof Error?t.message:"Unknown error"}`,details:{error:t instanceof Error?t.message:"Unknown error"}}}}}});var yi,$n=y(()=>{"use strict";yi=class{constructor(t={}){this._timerRegistry=new Map;this._timerMasterInterval=null;this.config={timerIntervalMs:t.timerIntervalMs||50,maxTimerBudget:t.maxTimerBudget||10,enableDebug:t.enableDebug||!1,...t},this._timerPerformanceMetrics={totalExecutions:0,totalTime:0,maxExecutionTime:0,averageExecutionTime:0,skippedTimers:0,timerCallbacks:new Map},this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Initialized")}initialize(){this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Timer consolidation initialized")}registerConsolidatedTimer(t,e,i,a="normal"){if(this._timerRegistry.has(t)){console.warn(`[TimerConsolidationSystem] Timer ${t} already registered`);return}let r={callback:e,intervalMs:i,priority:a,lastExecution:0,enabled:!0,executionCount:0,totalExecutionTime:0,maxExecutionTime:0,skippedExecutions:0};this._timerRegistry.set(t,r),this._timerPerformanceMetrics.timerCallbacks.set(t,{calls:0,totalTime:0,maxTime:0}),this.config.enableDebug&&console.log(`\u23F1\uFE0F [TimerConsolidationSystem] Registered timer: ${t} (${i}ms, ${a} priority)`),this._timerRegistry.size===1&&!this._timerMasterInterval&&this._startMasterTimer()}unregisterConsolidatedTimer(t){this._timerRegistry.has(t)&&(this._timerRegistry.delete(t),this._timerPerformanceMetrics.timerCallbacks.delete(t),this.config.enableDebug&&console.log(`\u23F1\uFE0F [TimerConsolidationSystem] Unregistered timer: ${t}`),this._timerRegistry.size===0&&this._stopMasterTimer())}_startMasterTimer(){this._timerMasterInterval||(this._timerMasterInterval=setInterval(()=>{this._executeMasterTimerFrame()},this.config.timerIntervalMs),this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Master timer started"))}_stopMasterTimer(){this._timerMasterInterval&&(clearInterval(this._timerMasterInterval),this._timerMasterInterval=null),this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Master timer stopped")}_executeMasterTimerFrame(){let t=performance.now(),e=this.config.maxTimerBudget,i=Array.from(this._timerRegistry.entries()).sort(([,r],[,n])=>{let s={critical:0,normal:1,background:2};return s[r.priority]-s[n.priority]});for(let[r,n]of i){if(!n.enabled||e<=0&&n.priority==="background"){e<=0&&n.skippedExecutions++;continue}if(t-n.lastExecution<n.intervalMs)continue;let o=performance.now();try{n.callback();let c=performance.now()-o;n.executionCount++,n.totalExecutionTime+=c,n.maxExecutionTime=Math.max(n.maxExecutionTime,c),n.lastExecution=t;let m=this._timerPerformanceMetrics.timerCallbacks.get(r);m&&(m.calls++,m.totalTime+=c,m.maxTime=Math.max(m.maxTime,c)),e-=c}catch(c){console.error(`[TimerConsolidationSystem] Error in timer ${r}:`,c),n.enabled=!1}}let a=performance.now()-t;this._updateTimerPerformanceMetrics(a)}_updateTimerPerformanceMetrics(t){let e=this._timerPerformanceMetrics;e.totalExecutions++,e.totalTime+=t,e.maxExecutionTime=Math.max(e.maxExecutionTime,t),e.averageExecutionTime=e.totalTime/e.totalExecutions,t>this.config.maxTimerBudget&&e.skippedTimers++}destroy(){this._stopMasterTimer(),this._timerRegistry.clear(),this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Destroyed")}}});var Te,ze,ja,bi=y(()=>{"use strict";k();Te=class Te{constructor(t,e){this.performanceAnalyzer=null;this.subsystemMetrics=new Map;this.optimizationStrategies=new Map;this.adaptiveOptimizationEnabled=!1;this.optimizationInterval=null;this.activeIssues=new Map;this.issueHistory=[];this.lastHealthCheck=0;this.healthCheckInterval=null;this.HEALTH_CHECK_INTERVAL=5e3;this.batteryState=null;this.frameTimeHistory=[];this.memoryUsageHistory=[];this.lastOptimizationTime=0;this.optimizationCooldown=5e3;this.PERFORMANCE_THRESHOLDS={frameTime:{warning:16.67,critical:33.33},memoryUsage:{warning:50*1024*1024,critical:100*1024*1024},cpuUsage:{warning:15,critical:30},fps:{warning:50,critical:30}};this.PERFORMANCE_MODES={battery:{name:"battery",qualityLevel:.4,animationQuality:.3,effectQuality:.2,blurQuality:.3,shadowQuality:.2,frameRate:30,optimizationLevel:3},balanced:{name:"balanced",qualityLevel:.8,animationQuality:.8,effectQuality:.7,blurQuality:.8,shadowQuality:.7,frameRate:60,optimizationLevel:1},performance:{name:"performance",qualityLevel:1,animationQuality:1,effectQuality:1,blurQuality:1,shadowQuality:1,frameRate:60,optimizationLevel:0},auto:{name:"auto",qualityLevel:.8,animationQuality:.8,effectQuality:.8,blurQuality:.8,shadowQuality:.8,frameRate:60,optimizationLevel:1}};this.config=t,this.performanceAnalyzer=e||null,this.eventBus=p,this.initializeDeviceCapabilities(),this.initializeThermalMonitoring(),this.initializeBatteryMonitoring(),this.currentPerformanceMode=this.PERFORMANCE_MODES.auto,this.initializeDefaultStrategies(),this.startHealthMonitoring(),this.subscribeToEvents(),this.config.enableDebug&&console.log("[PerformanceAnalyzer] Initialized with enhanced device capabilities, thermal monitoring, and battery optimization")}static getInstance(t,e){if(!Te.instance){if(!t||!e)throw new Error("PerformanceAnalyzer requires config and performanceAnalyzer for first initialization");Te.instance=new Te(t,e)}return Te.instance}trackSubsystem(t,e){let i=performance.now(),r={...this.subsystemMetrics.get(t)||{name:t,frameTime:0,memoryUsage:0,cpuUsage:0,fps:60,lastUpdate:i,status:"healthy",issues:[]},...e,lastUpdate:i};r.status=this.calculateHealthStatus(r),this.updateSubsystemIssues(r),this.subsystemMetrics.set(t,r),this.performanceAnalyzer&&(this.performanceAnalyzer.recordMetric?.(`subsystem_${t}_frame_time`,r.frameTime),this.performanceAnalyzer.recordMetric?.(`subsystem_${t}_memory`,r.memoryUsage),this.performanceAnalyzer.recordMetric?.(`subsystem_${t}_fps`,r.fps)),this.adaptiveOptimizationEnabled&&r.status!=="healthy"&&this.checkAndTriggerOptimization(r),this.config.enableDebug&&r.status!=="healthy"&&console.warn(`[PerformanceAnalyzer] Subsystem ${t} status: ${r.status}`,r)}getSystemHealth(){let t=performance.now(),e=new Map(this.subsystemMetrics),i=0,a=0,r=0;for(let d of e.values())switch(d.status){case"healthy":i++;break;case"warning":a++;break;case"critical":r++;break}let n=e.size,s="healthy";r>0?s="critical":a>0&&(s="warning");let o=this.calculatePerformanceScore(e),c=this.generateRecommendations(e),m={overall:s,totalSubsystems:n,healthySubsystems:i,warningSubsystems:a,criticalSubsystems:r,subsystems:e,recommendations:c,performanceScore:o,lastUpdate:t};return this.lastHealthCheck=t,m}startMonitoring(){this.enableAdaptiveOptimization(),this.healthCheckInterval||this.startHealthMonitoring(),this.config.enableDebug&&console.log("[PerformanceAnalyzer] Monitoring started")}enableAdaptiveOptimization(){this.adaptiveOptimizationEnabled||(this.adaptiveOptimizationEnabled=!0,this.optimizationInterval=setInterval(()=>{this.performOptimizationCheck()},2e3),this.config.enableDebug&&console.log("[PerformanceAnalyzer] Adaptive optimization enabled"))}disableAdaptiveOptimization(){this.adaptiveOptimizationEnabled&&(this.adaptiveOptimizationEnabled=!1,this.optimizationInterval&&(clearInterval(this.optimizationInterval),this.optimizationInterval=null),this.config.enableDebug&&console.log("[PerformanceAnalyzer] Adaptive optimization disabled"))}registerOptimizationStrategy(t){this.optimizationStrategies.set(t.name,t),this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Registered optimization strategy: ${t.name}`)}triggerOptimization(t){this.activeIssues.set(`${t.subsystem}:${t.type}`,t),this.issueHistory.push(t),this.issueHistory.length>100&&this.issueHistory.shift();let e=Array.from(this.optimizationStrategies.values()).filter(i=>i.subsystem===t.subsystem||i.subsystem==="*").sort((i,a)=>a.priority-i.priority);for(let i of e){let a=this.subsystemMetrics.get(t.subsystem);if(a&&i.condition(a))try{i.action(a),this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Applied optimization strategy: ${i.name} for ${t.subsystem}`);break}catch(r){console.error(`[PerformanceAnalyzer] Error applying optimization strategy ${i.name}:`,r)}}}getMetrics(){return{subsystems:new Map(this.subsystemMetrics),issues:new Map(this.activeIssues),strategies:new Map(this.optimizationStrategies),adaptiveOptimizationEnabled:this.adaptiveOptimizationEnabled}}destroy(){this.disableAdaptiveOptimization(),this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.subsystemMetrics.clear(),this.optimizationStrategies.clear(),this.activeIssues.clear(),this.issueHistory=[],Te.instance===this&&(Te.instance=null),this.config.enableDebug&&console.log("[PerformanceAnalyzer] Destroyed")}initializeDefaultStrategies(){this.registerOptimizationStrategy({name:"memory-cleanup",type:"memory_cleanup",priority:100,subsystem:"*",description:"Trigger garbage collection and memory cleanup",condition:t=>t.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.warning,action:t=>{}}),this.registerOptimizationStrategy({name:"fps-optimization",type:"reduce_quality",priority:80,subsystem:"*",description:"Reduce quality settings to improve FPS",condition:t=>t.fps<this.PERFORMANCE_THRESHOLDS.fps.warning,action:t=>{}}),this.registerOptimizationStrategy({name:"cpu-throttling",type:"throttle_updates",priority:70,subsystem:"*",description:"Throttle update frequency to reduce CPU usage",condition:t=>t.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.warning,action:t=>{}})}calculateHealthStatus(t){let e=[];return t.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.critical?e.push("critical-frame-time"):t.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.warning&&e.push("warning-frame-time"),t.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.critical?e.push("critical-memory"):t.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.warning&&e.push("warning-memory"),t.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.critical?e.push("critical-cpu"):t.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.warning&&e.push("warning-cpu"),t.fps<this.PERFORMANCE_THRESHOLDS.fps.critical?e.push("critical-fps"):t.fps<this.PERFORMANCE_THRESHOLDS.fps.warning&&e.push("warning-fps"),t.issues=e,e.some(i=>i.startsWith("critical"))?"critical":e.some(i=>i.startsWith("warning"))?"warning":"healthy"}updateSubsystemIssues(t){let e=`${t.name}:performance`;if(t.status==="healthy"){if(this.activeIssues.has(e)){let i=this.activeIssues.get(e);i.resolved=!0,this.activeIssues.delete(e)}}else{let i={type:"render",severity:t.status==="critical"?"critical":"medium",subsystem:t.name,message:`Performance degradation detected: ${t.issues.join(", ")}`,timestamp:Date.now(),resolved:!1};this.activeIssues.set(e,i)}}checkAndTriggerOptimization(t){let e=`${t.name}:performance`,i=this.activeIssues.get(e);i&&!i.resolved&&this.triggerOptimization(i)}performOptimizationCheck(){let t=performance.now();for(let[e,i]of this.subsystemMetrics)t-i.lastUpdate>1e4||i.status!=="healthy"&&this.checkAndTriggerOptimization(i)}calculatePerformanceScore(t){if(t.size===0)return 100;let e=0;for(let i of t.values()){let a=100;i.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.warning&&(a-=20),i.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.critical&&(a-=30),i.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.warning&&(a-=15),i.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.critical&&(a-=25),i.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.warning&&(a-=10),i.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.critical&&(a-=20),i.fps<this.PERFORMANCE_THRESHOLDS.fps.warning&&(a-=15),i.fps<this.PERFORMANCE_THRESHOLDS.fps.critical&&(a-=25),e+=Math.max(0,a)}return Math.round(e/t.size)}generateRecommendations(t){let e=[],i=Array.from(t.values()).flatMap(r=>r.issues),a=new Map;for(let r of i)a.set(r,(a.get(r)||0)+1);for(let[r,n]of a)if(n>=2)switch(r){case"critical-frame-time":case"warning-frame-time":e.push("Consider reducing animation quality or frequency");break;case"critical-memory":case"warning-memory":e.push("Memory cleanup needed - consider reducing cache sizes");break;case"critical-cpu":case"warning-cpu":e.push("High CPU usage detected - consider throttling updates");break;case"critical-fps":case"warning-fps":e.push("Low FPS detected - consider disabling non-essential effects");break}return e.length===0&&e.push("System performance is optimal"),e}startHealthMonitoring(){this.healthCheckInterval=setInterval(()=>{this.getSystemHealth()},this.HEALTH_CHECK_INTERVAL)}subscribeToEvents(){}initializeDeviceCapabilities(){let t=navigator,e=performance.memory,i=document.createElement("canvas"),a=i.getContext("webgl2")||i.getContext("webgl"),r=2048;a&&(r=a.getParameter(a.MAX_TEXTURE_SIZE)||2048);let n=e?Math.round(e.jsHeapSizeLimit/(1024*1024*1024)):4,s="medium";n>=8&&t.hardwareConcurrency>=8&&r>=4096?s="premium":n>=4&&t.hardwareConcurrency>=4?s="high":n>=2&&t.hardwareConcurrency>=2?s="medium":s="low",this.deviceCapabilities={performanceTier:s,memoryGB:n,cpuCores:t.hardwareConcurrency||4,gpuAcceleration:!!a,isMobile:/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(t.userAgent),supportsWebGL:!!a,supportsBackdropFilter:CSS.supports("backdrop-filter","blur(10px)"),maxTextureSize:r,devicePixelRatio:window.devicePixelRatio||1},this.config.enableDebug&&console.log("[PerformanceAnalyzer] Device capabilities detected:",this.deviceCapabilities)}initializeThermalMonitoring(){this.thermalState={temperature:"normal",throttleLevel:0,cpuUsage:0,gpuUsage:0,memoryUsage:0},setInterval(()=>{this.updateThermalState()},1e4)}async initializeBatteryMonitoring(){try{let t=navigator;if("getBattery"in t){let e=await t.getBattery();this.batteryState={level:e.level,charging:e.charging,chargingTime:e.chargingTime,dischargingTime:e.dischargingTime},e.addEventListener("levelchange",()=>{this.batteryState&&(this.batteryState.level=e.level,this.adjustPerformanceModeForBattery())}),e.addEventListener("chargingchange",()=>{this.batteryState&&(this.batteryState.charging=e.charging,this.adjustPerformanceModeForBattery())}),this.config.enableDebug&&console.log("[PerformanceAnalyzer] Battery monitoring initialized")}}catch{this.config.enableDebug&&console.log("[PerformanceAnalyzer] Battery API not available")}}updateThermalState(){let t=this.performanceAnalyzer?.getMedianFPS?.()||60,e=performance.memory,i=e?e.usedJSHeapSize/e.jsHeapSizeLimit:0,a="normal",r=0;t<30||i>.9?(a="critical",r=.8):t<45||i>.7?(a="hot",r=.4):(t<55||i>.5)&&(a="warm",r=.2),this.thermalState={temperature:a,throttleLevel:r,cpuUsage:Math.min(1-t/60,1),gpuUsage:0,memoryUsage:i},a==="critical"&&this.currentPerformanceMode.name!=="battery"?this.setPerformanceMode("battery"):a==="normal"&&this.currentPerformanceMode.name==="battery"&&this.setPerformanceMode("auto")}adjustPerformanceModeForBattery(){this.batteryState&&(!this.batteryState.charging&&this.batteryState.level<.2?this.setPerformanceMode("battery"):this.batteryState.charging&&this.currentPerformanceMode.name==="battery"&&this.setPerformanceMode("auto"))}setPerformanceMode(t){let e=this.PERFORMANCE_MODES[t];e&&(this.currentPerformanceMode=e,this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Performance mode changed to: ${t}`))}getDeviceCapabilities(){return{...this.deviceCapabilities}}getThermalState(){return{...this.thermalState}}getBatteryState(){return this.batteryState?{...this.batteryState}:null}getCurrentPerformanceMode(){return{...this.currentPerformanceMode}}emitTrace(t,e){this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Trace: ${t}`,e)}recordMetric(t,e){let i=t.match(/^subsystem_(.+)_(.+)$/);if(i&&i.length>=3){let a=i[1]||"unknown",r=i[2]||"unknown",n=this.subsystemMetrics.get(a)||{name:a,frameTime:0,memoryUsage:0,cpuUsage:0,fps:60,lastUpdate:performance.now(),status:"healthy",issues:[]};switch(r){case"frame_time":n.frameTime=e;break;case"memory":n.memoryUsage=e;break;case"fps":n.fps=e;break;case"cpu":n.cpuUsage=e;break}this.trackSubsystem(a,n)}this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Metric: ${t}=${e}`)}getMedianFPS(){let t=Array.from(this.subsystemMetrics.values()).map(i=>i.fps);if(t.length>0){t.sort((a,r)=>a-r);let i=Math.floor(t.length/2);return t.length%2===0?((t[i-1]||0)+(t[i]||0))/2:t[i]||0}switch(this.deviceCapabilities.performanceTier){case"premium":return 60;case"high":return 60;case"medium":return 50;case"low":return 30;default:return 30}}calculateHealthScore(){return this.getSystemHealth().performanceScore/100}shouldReduceQuality(){let t=this.deviceCapabilities.performanceTier,e=this.thermalState.temperature,i=this.calculateHealthScore();return t==="low"||e==="hot"||e==="critical"||i<.5}timeOperation(t,e){let i=performance.now(),a=e(),r=performance.now()-i;return this.recordMetric(`operation_${t}_duration`,r),this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Operation ${t}: ${r.toFixed(2)}ms`),a}async timeOperationAsync(t,e){let i=performance.now(),a=await e(),r=performance.now()-i;return this.recordMetric(`async_operation_${t}_duration`,r),this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Async operation ${t}: ${r.toFixed(2)}ms`),a}getAverageTime(t){switch(this.deviceCapabilities.performanceTier){case"premium":return 3;case"high":return 5;case"medium":return 15;case"low":return 30;default:return 15}}updateBudget(t,e){this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Budget update ignored: ${t}=${e} (using adaptive optimization instead)`)}startTiming(t){let e=`${t}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Timing started: ${t} (${e})`),e}endTiming(t,e){this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Timing ended: ${t}`,e)}getWebGLStatus(){let t=this.deviceCapabilities.supportsWebGL,e=this.deviceCapabilities.performanceTier;if(!t)return{state:"disabled",quality:"low",enabled:!1};let i="medium";return e==="premium"||e==="high"?i=this.thermalState.temperature==="normal"?"high":"medium":(e==="low"||this.thermalState.temperature==="critical")&&(i="low"),{state:"webgl-active",quality:i,enabled:!0}}getPerformanceSummary(){let t=this.getWebGLStatus(),e=this.getSystemHealth(),i=this.deviceCapabilities.performanceTier==="premium"?"high":this.deviceCapabilities.performanceTier,a=`${this.deviceCapabilities.memoryGB}GB RAM, ${this.deviceCapabilities.cpuCores} cores, ${this.deviceCapabilities.supportsWebGL?"WebGL":"No WebGL"}${this.deviceCapabilities.isMobile?", Mobile":""}`,r=e.performanceScore/100,n=[];n.push(`Device tier: ${i} (${this.deviceCapabilities.performanceTier})`),n.push(`Memory: ${this.deviceCapabilities.memoryGB}GB`),n.push(`CPU cores: ${this.deviceCapabilities.cpuCores}`),this.deviceCapabilities.supportsWebGL&&n.push(`WebGL supported (${this.deviceCapabilities.maxTextureSize}px max texture)`),this.thermalState.temperature!=="normal"&&n.push(`Thermal state: ${this.thermalState.temperature}`);let s=this.currentPerformanceMode.name==="performance"&&this.thermalState.temperature==="normal"&&(this.batteryState?.charging||(this.batteryState?.level||0)>.5||!this.batteryState);return{deviceTier:i,deviceDescription:a,confidence:r,reasoning:n,webglStatus:t,energyBoost:s,settings:this.currentPerformanceMode}}getDeviceTier(){return this.deviceCapabilities.performanceTier==="premium"?"high":this.deviceCapabilities.performanceTier}getDeviceDescription(){return`${this.deviceCapabilities.memoryGB}GB RAM, ${this.deviceCapabilities.cpuCores} cores, ${this.deviceCapabilities.supportsWebGL?"WebGL":"No WebGL"}${this.deviceCapabilities.isMobile?", Mobile":""}`}hasEnergyBoost(){return this.currentPerformanceMode.name==="performance"&&this.thermalState.temperature==="normal"&&(this.batteryState?.charging||(this.batteryState?.level||0)>.5||!this.batteryState)}getCurrentSettings(){return{performanceMode:this.currentPerformanceMode,deviceCapabilities:this.deviceCapabilities,thermalState:this.thermalState,batteryState:this.batteryState,webglStatus:this.getWebGLStatus()}}};Te.instance=null;ze=Te,ja=ze});var Ka,Ue,Qa=y(()=>{"use strict";bi();G();A();Ka=class{constructor(t,e){this.initialized=!1;typeof process<"u",this.config=M;try{this.unifiedCoordinator=ze.getInstance(this.config,this)}catch{this.unifiedCoordinator=new ze(this.config,this)}u?.debug?.log("PerformanceManager","High-level performance management - delegating to PerformanceAnalyzer")}async initialize(){this.initialized||(this.initialized=!0,u?.debug?.log("SimplePerformanceCoordinator","Compatibility layer initialized - delegating to PerformanceAnalyzer"))}async healthCheck(){if(!this.initialized)return{healthy:!1,details:"Not initialized",system:"SimplePerformanceCoordinator"};let t=this.unifiedCoordinator.getSystemHealth();return{healthy:t.overall==="healthy",details:t.overall==="healthy"?`Performance monitoring active (${t.totalSubsystems} subsystems)`:`Performance issues detected: ${t.recommendations.join(", ")}`,system:"SimplePerformanceCoordinator"}}destroy(){this.initialized=!1,u?.debug?.log("SimplePerformanceCoordinator","Compatibility layer destroyed")}updateAnimation(t){}getPerformanceSystem(){return this.unifiedCoordinator}getDeviceTier(){return this.unifiedCoordinator.getDeviceTier()}getDeviceDescription(){return this.unifiedCoordinator.getDeviceDescription()}hasEnergyBoost(){return this.unifiedCoordinator.hasEnergyBoost()}getCurrentSettings(){return this.unifiedCoordinator.getCurrentSettings()}getWebGLStatus(){return this.unifiedCoordinator.getWebGLStatus()}getPerformanceSummary(){return this.unifiedCoordinator.getPerformanceSummary()}startMonitoring(){this.unifiedCoordinator.startMonitoring(),u?.debug?.log("PerformanceManager","Monitoring started (delegated to PerformanceAnalyzer)")}emitTrace(t,e){return this.unifiedCoordinator.emitTrace(t,e)}recordMetric(t,e){return this.unifiedCoordinator.recordMetric(t,e)}getMedianFPS(){return this.unifiedCoordinator.getMedianFPS()}calculateHealthScore(){return this.unifiedCoordinator.calculateHealthScore()}shouldReduceQuality(){return this.unifiedCoordinator.shouldReduceQuality()}timeOperation(t,e){return this.unifiedCoordinator.timeOperation(t,e)}async timeOperationAsync(t,e){return this.unifiedCoordinator.timeOperationAsync(t,e)}getAverageTime(t){return this.unifiedCoordinator.getAverageTime(t)}updateBudget(t,e){return this.unifiedCoordinator.updateBudget(t,e)}startTiming(t){return this.unifiedCoordinator.startTiming(t)}endTiming(t,e){return this.unifiedCoordinator.endTiming(t,e)}},Ue=Ka});var O,oe=y(()=>{"use strict";O=class{constructor(t={}){this.deviceCapabilities=null;this.isInitialized=!1;this.benchmarkCache=new Map;this.detectionStartTime=0;this.config={enableDebug:t.enableDebug||!1,runStressTests:t.runStressTests!==!1,spicetifyContext:t.spicetifyContext||this._detectSpicetifyContext(),...t},this.config.enableDebug&&console.log("\u{1F50D} [DeviceCapabilityDetector] Initialized",this.config.spicetifyContext?"(Spicetify-optimized)":"(Standard)")}_detectSpicetifyContext(){return!!window.Spicetify}async initialize(){if(this.isInitialized)return this.deviceCapabilities;this.detectionStartTime=performance.now(),this.config.enableDebug&&console.log("\u{1F50D} [DeviceCapabilityDetector] Starting enhanced capability detection...",this.config.spicetifyContext?"(Spicetify mode)":"(Standard mode)");let t=await this._analyzeMemoryCapabilities(),e=await this._analyzeCPUCapabilities(),i=await this._analyzeGPUCapabilities();this.deviceCapabilities={memory:t,cpu:e,gpu:i,browser:{supportsOffscreenCanvas:this._detectOffscreenCanvasSupport(),supportsWorkers:this._detectWorkerSupport(),supportsSharedArrayBuffer:this._detectSharedArrayBufferSupport(),supportsWASM:this._detectWASMSupport(),supportsCSSHoudini:this._detectCSSHoudiniSupport()},display:{pixelRatio:window.devicePixelRatio||1,refreshRate:await this._detectRefreshRate(),colorGamut:this._detectColorGamut(),contrastRatio:this._detectContrastCapability(),reducedMotion:this._detectReducedMotion()},network:{effectiveType:navigator.connection?.effectiveType||"unknown",downlink:navigator.connection?.downlink||0,rtt:navigator.connection?.rtt||0,saveData:navigator.connection?.saveData||!1},overall:"detecting",spicetifyProfile:await this._createSpicetifyProfile(t,e,i)},this.config.runStressTests&&(await this._runCapabilityTests(),this.deviceCapabilities.spicetifyProfile=await this._createSpicetifyProfile(this.deviceCapabilities.memory,this.deviceCapabilities.cpu,this.deviceCapabilities.gpu)),this.deviceCapabilities.overall=this._calculateOverallPerformanceLevel(),this.isInitialized=!0;let a=performance.now()-this.detectionStartTime;return this.config.enableDebug&&console.log("\u{1F4CA} [DeviceCapabilityDetector] Enhanced detection completed in",`${a.toFixed(1)}ms`,`
Spicetify Profile:`,this.deviceCapabilities.spicetifyProfile),this.config.enableDebug&&console.log("\u{1F4CA} [DeviceCapabilityDetector] Capabilities detected:",this.deviceCapabilities),this.deviceCapabilities}getSpicetifyProfile(){return this.deviceCapabilities?.spicetifyProfile||null}getRecommendedQualityLevel(){return this.deviceCapabilities?.spicetifyProfile?.recommendedQualityLevel||50}async _analyzeMemoryCapabilities(){let t=navigator.deviceMemory,e=typeof t=="number",i=t||this._estimateMemoryFromOtherSources(),a=performance.memory?.jsHeapSizeLimit||0,r=this._estimateAvailableMemory(),n=this.config.spicetifyContext?this._estimateSpicetifyOverhead():0,s=this._calculateMemoryScore(i,a,r);return{total:i,score:s,level:s>=7?"high":s>=4?"medium":"low",jsHeapSizeLimit:a,estimatedAvailable:r,spicetifyOverhead:n,confidenceLevel:e?.9:.6}}_detectMemoryLevel(){let t=navigator.deviceMemory||6;return t>=8?"high":t>=4?"medium":"low"}_estimateAvailableMemory(){return performance.memory?performance.memory.jsHeapSizeLimit-performance.memory.usedJSHeapSize:(navigator.deviceMemory||4)*1024*1024*1024*.7}async _analyzeCPUCapabilities(){let t=navigator.hardwareConcurrency||4,e=await this._benchmarkSingleThreadPerformance(),i=this._estimateThermalThrottlingRisk(t),a=this._calculateCPUScore(t,e);return{cores:t,score:a,level:a>=7?"high":a>=4?"medium":"low",singleThreadPerformance:e,thermalThrottlingRisk:i,confidenceLevel:t>1?.8:.5}}_detectCPULevel(){let t=navigator.hardwareConcurrency||4;return t>=8?"high":t>=4?"medium":"low"}_detectWebGLSupport(){try{let t=document.createElement("canvas");return!!(t.getContext("webgl")||t.getContext("experimental-webgl"))}catch{return!1}}_detectWebGL2Support(){try{return!!document.createElement("canvas").getContext("webgl2")}catch{return!1}}_getMaxTextureSize(){try{let t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");return e?e.getParameter(e.MAX_TEXTURE_SIZE):0}catch{return 0}}_getGPUVendor(){try{let t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");if(!e)return"unknown";let i=e.getExtension("WEBGL_debug_renderer_info");return i?e.getParameter(i.UNMASKED_VENDOR_WEBGL):"unknown"}catch{return"unknown"}}_getGPURenderer(){try{let t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");if(!e)return"unknown";let i=e.getExtension("WEBGL_debug_renderer_info");return i?e.getParameter(i.UNMASKED_RENDERER_WEBGL):"unknown"}catch{return"unknown"}}async _analyzeGPUCapabilities(){let t=this._detectWebGLSupport(),e=this._detectWebGL2Support(),i=this._getMaxTextureSize(),a=this._getGPUVendor(),r=this._getGPURenderer(),n=await this._benchmarkWebGLCapabilities(),s=this._calculateGPUScore(r,n,e,i);return{supportsWebGL:t,supportsWebGL2:e,maxTextureSize:i,score:s,level:s>=7?"high":s>=4?"medium":"low",vendor:a,renderer:r,webglCapabilityScore:n,confidenceLevel:t?.8:.3}}_detectGPULevel(){let t=this._getGPURenderer().toLowerCase();return/rtx|radeon rx|gtx 16|gtx 20|apple m[1-9]|iris xe/.test(t)?"high":/gtx|radeon|intel iris|intel uhd|vega|ryzen/.test(t)?"medium":"low"}_detectOffscreenCanvasSupport(){return typeof OffscreenCanvas<"u"}_detectWorkerSupport(){return typeof Worker<"u"}_detectSharedArrayBufferSupport(){return typeof SharedArrayBuffer<"u"}_detectWASMSupport(){return typeof WebAssembly<"u"}_detectCSSHoudiniSupport(){return typeof CSS<"u"&&CSS.paintWorklet!==void 0}async _detectRefreshRate(){return new Promise(t=>{let e=performance.now(),i=0,a=[],r=()=>{let n=performance.now(),s=n-e;if(a.push(1e3/s),e=n,i++,i<10)requestAnimationFrame(r);else{let o=a.reduce((c,m)=>c+m,0)/a.length;t(Math.round(o))}};requestAnimationFrame(r)})}_detectColorGamut(){return window.matchMedia("(color-gamut: p3)").matches?"p3":window.matchMedia("(color-gamut: srgb)").matches?"srgb":"limited"}_detectContrastCapability(){return window.matchMedia("(dynamic-range: high)").matches||window.matchMedia("(contrast: high)").matches?"high":"standard"}_detectReducedMotion(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}async _runCapabilityTests(){this.deviceCapabilities&&(this.deviceCapabilities.gpu.stressTestScore=await this._runGPUStressTest(),this.deviceCapabilities.memory.stressTestScore=await this._runMemoryStressTest()),this.config.enableDebug&&console.log("\u26A1 [DeviceCapabilityDetector] Capability tests completed")}async _runGPUStressTest(){return 0}async _runMemoryStressTest(){return 0}_estimateMemoryFromOtherSources(){let t=navigator.hardwareConcurrency||4,e=window.screen,i=4;return t>=8?i=16:t>=6?i=12:t>=4?i=8:t>=2&&(i=6),e.width*e.height>2073600&&(i*=1.5),Math.round(i)}_estimateSpicetifyOverhead(){return this.config.spicetifyContext?.15:0}_calculateMemoryScore(t,e,i){let a=Math.min(t/2,10);if(e>0){let r=e/1073741824;a=Math.max(a,Math.min(r,10))}return this.config.spicetifyContext&&(a*=.85),Math.min(Math.max(a,1),10)}async _benchmarkSingleThreadPerformance(){let t="singleThreadPerf";return this.benchmarkCache.has(t)?this.benchmarkCache.get(t):new Promise(e=>{let i=performance.now(),a=0;for(let s=0;s<5e5;s++)a+=Math.sin(s)*Math.cos(s);let r=performance.now()-i,n=Math.max(1,Math.min(10,50/r));this.benchmarkCache.set(t,n),e(n)})}_estimateThermalThrottlingRisk(t){let e=/Mobi|Android/i.test(navigator.userAgent),i=.1;return t>=8&&(i+=.2),e&&(i+=.3),Math.min(i,1)}_calculateCPUScore(t,e){let i=Math.min(t/2,10),a=.7;return Math.min(i*(1-a)+e*a,10)}async _benchmarkWebGLCapabilities(){let t="webglCapability";if(this.benchmarkCache.has(t))return this.benchmarkCache.get(t);if(!this._detectWebGLSupport())return this.benchmarkCache.set(t,0),0;let e=document.createElement("canvas"),i=e.getContext("webgl2")||e.getContext("webgl");if(!i)return this.benchmarkCache.set(t,0),0;let a=2;i.getExtension("OES_texture_float")&&(a+=1),i.getExtension("WEBGL_depth_texture")&&(a+=1),i.getExtension("OES_element_index_uint")&&(a+=1);let r=i.getParameter(i.MAX_TEXTURE_SIZE);return r>=4096?a+=2:r>=2048&&(a+=1),i.getParameter(i.MAX_VERTEX_ATTRIBS)>=16&&(a+=1),i instanceof WebGL2RenderingContext&&(a+=2),this.benchmarkCache.set(t,Math.min(a,10)),Math.min(a,10)}_calculateGPUScore(t,e,i,a){let r=e,n=t.toLowerCase();return/rtx|radeon rx|apple m[1-9]|arc a/.test(n)?r+=2:/gtx|radeon|vega|iris xe|ryzen/.test(n)?r+=1:/intel|qualcomm|mali|adreno/.test(n)&&(r+=.5),Math.min(Math.max(r,1),10)}async _createSpicetifyProfile(t,e,i){let a=t.score,r=e.score,n=i.score,s=Math.round((a*.3+r*.4+n*.3)*10),o=Math.min(s,100);this.config.spicetifyContext&&(o*=1-t.spicetifyOverhead),o=Math.max(o,20);let c=(t.confidenceLevel+e.confidenceLevel+i.confidenceLevel)/3;return{memoryScore:a,cpuScore:r,gpuScore:n,compositeScore:s,spicetifyOverhead:t.spicetifyOverhead,userQualityPreference:"auto",confidenceLevel:c,recommendedQualityLevel:Math.round(o)}}_calculateOverallPerformanceLevel(){if(!this.deviceCapabilities)return"low";let t=this.deviceCapabilities.spicetifyProfile.compositeScore,e=this.deviceCapabilities.spicetifyProfile.confidenceLevel,i=t*(.7+e*.3);return i>=70?"high":i>=40?"medium":"low"}getCapabilities(){return this.isInitialized?this.deviceCapabilities:(console.warn("[DeviceCapabilityDetector] Not initialized - call initialize() first"),null)}hasWebGLSupport(){return this.isInitialized&&this.deviceCapabilities?this.deviceCapabilities.gpu.supportsWebGL:this._detectWebGLSupport()}hasWebGL2Support(){return this.isInitialized&&this.deviceCapabilities?this.deviceCapabilities.gpu.supportsWebGL2:this._detectWebGL2Support()}destroy(){this.deviceCapabilities=null,this.isInitialized=!1,this.config.enableDebug&&console.log("\u{1F50D} [DeviceCapabilityDetector] Destroyed")}recommendPerformanceQuality(){if(!this.isInitialized||!this.deviceCapabilities)return"balanced";switch(this.deviceCapabilities.overall){case"high":return"high";case"medium":return"balanced";case"low":default:return"low"}}static detectTier(){let t=this._analyzeBasicCapabilities(),e=[],i="medium",a=.8;this._isHighTierDevice(t,e)?(i="high",a=.9):this._isLowTierDevice(t,e)?(i="low",a=.85):(e.push("Standard modern device - full experience enabled"),e.push(`${t.memory}GB RAM, ${t.cores} cores, WebGL2: ${t.webgl2}`));let r={tier:i,confidence:a,reasoning:e,capabilities:t};return console.log("\u{1F50D} [DeviceCapabilityDetector] Enhanced tier detection complete",r),r}static _analyzeBasicCapabilities(){let t=navigator.deviceMemory||this._estimateMemory(),e=navigator.hardwareConcurrency||this._estimateCores(),i=this._checkWebGLSupport(),a=this._checkWebGL2Support(),r=navigator.userAgent,n=navigator.platform||"unknown";return{memory:t,cores:e,webgl:i,webgl2:a,userAgent:r,platform:n,hardwareInfo:{isHighEnd:this._detectHighEndHardware(t,e,r),isMobile:this._isMobileDevice(r,n),isOldDevice:this._isOldDevice(r),hasPerformanceIndicators:this._hasPerformanceIndicators(r)}}}static _isHighTierDevice(t,e){let{memory:i,cores:a,webgl2:r,hardwareInfo:n}=t;if(!(i>=8&&a>=6&&r))return!1;let o=[];return i>=16&&o.push("16+GB RAM"),a>=8&&o.push("8+ CPU cores"),n.hasPerformanceIndicators&&o.push("Performance GPU detected"),n.isHighEnd&&o.push("High-end hardware signatures"),o.length>=2?(e.push("High-end device detected"),e.push(`Specs: ${i}GB RAM, ${a} cores, WebGL2: ${r}`),e.push(`Indicators: ${o.join(", ")}`),!0):this._isGamingOrWorkstation(t)?(e.push("Gaming/workstation device detected"),e.push("High-performance device indicators found"),!0):!1}static _isLowTierDevice(t,e){let{memory:i,cores:a,webgl2:r,hardwareInfo:n}=t,s=[];return i<4&&s.push(`Low memory: ${i}GB`),a<4&&s.push(`Few CPU cores: ${a}`),r||s.push("No WebGL2 support"),n.isOldDevice&&s.push("Legacy device detected"),n.isMobile&&i<=4&&a<=4&&s.push("Resource-constrained mobile device"),s.length>=2?(e.push("Budget/legacy device detected - enabling performance optimizations"),e.push(...s),!0):!1}static _estimateMemory(){let t=navigator.userAgent.toLowerCase();return t.includes("mobile")||t.includes("android")?4:t.includes("ipad")||t.includes("tablet")?6:8}static _estimateCores(){return navigator.userAgent.toLowerCase().includes("mobile"),4}static _checkWebGLSupport(){try{let t=document.createElement("canvas"),i=(t.getContext("webgl")||t.getContext("experimental-webgl"))!==null;return t.remove(),i}catch{return!1}}static _checkWebGL2Support(){try{let t=document.createElement("canvas"),i=t.getContext("webgl2")!==null;return t.remove(),i}catch{return!1}}static _detectHighEndHardware(t,e,i){let a=i.toLowerCase();return[a.includes("gaming"),a.includes("nvidia"),a.includes("amd"),a.includes("geforce"),a.includes("radeon"),t>=16,e>=8].filter(Boolean).length>=2}static _isMobileDevice(t,e){let i=t.toLowerCase(),a=e.toLowerCase();return i.includes("mobile")||i.includes("android")||i.includes("iphone")||i.includes("ipad")||a.includes("arm")||"ontouchstart"in window}static _isOldDevice(t){let e=t.toLowerCase();return[/chrome\/[1-6]\d\./,/firefox\/[1-5]\d\./,/safari\/[1-9]\./,/msie|trident/].some(a=>a.test(e))}static _hasPerformanceIndicators(t){let e=t.toLowerCase();return["nvidia","amd","geforce","radeon","quadro","gaming","performance"].some(a=>e.includes(a))}static _isGamingOrWorkstation(t){let{userAgent:e,memory:i,cores:a}=t,r=e.toLowerCase();return[r.includes("gaming"),r.includes("nvidia"),r.includes("geforce"),r.includes("rog"),r.includes("alienware"),i>=16&&a>=8].filter(Boolean).length>=2}}});var de,Si=y(()=>{"use strict";oe();A();de=class{static detectTier(){typeof process<"u";let t=O.detectTier();return u?.debug?.log("EnhancedDeviceTierDetector","Compatibility layer - delegating to DeviceCapabilityDetector",t),t}static _analyzeDeviceCapabilities(){let t=navigator.deviceMemory||this._estimateMemory(),e=navigator.hardwareConcurrency||this._estimateCores(),i=this._checkWebGLSupport(),a=this._checkWebGL2Support(),r=navigator.userAgent,n=navigator.platform||"unknown";return{memory:t,cores:e,webgl:i,webgl2:a,userAgent:r,platform:n,hardwareInfo:{isHighEnd:this._detectHighEndHardware(t,e,r),isMobile:this._isMobileDevice(r,n),isOldDevice:this._isOldDevice(r),hasPerformanceIndicators:this._hasPerformanceIndicators(r)}}}static _estimateMemory(){let t=navigator.userAgent.toLowerCase();return t.includes("mobile")||t.includes("android")?4:t.includes("ipad")||t.includes("tablet")?6:8}static _estimateCores(){return navigator.userAgent.toLowerCase().includes("mobile"),4}static _checkWebGLSupport(){try{let t=document.createElement("canvas"),i=(t.getContext("webgl")||t.getContext("experimental-webgl"))!==null;return t.remove(),i}catch{return!1}}static _checkWebGL2Support(){try{let t=document.createElement("canvas"),i=t.getContext("webgl2")!==null;return t.remove(),i}catch{return!1}}static _detectHighEndHardware(t,e,i){let a=i.toLowerCase();return[a.includes("gaming"),a.includes("nvidia"),a.includes("amd"),a.includes("geforce"),a.includes("radeon"),t>=16,e>=8].filter(Boolean).length>=2}static _isMobileDevice(t,e){let i=t.toLowerCase(),a=e.toLowerCase();return i.includes("mobile")||i.includes("android")||i.includes("iphone")||i.includes("ipad")||a.includes("arm")||"ontouchstart"in window}static _isOldDevice(t){let e=t.toLowerCase();return[/chrome\/[1-6]\d\./,/firefox\/[1-5]\d\./,/safari\/[1-9]\./,/msie|trident/].some(a=>a.test(e))}static _hasPerformanceIndicators(t){let e=t.toLowerCase();return["nvidia","amd","geforce","radeon","quadro","gaming","performance"].some(a=>e.includes(a))}static getDeviceDescription(t){typeof process<"u";let{memory:e,cores:i,platform:a,hardwareInfo:r}=t,n=r.isMobile?"Mobile":"Desktop",s=[];return r.isHighEnd&&s.push("High-End"),r.isOldDevice&&s.push("Legacy"),`${n} Device (${e}GB RAM, ${i} cores, ${a})${s.length?` [${s.join(", ")}]`:""}`}}});var vi,Wn=y(()=>{"use strict";Si();k();A();vi=class{constructor(t){this.initialized=!1;this.webglIntegration=null;this.deviceTier="medium";this.tierDetectionResult=null;this.energyBoostActive=!1;this.energyBoostTimeout=null;this.tierSettings={low:{webglQuality:"low",animationDensity:.6,updateFrequency:45,particleMultiplier:.4,corridorEffects:!1,advancedFeatures:!1,experimentalFeatures:!1},medium:{webglQuality:"high",animationDensity:.9,updateFrequency:60,particleMultiplier:1,corridorEffects:!0,advancedFeatures:!0,experimentalFeatures:!1},high:{webglQuality:"high",animationDensity:1,updateFrequency:60,particleMultiplier:1.2,corridorEffects:!0,advancedFeatures:!0,experimentalFeatures:!0}};this.energyBoostSettings={animationBoost:1.3,particleBoost:1.5,duration:1e4};this.enhancedDeviceTierDetector=t,this.currentSettings=this.tierSettings.medium,u?.debug?.log("SimpleTierBasedPerformanceSystem","Initialized with tier-based performance management")}async initialize(){this.initialized||(this.tierDetectionResult=de.detectTier(),this.deviceTier=this.tierDetectionResult.tier,this.currentSettings=this.tierSettings[this.deviceTier],this._setupMusicAnalysisListener(),this._applyTierSettings(),this.initialized=!0,u?.debug?.log("SimpleTierBasedPerformanceSystem","Initialization complete",{deviceTier:this.deviceTier,confidence:this.tierDetectionResult.confidence,reasoning:this.tierDetectionResult.reasoning,deviceDescription:de.getDeviceDescription(this.tierDetectionResult.capabilities),settings:this.currentSettings}))}async healthCheck(){return this.initialized?{healthy:!0,details:`Performance tier: ${this.deviceTier}, Energy boost: ${this.energyBoostActive?"active":"inactive"}`,system:"SimpleTierBasedPerformanceSystem"}:{healthy:!1,details:"Not initialized",system:"SimpleTierBasedPerformanceSystem"}}destroy(){this.energyBoostTimeout&&(clearTimeout(this.energyBoostTimeout),this.energyBoostTimeout=null),p.unsubscribe("colors:extracted"),p.unsubscribe("music:track-changed"),this.initialized=!1,u?.debug?.log("SimpleTierBasedPerformanceSystem","Destroyed")}updateAnimation(t){}registerWebGLIntegration(t){this.webglIntegration=t,this.initialized&&this._applyWebGLSettings(),u?.debug?.log("SimpleTierBasedPerformanceSystem","WebGL integration registered")}getDeviceTier(){return this.deviceTier}getTierDetectionResult(){return this.tierDetectionResult}getDeviceDescription(){return this.tierDetectionResult?de.getDeviceDescription(this.tierDetectionResult.capabilities):"Unknown device"}getCurrentSettings(){return{...this.currentSettings}}hasEnergyBoost(){return this.energyBoostActive}getEffectiveSettings(){let t={...this.currentSettings};return this.energyBoostActive?{...t,animationDensity:Math.min(1,t.animationDensity*this.energyBoostSettings.animationBoost),particleMultiplier:t.particleMultiplier*this.energyBoostSettings.particleBoost,energyBoosted:!0}:{...t,energyBoosted:!1}}setTier(t){this.deviceTier=t,this.currentSettings=this.tierSettings[t],this._applyTierSettings(),u?.debug?.log("SimpleTierBasedPerformanceSystem",`Tier manually set to ${t}`)}_setupMusicAnalysisListener(){p.subscribe("colors:extracted",t=>{t.musicData&&this._handleMusicAnalysis({energy:t.musicData.energy||.5,valence:t.musicData.valence||.5,bpm:t.musicData.tempo||120,genre:t.musicData.genre||"unknown"})}),p.subscribe("music:track-changed",t=>{this._handleSongChange(t)})}_handleSongChange(t){t.analysis&&this._checkEnergyBoost(t.analysis)}_handleMusicAnalysis(t){this._checkEnergyBoost(t)}_checkEnergyBoost(t){let e=t.energy>.7&&t.bpm>130&&(t.danceability||0)>.6,i=e&&!this.energyBoostActive,a=!e&&this.energyBoostActive;i?this._activateEnergyBoost(t):a&&this._deactivateEnergyBoost()}_activateEnergyBoost(t){this.energyBoostActive=!0,this.energyBoostTimeout&&clearTimeout(this.energyBoostTimeout),this._applyTierSettings(),this.energyBoostTimeout=window.setTimeout(()=>{this._deactivateEnergyBoost()},this.energyBoostSettings.duration),p.emit("performance:tier-changed",{tier:this.deviceTier,previousTier:this.deviceTier,timestamp:Date.now()}),u?.debug?.log("SimpleTierBasedPerformanceSystem","Energy boost activated",{bpm:t.bpm,energy:t.energy,danceability:t.danceability})}_deactivateEnergyBoost(){this.energyBoostActive&&(this.energyBoostActive=!1,this.energyBoostTimeout&&(clearTimeout(this.energyBoostTimeout),this.energyBoostTimeout=null),this._applyTierSettings(),p.emit("performance:tier-changed",{tier:this.deviceTier,previousTier:this.deviceTier,timestamp:Date.now()}),u?.debug?.log("SimpleTierBasedPerformanceSystem","Energy boost deactivated"))}_applyTierSettings(){this._applyWebGLSettings(),this._applySystemSettings();let t=this.getEffectiveSettings();p.emit("performance:tier-changed",{tier:this.deviceTier,previousTier:this.deviceTier,timestamp:Date.now()})}_applyWebGLSettings(){if(!this.webglIntegration)return;let t=this.getEffectiveSettings();this.webglIntegration.setQuality(t.webglQuality),u?.debug?.log("SimpleTierBasedPerformanceSystem","WebGL settings applied",{tier:this.deviceTier,quality:t.webglQuality,energyBoosted:t.energyBoosted})}_applySystemSettings(){let t=this.getEffectiveSettings();p.emit("performance:frame",{deltaTime:16,fps:t.updateFrequency,memoryUsage:.5,timestamp:Date.now()})}}});var Ci,qn=y(()=>{"use strict";A();k();Ci=class{constructor(t){this.initialized=!1;this.currentState="disabled";this.webglSystems=new Map;this.lastStateChange=0;this.stateChangeHistory=[];this.userExplicitlyDisabled=!1;this.userExplicitQuality=null;this.deviceCapabilities=t,this.config={enabled:!0,quality:"medium",forceEnabled:!1,allowPerformanceAdjustment:!0},u?.debug?.log("UnifiedWebGLController","Initialized with unified WebGL management")}async initialize(){this.initialized||(this.deviceCapabilities.isInitialized||await this.deviceCapabilities.initialize(),await this._loadSettings(),await this._determineInitialState(),this._setupEventListeners(),this._applyStateToAllSystems(),this.initialized=!0,u?.debug?.log("UnifiedWebGLController","Initialization complete",{state:this.currentState,quality:this.config.quality,systemCount:this.webglSystems.size}))}async healthCheck(){if(!this.initialized)return{healthy:!1,details:"Not initialized",system:"UnifiedWebGLController"};let t=[];for(let[i,a]of this.webglSystems)if(a.system.healthCheck)try{let r=await a.system.healthCheck();r.healthy||t.push(`${i}: ${r.details||"unhealthy"}`)}catch{t.push(`${i}: health check failed`)}let e=this.stateChangeHistory.filter(i=>Date.now()-i.timestamp<3e4).length;return t.length>0||e>3?{healthy:!0,details:`Issues detected: ${t.join(", ")}`,issues:t,system:"UnifiedWebGLController"}:{healthy:!0,details:"All WebGL systems operating normally",system:"UnifiedWebGLController"}}destroy(){this._setState("disabled"),this.webglSystems.clear(),p.unsubscribe("settings:changed"),p.unsubscribe("system:state-changed"),this.initialized=!1,u?.debug?.log("UnifiedWebGLController","Destroyed - all WebGL systems disabled")}updateAnimation(t){if(this.currentState==="webgl-active"){for(let[e,i]of this.webglSystems)if(i.system.updateAnimation)try{i.system.updateAnimation(t)}catch(a){u?.debug?.warn("UnifiedWebGLController",`Animation update failed for ${e}:`,a)}}}enable(){this.userExplicitlyDisabled=!1,this.config.enabled=!0,this._determineAndApplyState(),this._saveSettings(),u?.debug?.log("UnifiedWebGLController","WebGL enabled by user")}disable(){this.userExplicitlyDisabled=!0,this.config.enabled=!1,this._setState("css-fallback"),this._saveSettings(),u?.debug?.log("UnifiedWebGLController","WebGL disabled by user")}setQuality(t){this.userExplicitQuality=t,this.config.quality=t,this._applyQualityToAllSystems(),this._saveSettings(),u?.debug?.log("UnifiedWebGLController",`Quality set to ${t} by user`)}isEnabled(){return this.currentState==="webgl-active"}isAvailable(){return this.deviceCapabilities.getSpicetifyProfile()?.webglCapabilities?.available||!1}getState(){return this.currentState}getQuality(){return this.config.quality}forceEnable(t=!0){this.config.forceEnabled=t,this._determineAndApplyState(),this._saveSettings(),u?.debug?.log("UnifiedWebGLController",`Force enable set to ${t}`)}registerSystem(t,e,i=0){this.webglSystems.set(t,{system:e,name:t,priority:i}),this.initialized&&this._applyStateToSystem(t,e),u?.debug?.log("UnifiedWebGLController",`System registered: ${t} (priority: ${i})`)}unregisterSystem(t){let e=this.webglSystems.get(t);e&&(e.system.setEnabled&&e.system.setEnabled(!1),this.webglSystems.delete(t),u?.debug?.log("UnifiedWebGLController",`System unregistered: ${t}`))}suggestQualityAdjustment(t,e){if(!this.config.allowPerformanceAdjustment){u?.debug?.log("UnifiedWebGLController",`Performance adjustment ignored (not allowed): ${e}`);return}if(this.userExplicitQuality!==null){u?.debug?.log("UnifiedWebGLController",`Performance adjustment ignored (user set explicit quality): ${e}`);return}if(this.config.quality!==t){let i=this.config.quality;this.config.quality=t,this._applyQualityToAllSystems(),u?.debug?.log("UnifiedWebGLController",`Quality adjusted by performance system: ${i} \u2192 ${t} (${e})`)}}performanceDisable(t){!this.config.allowPerformanceAdjustment||this.userExplicitlyDisabled===!1||this.currentState==="webgl-active"&&(this._setState("css-fallback"),u?.debug?.log("UnifiedWebGLController",`WebGL disabled by performance system: ${t}`))}performanceEnable(t){!this.config.allowPerformanceAdjustment||this.userExplicitlyDisabled||this.currentState==="css-fallback"&&this.config.enabled&&(this._determineAndApplyState(),u?.debug?.log("UnifiedWebGLController",`WebGL re-enabled by performance system: ${t}`))}async _loadSettings(){try{let t=localStorage.getItem("sn-webgl-enabled"),e=localStorage.getItem("sn-webgl-quality"),i=localStorage.getItem("sn-webgl-force-enabled");t!==null&&(this.config.enabled=t==="true",t==="false"&&(this.userExplicitlyDisabled=!0)),e&&["low","medium","high"].includes(e)&&(this.config.quality=e,this.userExplicitQuality=e),i!==null&&(this.config.forceEnabled=i==="true"),u?.debug?.log("UnifiedWebGLController","Settings loaded",this.config)}catch(t){u?.debug?.warn("UnifiedWebGLController","Failed to load settings:",t)}}_saveSettings(){try{localStorage.setItem("sn-webgl-enabled",this.config.enabled.toString()),localStorage.setItem("sn-webgl-quality",this.config.quality),localStorage.setItem("sn-webgl-force-enabled",this.config.forceEnabled.toString())}catch(t){u?.debug?.warn("UnifiedWebGLController","Failed to save settings:",t)}}async _determineInitialState(){if(!this.config.enabled||this.userExplicitlyDisabled){this._setState("css-fallback");return}this.config.forceEnabled||this.isAvailable()?this._setState("webgl-active"):this._setState("css-fallback")}_determineAndApplyState(){!this.config.enabled||this.userExplicitlyDisabled?this._setState("css-fallback"):this.config.forceEnabled||this.isAvailable()?this._setState("webgl-active"):this._setState("css-fallback")}_setState(t){if(this.currentState===t)return;let e=this.currentState;this.currentState=t,this.lastStateChange=Date.now(),this.stateChangeHistory.push({state:t,quality:this.config.quality,timestamp:this.lastStateChange}),this.stateChangeHistory.length>20&&(this.stateChangeHistory=this.stateChangeHistory.slice(-20)),this._applyStateToAllSystems(),p.emit("performance:tier-changed",{tier:t,previousTier:e,timestamp:this.lastStateChange}),u?.debug?.log("UnifiedWebGLController",`State changed: ${e} \u2192 ${t}`)}_applyStateToAllSystems(){let t=Array.from(this.webglSystems.entries()).sort(([,e],[,i])=>i.priority-e.priority);for(let[e,i]of t)this._applyStateToSystem(e,i.system)}_applyStateToSystem(t,e){try{let i=this.currentState==="webgl-active";if(e.setEnabled&&e.setEnabled(i),i&&e.setQuality&&e.setQuality(this.config.quality),t==="corridor-effects"&&e.setEnabled){let a=i&&(this.config.quality==="medium"||this.config.quality==="high");e.setEnabled(a)}}catch(i){u?.debug?.warn("UnifiedWebGLController",`Failed to apply state to ${t}:`,i)}}_applyQualityToAllSystems(){if(this.currentState==="webgl-active"){for(let[t,e]of this.webglSystems)try{if(e.system.setQuality&&e.system.setQuality(this.config.quality),t==="corridor-effects"){let i=this.config.quality==="medium"||this.config.quality==="high";e.system.setEnabled&&e.system.setEnabled(i)}}catch(i){u?.debug?.warn("UnifiedWebGLController",`Failed to apply quality to ${t}:`,i)}p.emit("performance:tier-changed",{tier:this.config.quality,previousTier:this.config.quality,timestamp:Date.now()})}}_setupEventListeners(){p.subscribe("settings:changed",t=>{t.settingKey==="sn-webgl-enabled"?(this.config.enabled=t.newValue==="true",this.userExplicitlyDisabled=t.newValue==="false",this._determineAndApplyState()):t.settingKey==="sn-webgl-quality"?this.setQuality(t.newValue):t.settingKey==="sn-webgl-force-enabled"&&(this.config.forceEnabled=t.newValue==="true",this._determineAndApplyState())}),p.subscribe("performance:tier-changed",t=>{let e=t.tier==="excellent"?"high":t.tier==="good"?"medium":"low";e!==this.config.quality&&this.setQuality(e)})}}});var Ei,Yn=y(()=>{"use strict";Ei=class{static getAnimationDensity(t){switch(t){case"low":return .3;case"medium":return .7;case"high":return 1}}static getUpdateFrequency(t){switch(t){case"low":return 30;case"medium":return 45;case"high":return 60}}static getShaderComplexity(t){switch(t){case"low":return .4;case"medium":return .7;case"high":return 1}}static getParticleMultiplier(t){switch(t){case"low":return .3;case"medium":return .6;case"high":return 1}}static shouldEnableCorridorEffects(t){return t==="medium"||t==="high"}static shouldEnableAdvancedFeatures(t){return t==="high"}static getBlendMode(t){switch(t){case"low":return"normal";case"medium":return"screen";case"high":return"screen"}}static getFrameThrottling(t){switch(t){case"low":return 33;case"medium":return 22;case"high":return 16}}}});var Mi,jn=y(()=>{"use strict";Yn();A();Mi=class{constructor(t){this.enabled=!1;this.quality="medium";this.system=t,u?.debug?.log("WebGLGradientAdapter","Created adapter for WebGL gradient system")}setEnabled(t){this.enabled!==t&&(this.enabled=t,t?this._enableSystem():this._disableSystem(),u?.debug?.log("WebGLGradientAdapter",`WebGL gradient ${t?"enabled":"disabled"}`))}setQuality(t){this.quality!==t&&(this.quality=t,this.enabled&&this._applyQualitySettings(),u?.debug?.log("WebGLGradientAdapter",`Quality set to ${t}`))}isEnabled(){return this.enabled}isCapable(){return this._checkWebGLCapability()}getQuality(){return this.quality}getSystemName(){return"WebGL Gradient Background"}_enableSystem(){try{let t=this._mapQualityToIntensity(this.quality);this.system.settingsManager&&(this.system.settingsManager.set("sn-gradient-intensity",t),this.system.settingsManager.set("sn-webgl-enabled","true")),this.system.initialized||this.system.initialize(),this._applyQualitySettings()}catch(t){u?.debug?.warn("WebGLGradientAdapter","Failed to enable system:",t)}}_disableSystem(){try{this.system.settingsManager&&this.system.settingsManager.set("sn-gradient-intensity","disabled"),typeof this.system.disable=="function"?this.system.disable():typeof this.system.destroy=="function"&&this.system.destroy()}catch(t){u?.debug?.warn("WebGLGradientAdapter","Failed to disable system:",t)}}_applyQualitySettings(){try{let t=this.system.settings;if(!t)return;t.flowStrength=this._getFlowStrength(this.quality),t.noiseScale=this._getNoiseScale(this.quality),t.corridorIntensity=this._getColorIntensity(this.quality);let e=Ei.getUpdateFrequency(this.quality);this.system.updateFrequency!==void 0&&(this.system.updateFrequency=e),typeof this.system.forceRepaint=="function"&&this.system.forceRepaint(`quality-change-${this.quality}`)}catch(t){u?.debug?.warn("WebGLGradientAdapter","Failed to apply quality settings:",t)}}_mapQualityToIntensity(t){switch(t){case"low":return"minimal";case"medium":return"balanced";case"high":return"intense";default:return"balanced"}}_getFlowStrength(t){switch(t){case"low":return .3;case"medium":return .7;case"high":return 1;default:return .7}}_getAnimationSpeed(t){switch(t){case"low":return .5;case"medium":return .8;case"high":return 1.2;default:return .8}}_getNoiseScale(t){switch(t){case"low":return 1.5;case"medium":return 2;case"high":return 2.8;default:return 2}}_getColorIntensity(t){switch(t){case"low":return .6;case"medium":return .8;case"high":return 1;default:return .8}}_checkWebGLCapability(){try{let t=document.createElement("canvas"),e=t.getContext("webgl2")||t.getContext("webgl");return t.remove(),e!==null}catch{return!1}}}});var nt,Xa=y(()=>{"use strict";qn();jn();A();nt=class{constructor(t){this.initialized=!1;this.webglGradientSystem=null;this.webglGradientAdapter=null;this.controller=new Ci(t),u?.debug?.log("WebGLSystemsIntegration","Created WebGL systems integration")}async initialize(){this.initialized||(await this.controller.initialize(),await this._registerWebGLSystems(),this.initialized=!0,u?.debug?.log("WebGLSystemsIntegration","Integration initialized",{controllerState:this.controller.getState(),quality:this.controller.getQuality(),registeredSystems:this._getRegisteredSystemNames()}))}async healthCheck(){if(!this.initialized)return{healthy:!1,details:"Not initialized",system:"WebGLSystemsIntegration"};let t=await this.controller.healthCheck();if(!t.healthy)return{healthy:!1,details:`Controller unhealthy: ${t.details}`,system:"WebGLSystemsIntegration"};let e=[];if(this.webglGradientSystem)try{let i=await this.webglGradientSystem.healthCheck();i.ok||e.push(`WebGL Gradient: ${i.details}`)}catch{e.push("WebGL Gradient: health check failed")}return{healthy:!0,details:e.length>0?`Some system issues: ${e.join(", ")}`:"All WebGL systems healthy",issues:e,system:"WebGLSystemsIntegration"}}destroy(){this.webglGradientSystem&&this.webglGradientSystem.destroy(),this.controller.destroy(),this.initialized=!1,u?.debug?.log("WebGLSystemsIntegration","Integration destroyed")}updateAnimation(t){this.initialized&&this.controller.updateAnimation(t)}getController(){return this.controller}enableWebGL(){this.controller.enable()}disableWebGL(){this.controller.disable()}setQuality(t){this.controller.setQuality(t)}isWebGLActive(){return this.controller.isEnabled()}getWebGLState(){return this.controller.getState()}getQuality(){return this.controller.getQuality()}handlePerformanceQualityAdjustment(t,e){this.controller.suggestQualityAdjustment(t,e)}handlePerformanceDisable(t){this.controller.performanceDisable(t)}handlePerformanceEnable(t){this.controller.performanceEnable(t)}setQualityFromTier(t){this.controller.setQuality(t),u?.debug?.log("WebGLSystemsIntegration",`Quality set from device tier: ${t}`)}async _registerWebGLSystems(){try{await this._registerWebGLGradientSystem(),u?.debug?.log("WebGLSystemsIntegration","All WebGL systems registered successfully")}catch(t){u?.debug?.warn("WebGLSystemsIntegration","Failed to register some WebGL systems:",t)}}async _registerWebGLGradientSystem(){try{let t=globalThis.year3000System;if(!t){u?.debug?.warn("WebGLSystemsIntegration","Year3000System not available");return}let e=["webglGradientBackgroundSystem","flowingLiquidConsciousnessSystem","webglBackgroundSystem"],i=null;for(let a of e)if(t[a]){i=t[a];break}if(!i){u?.debug?.warn("WebGLSystemsIntegration","WebGL gradient system not found in Year3000System");return}this.webglGradientSystem=i,this.webglGradientAdapter=new Mi(this.webglGradientSystem),this.controller.registerSystem("webgl-gradient-background",this.webglGradientAdapter,100),u?.debug?.log("WebGLSystemsIntegration","WebGL gradient system registered")}catch(t){u?.debug?.warn("WebGLSystemsIntegration","Failed to register WebGL gradient system:",t)}}_getRegisteredSystemNames(){let t=[];return this.webglGradientAdapter&&t.push("WebGL Gradient Background"),t}}});var Oe,Pe,wi=y(()=>{"use strict";Oe=class Oe{constructor(t={},e){this.cssVariableManager=null;this.optimizationLevel="none";this.disabledFeatures=new Set;this.config={budgets:{animationFrame:16.67,cssVariableUpdate:2,domObservation:5,audioAnalysis:10,visualEffects:8,userInteraction:100},autoOptimize:{enabled:!0,violationThreshold:5,recoveryThreshold:80},enableDebug:!1,...t},this.performanceAnalyzer=e,this.setupBudgetMonitoring()}static getInstance(t,e){return!Oe.instance&&e&&(Oe.instance=new Oe(t,e)),Oe.instance}registerUnifiedCSSVariableManager(t){this.cssVariableManager=t}setupBudgetMonitoring(){this.config.autoOptimize.enabled&&setInterval(()=>{this.checkBudgets()},5e3)}checkBudgets(){this.performanceAnalyzer.calculateHealthScore()>=this.config.autoOptimize.recoveryThreshold&&this.recoverOptimizations()}optimizeOperation(t){if(!this.disabledFeatures.has(t)){switch(t){case"cssVariableUpdate":this.optimizeCSSVariableUpdates();break;case"domObservation":this.optimizeDOMObservation();break;case"visualEffects":this.optimizeVisualEffects();break;case"audioAnalysis":this.optimizeAudioAnalysis();break}this.disabledFeatures.add(t),this.config.enableDebug&&console.log(`\u{1F3AF} [PerformanceBudgetManager] Optimized ${t} due to budget violations`)}}optimizeCSSVariableUpdates(){this.cssVariableManager&&this.cssVariableManager.updateConfig({batchIntervalMs:32,maxBatchSize:25})}optimizeDOMObservation(){document.dispatchEvent(new CustomEvent("year3000:optimize-dom-observation",{detail:{level:this.optimizationLevel}}))}optimizeVisualEffects(){document.dispatchEvent(new CustomEvent("year3000:optimize-visual-effects",{detail:{level:this.optimizationLevel}}))}optimizeAudioAnalysis(){document.dispatchEvent(new CustomEvent("year3000:optimize-audio-analysis",{detail:{level:this.optimizationLevel}}))}escalateOptimization(){this.optimizationLevel==="none"?this.optimizationLevel="conservative":this.optimizationLevel==="conservative"&&(this.optimizationLevel="aggressive"),this.config.enableDebug&&console.log(`\u{1F3AF} [PerformanceBudgetManager] Escalated to ${this.optimizationLevel} optimization`)}recoverOptimizations(){this.optimizationLevel!=="none"&&(this.disabledFeatures.clear(),this.cssVariableManager&&this.cssVariableManager.updateConfig({batchIntervalMs:16,maxBatchSize:50}),document.dispatchEvent(new CustomEvent("year3000:recover-optimizations",{detail:{previousLevel:this.optimizationLevel}})),this.optimizationLevel="none",this.config.enableDebug&&console.log("\u{1F3AF} [PerformanceBudgetManager] Recovered from optimizations"))}getOptimizationStatus(){return{level:this.optimizationLevel,disabledFeatures:Array.from(this.disabledFeatures),budgetViolations:[],healthScore:this.performanceAnalyzer.calculateHealthScore()}}manualOptimize(t){this.optimizeOperation(t)}manualRecover(){this.recoverOptimizations()}updateBudgets(t){this.config.budgets={...this.config.budgets,...t};for(let[e,i]of Object.entries(t))this.performanceAnalyzer.updateBudget(e,i)}destroy(){this.disabledFeatures.clear(),this.cssVariableManager=null,Oe.instance=null}};Oe.instance=null;Pe=Oe});var ae,st=y(()=>{"use strict";G();Z();Se();ae=class{constructor(t=M,e=ve,i=D){this.initialized=!1;this.initialized=!0,t?.enableDebug&&console.log("[SettingsManager] Initialized with new type-safe backend")}forceRepaint(t){typeof document<"u"&&(document.documentElement.style.display="none",document.documentElement.offsetHeight,document.documentElement.style.display="")}async initialize(){this.initialized=!0}async healthCheck(){return{healthy:this.initialized,system:"SettingsManager",details:this.initialized?"Settings manager operational":"Settings manager not initialized"}}updateAnimation(){}destroy(){this.initialized=!1}get(t){try{switch(t){case"artisticMode":return x.get("sn-artistic-mode");case"paletteSystem":return x.get("sn-palette-system");case"gradientIntensity":return x.get("sn-gradient-intensity");case"webglEnabled":return x.get("sn-webgl-enabled");case"animationQuality":return x.get("sn-animation-quality");default:return typeof t=="string"&&t.startsWith("sn-")?x.get(t):void 0}}catch(e){console.warn(`[SettingsManager] Failed to get setting ${String(t)}:`,e);return}}getAllowedValues(t){switch(t){case"artisticMode":return Object.keys(et);case"paletteSystem":return["catppuccin","year3000"];case"gradientIntensity":return["disabled","minimal","balanced","intense"];case"webglEnabled":return[!0,!1];case"animationQuality":return["auto","low","high"];default:return}}set(t,e){try{switch(t){case"artisticMode":return x.set("sn-artistic-mode",e);case"paletteSystem":return x.set("sn-palette-system",e);case"gradientIntensity":return x.set("sn-gradient-intensity",e);case"webglEnabled":return x.set("sn-webgl-enabled",!!e);case"animationQuality":return x.set("sn-animation-quality",e);default:return typeof t=="string"&&t.startsWith("sn-")?x.set(t,e):(console.warn(`[SettingsManager] Unknown setting key: ${String(t)}`),!1)}}catch(i){return console.warn(`[SettingsManager] Failed to set setting ${String(t)}:`,i),!1}}getAllSettings(){return{artisticMode:this.get("artisticMode")||"artist-vision",paletteSystem:this.get("paletteSystem")||"catppuccin",gradientIntensity:this.get("gradientIntensity")||"balanced",webglEnabled:this.get("webglEnabled")??!0,animationQuality:this.get("animationQuality")||"auto"}}validateAndRepair(){console.log("[SettingsManager] Settings validation handled by typed system")}resetAllToDefaults(){try{x.set("sn-artistic-mode","artist-vision"),x.set("sn-palette-system","catppuccin"),x.set("sn-gradient-intensity","balanced"),x.set("sn-webgl-enabled",!0),x.set("sn-animation-quality","auto"),console.log("[SettingsManager] Reset all settings to defaults")}catch(t){console.warn("[SettingsManager] Failed to reset settings:",t)}}getCurrentHarmonicMode(){let t=x.get("sn-artistic-mode")||"artist-vision",i={"artist-vision":"analogous-flow","cosmic-maximum":"triadic-balance","corporate-safe":"monochromatic-smooth"}[String(t)]||"analogous-flow";return ve[i]||ve["analogous-flow"]}getHarmonicMode(t){return ve[t]}}});var gt,Za=y(()=>{"use strict";U();A();Me();gt=class{constructor(t,e=null,i=null){this.musicSyncService=null;this.settingsManager=null;this.currentEmotionalProfile=null;this.emotionalHistory=[];this.maxHistorySize=50;this.isActive=!1;this.boundSpectralHandler=null;this.boundSettingsHandler=null;this.currentEmotionalTemperature=null;this.moodProfiles={euphoric:{hueShift:15,saturationMultiplier:1.3,brightnessMultiplier:1.2,contrastMultiplier:1.2,animationSpeed:1.5,pulseIntensity:.8,layerHarmony:.9,discordLevel:.1,transitionSpeed:.8},content:{hueShift:5,saturationMultiplier:1.1,brightnessMultiplier:1.1,contrastMultiplier:1,animationSpeed:.8,pulseIntensity:.4,layerHarmony:.95,discordLevel:.05,transitionSpeed:1.5},melancholic:{hueShift:-30,saturationMultiplier:.8,brightnessMultiplier:.8,contrastMultiplier:.9,animationSpeed:.6,pulseIntensity:.3,layerHarmony:.8,discordLevel:.2,transitionSpeed:2},aggressive:{hueShift:-15,saturationMultiplier:1.3,brightnessMultiplier:1.2,contrastMultiplier:1.5,animationSpeed:2,pulseIntensity:1,layerHarmony:.6,discordLevel:.4,transitionSpeed:.5},mysterious:{hueShift:-45,saturationMultiplier:.9,brightnessMultiplier:.8,contrastMultiplier:1.3,animationSpeed:.7,pulseIntensity:.6,layerHarmony:.7,discordLevel:.3,transitionSpeed:1.8},peaceful:{hueShift:25,saturationMultiplier:.8,brightnessMultiplier:1,contrastMultiplier:.9,animationSpeed:.5,pulseIntensity:.2,layerHarmony:1,discordLevel:0,transitionSpeed:3},dramatic:{hueShift:0,saturationMultiplier:1.3,brightnessMultiplier:1.1,contrastMultiplier:1.4,animationSpeed:1.2,pulseIntensity:.9,layerHarmony:.6,discordLevel:.4,transitionSpeed:.7},ambient:{hueShift:10,saturationMultiplier:.8,brightnessMultiplier:.9,contrastMultiplier:.8,animationSpeed:.3,pulseIntensity:.1,layerHarmony:.9,discordLevel:.1,transitionSpeed:4},chaotic:{hueShift:0,saturationMultiplier:1.3,brightnessMultiplier:1.2,contrastMultiplier:1.6,animationSpeed:2.5,pulseIntensity:.9,layerHarmony:.3,discordLevel:.7,transitionSpeed:.3},nostalgic:{hueShift:-10,saturationMultiplier:.8,brightnessMultiplier:.95,contrastMultiplier:.9,animationSpeed:.7,pulseIntensity:.4,layerHarmony:.85,discordLevel:.15,transitionSpeed:2.2},heroic:{hueShift:20,saturationMultiplier:1.2,brightnessMultiplier:1.2,contrastMultiplier:1.3,animationSpeed:1.3,pulseIntensity:.7,layerHarmony:.8,discordLevel:.2,transitionSpeed:1},contemplative:{hueShift:-5,saturationMultiplier:.9,brightnessMultiplier:1,contrastMultiplier:1.1,animationSpeed:.6,pulseIntensity:.3,layerHarmony:.8,discordLevel:.2,transitionSpeed:2.5},neutral:{hueShift:0,saturationMultiplier:1,brightnessMultiplier:1,contrastMultiplier:1,animationSpeed:1,pulseIntensity:.5,layerHarmony:.75,discordLevel:.25,transitionSpeed:1.5}};this.cssController=t||P(),this.musicSyncService=e,this.settingsManager=i,this.currentGradientState=this.createNeutralGradientState(),this.emotionalTemperatureMapper=new J(!0),this.moodToEmotionMap={euphoric:"energetic",content:"happy",melancholic:"melancholy",aggressive:"aggressive",mysterious:"mysterious",peaceful:"calm",dramatic:"epic",ambient:"ambient",chaotic:"aggressive",nostalgic:"melancholy",heroic:"epic",contemplative:"calm",neutral:"ambient"},this.boundSpectralHandler=this.handleSpectralData.bind(this),this.boundSettingsHandler=this.handleSettingsChange.bind(this)}async initialize(){this.boundSpectralHandler&&document.addEventListener("music-sync:data-updated",this.boundSpectralHandler),this.boundSettingsHandler&&document.addEventListener("year3000SystemSettingsChanged",this.boundSettingsHandler),this.isActive=!0,u?.debug?.log("EmotionalGradientMapper","Emotional mapping system initialized")}createNeutralGradientState(){return{hueShift:0,saturationMultiplier:1,brightnessMultiplier:1,contrastMultiplier:1,animationSpeed:1,pulseIntensity:.5,flowDirection:0,layerHarmony:.75,discordLevel:.25,depthPerception:.5,transitionSpeed:1.5,smoothing:.7,responsiveness:.8}}handleSpectralData(t){if(!this.isActive)return;let i=t.detail;if(!i)return;let a=this.analyzeEmotionalContent(i);try{let n={energy:a.energy,valence:a.valence,danceability:a.arousal,tempo:120,loudness:a.dynamics,acousticness:1-a.complexity,instrumentalness:.5,speechiness:.1,mode:a.mode==="major"?1:0,key:0,genre:this.inferGenreFromProfile(a)};this.currentEmotionalTemperature=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(n),this.applyEmotionalTemperatureToDocument(this.currentEmotionalTemperature),u?.debug?.log("EmotionalGradientMapper","\u{1F321}\uFE0F Applied emotional temperature:",{mood:a.mood,emotionalState:this.currentEmotionalTemperature.primaryEmotion,temperature:this.currentEmotionalTemperature.temperature,intensity:this.currentEmotionalTemperature.intensity})}catch(n){u?.debug?.warn("EmotionalGradientMapper","\u{1F321}\uFE0F Failed to apply emotional temperature:",n)}this.storeEmotionalHistory(a);let r=this.mapEmotionToGradient(a);this.currentGradientState=this.smoothGradientTransition(this.currentGradientState,r,a.stability),this.updateGradientVariables(),this.currentEmotionalProfile=a}analyzeEmotionalContent(t){let e=t.valence||.5,i=t.energy||.5,a=t.danceability||.5,r=this.calculateTension(t),n=this.detectMode(t),s=this.calculateDynamics(t),o=this.calculateComplexity(t),c=this.calculateStability(),m=this.calculatePredictability(),d=this.classifyMood(e,i,a,r,n),h=this.calculateMoodConfidence(e,i,a,r);return{valence:e,energy:i,arousal:a,tension:r,mode:n,dynamics:s,complexity:o,stability:c,predictability:m,mood:d,confidence:h}}calculateTension(t){let e=Math.abs((t.loudness||0)/-60),i=t.tempo?Math.min(1,(t.tempo-60)/140):.5,a=1-(t.acousticness||.5),r=t.speechiness||0;return Math.max(0,Math.min(1,e*.4+i*.3+a*.2+r*.1))}calculateDynamics(t){let e=Math.abs((t.loudness||0)/-60),i=t.energy||.5;return Math.max(0,Math.min(1,(e+i)/2))}calculateComplexity(t){let e=t.instrumentalness||.5,i=t.speechiness||0,a=1-(t.acousticness||.5);return Math.max(0,Math.min(1,(e+i+a)/3))}detectMode(t){if(typeof t.mode=="number")return t.mode===1?"major":"minor";let e=t.valence||.5,i=t.acousticness||.5;return e>.6&&i>.5?"major":e<.4||i<.3?"minor":"neutral"}calculateStability(){if(this.emotionalHistory.length<2)return .5;let t=Math.min(10,this.emotionalHistory.length),e=0;for(let i=1;i<t;i++){let a=this.emotionalHistory[this.emotionalHistory.length-i],r=this.emotionalHistory[this.emotionalHistory.length-i-1];a&&r&&(e+=Math.abs(a.valence-r.valence),e+=Math.abs(a.energy-r.energy),e+=Math.abs(a.arousal-r.arousal))}return Math.max(0,Math.min(1,1-e/(t*3)))}calculatePredictability(){if(this.emotionalHistory.length<5)return .5;let t=this.emotionalHistory.slice(-5),e=0;for(let i=1;i<t.length;i++){let a=t[i],r=t[i-1];if(a&&r){let n=a.valence-r.valence,s=a.energy-r.energy;Math.abs(n)<.1&&Math.abs(s)<.1&&e++}}return e/(t.length-1)}classifyMood(t,e,i,a,r){return t>.7&&e>.7?"euphoric":t>.7&&e<.3?"content":t<.3&&e<.3?"melancholic":t<.3&&e>.7?"aggressive":t<.4&&a>.6?"mysterious":t>.6&&a<.3?"peaceful":a>.7&&i>.6?"dramatic":e<.4&&i<.4?"ambient":a>.6&&e>.6?"chaotic":r==="minor"&&t>.3&&t<.7?"nostalgic":r==="major"&&e>.6&&t>.5?"heroic":i<.5&&t>.4&&t<.6?"contemplative":"neutral"}calculateMoodConfidence(t,e,i,a){let r=[t,e,i,a].map(n=>Math.abs(n-.5)*2);return r.reduce((n,s)=>n+s,0)/r.length}mapEmotionToGradient(t){let e=this.moodProfiles[t.mood],i={...this.createNeutralGradientState(),...e};return{...i,hueShift:i.hueShift+(t.valence-.5)*20,saturationMultiplier:i.saturationMultiplier*(.5+t.arousal*.5),brightnessMultiplier:i.brightnessMultiplier*(.7+t.energy*.6),contrastMultiplier:i.contrastMultiplier*(.6+t.tension*.8),animationSpeed:i.animationSpeed*(.3+t.energy*1.4),pulseIntensity:i.pulseIntensity*t.arousal,flowDirection:t.valence*360,layerHarmony:i.layerHarmony*(.3+t.stability*.7),discordLevel:i.discordLevel*(.1+t.tension*.9),depthPerception:.3+t.complexity*.7,transitionSpeed:i.transitionSpeed/(.5+t.predictability*1.5),smoothing:.4+t.stability*.6,responsiveness:.4+t.confidence*.6}}smoothGradientTransition(t,e,i){let a=.1+i*.4;return{hueShift:this.lerp(t.hueShift,e.hueShift,a),saturationMultiplier:this.lerp(t.saturationMultiplier,e.saturationMultiplier,a),brightnessMultiplier:this.lerp(t.brightnessMultiplier,e.brightnessMultiplier,a),contrastMultiplier:this.lerp(t.contrastMultiplier,e.contrastMultiplier,a),animationSpeed:this.lerp(t.animationSpeed,e.animationSpeed,a),pulseIntensity:this.lerp(t.pulseIntensity,e.pulseIntensity,a),flowDirection:this.lerp(t.flowDirection,e.flowDirection,a),layerHarmony:this.lerp(t.layerHarmony,e.layerHarmony,a),discordLevel:this.lerp(t.discordLevel,e.discordLevel,a),depthPerception:this.lerp(t.depthPerception,e.depthPerception,a),transitionSpeed:this.lerp(t.transitionSpeed,e.transitionSpeed,a*.5),smoothing:this.lerp(t.smoothing,e.smoothing,.1),responsiveness:this.lerp(t.responsiveness,e.responsiveness,.1)}}lerp(t,e,i){return t+(e-t)*Math.max(0,Math.min(1,i))}updateGradientVariables(){let t=this.currentGradientState,e={"--sn-emotional-hue-shift":`${t.hueShift}deg`,"--sn-emotional-saturation-multiplier":t.saturationMultiplier.toString(),"--sn-emotional-brightness-multiplier":t.brightnessMultiplier.toString(),"--sn-emotional-contrast-multiplier":t.contrastMultiplier.toString(),"--sn-emotional-animation-speed":t.animationSpeed.toString(),"--sn-emotional-pulse-intensity":t.pulseIntensity.toString(),"--sn-emotional-flow-direction":`${t.flowDirection}deg`,"--sn-emotional-layer-harmony":t.layerHarmony.toString(),"--sn-emotional-discord-level":t.discordLevel.toString(),"--sn-emotional-depth-perception":t.depthPerception.toString(),"--sn-emotional-transition-speed":t.transitionSpeed.toString()};if(this.cssController.batchSetVariables("EmotionalGradientMapper",e,"normal","emotional-gradient-mapping"),this.currentEmotionalTemperature){let i={...this.currentEmotionalTemperature.cssVariables,"--sn-emotional-temperature":this.currentEmotionalTemperature.temperature.toString(),"--sn-emotional-temperature-intensity":this.currentEmotionalTemperature.intensity.toString(),"--sn-emotional-temperature-class":this.currentEmotionalTemperature.cssClass,"--sn-emotional-temperature-blend":this.currentEmotionalTemperature.intensity.toString()};this.cssController.batchSetVariables("EmotionalGradientMapper",i,"high","emotional-temperature-mapping"),u?.debug?.log("EmotionalGradientMapper","\u{1F321}\uFE0F Applied temperature CSS variables:",{temperature:this.currentEmotionalTemperature.temperature,intensity:this.currentEmotionalTemperature.intensity,cssClass:this.currentEmotionalTemperature.cssClass,variableCount:Object.keys(this.currentEmotionalTemperature.cssVariables).length})}if(this.updateEmotionalGradientCoordination(t),this.currentEmotionalProfile){let i={"--sn-current-mood":this.currentEmotionalProfile.mood,"--sn-mood-confidence":this.currentEmotionalProfile.confidence.toString(),"--sn-emotional-valence":this.currentEmotionalProfile.valence.toString(),"--sn-emotional-energy":this.currentEmotionalProfile.energy.toString()};this.cssController.batchSetVariables("EmotionalGradientMapper",i,"normal","mood-state-tracking")}}updateEmotionalGradientCoordination(t){let e=getComputedStyle(document.documentElement),i=e.getPropertyValue("--sn-bg-gradient-primary").trim(),a=e.getPropertyValue("--sn-bg-gradient-secondary").trim(),r=e.getPropertyValue("--sn-bg-gradient-accent").trim();if(i||a||r){let n={"--sn-bg-gradient-flow-x":(t.flowDirection*.01).toString(),"--sn-bg-gradient-flow-y":(Math.sin(t.flowDirection*Math.PI/180)*.5).toString(),"--sn-bg-gradient-opacity":(.8*t.layerHarmony).toString(),"--sn-bg-gradient-blur":`${120*(1+t.depthPerception*.5)}px`,"--sn-bg-gradient-saturation":t.saturationMultiplier.toString(),"--sn-bg-gradient-brightness":t.brightnessMultiplier.toString(),"--sn-bg-gradient-contrast":t.contrastMultiplier.toString()};this.cssController.batchSetVariables("EmotionalGradientMapper",n,"normal","bg-gradient-coordination"),u?.debug?.log("EmotionalGradientMapper",`Coordinated emotional modifications with gradient system: flow=${t.flowDirection}\xB0, opacity=${.8*t.layerHarmony}`)}}storeEmotionalHistory(t){this.emotionalHistory.push(t),this.emotionalHistory.length>this.maxHistorySize&&this.emotionalHistory.shift()}handleSettingsChange(t){let e=t,{key:i,value:a}=e.detail;(i.startsWith("sn-emotional-")||i.startsWith("sn-gradient-"))&&u?.debug?.log("EmotionalGradientMapper","Settings changed, updating emotional sensitivity")}getCurrentEmotionalProfile(){return this.currentEmotionalProfile}getCurrentGradientState(){return{...this.currentGradientState}}getEmotionalHistory(){return[...this.emotionalHistory]}setMoodOverride(t,e=5e3){let i=this.moodProfiles[t];i&&(this.currentGradientState={...this.currentGradientState,...i},this.updateGradientVariables(),setTimeout(()=>{u?.debug?.log("EmotionalGradientMapper","Mood override expired, returning to automatic detection")},e))}applyEmotionalTemperatureToDocument(t){let e=Array.from(document.body.classList).filter(i=>i.startsWith("smooth-emotion-"));document.body.classList.remove(...e),document.body.classList.add(t.cssClass),t.secondaryEmotion&&document.body.classList.add(`smooth-emotion-blend-${t.secondaryEmotion}`),this.cssController.batchSetVariables("EmotionalGradientMapper",t.cssVariables,"high","emotional-temperature-document"),u?.debug?.log("EmotionalGradientMapper","\u{1F321}\uFE0F Applied emotional temperature to document:",{primaryClass:t.cssClass,secondaryEmotion:t.secondaryEmotion,cssVariableCount:Object.keys(t.cssVariables).length})}inferGenreFromProfile(t){let{mood:e,energy:i,valence:a,tension:r,arousal:n,mode:s}=t;return e==="aggressive"||i>.8&&a<.4?r>.7?"metal":"hard-rock":e==="euphoric"||i>.7&&a>.7?n>.8?"edm":"pop":e==="melancholic"||i<.4&&a<.4?s==="minor"?"blues":"folk":e==="peaceful"||i<.3&&a>.6?"ambient":e==="dramatic"||r>.6&&i>.5?"classical":e==="mysterious"||a<.5&&r>.5?"jazz":e==="heroic"||s==="major"&&i>.6?"soundtrack":"indie-pop"}getCurrentEmotionalTemperature(){return this.currentEmotionalTemperature}setEmotionalTemperatureOverride(t,e=1,i=5e3){try{let a={energy:e,valence:e>.5?.7:.3,genre:"override"},r=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(a);r.primaryEmotion=t,r.intensity=e,r.cssClass=`smooth-emotion-${t}`,this.currentEmotionalTemperature=r,this.applyEmotionalTemperatureToDocument(r),u?.debug?.log("EmotionalGradientMapper","\u{1F321}\uFE0F Applied emotional temperature override:",{emotion:t,intensity:e,duration:i}),setTimeout(()=>{u?.debug?.log("EmotionalGradientMapper","\u{1F321}\uFE0F Emotional temperature override expired")},i)}catch(a){u?.debug?.warn("EmotionalGradientMapper","\u{1F321}\uFE0F Failed to apply emotional temperature override:",a)}}destroy(){if(this.isActive=!1,this.boundSpectralHandler&&document.removeEventListener("music-sync:data-updated",this.boundSpectralHandler),this.boundSettingsHandler&&document.removeEventListener("year3000SystemSettingsChanged",this.boundSettingsHandler),this.currentEmotionalTemperature){let t=Array.from(document.body.classList).filter(e=>e.startsWith("smooth-emotion-"));document.body.classList.remove(...t)}this.emotionalHistory=[],this.currentEmotionalProfile=null,this.currentEmotionalTemperature=null,u?.debug?.log("EmotionalGradientMapper","Emotional mapping system destroyed")}}});var Ti,Kn=y(()=>{"use strict";G();U();A();ne();Ti=class extends N{constructor(e=M,i,a,r=null,n=null){super(e,i,a,r,n);this.colorHarmonyEngine=null;this.lastBeatTime=0;this.lastFlowUpdate=0;this.flowSmoothingBuffer=[];this.currentGenre=null;this.boundBeatHandler=null;this.boundGenreHandler=null;this.boundSpectralHandler=null;this.boundEnergyHandler=null;this.updateThrottleInterval=1e3/30;this.colorHarmonyEngine=null;let s=me.getGlobalInstance();s?this.cssVariableController=s:(u?.debug?.warn("GradientDirectionalFlowSystem","OptimizedCSSVariableManager not available, CSS integration disabled"),this.cssVariableController=null),this.flowSettings={enabled:!0,flowSensitivity:.8,beatResponseStrength:.9,genreAdaptation:!0,spectralSeparation:!0,smoothingFactor:.7,maxFlowIntensity:1,corridorFlowEnabled:!0,radialFlowStrength:.8,inwardFlowIntensity:.7,corridorBeatResponse:1.3},this.currentFlowVector={x:0,y:0,intensity:0,timestamp:performance.now()},this.currentRadialFlow={angle:0,radius:.5,intensity:0,inwardFlow:0,timestamp:performance.now()},this.genreFlowPatterns={electronic:{x:1,y:.2,intensity:.9,timestamp:0},ambient:{x:.3,y:.8,intensity:.4,timestamp:0},rock:{x:.7,y:.5,intensity:.8,timestamp:0},pop:{x:.6,y:.6,intensity:.7,timestamp:0},jazz:{x:.4,y:.7,intensity:.6,timestamp:0},classical:{x:.2,y:.9,intensity:.5,timestamp:0},default:{x:.5,y:.5,intensity:.6,timestamp:0}},this.spectralFlowMapping={bassFlow:{x:.8,y:.2,intensity:.7,timestamp:0},midFlow:{x:.5,y:.6,intensity:.6,timestamp:0},trebleFlow:{x:.3,y:.9,intensity:.5,timestamp:0},harmonyFlow:{x:.6,y:.4,intensity:.8,timestamp:0}},this.boundBeatHandler=this.handleBeatEvent.bind(this),this.boundGenreHandler=this.handleGenreChange.bind(this),this.boundSpectralHandler=this.handleSpectralAnalysis.bind(this),this.boundEnergyHandler=this.handleEnergyChange.bind(this),this.flowSmoothingBuffer=Array(5).fill(null).map(()=>({...this.currentFlowVector}))}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization(),this.subscribeToMusicEvents(),this.startFlowUpdates(),u?.debug?.log("GradientDirectionalFlowSystem","Gradient flow system initialized")}subscribeToMusicEvents(){this.boundBeatHandler&&document.addEventListener("music-sync:beat",this.boundBeatHandler),this.boundGenreHandler&&document.addEventListener("music-sync:genre-detected",this.boundGenreHandler),this.boundSpectralHandler&&document.addEventListener("music-sync:spectral-analysis",this.boundSpectralHandler),this.boundEnergyHandler&&document.addEventListener("music-sync:energy-changed",this.boundEnergyHandler)}handleBeatEvent(e){let i=performance.now();if(i-this.lastBeatTime<50)return;this.lastBeatTime=i;let a=e,{intensity:r,bpm:n,confidence:s}=a.detail,o=this.calculateBeatFlow(r,n,s),c=this.applyGenreModifications(o);this.updateFlowVector(c),u?.debug?.log("GradientDirectionalFlowSystem",`Beat flow: ${o.x.toFixed(2)}, ${o.y.toFixed(2)}, intensity: ${o.intensity.toFixed(2)}`)}handleGenreChange(e){let i=e,{genre:a,confidence:r}=i.detail;this.currentGenre=a,this.flowSettings.genreAdaptation&&r>.7&&this.adaptFlowToGenre(a),u?.debug?.log("GradientDirectionalFlowSystem",`Genre flow adaptation: ${a} (confidence: ${r.toFixed(2)})`)}handleSpectralAnalysis(e){let a=e.detail;if(!this.flowSettings.spectralSeparation)return;let r=this.mapSpectralToFlow(a),n=this.blendSpectralFlow(r);this.updateFlowVector(n)}handleEnergyChange(e){let i=e,{energy:a,valence:r}=i.detail,n=a*this.flowSettings.flowSensitivity,s=r*.5;this.currentFlowVector.intensity=Math.min(this.flowSettings.maxFlowIntensity,n+s)}calculateBeatFlow(e,i,a){let n=performance.now()/1e3*(i/60)*Math.PI*2,s=e*this.flowSettings.beatResponseStrength*a,o=Math.cos(n)*s,c=Math.sin(n)*s;return{x:o,y:c,intensity:s,timestamp:performance.now()}}applyGenreModifications(e){if(!this.flowSettings.genreAdaptation||!this.currentGenre)return e;let i=this.genreFlowPatterns[this.currentGenre.genre]||this.genreFlowPatterns.default,a=.3;return{x:e.x*(1-a)+i.x*a,y:e.y*(1-a)+i.y*a,intensity:e.intensity*(1-a)+i.intensity*a,timestamp:performance.now()}}mapSpectralToFlow(e){let{bassEnergy:i,midEnergy:a,trebleEnergy:r,harmonicContent:n}=e;return this.spectralFlowMapping.bassFlow={x:i*.8,y:i*.2,intensity:i,timestamp:performance.now()},this.spectralFlowMapping.midFlow={x:a*.6,y:a*.6,intensity:a,timestamp:performance.now()},this.spectralFlowMapping.trebleFlow={x:r*.2,y:r*.8,intensity:r,timestamp:performance.now()},this.spectralFlowMapping.harmonyFlow={x:n*.5,y:n*.7,intensity:n,timestamp:performance.now()},this.spectralFlowMapping}blendSpectralFlow(e){let i={bass:.4,mid:.3,treble:.2,harmony:.1},a=e.bassFlow.x*i.bass+e.midFlow.x*i.mid+e.trebleFlow.x*i.treble+e.harmonyFlow.x*i.harmony,r=e.bassFlow.y*i.bass+e.midFlow.y*i.mid+e.trebleFlow.y*i.treble+e.harmonyFlow.y*i.harmony,n=e.bassFlow.intensity*i.bass+e.midFlow.intensity*i.mid+e.trebleFlow.intensity*i.treble+e.harmonyFlow.intensity*i.harmony;return{x:a,y:r,intensity:n,timestamp:performance.now()}}updateFlowVector(e){this.flowSmoothingBuffer.push(e),this.flowSmoothingBuffer.length>5&&this.flowSmoothingBuffer.shift();let i=this.calculateSmoothedFlow();this.currentFlowVector=i,this.flowSettings.corridorFlowEnabled&&this.updateRadialFlow(i),this.updateCSSVariables()}calculateSmoothedFlow(){let e=this.flowSmoothingBuffer,i=this.flowSettings.smoothingFactor,a=e[0]?.x||0,r=e[0]?.y||0,n=e[0]?.intensity||0;for(let s=1;s<e.length;s++)a=a*i+e[s].x*(1-i),r=r*i+e[s].y*(1-i),n=n*i+e[s].intensity*(1-i);return{x:a,y:r,intensity:n,timestamp:performance.now()}}updateRadialFlow(e){let s=performance.now()/1e3*.1+e.x*Math.PI*2,o=-Math.cos(s),c=-Math.sin(s),m=Math.sqrt(o*o+c*c),d=o/(m||1),h=c/(m||1),g=this.flowSettings.inwardFlowIntensity,f=this.calculateBeatModifier(),v=this.calculateGenreInwardModifier(),C=Math.min(1,g*f*v*this.flowSettings.corridorBeatResponse);this.currentRadialFlow={angle:Math.atan2(h,d),radius:Math.min(1,m*this.flowSettings.radialFlowStrength),intensity:e.intensity,inwardFlow:C,timestamp:performance.now()},this.cssVariableController&&(this.cssVariableController.queueCSSVariableUpdate("--sn-inward-vector-x",d.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-inward-vector-y",h.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-radial-distance",m.toFixed(3)))}calculateBeatModifier(){if(!this.musicSyncService)return 1;let e=this.musicSyncService.getCurrentMusicState();if(!e)return 1;let a=performance.now()-this.lastBeatTime,n=Math.max(0,1-a/500);return .6+(e.beat?.energy??.5)*.8+n*.4}calculateGenreInwardModifier(){if(!this.currentGenre)return 1;let e={electronic:1.2,ambient:.8,rock:1,pop:.9,jazz:.7,classical:.6},i=this.currentGenre.genre;return e[i]??1}updateCSSVariables(){let e=performance.now();if(!(e-this.lastFlowUpdate<this.updateThrottleInterval)&&(this.lastFlowUpdate=e,this.cssVariableController)){this.cssVariableController.queueCSSVariableUpdate("--sn-flow-direction-x",this.currentFlowVector.x.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-flow-direction-y",this.currentFlowVector.y.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-flow-intensity",this.currentFlowVector.intensity.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-flow-strength",(this.currentFlowVector.intensity*.8).toFixed(3));let i=Math.atan2(this.currentFlowVector.y,this.currentFlowVector.x);this.cssVariableController.queueCSSVariableUpdate("--sn-flow-angle",`${(i*180/Math.PI).toFixed(1)}deg`),this.flowSettings.corridorFlowEnabled?(this.cssVariableController.queueCSSVariableUpdate("--sn-corridor-flow-angle",this.currentRadialFlow.angle.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-corridor-flow-radius",this.currentRadialFlow.radius.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-corridor-inward-flow",this.currentRadialFlow.inwardFlow.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-corridor-flow-intensity",this.currentRadialFlow.intensity.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-corridor-flow-enabled","1")):this.cssVariableController.queueCSSVariableUpdate("--sn-corridor-flow-enabled","0")}}adaptFlowToGenre(e){let i=this.genreFlowPatterns[e.genre]||this.genreFlowPatterns.default;document.dispatchEvent(new CustomEvent("gradient-flow:genre-adapted",{detail:{genre:e,flowPattern:i,timestamp:performance.now()}}))}startFlowUpdates(){let e=()=>{if(!this.isActive)return;let a=performance.now()-this.lastFlowUpdate;this.animateFlowPatterns(a),setTimeout(e,this.updateThrottleInterval)};e()}animateFlowPatterns(e){let i=performance.now()/1e3*.1,a=this.currentFlowVector.x,r=this.currentFlowVector.y,n=a+Math.sin(i)*.05,s=r+Math.cos(i)*.05;this.cssVariableController&&(this.cssVariableController.queueCSSVariableUpdate("--sn-flow-animated-x",n.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-flow-animated-y",s.toFixed(3)))}updateAnimation(e){this.animateFlowPatterns(e)}async healthCheck(){let e=this.flowSettings.enabled&&this.currentFlowVector.timestamp>0&&this.musicSyncService!==null;return{system:"GradientDirectionalFlowSystem",healthy:e,metrics:{enabled:this.flowSettings.enabled,lastUpdateTime:this.currentFlowVector.timestamp,musicSyncConnected:!!this.musicSyncService,flowIntensity:this.currentFlowVector.intensity},issues:e?[]:[...this.flowSettings.enabled?[]:["System disabled"],...this.currentFlowVector.timestamp>0?[]:["No flow updates"],...this.musicSyncService?[]:["Music sync disconnected"]]}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),this.boundBeatHandler&&document.removeEventListener("music-sync:beat",this.boundBeatHandler),this.boundGenreHandler&&document.removeEventListener("music-sync:genre-detected",this.boundGenreHandler),this.boundSpectralHandler&&document.removeEventListener("music-sync:spectral-analysis",this.boundSpectralHandler),this.boundEnergyHandler&&document.removeEventListener("music-sync:energy-changed",this.boundEnergyHandler),this.boundBeatHandler=null,this.boundGenreHandler=null,this.boundSpectralHandler=null,this.boundEnergyHandler=null}setFlowSensitivity(e){this.flowSettings.flowSensitivity=Math.max(0,Math.min(1,e))}setBeatResponseStrength(e){this.flowSettings.beatResponseStrength=Math.max(0,Math.min(1,e))}setGenreAdaptation(e){this.flowSettings.genreAdaptation=e}setSpectralSeparation(e){this.flowSettings.spectralSeparation=e}getCurrentFlowVector(){return{...this.currentFlowVector}}getFlowSettings(){return{...this.flowSettings}}getGenreFlowPatterns(){return{...this.genreFlowPatterns}}setCorridorFlowEnabled(e){this.flowSettings.corridorFlowEnabled=e,this.cssVariableController&&this.cssVariableController.queueCSSVariableUpdate("--sn-corridor-flow-enabled",e?"1":"0"),u?.debug?.log("GradientDirectionalFlowSystem",`Corridor flow ${e?"enabled":"disabled"}`)}getCurrentRadialFlow(){return{...this.currentRadialFlow}}updateCorridorFlowSettings(e){e.radialFlowStrength!==void 0&&(this.flowSettings.radialFlowStrength=Math.max(0,Math.min(2,e.radialFlowStrength))),e.inwardFlowIntensity!==void 0&&(this.flowSettings.inwardFlowIntensity=Math.max(0,Math.min(1,e.inwardFlowIntensity))),e.corridorBeatResponse!==void 0&&(this.flowSettings.corridorBeatResponse=Math.max(0,Math.min(3,e.corridorBeatResponse))),u?.debug?.log("GradientDirectionalFlowSystem","Corridor flow settings updated",e)}getCorridorFlowMapping(){return{linearFlow:{...this.currentFlowVector},radialFlow:{...this.currentRadialFlow},enabled:this.flowSettings.corridorFlowEnabled}}calculateInwardVectorForPosition(e,i){let n=.5-e,s=.5-i,o=Math.sqrt(n*n+s*s),c=o>.001?n/o:0,m=o>.001?s/o:0,d=Math.min(1,o*2),h=this.currentFlowVector.intensity*this.flowSettings.inwardFlowIntensity,g=this.calculateBeatModifier(),f=d*h*g;return{inwardX:c,inwardY:m,distanceFromCenter:o,flowIntensity:Math.min(1,f)}}getInwardFlowVectorsForShader(){let e=[];for(let a=0;a<8;a++){let r=a/8*Math.PI*2,n=.4,s=.5+Math.cos(r)*n,o=.5+Math.sin(r)*n,c=this.calculateInwardVectorForPosition(s,o);e.push({angle:r,inwardX:c.inwardX,inwardY:c.inwardY,intensity:c.flowIntensity})}return e}}});var Pi,Qn=y(()=>{"use strict";Za();si();G();k();oe();A();Z();ne();Pi=class extends N{constructor(e=M,i,a,r=null,n=null,s=null){super(e,i,a,r,n);this.colorHarmonyEngine=null;this.emotionalGradientMapper=null;this.genreGradientEvolution=null;this.containerElement=null;this.backgroundContainer=null;this.spectralData={bassResponse:0,midResponse:0,trebleResponse:0,vocalPresence:0};this.animationFrameId=null;this.lastAnimationTime=0;this.scrollY=0;this.scrollX=0;this.boundScrollHandler=null;this.boundResizeHandler=null;this.eventSubscriptionIds=[];this.visualEffectsCoordinator=null;this.currentVisualEffectState=null;this.lerpHalfLifeValues={parallaxOffset:.15,opacity:.2,blur:.25,hueRotate:.3,scale:.18};this.systemName="DepthLayeredGradientSystem";this.layerTemplates={cosmic:{gradient:"radial-gradient(ellipse 60% 40% at 25% 30%, rgba(88, 91, 112, 0.9) 0%, rgba(49, 50, 68, 0.5) 40%, transparent 80%), radial-gradient(ellipse 40% 60% at 75% 70%, rgba(49, 50, 68, 0.7) 0%, rgba(30, 30, 46, 0.3) 50%, transparent 85%), radial-gradient(circle 30% at 50% 50%, rgba(88, 91, 112, 0.4) 0%, transparent 70%)",animation:"cosmic-drift",duration:"120s"},void:{gradient:"radial-gradient(ellipse 50% 35% at 40% 25%, rgba(30, 30, 46, 0.95) 0%, rgba(49, 50, 68, 0.7) 35%, transparent 90%), radial-gradient(ellipse 35% 50% at 65% 75%, rgba(49, 50, 68, 0.8) 0%, rgba(88, 91, 112, 0.4) 45%, transparent 85%), radial-gradient(circle 25% at 20% 80%, rgba(30, 30, 46, 0.6) 0%, transparent 80%)",animation:"void-expansion",duration:"480s"},multiBlobPrimary:{gradient:"radial-gradient(circle 20% at 15% 20%, rgba(203, 166, 247, 0.6) 0%, rgba(203, 166, 247, 0.2) 50%, transparent 70%), radial-gradient(circle 25% at 45% 60%, rgba(245, 194, 231, 0.5) 0%, rgba(245, 194, 231, 0.15) 45%, transparent 75%), radial-gradient(circle 18% at 75% 35%, rgba(137, 180, 250, 0.55) 0%, rgba(137, 180, 250, 0.18) 48%, transparent 72%), radial-gradient(circle 15% at 85% 85%, rgba(203, 166, 247, 0.4) 0%, transparent 65%)",animation:"multi-blob-primary",duration:"200s"},multiBlobSecondary:{gradient:"radial-gradient(circle 22% at 30% 75%, rgba(250, 179, 135, 0.5) 0%, rgba(250, 179, 135, 0.12) 50%, transparent 75%), radial-gradient(circle 28% at 70% 25%, rgba(166, 227, 161, 0.45) 0%, rgba(166, 227, 161, 0.1) 48%, transparent 78%), radial-gradient(circle 16% at 10% 50%, rgba(245, 194, 231, 0.52) 0%, rgba(245, 194, 231, 0.15) 46%, transparent 70%), radial-gradient(circle 20% at 90% 60%, rgba(137, 180, 250, 0.4) 0%, transparent 68%)",animation:"multi-blob-secondary",duration:"280s"},smoothBubbles:{gradient:"radial-gradient(ellipse 45% 35% at 35% 40%, rgba(203, 166, 247, 0.4) 0%, rgba(203, 166, 247, 0.1) 60%, transparent 90%), radial-gradient(ellipse 35% 45% at 70% 65%, rgba(137, 180, 250, 0.35) 0%, rgba(137, 180, 250, 0.08) 65%, transparent 95%), radial-gradient(circle 25% at 25% 75%, rgba(245, 194, 231, 0.3) 0%, transparent 80%), radial-gradient(ellipse 20% 30% at 80% 20%, rgba(250, 179, 135, 0.25) 0%, transparent 75%)",animation:"smooth-bubble-flow",duration:"320s"},nebula:{gradient:"conic-gradient(from 45deg, rgba(203, 166, 247, 0.3) 0%, rgba(245, 194, 231, 0.2) 25%, rgba(250, 179, 135, 0.1) 50%, rgba(166, 227, 161, 0.2) 75%, rgba(203, 166, 247, 0.3) 100%)",animation:"nebula-flow",duration:"180s"},stellar:{gradient:"linear-gradient(45deg, rgba(137, 180, 250, 0.2) 0%, rgba(203, 166, 247, 0.1) 25%, rgba(245, 194, 231, 0.2) 50%, rgba(250, 179, 135, 0.1) 75%, rgba(166, 227, 161, 0.2) 100%)",animation:"stellar-motion",duration:"240s"},dimensional:{gradient:"linear-gradient(135deg, rgba(137, 180, 250, 0.1) 0%, rgba(203, 166, 247, 0.2) 20%, rgba(245, 194, 231, 0.1) 40%, rgba(250, 179, 135, 0.2) 60%, rgba(166, 227, 161, 0.1) 80%, rgba(137, 180, 250, 0.2) 100%)",animation:"dimensional-shift",duration:"360s"}};this.colorHarmonyEngine=s?.colorHarmonyEngine||null,this.visualEffectsCoordinator=s?.backgroundConsciousnessChoreographer||null,this.cssVariableController=null,this.deviceCapabilities=new O,this.depthLayers=new Map,this.visualEffectsLayers=new Map,this.depthSettings={enabled:!0,layerCount:6,maxDepth:1e3,parallaxStrength:.5,depthFogIntensity:.7,infiniteScrolling:!0,qualityLevel:"medium",performanceMode:!1,musicalVisualEffects:{enabled:!0,activityLevel:.7,temporalMemory:.3,harmonicSensitivity:.6,flowDynamics:.4,stellarDensity:.5,dimensionalDepth:3}},this.performanceMetrics={totalLayers:0,visibleLayers:0,averageDepth:0,parallaxRange:0,renderTime:0,memoryUsage:0},this.boundScrollHandler=this.handleScroll.bind(this),this.boundResizeHandler=this.handleResize.bind(this),this.adaptToDeviceCapabilities()}setOptimizedCSSVariableManager(e){this.cssVariableController=e,this.initializeMusicalVisualEffects()}async initializeMusicalVisualEffectsAsync(){this.initializeMusicalVisualEffects(),this.emotionalGradientMapper&&await this.emotionalGradientMapper.initialize(),this.genreGradientEvolution&&await this.genreGradientEvolution.initialize()}initializeMusicalVisualEffects(){if(!this.cssVariableController){u?.debug?.warn("DepthLayeredGradientSystem","CSS variable controller not available, musical visual effects disabled");return}try{this.emotionalGradientMapper=new gt(this.cssVariableController,this.musicSyncService,this.settingsManager),this.genreGradientEvolution=new ke(this.cssVariableController,this.musicSyncService,this.emotionalGradientMapper,this.settingsManager),u?.debug?.log("DepthLayeredGradientSystem","Musical visual effects components initialized")}catch(e){u?.debug?.error("DepthLayeredGradientSystem","Failed to initialize musical visual effects:",e),this.emotionalGradientMapper=null,this.genreGradientEvolution=null}}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization(),this.loadSettings(),this.createContainerElements(),this.createDepthAnimations(),this.initializeDepthLayers(),this.initializeVisualEffectsLayers(),this.cssVariableController&&await this.initializeMusicalVisualEffectsAsync(),this.setupEventListeners(),this.registerWithVisualEffectsCoordinator(),this.startAnimationLoop(),u?.debug?.log("DepthLayeredGradientSystem","Depth-layered gradient system initialized")}loadSettings(){if(this.settingsManager)try{let e=this.settingsManager.get("sn-depth-quality");e&&(this.depthSettings.qualityLevel=e,this.adjustQualitySettings());let i=this.settingsManager.get("sn-depth-enabled");i!==void 0&&(this.depthSettings.enabled=i)}catch(e){u?.debug?.warn("DepthLayeredGradientSystem","Failed to load settings:",e)}}adaptToDeviceCapabilities(){switch(this.deviceCapabilities.recommendPerformanceQuality()){case"low":this.depthSettings.qualityLevel="low",this.depthSettings.layerCount=3,this.depthSettings.performanceMode=!0;break;case"balanced":this.depthSettings.qualityLevel="medium",this.depthSettings.layerCount=6,this.depthSettings.performanceMode=!1;break;case"high":this.depthSettings.qualityLevel="high",this.depthSettings.layerCount=9,this.depthSettings.performanceMode=!1;break}}adjustQualitySettings(){switch(this.depthSettings.qualityLevel){case"low":this.depthSettings.layerCount=3,this.depthSettings.parallaxStrength=.3,this.depthSettings.depthFogIntensity=.5;break;case"medium":this.depthSettings.layerCount=6,this.depthSettings.parallaxStrength=.5,this.depthSettings.depthFogIntensity=.7;break;case"high":this.depthSettings.layerCount=9,this.depthSettings.parallaxStrength=.8,this.depthSettings.depthFogIntensity=.9;break}}createContainerElements(){this.containerElement=document.querySelector(".Root__main-view")||document.querySelector(".main-view-container")||document.body,this.backgroundContainer=document.createElement("div"),this.backgroundContainer.className="sn-depth-background-container",this.backgroundContainer.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -20;
      pointer-events: none;
      overflow: hidden;
      perspective: 1000px;
      transform-style: preserve-3d;
    `,this.containerElement.insertBefore(this.backgroundContainer,this.containerElement.firstChild)}createDepthAnimations(){let e=document.createElement("style");e.textContent=`
      .sn-depth-layer {
        position: absolute;
        width: 120%;
        height: 120%;
        top: -10%;
        left: -10%;
        pointer-events: none;
        transform-style: preserve-3d;
        will-change: transform, opacity;
      }

      @keyframes cosmic-drift {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        25% { transform: translate3d(-2%, 1%, 0) rotate(0.5deg) scale(1.02); }
        50% { transform: translate3d(0, -1%, 0) rotate(0deg) scale(0.98); }
        75% { transform: translate3d(2%, 0.5%, 0) rotate(-0.5deg) scale(1.01); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes nebula-flow {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        33% { transform: translate3d(1%, -1%, 0) rotate(1deg) scale(1.03); }
        66% { transform: translate3d(-1%, 1%, 0) rotate(-1deg) scale(0.97); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes stellar-motion {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        20% { transform: translate3d(-1%, 0.5%, 0) rotate(0.3deg) scale(1.01); }
        40% { transform: translate3d(0.5%, -0.5%, 0) rotate(-0.3deg) scale(0.99); }
        60% { transform: translate3d(1%, 0.5%, 0) rotate(0.2deg) scale(1.02); }
        80% { transform: translate3d(-0.5%, 1%, 0) rotate(-0.2deg) scale(0.98); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes quantum-field {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); filter: blur(0px); }
        25% { transform: translate3d(0.5%, -0.5%, 0) rotate(0.1deg) scale(1.01); filter: blur(0.5px); }
        50% { transform: translate3d(-0.5%, 0.5%, 0) rotate(-0.1deg) scale(0.99); filter: blur(1px); }
        75% { transform: translate3d(0.3%, 0.3%, 0) rotate(0.05deg) scale(1.005); filter: blur(0.3px); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); filter: blur(0px); }
      }

      @keyframes dimensional-shift {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        16% { transform: translate3d(0.2%, -0.2%, 0) rotate(0.1deg) scale(1.005); }
        32% { transform: translate3d(-0.2%, 0.2%, 0) rotate(-0.1deg) scale(0.995); }
        48% { transform: translate3d(0.1%, 0.1%, 0) rotate(0.05deg) scale(1.002); }
        64% { transform: translate3d(-0.1%, -0.1%, 0) rotate(-0.05deg) scale(0.998); }
        80% { transform: translate3d(0.15%, 0%, 0) rotate(0.02deg) scale(1.001); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes void-expansion {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.9; }
        50% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1.1); opacity: 0.6; }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.9; }
      }

      @keyframes multi-blob-primary {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.8; }
        20% { transform: translate3d(1%, -0.5%, 0) rotate(0.3deg) scale(1.03); opacity: 0.9; }
        40% { transform: translate3d(-0.5%, 1%, 0) rotate(-0.2deg) scale(0.97); opacity: 0.7; }
        60% { transform: translate3d(0.8%, 0.3%, 0) rotate(0.4deg) scale(1.05); opacity: 0.85; }
        80% { transform: translate3d(-0.3%, -0.8%, 0) rotate(-0.3deg) scale(0.98); opacity: 0.75; }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.8; }
      }

      @keyframes multi-blob-secondary {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.7; }
        25% { transform: translate3d(-1.2%, 0.8%, 0) rotate(-0.4deg) scale(1.04); opacity: 0.85; }
        50% { transform: translate3d(0.6%, -0.6%, 0) rotate(0.3deg) scale(0.96); opacity: 0.6; }
        75% { transform: translate3d(0.3%, 1.1%, 0) rotate(-0.2deg) scale(1.02); opacity: 0.8; }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.7; }
      }

      @keyframes smooth-bubble-flow {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.75; }
        12% { transform: translate3d(0.4%, -0.3%, 0) rotate(0.15deg) scale(1.02); opacity: 0.85; }
        24% { transform: translate3d(-0.3%, 0.6%, 0) rotate(-0.25deg) scale(0.98); opacity: 0.65; }
        36% { transform: translate3d(0.7%, 0.2%, 0) rotate(0.35deg) scale(1.04); opacity: 0.8; }
        48% { transform: translate3d(-0.2%, -0.5%, 0) rotate(-0.15deg) scale(0.99); opacity: 0.7; }
        60% { transform: translate3d(0.5%, 0.8%, 0) rotate(0.25deg) scale(1.03); opacity: 0.85; }
        72% { transform: translate3d(-0.6%, -0.1%, 0) rotate(-0.3deg) scale(0.97); opacity: 0.6; }
        84% { transform: translate3d(0.1%, -0.7%, 0) rotate(0.1deg) scale(1.01); opacity: 0.8; }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.75; }
      }

      @media (prefers-reduced-motion: reduce) {
        .sn-depth-layer {
          animation: none !important;
        }
      }
    `,document.head.appendChild(e)}initializeDepthLayers(){if(!this.backgroundContainer)return;let e=Object.keys(this.layerTemplates);for(let i=0;i<this.depthSettings.layerCount;i++){let a=(i+1)*(this.depthSettings.maxDepth/this.depthSettings.layerCount),r=e[i%e.length],n=this.layerTemplates[r],s=document.createElement("div");s.className="sn-depth-layer",s.id=`sn-depth-layer-${i}`;let o=a/this.depthSettings.maxDepth,c=1-o*this.depthSettings.parallaxStrength,m=1-o*this.depthSettings.depthFogIntensity,d=1+o*.2,h=o*3;s.style.cssText=`
        background: ${n.gradient};
        transform: translate3d(0, 0, ${-a}px) scale(${d});
        opacity: ${m};
        filter: blur(${h}px);
        animation: ${n.animation} ${n.duration} ease-in-out infinite;
        animation-delay: ${i*.5}s;
      `;let g={id:`depth-layer-${i}`,element:s,depth:a,parallaxFactor:c,opacityRange:[m*.5,m],scaleRange:[d*.95,d*1.05],rotationSpeed:.01+i*.001,colorShift:i*30,blurAmount:h,animationPhase:i*Math.PI/4,enabled:!0,currentOffsetY:0,targetOffsetY:0,currentOpacity:m,targetOpacity:m,currentBlur:h,targetBlur:h,currentHueRotate:0,targetHueRotate:0,currentScale:d,targetScale:d};this.depthLayers.set(g.id,g),this.backgroundContainer.appendChild(s)}this.updatePerformanceMetrics(),u?.debug?.log("DepthLayeredGradientSystem",`Initialized ${this.depthLayers.size} depth layers`)}initializeVisualEffectsLayers(){if(!this.backgroundContainer||!this.depthSettings.musicalVisualEffects.enabled)return;let e=this.performanceMonitor?.averageFPS||60,i=this.performanceMonitor?.getDeviceTier?.()==="low"||!1,a=this.performanceMonitor?.shouldReduceQuality?.()||!1;if(e<45||i||a){this.depthSettings.musicalVisualEffects.enabled=!1,u?.debug?.log("DepthLayeredGradientSystem",`Performance mode activated - visual effects layers disabled (FPS: ${e})`);return}let r=this.findSpotifyContainer(),n=document.createElement("div");n.className="sn-harmonic-layer",n.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -8;
      pointer-events: none;
      will-change: auto;
    `;let s=document.createElement("div");s.className="sn-flow-dynamics-primary",s.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -7;
      pointer-events: none;
      will-change: auto;
    `;let o=document.createElement("div");o.className="sn-wave-dynamics",o.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -5;
      pointer-events: none;
      will-change: transform, opacity, clip-path;
    `;let c=document.createElement("div");c.className="sn-flow-effects",c.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -4;
      pointer-events: none;
      will-change: transform, opacity, clip-path;
    `;let m=document.createElement("div");m.className="sn-procedural-nebula",m.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -3;
      pointer-events: none;
      will-change: transform, opacity, filter;
    `;let d=document.createElement("div");d.className="sn-stellar-layer",d.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -6;
      pointer-events: none;
      will-change: auto;
    `,this.visualEffectsLayers.set("harmonic",n),this.visualEffectsLayers.set("flowDynamics",s),this.visualEffectsLayers.set("waveDynamics",o),this.visualEffectsLayers.set("flowEffects",c),this.visualEffectsLayers.set("proceduralNebula",m),this.visualEffectsLayers.set("stellar",d),r.appendChild(n),r.appendChild(s),r.appendChild(d),r.appendChild(o),r.appendChild(c),r.appendChild(m),u?.debug?.log("DepthLayeredGradientSystem",`Initialized ${this.visualEffectsLayers.size} visual effects layers`)}findSpotifyContainer(){let e=[".Root__main-view",".main-view-container",".main-gridContainer-gridContainer",".Root__top-container","body"];for(let i of e){let a=document.querySelector(i);if(a)return a}return document.body}setupEventListeners(){this.boundScrollHandler&&window.addEventListener("scroll",this.boundScrollHandler,{passive:!0}),this.boundResizeHandler&&window.addEventListener("resize",this.boundResizeHandler,{passive:!0});let e=p.subscribe("music:beat",this.handleMusicBeat.bind(this),"DepthLayeredGradientSystem");this.eventSubscriptionIds.push(e);let i=p.subscribe("music:energy",this.handleMusicEnergy.bind(this),"DepthLayeredGradientSystem");this.eventSubscriptionIds.push(i),u?.debug?.log("DepthLayeredGradientSystem","Event listeners set up",{unifiedEventSubscriptions:this.eventSubscriptionIds.length})}handleScroll(e){this.scrollY=window.scrollY,this.scrollX=window.scrollX,this.updateParallaxEffects()}handleResize(e){this.updateLayerDimensions()}handleMusicBeat(e){this.pulseDepthLayers(e.intensity),this.handleMusicalVisualEffectsBeat(e.intensity),u?.debug?.log("DepthLayeredGradientSystem","Music beat processed",{bpm:e.bpm,intensity:e.intensity})}handleMusicEnergy(e){this.updateDepthWithMusicEnergy(e.energy),this.handleMusicalVisualEffectsSpectralData({energy:e.energy,valence:e.valence}),u?.debug?.log("DepthLayeredGradientSystem","Music energy processed",{energy:e.energy,valence:e.valence})}handleMusicalVisualEffectsBeat(e){this.depthSettings.musicalVisualEffects.enabled&&this.updateFlowDynamics(e)}handleMusicalVisualEffectsSpectralData(e){this.depthSettings.musicalVisualEffects.enabled&&(this.spectralData.bassResponse=e.energy*.8,this.spectralData.midResponse=e.energy*.6,this.spectralData.trebleResponse=e.energy*.4,this.spectralData.vocalPresence=e.valence*.7,this.updateSpectralVariables())}updateParallaxEffects(){this.depthSettings.infiniteScrolling&&this.depthLayers.forEach(e=>{let i=this.scrollY*e.parallaxFactor,a=this.scrollX*e.parallaxFactor*.5,n=e.element.style.transform.replace(/translate3d\([^)]*\)/,`translate3d(${a}px, ${i}px, ${-e.depth}px)`);e.element.style.transform=n})}updateLayerDimensions(){this.depthLayers.forEach(e=>{let a=1+e.depth/this.depthSettings.maxDepth*.2,n=e.element.style.transform.replace(/scale\([^)]*\)/,`scale(${a})`);e.element.style.transform=n})}updateDepthWithMusicEnergy(e){let i=e*.3;this.depthLayers.forEach(a=>{let r=a.opacityRange[0],n=a.opacityRange[1],s=r+i*(n-r);a.element.style.opacity=s.toString()})}pulseDepthLayers(e){let i=e*.1;this.depthLayers.forEach(a=>{let r=a.scaleRange[0],n=a.scaleRange[1],s=r+i*(n-r),c=a.element.style.transform.replace(/scale\([^)]*\)/,`scale(${s})`);a.element.style.transform=c,setTimeout(()=>{let m=a.element.style.transform.replace(/scale\([^)]*\)/,`scale(${r})`);a.element.style.transform=m},200)})}startAnimationLoop(){let e=()=>{if(!this.isActive)return;let i=performance.now(),a=i-this.lastAnimationTime;if(a<33){this.animationFrameId=requestAnimationFrame(e);return}this.lastAnimationTime=i,this.updateDepthAnimations(a),this.updatePerformanceMetrics(),this.animationFrameId=requestAnimationFrame(e)};this.animationFrameId=requestAnimationFrame(e)}updateDepthAnimations(e){let i=e/1e3;this.depthLayers.forEach(a=>{a.animationPhase+=a.rotationSpeed*e*.001,this.updateLayerTargetsFromMusic(a),a.currentOffsetY=R(a.currentOffsetY,a.targetOffsetY,i,this.lerpHalfLifeValues.parallaxOffset),a.currentOpacity=R(a.currentOpacity,a.targetOpacity,i,this.lerpHalfLifeValues.opacity),a.currentBlur=R(a.currentBlur,a.targetBlur,i,this.lerpHalfLifeValues.blur),a.currentHueRotate=R(a.currentHueRotate,a.targetHueRotate,i,this.lerpHalfLifeValues.hueRotate),a.currentScale=R(a.currentScale,a.targetScale,i,this.lerpHalfLifeValues.scale),this.applyLayerProperties(a)})}updateLayerTargetsFromMusic(e){let i=this.musicSyncService?.getCurrentMusicState();if(i){let{intensity:a,beat:r,emotion:n}=i,s=Math.sin(e.animationPhase)*.05*a,o=e.opacityRange[0]+(e.opacityRange[1]-e.opacityRange[0])*.5;e.targetOpacity=Math.max(0,Math.min(1,o+s)),e.targetOffsetY=this.scrollY*e.parallaxFactor+Math.sin(e.animationPhase*.5)*a*10;let c=e.scaleRange[0]+(e.scaleRange[1]-e.scaleRange[0])*.5;if(e.targetScale=c+a*.05,e.targetBlur=e.blurAmount+a*2,n){let m=n==="energetic"?15:n==="calm"?-10:n==="melancholy"?-20:0;e.targetHueRotate=m+e.colorShift*.1}}else{let a=Math.sin(e.animationPhase)*.02,r=e.opacityRange[0]+(e.opacityRange[1]-e.opacityRange[0])*.5;e.targetOpacity=Math.max(0,Math.min(1,r+a)),e.targetOffsetY=this.scrollY*e.parallaxFactor,e.targetScale=e.scaleRange[0]+(e.scaleRange[1]-e.scaleRange[0])*.5,e.targetBlur=e.blurAmount,e.targetHueRotate=0}}applyLayerProperties(e){e.element.style.transform=`translate3d(0, ${e.currentOffsetY}px, ${-e.depth}px) scale(${e.currentScale})`,e.element.style.opacity=e.currentOpacity.toString(),e.element.style.filter=`blur(${e.currentBlur}px) hue-rotate(${e.currentHueRotate}deg)`}updatePerformanceMetrics(){this.performanceMetrics.totalLayers=this.depthLayers.size,this.performanceMetrics.visibleLayers=Array.from(this.depthLayers.values()).filter(e=>parseFloat(e.element.style.opacity)>.01).length,this.performanceMetrics.averageDepth=Array.from(this.depthLayers.values()).reduce((e,i)=>e+i.depth,0)/this.depthLayers.size,this.performanceMetrics.parallaxRange=this.depthSettings.parallaxStrength,this.performanceMetrics.renderTime=performance.now()-this.lastAnimationTime,this.cssVariableController&&(this.cssVariableController.queueCSSVariableUpdate("--sn-depth-layers-total",this.performanceMetrics.totalLayers.toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-depth-layers-visible",this.performanceMetrics.visibleLayers.toString()))}updateVisualEffectsVariables(){if(!this.cssVariableController||!this.depthSettings.musicalVisualEffects.enabled)return;let e=this.performanceMonitor?.currentFPS||60;if(e<40&&this.depthSettings.musicalVisualEffects.enabled){this.depthSettings.musicalVisualEffects.enabled=!1,this.destroyVisualEffectsLayers(),u?.debug?.log("DepthLayeredGradientSystem",`Runtime performance degradation detected - visual effects layers disabled (FPS: ${e})`);return}let i=this.depthSettings.musicalVisualEffects;[["--sn-gradient-activity-level",i.activityLevel.toString()],["--sn-gradient-temporal-memory",i.temporalMemory.toString()],["--sn-gradient-harmonic-resonance",i.harmonicSensitivity.toString()],["--sn-gradient-flow-dynamics",i.flowDynamics.toString()],["--sn-gradient-nebula-density",i.stellarDensity.toString()],["--sn-gradient-dimensional-depth",i.dimensionalDepth.toString()],["--sn-gradient-layer-activity","1"],["--sn-gradient-layer-temporal","0.8"],["--sn-gradient-layer-harmonic",(i.harmonicSensitivity*.6).toString()],["--sn-gradient-layer-flow",(i.flowDynamics*.4).toString()],["--sn-gradient-layer-stellar",(i.stellarDensity*.2).toString()],["--sn-gradient-wave-intensity",(Math.round(i.activityLevel*40)/100).toString()],["--sn-gradient-flow-intensity",(Math.round(i.harmonicSensitivity*30)/100).toString()],["--sn-gradient-temporal-flow-speed",Math.max(.5,Math.round(i.temporalMemory*100)/100).toString()]].forEach(([r,n])=>{r&&n!==void 0&&this.cssVariableController&&this.cssVariableController.queueCSSVariableUpdate(r,n)})}updateSpectralVariables(){this.cssVariableController&&(this.cssVariableController.queueCSSVariableUpdate("--sn-gradient-bass-response",this.spectralData.bassResponse.toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-gradient-mid-response",this.spectralData.midResponse.toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-gradient-treble-response",this.spectralData.trebleResponse.toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-gradient-vocal-presence",this.spectralData.vocalPresence.toString()))}updateFlowDynamics(e){if(!this.cssVariableController)return;let i=Math.min(this.depthSettings.musicalVisualEffects.flowDynamics+e*.3,1);this.cssVariableController.queueCSSVariableUpdate("--sn-gradient-flow-dynamics",i.toString()),setTimeout(()=>{this.cssVariableController&&this.cssVariableController.queueCSSVariableUpdate("--sn-gradient-flow-dynamics",this.depthSettings.musicalVisualEffects.flowDynamics.toString())},500)}destroyVisualEffectsLayers(){this.visualEffectsLayers.forEach((e,i)=>{e.parentNode&&e.parentNode.removeChild(e)}),this.visualEffectsLayers.clear(),this.cssVariableController&&["--sn-gradient-activity-level","--sn-gradient-layer-activity","--sn-gradient-layer-temporal","--sn-gradient-layer-harmonic","--sn-gradient-layer-flow","--sn-gradient-layer-stellar"].forEach(i=>{this.cssVariableController.queueCSSVariableUpdate(i,"0")})}updateAnimation(e){if(this.depthSettings.musicalVisualEffects.enabled&&this.cssVariableController){let i=performance.now(),a=i/1e4%1;this.cssVariableController.queueCSSVariableUpdate("--sn-gradient-temporal-phase",a.toString()),i%1e3<16&&this.updateVisualEffectsVariables()}}async healthCheck(){let e=this.depthSettings.enabled&&this.depthLayers.size>0&&this.backgroundContainer!==null;return{system:"DepthLayeredGradientSystem",healthy:e,metrics:{enabled:this.depthSettings.enabled,layerCount:this.depthLayers.size,hasContainer:!!this.backgroundContainer,layerSettings:this.depthSettings.layerCount},issues:e?[]:[...this.depthSettings.enabled?[]:["System disabled"],...this.depthLayers.size>0?[]:["No active layers"],...this.backgroundContainer?[]:["Missing container element"]]}}_performSystemSpecificCleanup(){if(super._performSystemSpecificCleanup(),this.visualEffectsCoordinator)try{this.visualEffectsCoordinator.unregisterVisualEffectsParticipant("DepthLayeredGradientSystem"),u?.debug?.log("DepthLayeredGradientSystem","Unregistered from visual effects coordinator")}catch(e){u?.debug?.error("DepthLayeredGradientSystem","Error unregistering from visual effects coordinator:",e)}this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.boundScrollHandler&&window.removeEventListener("scroll",this.boundScrollHandler),this.boundResizeHandler&&window.removeEventListener("resize",this.boundResizeHandler),this.eventSubscriptionIds.forEach(e=>{p.unsubscribe(e)}),this.eventSubscriptionIds=[],this.depthLayers.forEach(e=>{e.element.parentNode&&e.element.parentNode.removeChild(e.element)}),this.depthLayers.clear(),this.destroyVisualEffectsLayers(),this.emotionalGradientMapper&&(this.emotionalGradientMapper.destroy(),this.emotionalGradientMapper=null),this.genreGradientEvolution&&(this.genreGradientEvolution.destroy(),this.genreGradientEvolution=null),this.backgroundContainer&&this.backgroundContainer.parentNode&&(this.backgroundContainer.parentNode.removeChild(this.backgroundContainer),this.backgroundContainer=null),this.boundScrollHandler=null,this.boundResizeHandler=null}setDepthEnabled(e){this.depthSettings.enabled=e,this.backgroundContainer&&(this.backgroundContainer.style.display=e?"block":"none")}setQualityLevel(e){this.depthSettings.qualityLevel=e,this.adjustQualitySettings(),this.depthLayers.forEach(i=>{i.element.parentNode&&i.element.parentNode.removeChild(i.element)}),this.depthLayers.clear(),this.initializeDepthLayers()}setParallaxStrength(e){this.depthSettings.parallaxStrength=Math.max(0,Math.min(1,e)),this.depthLayers.forEach(i=>{let a=i.depth/this.depthSettings.maxDepth;i.parallaxFactor=1-a*this.depthSettings.parallaxStrength})}setDepthFogIntensity(e){this.depthSettings.depthFogIntensity=Math.max(0,Math.min(1,e)),this.depthLayers.forEach(i=>{let r=1-i.depth/this.depthSettings.maxDepth*this.depthSettings.depthFogIntensity;i.element.style.opacity=r.toString()})}getDepthSettings(){return{...this.depthSettings}}getPerformanceMetrics(){return{...this.performanceMetrics}}getDepthLayerCount(){return this.depthLayers.size}getVisibleLayerCount(){return this.performanceMetrics.visibleLayers}setVisualEffectsLevel(e){this.depthSettings.musicalVisualEffects.activityLevel=Math.max(0,Math.min(1,e)),this.updateVisualEffectsVariables()}setTemporalMemory(e){this.depthSettings.musicalVisualEffects.temporalMemory=Math.max(0,Math.min(1,e)),this.updateVisualEffectsVariables()}setHarmonicSensitivity(e){this.depthSettings.musicalVisualEffects.harmonicSensitivity=Math.max(0,Math.min(1,e)),this.updateVisualEffectsVariables()}setStellarDrift(e){this.cssVariableController&&this.cssVariableController.queueCSSVariableUpdate("--sn-gradient-stellar-drift",`${e}deg`)}getVisualEffectsMetrics(){return{activityLevel:this.depthSettings.musicalVisualEffects.activityLevel,temporalMemory:this.depthSettings.musicalVisualEffects.temporalMemory,harmonicSensitivity:this.depthSettings.musicalVisualEffects.harmonicSensitivity,flowDynamics:this.depthSettings.musicalVisualEffects.flowDynamics,stellarDensity:this.depthSettings.musicalVisualEffects.stellarDensity,dimensionalDepth:this.depthSettings.musicalVisualEffects.dimensionalDepth,spectralData:{...this.spectralData},emotionalProfile:this.emotionalGradientMapper?.getCurrentEmotionalProfile()||null,gradientState:this.emotionalGradientMapper?.getCurrentGradientState()||null,currentGenre:this.genreGradientEvolution?.getCurrentGenre()||null,genreConfidence:this.genreGradientEvolution?.getGenreConfidence()||0,genreHistory:this.genreGradientEvolution?.getGenreHistory()||[]}}getEmotionalGradientMapper(){return this.emotionalGradientMapper}getGenreGradientEvolution(){return this.genreGradientEvolution}registerWithVisualEffectsCoordinator(){if(!this.visualEffectsCoordinator){u?.debug?.log("DepthLayeredGradientSystem","Visual effects coordinator not available, skipping registration");return}try{this.visualEffectsCoordinator.registerVisualEffectsParticipant(this),u?.debug?.log("DepthLayeredGradientSystem","Successfully registered with visual effects coordinator")}catch(e){u?.debug?.error("DepthLayeredGradientSystem","Failed to register with visual effects coordinator:",e)}}get systemPriority(){return"high"}getVisualEffectsContribution(){return{depthPerception:this.depthSettings.maxDepth/10,layerCount:this.depthLayers.size,parallaxStrength:this.depthSettings.parallaxStrength,fogDensity:this.depthSettings.depthFogIntensity,infinityPerception:this.depthSettings.infiniteScrolling?1:.5,spatialAwareness:this.performanceMetrics.visibleLayers/this.performanceMetrics.totalLayers}}onVisualEffectsFieldUpdate(e){try{this.currentVisualEffectState=e,this.updateDepthFromVisualEffects(e),u?.debug?.log("DepthLayeredGradientSystem","Updated from visual effects field:",{rhythmicPulse:e.pulseRate,depthPerception:e.depthPerception,animationCycle:e.pulseRate})}catch(i){u?.debug?.error("DepthLayeredGradientSystem","Error updating from visual effects field:",i)}}updateDepthFromVisualEffects(e){let i=this.depthSettings.parallaxStrength*(.7+e.pulseRate*.6);for(let[a,r]of this.depthLayers.entries()){if(!r.element)continue;let s=(r.opacityRange[0]+(r.opacityRange[1]-r.opacityRange[0])*e.flowDirection.x)*(.8+e.depthPerception*.4),o=1+Math.sin(e.pulseRate*Math.PI*2)*.05,m=(r.scaleRange[0]+(r.scaleRange[1]-r.scaleRange[0])*e.energyLevel)*o;r.element.style.opacity=s.toString(),r.element.style.transform=`
        scale(${m})
        translateZ(${r.depth*i}px)
        rotateZ(${r.animationPhase*r.rotationSpeed}deg)
      `;let d=r.blurAmount*(1+e.depthPerception*.5);r.element.style.filter=`blur(${d}px)`}this.cssVariableController&&(this.cssVariableController.queueCSSVariableUpdate("--sn-depth-activity-parallax",i.toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-depth-perception-intensity",e.depthPerception.toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-depth-fog-intensity",this.depthSettings.depthFogIntensity.toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-depth-spatial-awareness",(this.performanceMetrics.visibleLayers/this.performanceMetrics.totalLayers).toString()))}updateLayerScalesWithAnimation(e){let i=Math.sin(e*Math.PI*2)*.03;for(let a of this.depthLayers.values()){if(!a.element)continue;let r=a.element.style.transform,s=(a.scaleRange[0]+(a.scaleRange[1]-a.scaleRange[0])*.5)*(1+i);a.element.style.transform=r.replace(/scale\([^)]+\)/,`scale(${s})`)}}updateDepthFogIntensity(){for(let e of this.depthLayers.values()){if(!e.element)continue;let i=e.depth/this.depthSettings.maxDepth*this.depthSettings.depthFogIntensity,a=Math.max(0,Math.min(.8,i));e.element.style.boxShadow=`inset 0 0 ${50*i}px rgba(30, 30, 46, ${a})`}}updateDepthPerception(){let e=Array.from(this.depthLayers.values()).sort((i,a)=>i.depth-a.depth);e.forEach((i,a)=>{let r=a/(e.length-1);i.depth=r*this.depthSettings.maxDepth,i.element&&(i.element.style.transform=i.element.style.transform.replace(/translateZ\([^)]+\)/,`translateZ(${i.depth*this.depthSettings.parallaxStrength}px)`))})}onVisualStateUpdate(e){this.onVisualEffectsFieldUpdate(e)}onVisualEffectEvent(e,i){switch(e){case"visual-effects:rhythm-shift":i.intensity&&(this.depthSettings.parallaxStrength=Math.min(10,i.intensity*5));break;case"visual-effects:color-shift":this.forceRepaint?.("color-shift");break;case"visual-effects:energy-surge":i.intensity>.6&&(this.depthSettings.depthFogIntensity=Math.min(1,i.intensity));break}}getVisualContribution(){return{depthPerception:this.depthSettings.parallaxStrength/10,effectDepth:this.depthSettings.depthFogIntensity,visualCoherence:this.depthSettings.maxDepth/100}}onConsciousnessFieldUpdate(e){return this.onVisualEffectsFieldUpdate(e)}getConsciousnessContribution(){return this.getVisualEffectsContribution()}setConsciousnessLevel(e){return this.setVisualEffectsLevel(e)}getConsciousnessMetrics(){return this.getVisualEffectsMetrics()}onChoreographyEvent(e,i){return this.onVisualEffectEvent(e,i)}}});var Ja={};te(Ja,{DEFAULT_VERTEX_SHADER:()=>xt,ShaderLoader:()=>Q,createGradientTexture:()=>le});function le(l,t,e=256){try{if(!l)return u?.debug?.error("ShaderLoader","WebGL context is null or undefined"),null;if(!t||t.length===0)return u?.debug?.error("ShaderLoader","Invalid or empty color stops array"),null;if(e<=0||e>8192)return u?.debug?.error("ShaderLoader",`Invalid texture width: ${e}`),null;let i=l.getError();if(i!==l.NO_ERROR&&u?.debug?.warn("ShaderLoader",`WebGL context has pending error: ${i}`),l.isContextLost())return u?.debug?.error("ShaderLoader","WebGL context is lost"),null;let a=document.createElement("canvas");if(!a)return u?.debug?.error("ShaderLoader","Failed to create canvas element"),null;a.width=e,a.height=1;let r=a.getContext("2d",{willReadFrequently:!1});if(!r)return u?.debug?.error("ShaderLoader","Failed to get 2D canvas context"),null;let n=t.filter(c=>typeof c.r!="number"||typeof c.g!="number"||typeof c.b!="number"||typeof c.a!="number"||typeof c.position!="number"?(u?.debug?.warn("ShaderLoader","Invalid color stop found, skipping"),!1):((c.position<0||c.position>1)&&(u?.debug?.warn("ShaderLoader",`Invalid color stop position: ${c.position}, clamping`),c.position=Math.max(0,Math.min(1,c.position))),!0));if(n.length===0)return u?.debug?.error("ShaderLoader","No valid color stops after validation"),null;n.sort((c,m)=>c.position-m.position);let s=r.createLinearGradient(0,0,e,0);if(!s)return u?.debug?.error("ShaderLoader","Failed to create linear gradient"),null;try{n.forEach((c,m)=>{let d=Math.max(0,Math.min(255,Math.round(c.r*255))),h=Math.max(0,Math.min(255,Math.round(c.g*255))),g=Math.max(0,Math.min(255,Math.round(c.b*255))),f=Math.max(0,Math.min(1,c.a)),v=`rgba(${d}, ${h}, ${g}, ${f})`;s.addColorStop(c.position,v)})}catch(c){return u?.debug?.error("ShaderLoader","Failed to add color stops to gradient:",c),null}try{r.fillStyle=s,r.fillRect(0,0,e,1)}catch(c){return u?.debug?.error("ShaderLoader","Failed to fill canvas with gradient:",c),null}let o=l.createTexture();if(!o)return u?.debug?.error("ShaderLoader","Failed to create WebGL texture - gl.createTexture() returned null"),null;try{l.bindTexture(l.TEXTURE_2D,o);let c=l.getError();if(c!==l.NO_ERROR)return u?.debug?.error("ShaderLoader",`WebGL error after texture binding: ${c}`),l.deleteTexture(o),null;l.texImage2D(l.TEXTURE_2D,0,l.RGBA,l.RGBA,l.UNSIGNED_BYTE,a);let m=l.getError();if(m!==l.NO_ERROR)return u?.debug?.error("ShaderLoader",`WebGL error after texture upload: ${m}`),l.deleteTexture(o),null;l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.LINEAR),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.LINEAR);let d=l.getError();return d!==l.NO_ERROR?(u?.debug?.error("ShaderLoader",`WebGL error after setting texture parameters: ${d}`),l.deleteTexture(o),null):(l.bindTexture(l.TEXTURE_2D,null),u?.debug?.log("ShaderLoader",`Gradient texture created successfully: ${e}x1, ${n.length} stops`),o)}catch(c){return u?.debug?.error("ShaderLoader","Exception during WebGL texture operations:",c),o&&l.deleteTexture(o),null}}catch(i){return u?.debug?.error("ShaderLoader",`Gradient texture creation failed: ${i instanceof Error?i.message:"Unknown error"}`),null}}var Q,xt,pt=y(()=>{"use strict";A();Q=class{static loadFragment(t,e,i){let a=i||this.hashSource(e),r=this.getContextCache(t);if(r[a])return r[a];try{let n=this.compileShader(t,t.FRAGMENT_SHADER,e);return n&&(r[a]=n,u?.debug?.log("ShaderLoader",`Fragment shader compiled: ${a.substring(0,8)}...`)),n}catch(n){return u?.debug?.error("ShaderLoader",`Fragment shader compilation failed: ${n}`),null}}static loadVertex(t,e,i){let a=i||this.hashSource(e),r=this.getContextCache(t);if(r[a])return r[a];try{let n=this.compileShader(t,t.VERTEX_SHADER,e);return n&&(r[a]=n,u?.debug?.log("ShaderLoader",`Vertex shader compiled: ${a.substring(0,8)}...`)),n}catch(n){return u?.debug?.error("ShaderLoader",`Vertex shader compilation failed: ${n}`),null}}static createProgram(t,e,i){try{let a=t.createProgram();if(!a)return null;if(t.attachShader(a,e),t.attachShader(a,i),t.linkProgram(a),!t.getProgramParameter(a,t.LINK_STATUS)){let r=t.getProgramInfoLog(a);throw t.deleteProgram(a),new Error(`Program linking failed: ${r}`)}return a}catch(a){return u?.debug?.error("ShaderLoader",`Program creation failed: ${a}`),null}}static clearCache(t){let e=this.cache.get(t);e&&(Object.values(e).forEach(i=>{t.deleteShader(i)}),this.cache.delete(t))}static clearAllCaches(){this.cache.clear()}static compileShader(t,e,i){let a=t.createShader(e);if(!a)return null;if(t.shaderSource(a,i),t.compileShader(a),!t.getShaderParameter(a,t.COMPILE_STATUS)){let r=t.getShaderInfoLog(a);throw t.deleteShader(a),new Error(`Shader compilation failed: ${r}`)}return a}static clearContextCache(t){if(this.cache.has(t)){let e=this.cache.get(t);Object.values(e).forEach(i=>{if(i&&t&&!t.isContextLost())try{t.deleteShader(i)}catch{}}),this.cache.set(t,{}),u?.debug?.log("ShaderLoader","Context cache cleared due to WebGL context loss/restore")}}static getContextCache(t){return this.cache.has(t)||this.cache.set(t,{}),this.cache.get(t)}static hashSource(t){let e=0;for(let i=0;i<t.length;i++){let a=t.charCodeAt(i);e=(e<<5)-e+a,e=e&e}return e.toString(16)}};Q.cache=new Map;xt=`#version 300 es
precision mediump float;

in vec2 a_position;
out vec2 v_uv;

void main() {
  v_uv = a_position * 0.5 + 0.5;
  gl_Position = vec4(a_position, 0.0, 1.0);
}`});var wl,Xn,Zn,Jn,es,Ne,X,er,tr,ir,ts=y(()=>{"use strict";wl=`#version 300 es
in vec2 a_position;
void main() {
  gl_Position = vec4(a_position, 0.0, 1.0);
}`,Xn=`
// Shared simplex noise implementation for visual effects
vec3 mod289(vec3 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec2 mod289(vec2 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec3 permute(vec3 x) {
  return mod289(((x*34.0)+1.0)*x);
}

float snoise(vec2 v) {
  const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);
  vec2 i = floor(v + dot(v, C.yy));
  vec2 x0 = v - i + dot(i, C.xx);
  vec2 i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
  vec4 x12 = x0.xyxy + C.xxzz;
  x12.xy -= i1;
  i = mod289(i);
  vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));
  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
  m = m*m;
  m = m*m;
  vec3 x = 2.0 * fract(p * C.www) - 1.0;
  vec3 h = abs(x) - 0.5;
  vec3 ox = floor(x + 0.5);
  vec3 a0 = x - ox;
  m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);
  vec3 g;
  g.x = a0.x * x0.x + h.x * x0.y;
  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
  return 130.0 * dot(m, g);
}`,Zn=`
// Enhanced visualEffects-aware animation effect with multi-phase patterns
float visualEffectsPulsing(float time, float phase, float intensity) {
  return sin(time * 0.05 + phase) * intensity;
}

// Deep visualEffects animation with emotional resonance
float deepVisualEffectsPulsing(float time, float phase, float emotionalIntensity) {
  float primaryBreath = sin(time * 0.04 + phase) * 0.6;
  float secondaryBreath = sin(time * 0.07 + phase * 1.3) * 0.3;
  float emotionalBreath = sin(time * 0.02 + phase * 0.7) * 0.2;
  return (primaryBreath + secondaryBreath + emotionalBreath) * emotionalIntensity;
}

// Rhythmic pulse modulation from visualEffects field
float rhythmicPulseModulation(float baseValue, float rhythmicPulse, float intensity) {
  return baseValue * (1.0 + rhythmicPulse * intensity);
}

// Musical flow direction calculation
vec2 calculateMusicalFlow(vec2 baseDirection, vec2 musicFlow, float sensitivity) {
  return baseDirection + musicFlow * sensitivity;
}

// Energy resonance modulation
float energyResonanceModulation(float baseValue, float energyResonance, float minMult, float maxMult) {
  return baseValue * (minMult + energyResonance * (maxMult - minMult));
}

// Surface fluidity effect
float surfaceFluidityEffect(float value, float fluidityIndex) {
  return mix(value, value * 1.2, fluidityIndex);
}

// === ADVANCED VISUAL_EFFECTS FIELD PATTERNS ===

// Multi-dimensional visualEffects field intensity calculation
float visualEffectsFieldIntensity(vec2 position, float time, float musicEnergy) {
  // Primary visualEffects wave
  float primaryField = snoise(position * 2.0 + time * 0.1) * 0.6;
  
  // Secondary awareness resonance
  float secondaryField = snoise(position * 4.0 + time * 0.05) * 0.3;
  
  // Musical visualEffects enhancement
  float musicalField = snoise(position * 6.0 + time * 0.15) * 0.2;
  
  // Combine visualEffects layers
  float combinedField = primaryField + secondaryField + (musicalField * musicEnergy);
  return clamp(combinedField * 0.5 + 0.5, 0.0, 1.0);
}

// Multi-dimensional awareness patterns for color modulation
vec3 awarenessResonance(vec3 baseColor, float visualEffectsLevel, float musicIntensity) {
  // VisualEffects-aware color temperature shift
  float temperatureShift = visualEffectsLevel * 0.3;
  vec3 warmShift = vec3(1.0 + temperatureShift, 1.0 + temperatureShift * 0.5, 1.0);
  vec3 coolShift = vec3(1.0, 1.0 + temperatureShift * 0.3, 1.0 + temperatureShift);
  
  // Musical intensity affects color saturation
  float saturationBoost = 1.0 + musicIntensity * 0.4;
  
  // Apply visualEffects-aware color modulation
  vec3 temperatureColor = mix(coolShift, warmShift, visualEffectsLevel);
  return baseColor * temperatureColor * saturationBoost;
}

// Temporal flow patterns for Year 3000 streaming effects
vec2 temporalFlowDirection(vec2 position, float time, vec2 musicFlow) {
  // Primary temporal stream
  vec2 primaryFlow = vec2(
    sin(time * 0.08 + position.x * 3.0),
    cos(time * 0.06 + position.y * 2.5)
  ) * 0.02;
  
  // Secondary visualEffects flow
  vec2 visualEffectsFlow = vec2(
    sin(time * 0.05 + position.y * 4.0),
    cos(time * 0.04 + position.x * 3.5)
  ) * 0.015;
  
  // Musical synchronization flow
  vec2 musicalSync = musicFlow * 0.01;
  
  return primaryFlow + visualEffectsFlow + musicalSync;
}

// Surface visualEffects dynamics for smooth boundaries
float surfaceVisualEffectsFlow(vec2 position, float fluidityIndex, float awarenessLevel) {
  // Base surface oscillation
  float surfaceBase = sin(position.x * 8.0 + position.y * 6.0) * 0.1;
  
  // VisualEffects-driven surface flexibility
  float visualEffectsFlex = awarenessLevel * fluidityIndex * 0.2;
  
  // Smooth surface animation
  float surfaceBreath = sin(position.x * 3.0 + position.y * 4.0) * 0.05;
  
  return surfaceBase + visualEffectsFlex + surfaceBreath;
}

// Advanced visualEffects animation patterns
float visualEffectsMemoryPulsing(float time, float phase, float memoryIntensity) {
  // Primary visualEffects rhythm
  float primaryRhythm = sin(time * 0.03 + phase) * 0.5;
  
  // Memory echo patterns
  float memoryEcho = sin(time * 0.08 + phase * 1.7) * 0.3 * memoryIntensity;
  
  // Deep awareness pulse
  float awarenessePulse = sin(time * 0.015 + phase * 0.5) * 0.2;
  
  return primaryRhythm + memoryEcho + awarenessePulse;
}`,Jn=`
// Convert screen coordinates to polar coordinates for radial flow
vec2 toPolar(vec2 uv) {
  vec2 centered = uv - 0.5;
  float angle = atan(centered.y, centered.x);
  float radius = length(centered);
  return vec2(angle, radius);
}

// Convert polar coordinates back to cartesian
vec2 fromPolar(vec2 polar) {
  float angle = polar.x;
  float radius = polar.y;
  return vec2(cos(angle) * radius, sin(angle) * radius) + 0.5;
}

// Signed distance field for a circle
float circleSDF(vec2 uv, vec2 center, float radius) {
  return length(uv - center) - radius;
}

// Smooth minimum for blending SDFs
float smin(float a, float b, float k) {
  float h = clamp(0.5 + 0.5 * (b - a) / k, 0.0, 1.0);
  return mix(b, a, h) - k * h * (1.0 - h);
}

// Enhanced multiple bubble corridors with smooth visualEffects-aware animations
float bubbleCorridors(vec2 uv, float time, float intensity) {
  // ===== ENHANCED PRIMARY BUBBLE APERTURES =====
  // Create 6 main circular apertures arranged in a ring with dynamic bubble count
  float baseBubbleCount = 6.0;
  float dynamicBubbleCount = baseBubbleCount + floor(intensity * 2.0); // 6-8 bubbles based on intensity
  float ringRadius = 0.28 + sin(time * 0.15) * 0.08; // Pulsing ring radius (0.20-0.36)
  
  float minBubbleDistance = 2.0; // Track closest bubble distance
  
  // Calculate distance to each bubble position with enhanced smooth movement
  for(float i = 0.0; i < dynamicBubbleCount; i += 1.0) {
    // Enhanced smooth rotation with animation rhythm
    float bubbleAngle = (i / dynamicBubbleCount) * 2.0 * 3.14159 + time * 0.08;
    
    // Add smooth spiral motion for visualEffects effect
    float spiralOffset = sin(time * 0.25 + i * 0.6) * 0.15;
    float dynamicRingRadius = ringRadius + spiralOffset;
    
    // Bubble center position with enhanced smooth movement
    vec2 bubbleCenter = vec2(0.5) + vec2(
      cos(bubbleAngle) * dynamicRingRadius,
      sin(bubbleAngle) * dynamicRingRadius
    );
    
    // Enhanced animation/pulsing animation with multi-frequency modulation
    float animationPhase = sin(time * 0.6 + i * 0.8) * 0.04;
    float smoothPhase = sin(time * 0.35 + i * 1.2) * 0.03;
    float visualEffectsPhase = sin(time * 0.18 + i * 0.5) * 0.025;
    
    vec2 smoothMovement = vec2(
      sin(time * 0.3 + i * 0.7) * (animationPhase + smoothPhase),
      cos(time * 0.4 + i * 0.9) * (animationPhase + visualEffectsPhase)
    );
    
    vec2 animatedCenter = bubbleCenter + smoothMovement;
    
    // Calculate distance from current pixel to this bubble center
    float distanceToBubble = length(uv - animatedCenter);
    minBubbleDistance = min(minBubbleDistance, distanceToBubble);
  }
  
  // ===== ENHANCED BUBBLE APERTURE SIZING =====
  // Enhanced bubble size with multi-wave expansion patterns
  float baseBubbleSize = 0.08 * intensity;
  float primaryPulse = sin(time * 1.5) * 0.35;
  float smoothPulse = sin(time * 0.8) * 0.25;
  float visualEffectsPulse = sin(time * 2.2) * 0.15;
  
  float expandedBubbleSize = baseBubbleSize * (1.0 + primaryPulse + smoothPulse + visualEffectsPulse);
  
  // Create clean circular apertures with enhanced soft edges
  float primaryBubbleMask = 1.0 - smoothstep(expandedBubbleSize * 0.6, expandedBubbleSize * 1.1, minBubbleDistance);
  
  // ===== ENHANCED SECONDARY BUBBLE LAYER =====
  // Add smaller secondary bubbles with smooth movement
  float secondaryBubbleCount = 4.0 + floor(intensity * 1.0); // 4-5 secondary bubbles
  float baseSecondaryRadius = 0.15;
  float secondaryRingRadius = baseSecondaryRadius * (1.0 + sin(time * 0.12) * 0.3);
  float minSecondaryDistance = 2.0;
  
  for(float i = 0.0; i < secondaryBubbleCount; i += 1.0) {
    // Counter-rotating secondary bubbles with smooth offset
    float secondaryAngle = (i / secondaryBubbleCount) * 2.0 * 3.14159 - time * 0.15 + 1.57;
    
    // Add smooth wobble to secondary bubble positions
    float wobbleX = sin(time * 0.45 + i * 1.1) * 0.02;
    float wobbleY = cos(time * 0.55 + i * 0.8) * 0.02;
    
    vec2 secondaryCenter = vec2(0.5) + vec2(
      cos(secondaryAngle) * secondaryRingRadius + wobbleX,
      sin(secondaryAngle) * secondaryRingRadius + wobbleY
    );
    
    float distanceToSecondary = length(uv - secondaryCenter);
    minSecondaryDistance = min(minSecondaryDistance, distanceToSecondary);
  }
  
  float secondaryBubbleSize = baseBubbleSize * 0.5 * (1.0 + sin(time * 1.8) * 0.3);
  float secondaryBubbleMask = 1.0 - smoothstep(secondaryBubbleSize * 0.6, secondaryBubbleSize * 1.0, minSecondaryDistance);
  secondaryBubbleMask *= 0.75; // Make secondary bubbles dimmer for depth
  
  // ===== ENHANCED CENTER SPOTLIGHT BUBBLE =====
  // Enhanced central bubble with complex pulsing patterns
  float centerDistance = length(uv - vec2(0.5));
  float centerPrimaryPulse = sin(time * 2.0) * 0.4;
  float centerSecondaryPulse = sin(time * 3.5) * 0.2;
  float centerPulsingPulse = sin(time * 0.6) * 0.3;
  
  float centerBubbleSize = 0.06 * intensity * (1.0 + centerPrimaryPulse + centerSecondaryPulse + centerPulsingPulse);
  float centerBubbleMask = 1.0 - smoothstep(centerBubbleSize * 0.4, centerBubbleSize * 0.9, centerDistance);
  
  // ===== ENHANCED COMBINATION AND BLENDING =====
  // Use smooth maximum for smooth blending instead of hard max
  float corridorMask = primaryBubbleMask;
  corridorMask = max(corridorMask, secondaryBubbleMask * 0.9);
  corridorMask = max(corridorMask, centerBubbleMask * 1.1); // Center bubble slightly stronger
  
  // Enhanced radial falloff with smooth variation
  vec2 center = uv - vec2(0.5);
  float radialDistance = length(center);
  float smoothVariation = sin(time * 0.3 + radialDistance * 8.0) * 0.05;
  float radialFalloff = 1.0 - smoothstep(0.0, 0.65 + smoothVariation, radialDistance);
  corridorMask *= radialFalloff;
  
  // Enhanced smooth animation pattern with visualEffects harmonics
  float primaryPulsing = sin(time * 0.4) * 0.15;
  float secondaryPulsing = sin(time * 0.25) * 0.08;
  float visualEffectsPulsing = sin(time * 0.6) * 0.05;
  float animationCycle = 0.85 + primaryPulsing + secondaryPulsing + visualEffectsPulsing;
  corridorMask *= animationCycle;
  
  // Add subtle noise variation for smooth visualEffects texture
  float noisePattern = sin(radialDistance * 12.0 + time * 0.5) * cos(radialDistance * 8.0 - time * 0.3) * 0.03;
  corridorMask += noisePattern * intensity * 0.5;
  
  return clamp(corridorMask, 0.0, 1.0);
}

// Perspective depth calculation for inward flow
float calculatePerspectiveDepth(vec2 uv, float time, float flowStrength) {
  vec2 polar = toPolar(uv);
  float radius = polar.y;
  
  // Create perspective tunnel effect
  float depth = 1.0 - radius;
  depth = pow(depth, 2.2); // Gamma correction for natural falloff
  
  // Add inward flow animation
  float flowPhase = time * flowStrength + radius * 8.0;
  depth += sin(flowPhase) * 0.05 * (1.0 - radius);
  
  return clamp(depth, 0.0, 1.0);
}

// Dynamic aperture sizing based on music response
float musicResponsiveAperture(float baseMask, float beatIntensity, float bassResponse) {
  // Beat response expands apertures
  float beatExpansion = 1.0 + beatIntensity * 0.3;
  
  // Bass response adds pulsing
  float bassPulse = sin(bassResponse * 10.0) * 0.1;
  
  // Apply modulations
  float responsiveMask = baseMask * beatExpansion + bassPulse;
  
  return clamp(responsiveMask, 0.0, 1.0);
}

// ===================================================================
// DUNGEON CORRIDOR TUNNEL FUNCTIONS
// ===================================================================

// Signed distance field for rounded rectangle (corridor tunnel shape)
float roundedRectangleSDF(vec2 uv, vec2 center, vec2 size, float radius) {
  vec2 d = abs(uv - center) - size;
  return length(max(d, 0.0)) + min(max(d.x, d.y), 0.0) - radius;
}

// Apply perspective transformation for 3D tunnel illusion
vec2 perspectiveTunnelTransform(vec2 uv, float depth, float focalLength) {
  // Transform to centered coordinates
  vec2 centered = uv - 0.5;
  
  // Apply perspective projection with vanishing point at center
  float perspectiveFactor = focalLength / (focalLength + depth);
  vec2 perspective = centered * perspectiveFactor;
  
  // Return to UV space
  return perspective + 0.5;
}

// Calculate surface normal from SDF for lighting
vec2 tunnelNormalFromSDF(vec2 uv, vec2 center, vec2 size, float radius) {
  const float epsilon = 0.001;
  
  float centerSDF = roundedRectangleSDF(uv, center, size, radius);
  float rightSDF = roundedRectangleSDF(uv + vec2(epsilon, 0.0), center, size, radius);
  float upSDF = roundedRectangleSDF(uv + vec2(0.0, epsilon), center, size, radius);
  
  return normalize(vec2(rightSDF - centerSDF, upSDF - centerSDF));
}

// Advanced lighting system for dungeon corridors
vec3 calculateTunnelLighting(vec2 uv, float tunnelMask, vec2 normal, float depth, float time, float intensity) {
  // ===== AMBIENT SHADOW LAYER =====
  // Create dark base for corridor walls
  float ambientShadow = 0.15; // Base darkness level
  vec3 shadowColor = vec3(0.05, 0.08, 0.12); // Cool blue-gray shadows
  
  // ===== EDGE HIGHLIGHT LAYER =====
  // Bright rim lighting along corridor edges using surface normals
  float edgeIntensity = 1.0 - smoothstep(0.0, 0.3, tunnelMask);
  float edgeHighlight = pow(edgeIntensity, 2.0) * 0.8;
  
  // Edge lighting color shifts with music (warmer for high energy)
  vec3 edgeLightColor = mix(
    vec3(0.4, 0.5, 0.8), // Cool blue edge light
    vec3(0.8, 0.6, 0.3), // Warm orange edge light
    intensity * 0.7
  );
  
  // ===== END LIGHT SOURCE =====
  // Dynamic light at tunnel end that pulses with music
  float distanceFromCenter = length(uv - vec2(0.5));
  float endLightFalloff = 1.0 / (1.0 + distanceFromCenter * 4.0); // Inverse square falloff
  
  // Music-responsive light intensity with animation effect
  float lightPulse = sin(time * 2.0) * 0.3 + 0.7;
  float endLightIntensity = intensity * lightPulse * endLightFalloff;
  
  // End light color temperature (cooler when distant, warmer when close)
  vec3 endLightColor = mix(
    vec3(0.3, 0.4, 0.9), // Cool distant light
    vec3(0.9, 0.7, 0.4), // Warm close light  
    endLightIntensity
  );
  
  // ===== FRESNEL EFFECT =====
  // Edge lighting intensity based on viewing angle
  vec2 viewDirection = normalize(uv - vec2(0.5));
  float fresnel = pow(1.0 - abs(dot(normal, viewDirection)), 2.0);
  
  // ===== COMBINE LIGHTING LAYERS =====
  vec3 ambientLayer = shadowColor * ambientShadow;
  vec3 edgeLayer = edgeLightColor * edgeHighlight * fresnel;
  vec3 endLayer = endLightColor * endLightIntensity * tunnelMask;
  
  // Apply depth-based attenuation
  float depthAttenuation = 1.0 - smoothstep(0.0, 1.0, depth);
  
  return (ambientLayer + edgeLayer + endLayer) * depthAttenuation;
}

// Create multiple dungeon corridor tunnels with realistic lighting
float dungeonCorridorTunnels(vec2 uv, float time, float intensity) {
  // ===== MAIN CORRIDOR TUNNELS =====
  float corridorCount = 4.0;
  float minCorridorDistance = 2.0;
  
  for(float i = 0.0; i < corridorCount; i += 1.0) {
    float corridorAngle = (i / corridorCount) * 2.0 * 3.14159 + time * 0.05;
    
    // Corridor center position with slight offset for smooth feel
    vec2 corridorOffset = vec2(
      cos(corridorAngle) * 0.25,
      sin(corridorAngle) * 0.25
    );
    vec2 corridorCenter = vec2(0.5) + corridorOffset;
    
    // Apply perspective transformation for depth illusion
    float depth = 0.3 + sin(time * 0.3 + i) * 0.1;
    vec2 perspectiveUV = perspectiveTunnelTransform(uv, depth, 2.0);
    
    // Create elongated corridor tunnel shape
    vec2 corridorSize = vec2(0.15, 0.04) * (1.0 + intensity * 0.3); // Width varies with music
    float cornerRadius = 0.01;
    
    // Calculate distance to this corridor tunnel
    float corridorDistance = roundedRectangleSDF(perspectiveUV, corridorCenter, corridorSize, cornerRadius);
    minCorridorDistance = min(minCorridorDistance, corridorDistance);
  }
  
  // ===== SECONDARY TUNNEL LAYER =====
  // Add smaller secondary tunnels for depth complexity
  float secondaryCount = 2.0;
  float minSecondaryDistance = 2.0;
  
  for(float i = 0.0; i < secondaryCount; i += 1.0) {
    float secondaryAngle = (i / secondaryCount) * 2.0 * 3.14159 + time * 0.08 + 1.57;
    
    vec2 secondaryOffset = vec2(
      cos(secondaryAngle) * 0.15,
      sin(secondaryAngle) * 0.15  
    );
    vec2 secondaryCenter = vec2(0.5) + secondaryOffset;
    
    // Deeper perspective for secondary tunnels
    float secondaryDepth = 0.5 + sin(time * 0.2 + i) * 0.1;
    vec2 secondaryPerspectiveUV = perspectiveTunnelTransform(uv, secondaryDepth, 2.5);
    
    vec2 secondarySize = vec2(0.08, 0.025) * (1.0 + intensity * 0.2);
    float secondaryDistance = roundedRectangleSDF(secondaryPerspectiveUV, secondaryCenter, secondarySize, 0.005);
    minSecondaryDistance = min(minSecondaryDistance, secondaryDistance);
  }
  
  // ===== COMBINE TUNNEL LAYERS =====
  float primaryMask = 1.0 - smoothstep(0.0, 0.02, minCorridorDistance);
  float secondaryMask = 1.0 - smoothstep(0.0, 0.015, minSecondaryDistance);
  secondaryMask *= 0.7; // Dimmer secondary tunnels
  
  float combinedMask = max(primaryMask, secondaryMask);
  
  // ===== RADIAL FALLOFF FOR FOCUS =====
  vec2 center = uv - vec2(0.5);
  float radialDistance = length(center);
  float radialFalloff = 1.0 - smoothstep(0.2, 0.8, radialDistance);
  
  // ===== ORGANIC BREATHING PATTERN =====
  float animationCycle = 0.9 + sin(time * 0.4) * 0.1;
  
  return clamp(combinedMask * radialFalloff * animationCycle, 0.0, 1.0);
}

// Enhanced corridor gradient reveal with advanced dual-layer blending
vec4 corridorGradientReveal(vec2 uv, sampler2D gradientTex, float corridorMask, float time, float intensity) {
  // ===== ENHANCED BASE LAYER: Musical flow with visualEffects awareness =====
  vec2 baseFlowUV = uv;
  vec2 flowDirection = normalize(vec2(1.0, 0.0));
  
  // Enhanced musical flow with multi-frequency modulation
  #ifdef HAS_FLOW_UNIFORMS
    flowDirection = normalize(u_musicalFlow.xy + vec2(0.001, 0.0));
  #endif
  
  // Multi-layered flow animation with visualEffects patterns
  float primaryFlow = sin(time * 0.1) * 0.02;
  float smoothFlow = sin(time * 0.07) * 0.015;
  float visualEffectsFlow = sin(time * 0.13) * 0.008;
  
  baseFlowUV += flowDirection * (primaryFlow + smoothFlow + visualEffectsFlow);
  vec4 baseGradient = texture(gradientTex, vec2(baseFlowUV.x, 0.5));
  
  // Enhanced base layer with depth awareness
  vec2 polar = toPolar(uv);
  float baseDepthModulation = 1.0 + polar.y * 0.2; // Subtle depth variation
  baseGradient.rgb *= baseDepthModulation;
  
  // ===== ENHANCED CORRIDOR LAYER: Multi-dimensional inward flow =====
  float angle = polar.x;
  float radius = polar.y;
  
  // Advanced inward flow with multi-phase animation
  float primaryInwardPhase = time * 0.15 + radius * 6.0;
  float secondaryInwardPhase = time * 0.08 + radius * 4.5;
  float visualEffectsInwardPhase = time * 0.22 + radius * 8.0;
  
  // Multi-layered inward flow combining multiple patterns
  float primaryInwardFlow = radius - (sin(primaryInwardPhase) * 0.1);
  float secondaryInwardFlow = radius - (cos(secondaryInwardPhase) * 0.06);
  float visualEffectsInwardFlow = radius - (sin(visualEffectsInwardPhase) * 0.04);
  
  float combinedInwardFlow = mix(
    mix(primaryInwardFlow, secondaryInwardFlow, 0.3),
    visualEffectsInwardFlow, 0.2
  );
  
  // Enhanced gradient sampling with dual-layer coordination
  vec2 corridorFlowUV = vec2(
    fract(angle / (2.0 * 3.14159) + time * 0.02), // Slow rotation for smooth feel
    clamp(combinedInwardFlow, 0.0, 1.0)
  );
  vec4 corridorGradient = texture(gradientTex, corridorFlowUV);
  
  // ===== ADVANCED DEPTH AND PERSPECTIVE =====
  float depth = calculatePerspectiveDepth(uv, time, intensity);
  
  // Enhanced tunnel brightness with smooth variation
  float smoothBrightnessVariation = sin(angle * 3.0 + time * 0.3) * 0.1;
  float tunnelBrightness = 1.0 + depth * 0.9 + smoothBrightnessVariation;
  corridorGradient.rgb *= tunnelBrightness;
  
  // Advanced color shift with visualEffects-aware color temperature
  vec3 warmShift = vec3(1.15, 1.05, 0.85); // Warm center
  vec3 coolShift = vec3(0.9, 1.0, 1.1);    // Cool edges
  vec3 colorTemperature = mix(coolShift, warmShift, depth);
  corridorGradient.rgb = mix(corridorGradient.rgb, corridorGradient.rgb * colorTemperature, depth * 0.4);
  
  // ===== ENHANCED DUAL-LAYER BLENDING =====
  // Multi-stage aperture masking for smooth blending
  float softApertureMask = smoothstep(0.2, 0.8, corridorMask);
  float sharpApertureMask = smoothstep(0.4, 0.6, corridorMask);
  float smoothApertureMask = mix(softApertureMask, sharpApertureMask, 0.6);
  
  // Enhanced blending with visualEffects-aware mixing
  float visualEffectsBlendFactor = 0.7 + sin(time * 0.4 + radius * 4.0) * 0.2;
  float dynamicIntensity = intensity * visualEffectsBlendFactor;
  
  // Primary blend: base and corridor layers
  vec4 primaryBlend = mix(baseGradient, corridorGradient, smoothApertureMask * dynamicIntensity);
  
  // ===== ADVANCED APERTURE EFFECTS =====
  // Enhanced rim lighting with smooth variation 
  float rimLightBase = corridorMask * (1.0 - smoothApertureMask);
  float rimLightVariation = sin(angle * 4.0 + time * 0.5) * 0.3 + 0.7;
  float enhancedRimLight = rimLightBase * rimLightVariation * 0.6;
  
  // Aperture glow effect for depth illusion
  float apertureGlow = softApertureMask * (1.0 - sharpApertureMask) * 0.4;
  vec3 glowColor = corridorGradient.rgb * 1.2;
  
  // ===== VISUAL_EFFECTS-AWARE COLOR HARMONIZATION =====
  // Harmonize colors between layers for smooth visualEffects effect
  vec3 harmonizedColor = mix(
    primaryBlend.rgb,
    (primaryBlend.rgb + corridorGradient.rgb) * 0.5,
    smoothApertureMask * 0.3
  );
  
  // Final composition with enhanced rim and glow effects
  vec4 finalColor = vec4(harmonizedColor, primaryBlend.a);
  finalColor.rgb += vec3(enhancedRimLight) * dynamicIntensity;
  finalColor.rgb += glowColor * apertureGlow * dynamicIntensity;
  
  // Smooth animation effect for visualEffects integration
  float animationCycle = 0.95 + sin(time * 0.3) * 0.05;
  finalColor.rgb *= animationCycle;
  
  return finalColor;
}

// Advanced dungeon corridor gradient reveal with realistic lighting
vec4 dungeonCorridorGradientReveal(vec2 uv, sampler2D gradientTex, float corridorMask, float time, float intensity) {
  // ===== BASE LAYER: Dark stone/metal corridor walls =====
  vec4 baseWallColor = vec4(0.1, 0.12, 0.15, 1.0); // Dark stone base
  
  // ===== CORRIDOR TUNNEL CALCULATION =====
  // Use dungeon corridor tunnels instead of simple bubbles
  float tunnelMask = dungeonCorridorTunnels(uv, time, intensity);
  
  // ===== LIGHTING CALCULATION =====
  // Calculate lighting for tunnel areas
  vec2 tunnelCenter = vec2(0.5); // Simplified center for normal calculation
  vec2 tunnelSize = vec2(0.15, 0.04);
  vec2 surfaceNormal = tunnelNormalFromSDF(uv, tunnelCenter, tunnelSize, 0.01);
  
  float depth = length(uv - vec2(0.5)) * 0.5; // Distance-based depth
  vec3 tunnelLighting = calculateTunnelLighting(uv, tunnelMask, surfaceNormal, depth, time, intensity);
  
  // ===== CORRIDOR LAYER: Inward flowing magical light =====
  // Convert to polar coordinates for inward flow calculation
  vec2 polar = toPolar(uv);
  float angle = polar.x;
  float radius = polar.y;
  
  // Create magical inward flow animation - light streams toward center
  float magicalFlowPhase = time * 0.2 + radius * 8.0; // Faster flow for magical effect
  float inwardFlow = radius - (sin(magicalFlowPhase) * 0.15); // More dramatic flow
  
  // Sample gradient using inward flow for magical light colors
  vec2 corridorFlowUV = vec2(
    angle / (2.0 * 3.14159), // Normalize angle for gradient sampling
    clamp(inwardFlow, 0.0, 1.0) // Use inward flow for magical color variation
  );
  vec4 magicalLightGradient = texture(gradientTex, corridorFlowUV);
  
  // ===== ENHANCE MAGICAL LIGHT WITH MUSIC RESPONSIVENESS =====
  // Enhance magical light colors based on music intensity
  magicalLightGradient.rgb *= 1.5 + intensity * 0.8; // Brighter with music
  
  // Add magical shimmer effect
  float shimmerPhase = time * 4.0 + uv.x * 10.0 + uv.y * 8.0;
  float shimmer = sin(shimmerPhase) * 0.1 + 0.9;
  magicalLightGradient.rgb *= shimmer;
  
  // ===== DEPTH AND PERSPECTIVE EFFECTS =====
  float perspectiveDepth = calculatePerspectiveDepth(uv, time, intensity * 1.2);
  
  // Enhance magical light with depth - brighter toward tunnel end
  float tunnelEndBrightness = 1.0 + perspectiveDepth * 1.5;
  magicalLightGradient.rgb *= tunnelEndBrightness;
  
  // ===== CORRIDOR WALL TEXTURING =====
  // Add stone/metal texture to walls using noise-like patterns
  float wallTexturePhase = uv.x * 20.0 + uv.y * 15.0;
  float wallTexture = sin(wallTexturePhase) * 0.1 + 0.9;
  baseWallColor.rgb *= wallTexture;
  
  // ===== ADVANCED APERTURE BLENDING =====
  // Smooth tunnel aperture with realistic falloff
  float apertureMask = smoothstep(0.1, 0.8, tunnelMask);
  
  // ===== LIGHTING INTEGRATION =====
  // Apply calculated lighting to both wall and magical light
  vec4 litWallColor = baseWallColor;
  litWallColor.rgb += tunnelLighting; // Add ambient shadows, edge highlights, end illumination
  
  // Blend wall color with magical light streaming through tunnels
  vec4 finalColor = mix(litWallColor, magicalLightGradient, apertureMask * intensity);
  
  // ===== RIM LIGHTING FOR DEPTH ILLUSION =====
  // Enhanced rim lighting around tunnel apertures
  float rimIntensity = tunnelMask * (1.0 - apertureMask) * 0.8;
  vec3 rimColor = mix(
    vec3(0.3, 0.4, 0.8), // Cool rim light
    vec3(0.8, 0.5, 0.2), // Warm rim light
    intensity
  );
  finalColor.rgb += rimColor * rimIntensity;
  
  // ===== ATMOSPHERIC PERSPECTIVE =====
  // Add slight fog/haze effect for distance illusion
  float atmosphericHaze = depth * 0.2;
  vec3 hazeColor = vec3(0.15, 0.18, 0.25);
  finalColor.rgb = mix(finalColor.rgb, hazeColor, atmosphericHaze);
  
  return finalColor;
}`,es=`
// Time and resolution (universal)
uniform float u_time;
uniform vec2 u_resolution;

// Enhanced visualEffects field uniforms
uniform float u_rhythmicPulse;
uniform vec2 u_musicalFlow;
uniform float u_energyResonance;
uniform float u_animationCycle;
uniform float u_surfaceFluidityIndex;

// Advanced visualEffects control uniforms
uniform float u_visualEffectsLevel;        // 0-1 current visualEffects intensity
uniform float u_awarenessLevel;           // 0-1 current awareness depth
uniform float u_emotionalIntensity;       // 0-1 emotional resonance strength
uniform float u_memoryIntensity;          // 0-1 visualEffects memory patterns
uniform vec2 u_temporalFlowDirection;     // Year 3000 temporal stream direction
uniform float u_visualEffectsTemperature; // Color temperature shift from visualEffects

// Enhanced music sync uniforms
uniform float u_musicEnergy;
uniform float u_musicValence;
uniform float u_beatIntensity;
uniform float u_bassResponse;
uniform float u_musicalVisualEffectsSync; // Music-visualEffects synchronization level
uniform float u_genreVisualEffectsShift;  // Genre-specific visualEffects adjustments

// Corridor-specific uniforms
uniform float u_corridorIntensity;
uniform float u_corridorFlowStrength;
uniform float u_corridorDepthEffect;
uniform float u_corridorBubbleScale;

// Dungeon corridor uniforms
uniform float u_dungeonEnabled;
uniform float u_tunnelWidth;
uniform float u_lightingIntensity;
uniform float u_atmosphericHaze;
uniform vec3 u_wallColor;`,Ne=class{static buildFragmentShader(t){let{precision:e="precision mediump float;",additionalUniforms:i="",additionalFunctions:a="",mainShaderLogic:r,includeNoiseFunctions:n=!0,includeVisualEffectsFunctions:s=!0,includeCorridorFunctions:o=!1}=t,c=`#version 300 es
${e}

`;return c+=es+`

`,i&&(c+=i+`

`),c+=`out vec4 fragColor;

`,n&&(c+=Xn+`

`),s&&(c+=Zn+`

`),o&&(c+=Jn+`

`),a&&(c+=a+`

`),c+=`void main() {
`,c+=`  vec2 uv = gl_FragCoord.xy / u_resolution.xy;

`,c+=r,c+=`
}`,c}static getStandardUniformNames(){return["u_time","u_resolution","u_rhythmicPulse","u_musicalFlow","u_energyResonance","u_animationCycle","u_surfaceFluidityIndex","u_visualEffectsLevel","u_awarenessLevel","u_emotionalIntensity","u_memoryIntensity","u_temporalFlowDirection","u_visualEffectsTemperature","u_musicEnergy","u_musicValence","u_beatIntensity","u_bassResponse","u_musicalVisualEffectsSync","u_genreVisualEffectsShift"]}static getWebGLUniformNames(){return[...this.getStandardUniformNames(),"u_gradientTex","u_flowStrength","u_noiseScale","u_colorIntensity","u_patternScale","u_animationSpeed"]}static getLiquidUniformNames(){return[...this.getStandardUniformNames(),"u_gradientTex","u_flowStrength","u_noiseScale","u_liquidPhase","u_animationIntensity","u_auroraFlow","u_flowDirection","u_liquidTurbulence","u_visualEffectsDepth","u_waveY","u_waveHeight","u_waveOffset","u_blurExp","u_blurMax"]}static getCorridorUniformNames(){return["u_time","u_resolution","u_gradientTex","u_rhythmicPulse","u_musicalFlow","u_energyResonance","u_animationCycle","u_surfaceFluidityIndex","u_musicEnergy","u_musicValence","u_beatIntensity","u_bassResponse","u_corridorIntensity","u_corridorFlowStrength","u_corridorDepthEffect","u_corridorBubbleScale"]}static getTunnelVisualizationUniformNames(){return[...this.getCorridorUniformNames(),"u_tunnelEnabled","u_tunnelWidth","u_lightingIntensity","u_atmosphericHaze","u_wallColor"]}},X=class{static musicFlowLogic(){return`
  // Calculate enhanced music-driven flow
  vec2 flowDirection = calculateMusicalFlow(vec2(1.0, 0.5), u_musicalFlow, 0.5);
  float flowStrength = rhythmicPulseModulation(0.5, u_rhythmicPulse, 0.3);
  
  // Add temporal flow patterns for Year 3000 effects
  vec2 temporalFlow = temporalFlowDirection(uv, u_time, u_temporalFlowDirection);
  flowDirection += temporalFlow;
  
  // Apply enhanced animation modulation with emotional resonance
  float animationMod = deepVisualEffectsPulsing(u_time, 0.0, u_emotionalIntensity);
  flowStrength *= (1.0 + animationMod);
  
  // Apply visualEffects field intensity
  float fieldIntensity = visualEffectsFieldIntensity(uv, u_time, u_musicEnergy);
  flowStrength *= (0.5 + fieldIntensity * 0.5);`}static audioNoiseSampling(){return`
  // Generate enhanced audio-modulated noise
  vec2 noiseUV = uv + flowDirection * u_time * 0.03;
  
  // Multi-layered visualEffects noise patterns
  float noise1 = snoise(noiseUV * 2.0);
  float noise2 = snoise(noiseUV * 4.0) * 0.5;
  float memoryNoise = snoise(noiseUV * 1.5 + u_time * 0.01) * u_memoryIntensity * 0.3;
  
  // Apply visualEffects field modulation
  float visualEffectsModulation = visualEffectsFieldIntensity(noiseUV, u_time, u_musicEnergy);
  
  // Combine noise with enhanced visualEffects influence
  float t = (noise1 + noise2 + memoryNoise) * energyResonanceModulation(1.0, u_energyResonance, 0.5, 1.5);
  t *= visualEffectsModulation;
  t = clamp(t * 0.5 + 0.5, 0.0, 1.0);`}static visualEffectsVignette(){return`
  // Apply enhanced visualEffects-aware vignette
  vec2 center = uv - 0.5;
  float animation = deepVisualEffectsPulsing(u_time, u_animationCycle, u_emotionalIntensity);
  
  // Add surface visualEffects flow for smooth boundaries
  float surfaceFlow = surfaceVisualEffectsFlow(uv, u_surfaceFluidityIndex, u_awarenessLevel);
  
  // Calculate visualEffects-aware vignette with surface dynamics
  float vignette = (0.9 + animation + surfaceFlow) - dot(center, center) * 0.3;
  
  // Apply awareness resonance to color
  color.rgb = awarenessResonance(color.rgb, u_visualEffectsLevel, u_musicEnergy);
  color.rgb *= vignette;`}static musicResponsiveAlpha(){return`
  // Music-responsive alpha modulation
  float musicAlpha = 0.8 + u_beatIntensity * 0.2 + u_bassResponse * 0.1;
  color.a *= musicAlpha;`}static auroraShimmerEffect(){return`
  // Aurora shimmer overlay
  float shimmerPhase = u_time * 3.0 + uv.x * 15.0 + uv.y * 10.0;
  float shimmer = sin(shimmerPhase) * 0.03 + 0.97;
  color.rgb *= shimmer;`}},er=class{static webglGradientFragment(){return`
  ${X.musicFlowLogic()}
  
  // WebGL-specific gradient sampling
  ${X.audioNoiseSampling()}
  
  // Sample gradient texture
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  
  // Apply visualEffects effects
  ${X.visualEffectsVignette()}
  ${X.musicResponsiveAlpha()}
  
  fragColor = color;`}static liquidEffectsFragment(){return`
  ${X.musicFlowLogic()}
  
  // Liquid-specific turbulence and phase
  float liquidPhase = u_liquidPhase + u_rhythmicPulse * 0.5;
  vec2 turbulenceUV = uv * u_liquidTurbulence;
  float turbulence = snoise(turbulenceUV + u_time * 0.01);
  
  // Liquid visualEffects noise
  vec2 liquidUV = uv + flowDirection * u_time * 0.03;
  liquidUV += vec2(sin(u_time * 0.04 + liquidPhase), cos(u_time * 0.03 + liquidPhase)) * 0.02;
  float liquidNoise = snoise(liquidUV * 2.0 + turbulence * 0.1);
  
  float t = clamp(liquidNoise * 0.5 + 0.5, 0.0, 1.0);
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  
  ${X.visualEffectsVignette()}
  ${X.auroraShimmerEffect()}
  ${X.musicResponsiveAlpha()}
  
  fragColor = color;`}static corridorBubbleFragment(){return`
  ${X.musicFlowLogic()}
  
  // Calculate corridor bubble mask
  float corridorMask = bubbleCorridors(uv, u_time, u_corridorIntensity * u_corridorBubbleScale);
  
  // Apply music-responsive aperture modulation
  corridorMask = musicResponsiveAperture(corridorMask, u_beatIntensity, u_bassResponse);
  
  // Generate corridor gradient reveal effect
  vec4 color = corridorGradientReveal(uv, u_gradientTex, corridorMask, u_time, u_corridorIntensity);
  
  // Apply visualEffects effects
  ${X.visualEffectsVignette()}
  
  // Enhanced music responsiveness for corridor effects
  float corridorMusicAlpha = 0.85 + u_beatIntensity * 0.15 + u_bassResponse * 0.05;
  color.a *= corridorMusicAlpha;
  
  // Apply corridor depth effect for enhanced dimensionality
  float depth = calculatePerspectiveDepth(uv, u_time, u_corridorFlowStrength);
  color.rgb = mix(color.rgb, color.rgb * (1.0 + depth * 0.3), u_corridorDepthEffect);
  
  fragColor = color;`}static dungeonCorridorFragment(){return`
  ${X.musicFlowLogic()}
  
  // Calculate dungeon corridor tunnel mask
  float corridorMask = dungeonCorridorTunnels(uv, u_time, u_corridorIntensity * u_corridorBubbleScale);
  
  // Apply music-responsive corridor modulation  
  corridorMask = musicResponsiveAperture(corridorMask, u_beatIntensity, u_bassResponse);
  
  // Generate advanced dungeon corridor gradient reveal effect with realistic lighting
  vec4 color = dungeonCorridorGradientReveal(uv, u_gradientTex, corridorMask, u_time, u_corridorIntensity);
  
  // Apply visualEffects effects for smooth integration
  ${X.visualEffectsVignette()}
  
  // Enhanced music responsiveness for dungeon atmosphere
  float dungeonMusicAlpha = 0.9 + u_beatIntensity * 0.1 + u_bassResponse * 0.05;
  color.a *= dungeonMusicAlpha;
  
  // Apply corridor depth effect for enhanced dimensionality
  float depth = calculatePerspectiveDepth(uv, u_time, u_corridorFlowStrength);
  color.rgb = mix(color.rgb, color.rgb * (1.0 + depth * 0.4), u_corridorDepthEffect);
  
  // Add subtle magical shimmer for mystical atmosphere
  float magicalShimmer = sin(u_time * 5.0 + uv.x * 12.0 + uv.y * 8.0) * 0.05 + 0.95;
  color.rgb *= magicalShimmer;
  
  fragColor = color;`}static advancedVisualEffectsFieldFragment(){return`
  ${X.musicFlowLogic()}
  
  // Calculate multi-dimensional visualEffects field
  float visualEffectsField = visualEffectsFieldIntensity(uv, u_time, u_musicEnergy);
  
  // Apply temporal flow effects for Year 3000 streaming
  vec2 temporalUV = uv + temporalFlowDirection(uv, u_time, u_temporalFlowDirection);
  
  // Enhanced visualEffects noise sampling with memory patterns
  ${X.audioNoiseSampling()}
  
  // Sample gradient with visualEffects field modulation
  vec4 color = texture(u_gradientTex, vec2(t * visualEffectsField, 0.5));
  
  // Apply awareness resonance for visualEffects-aware color
  color.rgb = awarenessResonance(color.rgb, u_visualEffectsLevel, u_musicEnergy);
  
  // Enhanced surface visualEffects effects
  float surfaceEffect = surfaceVisualEffectsFlow(temporalUV, u_surfaceFluidityIndex, u_awarenessLevel);
  color.rgb *= (1.0 + surfaceEffect * 0.3);
  
  // Apply visualEffects memory animation
  float memoryPulsing = visualEffectsMemoryPulsing(u_time, u_animationCycle, u_memoryIntensity);
  color.a *= (0.8 + memoryPulsing * 0.2 + u_beatIntensity * 0.1);
  
  // Enhanced visualEffects vignette
  ${X.visualEffectsVignette()}
  
  fragColor = color;`}static surfaceVisualEffectsDynamicsFragment(){return`
  ${X.musicFlowLogic()}
  
  // Calculate surface visualEffects position with flow
  vec2 surfaceUV = uv;
  surfaceUV += temporalFlowDirection(uv, u_time, u_temporalFlowDirection);
  
  // Apply surface visualEffects flow for smooth boundaries
  float surfaceFlow = surfaceVisualEffectsFlow(surfaceUV, u_surfaceFluidityIndex, u_awarenessLevel);
  surfaceUV += vec2(surfaceFlow * 0.02);
  
  // Enhanced noise sampling with surface distortion
  vec2 noiseUV = surfaceUV + flowDirection * u_time * 0.03;
  float surfaceNoise = snoise(noiseUV * 3.0 + surfaceFlow);
  float visualEffectsNoise = snoise(noiseUV * 1.5) * u_visualEffectsLevel;
  
  // Combine surface and visualEffects noise
  float t = (surfaceNoise * 0.6 + visualEffectsNoise * 0.4) * 0.5 + 0.5;
  t = clamp(t, 0.0, 1.0);
  
  // Sample gradient with surface visualEffects modulation
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  
  // Apply visualEffects field influence to surface
  float fieldInfluence = visualEffectsFieldIntensity(surfaceUV, u_time, u_musicEnergy);
  color.rgb = awarenessResonance(color.rgb, fieldInfluence, u_musicEnergy);
  
  // Enhanced surface animation with emotional resonance
  float surfacePulsing = deepVisualEffectsPulsing(u_time, u_animationCycle, u_emotionalIntensity);
  color.rgb *= (0.9 + surfacePulsing * 0.2 + surfaceFlow * 0.1);
  
  // Musical visualEffects synchronization
  color.a *= (0.85 + u_musicalVisualEffectsSync * 0.15 + u_beatIntensity * 0.1);
  
  // Apply enhanced vignette with surface dynamics
  ${X.visualEffectsVignette()}
  
  fragColor = color;`}},tr=class{static generateOptimizedShader(t,e){switch(e){case"high":return t;case"medium":return t.replace(/snoise\(.*?\)/g,"snoise($1)").replace(/\* 0\.0[1-9]/g,"* 0.02");case"low":return t.replace(/snoise\(.*?\) \* 0\.[0-9]+/g,"0.5").replace(/sin\(.*?\) \* 0\.[0-9]+/g,"0.0");default:return t}}static calculateShaderComplexity(t){let e=0;return e+=(t.match(/snoise/g)||[]).length*10,e+=(t.match(/sin|cos|tan/g)||[]).length*2,e+=(t.match(/texture/g)||[]).length*3,e+=(t.match(/mix|smoothstep/g)||[]).length*1,e}static generateFallbackShader(){return Ne.buildFragmentShader({includeNoiseFunctions:!1,includeVisualEffectsFunctions:!1,additionalUniforms:"uniform sampler2D u_gradientTex;",mainShaderLogic:`
  // Minimal fallback visualEffects shader
  float t = uv.x + sin(u_time * 0.5 + u_rhythmicPulse) * 0.1;
  t = clamp(t, 0.0, 1.0);
  
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  color.a *= 0.8 + u_beatIntensity * 0.2;
  
  fragColor = color;`})}},ir={Template:Ne,VERTEX_SHADER:wl,NOISE_FUNCTIONS:Xn,VISUAL_EFFECTS_FUNCTIONS:Zn,CORRIDOR_FUNCTIONS:Jn,STANDARD_UNIFORMS:es,LogicPatterns:X,Fragments:er,Optimization:tr,AdvancedEffects:{VISUAL_EFFECTS_FIELD_PATTERNS:["visualEffectsFieldIntensity","awarenessResonance","temporalFlowDirection","surfaceVisualEffectsFlow","visualEffectsMemoryPulsing"],YEAR_3000_PATTERNS:["temporalFlowDirection","visualEffectsMemoryPulsing","deepVisualEffectsPulsing"],MEMBRANE_DYNAMICS:["surfaceVisualEffectsFlow","surfaceFluidityEffect"]}}});var Tl,Pl,xe,xi=y(()=>{"use strict";G();U();k();oe();A();pt();ne();ts();Tl=Ne.buildFragmentShader({additionalUniforms:`
// WebGL-specific uniforms
uniform sampler2D u_gradientTex;
uniform float u_flowStrength;
uniform float u_noiseScale;
uniform float u_colorIntensity;
uniform float u_patternScale;
uniform float u_animationSpeed;

// Wave stack uniforms
uniform float u_waveY[2];
uniform float u_waveHeight[2];
uniform float u_waveOffset[2];
uniform float u_blurExp;
uniform float u_blurMax;`,additionalFunctions:`
// Octave noise for richer detail
float octaveNoise(vec2 uv, float octaves, float persistence, float scale) {
  float value = 0.0;
  float amplitude = 1.0;
  float frequency = scale;
  float maxValue = 0.0;

  for(float i = 0.0; i < octaves; i++) {
    value += snoise(uv * frequency) * amplitude;
    maxValue += amplitude;
    amplitude *= persistence;
    frequency *= 2.0;
  }

  return value / maxValue;
}

// Wave alpha calculation
float waveAlpha(vec2 uv, int waveIndex) {
  float y = uv.y;
  float waveCenter = u_waveY[waveIndex];
  float waveHeight = u_waveHeight[waveIndex];

  float distance = abs(y - waveCenter);
  return 1.0 - smoothstep(0.0, waveHeight * 0.5, distance);
}

// Dynamic blur calculation
float calculateBlur(vec2 uv) {
  vec2 center = vec2(0.5, 0.5);
  float distance = length(uv - center);
  float blur = pow(distance, u_blurExp);
  return clamp(blur, 0.0, u_blurMax);
}`,mainShaderLogic:ir.Fragments.webglGradientFragment()}),Pl=Ne.buildFragmentShader({additionalUniforms:`
// WebGL-specific uniforms
uniform sampler2D u_gradientTex;
uniform float u_flowStrength;
uniform float u_noiseScale;`,includeCorridorFunctions:!0,mainShaderLogic:ir.Fragments.corridorBubbleFragment()}),xe=class extends N{constructor(e=M,i,a,r=null,n=null,s=null){super(e,i,a,r,n);this.canvas=null;this.wrapper=null;this.gl=null;this.shaderProgram=null;this.corridorShaderProgram=null;this.uniforms={};this.corridorUniforms={};this.gradientTexture=null;this.vertexBuffer=null;this.vao=null;this.settings={enabled:!0,intensity:"balanced",webglPersistenceMode:"adaptive",flowStrength:.7,noiseScale:1.2,waveY:[.25,.75],waveHeight:[.4,.3],waveOffset:[2.5,-1.8],blurExp:1.2,blurMax:.6,corridorEnabled:!1,corridorIntensity:.8,corridorFlowStrength:1.2,corridorDepthEffect:.6,corridorBubbleScale:1};this.isWebGLAvailable=!1;this.animationId=null;this.startTime=0;this.lastFrameTime=0;this.frameThrottleInterval=1e3/45;this.colorHarmonyEngine=null;this.cssVisualEffectsController=null;this.eventSubscriptionIds=[];this.prefersReducedMotion=!1;this.visualEffectsChoreographer=null;this.currentVisualEffectsField=null;this.webglReady=!1;this.textureUpdatePending=!1;this.lastTextureUpdate=0;this.textureUpdateDebounceTimer=null;this.textureUpdateThrottleMs=50;this.textureUpdateDebounceMs=300;this.textureCreationInProgress=!1;this.contextLost=!1;this.pendingContextRestore=!1;this.contextLossCount=0;this.maxContextLossRetries=10;this.lastSuccessfulRender=0;this.contextRecoveryTimeouts=[100,200,400,800,1600,3200,5e3,5e3,5e3,5e3];this.currentRecoveryAttempt=0;this.currentQualityLevel=null;this.qualityCapabilities=[{name:"webgl-rendering",enabled:!0,qualityLevel:"high"},{name:"shader-complexity",enabled:!0,qualityLevel:"high"},{name:"noise-octaves",enabled:!0,qualityLevel:"medium"},{name:"wave-layers",enabled:!0,qualityLevel:"medium"},{name:"blur-effects",enabled:!0,qualityLevel:"low"},{name:"flow-strength",enabled:!0,qualityLevel:"low"},{name:"corridor-effects",enabled:!0,qualityLevel:"high"},{name:"corridor-sdf-complexity",enabled:!0,qualityLevel:"medium"},{name:"corridor-bubble-layers",enabled:!0,qualityLevel:"medium"},{name:"corridor-depth-effects",enabled:!0,qualityLevel:"low"}];this.qualityAdjustments={};this.systemName="WebGLGradientBackgroundSystem";this.lastColorHarmonizedData=null;this.lastColorHarmonizedTime=0;this.animate=()=>{if(!this.isActive||!this.gl||!this.canvas)return;let e=performance.now();if(e-this.lastFrameTime<this.frameThrottleInterval){this.animationId=requestAnimationFrame(this.animate);return}this.lastFrameTime=e,this.render(e),this.animationId=requestAnimationFrame(this.animate)};this.resize=()=>{if(!this.canvas)return;let e=window.devicePixelRatio||1,i=window.innerWidth,a=window.innerHeight;this.canvas.width=i*e,this.canvas.height=a*e,this.canvas.style.width=i+"px",this.canvas.style.height=a+"px"};this.colorHarmonyEngine=s?.colorHarmonyEngine||null,this.visualEffectsChoreographer=s?.backgroundVisualEffectsChoreographer||null,this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches}get systemPriority(){return"high"}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();let e=globalThis.year3000System;if(this.cssController=e?.cssVisualEffectsController||P(),this.isWebGLAvailable=this.checkWebGL2Support(),!this.isWebGLAvailable)if(this.shouldAttemptWebGLRecovery()){if(u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL2 not available but persistence mode enabled - attempting WebGL1 compatibility mode"),this.isWebGLAvailable=this.checkWebGL1Support(),!this.isWebGLAvailable){u?.debug?.error("WebGLGradientBackgroundSystem","Neither WebGL2 nor WebGL1 available despite persistence mode"),this.fallbackToCSSGradient();return}}else{this.fallbackToCSSGradient();return}let i=new O;await i.initialize();let a=i.recommendPerformanceQuality(),r=i.getCapabilities();if(a==="low"?(u?.debug?.log("WebGLGradientBackgroundSystem","Low performance device detected - trying minimal WebGL quality",{performanceQuality:a,deviceCapabilities:r?.overall,memoryLevel:r?.memory.level,gpuLevel:r?.gpu.level}),this.frameThrottleInterval=1e3/20,this.textureUpdateThrottleMs=1e3,this.settings.corridorEnabled=!1,this.settings.intensity="minimal",this.settings.flowStrength=.3):u?.debug?.log("WebGLGradientBackgroundSystem","Device capabilities acceptable for WebGL",{performanceQuality:a,deviceCapabilities:r?.overall}),this.loadSettings(),!this.settings.enabled){this.fallbackToCSSGradient();return}try{await this.initializeWebGL(),this.subscribeToEvents(),this.registerWithVisualEffectsChoreographer(),this.startAnimation();let n={"--sn.bg.webgl.ready":"1","--sn.bg.webgl.enabled":"1","--sn.bg.active-backend":"hybrid","--sn-gradient-crossfade-opacity":"0.5"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",n,"high","webgl-initialization"),u?.debug?.log("WebGLGradientBackgroundSystem","WebGL gradient system initialized successfully")}catch(n){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to initialize WebGL gradient:",n),this.fallbackToCSSGradient()}}checkWebGL2Support(){try{let i=document.createElement("canvas").getContext("webgl2");if(!i)return u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL2 context creation failed"),!1;let a=["EXT_color_buffer_float"],r=[];for(let o of a)i.getExtension(o)||r.push(o);r.length>0&&u?.debug?.warn("WebGLGradientBackgroundSystem","Missing WebGL2 extensions:",r);let n=i.getParameter(i.MAX_TEXTURE_SIZE),s=i.getParameter(i.MAX_RENDERBUFFER_SIZE);return u?.debug?.log("WebGLGradientBackgroundSystem","WebGL2 capability check:",{maxTextureSize:n,maxRenderbufferSize:s,missingExtensions:r.length>0?r:"none"}),!0}catch(e){return u?.debug?.error("WebGLGradientBackgroundSystem","WebGL2 support check failed:",e),!1}}checkWebGL1Support(){try{let e=document.createElement("canvas"),i=e.getContext("webgl")||e.getContext("experimental-webgl");if(!i)return u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL1 context creation failed"),!1;let a=i.getParameter(i.MAX_TEXTURE_SIZE),r=i.getParameter(i.MAX_RENDERBUFFER_SIZE);return u?.debug?.log("WebGLGradientBackgroundSystem","WebGL1 fallback capability check:",{maxTextureSize:a,maxRenderbufferSize:r}),!0}catch(e){return u?.debug?.error("WebGLGradientBackgroundSystem","WebGL1 support check failed:",e),!1}}findSpotifyContainer(){let e=[".Root__main-view",".main-view-container",".main-gridContainer-gridContainer",".Root__top-container","body"];for(let i of e){let a=document.querySelector(i);if(a)return u?.debug?.log("WebGLGradientBackgroundSystem",`Found container: ${i}`),a}return u?.debug?.warn("WebGLGradientBackgroundSystem","No Spotify container found, falling back to body"),document.body}loadSettings(){if(this.settingsManager)try{let e=this.settingsManager.get("sn-webgl-enabled"),i=this.settingsManager.get("sn-webgl-force-enabled"),a=this.settingsManager.get("sn-webgl-persistence-mode"),r=this.settingsManager.get("sn-gradient-intensity");if(e==="false"&&i!=="true"){this.settings.enabled=!1,u?.debug?.log("WebGLGradientBackgroundSystem","WebGL disabled by user setting");return}if(this.settings.webglPersistenceMode=a||"adaptive",r==="disabled"){this.settings.enabled=!1;return}switch(this.settings.intensity=r||"balanced",this.settings.intensity){case"minimal":this.settings.flowStrength=.4,this.settings.noiseScale=.8,this.settings.waveHeight=[.3,.2],this.settings.waveOffset=[1.5,-1],this.settings.blurExp=1,this.settings.blurMax=.4;break;case"balanced":this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.waveOffset=[2.5,-1.8],this.settings.blurExp=1.2,this.settings.blurMax=.6;break;case"intense":this.settings.flowStrength=1,this.settings.noiseScale=1.6,this.settings.waveHeight=[.5,.4],this.settings.waveOffset=[3.5,-2.5],this.settings.blurExp=1.4,this.settings.blurMax=.8;break}u?.debug?.log("WebGLGradientBackgroundSystem","Settings loaded:",{webglEnabled:e,webglForceEnabled:i,persistenceMode:this.settings.webglPersistenceMode,intensity:this.settings.intensity,enabled:this.settings.enabled})}catch(e){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to load settings, using defaults:",e)}}applyUpdatedSettings(e,i){if(this.settingsManager){u?.debug?.log("WebGLGradientBackgroundSystem",`Runtime setting changed: ${e} = ${i}`);try{switch(e){case"sn-webgl-enabled":i==="false"?(this.settings.enabled=!1,this.destroy()):i==="true"&&!this.settings.enabled&&(this.settings.enabled=!0,!this.gl&&this.canvas&&this.initialize());break;case"sn-webgl-force-enabled":this.settingsManager.get("sn-webgl-enabled")==="false"&&i!=="true"&&(this.settings.enabled=!1,this.destroy());break;case"sn-webgl-persistence-mode":this.settings.webglPersistenceMode=i||"adaptive",u?.debug?.log("WebGLGradientBackgroundSystem",`Persistence mode changed to: ${this.settings.webglPersistenceMode}`);break;case"sn-gradient-intensity":if(i==="disabled")this.settings.enabled=!1;else switch(this.settings.enabled=!0,this.settings.intensity=i||"balanced",this.settings.intensity){case"minimal":this.settings.flowStrength=.4,this.settings.noiseScale=.8,this.settings.waveHeight=[.3,.2],this.settings.waveOffset=[1.5,-1],this.settings.blurExp=1,this.settings.blurMax=.4;break;case"balanced":this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.waveOffset=[2.5,-1.8],this.settings.blurExp=1.2,this.settings.blurMax=.6;break;case"intense":this.settings.flowStrength=1,this.settings.noiseScale=1.6,this.settings.waveHeight=[.5,.4],this.settings.waveOffset=[3.5,-2.5],this.settings.blurExp=1.4,this.settings.blurMax=.8;break}break;default:return}this.forceRepaint?.(`setting-change:${e}`)}catch(a){u?.debug?.error("WebGLGradientBackgroundSystem",`Failed to apply runtime setting ${e}:`,a)}}}async initializeWebGL(){this.wrapper=document.createElement("div"),this.wrapper.className="sn-gradient-effects-wrapper",this.wrapper.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -11;
      pointer-events: none;
      overflow: hidden;
    `,this.canvas=document.createElement("canvas"),this.canvas.id="sn-webgl-gradient",this.canvas.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    `,this.wrapper.appendChild(this.canvas);try{if(this.gl=this.canvas.getContext("webgl2",{alpha:!0,antialias:!1,depth:!1,stencil:!1,powerPreference:"default"}),!this.gl)throw new Error("WebGL2 context creation returned null - likely unsupported");this.setupContextLossHandlers();let i=this.gl.getParameter(this.gl.VERSION);if(!i)throw new Error("WebGL2 context appears non-functional - getParameter failed");u?.debug?.log("WebGLGradientBackgroundSystem","WebGL2 context created successfully:",{version:i,renderer:this.gl.getParameter(this.gl.RENDERER),vendor:this.gl.getParameter(this.gl.VENDOR)})}catch(i){throw u?.debug?.error("WebGLGradientBackgroundSystem","WebGL2 context creation failed:",i),new Error(`Failed to create WebGL2 context: ${i instanceof Error?i.message:"Unknown error"}`)}await this.compileShaders(),this.createGeometry(),await this.updateGradientTexture(),this.setupUniforms(),this.resize(),this.findSpotifyContainer().appendChild(this.wrapper),window.addEventListener("resize",this.resize.bind(this))}async compileShaders(){if(!this.gl)throw new Error("WebGL context not available");let e=null,i=null,a="full";if(e=Q.loadVertex(this.gl,xt),!e)throw new Error("Failed to compile vertex shader - even basic vertex shader failed");let r=[{name:"full",shader:Tl,description:"Full visualEffects shader with all features"},{name:"simplified",shader:this.getSimplifiedFragmentShader(),description:"Simplified shader without complex noise functions"},{name:"basic",shader:this.getBasicFragmentShader(),description:"Basic gradient shader with minimal features"},{name:"emergency",shader:this.getEmergencyFragmentShader(),description:"Emergency shader for maximum hardware compatibility"}];for(let s of r)try{if(i=Q.loadFragment(this.gl,s.shader),i){a=s.name,u?.debug?.log("WebGLGradientBackgroundSystem",`Successfully compiled shader variant: ${s.name}`,{description:s.description});break}}catch(o){u?.debug?.warn("WebGLGradientBackgroundSystem",`Failed to compile ${s.name} shader variant:`,o);continue}if(!i)throw new Error("Failed to compile any fragment shader variant");if(this.shaderProgram=Q.createProgram(this.gl,e,i),!this.shaderProgram)throw new Error("Failed to create shader program");let n=Q.loadFragment(this.gl,Pl);if(!n){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to compile corridor shader - corridor effects disabled"),this.settings.corridorEnabled=!1;return}this.corridorShaderProgram=Q.createProgram(this.gl,e,n),this.corridorShaderProgram||(u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to create corridor shader program - corridor effects disabled"),this.settings.corridorEnabled=!1)}createGeometry(){if(!this.gl||!this.shaderProgram)return;let e=new Float32Array([-1,-1,3,-1,-1,3]);this.vertexBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.STATIC_DRAW),this.vao=this.gl.createVertexArray(),this.gl.bindVertexArray(this.vao);let i=this.gl.getAttribLocation(this.shaderProgram,"a_position");this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,0,0),this.gl.bindVertexArray(null)}setupUniforms(){!this.gl||!this.shaderProgram||(this.uniforms.u_time=this.gl.getUniformLocation(this.shaderProgram,"u_time"),this.uniforms.u_gradientTex=this.gl.getUniformLocation(this.shaderProgram,"u_gradientTex"),this.uniforms.u_resolution=this.gl.getUniformLocation(this.shaderProgram,"u_resolution"),this.uniforms.u_flowStrength=this.gl.getUniformLocation(this.shaderProgram,"u_flowStrength"),this.uniforms.u_noiseScale=this.gl.getUniformLocation(this.shaderProgram,"u_noiseScale"),this.uniforms.u_waveY=this.gl.getUniformLocation(this.shaderProgram,"u_waveY"),this.uniforms.u_waveHeight=this.gl.getUniformLocation(this.shaderProgram,"u_waveHeight"),this.uniforms.u_waveOffset=this.gl.getUniformLocation(this.shaderProgram,"u_waveOffset"),this.uniforms.u_blurExp=this.gl.getUniformLocation(this.shaderProgram,"u_blurExp"),this.uniforms.u_blurMax=this.gl.getUniformLocation(this.shaderProgram,"u_blurMax"),this.corridorShaderProgram&&this.setupCorridorUniforms())}setupCorridorUniforms(){if(!this.gl||!this.corridorShaderProgram)return;let e=Ne.getCorridorUniformNames();for(let i of e)this.corridorUniforms[i]=this.gl.getUniformLocation(this.corridorShaderProgram,i)}updateVisualEffectsUniforms(e,i){if(!this.gl)return;let a=this.currentVisualEffectsField,r=a?.pulseRate??.5;e.u_rhythmicPulse&&this.gl.uniform1f(e.u_rhythmicPulse,r);let n=a?.flowDirection??{x:0,y:0};e.u_musicalFlow&&n&&this.gl.uniform2f(e.u_musicalFlow,n.x??0,n.y??0);let s=a?.energyLevel??.5;e.u_energyResonance&&this.gl.uniform1f(e.u_energyResonance,s);let o=Math.sin(i*.05)*.5+.5;e.u_pulsingCycle&&this.gl.uniform1f(e.u_pulsingCycle,o);let c=a?.fluidIntensity??.3;if(e.u_surfaceFluidityIndex&&this.gl.uniform1f(e.u_surfaceFluidityIndex,c),this.musicSyncService){let m=this.musicSyncService.getCurrentMusicState();if(m){let d=m.beat?.energy??.5,h=m.emotion?.valence??.5,g=m.intensity??0,f=m.beat?.energy??0;e.u_musicEnergy&&this.gl.uniform1f(e.u_musicEnergy,d),e.u_musicValence&&this.gl.uniform1f(e.u_musicValence,h),e.u_beatIntensity&&this.gl.uniform1f(e.u_beatIntensity,g),e.u_bassResponse&&this.gl.uniform1f(e.u_bassResponse,f)}}}async updateGradientTexture(){if(!this.gl){u?.debug?.warn("WebGLGradientBackgroundSystem","No WebGL context available");return}if(!this.isContextValid()){u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL context invalid, attempting recovery"),this.contextLost&&!this.pendingContextRestore&&(u?.debug?.log("WebGLGradientBackgroundSystem","Attempting WebGL context recovery"),this.fallbackToCSSGradient());return}let e=this.gl.getError();if(e!==this.gl.NO_ERROR)for(u?.debug?.warn("WebGLGradientBackgroundSystem",`WebGL error detected before texture update: ${e}`);this.gl.getError()!==this.gl.NO_ERROR;);if(this.textureCreationInProgress){u?.debug?.log("WebGLGradientBackgroundSystem","Texture creation already in progress, skipping update");return}this.textureCreationInProgress=!0;try{let i=this.getDefaultGradientStops(),a="default";if(this.colorHarmonyEngine)try{let o=this.colorHarmonyEngine.getCurrentGradient(5);if(o&&o.length>0)i=o.map((c,m)=>({r:c.r/255,g:c.g/255,b:c.b/255,a:1,position:m/(o.length-1)})),a="ColorHarmonyEngine",u?.debug?.log("WebGLGradientBackgroundSystem",`Updated gradient texture with ${i.length} stops from ColorHarmonyEngine`);else{let c=this.getCSSGradientStops();c&&c.length>0&&(i=c,a="CSS variables",u?.debug?.log("WebGLGradientBackgroundSystem",`ColorHarmonyEngine returned empty, using CSS gradient fallback with ${i.length} stops`))}}catch(o){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to get gradient from ColorHarmonyEngine, trying CSS fallback:",o);let c=this.getCSSGradientStops();c&&c.length>0&&(i=c,a="CSS variables (engine failed)",u?.debug?.log("WebGLGradientBackgroundSystem",`Using CSS gradient fallback after ColorHarmonyEngine error with ${i.length} stops`))}else{let o=this.getCSSGradientStops();o&&o.length>0&&(i=o,a="CSS variables (no engine)",u?.debug?.log("WebGLGradientBackgroundSystem",`No ColorHarmonyEngine available, using CSS gradient fallback with ${i.length} stops`))}if(u?.debug?.log("WebGLGradientBackgroundSystem",`Final color source: ${a}, stops: ${i.length}`),this.gl.isContextLost())throw new Error("WebGL context was lost during gradient preparation");if(this.gradientTexture){try{this.gl.deleteTexture(this.gradientTexture)}catch(o){u?.debug?.warn("WebGLGradientBackgroundSystem","Error deleting old texture:",o)}this.gradientTexture=null}(!i||i.length===0)&&(u?.debug?.warn("WebGLGradientBackgroundSystem","No valid color stops, using defaults"),i=this.getDefaultGradientStops());let r=null,n=0,s=3;for(;!r&&n<s;){n++;try{if(this.gl.isContextLost())throw new Error("WebGL context lost during texture creation attempt");if(r=le(this.gl,i),r){u?.debug?.log("WebGLGradientBackgroundSystem",`Gradient texture created successfully on attempt ${n}`);break}}catch(o){u?.debug?.warn("WebGLGradientBackgroundSystem",`Texture creation attempt ${n} failed:`,o),n<s&&await new Promise(c=>setTimeout(c,n*10))}}if(r)this.gradientTexture=r;else{u?.debug?.error("WebGLGradientBackgroundSystem","Failed to create gradient texture after all attempts - trying default colors");try{let o=this.getDefaultGradientStops(),c=le(this.gl,o);if(!c)throw new Error("Failed to create gradient texture even with default colors");this.gradientTexture=c,i=o,u?.debug?.log("WebGLGradientBackgroundSystem","Using default gradient fallback after all attempts failed")}catch(o){u?.debug?.error("WebGLGradientBackgroundSystem","Default gradient fallback failed, attempting emergency solid color:",o);try{let c=[{r:.196,g:.165,b:.282,a:1,position:0},{r:.196,g:.165,b:.282,a:1,position:1}],m=le(this.gl,c);if(m)this.gradientTexture=m,i=c,u?.debug?.warn("WebGLGradientBackgroundSystem","Using emergency solid color texture as final fallback");else throw new Error("Emergency solid color texture creation failed")}catch(c){throw u?.debug?.error("WebGLGradientBackgroundSystem","Emergency solid color texture failed:",c),new Error(`All gradient texture creation methods failed: ${c}`)}}}this.lastTextureUpdate=performance.now(),u?.debug?.log("WebGLGradientBackgroundSystem",`Gradient texture updated successfully using ${a}`,{colorStops:i.length,source:a,firstColor:i[0]?`rgb(${Math.round(i[0].r*255)},${Math.round(i[0].g*255)},${Math.round(i[0].b*255)})`:"none"})}catch(i){if(u?.debug?.error("WebGLGradientBackgroundSystem","Critical error in updateGradientTexture:",i),i instanceof Error&&i.message.includes("context"))u?.debug?.log("WebGLGradientBackgroundSystem","WebGL context-related error detected, switching to CSS fallback"),this.fallbackToCSSGradient();else{u?.debug?.log("WebGLGradientBackgroundSystem","Attempting simple texture recovery with default colors");try{this.gradientTexture=null;let a=this.getDefaultGradientStops();if(this.gl&&!this.gl.isContextLost())if(this.gradientTexture=le(this.gl,a),this.gradientTexture)u?.debug?.log("WebGLGradientBackgroundSystem","Successfully recovered with default gradient");else throw new Error("Recovery attempt failed");else throw new Error("WebGL context unavailable for recovery")}catch(a){u?.debug?.error("WebGLGradientBackgroundSystem","Recovery attempt failed, falling back to CSS:",a),this.fallbackToCSSGradient()}}}finally{this.textureCreationInProgress=!1}}async updateGradientTextureThrottled(){let e=performance.now();if(e-this.lastTextureUpdate<this.textureUpdateThrottleMs){if(!this.textureUpdatePending){this.textureUpdatePending=!0;let i=this.textureUpdateThrottleMs-(e-this.lastTextureUpdate);setTimeout(()=>{this.textureUpdatePending=!1,this.updateGradientTexture().catch(a=>{u?.debug?.error("WebGLGradientBackgroundSystem","Throttled texture update failed:",a)})},i)}return}await this.updateGradientTexture()}debouncedUpdateGradientTexture(){this.textureUpdateDebounceTimer&&clearTimeout(this.textureUpdateDebounceTimer),this.textureUpdateDebounceTimer=window.setTimeout(()=>{this.textureUpdateDebounceTimer=null,this.updateGradientTextureThrottled().catch(e=>{u?.debug?.error("WebGLGradientBackgroundSystem","Debounced texture update failed:",e)})},this.textureUpdateDebounceMs)}setupContextLossHandlers(){if(!this.canvas)return;this.canvas.addEventListener("webglcontextlost",async i=>{if(this.contextLossCount++,u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL context lost - Enhanced Recovery",{lossCount:this.contextLossCount,maxRetries:this.maxContextLossRetries}),i.preventDefault(),this.contextLost=!0,this.textureCreationInProgress=!1,this.contextLossCount<=this.maxContextLossRetries){let a=Math.min(this.contextLossCount-1,this.contextRecoveryTimeouts.length-1),r=this.contextRecoveryTimeouts[a]||5e3;if(u?.debug?.log("WebGLGradientBackgroundSystem",`Preparing for context recovery attempt ${this.contextLossCount}/${this.maxContextLossRetries} with ${r}ms backoff`,{shouldPersist:this.shouldPersistWebGL()}),this.gl)try{let{ShaderLoader:n}=await Promise.resolve().then(()=>(pt(),Ja));n.clearContextCache(this.gl)}catch{}this.textureUpdateDebounceTimer&&(clearTimeout(this.textureUpdateDebounceTimer),this.textureUpdateDebounceTimer=null),this.textureUpdatePending=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}else this.shouldPersistWebGL()?(u?.debug?.warn("WebGLGradientBackgroundSystem",`Context lost ${this.contextLossCount} times but persistence mode enabled - resetting retry count and continuing`),this.contextLossCount=Math.max(1,this.maxContextLossRetries-3),this.currentRecoveryAttempt=0):(u?.debug?.error("WebGLGradientBackgroundSystem",`Context lost ${this.contextLossCount} times - falling back to CSS gradient`),this.fallbackToCSSGradient())},!1);let e=async()=>{if(!this.contextLost||this.pendingContextRestore)return;let i=Math.min(this.currentRecoveryAttempt,this.contextRecoveryTimeouts.length-1),a=this.contextRecoveryTimeouts[i]||5e3;u?.debug?.log("WebGLGradientBackgroundSystem",`Attempting context recovery in ${a}ms (attempt ${this.currentRecoveryAttempt+1})`),setTimeout(async()=>{if(this.contextLost){this.currentRecoveryAttempt++;try{this.gl&&this.gl.isContextLost()&&this.gl.getError()}catch(r){u?.debug?.warn("WebGLGradientBackgroundSystem","Error during context recovery attempt:",r)}this.contextLost&&this.currentRecoveryAttempt<this.maxContextLossRetries&&e()}},a)};this.canvas.addEventListener("webglcontextlost",()=>{this.currentRecoveryAttempt=0,e()}),this.canvas.addEventListener("webglcontextrestored",async()=>{u?.debug?.log("WebGLGradientBackgroundSystem","WebGL context restored - Enhanced Recovery",{lossCount:this.contextLossCount,maxRetries:this.maxContextLossRetries}),this.contextLost=!1,this.pendingContextRestore=!0;try{if(!this.gl||this.gl.isContextLost())throw new Error("Context is still lost after restore event");await this.reinitializeWebGLResources(),this.contextLossCount>=2?(u?.debug?.log("WebGLGradientBackgroundSystem","Reducing quality after multiple context losses"),this.adjustQualityForTier("low")):this.contextLossCount>=1&&(u?.debug?.log("WebGLGradientBackgroundSystem","Reducing quality after context loss"),this.adjustQualityForTier("medium")),this.startAnimation(),this.pendingContextRestore=!1,u?.debug?.log("WebGLGradientBackgroundSystem","WebGL context restore completed successfully",{lossCount:this.contextLossCount,qualityReduced:this.contextLossCount>0})}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to restore WebGL context:",i),this.pendingContextRestore=!1,this.contextLossCount++,this.contextLossCount>this.maxContextLossRetries&&(u?.debug?.error("WebGLGradientBackgroundSystem","Context restoration failed too many times - falling back to CSS"),this.fallbackToCSSGradient())}},!1)}async reinitializeWebGLResources(){if(!this.gl)throw new Error("WebGL context not available");this.shaderProgram=null,this.vertexBuffer=null,this.vao=null,this.gradientTexture=null;let{ShaderLoader:e}=await Promise.resolve().then(()=>(pt(),Ja));e.clearContextCache(this.gl),await this.compileShaders(),this.createGeometry(),await this.updateGradientTexture(),this.setupUniforms(),u?.debug?.log("WebGLGradientBackgroundSystem","WebGL resources reinitialized after context restore")}isContextValid(){return!this.gl||this.contextLost?!1:this.gl.isContextLost()?(this.contextLost=!0,!1):!0}getDefaultGradientStops(){return[{r:.196,g:.165,b:.282,a:1,position:0},{r:.549,g:.408,b:.878,a:1,position:.3},{r:.788,g:.557,b:.902,a:1,position:.6},{r:.957,g:.761,b:.494,a:1,position:1}]}getCSSGradientStops(){try{let e=document.documentElement,i=getComputedStyle(e),a=["--sn-bg-gradient-primary-rgb","--sn-bg-gradient-secondary-rgb","--sn-bg-gradient-tertiary-rgb"],r=[];for(let o=0;o<a.length;o++){let c=a[o]||"--sn-bg-gradient-primary-rgb",m=i.getPropertyValue(c).trim();if(!m){u?.debug?.log("WebGLGradientBackgroundSystem",`CSS variable ${c} not set, trying without CSS fallback`);continue}let d=m.split(",").map(h=>parseInt(h.trim(),10));if(d.length!==3||d.some(h=>isNaN(h)||h<0||h>255)){u?.debug?.warn("WebGLGradientBackgroundSystem",`Invalid RGB values in ${c}: ${m}, skipping this color`);continue}r.push({r:(d[0]??0)/255,g:(d[1]??0)/255,b:(d[2]??0)/255,a:1,position:o/(a.length-1)})}if(r.length<2)return u?.debug?.log("WebGLGradientBackgroundSystem",`Only ${r.length} valid CSS colors found, need at least 2 for gradient`),null;let n=i.getPropertyValue("--sn-bg-gradient-opacity").trim(),s=n?parseFloat(n):1;return s!==1&&s>0&&s<=1&&r.forEach(o=>{o.a=s}),u?.debug?.log("WebGLGradientBackgroundSystem",`Successfully parsed ${r.length} CSS background gradient stops from OKLAB inheritance`,{colors:r.map(o=>`rgba(${Math.round(o.r*255)},${Math.round(o.g*255)},${Math.round(o.b*255)},${o.a})`),opacity:s!==1?s:"default"}),r}catch(e){return u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to parse CSS background gradient variables:",e),null}}subscribeToEvents(){let e=p.subscribe("colors:harmonized",this.handleColorHarmonized.bind(this),"WebGLGradientBackgroundSystem");this.eventSubscriptionIds.push(e);let i=p.subscribe("colors:applied",this.handleColorApplied.bind(this),"WebGLGradientBackgroundSystem");this.eventSubscriptionIds.push(i);let a=p.subscribe("performance:tier-changed",this.handlePerformanceTierChanged.bind(this),"WebGLGradientBackgroundSystem");this.eventSubscriptionIds.push(a),u?.debug?.log("WebGLGradientBackgroundSystem","Subscribed to unified events",{subscriptionCount:this.eventSubscriptionIds.length,events:["colors:harmonized","colors:applied","performance:tier-changed"]})}handleColorHarmonized(e){let i=performance.now(),a=`${e.accentHex}-${e.processingTime}-${e.strategies.join(",")}`;if(this.lastColorHarmonizedData===a&&i-this.lastColorHarmonizedTime<100){u?.debug?.log("WebGLGradientBackgroundSystem","Duplicate color harmonization event detected, skipping");return}this.lastColorHarmonizedData=a,this.lastColorHarmonizedTime=i,this.debouncedUpdateGradientTexture(),u?.debug?.log("WebGLGradientBackgroundSystem","Color harmonization processed",{strategies:e.strategies,processingTime:e.processingTime,accentHex:e.accentHex,deduplicationHash:a.substring(0,16)+"..."})}handleColorApplied(e){u?.debug?.log("WebGLGradientBackgroundSystem","Color application coordinated",{accentHex:e.accentHex,appliedAt:e.appliedAt})}handlePerformanceTierChanged(e){if(!(!this.isActive||!this.gl))switch(u?.debug?.log("WebGLGradientBackgroundSystem","Performance tier changed",{previousTier:e.previousTier,newTier:e.tier,timestamp:e.timestamp}),e.tier){case"excellent":this.adjustQualityForTier("high");break;case"good":this.adjustQualityForTier("medium");break;case"degraded":this.adjustQualityForTier("low"),u?.debug?.warn("WebGLGradientBackgroundSystem","Performance degraded - reducing WebGL quality instead of fallback");break;case"critical":e.previousTier==="degraded"?this.shouldPersistWebGL()?(u?.debug?.warn("WebGLGradientBackgroundSystem","Critical performance but persistence mode enabled - reducing to absolute minimum WebGL quality"),this.adjustQualityForTier("emergency")):(u?.debug?.warn("WebGLGradientBackgroundSystem","Critical performance detected - falling back to CSS gradient"),this.fallbackToCSSGradient()):(this.adjustQualityForTier("minimal"),u?.debug?.warn("WebGLGradientBackgroundSystem","Critical performance - using minimal WebGL quality"));break}}adjustQualityForTier(e){if(!this.gl||!this.canvas)return;switch(e){case"high":this.frameThrottleInterval=1e3/60;break;case"medium":this.frameThrottleInterval=1e3/45;break;case"low":this.frameThrottleInterval=1e3/30;break;case"minimal":this.frameThrottleInterval=1e3/15;break;case"emergency":this.frameThrottleInterval=1e3/10;break}switch(e){case"high":this.textureUpdateThrottleMs=100;break;case"medium":this.textureUpdateThrottleMs=200;break;case"low":this.textureUpdateThrottleMs=500;break;case"minimal":this.textureUpdateThrottleMs=1e3;break;case"emergency":this.textureUpdateThrottleMs=2e3;break}let i=this.findSpotifyContainer();if(i){let r=i.getBoundingClientRect(),n=1;switch(e){case"high":n=1;break;case"medium":n=.8;break;case"low":n=.6;break;case"minimal":n=.4;break;case"emergency":n=.1;break}let s=Math.floor(r.width*n),o=Math.floor(r.height*n);this.canvas.width=s,this.canvas.height=o,this.gl&&this.gl.viewport(0,0,s,o)}let a=this.settings.corridorEnabled;switch(e){case"high":this.settings.intensity="intense",this.settings.flowStrength=Math.max(this.settings.flowStrength,.7);break;case"medium":this.settings.intensity="balanced",this.settings.flowStrength=Math.min(this.settings.flowStrength,.6);break;case"low":this.settings.corridorEnabled=!1,this.settings.intensity="minimal",this.settings.flowStrength=Math.min(this.settings.flowStrength,.4);break;case"minimal":this.settings.corridorEnabled=!1,this.settings.intensity="minimal",this.settings.flowStrength=.2;break}a!==this.settings.corridorEnabled&&u?.debug?.log("WebGLGradientBackgroundSystem",`Corridor shader ${this.settings.corridorEnabled?"enabled":"disabled"} for ${e} quality`),u?.debug?.log("WebGLGradientBackgroundSystem",`Quality adjusted for ${e} performance tier`,{frameFPS:Math.round(1e3/this.frameThrottleInterval),textureFPS:Math.round(1e3/this.textureUpdateThrottleMs),canvasResolution:`${this.canvas.width}x${this.canvas.height}`,corridorEnabled:this.settings.corridorEnabled})}startAnimation(){this.startTime=performance.now(),this.lastFrameTime=this.startTime,this.animate()}render(e){if(!this.gl||!this.vao)return;if(!this.gradientTexture){u?.debug?.warn("WebGLGradientBackgroundSystem","No gradient texture during render - creating emergency texture");try{let s=[()=>{let o=this.getCSSGradientStops();return o?le(this.gl,o):null},()=>{let o=this.getDefaultGradientStops();return le(this.gl,o)},()=>{let o=[{r:.196,g:.165,b:.282,a:1,position:0},{r:.196,g:.165,b:.282,a:1,position:1}];return le(this.gl,o)}];for(let o=0;o<s.length;o++)try{if(this.gradientTexture=s[o](),this.gradientTexture){u?.debug?.log("WebGLGradientBackgroundSystem",`Emergency texture created using method ${o+1}`);break}}catch(c){u?.debug?.warn("WebGLGradientBackgroundSystem",`Emergency texture method ${o+1} failed:`,c)}if(!this.gradientTexture){u?.debug?.error("WebGLGradientBackgroundSystem","All emergency texture creation methods failed - skipping render");return}}catch(s){u?.debug?.error("WebGLGradientBackgroundSystem","Emergency texture creation failed completely:",s);return}}if(this.lastSuccessfulRender=e,this.contextLossCount>0&&e-this.lastSuccessfulRender>3e4){let s=this.contextLossCount;this.contextLossCount=Math.max(0,this.contextLossCount-1),s!==this.contextLossCount&&u?.debug?.log("WebGLGradientBackgroundSystem","Context loss count reduced due to successful renders",{oldCount:s,newCount:this.contextLossCount})}let i=this.settings.corridorEnabled&&this.corridorShaderProgram&&this.currentQualityLevel!=="low",a=i?this.corridorShaderProgram:this.shaderProgram,r=i?this.corridorUniforms:this.uniforms;if(!a)return;if(this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.useProgram(a),this.gl.bindVertexArray(this.vao),!this.webglReady){this.webglReady=!0;let s={"--sn.bg.webgl.ready":"1","--sn.bg.webgl.enabled":"1","--sn.bg.active-backend":"hybrid","--sn-gradient-crossfade-opacity":"0.5"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",s,"critical","webgl-first-draw")}let n=this.prefersReducedMotion?0:(e-this.startTime)/1e3;if(r.u_time&&this.gl.uniform1f(r.u_time,n),r.u_resolution&&this.gl.uniform2f(r.u_resolution,this.canvas.width,this.canvas.height),r.u_flowStrength){let s=this.settings.flowStrength;try{let c=getComputedStyle(document.documentElement).getPropertyValue("--sn-flow-strength").trim();c&&(s=parseFloat(c))}catch{u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to read flow strength CSS variable, using settings value")}this.gl.uniform1f(r.u_flowStrength,s)}r.u_noiseScale&&this.gl.uniform1f(r.u_noiseScale,this.settings.noiseScale),i||(r.u_waveY&&this.gl.uniform1fv(r.u_waveY,this.settings.waveY),r.u_waveHeight&&this.gl.uniform1fv(r.u_waveHeight,this.settings.waveHeight),r.u_waveOffset&&this.gl.uniform1fv(r.u_waveOffset,this.settings.waveOffset),r.u_blurExp&&this.gl.uniform1f(r.u_blurExp,this.settings.blurExp),r.u_blurMax&&this.gl.uniform1f(r.u_blurMax,this.settings.blurMax)),i&&(r.u_corridorIntensity&&this.gl.uniform1f(r.u_corridorIntensity,this.settings.corridorIntensity),r.u_corridorFlowStrength&&this.gl.uniform1f(r.u_corridorFlowStrength,this.settings.corridorFlowStrength),r.u_corridorDepthEffect&&this.gl.uniform1f(r.u_corridorDepthEffect,this.settings.corridorDepthEffect),r.u_corridorBubbleScale&&this.gl.uniform1f(r.u_corridorBubbleScale,this.settings.corridorBubbleScale),this.updateVisualEffectsUniforms(r,n)),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.gradientTexture),r.u_gradientTex&&this.gl.uniform1i(r.u_gradientTex,0),this.gl.drawArrays(this.gl.TRIANGLES,0,3),this.gl.bindVertexArray(null)}fallbackToCSSGradient(){let e={"--sn.bg.webgl.ready":"0","--sn.bg.webgl.enabled":"0","--sn.bg.active-backend":"css","--sn-gradient-crossfade-opacity":"0"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",e,"critical","webgl-css-fallback"),this.cssVisualEffectsController&&this.startCSSFallbackAnimation(),u?.debug?.log("WebGLGradientBackgroundSystem","Using CSS gradient fallback")}startCSSFallbackAnimation(){if(!this.cssVisualEffectsController)return;let e=()=>{if(!this.isActive)return;let i=performance.now()/1e3,a=Math.sin(i*.04)*20+Math.sin(i*.07)*8,r=Math.cos(i*.05)*20+Math.cos(i*.09)*6,n=1.15+Math.sin(i*.03)*.2,s={"--sn-gradient-flow-x":`${a}%`,"--sn-gradient-flow-y":`${r}%`,"--sn-gradient-flow-scale":n.toString()};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",s,"normal","css-fallback-animation"),setTimeout(e,this.frameThrottleInterval)};e()}handleSettingsChange(e){super.handleSettingsChange(e);let i=e,{key:a,value:r}=i.detail;if(a==="sn-gradient-intensity"){let n=this.settings.enabled;this.settings.intensity=r,this.loadSettings(),r==="disabled"&&n?(this.settings.enabled=!1,this.destroy(),this.fallbackToCSSGradient()):this.settings.enabled&&!n&&this.isWebGLAvailable&&this.initialize()}}_performSystemSpecificCleanup(){if(super._performSystemSpecificCleanup(),this.visualEffectsChoreographer)try{this.visualEffectsChoreographer.unregisterVisualEffectsParticipant("WebGLGradientBackgroundSystem"),u?.debug?.log("WebGLGradientBackgroundSystem","Unregistered from visualEffects choreographer")}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Error unregistering from visualEffects choreographer:",i)}this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.textureUpdateDebounceTimer&&(clearTimeout(this.textureUpdateDebounceTimer),this.textureUpdateDebounceTimer=null),this.textureUpdatePending=!1,this.textureCreationInProgress=!1,this.lastColorHarmonizedData=null,this.gl&&(this.gradientTexture&&(this.gl.deleteTexture(this.gradientTexture),this.gradientTexture=null),this.vertexBuffer&&(this.gl.deleteBuffer(this.vertexBuffer),this.vertexBuffer=null),this.vao&&(this.gl.deleteVertexArray(this.vao),this.vao=null),this.shaderProgram&&(this.gl.deleteProgram(this.shaderProgram),this.shaderProgram=null),Q.clearCache(this.gl)),this.wrapper&&this.wrapper.parentNode&&(this.wrapper.parentNode.removeChild(this.wrapper),this.wrapper=null),this.canvas=null,this.eventSubscriptionIds.forEach(i=>{p.unsubscribe(i)}),this.eventSubscriptionIds=[],u?.debug?.log("WebGLGradientBackgroundSystem","Unified event subscriptions cleaned up"),window.removeEventListener("resize",this.resize),this.gl=null;let e={"--sn.bg.webgl.ready":"0","--sn.bg.webgl.enabled":"0","--sn.bg.active-backend":"css","--sn-gradient-crossfade-opacity":"0"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",e,"critical","webgl-system-cleanup")}forceRepaint(e="settings-change"){this.isActive&&this.gradientTexture&&this.updateGradientTexture().catch(i=>{u?.debug?.error("WebGLGradientBackgroundSystem","Failed to repaint gradient:",i)})}setWaveY(e){this.settings.waveY=e}setWaveHeight(e){this.settings.waveHeight=e}setWaveOffset(e){this.settings.waveOffset=e}setBlurSettings(e,i){this.settings.blurExp=e,this.settings.blurMax=i}getMetrics(){return{fps:this.performanceMonitor?.getMedianFPS?.()||0,compileErrors:0,isActive:this.isActive,settings:{...this.settings}}}stopAnimation(){this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)}updateAnimation(e){if(!this.isActive||!this.gl||!this.isWebGLAvailable)return;let i=performance.now();this.shouldSkipFrame(i)||(this.shouldUpdateTexture()&&this.currentQualityLevel!=="low"&&this.updateGradientTextureThrottled(),this.webglReady?this.render(i):this.ensureBasicResources())}shouldSkipFrame(e){if(!this.frameThrottleInterval)return!1;let a=e-(this.lastFrameTime||0)<this.frameThrottleInterval;return a||(this.lastFrameTime=e),a}shouldUpdateTexture(){return performance.now()-this.lastTextureUpdate>=this.textureUpdateThrottleMs}ensureBasicResources(){if(!(!this.gl||this.contextLost)&&!this.gradientTexture)try{let e=this.getDefaultGradientStops();this.gradientTexture=le(this.gl,e),this.gradientTexture&&u?.debug?.log("WebGLGradientBackgroundSystem","Emergency gradient texture created during animation update")}catch(e){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to create emergency gradient texture:",e)}}async healthCheck(){let e=this.webglReady&&this.initialized&&this.isActive;return{system:"WebGLGradientBackgroundSystem",healthy:e,metrics:{webglReady:this.webglReady,initialized:this.initialized,active:this.isActive,contextLost:this.contextLost,canvasExists:!!this.canvas},issues:e?[]:[...this.webglReady?[]:["WebGL not ready"],...this.initialized?[]:["System not initialized"],...this.isActive?[]:["System not active"],...this.contextLost?["WebGL context lost"]:[]]}}resizeTo(e,i){this.canvas&&(this.canvas.width=e,this.canvas.height=i,this.resize?.())}registerWithVisualEffectsChoreographer(){if(!this.visualEffectsChoreographer){u?.debug?.log("WebGLGradientBackgroundSystem","VisualEffects choreographer not available, skipping registration");return}try{this.visualEffectsChoreographer.registerVisualEffectsParticipant(this),u?.debug?.log("WebGLGradientBackgroundSystem","Successfully registered with visualEffects choreographer")}catch(e){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to register with visualEffects choreographer:",e)}}getVisualEffectsContribution(){return{webglLuminosity:this.settings.flowStrength||.5,shaderComplexity:this.isWebGLAvailable?.8:0,gpuUtilization:this.isWebGLAvailable?.6:0,renderingPipeline:"forward",textureResolution:1}}onVisualEffectsFieldUpdate(e){if(!(!this.isWebGLAvailable||!this.webglReady))try{this.currentVisualEffectsField=e,this.updateShaderFromVisualEffects(e),u?.debug?.log("WebGLGradientBackgroundSystem","Updated from visualEffects field:",{rhythmicPulse:e.pulseRate,webglLuminosity:e.luminosity,emotionalTemperature:e.colorTemperature})}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Error updating from visualEffects field:",i)}}onChoreographyEvent(e,i){if(!(!this.isWebGLAvailable||!this.webglReady))try{switch(e){case"choreography:rhythm-shift":this.frameThrottleInterval=1e3/Math.max(30,Math.min(60,i.newRhythm?.bpm/2||45));break;case"choreography:energy-surge":let a=i.intensity||1;this.cssController.setVariable("WebGLGradientBackgroundSystem","--sn-webgl-energy-surge",a.toString(),"high","choreography-energy-surge");break;case"visualEffects:pulsing-cycle":let r=i.phase||0;this.cssController.setVariable("WebGLGradientBackgroundSystem","--sn-webgl-pulsing-sync",r.toString(),"normal","visualEffects-pulsing-cycle");break}u?.debug?.log("WebGLGradientBackgroundSystem",`Handled choreography event: ${e}`,i)}catch(a){u?.debug?.error("WebGLGradientBackgroundSystem",`Error handling choreography event ${e}:`,a)}}updateShaderFromVisualEffects(e){if(!this.gl||!this.shaderProgram)return;let i=this.settings.flowStrength*(.5+e.pulseRate*.5),a=this.gl.getUniformLocation(this.shaderProgram,"u_flowStrength");a&&this.gl.uniform1f(a,i);let r=this.settings.noiseScale*(.8+e.flowDirection.x*.4),n=this.gl.getUniformLocation(this.shaderProgram,"u_noiseScale");n&&this.gl.uniform1f(n,r);let s=Math.sin(Date.now()*.001*e.pulseRate)*.1,o=this.gl.getUniformLocation(this.shaderProgram,"u_waveY");if(o){let m=[this.settings.waveY[0]+s,this.settings.waveY[1]-s];this.gl.uniform1fv(o,m)}let c={"--sn-webgl-visualEffects-flow":i.toString(),"--sn-webgl-visualEffects-noise":r.toString(),"--sn-webgl-pulsing-phase":s.toString()};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",c,"normal","visualEffects-shader-update")}adjustQuality(e){this.setQualityLevel(e)}setQualityLevel(e){switch(this.currentQualityLevel=e,e){case"low":this.settings.flowStrength=.5,this.settings.noiseScale=1,this.settings.waveHeight=[.3,.2],this.settings.blurExp=1,this.settings.blurMax=.4,this.frameThrottleInterval=1e3/30;break;case"medium":this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.blurExp=1.2,this.settings.blurMax=.6,this.frameThrottleInterval=1e3/45;break;case"high":this.settings.flowStrength=.9,this.settings.noiseScale=1.4,this.settings.waveHeight=[.5,.4],this.settings.blurExp=1.3,this.settings.blurMax=.7,this.frameThrottleInterval=1e3/60;break;default:this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.blurExp=1.2,this.settings.blurMax=.6,this.frameThrottleInterval=1e3/45;break}this.updateQualityCapabilities(e),u?.debug?.log("WebGLGradientBackgroundSystem",`Quality level set to: ${e}`,{flowStrength:this.settings.flowStrength,frameRate:1e3/this.frameThrottleInterval})}getPerformanceImpact(){let e=this.lastFrameTime>0?1e3/this.lastFrameTime:60,i=this.estimateMemoryUsage();return{fps:e,frameTime:this.lastFrameTime,memoryUsage:i,cpuUsage:this.estimateCPUUsage()}}reduceQuality(e){this.qualityAdjustments["flow-reduction"]=(this.qualityAdjustments["flow-reduction"]||0)+e,this.qualityAdjustments["noise-reduction"]=(this.qualityAdjustments["noise-reduction"]||0)+e*.8,this.qualityAdjustments["wave-reduction"]=(this.qualityAdjustments["wave-reduction"]||0)+e*.6,this.settings.flowStrength=Math.max(.1,this.settings.flowStrength*(1-e)),this.settings.noiseScale=Math.max(.5,this.settings.noiseScale*(1-e*.8)),this.settings.waveHeight=[Math.max(.1,this.settings.waveHeight[0]*(1-e*.6)),Math.max(.1,this.settings.waveHeight[1]*(1-e*.6))],e>.5&&(this.frameThrottleInterval=Math.min(1e3/15,this.frameThrottleInterval*(1+e))),u?.debug?.log("WebGLGradientBackgroundSystem",`Quality reduced by ${e}`,this.settings)}increaseQuality(e){if(Object.keys(this.qualityAdjustments).forEach(i=>{this.qualityAdjustments[i]=Math.max(0,(this.qualityAdjustments[i]||0)-e)}),this.currentQualityLevel){let i=this.getBaseSettingsForLevel(this.currentQualityLevel)||this.settings;this.settings.flowStrength=Math.min(i.flowStrength,this.settings.flowStrength*(1+e*.5)),this.settings.noiseScale=Math.min(i.noiseScale,this.settings.noiseScale*(1+e*.3));let a=this.currentQualityLevel==="high"?60:this.currentQualityLevel==="medium"?45:30;this.frameThrottleInterval=Math.max(1e3/a,this.frameThrottleInterval*(1-e*.3))}u?.debug?.log("WebGLGradientBackgroundSystem",`Quality increased by ${e}`,this.settings)}getQualityCapabilities(){return[...this.qualityCapabilities]}updateQualityCapabilities(e){this.qualityCapabilities.forEach(i=>{switch(i.name){case"webgl-rendering":i.enabled=!0;break;case"shader-complexity":i.enabled=e==="high"||e==="medium";break;case"blur-effects":i.enabled=e!=="low";break;case"corridor-effects":i.enabled=e!=="low",e==="low"&&this.settings.corridorEnabled&&(this.settings.corridorEnabled=!1);break;case"corridor-sdf-complexity":let a=e==="high"?1:e==="medium"?.8:.6;this.settings.corridorBubbleScale=Math.max(.5,1*a),i.enabled=e!=="low";break;case"corridor-bubble-layers":let r=e==="high"?1:e==="medium"?.8:.6;this.settings.corridorIntensity=Math.max(.3,.8*r),i.enabled=e==="high"||e==="medium";break;case"corridor-depth-effects":let n=e==="high"?1:e==="medium"?.7:.4;this.settings.corridorDepthEffect=Math.max(.1,.6*n),i.enabled=e!=="low";break;default:i.enabled=e!=="low"}})}getBaseSettingsForLevel(e){let i={...this.settings};switch(e){case"minimal":return{...i,flowStrength:.3,noiseScale:.8,corridorEnabled:!1,corridorIntensity:.3,corridorFlowStrength:.5,corridorDepthEffect:.2,corridorBubbleScale:.5};case"low":return{...i,flowStrength:.5,noiseScale:1,corridorEnabled:!1,corridorIntensity:.4,corridorFlowStrength:.8,corridorDepthEffect:.3,corridorBubbleScale:.6};case"medium":return{...i,flowStrength:.7,noiseScale:1.2,corridorEnabled:!0,corridorIntensity:.6,corridorFlowStrength:1,corridorDepthEffect:.5,corridorBubbleScale:.8};case"high":return{...i,flowStrength:.9,noiseScale:1.4,corridorEnabled:!0,corridorIntensity:.8,corridorFlowStrength:1.2,corridorDepthEffect:.6,corridorBubbleScale:1};case"ultra":return{...i,flowStrength:1,noiseScale:1.6,corridorEnabled:!0,corridorIntensity:1,corridorFlowStrength:1.4,corridorDepthEffect:.8,corridorBubbleScale:1.2};default:return i}}setCorridorEffectsEnabled(e){this.settings.corridorEnabled=e&&this.corridorShaderProgram!==null,this.cssController.setVariable("WebGLGradientBackgroundSystem","--sn-corridor-enabled",e?"1":"0","normal","corridor-settings-update"),u?.debug?.log("WebGLGradientBackgroundSystem",`Corridor effects ${e?"enabled":"disabled"}`)}updateCorridorSettings(e){e.corridorIntensity!==void 0&&(this.settings.corridorIntensity=Math.max(0,Math.min(1,e.corridorIntensity))),e.corridorFlowStrength!==void 0&&(this.settings.corridorFlowStrength=Math.max(0,Math.min(2,e.corridorFlowStrength))),e.corridorDepthEffect!==void 0&&(this.settings.corridorDepthEffect=Math.max(0,Math.min(1,e.corridorDepthEffect))),e.corridorBubbleScale!==void 0&&(this.settings.corridorBubbleScale=Math.max(.1,Math.min(2,e.corridorBubbleScale))),u?.debug?.log("WebGLGradientBackgroundSystem","Corridor settings updated",e)}estimateMemoryUsage(){let e=5;if(this.canvas&&this.gl){let i=this.canvas.width*this.canvas.height;e+=i*4/(1024*1024),this.gradientTexture&&(e+=1),this.vertexBuffer&&(e+=.1)}return e}estimateCPUUsage(){let e=this.isWebGLAvailable?5:15,i=this.settings.flowStrength+this.settings.noiseScale/2;return Math.min(50,e*i)}getSimplifiedFragmentShader(){return`#version 300 es
      precision highp float;

      in vec2 vTextureCoords;
      out vec4 fragColor;

      uniform sampler2D u_gradientTexture;
      uniform float u_time;
      uniform float u_intensity;
      uniform float u_flowStrength;
      uniform vec2 u_resolution;

      // Simplified noise function - uses basic sin/cos instead of complex noise
      float simpleNoise(vec2 st) {
        return sin(st.x * 12.9898 + st.y * 78.233) * 43758.5453;
      }

      void main() {
        vec2 uv = vTextureCoords;
        
        // Simple flow effect without complex noise
        vec2 flow = vec2(
          sin(u_time * 0.5 + uv.y * 3.0) * 0.1,
          cos(u_time * 0.3 + uv.x * 2.0) * 0.1
        ) * u_flowStrength;
        
        // Apply flow offset
        vec2 flowUV = uv + flow;
        
        // Simple gradient lookup with basic distortion
        vec4 gradientColor = texture(u_gradientTexture, flowUV);
        
        // Simple intensity modulation
        float intensity = u_intensity * (0.8 + 0.2 * sin(u_time + uv.x + uv.y));
        
        fragColor = vec4(gradientColor.rgb * intensity, gradientColor.a);
      }`}getBasicFragmentShader(){return`#version 300 es
      precision mediump float;

      in vec2 vTextureCoords;
      out vec4 fragColor;

      uniform sampler2D u_gradientTexture;
      uniform float u_intensity;

      void main() {
        vec2 uv = vTextureCoords;
        
        // Basic gradient lookup without any effects
        vec4 gradientColor = texture(u_gradientTexture, uv);
        
        // Simple intensity scaling
        fragColor = vec4(gradientColor.rgb * u_intensity, gradientColor.a);
      }`}getEmergencyFragmentShader(){return`#version 300 es
      precision lowp float;

      in vec2 vTextureCoords;
      out vec4 fragColor;

      uniform sampler2D u_gradientTexture;

      void main() {
        // Ultra-simple gradient lookup with minimal processing
        // Use lowp precision for maximum compatibility
        vec2 uv = vTextureCoords;
        
        // Simple gradient sample - no effects, no animations
        vec4 color = texture(u_gradientTexture, uv);
        
        // Emergency mode: ensure we always output something visible
        // Fallback to magenta if texture fails (indicates shader compilation success)
        if (color.a < 0.01) {
          fragColor = vec4(0.2, 0.1, 0.3, 1.0); // Dark purple fallback
        } else {
          fragColor = color;
        }
      }`}shouldPersistWebGL(){return this.settings.webglPersistenceMode==="persistent"?!0:this.settings.webglPersistenceMode==="fallback"?!1:this.settings.webglPersistenceMode==="adaptive"&&this.settings.enabled&&this.isWebGLAvailable}shouldAttemptWebGLRecovery(){return this.shouldPersistWebGL()}applyContinuousQuality(e){try{let i=e;u?.debug?.log("WebGLGradientBackgroundSystem",`Applying simplified quality level: ${i}`),this.setQualityLevel(i),this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",{"--sn-webgl-quality-level":i,"--sn-webgl-corridor-enabled":this.settings.corridorEnabled?"1":"0"},"high","continuous-quality-update"),this.initialized&&this.gl&&this.forceRepaint("quality-level-changed")}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to apply continuous quality:",i)}}getCurrentQualityImpact(){let e=this.gl!==null&&this.isWebGLAvailable,i=this.settings.corridorEnabled&&this.corridorShaderProgram!==null,a=e?.15:.05,r=e?.1:.03,n=e?.2:0,s=i?.1:0,o=i?.05:0,c=i?.15:0,m=Math.max(.5,this.settings.flowStrength/2),d=60;return i&&(d-=10),this.settings.intensity==="intense"&&(d-=5),d=Math.max(30,d),{cpu:Math.min(1,(a+s)*m),memory:Math.min(1,(r+o)*m),gpu:Math.min(1,(n+c)*m),estimatedFPS:d}}onVisualStateUpdate(e){this.onVisualEffectsFieldUpdate(e)}onVisualEffectEvent(e,i){switch(e){case"visual:rhythm-shift":i.intensity&&(this.settings.flowStrength=Math.min(5,i.intensity*3));break;case"visual:color-shift":this.forceRepaint("color-shift");break;case"visual:energy-surge":i.intensity>.7&&this.forceRepaint("energy-surge");break}}getVisualContribution(){return{luminosity:this.settings.intensity==="intense"?.8:.5,fluidIntensity:this.settings.flowStrength/5,effectDepth:this.getCurrentQualityImpact().cpu}}}});var xl,Ai,is=y(()=>{"use strict";G();U();k();A();pt();ne();xi();xl=`#version 300 es
precision mediump float;

uniform float u_time;
uniform sampler2D u_gradientTex;
uniform vec2 u_resolution;
uniform float u_flowStrength;
uniform float u_noiseScale;

// Enhanced liquid visual effects uniforms
uniform float u_liquidPhase;
uniform float u_animationIntensity;
uniform float u_auroraFlow;
uniform vec2 u_flowDirection;
uniform float u_liquidTurbulence;
uniform float u_visualEffectsDepth;

// Advanced liquid physics uniforms
uniform float u_surfaceTension;
uniform float u_viscosity;
uniform float u_liquidGravity;
uniform float u_particleDensity;
uniform float u_fluidDynamics;
uniform float u_surfaceElasticity;
uniform vec2 u_liquidVelocity;
uniform float u_visualEffectsTemperature;

// Music sync uniforms
uniform float u_musicEnergy;
uniform float u_musicValence;
uniform float u_beatIntensity;
uniform float u_bassResponse;
uniform float u_genreInfluence;
uniform float u_emotionalTemperature;

// Multi-layer visual effects uniforms
uniform float u_visualEffectsLevel;
uniform float u_activityLevel;
uniform float u_memoryIntensity;
uniform float u_temporalFlowStrength;

// Wave stack uniforms
uniform float u_waveY[3];
uniform float u_waveHeight[3];
uniform float u_waveOffset[3];
uniform float u_blurExp;
uniform float u_blurMax;

out vec4 fragColor;

// Improved simplex noise with liquid visualEffects modifications
vec3 mod289(vec3 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec2 mod289(vec2 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec3 permute(vec3 x) {
  return mod289(((x*34.0)+1.0)*x);
}

float snoise(vec2 v) {
  const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);
  vec2 i = floor(v + dot(v, C.yy));
  vec2 x0 = v - i + dot(i, C.xx);
  vec2 i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
  vec4 x12 = x0.xyxy + C.xxzz;
  x12.xy -= i1;
  i = mod289(i);
  vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));
  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
  m = m*m;
  m = m*m;
  vec3 x = 2.0 * fract(p * C.www) - 1.0;
  vec3 h = abs(x) - 0.5;
  vec3 ox = floor(x + 0.5);
  vec3 a0 = x - ox;
  m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);
  vec3 g;
  g.x = a0.x * x0.x + h.x * x0.y;
  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
  return 130.0 * dot(m, g);
}

// Advanced liquid physics simulation functions
float calculateSurfaceTension(vec2 uv, float baseValue) {
  // Surface tension creates natural droplet boundaries
  float distance = length(uv - 0.5);
  float tensionEffect = smoothstep(0.3, 0.7, distance) * u_surfaceTension;
  return baseValue * (1.0 + tensionEffect * 0.3);
}

vec2 calculateViscosityFlow(vec2 uv, vec2 baseFlow, float timeOffset) {
  // Viscosity affects flow resistance and creates more dynamic movement
  float viscosityResistance = 1.0 - u_viscosity * 0.8;
  vec2 viscousFlow = baseFlow * viscosityResistance;
  
  // Add viscous swirl patterns
  float swirl = sin(u_time * 0.1 + timeOffset + length(uv - 0.5) * 10.0) * u_viscosity * 0.2;
  viscousFlow += vec2(-swirl * (uv.y - 0.5), swirl * (uv.x - 0.5));
  
  return viscousFlow;
}

float simulateGravityEffect(vec2 uv, float baseIntensity) {
  // Gravity creates natural settling patterns
  float gravityInfluence = (1.0 - uv.y) * u_liquidGravity;
  float settlingPattern = sin(u_time * 0.05 + uv.x * 5.0) * gravityInfluence * 0.1;
  return baseIntensity + settlingPattern;
}

// Enhanced liquid visual effects noise with advanced physics
float liquidVisualEffectsNoise(vec2 uv, float timeOffset) {
  vec2 flowUV = uv;
  float adjustedTime = u_time + timeOffset;

  // Enhanced liquid flow with physics simulation
  vec2 musicFlowDirection = normalize(u_flowDirection + vec2(
    sin(adjustedTime * 0.1 + u_musicEnergy * 2.0) * u_musicValence,
    cos(adjustedTime * 0.15 + u_musicEnergy * 1.5) * u_musicValence
  ));
  
  // Apply viscosity to flow
  vec2 viscousFlow = calculateViscosityFlow(uv, musicFlowDirection, timeOffset);
  
  // Add liquid velocity for momentum
  viscousFlow += u_liquidVelocity * 0.5;

  // Enhanced animation effect with visualEffects depth
  float animationPhase = sin(adjustedTime * 0.05 + u_liquidPhase) * u_animationIntensity;
  float visualEffectsWave = sin(adjustedTime * 0.02 + u_visualEffectsDepth) * 0.3;
  
  // VisualEffects memory patterns
  float memoryPattern = sin(adjustedTime * 0.008 + u_memoryIntensity * 5.0) * 0.15;
  
  // Temporal flow effects
  float temporalDistortion = sin(adjustedTime * 0.12 + u_temporalFlowStrength * 3.0) * 0.1;

  // Aurora flow patterns with enhanced physics
  flowUV += viscousFlow * adjustedTime * 0.03 * u_auroraFlow;
  flowUV += vec2(
    sin(adjustedTime * 0.04 + uv.y * 6.28) * (animationPhase + memoryPattern),
    cos(adjustedTime * 0.03 + uv.x * 6.28) * (animationPhase + temporalDistortion)
  ) * 0.02;

  // Enhanced turbulence with particle density
  vec2 turbulenceUV = flowUV * u_liquidTurbulence;
  float particleInfluence = u_particleDensity * 0.3;
  float turbulence1 = snoise(turbulenceUV + adjustedTime * 0.01) * (1.0 + particleInfluence);
  float turbulence2 = snoise(turbulenceUV * 2.0 + adjustedTime * 0.02) * (1.0 + particleInfluence * 0.5);
  
  // Fluid dynamics creates more complex flow patterns
  float fluidDynamicsEffect = snoise(flowUV * 3.0 + adjustedTime * 0.005) * u_fluidDynamics;

  // Multi-octave liquid noise with visualEffects layers
  float noise1 = snoise(flowUV * u_noiseScale + turbulence1 * 0.1) * u_visualEffectsLevel;
  float noise2 = snoise(flowUV * u_noiseScale * 2.0 + turbulence2 * 0.05) * u_activityLevel;
  float noise3 = snoise(flowUV * u_noiseScale * 0.5 + visualEffectsWave) * (1.0 - u_visualEffectsLevel * 0.3);
  float memoryNoise = snoise(flowUV * u_noiseScale * 1.5 + memoryPattern) * u_memoryIntensity * 0.3;

  // Apply surface tension effects
  float surfaceTensionEffect = calculateSurfaceTension(uv, 1.0);
  
  // Apply gravity settling
  float gravityEffect = simulateGravityEffect(uv, 1.0);

  // Blend with enhanced music and visualEffects responsiveness
  float baseNoise = (noise1 * 0.4 + noise2 * 0.3 + noise3 * 0.2 + memoryNoise * 0.1) * surfaceTensionEffect * gravityEffect;
  baseNoise += fluidDynamicsEffect * 0.1;
  
  // Enhanced musical modulation with genre influence
  float musicModulation = u_beatIntensity * 0.2 + u_bassResponse * 0.1 + u_genreInfluence * 0.05;
  
  // Emotional temperature affects liquid characteristics
  float temperatureEffect = mix(0.8, 1.2, u_emotionalTemperature);

  return clamp((baseNoise + musicModulation) * temperatureEffect * 0.5 + 0.5, 0.0, 1.0);
}

// Advanced liquid wave physics with surface elasticity
float liquidWaveAlpha(vec2 uv, int waveIndex) {
  float y = uv.y;
  float waveCenter = u_waveY[waveIndex];
  float waveHeight = u_waveHeight[waveIndex];

  // Enhanced animation modulation with visualEffects memory
  float animationMod = sin(u_time * 0.1 + float(waveIndex) * 2.0) * u_animationIntensity * 0.2;
  float visualEffectsBreathing = sin(u_time * 0.06 + u_visualEffectsLevel * 3.0) * 0.15;
  float memoryBreathing = sin(u_time * 0.04 + u_memoryIntensity * 2.0) * 0.1;
  
  float totalBreathing = animationMod + visualEffectsBreathing + memoryBreathing;
  float adjustedWaveHeight = waveHeight * (1.0 + totalBreathing);

  // Enhanced liquid distortion with surface elasticity
  float surfaceElastic = snoise(vec2(uv.x * 6.0 + u_time * 0.3, uv.y * 4.0)) * u_surfaceElasticity * 0.08;
  float liquidDistortion = snoise(vec2(uv.x * 8.0, u_time * 0.5)) * 0.05 * u_liquidTurbulence;
  float fluidDeformation = sin(uv.x * 10.0 + u_time * 0.7) * u_fluidDynamics * 0.03;
  
  float totalDistortion = liquidDistortion + surfaceElastic + fluidDeformation;
  float adjustedWaveCenter = waveCenter + totalDistortion;

  // Surface tension creates natural wave boundaries
  float distance = abs(y - adjustedWaveCenter);
  float tensionSmoothness = mix(0.3, 0.7, u_surfaceTension);
  float alpha = 1.0 - smoothstep(0.0, adjustedWaveHeight * tensionSmoothness, distance);

  // Enhanced shimmer with visualEffects and emotional temperature
  float baseShimmer = sin(u_time * 2.0 + uv.x * 20.0) * 0.1 + 0.9;
  float visualEffectsShimmer = sin(u_time * 1.5 + uv.y * 15.0 + u_visualEffectsLevel * 5.0) * 0.05 + 0.975;
  float temperatureShimmer = mix(0.95, 1.05, u_emotionalTemperature);
  
  alpha *= baseShimmer * visualEffectsShimmer * temperatureShimmer;

  // Viscosity affects wave edge softness
  alpha = mix(alpha, smoothstep(0.2, 0.8, alpha), u_viscosity);

  return clamp(alpha, 0.0, 1.0);
}

// Dynamic blur with visualEffects depth
float liquidBlur(vec2 uv) {
  vec2 center = vec2(0.5, 0.5);
  float distance = length(uv - center);

  // VisualEffects depth affects blur
  float depthModulation = sin(u_time * 0.08 + u_visualEffectsDepth) * 0.2 + 0.8;
  float adjustedBlurExp = u_blurExp * depthModulation;

  float blur = pow(distance, adjustedBlurExp);
  blur = clamp(blur, 0.0, u_blurMax);

  return blur;
}

void main() {
  vec2 uv = gl_FragCoord.xy / u_resolution.xy;

  // Generate enhanced liquid visualEffects noise fields with physics
  float liquidNoise1 = liquidVisualEffectsNoise(uv, u_waveOffset[0]);
  float liquidNoise2 = liquidVisualEffectsNoise(uv, u_waveOffset[1]);
  float liquidNoise3 = liquidVisualEffectsNoise(uv, u_waveOffset[2]);

  // Calculate advanced liquid wave alphas with physics simulation
  float alpha1 = liquidWaveAlpha(uv, 0);
  float alpha2 = liquidWaveAlpha(uv, 1);
  float alpha3 = liquidWaveAlpha(uv, 2);

  // Enhanced normalization with particle density influence
  float totalAlpha = alpha1 + alpha2 + alpha3;
  float particleWeight = 1.0 + u_particleDensity * 0.3;
  if (totalAlpha > 0.0) {
    alpha1 = (alpha1 / totalAlpha) * particleWeight;
    alpha2 = (alpha2 / totalAlpha) * particleWeight;
    alpha3 = (alpha3 / totalAlpha) * particleWeight;
  }

  // Blend liquid visualEffects noise fields with physics
  float t = liquidNoise1 * alpha1 + liquidNoise2 * alpha2 + liquidNoise3 * alpha3;
  
  // Apply visualEffects temperature modulation
  t = mix(t * 0.8, t * 1.2, u_visualEffectsTemperature);
  t = clamp(t, 0.0, 1.0);

  // Sample gradient texture with enhanced visualEffects modulation
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));

  // Apply dynamic blur with visualEffects awareness
  float blurAmount = liquidBlur(uv);
  float visualEffectsBlur = mix(blurAmount, blurAmount * 0.5, u_visualEffectsLevel);

  // Enhanced vignette with visualEffects memory patterns
  vec2 center = uv - 0.5;
  float animationVignette = sin(u_time * 0.06 + u_liquidPhase) * 0.1 + 0.9;
  float visualEffectsVignette = sin(u_time * 0.04 + u_visualEffectsLevel * 3.0) * 0.05 + 0.975;
  float memoryVignette = sin(u_time * 0.03 + u_memoryIntensity * 2.0) * 0.03 + 0.985;
  
  float combinedVignette = animationVignette * visualEffectsVignette * memoryVignette;
  float vignette = combinedVignette - dot(center, center) * (0.3 + visualEffectsBlur * 0.2);
  color.rgb *= vignette;

  // Enhanced shimmer overlay with visualEffects patterns
  float shimmerPhase = u_time * 3.0 + uv.x * 15.0 + uv.y * 10.0;
  float baseShimmer = sin(shimmerPhase) * 0.03 + 0.97;
  float awarenessShimmer = sin(u_time * 2.5 + uv.x * 12.0 + u_activityLevel * 8.0) * 0.02 + 0.98;
  float temporalShimmer = sin(u_time * 1.8 + u_temporalFlowStrength * 6.0) * 0.015 + 0.985;
  
  color.rgb *= baseShimmer * awarenessShimmer * temporalShimmer;

  // Enhanced music-responsive alpha with visualEffects integration
  float musicAlpha = 0.8 + u_beatIntensity * 0.2 + u_bassResponse * 0.1 + u_genreInfluence * 0.05;
  float visualEffectsAlpha = 0.9 + u_visualEffectsLevel * 0.1 - u_activityLevel * 0.05;
  
  color.a *= musicAlpha * visualEffectsAlpha * (1.0 - visualEffectsBlur * 0.3);

  // Apply emotional temperature to final color
  color.rgb = mix(
    color.rgb * vec3(0.9, 0.95, 1.1),  // Cool temperature
    color.rgb * vec3(1.1, 1.05, 0.9),  // Warm temperature
    u_emotionalTemperature
  );

  fragColor = color;
}`,Ai=class extends N{constructor(e=M,i,a,r=null,n=null,s=null){super(e,i,a,r,n);this.shaderProgram=null;this.gl=null;this.eventSubscriptionIds=[];this.animationPhase=0;this.lastMusicUpdate=0;this.visualEffectsChoreographer=null;this.currentVisualEffectsField=null;this.systemName="FluidGradientBackgroundSystem";this.webglGradientSystem=new xe(e,i,a,r,n,s),this.visualEffectsChoreographer=s?.backgroundVisualEffectsChoreographer||null,this.liquidSettings={enabled:!0,liquidPhase:0,animationIntensity:.8,auroraFlow:.6,flowDirection:[1,.5],liquidTurbulence:1.2,visualEffectsDepth:.7,surfaceTension:.6,viscosity:.4,liquidGravity:.3,particleDensity:.5,smoothDynamics:.7,surfaceElasticity:.5,liquidVelocity:[0,0],visualEffectsTemperature:.5,visualEffectsLevel:.7,awarenessLevel:.6,memoryIntensity:.4,temporalFlowStrength:.5,genreInfluence:.3,emotionalTemperature:.5,flowIntensity:.7,turbulenceScale:.9,colorMixingStrength:.8,animationSpeed:1},this.liquidUniforms={u_time:null,u_gradientTex:null,u_resolution:null,u_flowStrength:null,u_noiseScale:null,u_liquidPhase:null,u_animationIntensity:null,u_auroraFlow:null,u_flowDirection:null,u_liquidTurbulence:null,u_visualEffectsDepth:null,u_surfaceTension:null,u_viscosity:null,u_liquidGravity:null,u_particleDensity:null,u_smoothDynamics:null,u_surfaceElasticity:null,u_liquidVelocity:null,u_visualEffectsTemperature:null,u_musicEnergy:null,u_musicValence:null,u_beatIntensity:null,u_bassResponse:null,u_genreInfluence:null,u_emotionalTemperature:null,u_visualEffectsLevel:null,u_activityLevel:null,u_memoryIntensity:null,u_temporalFlowStrength:null,u_waveY:null,u_waveHeight:null,u_waveOffset:null,u_blurExp:null,u_blurMax:null}}async _performSystemSpecificInitialization(){if(await super._performSystemSpecificInitialization(),await this.webglGradientSystem.initialize(),this.gl=this.webglGradientSystem.gl,!this.gl){u?.debug?.log("FluidGradientBackgroundSystem","WebGL not available, using base system");return}try{await this.compileLiquidShader(),this.setupLiquidUniforms(),this.subscribeToUnifiedEvents(),this.registerWithVisualEffectsChoreographer(),u?.debug?.log("FluidGradientBackgroundSystem","Liquid visualEffects system initialized")}catch(e){u?.debug?.error("FluidGradientBackgroundSystem","Failed to initialize liquid visualEffects:",e)}}async compileLiquidShader(){if(!this.gl)throw new Error("WebGL context not available");let e=Q.loadVertex(this.gl,`#version 300 es
      in vec2 a_position;
      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
      }
    `),i=Q.loadFragment(this.gl,xl);if(!e||!i)throw new Error("Failed to compile liquid visualEffects shaders");if(this.shaderProgram=Q.createProgram(this.gl,e,i),!this.shaderProgram)throw new Error("Failed to create liquid visualEffects shader program")}setupLiquidUniforms(){if(!this.gl||!this.shaderProgram)return;["u_time","u_gradientTex","u_resolution","u_flowStrength","u_noiseScale","u_liquidPhase","u_animationIntensity","u_auroraFlow","u_flowDirection","u_liquidTurbulence","u_visualEffectsDepth","u_musicEnergy","u_musicValence","u_beatIntensity","u_bassResponse","u_waveY","u_waveHeight","u_waveOffset","u_blurExp","u_blurMax","u_surfaceTension","u_viscosity","u_liquidGravity","u_particleDensity","u_surfaceElasticity","u_smoothDynamics","u_visualEffectsLevel","u_visualEffectsTemperature","u_memoryIntensity","u_emotionalTemperature","u_genreInfluence"].forEach(i=>{this.liquidUniforms[i]=this.gl.getUniformLocation(this.shaderProgram,i)})}subscribeToUnifiedEvents(){let e=p.subscribe("music:beat",this.handleMusicBeat.bind(this),"FluidGradientBackgroundSystem");this.eventSubscriptionIds.push(e);let i=p.subscribe("music:energy",this.handleMusicEnergy.bind(this),"FluidGradientBackgroundSystem");this.eventSubscriptionIds.push(i);let a=p.subscribe("music:state-changed",this.handleMusicStateChange.bind(this),"FluidGradientBackgroundSystem");this.eventSubscriptionIds.push(a);let r=p.subscribe("colors:harmonized",this.handleColorHarmonized.bind(this),"FluidGradientBackgroundSystem");this.eventSubscriptionIds.push(r),u?.debug?.log("FluidGradientBackgroundSystem","Subscribed to unified events",{subscriptionCount:this.eventSubscriptionIds.length})}handleMusicBeat(e){let i=performance.now();i-this.lastMusicUpdate<33||(this.lastMusicUpdate=i,this.animationPhase+=.1,this.updateFlowDirection(e.intensity),u?.debug?.log("FluidGradientBackgroundSystem","Music beat processed",{bpm:e.bpm,intensity:e.intensity,confidence:e.confidence}))}handleMusicEnergy(e){this.liquidSettings.animationIntensity=.5+e.energy*.5,this.liquidSettings.auroraFlow=.4+e.valence*.6,u?.debug?.log("FluidGradientBackgroundSystem","Music energy processed",{energy:e.energy,valence:e.valence,tempo:e.tempo})}handleMusicStateChange(e){e.isPlaying?this.liquidSettings.visualEffectsDepth=Math.max(.7,this.liquidSettings.visualEffectsDepth):this.liquidSettings.visualEffectsDepth=Math.min(.3,this.liquidSettings.visualEffectsDepth),u?.debug?.log("FluidGradientBackgroundSystem","Music state change processed",{isPlaying:e.isPlaying,position:e.position,duration:e.duration})}handleColorHarmonized(e){let i=e.strategies.length;this.liquidSettings.liquidTurbulence=Math.max(.8,Math.min(1.5,i*.3)),u?.debug?.log("FluidGradientBackgroundSystem","Color harmonization processed",{strategies:e.strategies,processingTime:e.processingTime,turbulenceAdjustment:this.liquidSettings.liquidTurbulence})}updateFlowDirection(e){let i=this.animationPhase;this.liquidSettings.flowDirection=[Math.sin(i*.3)*e,Math.cos(i*.2)*e]}updateAnimation(e){this.webglGradientSystem?.updateAnimation?.(e),this.liquidSettings.liquidPhase+=e*.001,this.liquidSettings.visualEffectsDepth=.5+Math.sin(this.liquidSettings.liquidPhase*.5)*.3,this.gl&&this.shaderProgram&&this.updateLiquidUniforms()}updateLiquidUniforms(){!this.gl||!this.shaderProgram||(this.gl.useProgram(this.shaderProgram),this.liquidUniforms.u_liquidPhase&&this.gl.uniform1f(this.liquidUniforms.u_liquidPhase,this.liquidSettings.liquidPhase),this.liquidUniforms.u_animationIntensity&&this.gl.uniform1f(this.liquidUniforms.u_animationIntensity,this.liquidSettings.animationIntensity),this.liquidUniforms.u_auroraFlow&&this.gl.uniform1f(this.liquidUniforms.u_auroraFlow,this.liquidSettings.auroraFlow),this.liquidUniforms.u_flowDirection&&this.gl.uniform2fv(this.liquidUniforms.u_flowDirection,this.liquidSettings.flowDirection),this.liquidUniforms.u_liquidTurbulence&&this.gl.uniform1f(this.liquidUniforms.u_liquidTurbulence,this.liquidSettings.liquidTurbulence),this.liquidUniforms.u_visualEffectsDepth&&this.gl.uniform1f(this.liquidUniforms.u_visualEffectsDepth,this.liquidSettings.visualEffectsDepth),this.liquidUniforms.u_surfaceTension&&this.gl.uniform1f(this.liquidUniforms.u_surfaceTension,this.liquidSettings.surfaceTension),this.liquidUniforms.u_viscosity&&this.gl.uniform1f(this.liquidUniforms.u_viscosity,this.liquidSettings.viscosity),this.liquidUniforms.u_liquidGravity&&this.gl.uniform1f(this.liquidUniforms.u_liquidGravity,this.liquidSettings.liquidGravity),this.liquidUniforms.u_particleDensity&&this.gl.uniform1f(this.liquidUniforms.u_particleDensity,this.liquidSettings.particleDensity),this.liquidUniforms.u_surfaceElasticity&&this.gl.uniform1f(this.liquidUniforms.u_surfaceElasticity,this.liquidSettings.surfaceElasticity),this.liquidUniforms.u_smoothDynamics&&this.gl.uniform1f(this.liquidUniforms.u_smoothDynamics,this.liquidSettings.smoothDynamics),this.liquidUniforms.u_visualEffectsLevel&&this.gl.uniform1f(this.liquidUniforms.u_visualEffectsLevel,this.liquidSettings.visualEffectsLevel),this.liquidUniforms.u_visualEffectsTemperature&&this.gl.uniform1f(this.liquidUniforms.u_visualEffectsTemperature,this.liquidSettings.visualEffectsTemperature),this.liquidUniforms.u_memoryIntensity&&this.gl.uniform1f(this.liquidUniforms.u_memoryIntensity,this.liquidSettings.memoryIntensity),this.liquidUniforms.u_emotionalTemperature&&this.gl.uniform1f(this.liquidUniforms.u_emotionalTemperature,this.liquidSettings.emotionalTemperature),this.liquidUniforms.u_genreInfluence&&this.gl.uniform1f(this.liquidUniforms.u_genreInfluence,this.liquidSettings.genreInfluence),this.updateMusicUniforms())}updateMusicUniforms(){if(!this.gl||!this.musicSyncService)return;let e=this.musicSyncService.getLatestProcessedData?.()||{},i=e.energy||0,a=e.valence||0,r=e.beatIntensity||0,n=e.bassResponse||0;this.liquidUniforms.u_musicEnergy&&this.gl.uniform1f(this.liquidUniforms.u_musicEnergy,i),this.liquidUniforms.u_musicValence&&this.gl.uniform1f(this.liquidUniforms.u_musicValence,a),this.liquidUniforms.u_beatIntensity&&this.gl.uniform1f(this.liquidUniforms.u_beatIntensity,r),this.liquidUniforms.u_bassResponse&&this.gl.uniform1f(this.liquidUniforms.u_bassResponse,n)}async healthCheck(){let e=this.liquidSettings.enabled&&this.shaderProgram!==null;return{system:"FluidGradientBackgroundSystem",healthy:e,metrics:{enabled:this.liquidSettings.enabled,hasShaderProgram:!!this.shaderProgram,initialized:this.initialized,flowIntensity:this.liquidSettings.flowIntensity},issues:e?[]:[...this.liquidSettings.enabled?[]:["System disabled"],...this.shaderProgram?[]:["Shader program not initialized"]]}}forceRepaint(e="liquid-visualEffects-update"){this.webglGradientSystem.forceRepaint(e)}adjustQuality(e){this.setQualityLevel(e)}setQualityLevel(e){switch(e){case"low":this.liquidSettings.flowIntensity=.5,this.liquidSettings.turbulenceScale=.7,this.liquidSettings.colorMixingStrength=.6,this.liquidSettings.animationSpeed=.8;break;case"medium":this.liquidSettings.flowIntensity=.7,this.liquidSettings.turbulenceScale=.9,this.liquidSettings.colorMixingStrength=.8,this.liquidSettings.animationSpeed=1;break;case"high":this.liquidSettings.flowIntensity=.9,this.liquidSettings.turbulenceScale=1.1,this.liquidSettings.colorMixingStrength=1,this.liquidSettings.animationSpeed=1.2;break;default:this.liquidSettings.flowIntensity=.7,this.liquidSettings.turbulenceScale=.9,this.liquidSettings.colorMixingStrength=.8,this.liquidSettings.animationSpeed=1;break}this.webglGradientSystem.setQualityLevel(e),M.enableDebug&&u?.debug?.log("FluidGradientBackgroundSystem",`Quality level set to: ${e}`,this.liquidSettings)}getPerformanceImpact(){let e=this.webglGradientSystem.getPerformanceImpact();return{fps:e.fps,frameTime:e.frameTime+1.2,memoryUsage:e.memoryUsage+5,cpuUsage:e.cpuUsage+3}}reduceQuality(e){this.liquidSettings.flowIntensity=Math.max(.1,this.liquidSettings.flowIntensity-e*.3),this.liquidSettings.turbulenceScale=Math.max(.2,this.liquidSettings.turbulenceScale-e*.4),this.liquidSettings.colorMixingStrength=Math.max(.2,this.liquidSettings.colorMixingStrength-e*.3),this.liquidSettings.animationSpeed=Math.max(.3,this.liquidSettings.animationSpeed-e*.5),this.webglGradientSystem.reduceQuality(e)}increaseQuality(e){this.liquidSettings.flowIntensity=Math.min(1,this.liquidSettings.flowIntensity+e*.2),this.liquidSettings.turbulenceScale=Math.min(1.5,this.liquidSettings.turbulenceScale+e*.3),this.liquidSettings.colorMixingStrength=Math.min(1.2,this.liquidSettings.colorMixingStrength+e*.2),this.liquidSettings.animationSpeed=Math.min(1.6,this.liquidSettings.animationSpeed+e*.3),this.webglGradientSystem.increaseQuality(e)}getQualityCapabilities(){return[{name:"liquid-flow-intensity",enabled:this.liquidSettings.flowIntensity>.5,qualityLevel:"medium"},{name:"turbulence-complexity",enabled:this.liquidSettings.turbulenceScale>.8,qualityLevel:"high"},{name:"color-mixing-quality",enabled:this.liquidSettings.colorMixingStrength>.7,qualityLevel:"low"},{name:"animation-smoothness",enabled:this.liquidSettings.animationSpeed>1,qualityLevel:"medium"}]}_performSystemSpecificCleanup(){if(super._performSystemSpecificCleanup(),this.visualEffectsChoreographer)try{this.visualEffectsChoreographer.unregisterVisualEffectsParticipant("FluidGradientBackgroundSystem"),u?.debug?.log("FluidGradientBackgroundSystem","Unregistered from visualEffects choreographer")}catch(e){u?.debug?.error("FluidGradientBackgroundSystem","Error unregistering from visualEffects choreographer:",e)}this.eventSubscriptionIds.forEach(e=>{p.unsubscribe(e)}),this.eventSubscriptionIds=[],u?.debug?.log("FluidGradientBackgroundSystem","Unified event subscriptions cleaned up"),this.gl&&this.shaderProgram&&(this.gl.deleteProgram(this.shaderProgram),this.shaderProgram=null),this.webglGradientSystem.destroy()}setLiquidPhase(e){this.liquidSettings.liquidPhase=e}setAnimationIntensity(e){this.liquidSettings.animationIntensity=Math.max(0,Math.min(1,e))}setAuroraFlow(e){this.liquidSettings.auroraFlow=Math.max(0,Math.min(1,e))}setFlowDirection(e,i){this.liquidSettings.flowDirection=[e,i]}setLiquidTurbulence(e){this.liquidSettings.liquidTurbulence=Math.max(0,Math.min(2,e))}setVisualEffectsDepth(e){this.liquidSettings.visualEffectsDepth=Math.max(0,Math.min(1,e))}setSurfaceTension(e){this.liquidSettings.surfaceTension=Math.max(0,Math.min(1,e))}setViscosity(e){this.liquidSettings.viscosity=Math.max(0,Math.min(1,e))}setLiquidGravity(e){this.liquidSettings.liquidGravity=Math.max(0,Math.min(1,e))}setParticleDensity(e){this.liquidSettings.particleDensity=Math.max(0,Math.min(2,e))}setSurfaceElasticity(e){this.liquidSettings.surfaceElasticity=Math.max(0,Math.min(1,e))}setSmoothDynamics(e){this.liquidSettings.smoothDynamics=Math.max(0,Math.min(1,e))}setVisualEffectsLevel(e){this.liquidSettings.visualEffectsLevel=Math.max(0,Math.min(1,e))}setVisualEffectsTemperature(e){this.liquidSettings.visualEffectsTemperature=Math.max(0,Math.min(1,e))}setMemoryIntensity(e){this.liquidSettings.memoryIntensity=Math.max(0,Math.min(1,e))}setEmotionalTemperature(e){this.liquidSettings.emotionalTemperature=Math.max(0,Math.min(1,e))}setGenreInfluence(e){this.liquidSettings.genreInfluence=Math.max(0,Math.min(1,e))}getLiquidSettings(){return{...this.liquidSettings}}registerWithVisualEffectsChoreographer(){if(!this.visualEffectsChoreographer){u?.debug?.log("FluidGradientBackgroundSystem","VisualEffects choreographer not available, skipping registration");return}try{this.visualEffectsChoreographer.registerVisualEffectsParticipant(this),u?.debug?.log("FluidGradientBackgroundSystem","Successfully registered with visualEffects choreographer")}catch(e){u?.debug?.error("FluidGradientBackgroundSystem","Failed to register with visualEffects choreographer:",e)}}get systemPriority(){return"high"}getVisualEffectsContribution(){return{liquidDensity:this.liquidSettings.liquidTurbulence||.5,smoothDynamics:this.liquidSettings.auroraFlow||.6,surfaceFluidityIndex:this.liquidSettings.animationIntensity||.8,turbulenceLevel:this.liquidSettings.liquidTurbulence||.5,viscosityIndex:1,flowPatterns:["aurora","liquid","visualEffects"]}}onVisualEffectsFieldUpdate(e){if(!(!this.gl||!this.shaderProgram))try{this.currentVisualEffectsField=e,this.updateLiquidFromVisualEffects(e),u?.debug?.log("FluidGradientBackgroundSystem","Updated from visualEffects field:",{rhythmicPulse:e.pulseRate,liquidDensity:e.fluidIntensity,surfaceFluidityIndex:e.fluidIntensity})}catch(i){u?.debug?.error("FluidGradientBackgroundSystem","Error updating from visualEffects field:",i)}}onChoreographyEvent(e,i){if(!(!this.gl||!this.shaderProgram))try{switch(e){case"choreography:rhythm-shift":let a=i.newRhythm?.bpm||120;this.liquidSettings.auroraFlow=Math.max(.2,Math.min(1,a/120));break;case"choreography:energy-surge":let r=i.intensity||1;this.liquidSettings.liquidTurbulence=Math.min(1,this.liquidSettings.liquidTurbulence*(1+r*.5));break;case"visualEffects:animation-cycle":let n=i.phase||0;this.liquidSettings.animationIntensity=.5+Math.sin(n*Math.PI*2)*.3;break;case"visualEffects:surface-fluid":let s=i.fluidityIndex||.5;this.liquidSettings.visualEffectsDepth=s;break}this.currentVisualEffectsField&&this.updateLiquidFromVisualEffects(this.currentVisualEffectsField),u?.debug?.log("FluidGradientBackgroundSystem",`Handled choreography event: ${e}`,i)}catch(a){u?.debug?.error("FluidGradientBackgroundSystem",`Error handling choreography event ${e}:`,a)}}updateLiquidFromVisualEffects(e){if(!this.gl||!this.shaderProgram)return;let i=this.liquidSettings.liquidPhase+e.pulseRate*.5,a=this.gl.getUniformLocation(this.shaderProgram,"u_liquidPhase");a&&this.gl.uniform1f(a,i);let r=this.liquidSettings.animationIntensity*(.7+e.pulseRate*.3),n=this.gl.getUniformLocation(this.shaderProgram,"u_animationIntensity");n&&this.gl.uniform1f(n,r);let s=this.gl.getUniformLocation(this.shaderProgram,"u_auroraFlow");s&&this.gl.uniform1f(s,this.liquidSettings.auroraFlow*(.8+e.flowDirection.x*.4));let o=this.gl.getUniformLocation(this.shaderProgram,"u_flowDirection");o&&this.gl.uniform2f(o,e.flowDirection.x,e.flowDirection.y);let c=this.gl.getUniformLocation(this.shaderProgram,"u_liquidTurbulence");if(c){let d=this.liquidSettings.liquidTurbulence*(.5+e.energyLevel*.5);this.gl.uniform1f(c,d)}let m=this.gl.getUniformLocation(this.shaderProgram,"u_visualEffectsDepth");m&&this.gl.uniform1f(m,e.fluidIntensity);try{let d=P();d.queueCSSVariableUpdate("--sn-visualEffects-flow-direction",i.toString()),d.queueCSSVariableUpdate("--sn-visualEffects-animation-intensity",r.toString()),d.queueCSSVariableUpdate("--sn-visualEffects-aurora-flow",this.liquidSettings.auroraFlow.toString()),d.queueCSSVariableUpdate("--sn-visualEffects-viscosity",this.liquidSettings.liquidTurbulence.toString()),d.queueCSSVariableUpdate("--sn-visualEffects-surface-tension",this.liquidSettings.surfaceTension.toString()),d.queueCSSVariableUpdate("--sn-visualEffects-surface-elasticity",this.liquidSettings.surfaceElasticity.toString()),d.queueCSSVariableUpdate("--sn-visualEffects-animation-scale",this.liquidSettings.particleDensity.toString())}catch(d){u?.debug?.warn("FluidGradientBackgroundSystem","Global CSS controller not available:",d)}}onVisualStateUpdate(e){this.onVisualEffectsFieldUpdate(e)}onVisualEffectEvent(e,i){switch(e){case"visual:rhythm-shift":i.intensity&&(this.liquidSettings.liquidTurbulence=Math.min(1,i.intensity*.8));break;case"visual:color-shift":this.forceRepaint("color-shift");break;case"visual:energy-surge":i.intensity>.5&&(this.liquidSettings.particleDensity=Math.min(1,i.intensity));break}}getVisualContribution(){return{fluidIntensity:this.liquidSettings.liquidTurbulence,effectDepth:this.liquidSettings.particleDensity,systemHarmony:this.liquidSettings.surfaceTension}}onConsciousnessFieldUpdate(e){return this.onVisualEffectsFieldUpdate(e)}}});var Ii,as=y(()=>{"use strict";G();U();A();ne();Ii=class extends N{constructor(e=M,i,a,r=null){super(e,i,a,null,r);this.intersectionObserver=null;this.animationFrameId=null;this.lastAnimationTime=0;this.styleElement=null;this.prefersReducedMotion=!1;this.currentQualityLevel=null;this.qualityCapabilities=[{name:"shimmer-effects",enabled:!0,qualityLevel:"medium"},{name:"oil-slick-intensity",enabled:!0,qualityLevel:"medium"},{name:"chromatic-aberration",enabled:!0,qualityLevel:"low"},{name:"interference-patterns",enabled:!0,qualityLevel:"low"},{name:"gpu-acceleration",enabled:!0,qualityLevel:"medium"},{name:"element-pooling",enabled:!0,qualityLevel:"low"}];this.qualityAdjustments={};this.shimmerElements=new Map;try{this.cssController=P()}catch(n){throw u?.debug?.warn("IridescentShimmerEffectsSystem","OptimizedCSSVariableManager not available:",n),n}this.shimmerSettings={enabled:!0,intensity:"balanced",targetSelectors:[".main-entityHeader-container",".main-card-card",".main-playButton-PlayButton",".main-actionBarRow-ActionBarRow",".main-trackList-trackListRow",".main-nowPlayingWidget-nowPlaying"],animationSpeed:.5,colorShift:30,opacityRange:[.1,.3],scaleRange:[.8,1.2],rotationSpeed:.2,blurRadius:8,saturationBoost:1.5,oilSlickIntensity:.7,chromaticAberration:2,refractionStrength:1.5,interferencePattern:!0,surfaceTension:.8,useGPUAcceleration:!0,maxSimultaneousShimmers:12,adaptiveQuality:!0,poolingEnabled:!0},this.shimmerKeyframes={shimmer:[{transform:"translateX(-100%) translateY(-100%) rotate(0deg) scale(0.8)",opacity:"0",filter:"hue-rotate(0deg) saturate(1)"},{transform:"translateX(0%) translateY(0%) rotate(45deg) scale(1.1)",opacity:"0.3",filter:"hue-rotate(120deg) saturate(1.8)"},{transform:"translateX(100%) translateY(100%) rotate(90deg) scale(1.2)",opacity:"0.1",filter:"hue-rotate(240deg) saturate(1.3)"},{transform:"translateX(200%) translateY(200%) rotate(180deg) scale(0.9)",opacity:"0",filter:"hue-rotate(360deg) saturate(1)"}],prism:[{background:"linear-gradient(45deg, rgba(var(--spice-rgb-shimmer-primary, 255, 0, 150), 0.1) 0%, rgba(var(--spice-rgb-shimmer-secondary, 0, 255, 255), 0.1) 50%, rgba(var(--spice-rgb-shimmer-tertiary, 255, 255, 0), 0.1) 100%)",transform:"rotate(0deg) scale(1)",mixBlendMode:"multiply"},{background:"linear-gradient(135deg, rgba(var(--spice-rgb-shimmer-secondary, 0, 255, 150), 0.12) 0%, rgba(var(--spice-rgb-shimmer-quaternary, 255, 0, 255), 0.12) 50%, rgba(var(--spice-rgb-shimmer-tertiary, 0, 150, 255), 0.12) 100%)",transform:"rotate(120deg) scale(1.1)",mixBlendMode:"overlay"},{background:"linear-gradient(225deg, rgba(var(--spice-rgb-shimmer-tertiary, 255, 150, 0), 0.12) 0%, rgba(var(--spice-rgb-shimmer-quaternary, 150, 255, 0), 0.12) 50%, rgba(var(--spice-rgb-shimmer-primary, 255, 0, 150), 0.12) 100%)",transform:"rotate(240deg) scale(0.9)",mixBlendMode:"overlay"},{background:"linear-gradient(315deg, rgba(var(--spice-rgb-shimmer-quaternary, 150, 0, 255), 0.08) 0%, rgba(var(--spice-rgb-shimmer-tertiary, 255, 255, 0), 0.08) 50%, rgba(var(--spice-rgb-shimmer-secondary, 0, 255, 150), 0.08) 100%)",transform:"rotate(360deg) scale(1)",mixBlendMode:"multiply"}],oilSlick:[{backdropFilter:"blur(2px) hue-rotate(0deg) saturate(1.5)",transform:"scaleX(1) scaleY(1) rotate(0deg)",opacity:"0.8"},{backdropFilter:"blur(4px) hue-rotate(90deg) saturate(2.2)",transform:"scaleX(1.05) scaleY(0.95) rotate(2deg)",opacity:"0.6"},{backdropFilter:"blur(6px) hue-rotate(180deg) saturate(1.8)",transform:"scaleX(0.95) scaleY(1.05) rotate(-2deg)",opacity:"0.7"},{backdropFilter:"blur(3px) hue-rotate(270deg) saturate(1.3)",transform:"scaleX(1.02) scaleY(0.98) rotate(1deg)",opacity:"0.9"},{backdropFilter:"blur(2px) hue-rotate(360deg) saturate(1.5)",transform:"scaleX(1) scaleY(1) rotate(0deg)",opacity:"0.8"}],rainbow:[{filter:"hue-rotate(0deg) saturate(1.2) brightness(1.1)"},{filter:"hue-rotate(60deg) saturate(1.8) brightness(1.2)"},{filter:"hue-rotate(120deg) saturate(1.5) brightness(1.1)"},{filter:"hue-rotate(180deg) saturate(1.9) brightness(1.3)"},{filter:"hue-rotate(240deg) saturate(1.4) brightness(1.1)"},{filter:"hue-rotate(300deg) saturate(1.6) brightness(1.2)"},{filter:"hue-rotate(360deg) saturate(1.2) brightness(1.1)"}]},this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,window.matchMedia("(prefers-reduced-motion: reduce)").addEventListener("change",n=>{this.prefersReducedMotion=n.matches,this.updateShimmerElements()})}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization(),this.loadSettings(),this.createShimmerStyles(),this.setupIntersectionObserver(),this.setupShimmerElements(),u?.debug?.log("IridescentShimmerEffectsSystem","Iridescent shimmer system initialized")}loadSettings(){if(this.settingsManager)try{let e=this.settingsManager.get("sn-shimmer-intensity");e&&(this.shimmerSettings.intensity=e,this.applyIntensitySettings());let i=this.settingsManager.get("sn-shimmer-enabled");i!==void 0&&(this.shimmerSettings.enabled=i)}catch(e){u?.debug?.warn("IridescentShimmerEffectsSystem","Failed to load settings:",e)}}applyIntensitySettings(){switch(this.shimmerSettings.intensity){case"minimal":this.shimmerSettings.animationSpeed=.3,this.shimmerSettings.opacityRange=[.05,.15],this.shimmerSettings.colorShift=15,this.shimmerSettings.blurRadius=4,this.shimmerSettings.saturationBoost=1.2;break;case"balanced":this.shimmerSettings.animationSpeed=.5,this.shimmerSettings.opacityRange=[.1,.3],this.shimmerSettings.colorShift=30,this.shimmerSettings.blurRadius=8,this.shimmerSettings.saturationBoost=1.5;break;case"intense":this.shimmerSettings.animationSpeed=.8,this.shimmerSettings.opacityRange=[.15,.5],this.shimmerSettings.colorShift=60,this.shimmerSettings.blurRadius=12,this.shimmerSettings.saturationBoost=2;break}}createShimmerStyles(){this.styleElement=document.createElement("style"),this.styleElement.textContent=`
      .sn-shimmer-container {
        position: relative;
        overflow: hidden;
        isolation: isolate;
      }

      .sn-shimmer-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
        opacity: calc(var(--shimmer-intensity, 0.3) * 0.6);
        will-change: transform, filter;
      }

      /* Single unified shimmer effect - replaces 3 separate layers */
      .sn-shimmer-unified {
        background:
          conic-gradient(
            from var(--shimmer-phase, 0deg) at 50% 50%,
            rgba(var(--spice-rgb-shimmer-primary, 255, 0, 150), 0.08) 0%,
            rgba(var(--spice-rgb-shimmer-secondary, 0, 255, 255), 0.12) 25%,
            rgba(var(--spice-rgb-shimmer-tertiary, 255, 255, 0), 0.08) 50%,
            rgba(var(--spice-rgb-shimmer-quaternary, 150, 0, 255), 0.10) 75%,
            rgba(var(--spice-rgb-shimmer-primary, 255, 0, 150), 0.08) 100%
          ),
          linear-gradient(
            45deg,
            rgba(var(--spice-rgb-shimmer-primary, 255, 0, 150), 0.06) 0%,
            rgba(var(--spice-rgb-shimmer-secondary, 0, 255, 255), 0.04) 50%,
            rgba(var(--spice-rgb-shimmer-primary, 255, 0, 150), 0.06) 100%
          );
        backdrop-filter:
          blur(calc(var(--shimmer-intensity, 0.3) * 6px))
          saturate(calc(1 + var(--shimmer-intensity, 0.3) * 0.8));
        mix-blend-mode: overlay;
        animation:
          sn-shimmer-unified var(--shimmer-duration, 10s) ease-in-out infinite,
          sn-shimmer-rotation calc(var(--shimmer-duration, 10s) * 1.5) linear infinite;
        animation-delay: calc(var(--shimmer-phase, 0deg) / 360deg * var(--shimmer-duration, 10s));
      }

      @keyframes sn-shimmer-unified {
        0%, 100% {
          transform: scale(1) translateX(0%) translateY(0%);
          filter: hue-rotate(0deg) brightness(1.05);
        }
        25% {
          transform: scale(1.02) translateX(0.5%) translateY(-0.5%);
          filter: hue-rotate(90deg) brightness(1.15);
        }
        50% {
          transform: scale(0.98) translateX(-0.3%) translateY(0.3%);
          filter: hue-rotate(180deg) brightness(1.1);
        }
        75% {
          transform: scale(1.01) translateX(0.2%) translateY(-0.2%);
          filter: hue-rotate(270deg) brightness(1.08);
        }
      }

      @keyframes sn-shimmer-rotation {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Performance optimization for reduced motion */
      @media (prefers-reduced-motion: reduce) {
        .sn-shimmer-unified {
          animation: none;
          transform: none;
          filter: none;
          opacity: calc(var(--shimmer-intensity, 0.3) * 0.3);
        }
      }

      /* GPU acceleration hints */
      .sn-shimmer-unified {
        transform: translateZ(0);
        backface-visibility: hidden;
        perspective: 1000px;
      }
    `,document.head.appendChild(this.styleElement)}setupIntersectionObserver(){this.intersectionObserver=new IntersectionObserver(e=>{e.forEach(i=>{let a=this.shimmerElements.get(i.target);a&&(a.isVisible=i.isIntersecting,a.bounds=i.boundingClientRect,a.isVisible?this.activateShimmer(a):this.deactivateShimmer(a))})},{root:null,rootMargin:"50px",threshold:.1})}setupShimmerElements(){this.shimmerSettings.targetSelectors.forEach(i=>{document.querySelectorAll(i).forEach(r=>{this.addShimmerToElement(r)})}),new MutationObserver(i=>{i.forEach(a=>{a.addedNodes.forEach(r=>{if(r.nodeType===Node.ELEMENT_NODE){let n=r;this.shimmerSettings.targetSelectors.forEach(s=>{n.matches(s)&&this.addShimmerToElement(n),n.querySelectorAll(s).forEach(c=>{this.addShimmerToElement(c)})})}})})}).observe(document.body,{childList:!0,subtree:!0})}addShimmerToElement(e){if(this.shimmerElements.has(e))return;let i=document.createElement("div");i.className="sn-shimmer-layer sn-shimmer-unified";let a=this.getIntensityValue(),r=Math.random()*360;i.style.setProperty("--shimmer-intensity",a.toString()),i.style.setProperty("--shimmer-phase",`${r}deg`),i.style.setProperty("--shimmer-duration",`${8+Math.random()*4}s`),e.classList.add("sn-shimmer-container"),e.appendChild(i);let n={element:e,shimmerLayer:i,animationPhase:r,intensity:a,lastUpdate:0,isVisible:!1,bounds:e.getBoundingClientRect()};this.shimmerElements.set(e,n),this.intersectionObserver&&this.intersectionObserver.observe(e),this.config.enableDebug&&u?.debug?.log("IridescentShimmerEffectsSystem",`Added optimized shimmer to ${e.tagName}.${e.className.substring(0,20)}`)}getIntensityValue(){return{minimal:.3,balanced:.6,intense:1}[this.shimmerSettings.intensity]}activateShimmer(e){if(this.prefersReducedMotion){e.shimmerLayer.style.setProperty("--shimmer-intensity","0.1"),e.shimmerLayer.style.opacity="0.1";return}e.shimmerLayer.style.setProperty("--shimmer-intensity",e.intensity.toString()),e.shimmerLayer.style.opacity="1",e.shimmerLayer.style.animationPlayState="running"}deactivateShimmer(e){e.shimmerLayer.style.opacity="0",e.shimmerLayer.style.animationPlayState="paused"}updateShimmerElements(){if(!this.shimmerSettings.enabled){this.disableAllShimmers();return}let e={"--sn-shimmer-global-intensity":this.getIntensityValue().toString(),"--sn-shimmer-global-speed":`${this.shimmerSettings.animationSpeed}s`,"--sn-shimmer-global-blur":`${this.shimmerSettings.blurRadius}px`};this.cssController.batchSetVariables("IridescentShimmerEffectsSystem",e,"normal","shimmer-global-settings"),this.shimmerElements.forEach(i=>{i.isVisible?this.activateShimmer(i):this.deactivateShimmer(i)})}disableAllShimmers(){this.shimmerElements.forEach(e=>{this.deactivateShimmer(e)})}updateAnimation(e){}async healthCheck(){let e=this.shimmerSettings.enabled&&this.shimmerElements.size>0;return{system:"IridescentShimmerEffectsSystem",healthy:e,metrics:{enabled:this.shimmerSettings.enabled,elementCount:this.shimmerElements.size,intensity:this.shimmerSettings.intensity,initialized:this.initialized},issues:e?[]:[...this.shimmerSettings.enabled?[]:["System disabled"],...this.shimmerElements.size>0?[]:["No shimmer elements found"]]}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.intersectionObserver=null),this.shimmerElements.forEach((e,i)=>{i.classList.remove("sn-shimmer-container"),e.shimmerLayer.parentNode&&e.shimmerLayer.parentNode.removeChild(e.shimmerLayer)}),this.shimmerElements.clear(),this.styleElement&&this.styleElement.parentNode&&(this.styleElement.parentNode.removeChild(this.styleElement),this.styleElement=null)}setShimmerIntensity(e){this.shimmerSettings.intensity=e,this.applyIntensitySettings(),this.updateShimmerElements()}setShimmerEnabled(e){this.shimmerSettings.enabled=e,this.updateShimmerElements()}addShimmerTarget(e){this.shimmerSettings.targetSelectors.includes(e)||(this.shimmerSettings.targetSelectors.push(e),document.querySelectorAll(e).forEach(a=>{this.addShimmerToElement(a)}))}removeShimmerTarget(e){let i=this.shimmerSettings.targetSelectors.indexOf(e);i>-1&&(this.shimmerSettings.targetSelectors.splice(i,1),document.querySelectorAll(e).forEach(r=>{let n=this.shimmerElements.get(r);n&&(this.shimmerElements.delete(r),this.intersectionObserver&&this.intersectionObserver.unobserve(r),r.classList.remove("sn-shimmer-container"),n.shimmerLayer.parentNode&&n.shimmerLayer.parentNode.removeChild(n.shimmerLayer))}))}getShimmerSettings(){return{...this.shimmerSettings}}getShimmerElementCount(){return this.shimmerElements.size}setQualityLevel(e){switch(this.currentQualityLevel=e,e){case"low":this.shimmerSettings.enabled=!1,this.shimmerSettings.maxSimultaneousShimmers=3,this.shimmerSettings.animationSpeed=.2,this.shimmerSettings.oilSlickIntensity=.3,this.shimmerSettings.chromaticAberration=.5,this.shimmerSettings.useGPUAcceleration=!1;break;case"low":this.shimmerSettings.enabled=!0,this.shimmerSettings.intensity="minimal",this.shimmerSettings.maxSimultaneousShimmers=5,this.shimmerSettings.animationSpeed=.3,this.shimmerSettings.oilSlickIntensity=.4,this.shimmerSettings.chromaticAberration=1,this.shimmerSettings.useGPUAcceleration=!1,this.shimmerSettings.interferencePattern=!1;break;case"medium":this.shimmerSettings.enabled=!0,this.shimmerSettings.intensity="balanced",this.shimmerSettings.maxSimultaneousShimmers=8,this.shimmerSettings.animationSpeed=.5,this.shimmerSettings.oilSlickIntensity=.7,this.shimmerSettings.chromaticAberration=2,this.shimmerSettings.useGPUAcceleration=!0,this.shimmerSettings.interferencePattern=!0;break;case"high":this.shimmerSettings.enabled=!0,this.shimmerSettings.intensity="intense",this.shimmerSettings.maxSimultaneousShimmers=12,this.shimmerSettings.animationSpeed=.7,this.shimmerSettings.oilSlickIntensity=.9,this.shimmerSettings.chromaticAberration=2.5,this.shimmerSettings.useGPUAcceleration=!0,this.shimmerSettings.interferencePattern=!0;break;case"high":this.shimmerSettings.enabled=!0,this.shimmerSettings.intensity="intense",this.shimmerSettings.maxSimultaneousShimmers=16,this.shimmerSettings.animationSpeed=1,this.shimmerSettings.oilSlickIntensity=1,this.shimmerSettings.chromaticAberration=3,this.shimmerSettings.useGPUAcceleration=!0,this.shimmerSettings.interferencePattern=!0;break}this.updateQualityCapabilities(e),this.applyQualityToExistingElements(),u?.debug?.log("IridescentShimmerEffectsSystem",`Quality level set to: ${e}`,{maxShimmers:this.shimmerSettings.maxSimultaneousShimmers,oilSlickIntensity:this.shimmerSettings.oilSlickIntensity,gpuAcceleration:this.shimmerSettings.useGPUAcceleration})}getPerformanceImpact(){let e=Array.from(this.shimmerElements.values()).filter(r=>r.isVisible).length,i=this.calculateAverageProcessingTime(),a=this.estimateMemoryUsage();return{fps:60,frameTime:i,memoryUsage:a,cpuUsage:this.estimateCPUUsage(e)}}reduceQuality(e){this.qualityAdjustments["shimmer-reduction"]=(this.qualityAdjustments["shimmer-reduction"]||0)+e,this.qualityAdjustments["animation-reduction"]=(this.qualityAdjustments["animation-reduction"]||0)+e*.8,this.qualityAdjustments["effect-reduction"]=(this.qualityAdjustments["effect-reduction"]||0)+e*.6,this.shimmerSettings.maxSimultaneousShimmers=Math.max(2,Math.floor(this.shimmerSettings.maxSimultaneousShimmers*(1-e*.5))),this.shimmerSettings.animationSpeed=Math.max(.1,this.shimmerSettings.animationSpeed*(1-e*.4)),this.shimmerSettings.oilSlickIntensity=Math.max(.2,this.shimmerSettings.oilSlickIntensity*(1-e*.6)),this.shimmerSettings.chromaticAberration=Math.max(.5,this.shimmerSettings.chromaticAberration*(1-e*.5)),e>.6&&(this.shimmerSettings.useGPUAcceleration=!1),e>.4&&(this.shimmerSettings.interferencePattern=!1),this.applyQualityToExistingElements(),u?.debug?.log("IridescentShimmerEffectsSystem",`Quality reduced by ${e}`,this.shimmerSettings)}increaseQuality(e){if(Object.keys(this.qualityAdjustments).forEach(i=>{this.qualityAdjustments[i]=Math.max(0,(this.qualityAdjustments[i]||0)-e)}),this.currentQualityLevel){let i=this.getBaseSettingsForLevel(this.currentQualityLevel);this.shimmerSettings.maxSimultaneousShimmers=Math.min(i.maxSimultaneousShimmers||this.shimmerSettings.maxSimultaneousShimmers,Math.floor(this.shimmerSettings.maxSimultaneousShimmers*(1+e*.3))),this.shimmerSettings.animationSpeed=Math.min(i.animationSpeed||this.shimmerSettings.animationSpeed,this.shimmerSettings.animationSpeed*(1+e*.2)),this.shimmerSettings.oilSlickIntensity=Math.min(i.oilSlickIntensity||this.shimmerSettings.oilSlickIntensity,this.shimmerSettings.oilSlickIntensity*(1+e*.3)),this.shimmerSettings.chromaticAberration=Math.min(i.chromaticAberration||this.shimmerSettings.chromaticAberration,this.shimmerSettings.chromaticAberration*(1+e*.2)),e>.3&&(this.shimmerSettings.interferencePattern=i.interferencePattern||!1),e>.5&&(this.shimmerSettings.useGPUAcceleration=i.useGPUAcceleration||!1)}this.applyQualityToExistingElements(),u?.debug?.log("IridescentShimmerEffectsSystem",`Quality increased by ${e}`,this.shimmerSettings)}getQualityCapabilities(){return[...this.qualityCapabilities]}updateQualityCapabilities(e){this.qualityCapabilities.forEach(i=>{switch(i.name){case"shimmer-effects":i.enabled=this.shimmerSettings.enabled;break;case"oil-slick-intensity":i.enabled=this.shimmerSettings.oilSlickIntensity>.3;break;case"chromatic-aberration":i.enabled=this.shimmerSettings.chromaticAberration>1;break;case"interference-patterns":i.enabled=this.shimmerSettings.interferencePattern;break;case"gpu-acceleration":i.enabled=this.shimmerSettings.useGPUAcceleration;break;case"element-pooling":i.enabled=this.shimmerSettings.poolingEnabled;break}})}getBaseSettingsForLevel(e){switch(e){case"low":return{maxSimultaneousShimmers:3,animationSpeed:.2,oilSlickIntensity:.3,chromaticAberration:.5,useGPUAcceleration:!1,interferencePattern:!1};case"low":return{maxSimultaneousShimmers:5,animationSpeed:.3,oilSlickIntensity:.4,chromaticAberration:1,useGPUAcceleration:!1,interferencePattern:!1};case"medium":return{maxSimultaneousShimmers:8,animationSpeed:.5,oilSlickIntensity:.7,chromaticAberration:2,useGPUAcceleration:!0,interferencePattern:!0};case"high":return{maxSimultaneousShimmers:12,animationSpeed:.7,oilSlickIntensity:.9,chromaticAberration:2.5,useGPUAcceleration:!0,interferencePattern:!0};case"high":return{maxSimultaneousShimmers:16,animationSpeed:1,oilSlickIntensity:1,chromaticAberration:3,useGPUAcceleration:!0,interferencePattern:!0};default:return{}}}applyQualityToExistingElements(){this.shimmerElements.forEach((e,i)=>{e.animation&&(e.animation.playbackRate=this.shimmerSettings.animationSpeed),e.intensity=this.shimmerSettings.oilSlickIntensity;let a={"--sn-shimmer-intensity":this.shimmerSettings.oilSlickIntensity.toString(),"--sn-shimmer-chromatic":this.shimmerSettings.chromaticAberration.toString(),"--sn-shimmer-speed":this.shimmerSettings.animationSpeed.toString()};this.cssController.batchSetVariables("IridescentShimmerEffectsSystem",a,"normal","shimmer-quality-update")})}calculateAverageProcessingTime(){let e=Array.from(this.shimmerElements.values()).filter(r=>r.isVisible).length,i=2,a=(this.shimmerSettings.oilSlickIntensity+this.shimmerSettings.chromaticAberration/3+this.shimmerSettings.animationSpeed)/3;return i*e*a}estimateMemoryUsage(){let e=Array.from(this.shimmerElements.values()).filter(r=>r.isVisible).length,i=.5,a=this.shimmerSettings.useGPUAcceleration?2:0;return i*e+a}estimateCPUUsage(e){let a=(this.shimmerSettings.oilSlickIntensity+this.shimmerSettings.chromaticAberration/3)/2,r=this.shimmerSettings.useGPUAcceleration?.5:1;return Math.min(40,3*e*a*r)}adjustQuality(e){switch(this.currentQualityLevel=e,e){case"low":this.shimmerSettings.intensity="minimal",this.shimmerSettings.oilSlickIntensity=.2,this.shimmerSettings.useGPUAcceleration=!1;break;case"medium":this.shimmerSettings.intensity="balanced",this.shimmerSettings.oilSlickIntensity=.5,this.shimmerSettings.useGPUAcceleration=!0;break;case"high":default:this.shimmerSettings.intensity="intense",this.shimmerSettings.oilSlickIntensity=.8,this.shimmerSettings.useGPUAcceleration=!0;break}}}});function rs(l,t){let e=Math.max(0,Math.min(.9999,l))*63,i=Math.max(0,Math.min(.9999,t))*63,a=Math.floor(e),r=Math.floor(i),n=a+1,s=r+1,o=e-a,c=i-r,m=ft[r*64+a],d=ft[r*64+n%64],h=ft[s%64*64+a],g=ft[s%64*64+n%64],f=(V,W,$)=>V+(W-V)*$,v=f(m.x,d.x,o),C=f(m.y,d.y,o),T=f(h.x,g.x,o),w=f(h.y,g.y,o);return{x:f(v,T,c),y:f(C,w,c)}}var ft,ns=y(()=>{"use strict";ft=new Array(4096);(function(){for(let t=0;t<ft.length;t++){let e=Math.random()*Math.PI*2;ft[t]={x:Math.cos(e),y:Math.sin(e)}}})()});var ss={};te(ss,{SidebarVisualEffectsSystem:()=>$e});var yt,$e,Di=y(()=>{"use strict";G();ns();ne();yt=class yt extends N{constructor(e,i,a,r,n,s=null){super(e,i,a,r,n);this.rootNavBar=null;this.overlayContainer=null;this.resizeObserver=null;this.visualEffectsElement=null;this.harmonicModeIndicator=null;this.visualEffectsAnimationFrame=null;this.echoPool=[];this.currentEchoCount=0;this._elementsWithActiveEcho=new WeakSet;this._navInteractionHandler=null;this.echoTimerCounter=0;this._lastMotionDisabled=!1;this.interactionPatterns=new Map;this.proximityObserver=null;this.interactionElements=new Map;this.activeEffects=[];this.animationPhase=0;this.localFrameCount=0;this.musicBeatIntensity=0;this.musicEnergyLevel=0;this.cursorPosition={x:0,y:0};this.cursorVelocity={x:0,y:0};this.lastCursorUpdate=0;this.MAX_EFFECT_POINTS=50;this.EFFECT_DECAY_RATE=.05;this.PROXIMITY_THRESHOLD=100;this.INTERACTION_COOLDOWN=16;this.ANIMATION_LERP=.08;this.SMOOTHING_LERP=.12;this.INTENSITY_LERP=.15;this.year3000System=s,this.masterAnimationRegistered=!1,this.isUsingMasterAnimation=!1,this.currentHarmonicModeClass="",this.currentEnergyClass="",this.currentHarmonicModeKey="artist-vision",this.nexusVariables={},this.performanceMetrics={animationFrames:0,maxFrameTime:0,averageFrameTime:0,frameTimeHistory:[],cssVariableUpdates:0,elementUpdates:0},this.deviceCapabilities={supportsCSSFilter:this._detectCSSFilterSupport(),supportsTransforms:this._detectTransformSupport(),performanceLevel:this._detectPerformanceLevel(),reducedMotion:this._detectReducedMotion()},this.animationState={lastPulse:0,pulseDirection:1,baseOpacity:.7,currentScale:1,targetScale:1,smoothingFactor:.15},this.visualState={direction:"radial",intensity:.3,velocity:50,smoothing:.7,effectPoints:[]},this.userInteractionState={globalIntensity:0,dominantDirection:0,interactionCount:0,lastInteractionTime:0,proximityElements:[]},this.setupEffectPoints(),this.setupInteractionPatterns(),e.enableDebug&&console.log(`[${this.systemName}] Enhanced with visual interaction system`)}onAnimate(e){}_detectCSSFilterSupport(){let e=document.createElement("div");return e.style.filter="blur(1px)",!!e.style.filter}_detectTransformSupport(){let e=document.createElement("div");return e.style.transform="scale(1.1)",!!e.style.transform}_detectPerformanceLevel(){let e=navigator.deviceMemory||4,i=navigator.hardwareConcurrency||4;return e>=8&&i>=8?"high":e>=4&&i>=4?"medium":"low"}_detectReducedMotion(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}async initialize(){if(await super.initialize(),this.rootNavBar=document.querySelector(".Root__nav-bar"),!this.rootNavBar){this.initialized=!1;return}this._createOverlayContainer(),this._createVisualEffectsElement(),this.createHarmonicModeDisplay(),this.updateColors(),this.rootNavBar&&(this._navInteractionHandler=e=>{let i=e.target;!i||!(i instanceof HTMLElement)||i.matches("a, button, [role='link']")&&this._spawnNavEcho(i)},this.rootNavBar.addEventListener("focusin",this._navInteractionHandler,!0),this.rootNavBar.addEventListener("pointerenter",this._navInteractionHandler,!0)),this._tryRegisterWithMasterAnimation(),this._setupResizeObserver()}_createOverlayContainer(){this.overlayContainer=document.createElement("div"),this.overlayContainer.id="sidebar-visual-effects-overlay",this.overlayContainer.style.position="absolute",this.overlayContainer.style.pointerEvents="none",this.overlayContainer.style.zIndex="1000",document.body.appendChild(this.overlayContainer)}_setupResizeObserver(){!this.rootNavBar||!this.overlayContainer||(this.resizeObserver=new ResizeObserver(e=>{for(let i of e){let{left:a,top:r,width:n,height:s}=i.contentRect;this.overlayContainer&&(this.overlayContainer.style.left=`${a}px`,this.overlayContainer.style.top=`${r}px`,this.overlayContainer.style.width=`${n}px`,this.overlayContainer.style.height=`${s}px`)}}),this.resizeObserver.observe(this.rootNavBar))}_tryRegisterWithMasterAnimation(){if(this.year3000System&&this.year3000System.registerAnimationSystem)try{this.year3000System.registerAnimationSystem("SidebarVisualEffectsSystem",this,"background",this.deviceCapabilities.performanceLevel==="high"?30:15),this.masterAnimationRegistered=!0,this.isUsingMasterAnimation=!0}catch{this._startFallbackVisualEffectsLoop()}else this._startFallbackVisualEffectsLoop()}_startFallbackVisualEffectsLoop(){this.isUsingMasterAnimation=!1,this.startVisualEffectsLoop()}updateAnimation(e){if(this.deviceCapabilities.reducedMotion||!this.visualEffectsElement||!this.rootNavBar)return;let a=performance.now()*.001,r=Math.sin(a*2)*.1+.9;if(this.animationState.targetScale=r,this.animationState.currentScale+=(this.animationState.targetScale-this.animationState.currentScale)*this.animationState.smoothingFactor,this.visualEffectsElement.style.transform=`translateX(-50%) scale(${this.animationState.currentScale.toFixed(3)})`,this.harmonicModeIndicator){let n=(Math.sin(a*1.5)*.1+.85).toFixed(2);this.harmonicModeIndicator.style.opacity=n}}onPerformanceModeChange(e){e==="low"?this.animationState.smoothingFactor=.3:this.animationState.smoothingFactor=.15}handleSettingsChange(e){super.handleSettingsChange(e),e.detail.key==="sn-harmonic-mode"&&this.updateHarmonicModeDisplay(e.detail.value)}_createVisualEffectsElement(){this.overlayContainer&&(this.visualEffectsElement=document.createElement("div"),this.visualEffectsElement.className="sidebar-visual-effects-element",this.overlayContainer.appendChild(this.visualEffectsElement))}createHarmonicModeDisplay(){this.overlayContainer&&(this.harmonicModeIndicator=document.createElement("div"),this.harmonicModeIndicator.className="harmonic-mode-indicator",this.overlayContainer.appendChild(this.harmonicModeIndicator))}updateColors(){if(!this.visualEffectsElement||!this.harmonicModeIndicator||!this.rootNavBar)return;let e=getComputedStyle(this.rootNavBar),i=e.getPropertyValue("--spice-sidebar"),a=e.getPropertyValue("--spice-text");this.visualEffectsElement.style.backgroundColor=i,this.visualEffectsElement.style.borderColor=a,this.visualEffectsElement.style.borderWidth="1px",this.visualEffectsElement.style.borderStyle="solid",this.harmonicModeIndicator&&(this.harmonicModeIndicator.style.backgroundColor=`rgba(${this.utils.hexToRgb(a)?.r}, ${this.utils.hexToRgb(a)?.g}, ${this.utils.hexToRgb(a)?.b}, 0.1)`,this.harmonicModeIndicator.style.color=a)}startVisualEffectsLoop(){this.visualEffectsAnimationFrame&&cancelAnimationFrame(this.visualEffectsAnimationFrame);let e=i=>{this.updateAnimation(16.67),this.visualEffectsAnimationFrame=requestAnimationFrame(e)};this.visualEffectsAnimationFrame=requestAnimationFrame(e)}updateHarmonicModeDisplay(e){if(this.currentHarmonicModeKey=e,this.rootNavBar){let i=this.rootNavBar.classList;i.forEach(r=>{r.startsWith("sn-harmonic-")&&i.remove(r)}),ve[e]&&this.rootNavBar.classList.add(`sn-harmonic-${e}`)}}_updateSidebarVariables(e={}){if(!this.rootNavBar)return;let{visualIntensity:i=.5,moodIdentifier:a="neutral",energyLevel:r="low"}=e;this.rootNavBar.classList.remove("sn-music-low-energy","sn-music-mid-energy","sn-music-high-energy"),this.rootNavBar.classList.add(`sn-music-${r}-energy`),this.rootNavBar.setAttribute("data-mood",a);let n=Math.max(0,Math.min(1,i)),s=Math.min(.5,n*.6),o=(c,m)=>{this.year3000System&&this.year3000System.queueCSSVariableUpdate?this.year3000System.queueCSSVariableUpdate(c,m,this.rootNavBar):this.rootNavBar.style.setProperty(c,m)};o("--sn-nav-item-glow-intensity",`${n}`),o("--sn-nav-text-energy-opacity",`${s}`),o("--sidebar-intensity",`${i}`)}updateFromMusicAnalysis(e,i,a){this.initialized&&(super.updateFromMusicAnalysis(e),this._updateSidebarVariables(e))}updateModeConfiguration(e){super.updateModeConfiguration(e),this.currentHarmonicModeKey=e.activeMode||"artist-vision",this.updateVisualEffectsForMode(),this.updateHarmonicModeDisplay(this.currentHarmonicModeKey)}updateVisualEffectsForMode(){if(this.visualEffectsElement){let e=this.modeConfig?.intensityMultiplier||1;this.visualEffectsElement.style.opacity=`${.1*e}`}}destroy(){if(this.visualEffectsAnimationFrame&&cancelAnimationFrame(this.visualEffectsAnimationFrame),this.year3000System?.timerConsolidationSystem)for(let e=0;e<this.echoTimerCounter;e++)this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer(`SidebarVisualEffectsSystem-echo-${e}`);if(this.rootNavBar&&this._navInteractionHandler&&(this.rootNavBar.removeEventListener("focusin",this._navInteractionHandler,!0),this.rootNavBar.removeEventListener("pointerenter",this._navInteractionHandler,!0),this._navInteractionHandler=null),this.year3000System&&this.year3000System.unregisterAnimationSystem&&this.year3000System.unregisterAnimationSystem("SidebarVisualEffectsSystem"),this.resizeObserver&&this.rootNavBar&&(this.resizeObserver.unobserve(this.rootNavBar),this.resizeObserver.disconnect(),this.resizeObserver=null),this.overlayContainer&&this.overlayContainer.parentNode&&(this.overlayContainer.parentNode.removeChild(this.overlayContainer),this.overlayContainer=null),this.rootNavBar){let e=this.rootNavBar.classList;e.forEach(i=>{i.startsWith("sn-")&&e.remove(i)})}super.destroy()}get echoIntensitySetting(){let i=parseInt("2",10);return isNaN(i)?2:i}get dynamicMaxEchoes(){switch(this.echoIntensitySetting){case 0:return 0;case 1:return Math.ceil(yt.BASE_MAX_ECHOES/2);case 3:return yt.BASE_MAX_ECHOES*2;default:return yt.BASE_MAX_ECHOES}}_acquireEchoElement(){let e=this.echoPool.pop();return e?(e.style.animation="none",e.offsetWidth,e.style.animation=""):(e=document.createElement("div"),e.className="sn-temporal-echo"),e}_releaseEchoElement(e){this.echoPool.length<20&&this.echoPool.push(e)}_spawnNavEcho(e){if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||this.currentEchoCount>=this.dynamicMaxEchoes||this.echoIntensitySetting===0||this._elementsWithActiveEcho.has(e))return;let i=this.musicSyncService?.getLatestProcessedData()??{},a=i.energy??.5,r=i.valence??.5,n=Math.min(1.4,1+a*.4),s=((r-.5)*40).toFixed(1),o=e.getBoundingClientRect(),c=o.left/window.innerWidth,m=o.top/window.innerHeight,d=rs(c,m),h=this.musicSyncService?.getCurrentBeatVector?.()??{x:0,y:0},g=6+a*6,f=(d.x+h.x)*g,v=(d.y+h.y)*g,C=d.x*6,T=(Math.random()*360).toFixed(1),w=this._acquireEchoElement();w.style.setProperty("--sn-echo-radius-multiplier",n.toFixed(2)),w.style.setProperty("--sn-echo-hue-shift",`${s}deg`),w.style.setProperty("--sn-echo-offset-x",`${f.toFixed(1)}px`),w.style.setProperty("--sn-echo-offset-y",`${v.toFixed(1)}px`),w.style.setProperty("--sn-echo-skew",`${C.toFixed(2)}deg`),w.style.setProperty("--sn-echo-rotate",`${T}deg`),e.appendChild(w),this.currentEchoCount++,this._elementsWithActiveEcho.add(e);let V=`SidebarVisualEffectsSystem-echo-${this.echoTimerCounter++}`,W=()=>{w.parentElement&&w.parentElement.removeChild(w),this.currentEchoCount--,this._releaseEchoElement(w),this._elementsWithActiveEcho.delete(e)};this.year3000System?.timerConsolidationSystem?this.year3000System.timerConsolidationSystem.registerConsolidatedTimer(V,W,1100,"background"):setTimeout(W,1100)}applyPerformanceSettings(e){super.applyPerformanceSettings(e);let a=!e.enableGPUAcceleration||e.animationThrottle>=24||e.reducedMotion;this.rootNavBar&&a!==this._lastMotionDisabled&&(this.rootNavBar.classList.toggle("sn-motion-disabled",a),this._lastMotionDisabled=a)}setupEffectPoints(){this.visualState.effectPoints=[];let e=8,i=20;for(let a=0;a<e;a++)for(let r=0;r<e;r++){let n={x:a*i,y:r*i,magnitude:.5+Math.random()*.5,direction:Math.random()*Math.PI*2,influence:.3+Math.random()*.4};this.visualState.effectPoints.push(n)}}setupInteractionPatterns(){this.interactionPatterns.set("hover",{id:"hover",type:"hover",response:{intensityChange:.2,velocityChange:.1,smoothingChange:-.1,visualEffects:[{center:{x:0,y:0},radius:30,strength:.3,decay:.05,type:"wave"}],rippleEffect:!1,glowEffect:!0},duration:300,easing:"smooth",priority:3}),this.interactionPatterns.set("click",{id:"click",type:"click",response:{intensityChange:.5,velocityChange:.3,smoothingChange:-.2,visualEffects:[{center:{x:0,y:0},radius:50,strength:.7,decay:.08,type:"pulse"}],rippleEffect:!1,glowEffect:!0},duration:500,easing:"smooth",priority:8}),this.interactionPatterns.set("focus",{id:"focus",type:"focus",response:{intensityChange:.3,velocityChange:.05,smoothingChange:.1,visualEffects:[{center:{x:0,y:0},radius:40,strength:.4,decay:.02,type:"spiral"}],rippleEffect:!1,glowEffect:!0},duration:1e3,easing:"smooth",priority:6})}setupProximityDetection(){typeof IntersectionObserver<"u"&&(this.proximityObserver=new IntersectionObserver(e=>{e.forEach(i=>{let a=i.target,r=a.id||a.className;i.isIntersecting?(this.interactionElements.set(r,a),this.handleProximityEnter(a)):(this.interactionElements.delete(r),this.handleProximityExit(a))})},{threshold:[0,.1,.5,1],rootMargin:`${this.PROXIMITY_THRESHOLD}px`}))}handleProximityEnter(e){let i=e.getBoundingClientRect(),a={x:i.left+i.width/2,y:i.top+i.height/2},r=Math.sqrt(Math.pow(a.x-this.cursorPosition.x,2)+Math.pow(a.y-this.cursorPosition.y,2));this.userInteractionState.proximityElements.push({element:e,distance:r,influence:Math.max(0,1-r/this.PROXIMITY_THRESHOLD)})}handleProximityExit(e){this.userInteractionState.proximityElements=this.userInteractionState.proximityElements.filter(i=>i.element!==e)}updateVisualEffects(){this.activeEffects=this.activeEffects.filter(e=>(e.strength*=1-e.decay,e.strength>.01)),this.activeEffects.forEach(e=>{this.visualState.effectPoints.forEach(i=>{let a=Math.sqrt(Math.pow(i.x-e.center.x,2)+Math.pow(i.y-e.center.y,2));if(a<e.radius){let r=e.strength*(1-a/e.radius);switch(e.type){case"wave":i.magnitude+=r*.3;break;case"spiral":i.direction+=r*.5;break;case"pulse":i.magnitude+=r*.5,i.direction+=r*.2;break;case"vortex":let n=Math.atan2(i.y-e.center.y,i.x-e.center.x);i.direction=n+r*Math.PI*.5;break}}})})}updateMusicVisualEffects(){let e=this.musicBeatIntensity*.3;this.visualState.intensity=Math.max(this.visualState.intensity,e);let i=this.musicEnergyLevel*30;this.visualState.velocity=Math.min(200,this.visualState.velocity+i);let a=(1-this.musicEnergyLevel)*.2;this.visualState.smoothing=Math.max(.1,this.visualState.smoothing-a)}getVisualState(){return{...this.visualState}}getUserInteractionState(){return{...this.userInteractionState}}getActiveEffects(){return[...this.activeEffects]}};yt.BASE_MAX_ECHOES=4;$e=yt});var bt,ar=y(()=>{"use strict";U();k();A();ne();bt=class extends N{constructor(e,i,a,r,n){super(e,i,a,r,n);this.systemName="UIVisualEffectsController";this.legacySystemName="UIVisualEffectsController";this.visualEffectsCoordinator=null;this.currentVisualField=null;this.currentConsciousnessField=null;this.shimmerElements=new Map;this.mutationObserver=null;this.intersectionObserver=null;this.animationFrameId=null;this.lastFrameTime=0;this.frameTimeHistory=[];this.eventUnsubscribeFunctions=[];this.customPerformanceMonitor={frameCount:0,totalFrameTime:0,lastPerformanceCheck:0,adaptiveQualityLevel:1};this.diagnosticTimerId=null;this.lastDiagnosticRun=0;this.uiEffectsConfig={enabled:!0,activityThreshold:.3,shimmerEnabled:!0,shimmerIntensity:.6,shimmerType:"mixed",shimmerPerformanceLevel:"balanced",interactionTrackingEnabled:!0,digitalMeditationThreshold:3e4,scrollVelocityTracking:!0,diagnosticEnabled:!0,autoFixWhiteLayer:!0,diagnosticInterval:5e3,audioVisualEnabled:!0,beatSynchronization:!0,nebulaEffectIntensity:this.getNebulaIntensityFromSettings(),scrollEffectsEnabled:!0,prismaticSheenIntensity:.5,maxFrameTime:1,adaptiveQuality:!0,debugMode:e.enableDebug||!1},this.activityState=this.createInitialActivityState(),u?.debug?.log("UIVisualEffectsController","Unified UI effects controller created")}get systemPriority(){return"normal"}getNebulaIntensityFromSettings(){if(!this.settingsManager)return .7;switch(this.settingsManager.get("sn-gradient-intensity")){case"disabled":return 0;case"minimal":return .3;case"balanced":return .7;case"intense":return 1;default:return .7}}createInitialActivityState(){return{activityLevel:"dormant",shimmer:{intensity:0,effectType:"mixed",activeElements:new Set,performanceLevel:this.uiEffectsConfig.shimmerPerformanceLevel},interaction:{isActive:!1,lastInteractionTime:0,digitalMeditationDetected:!1,scrollVelocity:{x:0,y:0,direction:"none"},nexusState:"idle"},diagnostic:{whiteLayerIssues:[],webglContextHealthy:!0,lastDiagnosticTime:0,autoFixEnabled:this.uiEffectsConfig.autoFixWhiteLayer,criticalIssuesDetected:0},audioVisual:{beatIntensity:0,genreChangeDetected:!1,nebulaEffectIntensity:0,lastBeatTime:0,performanceAdaptive:this.uiEffectsConfig.adaptiveQuality},scroll:{sheenIntensity:0,scrollRatio:0,prismaticEffectActive:!1,lastScrollTime:0},performance:{frameTime:0,avgFrameTime:0,maxFrameTime:0,healthStatus:"excellent",adaptiveQualityEnabled:this.uiEffectsConfig.adaptiveQuality}}}async initialize(){try{u?.debug?.log("UIVisualEffectsController","Starting unified UI effects initialization..."),await this.initializeVisualCSS(),await this.initializeVisualCoordination(),this.subscribeToUnifiedEvents(),this.uiEffectsConfig.shimmerEnabled&&await this.initializeShimmerEffects(),this.uiEffectsConfig.interactionTrackingEnabled&&await this.initializeInteractionTracking(),this.uiEffectsConfig.diagnosticEnabled&&await this.initializeDiagnosticSystem(),this.uiEffectsConfig.audioVisualEnabled&&await this.initializeAudioVisualEffects(),this.uiEffectsConfig.scrollEffectsEnabled&&await this.initializeScrollEffects(),this.startUnifiedAnimationLoop(),this.initialized=!0,u?.debug?.log("UIVisualEffectsController","Unified UI effects controller initialized")}catch(e){throw u?.debug?.error("UIVisualEffectsController","Failed to initialize:",e),e}}async initializeVisualCSS(){return this.initializeCSSConsciousness()}async initializeCSSConsciousness(){try{this.cssController=globalThis.unifiedVisualCSSController||globalThis.unifiedCSSConsciousnessController||null,this.cssController=P(),this.cssController?u?.debug?.log("UIVisualEffectsController","Connected to unified CSS visual effects"):u?.debug?.warn("UIVisualEffectsController","CSS visual effects not available, using coordinator fallback")}catch(e){u?.debug?.warn("UIVisualEffectsController","CSS visual effects initialization failed:",e)}}async initializeVisualCoordination(){return this.initializeConsciousnessIntegration()}async initializeConsciousnessIntegration(){try{this.visualEffectsCoordinator=globalThis.backgroundVisualCoordinator||globalThis.backgroundConsciousnessChoreographer||null,this.visualEffectsCoordinator?(this.visualEffectsCoordinator.registerVisualEffectsParticipant?this.visualEffectsCoordinator.registerVisualEffectsParticipant(this):this.visualEffectsCoordinator.registerConsciousnessParticipant&&this.visualEffectsCoordinator.registerConsciousnessParticipant(this),u?.debug?.log("UIVisualEffectsController","Registered with visual effects coordinator")):u?.debug?.log("UIVisualEffectsController","Operating without visual effects coordinator integration")}catch(e){u?.debug?.warn("UIVisualEffectsController","Visual coordination integration failed:",e)}}subscribeToUnifiedEvents(){let e=p.subscribe("music:beat",this.handleMusicBeat.bind(this),"UIVisualEffectsController");this.eventUnsubscribeFunctions.push(()=>p.unsubscribe(e));let i=p.subscribe("music:energy",this.handleMusicEnergy.bind(this),"UIVisualEffectsController");this.eventUnsubscribeFunctions.push(()=>p.unsubscribe(i));let a=p.subscribe("settings:changed",this.handleSettingsChange.bind(this),"UIVisualEffectsController");this.eventUnsubscribeFunctions.push(()=>p.unsubscribe(a)),u?.debug?.log("UIVisualEffectsController",`Subscribed to ${this.eventUnsubscribeFunctions.length} unified events`)}async initializeShimmerEffects(){try{this.setupElementObservers(),await this.discoverShimmerElements(),u?.debug?.log("UIVisualEffectsController",`Shimmer effects initialized with ${this.shimmerElements.size} elements`)}catch(e){u?.debug?.error("UIVisualEffectsController","Shimmer effects initialization failed:",e)}}async initializeInteractionTracking(){try{this.setupInteractionListeners(),u?.debug?.log("UIVisualEffectsController","Interaction tracking initialized")}catch(e){u?.debug?.error("UIVisualEffectsController","Interaction tracking initialization failed:",e)}}async initializeDiagnosticSystem(){try{this.startDiagnosticMonitoring(),u?.debug?.log("UIVisualEffectsController","Diagnostic system initialized")}catch(e){u?.debug?.error("UIVisualEffectsController","Diagnostic system initialization failed:",e)}}async initializeAudioVisualEffects(){try{u?.debug?.log("UIVisualEffectsController","Audio-visual effects initialized")}catch(e){u?.debug?.error("UIVisualEffectsController","Audio-visual effects initialization failed:",e)}}async initializeScrollEffects(){try{u?.debug?.log("UIVisualEffectsController","Scroll effects initialized")}catch(e){u?.debug?.error("UIVisualEffectsController","Scroll effects initialization failed:",e)}}setupElementObservers(){typeof MutationObserver<"u"&&(this.mutationObserver=new MutationObserver(e=>{let i=!1;e.forEach(a=>{a.type==="childList"&&a.addedNodes.forEach(r=>{r.nodeType===Node.ELEMENT_NODE&&(i=!0)})}),i&&this.discoverShimmerElements()}),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0})),typeof IntersectionObserver<"u"&&(this.intersectionObserver=new IntersectionObserver(e=>{e.forEach(i=>{let a=i.target.getAttribute("data-shimmer-id");a&&(i.isIntersecting?this.activityState.shimmer.activeElements.add(a):this.activityState.shimmer.activeElements.delete(a))})},{threshold:[0,.1,.5,1]}))}async discoverShimmerElements(){let e=[".main-card-card",".main-trackList-trackListRow",".main-button-primary",".main-playButton-button",'[data-testid="card-click-handler"]'],i=0;e.forEach(a=>{document.querySelectorAll(a).forEach((n,s)=>{let o=`shimmer-${a.replace(/[^\w]/g,"_")}-${s}`,c=n;c.setAttribute("data-shimmer-id",o),this.shimmerElements.set(o,c),this.intersectionObserver&&this.intersectionObserver.observe(c),i++})}),this.uiEffectsConfig.debugMode&&i>0&&u?.debug?.log("UIVisualEffectsController",`Discovered ${i} shimmer elements`)}setupInteractionListeners(){["click","keydown","mousemove","scroll","touchstart"].forEach(i=>{document.addEventListener(i,()=>{this.activityState.interaction.isActive=!0,this.activityState.interaction.lastInteractionTime=Date.now(),this.activityState.interaction.digitalMeditationDetected=!1,this.updateNexusState()},{passive:!0})})}startDiagnosticMonitoring(){this.diagnosticTimerId=window.setInterval(()=>{this.runDiagnosticCheck()},this.uiEffectsConfig.diagnosticInterval)}startUnifiedAnimationLoop(){let e=i=>{if(!this.initialized)return;let a=i-this.lastFrameTime;this.lastFrameTime=i;let r=performance.now();try{this.updateVisualActivityState(a),this.uiEffectsConfig.shimmerEnabled&&this.updateShimmerEffects(a),this.uiEffectsConfig.interactionTrackingEnabled&&this.updateInteractionTracking(a),this.uiEffectsConfig.audioVisualEnabled&&this.updateAudioVisualEffects(a),this.uiEffectsConfig.scrollEffectsEnabled&&this.updateScrollEffects(a),this.applyCSSUpdates();let n=performance.now()-r;this.updatePerformanceMetrics(n),n>this.uiEffectsConfig.maxFrameTime&&this.handlePerformanceIssue(n)}catch(n){u?.debug?.error("UIVisualEffectsController","Animation loop error:",n)}this.animationFrameId=requestAnimationFrame(e)};this.animationFrameId=requestAnimationFrame(e)}updateVisualActivityState(e){let i=this.activityState,a=i.shimmer.intensity*.2+(i.interaction.isActive?.3:0)+i.audioVisual.beatIntensity*.3+i.scroll.sheenIntensity*.2;a>.8?(i.activityLevel="enhanced",i.transcendentLevel="advanced"):a>.5?i.activityLevel="focused":a>.2?i.activityLevel="aware":i.activityLevel="dormant"}updateShimmerEffects(e){let i=this.activityState.shimmer,a=this.activityState.audioVisual.beatIntensity*.3,r=this.activityState.interaction.isActive?.2:0;i.intensity=Math.min(this.uiEffectsConfig.shimmerIntensity+a+r,1),this.activityState.performance.healthStatus==="degraded"?i.intensity*=.7:this.activityState.performance.healthStatus==="critical"&&(i.intensity*=.3)}updateInteractionTracking(e){let i=this.activityState.interaction,r=Date.now()-i.lastInteractionTime;r>this.uiEffectsConfig.digitalMeditationThreshold&&(i.digitalMeditationDetected||(i.digitalMeditationDetected=!0,u?.debug?.log("UIVisualEffectsController","Digital meditation detected",{inactiveTime:r}))),this.updateNexusState()}updateNexusState(){let e=this.activityState.interaction,a=Date.now()-e.lastInteractionTime;e.digitalMeditationDetected?e.nexusState="meditation":a<1e3?e.nexusState="active":a<1e4?e.nexusState="flow":e.nexusState="idle"}updateAudioVisualEffects(e){let i=this.activityState.audioVisual,a=this.activityState.activityLevel==="enhanced"?.2:0;i.nebulaEffectIntensity=Math.min(this.uiEffectsConfig.nebulaEffectIntensity+i.beatIntensity*.3+a,1)}updateScrollEffects(e){let i=this.activityState.scroll;Date.now()-i.lastScrollTime<1e3?(i.prismaticEffectActive=!0,i.sheenIntensity=Math.min(i.scrollRatio*this.uiEffectsConfig.prismaticSheenIntensity,1)):(i.prismaticEffectActive=!1,i.sheenIntensity*=.95)}applyCSSUpdates(){let e=this.activityState,i={"--sn-ui-activity-level":e.activityLevel,"--sn-shimmer-intensity":e.shimmer.intensity.toFixed(3),"--sn-shimmer-effect-type":e.shimmer.effectType,"--sn-shimmer-performance":e.shimmer.performanceLevel,"--sn-interaction-nexus-state":e.interaction.nexusState,"--sn-interaction-meditation":e.interaction.digitalMeditationDetected?"1":"0","--sn-scroll-velocity-x":e.interaction.scrollVelocity.x.toFixed(2),"--sn-scroll-velocity-y":e.interaction.scrollVelocity.y.toFixed(2),"--sn-beat-intensity":e.audioVisual.beatIntensity.toFixed(3),"--sn-nebula-intensity":e.audioVisual.nebulaEffectIntensity.toFixed(3),"--sn-genre-change":e.audioVisual.genreChangeDetected?"1":"0","--sn-scroll-sheen-intensity":e.scroll.sheenIntensity.toFixed(3),"--sn-scroll-ratio":e.scroll.scrollRatio.toFixed(3),"--sn-prismatic-active":e.scroll.prismaticEffectActive?"1":"0","--sn-white-layer-issues":e.diagnostic.whiteLayerIssues.length.toString(),"--sn-webgl-healthy":e.diagnostic.webglContextHealthy?"1":"0"};try{this.cssController.batchSetVariables("UIVisualEffectsController",i,"normal","ui-activity-update")}catch(a){u?.debug?.warn("UIVisualEffectsController","CSS coordination error:",a)}}updatePerformanceMetrics(e){let i=this.activityState.performance;i.frameTime=e,this.frameTimeHistory.push(e),this.frameTimeHistory.length>60&&this.frameTimeHistory.shift(),i.avgFrameTime=this.frameTimeHistory.reduce((a,r)=>a+r,0)/this.frameTimeHistory.length,i.maxFrameTime=Math.max(...this.frameTimeHistory),i.avgFrameTime>2?i.healthStatus="critical":i.avgFrameTime>1.5?i.healthStatus="degraded":i.avgFrameTime>1?i.healthStatus="good":i.healthStatus="excellent"}handlePerformanceIssue(e){this.uiEffectsConfig.adaptiveQuality&&(this.customPerformanceMonitor.adaptiveQualityLevel*=.9,this.customPerformanceMonitor.adaptiveQualityLevel<.5&&(this.activityState.shimmer.performanceLevel="minimal"),this.uiEffectsConfig.debugMode&&u?.debug?.warn("UIVisualEffectsController",`Performance issue: ${e.toFixed(2)}ms, reduced quality to ${this.customPerformanceMonitor.adaptiveQualityLevel.toFixed(2)}`))}runDiagnosticCheck(){let e=this.activityState.diagnostic,i=Date.now();e.lastDiagnosticTime=i,e.whiteLayerIssues=[];try{let a=document.createElement("canvas"),r=a.getContext("webgl")||a.getContext("experimental-webgl");e.webglContextHealthy=!!r;let n=document.querySelectorAll('[style*="background"], [style*="color"]'),s=0;n.forEach(o=>{let c=window.getComputedStyle(o);(c.backgroundColor==="rgb(255, 255, 255)"||c.color==="rgb(255, 255, 255)")&&s++}),s>10&&(e.whiteLayerIssues.push(`Excessive white layers detected: ${s}`),e.autoFixEnabled&&this.autoFixWhiteLayerIssues()),e.criticalIssuesDetected=e.whiteLayerIssues.length}catch(a){u?.debug?.error("UIVisualEffectsController","Diagnostic check failed:",a)}}autoFixWhiteLayerIssues(){try{this.cssController.batchSetVariables("UIVisualEffectsController",{"--spice-text":"var(--spice-main)","--spice-subtext":"var(--catppuccin-text)"},"critical","white-layer-autofix"),this.uiEffectsConfig.debugMode&&u?.debug?.log("UIVisualEffectsController","Applied white layer auto-fix")}catch(e){u?.debug?.error("UIVisualEffectsController","Auto-fix failed:",e)}}handleMusicBeat(e){let i=this.activityState.audioVisual;if(i.beatIntensity=e.intensity||.5,i.lastBeatTime=Date.now(),this.uiEffectsConfig.shimmerEnabled){let a=i.beatIntensity*.2;this.activityState.shimmer.intensity=Math.min(this.activityState.shimmer.intensity+a,1)}}handleMusicEnergy(e){let i=this.activityState.audioVisual;e.energy!==void 0&&(i.beatIntensity=Math.max(i.beatIntensity,e.energy*.8))}handleGenreChange(e){let i=this.activityState.audioVisual;i.genreChangeDetected=!0,setTimeout(()=>{i.genreChangeDetected=!1},2e3)}handleUserScroll(e){let i=this.activityState.scroll,a=this.activityState.interaction;i.lastScrollTime=Date.now(),i.scrollRatio=e.scrollRatio||0,e.velocity&&(a.scrollVelocity={x:e.velocity.x||0,y:e.velocity.y||0,direction:e.direction||"none"}),this.handleUserInteraction({type:"scroll",timestamp:Date.now()})}handleUserInteraction(e){let i=this.activityState.interaction;i.isActive=!0,i.lastInteractionTime=e.timestamp||Date.now(),i.digitalMeditationDetected=!1,this.updateNexusState()}handleSettingsChange(e){let{key:i,value:a}=e;i.startsWith("sn-ui-effects-")?this.updateConfigFromSettings(i,a):i==="sn-gradient-intensity"&&(this.uiEffectsConfig.nebulaEffectIntensity=this.getNebulaIntensityFromSettings(),u?.debug?.log("UIVisualEffectsController",`Updated nebula intensity to: ${this.uiEffectsConfig.nebulaEffectIntensity} from consolidated gradient setting: ${a}`))}updateConfigFromSettings(e,i){switch(e){case"sn-ui-effects-shimmer-intensity":this.uiEffectsConfig.shimmerIntensity=parseFloat(i)||.6;break;case"sn-ui-effects-diagnostic-enabled":this.uiEffectsConfig.diagnosticEnabled=i==="true"||i===!0;break;case"sn-ui-effects-adaptive-quality":this.uiEffectsConfig.adaptiveQuality=i==="true"||i===!0;break}}getConsciousnessContribution(){return{systemName:this.systemName,activityLevel:this.activityState.activityLevel,shimmerIntensity:this.activityState.shimmer.intensity,interactionState:this.activityState.interaction.nexusState,audioVisualIntensity:this.activityState.audioVisual.nebulaEffectIntensity,scrollActivity:this.activityState.scroll.sheenIntensity,timestamp:Date.now()}}onVisualFieldUpdate(e){return this.onConsciousnessFieldUpdate(e)}onConsciousnessFieldUpdate(e){try{this.currentVisualField=e,this.currentConsciousnessField=e;let i=e.pulseRate*.2;this.activityState.shimmer.intensity=Math.min(this.activityState.shimmer.intensity+i,1),this.activityState.audioVisual.nebulaEffectIntensity=Math.min(this.activityState.audioVisual.nebulaEffectIntensity+i*.3,1)}catch(i){u?.debug?.error("UIVisualEffectsController","Error updating from visual effects state:",i)}}onVisualCoordinationEvent(e,i){return this.onChoreographyEvent(e,i)}onChoreographyEvent(e,i){e==="transition:start"&&(this.activityState.shimmer.intensity=Math.min(this.activityState.shimmer.intensity+.2,1),this.activityState.audioVisual.nebulaEffectIntensity=Math.min(this.activityState.audioVisual.nebulaEffectIntensity+.15,1)),this.uiEffectsConfig.debugMode&&u?.debug?.log("UIVisualEffectsController",`Visual coordination event: ${e}`,i)}async healthCheck(){let e=this.activityState,i=this.initialized&&e.performance.healthStatus!=="critical"&&e.diagnostic.criticalIssuesDetected===0;return{healthy:i,ok:i,details:`UI Effects Activity: ${e.activityLevel}, Shimmer: ${e.shimmer.activeElements.size} elements, Interaction: ${e.interaction.nexusState}, Performance: ${e.performance.healthStatus}, Diagnostics: ${e.diagnostic.criticalIssuesDetected} issues`,system:"UIVisualEffectsController"}}updateConfiguration(e){let i={...this.uiEffectsConfig},a=[],r=[];try{for(let[n,s]of Object.entries(e))n in this.uiEffectsConfig?a.push(n):r.push(`Unknown configuration property: ${n}`),n==="shimmerIntensity"&&typeof s=="number"&&(s<0||s>1)&&r.push("shimmerIntensity must be between 0 and 1"),n==="digitalMeditationThreshold"&&typeof s=="number"&&s<1e3&&r.push("digitalMeditationThreshold must be at least 1000ms");return r.length===0&&(Object.assign(this.uiEffectsConfig,e),e.shimmerEnabled!==void 0&&e.shimmerEnabled&&!this.activityState.shimmer.activeElements.size&&this.discoverShimmerElements(),e.diagnosticEnabled!==void 0&&(e.diagnosticEnabled&&!this.diagnosticTimerId?this.startDiagnosticMonitoring():!e.diagnosticEnabled&&this.diagnosticTimerId&&(clearInterval(this.diagnosticTimerId),this.diagnosticTimerId=null)),u?.debug?.log("UIEffectsController","Configuration updated:",e)),{success:r.length===0,updatedProperties:a,validationErrors:r,previousConfig:i,newConfig:{...this.uiEffectsConfig}}}catch(n){let s=n instanceof Error?n.message:"Unknown error during configuration update";return{success:!1,updatedProperties:a,validationErrors:[...r,s],previousConfig:i,newConfig:i}}}getConfiguration(){return{...this.uiEffectsConfig}}getVisualState(){return this.getConsciousnessState()}getConsciousnessState(){return{...this.activityState}}generateDiagnosticReport(){let e=performance.now(),i=performance.memory,a=100,r={whiteLayerProblems:[...this.activityState.diagnostic.whiteLayerIssues],webglContextIssues:[],performanceWarnings:[],configurationErrors:[]},n=[];this.activityState.performance.avgFrameTime>33&&(a-=20,r.performanceWarnings.push(`High frame time: ${this.activityState.performance.avgFrameTime.toFixed(1)}ms`),n.push("Consider reducing visual effect quality or disabling intensive effects")),this.activityState.diagnostic.webglContextHealthy||(a-=30,r.webglContextIssues.push("WebGL context is unhealthy or lost"),n.push("Restart visual effects or check browser WebGL support")),this.uiEffectsConfig.enabled||(r.configurationErrors.push("UI effects are disabled"),n.push("Enable UI effects in settings for full experience")),this.activityState.diagnostic.whiteLayerIssues.length>0&&(a-=15*this.activityState.diagnostic.whiteLayerIssues.length,n.push("Enable auto-fix for white layer issues or check CSS customizations"));let s;return a>=90?s="excellent":a>=70?s="good":a>=50?s="degraded":s="critical",{timestamp:e,systemHealth:s,activeEffects:{shimmer:this.uiEffectsConfig.shimmerEnabled&&this.activityState.shimmer.intensity>0,interaction:this.uiEffectsConfig.interactionTrackingEnabled&&this.activityState.interaction.isActive,audioVisual:this.uiEffectsConfig.audioVisualEnabled&&this.activityState.audioVisual.beatIntensity>0,scroll:this.uiEffectsConfig.scrollEffectsEnabled&&this.activityState.scroll.prismaticEffectActive},performanceMetrics:{averageFrameTime:this.activityState.performance.avgFrameTime,maxFrameTime:this.activityState.performance.maxFrameTime,memoryUsage:i?.usedJSHeapSize||0,cpuUsage:this.activityState.performance.frameTime/16.67},issues:r,recommendations:n}}getShimmerElements(){return new Map(this.shimmerElements)}getInteractionState(){return this.activityState.interaction}getDiagnosticState(){return this.activityState.diagnostic}async destroy(){u?.debug?.log("UIVisualEffectsController","Destroying unified UI effects controller..."),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.diagnosticTimerId&&(clearInterval(this.diagnosticTimerId),this.diagnosticTimerId=null),this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.intersectionObserver=null);for(let e of this.eventUnsubscribeFunctions)e();this.eventUnsubscribeFunctions=[],this.shimmerElements.clear(),this.visualEffectsCoordinator,this.initialized=!1,u?.debug?.log("UIVisualEffectsController","Unified UI effects controller destroyed")}onVisualStateUpdate(e){e.musicIntensity>.6&&this.triggerIntensityEffects(e.musicIntensity),e.colorTemperature&&this.updateTemperatureEffects(e.colorTemperature)}onVisualEffectEvent(e,i){switch(e){case"visual:rhythm-shift":this.triggerShimmerEffects(i.intensity||.5);break;case"visual:color-shift":this.updateTemperatureEffects(i.temperature||6500);break;case"visual:energy-surge":i.intensity>.7&&this.triggerIntensityEffects(i.intensity);break}}getVisualContribution(){let e=[],i=0,a={};return this.uiEffectsConfig.shimmerEnabled&&this.activityState.shimmer.intensity>0&&(a.visualCoherence=this.activityState.activityLevel==="enhanced"?1:.7,a.systemHarmony=this.activityState.shimmer.intensity,e.push("shimmer"),i+=.3),this.uiEffectsConfig.audioVisualEnabled&&this.activityState.audioVisual.nebulaEffectIntensity>0&&(a.effectDepth=this.activityState.audioVisual.nebulaEffectIntensity,a.energyLevel=this.activityState.audioVisual.beatIntensity,e.push("audioVisual"),i+=.4),this.activityState.interaction.isActive&&Math.sqrt(this.activityState.interaction.scrollVelocity.x**2+this.activityState.interaction.scrollVelocity.y**2)>0&&(a.flowDirection={x:this.activityState.interaction.scrollVelocity.x/100,y:this.activityState.interaction.scrollVelocity.y/100},e.push("interaction"),i+=.2),this.activityState.performance.healthStatus!=="critical"&&(e.push("performance"),i+=.1),{contribution:a,confidence:Math.min(1,i),sources:e,timestamp:performance.now()}}triggerIntensityEffects(e){this.uiEffectsConfig.shimmerEnabled&&(this.activityState.shimmer.intensity=Math.min(this.activityState.shimmer.intensity+e*.3,1)),this.uiEffectsConfig.audioVisualEnabled&&(this.activityState.audioVisual.nebulaEffectIntensity=Math.min(this.activityState.audioVisual.nebulaEffectIntensity+e*.2,1)),this.uiEffectsConfig.scrollEffectsEnabled&&(this.activityState.scroll.sheenIntensity=Math.min(this.activityState.scroll.sheenIntensity+e*.1,1))}updateTemperatureEffects(e){let i=Math.max(1e3,Math.min(1e4,e));this.uiEffectsConfig.shimmerEnabled&&(i<3e3?this.activityState.shimmer.effectType="prism":i>7e3?this.activityState.shimmer.effectType="oil-slick":this.activityState.shimmer.effectType="rainbow");let a=(i-1e3)/9e3;this.uiEffectsConfig.audioVisualEnabled&&(this.activityState.audioVisual.nebulaEffectIntensity=Math.min(this.activityState.audioVisual.nebulaEffectIntensity+a*.1,1))}triggerShimmerEffects(e){if(!this.uiEffectsConfig.shimmerEnabled)return;this.activityState.shimmer.intensity=Math.min(this.activityState.shimmer.intensity+e*.4,1);let i=this.activityState.shimmer.effectType;this.activityState.shimmer.effectType="mixed",setTimeout(()=>{this.activityState.shimmer.effectType=i},2e3)}}});var We,Li=y(()=>{"use strict";U();k();ui();bi();G();We=class{constructor(t=M){this.initialized=!1;this.destroyed=!1;this.eventUnsubscribers=[];this.initializationStartTime=null;this.frameStartTime=0;this.frameCount=0;this.lastFPSCalculation=0;this.currentFPS=60;this.config=t,this.systemName=this.constructor.name,this.config.enableDebug&&console.log(`[${this.systemName}] UnifiedSystemBase constructor`)}get cssConsciousnessController(){return this.cssController}set cssConsciousnessController(t){this.cssController=t}async _baseInitialize(){if(this.initialized){this.config.enableDebug&&console.warn(`[${this.systemName}] Already initialized`);return}try{this.initializationStartTime=performance.now(),this.config.enableDebug&&console.log(`[${this.systemName}] Starting unified initialization`);let t=globalThis.year3000System;if(t?(this.performanceAnalyzer=t.performanceAnalyzer||t.facadeCoordinator?.getCachedNonVisualSystem?.("SimplePerformanceCoordinator")||t.facadeCoordinator?.getCachedNonVisualSystem?.("PerformanceAnalyzer"),this.cssController=t.cssController||t.cssConsciousnessController||P(),this.eventBus=p,this.performanceCoordinator=t.performanceCoordinator||(this.performanceAnalyzer?ja.getInstance(this.config,this.performanceAnalyzer):null),this.animationCoordinator=t.enhancedMasterAnimationCoordinator||(this.performanceCoordinator?he.getInstance(this.config,this.performanceCoordinator):null),this.unifiedCSSManager=t.unifiedCSSManager||P()):(this.cssController=P(),this.eventBus=p,this.performanceCoordinator=ja.getInstance(this.config,this.performanceAnalyzer),this.animationCoordinator=he.getInstance(this.config,this.performanceCoordinator),this.unifiedCSSManager=P()),this.unifiedCSSManager&&this.performanceAnalyzer&&this.cssController,this.performanceAnalyzer&&typeof this.performanceAnalyzer.recordMetric=="function"&&this.performanceAnalyzer.recordMetric(`${this.systemName}_registered`,1),await this.trackPerformanceAsync("initialize",async()=>{await this._performSystemSpecificInitialization()}),this.initialized=!0,this.publishEvent("system:initialized",{systemName:this.systemName,timestamp:Date.now(),metadata:{initializationTime:this.initializationStartTime?performance.now()-this.initializationStartTime:0}}),this.config.enableDebug){let e=this.initializationStartTime?performance.now()-this.initializationStartTime:0;console.log(`[${this.systemName}] Unified initialization complete (${e.toFixed(2)}ms)`)}}catch(t){throw console.error(`[${this.systemName}] Initialization failed:`,t),this.publishEvent("system:initialization-failed",{systemName:this.systemName,error:t instanceof Error?t.message:String(t),timestamp:Date.now()}),t}}_baseDestroy(){if(this.destroyed){this.config.enableDebug&&console.warn(`[${this.systemName}] Already destroyed`);return}try{this.config.enableDebug&&console.log(`[${this.systemName}] Starting unified destruction`),this.eventUnsubscribers.forEach(t=>{try{t()}catch(e){console.warn(`[${this.systemName}] Error during event unsubscription:`,e)}}),this.eventUnsubscribers=[],this.performanceAnalyzer&&typeof this.performanceAnalyzer.recordMetric=="function"&&this.performanceAnalyzer.recordMetric(`${this.systemName}_unregistered`,1),this.destroy(),this.destroyed=!0,this.publishEvent("system:destroyed",{systemName:this.systemName,timestamp:Date.now()}),this.config.enableDebug&&console.log(`[${this.systemName}] Unified destruction complete`)}catch(t){console.error(`[${this.systemName}] Destruction failed:`,t)}}updateCSSVariable(t,e,i="normal"){this.unifiedCSSManager?this.unifiedCSSManager.queueUpdate(t,e,i,this.systemName):this.cssController?this.cssController.queueCSSVariableUpdate(t,e):console.warn(`[${this.systemName}] CSS variable management not initialized`)}updateCSSVariables(t,e="normal"){this.unifiedCSSManager?this.unifiedCSSManager.queueTransaction(t,e,this.systemName):this.cssController?Object.entries(t).forEach(([i,a])=>{this.cssController.queueCSSVariableUpdate(i,a)}):console.warn(`[${this.systemName}] CSS variable management not initialized`)}subscribeToEvent(t,e){if(!this.eventBus){console.warn(`[${this.systemName}] Event bus not initialized - attempting to initialize`);try{if(this.eventBus=p,!this.eventBus)return console.error(`[${this.systemName}] Failed to get unified event bus - event subscription deferred`),()=>{}}catch(i){return console.error(`[${this.systemName}] Error accessing unified event bus:`,i),()=>{}}}try{let i=this.eventBus.subscribe(t,e,this.systemName),a=()=>{this.eventBus.unsubscribe(i)};return this.eventUnsubscribers.push(a),a}catch(i){return console.error(`[${this.systemName}] Failed to subscribe to event ${t}:`,i),()=>{}}}publishEvent(t,e){if(!this.eventBus){console.warn(`[${this.systemName}] Event bus not initialized - attempting to initialize`);try{if(this.eventBus=p,!this.eventBus){console.error(`[${this.systemName}] Failed to get unified event bus - event publication skipped`);return}}catch(i){console.error(`[${this.systemName}] Error accessing unified event bus:`,i);return}}try{this.eventBus.emitSync(t,e)}catch(i){console.error(`[${this.systemName}] Failed to publish event ${t}:`,i)}}trackPerformance(t,e){let i=performance.now();try{e()}finally{let r=performance.now()-i;this.trackSystemPerformance(r),this.performanceAnalyzer&&typeof this.performanceAnalyzer.timeOperation=="function"&&this.performanceAnalyzer.recordMetric(`${this.systemName}_${t}`,r)}}async trackPerformanceAsync(t,e){if(!this.performanceAnalyzer||typeof this.performanceAnalyzer.timeOperationAsync!="function"){await e();return}await this.performanceAnalyzer.timeOperationAsync(`${this.systemName}_${t}`,e)}trackSystemPerformance(t){if(!this.performanceCoordinator)return;this.frameCount++;let e=performance.now();e-this.lastFPSCalculation>=1e3&&(this.currentFPS=this.frameCount,this.frameCount=0,this.lastFPSCalculation=e);let i=performance.memory?.usedJSHeapSize||0;this.performanceCoordinator.trackSubsystem(this.systemName,{frameTime:t,memoryUsage:i,fps:this.currentFPS,cpuUsage:t>16.67?Math.min(100,t/16.67*5):0})}registerAnimation(t=60){if(!this.animationCoordinator){console.warn(`[${this.systemName}] Animation coordinator not initialized, attempting lazy initialization`);try{this.animationCoordinator=he.getInstance(this.config,this.performanceCoordinator)}catch(e){console.error(`[${this.systemName}] Failed to initialize animation coordinator:`,e);return}}try{this.animationCoordinator.registerAnimationSystem(this.systemName,this,"normal",t),this.config.enableDebug&&console.log(`[${this.systemName}] Successfully registered with animation coordinator`)}catch(e){console.error(`[${this.systemName}] Failed to register with animation coordinator:`,e)}}forceRepaint(t){this.config.enableDebug&&console.log(`[${this.systemName}] Force repaint: ${t||"unknown"}`),this.unifiedCSSManager&&this.unifiedCSSManager.forceFlush(),document.documentElement.style.transform="translateZ(0)",requestAnimationFrame(()=>{document.documentElement.style.transform=""})}get isInitialized(){return this.initialized}get isDestroyed(){return this.destroyed}get name(){return this.systemName}get systemConfig(){return this.config}registerCSSVariableGroup(t,e="normal"){this.unifiedCSSManager&&this.unifiedCSSManager.registerVariableGroup(`${this.systemName}-${t}`,e)}updateCSSVariableGroup(t,e){this.unifiedCSSManager?this.unifiedCSSManager.updateVariableGroup(`${this.systemName}-${t}`,e,this.systemName):this.updateCSSVariables(e)}updateAnimation(t){this.onAnimate(t)}async _performSystemSpecificInitialization(){}_performSystemSpecificCleanup(){this.destroy()}}});var St,rr=y(()=>{"use strict";Li();U();k();A();St=class extends We{constructor(e){super(e);this.effectsState={energy:.5,valence:.5,tempo:120,harmonyHue:0,intensity:.8,lastUpdateTime:0,animationActive:!0,preferredMotion:!0,frameRate:60,lastFrameTime:0};this.animationFrameId=0;this.updateInterval=0;this.eventDebounceTimers={musicEnergy:0,colorHarmony:0,beatSync:0,cssUpdate:0};this.eventDebounceMs=100;this.frameThrottleMs=16;this.lastCSSUpdateTime=0;this.previousCSSValues={energy:0,valence:0,harmonyHue:0,intensity:0,depth:0};this.cssChangeThreshold=.01}debouncedEventHandler(e,i){let a=performance.now();a-this.eventDebounceTimers[e]>=this.eventDebounceMs&&(i(),this.eventDebounceTimers[e]=a)}hasSignificantCSSChange(){let e=this.effectsState,i=1+e.energy*.5,a={energy:e.energy,valence:e.valence,harmonyHue:e.harmonyHue,intensity:e.intensity,depth:i};for(let[r,n]of Object.entries(a)){let s=this.previousCSSValues[r];if(Math.abs(n-s)>=this.cssChangeThreshold)return!0}return!1}updatePreviousCSSValues(){let e=this.effectsState,i=1+e.energy*.5;this.previousCSSValues.energy=e.energy,this.previousCSSValues.valence=e.valence,this.previousCSSValues.harmonyHue=e.harmonyHue,this.previousCSSValues.intensity=e.intensity,this.previousCSSValues.depth=i}batchApplyCSSUpdates(e,i="normal",a="header-effects"){let r={};for(let[n,s]of e)r[n]=s;this.cssController.batchSetVariables("HeaderVisualEffectsController",r,i,a)}scheduleEffectsUpdate(){this.debouncedEventHandler("cssUpdate",()=>{this.hasSignificantCSSChange()&&(this.updateHeaderEffectsVariables(),this.updatePreviousCSSValues())})}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{let e=globalThis.year3000System;this.cssController=e?.cssVariableController||P(),this.effectsState.preferredMotion=!window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.setupMusicEventListeners(),this.setupColorHarmonyListeners(),this.updateHeaderEffectsVariables(),this.effectsState.preferredMotion&&this.startAnimationLoop(),this.setupPerformanceMonitoring(),u?.debug?.log("HeaderVisualEffectsController","Header visual effects initialization complete")}catch(e){u?.debug?.error("HeaderVisualEffectsController","Initialization failed:",e)}}setupMusicEventListeners(){p.subscribe("music:energy",e=>{this.debouncedEventHandler("musicEnergy",()=>{typeof e.energy=="number"&&(this.effectsState.energy=Math.max(0,Math.min(1,e.energy)),this.scheduleEffectsUpdate()),typeof e.tempo=="number"&&(this.effectsState.tempo=Math.max(60,Math.min(200,e.tempo)),this.updateAnimationSpeed()),typeof e.valence=="number"&&(this.effectsState.valence=Math.max(0,Math.min(1,e.valence)),this.scheduleEffectsUpdate())})},"HeaderVisualEffectsController"),p.subscribe("music:beat",e=>{this.debouncedEventHandler("beatSync",()=>{if(this.effectsState.animationActive){let i=e.intensity||.8;this.onBeatDetected(i)}})},"HeaderVisualEffectsController"),p.subscribe("music:energy-changed",e=>{this.debouncedEventHandler("musicEnergy",()=>{typeof e.energy=="number"&&(this.effectsState.energy=Math.max(0,Math.min(1,e.energy)),this.scheduleEffectsUpdate())})},"HeaderVisualEffectsController")}setupColorHarmonyListeners(){p.subscribe("colors:harmonized",e=>{this.debouncedEventHandler("colorHarmony",()=>{e.coordinationMetrics?.coordinationStrategy&&this.updateHarmonyHue(e.coordinationMetrics.coordinationStrategy)})},"HeaderVisualEffectsController"),p.subscribe("colors:extracted",e=>{this.debouncedEventHandler("colorHarmony",()=>{if(e.musicData&&typeof e.musicData.energy=="number"){let i=e.musicData.energy*360;this.effectsState.harmonyHue=i,this.scheduleEffectsUpdate()}})},"HeaderVisualEffectsController")}updateHarmonyHue(e){let a={monochromatic:0,complementary:180,triadic:120,analogous:30,tetradic:90,"split-complementary":150}[e]||0;this.effectsState.harmonyHue=a,this.scheduleEffectsUpdate()}onBeatDetected(e){let i=Math.min(1,this.effectsState.energy+e*.3);this.batchApplyCSSUpdates([["--header-effects-energy",i.toString()]],"high","beat-sync");let a=performance.now()+150,r=()=>{performance.now()>=a&&this.initialized?this.batchApplyCSSUpdates([["--header-effects-energy",this.effectsState.energy.toString()]],"normal","beat-reset"):this.initialized&&requestAnimationFrame(r)};requestAnimationFrame(r)}updateAnimationSpeed(){let a=8/(this.effectsState.tempo/120);this.batchApplyCSSUpdates([["--header-effects-flow-speed",`${Math.max(2,Math.min(16,a))}s`]],"high","tempo-sync")}updateHeaderEffectsVariables(){if(!this.initialized)return;let e=this.effectsState,i=e.intensity*(.6+e.valence*.4)*(.8+e.energy*.2),a=1+e.energy*.5;this.batchApplyCSSUpdates([["--header-effects-energy",e.energy.toString()],["--header-effects-harmony",`${e.harmonyHue}deg`],["--header-effects-intensity",i.toString()],["--header-effects-depth",a.toString()]],"normal","effects-update"),this.effectsState.lastUpdateTime=Date.now()}startAnimationLoop(){let e=i=>{if(!this.initialized||!this.effectsState.animationActive)return;if(i-this.lastCSSUpdateTime<this.frameThrottleMs){this.animationFrameId=requestAnimationFrame(e);return}let a=i-this.effectsState.lastFrameTime;this.effectsState.frameRate=1e3/a,this.effectsState.lastFrameTime=i,i-this.effectsState.lastUpdateTime>100&&this.hasSignificantCSSChange()&&(this.updateHeaderEffectsVariables(),this.updatePreviousCSSValues()),this.lastCSSUpdateTime=i,this.animationFrameId=requestAnimationFrame(e)};this.animationFrameId=requestAnimationFrame(e)}setupPerformanceMonitoring(){this.updateInterval=window.setInterval(()=>{this.initialized&&(this.effectsState.frameRate<30&&u?.debug?.warn("HeaderVisualEffectsController","Performance degradation detected, reducing update frequency"),this.cssController.setVariable("HeaderVisualEffectsController","--header-effects-performance",this.effectsState.frameRate>50?"1":"0.5","low","performance-monitor"))},2e3)}setEffectsIntensity(e){this.effectsState.intensity=Math.max(0,Math.min(1,e)),this.updateHeaderEffectsVariables()}setAnimationActive(e){this.effectsState.animationActive=e,!e&&this.animationFrameId?(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=0):e&&this.effectsState.preferredMotion&&this.startAnimationLoop()}getEffectsState(){return{...this.effectsState}}async healthCheck(){let e=this.initialized&&this.effectsState.frameRate>20&&Date.now()-this.effectsState.lastUpdateTime<5e3;return{healthy:e,issues:e?[]:[this.effectsState.frameRate<=20?"Low frame rate detected":"",Date.now()-this.effectsState.lastUpdateTime>=5e3?"No recent updates":""].filter(i=>i),metrics:{frameRate:this.effectsState.frameRate,energy:this.effectsState.energy,intensity:this.effectsState.intensity,animationActive:this.effectsState.animationActive,lastUpdate:this.effectsState.lastUpdateTime}}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=0),this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=0),p.unsubscribeAll("HeaderVisualEffectsController"),u?.debug?.log("HeaderVisualEffectsController","Header visual effects system cleaned up")}async initialize(){await this._baseInitialize()}async destroy(){this._performSystemSpecificCleanup()}onAnimate(e){this.effectsState.animationActive&&this.updateHeaderEffectsVariables()}}});var pe,fe,Ae,ki,os=y(()=>{"use strict";Za();Kn();k();A();Qn();is();xi();as();Di();ar();rr();pe={VISUAL_EFFECTS:"--sn-visual-effects-",VISUAL_STATE:"--sn-visual-state-",VISUAL_COORDINATION:"--sn-visual-coordination-",VISUAL_PERFORMANCE:"--sn-visual-performance-"},fe={ENERGY_LEVEL:pe.VISUAL_STATE+"energy-level",FLOW_DIRECTION_X:pe.VISUAL_STATE+"flow-direction-x",FLOW_DIRECTION_Y:pe.VISUAL_STATE+"flow-direction-y",COLOR_TEMPERATURE:pe.VISUAL_STATE+"color-temperature",ADAPTIVE_QUALITY:pe.VISUAL_PERFORMANCE+"adaptive-quality",PARTICIPANT_COUNT:pe.VISUAL_COORDINATION+"participant-count",UPDATE_RATE:pe.VISUAL_PERFORMANCE+"update-rate",PULSE_RATE:pe.VISUAL_EFFECTS+"pulse-rate",TRANSITION_FLUIDITY:pe.VISUAL_EFFECTS+"transition-fluidity",SYSTEM_HARMONY:pe.VISUAL_EFFECTS+"system-harmony"},Ae=class Ae{constructor(t,e,i,a,r){this.initialized=!1;this.cssController=null;this.performanceCoordinator=null;this.musicSyncService=null;this.colorHarmonyEngine=null;this.emotionalGradientMapper=null;this.currentVisualState=null;this.previousVisualState=null;this.fieldUpdateTimer=null;this.lastFieldUpdate=0;this.registeredParticipants=new Map;this.participantContributions=new Map;this.transitionConfig={enabled:!0,transitionDuration:1e3,easingFunction:"smooth",intensityFactor:1,coherenceThreshold:.3};this.isActive=!1;this.updateInterval=16;this.performanceMetrics={stateUpdates:0,coordinationEvents:0,animationTransitions:0,lastUpdate:0,averageUpdateTime:0};this.systemRegistry=new Map;this.systemInstances=new Map;this.systemDependencies=new Map;this.factoryConfig={mode:"progressive",enablePerformanceMonitoring:!0,enableAdaptiveQuality:!0,enableEventCoordination:!0,enableGradientTransitions:!0,performanceThresholds:{minFPS:45,maxMemoryMB:100,thermalThreshold:.7}};this.gradientEffectsState={liquidVisualEffects:!1,directionalFlow:!1,shimmerEffects:!1,depthLayers:!1,performanceOptimization:!0};this.gradientSystems=new Map;this.transitionQueue=[];this.currentBackend="css";this.transitionInProgress=!1;this.backendStabilityCheck=null;this.config=t,this.eventBus=p,this.cssController=e||null,this.performanceCoordinator=i||null,this.musicSyncService=a||null,this.colorHarmonyEngine=r||null,this.cssController&&this.musicSyncService&&(this.emotionalGradientMapper=new gt(this.cssController,this.musicSyncService)),this.initializeFactoryRegistry(),this.initializeGradientSystems(),this.initializeTransitionManagement(),this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator","Enhanced visual effects coordinator created with consolidated functionality")}static getInstance(t,e,i,a,r){if(!Ae.instance){if(!t)throw new Error("VisualEffectsCoordinator requires configuration for first initialization");Ae.instance=new Ae(t,e,i,a,r)}return Ae.instance}async initialize(){if(!this.initialized)try{this.emotionalGradientMapper&&await this.emotionalGradientMapper.initialize(),this.currentVisualState=this.createInitialVisualState(),this.startVisualEffectsUpdates(),this.subscribeToEvents(),this.initialized=!0,this.isActive=!0,this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator","Visual effects coordinator initialized")}catch(t){throw u?.debug?.error("VisualEffectsCoordinator","Failed to initialize:",t),t}}updateAnimation(t){this.performanceMetrics.lastUpdate=performance.now()}async healthCheck(){let t=this.registeredParticipants.size,e=this.currentVisualState?performance.now()-this.currentVisualState.timestamp:0,i=this.isActive&&e<1e3&&t>0;return{system:"VisualEffectsCoordinator",healthy:i,ok:i,details:i?"Visual effects coordination active":"Visual effects state inactive or stale",metrics:{isActive:this.isActive,participantCount:t,fieldAge:e,stateUpdates:this.performanceMetrics.stateUpdates,coordinationEvents:this.performanceMetrics.coordinationEvents,animationTransitions:this.performanceMetrics.animationTransitions,averageUpdateTime:this.performanceMetrics.averageUpdateTime}}}destroy(){this.fieldUpdateTimer&&(clearTimeout(this.fieldUpdateTimer),this.fieldUpdateTimer=null),this.unsubscribeFromEvents(),this.emotionalGradientMapper&&(this.emotionalGradientMapper.destroy(),this.emotionalGradientMapper=null),this.registeredParticipants.clear(),this.participantContributions.clear(),this.currentVisualState=null,this.previousVisualState=null,this.isActive=!1,this.initialized=!1,Ae.instance===this&&(Ae.instance=null),this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator","Visual effects coordinator destroyed")}createInitialVisualState(){let t=this.performanceCoordinator?.getDeviceCapabilities()||{performanceTier:"medium",memoryGB:4,cpuCores:2,gpuAcceleration:!1,isMobile:!1,supportsWebGL:!1,supportsBackdropFilter:!1,maxTextureSize:2048,devicePixelRatio:1},e=this.performanceCoordinator?.getCurrentPerformanceMode()||{name:"balanced",qualityLevel:.7,animationQuality:.7,effectQuality:.7,blurQuality:.7,shadowQuality:.7,frameRate:60,optimizationLevel:1};return{musicIntensity:.5,flowDirection:{x:0,y:0},energyLevel:.5,colorTemperature:6500,tempoModulation:1,harmonicComplexity:.5,fluidIntensity:1,depthPerception:.7,luminosity:t.gpuAcceleration?1.2:.8,colorHarmony:.6,visualCoherence:.8,pulseRate:2,transitionFluidity:.5,scalingFactor:1,effectDepth:.6,systemHarmony:.7,deviceCapabilities:t,performanceMode:e,adaptiveQuality:e.qualityLevel,thermalState:0,batteryConservation:0,timestamp:performance.now(),evolutionPhase:0,continuityIndex:1}}updateVisualEffectsState(){let t=performance.now();if(!this.currentVisualState){this.currentVisualState=this.createInitialVisualState();return}this.previousVisualState={...this.currentVisualState};let e=this.evolveVisualState(this.currentVisualState);this.transitionConfig.enabled?this.currentVisualState=this.applyDynamicTransition(this.currentVisualState,e):this.currentVisualState=e,this.applyStandardizedVisualVariables().catch(r=>{u?.debug?.error("VisualEffectsCoordinator","Failed to apply CSS variables:",r)});let i=this.choreographVisualEffectsUpdate();!i.success&&this.config.enableDebug&&u?.debug?.warn("VisualEffectsCoordinator",`Visual effects update had ${i.errorCount} errors, notified ${i.participantsNotified} participants`);let a=performance.now()-t;this.performanceMetrics.stateUpdates++,this.performanceMetrics.averageUpdateTime=(this.performanceMetrics.averageUpdateTime+a)/2,this.config.enableDebug&&this.performanceMetrics.stateUpdates%60===0&&u?.debug?.log("VisualEffectsCoordinator",`Visual effects state evolved - Update #${this.performanceMetrics.stateUpdates}, avg time: ${this.performanceMetrics.averageUpdateTime.toFixed(2)}ms`)}evolveVisualState(t){let e={...t};return e.timestamp=performance.now(),e.evolutionPhase=Math.min(1,e.evolutionPhase+.001),this.updateFromMusicAnalysis(e),this.integrateParticipantContributions(e),this.applyAnimationTransitions(e),this.updatePerformanceAwareness(e),this.previousVisualState&&(e.continuityIndex=this.calculateContinuityIndex(this.previousVisualState,e)),e}updateFromMusicAnalysis(t){if(this.emotionalGradientMapper){let e=this.emotionalGradientMapper.getCurrentEmotionalProfile();if(e){t.pulseRate=e.energy,t.energyLevel=e.arousal,t.colorTemperature=3e3+e.valence*1e4,t.harmonicComplexity=e.complexity;let i={euphoric:{x:1,y:1},aggressive:{x:-1,y:1},peaceful:{x:0,y:-.5},melancholic:{x:-.5,y:-1},mysterious:{x:.7,y:0},contemplative:{x:0,y:.3}};t.flowDirection=i[e.mood]||{x:0,y:0},t.tempoModulation=.5+e.energy*1.5}}this.musicSyncService}integrateParticipantContributions(t){if(this.participantContributions.size===0)return;let e=0,i=[];for(let[a,r]of this.participantContributions)i.push(r),e+=1;if(e>0)for(let a of i)a.fluidIntensity!==void 0&&(t.fluidIntensity=this.dynamicBlend(t.fluidIntensity,a.fluidIntensity,.1)),a.depthPerception!==void 0&&(t.depthPerception=this.dynamicBlend(t.depthPerception,a.depthPerception,.1)),a.luminosity!==void 0&&(t.luminosity=this.dynamicBlend(t.luminosity,a.luminosity,.1))}applyAnimationTransitions(t){let i=performance.now()/1e3%t.pulseRate/t.pulseRate,a=Math.sin(i*Math.PI*2)*.1;t.scalingFactor+=a,t.transitionFluidity=Math.max(0,Math.min(1,t.transitionFluidity+a*.5)),t.effectDepth=Math.max(0,Math.min(1,t.effectDepth+t.evolutionPhase*.001)),t.systemHarmony=Math.max(0,Math.min(1,(t.visualCoherence+t.continuityIndex)/2))}updatePerformanceAwareness(t){if(this.performanceCoordinator){t.deviceCapabilities=this.performanceCoordinator.getDeviceCapabilities(),t.performanceMode=this.performanceCoordinator.getCurrentPerformanceMode(),t.adaptiveQuality=t.performanceMode.qualityLevel;let e=this.performanceCoordinator.getThermalState(),i=this.performanceCoordinator.getBatteryState();t.thermalState=e.throttleLevel||0,t.batteryConservation=i&&!i.charging?(1-i.level)*.5:0}}calculateContinuityIndex(t,e){let i=[Math.abs(t.pulseRate-e.pulseRate),Math.abs(t.energyLevel-e.energyLevel),Math.abs(t.fluidIntensity-e.fluidIntensity),Math.abs(t.depthPerception-e.depthPerception),Math.abs(t.luminosity-e.luminosity)],a=i.reduce((r,n)=>r+n,0)/i.length;return Math.max(0,Math.min(1,1-a))}applyDynamicTransition(t,e){let i=this.calculateDynamicTransitionSpeed(t,e),a=this.applyDynamicEasing(i);return this.blendVisualStates(t,e,a)}applySmoothTransition(t,e){return this.applyDynamicTransition(t,e)}calculateDynamicTransitionSpeed(t,e){let i=.016666666666666666,a=1+Math.sin(performance.now()/1e3/t.pulseRate*Math.PI*2)*.2,r=.5+t.energyLevel*1.5;return i*a*r*this.transitionConfig.intensityFactor}calculateSmoothTransitionSpeed(t,e){return this.calculateDynamicTransitionSpeed(t,e)}applyDynamicEasing(t){switch(this.transitionConfig.easingFunction){case"smooth":return t*t*(3-2*t);case"harmonic":return(Math.sin((t-.5)*Math.PI)+1)/2;case"exponential":return t*t;case"cubic":return t*t*t;default:return t}}applySmoothEasing(t){return this.applyDynamicEasing(t)}blendVisualStates(t,e,i){let a={...t};return a.pulseRate=this.dynamicBlend(t.pulseRate,e.pulseRate,i),a.energyLevel=this.dynamicBlend(t.energyLevel,e.energyLevel,i),a.colorTemperature=this.dynamicBlend(t.colorTemperature,e.colorTemperature,i),a.fluidIntensity=this.dynamicBlend(t.fluidIntensity,e.fluidIntensity,i),a.depthPerception=this.dynamicBlend(t.depthPerception,e.depthPerception,i),a.luminosity=this.dynamicBlend(t.luminosity,e.luminosity,i),a.colorHarmony=this.dynamicBlend(t.colorHarmony,e.colorHarmony,i),a.visualCoherence=this.dynamicBlend(t.visualCoherence,e.visualCoherence,i),a.transitionFluidity=this.dynamicBlend(t.transitionFluidity,e.transitionFluidity,i),a.scalingFactor=this.dynamicBlend(t.scalingFactor,e.scalingFactor,i),a.effectDepth=this.dynamicBlend(t.effectDepth,e.effectDepth,i),a.systemHarmony=this.dynamicBlend(t.systemHarmony,e.systemHarmony,i),a.tempoModulation=this.dynamicBlend(t.tempoModulation,e.tempoModulation,i),a.harmonicComplexity=this.dynamicBlend(t.harmonicComplexity,e.harmonicComplexity,i),a.adaptiveQuality=this.dynamicBlend(t.adaptiveQuality,e.adaptiveQuality,i),a.flowDirection={x:this.dynamicBlend(t.flowDirection.x,e.flowDirection.x,i),y:this.dynamicBlend(t.flowDirection.y,e.flowDirection.y,i)},a.timestamp=performance.now(),a.continuityIndex=t.continuityIndex,a}dynamicBlend(t,e,i){return t+(e-t)*i}smoothBlend(t,e,i){return this.dynamicBlend(t,e,i)}registerVisualEffectsParticipant(t){try{if(this.registeredParticipants.has(t.systemName))return{success:!1,participantName:t.systemName,contributionReceived:!1,errorMessage:`Participant '${t.systemName}' is already registered`};this.registeredParticipants.set(t.systemName,t);let e=!1;try{let i=t.getVisualContribution();this.participantContributions.set(t.systemName,i),e=!0}catch(i){u?.debug?.warn("VisualEffectsCoordinator",`Failed to get initial contribution from ${t.systemName}:`,i)}return this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Registered participant: ${t.systemName}`),{success:!0,participantName:t.systemName,contributionReceived:e}}catch(e){let i=e instanceof Error?e.message:"Unknown registration error";return u?.debug?.error("VisualEffectsCoordinator",`Failed to register participant ${t.systemName}:`,e),{success:!1,participantName:t.systemName,contributionReceived:!1,errorMessage:i}}}unregisterVisualEffectsParticipant(t){this.registeredParticipants.delete(t),this.participantContributions.delete(t),this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Unregistered participant: ${t}`)}updateParticipantContribution(t,e){this.registeredParticipants.has(t)&&this.participantContributions.set(t,e)}choreographVisualEffectsUpdate(){let t=performance.now(),e=0,i=0;if(!this.currentVisualState)return{success:!1,participantsNotified:0,updateDuration:0,continuityIndex:0,errorCount:1};try{this.eventBus.emit("visual-effects:field-updated",{rhythmicPulse:this.currentVisualState.pulseRate,musicalFlow:this.currentVisualState.flowDirection,energyResonance:this.currentVisualState.energyLevel,depthPerception:this.currentVisualState.depthPerception,pulsingCycle:this.currentVisualState.pulseRate})}catch(r){u?.debug?.error("VisualEffectsCoordinator","Error broadcasting visual effects state update:",r),i++}for(let r of this.registeredParticipants.values())try{r.onVisualStateUpdate(this.currentVisualState),e++}catch(n){u?.debug?.error("VisualEffectsCoordinator",`Error updating participant ${r.systemName}:`,n),i++}this.performanceMetrics.coordinationEvents++;let a=performance.now()-t;return{success:i===0,participantsNotified:e,updateDuration:a,continuityIndex:this.currentVisualState.continuityIndex,errorCount:i}}choreographEvent(t,e){if(t&&typeof t=="string")try{let i=this.mapChoreographyEventToUnified(t);i&&this.eventBus.emit(i.eventName,i.payload)}catch{this.eventBus.emit(`visual-effects:${t}`,e)}for(let i of this.registeredParticipants.values())try{t.startsWith("visual:")?i.onVisualEffectEvent(t,e):i.onVisualEffectEvent("visual:coordination",{...e,originalEventType:t})}catch(a){u?.debug?.error("VisualEffectsCoordinator",`Error sending choreography event to ${i.systemName}:`,a)}this.performanceMetrics.coordinationEvents++,this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Choreographed event: ${t}`,e)}startVisualEffectsUpdates(){if(this.fieldUpdateTimer)return;let t=()=>{this.isActive&&(this.updateVisualEffectsState(),this.fieldUpdateTimer=setTimeout(t,this.updateInterval))};t(),this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Started visual effects state updates (${this.updateInterval}ms interval)`)}subscribeToEvents(){this.musicSyncService&&(this.eventBus.subscribe("music:track-changed",t=>{this.choreographEvent("rhythm-shift",{newTrack:t,transitionType:"smooth"})},"VisualEffectsCoordinator"),this.eventBus.subscribe("music:emotion-analyzed",t=>{this.choreographEvent("intensity-peak",{intensity:t?.energy||.5,affectedSystems:["all"],surgeType:"full-spectrum",duration:1e3,falloffCurve:"smooth"})},"VisualEffectsCoordinator")),this.performanceCoordinator&&this.eventBus.subscribe("performance:tier-changed",t=>{this.choreographEvent("genre-transition",{newMode:t||{name:"auto",qualityLevel:.8,frameRate:60,optimizationLevel:.5},adaptationType:"smooth",reason:"automatic",affectedSystems:["all"]})},"VisualEffectsCoordinator"),this.eventBus.subscribe("settings:visual-guide-changed",t=>{(t?.key?.includes("visual-effects")||t?.key?.includes("choreography"))&&this.updateDynamicTransitionConfig(t)},"VisualEffectsCoordinator")}unsubscribeFromEvents(){}mapChoreographyEventToUnified(t){switch(t){case"rhythm-shift":return{eventName:"visual-effects:coordination",payload:{source:"choreographer",type:"rhythm-shift"}};case"intensity-peak":return{eventName:"visual-effects:intensity-changed",payload:{intensity:.8,userEngagement:.6,timestamp:Date.now()}};case"genre-transition":return{eventName:"visual-effects:coordination",payload:{source:"choreographer",type:"genre-transition"}};case"emotional-shift":return{eventName:"visual-effects:coordination",payload:{source:"choreographer",type:"emotional-shift"}};default:return{eventName:"visual-effects:coordination",payload:{source:"choreographer",type:t}}}}updateDynamicTransitionConfig(t){let{key:e,value:i}=t;if(e.includes("transition-intensity"))this.transitionConfig.intensityFactor=Math.max(0,Math.min(2,parseFloat(i)||1));else if(e.includes("transition-duration"))this.transitionConfig.transitionDuration=Math.max(100,Math.min(5e3,parseInt(i)||1e3));else if(e.includes("animation-cycle")){let a=Math.max(.5,Math.min(4,parseFloat(i)||2));this.currentVisualState&&(this.currentVisualState.pulseRate=a)}this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Updated dynamic transition config: ${e} = ${i}`)}updateSmoothTransitionConfig(t){return this.updateDynamicTransitionConfig(t)}async applyStandardizedVisualVariables(t){if(!this.currentVisualState)return;let e=t||document.documentElement,i=this.currentVisualState,a={[fe.ENERGY_LEVEL]:i.energyLevel.toFixed(3),[fe.FLOW_DIRECTION_X]:i.flowDirection.x.toFixed(3),[fe.FLOW_DIRECTION_Y]:i.flowDirection.y.toFixed(3),[fe.COLOR_TEMPERATURE]:i.colorTemperature.toString(),[fe.ADAPTIVE_QUALITY]:i.adaptiveQuality.toFixed(3),[fe.PARTICIPANT_COUNT]:this.registeredParticipants.size.toString(),[fe.UPDATE_RATE]:(1e3/this.updateInterval).toString(),[fe.PULSE_RATE]:i.pulseRate.toFixed(3),[fe.TRANSITION_FLUIDITY]:i.transitionFluidity.toFixed(3),[fe.SYSTEM_HARMONY]:i.systemHarmony.toFixed(3)};if(this.cssController)for(let[r,n]of Object.entries(a))await this.cssController.setVariable("VisualEffectsCoordinator",r,n,"normal","standardized-vars");else for(let[r,n]of Object.entries(a))e.style.setProperty(r,n);this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Applied ${Object.keys(a).length} standardized visual effect CSS variables`)}getCurrentVisualEffectsState(){return this.currentVisualState?{...this.currentVisualState}:null}getRegisteredParticipants(){return Array.from(this.registeredParticipants.keys())}updateDynamicTransitionConfiguration(t){this.transitionConfig={...this.transitionConfig,...t},this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator","Updated dynamic transition configuration:",t)}updateSmoothTransitionConfiguration(t){return this.updateDynamicTransitionConfiguration(t)}forceVisualEffectsStateUpdate(){this.updateVisualEffectsState()}getPerformanceMetrics(){return{...this.performanceMetrics}}initializeFactoryRegistry(){this.systemRegistry.set("SidebarVisualEffects",$e),this.systemDependencies.set("SidebarVisualEffects",["eventBus","musicSyncService"]),this.systemRegistry.set("UIVisualEffects",bt),this.systemDependencies.set("UIVisualEffects",["eventBus","musicSyncService","cssVariableController"]),this.systemRegistry.set("HeaderVisualEffects",St),this.systemDependencies.set("HeaderVisualEffects",["eventBus","musicSyncService","colorHarmonyEngine"]),this.systemRegistry.set("WebGLBackground",xe),this.systemDependencies.set("WebGLBackground",["performanceAnalyzer","eventBus"]),this.systemRegistry.set("FluidGradient",Ai),this.systemDependencies.set("FluidGradient",["performanceAnalyzer","musicSyncService","cssVariableController"]),this.systemRegistry.set("DepthLayers",Pi),this.systemDependencies.set("DepthLayers",["performanceAnalyzer","musicSyncService","cssVariableController"]),this.systemRegistry.set("IridescentShimmer",Ii),this.systemDependencies.set("IridescentShimmer",["performanceAnalyzer","musicSyncService","cssVariableController"]),this.systemRegistry.set("DirectionalFlow",Ti),this.systemDependencies.set("DirectionalFlow",["performanceAnalyzer","musicSyncService","cssVariableController"])}initializeGradientSystems(){this.gradientEffectsState={liquidVisualEffects:!1,directionalFlow:!1,shimmerEffects:!1,depthLayers:!1,performanceOptimization:!0}}initializeTransitionManagement(){this.currentBackend="css",this.transitionInProgress=!1,this.transitionQueue=[]}async createVisualSystem(t,e=!1){try{let i=t;if(!e&&this.systemInstances.has(i))return this.systemInstances.get(i)||null;let a=this.systemRegistry.get(t);if(!a)return console.warn(`Visual system '${t}' not found in registry`),null;let r=this.resolveDependencies(i),n=new a(...r);return n.initialize&&await n.initialize(),this.systemInstances.set(i,n),this.config.enableDebug&&u?.debug?.log("VisualSystemFactory",`Created visual system: ${t}`),n}catch(i){return console.error(`Failed to create visual system '${t}':`,i),null}}async orchestrateGradientEffects(t){try{if(this.gradientEffectsState={...this.gradientEffectsState,...t},t.liquidVisualEffects){let e=await this.createVisualSystem("FluidGradient");e&&this.gradientSystems.set("FluidGradient",e)}if(t.depthLayers){let e=await this.createVisualSystem("DepthLayers");e&&this.gradientSystems.set("DepthLayers",e)}if(t.shimmerEffects){let e=await this.createVisualSystem("IridescentShimmer");e&&this.gradientSystems.set("IridescentShimmer",e)}if(t.directionalFlow){let e=await this.createVisualSystem("DirectionalFlow");e&&this.gradientSystems.set("DirectionalFlow",e)}this.config.enableDebug&&u?.debug?.log("GradientOrchestration","Gradient effects orchestrated",this.gradientEffectsState)}catch(e){console.error("Failed to orchestrate gradient effects:",e)}}async coordinateBackendTransition(t,e={}){if(!(this.transitionInProgress||this.currentBackend===t))try{this.transitionInProgress=!0;let i={mode:e.mode||"crossfade",duration:e.duration||1e3,easing:e.easing||"ease-in-out",preserveState:e.preserveState??!0,fallbackDelay:e.fallbackDelay||5e3};this.transitionQueue.push({from:this.currentBackend,to:t,config:i,startTime:Date.now()}),t==="webgl"?await this.transitionToWebGL(i):t==="css"?await this.transitionToCSS(i):t==="hybrid"&&await this.transitionToHybrid(i),this.currentBackend=t,this.transitionInProgress=!1,this.config.enableDebug&&u?.debug?.log("TransitionCoordination",`Transitioned to ${t} backend`)}catch(i){console.error("Backend transition failed:",i),this.transitionInProgress=!1}}async getConsolidatedHealthCheck(){let t=new Map;for(let[r,n]of this.systemInstances)try{let s=n.healthCheck?await n.healthCheck():{healthy:!0,details:"No health check method"};t.set(r,{ok:s.healthy,details:s.details||"OK"})}catch(s){t.set(r,{ok:!1,details:`Health check failed: ${s}`})}for(let[r,n]of this.gradientSystems)try{let s=n.healthCheck?await n.healthCheck():{healthy:!0,details:"No health check method"};t.set(`gradient-${r}`,{ok:s.healthy,details:s.details||"OK"})}catch(s){t.set(`gradient-${r}`,{ok:!1,details:`Health check failed: ${s}`})}let e=Array.from(t.values()).filter(r=>!r.ok),i=e.length===0?"excellent":e.length<=2?"good":e.length<=5?"degraded":"critical",a=[];return e.length>0&&a.push(`${e.length} systems require attention`),this.transitionQueue.length>3&&a.push("High transition queue - consider reducing visual complexity"),{overall:i,systems:t,gradientEffects:this.gradientEffectsState,transitions:{activeTransitions:this.transitionQueue.length,backendStability:!this.transitionInProgress},recommendations:a,timestamp:Date.now()}}resolveDependencies(t){let e=this.systemDependencies.get(t)||[],i=[];for(let a of e)switch(a){case"eventBus":i.push(this.eventBus);break;case"musicSyncService":i.push(this.musicSyncService);break;case"cssVariableController":i.push(this.cssController);break;case"colorHarmonyEngine":i.push(this.colorHarmonyEngine);break;case"performanceAnalyzer":i.push(this.performanceCoordinator);break;default:i.push(null)}return i}async transitionToWebGL(t){let e=await this.createVisualSystem("WebGLBackground");e&&e.initialize&&await e.initialize()}async transitionToCSS(t){let e=await this.createVisualSystem("FluidGradient");e&&e.initialize&&await e.initialize()}async transitionToHybrid(t){await Promise.all([this.transitionToCSS(t),this.transitionToWebGL(t)])}registerConsciousnessParticipant(t){return this.registerVisualEffectsParticipant(t)}unregisterConsciousnessParticipant(t){this.unregisterVisualEffectsParticipant(t)}getCurrentConsciousnessField(){return this.getCurrentVisualEffectsState()}forceConsciousnessFieldUpdate(){this.forceVisualEffectsStateUpdate()}registerBackgroundSystemParticipant(t){return this.registerVisualEffectsParticipant(t)}unregisterBackgroundSystemParticipant(t){this.unregisterVisualEffectsParticipant(t)}getCurrentBackgroundState(){return this.getCurrentVisualEffectsState()}choreographBackgroundEvent(t,e){return this.choreographEvent(t,e)}};Ae.instance=null;ki=Ae});var Ri,ls=y(()=>{"use strict";pi();G();A();Me();ie();Ri=class{constructor(t=M.enableDebug){this.coordinationCache=new Map;this.cacheMaxSize=20;this.cacheTimeoutMs=3e5;this.enableDebug=t,this.oklabProcessor=new E(t),this.emotionalMapper=new J(t),this.genreManager=new _e({ADVANCED_SYSTEM_CONFIG:M}),this.enableDebug&&u?.debug?.log("MusicalOKLABProcessor","Unified music-to-OKLAB coordinator initialized")}async processMusicalColors(t,e={}){let i=performance.now(),a=this.generateCacheKey(t),r=this.coordinationCache.get(a);if(r)return this.enableDebug&&u?.debug?.log("MusicalOKLABProcessor","Using cached processing result",{cacheKey:a}),r;try{let n=this.determineProcessingStrategy(t,e),s=await this.getOptimalOKLABPreset(t,n,e),o=await this.processColorsWithMusicalContext(t.rawColors,t.musicData,s),c=this.emotionalMapper.mapMusicToEmotionalTemperature(t.musicData),m=this.genreManager.detectGenre(t.musicData),d=this.genreManager.getColorCharacteristicsForGenre(m),h=this.calculateMusicInfluenceStrength(t.musicData,c),g=this.generateUnifiedCSSVariables(o,c,d,s),{accentHex:f,accentRgb:v}=this.selectOptimalAccentColor(o),C=performance.now()-i,T={enhancedColors:Object.fromEntries(Object.entries(o).map(([w,V])=>[w,V.enhancedHex])),accentHex:f,accentRgb:v,oklabPreset:s,oklabResults:o,detectedGenre:m,emotionalResult:c,genreCharacteristics:d,processingTime:C,musicInfluenceStrength:h,processingStrategy:n,cssVariables:g};return this.cacheResult(a,T),this.enableDebug&&u?.debug?.log("MusicalOKLABProcessor","Musical OKLAB processing completed",{genre:m,emotion:c.primaryEmotion,strategy:n,preset:s.name,processingTime:C,colorCount:Object.keys(o).length}),T}catch(n){return this.enableDebug&&u?.debug?.error("MusicalOKLABProcessor","Musical processing failed:",n),this.createFallbackResult(t,performance.now()-i)}}determineProcessingStrategy(t,e){let{musicData:i}=t;if(!i||typeof i.energy!="number"||typeof i.valence!="number")return"fallback";if(e.preferGenreOverEmotion===!0)return"genre-primary";if(e.preferGenreOverEmotion===!1)return"emotion-primary";let a=Math.abs(i.energy-.5)*2,r=Math.abs(i.valence-.5)*2;return(a+r)/2>.6?"emotion-primary":this.genreManager.detectGenre(i)!=="default"?"genre-primary":"balanced"}async getOptimalOKLABPreset(t,e,i){let{musicData:a}=t;try{let r;switch(e){case"genre-primary":r=this.genreManager.getOKLABPresetForTrack(a);break;case"emotion-primary":r=this.emotionalMapper.mapMusicToEmotionalTemperature(a).oklabPreset;break;case"balanced":let s=this.genreManager.getOKLABPresetForTrack(a),o=this.emotionalMapper.mapMusicToEmotionalTemperature(a);r=this.processBlendedPresets(s,o.oklabPreset,i.intensityMultiplier||1);break;default:r=E.getPreset("STANDARD")}return r}catch(r){return this.enableDebug&&u?.debug?.warn("MusicalOKLABProcessor","Failed to get optimal preset, using STANDARD:",r),E.getPreset("STANDARD")}}processBlendedPresets(t,e,i){let a=(t.chromaBoost+e.chromaBoost)/2*i,r=(t.lightnessBoost+e.lightnessBoost)/2,n=(t.shadowReduction+e.shadowReduction)/2,s=(t.vibrantThreshold+e.vibrantThreshold)/2;return E.createCustomPreset("blended-genre-emotion",`Blended ${t.name} + ${e.name}`,r,a,n,s)}async processColorsWithMusicalContext(t,e,i){let a={};for(let[r,n]of Object.entries(t))if(!(!n||typeof n!="string"||!n.startsWith("#")))try{let s=this.oklabProcessor.processColor(n,i);a[r]=s}catch(s){this.enableDebug&&u?.debug?.warn("MusicalOKLABProcessor",`Failed to process color ${r}:`,s)}return a}calculateMusicInfluenceStrength(t,e){let i=t.energy||.5,a=Math.abs((t.valence||.5)-.5)*2,r=e.intensity,n=(i+a+r)/3,s=1;return t.tempo&&t.tempo>0&&(s+=.1),t.danceability&&t.danceability>.7&&(s+=.1),t.genre&&t.genre!=="default"&&(s+=.1),Math.min(1,n*s)}generateUnifiedCSSVariables(t,e,i,a){let r={};return Object.entries(t).forEach(([n,s])=>{r[`--sn-${n.toLowerCase()}-enhanced`]=s.enhancedHex,r[`--sn-${n.toLowerCase()}-oklab-l`]=s.oklabEnhanced.L.toFixed(3),r[`--sn-${n.toLowerCase()}-oklab-a`]=s.oklabEnhanced.a.toFixed(3),r[`--sn-${n.toLowerCase()}-oklab-b`]=s.oklabEnhanced.b.toFixed(3),r[`--sn-${n.toLowerCase()}-oklch-c`]=s.oklchEnhanced.C.toFixed(3),r[`--sn-${n.toLowerCase()}-oklch-h`]=s.oklchEnhanced.H.toFixed(1),r[`--sn-${n.toLowerCase()}-shadow`]=s.shadowHex}),Object.entries(e.cssVariables).forEach(([n,s])=>{r[n]=s}),r["--sn-detected-genre"]=i?i.vibrancyLevel:"standard",r["--sn-color-temperature"]=i?i.colorTemperature:"neutral",r["--sn-emotional-range"]=i?i.emotionalRange:"moderate",r["--sn-oklab-preset-name"]=a.name,r["--sn-oklab-chroma-boost"]=a.chromaBoost.toString(),r["--sn-oklab-lightness-boost"]=a.lightnessBoost.toString(),r["--sn-musical-oklab-processing"]="enabled",r["--sn-color-processing-mode"]="unified-musical-oklab",r}selectOptimalAccentColor(t){let e=["VIBRANT","PROMINENT","DARK_VIBRANT","LIGHT_VIBRANT"];for(let a of e)if(t[a]){let r=t[a];return{accentHex:r.enhancedHex,accentRgb:`${r.enhancedRgb.r},${r.enhancedRgb.g},${r.enhancedRgb.b}`}}let i=Object.values(t)[0];return i?{accentHex:i.enhancedHex,accentRgb:`${i.enhancedRgb.r},${i.enhancedRgb.g},${i.enhancedRgb.b}`}:{accentHex:"#cba6f7",accentRgb:"203,166,247"}}createFallbackResult(t,e){let i=E.getPreset("STANDARD");return{enhancedColors:t.rawColors,accentHex:"#cba6f7",accentRgb:"203,166,247",oklabPreset:i,oklabResults:{},detectedGenre:"default",emotionalResult:{primaryEmotion:"calm",intensity:.5,temperature:3500,blendRatio:1,cssClass:"smooth-emotion-calm",cssVariables:{},oklabPreset:i},genreCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"},processingTime:e,musicInfluenceStrength:.5,processingStrategy:"fallback",cssVariables:{"--sn-musical-oklab-processing":"fallback","--sn-oklab-preset-name":"STANDARD"}}}generateCacheKey(t){return`${t.trackUri}-${t.timestamp}-${JSON.stringify(t.musicData)}`}cacheResult(t,e){if(this.coordinationCache.size>=this.cacheMaxSize){let i=this.coordinationCache.keys().next().value;i&&this.coordinationCache.delete(i)}this.coordinationCache.set(t,e),setTimeout(()=>{this.coordinationCache.delete(t)},this.cacheTimeoutMs)}convertToColorResult(t,e){return{processedColors:{...t.enhancedColors,...t.cssVariables},accentHex:t.accentHex,accentRgb:t.accentRgb,metadata:{strategy:"musical-oklab-processor",processingTime:t.processingTime,detectedGenre:t.detectedGenre,emotionalState:t.emotionalResult.primaryEmotion,oklabPreset:t.oklabPreset.name,processingStrategy:t.processingStrategy,musicInfluenceStrength:t.musicInfluenceStrength},context:{rawColors:e.rawColors,trackUri:e.trackUri,timestamp:e.timestamp,harmonicMode:e.harmonicMode||"musical-oklab-processing",musicData:e.musicData}}}clearProcessingCache(){this.coordinationCache.clear(),this.enableDebug&&u?.debug?.log("MusicalOKLABProcessor","Processing cache cleared")}getProcessingMetrics(){return{cacheSize:this.coordinationCache.size,maxCacheSize:this.cacheMaxSize,cacheTimeoutMs:this.cacheTimeoutMs,enableDebug:this.enableDebug}}}});var Vi,cs=y(()=>{"use strict";A();Vi=class{constructor(){this.strategiesMap=new Map;this.metrics={totalStrategies:0,healthyStrategies:0,averageResponseTime:0,totalUsageCount:0,cacheHitRate:0,memoryUsage:0};this.healthCheckInterval=null;this.HEALTH_CHECK_INTERVAL_MS=3e4;this.startHealthMonitoring(),u?.debug?.log("BackgroundStrategyRegistry","Strategy registry initialized")}register(t){let e=t.getStrategyName();this.strategiesMap.has(e)&&u?.debug?.warn("BackgroundStrategyRegistry",`Strategy ${e} is already registered, replacing...`);try{let i={strategy:t,registrationTime:Date.now(),lastUsed:0,usageCount:0,errorCount:0,averageProcessingTime:0,isHealthy:!0,metadata:this.inferStrategyMetadata(t)};this.strategiesMap.set(e,i),this.updateMetrics(),u?.debug?.log("BackgroundStrategyRegistry",`Registered strategy: ${e}`,{category:i.metadata.category,priority:i.metadata.priority,memoryImpact:i.metadata.memoryImpact})}catch(i){u?.debug?.error("BackgroundStrategyRegistry",`Failed to register strategy ${e}:`,i)}}selectStrategy(t){let e=Array.from(this.strategiesMap.values()).filter(a=>a.isHealthy).sort((a,r)=>this.scoreStrategy(r,t)-this.scoreStrategy(a,t));if(e.length===0)return u?.debug?.warn("BackgroundStrategyRegistry","No healthy strategies available"),null;let i=e[0];return i?(this.recordStrategyUsage(i.strategy.getStrategyName()),u?.debug?.log("BackgroundStrategyRegistry",`Selected strategy: ${i.strategy.getStrategyName()}`,{score:this.scoreStrategy(i,t),totalAvailable:e.length}),i.strategy):(u?.debug?.warn("BackgroundStrategyRegistry","No strategies available after filtering"),null)}getStrategies(){return Array.from(this.strategiesMap.values()).filter(t=>t.isHealthy).map(t=>t.strategy)}getStrategy(t){let e=this.strategiesMap.get(t);return e&&e.isHealthy?e.strategy:null}selectMultipleStrategies(t,e=4){let i=Array.from(this.strategiesMap.values()).filter(r=>r.isHealthy).map(r=>({registration:r,score:this.scoreStrategy(r,t)})).sort((r,n)=>n.score-r.score).slice(0,e);i.forEach(r=>{this.recordStrategyUsage(r.registration.strategy.getStrategyName())});let a=i.map(r=>r.registration.strategy);return u?.debug?.log("BackgroundStrategyRegistry",`Selected ${a.length} strategies`,{strategies:a.map(r=>r.getStrategyName()),scores:i.map(r=>r.score)}),a}scoreStrategy(t,e){let i=0;switch(i+=t.metadata.priority*10,e.performance){case"high":t.metadata.memoryImpact==="low"&&(i+=20),t.averageProcessingTime<10&&(i+=15);break;case"medium":t.metadata.memoryImpact!=="high"&&(i+=10),t.averageProcessingTime<20&&(i+=10);break;case"low":break}switch(e.quality){case"premium":t.metadata.category==="enhancement"&&(i+=15),t.metadata.tags.includes("webgl")&&(i+=10);break;case"enhanced":t.metadata.category!=="effects"&&(i+=10);break;case"basic":t.metadata.category==="foundation"&&(i+=15);break}if(e.deviceCapabilities&&(e.deviceCapabilities.hasWebGL&&t.metadata.tags.includes("webgl")&&(i+=15),e.deviceCapabilities.isMobile&&t.metadata.memoryImpact==="low"&&(i+=10),e.deviceCapabilities.memoryMB&&e.deviceCapabilities.memoryMB<4e3&&t.metadata.memoryImpact==="high"&&(i-=20)),e.userPreferences&&(e.userPreferences.enableAdvancedBlending&&t.metadata.tags.includes("advanced-blending")&&(i+=12),e.userPreferences.harmonicMode)){let n=e.userPreferences.harmonicMode;t.metadata.tags.includes(n)&&(i+=8)}let a=t.usageCount>0?t.errorCount/t.usageCount:0;return i-=a*30,Date.now()-t.lastUsed<3e5&&(i+=5),Math.max(0,i)}inferStrategyMetadata(t){let e=t.getStrategyName(),i=[],a="enhancement",r=5,n="medium",s=[];switch(e){case"dynamic-catppuccin":a="accent",r=10,n="low",i.push("catppuccin","dynamic","accent","spicetify");break;case"living-gradient":a="foundation",r=8,n="low",i.push("gradient","pulsing","foundation","css");break;case"webgl-gradient":a="enhancement",r=6,n="high",s.push("webgl"),i.push("webgl","gradient","performance","advanced-blending");break;case"depth-layered":a="effects",r=7,n="medium",i.push("depth","layers","parallax","visual-effects","cosmic","cinematic");break;default:break}return{category:a,priority:r,memoryImpact:n,deviceRequirements:s,tags:i}}recordStrategyUsage(t){let e=this.strategiesMap.get(t);e&&(e.usageCount++,e.lastUsed=Date.now())}recordStrategyError(t,e){let i=this.strategiesMap.get(t);if(i){i.errorCount++;let a=i.errorCount/Math.max(1,i.usageCount);a>.5&&i.usageCount>5&&(i.isHealthy=!1,u?.debug?.warn("BackgroundStrategyRegistry",`Strategy ${t} marked as unhealthy`,{errorRate:a,errorCount:i.errorCount,usageCount:i.usageCount}))}}recordStrategyProcessingTime(t,e){let i=this.strategiesMap.get(t);if(i){let a=i.averageProcessingTime*(i.usageCount-1)+e;i.averageProcessingTime=a/i.usageCount}}startHealthMonitoring(){this.healthCheckInterval=window.setInterval(()=>{this.performHealthChecks()},this.HEALTH_CHECK_INTERVAL_MS)}async performHealthChecks(){try{for(let[t,e]of this.strategiesMap.entries())try{if("healthCheck"in e.strategy&&typeof e.strategy.healthCheck=="function"){let i=await e.strategy.healthCheck();e.isHealthy=i?.healthy??!0,e.isHealthy||u?.debug?.warn("BackgroundStrategyRegistry",`Strategy ${t} failed health check:`,i)}}catch(i){e.isHealthy=!1,u?.debug?.error("BackgroundStrategyRegistry",`Health check failed for strategy ${t}:`,i)}this.updateMetrics()}catch(t){u?.debug?.error("BackgroundStrategyRegistry","Health check monitoring failed:",t)}}updateMetrics(){let t=Array.from(this.strategiesMap.values());this.metrics.totalStrategies=t.length,this.metrics.healthyStrategies=t.filter(i=>i.isHealthy).length,this.metrics.totalUsageCount=t.reduce((i,a)=>i+a.usageCount,0);let e=t.filter(i=>i.averageProcessingTime>0).map(i=>i.averageProcessingTime);e.length>0&&(this.metrics.averageResponseTime=e.reduce((i,a)=>i+a,0)/e.length),this.metrics.memoryUsage=t.reduce((i,a)=>{let r=a.metadata.memoryImpact==="high"?3:a.metadata.memoryImpact==="medium"?2:1;return i+r},0)}getRegistryMetrics(){return{...this.metrics}}getStrategyInfo(t){let e=this.strategiesMap.get(t);return e?{...e}:null}getAllStrategyInfo(){return Array.from(this.strategiesMap.entries()).map(([t,e])=>({name:t,registration:{...e}}))}unregister(t){let e=this.strategiesMap.delete(t);return e&&(this.updateMetrics(),u?.debug?.log("BackgroundStrategyRegistry",`Unregistered strategy: ${t}`)),e}clear(){this.strategiesMap.clear(),this.updateMetrics(),u?.debug?.log("BackgroundStrategyRegistry","All strategies cleared from registry")}destroy(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null);for(let[t,e]of this.strategiesMap.entries())if("destroy"in e.strategy&&typeof e.strategy.destroy=="function")try{e.strategy.destroy()}catch(i){u?.debug?.warn("BackgroundStrategyRegistry",`Error destroying strategy ${t}:`,i)}this.clear(),u?.debug?.log("BackgroundStrategyRegistry","Strategy registry destroyed")}}});var Bi,us=y(()=>{"use strict";G();U();oe();A();Se();Z();Bi=class{constructor(){this.utils=D;this.config=M;this.cssController=null;this.depthState={containerElement:null,backgroundContainer:null,depthLayers:new Map,animationFrameId:null,lastAnimationTime:0,scrollY:0,scrollX:0,lastUpdateTime:0,isInitialized:!1,stylesInjected:!1};this.depthSettings={enabled:!0,layerCount:6,maxDepth:1e3,parallaxStrength:.5,depthFogIntensity:.7,infiniteScrolling:!0,qualityLevel:"medium",performanceMode:!1,musicResponsiveness:1};this.performanceMetrics={totalLayers:0,visibleLayers:0,averageDepth:0,parallaxRange:0,renderTime:0,memoryUsage:0};this.layerTemplates={cosmic:{animation:"cosmic-drift",duration:"120s",baseGradient:"radial-gradient(ellipse at center, {primary} 0%, {secondary} 50%, {base} 100%)"},nebula:{animation:"nebula-flow",duration:"180s",baseGradient:"conic-gradient(from 45deg, {primary} 0%, {secondary} 25%, {tertiary} 50%, {quaternary} 75%, {primary} 100%)"},stellar:{animation:"stellar-motion",duration:"240s",baseGradient:"linear-gradient(45deg, {primary} 0%, {secondary} 25%, {tertiary} 50%, {quaternary} 75%, {primary} 100%)"},quantum:{animation:"quantum-field",duration:"300s",baseGradient:"radial-gradient(circle at 30% 70%, {primary} 0%, transparent 50%), radial-gradient(circle at 70% 30%, {secondary} 0%, transparent 50%)"},dimensional:{animation:"dimensional-shift",duration:"360s",baseGradient:"linear-gradient(135deg, {primary} 0%, {secondary} 20%, {tertiary} 40%, {quaternary} 60%, {primary} 80%, {secondary} 100%)"},void:{animation:"void-expansion",duration:"480s",baseGradient:"radial-gradient(ellipse at center, {base} 0%, {secondary} 30%, {primary} 60%, transparent 100%)"}};this.boundScrollHandler=null;this.boundResizeHandler=null;this.deviceDetector=new O,this.cssController=P(),this.loadDepthSettings(),this.adaptToDeviceCapabilities(),this.boundScrollHandler=this.handleScroll.bind(this),this.boundResizeHandler=this.handleResize.bind(this),u?.debug?.log("DepthLayeredStrategy","Depth layered strategy initialized",{layerCount:this.depthSettings.layerCount,qualityLevel:this.depthSettings.qualityLevel,deviceCapability:this.deviceDetector.recommendPerformanceQuality()})}getStrategyName(){return"depth-layered"}canProcess(t){return this.depthSettings.enabled}getEstimatedProcessingTime(t){let i=this.depthSettings.layerCount/6,a=this.depthSettings.qualityLevel==="high"?1.3:this.depthSettings.qualityLevel==="low"?.7:1;return Math.round(15*i*a)}async processColors(t){let e=performance.now();try{this.depthState.isInitialized||await this.initializeDepthSystem();let i=this.extractDepthColors(t.rawColors);await this.updateDepthLayers(i),this.depthState.animationFrameId||this.startDepthAnimation(),t.musicData?.energy!==void 0&&this.updateDepthWithMusicEnergy(t.musicData.energy),this.depthState.lastUpdateTime=Date.now(),this.updatePerformanceMetrics();let a=performance.now()-e,r={processedColors:{depthLayers:this.depthState.depthLayers.size.toString(),depthEnabled:this.depthSettings.enabled.toString(),qualityLevel:this.depthSettings.qualityLevel,...t.rawColors},accentHex:this.selectPrimaryColor(t.rawColors)||"#cba6f7",accentRgb:this.convertToRgbString(this.selectPrimaryColor(t.rawColors)||"#cba6f7"),metadata:{strategy:this.getStrategyName(),processingTime:a,cacheKey:`depth-layered-${t.trackUri}`,harmonicIntensity:this.depthSettings.parallaxStrength,layerCount:this.depthState.depthLayers.size},context:t};return u?.debug?.log("DepthLayeredStrategy","Depth layered processing completed",{layerCount:this.depthState.depthLayers.size,processingTime:a,trackUri:t.trackUri}),r}catch(i){let a=performance.now()-e;return u?.debug?.error("DepthLayeredStrategy","Depth layered processing failed:",i),{processedColors:t.rawColors,accentHex:this.selectPrimaryColor(t.rawColors)||"#cba6f7",accentRgb:this.convertToRgbString(this.selectPrimaryColor(t.rawColors)||"#cba6f7"),metadata:{strategy:this.getStrategyName(),processingTime:a,error:i instanceof Error?i.message:"Unknown error"},context:t}}}loadDepthSettings(){try{let t=x.get("sn-gradient-intensity");if(t){let i=t==="intense"?"high":t==="balanced"?"medium":t==="minimal"?"low":"medium";this.depthSettings.qualityLevel=i,this.adjustQualitySettings()}let e=t!=="disabled";e!==void 0&&(this.depthSettings.enabled=e)}catch(t){u?.debug?.warn("DepthLayeredStrategy","Failed to load settings:",t)}}adaptToDeviceCapabilities(){switch(this.deviceDetector.recommendPerformanceQuality()){case"low":this.depthSettings.qualityLevel="low",this.depthSettings.layerCount=3,this.depthSettings.performanceMode=!0,this.depthSettings.parallaxStrength=.3,this.depthSettings.depthFogIntensity=.5;break;case"balanced":this.depthSettings.qualityLevel="medium",this.depthSettings.layerCount=6,this.depthSettings.performanceMode=!1,this.depthSettings.parallaxStrength=.5,this.depthSettings.depthFogIntensity=.7;break;case"high":this.depthSettings.qualityLevel="high",this.depthSettings.layerCount=9,this.depthSettings.performanceMode=!1,this.depthSettings.parallaxStrength=.8,this.depthSettings.depthFogIntensity=.9;break}}adjustQualitySettings(){switch(this.depthSettings.qualityLevel){case"low":this.depthSettings.layerCount=3,this.depthSettings.parallaxStrength=.3,this.depthSettings.depthFogIntensity=.5;break;case"medium":this.depthSettings.layerCount=6,this.depthSettings.parallaxStrength=.5,this.depthSettings.depthFogIntensity=.7;break;case"high":this.depthSettings.layerCount=9,this.depthSettings.parallaxStrength=.8,this.depthSettings.depthFogIntensity=.9;break}}async initializeDepthSystem(){this.createContainerElements(),this.injectDepthAnimations(),this.setupEventListeners(),this.depthState.isInitialized=!0,u?.debug?.log("DepthLayeredStrategy","Depth system initialized successfully")}createContainerElements(){this.depthState.containerElement=document.querySelector(".Root__main-view")||document.querySelector(".main-view-container")||document.body,this.depthState.backgroundContainer=document.createElement("div"),this.depthState.backgroundContainer.className="sn-depth-background-container",this.depthState.backgroundContainer.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -20;
      pointer-events: none;
      overflow: hidden;
      perspective: 1000px;
      transform-style: preserve-3d;
    `,this.depthState.containerElement.insertBefore(this.depthState.backgroundContainer,this.depthState.containerElement.firstChild)}injectDepthAnimations(){if(this.depthState.stylesInjected)return;let t=document.createElement("style");t.textContent=`
      .sn-depth-layer {
        position: absolute;
        width: 120%;
        height: 120%;
        top: -10%;
        left: -10%;
        pointer-events: none;
        transform-style: preserve-3d;
        will-change: transform, opacity;
      }

      @keyframes cosmic-drift {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        25% { transform: translate3d(-2%, 1%, 0) rotate(0.5deg) scale(1.02); }
        50% { transform: translate3d(0, -1%, 0) rotate(0deg) scale(0.98); }
        75% { transform: translate3d(2%, 0.5%, 0) rotate(-0.5deg) scale(1.01); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes nebula-flow {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        33% { transform: translate3d(1%, -1%, 0) rotate(1deg) scale(1.03); }
        66% { transform: translate3d(-1%, 1%, 0) rotate(-1deg) scale(0.97); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes stellar-motion {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        20% { transform: translate3d(-1%, 0.5%, 0) rotate(0.3deg) scale(1.01); }
        40% { transform: translate3d(0.5%, -0.5%, 0) rotate(-0.3deg) scale(0.99); }
        60% { transform: translate3d(1%, 0.5%, 0) rotate(0.2deg) scale(1.02); }
        80% { transform: translate3d(-0.5%, 1%, 0) rotate(-0.2deg) scale(0.98); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes quantum-field {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); filter: blur(0px); }
        25% { transform: translate3d(0.5%, -0.5%, 0) rotate(0.1deg) scale(1.01); filter: blur(0.5px); }
        50% { transform: translate3d(-0.5%, 0.5%, 0) rotate(-0.1deg) scale(0.99); filter: blur(1px); }
        75% { transform: translate3d(0.3%, 0.3%, 0) rotate(0.05deg) scale(1.005); filter: blur(0.3px); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); filter: blur(0px); }
      }

      @keyframes dimensional-shift {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        16% { transform: translate3d(0.2%, -0.2%, 0) rotate(0.1deg) scale(1.005); }
        32% { transform: translate3d(-0.2%, 0.2%, 0) rotate(-0.1deg) scale(0.995); }
        48% { transform: translate3d(0.1%, 0.1%, 0) rotate(0.05deg) scale(1.002); }
        64% { transform: translate3d(-0.1%, -0.1%, 0) rotate(-0.05deg) scale(0.998); }
        80% { transform: translate3d(0.15%, 0%, 0) rotate(0.02deg) scale(1.001); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes void-expansion {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.9; }
        50% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1.1); opacity: 0.6; }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.9; }
      }

      @media (prefers-reduced-motion: reduce) {
        .sn-depth-layer {
          animation: none !important;
        }
      }
    `,document.head.appendChild(t),this.depthState.stylesInjected=!0}setupEventListeners(){this.boundScrollHandler&&window.addEventListener("scroll",this.boundScrollHandler,{passive:!0}),this.boundResizeHandler&&window.addEventListener("resize",this.boundResizeHandler,{passive:!0})}extractDepthColors(t){let e=["PRIMARY","VIBRANT","LIGHT_VIBRANT","DARK_VIBRANT","VIBRANT_NON_ALARMING","PROMINENT","SECONDARY","DESATURATED"],i=[],a=new Set;for(let r of e){let n=t[r];if(n&&!a.has(n)&&this.utils.hexToRgb(n)&&(i.push(n),a.add(n),i.length>=this.depthSettings.layerCount))break}for(;i.length<this.depthSettings.layerCount;){let r=i[0]||"#cba6f7",n=this.createColorVariation(r,i.length);i.push(n)}return i}createColorVariation(t,e){let i=this.utils.hexToRgb(t);if(!i)return t;let a=.8-e*.1,r=Math.round(i.r*a),n=Math.round(i.g*a),s=Math.round(i.b*a);return this.utils.rgbToHex(r,n,s)}async updateDepthLayers(t){if(!this.depthState.backgroundContainer)return;this.depthState.depthLayers.forEach(i=>{i.element.parentNode&&i.element.parentNode.removeChild(i.element)}),this.depthState.depthLayers.clear();let e=Object.keys(this.layerTemplates);for(let i=0;i<this.depthSettings.layerCount;i++){let a=(i+1)*(this.depthSettings.maxDepth/this.depthSettings.layerCount),r=e[i%e.length],n=this.layerTemplates[r],s=document.createElement("div");s.className="sn-depth-layer",s.id=`sn-depth-layer-${i}`;let o=a/this.depthSettings.maxDepth,c=1-o*this.depthSettings.parallaxStrength,m=1-o*this.depthSettings.depthFogIntensity,d=1+o*.2,h=o*3,g=this.createDepthGradient(n.baseGradient,t,i);s.style.cssText=`
        background: ${g};
        transform: translate3d(0, 0, ${-a}px) scale(${d});
        opacity: ${m};
        filter: blur(${h}px);
        animation: ${n.animation} ${n.duration} ease-in-out infinite;
        animation-delay: ${i*.5}s;
      `;let f={id:`depth-layer-${i}`,element:s,depth:a,parallaxFactor:c,opacityRange:[m*.5,m],scaleRange:[d*.95,d*1.05],rotationSpeed:.01+i*.001,colorShift:i*30,blurAmount:h,animationPhase:i*Math.PI/4,enabled:!0,gradientColors:t.slice(i,i+4)};this.depthState.depthLayers.set(f.id,f),this.depthState.backgroundContainer.appendChild(s)}u?.debug?.log("DepthLayeredStrategy",`Updated ${this.depthState.depthLayers.size} depth layers with new colors`)}createDepthGradient(t,e,i){let a=e.length,r=i%a,n=(i+1)%a,s=(i+2)%a,o=(i+3)%a,m=.8-i/this.depthSettings.layerCount*.6,d=this.convertToRgba(e[r]||"#cba6f7",m),h=this.convertToRgba(e[n]||"#f5c2e7",m*.7),g=this.convertToRgba(e[s]||"#fab387",m*.5),f=this.convertToRgba(e[o]||"#a6e3a1",m*.3),v=this.convertToRgba("#1e1e2e",m*.9);return t.replace(/\{primary\}/g,d).replace(/\{secondary\}/g,h).replace(/\{tertiary\}/g,g).replace(/\{quaternary\}/g,f).replace(/\{base\}/g,v)}convertToRgba(t,e){let i=this.utils.hexToRgb(t);return i?`rgba(${i.r}, ${i.g}, ${i.b}, ${e})`:`rgba(203, 166, 247, ${e})`}startDepthAnimation(){this.depthState.lastAnimationTime=performance.now();let t=()=>{if(!this.depthState.isInitialized)return;let e=performance.now(),i=e-this.depthState.lastAnimationTime;if(i<33){this.depthState.animationFrameId=requestAnimationFrame(t);return}this.depthState.lastAnimationTime=e,this.updateDepthAnimations(i),this.updatePerformanceMetrics(),this.depthState.animationFrameId=requestAnimationFrame(t)};this.depthState.animationFrameId=requestAnimationFrame(t)}updateDepthAnimations(t){this.depthState.depthLayers.forEach(e=>{e.animationPhase+=e.rotationSpeed*t*.001;let i=Math.sin(e.animationPhase)*.05,r=parseFloat(e.element.style.opacity)+i;e.element.style.opacity=Math.max(0,Math.min(1,r)).toString()})}updateDepthWithMusicEnergy(t){let e=t*this.depthSettings.musicResponsiveness*.3;this.depthState.depthLayers.forEach(i=>{let a=i.opacityRange[0],r=i.opacityRange[1],n=a+e*(r-a);i.element.style.opacity=Math.max(0,Math.min(1,n)).toString()})}handleScroll(t){this.depthSettings.infiniteScrolling&&(this.depthState.scrollY=window.scrollY,this.depthState.scrollX=window.scrollX,this.updateParallaxEffects())}handleResize(t){this.updateLayerDimensions()}updateParallaxEffects(){this.depthState.depthLayers.forEach(t=>{let e=this.depthState.scrollY*t.parallaxFactor,i=this.depthState.scrollX*t.parallaxFactor*.5,r=t.element.style.transform.replace(/translate3d\([^)]*\)/,`translate3d(${i}px, ${e}px, ${-t.depth}px)`);t.element.style.transform=r})}updateLayerDimensions(){this.depthState.depthLayers.forEach(t=>{let i=1+t.depth/this.depthSettings.maxDepth*.2,r=t.element.style.transform.replace(/scale\([^)]*\)/,`scale(${i})`);t.element.style.transform=r})}updatePerformanceMetrics(){this.performanceMetrics.totalLayers=this.depthState.depthLayers.size,this.performanceMetrics.visibleLayers=Array.from(this.depthState.depthLayers.values()).filter(t=>parseFloat(t.element.style.opacity)>.01).length,this.performanceMetrics.averageDepth=Array.from(this.depthState.depthLayers.values()).reduce((t,e)=>t+e.depth,0)/this.depthState.depthLayers.size,this.performanceMetrics.parallaxRange=this.depthSettings.parallaxStrength,this.performanceMetrics.renderTime=performance.now()-this.depthState.lastAnimationTime,this.cssController&&(this.cssController.queueCSSVariableUpdate("--sn-depth-layers-total",this.performanceMetrics.totalLayers.toString()),this.cssController.queueCSSVariableUpdate("--sn-depth-layers-visible",this.performanceMetrics.visibleLayers.toString()))}selectPrimaryColor(t){let e=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let i of e){let a=t[i];if(a&&this.utils.hexToRgb(a))return a}return null}convertToRgbString(t){let e=this.utils.hexToRgb(t);return e?`${e.r},${e.g},${e.b}`:"203,166,247"}updateConfig(t){this.depthSettings={...this.depthSettings,...t},t.qualityLevel&&this.adjustQualitySettings(),u?.debug?.log("DepthLayeredStrategy","Configuration updated:",t)}async healthCheck(){let t=Date.now()-this.depthState.lastUpdateTime<3e4;return{healthy:this.depthState.isInitialized&&this.depthSettings.enabled,canProcess:this.canProcess({}),issues:this.depthState.isInitialized?this.depthSettings.enabled?[]:["Depth layers disabled in settings"]:["Depth system not initialized"],metrics:{isInitialized:this.depthState.isInitialized,depthEnabled:this.depthSettings.enabled,layerCount:this.depthState.depthLayers.size,qualityLevel:this.depthSettings.qualityLevel,parallaxStrength:this.depthSettings.parallaxStrength,hasRecentUpdate:t,animationActive:this.depthState.animationFrameId!==null,performanceMetrics:this.performanceMetrics}}}destroy(){this.depthState.animationFrameId&&(cancelAnimationFrame(this.depthState.animationFrameId),this.depthState.animationFrameId=null),this.boundScrollHandler&&(window.removeEventListener("scroll",this.boundScrollHandler),this.boundScrollHandler=null),this.boundResizeHandler&&(window.removeEventListener("resize",this.boundResizeHandler),this.boundResizeHandler=null),this.depthState.depthLayers.forEach(t=>{t.element.parentNode&&t.element.parentNode.removeChild(t.element)}),this.depthState.depthLayers.clear(),this.depthState.backgroundContainer&&this.depthState.backgroundContainer.parentNode&&(this.depthState.backgroundContainer.parentNode.removeChild(this.depthState.backgroundContainer),this.depthState.backgroundContainer=null),this.depthState.isInitialized=!1,this.depthState.containerElement=null,u?.debug?.log("DepthLayeredStrategy","Depth layered strategy destroyed")}}});var Fi,ms=y(()=>{"use strict";G();U();A();Se();ie();Tt();Z();Fi=class{constructor(t){this.utils=D;this.config=M;this.dynamicColorState=this.getInitialColorState();this.integrationConfig={accentUpdateEnabled:!0,baseTransformationEnabled:!0,visualEffectsIntegrationEnabled:!0,oklabEnhancementEnabled:!0,smoothTransitionDuration:800,energyResponseMultiplier:1.2,oklabPreset:"VIBRANT"};this.transitionTimer=0;this.lastTransitionStartTime=0;this.transitionFromAccent="";this.transitionToAccent="";this.cssController=t||P(),this.oklabProcessor=new E(this.config.enableDebug),this.initializeCurrentState(),u?.debug?.log("DynamicCatppuccinStrategy","Color strategy initialized with CSS coordinator and OKLAB processing")}getInitialColorState(){try{let t=K.getDefaultAccentColor(),e=K.getBrightnessAdjustedBaseColor();return{currentAccentHex:t.hex,currentAccentRgb:t.rgb,baseBackgroundHex:e.hex,baseBackgroundRgb:e.rgb,lastUpdateTime:0,musicEnergy:.5,transitionInProgress:!1}}catch(t){return console.warn("[DynamicCatppuccinStrategy] Failed to get initial colors, using fallback:",t),{currentAccentHex:"#7c3aed",currentAccentRgb:"124,58,237",baseBackgroundHex:"#0d1117",baseBackgroundRgb:"13,17,23",lastUpdateTime:0,musicEnergy:.5,transitionInProgress:!1}}}getStrategyName(){return"dynamic-catppuccin"}canProcess(t){return this.checkDynamicAccentEnabled()}getEstimatedProcessingTime(t){return 5}async processColors(t){let e=performance.now();try{let i=this.selectBestAccentColor(t.rawColors);if(!i)throw new Error("No suitable accent color found in extracted colors");let a=i,r=this.utils.hexToRgb(i),n=null;if(this.integrationConfig.oklabEnhancementEnabled){let c=E.getPreset(this.integrationConfig.oklabPreset);n=this.oklabProcessor.processColor(i,c),a=n.enhancedHex,r=n.enhancedRgb,u?.debug?.log("DynamicCatppuccinStrategy","OKLAB color enhancement applied:",{original:i,enhanced:a,preset:c.name,processingTime:`${n.processingTime.toFixed(2)}ms`})}await this.applyColorFacade(a,t.rawColors,n),this.dynamicColorState.currentAccentHex=a,r&&(this.dynamicColorState.currentAccentRgb=`${r.r},${r.g},${r.b}`),this.dynamicColorState.lastUpdateTime=Date.now(),t.musicData?.energy!==void 0&&(this.dynamicColorState.musicEnergy=t.musicData.energy,await this.updateVisualEffectsWithMusicEnergy(t.musicData.energy));let s=performance.now()-e,o={processedColors:{accent:a,primary:a,originalAccent:i,...t.rawColors},accentHex:a,accentRgb:this.dynamicColorState.currentAccentRgb,metadata:{strategy:this.getStrategyName(),processingTime:s,cacheKey:`dynamic-catppuccin-${t.trackUri}`,harmonicIntensity:this.integrationConfig.energyResponseMultiplier,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,oklabPreset:this.integrationConfig.oklabPreset,...n&&{oklabMetadata:{originalHex:n.originalHex,enhancedHex:n.enhancedHex,shadowHex:n.shadowHex,oklabProcessingTime:n.processingTime}}},context:t};return u?.debug?.log("DynamicCatppuccinStrategy","Color processing completed",{originalAccent:i,processedAccent:a,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,processingTime:s,trackUri:t.trackUri}),o}catch(i){let a=performance.now()-e;return u?.debug?.error("DynamicCatppuccinStrategy","Color processing failed:",i),{processedColors:t.rawColors,accentHex:this.dynamicColorState.currentAccentHex,accentRgb:this.dynamicColorState.currentAccentRgb,metadata:{strategy:this.getStrategyName(),processingTime:a,error:i instanceof Error?i.message:"Unknown error"},context:t}}}checkDynamicAccentEnabled(){try{let t=x.get("catppuccin-accentColor"),e=String(t)==="dynamic";return this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinStrategy",`Accent setting: ${t}, Dynamic: ${e}`),e}catch(t){return u?.debug?.error("DynamicCatppuccinStrategy","Error checking dynamic accent setting:",t),!1}}initializeCurrentState(){let t=document.documentElement,e=getComputedStyle(t),i=e.getPropertyValue("--spice-accent").trim()||e.getPropertyValue("--sn-color-accent-hex").trim();if(i){this.dynamicColorState.currentAccentHex=i;let n=this.utils.hexToRgb(i);n&&(this.dynamicColorState.currentAccentRgb=`${n.r},${n.g},${n.b}`)}let a=e.getPropertyValue("--spice-base").trim()||"#1e1e2e";this.dynamicColorState.baseBackgroundHex=a;let r=this.utils.hexToRgb(a);r&&(this.dynamicColorState.baseBackgroundRgb=`${r.r},${r.g},${r.b}`),this.dynamicColorState.lastUpdateTime=Date.now(),u?.debug?.log("DynamicCatppuccinStrategy","Current state initialized:",{accent:this.dynamicColorState.currentAccentHex,base:this.dynamicColorState.baseBackgroundHex})}selectBestAccentColor(t){let e=["VIBRANT_NON_ALARMING","VIBRANT","LIGHT_VIBRANT","PROMINENT","PRIMARY","DARK_VIBRANT"];for(let i of e){let a=t[i];if(a&&this.utils.hexToRgb(a))return a}return null}async applyColorFacade(t,e,i){let a=this.utils.hexToRgb(t);if(!a)return;let r=`${a.r},${a.g},${a.b}`,n={"--sn-dynamic-accent-hex":t,"--sn-dynamic-accent-rgb":r,"--sn-dynamic-primary-hex":t,"--sn-dynamic-primary-rgb":r,"--spice-accent":t,"--spice-button":t,"--spice-button-active":t,"--spice-rgb-accent":r,"--spice-rgb-button":r,"--sn-color-extracted-primary-rgb":r,"--sn-color-extracted-vibrant-rgb":r,"--sn-color-extracted-dominant-rgb":r};if(i&&this.integrationConfig.oklabEnhancementEnabled){let o=this.oklabProcessor.generateCSSVariables(i,"sn-oklab-accent");Object.assign(n,{...o,"--sn-dynamic-shadow-hex":i.shadowHex,"--sn-dynamic-shadow-rgb":`${i.shadowRgb.r},${i.shadowRgb.g},${i.shadowRgb.b}`,"--sn-accent-oklch-l":i.oklchEnhanced.L.toFixed(3),"--sn-accent-oklch-c":i.oklchEnhanced.C.toFixed(3),"--sn-accent-oklch-h":i.oklchEnhanced.H.toFixed(1)}),u?.debug?.log("DynamicCatppuccinStrategy","Added OKLAB-enhanced CSS variables:",{oklabVarsCount:Object.keys(o).length,enhancedHex:i.enhancedHex,shadowHex:i.shadowHex})}this.cssController&&this.cssController.updateVariables(n,"high","core-spicetify-facade");let s=e.PRIMARY||e.VIBRANT;s&&await this.updateLivingBaseBackground(s),this.integrationConfig.visualEffectsIntegrationEnabled&&await this.updateVisualEffectsWithAccent(t,r),u?.debug?.log("DynamicCatppuccinStrategy",`Applied coordinated color facade - Spicetify: ${t}, Visual-effects extensions updated`,{oklabProcessing:!!i,variableCount:Object.keys(n).length})}async updateLivingBaseBackground(t){let e=this.utils.hexToRgb(t);if(!e)return;let i=`${e.r},${e.g},${e.b}`,a=`
      linear-gradient(135deg,
        var(--spice-base) 0%,
        rgba(${i}, 0.08) 30%,
        var(--spice-base) 70%
      ),
      var(--spice-base)
    `,r={"--sn-dynamic-secondary-hex":t,"--sn-dynamic-secondary-rgb":i,"--sn-color-extracted-secondary-rgb":i,"--sn-color-harmony-complementary-rgb":i,"--living-base-gradient":a,"--visual-effects-base-gradient":a};this.cssController&&this.cssController.updateVariables(r,"normal","living-base-background"),u?.debug?.log("DynamicCatppuccinStrategy",`Coordinated living base facade updated - Primary: ${t}, preserving --spice-base`)}async updateVisualEffectsWithAccent(t,e){let i={"--sn-holographic-rgb":e,"--holographic-scanline-rgb":e,"--visual-effects-intensity":`calc(0.5 + var(--musical-sync-intensity) * ${this.integrationConfig.energyResponseMultiplier})`};this.cssController&&this.cssController.updateVariables(i,"normal","visual-effects-accent-integration")}async updateVisualEffectsWithMusicEnergy(t){let e=t*this.integrationConfig.energyResponseMultiplier,a=Math.max(.1,Math.min(1,.5+e*.3)),r={"--musical-sync-intensity":e.toString(),"--holographic-music-flicker-intensity":e.toString(),"--visual-effects-intensity":a.toString()};this.cssController&&(this.cssController.updateVariables(r,"high","visual-effects-music-energy"),this.cssController.updateVisualEffectsIntensity(parseFloat(a.toString()),"DynamicCatppuccinStrategy",e))}getDynamicColorState(){return{...this.dynamicColorState}}updateConfig(t){this.integrationConfig={...this.integrationConfig,...t},("oklabEnhancementEnabled"in t||"oklabPreset"in t)&&(this.oklabProcessor=new E(this.config.enableDebug)),u?.debug?.log("DynamicCatppuccinStrategy","Configuration updated:",{...t,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,oklabPreset:this.integrationConfig.oklabPreset})}async healthCheck(){let t=this.checkDynamicAccentEnabled(),e=Date.now()-this.dynamicColorState.lastUpdateTime<3e4;return{healthy:t,canProcess:t,issues:t?[]:["Dynamic accent not enabled in settings"],metrics:{dynamicAccentEnabled:t,currentAccent:this.dynamicColorState.currentAccentHex,lastUpdateAge:Date.now()-this.dynamicColorState.lastUpdateTime,hasRecentUpdate:e,transitionInProgress:this.dynamicColorState.transitionInProgress,musicEnergy:this.dynamicColorState.musicEnergy,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,oklabPreset:this.integrationConfig.oklabPreset,visualEffectsIntegration:this.integrationConfig.visualEffectsIntegrationEnabled}}}destroy(){this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=0),this.dynamicColorState.transitionInProgress=!1,u?.debug?.log("DynamicCatppuccinStrategy","Dynamic Catppuccin strategy destroyed")}}});var ds={};te(ds,{DynamicGradientStrategy:()=>At});var At,nr=y(()=>{"use strict";G();U();k();oe();A();ie();Z();ne();At=class extends N{constructor(e=M,i=D,a=null,r=null,n,s){super(e,i,a,r,null);this.utils=D;this.config=M;this.livingBaseState={currentBaseHex:"#1e1e2e",currentBaseRgb:"30,30,46",currentPrimaryHex:"var(--sn-brightness-adjusted-accent-hex, #cba6f7)",currentPrimaryRgb:"var(--sn-brightness-adjusted-accent-rgb, 203, 166, 247)",visualEffectsIntensity:.5,musicEnergy:.5,lastUpdateTime:0,webglIntegrationActive:!1,oklabGradientStops:[]};this.gradientConfig={baseTransformationEnabled:!0,webglIntegrationEnabled:!0,responsiveAnimationEnabled:!0,visualEffectsLayerOpacity:.08,dynamicFlowIntensity:1.2,musicResponsiveness:1,oklabInterpolationEnabled:!0,oklabPreset:"STANDARD",gradientSmoothness:.8,animationThrottleFps:30,enablePerformanceBudget:!0,maxFrameTimeMs:16};this.cssAnimationManager=null;this.oklabCache=new Map;this.gradientCache=new Map;this.cacheValidityMs=5e3;this.lastCacheCleanup=0;this.musicEventDebounceTimers={musicState:0,harmonizedColors:0,webglState:0,visualEffectsIntensity:0};this.eventDebounceMs=100;this.cssController=n||P(),this.oklabProcessor=new E(this.config.enableDebug),this.deviceDetector=new O,this.cssAnimationManager=s,this.initializeBaseState(),this.applyDeviceAwareSettings().catch(o=>{u?.debug?.warn("DynamicGradientStrategy","Failed to apply device-aware settings:",o)}),u?.debug?.log("DynamicGradientStrategy","Living gradient strategy initialized with OKLAB interpolation and device-aware performance")}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{this.setupConsciousnessListeners(),this.setupWebGLIntegrationListeners(),this.initializeBaseState(),this.initializeConsciousnessBreathing(),await this.applyLivingConsciousnessBase(),u?.debug?.log("DynamicGradientStrategy","Living gradient system awakened with visual system lifecycle")}catch(e){u?.debug?.error("DynamicGradientStrategy","Failed to initialize living gradient system:",e)}}setupConsciousnessListeners(){typeof p<"u"&&p.subscribe("colors:harmonized",e=>{e&&e.processedColors&&this.handleHarmonizedColorUpdate(e.processedColors)},"LivingGradientStrategy"),document.addEventListener("music-state-change",e=>{let i=e;i.detail&&this.handleMusicStateChange(i.detail)}),document.addEventListener("visualEffects-intensity-change",e=>{let i=e;i.detail&&typeof i.detail.intensity=="number"&&this.updateConsciousnessIntensity(i.detail.intensity)}),u?.debug?.log("DynamicGradientStrategy","Consciousness listeners established")}setupWebGLIntegrationListeners(){document.addEventListener("webgl-state-change",e=>{let i=e;i.detail&&this.handleWebGLStateChange(i.detail)}),document.addEventListener("webgl-gradient-update",e=>{let i=e;i.detail&&this.coordinateWithWebGLGradient(i.detail)}),u?.debug?.log("DynamicGradientStrategy","WebGL integration listeners established")}handleHarmonizedColorUpdate(e){this.debouncedEventHandler("harmonizedColors",()=>{let i=e.VIBRANT||e.PRIMARY||e.PROMINENT;if(i&&i!==this.livingBaseState.currentPrimaryHex){this.livingBaseState.currentPrimaryHex=i;let a=this.utils.hexToRgb(i);a&&(this.livingBaseState.currentPrimaryRgb=`${a.r},${a.g},${a.b}`),this.updateLivingConsciousnessBase(),this.triggerConsciousnessBreathing(),u?.debug?.log("DynamicGradientStrategy","Living base updated with harmonized colors:",i)}})}handleMusicStateChange(e){this.debouncedEventHandler("musicState",()=>{if(e.energy!==void 0){this.livingBaseState.musicEnergy=e.energy;let i=.5,a=e.energy*this.gradientConfig.musicResponsiveness;this.livingBaseState.visualEffectsIntensity=Math.max(.1,Math.min(1,i+a*.3)),this.updateMusicResponsiveVariables()}})}handleWebGLStateChange(e){this.debouncedEventHandler("webglState",()=>{e.enabled!==void 0&&(this.livingBaseState.webglIntegrationActive=e.enabled,this.coordinateWithWebGLSystem(e.enabled),u?.debug?.log("DynamicGradientStrategy",`WebGL integration ${e.enabled?"activated":"deactivated"}`))})}updateConsciousnessIntensity(e){this.debouncedEventHandler("visualEffectsIntensity",()=>{this.livingBaseState.visualEffectsIntensity=Math.max(0,Math.min(1,e)),this.updateConsciousnessVariables()})}debouncedEventHandler(e,i){let a=performance.now();a-this.musicEventDebounceTimers[e]>=this.eventDebounceMs&&(i(),this.musicEventDebounceTimers[e]=a)}initializeConsciousnessBreathing(){if(this.gradientConfig.responsiveAnimationEnabled){if(!this.cssAnimationManager){u?.debug?.warn("DynamicGradientStrategy","CSSAnimationManager not available, falling back to basic visualEffects");return}this.triggerConsciousnessBreathing(),u?.debug?.log("DynamicGradientStrategy","CSS-first visualEffects animation initialized")}}triggerConsciousnessBreathing(){if(!this.cssAnimationManager||!this.gradientConfig.responsiveAnimationEnabled)return;let e=document.querySelectorAll(".Root__main-view::before, .Root__main-view, [data-visualEffects-animation]");if(e.length===0){let i=document.querySelector(".Root__main-view")||document.body;i&&(i.setAttribute("data-visualEffects-animation","true"),this.cssAnimationManager.triggerConsciousnessBreathing([i],this.livingBaseState.musicEnergy,120))}else this.cssAnimationManager.triggerConsciousnessBreathing(e,this.livingBaseState.musicEnergy,120);u?.debug?.log("DynamicGradientStrategy",`CSS-first visualEffects animation triggered for ${e.length} elements`)}async applyDeviceAwareSettings(){if(!this.deviceDetector.isInitialized)try{await this.deviceDetector.initialize()}catch(a){u?.debug?.warn("DynamicGradientStrategy","Device detection failed, using default settings:",a);return}let e=this.deviceDetector.getCapabilities();if(!e){u?.debug?.warn("DynamicGradientStrategy","No device capabilities available, using default settings");return}let i=e.overall;switch(i){case"high":this.gradientConfig.animationThrottleFps=30,this.gradientConfig.maxFrameTimeMs=16,this.gradientConfig.enablePerformanceBudget=!0;break;case"medium":this.gradientConfig.animationThrottleFps=20,this.gradientConfig.maxFrameTimeMs=20,this.gradientConfig.enablePerformanceBudget=!0;break;case"low":this.gradientConfig.animationThrottleFps=15,this.gradientConfig.maxFrameTimeMs=33,this.gradientConfig.enablePerformanceBudget=!0,this.gradientConfig.visualEffectsLayerOpacity*=.7,this.gradientConfig.dynamicFlowIntensity*=.8,this.gradientConfig.oklabInterpolationEnabled=!1;break;default:this.gradientConfig.animationThrottleFps=20,this.gradientConfig.maxFrameTimeMs=20;break}e.gpu.supportsWebGL||(this.gradientConfig.webglIntegrationEnabled=!1),e.memory.level==="low"&&(this.cacheValidityMs=2e3),e.cpu.cores<=2&&(this.gradientConfig.animationThrottleFps=Math.min(this.gradientConfig.animationThrottleFps,15)),e.display.reducedMotion&&(this.gradientConfig.responsiveAnimationEnabled=!1,u?.debug?.log("DynamicGradientStrategy","Breathing animation disabled due to reduced motion preference")),u?.debug?.log("DynamicGradientStrategy",`Device-aware settings applied for ${i}: ${this.gradientConfig.animationThrottleFps}fps, CSS-first animation coordination`)}getStrategyName(){return"living-gradient"}canProcess(e){return this.gradientConfig.baseTransformationEnabled}getEstimatedProcessingTime(e){return 8}async processColors(e){let i=performance.now();try{let a=this.selectPrimaryColor(e.rawColors),r=this.selectSecondaryColor(e.rawColors);if(!a)throw new Error("No suitable primary color found for living gradient");let n=a,s=r,o=[];if(this.gradientConfig.oklabInterpolationEnabled&&a){let d=E.getPreset(this.gradientConfig.oklabPreset);if(n=this.oklabProcessor.processColor(a,d).enhancedHex,r){s=this.oklabProcessor.processColor(r,d).enhancedHex;let f=Math.ceil(5*this.gradientConfig.gradientSmoothness)+3;o=this.oklabProcessor.generateOKLABGradient(n,s,f,d)}else{let g=this.livingBaseState.currentBaseHex;o=this.oklabProcessor.generateOKLABGradient(n,g,5,d),s=o[o.length-1]?.enhancedHex||n}u?.debug?.log("DynamicGradientStrategy","OKLAB gradient processing applied:",{originalPrimary:a,processedPrimary:n,originalSecondary:r,processedSecondary:s,gradientStops:o.length,preset:d.name})}await this.updateDynamicGradientState(n,s,e,o),await this.applyLivingConsciousnessBase(),this.triggerConsciousnessBreathing(),await this.updateWebGLIntegration();let c=performance.now()-i,m={processedColors:{primary:n,secondary:s||n,originalPrimary:a,...r&&{originalSecondary:r},livingBase:this.livingBaseState.currentBaseHex,...e.rawColors},accentHex:n,accentRgb:this.livingBaseState.currentPrimaryRgb,metadata:{strategy:this.getStrategyName(),processingTime:c,cacheKey:`living-gradient-${e.trackUri}`,harmonicIntensity:this.gradientConfig.dynamicFlowIntensity,oklabInterpolation:this.gradientConfig.oklabInterpolationEnabled,oklabPreset:this.gradientConfig.oklabPreset,gradientStopCount:o.length,gradientSmoothness:this.gradientConfig.gradientSmoothness},context:e};return u?.debug?.log("DynamicGradientStrategy","Living gradient processing completed",{originalPrimary:a,processedPrimary:n,originalSecondary:r,processedSecondary:s,oklabProcessing:this.gradientConfig.oklabInterpolationEnabled,gradientStops:o.length,processingTime:c,trackUri:e.trackUri}),m}catch(a){let r=performance.now()-i;return u?.debug?.error("DynamicGradientStrategy","Living gradient processing failed:",a),{processedColors:e.rawColors,accentHex:this.livingBaseState.currentPrimaryHex,accentRgb:this.livingBaseState.currentPrimaryRgb,metadata:{strategy:this.getStrategyName(),processingTime:r,error:a instanceof Error?a.message:"Unknown error"},context:e}}}initializeBaseState(){let e=document.documentElement,i=getComputedStyle(e),a=i.getPropertyValue("--spice-base").trim()||"#1e1e2e";this.livingBaseState.currentBaseHex=a;let r=this.utils.hexToRgb(a);r&&(this.livingBaseState.currentBaseRgb=`${r.r},${r.g},${r.b}`);let n=i.getPropertyValue("--sn-bg-gradient-primary-rgb").trim();if(n){let s=n.split(",").map(o=>parseInt(o.trim()));s.length===3&&(this.livingBaseState.currentPrimaryRgb=n,this.livingBaseState.currentPrimaryHex=this.utils.rgbToHex(s[0],s[1],s[2]))}this.livingBaseState.lastUpdateTime=Date.now(),u?.debug?.log("DynamicGradientStrategy","Base state initialized:",{base:this.livingBaseState.currentBaseHex,primary:this.livingBaseState.currentPrimaryHex})}selectPrimaryColor(e){let i=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let a of i){let r=e[a];if(r&&this.utils.hexToRgb(r))return r}return null}selectSecondaryColor(e){let i=["SECONDARY","DARK_VIBRANT","DESATURATED","LIGHT_VIBRANT"];for(let a of i){let r=e[a];if(r&&this.utils.hexToRgb(r))return r}return null}async updateDynamicGradientState(e,i,a,r=[]){let n=this.utils.hexToRgb(e);if(n){if(this.livingBaseState.currentPrimaryHex=e,this.livingBaseState.currentPrimaryRgb=`${n.r},${n.g},${n.b}`,this.livingBaseState.oklabGradientStops=r,a.musicData?.energy!==void 0){this.livingBaseState.musicEnergy=a.musicData.energy;let s=this.gradientConfig.visualEffectsLayerOpacity,o=1+a.musicData.energy*this.gradientConfig.musicResponsiveness;this.livingBaseState.visualEffectsIntensity=Math.max(.05,Math.min(1,s*o))}this.livingBaseState.lastUpdateTime=Date.now()}}async applyLivingConsciousnessBase(){let e=this.createLivingGradient(this.livingBaseState.oklabGradientStops),a=performance.now()/4e3*Math.PI*2,r=1+Math.sin(a)*.2,n=this.livingBaseState.visualEffectsIntensity*r,s=Math.sin(a*.7)*this.gradientConfig.dynamicFlowIntensity,o=Math.cos(a*.5)*this.gradientConfig.dynamicFlowIntensity,c=4e3,m=.5+this.livingBaseState.musicEnergy*1.5,d=c/m,h={"--living-base-gradient":e,"--visualEffects-base-gradient":e,"--visualEffects-layer-opacity":n.toString(),"--visualEffects-flow-x":`${s}%`,"--visualEffects-flow-y":`${o}%`,"--visualEffects-animation-duration":`${d}ms`};await this.cssController.batchSetVariables("DynamicGradientStrategy",h,"high","living-visualEffects-base"),u?.debug?.log("DynamicGradientStrategy","Applied coordinated living visualEffects base gradient")}createGradientCacheKey(e,i,a,r){let n=a.map((s,o)=>`${s.enhancedHex}-${o}`).join("|");return`${e}-${i}-${n}-${Math.floor(r*10)}`}cleanupCache(){let e=Date.now();e-this.lastCacheCleanup<1e4||(this.lastCacheCleanup=e,this.gradientCache.clear(),this.config.enableDebug&&u?.debug?.log("DynamicGradientStrategy","Cache cleanup completed"))}createLivingGradient(e=[]){let i=this.livingBaseState.currentPrimaryRgb,a=this.livingBaseState.currentBaseRgb,n=performance.now()/4e3*Math.PI*2,s=this.createGradientCacheKey(i,a,e,n),o=this.gradientCache.get(s);if(o)return this.cleanupCache(),o;let c=this.generateLivingGradient(i,a,e);return this.gradientCache.set(s,c),c}generateLivingGradient(e,i,a){return this.gradientConfig.oklabInterpolationEnabled&&a.length>0?`
        radial-gradient(
          ellipse at calc(50% + var(--visualEffects-flow-x)) calc(50% + var(--visualEffects-flow-y)),
          ${a.map((n,s)=>{let o=s/(a.length-1)*100,c=`${n.enhancedRgb.r},${n.enhancedRgb.g},${n.enhancedRgb.b}`,m=.6*(1-s/a.length)+.1;return`rgba(${c}, calc(var(--visualEffects-layer-opacity) * ${m})) ${o}%`}).join(", ")}
        ),
        linear-gradient(
          135deg,
          rgba(${a[0]?.enhancedRgb.r||e.split(",")[0]},${a[0]?.enhancedRgb.g||e.split(",")[1]},${a[0]?.enhancedRgb.b||e.split(",")[2]}, calc(var(--visualEffects-layer-opacity) * 0.4)) 0%,
          var(--spice-base) 50%,
          rgba(${a[a.length-1]?.enhancedRgb.r||e.split(",")[0]},${a[a.length-1]?.enhancedRgb.g||e.split(",")[1]},${a[a.length-1]?.enhancedRgb.b||e.split(",")[2]}, calc(var(--visualEffects-layer-opacity) * 0.2)) 100%
        ),
        var(--spice-base)
      `:`
      radial-gradient(
        ellipse at calc(50% + var(--visualEffects-flow-x)) calc(50% + var(--visualEffects-flow-y)),
        rgba(${e}, calc(var(--visualEffects-layer-opacity) * 0.6)) 0%,
        rgba(${e}, calc(var(--visualEffects-layer-opacity) * 0.3)) 30%,
        rgba(${i}, calc(var(--visualEffects-layer-opacity) * 0.1)) 60%,
        var(--spice-base) 100%
      ),
      linear-gradient(
        135deg,
        rgba(${e}, calc(var(--visualEffects-layer-opacity) * 0.4)) 0%,
        var(--spice-base) 50%,
        rgba(${e}, calc(var(--visualEffects-layer-opacity) * 0.2)) 100%
      ),
      var(--spice-base)
    `}updateBreathingAnimation(){this.triggerConsciousnessBreathing()}startBreathingAnimation(){this.triggerConsciousnessBreathing(),u?.debug?.log("DynamicGradientStrategy","CSS-first visualEffects animation started - 90%+ JavaScript overhead eliminated")}scheduleDebouncedCssUpdate(){u?.debug?.log("DynamicGradientStrategy","Debounced CSS updates eliminated - using CSS-first animation")}async updateWebGLIntegration(){if(!this.gradientConfig.webglIntegrationEnabled)return;let e={"--sn-bg-gradient-primary-rgb":this.livingBaseState.currentPrimaryRgb,"--sn-webgl-living-gradient-sync":"1","--sn-gradient-visualEffects-level":this.livingBaseState.visualEffectsIntensity.toString()};await this.cssController.batchSetVariables("DynamicGradientStrategy",e,"high","webgl-living-gradient-integration"),this.livingBaseState.webglIntegrationActive=!0,u?.debug?.log("DynamicGradientStrategy","WebGL integration updated")}getDynamicGradientState(){return{...this.livingBaseState}}updateLivingConsciousnessBase(){this.applyLivingConsciousnessBase().catch(i=>{u?.debug?.error("DynamicGradientStrategy","Failed to update living visualEffects base:",i)});let e=new CustomEvent("living-base-update",{detail:{baseHex:this.livingBaseState.currentBaseHex,primaryHex:this.livingBaseState.currentPrimaryHex,visualEffectsIntensity:this.livingBaseState.visualEffectsIntensity,timestamp:Date.now()}});document.dispatchEvent(e)}updateMusicResponsiveVariables(){let e={"--visualEffects-music-energy":this.livingBaseState.musicEnergy.toString(),"--visualEffects-music-intensity":this.livingBaseState.visualEffectsIntensity.toString()};try{this.cssController.batchSetVariables("DynamicGradientStrategy",e,3,"music-responsive")}catch(i){u?.debug?.error("DynamicGradientStrategy","Failed to update music responsive variables:",i)}}updateConsciousnessVariables(){let e={"--visualEffects-intensity-global":this.livingBaseState.visualEffectsIntensity.toString(),"--visualEffects-layer-opacity":(this.gradientConfig.visualEffectsLayerOpacity*this.livingBaseState.visualEffectsIntensity).toString()};try{this.cssController.batchSetVariables("DynamicGradientStrategy",e,3,"visualEffects-vars")}catch(i){u?.debug?.error("DynamicGradientStrategy","Failed to update visualEffects variables:",i)}}coordinateWithWebGLSystem(e){let i=e?{"--visualEffects-webgl-coordination":"0.7","--visualEffects-css-fallback":"0.3"}:{"--visualEffects-webgl-coordination":"0","--visualEffects-css-fallback":"1.0"};try{this.cssController.batchSetVariables("DynamicGradientStrategy",i,"high","webgl-coordination")}catch(a){u?.debug?.error("DynamicGradientStrategy","Failed to coordinate with WebGL system:",a)}u?.debug?.log("DynamicGradientStrategy",`WebGL coordination ${e?"enabled":"disabled"}`)}coordinateWithWebGLGradient(e){this.gradientConfig.webglIntegrationEnabled&&(e.flowState&&this.updateFlowStateFromWebGL(e.flowState),e.colorState&&this.updateColorStateFromWebGL(e.colorState))}updateFlowStateFromWebGL(e){let i={};if(e.flowX!==void 0&&(i["--visualEffects-webgl-flow-x"]=`${e.flowX}%`),e.flowY!==void 0&&(i["--visualEffects-webgl-flow-y"]=`${e.flowY}%`),e.flowScale!==void 0&&(i["--visualEffects-webgl-scale"]=e.flowScale.toString()),Object.keys(i).length>0)try{this.cssController.batchSetVariables("DynamicGradientStrategy",i,3,"webgl-flow")}catch(a){u?.debug?.error("DynamicGradientStrategy","Failed to update WebGL flow state:",a)}}updateColorStateFromWebGL(e){e.primaryColor&&(this.livingBaseState.currentPrimaryRgb=e.primaryColor,this.updateLivingConsciousnessBase())}async healthCheck(){let e=await this.getStrategyHealthCheck();return{healthy:e.healthy&&this.isActive,canProcess:e.canProcess,issues:e.issues||[],metrics:{...e.metrics,systemType:"consolidated-living-gradient",isVisualSystem:!0,isColorProcessor:!0,isActive:this.isActive,initialized:this.initialized}}}async getStrategyHealthCheck(){let e=Date.now()-this.livingBaseState.lastUpdateTime<3e4;return{healthy:this.gradientConfig.baseTransformationEnabled,canProcess:this.gradientConfig.baseTransformationEnabled,issues:this.gradientConfig.baseTransformationEnabled?[]:["Base transformation disabled in configuration"],metrics:{baseTransformationEnabled:this.gradientConfig.baseTransformationEnabled,responsiveAnimationEnabled:this.gradientConfig.responsiveAnimationEnabled,webglIntegrationActive:this.livingBaseState.webglIntegrationActive,visualEffectsIntensity:this.livingBaseState.visualEffectsIntensity,musicEnergy:this.livingBaseState.musicEnergy,hasRecentUpdate:e,cssFirstBreathing:!0,oklabInterpolation:this.gradientConfig.oklabInterpolationEnabled,oklabPreset:this.gradientConfig.oklabPreset,gradientSmoothness:this.gradientConfig.gradientSmoothness,oklabGradientStops:this.livingBaseState.oklabGradientStops.length}}}destroy(){this.cssAnimationManager&&this.cssAnimationManager.stopConsciousnessBreathing(),this.oklabCache.clear(),this.gradientCache.clear(),super.destroy(),u?.debug?.log("DynamicGradientStrategy","Consolidated living gradient system destroyed with complete cleanup")}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),u?.debug?.log("DynamicGradientStrategy","Living gradient system cleaned up")}updateConfig(e){this.gradientConfig={...this.gradientConfig,...e},("oklabInterpolationEnabled"in e||"oklabPreset"in e)&&(this.oklabProcessor=new E(this.config.enableDebug)),u?.debug?.log("DynamicGradientStrategy","Configuration updated:",{...e,oklabInterpolation:this.gradientConfig.oklabInterpolationEnabled,oklabPreset:this.gradientConfig.oklabPreset,gradientSmoothness:this.gradientConfig.gradientSmoothness})}stopBreathingAnimation(){this.cssAnimationManager&&this.cssAnimationManager.stopConsciousnessBreathing(),u?.debug?.log("DynamicGradientStrategy","CSS-first visualEffects animation stopped")}}});var Al,It,hs=y(()=>{"use strict";G();U();oe();A();Se();ie();Tt();Z();pt();Al=`#version 300 es
precision mediump float;

uniform float u_time;
uniform sampler2D u_gradientTex;
uniform vec2 u_resolution;
uniform float u_flowStrength;
uniform float u_noiseScale;

// Wave stack uniforms
uniform float u_waveY[2];
uniform float u_waveHeight[2];
uniform float u_waveOffset[2];
uniform float u_blurExp;
uniform float u_blurMax;

out vec4 fragColor;

// Simplex noise implementation
vec3 mod289(vec3 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec2 mod289(vec2 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec3 permute(vec3 x) {
  return mod289(((x*34.0)+1.0)*x);
}

float snoise(vec2 v) {
  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0
                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)
                     -0.577350269189626,  // -1.0 + 2.0 * C.x
                      0.024390243902439); // 1.0 / 41.0
  vec2 i  = floor(v + dot(v, C.yy) );
  vec2 x0 = v -   i + dot(i, C.xx);

  vec2 i1;
  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
  vec4 x12 = x0.xyxy + C.xxzz;
  x12.xy -= i1;

  i = mod289(i);
  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))
    + i.x + vec3(0.0, i1.x, 1.0 ));

  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
  m = m*m ;
  m = m*m ;

  vec3 x = 2.0 * fract(p * C.www) - 1.0;
  vec3 h = abs(x) - 0.5;
  vec3 ox = floor(x + 0.5);
  vec3 a0 = x - ox;

  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );

  vec3 g;
  g.x  = a0.x  * x0.x  + h.x  * x0.y;
  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
  return 130.0 * dot(m, g);
}

// Octave noise for richer detail
float octaveNoise(vec2 uv, float octaves, float persistence, float scale) {
  float value = 0.0;
  float amplitude = 1.0;
  float frequency = scale;
  float maxValue = 0.0;

  for(float i = 0.0; i < octaves; i++) {
    value += snoise(uv * frequency) * amplitude;
    maxValue += amplitude;
    amplitude *= persistence;
    frequency *= 2.0;
  }

  return value / maxValue;
}

// Wave alpha calculation with smooth transitions
float wave_alpha(vec2 uv, int waveIndex) {
  float y = uv.y;
  float waveCenter = u_waveY[waveIndex];
  float waveHeight = u_waveHeight[waveIndex];

  float distance = abs(y - waveCenter);
  float alpha = 1.0 - smoothstep(0.0, waveHeight * 0.5, distance);

  return alpha;
}

// Dynamic blur calculation using power function
float calc_blur(vec2 uv) {
  vec2 center = vec2(0.5, 0.5);
  float distance = length(uv - center);

  float blur = pow(distance, u_blurExp);
  blur = clamp(blur, 0.0, u_blurMax);

  return blur;
}

// Background noise generator with time offset
float background_noise(vec2 uv, float timeOffset) {
  vec2 flowUV = uv;
  float adjustedTime = u_time + timeOffset;

  flowUV.x += adjustedTime * 0.02 * u_flowStrength;
  flowUV.y += sin(adjustedTime * 0.03 + uv.x * 3.14159) * 0.01 * u_flowStrength;

  float noise1 = octaveNoise(flowUV * u_noiseScale, 4.0, 0.5, 1.0);
  float noise2 = octaveNoise(flowUV * u_noiseScale * 2.0 + vec2(100.0), 3.0, 0.4, 1.0);

  return (noise1 + noise2 * 0.3) * 0.5 + 0.5;
}

void main() {
  vec2 uv = gl_FragCoord.xy / u_resolution.xy;

  // Generate three distinct background noise fields with time offsets
  float noise1 = background_noise(uv, u_waveOffset[0]);
  float noise2 = background_noise(uv, u_waveOffset[1]);
  float noise3 = background_noise(uv, 0.0); // Base noise without offset

  // Calculate wave alphas for blending
  float alpha1 = wave_alpha(uv, 0);
  float alpha2 = wave_alpha(uv, 1);
  float alpha3 = 1.0 - alpha1 - alpha2; // Remaining area
  alpha3 = max(alpha3, 0.0); // Ensure non-negative

  // Normalize alphas to ensure they sum to 1.0
  float totalAlpha = alpha1 + alpha2 + alpha3;
  if (totalAlpha > 0.0) {
    alpha1 /= totalAlpha;
    alpha2 /= totalAlpha;
    alpha3 /= totalAlpha;
  }

  // Blend the three noise fields based on wave alphas
  float t = noise1 * alpha1 + noise2 * alpha2 + noise3 * alpha3;
  t = clamp(t, 0.0, 1.0);

  // Sample gradient texture
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));

  // Apply dynamic blur based on position
  float blurAmount = calc_blur(uv);

  // Apply subtle vignette with blur modulation
  vec2 center = uv - 0.5;
  float vignette = 1.0 - dot(center, center) * (0.3 + blurAmount * 0.2);
  color.rgb *= vignette;

  // Apply blur effect to alpha channel for depth
  color.a *= (1.0 - blurAmount * 0.3);

  fragColor = color;
}`,It=class{constructor(t){this.utils=D;this.config=M;this.webglState={canvas:null,wrapper:null,gl:null,shaderProgram:null,gradientTexture:null,vertexBuffer:null,vao:null,isWebGLAvailable:!1,webglReady:!1,animationId:null,startTime:0,lastFrameTime:0,lastUpdateTime:0,currentFlowStrength:.3,targetFlowStrength:.3,currentNoiseScale:1,targetNoiseScale:1,currentBlurExp:1.2,targetBlurExp:1.2,currentBlurMax:.5,targetBlurMax:.5,currentWaveY:[.3,.7],targetWaveY:[.3,.7],currentWaveHeight:[.4,.3],targetWaveHeight:[.4,.3],currentWaveOffset:[.1,.6],targetWaveOffset:[.1,.6]};this.uniforms={u_time:null,u_gradientTex:null,u_resolution:null,u_flowStrength:null,u_noiseScale:null,u_waveY:null,u_waveHeight:null,u_waveOffset:null,u_blurExp:null,u_blurMax:null};this.flowSettings={enabled:!0,intensity:"balanced",flowStrength:.7,noiseScale:1.2,waveY:[.25,.75],waveHeight:[.4,.3],waveOffset:[2.5,-1.8],blurExp:1.2,blurMax:.6,frameThrottleInterval:1e3/45,oklabProcessingEnabled:!0,oklabPreset:"VIBRANT",gradientTextureSize:512};this.prefersReducedMotion=!1;this.animateWebGL=()=>{if(!this.webglState.webglReady||!this.webglState.gl||!this.webglState.canvas)return;let t=performance.now();if(t-this.webglState.lastFrameTime<this.flowSettings.frameThrottleInterval){this.webglState.animationId=requestAnimationFrame(this.animateWebGL);return}this.webglState.lastFrameTime=t,this.renderWebGLFrame(t),this.webglState.animationId=requestAnimationFrame(this.animateWebGL)};this.lerpHalfLifeValues={flowStrength:.25,noiseScale:.3,blur:.2,wave:.35};this.resizeWebGLCanvas=()=>{if(!this.webglState.canvas)return;let t=window.devicePixelRatio||1,e=window.innerWidth,i=window.innerHeight;this.webglState.canvas.width=e*t,this.webglState.canvas.height=i*t,this.webglState.canvas.style.width=e+"px",this.webglState.canvas.style.height=i+"px"};this.deviceDetector=new O,this.cssController=t||P(),this.oklabProcessor=new E(this.config.enableDebug),this.cssController=P(),this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.webglState.isWebGLAvailable=this.checkWebGL2Support(),this.loadFlowSettings(),u?.debug?.log("WebGLGradientStrategy","\u{1F30A} WebGL gradient strategy initialized - Flow Gradient Recovery Debug",{webglAvailable:this.webglState.isWebGLAvailable,deviceCapability:this.deviceDetector.recommendPerformanceQuality(),oklabProcessing:this.flowSettings.oklabProcessingEnabled,flowSettings:{enabled:this.flowSettings.enabled,intensity:this.flowSettings.intensity,flowStrength:this.flowSettings.flowStrength,noiseScale:this.flowSettings.noiseScale},prefersReducedMotion:this.prefersReducedMotion,webgl2ContextTest:this.checkWebGL2Support()})}getStrategyName(){return"webgl-gradient"}canProcess(t){return u?.debug?.log("WebGLGradientStrategy","\u{1F50D} canProcess() - WebGL Gradient Capability Check",{isWebGLAvailable:this.webglState.isWebGLAvailable,flowSettingsEnabled:this.flowSettings.enabled,webglReady:this.webglState.webglReady,contextTrackUri:t.trackUri,contextColorCount:Object.keys(t.rawColors).length}),this.webglState.isWebGLAvailable?this.flowSettings.enabled?x.get("sn-webgl-enabled")?(u?.debug?.log("WebGLGradientStrategy","canProcess: WebGL force enabled - bypassing device restrictions"),!0):(this.deviceDetector.recommendPerformanceQuality()==="low"&&u?.debug?.log("WebGLGradientStrategy","canProcess: Low performance device detected, allowing based on strategy selection (not force mode)"),!0):(u?.debug?.warn("WebGLGradientStrategy","\u274C canProcess: WebGL strategy disabled in settings"),!1):(u?.debug?.warn("WebGLGradientStrategy","\u274C canProcess: WebGL not available - failed WebGL2 context check"),!1)}getEstimatedProcessingTime(t){let i=this.flowSettings.intensity==="intense"?1.3:1;return Math.round(12*i)}async processColors(t){let e=performance.now(),i={};try{this.webglState.webglReady||await this.initializeWebGLGradient();let a=t.rawColors;if(this.flowSettings.oklabProcessingEnabled){let c=E.getPreset(this.flowSettings.oklabPreset);i=this.oklabProcessor.processColorPalette(t.rawColors,c),a=Object.fromEntries(Object.entries(i).map(([m,d])=>[m,d.enhancedHex])),u?.debug?.log("WebGLGradientStrategy","OKLAB color enhancement applied:",{originalColors:Object.keys(t.rawColors).length,processedColors:Object.keys(a).length,preset:c.name})}let r=this.createGradientStops(a,i);await this.updateGradientTexture(r),await this.enableHybridCoordination(),this.webglState.animationId||this.startWebGLAnimation(),t.musicData?.energy!==void 0&&await this.updateFlowWithMusicEnergy(t.musicData.energy),this.webglState.lastUpdateTime=Date.now();let n=performance.now()-e,s=this.selectPrimaryColor(a)||K.getDefaultAccentColor().hex,o={processedColors:{webgl:"active",gradientStops:r.length.toString(),...a,...Object.keys(t.rawColors).length>0&&{originalColors:JSON.stringify(t.rawColors)}},accentHex:s,accentRgb:this.convertToRgbString(s),metadata:{strategy:this.getStrategyName(),processingTime:n,cacheKey:`webgl-gradient-${t.trackUri}`,harmonicIntensity:this.flowSettings.flowStrength,webglReady:this.webglState.webglReady,oklabProcessing:this.flowSettings.oklabProcessingEnabled,oklabPreset:this.flowSettings.oklabPreset,gradientTextureSize:this.flowSettings.gradientTextureSize,oklabResultsCount:Object.keys(i).length},context:t};return u?.debug?.log("WebGLGradientStrategy","WebGL gradient processing completed",{gradientStops:r.length,processingTime:n,trackUri:t.trackUri}),o}catch(a){let r=performance.now()-e;u?.debug?.error("WebGLGradientStrategy","WebGL gradient processing failed:",a);let n=await this.executeProgressiveFallback(t,a);return{...n,metadata:{...n.metadata,strategy:this.getStrategyName(),processingTime:r,error:a instanceof Error?a.message:"Unknown error"},context:t}}}checkWebGL2Support(){return document.createElement("canvas").getContext("webgl2")!==null}loadFlowSettings(){try{let t=x.get("sn-gradient-intensity");if(t==="disabled"){this.flowSettings.enabled=!1;return}switch(this.flowSettings.intensity=t||"balanced",this.flowSettings.intensity){case"minimal":this.flowSettings.flowStrength=.4,this.flowSettings.noiseScale=.8,this.flowSettings.waveHeight=[.3,.2],this.flowSettings.waveOffset=[1.5,-1],this.flowSettings.blurExp=1,this.flowSettings.blurMax=.4;break;case"balanced":this.flowSettings.flowStrength=.7,this.flowSettings.noiseScale=1.2,this.flowSettings.waveHeight=[.4,.3],this.flowSettings.waveOffset=[2.5,-1.8],this.flowSettings.blurExp=1.2,this.flowSettings.blurMax=.6;break;case"intense":this.flowSettings.flowStrength=1,this.flowSettings.noiseScale=1.6,this.flowSettings.waveHeight=[.5,.4],this.flowSettings.waveOffset=[3.5,-2.5],this.flowSettings.blurExp=1.4,this.flowSettings.blurMax=.8;break}}catch(t){u?.debug?.warn("WebGLGradientStrategy","Failed to load settings, using defaults:",t)}}async initializeWebGLGradient(){if(!this.webglState.isWebGLAvailable)throw new Error("WebGL2 not available");await this.createWebGLCanvas(),await this.initializeWebGLContext(),await this.compileWebGLShaders(),this.createWebGLGeometry(),this.setupWebGLUniforms(),this.resizeWebGLCanvas(),this.attachWebGLToDom(),window.addEventListener("resize",this.resizeWebGLCanvas.bind(this)),this.webglState.webglReady=!0;try{let t=P();t.setPerformanceTokens({webglReady:!0,activeBackend:"webgl-strategy",qualityLevel:"high",gpuAcceleration:!0}),u?.debug?.log("WebGLGradientStrategy","\u{1F3A8} WebGL readiness announced to CSS visual effects system - CSS Variables Set",{webglReady:!0,activeBackend:"webgl-strategy",qualityLevel:"high",gpuAcceleration:!0,cssControllerReady:!!t})}catch(t){u?.debug?.warn("WebGLGradientStrategy","\u274C Failed to announce WebGL readiness - CSS Variables NOT Set:",t)}u?.debug?.log("WebGLGradientStrategy","WebGL gradient system initialized successfully")}async createWebGLCanvas(){u?.debug?.log("WebGLGradientStrategy","\u{1F3A8} Creating WebGL canvas and wrapper elements"),this.webglState.wrapper=document.createElement("div"),this.webglState.wrapper.className="sn-webgl-gradient-wrapper",this.webglState.wrapper.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -11;
      pointer-events: none;
      overflow: hidden;
    `,this.webglState.canvas=document.createElement("canvas"),this.webglState.canvas.id="sn-webgl-gradient-strategy",this.webglState.canvas.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    `,this.webglState.wrapper.appendChild(this.webglState.canvas),u?.debug?.log("WebGLGradientStrategy","\u2705 WebGL canvas and wrapper created successfully",{wrapperId:this.webglState.wrapper.className,canvasId:this.webglState.canvas.id,wrapperStyle:this.webglState.wrapper.style.cssText.replace(/\s+/g," ").trim()})}async initializeWebGLContext(){if(!this.webglState.canvas)throw new Error("Canvas not created");if(this.webglState.gl=this.webglState.canvas.getContext("webgl2",{alpha:!0,antialias:!1,depth:!1,stencil:!1,powerPreference:"default"}),!this.webglState.gl)throw new Error("Failed to get WebGL2 context")}async compileWebGLShaders(){if(!this.webglState.gl)throw new Error("WebGL context not available");let t=Q.loadVertex(this.webglState.gl,xt),e=Q.loadFragment(this.webglState.gl,Al);if(!t||!e)throw new Error("Failed to compile shaders");if(this.webglState.shaderProgram=Q.createProgram(this.webglState.gl,t,e),!this.webglState.shaderProgram)throw new Error("Failed to create shader program")}createWebGLGeometry(){if(!this.webglState.gl||!this.webglState.shaderProgram)return;let t=new Float32Array([-1,-1,3,-1,-1,3]);this.webglState.vertexBuffer=this.webglState.gl.createBuffer(),this.webglState.gl.bindBuffer(this.webglState.gl.ARRAY_BUFFER,this.webglState.vertexBuffer),this.webglState.gl.bufferData(this.webglState.gl.ARRAY_BUFFER,t,this.webglState.gl.STATIC_DRAW),this.webglState.vao=this.webglState.gl.createVertexArray(),this.webglState.gl.bindVertexArray(this.webglState.vao);let e=this.webglState.gl.getAttribLocation(this.webglState.shaderProgram,"a_position");this.webglState.gl.enableVertexAttribArray(e),this.webglState.gl.vertexAttribPointer(e,2,this.webglState.gl.FLOAT,!1,0,0),this.webglState.gl.bindVertexArray(null)}setupWebGLUniforms(){!this.webglState.gl||!this.webglState.shaderProgram||(this.uniforms.u_time=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_time"),this.uniforms.u_gradientTex=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_gradientTex"),this.uniforms.u_resolution=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_resolution"),this.uniforms.u_flowStrength=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_flowStrength"),this.uniforms.u_noiseScale=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_noiseScale"),this.uniforms.u_waveY=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_waveY"),this.uniforms.u_waveHeight=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_waveHeight"),this.uniforms.u_waveOffset=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_waveOffset"),this.uniforms.u_blurExp=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_blurExp"),this.uniforms.u_blurMax=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_blurMax"))}createGradientStops(t,e={}){let i=["PRIMARY","VIBRANT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT","DARK_VIBRANT","PROMINENT"],a=[],r=new Set,n=0;for(let s of i){let o=t[s];if(o&&!r.has(o)){let c=e[s],m=c?c.enhancedHex:o,d=this.utils.hexToRgb(m);if(d&&(a.push({r:d.r/255,g:d.g/255,b:d.b/255,a:1,position:n/(Math.min(i.length,4)-1),...c&&{oklabOriginal:c.originalHex,oklabEnhanced:c.enhancedHex}}),r.add(o),n++,a.length>=4))break}}return a.length===0?this.getDefaultGradientStops():a}getDefaultGradientStops(){return[{r:.196,g:.165,b:.282,a:1,position:0},{r:.549,g:.408,b:.878,a:1,position:.3},{r:.788,g:.557,b:.902,a:1,position:.6},{r:.957,g:.761,b:.494,a:1,position:1}]}async updateGradientTexture(t){if(this.webglState.gl){if(this.webglState.gradientTexture&&this.webglState.gl.deleteTexture(this.webglState.gradientTexture),this.webglState.gradientTexture=le(this.webglState.gl,t),!this.webglState.gradientTexture)throw new Error("Failed to create gradient texture");await this.updateCSSFallbackVariables(t)}}async updateCSSFallbackVariables(t){let e=Math.min(8,t.length),i={"--sn-grad-stop-count":String(e)};for(let a=0;a<e;a++){let r=t[a];r&&(i[`--sn-grad-stop-${a}-rgb`]=`${Math.round(r.r*255)},${Math.round(r.g*255)},${Math.round(r.b*255)}`)}await this.cssController.batchSetVariables("WebGLGradientStrategy",i,"normal","gradient-stops-configuration")}async enableHybridCoordination(){let t={"--sn-webgl-ready":"1","--sn-webgl-enabled":"1","--sn-current-backend":"hybrid","--sn-gradient-crossfade-opacity":"0.5"};u?.debug?.log("WebGLGradientStrategy","\u{1F517} Setting hybrid coordination CSS variables - WebGL Gradient Activation",{variables:t,cssControllerReady:!!this.cssController}),await this.cssController.batchSetVariables("WebGLGradientStrategy",t,"high","hybrid-coordination-enable"),u?.debug?.log("WebGLGradientStrategy","\u2705 Hybrid coordination CSS variables set successfully")}startWebGLAnimation(){this.webglState.startTime=performance.now(),this.webglState.lastFrameTime=this.webglState.startTime,this.animateWebGL()}updateUniformsWithLERP(t){this.webglState.targetFlowStrength=this.flowSettings.flowStrength,this.webglState.targetNoiseScale=this.flowSettings.noiseScale,this.webglState.targetBlurExp=this.flowSettings.blurExp,this.webglState.targetBlurMax=this.flowSettings.blurMax,this.webglState.targetWaveY=[this.flowSettings.waveY[0],this.flowSettings.waveY[1]],this.webglState.targetWaveHeight=[this.flowSettings.waveHeight[0],this.flowSettings.waveHeight[1]],this.webglState.targetWaveOffset=[this.flowSettings.waveOffset[0],this.flowSettings.waveOffset[1]],this.webglState.currentFlowStrength=R(this.webglState.currentFlowStrength,this.webglState.targetFlowStrength,t,this.lerpHalfLifeValues.flowStrength),this.webglState.currentNoiseScale=R(this.webglState.currentNoiseScale,this.webglState.targetNoiseScale,t,this.lerpHalfLifeValues.noiseScale),this.webglState.currentBlurExp=R(this.webglState.currentBlurExp,this.webglState.targetBlurExp,t,this.lerpHalfLifeValues.blur),this.webglState.currentBlurMax=R(this.webglState.currentBlurMax,this.webglState.targetBlurMax,t,this.lerpHalfLifeValues.blur);let e=0,i=1;this.webglState.currentWaveY[e]=R(this.webglState.currentWaveY[e],this.webglState.targetWaveY[e],t,this.lerpHalfLifeValues.wave),this.webglState.currentWaveY[i]=R(this.webglState.currentWaveY[i],this.webglState.targetWaveY[i],t,this.lerpHalfLifeValues.wave),this.webglState.currentWaveHeight[e]=R(this.webglState.currentWaveHeight[e],this.webglState.targetWaveHeight[e],t,this.lerpHalfLifeValues.wave),this.webglState.currentWaveHeight[i]=R(this.webglState.currentWaveHeight[i],this.webglState.targetWaveHeight[i],t,this.lerpHalfLifeValues.wave),this.webglState.currentWaveOffset[e]=R(this.webglState.currentWaveOffset[e],this.webglState.targetWaveOffset[e],t,this.lerpHalfLifeValues.wave),this.webglState.currentWaveOffset[i]=R(this.webglState.currentWaveOffset[i],this.webglState.targetWaveOffset[i],t,this.lerpHalfLifeValues.wave)}renderWebGLFrame(t){if(!this.webglState.gl||!this.webglState.shaderProgram||!this.webglState.vao||!this.webglState.gradientTexture)return;let e=(t-this.webglState.lastFrameTime)/1e3;this.updateUniformsWithLERP(e),this.webglState.gl.viewport(0,0,this.webglState.canvas.width,this.webglState.canvas.height),this.webglState.gl.clearColor(0,0,0,0),this.webglState.gl.clear(this.webglState.gl.COLOR_BUFFER_BIT),this.webglState.gl.useProgram(this.webglState.shaderProgram),this.webglState.gl.bindVertexArray(this.webglState.vao);let i=this.prefersReducedMotion?0:(t-this.webglState.startTime)/1e3;this.uniforms.u_time&&this.webglState.gl.uniform1f(this.uniforms.u_time,i),this.uniforms.u_resolution&&this.webglState.gl.uniform2f(this.uniforms.u_resolution,this.webglState.canvas.width,this.webglState.canvas.height),this.uniforms.u_flowStrength&&this.webglState.gl.uniform1f(this.uniforms.u_flowStrength,this.webglState.currentFlowStrength),this.uniforms.u_noiseScale&&this.webglState.gl.uniform1f(this.uniforms.u_noiseScale,this.webglState.currentNoiseScale),this.uniforms.u_waveY&&this.webglState.gl.uniform1fv(this.uniforms.u_waveY,this.webglState.currentWaveY),this.uniforms.u_waveHeight&&this.webglState.gl.uniform1fv(this.uniforms.u_waveHeight,this.webglState.currentWaveHeight),this.uniforms.u_waveOffset&&this.webglState.gl.uniform1fv(this.uniforms.u_waveOffset,this.webglState.currentWaveOffset),this.uniforms.u_blurExp&&this.webglState.gl.uniform1f(this.uniforms.u_blurExp,this.webglState.currentBlurExp),this.uniforms.u_blurMax&&this.webglState.gl.uniform1f(this.uniforms.u_blurMax,this.webglState.currentBlurMax),this.webglState.gl.activeTexture(this.webglState.gl.TEXTURE0),this.webglState.gl.bindTexture(this.webglState.gl.TEXTURE_2D,this.webglState.gradientTexture),this.uniforms.u_gradientTex&&this.webglState.gl.uniform1i(this.uniforms.u_gradientTex,0),this.webglState.gl.drawArrays(this.webglState.gl.TRIANGLES,0,3),this.webglState.gl.bindVertexArray(null)}async updateFlowWithMusicEnergy(t){let e=this.flowSettings.flowStrength,i=1+t*.5,a=e*i;await this.cssController.setVariable("WebGLGradientStrategy","--sn-flow-strength",a.toString(),"high","music-energy-flow-strength")}attachWebGLToDom(){if(!this.webglState.wrapper){u?.debug?.error("WebGLGradientStrategy","\u274C Cannot attach to DOM - wrapper element not created");return}u?.debug?.log("WebGLGradientStrategy","\u{1F517} Attaching WebGL canvas to DOM - Searching for container");let t=[".Root__main-view",".main-view-container",".main-gridContainer-gridContainer",".Root__top-container","body"],e=null,i=[];for(let a of t)if(e=document.querySelector(a),i.push({selector:a,found:!!e}),e)break;e||(e=document.body),e.appendChild(this.webglState.wrapper),u?.debug?.log("WebGLGradientStrategy","\u2705 WebGL canvas attached to DOM successfully",{containerSearch:i,selectedContainer:e?.tagName||"unknown",containerClass:e?.className||"none",wrapperId:this.webglState.wrapper.className,canvasId:this.webglState.canvas?.id||"not-created"})}async executeProgressiveFallback(t,e){let i=this.selectPrimaryColor(t.rawColors)||K.getDefaultAccentColor().hex;try{return u?.debug?.warn("WebGLGradientStrategy","Attempting CSS gradient fallback"),await this.fallbackToCSSGradient(),{processedColors:{...t.rawColors,fallbackMethod:"css-gradient"},accentHex:i,accentRgb:this.convertToRgbString(i),metadata:{strategy:this.getStrategyName(),processingTime:0,fallbackMode:"css-gradient",fallbackReason:"webgl-failed",gradientStops:Object.keys(t.rawColors).length},context:t}}catch(a){return u?.debug?.error("WebGLGradientStrategy","CSS gradient fallback failed, using solid color:",a),await this.fallbackToSolidColor(t,i,e,a)}}async fallbackToSolidColor(t,e,i,a){try{return await this.cssController?.queueUpdate("--sn-accent-color",e,"critical","solid-color-fallback"),{processedColors:{accentColor:e,fallbackMethod:"solid-color",originalColors:JSON.stringify(t.rawColors)},accentHex:e,accentRgb:this.convertToRgbString(e),metadata:{strategy:this.getStrategyName(),processingTime:0,fallbackMode:"solid-color",fallbackReason:"all-gradients-failed",webglError:i instanceof Error?i.message:"Unknown WebGL error",cssError:a instanceof Error?a.message:"Unknown CSS error",emergencyMode:!0},context:t}}catch(r){return u?.debug?.error("WebGLGradientStrategy","All fallback methods failed, using emergency mode:",r),{processedColors:{emergencyMode:"true"},accentHex:"#ff6b9d",accentRgb:"rgb(255, 107, 157)",metadata:{strategy:this.getStrategyName(),processingTime:0,fallbackMode:"emergency",fallbackReason:"complete-system-failure",criticalError:!0},context:t}}}async fallbackToCSSGradient(){let t={"--sn-webgl-ready":"0","--sn-webgl-enabled":"0","--sn-current-backend":"css","--sn-gradient-crossfade-opacity":"0"};await this.cssController.batchSetVariables("WebGLGradientStrategy",t,"critical","css-gradient-fallback"),this.cssController&&this.startCSSFallbackAnimation(),u?.debug?.log("WebGLGradientStrategy","Using CSS gradient fallback")}startCSSFallbackAnimation(){if(!this.cssController)return;let t=()=>{if(!this.webglState.webglReady)return;let e=performance.now()/1e3,i=Math.sin(e*.04)*20+Math.sin(e*.07)*8,a=Math.cos(e*.05)*20+Math.cos(e*.09)*6,r=1.15+Math.sin(e*.03)*.2;this.cssController.queueCSSVariableUpdate("--sn-gradient-flow-x",`${i}%`),this.cssController.queueCSSVariableUpdate("--sn-gradient-flow-y",`${a}%`),this.cssController.queueCSSVariableUpdate("--sn-gradient-flow-scale",r.toString()),setTimeout(t,this.flowSettings.frameThrottleInterval)};t()}selectPrimaryColor(t){let e=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let i of e){let a=t[i];if(a&&this.utils.hexToRgb(a))return a}return null}convertToRgbString(t){let e=this.utils.hexToRgb(t);return e?`${e.r},${e.g},${e.b}`:"203,166,247"}updateConfig(t){this.flowSettings={...this.flowSettings,...t},("oklabProcessingEnabled"in t||"oklabPreset"in t)&&(this.oklabProcessor=new E(this.config.enableDebug)),u?.debug?.log("WebGLGradientStrategy","Configuration updated:",{...t,oklabProcessing:this.flowSettings.oklabProcessingEnabled,oklabPreset:this.flowSettings.oklabPreset,gradientTextureSize:this.flowSettings.gradientTextureSize})}async healthCheck(){let t=Date.now()-this.webglState.lastUpdateTime<3e4;return{healthy:this.webglState.webglReady&&this.flowSettings.enabled,canProcess:this.canProcess({}),issues:this.webglState.webglReady?this.flowSettings.enabled?[]:["WebGL gradient disabled in settings"]:["WebGL system not ready"],metrics:{webglAvailable:this.webglState.isWebGLAvailable,webglReady:this.webglState.webglReady,flowEnabled:this.flowSettings.enabled,intensity:this.flowSettings.intensity,deviceCapability:this.deviceDetector.recommendPerformanceQuality(),hasRecentUpdate:t,animationActive:this.webglState.animationId!==null,oklabProcessing:this.flowSettings.oklabProcessingEnabled,oklabPreset:this.flowSettings.oklabPreset,gradientTextureSize:this.flowSettings.gradientTextureSize,canvasSize:this.webglState.canvas?{width:this.webglState.canvas.width,height:this.webglState.canvas.height}:null}}}destroy(){this.webglState.animationId&&(cancelAnimationFrame(this.webglState.animationId),this.webglState.animationId=null),this.webglState.gl&&(this.webglState.gradientTexture&&(this.webglState.gl.deleteTexture(this.webglState.gradientTexture),this.webglState.gradientTexture=null),this.webglState.vertexBuffer&&(this.webglState.gl.deleteBuffer(this.webglState.vertexBuffer),this.webglState.vertexBuffer=null),this.webglState.vao&&(this.webglState.gl.deleteVertexArray(this.webglState.vao),this.webglState.vao=null),this.webglState.shaderProgram&&(this.webglState.gl.deleteProgram(this.webglState.shaderProgram),this.webglState.shaderProgram=null),Q.clearCache(this.webglState.gl)),this.webglState.wrapper&&this.webglState.wrapper.parentNode&&(this.webglState.wrapper.parentNode.removeChild(this.webglState.wrapper),this.webglState.wrapper=null),this.webglState.canvas=null,this.webglState.gl=null,this.webglState.webglReady=!1,window.removeEventListener("resize",this.resizeWebGLCanvas);let t={"--sn-webgl-ready":"0","--sn-webgl-enabled":"0","--sn-current-backend":"css","--sn-gradient-crossfade-opacity":"0"};try{this.cssController.batchSetVariables("WebGLGradientStrategy",t,"critical","strategy-destroy-cleanup")}catch(e){u?.debug?.error("WebGLGradientStrategy","Error during destroy cleanup:",e)}u?.debug?.log("WebGLGradientStrategy","WebGL gradient strategy destroyed")}}});var Gi,gs=y(()=>{"use strict";oe();A();Se();us();ms();nr();hs();Gi=class{constructor(){this.strategyInstances=new Map;this.strategyMetadata=new Map;this.deviceDetector=new O,this.initializeStrategyMetadata(),u?.debug?.log("BackgroundStrategySelector","Strategy selector initialized")}initializeStrategyMetadata(){this.strategyMetadata.set("dynamic-catppuccin",{name:"dynamic-catppuccin",priority:10,estimatedProcessingTime:5,memoryImpact:2,qualityScore:9,compatibilityScore:10}),this.strategyMetadata.set("living-gradient",{name:"living-gradient",priority:8,estimatedProcessingTime:8,memoryImpact:3,qualityScore:8,compatibilityScore:9}),this.strategyMetadata.set("webgl-gradient",{name:"webgl-gradient",priority:6,estimatedProcessingTime:12,memoryImpact:7,qualityScore:10,compatibilityScore:6}),this.strategyMetadata.set("webgl-gradient-degraded",{name:"webgl-gradient-degraded",priority:5,estimatedProcessingTime:8,memoryImpact:4,qualityScore:6,compatibilityScore:8}),this.strategyMetadata.set("depth-layered",{name:"depth-layered",priority:7,estimatedProcessingTime:15,memoryImpact:5,qualityScore:9,compatibilityScore:7})}selectStrategies(t,e){let i=performance.now(),a=[];try{let r=e.deviceContext||this.buildDeviceContext(),n=e.settingsContext||this.buildSettingsContext();u?.debug?.log("BackgroundStrategySelector","\u{1F3AF} Strategy Selection Debug - WebGL Gradient Analysis",{trackUri:t.trackUri,colorCount:Object.keys(t.rawColors).length,deviceContext:{supportsWebGL:r.supportsWebGL,performanceLevel:r.performanceLevel,memoryCapacity:r.memoryCapacity,isMobile:r.isMobile},settingsContext:{webglEnabled:n.webglEnabled,webglForceEnabled:n.webglForceEnabled,gradientIntensity:n.gradientIntensity,visualEffectsLevel:n.visualEffectsLevel}});let s=this.analyzeStrategyCompatibility(t,{...e,deviceContext:r,settingsContext:n});for(let c of s)if(u?.debug?.log("BackgroundStrategySelector",`Strategy decision: ${c.strategyName}`,{shouldInclude:c.shouldInclude,reason:c.reason,score:c.score}),c.shouldInclude){let m=this.getOrCreateStrategy(c.strategyName);if(m){let d=m.canProcess(t);u?.debug?.log("BackgroundStrategySelector",`Strategy ${c.strategyName} canProcess check`,{canProcess:d,strategyName:c.strategyName,contextColors:Object.keys(t.rawColors).length}),d?(a.push(m),u?.debug?.log("BackgroundStrategySelector",`\u2705 Selected strategy: ${c.strategyName}`)):u?.debug?.warn("BackgroundStrategySelector",`\u274C Strategy rejected by canProcess(): ${c.strategyName}`)}else u?.debug?.error("BackgroundStrategySelector",`Failed to create strategy: ${c.strategyName}`)}if(a.length===0){let c=this.getOrCreateStrategy("living-gradient");c?.canProcess(t)&&a.push(c)}let o=performance.now()-i;return u?.debug?.log("BackgroundStrategySelector","\u{1F3AF} Strategy selection completed",{selectedCount:a.length,strategies:a.map(c=>c.getStrategyName()),processingTime:o,deviceLevel:r.performanceLevel,visualGuideMode:n.visualGuideMode,webglEnabled:n.webglEnabled,webglForceEnabled:n.webglForceEnabled,supportsWebGL:r.supportsWebGL,totalDecisions:s.length,includedDecisions:s.filter(c=>c.shouldInclude).length}),a}catch(r){u?.debug?.error("BackgroundStrategySelector","Strategy selection failed:",r);let n=this.getOrCreateStrategy("living-gradient");return n?[n]:[]}}analyzeStrategyCompatibility(t,e){let i=[],a=this.scoreDynamicCatppuccinStrategy(e);i.push({strategyName:"dynamic-catppuccin",shouldInclude:e.settingsContext.dynamicAccentEnabled&&a>.5,reason:e.settingsContext.dynamicAccentEnabled?`Dynamic accent enabled (score: ${a.toFixed(2)})`:"Dynamic accent disabled in settings",score:a});let r=this.scoreDynamicGradientStrategy(e);i.push({strategyName:"living-gradient",shouldInclude:r>.3,reason:`Living gradient foundation (score: ${r.toFixed(2)})`,score:r});let n=this.scoreWebGLGradientStrategy(e),s=this.scoreWebGLDegradedStrategy(e),o=e.settingsContext.webglEnabled&&e.deviceContext.supportsWebGL&&(e.deviceContext.performanceLevel!=="low"||e.settingsContext.webglForceEnabled)&&n>.6;i.push({strategyName:"webgl-gradient",shouldInclude:o,reason:`WebGL full quality (score: ${n.toFixed(2)}, device: ${e.deviceContext.performanceLevel}${e.settingsContext.webglForceEnabled?", FORCED":""})`,score:n}),i.push({strategyName:"webgl-gradient-degraded",shouldInclude:e.settingsContext.webglEnabled&&e.deviceContext.supportsWebGL&&e.deviceContext.performanceLevel==="low"&&!e.settingsContext.webglForceEnabled&&s>.4,reason:`WebGL degraded mode (score: ${s.toFixed(2)}, device: low${e.settingsContext.webglForceEnabled?", skipped due to force":""})`,score:s});let c=this.scoreDepthLayeredStrategy(e);return i.push({strategyName:"depth-layered",shouldInclude:e.settingsContext.depthLayersEnabled&&e.settingsContext.visualEffectsLevel>.4&&e.deviceContext.performanceLevel!=="low"&&c>.5,reason:`Depth visual effects (score: ${c.toFixed(2)}, visual-effects: ${e.settingsContext.visualEffectsLevel})`,score:c}),i}scoreDynamicCatppuccinStrategy(t){let e=.8;return t.settingsContext.dynamicAccentEnabled&&(e+=.2),t.musicContext?.energy&&t.musicContext.energy>.7&&(e+=.1),["cosmic","cinematic","ethereal","natural"].includes(t.settingsContext.visualGuideMode)&&(e+=.1),e+=.1,Math.min(1,e)}scoreDynamicGradientStrategy(t){let e=.9;return t.settingsContext.pulsingAnimationEnabled&&(e+=.1),e+=t.settingsContext.visualEffectsLevel*.2,t.musicContext?.valence!==void 0&&(e+=.05),t.deviceContext.performanceLevel==="high"&&(e+=.05),Math.min(1,e)}scoreWebGLGradientStrategy(t){let e=0;if(!t.deviceContext.supportsWebGL||!t.settingsContext.webglEnabled)return 0;switch(e=.6,t.settingsContext.webglForceEnabled&&(e+=.4,u?.debug?.log("BackgroundStrategySelector","WebGL force enabled - boosting score by 0.4")),t.deviceContext.performanceLevel){case"high":e+=.3;break;case"medium":e+=.2;break;case"low":if(!t.settingsContext.webglForceEnabled)return 0;e+=.1;break}return t.deviceContext.memoryCapacity>4e3&&(e+=.1),t.deviceContext.memoryCapacity>8e3&&(e+=.1),t.settingsContext.visualEffectsLevel>.7&&(e+=.1),t.musicContext?.energy&&t.musicContext.energy>.8&&(e+=.1),t.deviceContext.isMobile&&(e-=.2),Math.min(1,Math.max(0,e))}scoreWebGLDegradedStrategy(t){let e=0;return!t.deviceContext.supportsWebGL||!t.settingsContext.webglEnabled||t.deviceContext.performanceLevel!=="low"?0:(e=.5,e+=.3,t.settingsContext.visualEffectsLevel>.5&&(e+=.1),t.musicContext?.energy&&t.musicContext.energy>.6&&(e+=.05),t.deviceContext.isMobile&&(e-=.1),t.deviceContext.memoryCapacity>2e3&&(e+=.05),Math.min(1,Math.max(0,e)))}scoreDepthLayeredStrategy(t){let e=0;if(!t.settingsContext.depthLayersEnabled)return 0;switch(e=.5,e+=t.settingsContext.visualEffectsLevel*.4,t.deviceContext.performanceLevel){case"high":e+=.2;break;case"medium":e+=.1;break;case"low":return e=0,0}return["cosmic","cinematic"].includes(t.settingsContext.visualGuideMode)&&(e+=.2),t.musicContext?.tempo&&t.musicContext.tempo<100&&(e+=.1),t.deviceContext.memoryCapacity>6e3&&(e+=.1),t.deviceContext.isMobile&&(e-=.15),Math.min(1,Math.max(0,e))}buildDeviceContext(){let t=window.navigator.deviceMemory?window.navigator.deviceMemory*1024:4096,e=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);return{supportsWebGL:this.deviceDetector.hasWebGLSupport(),performanceLevel:this.deviceDetector.recommendPerformanceQuality(),memoryCapacity:t,isMobile:e}}buildSettingsContext(){try{return{dynamicAccentEnabled:!0,gradientIntensity:x.get("sn-gradient-intensity"),webglEnabled:x.get("sn-webgl-enabled"),webglForceEnabled:x.get("sn-webgl-enabled"),visualGuideMode:x.get("sn-artistic-mode"),depthLayersEnabled:x.get("sn-gradient-intensity")!=="disabled",visualEffectsLevel:.8,pulsingAnimationEnabled:!0}}catch(t){return u?.debug?.warn("BackgroundStrategySelector","Failed to load settings, using defaults:",t),{dynamicAccentEnabled:!0,gradientIntensity:"balanced",webglEnabled:!0,webglForceEnabled:!1,visualGuideMode:"cosmic",depthLayersEnabled:!0,visualEffectsLevel:.8,pulsingAnimationEnabled:!0}}}getOrCreateStrategy(t){if(this.strategyInstances.has(t))return this.strategyInstances.get(t);let e=null;try{switch(t){case"dynamic-catppuccin":e=new Fi;break;case"living-gradient":e=new At;break;case"webgl-gradient":e=new It;break;case"webgl-gradient-degraded":e=new It;break;case"depth-layered":e=new Bi;break;default:return u?.debug?.warn("BackgroundStrategySelector",`Unknown strategy: ${t}`),null}e&&(this.strategyInstances.set(t,e),u?.debug?.log("BackgroundStrategySelector",`Created strategy instance: ${t}`))}catch(i){return u?.debug?.error("BackgroundStrategySelector",`Failed to create strategy ${t}:`,i),null}return e}getEstimatedProcessingTime(t,e){return t.reduce((i,a)=>i+a.getEstimatedProcessingTime(e),0)}getStrategyMetadata(t){return this.strategyMetadata.get(t)||null}getAvailableStrategyNames(){return Array.from(this.strategyMetadata.keys())}updateSelectionCriteria(t){u?.debug?.log("BackgroundStrategySelector","Strategy selection criteria updated:",t)}destroy(){this.strategyInstances.forEach((t,e)=>{if("destroy"in t&&typeof t.destroy=="function")try{t.destroy()}catch(i){u?.debug?.warn("BackgroundStrategySelector",`Error destroying strategy ${e}:`,i)}}),this.strategyInstances.clear(),this.strategyMetadata.clear(),u?.debug?.log("BackgroundStrategySelector","Strategy selector destroyed")}}});var Dt,Il,Dl,Ll,_i,sr=y(()=>{"use strict";k();oe();A();st();ls();ie();cs();gs();Dt=class{constructor(t,e){this.initialized=!1;this.processingState={isProcessing:!1,currentTrackUri:null,lastExtractedColors:null,lastProcessedResult:null,lastProcessingTime:0,processingQueue:[],queueSize:0};this.metrics={totalExtractions:0,totalProcessed:0,totalApplied:0,averageProcessingTime:0,successRate:0,errorCount:0,lastProcessingTime:0,oklabCoordinations:0,strategySelections:0,cacheHits:0};this.orchestrationMetrics={totalProcessingTime:0,strategiesProcessed:0,strategiesSucceeded:0,strategiesFailed:0,cacheHits:0,averageStrategyTime:0,memoryUsage:0,oklabCoordinations:0,oklabProcessingTime:0};this.oklabCoordinationEnabled=!0;this.multiStrategyProcessingEnabled=!0;this.resultCache=new Map;this.cacheMaxSize=50;this.cacheTimeoutMs=3e5;this.processedContexts=new Map;this.CONTEXT_CACHE_TTL=2e3;this.processingTimeout=null;this.PROCESSING_TIMEOUT_MS=1e4;this.MAX_QUEUE_SIZE=10;this.processingCache=new Map;this.CACHE_TTL_MS=3e4;this.settingsManager=t||new ae,this.performanceAnalyzer=e||null,this.deviceCapabilityDetector=new O,this.strategyRegistry=new Vi,this.strategySelector=new Gi,this.oklabProcessor=new E,this.musicalOKLABProcessor=new Ri(!0)}async initialize(){if(!this.initialized)try{await this.deviceCapabilityDetector.initialize(),this.setupEventSubscriptions(),this.registerDefaultStrategies(),this.initialized=!0,u?.debug?.log("UnifiedColorProcessingEngine","\u{1F3A8} Unified color processing engine initialized")}catch(t){throw u?.debug?.error("UnifiedColorProcessingEngine","Failed to initialize:",t),t}}async healthCheck(){let t=[];return this.initialized||t.push("Engine not initialized"),this.processingState.isProcessing&&Date.now()-this.processingState.lastProcessingTime>this.PROCESSING_TIMEOUT_MS&&t.push("Processing appears stuck"),this.metrics.errorCount>0&&this.metrics.successRate<.8&&t.push(`Low success rate: ${(this.metrics.successRate*100).toFixed(1)}%`),this.processingState.queueSize>this.MAX_QUEUE_SIZE&&t.push(`Queue overflow: ${this.processingState.queueSize} items`),{healthy:t.length===0,ok:t.length===0,details:`Unified color processing - ${this.metrics.totalProcessed} processed, ${this.metrics.successRate.toFixed(2)} success rate`,issues:t,system:"UnifiedColorProcessingEngine"}}updateAnimation(t){this.processingCache.size>50&&this.cleanupCache()}destroy(){this.processingTimeout&&(clearTimeout(this.processingTimeout),this.processingTimeout=null),this.processingState.processingQueue=[],this.processingCache.clear(),p.unsubscribeAll("UnifiedColorProcessingEngine"),this.initialized=!1}setupEventSubscriptions(){p.subscribe("colors:extracted",t=>{this.handleColorExtraction(t)},"UnifiedColorProcessingEngine"),p.subscribe("settings:changed",t=>{this.handleSettingsChange(t)},"UnifiedColorProcessingEngine")}async processColors(t){let e=performance.now();try{let i=this.generateCacheKey(t),a=this.getCachedResult(i);if(a)return this.metrics.cacheHits++,this.orchestrationMetrics.cacheHits++,a;if(this.isDuplicateContext(t))return u?.debug?.log("UnifiedColorProcessingEngine","Skipping duplicate context within TTL"),this.getLastProcessedResult()||this.createFallbackResult(t,new Error("No previous result"));let r;if(this.multiStrategyProcessingEnabled)r=await this.processMultipleStrategies(t);else{let o=await this.selectOptimalStrategy(t);this.metrics.strategySelections++,r=await this.processWithOKLAB(t,o)}let n=performance.now()-e;this.updateMetrics(n,!0),this.updateOrchestrationMetrics(n,!0);let s={...r,processingTime:n,strategy:r.metadata?.strategy?{getStrategyName:()=>r.metadata.strategy}:await this.selectOptimalStrategy(t),success:!0,timestamp:Date.now(),coordinationMetrics:{detectedGenre:t.musicData?.genre||"unknown",emotionalState:t.musicData?.energy?this.classifyEmotionalState(t.musicData.energy):"neutral",oklabPreset:this.determineOKLABPreset(t),coordinationStrategy:r.metadata?.strategy||"unified",musicInfluenceStrength:t.musicData?.energy||.5}};return this.cacheResult(i,s),this.cacheContext(t),this.processingState.lastProcessedResult=s,p.emit("colors:harmonized",{processedColors:r.processedColors,accentHex:r.accentHex||"var(--sn-brightness-adjusted-accent-hex, #cba6f7)",accentRgb:r.accentRgb||"var(--sn-brightness-adjusted-accent-rgb, 203, 166, 247)",strategies:[s.coordinationMetrics.coordinationStrategy],coordinationMetrics:s.coordinationMetrics,oklabData:s.oklabData,processingTime:n,timestamp:Date.now()}),s}catch(i){let a=performance.now()-e;return this.updateMetrics(a,!1),this.updateOrchestrationMetrics(a,!1),u?.debug?.error("UnifiedColorProcessingEngine","Processing failed:",i),this.createFallbackResult(t,i)}}async processMultipleStrategies(t){let e=performance.now();try{let i=await this.selectMultipleStrategies(t);if(i.length===0)throw new Error("No strategies available for processing");let a=i.map(async s=>{let o=performance.now();try{let c=await s.processColors(t),m=performance.now()-o;return{strategy:s,result:c,processingTime:m,success:!0,oklabData:c.metadata?.oklabData}}catch(c){let m=performance.now()-o;return u?.debug?.warn("UnifiedColorProcessingEngine",`Strategy ${s.getStrategyName()} failed:`,c),{strategy:s,result:this.createFallbackResult(t,c),processingTime:m,success:!1,error:c.message}}}),r=await Promise.all(a);this.orchestrationMetrics.strategiesProcessed+=r.length,this.orchestrationMetrics.strategiesSucceeded+=r.filter(s=>s.success).length,this.orchestrationMetrics.strategiesFailed+=r.filter(s=>!s.success).length,this.orchestrationMetrics.totalProcessingTime+=performance.now()-e,this.orchestrationMetrics.averageStrategyTime=r.reduce((s,o)=>s+o.processingTime,0)/r.length;let n;return this.oklabCoordinationEnabled&&r.some(s=>s.success)?(n=await this.coordinateOKLABProcessing(t,r),this.orchestrationMetrics.oklabCoordinations++):n=this.mergeStrategyResults(r,t),n}catch(i){u?.debug?.error("UnifiedColorProcessingEngine","Multi-strategy processing failed:",i);let a=await this.selectOptimalStrategy(t);return await this.processWithOKLAB(t,a)}}async coordinateOKLABProcessing(t,e){let i=performance.now();try{let a=e.filter(d=>d.success);if(a.length===0)throw new Error("No successful strategy results for OKLAB coordination");let r={};a.forEach(d=>{Object.entries(d.result.processedColors).forEach(([h,g])=>{r[h]||(r[h]=[]),r[h].push(g)})});let n={rawColors:t.rawColors,musicData:t.musicData,trackUri:t.trackUri,timestamp:t.timestamp},s=await this.musicalOKLABProcessor.processMusicalColors(n),o=this.blendOKLABWithStrategies(r,s),c=this.selectPrimaryResult(a),m={...c.result,processedColors:o,metadata:{...c.result.metadata,oklabCoordination:s,coordinationStrategy:"multi-strategy-oklab",strategiesUsed:a.map(d=>d.strategy.getStrategyName()),oklabProcessingTime:performance.now()-i}};return this.orchestrationMetrics.oklabProcessingTime+=performance.now()-i,m}catch(a){return u?.debug?.error("UnifiedColorProcessingEngine","OKLAB coordination failed, falling back to merge:",a),this.mergeStrategyResults(e,t)}}mergeStrategyResults(t,e,i={priorityWeighting:!0,conflictResolution:"merge",preserveMetadata:!0,visualEffectsBlending:!0,oklabCoordination:!1}){let a=t.filter(c=>c.success);if(a.length===0)return this.createFallbackResult(e,new Error("No successful strategies"));if(a.length===1){let c=a[0];return c?c.result:this.createFallbackResult(e,new Error("Single result is undefined"))}let r=i.priorityWeighting?this.prioritizeResults(a):a;if(r.length===0)return this.createFallbackResult(e,new Error("No prioritized results"));let n=r[0];if(!n)return this.createFallbackResult(e,new Error("Primary result is undefined"));let s={...n.result.processedColors};r.slice(1).forEach(c=>{Object.entries(c.result.processedColors).forEach(([m,d])=>{if(s[m])switch(i.conflictResolution){case"override":break;case"merge":s[`${m}-${c.strategy.getStrategyName()}`]=d;break;case"average":this.isValidHexColor(s[m])&&this.isValidHexColor(d)&&(s[m]=this.averageColors(s[m],d));break}else s[m]=d})});let o=i.preserveMetadata?this.mergeMetadata(r.map(c=>c.result.metadata)):n.result.metadata;return{...n.result,processedColors:s,metadata:{...o,mergeStrategy:i.conflictResolution,strategiesUsed:a.map(c=>c.strategy.getStrategyName()),mergeTimestamp:Date.now()}}}async handleColorExtraction(t){return"rawColors"in t&&"trackUri"in t?this.processColorContext(t):this.handleColorExtractionEvent(t)}async processColorContext(t){this.metrics.totalExtractions++;try{if(this.processingState.isProcessing){this.addToQueue(t);return}await this.processWithTimeout(t)}catch(e){this.metrics.errorCount++,u?.debug?.error("UnifiedColorProcessingEngine","Color context processing failed:",e)}}async handleColorExtractionEvent(t){this.metrics.totalExtractions++;try{let e={rawColors:t.rawColors,trackUri:t.trackUri,musicData:t.musicData,timestamp:t.timestamp||Date.now()};if(this.processingState.isProcessing){this.addToQueue(e);return}await this.processWithTimeout(e)}catch(e){this.metrics.errorCount++,u?.debug?.error("UnifiedColorProcessingEngine","Color extraction handling failed:",e)}}async processWithOKLAB(t,e){let i={rawColors:t.rawColors,musicData:t.musicData,trackUri:t.trackUri,timestamp:t.timestamp},a=await this.musicalOKLABProcessor.processMusicalColors(i);this.metrics.oklabCoordinations++;let r=await e.processColors(t),n=await this.enhanceWithOKLAB(r.processedColors,a);return{...r,processedColors:n,metadata:{...r.metadata,oklabPreset:this.determineOKLABPreset(t),oklabCoordination:a}}}async selectOptimalStrategy(t){try{let i=this.deviceCapabilityDetector.getCapabilities(),a={performance:"medium",quality:"enhanced",deviceCapabilities:{hasWebGL:i?.gpu?.supportsWebGL||!0,memoryMB:i?.memory?.total||4096,isMobile:!1},userPreferences:{harmonicMode:"cosmic",intensity:.8,enableAdvancedBlending:!0},settingsContext:{dynamicAccentEnabled:!0,gradientIntensity:"medium",webglEnabled:i?.gpu?.supportsWebGL||!0,webglForceEnabled:!1,visualGuideMode:"enhanced",depthLayersEnabled:!0,visualEffectsLevel:.8,pulsingAnimationEnabled:!0},deviceContext:{supportsWebGL:i?.gpu?.supportsWebGL||!0,performanceLevel:"medium",memoryCapacity:i?.memory?.total||4096,isMobile:!1}},r=this.strategySelector.selectStrategies(t,a);if(r&&r.length>0&&r[0])return r[0]}catch(i){u?.debug?.warn("UnifiedColorProcessingEngine","Strategy selection failed, using fallback:",i)}return{getStrategyName:()=>"fallback",canProcess:i=>!0,getEstimatedProcessingTime:i=>50,processColors:async i=>({processedColors:i.rawColors,accentHex:"var(--sn-brightness-adjusted-accent-hex, #cba6f7)",accentRgb:"var(--sn-brightness-adjusted-accent-rgb, 203, 166, 247)",context:i,metadata:{strategy:"fallback",timestamp:Date.now(),processingTime:0}})}}addToQueue(t){this.processingState.queueSize>=this.MAX_QUEUE_SIZE&&this.processingState.processingQueue.shift(),this.processingState.processingQueue.push(t),this.processingState.queueSize=this.processingState.processingQueue.length}async processQueue(){for(;this.processingState.processingQueue.length>0&&!this.processingState.isProcessing;){let t=this.processingState.processingQueue.shift();this.processingState.queueSize=this.processingState.processingQueue.length,await this.processWithTimeout(t)}}async processWithTimeout(t){this.processingState.isProcessing=!0,this.processingState.lastProcessingTime=Date.now(),this.processingTimeout=window.setTimeout(()=>{u?.debug?.warn("UnifiedColorProcessingEngine","Processing timeout - forcing reset"),this.processingState.isProcessing=!1,this.metrics.errorCount++},this.PROCESSING_TIMEOUT_MS);try{await this.processColors(t),this.metrics.totalProcessed++}finally{this.processingTimeout&&(clearTimeout(this.processingTimeout),this.processingTimeout=null),this.processingState.isProcessing=!1,this.processingState.processingQueue.length>0&&setTimeout(()=>this.processQueue(),0)}}generateCacheKey(t){let e={colors:Object.keys(t.rawColors).sort().join(","),music:t.musicData?.energy||0};return JSON.stringify(e)}getCachedResult(t){let e=this.processingCache.get(t);return e&&Date.now()-e.timestamp<this.CACHE_TTL_MS?e:null}cacheResult(t,e){if(this.processingCache.set(t,{...e,timestamp:Date.now()}),this.resultCache.set(t,e),this.resultCache.size>this.cacheMaxSize){let i=Array.from(this.resultCache.entries());i.slice(0,i.length-this.cacheMaxSize).forEach(([r])=>this.resultCache.delete(r))}}cleanupCache(){let t=Date.now();for(let[e,i]of this.processingCache.entries())t-i.timestamp>this.CACHE_TTL_MS&&this.processingCache.delete(e)}updateMetrics(t,e){this.metrics.averageProcessingTime=(this.metrics.averageProcessingTime*this.metrics.totalProcessed+t)/(this.metrics.totalProcessed+1),e?this.metrics.successRate=(this.metrics.successRate*this.metrics.totalProcessed+1)/(this.metrics.totalProcessed+1):this.metrics.successRate=this.metrics.successRate*this.metrics.totalProcessed/(this.metrics.totalProcessed+1),this.metrics.lastProcessingTime=Date.now()}async selectMultipleStrategies(t){try{let e=this.deviceCapabilityDetector.getCapabilities(),i=this.buildSelectionCriteria(e);return this.strategySelector.selectStrategies(t,i)?.slice(0,3)||[]}catch(e){return u?.debug?.warn("UnifiedColorProcessingEngine","Multi-strategy selection failed, using single strategy:",e),[await this.selectOptimalStrategy(t)]}}isDuplicateContext(t){if(!t.trackUri)return!1;let e=this.processedContexts.get(t.trackUri);return e?Date.now()-e<this.CONTEXT_CACHE_TTL:!1}cacheContext(t){if(t.trackUri&&(this.processedContexts.set(t.trackUri,Date.now()),this.processedContexts.size>100)){let e=Date.now()-this.CONTEXT_CACHE_TTL*2;for(let[i,a]of this.processedContexts.entries())a<e&&this.processedContexts.delete(i)}}getLastProcessedResult(){return this.processingState.lastProcessedResult}updateOrchestrationMetrics(t,e){this.orchestrationMetrics.totalProcessingTime+=t,e||this.orchestrationMetrics.strategiesFailed++,this.orchestrationMetrics.memoryUsage=Math.round((this.resultCache.size*1024+this.processedContexts.size*256)/1024)}blendOKLABWithStrategies(t,e){let i={};return e.enhancedColors&&Object.entries(e.enhancedColors).forEach(([a,r])=>{i[`oklab-${a}`]=r}),Object.entries(t).forEach(([a,r])=>{r.length===1&&r[0]?i[a]=r[0]:r.length>1&&r[0]&&(i[a]=r[0],r.slice(1).forEach((n,s)=>{n&&(i[`${a}-variant-${s+1}`]=n)}))}),i}selectPrimaryResult(t){if(t.length===0)throw new Error("Cannot select primary result from empty results array");let i=t.sort((a,r)=>a.success&&!r.success?-1:!a.success&&r.success?1:a.processingTime-r.processingTime)[0];if(!i)throw new Error("Primary result is undefined after sorting");return i}prioritizeResults(t){return t.length===0?[]:t.sort((e,i)=>e.success&&!i.success?-1:!e.success&&i.success?1:e.success&&i.success?e.processingTime-i.processingTime:0)}mergeMetadata(t){if(t.length===0)return{};if(t.length===1)return t[0]||{};let e={...t[0]},i=[];return t.forEach(a=>{a?.strategy&&i.push(a.strategy),a?.strategiesUsed&&i.push(...a.strategiesUsed)}),e.strategiesUsed=[...new Set(i)],e.mergeTimestamp=Date.now(),e}isValidHexColor(t){return/^#[0-9A-F]{6}$/i.test(t)}averageColors(t,e){try{let i=parseInt(t.substring(1,3),16),a=parseInt(t.substring(3,5),16),r=parseInt(t.substring(5,7),16),n=parseInt(e.substring(1,3),16),s=parseInt(e.substring(3,5),16),o=parseInt(e.substring(5,7),16),c=Math.round((i+n)/2),m=Math.round((a+s)/2),d=Math.round((r+o)/2);return`#${c.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}`}catch{return t}}buildSelectionCriteria(t){return{performance:"medium",quality:"enhanced",deviceCapabilities:{hasWebGL:t?.gpu?.supportsWebGL||!0,memoryMB:t?.memory?.total||4096,isMobile:!1},userPreferences:{harmonicMode:"cosmic",intensity:.8,enableAdvancedBlending:!0},settingsContext:{dynamicAccentEnabled:!0,gradientIntensity:"medium",webglEnabled:t?.gpu?.supportsWebGL||!0,webglForceEnabled:!1,visualGuideMode:"enhanced",depthLayersEnabled:!0,visualEffectsLevel:.8,pulsingAnimationEnabled:!0},deviceContext:{supportsWebGL:t?.gpu?.supportsWebGL||!0,performanceLevel:"medium",memoryCapacity:t?.memory?.total||4096,isMobile:!1}}}async enhanceWithOKLAB(t,e){let i={...t};return e.enhancedColors&&Object.entries(e.enhancedColors).forEach(([a,r])=>{i[`oklab-${a}`]=r}),i}classifyEmotionalState(t){return t>.8?"energetic":t>.6?"upbeat":t>.4?"moderate":t>.2?"calm":"peaceful"}determineOKLABPreset(t){let e=t.musicData?.energy||.5;return e>.8?"high-energy":e>.6?"dynamic":e>.4?"balanced":"ambient"}createFallbackResult(t,e){return{processedColors:{fallback:"var(--sn-brightness-adjusted-accent-hex, #cba6f7)"},accentHex:"var(--sn-brightness-adjusted-accent-hex, #cba6f7)",accentRgb:"var(--sn-brightness-adjusted-accent-rgb, 203, 166, 247)",context:t,metadata:{strategy:"fallback",error:e.message,timestamp:Date.now(),processingTime:0}}}registerDefaultStrategies(){}async handleSettingsChange(t){["catppuccin-flavor","catppuccin-accentColor","sn-dynamic-color-intensity"].includes(t.settingKey)&&(this.processingCache.clear(),u?.debug?.log("UnifiedColorProcessingEngine","Cache cleared due to settings change:",t.settingKey))}async handlePerformanceWarning(t){t.memoryUsage>50&&(this.processingCache.clear(),u?.debug?.log("UnifiedColorProcessingEngine","Cache cleared due to memory pressure"))}getMetrics(){return{...this.metrics}}async forceReprocessColors(){if(this.processingCache.clear(),this.processingState.lastExtractedColors){let t={rawColors:this.processingState.lastExtractedColors,trackUri:this.processingState.currentTrackUri||"",timestamp:Date.now()};await this.processColors(t)}}getProcessingState(){return{...this.processingState}}getStatus(){return{isProcessing:this.processingState.isProcessing,queueSize:this.processingState.queueSize}}setSelectionCriteria(t){u?.debug?.log("UnifiedColorProcessingEngine","Strategy selection criteria updated:",t)}},Il=()=>{let l=globalThis.year3000System;return{settingsManager:l?.settingsManager,performanceAnalyzer:l?.performanceAnalyzer||l?.facadeCoordinator?.getCachedNonVisualSystem?.("PerformanceAnalyzer")}},{settingsManager:Dl,performanceAnalyzer:Ll}=Il(),_i=new Dt(Dl,Ll)});var Hi,ps=y(()=>{"use strict";Me();ie();k();Hi=class l{constructor(t,e,i){this.initialized=!1;this.cardQuerySelector=".main-card-card, .main-gridContainer-gridContainer.main-gridContainer-fixedWidth";this.cardEventHandlers=new WeakMap;this.musicSyncService=null;this.currentQualityLevel=null;this.qualityCapabilities=[];this.effectCoordinationCallbacks=new Set;this.config={perspective:1e3,maxRotation:5,scale:1.02,transitionSpeed:"200ms",glowOpacity:.8,selector:".main-card-card, .main-grid-grid > *, .main-shelf-shelf > * > *",depthMultiplier:1.5,musicResponseStrength:.8,beatSyncIntensity:.6,effectIntensityMultiplier:1.2},this.performanceMonitor=t,this.settingsManager=e,this.utils=i,this.cards=document.querySelectorAll(this.config.selector),this.musicTemperatureMapper=new J(!0),this.oklabProcessor=new E(!0),this.effectPreset=E.getPreset("VIBRANT"),this.effectState={currentMusicMood:"neutral",musicIntensity:.5,beatPhase:0,lastBeatTime:0,effectIntensityLevel:0,dynamicAccentHex:"#cba6f7",dynamicAccentRgb:"203,166,247",overallIntensityLevel:.5},this.boundHandleSettingsChange=this.handleSettingsChange.bind(this)}static getInstance(t,e,i){return l.instance||(l.instance=new l(t,e,i)),l.instance}async initialize(){if(this.initialized)return;let t=this.performanceMonitor.shouldReduceQuality();this.cards=document.querySelectorAll(this.config.selector),await this.applyEventListeners(),await this.initializeMusicIntegration(),this.initializeCrossSystemCoordination(),document.addEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange),this.initialized=!0}async healthCheck(){let t=document.querySelectorAll(this.cardQuerySelector);return t.length>0?{healthy:!0,ok:!0,details:`Found ${t.length} cards to manage.`,issues:[],system:"Card3DManager"}:{healthy:!1,ok:!1,details:"No card elements found with the configured selector.",issues:["No card elements found with the configured selector."],system:"Card3DManager"}}updateAnimation(t){}apply3DMode(t){console.log(`[Card3DManager] Applying 3D mode: ${t}`),t==="disabled"?this.destroy():this.initialize()}get shouldEnable3DEffects(){let t=this.performanceMonitor.shouldReduceQuality(),e=this.settingsManager.get("sn-enable3dCards");return!t&&e!=="disabled"}async applyEventListeners(){this.cards.forEach(t=>{if(this.cardEventHandlers.has(t))return;let e=a=>this.handleMouseMove(t,a),i=()=>this.handleMouseLeave(t);this.cardEventHandlers.set(t,{move:e,leave:i}),t.addEventListener("mousemove",e),t.addEventListener("mouseleave",i)})}handleMouseMove(t,e){if(!this.shouldEnable3DEffects)return;let{clientX:i,clientY:a}=e,{top:r,left:n,width:s,height:o}=t.getBoundingClientRect(),c=i-n,m=a-r,d=this.config.maxRotation*(m-o/2)/(o/2),h=-this.config.maxRotation*(c-s/2)/(s/2);t.style.transform=`perspective(${this.config.perspective}px) rotateX(${d}deg) rotateY(${h}deg) scale3d(${this.config.scale}, ${this.config.scale}, ${this.config.scale})`,t.style.transition=`transform ${this.config.transitionSpeed} ease-out`,this.applyGlow(t,c,m,s,o)}handleMouseLeave(t){t.style.transform="perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)",t.style.transition="transform 600ms ease-in-out",this.removeGlow(t)}applyGlow(t,e,i,a,r){let n=t.querySelector(".card-glow");n||(n=document.createElement("div"),n.className="card-glow",t.appendChild(n));let{dynamicAccentRgb:s,musicIntensity:o,beatPhase:c,effectIntensityLevel:m}=this.effectState,d=this.config.glowOpacity,h=1+(o-.5)*this.config.musicResponseStrength,g=1+Math.sin(c)*this.config.beatSyncIntensity*.3,f=1+m*this.config.effectIntensityMultiplier*.4,v=d*h*g*f,C=Math.max(.1,Math.min(1,v)),w=40+Math.sin(c*.5)*8*this.config.beatSyncIntensity;n.style.background=`radial-gradient(circle at ${e}px ${i}px, 
      rgba(${s}, ${C}) 0%, 
      rgba(${s}, ${C*.6}) 20%, 
      transparent ${w}%)`}removeGlow(t){let e=t.querySelector(".card-glow");e&&(e.style.background="transparent")}destroy(){this.cards.forEach(t=>{let e=this.cardEventHandlers.get(t);e&&(t.removeEventListener("mousemove",e.move),t.removeEventListener("mouseleave",e.leave),this.cardEventHandlers.delete(t)),this.removeGlow(t),t.style.transform="",t.style.transition=""}),this.initialized=!1,document.removeEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange)}handleSettingsChange(t){let{key:e,value:i}=t.detail||{}}async initializeMusicIntegration(){try{p.subscribe("colors:extracted",t=>{this.onColorsExtracted(t)},"Card3DManager"),p.subscribe("colors:harmonized",t=>{this.onColorsHarmonized(t)},"Card3DManager"),p.subscribe("music:beat",t=>{this.onMusicBeat(t)},"Card3DManager"),p.subscribe("music:dramatic-peak-detected",t=>{this.onIntensityEvent(t)},"Card3DManager"),this.updateDynamicAccentColor(),console.log("[Card3DManager] \u2705 Year 3000 music integration initialized")}catch(t){console.error("[Card3DManager] Failed to initialize music integration:",t)}}onColorsExtracted(t){let{rawColors:e,musicData:i}=t;if(i){let a=this.musicTemperatureMapper.mapMusicToEmotionalTemperature(i);this.updateMusicState(a)}}onColorsHarmonized(t){let{processedColors:e,coordinationMetrics:i}=t;if(e.VIBRANT){let a=this.oklabProcessor.processColor(e.VIBRANT,this.effectPreset);this.effectState.dynamicAccentHex=a.enhancedHex,this.effectState.dynamicAccentRgb=`${a.enhancedRgb.r},${a.enhancedRgb.g},${a.enhancedRgb.b}`}i?.overallIntensityLevel!==void 0&&(this.effectState.overallIntensityLevel=i.overallIntensityLevel)}onMusicBeat(t){let{beat:e,intensity:i,timestamp:a}=t;this.effectState.beatPhase+=Math.PI*2*this.config.beatSyncIntensity,this.effectState.lastBeatTime=a||Date.now(),i>.7&&this.applyBeatSyncDepthPulse(i)}onIntensityEvent(t){let{intensity:e,type:i}=t;this.effectState.effectIntensityLevel=e,e>.8&&this.applyEnhancedDepthDistortion(e)}updateMusicState(t){switch(this.effectState.currentMusicMood=t.primaryEmotion,this.effectState.musicIntensity=t.intensity,t.primaryEmotion){case"energetic":case"aggressive":this.effectPreset=E.getPreset("COSMIC");break;case"calm":case"ambient":this.effectPreset=E.getPreset("SUBTLE");break;default:this.effectPreset=E.getPreset("VIBRANT")}}applyBeatSyncDepthPulse(t){let e=1+t*.15*this.config.beatSyncIntensity;this.cards.forEach(i=>{if(i instanceof HTMLElement){let r=(i.style.transform||"").replace(/scale3d\([^)]*\)/,`scale3d(${e}, ${e}, ${e})`);i.style.transform=r||`scale3d(${e}, ${e}, ${e})`,i.style.transition="transform 100ms ease-out",setTimeout(()=>{i.style.transform.includes(`scale3d(${e}`)&&(i.style.transform=i.style.transform.replace(/scale3d\([^)]*\)/,"scale3d(1, 1, 1)"))},200)}})}applyEnhancedDepthDistortion(t){let e=this.config.perspective*(1+t*this.config.effectIntensityMultiplier),i=this.config.maxRotation*(1+t*.8);this.cards.forEach(a=>{if(a instanceof HTMLElement){let r=`perspective(${e}px) rotateX(${i*.3}deg) rotateY(${i*.2}deg)`;a.style.transform=r,a.style.transition="transform 800ms ease-out",setTimeout(()=>{a.style.transform="perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)",a.style.transition="transform 1200ms ease-in-out"},1500)}})}updateDynamicAccentColor(){let t=document.documentElement,e=getComputedStyle(t),i=e.getPropertyValue("--sn-dynamic-accent-hex").trim()||e.getPropertyValue("--sn-color-accent-hex").trim()||e.getPropertyValue("--spice-accent").trim(),a=e.getPropertyValue("--sn-dynamic-accent-rgb").trim()||e.getPropertyValue("--sn-color-accent-rgb").trim()||e.getPropertyValue("--spice-rgb-accent").trim();i&&i!==""&&(this.effectState.dynamicAccentHex=i),a&&a!==""&&(this.effectState.dynamicAccentRgb=a)}setMusicSyncService(t){this.musicSyncService=t}getEffectState(){return{...this.effectState}}setQualityLevel(t){switch(this.currentQualityLevel=t,t){case"low":this.config.perspective=900,this.config.maxRotation=3,this.config.depthMultiplier=1.2,this.config.musicResponseStrength=.5,this.config.beatSyncIntensity=.4,this.config.effectIntensityMultiplier=.8;break;case"medium":this.config.perspective=1e3,this.config.maxRotation=5,this.config.depthMultiplier=1.5,this.config.musicResponseStrength=.8,this.config.beatSyncIntensity=.6,this.config.effectIntensityMultiplier=1.2;break;case"high":this.config.perspective=1200,this.config.maxRotation=7,this.config.depthMultiplier=1.8,this.config.musicResponseStrength=1,this.config.beatSyncIntensity=.8,this.config.effectIntensityMultiplier=1.5;break;default:this.config.perspective=1e3,this.config.maxRotation=5,this.config.depthMultiplier=1.5,this.config.musicResponseStrength=.8,this.config.beatSyncIntensity=.6,this.config.effectIntensityMultiplier=1.2;break}console.log(`[Card3DManager] Quality level set to: ${t}`)}adjustQuality(t){this.setQualityLevel(t)}getPerformanceImpact(){let t=this.cards.length,e=t*.1,i=this.config.depthMultiplier*.2,a=this.config.musicResponseStrength*.15,r=this.config.effectIntensityMultiplier*.1;return{fps:60,frameTime:e+i+a+r,memoryUsage:t*.05,cpuUsage:(e+i)*100}}reduceQuality(t){this.currentQualityLevel&&(this.config.depthMultiplier=Math.max(.5,this.config.depthMultiplier-t),this.config.musicResponseStrength=Math.max(.1,this.config.musicResponseStrength-t),this.config.beatSyncIntensity=Math.max(.1,this.config.beatSyncIntensity-t),this.config.effectIntensityMultiplier=Math.max(.5,this.config.effectIntensityMultiplier-t),console.log(`[Card3DManager] Quality reduced by ${t}`))}increaseQuality(t){this.currentQualityLevel&&(this.config.depthMultiplier=Math.min(2,this.config.depthMultiplier+t),this.config.musicResponseStrength=Math.min(1.5,this.config.musicResponseStrength+t),this.config.beatSyncIntensity=Math.min(1,this.config.beatSyncIntensity+t),this.config.effectIntensityMultiplier=Math.min(2,this.config.effectIntensityMultiplier+t),console.log(`[Card3DManager] Quality increased by ${t}`))}getQualityCapabilities(){return this.qualityCapabilities.length===0&&(this.qualityCapabilities=[{name:"3D Perspective",enabled:!0,qualityLevel:"medium"},{name:"Music-Reactive Glow",enabled:!0,qualityLevel:"low"},{name:"Beat Sync Effects",enabled:!0,qualityLevel:"low"},{name:"Intensity Distortion",enabled:!0,qualityLevel:"medium"},{name:"Music Modulation",enabled:!0,qualityLevel:"low"}]),this.qualityCapabilities}async refreshColorState(t){try{if(this.updateDynamicAccentColor(),this.effectState.dynamicAccentHex){let e=this.oklabProcessor.processColor(this.effectState.dynamicAccentHex,this.effectPreset);this.effectState.dynamicAccentHex=e.enhancedHex,this.effectState.dynamicAccentRgb=`${e.enhancedRgb.r},${e.enhancedRgb.g},${e.enhancedRgb.b}`}console.log(`[Card3DManager] Color state refreshed for trigger: ${t}`)}catch(e){console.error("[Card3DManager] Error refreshing color state:",e)}}onEffectCoordination(t){return this.effectCoordinationCallbacks.add(t),()=>{this.effectCoordinationCallbacks.delete(t)}}synchronizeEffectState(t){t.currentMusicMood&&(this.effectState.currentMusicMood=t.currentMusicMood),t.musicIntensity!==void 0&&(this.effectState.musicIntensity=t.musicIntensity),t.beatPhase!==void 0&&(this.effectState.beatPhase=t.beatPhase),t.effectIntensityLevel!==void 0&&(this.effectState.effectIntensityLevel=t.effectIntensityLevel),t.overallIntensityLevel!==void 0&&(this.effectState.overallIntensityLevel=t.overallIntensityLevel),t.dynamicAccentHex&&(this.effectState.dynamicAccentHex=t.dynamicAccentHex),t.dynamicAccentRgb&&(this.effectState.dynamicAccentRgb=t.dynamicAccentRgb),this.broadcastEffectState()}broadcastEffectState(){this.effectCoordinationCallbacks.forEach(t=>{try{t(this.effectState)}catch(e){console.error("[Card3DManager] Error in effect coordination callback:",e)}})}updateMusicStateWithCoordination(t){this.updateMusicState(t),this.broadcastEffectState(),p.emit("visual-effects:coordination",{source:"Card3DManager",state:this.convertToVisualEffectsState(this.effectState),timestamp:Date.now()})}onMusicBeatWithCoordination(t){this.onMusicBeat(t),this.broadcastEffectState(),p.emit("music:beat-sync",{source:"Card3DManager",beatPhase:this.effectState.beatPhase,lastBeatTime:this.effectState.lastBeatTime,timestamp:Date.now()})}onIntensityEventWithCoordination(t){this.onIntensityEvent(t),this.broadcastEffectState(),p.emit("music:dramatic-sync",{source:"Card3DManager",dramaticLevel:this.effectState.effectIntensityLevel,type:t.type,timestamp:Date.now()})}initializeCrossSystemCoordination(){try{p.subscribe("visual-effects:coordination",t=>{t.source!=="Card3DManager"&&this.synchronizeEffectState(this.convertFromVisualEffectsState(t.state))},"Card3DManager"),p.subscribe("music:beat-sync",t=>{t.source!=="Card3DManager"&&(this.effectState.beatPhase=t.beatPhase,this.effectState.lastBeatTime=t.lastBeatTime)},"Card3DManager"),p.subscribe("music:dramatic-sync",t=>{t.source!=="Card3DManager"&&(this.effectState.effectIntensityLevel=t.dramaticLevel)},"Card3DManager"),console.log("[Card3DManager] \u2705 Cross-system effect coordination initialized")}catch(t){console.error("[Card3DManager] Failed to initialize cross-system coordination:",t)}}convertToVisualEffectsState(t){return{intensity:t.effectIntensityLevel,colorTemperature:6500,animationScale:t.musicIntensity,dominantEmotion:t.currentMusicMood,resonance:t.musicIntensity,symbioticResonance:t.musicIntensity,surfaceFluidityIndex:t.musicIntensity,animationScaleRate:t.effectIntensityLevel,emotionalTemperature:6500,pulsingCycle:t.beatPhase,cinematicIntensity:t.effectIntensityLevel}}convertFromVisualEffectsState(t){return{currentMusicMood:t.dominantEmotion,musicIntensity:t.intensity,effectIntensityLevel:t.intensity,overallIntensityLevel:t.intensity}}}});var or,lr,fs=y(()=>{"use strict";or=class l{constructor(){this.observers=new Map;this.trackedElements=new Map;this.isSupported=typeof IntersectionObserver<"u",this.isSupported||console.warn("[ViewportController] IntersectionObserver not supported, falling back to always-visible behavior")}static getInstance(){return l.instance||(l.instance=new l),l.instance}trackElement(t,e,i={}){if(!this.isSupported){let o={isVisible:!0,intersectionRatio:1,lastVisibilityChange:Date.now(),element:t};return e(o),()=>{}}let a={visibilityThreshold:.1,rootMargin:"50px",trackRootElement:!1,...i},r=this.getObserverKey(a),n=this.observers.get(r);n||(n=new IntersectionObserver(o=>this.handleIntersectionChanges(o),{threshold:a.visibilityThreshold,rootMargin:a.rootMargin,root:a.rootSelector?document.querySelector(a.rootSelector):null}),this.observers.set(r,n));let s={isVisible:!1,intersectionRatio:0,lastVisibilityChange:Date.now(),element:t};return this.trackedElements.set(t,{callback:e,options:a,state:s}),n.observe(t),()=>this.untrackElement(t)}isElementVisible(t){return this.trackedElements.get(t)?.state.isVisible??!0}getVisibilityState(t){return this.trackedElements.get(t)?.state??null}untrackElement(t){let e=this.trackedElements.get(t);if(!e)return;let i=this.getObserverKey(e.options),a=this.observers.get(i);a&&a.unobserve(t),this.trackedElements.delete(t)}trackSpotifyContainer(t){let e=[".Root__main-view",'[data-testid="topbar"]',".main-view-container","#main"],i=null;for(let a of e)if(i=document.querySelector(a),i)break;return i||(console.warn("[ViewportController] Could not find Spotify main container, using document.body"),i=document.body),this.trackElement(i,t,{visibilityThreshold:.1,rootMargin:"0px",trackRootElement:!0})}checkBulkVisibility(t){let e=new Map;for(let i of t)e.set(i,this.isElementVisible(i));return e}destroy(){for(let t of this.observers.values())t.disconnect();this.observers.clear(),this.trackedElements.clear()}handleIntersectionChanges(t){for(let e of t){let i=this.trackedElements.get(e.target);if(!i)continue;let a=i.state.isVisible,r=e.isIntersecting;if(i.state={isVisible:r,intersectionRatio:e.intersectionRatio,lastVisibilityChange:a!==r?Date.now():i.state.lastVisibilityChange,element:e.target},a!==r)try{i.callback(i.state)}catch(n){console.error("[ViewportController] Error in visibility callback:",n)}}}getObserverKey(t){return`${t.visibilityThreshold}-${t.rootMargin}-${t.rootSelector||"viewport"}`}},lr=or.getInstance()});var zi,ys=y(()=>{"use strict";fs();k();zi=class{constructor(t={}){this.initialized=!1;this.isVisible=!0;this.visibilityState=null;this.animationsPaused=!1;this.settingsUpdatesPaused=!1;this.viewportOptions={visibilityThreshold:.1,rootMargin:"50px",pauseAnimationsWhenHidden:!0,pauseSettingsUpdatesWhenHidden:!0,resumeDelay:100,...t}}async initialize(){await this.initializeViewportTracking(),await this.initializeEventSubscriptions(),await this.initializeSystem(),this.initialized=!0}async healthCheck(){let t=await this.performHealthCheck();return{...t,details:`${t.details} | Viewport: ${this.isVisible?"visible":"hidden"}`}}updateAnimation(t){this.shouldSkipAnimationUpdate()||this.performAnimationUpdate(t)}destroy(){this.cleanupViewportTracking(),this.cleanupEventSubscriptions(),this.performDestroy()}handleSettingsChange(t){this.shouldSkipSettingsUpdate()||this.performSettingsUpdate(t)}forceRepaint(t){this.performForceRepaint?.(t)}onVisibilityChanged(t){}onBecomingVisible(){}onBecomingHidden(){}async initializeViewportTracking(){let t=null;this.viewportOptions.trackingSelector&&(t=document.querySelector(this.viewportOptions.trackingSelector)),t?this.untrackViewport=lr.trackElement(t,e=>this.handleVisibilityChange(e),this.viewportOptions):this.untrackViewport=lr.trackSpotifyContainer(e=>this.handleVisibilityChange(e))}async initializeEventSubscriptions(){this.settingsSubscriptionId=p.subscribe("settings:changed",t=>this.handleUnifiedSettingsChange(t),`ViewportAwareSystem-${this.constructor.name}`)}cleanupEventSubscriptions(){this.settingsSubscriptionId&&(p.unsubscribe(this.settingsSubscriptionId),delete this.settingsSubscriptionId)}handleUnifiedSettingsChange(t){if(this.shouldSkipSettingsUpdate())return;let e=new CustomEvent("year3000SystemSettingsChanged",{detail:{key:t.settingKey,value:t.newValue}});this.performSettingsUpdate(e)}handleVisibilityChange(t){let e=this.isVisible;this.isVisible=t.isVisible,this.visibilityState=t,!e&&this.isVisible?this.handleBecomingVisible():e&&!this.isVisible&&this.handleBecomingHidden(),this.onVisibilityChanged(t)}handleBecomingVisible(){this.resumeTimeoutId&&clearTimeout(this.resumeTimeoutId),this.resumeTimeoutId=window.setTimeout(()=>{this.animationsPaused=!1,this.settingsUpdatesPaused=!1,this.onBecomingVisible()},this.viewportOptions.resumeDelay||100)}handleBecomingHidden(){this.viewportOptions.pauseAnimationsWhenHidden&&(this.animationsPaused=!0),this.viewportOptions.pauseSettingsUpdatesWhenHidden&&(this.settingsUpdatesPaused=!0),this.onBecomingHidden()}shouldSkipAnimationUpdate(){return this.animationsPaused||!this.isVisible&&(this.viewportOptions.pauseAnimationsWhenHidden??!0)}shouldSkipSettingsUpdate(){return this.settingsUpdatesPaused||!this.isVisible&&(this.viewportOptions.pauseSettingsUpdatesWhenHidden??!0)}cleanupViewportTracking(){this.untrackViewport&&(this.untrackViewport(),delete this.untrackViewport),this.resumeTimeoutId&&(clearTimeout(this.resumeTimeoutId),delete this.resumeTimeoutId)}getVisibilityInfo(){return{isVisible:this.isVisible,animationsPaused:this.animationsPaused,settingsUpdatesPaused:this.settingsUpdatesPaused,...this.visibilityState?.intersectionRatio!==void 0&&{intersectionRatio:this.visibilityState.intersectionRatio}}}}});var Ui,bs=y(()=>{"use strict";G();ei();U();ys();Z();Me();ie();k();Ui=class l extends zi{constructor(e=M,i=D,a=null,r=null,n,s={}){super({visibilityThreshold:.2,pauseAnimationsWhenHidden:!1,pauseSettingsUpdatesWhenHidden:!0,resumeDelay:50,...s});this.cssBatcher=null;this.performanceAnalyzer=null;this.observers=[];this.musicSyncService=null;this.currentQualityLevel=null;this.qualityCapabilities=[];this.effectCoordinationCallbacks=new Set;this.config=e,this.utils=i,this.cssBatcher=a,this.performanceAnalyzer=r,this.settingsManager=n,this.isSupported=this.detectBackdropFilterSupport(),this.currentIntensity="balanced",this.musicTemperatureMapper=new J(!0),this.oklabProcessor=new E(!0),this.effectPreset=E.getPreset("STANDARD"),this.effectState={currentMusicMood:"neutral",musicIntensity:.5,beatPhase:0,lastBeatTime:0,effectIntensityLevel:0,dynamicAccentHex:"#cba6f7",dynamicAccentRgb:"203,166,247",overallIntensityLevel:.5,genreStyle:"standard",animationRate:1}}static getInstance(){if(!l.instance)throw new Error("GlassmorphismManager instance not initialized");return l.instance}async initializeSystem(){let e=globalThis.year3000System;this.cssController=e?.cssController||P();let i=this.settingsManager.get("sn-glassmorphism-level");this.applyGlassmorphismSettings(i),await this.initializeMusicIntegration()}async performHealthCheck(){return{healthy:!0,ok:!0,details:"GlassmorphismManager is operational.",issues:[],system:"GlassmorphismManager"}}performAnimationUpdate(e){}performDestroy(){this.observers.forEach(e=>e.disconnect()),this.observers=[]}performSettingsUpdate(e){let i=e,{key:a,value:r}=i.detail||{};a===Jr&&(this.applyGlassmorphismSettings(r),this.updateGlassVariables(this.currentIntensity))}onBecomingVisible(){if(this.currentIntensity!=="disabled"){let e=document.documentElement,a=getComputedStyle(e).getPropertyValue("--spice-rgb-accent").trim();a&&a!==""&&this.updateGlassColors(`rgb(${a})`,`rgb(${a})`)}}onBecomingHidden(){}detectBackdropFilterSupport(){try{return CSS.supports("backdrop-filter","blur(1px)")||CSS.supports("-webkit-backdrop-filter","blur(1px)")}catch(e){return console.warn("StarryNight: CSS.supports not available, assuming no backdrop-filter support",e),!1}}applyGlassmorphismSettings(e){let i=document.body;i.classList.remove("sn-glass-disabled","sn-glass-minimal","sn-glass-balanced","sn-glass-intense"),i.classList.add(`sn-glass-${e}`),this.currentIntensity=e,this.updateGlassVariables(e)}updateGlassVariables(e){let i=document.documentElement,a=this.performanceAnalyzer?.shouldReduceQuality()||!1,r,n,s;switch(e){case"disabled":i.style.removeProperty("--glass-blur"),i.style.removeProperty("--glass-opacity"),i.style.removeProperty("--glass-saturation");return;case"minimal":r=a?"2px":"3px",n="0.05",s="1.05";break;case"moderate":r=a?"3px":"5px",n="0.08",s="1.15";break;case"intense":r=a?"6px":"8px",n="0.15",s="1.4";break;case"balanced":default:r=a?"4px":"6px",n="0.1",s="1.2";break}let o=this.calculateMusicModulations(),c=this.modulateBlurValue(r,o),m=this.modulateOpacityValue(n,o),d=this.modulateSaturationValue(s,o),h={"--glass-blur":c,"--glass-opacity":m,"--glass-saturation":d,"--glass-animation-rate":`${this.effectState.animationRate}s`,"--glass-visual-effects-level":this.effectState.overallIntensityLevel.toString()};this.cssController.batchSetVariables("GlassmorphismManager",h,"high","glass-properties-update")}updateGlassColors(e,i){if(this.currentIntensity==="disabled")return;let a=this.convertToGlassColor(e,.1),r=this.convertToGlassColor(i,.08),n={"--glass-background":a,"--glass-border":r};this.cssController.batchSetVariables("GlassmorphismManager",n,"high","glass-color-update")}convertToGlassColor(e,i){try{if(typeof e!="string")return this.getThemeAwareFallback(i);if(e.startsWith("rgb")){let a=e.match(/\d+/g);if(a&&a.length>=3)return`rgba(${a[0]}, ${a[1]}, ${a[2]}, ${i})`}if(e.startsWith("#")){let a=e.slice(1),r=parseInt(a.substring(0,2),16),n=parseInt(a.substring(2,4),16),s=parseInt(a.substring(4,6),16);if(!isNaN(r)&&!isNaN(n)&&!isNaN(s))return`rgba(${r}, ${n}, ${s}, ${i})`}return this.getThemeAwareFallback(i)}catch{return this.getThemeAwareFallback(i)}}getThemeAwareFallback(e){let i=document.documentElement,a=getComputedStyle(i);if(this.effectState.dynamicAccentRgb&&this.effectState.dynamicAccentRgb!=="203,166,247")return`rgba(${this.effectState.dynamicAccentRgb}, ${e})`;let r=a.getPropertyValue("--sn-dynamic-accent-rgb").trim()||a.getPropertyValue("--sn-color-accent-rgb").trim()||a.getPropertyValue("--spice-rgb-accent").trim();if(r&&r!==""&&!r.includes("undefined"))return`rgba(${r}, ${e})`;let n=a.getPropertyValue("--spice-rgb-text").trim();return n&&n!==""&&!n.includes("undefined")?`rgba(${n}, ${e})`:`rgba(203, 166, 247, ${e})`}async initializeMusicIntegration(){try{p.subscribe("colors:extracted",e=>{this.onColorsExtracted(e)},"GlassmorphismManager"),p.subscribe("colors:harmonized",e=>{this.onColorsHarmonized(e)},"GlassmorphismManager"),p.subscribe("music:beat",e=>{this.onMusicBeat(e)},"GlassmorphismManager"),p.subscribe("music:dramatic-peak-detected",e=>{this.onCinematicDramaEvent(e)},"GlassmorphismManager"),this.updateDynamicAccentColor(),this.initializeCrossSystemCoordination(),console.log("[GlassmorphismManager] \u2705 Year 3000 visual-effects integration initialized")}catch(e){console.error("[GlassmorphismManager] Failed to initialize visual-effects integration:",e)}}calculateMusicModulations(){let{musicIntensity:e,beatPhase:i,effectIntensityLevel:a,overallIntensityLevel:r}=this.effectState,n=1+(e-.5)*.4,s=1+Math.sin(i)*r*.15,o=1+a*.3,c=1+Math.sin(Date.now()*this.effectState.animationRate*.001)*.08;return{musicModulation:n,beatModulation:s,cinematicModulation:o,animationModulation:c}}modulateBlurValue(e,i){let a=parseFloat(e.replace("px","")),{musicModulation:r,beatModulation:n,animationModulation:s}=i,o=a*r*n*s;return`${Math.max(1,Math.round(o))}px`}modulateOpacityValue(e,i){let a=parseFloat(e),{musicModulation:r,cinematicModulation:n,animationModulation:s}=i,o=a*(1+(r-1)*.5)*n*s;return Math.max(.01,Math.min(1,o)).toFixed(3)}modulateSaturationValue(e,i){let a=parseFloat(e),{musicModulation:r,beatModulation:n,cinematicModulation:s}=i,o=a*r*n*s;return Math.max(1,Math.min(3,o)).toFixed(2)}onColorsExtracted(e){let{rawColors:i,musicData:a}=e;if(a){let r=this.musicTemperatureMapper.mapMusicToEmotionalTemperature(a);this.updateMusicState(r)}}onColorsHarmonized(e){let{processedColors:i,coordinationMetrics:a}=e;if(i.VIBRANT){let r=this.oklabProcessor.processColor(i.VIBRANT,this.effectPreset);this.effectState.dynamicAccentHex=r.enhancedHex,this.effectState.dynamicAccentRgb=`${r.enhancedRgb.r},${r.enhancedRgb.g},${r.enhancedRgb.b}`,this.updateGlassColors(r.enhancedHex,r.enhancedHex)}a?.overallIntensityLevel!==void 0&&(this.effectState.overallIntensityLevel=a.overallIntensityLevel)}onMusicBeat(e){let{beat:i,intensity:a,timestamp:r}=e;this.effectState.beatPhase+=Math.PI*2*.5,this.effectState.lastBeatTime=r||Date.now(),a>.8&&this.currentIntensity!=="disabled"&&this.applyBeatSyncGlassPulse(a)}onCinematicDramaEvent(e){let{intensity:i,type:a}=e;this.effectState.effectIntensityLevel=i,i>.7&&this.currentIntensity!=="disabled"&&this.applyDramaticGlassDistortion(i)}updateMusicState(e){switch(this.effectState.currentMusicMood=e.primaryEmotion,this.effectState.musicIntensity=e.intensity,e.primaryEmotion){case"energetic":case"aggressive":this.effectState.animationRate=1.5,this.effectPreset=E.getPreset("COSMIC");break;case"calm":case"ambient":this.effectState.animationRate=.7,this.effectPreset=E.getPreset("SUBTLE");break;default:this.effectState.animationRate=1,this.effectPreset=E.getPreset("STANDARD")}}applyBeatSyncGlassPulse(e){if(!this.cssBatcher||!!1)return;let a=this.getIntensityValue(this.currentIntensity),r=e*2*(a.opacity*10),n=e*.05*a.opacity;this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-blur",`${r}px`),this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-opacity",n.toString()),setTimeout(()=>{this.cssBatcher&&(this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-blur","0px"),this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-opacity","0"))},150)}applyDramaticGlassDistortion(e){if(!this.cssBatcher)return;let i=e*4,a=1+e*.5;this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-blur",`${i}px`),this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-saturation",a.toString()),setTimeout(()=>{this.cssBatcher&&(this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-blur","0px"),this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-saturation","1"))},1200)}updateDynamicAccentColor(){let e=document.documentElement,i=getComputedStyle(e),a=i.getPropertyValue("--sn-dynamic-accent-hex").trim()||i.getPropertyValue("--sn-color-accent-hex").trim()||i.getPropertyValue("--spice-accent").trim(),r=i.getPropertyValue("--sn-dynamic-accent-rgb").trim()||i.getPropertyValue("--sn-color-accent-rgb").trim()||i.getPropertyValue("--spice-rgb-accent").trim();a&&a!==""&&(this.effectState.dynamicAccentHex=a),r&&r!==""&&(this.effectState.dynamicAccentRgb=r)}getConsciousnessState(){return{...this.effectState}}setQualityLevel(e){this.adjustQuality(e)}adjustQuality(e){this.currentQualityLevel=e;let i;switch(e){case"low":i="minimal";break;case"medium":i="balanced";break;case"high":i="intense";break;default:i="balanced";break}this.applyGlassmorphismSettings(i),console.log(`[GlassmorphismManager] Quality level set to: ${e} (intensity: ${i})`)}getPerformanceImpact(){let e=this.currentIntensity==="disabled"?0:this.currentIntensity==="minimal"?.1:this.currentIntensity==="balanced"?.3:this.currentIntensity==="intense"?.5:.2,i=this.effectState.overallIntensityLevel*.1,a=this.effectState.animationRate>1?.05:0;return{fps:60,frameTime:e+i+a,memoryUsage:e*2,cpuUsage:(e+i)*50}}reduceQuality(e){if(this.currentQualityLevel){if(this.effectState.overallIntensityLevel=Math.max(.1,this.effectState.overallIntensityLevel-e),this.effectState.animationRate=Math.max(.5,this.effectState.animationRate-e*.5),e>.5)switch(this.currentIntensity){case"intense":this.applyGlassmorphismSettings("balanced");break;case"balanced":this.applyGlassmorphismSettings("minimal");break;case"minimal":this.applyGlassmorphismSettings("disabled");break}console.log(`[GlassmorphismManager] Quality reduced by ${e}`)}}increaseQuality(e){if(this.currentQualityLevel){if(this.effectState.overallIntensityLevel=Math.min(1,this.effectState.overallIntensityLevel+e),this.effectState.animationRate=Math.min(2,this.effectState.animationRate+e*.5),e>.5)switch(this.currentIntensity){case"disabled":this.applyGlassmorphismSettings("minimal");break;case"minimal":this.applyGlassmorphismSettings("balanced");break;case"balanced":this.applyGlassmorphismSettings("intense");break}console.log(`[GlassmorphismManager] Quality increased by ${e}`)}}getQualityCapabilities(){return this.qualityCapabilities.length===0&&(this.qualityCapabilities=[{name:"Backdrop Filter Blur",enabled:this.isSupported&&this.currentIntensity!=="disabled",qualityLevel:"high"},{name:"Glass Saturation",enabled:this.currentIntensity!=="disabled",qualityLevel:"low"},{name:"Consciousness Breathing",enabled:!0,qualityLevel:"low"},{name:"Beat Sync Pulse",enabled:!0,qualityLevel:"low"},{name:"Dramatic Distortion",enabled:!0,qualityLevel:"medium"}]),this.qualityCapabilities}async refreshColorState(e){try{if(this.updateDynamicAccentColor(),this.effectState.dynamicAccentHex){let i=this.oklabProcessor.processColor(this.effectState.dynamicAccentHex,this.effectPreset);this.effectState.dynamicAccentHex=i.enhancedHex,this.effectState.dynamicAccentRgb=`${i.enhancedRgb.r},${i.enhancedRgb.g},${i.enhancedRgb.b}`,this.updateGlassColors(i.enhancedHex,i.enhancedHex)}console.log(`[GlassmorphismManager] Color state refreshed for trigger: ${e}`)}catch(i){console.error("[GlassmorphismManager] Error refreshing color state:",i)}}onConsciousnessCoordination(e){return this.effectCoordinationCallbacks.add(e),()=>{this.effectCoordinationCallbacks.delete(e)}}synchronizeConsciousnessState(e){e.currentMusicMood&&(this.effectState.currentMusicMood=e.currentMusicMood),e.musicIntensity!==void 0&&(this.effectState.musicIntensity=e.musicIntensity),e.beatPhase!==void 0&&(this.effectState.beatPhase=e.beatPhase),e.effectIntensityLevel!==void 0&&(this.effectState.effectIntensityLevel=e.effectIntensityLevel),e.overallIntensityLevel!==void 0&&(this.effectState.overallIntensityLevel=e.overallIntensityLevel),e.dynamicAccentHex&&(this.effectState.dynamicAccentHex=e.dynamicAccentHex),e.dynamicAccentRgb&&(this.effectState.dynamicAccentRgb=e.dynamicAccentRgb),e.genreStyle&&(this.effectState.genreStyle=e.genreStyle),e.animationRate!==void 0&&(this.effectState.animationRate=e.animationRate),this.updateGlassVariables(this.currentIntensity),this.broadcastConsciousnessState()}broadcastConsciousnessState(){this.effectCoordinationCallbacks.forEach(e=>{try{e(this.effectState)}catch(i){console.error("[GlassmorphismManager] Error in visual-effects coordination callback:",i)}})}updateMusicStateWithCoordination(e){this.updateMusicState(e),this.broadcastConsciousnessState(),p.emit("visual-effects:coordination",{source:"GlassmorphismManager",state:this.convertToVisualEffectsState(this.effectState),timestamp:Date.now()})}onMusicBeatWithCoordination(e){this.onMusicBeat(e),this.broadcastConsciousnessState(),p.subscribe("music:beat-sync",i=>{i.source!=="GlassmorphismManager"&&(this.effectState.beatPhase=i.beatPhase,this.effectState.lastBeatTime=i.lastBeatTime)},"GlassmorphismManager")}onCinematicDramaEventWithCoordination(e){this.onCinematicDramaEvent(e),this.broadcastConsciousnessState(),p.subscribe("music:dramatic-sync",i=>{i.source!=="GlassmorphismManager"&&(this.effectState.effectIntensityLevel=i.dramaticLevel,i.dramaticLevel>.7&&this.applyDramaticGlassDistortion(i.dramaticLevel))},"GlassmorphismManager")}initializeCrossSystemCoordination(){try{p.subscribe("visual-effects:coordination",e=>{e.source!=="GlassmorphismManager"&&this.synchronizeConsciousnessState(this.convertFromVisualEffectsState(e.state))},"GlassmorphismManager"),p.subscribe("music:beat-sync",e=>{e.source!=="GlassmorphismManager"&&(this.effectState.beatPhase=e.beatPhase,this.effectState.lastBeatTime=e.lastBeatTime,this.applyCoordinatedBeatPulse(e.beatPhase))},"GlassmorphismManager"),p.subscribe("music:dramatic-sync",e=>{e.source!=="GlassmorphismManager"&&(this.effectState.effectIntensityLevel=e.dramaticLevel,this.applyCoordinatedDramaticEffects(e.dramaticLevel,e.type||"unknown"))},"GlassmorphismManager"),console.log("[GlassmorphismManager] \u2705 Cross-system visual-effects coordination initialized")}catch(e){console.error("[GlassmorphismManager] Failed to initialize cross-system coordination:",e)}}checkPerformanceAndAdjust(){this.performanceAnalyzer?.shouldReduceQuality()&&(this.currentIntensity==="intense"?this.applyGlassmorphismSettings("balanced"):(this.currentIntensity==="balanced"||this.currentIntensity==="moderate")&&this.applyGlassmorphismSettings("minimal"))}applyGlassmorphism(e){let i=this.config.glassmorphism[e];this.cssBatcher&&(this.cssBatcher.queueCSSVariableUpdate("--sn-glass-display",e==="disabled"?"none":"block"),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-blur",`${i.blur}px`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-saturation",`${i.saturation}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-brightness",`${i.brightness}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-noise-opacity",`${i.noiseOpacity}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-border-opacity",`${i.borderOpacity}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-shadow-opacity",`${i.shadowOpacity}`),this.cssBatcher.flushCSSVariableBatch(),this.config.enableDebug&&console.log(`\u{1F48E} [GlassmorphismManager] Applied level: ${e}`))}applyUpdatedSettings(e,i){e==="sn-glassmorphism-level"&&(this.applyGlassmorphismSettings(i),this.updateGlassVariables(this.currentIntensity))}applyCoordinatedBeatPulse(e){let i=this.calculateMusicModulations(),a=this.getIntensityValue(this.currentIntensity),r=1+Math.sin(e)*.15*i.beatModulation,n=a.opacity*r;this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-opacity",n.toString()),this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-accent-opacity",(n*.8).toString()),this.cssBatcher?.flushCSSVariableBatch()}applyCoordinatedDramaticEffects(e,i){let a=this.calculateMusicModulations(),r=this.getIntensityValue(this.currentIntensity),n=1+e*.4,s=Math.min(1,r.opacity*n),o=Math.min(20,r.blur*(1+e*.3));this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-opacity",s.toString()),this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-blur",`${o}px`),this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-accent-opacity",(s*.9).toString()),this.cssBatcher?.flushCSSVariableBatch(),setTimeout(()=>{this.updateGlassVariables(this.currentIntensity)},1500)}getIntensityValue(e){switch(e){case"disabled":return{opacity:0,blur:0,saturation:1};case"minimal":return{opacity:.05,blur:3,saturation:1.05};case"balanced":return{opacity:.1,blur:6,saturation:1.2};case"intense":return{opacity:.15,blur:8,saturation:1.4};case"moderate":return{opacity:.08,blur:5,saturation:1.15};default:return{opacity:.1,blur:6,saturation:1.2}}}convertToVisualEffectsState(e){return{intensity:e.effectIntensityLevel,colorTemperature:6500,animationScale:e.musicIntensity,dominantEmotion:e.currentMusicMood,resonance:e.musicIntensity,symbioticResonance:e.musicIntensity,surfaceFluidityIndex:e.musicIntensity,animationScaleRate:e.effectIntensityLevel,emotionalTemperature:6500,pulsingCycle:e.beatPhase,cinematicIntensity:e.effectIntensityLevel}}convertFromVisualEffectsState(e){return{currentMusicMood:e.dominantEmotion,musicIntensity:e.intensity,effectIntensityLevel:e.intensity,overallIntensityLevel:e.intensity}}}});function qe(l,t={}){if(!kl)return Array.from(document.querySelectorAll(l));let e=cr.get(l),i=e?.ref?.deref();return(t.force||!i)&&(i=Array.from(document.querySelectorAll(l)),e={ref:new WeakRef(i),lastUpdate:Date.now()},cr.set(l,e),Vl?.register(i,l)),i}var cr,kl,Rl,Vl,Ss=y(()=>{"use strict";cr=new Map,kl=typeof WeakRef<"u",Rl=typeof FinalizationRegistry<"u",Vl=Rl?new FinalizationRegistry(l=>{cr.delete(l)}):null});function kt(l){return qe(l).length>0}function Fl(l,t,e){let i=qe(l,e);return i.length===0&&t&&(i=qe(t,e),i.length>0&&console.warn(`\u{1F30C} [SpotifyDOMSelectors] Using legacy selector: ${t}. Consider updating to: ${l}`)),i}function Gl(){console.group("\u{1F30C} [SpotifyDOMSelectors] DOM Validation");let l={found:0,missing:0,details:{}};return Object.entries(L).forEach(([t,e])=>{let i=kt(e);l.details[t]={selector:e,exists:i,element:i&&qe(e)[0]||null},i?(l.found++,console.log(`\u2705 ${t}: ${e}`)):(l.missing++,console.warn(`\u274C ${t}: ${e}`))}),console.log(`\u{1F4CA} Summary: ${l.found} found, ${l.missing} missing`),console.groupEnd(),l}function _l(){console.group("\u{1F30C} [Phase 1] Testing Gravity System Selectors"),console.log("\u{1F3AF} Primary gravity well targets:"),Lt.primary&&Lt.primary.forEach(l=>{let t=qe(l)[0]||null;console.log(`${t?"\u2705":"\u274C"} ${l}`,t)}),console.log("\u{1F3AF} Secondary gravity well targets:"),Lt.secondary&&Lt.secondary.forEach(l=>{let t=qe(l)[0]||null;console.log(`${t?"\u2705":"\u274C"} ${l}`,t)}),console.log("\u{1F6F8} Orbital elements:"),Object.entries(Ye).forEach(([l,t])=>{let e=qe(t);console.log(`${e.length>0?"\u2705":"\u274C"} ${l} (${t}): ${e.length} found`)}),console.groupEnd()}function vs(){console.group("\u{1F52E} [SpotifyDOMSelectors] Phase 2 - Prediction Target Validation");let l=[{name:"Track Rows",selector:Ye.trackRows},{name:"Progress Bar",selector:L.progressBar},{name:"Play Button",selector:L.playButton},{name:"Heart Button",selector:L.heartButton},{name:"Album Cover",selector:L.albumCover},{name:"Now Playing Widget",selector:L.nowPlayingWidget},{name:"Now Playing Left",selector:L.nowPlayingLeft},{name:"Left Sidebar",selector:L.leftSidebar},{name:"Library Items",selector:Ye.libraryItems}],t={found:0,missing:0,details:{}};return l.forEach(({name:e,selector:i})=>{if(!i)return;let r=Fl(i).length;t.details[e]={selector:i,count:r,exists:r>0},r>0?(t.found++,console.log(`\u2705 ${e}: ${r} elements found (${i})`)):(t.missing++,console.warn(`\u274C ${e}: No elements found (${i})`))}),console.log(`\u{1F4CA} Prediction Targets Summary: ${t.found} types found, ${t.missing} missing`),console.groupEnd(),t}function Hl(){console.group("\u{1F30C} [SpotifyDOMSelectors] Phase 2 - System Integration Test");let l={behavioralPrediction:vs(),dimensionalNexus:{sidebarElement:L.leftSidebar?kt(L.leftSidebar):!1},dataGlyph:{navLinks:L.navBarLink?kt(L.navBarLink):!1,trackRows:Ye.trackRows?kt(Ye.trackRows):!1,cards:Ye.cards?kt(Ye.cards):!1}},t=0;return Object.values(l).forEach(e=>{typeof e=="object"&&e.missing&&(t+=e.missing)}),console.log(`\u{1F3AF} Phase 2 Integration Health: ${t===0?"\u2705 All systems operational":`\u26A0\uFE0F ${t} issues detected`}`),console.groupEnd(),l}var L,Ep,Ye,Lt,Bl,ur=y(()=>{"use strict";Ss();L={nowPlayingBar:".Root__now-playing-bar",leftSidebar:".Root__nav-bar",mainView:".Root__main-view",rightSidebar:".Root__right-sidebar",nowPlayingWidget:"[data-testid='now-playing-widget']",nowPlayingLeft:".main-nowPlayingBar-left",nowPlayingCenter:".main-nowPlayingBar-center",nowPlayingRight:".main-nowPlayingBar-right",coverArt:".main-coverSlotCollapsed-container",trackInfo:".main-trackInfo-container",navMain:"nav[aria-label='Main']",yourLibrary:".main-yourLibraryX-libraryContainer",libraryItems:".main-yourLibraryX-listItem",libraryHeader:".main-yourLibraryX-header",playlistList:".main-rootlist-wrapper",trackListContainer:"[role='grid'][aria-label*='tracks']",trackRow:".main-trackList-trackListRow",trackListHeader:".main-trackList-trackListHeaderRow",trackNumber:".main-trackList-rowSectionIndex",trackTitle:".main-trackList-rowTitle",trackArtist:".main-trackList-rowSubTitle",entityHeader:".main-entityHeader-container",entityTitle:".main-entityHeader-title",entityMetadata:".main-entityHeader-metaData",entityImage:".main-entityHeader-imageContainer",actionBar:".main-actionBar-ActionBarRow",actionBarInner:".main-actionBar-ActionBar",playButton:"[data-testid='play-button']",pauseButton:"[data-testid='pause-button']",shuffleButton:"[data-testid='shuffle-button']",likeButton:".control-button-heart",queue:".main-queue-trackList",queueContainer:"[aria-label='Next in queue']",aboutArtist:"[aria-label='About the artist']",credits:"[aria-label='Credits']",searchInput:"[data-testid='search-input']",searchPage:"[data-testid='search-container']",filterPills:".main-genre-chip",sortButton:"[data-testid='sort-button']",card:".main-card-card",cardImage:".main-cardImage-image",albumArt:".main-trackList-albumArt",modal:".main-modal-container",overlay:".main-overlay-container"},Ep=Object.entries({".main-nowPlayingWidget-nowPlaying":L.nowPlayingBar,".main-navBar-navBar":L.leftSidebar,".main-search-searchBar":L.searchInput,".main-topBar-topBar":L.actionBar,".main-queue-queue":L.queue,".main-trackList-trackList":L.trackListContainer}).reduce((l,[t,e])=>(typeof e=="string"&&(l[t]=e),l),{}),Ye={trackRows:L.trackRow??"",libraryItems:L.libraryItems??"",cards:L.card??"",navLinks:".main-navBar-navBarLink"},Lt={primary:[L.nowPlayingBar,L.leftSidebar,L.entityHeader].filter(l=>!!l),secondary:[L.actionBar,L.queue,L.searchInput].filter(l=>!!l),tertiary:[L.playButton,L.trackListHeader].filter(l=>!!l)},Bl={searchAreas:[L.searchInput,L.searchPage].filter(l=>!!l),notifications:["[data-testid='notification-bar']",".main-topBar-notifications"],dropdowns:[".main-dropdown-menu","[role='menu']","[role='listbox']"]};typeof window<"u"&&(window.SpotifyDOMSelectors={validate:Gl,testGravity:_l,validatePredictionTargets:vs,testPhase2Systems:Hl,selectors:L,targets:Lt,orbital:Ye,antiGravity:Bl},console.log("\u{1F3AF} [SpotifyDOMSelectors] Debug functions available:"),console.log("  window.SpotifyDOMSelectors.validate() - Test all selectors"),console.log("  window.SpotifyDOMSelectors.testGravity() - Test gravity selectors"))});var Cs={};te(Cs,{SidebarPerformanceCoordinator:()=>Ol,SidebarPerformanceManager:()=>je,getSidebarPerformanceCoordinator:()=>Ul,getSidebarPerformanceManager:()=>zl});function zl(l){return je.getInstance(l)}function Ul(l){return je.getInstance(l)}var Ie,je,Ol,mr=y(()=>{"use strict";k();U();wi();ur();Ie=class Ie{constructor(t={}){this.pendingUpdates=new Map;this.isFlushScheduled=!1;this.rafId=null;this.performanceAnalyzer=null;this.harmonicVariableMap=new Map([["--sn-rs-beat-intensity","--sn-beat-pulse-intensity"],["--sn-rs-glow-alpha","--sn-rhythm-phase"],["--sn-rs-hue-shift","--sn-spectrum-phase"]]);this.flushCount=0;this.totalFlushTime=0;this.lastFlushTimestamp=0;this.budgetManager=null;this.domObserver=null;this.sidebarElement=null;this.visibilityObserver=null;this.observationThrottleTimer=null;this.lastObservationTime=0;this.OBSERVATION_THROTTLE_MS=200;this.isFirstOpen=!0;this.lastScrollUpdate=0;this.activeTimeouts=new Set;this.domObservationRetryTimeout=null;this.musicChangeUnsubscribe=null;this.config={enableDebug:t.enableDebug??!1,maxBatchSize:t.maxBatchSize??50,...t},this.performanceAnalyzer=t.performanceAnalyzer||null;let e=globalThis.year3000System;this.cssController=e.getGlobalOptimizedCSSController(),this.performanceAnalyzer&&(this.budgetManager=Pe.getInstance(void 0,this.performanceAnalyzer)),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceManager] Initialized with RAF-based batching")}static getInstance(t){return Ie.instance||(Ie.instance=new Ie(t)),Ie.instance}queueUpdate(t,e){if(["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift"].includes(t)){this.applyCriticalUpdate(t,e);return}try{P().queueCSSVariableUpdate(t,e,this.getSidebarElement())}catch{this.pendingUpdates.set(t,{property:t,value:e,timestamp:performance.now()}),this.config.enableDebug&&this.pendingUpdates.size===1&&console.log(`\u{1F30C} [SidebarPerformanceManager] Queuing first update (fallback): ${t}`),this.scheduleFlush()}}applyCriticalUpdate(t,e){try{this.cssController.queueCSSVariableUpdate(t,e,null,"critical","sidebar-critical-update")}catch(i){console.error(`\u{1F30C} [SidebarPerformanceManager] Failed to apply critical ${t}:`,i)}}getSidebarElement(){return this.sidebarElement||(this.sidebarElement=document.querySelector(L.rightSidebar)),this.sidebarElement||document.documentElement}scheduleFlush(){this.isFlushScheduled||(this.isFlushScheduled=!0,this.rafId=requestAnimationFrame(()=>{this.flushUpdates()}))}flushUpdates(){if(this.pendingUpdates.size===0){this.isFlushScheduled=!1;return}let t=performance.now(),e=this.getSidebarElement(),i=this.pendingUpdates.size;this.config.enableDebug&&console.log(`\u{1F30C} [SidebarPerformanceManager] Flushing ${i} updates atomically`),i>(this.config.maxBatchSize||50)&&console.warn(`\u{1F30C} [SidebarPerformanceManager] Large batch detected (${i} updates), may impact performance`);try{let s={},o={};for(let c of this.pendingUpdates.values()){s[c.property]=c.value;let m=this.harmonicVariableMap.get(c.property);m&&(o[m]=c.value,this.config.enableDebug&&console.log(`\u{1F30C} [SidebarPerformanceManager] Mapped ${c.property} \u2192 ${m} = ${c.value}`))}if(Object.keys(s).length>0){let c=e;for(let[m,d]of Object.entries(s))c.style.setProperty(m,d)}Object.keys(o).length>0&&this.cssController.batchSetVariables("SidebarPerformanceManager",o,"high","harmonic-variable-mapping")}catch(s){console.error("\u{1F30C} [SidebarPerformanceManager] Failed to apply batched updates:",s)}if(this.pendingUpdates.clear(),this.isFlushScheduled=!1,this.rafId=null,this.config.onFlushComplete)try{this.config.onFlushComplete()}catch(s){console.error("\u{1F30C} [SidebarPerformanceManager] Error in flush completion callback:",s)}let a=performance.now(),r=a-t;this.flushCount++,this.totalFlushTime+=r,this.lastFlushTimestamp=a,this.performanceAnalyzer&&this.performanceAnalyzer.emitTrace?.(`[SidebarPerformanceManager] Flushed ${i} updates in ${r.toFixed(2)}ms`);let n=this.flushCount>0?this.totalFlushTime/this.flushCount:0;n>3&&console.warn(`\u{1F30C} [SidebarPerformanceManager] Performance threshold exceeded: average ${n.toFixed(2)}ms per flush (target: <3ms)`),this.config.enableDebug&&r>4&&console.warn(`\u{1F30C} [SidebarPerformanceManager] Slow flush detected: ${r.toFixed(2)}ms for ${i} updates`)}setupMusicChangeCoordination(){this.musicChangeUnsubscribe||(this.musicChangeUnsubscribe=()=>{p.unsubscribeAll("SidebarPerformanceManager")},p.subscribe("music:track-changed",t=>{this.handleMusicChange({timestamp:t.timestamp,source:"track-changed",reason:"music:track-changed event"})},"SidebarPerformanceManager"),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceManager] Event-driven music coordination active"))}handleMusicChange(t){this.sidebarElement&&(this.handleVisibilityChange(),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceManager] Music change coordinated via event",{source:t.source,reason:t.reason,timestamp:t.timestamp}))}setupDOMObservation(){if(!this.domObserver){if(this.setupMusicChangeCoordination(),this.sidebarElement=document.querySelector(L.rightSidebar),!this.sidebarElement){this.config.enableDebug&&console.warn("\u{1F30C} [SidebarPerformanceManager] Sidebar not found, deferring DOM observation"),this.domObservationRetryTimeout&&(clearTimeout(this.domObservationRetryTimeout),this.activeTimeouts.delete(this.domObservationRetryTimeout)),this.domObservationRetryTimeout=setTimeout(()=>{this.setupDOMObservation(),this.domObservationRetryTimeout=null},1e3),this.activeTimeouts.add(this.domObservationRetryTimeout);return}this.domObserver=new MutationObserver(t=>{let e=t.filter(i=>this.isRelevantMutation(i));e.length!==0&&this.throttleObservationUpdate(()=>{for(let i of e)i.type==="attributes"&&(i.attributeName==="aria-hidden"||i.attributeName==="style")&&this.handleVisibilityChange();this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceManager] Relevant DOM change detected - visibility/structure only",{mutationCount:e.length,types:e.map(i=>i.type)})})}),this.domObserver.observe(this.sidebarElement,{childList:!0,subtree:!1,attributes:!0,attributeFilter:["aria-hidden","style","class"],attributeOldValue:!1,characterData:!1}),this.setupVisibilityObserver(),this.setupScrollObservation(),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceManager] DOM observation active on sidebar")}}setupVisibilityObserver(){!this.sidebarElement||this.visibilityObserver||(this.visibilityObserver=new IntersectionObserver(t=>{let e=t[0];e&&e.isIntersecting&&this.isFirstOpen&&(window.requestIdleCallback?window.requestIdleCallback(()=>{this.triggerTemporalEcho(),this.isFirstOpen=!1}):setTimeout(()=>{this.triggerTemporalEcho(),this.isFirstOpen=!1},0))},{threshold:.1}),this.visibilityObserver.observe(this.sidebarElement))}setupScrollObservation(){if(!this.sidebarElement)return;let t=this.sidebarElement.querySelector(".main-nowPlayingView-queue");t&&t.addEventListener("scroll",this.throttledScrollHandler.bind(this),{passive:!0})}throttledScrollHandler(){let t=performance.now();t-this.lastScrollUpdate<33||(this.lastScrollUpdate=t,window.requestIdleCallback?window.requestIdleCallback(()=>{this.queueUpdate("--sn-rs-scroll-ratio",Math.random().toString())},{timeout:100}):this.queueUpdate("--sn-rs-scroll-ratio",Math.random().toString()))}isRelevantMutation(t){if(t.type==="attributes"){let e=t.attributeName;return e==="aria-hidden"||e==="style"||e==="class"?!0:(e?.startsWith("--")||e==="data-style",!1)}return t.type==="childList"?t.addedNodes&&Array.from(t.addedNodes).some(i=>i.nodeType===Node.ELEMENT_NODE)||t.removedNodes&&Array.from(t.removedNodes).some(i=>i.nodeType===Node.ELEMENT_NODE):!1}throttleObservationUpdate(t){let e=performance.now();e-this.lastObservationTime<this.OBSERVATION_THROTTLE_MS?(this.observationThrottleTimer&&clearTimeout(this.observationThrottleTimer),this.observationThrottleTimer=window.setTimeout(()=>{t(),this.lastObservationTime=performance.now(),this.observationThrottleTimer=null},this.OBSERVATION_THROTTLE_MS)):(t(),this.lastObservationTime=e)}handleVisibilityChange(){if(!this.sidebarElement)return;let t=!this.sidebarElement.hasAttribute("aria-hidden")&&!this.sidebarElement.style.display?.includes("none");t&&this.isFirstOpen&&(this.triggerTemporalEcho(),this.isFirstOpen=!1),this.config.enableDebug&&console.log(`\u{1F30C} [SidebarPerformanceManager] Visibility changed: ${t?"visible":"hidden"}`)}triggerTemporalEcho(){if(!this.sidebarElement)return;this.sidebarElement.classList.add("sn-future-preview"),this.queueUpdate("--sn-kinetic-intensity","1"),this.queueUpdate("--sn-echo-hue-shift","15deg"),this.queueUpdate("--sn-echo-radius-multiplier","1.2"),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceManager] Triggering temporal echo effect");let t=setTimeout(()=>{this.sidebarElement?.classList.remove("sn-future-preview"),this.queueUpdate("--sn-kinetic-intensity","0"),this.activeTimeouts.delete(t)},2e3);this.activeTimeouts.add(t)}getPerformanceMetrics(){return{flushCount:this.flushCount,averageFlushTime:this.flushCount>0?this.totalFlushTime/this.flushCount:0,lastFlushTimestamp:this.lastFlushTimestamp,pendingUpdates:this.pendingUpdates.size}}forceFlush(){this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.flushUpdates()}destroy(){if(this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.activeTimeouts.forEach(t=>{clearTimeout(t)}),this.activeTimeouts.clear(),this.domObservationRetryTimeout&&(clearTimeout(this.domObservationRetryTimeout),this.domObservationRetryTimeout=null),this.observationThrottleTimer&&(clearTimeout(this.observationThrottleTimer),this.observationThrottleTimer=null),this.domObserver&&(this.domObserver.disconnect(),this.domObserver=null),this.visibilityObserver&&(this.visibilityObserver.disconnect(),this.visibilityObserver=null),this.musicChangeUnsubscribe&&(this.musicChangeUnsubscribe(),this.musicChangeUnsubscribe=null),this.pendingUpdates.clear(),this.isFlushScheduled=!1,this.sidebarElement=null,Ie.instance===this&&(Ie.instance=null),this.config.enableDebug){let t=this.flushCount>0?this.totalFlushTime/this.flushCount:0;console.log(`\u{1F30C} [SidebarPerformanceManager] Destroyed. Performance: ${this.flushCount} flushes, ${t.toFixed(2)}ms avg`)}}};Ie.instance=null;je=Ie;Ol=je});var Rt,Es=y(()=>{"use strict";Li();mr();G();Rt=class extends We{constructor(e=M){super(e);this.sidebarSystems=new Map;this.integrationEnabled=!1;this.lastFrameTime=0;this.sharedCoordinator=je.getInstance({enableDebug:e.enableDebug,performanceAnalyzer:this.performanceAnalyzer,onFlushComplete:()=>this.handlePerformanceFlush()}),this.performanceMetrics={totalSystems:4,activeSystems:0,bilateralSyncEnabled:!1,averageFrameTime:0,totalMemoryUsage:0,healthStatus:"healthy"},e.enableDebug&&console.log(`[${this.systemName}] Initialized sidebar systems integration`)}async initialize(){this.config.enableDebug&&console.log(`[${this.systemName}] Initializing sidebar systems integration`);try{this.registerSidebarSystems(),await this.registerWithUnifiedRegistry(),await this.initializeSystemsInOrder(),this.setupBilateralCoordination(),this.connectToEventBus(),this.integrateWithPerformanceSystems(),this.registerAnimation(70),this.integrationEnabled=!0,this.updatePerformanceMetrics(),this.publishEvent("sidebar:integration-ready",{systemName:this.systemName,totalSystems:this.sidebarSystems.size,activeSystems:this.performanceMetrics.activeSystems,bilateralSync:this.performanceMetrics.bilateralSyncEnabled,timestamp:Date.now()})}catch(e){throw console.error(`[${this.systemName}] Integration initialization failed:`,e),e}}registerSidebarSystems(){this.consolidatedSidebarSystem&&this.sidebarSystems.set("consolidatedSidebarSystem",{name:"consolidatedSidebarSystem",system:this.consolidatedSidebarSystem,priority:"critical",enabled:!0,dependencies:[]})}async initializeSystemsInOrder(){let e=this.calculateInitializationOrder();for(let i of e){let a=this.sidebarSystems.get(i);if(a&&a.enabled)try{await a.system._baseInitialize(),this.performanceMetrics.activeSystems++,this.config.enableDebug&&console.log(`[${this.systemName}] Initialized ${i}`)}catch(r){console.error(`[${this.systemName}] Failed to initialize ${i}:`,r)}}}calculateInitializationOrder(){let e=new Set,i=new Set,a=[],r=n=>{if(i.has(n))throw new Error(`Circular dependency detected: ${n}`);if(e.has(n))return;i.add(n);let s=this.sidebarSystems.get(n);if(s&&s.dependencies)for(let o of s.dependencies)r(o);i.delete(n),e.add(n),a.push(n)};for(let n of this.sidebarSystems.keys())r(n);return a}setupBilateralCoordination(){this.performanceMetrics.bilateralSyncEnabled=!0,this.subscribeToEvent("sidebar:bilateral-sync",e=>{this.handleBilateralSync(e)}),this.subscribeToEvent("sidebar:visual-level-changed",e=>{this.handleVisualLevelChange(e)})}handleBilateralSync(e){e.source==="orchestrator"&&this.updatePerformanceMetrics()}handleVisualLevelChange(e){let a={dormant:.5,aware:.7,focused:.9,advanced:1}[e.newLevel]||.7;this.adjustPerformanceBudgets(a)}adjustPerformanceBudgets(e){let a=Math.floor(16*e);this.config.enableDebug&&console.log(`[${this.systemName}] Adjusted performance budget to ${a} based on visual intensity level`)}handlePerformanceFlush(){let e=performance.now();if(this.lastFrameTime>0){let i=e-this.lastFrameTime;this.performanceMetrics.averageFrameTime=(this.performanceMetrics.averageFrameTime+i)/2}this.lastFrameTime=e,this.updateHealthStatus()}updatePerformanceMetrics(){this.performanceMetrics.totalSystems=this.sidebarSystems.size;let e=0;for(let[,i]of this.sidebarSystems)i.enabled&&i.system.isInitialized&&e++;this.performanceMetrics.activeSystems=e}updateHealthStatus(){this.performanceMetrics.averageFrameTime>20?this.performanceMetrics.healthStatus="critical":this.performanceMetrics.averageFrameTime>16.67?this.performanceMetrics.healthStatus="degraded":this.performanceMetrics.healthStatus="healthy"}onAnimate(e){if(!this.integrationEnabled)return;this.updatePerformanceMetrics(),this.updateHealthStatus(),performance.now()-this.lastFrameTime>1e3&&this.publishEvent("sidebar:integration-metrics",{metrics:this.performanceMetrics,timestamp:Date.now()})}registerWithAnimationCoordinator(e){if(!e){console.warn(`[${this.systemName}] Animation coordinator not available`);return}for(let[i,a]of this.sidebarSystems)if(a.enabled&&a.system.isInitialized)try{e.registerAnimationSystem(i,a.system,a.priority,60),this.config.enableDebug&&console.log(`[${this.systemName}] Registered ${i} with animation coordinator`)}catch(r){console.error(`[${this.systemName}] Failed to register ${i}:`,r)}}getSidebarSystems(){return new Map(this.sidebarSystems)}getPerformanceMetrics(){return{...this.performanceMetrics}}setSidebarSystemEnabled(e,i){let a=this.sidebarSystems.get(e);a&&(a.enabled=i,!i&&a.system.isInitialized?(a.system._baseDestroy(),this.performanceMetrics.activeSystems--):i&&!a.system.isInitialized&&a.system._baseInitialize().catch(r=>{console.error(`[${this.systemName}] Failed to re-enable ${e}:`,r)}),this.publishEvent("sidebar:system-toggled",{systemName:e,enabled:i,timestamp:Date.now()}))}async healthCheck(){let e={};for(let[r,n]of this.sidebarSystems)if(n.enabled&&n.system.isInitialized)try{e[r]=await n.system.healthCheck()}catch(s){e[r]={healthy:!1,ok:!1,details:`Health check failed: ${s.message}`,issues:[`Health check failed: ${s.message}`],system:r}}let i=Object.values(e).filter(r=>!r.ok),a=i.length===0;return{healthy:a,ok:a,details:`Sidebar integration ${a?"healthy":"degraded"} - ${this.performanceMetrics.activeSystems}/${this.performanceMetrics.totalSystems} systems active, bilateral sync: ${this.performanceMetrics.bilateralSyncEnabled}`,issues:i.map(r=>r.details||"Unknown issue"),system:"SidebarSystemsIntegration"}}async registerWithUnifiedRegistry(){this.config.enableDebug&&console.log(`[${this.systemName}] Sidebar systems are now managed by VisualSystemFacade`)}connectToEventBus(){this.subscribeToEvent("music:beat",e=>{this.handleMusicBeat(e)}),this.subscribeToEvent("music:energy",e=>{this.handleMusicEnergy(e)}),this.subscribeToEvent("performance:threshold-exceeded",e=>{this.handlePerformanceThreshold(e)}),this.subscribeToEvent("user:navigation",e=>{this.handleUserNavigation(e)}),this.config.enableDebug&&console.log(`[${this.systemName}] Connected to EventBus for system-wide communication`)}integrateWithPerformanceSystems(){let e=globalThis.year3000System;if(!e){this.config.enableDebug&&console.log(`[${this.systemName}] Year3000System not available, skipping performance integration`);return}try{let i=e.timerConsolidationSystem;i&&(i.registerTimer("sidebar-performance-monitor",1e3,()=>{this.updatePerformanceMetrics()}),this.config.enableDebug&&console.log(`[${this.systemName}] Integrated with TimerConsolidationSystem`));let a=e.enhancedMasterAnimationCoordinator;a&&(a.registerFrameCallback((r,n)=>{this.bilateralVisualEffectsFrameUpdate(r,n)},"critical","sidebar-bilateral-visual-effects"),this.config.enableDebug&&console.log(`[${this.systemName}] Integrated with EnhancedMasterAnimationCoordinator`))}catch(i){console.error(`[${this.systemName}] Failed to integrate with performance systems:`,i)}}handleMusicBeat(e){if(!this.integrationEnabled)return;let i={intensity:e.intensity||.5,timestamp:e.timestamp||Date.now(),bpm:e.bpm||120};this.config.enableDebug&&console.log(`[${this.systemName}] Processed music beat:`,i)}handleMusicEnergy(e){if(!this.integrationEnabled)return;let i=e.energy||.5;this.adjustPerformanceBudgets(.5+i*.5),this.consolidatedSidebarSystem?.initialized&&this.config.enableDebug&&console.log(`[${this.systemName}] Adapted visual effects to energy level: ${i}`)}handlePerformanceThreshold(e){this.integrationEnabled&&(e.severity==="critical"?(this.performanceMetrics.healthStatus="critical",this.config.enableDebug&&console.warn(`[${this.systemName}] Activated emergency performance mode`)):e.severity==="warning"&&this.performanceMetrics.healthStatus==="critical"&&(this.performanceMetrics.healthStatus="degraded"))}handleUserNavigation(e){if(!this.integrationEnabled)return;let i={action:e.action||"navigate",target:e.target||"unknown",timestamp:e.timestamp||Date.now()};this.config.enableDebug&&console.log(`[${this.systemName}] Processing navigation context:`,i)}bilateralVisualEffectsFrameUpdate(e,i){if(!this.integrationEnabled)return;let a={frameTime:e,timestamp:i};e>16.67&&this.publishEvent("sidebar:frame-time-warning",{frameTime:e,timestamp:i})}destroy(){this.config.enableDebug&&console.log(`[${this.systemName}] Destroying sidebar systems integration`),this.integrationEnabled=!1;let e=globalThis.year3000System;e?.timerConsolidationSystem&&e.timerConsolidationSystem.unregisterTimer("sidebar-performance-monitor");let i=this.calculateInitializationOrder().reverse();for(let a of i){let r=this.sidebarSystems.get(a);if(r&&r.system.isInitialized)try{r.system._baseDestroy(),this.config.enableDebug&&console.log(`[${this.systemName}] Destroyed ${a}`)}catch(n){console.error(`[${this.systemName}] Failed to destroy ${a}:`,n)}}this.sidebarSystems.clear(),this.performanceMetrics={totalSystems:0,activeSystems:0,bilateralSyncEnabled:!1,averageFrameTime:0,totalMemoryUsage:0,healthStatus:"healthy"},this.publishEvent("sidebar:integration-destroyed",{timestamp:Date.now()})}}});var dr,Vt,Oi,hr=y(()=>{"use strict";dr=class extends Error{constructor(e,i,a,r,n){super(e);this.systemKey=i;this.strategy=a;this.context=r;this.cause=n;this.name="SystemCreationError"}},Vt=class extends dr{constructor(e,i,a,r){super(`Missing required dependencies for ${e}: ${a.join(", ")}`,e,i,r);this.missingDependencies=a;this.name="DependencyValidationError"}},Oi=class extends Error{constructor(e,i,a=`No suitable creation strategy found for system: ${e}`){super(a);this.systemKey=e;this.criteria=i;this.name="StrategySelectionError"}}});var Bt,Ni,gr,pr,fr,Ms,ws=y(()=>{"use strict";k();A();hr();Bt=class{constructor(){this.systemConfigs=new Map}validateDependencies(t){let e=this.getRequiredDependencies(t.systemKey),i=this.getOptionalDependencies(t.systemKey),a=[],r=[];for(let n of e)(!(n in t.dependencies)||!t.dependencies[n])&&a.push(n);for(let n of i)(!(n in t.dependencies)||!t.dependencies[n])&&r.push(`Optional dependency missing: ${n}`);return{valid:a.length===0,missing:a,warnings:r}}getRequiredDependencies(t){return this.systemConfigs.get(t)?.requiredDependencies||[]}getOptionalDependencies(t){return this.systemConfigs.get(t)?.optionalDependencies||[]}registerSystemConfig(t){this.systemConfigs.set(t.systemKey,t)}createBaseResult(t,e,i,a){let n=performance.now()-i;return{system:t,success:!a&&t!==null,creationTime:n,strategy:this.getStrategyName(),injectedDependencies:Object.keys(e.dependencies),warnings:[],error:a||void 0,metadata:{requiresInitialization:!0,pendingDependencies:[],context:e}}}},Ni=class extends Bt{constructor(){super(),this.registerKnownSystems()}getStrategyName(){return"StandardConstructor"}canCreate(t){let e=this.systemConfigs.get(t.systemKey);return e!==void 0&&!e.creationPreferences.eventDriven}getEstimatedCreationTime(t){return 10}async createSystem(t,e){let i=performance.now();try{let a=this.validateDependencies(e);if(!a.valid&&e.preferences.validateDependencies!==!1)throw new Vt(e.systemKey,this.getStrategyName(),a.missing,e);let r=this.getConstructorParameters(e),n=new t(...r),s=this.createBaseResult(n,e,i);return s.warnings=a.warnings,u?.debug?.log("StandardConstructorStrategy",`Created ${e.systemKey}`,{creationTime:s.creationTime,parametersUsed:r.length}),s}catch(a){let r=this.createBaseResult(null,e,i,a);return u?.debug?.error("StandardConstructorStrategy",`Failed to create ${e.systemKey}:`,a),r}}getConstructorParameters(t){let e=this.systemConfigs.get(t.systemKey);if(!e?.constructorMapping)return this.getStandardParameters(t);let i=[],{parameterNames:a,dependencyMapping:r}=e.constructorMapping;for(let n of a)switch(r[n]||n){case"config":i.push(t.config);break;case"utils":i.push(t.utils);break;case"performanceAnalyzer":case"simplePerformanceCoordinator":i.push(t.dependencies.simplePerformanceCoordinator||t.dependencies.performanceAnalyzer);break;case"settingsManager":i.push(t.dependencies.settingsManager);break;case"musicSyncService":i.push(t.dependencies.musicSyncService);break;case"year3000System":i.push(t.dependencies.year3000System);break;case"cssController":case"cssConsciousnessController":i.push(t.dependencies.cssController||t.dependencies.cssConsciousnessController);break;case"performanceCoordinator":i.push(t.dependencies.performanceCoordinator);break;case"enhancedDeviceTierDetector":i.push(t.dependencies.enhancedDeviceTierDetector);break;case"webglSystemsIntegration":i.push(t.dependencies.webglSystemsIntegration);break;case"deviceCapabilityDetector":i.push(t.dependencies.deviceCapabilityDetector);break;default:i.push(void 0)}return i}getStandardParameters(t){return[t.config,t.utils,t.dependencies.simplePerformanceCoordinator||t.dependencies.performanceAnalyzer,t.dependencies.musicSyncService,t.dependencies.settingsManager,t.dependencies.year3000System]}registerKnownSystems(){this.registerSystemConfig({systemKey:"ColorHarmonyEngine",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerSystemConfig({systemKey:"EnhancedMasterAnimationCoordinator",requiredDependencies:["config","performanceCoordinator"],optionalDependencies:[],constructorMapping:{parameterNames:["config","performanceCoordinator"],dependencyMapping:{config:"config",performanceCoordinator:"performanceCoordinator"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"UnifiedPerformanceCoordinator",requiredDependencies:["config"],optionalDependencies:["simplePerformanceCoordinator"],constructorMapping:{parameterNames:["config","simplePerformanceCoordinator"],dependencyMapping:{config:"config",simplePerformanceCoordinator:"simplePerformanceCoordinator"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}});let t=["DeviceCapabilityDetector","SettingsManager"];for(let e of t)this.registerSystemConfig({systemKey:e,requiredDependencies:[],optionalDependencies:[],constructorMapping:{parameterNames:[],dependencyMapping:{}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}});this.registerSystemConfig({systemKey:"TimerConsolidationSystem",requiredDependencies:[],optionalDependencies:[],constructorMapping:{parameterNames:[],dependencyMapping:{}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"GlassmorphismManager",requiredDependencies:["config","utils","cssController","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","cssController","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",cssController:"cssController",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"Card3DManager",requiredDependencies:["simplePerformanceCoordinator","settingsManager","utils"],optionalDependencies:[],constructorMapping:{parameterNames:["simplePerformanceCoordinator","settingsManager","utils"],dependencyMapping:{simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager",utils:"utils"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"UnifiedCSSVariableManager",requiredDependencies:["config","performanceCoordinator"],optionalDependencies:[],constructorMapping:{parameterNames:["config","performanceCoordinator"],dependencyMapping:{config:"config",performanceCoordinator:"performanceCoordinator"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"SidebarSystemsIntegration",requiredDependencies:["cssController"],optionalDependencies:[],constructorMapping:{parameterNames:["cssController"],dependencyMapping:{cssController:"cssController"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"UnifiedSystemIntegration",requiredDependencies:["year3000System"],optionalDependencies:[],constructorMapping:{parameterNames:["year3000System"],dependencyMapping:{year3000System:"year3000System"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"GenreGradientEvolution",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerSystemConfig({systemKey:"MusicEmotionAnalyzer",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerNewSimplifiedSystems()}registerNewSimplifiedSystems(){this.registerSystemConfig({systemKey:"SimplePerformanceCoordinator",requiredDependencies:["enhancedDeviceTierDetector","webglSystemsIntegration"],optionalDependencies:[],constructorMapping:{parameterNames:["enhancedDeviceTierDetector","webglSystemsIntegration"],dependencyMapping:{enhancedDeviceTierDetector:"enhancedDeviceTierDetector",webglSystemsIntegration:"webglSystemsIntegration"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"SimpleTierBasedPerformanceSystem",requiredDependencies:["enhancedDeviceTierDetector"],optionalDependencies:[],constructorMapping:{parameterNames:["enhancedDeviceTierDetector"],dependencyMapping:{enhancedDeviceTierDetector:"enhancedDeviceTierDetector"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"EnhancedDeviceTierDetector",requiredDependencies:[],optionalDependencies:[],constructorMapping:{parameterNames:[],dependencyMapping:{}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"WebGLSystemsIntegration",requiredDependencies:["deviceCapabilityDetector"],optionalDependencies:[],constructorMapping:{parameterNames:["deviceCapabilityDetector"],dependencyMapping:{deviceCapabilityDetector:"deviceCapabilityDetector"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}})}},gr=class extends Bt{constructor(){super(),this.registerEventDrivenSystems()}getStrategyName(){return"EventDriven"}canCreate(t){return this.systemConfigs.get(t.systemKey)?.creationPreferences.eventDriven===!0}getEstimatedCreationTime(t){return 50}async createSystem(t,e){let i=performance.now();try{let r=await new Ni().createSystem(t,e);if(!r.success)return r;this.setupEventSubscriptions(r.system,e);let n=this.createBaseResult(r.system,e,i);return n.warnings=r.warnings,u?.debug?.log("EventDrivenCreationStrategy",`Created ${e.systemKey} with event subscriptions`),n}catch(a){let r=this.createBaseResult(null,e,i,a);return u?.debug?.error("EventDrivenCreationStrategy",`Failed to create ${e.systemKey}:`,a),r}}setupEventSubscriptions(t,e){let i=this.getEventSubscriptions(e.systemKey);for(let a of i){let r=this.mapEventType(a);typeof t.handleEvent=="function"?p.subscribe(r,n=>{t.handleEvent(n)},`SystemCreation-${e.systemKey}`):typeof t.handleColorExtraction=="function"&&(a==="colors/extracted"||r==="colors:extracted")&&p.subscribe(r,t.handleColorExtraction.bind(t),`SystemCreation-${e.systemKey}`)}u?.debug?.log("EventDrivenCreationStrategy",`Setup event subscriptions for ${e.systemKey}:`,i)}mapEventType(t){return{"colors/extracted":"colors:extracted","colors/harmonized":"colors:harmonized","music/beat":"music:beat","music/energy":"music:energy","music/track-changed":"music:track-changed","performance/mode-changed":"performance:tier-changed","performance/thermal-warning":"performance:frame","settings/changed":"settings:changed"}[t]||t}getEventSubscriptions(t){return{ColorHarmonyEngine:["colors:extracted","music:track-changed"],GenreGradientEvolution:["music:beat","music:energy","music:track-changed"],MusicEmotionAnalyzer:["music:beat","music:energy","music:track-changed"]}[t]||[]}registerEventDrivenSystems(){this.registerSystemConfig({systemKey:"ColorHarmonyEngine",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerSystemConfig({systemKey:"GenreGradientEvolution",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerSystemConfig({systemKey:"MusicEmotionAnalyzer",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}})}},pr=class extends Bt{constructor(){super(),this.registerObjectDependencySystems()}getStrategyName(){return"ObjectDependencies"}canCreate(t){return t.systemKey==="MusicSyncService"}getEstimatedCreationTime(t){return 30}async createSystem(t,e){let i=performance.now();try{let a=this.validateDependencies(e);if(!a.valid&&e.preferences.validateDependencies!==!1)throw new Vt(e.systemKey,this.getStrategyName(),a.missing,e);let r={ADVANCED_SYSTEM_CONFIG:e.config,ThemeUtilities:e.utils,settingsManager:e.dependencies.settingsManager,year3000System:e.dependencies.year3000System},n=new t(r),s=this.createBaseResult(n,e,i);return s.warnings=a.warnings,s.metadata.pendingDependencies=[],u?.debug?.log("ObjectDependenciesStrategy",`Created ${e.systemKey} with event-driven dependencies`),s}catch(a){let r=this.createBaseResult(null,e,i,a);return u?.debug?.error("ObjectDependenciesStrategy",`Failed to create ${e.systemKey}:`,a),r}}registerObjectDependencySystems(){this.registerSystemConfig({systemKey:"MusicSyncService",requiredDependencies:["config","utils"],optionalDependencies:["settingsManager","year3000System"],creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}})}},fr=class{constructor(){this.strategies=new Map;this.registerDefaultStrategies()}register(t){this.strategies.set(t.getStrategyName(),t),u?.debug?.log("SystemCreationStrategyRegistry",`Registered strategy: ${t.getStrategyName()}`)}selectStrategy(t,e){let i=this.getStrategiesForSystem(t);if(i.length===0)return null;let a=i[0];if(!a)return null;let r=this.scoreStrategy(a,t,e);for(let n=1;n<i.length;n++){let s=i[n];if(!s)continue;let o=this.scoreStrategy(s,t,e);o>r&&(a=s,r=o)}return a}getStrategies(){return Array.from(this.strategies.values())}getStrategy(t){return this.strategies.get(t)||null}getStrategiesForSystem(t){let e={systemKey:t,config:{},utils:{},dependencies:{},preferences:{},metadata:{timestamp:Date.now(),reason:"startup",priority:"medium"}};return this.getStrategies().filter(i=>i.canCreate(e))}scoreStrategy(t,e,i){let a=0;return a+=10,i.dependencyRequirements==="event-driven"?(t.getStrategyName()==="EventDriven"&&(a+=20),t.getStrategyName()==="ObjectDependencies"&&(a+=15)):i.dependencyRequirements==="basic"&&t.getStrategyName()==="StandardConstructor"&&(a+=20),i.performance==="lightweight"?t.getStrategyName()==="StandardConstructor"&&(a+=15):i.performance==="optimized"&&t.getStrategyName()==="EventDriven"&&(a+=10),i.creationContext==="startup"&&t.getStrategyName()==="StandardConstructor"&&(a+=5),a}registerDefaultStrategies(){this.register(new Ni),this.register(new gr),this.register(new pr)}getStatus(){return{strategyCount:this.strategies.size,strategies:Array.from(this.strategies.keys())}}},Ms=new fr});var yr,Ts,Ps=y(()=>{"use strict";A();hr();ws();yr=class{constructor(t){this.systemConfigs=new Map;this.creationMetrics={totalCreations:0,successfulCreations:0,averageCreationTime:0,strategyUsage:{}};this.strategyRegistry=t||Ms,u?.debug?.log("StrategyBasedFactory","Factory initialized with strategy registry")}async createSystem(t,e,i){let a=performance.now();try{this.creationMetrics.totalCreations++;let r=this.getSystemConfig(t),n=this.buildSelectionCriteria(t,r,i),s=this.strategyRegistry.selectStrategy(t,n);if(!s)throw new Oi(t,n);let o=s.getStrategyName();this.creationMetrics.strategyUsage[o]=(this.creationMetrics.strategyUsage[o]||0)+1;let c=await s.createSystem(e,i);c.success&&this.creationMetrics.successfulCreations++;let d=performance.now()-a;return this.updateAverageCreationTime(d),u?.debug?.log("StrategyBasedFactory",`Created ${t} using ${o}`,{success:c.success,creationTime:c.creationTime,totalTime:d}),c}catch(r){let s=performance.now()-a;return u?.debug?.error("StrategyBasedFactory",`Failed to create ${t}:`,r),{system:null,success:!1,creationTime:s,strategy:"unknown",injectedDependencies:[],warnings:[],error:r,metadata:{requiresInitialization:!1,pendingDependencies:[],context:i}}}}registerSystemConfig(t){this.systemConfigs.set(t.systemKey,t),u?.debug?.log("StrategyBasedFactory",`Registered config for ${t.systemKey}`)}getSystemConfig(t){return this.systemConfigs.get(t)||null}setStrategyRegistry(t){this.strategyRegistry=t,u?.debug?.log("StrategyBasedFactory","Strategy registry updated")}getMetrics(){return{...this.creationMetrics}}resetMetrics(){this.creationMetrics={totalCreations:0,successfulCreations:0,averageCreationTime:0,strategyUsage:{}}}buildSelectionCriteria(t,e,i){let a="medium",r=["DeviceCapabilityDetector","PerformanceAnalyzer","UnifiedCSSVariableManager","SettingsManager","TimerConsolidationSystem"],n=["GlassmorphismManager","Card3DManager","UnifiedCSSVariableManager","EnhancedMasterAnimationCoordinator"];r.includes(t)?a="simple":n.includes(t)&&(a="complex");let s="basic";t==="MusicSyncService"||t==="ColorHarmonyEngine"?s="event-driven":r.includes(t)&&(s="none");let o="standard";return i.metadata.priority==="critical"||i.preferences.monitorCreation?o="optimized":a==="simple"&&(o="lightweight"),{complexity:a,dependencyRequirements:s,performance:o,resourceConstraints:{memoryLimited:i.metadata.resourceConstraints?.maxMemoryMB!==void 0,timeLimited:i.metadata.resourceConstraints?.maxInitTimeMs!==void 0,cpuLimited:i.metadata.priority==="low"},creationContext:i.metadata.reason}}updateAverageCreationTime(t){let e=this.creationMetrics.totalCreations,i=this.creationMetrics.averageCreationTime;this.creationMetrics.averageCreationTime=(i*(e-1)+t)/e}registerDefaultSystemConfigs(){}},Ts=new yr});var br,xs,As=y(()=>{"use strict";Ps();A();br=class{constructor(t){this.adapted=!1;this.originalFacade=null;this.migrationProgress=0;this.systemsUsingStrategy=new Set;this.systemsUsingLegacy=new Set;this.strategyBasedFactory=t||Ts,u?.debug?.log("NonVisualSystemFacadeAdapter","Facade adapter initialized")}adaptToStrategyPattern(t){this.strategyBasedFactory=t,this.adapted=!0,this.migrationProgress=1,u?.debug?.log("NonVisualSystemFacadeAdapter","Facade adapted to strategy pattern")}getMigrationStatus(){return{adapted:this.adapted,systemsUsingStrategyPattern:Array.from(this.systemsUsingStrategy),systemsUsingLegacyPattern:Array.from(this.systemsUsingLegacy),migrationProgress:this.migrationProgress}}async completeMigration(){this.adapted||this.adaptToStrategyPattern(this.strategyBasedFactory),this.migrationProgress=1,this.systemsUsingLegacy.clear(),u?.debug?.log("NonVisualSystemFacadeAdapter","Migration to strategy pattern completed")}async createSystemWithStrategy(t,e,i){let a={systemKey:t,config:i.config,utils:i.utils,dependencies:i.dependencies,preferences:{lazyInit:!1,validateDependencies:!0,creationTimeout:5e3,monitorCreation:!0},metadata:{timestamp:Date.now(),reason:"startup",priority:"medium",resourceConstraints:{maxMemoryMB:50,maxInitTimeMs:1e3}}};try{let r=await this.strategyBasedFactory.createSystem(t,e,a);return r.success?(this.systemsUsingStrategy.add(t),this.systemsUsingLegacy.delete(t)):this.systemsUsingLegacy.add(t),this.updateMigrationProgress(),u?.debug?.log("NonVisualSystemFacadeAdapter",`Created ${t} via strategy pattern`,{strategy:r.strategy,success:r.success,creationTime:r.creationTime}),r}catch(r){return this.systemsUsingLegacy.add(t),this.updateMigrationProgress(),u?.debug?.error("NonVisualSystemFacadeAdapter",`Failed to create ${t} via strategy pattern:`,r),{system:null,success:!1,creationTime:0,strategy:"adapter-fallback",injectedDependencies:[],warnings:[`Strategy creation failed: ${r}`],error:r,metadata:{requiresInitialization:!1,pendingDependencies:[],context:a}}}}createSystemLegacy(t,e,i){switch(this.systemsUsingLegacy.add(t),this.updateMigrationProgress(),u?.debug?.warn("NonVisualSystemFacadeAdapter",`Using legacy creation for ${t} - should migrate to strategy pattern`),t){case"DeviceCapabilityDetector":case"PerformanceAnalyzer":case"SettingsManager":case"TimerConsolidationSystem":return new e;case"SidebarSystemsIntegration":return new e(i.dependencies.cssConsciousnessController);case"OptimizedCSSVariableManager":return new e(i.config,i.dependencies.performanceCoordinator);case"ColorHarmonyEngine":return new e(i.config,i.utils,i.dependencies.performanceAnalyzer,i.dependencies.settingsManager);case"EnhancedMasterAnimationCoordinator":return new e(i.config,i.dependencies.performanceCoordinator);case"UnifiedPerformanceCoordinator":return new e(i.config,i.dependencies.performanceAnalyzer);case"GlassmorphismManager":return new e(i.config,i.utils,i.dependencies.cssConsciousnessController,i.dependencies.performanceAnalyzer,i.dependencies.settingsManager);case"Card3DManager":return new e(i.dependencies.performanceAnalyzer,i.dependencies.settingsManager,i.utils);case"MusicSyncService":return new e({ADVANCED_SYSTEM_CONFIG:i.config,ThemeUtilities:i.utils,settingsManager:i.dependencies.settingsManager,year3000System:i.year3000System});case"EnhancedDeviceTierDetector":return e;case"WebGLSystemsIntegration":let a=i.dependencies.deviceCapabilityDetector;if(!a)throw new Error("WebGLSystemsIntegration requires DeviceCapabilityDetector");return new e(a);case"SimplePerformanceCoordinator":let r=i.dependencies.enhancedDeviceTierDetector,n=i.dependencies.webglSystemsIntegration;if(!r||!n)throw new Error("SimplePerformanceCoordinator requires EnhancedDeviceTierDetector and WebGLSystemsIntegration");return new e(r,n);case"SimpleTierBasedPerformanceSystem":let s=i.dependencies.enhancedDeviceTierDetector;if(!s)throw new Error("SimpleTierBasedPerformanceSystem requires EnhancedDeviceTierDetector");return new e(s);default:try{return new e}catch{return new e(i.config,i.utils,i.dependencies.performanceAnalyzer,i.dependencies.settingsManager)}}}updateMigrationProgress(){let t=this.systemsUsingStrategy.size+this.systemsUsingLegacy.size;t===0?this.migrationProgress=0:this.migrationProgress=this.systemsUsingStrategy.size/t}getAdapterMetrics(){let t=this.systemsUsingStrategy.size+this.systemsUsingLegacy.size;return{totalSystemsAdapted:this.systemsUsingStrategy.size,strategySuccessRate:t>0?this.systemsUsingStrategy.size/t:0,migrationProgress:this.migrationProgress,systemBreakdown:{strategy:Array.from(this.systemsUsingStrategy),legacy:Array.from(this.systemsUsingLegacy)}}}async migrateSystemToStrategy(t){try{return this.systemsUsingLegacy.delete(t),u?.debug?.log("NonVisualSystemFacadeAdapter",`Migrated ${t} to strategy pattern`),!0}catch(e){return u?.debug?.error("NonVisualSystemFacadeAdapter",`Failed to migrate ${t} to strategy pattern:`,e),!1}}getRecommendedMigrationOrder(){return["PerformanceAnalyzer","OptimizedCSSVariableManager","DeviceCapabilityDetector","SettingsManager","ColorHarmonyEngine","MusicSyncService","UnifiedPerformanceCoordinator","EnhancedMasterAnimationCoordinator","UnifiedSystemIntegration","GlassmorphismManager","Card3DManager"].filter(e=>this.systemsUsingLegacy.has(e))}},xs=new br});var Ft,Is=y(()=>{"use strict";A();ui();U();$n();Qa();Wn();Si();Xa();oe();bi();wi();Ya();fi();A();st();si();os();qa();sr();ps();bs();Es();As();Ft=class{constructor(t,e,i){this.cssVariableManager=null;this.musicSyncService=null;this.settingsManager=null;this.simplePerformanceCoordinator=null;this.webglSystemsIntegration=null;this.enhancedDeviceTierDetector=null;this.performanceAnalyzer=null;this.performanceCoordinator=null;this.performanceOrchestrator=null;this.isInitialized=!1;this.lastHealthCheck=null;this.healthCheckInterval=null;this.metricsUpdateInterval=null;this.onSystemCreated=null;this.onSystemFailed=null;this.onHealthChange=null;this.facadeAdapter=xs;this.config=t,this.utils=e,this.year3000System=i,i&&typeof i=="object"&&"performanceAnalyzer"in i&&(this.performanceAnalyzer=i.performanceAnalyzer||null,this.cssVariableManager=i.unifiedCSSConsciousnessController||null,this.performanceCoordinator=i.unifiedPerformanceCoordinator||null,this.performanceOrchestrator=i.performanceOrchestrator||null,this.musicSyncService=i.musicSyncService||null,this.settingsManager=i.settingsManager||null,u?.debug?.log("NonVisualSystemFacade","Shared dependencies injected from SystemCoordinator",{performanceAnalyzer:!!this.performanceAnalyzer,cssVariableManager:!!this.cssVariableManager,performanceOrchestrator:!!this.performanceOrchestrator,musicSyncService:!!this.musicSyncService,settingsManager:!!this.settingsManager})),this.systemRegistry=new Map,this.systemCache=new Map,this.systemDependencies=new Map,this.facadeConfig={mode:"progressive",enablePerformanceMonitoring:!0,enableDependencyInjection:!0,enableSystemHealthMonitoring:!0,performanceThresholds:{maxInitTime:5e3,maxMemoryMB:100,maxCPUPercent:15},systemPreferences:{lazyInitialization:!0,aggressiveCaching:!0,performanceOptimization:!0}},this.currentMetrics=this.createInitialMetrics(),this.registerNonVisualSystems(),u?.debug?.log("NonVisualSystemFacade","Non-visual systems facade initialized")}registerNonVisualSystems(){this.systemRegistry.set("EnhancedMasterAnimationCoordinator",he),this.systemDependencies.set("EnhancedMasterAnimationCoordinator",["performanceAnalyzer","cssVariableManager"]),this.systemRegistry.set("TimerConsolidationSystem",yi),this.systemDependencies.set("TimerConsolidationSystem",["performanceAnalyzer"]),this.systemRegistry.set("OptimizedCSSVariableManager",me),this.systemDependencies.set("OptimizedCSSVariableManager",["performanceCoordinator"]),this.systemRegistry.set("UnifiedCSSVariableManager",me),this.systemDependencies.set("UnifiedCSSVariableManager",["performanceCoordinator"]),this.systemRegistry.set("PerformanceAnalyzer",ze),this.systemDependencies.set("PerformanceAnalyzer",[]),this.systemRegistry.set("DeviceCapabilityDetector",O),this.systemDependencies.set("DeviceCapabilityDetector",[]),this.systemRegistry.set("PerformanceAnalyzer",Ue),this.systemDependencies.set("PerformanceAnalyzer",[]),this.systemRegistry.set("CSSVariableBatcher",me),this.systemDependencies.set("CSSVariableBatcher",[]),this.systemRegistry.set("SystemHealthMonitor",Ue),this.systemDependencies.set("SystemHealthMonitor",[]),this.systemRegistry.set("UnifiedSystemIntegration",Rt),this.systemDependencies.set("UnifiedSystemIntegration",[]),this.systemRegistry.set("PerformanceBudgetManager",Pe),this.systemDependencies.set("PerformanceBudgetManager",["performanceAnalyzer"]),this.systemRegistry.set("SimplePerformanceCoordinator",Ue),this.systemDependencies.set("SimplePerformanceCoordinator",["performanceAnalyzer","performanceCoordinator","deviceCapabilityDetector","performanceBudgetManager"]),this.systemRegistry.set("SimplePerformanceCoordinator",Ue),this.systemDependencies.set("SimplePerformanceCoordinator",["enhancedDeviceTierDetector","webglSystemsIntegration"]),this.systemRegistry.set("SimpleTierBasedPerformanceSystem",vi),this.systemDependencies.set("SimpleTierBasedPerformanceSystem",["enhancedDeviceTierDetector"]),this.systemRegistry.set("EnhancedDeviceTierDetector",de),this.systemDependencies.set("EnhancedDeviceTierDetector",[]),this.systemRegistry.set("WebGLSystemsIntegration",nt),this.systemDependencies.set("WebGLSystemsIntegration",["deviceCapabilityDetector"]),this.systemDependencies.set("UnifiedDebugManager",[]),this.systemRegistry.set("SettingsManager",ae),this.systemDependencies.set("SettingsManager",[]),this.systemRegistry.set("ColorHarmonyEngine",at),this.systemDependencies.set("ColorHarmonyEngine",["musicSyncService"]),this.systemRegistry.set("MusicSyncService",we),this.systemDependencies.set("MusicSyncService",[]),this.systemRegistry.set("UnifiedColorProcessingEngine",Dt),this.systemDependencies.set("UnifiedColorProcessingEngine",["settingsManager","performanceAnalyzer"]),this.systemDependencies.set("ColorOrchestrator",[]),this.systemRegistry.set("GenreGradientEvolution",ke),this.systemDependencies.set("GenreGradientEvolution",["cssVariableManager","musicSyncService","settingsManager"]),this.systemRegistry.set("MusicEmotionAnalyzer",dt),this.systemDependencies.set("MusicEmotionAnalyzer",["musicSyncService","settingsManager"]),this.systemRegistry.set("VisualEffectsCoordinator",ki),this.systemDependencies.set("VisualEffectsCoordinator",["settingsManager"]),this.systemRegistry.set("GlassmorphismManager",Ui),this.systemDependencies.set("GlassmorphismManager",["cssVariableManager","performanceAnalyzer","settingsManager"]),this.systemRegistry.set("Card3DManager",Hi),this.systemDependencies.set("Card3DManager",["performanceAnalyzer","settingsManager"]),this.systemRegistry.set("SidebarSystemsIntegration",Rt),this.systemDependencies.set("SidebarSystemsIntegration",["cssVariableManager"])}async initialize(t){if(this.isInitialized){u?.debug?.warn("NonVisualSystemFacade","Already initialized");return}try{let e=performance.now();this.facadeConfig={...this.facadeConfig,...t},await this.initializeSharedDependencies(),await this.applyConfiguration(),this.startMonitoring(),await this.performHealthCheck();let i=performance.now();this.currentMetrics.systemInitializationTime=i-e,this.isInitialized=!0,u?.debug?.log("NonVisualSystemFacade","Non-visual systems facade fully initialized",{mode:this.facadeConfig.mode,systemsRegistered:this.systemRegistry.size,initTime:this.currentMetrics.systemInitializationTime})}catch(e){throw u?.debug?.error("NonVisualSystemFacade","Initialization failed:",e),await this.cleanup(),e}}async initializeSharedDependencies(){let t=["DeviceCapabilityDetector","EnhancedDeviceTierDetector","WebGLSystemsIntegration","SimplePerformanceCoordinator","PerformanceAnalyzer","PerformanceAnalyzer","SimplePerformanceCoordinator","OptimizedCSSVariableManager","SettingsManager","UnifiedDebugManager","MusicSyncService"];for(let e of t)try{let i=await this.getSystem(e);switch(i&&typeof i.initialize=="function"&&await i.initialize(),e){case"DeviceCapabilityDetector":this.year3000System&&(this.year3000System.deviceCapabilityDetector=i);break;case"EnhancedDeviceTierDetector":this.enhancedDeviceTierDetector=i;break;case"WebGLSystemsIntegration":this.webglSystemsIntegration=i;break;case"SimplePerformanceCoordinator":this.simplePerformanceCoordinator=i,this.performanceOrchestrator=i;break;case"PerformanceAnalyzer":this.performanceAnalyzer=i;break;case"PerformanceAnalyzer":this.performanceCoordinator=i;break;case"OptimizedCSSVariableManager":this.cssVariableManager=i;break;case"SettingsManager":this.settingsManager=i;break;case"UnifiedDebugManager":break;case"MusicSyncService":this.musicSyncService=i;break}}catch(i){u?.debug?.error("NonVisualSystemFacade",`Failed to initialize ${e}:`,i)}}getCachedSystem(t){let e=this.systemCache.get(t);if(e)return e;if(t==="DeviceCapabilityDetector"&&this.year3000System?.deviceCapabilityDetector){let i=this.year3000System.deviceCapabilityDetector;return this.systemCache.set(t,i),i}return t==="EnhancedDeviceTierDetector"&&this.enhancedDeviceTierDetector?(this.systemCache.set(t,this.enhancedDeviceTierDetector),this.enhancedDeviceTierDetector):t==="WebGLSystemsIntegration"&&this.webglSystemsIntegration?(this.systemCache.set(t,this.webglSystemsIntegration),this.webglSystemsIntegration):t==="SimplePerformanceCoordinator"&&this.simplePerformanceCoordinator?(this.systemCache.set(t,this.simplePerformanceCoordinator),this.simplePerformanceCoordinator):t==="PerformanceAnalyzer"&&this.performanceAnalyzer?(this.systemCache.set(t,this.performanceAnalyzer),this.performanceAnalyzer):t==="SimplePerformanceCoordinator"&&this.performanceOrchestrator?(this.systemCache.set(t,this.performanceOrchestrator),this.performanceOrchestrator):(t==="OptimizedCSSVariableManager"||t==="UnifiedCSSVariableManager")&&this.cssVariableManager?(this.systemCache.set(t,this.cssVariableManager),this.cssVariableManager):t==="MusicSyncService"&&this.musicSyncService?(this.systemCache.set(t,this.musicSyncService),this.musicSyncService):t==="SettingsManager"&&this.settingsManager?(this.systemCache.set(t,this.settingsManager),this.settingsManager):null}async getSystem(t){if(this.systemCache.has(t))return this.systemCache.get(t);if(t==="DeviceCapabilityDetector"&&this.year3000System?.deviceCapabilityDetector){let i=this.year3000System.deviceCapabilityDetector;return this.systemCache.set(t,i),u?.debug?.log("NonVisualSystemFacade","Using shared DeviceCapabilityDetector instance from SystemCoordinator"),i}if(t==="EnhancedDeviceTierDetector"&&this.enhancedDeviceTierDetector)return this.systemCache.set(t,this.enhancedDeviceTierDetector),u?.debug?.log("NonVisualSystemFacade","Using shared EnhancedDeviceTierDetector instance from SystemCoordinator"),this.enhancedDeviceTierDetector;if(t==="WebGLSystemsIntegration"&&this.webglSystemsIntegration)return this.systemCache.set(t,this.webglSystemsIntegration),u?.debug?.log("NonVisualSystemFacade","Using shared WebGLSystemsIntegration instance from SystemCoordinator"),this.webglSystemsIntegration;if(t==="SimplePerformanceCoordinator"&&this.simplePerformanceCoordinator)return this.systemCache.set(t,this.simplePerformanceCoordinator),u?.debug?.log("NonVisualSystemFacade","Using shared SimplePerformanceCoordinator instance from SystemCoordinator"),this.simplePerformanceCoordinator;if(t==="PerformanceAnalyzer"&&this.performanceAnalyzer)return this.systemCache.set(t,this.performanceAnalyzer),u?.debug?.log("NonVisualSystemFacade","Using shared PerformanceAnalyzer instance from SystemCoordinator"),this.performanceAnalyzer;if((t==="OptimizedCSSVariableManager"||t==="UnifiedCSSVariableManager")&&this.cssVariableManager)return this.systemCache.set(t,this.cssVariableManager),u?.debug?.log("NonVisualSystemFacade",`Using shared OptimizedCSSVariableManager instance from SystemCoordinator (requested as ${t})`),this.cssVariableManager;if(t==="SimplePerformanceCoordinator"&&this.performanceOrchestrator)return this.systemCache.set(t,this.performanceOrchestrator),u?.debug?.log("NonVisualSystemFacade","Using shared SimplePerformanceCoordinator instance from SystemCoordinator"),this.performanceOrchestrator;if(t==="MusicSyncService"&&this.musicSyncService)return this.systemCache.set(t,this.musicSyncService),u?.debug?.log("NonVisualSystemFacade","Using shared MusicSyncService instance from SystemCoordinator"),this.musicSyncService;if(t==="SettingsManager"&&this.settingsManager)return this.systemCache.set(t,this.settingsManager),u?.debug?.log("NonVisualSystemFacade","Using shared SettingsManager instance from SystemCoordinator"),this.settingsManager;let e=await this.createSystem(t);return this.systemCache.set(t,e),this.currentMetrics.activeSystems.push(t),this.currentMetrics.initializedSystems++,this.onSystemCreated&&this.onSystemCreated(t,e),e}async createSystem(t){let e=performance.now();try{if(t==="UnifiedDebugManager"){let o=an.getInstance();this.injectDependencies(o,t),this.integratePerformanceMonitoring(o,t);let c=performance.now();return this.currentMetrics.dependencyResolutionTime+=c-e,o}if(t==="ColorOrchestrator"){let o=_i;this.injectDependencies(o,t),this.integratePerformanceMonitoring(o,t);let c=performance.now();return this.currentMetrics.dependencyResolutionTime+=c-e,o}let i=this.systemRegistry.get(t);if(!i)throw new Error(`Non-visual system '${t}' not found in registry`);let a={systemKey:t,config:this.config,utils:this.utils,dependencies:{config:this.config,utils:this.utils,performanceAnalyzer:this.performanceAnalyzer,settingsManager:this.settingsManager,musicSyncService:this.musicSyncService,year3000System:this.year3000System,cssVariableManager:this.cssVariableManager,performanceCoordinator:this.performanceCoordinator,performanceOrchestrator:this.performanceOrchestrator,enhancedDeviceTierDetector:this.enhancedDeviceTierDetector,webglSystemsIntegration:this.webglSystemsIntegration,simplePerformanceCoordinator:this.simplePerformanceCoordinator,deviceCapabilityDetector:this.year3000System?.deviceCapabilityDetector||null},preferences:{lazyInit:!1,validateDependencies:!0,creationTimeout:5e3,monitorCreation:!0},metadata:{timestamp:Date.now(),reason:"startup",priority:"medium",resourceConstraints:{maxMemoryMB:50,maxInitTimeMs:1e3}},year3000System:this.year3000System},r=await this.facadeAdapter.createSystemWithStrategy(t,i,a);if(!r.success){u?.debug?.warn("NonVisualSystemFacade",`Strategy creation failed for ${t}, falling back to legacy pattern`);let o=this.facadeAdapter.createSystemLegacy(t,i,a);this.injectDependencies(o,t),this.integratePerformanceMonitoring(o,t);let c=performance.now();return this.currentMetrics.dependencyResolutionTime+=c-e,o}let n=r.system;this.injectDependencies(n,t),this.integratePerformanceMonitoring(n,t);let s=performance.now();return this.currentMetrics.dependencyResolutionTime+=s-e,u?.debug?.log("NonVisualSystemFacade",`Created ${t} using strategy: ${r.strategy}`,{creationTime:r.creationTime,totalTime:s-e,injectedDependencies:r.injectedDependencies}),n}catch(i){throw this.currentMetrics.failedSystems++,this.currentMetrics.failedSystemsList.push(t),this.currentMetrics.systemErrors++,this.onSystemFailed&&this.onSystemFailed(t,i),u?.debug?.error("NonVisualSystemFacade",`Failed to create system ${t}:`,i),i}}injectDependencies(t,e){if(!this.facadeConfig.enableDependencyInjection)return;let i=this.systemDependencies.get(e)||[];i.includes("performanceAnalyzer")&&this.performanceAnalyzer&&t.setPerformanceAnalyzer&&t.setPerformanceAnalyzer(this.performanceAnalyzer),i.includes("cssVariableManager")&&this.cssVariableManager&&t.setCSSVariableManager&&t.setCSSVariableManager(this.cssVariableManager),i.includes("cssConsciousnessController")&&this.cssVariableManager&&t.setCSSConsciousnessController&&t.setCSSConsciousnessController(this.cssVariableManager),i.includes("musicSyncService")&&this.musicSyncService&&t.setMusicSyncService&&t.setMusicSyncService(this.musicSyncService),i.includes("settingsManager")&&this.settingsManager&&t.setSettingsManager&&t.setSettingsManager(this.settingsManager),i.includes("year3000System")&&t.setYear3000System&&t.setYear3000System(this.year3000System),i.includes("performanceOrchestrator")&&this.performanceOrchestrator&&t.setSimplePerformanceCoordinator&&t.setSimplePerformanceCoordinator(this.performanceOrchestrator)}integratePerformanceMonitoring(t,e){if(!this.facadeConfig.enablePerformanceMonitoring||!this.performanceAnalyzer)return;let i=t.initialize;typeof i=="function"&&(t.initialize=async(...r)=>{let n=performance.now(),s=await i.call(t,...r),o=performance.now();return this.performanceAnalyzer?.recordMetric(`NonVisual_${e}_Initialize`,o-n),s});let a=t.updateAnimation;typeof a=="function"&&(t.updateAnimation=r=>{let n=performance.now();a.call(t,r);let s=performance.now();this.performanceAnalyzer?.recordMetric(`NonVisual_${e}_Animation`,s-n)})}async initializeAllSystems(){let t=Array.from(this.systemCache.entries()).map(async([a,r])=>{try{return r&&typeof r.initialize=="function"&&await r.initialize(),u?.debug?.log("NonVisualSystemFacade",`Initialized system: ${a}`),{key:a,success:!0}}catch(n){return u?.debug?.error("NonVisualSystemFacade",`Failed to initialize ${a}:`,n),{key:a,success:!1,error:n}}}),e=await Promise.allSettled(t),i=e.filter(a=>a.status==="fulfilled"&&a.value.success).length;u?.debug?.log("NonVisualSystemFacade",`Non-visual systems initialized: ${i}/${e.length}`)}async performHealthCheck(){let t={overall:"good",systems:new Map,recommendations:[],timestamp:performance.now(),metrics:{...this.currentMetrics}},e=0,i=0;for(let[r,n]of this.systemCache){i++;try{let s=n.healthCheck?await n.healthCheck():{status:"unknown",message:"No health check available"},o=s.status==="healthy"||s.status==="good";o&&e++,t.systems.set(r,{ok:o,details:s.message||s.details||"System operational"})}catch(s){t.systems.set(r,{ok:!1,details:`Health check failed: ${s}`})}}let a=i>0?e/i:1;return a>=.9?t.overall="excellent":a>=.7?t.overall="good":a>=.5?(t.overall="degraded",t.recommendations.push("Some non-visual systems are experiencing issues")):(t.overall="critical",t.recommendations.push("Multiple non-visual system failures detected")),this.currentMetrics.systemInitializationTime>3e3&&t.recommendations.push("High initialization time - consider optimizing system startup"),this.currentMetrics.memoryUsageMB>80&&t.recommendations.push("High memory usage - consider optimizing system memory usage"),this.lastHealthCheck=t,this.currentMetrics.lastHealthCheckTime=performance.now(),this.onHealthChange&&this.onHealthChange(t),t}createInitialMetrics(){return{systemCount:this.systemRegistry.size,initializedSystems:0,failedSystems:0,totalInitTime:0,averageInitTime:0,memoryUsageMB:0,systemHealth:"good",activeSystems:[],failedSystemsList:[],dependencyInjection:this.facadeConfig.enableDependencyInjection,performanceMonitoring:this.facadeConfig.enablePerformanceMonitoring,healthMonitoring:this.facadeConfig.enableSystemHealthMonitoring,systemInitializationTime:0,dependencyResolutionTime:0,lastHealthCheckTime:0,systemErrors:0}}async applyConfiguration(){switch(this.facadeConfig.mode){case"performance-first":this.facadeConfig.systemPreferences.lazyInitialization=!0,this.facadeConfig.systemPreferences.aggressiveCaching=!0;break;case"quality-first":this.facadeConfig.systemPreferences.lazyInitialization=!1,this.facadeConfig.systemPreferences.performanceOptimization=!0;break;case"battery-optimized":this.facadeConfig.performanceThresholds.maxCPUPercent=5,this.facadeConfig.systemPreferences.lazyInitialization=!0;break}}startMonitoring(){this.facadeConfig.enableSystemHealthMonitoring&&(this.healthCheckInterval=window.setInterval(async()=>{await this.performHealthCheck()},3e4),this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},5e3))}updateMetrics(){this.currentMetrics.systemCount=this.systemRegistry.size,this.currentMetrics.initializedSystems=this.systemCache.size,this.currentMetrics.averageInitTime=this.currentMetrics.totalInitTime/Math.max(1,this.currentMetrics.initializedSystems);let t=performance.memory;t&&(this.currentMetrics.memoryUsageMB=t.usedJSHeapSize/(1024*1024));let e=this.currentMetrics.failedSystems/Math.max(1,this.currentMetrics.systemCount);e===0?this.currentMetrics.systemHealth="excellent":e<.1?this.currentMetrics.systemHealth="good":e<.3?this.currentMetrics.systemHealth="degraded":this.currentMetrics.systemHealth="critical"}async cleanup(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this.cssVariableManager=null,this.performanceAnalyzer=null,this.performanceOrchestrator=null,this.musicSyncService=null,this.settingsManager=null}getMetrics(){return{...this.currentMetrics}}getLastHealthCheck(){return this.lastHealthCheck}getConfiguration(){return{...this.facadeConfig}}async setConfiguration(t){this.facadeConfig={...this.facadeConfig,...t},await this.applyConfiguration()}setOnSystemCreated(t){this.onSystemCreated=t}setOnSystemFailed(t){this.onSystemFailed=t}setOnHealthChange(t){this.onHealthChange=t}getSystemStatus(){return{initialized:this.isInitialized,systemsActive:this.systemCache.size,healthy:this.currentMetrics.systemHealth==="excellent"||this.currentMetrics.systemHealth==="good"}}async destroy(){await this.cleanup(),this.isInitialized=!1,this.systemCache.clear(),u?.debug?.log("NonVisualSystemFacade","Non-visual systems facade destroyed")}}});var $i,Sr,vr,Ds=y(()=>{"use strict";$i=class{constructor(){this.pulsingEngine=new Sr,this.symbioticCore=new vr}getConsciousnessState(){return{intensity:.5,colorTemperature:6e3,animationScale:1,dominantEmotion:"neutral",resonance:.5,symbioticResonance:.5,surfaceFluidityIndex:.5,animationScaleRate:1,emotionalTemperature:6e3,pulsingCycle:2,cinematicIntensity:.5}}},Sr=class{updatePulsing(t){}getPulsingPhase(){return .5}initialize(){}updatePulsingCycle(t){}calculatePulsingCycle(t){return 2}adjustPulsingRhythm(t){}synchronizeWithBeat(t){}},vr=class{processAudioData(t){}getEmotionalState(){return{intensity:.5,valence:.5,arousal:.5,energy:.5}}initialize(){}updateSymbioticResonance(t){}calculateResonance(t){return .5}updateSymbioticEffects(t){}}});var Cr,Gt,Ls=y(()=>{"use strict";k();Cr=class{static selectOptimalBackend(t){let e=t.filter(i=>i.backend.isReady&&i.backend.capabilities).sort((i,a)=>a.priority-i.priority);for(let i of e){let a=i.capabilities;if(a.webgl2&&a.maxTextureSize>=2048||a.webgl&&a.maxTextureSize>=1024||i.backend.backendId==="css")return i.backend}return null}},Gt=class{constructor(t,e,i,a,r,n={}){this.initialized=!1;this.registeredBackends=new Map;this.activeBackend=null;this.rootElement=null;this.currentPalette=[];this.currentMusicMetrics=null;this.lastFrameTime=0;this.frameCount=0;this.performanceCheckInterval=null;this.eventBus=t||p,this.cssController=e,this.colorHarmonyEngine=i,this.musicSyncService=a,this.performanceAnalyzer=r,this.config={enabledBackends:["webgl","css"],defaultQuality:"high",transitionDuration:500,performanceMonitoring:!0,autoQualityScaling:!0,...n},this.currentConstraints={targetFPS:60,maxMemoryMB:50,cpuBudgetPercent:10,gpuBudgetPercent:25,qualityLevel:this.config.defaultQuality}}async initialize(){try{this.setupEventListeners(),this.setupCSSVariableUpdates(),this.config.performanceMonitoring&&this.startPerformanceMonitoring(),this.updateGlobalStatus(),this.initialized=!0,console.log("[GradientConductor] Initialized successfully",{enabledBackends:this.config.enabledBackends,registeredBackends:Array.from(this.registeredBackends.keys())})}catch(t){throw console.error("[GradientConductor] Initialization failed:",t),t}}registerBackend(t,e=0){let i={backend:t,priority:e,capabilities:t.capabilities,lastHealthCheck:new Date,isActive:!1};this.registeredBackends.set(t.backendId,i),console.log(`[GradientConductor] Registered backend: ${t.backendId}`,{priority:e,capabilities:t.capabilities}),this.evaluateActiveBackend()}unregisterBackend(t){let e=this.registeredBackends.get(t);e&&(e.backend.setEnabled(!1),this.registeredBackends.delete(t),this.activeBackend?.backendId===t&&(this.activeBackend=null,this.evaluateActiveBackend()),console.log(`[GradientConductor] Unregistered backend: ${t}`))}async initializeBackends(t){this.rootElement=t;let e=Array.from(this.registeredBackends.values()).map(async i=>{try{await i.backend.init(t,this.currentConstraints),console.log(`[GradientConductor] Backend ${i.backend.backendId} initialized`)}catch(a){console.error(`[GradientConductor] Failed to initialize backend ${i.backend.backendId}:`,a)}});await Promise.allSettled(e),this.evaluateActiveBackend(),this.activeBackend&&(this.currentPalette.length>0&&this.activeBackend.setPalette(this.currentPalette),this.currentMusicMetrics&&this.activeBackend.setMusicMetrics(this.currentMusicMetrics))}setPalette(t,e=this.config.transitionDuration){this.currentPalette=[...t],this.updateCSSGradientVariables(t),this.activeBackend&&this.activeBackend.setPalette(t,e),this.updateGlobalStatus(),console.log("[GradientConductor] Palette updated",{stops:t.length,activeBackend:this.activeBackend?.backendId,transition:e})}setMusicMetrics(t){this.currentMusicMetrics=t,this.updateCSSMusicVariables(t),this.activeBackend&&this.activeBackend.setMusicMetrics(t),this.eventBus.emit("music:energy",{energy:t.energy,valence:t.valence,tempo:t.bpm,timestamp:Date.now()})}setPerformanceConstraints(t){this.currentConstraints={...t};for(let e of this.registeredBackends.values())e.backend.setPerformanceConstraints(t);t.qualityLevel!==this.currentConstraints.qualityLevel&&this.evaluateActiveBackend(),console.log("[GradientConductor] Performance constraints updated",t)}getActiveBackend(){return this.activeBackend}async triggerMusicEmotionAnalysis(t,e){try{if(this.colorHarmonyEngine&&typeof this.colorHarmonyEngine.analyzeMusicEmotion=="function"){let i=await this.colorHarmonyEngine.analyzeMusicEmotion(t,e);i&&this.config.performanceMonitoring&&console.log(`[GradientConductor] Music emotion analysis triggered: ${i.primary} (${i.intensity.toFixed(2)} intensity)`)}else console.warn("[GradientConductor] ColorHarmonyEngine not available for music emotion analysis")}catch(i){console.error("[GradientConductor] Error triggering music emotion analysis:",i)}}getRegisteredBackends(){return Array.from(this.registeredBackends.values())}setActiveBackend(t){let e=this.registeredBackends.get(t);if(!e||!e.backend.isReady)return!1;if(this.activeBackend){this.activeBackend.setEnabled(!1);let i=this.registeredBackends.get(this.activeBackend.backendId);i&&(i.isActive=!1)}return this.activeBackend=e.backend,e.isActive=!0,e.backend.setEnabled(!0,this.config.transitionDuration),this.updateGlobalStatus(),console.log(`[GradientConductor] Forced backend switch to: ${t}`),!0}async healthCheck(){let t=[];for(let[e,i]of this.registeredBackends)try{let a=await i.backend.healthCheck();i.lastHealthCheck=new Date,a.ok||t.push(`Backend ${e}: ${a.details||"Health check failed"}`)}catch(a){t.push(`Backend ${e}: Health check error - ${a}`)}return{healthy:t.length===0,ok:t.length===0,details:t.length>0?`${t.length} backend issues detected`:"All backends healthy",issues:t,system:"GradientConductor"}}updateAnimation(t){this.frameCount++,this.lastFrameTime=t,this.activeBackend&&this.activeBackend.updateAnimation(t)}destroy(){this.performanceCheckInterval&&(clearInterval(this.performanceCheckInterval),this.performanceCheckInterval=null);for(let t of this.registeredBackends.values())t.backend.destroy();this.registeredBackends.clear(),this.activeBackend=null,this.initialized=!1,console.log("[GradientConductor] Destroyed")}setupEventListeners(){this.eventBus.subscribe("colors:harmonized",t=>{if(t&&t.processedColors){let e=Object.entries(t.processedColors).map(([i,a],r,n)=>{let s=a,o=128,c=128,m=128;if(s.startsWith("#")){let d=s.slice(1);o=parseInt(d.slice(0,2),16),c=parseInt(d.slice(2,4),16),m=parseInt(d.slice(4,6),16)}return{r:o,g:c,b:m,position:r/(n.length-1)}});this.setPalette(e)}},"GradientConductor"),this.eventBus.subscribe("music:energy",t=>{let e={energy:t.energy,valence:t.valence,bpm:t.tempo,beatIntensity:t.energy,rhythmPhase:0,pulsingScale:1+t.energy*.2};this.setMusicMetrics(e)},"GradientConductor"),this.eventBus.subscribe("music:beat",t=>{let e={energy:t.intensity,valence:.5,bpm:t.bpm,beatIntensity:t.intensity,rhythmPhase:Date.now()/16.67%360,pulsingScale:1+t.intensity*.1};this.setMusicMetrics(e)},"GradientConductor"),this.eventBus.subscribe("performance:tier-changed",t=>{let e={targetFPS:60,maxMemoryMB:50,cpuBudgetPercent:10,gpuBudgetPercent:25,qualityLevel:t.tier==="excellent"?"ultra":t.tier==="good"?"high":t.tier==="degraded"?"medium":"low"};this.setPerformanceConstraints(e)},"GradientConductor"),this.eventBus.subscribe("settings:changed",t=>{if(t.settingKey.includes("accessibility")||t.settingKey.includes("motion")){let e={reducedMotion:t.settingKey.includes("motion")&&t.newValue==="reduce",highContrast:t.settingKey.includes("contrast")&&t.newValue==="high",prefersTransparency:t.settingKey.includes("transparency")&&t.newValue==="reduce"};for(let i of this.registeredBackends.values())i.backend.applyAccessibilityPreferences?.(e)}},"GradientConductor"),this.eventBus.subscribe("music:emotion-analyzed",t=>{this.handleEmotionUpdate(t)},"GradientConductor"),this.eventBus.subscribe("music:emotional-context-updated",t=>{this.handleEmotionalColorContext(t)},"GradientConductor")}setupCSSVariableUpdates(){["--sn.music.beat.pulse.intensity","--sn.music.rhythm.phase","--sn.music.pulsing.scale","--sn.bg.webgl.ready","--sn.bg.active-backend","--sn-emotion-primary","--sn-emotion-intensity","--sn-color-temperature","--sn-visual-effects-level","--sn-smooth-flow","--sn-cinematic-depth"].forEach(e=>{this.cssController.addCriticalVariable(e)})}handleEmotionUpdate(t){try{let{emotion:e,colorTemperature:i,visualLevel:a,smoothFlow:r,cinematicDepth:n}=t;this.cssController.setProperty("--sn-emotion-primary",e.primary||"neutral"),this.cssController.setProperty("--sn-emotion-intensity",(e.intensity||.5).toString()),this.cssController.setProperty("--sn-emotion-confidence",(e.confidence||.5).toString()),this.cssController.setProperty("--sn-color-temperature",(i||6500).toString()),this.cssController.setProperty("--sn-visual-effects-level",(a||.5).toString()),this.cssController.setProperty("--sn-smooth-flow",(r||.5).toString()),this.cssController.setProperty("--sn-cinematic-depth",(n||.5).toString());for(let s of this.registeredBackends.values())s.backend.setEmotionalState&&s.backend.setEmotionalState(e);console.log(`[GradientConductor] Emotion updated: ${e.primary} (intensity: ${e.intensity?.toFixed(2)||"N/A"})`)}catch(e){console.error("[GradientConductor] Error handling emotion update:",e)}}handleEmotionalColorContext(t){try{let{primaryEmotion:e,emotionIntensity:i,colorTemperature:a,valence:r,arousal:n,dominance:s,smoothFlow:o,cinematicDepth:c,visualResonance:m}=t;this.cssController.setProperty("--sn-emotion-valence",(r||.5).toString()),this.cssController.setProperty("--sn-emotion-arousal",(n||.5).toString()),this.cssController.setProperty("--sn-emotion-dominance",(s||.5).toString()),this.cssController.setProperty("--sn-visual-resonance",(m||.5).toString());for(let d of this.registeredBackends.values())d.backend.setEmotionalContext&&d.backend.setEmotionalContext(t);console.log(`[GradientConductor] Emotional context updated: ${e} (temp: ${a}K)`)}catch(e){console.error("[GradientConductor] Error handling emotional color context:",e)}}updateCSSGradientVariables(t){if(t.length===0)return;let e=t[0],i=t[Math.floor(t.length/2)],a=t[t.length-1];this.cssController.setProperty("--sn.bg.gradient.primary.rgb",`${e.r}, ${e.g}, ${e.b}`),this.cssController.setProperty("--sn.bg.gradient.secondary.rgb",`${i.r}, ${i.g}, ${i.b}`),this.cssController.setProperty("--sn.bg.gradient.accent.rgb",`${a.r}, ${a.g}, ${a.b}`),this.cssController.setProperty("--sn.color.accent.rgb",`${a.r}, ${a.g}, ${a.b}`),this.cssController.setProperty("--sn.color.accent.hex",`#${Math.round(a.r).toString(16).padStart(2,"0")}${Math.round(a.g).toString(16).padStart(2,"0")}${Math.round(a.b).toString(16).padStart(2,"0")}`)}updateCSSMusicVariables(t){t.beatIntensity!==void 0&&this.cssController.setProperty("--sn.music.beat.pulse.intensity",t.beatIntensity.toString()),t.rhythmPhase!==void 0&&this.cssController.setProperty("--sn.music.rhythm.phase",`${t.rhythmPhase}deg`),t.pulsingScale!==void 0&&this.cssController.setProperty("--sn.music.pulsing.scale",t.pulsingScale.toString()),this.cssController.setProperty("--sn.music.energy.level",t.energy.toString()),this.cssController.setProperty("--sn.music.valence",t.valence.toString()),this.cssController.setProperty("--sn.music.tempo.bpm",t.bpm.toString())}updateGlobalStatus(){this.cssController.setProperty("--sn.bg.webgl.ready",this.registeredBackends.has("webgl")?"1":"0"),this.cssController.setProperty("--sn.bg.active-backend",this.activeBackend?.backendId||"none"),typeof window<"u"&&(window.snActiveBackend=this.activeBackend?.backendId||"none")}evaluateActiveBackend(){let t=Cr.selectOptimalBackend(Array.from(this.registeredBackends.values()));if(t&&t!==this.activeBackend){if(this.activeBackend){this.activeBackend.setEnabled(!1,this.config.transitionDuration);let i=this.registeredBackends.get(this.activeBackend.backendId);i&&(i.isActive=!1)}this.activeBackend=t;let e=this.registeredBackends.get(t.backendId);e&&(e.isActive=!0,t.setEnabled(!0,this.config.transitionDuration)),this.updateGlobalStatus(),console.log(`[GradientConductor] Switched to backend: ${t.backendId}`),this.eventBus.emit("system:initialized",{systemName:`GradientConductor-${t.backendId}`,timestamp:Date.now(),metadata:{previousBackend:this.activeBackend?.backendId||"none",newBackend:t.backendId,capabilities:t.capabilities.webgl?"webgl":"css"}})}}startPerformanceMonitoring(){this.performanceCheckInterval=window.setInterval(()=>{if(this.activeBackend)try{let t=this.activeBackend.getPerformanceMetrics();this.config.autoQualityScaling&&this.evaluateQualityScaling(t),this.performanceAnalyzer.recordMetric("gradientConductor.fps",t.fps),this.performanceAnalyzer.recordMetric("gradientConductor.memory",t.memoryUsageMB)}catch(t){console.warn("[GradientConductor] Performance monitoring error:",t)}},2e3)}evaluateQualityScaling(t){let e=this.currentConstraints;if(t.fps<e.targetFPS*.8||t.memoryUsageMB>e.maxMemoryMB*1.2){let i=e.qualityLevel;switch(e.qualityLevel){case"ultra":i="high";break;case"high":i="medium";break;case"medium":i="low";break;case"low":this.evaluateActiveBackend();return}console.log(`[GradientConductor] Auto-scaling quality: ${e.qualityLevel} \u2192 ${i}`),this.setPerformanceConstraints({...e,qualityLevel:i})}}}});var Wi,ks=y(()=>{"use strict";Li();Z();Wi=class extends We{constructor(e){super(e);this.musicIntensity=0;this.scaleMultiplier=1;this.animationPhase=0;this.colorTemperature=4e3;this.transitionFluidityLevel=.5;this.targetMusicIntensity=0;this.targetScaleMultiplier=1;this.targetColorTemperature=4e3;this.targetTransitionFluidityLevel=.5;this.lerpHalfLifeValues={intensityAttack:.05,intensityDecay:.15,scaleMultiplier:.08,colorTemperature:.3,transitionFluidity:.12};this.lastBeatTime=0;this.currentBPM=120;this.animationCycleDuration=2e3;this.musicSyncService=null;this.currentMusicalContext=null;this.lastBeatPhaseUpdate=0;this.performanceMetrics={syncUpdates:0,scaleEvents:0,animationCycles:0,emotionalShifts:0,averageFrameTime:0,memoryUsage:0};this.syncConfig={responseSensitivity:.7,animationIntensity:.8,colorTemperatureRange:{min:1e3,max:2e4},transitionFluidityEnabled:!0,visualParticlesEnabled:!0,cinematicEffectsEnabled:!0};this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F3B5} Music beat synchronizer initializing...")}setMusicSyncService(e){this.musicSyncService=e,this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F3B5} Music synchronization service activated")}onBeatDetected(e){let{intensity:i,bpm:a,energy:r,timestamp:n}=e;this.lastBeatTime=n||Date.now(),this.currentBPM=a||this.currentBPM,this.targetMusicIntensity=Math.min(1,i*this.syncConfig.responseSensitivity),this.targetScaleMultiplier=1+(r||.5)*.3,this.performanceMetrics.scaleEvents++,this.config.enableDebug&&console.log(`[MusicBeatSynchronizer] \u{1F3B5} Beat detected: intensity=${i}, energy=${r}, bpm=${a}`)}onEnergyChanged(e){let{energy:i,valence:a}=e;this.targetScaleMultiplier=1+i*.3,this.targetTransitionFluidityLevel=.3+a*.4,this.config.enableDebug&&console.log(`[MusicBeatSynchronizer] \u26A1 Energy change: energy=${i}, valence=${a}`)}onEmotionDetected(e){let{valence:i,energy:a}=e,r=4e3,n=(a-.5)*8e3,s=(i-.5)*6e3;this.targetColorTemperature=Math.max(1e3,Math.min(2e4,r+n+s)),this.performanceMetrics.emotionalShifts++,this.config.enableDebug&&console.log(`[MusicBeatSynchronizer] \u{1F308} Emotion detected: ${this.colorTemperature}K temperature`)}onTempoChanged(e){let{bpm:i,tempo:a,enhancedBPM:r}=e;this.currentBPM=r||i||a||120;let n=Math.max(.3,Math.min(3,this.currentBPM/120));this.animationCycleDuration=2e3/n,this.config.enableDebug&&console.log(`[MusicBeatSynchronizer] \u{1F3B6} Tempo changed: ${this.currentBPM} BPM, ${this.animationCycleDuration.toFixed(0)}ms cycle`)}async initialize(){this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F3B5} Initializing music synchronization system..."),this.registerCSSVariableGroup("music-sync-core","critical"),this.registerCSSVariableGroup("visual-scaling","high"),this.registerCSSVariableGroup("color-temperature","normal"),this.registerCSSVariableGroup("transition-fluidity","normal"),this.musicIntensity=0,this.scaleMultiplier=1,this.animationPhase=0,this.colorTemperature=4e3,this.transitionFluidityLevel=.5,this.subscribeToEvent("music:beat",e=>this.onBeatDetected(e)),this.subscribeToEvent("music:energy",e=>this.onEnergyChanged(e)),this.subscribeToEvent("music:emotion",e=>this.onEmotionDetected(e)),this.subscribeToEvent("music:bpm-change",e=>this.onTempoChanged(e)),this.registerAnimation(60),this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F31F} Music synchronization system ready")}destroy(){this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F343} Shutting down music synchronizer..."),this.musicIntensity=0,this.scaleMultiplier=1,this.animationPhase=0,this.colorTemperature=4e3,this.transitionFluidityLevel=.5,this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F30C} Music synchronizer cleanly shut down")}onAnimate(e){let i=performance.now();this.updateMusicalContext(),this.updateMusicSyncState(e),this.processVisualScaling(e),this.updateColorTemperature(e),this.animateTransitionFluidity(e),this.applyMusicSyncCSSVariables();let a=performance.now()-i;this.performanceMetrics.averageFrameTime=this.performanceMetrics.averageFrameTime*.9+a*.1,this.performanceMetrics.syncUpdates++,a>2&&this.config.enableDebug&&console.warn(`[MusicBeatSynchronizer] \u{1F40C} Music sync frame took ${a.toFixed(2)}ms (target: <2ms)`)}async healthCheck(){let e=[];return this.eventBus||e.push("EventBus not connected for music coordination"),this.performanceMetrics.averageFrameTime>2&&e.push(`Average frame time ${this.performanceMetrics.averageFrameTime.toFixed(2)}ms exceeds 2ms target`),this.musicIntensity===0&&Date.now()-this.lastBeatTime>1e4&&e.push("No music synchronization activity detected in last 10 seconds"),(this.colorTemperature<1e3||this.colorTemperature>2e4)&&e.push(`Color temperature ${this.colorTemperature}K outside 1000K-20000K range`),{healthy:e.length===0,ok:e.length===0,details:`Music synchronization health: ${e.length===0?"optimal":"needs attention"}`,issues:e,system:"MusicBeatSynchronizer"}}updateMusicSyncState(e){this.animationPhase+=e/this.animationCycleDuration*2*Math.PI,this.animationPhase>2*Math.PI&&(this.animationPhase-=2*Math.PI);let i=e/1e3,a=this.targetMusicIntensity>this.musicIntensity?this.lerpHalfLifeValues.intensityAttack:this.lerpHalfLifeValues.intensityDecay;this.musicIntensity=R(this.musicIntensity,this.targetMusicIntensity,i,a),Date.now()-this.lastBeatTime>2e3&&(this.targetMusicIntensity=R(this.targetMusicIntensity,0,i,this.lerpHalfLifeValues.intensityDecay))}processVisualScaling(e){let i=e/1e3;this.scaleMultiplier=R(this.scaleMultiplier,this.targetScaleMultiplier,i,this.lerpHalfLifeValues.scaleMultiplier),this.targetScaleMultiplier=R(this.targetScaleMultiplier,1,i,this.lerpHalfLifeValues.scaleMultiplier*2)}updateColorTemperature(e){let i=e/1e3;this.colorTemperature=R(this.colorTemperature,this.targetColorTemperature,i,this.lerpHalfLifeValues.colorTemperature);let a=4e3;this.targetColorTemperature=R(this.targetColorTemperature,a,i,this.lerpHalfLifeValues.colorTemperature*3)}animateTransitionFluidity(e){if(!this.syncConfig.transitionFluidityEnabled)return;let i=e/1e3;this.transitionFluidityLevel=R(this.transitionFluidityLevel,this.targetTransitionFluidityLevel,i,this.lerpHalfLifeValues.transitionFluidity)}applyMusicSyncCSSVariables(){this.updateCSSVariableGroup("music-sync-core",{"--sn-music-intensity":this.musicIntensity.toFixed(3),"--sn-music-bpm":this.currentBPM.toString(),"--sn-music-animation-phase":this.animationPhase.toFixed(4)}),this.updateCSSVariableGroup("visual-scaling",{"--sn-visual-scale":this.scaleMultiplier.toFixed(3),"--sn-visual-response-sensitivity":this.syncConfig.responseSensitivity.toFixed(2)}),this.updateCSSVariableGroup("color-temperature",{"--sn-color-temperature":`${this.colorTemperature.toFixed(0)}K`,"--sn-color-temperature-normalized":((this.colorTemperature-1e3)/19e3).toFixed(3)}),this.updateCSSVariableGroup("transition-fluidity",{"--sn-transition-fluidity":this.transitionFluidityLevel.toFixed(3),"--sn-transition-fluidity-enabled":this.syncConfig.transitionFluidityEnabled?"1":"0"})}getMusicSyncMetrics(){return{...this.performanceMetrics}}updateSyncConfig(e){this.syncConfig={...this.syncConfig,...e},this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F527} Sync configuration updated:",this.syncConfig)}getMusicSyncState(){return{musicIntensity:this.musicIntensity,scaleMultiplier:this.scaleMultiplier,animationPhase:this.animationPhase,colorTemperature:this.colorTemperature,transitionFluidityLevel:this.transitionFluidityLevel,lastBeatTime:this.lastBeatTime,currentBPM:this.currentBPM}}forceRepaint(e){super.forceRepaint(e),this.musicIntensity=0,this.scaleMultiplier=1,this.animationPhase=0,this.applyMusicSyncCSSVariables(),this.config.enableDebug&&console.log(`[MusicBeatSynchronizer] \u{1F504} Music synchronization repaint: ${e}`)}updateMusicalContext(){if(!this.musicSyncService){this.currentMusicalContext=null;return}let e=Date.now();if(e-this.lastBeatPhaseUpdate<16)return;this.lastBeatPhaseUpdate=e;let i=this.musicSyncService.getCurrentMusicState(),a=this.musicSyncService.getLatestProcessedData();if(this.currentMusicalContext={tempo:i?.beat?.tempo||a?.enhancedBPM||120,energy:i?.beat?.energy||a?.energy||.5,valence:a?.valence||.5,danceability:a?.danceability||.5,emotionalTemperature:a?.adaptedColorTemp||4e3,beatPhase:"sustain",beatConfidence:.5,beatInterval:i?.beat?.tempo?6e4/i.beat.tempo:500,timeSinceLastBeat:e-this.lastBeatTime,energyLevel:i?.beat?.energy||a?.energy||.5,harmonicContent:a?.harmonicContent||.5,rhythmicStability:a?.rhythmicStability||.8,harmonicComplexity:a?.harmonicComplexity||.5,rhythmicDensity:a?.rhythmicDensity||.5,spectralCentroid:a?.spectralCentroid||2e3,bpm:i?.beat?.tempo||a?.enhancedBPM||120,beat:Math.floor(e/(i?.beat?.tempo?6e4/i.beat.tempo:500))},this.config.enableDebug&&this.currentMusicalContext){let r=this.currentMusicalContext;console.log(`[MusicBeatSynchronizer] \u{1F3B5} Musical context: tempo=${r.tempo}, energy=${r.energy.toFixed(2)}, phase=${r.beatPhase}`)}}}});var qi,Rs=y(()=>{"use strict";fi();k();A();st();U();pi();Me();ie();qi=class{constructor(t,e,i){this.holographicElements=new Map;this.interfaceContainer=null;this.isInitialized=!1;this.isEnabled=!0;this.performanceMetrics={elementsProcessed:0,effectsApplied:0,averageProcessingTime:0,memoryUsage:0,lastUpdate:0};this.animationState={lastFrameTime:0,flickerPhase:0,scanlinePhase:0,chromaticPhase:0,dataStreamPhase:0,interferencePhase:0,dynamicPhase:0,isAnimating:!1};this.holographicPresets={"star-wars":{flickerIntensity:.4,transparency:.8,chromatic:.3,scanlineIntensity:.6,dataStreamFlow:.5,interferenceLevel:.2,energyStability:.7,projectionDistance:.8},"blade-runner":{flickerIntensity:.6,transparency:.7,chromatic:.5,scanlineIntensity:.8,dataStreamFlow:.8,interferenceLevel:.4,energyStability:.6,projectionDistance:.6},"dynamic-visualEffects":{flickerIntensity:.3,transparency:.9,chromatic:.2,scanlineIntensity:.4,dataStreamFlow:.6,interferenceLevel:.3,energyStability:.8,projectionDistance:.9}};this.lastMusicalContext=null;this.eventSubscriptionIds=[];this.lastScrollPosition=0;this.lastMouseMovement=0;this.lastUIClick=0;this.initialized=!1;this.currentQualityLevel=null;this.qualityCapabilities=[{name:"holographic-effects",enabled:!0,qualityLevel:"medium"},{name:"scanline-overlay",enabled:!0,qualityLevel:"low"},{name:"chromatic-aberration",enabled:!0,qualityLevel:"low"},{name:"data-streams",enabled:!0,qualityLevel:"medium"},{name:"interference-patterns",enabled:!0,qualityLevel:"low"},{name:"dynamic-integration",enabled:!0,qualityLevel:"high"}];this.qualityAdjustments={};this.manager=t,this.settingsManager=e||new ae,this.musicSyncService=i||new we,this.oklabProcessor=new E(!0),this.emotionalMapper=new J(!0),this.genreManager=new _e,this.holographicPreset=E.getPreset("COSMIC"),this.holographicState={flickerIntensity:.4,transparency:.8,chromatic:.3,scanlineIntensity:.6,dataStreamFlow:.5,interferenceLevel:.2,energyStability:.7,projectionDistance:.8},this.scanlineEffect={frequency:4,opacity:.1,animation:!0,speed:.5,dynamic:!1},this.chromaticAberration={offsetX:2,offsetY:1,redChannel:.5,greenChannel:0,blueChannel:-.5,intensity:.3},this.dataStream={characters:["0","1","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],speed:.5,density:.3,dynamic:!1,musicSync:!0,musicalSync:!0},this.interferencePattern={frequency:.1,amplitude:.05,phase:0,dynamic:!1,type:"wave"}}async initialize(){if(!this.initialized)try{let t=globalThis.year3000System;this.cssController=t?.cssController||P(),await this.createInterfaceContainer(),await this.initializeHolographicElements(),this.setupOKLABEventSubscriptions(),this.setupUserInteractionTracking(),this.startHolographicAnimation(),this.initialized=!0,this.isInitialized=!0,u?.debug?.log("HolographicUISystem","Initialized holographic interface system with OKLAB integration")}catch(t){throw u?.debug?.error("HolographicUISystem","Failed to initialize:",t),t}}async updateFromMusic(t,e,i){if(!this.isInitialized||!this.isEnabled)return;let a=performance.now();try{this.updateHolographicState(t,e),this.updateHolographicEffects(t,e,i),await this.updateElementAppearances();let r=performance.now()-a;this.updatePerformanceMetrics(r)}catch(r){console.error("[HolographicUISystem] Error updating from music:",r)}}updateHolographicState(t,e){let i=.2+t.intensity*.5+e.strength*.3;this.holographicState.flickerIntensity=this.smoothTransition(this.holographicState.flickerIntensity,i,.1);let a=.6+t.valence*.4;this.holographicState.transparency=this.smoothTransition(this.holographicState.transparency,a,.05);let r=.1+(t.arousal||.5)*.4;this.holographicState.chromatic=this.smoothTransition(this.holographicState.chromatic,r,.08);let n=.3+t.intensity*.5;this.holographicState.scanlineIntensity=this.smoothTransition(this.holographicState.scanlineIntensity,n,.06);let s=this.manager.getConsciousnessState(),o=.3+s.symbioticResonance*.7;this.holographicState.dataStreamFlow=this.smoothTransition(this.holographicState.dataStreamFlow,o,.04);let c=.1+s.surfaceFluidityIndex*.3;this.holographicState.interferenceLevel=this.smoothTransition(this.holographicState.interferenceLevel,c,.03);let m=1-t.intensity*.4;this.holographicState.energyStability=this.smoothTransition(this.holographicState.energyStability,m,.02)}updateHolographicEffects(t,e,i){this.scanlineEffect.frequency=2+this.holographicState.scanlineIntensity*6,this.scanlineEffect.opacity=this.holographicState.scanlineIntensity*.15,this.scanlineEffect.speed=.3+this.holographicState.dataStreamFlow*.7,this.scanlineEffect.dynamic=this.holographicState.energyStability>.7,this.chromaticAberration.intensity=this.holographicState.chromatic,this.chromaticAberration.offsetX=this.holographicState.chromatic*3,this.chromaticAberration.offsetY=this.holographicState.chromatic*2,this.dataStream.speed=.2+this.holographicState.dataStreamFlow*.8,this.dataStream.density=.2+this.holographicState.dataStreamFlow*.6,this.dataStream.dynamic=this.holographicState.energyStability>.6,this.interferencePattern.frequency=.05+this.holographicState.interferenceLevel*.15,this.interferencePattern.amplitude=this.holographicState.interferenceLevel*.1,this.interferencePattern.dynamic=this.holographicState.energyStability>.5,t.type==="ambient"?this.interferencePattern.type="dynamic":t.intensity>.7?this.interferencePattern.type="noise":this.interferencePattern.type="wave"}async updateElementAppearances(){let t=[];for(let[e,i]of this.holographicElements)i.isActive&&t.push(this.updateElementAppearance(i));await Promise.allSettled(t)}async updateElementAppearance(t){let{element:e,holographicType:i,intensity:a,visualEffectsLevel:r,smoothIntegration:n}=t;try{switch(this.applyHolographicBase(e,a),i){case"translucent_panel":this.applyTranslucentPanel(e,a);break;case"data_stream":this.applyDataStream(e,a);break;case"energy_barrier":this.applyEnergyBarrier(e,a);break;case"visual_effects_interface":this.applyVisualEffectsInterface(e,a,r);break;case"dynamic_hologram":this.applyDynamicHologram(e,a,n);break;case"musical_visualization":this.applyMusicalVisualization(e,a);break;case"scanline_overlay":this.applyScanlineOverlay(e,a);break;case"chromatic_ghost":this.applyChromaticGhost(e,a);break}r>.5&&this.applyVisualEffectsModifiers(e,r),n&&this.applyDynamicModifiers(e,a),t.lastUpdate=performance.now()}catch(s){console.warn(`[HolographicUISystem] Failed to update element ${t.id}:`,s)}}applyHolographicBase(t,e){let i=this.holographicState.transparency*e,a=this.holographicState.flickerIntensity*e,r=this.holographicState.chromatic*e;if(t.style.opacity=i.toString(),a>.3){let s=Math.sin(this.animationState.flickerPhase*10)*a*.3;t.style.opacity=Math.max(.1,i+s).toString()}if(r>.2){let s=r*2;t.style.filter=`
        drop-shadow(${s}px 0 0 rgba(255, 0, 0, 0.5))
        drop-shadow(-${s}px 0 0 rgba(0, 255, 255, 0.5))
      `}let n=e*.3;t.style.boxShadow=`
      0 0 ${n*20}px rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${n}),
      inset 0 0 ${n*10}px rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${n*.5})
    `}applyTranslucentPanel(t,e){let i=this.holographicState.transparency*e;t.style.background=`
      rgba(var(--spice-rgb-holographic-primary, var(--sn-holographic-rgb, 100, 255, 200)), ${i*.1}),
      linear-gradient(45deg,
        transparent 0%,
        rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${i*.05}) 50%,
        transparent 100%)
    `,t.style.backdropFilter=`blur(${Math.min(e*2,3)}px)`,t.style.border=`1px solid rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${i*.6})`}applyDataStream(t,e){let i=this.dataStream.speed*e,a=this.dataStream.density*e,r=this.generateDataStreamGradient(i,a);if(t.style.background=r,t.style.backgroundSize="100% 20px",t.style.animation=`dataStream ${2/i}s linear infinite`,!document.getElementById("dataStreamAnimation")){let n=document.createElement("style");n.id="dataStreamAnimation",n.textContent=`
        @keyframes dataStream {
          0% { background-position: 0 0; }
          100% { background-position: 0 20px; }
        }
      `,document.head.appendChild(n)}}applyEnergyBarrier(t,e){let i=this.holographicState.energyStability,a=this.holographicState.interferenceLevel*e,r=(1-i)*e;if(t.style.background=`
      linear-gradient(90deg,
        rgba(var(--sn-neon-glow-rgb, 0, 255, 255), ${r*.3}) 0%,
        rgba(var(--sn-neon-glow-rgb, 0, 255, 255), ${r*.1}) 50%,
        rgba(var(--sn-neon-glow-rgb, 0, 255, 255), ${r*.3}) 100%)
    `,t.style.backgroundSize="200% 100%",t.style.animation=`energyBarrier ${1/r}s ease-in-out infinite`,!document.getElementById("energyBarrierAnimation")){let n=document.createElement("style");n.id="energyBarrierAnimation",n.textContent=`
        @keyframes energyBarrier {
          0% { background-position: 0% 0%; }
          50% { background-position: 100% 0%; }
          100% { background-position: 0% 0%; }
        }
      `,document.head.appendChild(n)}}applyVisualEffectsInterface(t,e,i){let r=this.manager.getConsciousnessState().symbioticResonance*i,n=r*e*.5;t.style.boxShadow=`
      0 0 ${n*30}px rgba(var(--sn-accent-rgb, 203, 166, 247), ${n}),
      inset 0 0 ${n*15}px rgba(var(--sn-accent-rgb, 203, 166, 247), ${n*.3})
    `;let s=.7+r*.3;if(t.style.opacity=s.toString(),r>.6){let o=this.animationState.dynamicPhase*2,c=1+Math.sin(o)*r*.2;t.style.transform=`scale(${c})`}}applyDynamicHologram(t,e,i){if(!i)return;let a=this.animationState.dynamicPhase,r=this.holographicState.energyStability*e,n=Math.sin(a*1.5)*r*2,s=Math.cos(a*2)*r*1.5;t.style.transform=`translate(${n}px, ${s}px)`;let o=a*.5,c=Math.sin(o)*r*30;t.style.filter=`hue-rotate(${c}deg)`;let m=a*.8,d=1+Math.sin(m)*r*.05;t.style.transform+=` scale(${d})`}applyMusicalVisualization(t,e){let a=this.manager.getConsciousnessState().symbioticResonance*e,r=this.animationState.dataStreamPhase*3,n=a*.8,s=Math.sin(r)*n*20;t.style.background=`
      linear-gradient(0deg,
        rgba(var(--sn-primary-rgb, 205, 214, 244), ${n*.8}) 0%,
        rgba(var(--sn-primary-rgb, 205, 214, 244), ${n*.4}) ${50+s}%,
        transparent ${50+s}%)
    `;let o=1+Math.sin(r*2)*a*.1;t.style.transform=`scaleY(${o})`}applyScanlineOverlay(t,e){let i=this.holographicState.scanlineIntensity*e,a=this.scanlineEffect.frequency;if(t.style.background=`
      repeating-linear-gradient(
        0deg,
        transparent 0px,
        transparent ${a-1}px,
        rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${i*.1}) ${a}px,
        rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${i*.1}) ${a}px
      )
    `,this.scanlineEffect.animation&&(t.style.animation=`scanlines ${1/this.scanlineEffect.speed}s linear infinite`),!document.getElementById("scanlineAnimation")){let r=document.createElement("style");r.id="scanlineAnimation",r.textContent=`
        @keyframes scanlines {
          0% { background-position: 0 0; }
          100% { background-position: 0 ${a}px; }
        }
      `,document.head.appendChild(r)}}applyChromaticGhost(t,e){let i=this.holographicState.chromatic*e,a=i*3,r=i*1.5,n=i*2;t.style.filter=`
      drop-shadow(${a}px 0 0 rgba(255, 0, 0, 0.4))
      drop-shadow(-${r}px 0 0 rgba(0, 255, 0, 0.4))
      drop-shadow(0 ${n}px 0 rgba(0, 0, 255, 0.4))
    `;let s=this.animationState.chromaticPhase,o=Math.sin(s*5)*i;t.style.transform=`translate(${o}px, 0)`}applyVisualEffectsModifiers(t,e){let a=this.manager.getConsciousnessState().symbioticResonance*e,r=1+a*.3;t.style.filter=(t.style.filter||"")+` brightness(${r})`;let n=1+a*.5;t.style.filter=(t.style.filter||"")+` saturate(${n})`}applyDynamicModifiers(t,e){let i=this.animationState.dynamicPhase,a=this.holographicState.energyStability*e,r=i*1.2,n=Math.sin(r)*a*2,s=t.style.filter||"";!s.includes("blur(")&&n>0&&(t.style.filter=s+` blur(${Math.max(0,n)}px)`);let c=i*.7,m=1+Math.sin(c)*a*.2,d=parseFloat(t.style.opacity)||1;t.style.opacity=Math.max(.1,Math.min(1,d*m)).toString()}generateDataStreamGradient(t,e){let i=this.dataStream.characters,a=Math.floor(e*20),r="linear-gradient(90deg, ";for(let n=0;n<a;n++){let s=n/a*100,o=i[Math.floor(Math.random()*i.length)],c=.1+Math.random()*.3,m=this.getOKLABEnhancedDataStreamColor(c,this.lastMusicalContext);r+=`${m} ${s}%, `}return r=r.slice(0,-2)+")",r}async createInterfaceContainer(){this.interfaceContainer=document.createElement("div"),this.interfaceContainer.id="holographic-interface-container",this.interfaceContainer.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
      mix-blend-mode: normal;
    `,document.body.appendChild(this.interfaceContainer)}async initializeHolographicElements(){let t=[{selector:".main-view-container",type:"translucent_panel"},{selector:".Root__nav-bar",type:"data_stream"},{selector:".Root__now-playing-bar",type:"visualEffects_interface"},{selector:".main-view-container__scroll-node",type:"dynamic_hologram"},{selector:".root-now-playing-view",type:"energy_barrier"},{selector:".main-view-container__scroll-node-child",type:"scanline_overlay"}];for(let e of t){let i=document.querySelectorAll(e.selector);for(let a of i){let r={id:`holographic-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,element:a,originalStyles:getComputedStyle(a),holographicType:e.type,intensity:.7,isActive:!0,lastUpdate:0,animation:null,visualEffectsLevel:.8,smoothIntegration:!0};this.holographicElements.set(r.id,r)}}}updateHolographicAnimation(t){if(!this.isInitialized||!this.isEnabled)return;let e=t/1e3;this.animationState.flickerPhase+=e*2,this.animationState.scanlinePhase+=e*this.scanlineEffect.speed,this.animationState.chromaticPhase+=e*1.5,this.animationState.dataStreamPhase+=e*this.dataStream.speed,this.animationState.interferencePhase+=e*this.interferencePattern.frequency,this.animationState.dynamicPhase+=e*.5,this.performanceMetrics.lastUpdate=performance.now()}startHolographicAnimation(){this.animationState.isAnimating=!0,this.animationState.lastFrameTime=performance.now();let t=e=>{if(!this.animationState.isAnimating)return;let i=e-this.animationState.lastFrameTime;this.animationState.lastFrameTime=e,this.updateHolographicAnimation(i),requestAnimationFrame(t)};requestAnimationFrame(t)}smoothTransition(t,e,i){return t+(e-t)*i}updatePerformanceMetrics(t){this.performanceMetrics.averageProcessingTime=this.performanceMetrics.averageProcessingTime*.9+t*.1,this.performanceMetrics.elementsProcessed=this.holographicElements.size,this.performanceMetrics.memoryUsage=this.holographicElements.size*256}getHolographicState(){return{...this.holographicState}}getPerformanceMetrics(){return{...this.performanceMetrics}}getElementCount(){return this.holographicElements.size}setEnabled(t){if(this.isEnabled=t,!t)for(let[e,i]of this.holographicElements)i.element.style.opacity="1",i.element.style.filter="",i.element.style.background="",i.element.style.boxShadow="",i.element.style.transform=""}setHolographicPreset(t){let e=this.holographicPresets[t];e&&(this.holographicState={...e})}setFlickerIntensity(t){this.holographicState.flickerIntensity=Math.max(0,Math.min(1,t))}enableVolumetricDepth(t=.8){let e=800+t*1200;this.interfaceContainer&&(this.interfaceContainer.style.perspective=`${e}px`,this.interfaceContainer.style.transformStyle="preserve-3d");for(let[i,a]of this.holographicElements)this.applyVolumetricLayers(a.element,t,a.intensity);console.log(`[HolographicUISystem] \u{1F30A} Volumetric depth enabled: ${e}px perspective`)}updateVolumetricLayers(t,e){let i=t*.8,a=(e-4e3)/4e3;for(let[r,n]of this.holographicElements)this.applyVolumetricLayers(n.element,i,n.intensity,a)}applyVolumetricLayers(t,e,i,a=.5){let r=e*100,n=a*50,s=r+n,o=t.style.transform||"",c=`translateZ(${s}px)`;o.includes("translateZ")?t.style.transform=o.replace(/translateZ\([^)]*\)/,c):t.style.transform=`${o} ${c}`.trim();let m=Math.abs(s)/100*i,d=m*30,h=s>0?m*5:-m*3,g=t.style.boxShadow||"",f=`0 ${h}px ${d}px rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${m*.3})`;g?t.style.boxShadow=`${g}, ${f}`:t.style.boxShadow=f,this.applyVolumetricAtmosphere(t,e,i)}applyVolumetricAtmosphere(t,e,i){let a=e*i,r=Math.max(0,(e-.5)*4),n=1+(e-.5)*.3,s=t.style.filter||"",o=s.includes("blur("),c=[r>0&&!o?`blur(${r}px)`:"",`brightness(${n})`,`saturate(${1+a*.2})`].filter(f=>f).join(" "),m=s.includes("brightness"),d=s.includes("saturate");s&&!m&&!d?t.style.filter=`${s} ${c}`:s||(t.style.filter=c);let h=parseFloat(t.style.opacity||"1"),g=Math.max(.3,h-(1-e)*.3);t.style.opacity=g.toString()}updateConsciousnessScanlines(t,e,i){let a=Math.max(.2,t*1.5),r=this.mapTemperatureToFrequency(e),n=Math.sin(performance.now()*.005*i)*.3+.7,s={"--visualEffects-scanline-density":a.toString(),"--visualEffects-scanline-frequency":`${r}px`,"--visualEffects-scanline-opacity":(t*.15).toString(),"--musical-scanline-pulse":n.toString(),"--temperature-scanline-color-shift":`${(e-5e3)/3e3*30}deg`};this.cssController.batchSetVariables("HolographicUISystem",s,"high","visualEffects-scanline-update")}updateAberrationEffects(t,e,i,a=!1){let r=document.documentElement,n=Math.min(1,t*1.2),s=Math.min(1,i*1.5),o=2+s*3,m=(Math.max(3e3,Math.min(8e3,e))-5500)/2500,d=1.5+m*2,h=-1.5-m*2,g=m*.5,f=Math.sin(performance.now()*.003*i)*.4+.6,v=a?1.5:1,C=1e3+t*2e3+i*1e3,T={"--aberration-intensity":(n*v).toString(),"--aberration-color-separation":`${o}px`,"--aberration-musical-sync":s.toString(),"--aberration-emotional-temperature":`${e}K`,"--aberration-visualEffects-level":t.toString(),"--aberration-red-shift":`${d}px`,"--aberration-green-shift":`${g}px`,"--aberration-blue-shift":`${h}px`,"--aberration-wave-frequency":`${C}ms`,"--aberration-pulse-intensity":(f*v).toString()};this.cssController.batchSetVariables("HolographicUISystem",T,"high","aberration-effects-update");let w=parseFloat(r.style.getPropertyValue("--reading-mode-active")||"0"),V=Math.min(.8,w*.6);this.cssController.setVariable("HolographicUISystem","--aberration-reading-mode-reduction",V.toString(),"critical","aberration-reading-mode-update")}mapTemperatureToFrequency(t){return 2+(Math.max(3e3,Math.min(8e3,t))-3e3)/5e3*10}updateScanlineCSSVariables(t,e,i){let a={"--visualEffects-scanline-density":t.toString(),"--visualEffects-scanline-frequency":`${this.scanlineEffect.frequency}px`,"--visualEffects-scanline-opacity":this.scanlineEffect.opacity.toString(),"--visualEffects-scanline-speed":`${this.scanlineEffect.speed}s`,"--temperature-scanline-color-shift":`${(e-5e3)/2e3*30}deg`,"--musical-scanline-pulse":i.toString()};this.cssController.batchSetVariables("HolographicUISystem",a,"high","scanline-visualEffects-update");let r={"--visualEffects-scanline-interference":t>.7?"visible":"none","--visualEffects-scanline-complexity":t>.7?Math.min(1,(t-.7)*3.33).toString():"0"};this.cssController.batchSetVariables("HolographicUISystem",r,"high","scanline-complexity-update")}detectReadingMode(){let t=document.documentElement,e=(window.getSelection()?.toString()||"").length>0,i=this.isUserCurrentlyScrolling(),a=this.isHoveringTextContent(),r=0;e&&(r+=.6),i&&(r+=.3),a&&(r+=.4),r=Math.min(1,r),this.cssController.setVariable("HolographicUISystem","--reading-mode-active",r.toString(),"critical","reading-mode-detection-update")}trackUserInteraction(){let t=document.documentElement,e=this.isMouseCurrentlyMoving(),i=this.wasRecentUIClick(),a=this.isFocusedOnInputElement(),r=0;e&&(r+=.4),i&&(r+=.5),a&&(r+=.6),r=Math.min(1,r),this.cssController.setVariable("HolographicUISystem","--user-interaction-detected",r.toString(),"high","user-interaction-update")}isUserCurrentlyScrolling(){let t=document.querySelector(".main-view-container__scroll-node");if(!t)return!1;let e=t.scrollTop,i=this.lastScrollPosition||0;return this.lastScrollPosition=e,Math.abs(e-i)>5}isHoveringTextContent(){let t=document.querySelector(":hover");return t?(t.textContent?.trim()||"").length>20:!1}isMouseCurrentlyMoving(){let t=performance.now(),e=this.lastMouseMovement||0;return t-e<2e3}wasRecentUIClick(){let t=performance.now(),e=this.lastUIClick||0;return t-e<1e3}isFocusedOnInputElement(){let t=document.activeElement;return t?["input","textarea","select"].includes(t.tagName.toLowerCase())||t.getAttribute("contenteditable")==="true":!1}setTransparency(t){this.holographicState.transparency=Math.max(0,Math.min(1,t))}setChromaticAberration(t){this.holographicState.chromatic=Math.max(0,Math.min(1,t))}destroy(){console.log("[HolographicUISystem] Destroying holographic UI system..."),this.animationState.isAnimating=!1;for(let[e,i]of this.holographicElements)i.element.style.opacity="1",i.element.style.filter="",i.element.style.background="",i.element.style.boxShadow="",i.element.style.transform="",i.animation&&i.animation.cancel();this.holographicElements.clear(),this.interfaceContainer&&this.interfaceContainer.parentNode&&this.interfaceContainer.parentNode.removeChild(this.interfaceContainer),["dataStreamAnimation","energyBarrierAnimation","scanlineAnimation"].forEach(e=>{let i=document.getElementById(e);i&&i.remove()}),this.isInitialized=!1,this.initialized=!1,this.eventSubscriptionIds.forEach(e=>{p.unsubscribe(e)}),this.eventSubscriptionIds=[]}setQualityLevel(t){switch(this.currentQualityLevel=t,t){case"low":this.holographicState.flickerIntensity=.1,this.holographicState.transparency=.9,this.holographicState.chromatic=.1,this.holographicState.scanlineIntensity=.2,this.holographicState.dataStreamFlow=.2,this.holographicState.interferenceLevel=0,this.scanlineEffect.animation=!1;break;case"low":this.holographicState.flickerIntensity=.2,this.holographicState.transparency=.85,this.holographicState.chromatic=.2,this.holographicState.scanlineIntensity=.3,this.holographicState.dataStreamFlow=.3,this.holographicState.interferenceLevel=.1,this.scanlineEffect.animation=!0,this.scanlineEffect.speed=.3;break;case"medium":this.holographicState.flickerIntensity=.4,this.holographicState.transparency=.8,this.holographicState.chromatic=.3,this.holographicState.scanlineIntensity=.6,this.holographicState.dataStreamFlow=.5,this.holographicState.interferenceLevel=.2,this.scanlineEffect.animation=!0,this.scanlineEffect.speed=.5;break;case"high":this.holographicState.flickerIntensity=.6,this.holographicState.transparency=.7,this.holographicState.chromatic=.5,this.holographicState.scanlineIntensity=.8,this.holographicState.dataStreamFlow=.8,this.holographicState.interferenceLevel=.4,this.scanlineEffect.animation=!0,this.scanlineEffect.speed=.8;break;case"high":this.holographicState.flickerIntensity=.8,this.holographicState.transparency=.6,this.holographicState.chromatic=.7,this.holographicState.scanlineIntensity=1,this.holographicState.dataStreamFlow=1,this.holographicState.interferenceLevel=.6,this.scanlineEffect.animation=!0,this.scanlineEffect.speed=1;break}this.updateQualityCapabilities(t)}getPerformanceImpact(){let t=this.holographicElements.size;return{fps:60,frameTime:this.calculateProcessingTime(),memoryUsage:this.estimateMemoryUsage(),cpuUsage:this.estimateCPUUsage(t)}}reduceQuality(t){this.qualityAdjustments["flicker-reduction"]=(this.qualityAdjustments["flicker-reduction"]||0)+t,this.qualityAdjustments["effect-reduction"]=(this.qualityAdjustments["effect-reduction"]||0)+t*.8,this.holographicState.flickerIntensity=Math.max(.1,this.holographicState.flickerIntensity*(1-t*.8)),this.holographicState.chromatic=Math.max(0,this.holographicState.chromatic*(1-t)),this.holographicState.scanlineIntensity=Math.max(.1,this.holographicState.scanlineIntensity*(1-t*.6)),this.holographicState.dataStreamFlow=Math.max(.1,this.holographicState.dataStreamFlow*(1-t*.4)),this.holographicState.interferenceLevel=Math.max(0,this.holographicState.interferenceLevel*(1-t)),t>.5&&(this.scanlineEffect.animation=!1)}increaseQuality(t){if(Object.keys(this.qualityAdjustments).forEach(e=>{this.qualityAdjustments[e]=Math.max(0,(this.qualityAdjustments[e]||0)-t)}),this.currentQualityLevel){let e=this.getPresetForLevel(this.currentQualityLevel);this.holographicState.flickerIntensity=Math.min(e.flickerIntensity,this.holographicState.flickerIntensity*(1+t*.3)),this.holographicState.chromatic=Math.min(e.chromatic,this.holographicState.chromatic*(1+t*.4)),this.holographicState.scanlineIntensity=Math.min(e.scanlineIntensity,this.holographicState.scanlineIntensity*(1+t*.2)),this.holographicState.dataStreamFlow=Math.min(e.dataStreamFlow,this.holographicState.dataStreamFlow*(1+t*.2)),t>.3&&(this.scanlineEffect.animation=!0)}}getQualityCapabilities(){return[...this.qualityCapabilities]}updateQualityCapabilities(t){this.qualityCapabilities.forEach(e=>{switch(e.name){case"holographic-effects":e.enabled=this.holographicState.flickerIntensity>.2;break;case"scanline-overlay":e.enabled=this.holographicState.scanlineIntensity>.3;break;case"chromatic-aberration":e.enabled=this.holographicState.chromatic>.2;break;case"data-streams":e.enabled=this.holographicState.dataStreamFlow>.3;break;case"interference-patterns":e.enabled=this.holographicState.interferenceLevel>.1;break;case"dynamic-integration":e.enabled=t!=="low";break}})}getPresetForLevel(t){switch(t){case"low":return this.holographicPresets["dynamic-visualEffects"];case"medium":return this.holographicPresets["star-wars"];case"high":return this.holographicPresets["blade-runner"];default:return this.holographicPresets["star-wars"]}}calculateProcessingTime(){let t=this.holographicElements.size,e=(this.holographicState.flickerIntensity+this.holographicState.chromatic+this.holographicState.scanlineIntensity)/3;return Math.max(2,t*e*.5)}estimateMemoryUsage(){return .3*this.holographicElements.size+0}estimateCPUUsage(t){let i=(this.holographicState.flickerIntensity+this.holographicState.chromatic+this.holographicState.scanlineIntensity)/3,a=this.scanlineEffect.animation?1.5:1;return Math.min(30,2*t*i*a)}hexToRgb(t){try{let e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e&&e[1]&&e[2]&&e[3]?`${parseInt(e[1],16)}, ${parseInt(e[2],16)}, ${parseInt(e[3],16)}`:"100, 255, 200"}catch(e){return u?.debug?.warn("HolographicUISystem","Failed to convert hex to RGB:",e),"100, 255, 200"}}setupOKLABEventSubscriptions(){try{let t=p.subscribe("colors:oklab-enhanced",this.handleOKLABColorEvent.bind(this),"HolographicUISystem");this.eventSubscriptionIds.push(t);let e=p.subscribe("colors:musical-oklab-coordinated",this.handleMusicalOKLABEvent.bind(this),"HolographicUISystem");this.eventSubscriptionIds.push(e);let i=p.subscribe("colors:emotional-temperature-mapped",this.handleEmotionalTemperatureEvent.bind(this),"HolographicUISystem");this.eventSubscriptionIds.push(i);let a=p.subscribe("audio:genre-detected",this.handleGenreDetectionEvent.bind(this),"HolographicUISystem");this.eventSubscriptionIds.push(a),u?.debug?.log("HolographicUISystem","OKLAB event subscriptions established",{subscriptionCount:this.eventSubscriptionIds.length})}catch(t){u?.debug?.error("HolographicUISystem","Failed to setup OKLAB event subscriptions:",t)}}setupUserInteractionTracking(){try{document.addEventListener("mousemove",()=>{this.lastMouseMovement=performance.now()},{passive:!0}),document.addEventListener("click",()=>{this.lastUIClick=performance.now()},{passive:!0}),setInterval(()=>{this.detectReadingMode(),this.trackUserInteraction()},500),u?.debug?.log("HolographicUISystem","User interaction tracking initialized")}catch(t){u?.debug?.error("HolographicUISystem","Failed to setup user interaction tracking:",t)}}async handleOKLABColorEvent(t){try{let{enhancedColors:e,oklabPreset:i,rawColors:a,trackUri:r}=t;i&&(this.holographicPreset=i),e&&await this.updateHolographicColorsFromOKLAB(e),u?.debug?.log("HolographicUISystem","Updated holographic colors from OKLAB event",{preset:i?.name,trackUri:r,colorCount:Object.keys(e||{}).length})}catch(e){u?.debug?.error("HolographicUISystem","Failed to handle OKLAB color event:",e)}}async handleMusicalOKLABEvent(t){try{let{coordinatedColors:e,detectedGenre:i,emotionalResult:a,oklabPreset:r,musicInfluenceStrength:n,coordinationStrategy:s}=t;if(this.lastMusicalContext={genre:i,emotion:a?.primaryEmotion,preset:r,influence:n,strategy:s,timestamp:Date.now()},r&&(this.holographicPreset=r),e&&await this.updateHolographicColorsFromMusicalOKLAB(e,this.lastMusicalContext),a&&n!==void 0){let o=this.holographicState.flickerIntensity||.5,c=a.emotionalTemperature||6e3,m=n,d=a.beatDetected||!1;this.updateAberrationEffects(o,c,m,d)}u?.debug?.log("HolographicUISystem","Updated holographic effects from musical OKLAB coordination",{genre:i,emotion:a?.primaryEmotion,preset:r?.name,influence:n})}catch(e){u?.debug?.error("HolographicUISystem","Failed to handle musical OKLAB event:",e)}}async handleEmotionalTemperatureEvent(t){try{let{emotionalTemperature:e,primaryEmotion:i,perceptualColorHex:a,oklabPreset:r,cssVariables:n}=t;await this.updateHolographicEmotionalTemperature(e,i),a&&await this.updateHolographicColorFromEmotionalOKLAB(a,e);let s=this.holographicState.flickerIntensity||.5,o=this.lastMusicalContext?.influence||.5;this.updateAberrationEffects(s,e,o,!1),u?.debug?.log("HolographicUISystem","Updated holographic emotional temperature",{temperature:e,emotion:i,color:a})}catch(e){u?.debug?.error("HolographicUISystem","Failed to handle emotional temperature event:",e)}}async handleGenreDetectionEvent(t){try{let{detectedGenre:e,confidence:i,audioFeatures:a}=t,r=this.genreManager.getOKLABPresetForGenre(e);r&&(this.holographicPreset=r,await this.adjustHolographicEffectsForGenre(e,a)),u?.debug?.log("HolographicUISystem","Adjusted holographic effects for detected genre",{genre:e,confidence:i,preset:r?.name})}catch(e){u?.debug?.error("HolographicUISystem","Failed to handle genre detection event:",e)}}async updateHolographicColorsFromOKLAB(t){try{let e={};if(Object.entries(t).forEach(([i,a])=>{if(a&&typeof a=="string"){let r=this.oklabProcessor.processColor(a,this.holographicPreset);if(r.enhancedHex&&(e[`--holographic-${i.toLowerCase()}`]=r.enhancedHex,e[`--holographic-${i.toLowerCase()}-rgb`]=this.hexToRgb(r.enhancedHex),r.oklabEnhanced)){let{L:n,a:s,b:o}=r.oklabEnhanced;e[`--holographic-${i.toLowerCase()}-oklab`]=`${n.toFixed(3)} ${s.toFixed(3)} ${o.toFixed(3)}`}}}),t.VIBRANT||t.PRIMARY){let i=t.VIBRANT||t.PRIMARY;if(i){let a=this.oklabProcessor.processColor(i,this.holographicPreset);a.enhancedHex&&(e["--sn-holographic-rgb"]=this.hexToRgb(a.enhancedHex),e["--sn-holographic-primary"]=a.enhancedHex)}}Object.keys(e).length>0&&this.cssController.batchSetVariables("HolographicUISystem",e,"critical","oklab-holographic-colors-update")}catch(e){u?.debug?.error("HolographicUISystem","Failed to update holographic colors from OKLAB:",e)}}async updateHolographicColorsFromMusicalOKLAB(t,e){try{await this.updateHolographicColorsFromOKLAB(t),e.influence&&this.adjustHolographicIntensityFromMusicalInfluence(e.influence),e.genre&&await this.applyGenreSpecificHolographicEffects(e.genre,e.emotion)}catch(i){u?.debug?.error("HolographicUISystem","Failed to update holographic colors from musical OKLAB:",i)}}async updateHolographicColorFromEmotionalOKLAB(t,e){try{let i=document.documentElement,a=this.oklabProcessor.processColor(t,this.holographicPreset);if(a.enhancedHex){let r={"--holographic-emotional-primary":a.enhancedHex,"--holographic-emotional-rgb":this.hexToRgb(a.enhancedHex),"--holographic-emotional-temperature":`${e}K`};this.cssController.batchSetVariables("HolographicUISystem",r,"critical","emotional-oklab-holographic-update"),await this.updateHolographicEmotionalTemperature(e,null)}}catch(i){u?.debug?.error("HolographicUISystem","Failed to update holographic color from emotional OKLAB:",i)}}async updateHolographicEmotionalTemperature(t,e){try{let a=(Math.max(3e3,Math.min(8e3,t))-3e3)/5e3;this.holographicState.flickerIntensity=.2+a*.4,this.holographicState.chromatic=.1+a*.3,this.holographicState.energyStability=1-a*.3,a<.4?(this.holographicState.transparency=.9+a*.1,this.holographicState.dataStreamFlow=.3+a*.2):(this.holographicState.transparency=.8-(a-.4)*.2,this.holographicState.interferenceLevel=.1+(a-.4)*.3),u?.debug?.log("HolographicUISystem","Updated holographic effects from emotional temperature",{temperature:t,tempRatio:a,flicker:this.holographicState.flickerIntensity,chromatic:this.holographicState.chromatic})}catch(i){u?.debug?.error("HolographicUISystem","Failed to update holographic emotional temperature:",i)}}async adjustHolographicEffectsForGenre(t,e){try{switch(t.toLowerCase()){case"electronic":case"techno":case"edm":this.holographicState.dataStreamFlow=.8,this.holographicState.scanlineIntensity=.7,this.holographicState.interferenceLevel=.4,this.scanlineEffect.speed=.8;break;case"classical":case"orchestral":this.holographicState.transparency=.9,this.holographicState.energyStability=.8,this.holographicState.flickerIntensity=.2,this.scanlineEffect.dynamic=!0;break;case"rock":case"metal":this.holographicState.flickerIntensity=.6,this.holographicState.chromatic=.5,this.holographicState.interferenceLevel=.5,this.scanlineEffect.animation=!0;break;case"ambient":case"atmospheric":this.holographicState.transparency=.95,this.holographicState.dataStreamFlow=.3,this.holographicState.energyStability=.9,this.scanlineEffect.dynamic=!0,this.scanlineEffect.speed=.2;break;case"jazz":case"blues":this.holographicState.flickerIntensity=.4,this.holographicState.energyStability=.6,this.interferencePattern.type="dynamic",this.scanlineEffect.dynamic=!0;break;default:this.holographicState.flickerIntensity=.4,this.holographicState.transparency=.8,this.holographicState.chromatic=.3;break}u?.debug?.log("HolographicUISystem","Adjusted holographic effects for genre",{genre:t,flicker:this.holographicState.flickerIntensity,transparency:this.holographicState.transparency,dataFlow:this.holographicState.dataStreamFlow})}catch(i){u?.debug?.error("HolographicUISystem","Failed to adjust holographic effects for genre:",i)}}adjustHolographicIntensityFromMusicalInfluence(t){try{let e=.5+t*.5;this.holographicState.flickerIntensity*=e,this.holographicState.chromatic*=e,this.holographicState.scanlineIntensity*=e,this.holographicState.dataStreamFlow*=e,this.holographicState.interferenceLevel*=e,u?.debug?.log("HolographicUISystem","Adjusted holographic intensity from musical influence",{influence:t,multiplier:e})}catch(e){u?.debug?.error("HolographicUISystem","Failed to adjust holographic intensity from musical influence:",e)}}async applyGenreSpecificHolographicEffects(t,e){try{let i=`${t.toLowerCase()}-${e||"neutral"}`;t==="electronic"&&e==="energetic"?(this.setHolographicPreset("blade-runner"),this.holographicState.dataStreamFlow=1,this.holographicState.interferenceLevel=.6):t==="classical"&&e==="calm"?(this.setHolographicPreset("dynamic-visualEffects"),this.holographicState.transparency=.95,this.holographicState.energyStability=.9):t==="rock"&&e==="aggressive"&&(this.setHolographicPreset("star-wars"),this.holographicState.flickerIntensity=.8,this.holographicState.chromatic=.6),u?.debug?.log("HolographicUISystem","Applied genre-specific holographic effects",{genre:t,emotion:e,effectKey:i})}catch(i){u?.debug?.error("HolographicUISystem","Failed to apply genre-specific holographic effects:",i)}}updateAnimation(t){this.updateHolographicAnimation(t)}async healthCheck(){try{let t=this.estimateMemoryUsage(),e=this.estimateCPUUsage(this.holographicElements.size),i=this.holographicElements.size,a=this.initialized&&t<10&&e<25&&i<100;return{healthy:a,message:a?"Holographic UI system operating normally":"Holographic UI system performance degraded",details:{initialized:this.initialized,activeElements:i,memoryUsageMB:t,cpuUsagePercent:e,oklabIntegration:this.eventSubscriptionIds.length>0,lastUpdate:this.performanceMetrics.lastUpdate}}}catch(t){return{healthy:!1,message:`Holographic UI system health check failed: ${t}`,details:{error:t instanceof Error?t.message:String(t)}}}}getOKLABEnhancedGlowColor(t){try{let e=getComputedStyle(document.documentElement).getPropertyValue("--sn-holographic-primary")?.trim()||"#64ffcc",i=this.oklabProcessor.processColor(e,this.holographicPreset);return i.enhancedHex?`rgba(${this.hexToRgb(i.enhancedHex)}, ${t})`:`rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${t})`}catch(e){return u?.debug?.warn("HolographicUISystem","Failed to get OKLAB enhanced glow color:",e),`rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${t})`}}getOKLABEnhancedPanelColor(t){try{let e=getComputedStyle(document.documentElement).getPropertyValue("--sn-holographic-primary")?.trim()||"#64ffcc",i=this.oklabProcessor.processColor(e,this.holographicPreset);if(i.enhancedHex){let a=this.hexToRgb(i.enhancedHex);return{background:`rgba(${a}, ${t*.1})`,gradient:`rgba(${a}, ${t*.05})`,border:`rgba(${a}, ${t*.6})`}}return{background:`rgba(var(--spice-rgb-holographic-primary, var(--sn-holographic-rgb, 100, 255, 200)), ${t*.1})`,gradient:`rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${t*.05})`,border:`rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${t*.6})`}}catch(e){return u?.debug?.warn("HolographicUISystem","Failed to get OKLAB enhanced panel color:",e),{background:`rgba(var(--spice-rgb-holographic-primary, var(--sn-holographic-rgb, 100, 255, 200)), ${t*.1})`,gradient:`rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${t*.05})`,border:`rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${t*.6})`}}}getOKLABConsciousnessGlow(t,e){try{let i=getComputedStyle(document.documentElement).getPropertyValue("--sn-accent-hex")?.trim()||"#cba6f7",a={...this.holographicPreset,chromaBoost:this.holographicPreset.chromaBoost*(1+e*.5),lightnessBoost:this.holographicPreset.lightnessBoost*(1+e*.3)},r=this.oklabProcessor.processColor(i,a);if(r.enhancedHex){let n=this.hexToRgb(r.enhancedHex);return{outer:`rgba(${n}, ${t})`,inner:`rgba(${n}, ${t*.3})`}}return{outer:`rgba(var(--sn-accent-rgb, 203, 166, 247), ${t})`,inner:`rgba(var(--sn-accent-rgb, 203, 166, 247), ${t*.3})`}}catch(i){return u?.debug?.warn("HolographicUISystem","Failed to get OKLAB visualEffects glow:",i),{outer:`rgba(var(--sn-accent-rgb, 203, 166, 247), ${t})`,inner:`rgba(var(--sn-accent-rgb, 203, 166, 247), ${t*.3})`}}}getOKLABEnhancedDataStreamColor(t,e){try{let i="#64ffcc";if(e?.emotion){let r=this.emotionalMapper.mapMusicToEmotionalTemperature({energy:.5,valence:.5,tempo:120,genre:e.genre||"default"});r.perceptualColorHex&&(i=r.perceptualColorHex)}let a=this.oklabProcessor.processColor(i,this.holographicPreset);return a.enhancedHex?`rgba(${this.hexToRgb(a.enhancedHex)}, ${t})`:`rgba(var(--spice-rgb-holographic-primary, var(--sn-holographic-rgb, 100, 255, 200)), ${t})`}catch(i){return u?.debug?.warn("HolographicUISystem","Failed to get OKLAB enhanced data stream color:",i),`rgba(var(--spice-rgb-holographic-primary, var(--sn-holographic-rgb, 100, 255, 200)), ${t})`}}adjustQuality(t){switch(t){case"low":this.holographicState.energyStability=.3,this.holographicState.scanlineIntensity=.2,this.holographicState.interferenceLevel=.1;break;case"medium":this.holographicState.energyStability=.6,this.holographicState.scanlineIntensity=.5,this.holographicState.interferenceLevel=.3;break;case"high":default:this.holographicState.energyStability=1,this.holographicState.scanlineIntensity=.8,this.holographicState.interferenceLevel=.6;break}}}});var Yi,Vs=y(()=>{"use strict";k();ne();U();Yi=class extends N{constructor(e,i,a,r,n,s=null){super(e,i,a,r,n);this._scrollContainerElements=[];this._interactionHandler=null;this.year3000System=s,this.nexusState={currentNavigationScale:1,targetNavigationScale:1,userInfluence:0,lastEnergy:.5,lastValence:.5,lastVisualIntensity:.5,lastMoodIdentifier:"neutral"},this.biometricState={isMeditating:!1,lastUserInteractionTime:Date.now(),meditationGracePeriod:5e3,interactionCooldown:1e3,lastMeditationUpdateTime:null,desaturation:0,slowdown:1,targetDesaturation:0,targetSlowdown:1},this.lastHeavyUpdateTime=0,this.heavyUpdateInterval=1e3/10,this.lastBiometricCheckTime=0,this.biometricCheckInterval=1e3,this.lastInteractionRecordTime=0,this.interactionRecordInterval=200,this._animationRegistered=!1,this._performanceMode="auto",this._frameSkipCounter=0,this._maxFrameSkip=2,this.systemIntegrationMetrics={lastSystemsCheck:Date.now(),integrationHealth:"healthy",crossSystemErrors:0,meditationTransitions:0,navigationScaleUpdates:0};let o=this.utils.getHealthMonitor();o&&o.registerSystem("InteractionTrackingSystem",this),this.rootElement=this.utils.getRootStyle(),this.modalObserver=null,this._lastScrollTime=null,this._lastScrollTop=null}onAnimate(e){this.initialized&&this.updateAnimation(e)}async initialize(){await super.initialize();let e=globalThis.year3000System;this.cssController=e?.cssController||P(),this.initializeOptimizedQuantumSpace(),this.setupModalObserver(),this.setupOptimizedInteractionListener(),this._registerWithAnimationCoordinator()}_registerWithAnimationCoordinator(){this.year3000System&&this.year3000System.registerAnimationSystem?(this.year3000System.registerAnimationSystem("InteractionTrackingSystem",this,"normal",30),this._animationRegistered=!0):this._startFallbackAnimationLoops()}initializeOptimizedQuantumSpace(){if(!this.utils.getRootStyle())return;let i={"--sn-nav-item-transform-scale":"1.0","--sn-sidebar-meditation-desaturation":"0","--sn-sidebar-meditation-slowdown":"1"};this.cssController.batchSetVariables("InteractionTrackingSystem",i,"high","quantum-space-initialization")}recordUserInteraction(e){if(e.type==="scroll"){let r=e.target;if(r){let n=r.scrollTop,s=performance.now(),o=this._lastScrollTime?(n-(this._lastScrollTop??0))/(s-this._lastScrollTime):0,c=o<0?"up":"down";p.emit("user:scroll",{velocity:{x:0,y:o*1e3},direction:c,element:r.tagName||"unknown",timestamp:s}),this._lastScrollTop=n,this._lastScrollTime=s}}let a=performance.now();a-this.lastInteractionRecordTime<this.interactionRecordInterval||(this.lastInteractionRecordTime=a,this.nexusState.userInfluence+=.005,this.nexusState.userInfluence=Math.min(.5,this.nexusState.userInfluence),this.biometricState.lastUserInteractionTime=Date.now(),this.biometricState.isMeditating=!1)}setupModalObserver(){let e=document.querySelector(".main-modal-container");if(!e)return;let i=(a,r)=>{for(let n of a)if(n.type==="childList"){let s=e.children.length>0;this.nexusState.targetNavigationScale=s?.95:1}};this.modalObserver=new MutationObserver(i),this.modalObserver.observe(e,{childList:!0})}setupOptimizedInteractionListener(){this._interactionHandler=this.utils.throttle(n=>this.recordUserInteraction(n),100),["click","mousemove","keydown"].forEach(n=>{document.addEventListener(n,this._interactionHandler,{passive:!0})});let i=[".main-view-container__scroll-node",".main-view-container__scroll-node-child","section[data-testid='playlist-page']"],a=[];i.forEach(n=>{document.querySelectorAll(n).forEach(s=>{a.push(s)})}),(a.length?a:[document]).forEach(n=>{n.addEventListener("scroll",this._interactionHandler,{passive:!0})}),this._scrollContainerElements=a}updateFromMusicAnalysis(e,i,a){if(!this.initialized||!this.validateMusicData(e)){this.applySafeDefaults();return}this.updateNexusTargets(e)}updateNexusTargets(e){let{energy:i,valence:a,visualIntensity:r,moodIdentifier:n}=e;this.nexusState.lastEnergy=i,this.nexusState.lastValence=a,this.nexusState.lastVisualIntensity=r,this.nexusState.lastMoodIdentifier=n,this.nexusState.targetNavigationScale=this.calculateOptimizedNavigationScale(r,n)}updateDigitalMeditationState(e){let i=Date.now();if(i-this.lastBiometricCheckTime<this.biometricCheckInterval)return;this.lastBiometricCheckTime=i,i-this.biometricState.lastUserInteractionTime>this.biometricState.meditationGracePeriod&&e.energy<.3&&e.valence>.6?(this.biometricState.isMeditating=!0,this.biometricState.targetDesaturation=.6,this.biometricState.targetSlowdown=.5):(this.biometricState.isMeditating=!1,this.biometricState.targetDesaturation=0,this.biometricState.targetSlowdown=1)}updateAnimation(e){if(!this.initialized)return;let i=performance.now();if(this._frameSkipCounter++,!(this._frameSkipCounter<this._maxFrameSkip)&&(this._frameSkipCounter=0,this.animateOptimizedNexusFrame(e),i-this.lastHeavyUpdateTime>this.heavyUpdateInterval)){let a=this.musicSyncService?.getLatestProcessedData();a&&this.updateDigitalMeditationState(a),this.updateIntegrationMetrics(),this.lastHeavyUpdateTime=i}}onPerformanceModeChange(e){this._performanceMode=e,e==="performance"?(this.heavyUpdateInterval=1e3/5,this._maxFrameSkip=3,this.interactionRecordInterval=500):(this.heavyUpdateInterval=1e3/10,this._maxFrameSkip=2,this.interactionRecordInterval=200)}_startFallbackAnimationLoops(){let e=()=>{this.updateAnimation(16.67),requestAnimationFrame(e)};requestAnimationFrame(e)}animateOptimizedNexusFrame(e){let i=Math.min((e??16.67)/1e3*5,1);this.nexusState.currentNavigationScale=this.utils.lerp(this.nexusState.currentNavigationScale,this.nexusState.targetNavigationScale,i),this.biometricState.desaturation=this.utils.lerp(this.biometricState.desaturation,this.biometricState.targetDesaturation,i),this.biometricState.slowdown=this.utils.lerp(this.biometricState.slowdown,this.biometricState.targetSlowdown,i),this.applyOptimizedStateToCSS()}applyOptimizedStateToCSS(){let e={"--sn-nav-item-transform-scale":this.nexusState.currentNavigationScale.toFixed(3),"--sn-sidebar-meditation-desaturation":this.biometricState.desaturation.toFixed(3),"--sn-sidebar-meditation-slowdown":this.biometricState.slowdown.toFixed(3)};this.cssController.batchSetVariables("InteractionTrackingSystem",e,"high","interaction-state-update")}validateMusicData(e){return e&&typeof e.energy=="number"&&typeof e.valence=="number"&&typeof e.visualIntensity=="number"}applySafeDefaults(){let e={"--sn-nav-item-transform-scale":"1.0","--sn-sidebar-meditation-desaturation":"0","--sn-sidebar-meditation-slowdown":"1"};this.cssController.batchSetVariables("InteractionTrackingSystem",e,"critical","safe-defaults-fallback")}updateIntegrationMetrics(){}calculateIntegrationComplexity(){let e=0;return e+=this.nexusState.userInfluence*10,e+=this.nexusState.lastVisualIntensity*5,this.biometricState.isMeditating&&(e+=5),e}performCleanup(){this.nexusState.userInfluence>0&&(this.nexusState.userInfluence=Math.max(0,this.nexusState.userInfluence-.01))}calculateOptimizedNavigationScale(e=.5,i="neutral"){let a=1;return e>.7&&(a=1.02),i==="energetic"&&(a*=1.01),a}getNavigationScalingReport(){return{target:this.nexusState.targetNavigationScale,current:this.nexusState.currentNavigationScale,intensity:this.nexusState.lastVisualIntensity,mood:this.nexusState.lastMoodIdentifier}}getMeditationReport(){return{isMeditating:this.biometricState.isMeditating,timeSinceInteraction:(Date.now()-this.biometricState.lastUserInteractionTime)/1e3,desaturation:this.biometricState.desaturation,slowdown:this.biometricState.slowdown}}destroy(){this._interactionHandler&&(["click","mousemove","keydown"].forEach(e=>{document.removeEventListener(e,this._interactionHandler)}),this._scrollContainerElements.forEach(e=>{e.removeEventListener("scroll",this._interactionHandler)}),this._interactionHandler=null),super.destroy()}}});var ji,Bs=y(()=>{"use strict";k();ji=class{constructor(t){this.year3000System=t;this.systemName="SpotifyUIApplicationSystem";this.initialized=!1;this.effectLayers=[];this.observerRegistry=new Map;this.lastDiscoveryLogTime=0;this.lastRefreshLogTime=0;this.debounceRefresh=this.debounce(()=>{this.refreshUITargets()},2e3);this.targets=this.initializeEmptyTargets()}updateAnimation(t){}async healthCheck(){try{let t=this.getTargetStats(),e=Object.values(t).reduce((r,n)=>r+n,0),i=this.initialized&&e>0,a=[];return e===0&&a.push("No UI elements discovered"),{healthy:i,ok:i,details:`UI Application System ${this.initialized?"active":"inactive"}, ${e} elements enhanced`,issues:a,system:"SpotifyUIApplicationSystem"}}catch(t){return{healthy:!1,ok:!1,details:"Health check failed",issues:[t instanceof Error?t.message:"Unknown error"],system:"SpotifyUIApplicationSystem"}}}forceRepaint(t){console.log(`\u{1F3A8} Force repaint requested: ${t||"manual trigger"}`),this.forceEffectCascade()}initializeEmptyTargets(){return{nowPlaying:[],sidebar:[],mainContent:[],buttons:[],cards:[],headers:[],textElements:[],iconElements:[],playbackControls:[],trackRows:[]}}async initialize(){if(!this.initialized)try{await this.discoverUITargets(),this.setupEffectLayers(),this.applyUnifiedState(),this.setupDOMObservers(),this.registerSystemCallbacks(),this.initialized=!0,console.log("\u2728 SpotifyUIApplicationSystem initialized successfully")}catch(t){throw console.error("Failed to initialize SpotifyUIApplicationSystem",t),t}}async discoverUITargets(){let t={nowPlaying:['[data-testid="now-playing-widget"]',".main-nowPlayingWidget-nowPlaying",".Root__now-playing-bar"],sidebar:['[data-testid="nav-bar"]',".main-navBar-navBar",".Root__nav-bar"],mainContent:['[data-testid="main"]',".main-view-container",".Root__main-view"],buttons:['button[class*="Button"]','[role="button"]',".main-playButton-PlayButton"],cards:['[data-testid*="card"]',".main-card-card",".main-entityCard-container"],headers:["h1, h2, h3, h4, h5, h6",'[data-testid*="header"]',".main-entityHeader-titleText"],textElements:['[data-testid="track-name"]','[data-testid="artist-name"]',".main-trackList-trackName",".main-trackList-artistName"],iconElements:['svg[class*="Icon"]','[data-testid*="icon"]',".Svg-sc-ytk21e-0"],playbackControls:['[data-testid="control-button"]',".main-playPauseButton-button",".player-controls__buttons"],trackRows:['[data-testid="tracklist-row"]',".main-trackList-trackListRow",".main-rootlist-rootlistItem"]},e={};for(let[a,r]of Object.entries(t))e[a]=r.join(", ");let i=new Map;for(let[a,r]of Object.entries(e))try{let n=document.querySelectorAll(r);for(let s of n)i.has(s)||i.set(s,[]),i.get(s).push(a)}catch{continue}this.targets=this.initializeEmptyTargets();for(let[a,r]of i)for(let n of r)this.targets[n].push(a);performance.now()-this.lastDiscoveryLogTime>=5e3&&(console.log("\u{1F3AF} UI targets discovered",{nowPlaying:this.targets.nowPlaying.length,sidebar:this.targets.sidebar.length,mainContent:this.targets.mainContent.length,buttons:this.targets.buttons.length,cards:this.targets.cards.length,headers:this.targets.headers.length,textElements:this.targets.textElements.length,iconElements:this.targets.iconElements.length,playbackControls:this.targets.playbackControls.length,trackRows:this.targets.trackRows.length}),this.lastDiscoveryLogTime=performance.now())}setupEffectLayers(){this.effectLayers=[{name:"background-containers",elements:[...this.targets.mainContent,...this.targets.sidebar],priority:10,cssVariables:{"--sn-bg-primary":"var(--sn-accent-primary)","--sn-bg-secondary":"var(--sn-accent-secondary)","--sn-gradient-start":"var(--sn-gradient-primary-rgb)","--sn-gradient-end":"var(--sn-gradient-secondary-rgb)"}},{name:"ui-cards",elements:this.targets.cards,priority:20,cssVariables:{"--sn-card-bg":"var(--sn-accent-primary)","--sn-card-border":"var(--sn-accent-secondary)","--sn-card-glow":"var(--sn-accent-tertiary)","--sn-glassmorphism-intensity":"var(--sn-effect-intensity)"},interactionEffects:!0},{name:"interactive-elements",elements:[...this.targets.buttons,...this.targets.playbackControls],priority:30,cssVariables:{"--sn-button-bg":"var(--sn-accent-primary)","--sn-button-hover":"var(--sn-accent-secondary)","--sn-button-active":"var(--sn-accent-tertiary)","--sn-beat-sync-intensity":"var(--sn-music-intensity)"},interactionEffects:!0},{name:"text-icon-effects",elements:[...this.targets.textElements,...this.targets.iconElements,...this.targets.headers],priority:40,cssVariables:{"--sn-text-primary":"var(--sn-accent-primary)","--sn-text-secondary":"var(--sn-accent-secondary)","--sn-text-glow":"var(--sn-accent-tertiary)","--sn-icon-color":"var(--sn-accent-primary)","--sn-icon-glow":"var(--sn-accent-secondary)"}},{name:"now-playing-effects",elements:this.targets.nowPlaying,priority:50,cssVariables:{"--sn-now-playing-bg":"var(--sn-accent-primary)","--sn-now-playing-glow":"var(--sn-accent-secondary)","--sn-beat-pulse":"var(--sn-music-intensity)","--sn-track-progress":"var(--sn-accent-tertiary)"},interactionEffects:!0}]}applyUnifiedState(){this.effectLayers.forEach(t=>{t.elements.forEach(e=>{this.applyEffectToElement(e,t)})})}safeQueueCSSVariableUpdate(t,e,i){this.year3000System?.queueCSSVariableUpdate?this.year3000System.queueCSSVariableUpdate(t,e,i||null):(i||document.documentElement).style.setProperty(t,e)}applyEffectToElement(t,e){t instanceof HTMLElement&&(Object.entries(e.cssVariables).forEach(([i,a])=>{this.safeQueueCSSVariableUpdate(i,a,t)}),t.classList.add(`sn-${e.name}`),t.classList.add("sn-ui-enhanced"),e.interactionEffects&&this.addInteractionEffects(t,e),t.setAttribute("data-sn-layer",e.name),t.setAttribute("data-sn-priority",e.priority.toString()))}addInteractionEffects(t,e){(e.name==="interactive-elements"||e.name==="now-playing-effects")&&(this.safeQueueCSSVariableUpdate("--sn-beat-response","var(--sn-music-intensity)",t),t.classList.add("sn-beat-responsive")),t.addEventListener("mouseenter",()=>{this.safeQueueCSSVariableUpdate("--sn-hover-intensity","1",t),t.classList.add("sn-hover-active")}),t.addEventListener("mouseleave",()=>{this.safeQueueCSSVariableUpdate("--sn-hover-intensity","0",t),t.classList.remove("sn-hover-active")}),t.addEventListener("click",()=>{this.safeQueueCSSVariableUpdate("--sn-click-intensity","1",t),t.classList.add("sn-click-active"),setTimeout(()=>{this.safeQueueCSSVariableUpdate("--sn-click-intensity","0",t),t.classList.remove("sn-click-active")},300)})}setupDOMObservers(){let t={childList:!0,subtree:!1,attributes:!1},e=new MutationObserver(a=>{let r=!1;a.forEach(n=>{n.type==="childList"&&n.addedNodes.length>0&&Array.from(n.addedNodes).some(o=>{if(o.nodeType===Node.ELEMENT_NODE){let c=o;return c.matches('[data-testid*="card"], [data-testid*="track"], [data-testid*="header"], [role="button"]')||c.querySelector('[data-testid*="card"], [data-testid*="track"], [data-testid*="header"], [role="button"]')}return!1})&&(r=!0)}),r&&this.debounceRefresh()}),i=document.querySelector('[data-testid="main"]')||document.body;e.observe(i,t),this.observerRegistry.set("main",e)}debounce(t,e){let i;return function(...r){let n=()=>{clearTimeout(i),t(...r)};clearTimeout(i),i=setTimeout(n,e)}}async refreshUITargets(){try{let t=this.calculateTargetHash();await this.discoverUITargets();let e=this.calculateTargetHash();t!==e&&(this.applyUnifiedState(),performance.now()-this.lastRefreshLogTime>=1e4&&(console.log("\u{1F504} UI targets refreshed"),this.lastRefreshLogTime=performance.now()))}catch(t){console.error("Failed to refresh UI targets",t)}}calculateTargetHash(){return Object.values(this.targets).map(e=>e.length).join("-")}registerSystemCallbacks(){try{p.subscribe("colors:harmonized",t=>{this.handleColorHarmonizedEvent({type:"colors/harmonized",payload:{processedColors:t.processedColors,accentHex:t.accentHex||"#cba6f7",accentRgb:t.accentRgb||"203,166,247",context:{rawColors:t.processedColors,trackUri:"",timestamp:Date.now()},cssVariables:{},metadata:{strategy:t.strategies[0]||"unknown",accentHex:t.accentHex,processingTime:t.processingTime}}})},"SpotifyUIApplicationSystem"),console.log("\u{1F3A8} [SpotifyUIApplicationSystem] Subscribed to colors:harmonized events")}catch(t){if(console.error("[SpotifyUIApplicationSystem] Failed to subscribe to colors:harmonized events:",t),this.year3000System.colorHarmonyEngine){let e=this.year3000System.applyColorsToTheme.bind(this.year3000System);this.year3000System.applyColorsToTheme=(i={})=>{e(i),this.updateColorVariables(i)},console.warn("[SpotifyUIApplicationSystem] Using legacy color application hook as fallback")}}if(this.year3000System.musicSyncService){let t=this.year3000System.updateFromMusicAnalysis.bind(this.year3000System);this.year3000System.updateFromMusicAnalysis=(e,i,a)=>{t(e,i,a),this.updateMusicIntensity(e)}}this.year3000System.beatSyncVisualSystem&&(this.year3000System.timerConsolidationSystem?this.year3000System.timerConsolidationSystem.registerConsolidatedTimer("SpotifyUIApplicationSystem-beatEffects",()=>{let t=this.getCurrentMusicIntensity();t>.5&&this.triggerBeatEffects({intensity:t})},200,"normal"):setInterval(()=>{let t=this.getCurrentMusicIntensity();t>.5&&this.triggerBeatEffects({intensity:t})},200))}getCurrentMusicIntensity(){let t=document.documentElement,e=getComputedStyle(t).getPropertyValue("--sn-kinetic-energy").trim();return parseFloat(e)||0}handleColorHarmonizedEvent(t){if(t.type!=="colors/harmonized")return;let{processedColors:e,cssVariables:i,metadata:a}=t.payload;console.log("\u{1F3A8} [SpotifyUIApplicationSystem] Received harmonized colors via event-driven pattern",{strategy:a.strategy,colorsCount:Object.keys(e).length,cssVariablesCount:Object.keys(i).length});try{this.updateColorVariables(e),i&&Object.keys(i).length>0&&this.applyCSSVariablesToSpotifyUI(i)}catch(r){console.error("[SpotifyUIApplicationSystem] Failed to apply harmonized colors from event:",r),this.updateColorVariables(e)}}applyCSSVariablesToSpotifyUI(t){try{let e=document.documentElement,i=document.querySelectorAll(".sn-ui-enhanced");for(let[a,r]of Object.entries(t))a&&r&&e.style.setProperty(a,r);i.forEach(a=>{if(a instanceof HTMLElement)for(let[r,n]of Object.entries(t))r&&n&&a.style.setProperty(r,n)}),console.log("\u{1F3A8} [SpotifyUIApplicationSystem] Applied CSS variables to Spotify UI",{variablesCount:Object.keys(t).length,enhancedElementsCount:i.length})}catch(e){console.error("[SpotifyUIApplicationSystem] Failed to apply CSS variables to Spotify UI:",e)}}updateColorVariables(t){document.querySelectorAll(".sn-ui-enhanced").forEach(i=>{i instanceof HTMLElement&&(this.safeQueueCSSVariableUpdate("--sn-accent-primary",t.primary||"var(--spice-accent)",i),this.safeQueueCSSVariableUpdate("--sn-accent-secondary",t.secondary||"var(--spice-accent)",i),this.safeQueueCSSVariableUpdate("--sn-accent-tertiary",t.tertiary||"var(--spice-accent)",i))})}updateMusicIntensity(t){let e=t?.processedEnergy||0;document.querySelectorAll(".sn-beat-responsive").forEach(a=>{a instanceof HTMLElement&&this.safeQueueCSSVariableUpdate("--sn-music-intensity",e.toString(),a)})}triggerBeatEffects(t){document.querySelectorAll(".sn-beat-responsive").forEach(i=>{i instanceof HTMLElement&&(this.safeQueueCSSVariableUpdate("--sn-beat-pulse","1",i),i.classList.add("sn-beat-active"),setTimeout(()=>{this.safeQueueCSSVariableUpdate("--sn-beat-pulse","0",i),i.classList.remove("sn-beat-active")},200))})}forceEffectCascade(){this.effectLayers.sort((t,e)=>t.priority-e.priority).forEach(t=>{t.elements.forEach(e=>{this.applyEffectToElement(e,t)})})}async destroy(){this.year3000System?.timerConsolidationSystem&&this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer("SpotifyUIApplicationSystem-beatEffects"),this.observerRegistry.forEach(e=>{e.disconnect()}),this.observerRegistry.clear(),document.querySelectorAll(".sn-ui-enhanced").forEach(e=>{e.classList.remove("sn-ui-enhanced"),e.removeAttribute("data-sn-layer"),e.removeAttribute("data-sn-priority")}),this.initialized=!1}getTargetStats(){return Object.fromEntries(Object.entries(this.targets).map(([t,e])=>[t,e.length]))}}});var Ki,Fs=y(()=>{"use strict";k();Me();ie();Ki=class{constructor(t,e,i){this.initialized=!1;this.cinematicElements=new Map;this.dramaticElements=this.cinematicElements;this.performanceMetrics={energyBurstCount:0,averageProcessingTime:0,lastUpdateTime:0,cpuUsage:0};this.animationState={energyPhase:0,dramaticPhase:0,interferencePhase:0,lastFrameTime:0,isAnimating:!1};this.cinematicPalettes={"blade-runner":{primaryRed:{r:255,g:50,b:50},amberGlow:{r:255,g:140,b:0},deepBlue:{r:0,g:100,b:200},neonCyan:{r:0,g:255,b:255}},cyberpunk:{primaryRed:{r:255,g:0,b:100},amberGlow:{r:255,g:180,b:0},deepBlue:{r:50,g:50,b:255},neonCyan:{r:100,g:255,b:255}},"dramatic-noir":{primaryRed:{r:200,g:0,b:0},amberGlow:{r:255,g:120,b:0},deepBlue:{r:0,g:50,b:150},neonCyan:{r:0,g:200,b:255}}};this.layeredSystem=t,this.holographicSystem=t,this.cssController=e,this.musicSyncService=i,this.oklabProcessor=new E(!0),this.emotionalMapper=new J(!0),this.cinematicPreset=E.getPreset("COSMIC"),this.energyBurstState={burstIntensity:0,burstFrequency:.5,colorTemperature:2500,interferenceLevel:0,scanlineVelocity:1,layeredDepth:0,holographicDepth:0,musicTension:0,energyStability:1},this.cinematicConfig={energyActivationThreshold:.7,maxLayeredIntensity:.9,maxHolographicIntensity:.9,crtFilteringStrength:.8,bladeRunnerMode:!0,energyBurstDuration:1500,baseScanlineFrequency:120}}async initialize(){if(!this.initialized)try{console.log("[RedEnergyBurstSystem] Initializing red energy burst system..."),this.subscribeToColorVisualEffects(),this.subscribeToOKLABColorEvents(),await this.initializeCinematicElements(),this.setupCinematicCSSVariables(),this.startCinematicAnimation(),this.initialized=!0,console.log("[RedEnergyBurstSystem] \u2705 Ready for dramatic visual effects moments")}catch(t){throw console.error("[RedEnergyBurstSystem] Failed to initialize:",t),t}}updateAnimation(t){if(!this.initialized)return;let e=t/1e3;this.animationState.energyPhase+=e*this.energyBurstState.burstFrequency*2,this.animationState.dramaticPhase+=e*.8,this.animationState.interferencePhase+=e*3,this.updateEnergyBurstFromMusic(),this.updateLayeredMapping(),this.updateCinematicElements(),this.updatePerformanceMetrics(t)}async healthCheck(){let t=this.initialized&&this.energyBurstState.burstIntensity>=0&&this.performanceMetrics.averageProcessingTime<5;return{system:"RedEnergyBurstSystem",healthy:t,metrics:{energyBurstCount:this.performanceMetrics.energyBurstCount,processingTime:this.performanceMetrics.averageProcessingTime,cinematicElementCount:this.cinematicElements.size,cpuUsage:this.performanceMetrics.cpuUsage},issues:t?[]:["Performance degradation detected"]}}subscribeToColorVisualEffects(){p.subscribe("music:emotional-context-updated",t=>{this.onColorVisualEffectsUpdate(t)},"RedEnergyBurstSystem"),p.subscribe("music:emotion-analyzed",t=>{this.onMusicIntensitySpike(t)},"RedEnergyBurstSystem"),p.subscribe("music:emotion-analyzed",t=>{this.onDramaticMoment(t)},"RedEnergyBurstSystem")}subscribeToOKLABColorEvents(){p.subscribe("colors:harmonized",t=>{this.onOKLABColorsHarmonized(t)},"RedEnergyBurstSystem"),p.subscribe("colors:extracted",t=>{this.onColorsExtracted(t)},"RedEnergyBurstSystem")}onColorVisualEffectsUpdate(t){let{palette:e,visualEffectsLevel:i,emotionalTemperature:a}=t;this.energyBurstState.musicTension=i*.8,a<3e3?this.energyBurstState.colorTemperature=2200:a>6e3?this.energyBurstState.colorTemperature=2800:this.energyBurstState.colorTemperature=2500;let r=this.extractDominantRedColor(e);this.updateHolographicColors(r)}onMusicIntensitySpike(t){let{intensity:e,beat:i}=t;e>this.cinematicConfig.energyActivationThreshold&&this.triggerEnergyBurst(e,i)}onDramaticMoment(t){let{type:e,intensity:i}=t;this.energyBurstState.musicTension=Math.min(1,i*1.2),this.energyBurstState.interferenceLevel=i*.6,this.energyBurstState.energyStability=Math.max(.3,1-i*.7)}onOKLABColorsHarmonized(t){let{processedColors:e,coordinationMetrics:i}=t,a=this.extractCinematicOKLABColors(e);this.updateCinematicPaletteWithOKLAB(a),(i?.detectedGenre||i?.emotionalState)&&this.adjustCinematicPresetForContext(i)}onColorsExtracted(t){let{rawColors:e,musicData:i}=t;if(i){let a=this.emotionalMapper.mapMusicToEmotionalTemperature(i);this.adjustCinematicEffectsForEmotion(a),a.intensity>.7?this.cinematicPreset=E.getPreset("COSMIC"):a.intensity>.4?this.cinematicPreset=E.getPreset("VIBRANT"):this.cinematicPreset=E.getPreset("STANDARD")}}triggerEnergyBurst(t,e){let i=performance.now();this.energyBurstState.burstIntensity=Math.min(1,t*1.1),this.energyBurstState.burstFrequency=1+t*2,this.energyBurstState.layeredDepth=t*.8,this.energyBurstState.holographicDepth=t*.8,this.energyBurstState.scanlineVelocity=1+e.strength*2,setTimeout(()=>{this.decayEnergyBurst()},this.cinematicConfig.energyBurstDuration),this.performanceMetrics.energyBurstCount++,this.performanceMetrics.lastUpdateTime=performance.now()-i,console.log(`[RedEnergyBurstSystem] \u{1F525} Red energy burst triggered! Intensity: ${t.toFixed(2)}`)}decayEnergyBurst(){let e=()=>{this.energyBurstState.burstIntensity*=.95,this.energyBurstState.layeredDepth*=.96,this.energyBurstState.holographicDepth=this.energyBurstState.layeredDepth,this.energyBurstState.interferenceLevel*=.97,this.energyBurstState.burstIntensity>.05?requestAnimationFrame(e):(this.energyBurstState.burstIntensity=0,this.energyBurstState.layeredDepth=0,this.energyBurstState.holographicDepth=0,this.energyBurstState.interferenceLevel=0)};requestAnimationFrame(e)}updateEnergyBurstFromMusic(){let t=this.musicSyncService.getCurrentMusicState();if(!t)return;let{emotion:e,beat:i,intensity:a}=t;if(i&&i.tempo){let r=Math.max(.5,Math.min(2,i.tempo/120));this.energyBurstState.burstFrequency=this.energyBurstState.burstFrequency*r}e&&e.arousal>.7&&(this.energyBurstState.interferenceLevel=Math.max(this.energyBurstState.interferenceLevel,e.arousal*.5))}updateLayeredMapping(){let t=this.cinematicPalettes["blade-runner"],e={primaryColor:this.blendRedColors(t.primaryRed,t.amberGlow,this.energyBurstState.colorTemperature/3e3),glowIntensity:this.energyBurstState.burstIntensity*this.cinematicConfig.maxLayeredIntensity,flickerRate:this.energyBurstState.burstFrequency*2,scanlineColor:t.amberGlow,atmosphericDepth:this.energyBurstState.layeredDepth,interferencePattern:this.getInterferencePattern()};this.updateCinematicCSSVariables(e)}updateHolographicMapping(){this.updateLayeredMapping()}blendRedColors(t,e,i){let a=Math.max(0,Math.min(1,i));try{let r=`#${t.r.toString(16).padStart(2,"0")}${t.g.toString(16).padStart(2,"0")}${t.b.toString(16).padStart(2,"0")}`,n=`#${e.r.toString(16).padStart(2,"0")}${e.g.toString(16).padStart(2,"0")}${e.b.toString(16).padStart(2,"0")}`;return this.oklabProcessor.interpolateOKLAB(r,n,a,this.cinematicPreset).enhancedRgb}catch{return{r:Math.round(t.r*(1-a)+e.r*a),g:Math.round(t.g*(1-a)+e.g*a),b:Math.round(t.b*(1-a)+e.b*a)}}}getInterferencePattern(){return this.energyBurstState.energyStability<.4?"chaotic":this.energyBurstState.musicTension>.7?"intense":this.energyBurstState.interferenceLevel>.5?"noise":"wave"}extractDominantRedColor(t){let e={r:255,g:50,b:50};if(t&&t.length>0){let i=t.filter(a=>a.r>a.g&&a.r>a.b);i.length>0&&(e=i[0])}return e}extractCinematicOKLABColors(t){let i={...this.cinematicPalettes["blade-runner"]};if(t.VIBRANT){let a=this.oklabProcessor.processColor(t.VIBRANT,this.cinematicPreset);i.primaryRed=a.enhancedRgb}if(t.PROMINENT){let a=this.oklabProcessor.processColor(t.PROMINENT,this.cinematicPreset);i.amberGlow=a.enhancedRgb}if(t.DARK_VIBRANT){let a=this.oklabProcessor.processColor(t.DARK_VIBRANT,this.cinematicPreset);i.deepBlue=a.enhancedRgb}return i}updateCinematicPaletteWithOKLAB(t){this.cinematicPalettes["blade-runner"]=t,this.cssController.queueCSSVariableUpdate("--cinematic-red-r",t.primaryRed.r.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-red-g",t.primaryRed.g.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-red-b",t.primaryRed.b.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-amber-r",t.amberGlow.r.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-amber-g",t.amberGlow.g.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-amber-b",t.amberGlow.b.toString())}adjustCinematicPresetForContext(t){let{detectedGenre:e,emotionalState:i,oklabPreset:a}=t;if(e)switch(e){case"electronic":case"dance":case"techno":this.cinematicPreset=E.getPreset("COSMIC"),this.cinematicConfig.bladeRunnerMode=!0;break;case"rock":case"metal":this.cinematicPreset=E.getPreset("VIBRANT"),this.cinematicConfig.energyActivationThreshold=.6;break;case"ambient":case"classical":this.cinematicPreset=E.getPreset("SUBTLE"),this.cinematicConfig.energyActivationThreshold=.8;break;default:this.cinematicPreset=E.getPreset("STANDARD")}if(i)switch(i){case"aggressive":case"energetic":this.energyBurstState.burstFrequency*=1.5,this.energyBurstState.interferenceLevel=Math.min(1,this.energyBurstState.interferenceLevel+.3);break;case"calm":case"ambient":this.energyBurstState.burstFrequency*=.7,this.energyBurstState.energyStability=Math.min(1,this.energyBurstState.energyStability+.2);break;case"mysterious":this.cinematicConfig.bladeRunnerMode=!0,this.energyBurstState.interferenceLevel=Math.min(1,this.energyBurstState.interferenceLevel+.2);break}}adjustCinematicEffectsForEmotion(t){let{primaryEmotion:e,intensity:i,temperature:a}=t;switch(this.energyBurstState.musicTension=i*.9,a<3e3?this.energyBurstState.colorTemperature=2200:a>6e3?this.energyBurstState.colorTemperature=2800:this.energyBurstState.colorTemperature=2500,e){case"aggressive":this.energyBurstState.interferenceLevel=Math.min(1,i*.8),this.energyBurstState.energyStability=Math.max(.2,1-i);break;case"calm":this.energyBurstState.energyStability=Math.min(1,.8+i*.2),this.energyBurstState.interferenceLevel*=.5;break;case"mysterious":this.energyBurstState.interferenceLevel=i*.6,this.cinematicConfig.bladeRunnerMode=!0;break;case"energetic":this.energyBurstState.burstFrequency=Math.min(3,1+i*2);break}}updateHolographicColors(t){this.cssController.queueCSSVariableUpdate("--cinematic-red-r",t.r.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-red-g",t.g.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-red-b",t.b.toString())}async initializeCinematicElements(){return this.initializeDramaticElements()}async initializeDramaticElements(){let t=[{selector:".Root__now-playing-bar",type:"energy_barrier"},{selector:".main-view-container",type:"cinematic_overlay"},{selector:".Root__nav-bar",type:"data_stream_red"},{selector:".player-controls",type:"dramatic_interface"}];for(let e of t){let i=document.querySelectorAll(e.selector);for(let a of i){let r={id:`dramatic-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,element:a,originalStyles:getComputedStyle(a),holographicType:e.type,intensity:.8,isActive:!0,lastUpdate:0,animation:null,visualEffectsLevel:.9,smoothIntegration:!0};this.cinematicElements.set(r.id,r)}}}setupCinematicCSSVariables(){let t={"--cinematic-red-r":"255","--cinematic-red-g":"50","--cinematic-red-b":"50","--cinematic-amber-r":"255","--cinematic-amber-g":"140","--cinematic-amber-b":"0","--cinematic-glow-intensity":"0","--cinematic-flicker-rate":"0.5","--cinematic-scanline-speed":"1.0","--cinematic-interference":"0","--cinematic-depth":"0"};for(let[e,i]of Object.entries(t))this.cssController.queueCSSVariableUpdate(e,i)}updateCinematicCSSVariables(t){this.cssController.queueCSSVariableUpdate("--cinematic-glow-intensity",t.glowIntensity.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-flicker-rate",t.flickerRate.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-scanline-speed",this.energyBurstState.scanlineVelocity.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-interference",this.energyBurstState.interferenceLevel.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-depth",t.atmosphericDepth.toString())}updateCinematicElements(){for(let[t,e]of this.cinematicElements)e.isActive&&this.updateCinematicElement(e)}updateDramaticElements(){for(let[t,e]of this.cinematicElements)e.isActive&&this.updateDramaticElement(e)}updateCinematicElement(t){let{element:e,intensity:i}=t;this.energyBurstState.burstIntensity>.1&&this.applyRedEnergyBurst(e,i),this.energyBurstState.interferenceLevel>.1&&this.applyCRTInterference(e,i),this.applyCinematicScanlines(e,i)}updateDramaticElement(t){let{element:e,intensity:i}=t;this.energyBurstState.burstIntensity>.1&&this.applyRedEnergyBurst(e,i),this.energyBurstState.interferenceLevel>.1&&this.applyCRTInterference(e,i),this.applyCinematicScanlines(e,i)}applyRedEnergyBurst(t,e){let i=this.energyBurstState.burstIntensity*e,a=Math.sin(this.animationState.energyPhase*3)*.5+.5,r=i*a*.8;t.style.boxShadow=`
      0 0 ${r*40}px rgba(var(--cinematic-red-r), var(--cinematic-red-g), var(--cinematic-red-b), ${r}),
      inset 0 0 ${r*20}px rgba(var(--cinematic-amber-r), var(--cinematic-amber-g), var(--cinematic-amber-b), ${r*.5})
    `,i>.3&&(t.style.border=`1px solid rgba(var(--cinematic-red-r), var(--cinematic-red-g), var(--cinematic-red-b), ${i})`)}applyCRTInterference(t,e){let i=this.energyBurstState.interferenceLevel*e,a=this.animationState.interferencePhase,r=i*3,n=Math.sin(a*2)*r,s=Math.cos(a*2.5)*r;if(t.style.filter=`
      drop-shadow(${n}px 0 0 rgba(var(--spice-rgb-cinematic-red, 255, 0, 0), ${i*.6}))
      drop-shadow(${s}px 0 0 rgba(var(--spice-rgb-cinematic-cyan, 0, 255, 255), ${i*.4}))
    `,i>.5){let o=Math.sin(a*10)*i*2;t.style.transform=`translateX(${o}px)`}}applyCinematicScanlines(t,e){let i=this.energyBurstState.burstIntensity*e*.6;if(i>.1){let a=this.cinematicConfig.baseScanlineFrequency/30;t.style.background=`
        ${t.style.background||""},
        repeating-linear-gradient(
          0deg,
          transparent 0px,
          transparent ${a-1}px,
          rgba(var(--cinematic-amber-r), var(--cinematic-amber-g), var(--cinematic-amber-b), ${i*.15}) ${a}px
        )
      `}}applyDramaticScanlines(t,e){let i=this.energyBurstState.burstIntensity*e*.6;if(i>.1){let a=this.cinematicConfig.baseScanlineFrequency/30;t.style.background=`
        ${t.style.background||""},
        repeating-linear-gradient(
          0deg,
          transparent 0px,
          transparent ${a-1}px,
          rgba(var(--cinematic-amber-r), var(--cinematic-amber-g), var(--cinematic-amber-b), ${i*.15}) ${a}px
        )
      `}}startCinematicAnimation(){this.animationState.isAnimating=!0,this.animationState.lastFrameTime=performance.now();let t=e=>{if(!this.animationState.isAnimating)return;let i=e-this.animationState.lastFrameTime;this.animationState.lastFrameTime=e,this.updateAnimation(i),requestAnimationFrame(t)};requestAnimationFrame(t)}updatePerformanceMetrics(t){this.performanceMetrics.averageProcessingTime=this.performanceMetrics.averageProcessingTime*.9+t*.1,this.performanceMetrics.cpuUsage=Math.min(100,t/16.67*100)}forceRepaint(t){console.log(`[RedEnergyBurstSystem] Force repaint triggered: ${t||"Unknown"}`),this.updateCinematicElements(),this.cssController.flushCSSVariableBatch()}destroy(){console.log("[RedEnergyBurstSystem] Destroying cinematic drama engine..."),this.animationState.isAnimating=!1,this.cinematicElements.clear(),this.energyBurstState={burstIntensity:0,burstFrequency:.5,colorTemperature:2500,interferenceLevel:0,scanlineVelocity:1,layeredDepth:0,holographicDepth:0,musicTension:0,energyStability:1},this.initialized=!1}getEnergyBurstState(){return{...this.energyBurstState}}getCinematicConfig(){return{...this.cinematicConfig}}getPerformanceMetrics(){return{...this.performanceMetrics}}setRedEnergyThreshold(t){this.cinematicConfig.energyActivationThreshold=Math.max(0,Math.min(1,t))}setBladeRunnerMode(t){this.cinematicConfig.bladeRunnerMode=t,t&&console.log("[RedEnergyBurstSystem] \u{1F3AC} Blade Runner mode activated")}}});var _t,Gs=y(()=>{"use strict";k();Z();_t=class{constructor(t,e,i){this.initialized=!1;this.subtleElements=new Map;this.performanceMetrics={responsiveMomentCount:0,averageProcessingTime:0,lastUpdateTime:0,smoothTransitionCount:0,get emotionalMomentCount(){return this.responsiveMomentCount},set emotionalMomentCount(t){this.responsiveMomentCount=t},get gentleTransitionCount(){return this.smoothTransitionCount},set gentleTransitionCount(t){this.smoothTransitionCount=t}};this.animationState={ambientPhase:0,smoothPhase:0,flowingPhase:0,get mysticalPhase(){return this.ambientPhase},set mysticalPhase(t){this.ambientPhase=t},get dreamyPhase(){return this.smoothPhase},set dreamyPhase(t){this.smoothPhase=t},responsivePulsePhase:0,get emotionalPulsePhase(){return this.responsivePulsePhase},set emotionalPulsePhase(t){this.responsivePulsePhase=t},lastFrameTime:0,isAnimating:!1};this.lerpHalfLifeValues={glowIntensity:.25,effectLevel:.35,shimmerEffect:.2};this.subtlePalettes={"smooth-pastels":{primaryGlow:{r:203,g:166,b:247},shimmerColor:{r:148,g:226,b:213},mistBackground:{r:245,g:224,b:220},coreColor:{r:249,g:226,b:175},accentColor:{r:180,g:190,b:254}},"ambient-moonlight":{primaryGlow:{r:137,g:180,b:250},shimmerColor:{r:166,g:227,b:161},mistBackground:{r:205,g:214,b:244},coreColor:{r:243,g:139,b:168},accentColor:{r:137,g:220,b:235}},"smooth-aurora":{primaryGlow:{r:166,g:227,b:161},shimmerColor:{r:137,g:220,b:235},mistBackground:{r:186,g:194,b:222},coreColor:{r:250,g:179,b:135},accentColor:{r:203,g:166,b:247}}};this.holographicSystem=t,this.cssVisualEffectsController=e,this.musicSyncService=i,this.glowState={glowIntensity:0,effectLevel:0,softness:.8,shimmerEffect:0,transparency:.9,gradientPhase:0,musicResponse:0,smoothnessFactor:1,targetGlowIntensity:0,targetEffectLevel:0,targetShimmerEffect:0},this.glowConfig={musicThreshold:.6,maxGlowIntensity:.8,transitionDuration:2e3,particleCount:15,blurRadius:8,gradientSpeed:.3}}get etherealElements(){return this.subtleElements}get etherealPalettes(){return this.subtlePalettes}async initialize(){if(!this.initialized)try{console.log("[SoftGlowEffectsManager] Initializing subtle visual effects..."),this.subscribeToEmotionalVisualEffects(),await this.initializeGlowElements(),this.setupGlowCSSVariables(),this.startEtherealAnimation(),this.initialized=!0,console.log("[SoftGlowEffectsManager] \u2728 Ready for ambient responsive moments")}catch(t){throw console.error("[SoftGlowEffectsManager] Failed to initialize:",t),t}}updateAnimation(t){if(!this.initialized)return;let e=t/1e3;this.animationState.ambientPhase+=e*.5,this.animationState.smoothPhase+=e*.3,this.animationState.flowingPhase+=e*this.glowConfig.gradientSpeed,this.animationState.responsivePulsePhase+=e*.8,this.updateSubtleFromMusic(),this.updateSubtleStateWithLERP(e),this.updateAmbientEffects(),this.updateGlowElements(),this.updatePerformanceMetrics(t)}async healthCheck(){let t=this.initialized&&this.glowState.effectLevel>=0&&this.performanceMetrics.averageProcessingTime<8;return{system:"SoftGlowEffectsManager",healthy:t,metrics:{emotionalMomentCount:this.performanceMetrics.emotionalMomentCount,processingTime:this.performanceMetrics.averageProcessingTime,etherealElementCount:this.etherealElements.size,gentleTransitionCount:this.performanceMetrics.gentleTransitionCount},issues:t?[]:["Performance degradation detected"]}}subscribeToEmotionalVisualEffects(){p.subscribe("music:emotional-context-updated",t=>{this.onColorVisualEffectsUpdate(t)}),p.subscribe("music:emotion-analyzed",t=>{this.onEmotionalMoment(t)}),p.subscribe("settings:visual-guide-changed",t=>{this.onGentleTransition(t)})}onColorVisualEffectsUpdate(t){let{palette:e,visualEffectsLevel:i,emotionalTemperature:a}=t;this.glowState.musicResponse=i*.9,a>5e3?this.glowState.effectLevel=Math.min(.8,i*1.2):this.glowState.shimmerEffect=i*.7;let r=this.generateGlowColors(e,a);this.updateGlowColors(r)}onEmotionalMoment(t){let{type:e,intensity:i,valence:a}=t;a>this.glowConfig.musicThreshold&&this.triggerSubtleEffect(i,a)}onGentleTransition(t){let{fromState:e,toState:i,duration:a}=t;this.createGentleTransition(e,i,a),this.performanceMetrics.gentleTransitionCount++}triggerSubtleEffect(t,e){let i=performance.now();this.glowState.transparency=.8+e*.2,this.glowState.targetGlowIntensity=Math.max(this.glowState.targetGlowIntensity,t*.8),this.glowState.targetEffectLevel=Math.max(this.glowState.targetEffectLevel,e*.9),this.glowState.targetShimmerEffect=Math.max(this.glowState.targetShimmerEffect,e*.6),this.performanceMetrics.emotionalMomentCount++,this.performanceMetrics.lastUpdateTime=performance.now()-i,console.log(`[SoftGlowEffectsManager] \u2728 Ethereal beauty awakened! Intensity: ${t.toFixed(2)}, Valence: ${e.toFixed(2)}`)}updateSubtleStateWithLERP(t){this.glowState.glowIntensity=R(this.glowState.glowIntensity,this.glowState.targetGlowIntensity,t,this.lerpHalfLifeValues.glowIntensity),this.glowState.effectLevel=R(this.glowState.effectLevel,this.glowState.targetEffectLevel,t,this.lerpHalfLifeValues.effectLevel),this.glowState.shimmerEffect=R(this.glowState.shimmerEffect,this.glowState.targetShimmerEffect,t,this.lerpHalfLifeValues.shimmerEffect);let e=1.5;this.glowState.targetGlowIntensity=R(this.glowState.targetGlowIntensity,0,t,e),this.glowState.targetEffectLevel=R(this.glowState.targetEffectLevel,0,t,e*1.2),this.glowState.targetShimmerEffect=R(this.glowState.targetShimmerEffect,0,t,e*.8)}updateSubtleFromMusic(){let t=this.musicSyncService.getCurrentMusicState();if(!t)return;let{emotion:e,beat:i,intensity:a}=t;if(e&&e.valence>.5&&(this.glowState.shimmerEffect=Math.max(this.glowState.shimmerEffect,e.valence*a*.5),i&&i.tempo)){let r=Math.min(1.5,i.tempo/100);this.glowConfig.gradientSpeed=.3*r}}updateAmbientEffects(){let t=this.etherealPalettes["smooth-pastels"],e={primaryGlow:this.blendSoftColors(t.primaryGlow,t.shimmerColor,this.glowState.shimmerEffect),shimmerColor:t.shimmerColor,mistBackground:t.mistBackground,coreColor:t.coreColor,accentColor:t.accentColor,transparency:this.glowState.transparency};this.updateGlowCSSVariables(e)}blendSoftColors(t,e,i){let a=Math.max(0,Math.min(1,i));return{r:Math.round(t.r*(1-a)+e.r*a),g:Math.round(t.g*(1-a)+e.g*a),b:Math.round(t.b*(1-a)+e.b*a)}}generateGlowColors(t,e){let i=this.etherealPalettes["smooth-pastels"];return e<4e3?i=this.etherealPalettes["ambient-moonlight"]:e>7e3&&(i=this.etherealPalettes["smooth-aurora"]),{primaryGlow:i.primaryGlow,shimmerColor:i.shimmerColor,mistBackground:i.mistBackground,coreColor:i.coreColor,accentColor:i.accentColor,transparency:this.glowState.transparency}}updateGlowColors(t){this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-soft-r",t.primaryGlow.r.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-soft-g",t.primaryGlow.g.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-soft-b",t.primaryGlow.b.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-ambient-r",t.shimmerColor.r.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-ambient-g",t.shimmerColor.g.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-ambient-b",t.shimmerColor.b.toString())}async initializeGlowElements(){let t=[".main-view-container",".Root__now-playing-bar",".main-trackInfo-container",".cover-art",".player-controls"];for(let e of t){let i=document.querySelectorAll(e);for(let a of i){let r=`ethereal-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;this.etherealElements.set(r,a)}}}setupGlowCSSVariables(){let t={"--subtle-soft-r":"203","--subtle-soft-g":"166","--subtle-soft-b":"247","--subtle-ambient-r":"148","--subtle-ambient-g":"226","--subtle-ambient-b":"213","--subtle-smooth-r":"245","--subtle-smooth-g":"224","--subtle-smooth-b":"220","--subtle-effect-level":"0","--subtle-ambient-shimmer":"0","--subtle-smooth-transparency":"0.9","--subtle-flowing-phase":"0","--subtle-responsive-pulse":"0"};for(let[e,i]of Object.entries(t))this.cssVisualEffectsController.queueCSSVariableUpdate(e,i)}updateGlowCSSVariables(t){this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-effect-level",this.glowState.effectLevel.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-ambient-shimmer",this.glowState.shimmerEffect.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-smooth-transparency",t.transparency.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-flowing-phase",this.animationState.flowingPhase.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-responsive-pulse",Math.sin(this.animationState.responsivePulsePhase).toString())}updateGlowElements(){for(let[t,e]of this.etherealElements)this.updateEtherealElement(e)}updateEtherealElement(t){this.glowState.effectLevel>.1&&this.applySubtleEffect(t),this.glowState.shimmerEffect>.1&&this.applyAmbientShimmer(t),this.applyFlowingGradients(t)}applySubtleEffect(t){let e=this.glowState.effectLevel,i=Math.sin(this.animationState.responsivePulsePhase)*.5+.5,a=e*i*.6;t.style.boxShadow=`
      0 0 ${a*30}px rgba(var(--subtle-soft-r), var(--subtle-soft-g), var(--subtle-soft-b), ${a*.6}),
      inset 0 0 ${a*20}px rgba(var(--subtle-ambient-r), var(--subtle-ambient-g), var(--subtle-ambient-b), ${a*.3})
    `;let r=.9+e*.1;t.style.opacity=r.toString()}applyAmbientShimmer(t){let e=this.glowState.shimmerEffect,i=this.animationState.ambientPhase,a=Math.sin(i*2)*e*2,r=1+Math.cos(i*1.5)*e*.05;t.style.transform=`translate(${a}px, 0) scale(${r})`;let n=Math.sin(i*.8)*e*15;t.style.filter=`hue-rotate(${n}deg) saturate(${1+e*.3})`}applyFlowingGradients(t){let e=this.animationState.flowingPhase,i=this.glowState.effectLevel*.8;if(i>.1){let a=(Math.sin(e)+1)*50;t.style.background=`
        ${t.style.background||""},
        linear-gradient(
          ${a}deg,
          rgba(var(--subtle-soft-r), var(--subtle-soft-g), var(--subtle-soft-b), ${i*.1}) 0%,
          rgba(var(--subtle-ambient-r), var(--subtle-ambient-g), var(--subtle-ambient-b), ${i*.15}) 50%,
          rgba(var(--subtle-smooth-r), var(--subtle-smooth-g), var(--subtle-smooth-b), ${i*.05}) 100%
        )
      `}}createGentleTransition(t,e,i){let a=performance.now(),r=n=>{let s=n-a,o=Math.min(1,s/i),c=1-Math.pow(1-o,3);this.glowState.effectLevel=t.beauty+(e.beauty-t.beauty)*c,this.glowState.shimmerEffect=t.shimmer+(e.shimmer-t.shimmer)*c,o<1&&requestAnimationFrame(r)};requestAnimationFrame(r)}startEtherealAnimation(){this.animationState.isAnimating=!0,this.animationState.lastFrameTime=performance.now();let t=e=>{if(!this.animationState.isAnimating)return;let i=e-this.animationState.lastFrameTime;this.animationState.lastFrameTime=e,this.updateAnimation(i),requestAnimationFrame(t)};requestAnimationFrame(t)}updatePerformanceMetrics(t){this.performanceMetrics.averageProcessingTime=this.performanceMetrics.averageProcessingTime*.9+t*.1}forceRepaint(t){console.log(`[SoftGlowEffectsManager] Force repaint triggered: ${t||"Unknown"}`),this.updateGlowElements(),this.cssVisualEffectsController.flushCSSVariableBatch()}destroy(){console.log("[SoftGlowEffectsManager] Dissolving ethereal beauty..."),this.animationState.isAnimating=!1,this.etherealElements.clear(),this.glowState={glowIntensity:0,effectLevel:0,softness:.8,shimmerEffect:0,transparency:.9,gradientPhase:0,musicResponse:0,smoothnessFactor:1,targetGlowIntensity:0,targetEffectLevel:0,targetShimmerEffect:0},this.initialized=!1}getGlowState(){return{...this.glowState}}getGlowConfig(){return{...this.glowConfig}}getPerformanceMetrics(){return{...this.performanceMetrics,etherealElementCount:this.etherealElements.size}}setEmotionalThreshold(t){this.glowConfig.musicThreshold=Math.max(0,Math.min(1,t))}setMaxBeautyIntensity(t){this.glowConfig.maxGlowIntensity=Math.max(0,Math.min(1,t))}setGentleness(t){this.glowState.softness=Math.max(0,Math.min(1,t))}}});var Qi,_s=y(()=>{"use strict";k();Qi=class{constructor(t,e,i){this.initialized=!1;this.naturalElements=new Map;this.performanceMetrics={peacefulMomentCount:0,averageProcessingTime:0,lastUpdateTime:0,animationCycleCount:0};this.animationPhases={animationPhase:0,seasonalPhase:0,variationPhase:0,harmonyPhase:0,lastFrameTime:0,isAnimating:!1};this.naturalPalettes={"spring-awakening":{earthyWarm:{r:166,g:227,b:161},forestGreen:{r:64,g:160,b:43},skyBlue:{r:137,g:220,b:235},sunsetGlow:{r:250,g:179,b:135},stoneGray:{r:108,g:112,b:134}},"summer-warmth":{earthyWarm:{r:249,g:226,b:175},forestGreen:{r:166,g:227,b:161},skyBlue:{r:116,g:199,b:236},sunsetGlow:{r:250,g:179,b:135},stoneGray:{r:147,g:153,b:178}},"autumn-grounding":{earthyWarm:{r:250,g:179,b:135},forestGreen:{r:148,g:226,b:213},skyBlue:{r:137,g:180,b:250},sunsetGlow:{r:235,g:160,b:172},stoneGray:{r:127,g:132,b:156}},"winter-peace":{earthyWarm:{r:186,g:194,b:222},forestGreen:{r:148,g:226,b:213},skyBlue:{r:137,g:220,b:235},sunsetGlow:{r:203,g:166,b:247},stoneGray:{r:88,g:91,b:112}}};this.holographicSystem=t,this.cssController=e,this.musicSyncService=i,this.effectState={animationIntensity:0,animationFrequency:.4,animationDepth:.8,grounding:0,warmth:.7,ambientLevel:0,colorShift:0,harmonyLevel:0},this.harmonyConfig={calmThreshold:.3,maxBreathingDepth:.9,frequencyRange:[.2,.8],colorStrength:.6,transitionDuration:3e3,cycleSpeed:.1}}injectServices(t){this.services=t}getRequiredServices(){return[]}getOptionalServices(){return["cssVariables","events","performance"]}async initialize(){if(!this.initialized)try{console.log("[AnimationEffectsController] Initializing animation effects..."),this.subscribeToColorEvents(),await this.initializeBreathingElements(),this.setupBreathingCSSVariables(),this.startBreathingAnimation(),this.initialized=!0,console.log("[AnimationEffectsController] \u{1F33F} Breathing effects system ready")}catch(t){throw console.error("[AnimationEffectsController] Failed to initialize:",t),t}}updateAnimation(t){if(!this.initialized)return;let e=t/1e3;this.animationPhases.animationPhase+=e*this.effectState.animationFrequency*2*Math.PI,this.animationPhases.seasonalPhase+=e*this.harmonyConfig.cycleSpeed,this.animationPhases.variationPhase+=e*.4,this.animationPhases.harmonyPhase+=e*.6,this.updateNaturalFromMusic(),this.updateBreathingVisuals(),this.updateBreathingElements(),this.updatePerformanceMetrics(t)}async healthCheck(){let t=this.initialized&&this.effectState.animationIntensity>=0&&this.performanceMetrics.averageProcessingTime<10;return{system:"NaturalHarmonyEngine",healthy:t,metrics:{peacefulMomentCount:this.performanceMetrics.peacefulMomentCount,processingTime:this.performanceMetrics.averageProcessingTime,naturalElementCount:this.naturalElements.size,animationCycleCount:this.performanceMetrics.animationCycleCount},issues:t?[]:["Performance degradation detected"]}}subscribeToColorEvents(){this.services?.events?(this.services.events.subscribe("AnimationEffectsController","music:emotional-context-updated",this.onColorUpdate.bind(this)),this.services.events.subscribe("AnimationEffectsController","music:emotion-analyzed",this.onPeacefulMoment.bind(this)),this.services.events.subscribe("AnimationEffectsController","settings:visual-guide-changed",this.onVisualTransition.bind(this))):(p.subscribe("music:emotional-context-updated",t=>{this.onColorUpdate(t)}),p.subscribe("music:emotion-analyzed",t=>{this.onPeacefulMoment(t)}),p.subscribe("settings:visual-guide-changed",t=>{this.onVisualTransition(t)}))}onColorUpdate(t){let{palette:e,effectsLevel:i,emotionalTemperature:a}=t;this.effectState.harmonyLevel=i*.8,a<5e3?(this.effectState.grounding=i*.6,this.effectState.ambientLevel=i*.4):(this.effectState.warmth=i*.8,this.effectState.colorShift=i*.5);let r=this.generateBreathingColors(e,a);this.updateNaturalColors(r)}onPeacefulMoment(t){let{type:e,intensity:i,serenity:a}=t;this.triggerNaturalBreathing(i,a)}onVisualTransition(t){let{fromSeason:e,toSeason:i,duration:a}=t;this.createSeasonalTransition(e,i,a),this.performanceMetrics.animationCycleCount++}triggerNaturalBreathing(t,e){(this.services?.performance?(a,r)=>this.services.performance.trackOperation("AnimationEffectsController",a,r):(a,r)=>r())("triggerNaturalBreathing",()=>{this.effectState.animationIntensity=e,this.effectState.grounding=e*.7,this.effectState.ambientLevel=e*.6,this.effectState.warmth=.6+e*.3;let a=this.harmonyConfig.frequencyRange;this.effectState.animationFrequency=a[0]+e*(a[1]-a[0]),setTimeout(()=>{this.gentleDecayNaturalBreathing()},this.harmonyConfig.transitionDuration),this.performanceMetrics.peacefulMomentCount++,console.log(`[AnimationEffectsController] \u{1F33F} Breathing effects activated! Serenity: ${e.toFixed(2)}, Frequency: ${this.effectState.animationFrequency.toFixed(2)}Hz`)})}gentleDecayNaturalBreathing(){let e=()=>{this.effectState.animationIntensity*=.985,this.effectState.grounding*=.988,this.effectState.ambientLevel*=.991,this.effectState.animationIntensity>.05?requestAnimationFrame(e):(this.effectState.animationIntensity=0,this.effectState.grounding=0,this.effectState.ambientLevel=0)};requestAnimationFrame(e)}updateNaturalFromMusic(){let t=this.musicSyncService.getCurrentMusicState();if(!t)return;let{emotion:e,beat:i,intensity:a}=t;if(e&&a<this.harmonyConfig.calmThreshold&&(this.effectState.ambientLevel=Math.max(this.effectState.ambientLevel,(1-a)*.6),i&&i.tempo)){let r=Math.max(.5,Math.min(1.2,60/i.tempo));this.effectState.animationFrequency=.4*r}}updateBreathingVisuals(){let t=this.getCurrentSeason(),e=this.naturalPalettes[t],i={warmTone:this.blendBreathingColors(e.earthyWarm,e.sunsetGlow,this.effectState.warmth),coolTone:e.forestGreen,accentBlue:e.skyBlue,highlightGlow:e.sunsetGlow,neutralGray:e.stoneGray,transparency:.85+this.effectState.animationIntensity*.15};this.updateNaturalCSSVariables(i)}getCurrentSeason(){let e=this.animationPhases.seasonalPhase%(2*Math.PI)/(2*Math.PI);return e<.25?"spring-awakening":e<.5?"summer-warmth":e<.75?"autumn-grounding":"winter-peace"}blendBreathingColors(t,e,i){let a=Math.max(0,Math.min(1,i));return{r:Math.round(t.r*(1-a)+e.r*a),g:Math.round(t.g*(1-a)+e.g*a),b:Math.round(t.b*(1-a)+e.b*a)}}generateBreathingColors(t,e){let i=this.naturalPalettes["spring-awakening"];return e<4e3?i=this.naturalPalettes["winter-peace"]:e>7e3?i=this.naturalPalettes["summer-warmth"]:e>5500&&(i=this.naturalPalettes["autumn-grounding"]),{warmTone:i.earthyWarm,coolTone:i.forestGreen,accentBlue:i.skyBlue,highlightGlow:i.sunsetGlow,neutralGray:i.stoneGray,transparency:this.effectState.harmonyLevel}}updateNaturalColors(t){this.services?.cssVariables?this.services.cssVariables.queueBatchUpdate({"--sn-animation-warm-r":t.warmTone.r.toString(),"--sn-animation-warm-g":t.warmTone.g.toString(),"--sn-animation-warm-b":t.warmTone.b.toString(),"--sn-animation-cool-r":t.coolTone.r.toString(),"--sn-animation-cool-g":t.coolTone.g.toString(),"--sn-animation-cool-b":t.coolTone.b.toString()}):(this.cssController.queueCSSVariableUpdate("--sn-animation-warm-r",t.warmTone.r.toString()),this.cssController.queueCSSVariableUpdate("--sn-animation-warm-g",t.warmTone.g.toString()),this.cssController.queueCSSVariableUpdate("--sn-animation-warm-b",t.warmTone.b.toString()),this.cssController.queueCSSVariableUpdate("--sn-animation-cool-r",t.coolTone.r.toString()),this.cssController.queueCSSVariableUpdate("--sn-animation-cool-g",t.coolTone.g.toString()),this.cssController.queueCSSVariableUpdate("--sn-animation-cool-b",t.coolTone.b.toString()))}async initializeBreathingElements(){let t=[".main-view-container",".Root__now-playing-bar",".main-trackInfo-container",".progress-bar",".Root__nav-bar"];for(let e of t){let i=document.querySelectorAll(e);for(let a of i){let r=`natural-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;this.naturalElements.set(r,a)}}}setupBreathingCSSVariables(){let t={"--sn-animation-earthy-r":"166","--sn-animation-earthy-g":"227","--sn-animation-earthy-b":"161","--sn-animation-forest-r":"64","--sn-animation-forest-g":"160","--sn-animation-forest-b":"43","--sn-animation-sky-r":"137","--sn-animation-sky-g":"220","--sn-animation-sky-b":"235","--sn-animation-serenity-level":"0","--sn-animation-animation-frequency":"0.4","--sn-animation-earth-connection":"0","--sn-animation-animation-depth":"0.8","--sn-animation-seasonal-shift":"0"};if(this.services?.cssVariables)this.services.cssVariables.queueBatchUpdate(t);else for(let[e,i]of Object.entries(t))this.cssController.queueCSSVariableUpdate(e,i)}updateNaturalCSSVariables(t){let e=Math.sin(this.animationPhases.animationPhase)*this.effectState.animationDepth,i={"--sn-animation-animation-intensity":this.effectState.animationIntensity.toString(),"--sn-animation-animation-frequency":this.effectState.animationFrequency.toString(),"--sn-animation-grounding":this.effectState.grounding.toString(),"--sn-animation-animation-depth":this.effectState.animationDepth.toString(),"--sn-animation-color-shift":this.effectState.colorShift.toString(),"--sn-animation-animation-phase":e.toString()};this.services?.cssVariables?this.services.cssVariables.queueBatchUpdate(i):Object.entries(i).forEach(([a,r])=>{this.cssController.queueCSSVariableUpdate(a,r)})}updateBreathingElements(){for(let[t,e]of this.naturalElements)this.updateNaturalElement(e)}updateNaturalElement(t){this.effectState.animationIntensity>.1&&this.applyNaturalBreathing(t),this.effectState.grounding>.1&&this.applyEarthConnection(t),this.effectState.ambientLevel>.1&&this.applyForestAtmosphere(t)}applyNaturalBreathing(t){let e=this.effectState.animationIntensity,i=Math.sin(this.animationPhases.animationPhase),a=1+i*e*.02,r=.9+i*e*.1;t.style.transform=`scale(${a})`,t.style.opacity=r.toString();let n=e*(i*.5+.5)*.3;t.style.boxShadow=`
      0 0 ${n*20}px rgba(var(--sn-animation-earthy-r), var(--sn-animation-earthy-g), var(--sn-animation-earthy-b), ${n*.5}),
      inset 0 0 ${n*10}px rgba(var(--sn-animation-forest-r), var(--sn-animation-forest-g), var(--sn-animation-forest-b), ${n*.3})
    `}applyEarthConnection(t){let e=this.effectState.grounding;t.style.border=`1px solid rgba(var(--sn-animation-earthy-r), var(--sn-animation-earthy-g), var(--sn-animation-earthy-b), ${e*.4})`,t.style.background=`
      ${t.style.background||""},
      linear-gradient(180deg,
        rgba(var(--sn-animation-earthy-r), var(--sn-animation-earthy-g), var(--sn-animation-earthy-b), ${e*.05}) 0%,
        rgba(var(--sn-animation-forest-r), var(--sn-animation-forest-g), var(--sn-animation-forest-b), ${e*.08}) 100%
      )
    `}applyForestAtmosphere(t){let e=this.effectState.ambientLevel,i=this.animationPhases.variationPhase,a=Math.sin(i*.8)*e*1;t.style.transform+=` translateY(${a}px)`;let r=Math.sin(i*.5)*e*5;t.style.filter=`hue-rotate(${r}deg) saturate(${1+e*.2})`}createSeasonalTransition(t,e,i){let a=performance.now(),r=n=>{let s=n-a,o=Math.min(1,s/i),c=.5*(1-Math.cos(o*Math.PI));this.effectState.colorShift=c,o<1&&requestAnimationFrame(r)};requestAnimationFrame(r)}startBreathingAnimation(){this.animationPhases.isAnimating=!0,this.animationPhases.lastFrameTime=performance.now();let t=e=>{if(!this.animationPhases.isAnimating)return;let i=e-this.animationPhases.lastFrameTime;this.animationPhases.lastFrameTime=e,this.updateAnimation(i),requestAnimationFrame(t)};requestAnimationFrame(t)}updatePerformanceMetrics(t){this.performanceMetrics.averageProcessingTime=this.performanceMetrics.averageProcessingTime*.9+t*.1}forceRepaint(t){console.log(`[AnimationEffectsController] Force repaint triggered: ${t||"Unknown"}`),this.updateBreathingElements(),this.services?.cssVariables?this.services.cssVariables.flushUpdates():this.cssController.flushCSSVariableBatch()}destroy(){console.log("[AnimationEffectsController] Shutting down animation effects system..."),this.services?.events&&this.services.events.cleanupSystem("AnimationEffectsController"),this.animationPhases.isAnimating=!1,this.naturalElements.clear(),this.effectState={animationIntensity:0,animationFrequency:.4,animationDepth:.8,grounding:0,warmth:.7,ambientLevel:0,colorShift:0,harmonyLevel:0},this.initialized=!1}getBreathingState(){return{...this.effectState}}getAnimationConfig(){return{...this.harmonyConfig}}getPerformanceMetrics(){return{...this.performanceMetrics,naturalElementCount:this.naturalElements.size}}setCalmThreshold(t){this.harmonyConfig.calmThreshold=Math.max(0,Math.min(1,t))}setBreathingDepth(t){this.effectState.animationDepth=Math.max(0,Math.min(1,t))}setColorStrength(t){this.harmonyConfig.colorStrength=Math.max(0,Math.min(1,t))}}});var Ht,Hs=y(()=>{"use strict";oe();A();Ds();xi();ar();rr();Di();Ls();ks();Rs();Vs();Bs();Fs();Gs();_s();Ht=class{constructor(t,e,i,a,r,n,s,o,c,m){this.systemName="VisualSystemCoordinator";this.initialized=!1;this.colorHarmonyEngine=null;this.eventBus=null;this.animationCoordinator=null;this.isInitialized=!1;this.lastHealthCheck=null;this.boundAdaptationHandler=null;this.boundSettingsHandler=null;this.healthCheckInterval=null;this.metricsUpdateInterval=null;this.fpsHistory=[];this.onSystemAdaptation=null;this.onHealthChange=null;this.onSystemCreated=null;this.config=t,this.utils=e,this.year3000System=i,this.cssVariableController=a,this.performanceAnalyzer=r,this.musicSyncService=n,this.settingsManager=s,this.colorHarmonyEngine=o||null,this.eventBus=c||null,this.animationCoordinator=m||null,this.deviceDetector=new O,this.systemRegistry=new Map,this.systemCache=new Map,this.systemDependencies=new Map,this.bridgeConfig={mode:"progressive",enablePerformanceMonitoring:!0,enableAdaptiveQuality:!0,enableEventCoordination:!0,performanceThresholds:{minFPS:45,maxMemoryMB:50,thermalLimit:70},qualityPreferences:{preferHighQuality:!0,allowDynamicScaling:!0,batteryConservation:!1}},this.currentMetrics=this.createInitialMetrics(),this.boundAdaptationHandler=this.handleAdaptationEvent.bind(this),this.boundSettingsHandler=this.handleSettingsChange.bind(this),this.registerVisualSystems(),u?.debug?.log("VisualSystemFacade","Factory facade initialized with visual systems")}registerVisualSystems(){this.systemRegistry.set("SidebarVisualEffects",$e),this.systemDependencies.set("SidebarVisualEffects",["eventBus","musicSyncService"]),this.systemRegistry.set("UIVisualEffects",bt),this.systemDependencies.set("UIVisualEffects",["eventBus","musicSyncService","cssVariableController"]),this.systemRegistry.set("HeaderVisualEffects",St),this.systemDependencies.set("HeaderVisualEffects",["eventBus","musicSyncService","colorHarmonyEngine"]),this.systemRegistry.set("WebGLBackground",xe),this.systemDependencies.set("WebGLBackground",["performanceAnalyzer","eventBus"]),this.systemRegistry.set("MusicBeatSync",Wi),this.systemDependencies.set("MusicBeatSync",["performanceAnalyzer","cssVariableController","eventBus","musicSyncService","colorHarmonyEngine"]),this.systemRegistry.set("InteractionTracking",Yi),this.systemDependencies.set("InteractionTracking",["performanceAnalyzer","cssVariableController"]),this.systemRegistry.set("SpotifyUIApplication",ji),this.systemDependencies.set("SpotifyUIApplication",["year3000System"]),this.systemRegistry.set("CinematicDrama",Ki),this.systemDependencies.set("CinematicDrama",["performanceAnalyzer","cssVariableController","musicSyncService","colorHarmonyEngine","eventBus"]),this.systemRegistry.set("EtherealBeauty",_t),this.systemDependencies.set("EtherealBeauty",["performanceAnalyzer","cssVariableController","musicSyncService","colorHarmonyEngine","eventBus"]),this.systemRegistry.set("NaturalHarmony",Qi),this.systemDependencies.set("NaturalHarmony",["performanceAnalyzer","cssVariableController","musicSyncService","colorHarmonyEngine","eventBus"]),this.systemRegistry.set("GradientConductor",Gt),this.systemDependencies.set("GradientConductor",["cssVariableController","colorHarmonyEngine","musicSyncService","performanceAnalyzer","eventBus"]),this.systemRegistry.set("GlowEffects",_t),this.systemDependencies.set("GlowEffects",["performanceAnalyzer","cssVariableController","musicSyncService","colorHarmonyEngine","eventBus"]),this.systemRegistry.set("UnifiedParticle",$e),this.systemDependencies.set("UnifiedParticle",["eventBus","musicSyncService"]),this.systemRegistry.set("DepthLayeredGradient",Gt),this.systemDependencies.set("DepthLayeredGradient",["cssVariableController","colorHarmonyEngine","musicSyncService","performanceAnalyzer","eventBus"]),this.systemRegistry.set("FluidGradientBackground",xe),this.systemDependencies.set("FluidGradientBackground",["performanceAnalyzer","eventBus"])}async initialize(t){if(this.isInitialized){u?.debug?.warn("VisualSystemFacade","Already initialized");return}try{this.bridgeConfig={...this.bridgeConfig,...t},await this.deviceDetector.initialize(),await this.applyConfiguration(),this.subscribeToEvents(),this.startMonitoring(),await this.performVisualHealthCheck(),this.isInitialized=!0,this.initialized=!0,this.cssVariableController.queueCSSVariableUpdate("--sn-visual-bridge-active","1"),this.cssVariableController.queueCSSVariableUpdate("--sn-visual-bridge-mode",this.bridgeConfig.mode),u?.debug?.log("VisualSystemFacade","Facade fully initialized",{mode:this.bridgeConfig.mode,systemsRegistered:this.systemRegistry.size,performanceMonitoring:this.bridgeConfig.enablePerformanceMonitoring})}catch(e){throw u?.debug?.error("VisualSystemFacade","Initialization failed:",e),await this.cleanup(),e}}getVisualSystem(t){if(this.systemCache.has(t))return this.systemCache.get(t);let e=this.createVisualSystem(t);return this.systemCache.set(t,e),this.currentMetrics.activeVisualSystems.push(t),this.onSystemCreated&&this.onSystemCreated(t,e),e}createVisualSystem(t){let e=this.systemRegistry.get(t);if(!e)throw new Error(`Visual system '${t}' not found in registry`);let i=new e(this.config);if(typeof i._baseInitialize=="function"){let r=i;return this.injectUnifiedSystemDependencies(r,t),r}if(t==="SpotifyUIApplication"){let r=new e(this.year3000System);return this.injectDependencies(r,t),r}if(t==="GradientConductor"){let r=new e(this.eventBus,this.cssVariableController,this.colorHarmonyEngine,this.musicSyncService,this.performanceAnalyzer,{});return this.injectDependencies(r,t),r}if(t==="CinematicDrama"||t==="EtherealBeauty"||t==="NaturalHarmony"){let r=new $i,n=new qi(r,this.settingsManager,this.musicSyncService),s=new e(n,this.cssVariableController,this.musicSyncService);return this.injectDependencies(s,t),s}let a=new e(this.config,this.utils,this.performanceAnalyzer,this.musicSyncService,this.settingsManager,this.year3000System);return this.injectDependencies(a,t),a}injectDependencies(t,e){let i=this.systemDependencies.get(e)||[];i.includes("performanceAnalyzer")&&t.setPerformanceAnalyzer&&t.setPerformanceAnalyzer(this.performanceAnalyzer),i.includes("cssVariableController")&&t.setOptimizedCSSVariableManager&&t.setOptimizedCSSVariableManager(this.cssVariableController),i.includes("eventBus")&&this.eventBus&&t.setEventBus&&t.setEventBus(this.eventBus),this.colorHarmonyEngine&&t.setColorHarmonyEngine&&t.setColorHarmonyEngine(this.colorHarmonyEngine),i.includes("musicSyncService")&&t.setMusicSyncService&&t.setMusicSyncService(this.musicSyncService),i.includes("animationCoordinator")&&this.animationCoordinator&&t.setAnimationCoordinator&&t.setAnimationCoordinator(this.animationCoordinator),this.integratePerformanceMonitoring(t,e)}injectUnifiedSystemDependencies(t,e){this.cssVariableController&&(t.cssVariableController=this.cssVariableController),this.performanceAnalyzer&&(t.performanceAnalyzer=this.performanceAnalyzer),this.year3000System&&(globalThis.year3000System=this.year3000System),this.integratePerformanceMonitoring(t,e)}integratePerformanceMonitoring(t,e){if(!this.bridgeConfig.enablePerformanceMonitoring)return;let i=t.updateAnimation;typeof i=="function"&&(t.updateAnimation=r=>{let n=performance.now();i.call(t,r);let s=performance.now();this.performanceAnalyzer.recordMetric(`Visual_${e}`,s-n)});let a=t.onAnimate;typeof a=="function"&&(t.onAnimate=r=>{let n=performance.now();a.call(t,r);let s=performance.now();this.performanceAnalyzer.recordMetric(`Visual_${e}_Animate`,s-n)})}adaptiveQualityControl(t,e){this.eventBus&&(this.eventBus.subscribe("performance:degradation",i=>{t.reduceQuality&&t.reduceQuality(i.reductionLevel)}),this.eventBus.subscribe("performance:improvement",i=>{t.increaseQuality&&t.increaseQuality(i.improvementLevel)}))}handleAdaptationEvent(t){u?.debug?.log("VisualSystemFacade",`Adaptation event: ${t.type}`,t.reason),this.currentMetrics.currentQuality=t.newSettings,this.systemCache.forEach((e,i)=>{e.handleAdaptationEvent&&e.handleAdaptationEvent(t)}),this.onSystemAdaptation&&this.onSystemAdaptation(this.currentMetrics),this.cssVariableController.queueCSSVariableUpdate("--sn-adaptive-quality",(t.newSettings.gradientComplexity||0).toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-adaptive-fps",(t.newSettings.animationFPS||60).toString())}propagateVisualEvent(t){this.bridgeConfig.enableEventCoordination&&(this.systemCache.forEach((e,i)=>{if(e.handleVisualEvent)try{e.handleVisualEvent(t)}catch(a){u?.debug?.warn("VisualSystemFacade",`Error propagating event to ${i}:`,a)}}),this.currentMetrics.eventCount++,this.currentMetrics.lastEventTime=performance.now())}async initializeVisualSystems(){let t=Array.from(this.systemCache.entries()).map(async([a,r])=>{try{return typeof r._baseInitialize=="function"?await r._baseInitialize():await r.initialize(),u?.debug?.log("VisualSystemFacade",`Initialized visual system: ${a}`),{key:a,success:!0}}catch(n){return u?.debug?.error("VisualSystemFacade",`Failed to initialize ${a}:`,n),{key:a,success:!1,error:n}}}),e=await Promise.allSettled(t),i=e.filter(a=>a.status==="fulfilled"&&a.value.success).length;u?.debug?.log("VisualSystemFacade",`Visual systems initialized: ${i}/${e.length}`),await this.registerQualityScalingSystems()}async registerQualityScalingSystems(){try{let t=this.year3000System?.getCachedNonVisualSystem?.("SimplePerformanceCoordinator"),e=this.year3000System?.getCachedNonVisualSystem?.("QualityScalingManager");if(!t){u?.debug?.warn("VisualSystemFacade","SimplePerformanceCoordinator not available for quality scaling registration");return}if(!e){u?.debug?.warn("VisualSystemFacade","QualityScalingManager not available for quality scaling registration");return}for(let[i,a]of this.systemCache.entries())try{let r=a;typeof r.setQualityLevel=="function"&&typeof r.getPerformanceImpact=="function"&&typeof r.getQualityCapabilities=="function"&&(t.registerSystem(i,r),e.registerSystem(i,r),u?.debug?.log("VisualSystemFacade",`Registered ${i} for quality scaling and performance coordination`))}catch(r){u?.debug?.error("VisualSystemFacade",`Failed to register ${i} for quality scaling:`,r)}await this.initializeConsciousnessAwareAdaptation(e)}catch(t){u?.debug?.error("VisualSystemFacade","Failed to register quality scaling systems:",t)}}async initializeConsciousnessAwareAdaptation(t){try{let e=this.year3000System?.getCachedNonVisualSystem?.("MusicSyncService");if(!e){u?.debug?.warn("VisualSystemFacade","MusicSyncService not available for music-aware adaptation");return}let i=setInterval(()=>{try{let a=e.getOverallIntensity?.()||.5,r=e.getBeatStrength?.()||.5;t.adaptToMusicIntensity(a,r)}catch(a){u?.debug?.error("VisualSystemFacade","Error in music-aware adaptation:",a)}},2e3);this._musicAdaptationInterval=i,u?.debug?.log("VisualSystemFacade","Consciousness-aware quality adaptation initialized")}catch(e){u?.debug?.error("VisualSystemFacade","Failed to initialize music-aware adaptation:",e)}}async performVisualHealthCheck(){let t={overall:"good",systems:new Map,recommendations:[],timestamp:performance.now()},e=0,i=0;for(let[r,n]of this.systemCache){i++;try{let s=n.healthCheck?await n.healthCheck():{status:"unknown",message:"No health check available"},o=s.status==="healthy"||s.status==="good";o&&e++,t.systems.set(r,{ok:o,details:s.message||s.details||"System operational"})}catch(s){t.systems.set(r,{ok:!1,details:`Health check failed: ${s}`})}}let a=i>0?e/i:1;return a>=.9?t.overall="excellent":a>=.7?t.overall="good":a>=.5?(t.overall="degraded",t.recommendations.push("Some visual systems are experiencing issues")):(t.overall="critical",t.recommendations.push("Multiple visual system failures detected")),this.currentMetrics.currentFPS<30&&t.recommendations.push("Low FPS detected - consider reducing visual quality"),this.currentMetrics.memoryUsageMB>40&&t.recommendations.push("High memory usage - consider optimizing visual systems"),this.lastHealthCheck=t,this.cssVariableController.queueCSSVariableUpdate("--sn-visual-health",t.overall),t}async applyConfiguration(){}subscribeToEvents(){this.settingsManager&&this.boundSettingsHandler&&document.addEventListener("year3000SystemSettingsChanged",this.boundSettingsHandler)}startMonitoring(){this.bridgeConfig.enablePerformanceMonitoring&&(this.healthCheckInterval=window.setInterval(async()=>{await this.performVisualHealthCheck()},1e4),this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},1e3))}createInitialMetrics(){return{currentFPS:60,averageFPS:60,frameTime:16.67,memoryUsageMB:0,systemHealth:"excellent",activeVisualSystems:[],currentQuality:{level:"medium",gradientComplexity:.7,particleDensity:100,animationFPS:60,postProcessing:!0,bloomEnabled:!0,antiAliasing:"fxaa",shadowQuality:"medium",shaderPrecision:"medium"},adaptiveScaling:!0,performanceMonitoring:!0,eventCoordination:!0,lastEventTime:0,eventCount:0}}updateMetrics(){let t=performance.now(),e=this.performanceAnalyzer.getMedianFPS()||0;this.currentMetrics.currentFPS=e,this.fpsHistory||(this.fpsHistory=[]),this.fpsHistory.push(e),this.fpsHistory.length>10&&this.fpsHistory.shift(),this.currentMetrics.averageFPS=this.fpsHistory.reduce((r,n)=>r+n,0)/this.fpsHistory.length,this.currentMetrics.frameTime=this.currentMetrics.currentFPS>0?1e3/this.currentMetrics.currentFPS:1e3;let i=performance.memory;i&&(this.currentMetrics.memoryUsageMB=i.usedJSHeapSize/(1024*1024)),this.currentMetrics.activeVisualSystems=Array.from(this.systemCache.keys()).filter(r=>{let n=this.systemCache.get(r);return n&&n.initialized}),this.currentMetrics.systemHealth=this.calculateSystemHealth(),this.bridgeConfig.enableAdaptiveQuality&&this.checkAdaptiveQualityTriggers();let a=performance.now()-t;a>5&&u?.debug?.warn("VisualSystemCoordinator",`Metrics update took ${a.toFixed(2)}ms - performance concern`),this.onSystemAdaptation&&this.onSystemAdaptation(this.currentMetrics)}calculateSystemHealth(){let{currentFPS:t,averageFPS:e,memoryUsageMB:i}=this.currentMetrics,a=100;return t<20?a-=40:t<30?a-=25:t<45&&(a-=10),Math.abs(t-e)>10&&(a-=15),i>this.bridgeConfig.performanceThresholds.maxMemoryMB?a-=20:i>this.bridgeConfig.performanceThresholds.maxMemoryMB*.8&&(a-=10),this.currentMetrics.activeVisualSystems.length>8&&(a-=10),a>=90?"excellent":a>=70?"good":a>=50?"degraded":"critical"}checkAdaptiveQualityTriggers(){let{systemHealth:t,currentFPS:e,memoryUsageMB:i}=this.currentMetrics;t==="critical"||e<this.bridgeConfig.performanceThresholds.minFPS?this.triggerQualityReduction():t==="excellent"&&e>58&&i<this.bridgeConfig.performanceThresholds.maxMemoryMB*.5&&this.triggerQualityImprovement()}triggerQualityReduction(){if(this.currentMetrics.currentQuality.level==="minimal")return;let t=this.currentMetrics.currentQuality.level==="high"?"medium":"minimal";this.updateQualitySettings(t),u?.debug?.log("VisualSystemCoordinator",`Adaptive quality reduced to ${t} due to performance constraints`)}triggerQualityImprovement(){if(this.currentMetrics.currentQuality.level==="high")return;let t=this.currentMetrics.currentQuality.level==="minimal"?"medium":"high";this.updateQualitySettings(t),u?.debug?.log("VisualSystemCoordinator",`Adaptive quality improved to ${t} due to excellent performance`)}updateQualitySettings(t){let e={minimal:{gradientComplexity:.3,particleDensity:25,animationFPS:30,postProcessing:!1,bloomEnabled:!1,antiAliasing:"none",shadowQuality:"off"},low:{gradientComplexity:.4,particleDensity:40,animationFPS:45,postProcessing:!1,bloomEnabled:!1,antiAliasing:"fxaa",shadowQuality:"medium"},medium:{gradientComplexity:.6,particleDensity:60,animationFPS:60,postProcessing:!0,bloomEnabled:!0,antiAliasing:"fxaa",shadowQuality:"medium"},high:{gradientComplexity:1,particleDensity:100,animationFPS:60,postProcessing:!0,bloomEnabled:!0,antiAliasing:"msaa4x",shadowQuality:"high"},ultra:{gradientComplexity:1.2,particleDensity:150,animationFPS:60,postProcessing:!0,bloomEnabled:!0,antiAliasing:"msaa4x",shadowQuality:"high"}};t&&e[t]&&(this.currentMetrics.currentQuality={level:t,...e[t]});for(let[i,a]of this.systemCache.entries())if(a&&a.initialized&&typeof a.updateQuality=="function")try{a.updateQuality(this.currentMetrics.currentQuality)}catch(r){u?.debug?.error("VisualSystemCoordinator",`Failed to update quality for ${i}:`,r)}}handleSettingsChange(t){let e=t,{key:i,value:a}=e.detail;i.startsWith("sn-visual-")&&this.updateConfigurationFromSettings(i,a)}updateConfigurationFromSettings(t,e){switch(t){case"sn-visual-quality":this.bridgeConfig.qualityPreferences.preferHighQuality=e==="high";break;case"sn-visual-performance":this.bridgeConfig.enableAdaptiveQuality=e==="adaptive";break}}async cleanup(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this._musicAdaptationInterval&&(clearInterval(this._musicAdaptationInterval),this._musicAdaptationInterval=null),this.boundSettingsHandler&&document.removeEventListener("year3000SystemSettingsChanged",this.boundSettingsHandler),this.cssVariableController.queueCSSVariableUpdate("--sn-visual-bridge-active","0")}getMetrics(){return{...this.currentMetrics}}getLastHealthCheck(){return this.lastHealthCheck}getConfiguration(){return{...this.bridgeConfig}}async setConfiguration(t){this.bridgeConfig={...this.bridgeConfig,...t},await this.applyConfiguration()}setOnSystemAdaptation(t){this.onSystemAdaptation=t}setOnHealthChange(t){this.onHealthChange=t}setOnSystemCreated(t){this.onSystemCreated=t}getSystemStatus(){return{initialized:this.isInitialized,systemsActive:this.systemCache.size,healthy:this.currentMetrics.systemHealth==="excellent"||this.currentMetrics.systemHealth==="good"}}updateAnimation(t){this.initialized&&this.systemCache.forEach((e,i)=>{try{typeof e.updateAnimation=="function"?e.updateAnimation(t):typeof e.onAnimate=="function"&&e.onAnimate(t)}catch(a){u?.debug?.error("VisualSystemCoordinator",`Error updating ${i}:`,a)}})}async healthCheck(){try{let t=await this.performVisualHealthCheck(),e;switch(t.overall){case"excellent":case"good":e="healthy";break;case"degraded":e="degraded";break;case"critical":e="critical";break;default:e="healthy"}return{healthy:e==="healthy",ok:e!=="critical",details:`Visual system coordinator health: ${t.overall} (${t.systems.size} systems)`,system:"VisualSystemCoordinator",issues:t.recommendations,metrics:{overall:t.overall,systemCount:t.systems.size,recommendations:t.recommendations,currentMetrics:this.currentMetrics,status:e}}}catch(t){return{healthy:!1,ok:!1,details:`Health check failed: ${t}`,system:"VisualSystemCoordinator",issues:["Health check exception"],metrics:{error:String(t)}}}}forceRepaint(t){u?.debug?.log("VisualSystemCoordinator",`Force repaint requested${t?`: ${t}`:""}`),this.systemCache.forEach((e,i)=>{try{typeof e.forceRepaint=="function"?e.forceRepaint(t):typeof e.refresh=="function"&&e.refresh()}catch(a){u?.debug?.warn("VisualSystemCoordinator",`Error force repainting ${i}:`,a)}}),this.cssVariableController&&"flushPendingUpdates"in this.cssVariableController&&this.cssVariableController.flushPendingUpdates()}async destroy(){await this.cleanup(),this.isInitialized=!1,this.initialized=!1,this.systemCache.clear(),u?.debug?.log("VisualSystemCoordinator","Facade destroyed")}}});var zt,zs=y(()=>{"use strict";Ya();fi();U();Is();Qa();Si();Xa();oe();wi();A();st();Ua();Hs();zt=class{constructor(t,e,i){this.visualBridge=null;this.nonVisualFacade=null;this.sharedUnifiedCSSVariableManager=null;this.sharedSimplePerformanceCoordinator=null;this.sharedWebGLSystemsIntegration=null;this.sharedEnhancedDeviceTierDetector=null;this.sharedDeviceCapabilityDetector=null;this.sharedPerformanceBudgetManager=null;this.sharedMusicSyncService=null;this.sharedSettingsManager=null;this.sharedColorHarmonyEngine=null;this.sharedSemanticColorManager=null;this.isInitialized=!1;this.lastHealthCheck=null;this.colorDependentSystems=new Set;this.colorSystemRefreshCallbacks=new Map;this.currentPhase="core";this.systemStates=new Map;this.phaseCompletionPromises=new Map;this.systemDependencies=new Map;this.initializationOrder=new Map;this.eventBus=null;this.crossFacadeEventListeners=new Map;this.healthCheckInterval=null;this.metricsUpdateInterval=null;this.onSystemCreated=null;this.onHealthChange=null;this.onPerformanceChange=null;this.config=t,this.utils=e,this.year3000System=i,this.coordinationConfig={mode:"unified",enableSharedDependencies:!0,enableCrossFacadeCommunication:!0,enableUnifiedPerformanceMonitoring:!0,enableResourceOptimization:!0,coordination:{enforceSequentialInitialization:!0,dependencyValidation:!0,enableInitializationGates:!0,systemReadinessTimeout:5e3,phaseTransitionTimeout:1e4},performanceThresholds:{maxTotalMemoryMB:150,maxTotalInitTime:8e3,maxCrossCommLatency:10},coordinationPreferences:{preferSharedResources:!0,enableEventPropagation:!0,enableHealthCoordination:!0}},this.setupCoordinationPhases(),this.currentMetrics=this.createInitialMetrics(),u?.debug?.log("SystemCoordinator","System coordinator initialized")}async initialize(t){if(this.isInitialized){u?.debug?.warn("SystemCoordinator","Already initialized");return}try{let e=performance.now();this.coordinationConfig={...this.coordinationConfig,...t},this.coordinationConfig.coordination.enforceSequentialInitialization?(u?.debug?.log("SystemCoordinator","Starting coordinated initialization"),await this.executeCoordinatedInitialization()):(u?.debug?.log("SystemCoordinator","Starting legacy initialization"),await this.executeLegacyInitialization());let i=performance.now();this.currentMetrics.totalInitTime=i-e,this.isInitialized=!0,u?.debug?.log("SystemCoordinator","System coordination fully initialized",{mode:this.coordinationConfig.mode,coordinationEnabled:this.coordinationConfig.coordination.enforceSequentialInitialization,currentPhase:this.currentPhase,visualSystems:this.currentMetrics.visualSystems,nonVisualSystems:this.currentMetrics.nonVisualSystems,initTime:this.currentMetrics.totalInitTime})}catch(e){throw u?.debug?.error("SystemCoordinator","Initialization failed:",e),await this.cleanup(),e}}async initializeSharedDependencies(){if(this.coordinationConfig.enableSharedDependencies){u?.debug?.log("SystemCoordinator","Initializing simplified shared dependencies");try{this.sharedDeviceCapabilityDetector=new O({enableDebug:!0,spicetifyContext:!0}),await this.sharedDeviceCapabilityDetector.initialize(),this.sharedEnhancedDeviceTierDetector=new de,this.sharedWebGLSystemsIntegration=new nt(this.sharedDeviceCapabilityDetector),await this.sharedWebGLSystemsIntegration.initialize(),this.sharedDeviceCapabilityDetector=new O({enableDebug:this.config.enableDebug||!1,runStressTests:!1}),await this.sharedDeviceCapabilityDetector.initialize(),this.sharedPerformanceBudgetManager=new Pe({budgets:{animationFrame:16,cssVariableUpdate:2,domObservation:1,audioAnalysis:5,visualEffects:8,userInteraction:100},autoOptimize:{enabled:!0,violationThreshold:3,recoveryThreshold:.8},enableDebug:this.config.enableDebug||!1},this.sharedSimplePerformanceCoordinator),this.sharedSimplePerformanceCoordinator=new Ue(this.sharedEnhancedDeviceTierDetector,this.sharedWebGLSystemsIntegration),await this.sharedSimplePerformanceCoordinator.initialize();try{let t=this.sharedSimplePerformanceCoordinator;this.sharedUnifiedCSSVariableManager=new me(this.config,t,{enableAdaptiveThrottling:!0,batchIntervalMs:16,maxBatchSize:50,priorityMappings:{critical:["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift","--sn-enhanced-base-hex","--sn-enhanced-accent-hex"],high:["--sn-gradient-primary","--sn-gradient-secondary","--sn-gradient-accent","--sn-color-base-hex","--sn-color-accent-hex"],normal:["--sn-gradient-","--sn-rs-","--sn-color-"],low:["--sn-debug-","--sn-dev-","--sn-meta-"]},thresholds:{excellentFPS:55,goodFPS:45,poorFPS:30}}),za(this.sharedUnifiedCSSVariableManager),await this.sharedUnifiedCSSVariableManager.initialize()}catch(t){u?.debug?.warn("SystemCoordinator","Failed to initialize OptimizedCSSVariableManager:",t),this.sharedUnifiedCSSVariableManager=null}this.sharedSettingsManager=new ae,await this.sharedSettingsManager.initialize(),this.sharedMusicSyncService=new we,await this.sharedMusicSyncService.initialize(),this.sharedColorHarmonyEngine=new at(this.config,this.utils,this.sharedSimplePerformanceCoordinator,this.sharedSettingsManager),await this.sharedColorHarmonyEngine.initialize(),u?.debug?.log("SystemCoordinator","Shared dependencies initialized successfully")}catch(t){throw u?.debug?.error("SystemCoordinator","Failed to initialize shared dependencies:",t),t}}}async initializeFacades(){u?.debug?.log("SystemCoordinator","Initializing facades");try{let t=this.nonVisualFacade?.getCachedSystem("EnhancedMasterAnimationCoordinator")||null;this.visualBridge=new Ht(this.config,this.utils,this.year3000System,this.sharedUnifiedCSSVariableManager,this.sharedSimplePerformanceCoordinator,this.sharedMusicSyncService,this.sharedSettingsManager,this.sharedColorHarmonyEngine,this.eventBus,t),await this.visualBridge.initialize({mode:this.coordinationConfig.mode==="performance-optimized"?"performance-first":"progressive",enablePerformanceMonitoring:this.coordinationConfig.enableUnifiedPerformanceMonitoring,enableEventCoordination:this.coordinationConfig.enableCrossFacadeCommunication}),this.visualBridge.setOnSystemCreated((e,i)=>{this.handleSystemCreated("visual",e,i)}),this.nonVisualFacade=new Ft(this.config,this.utils,this.year3000System),await this.nonVisualFacade.initialize({mode:this.coordinationConfig.mode==="performance-optimized"?"performance-first":"progressive",enablePerformanceMonitoring:this.coordinationConfig.enableUnifiedPerformanceMonitoring,enableDependencyInjection:this.coordinationConfig.enableSharedDependencies}),this.nonVisualFacade.setOnSystemCreated((e,i)=>{this.handleSystemCreated("non-visual",e,i)}),this.injectSharedDependencies(),u?.debug?.log("SystemCoordinator","Facades initialized successfully")}catch(t){throw u?.debug?.error("SystemCoordinator","Failed to initialize facades:",t),t}}injectSharedDependencies(){!this.coordinationConfig.enableSharedDependencies||!this.nonVisualFacade||(this.sharedSimplePerformanceCoordinator&&(this.nonVisualFacade.simplePerformanceCoordinator=this.sharedSimplePerformanceCoordinator),this.sharedWebGLSystemsIntegration&&(this.nonVisualFacade.webglSystemsIntegration=this.sharedWebGLSystemsIntegration),this.sharedEnhancedDeviceTierDetector&&(this.nonVisualFacade.enhancedDeviceTierDetector=this.sharedEnhancedDeviceTierDetector),this.sharedSimplePerformanceCoordinator&&(this.nonVisualFacade.performanceAnalyzer=this.sharedSimplePerformanceCoordinator),this.sharedUnifiedCSSVariableManager&&(this.nonVisualFacade.cssVariableController=this.sharedUnifiedCSSVariableManager),this.sharedMusicSyncService&&(this.nonVisualFacade.musicSyncService=this.sharedMusicSyncService),this.sharedSettingsManager&&(this.nonVisualFacade.settingsManager=this.sharedSettingsManager),this.sharedColorHarmonyEngine&&(this.nonVisualFacade.colorHarmonyEngine=this.sharedColorHarmonyEngine),this.sharedSemanticColorManager&&(this.nonVisualFacade.semanticColorManager=this.sharedSemanticColorManager))}setupCrossFacadeCommunication(){this.coordinationConfig.enableCrossFacadeCommunication&&(u?.debug?.log("SystemCoordinator","Setting up cross-facade communication"),this.addEventListener("visual-event",t=>{this.visualBridge&&this.visualBridge.propagateVisualEvent(t)}),this.addEventListener("performance-event",t=>{this.visualBridge&&this.visualBridge.handleAdaptationEvent(t)}),this.coordinationConfig.coordinationPreferences.enableHealthCoordination&&this.addEventListener("health-degradation",t=>{this.handleHealthDegradation(t)}))}handleSystemCreated(t,e,i){t==="visual"?this.currentMetrics.visualSystems++:this.currentMetrics.nonVisualSystems++,this.currentMetrics.activeSystems++,this.onSystemCreated&&this.onSystemCreated(t,e,i),u?.debug?.log("SystemCoordinator",`System created: ${t}/${e}`)}handleHealthDegradation(t){u?.debug?.warn("SystemCoordinator","Health degradation detected:",t),this.coordinationConfig.mode==="performance-optimized"&&this.optimizeForPerformance()}optimizeForPerformance(){this.visualBridge&&this.visualBridge.setConfiguration({mode:"performance-first",enableAdaptiveQuality:!0,qualityPreferences:{preferHighQuality:!1,allowDynamicScaling:!0,batteryConservation:!0}}),this.nonVisualFacade&&this.nonVisualFacade.setConfiguration({mode:"performance-first",systemPreferences:{lazyInitialization:!0,aggressiveCaching:!0,performanceOptimization:!0}})}getVisualSystem(t){return this.visualBridge?this.visualBridge.getVisualSystem(t):null}getCachedNonVisualSystem(t){return this.nonVisualFacade?this.nonVisualFacade.getCachedSystem(t):null}async getNonVisualSystem(t){return this.nonVisualFacade?await this.nonVisualFacade.getSystem(t):null}async getSystem(t){if(this.visualBridge)try{return this.visualBridge.getVisualSystem(t)}catch{}if(this.nonVisualFacade)try{return await this.nonVisualFacade.getSystem(t)}catch{}return null}addEventListener(t,e){this.crossFacadeEventListeners.has(t)||this.crossFacadeEventListeners.set(t,[]),this.crossFacadeEventListeners.get(t).push(e)}removeEventListener(t,e){let i=this.crossFacadeEventListeners.get(t);if(i){let a=i.indexOf(e);a!==-1&&i.splice(a,1)}}emitEvent(t,e){let i=this.crossFacadeEventListeners.get(t);i&&i.forEach(a=>{try{a(e)}catch(r){u?.debug?.error("SystemCoordinator",`Error in event listener for ${t}:`,r)}}),this.currentMetrics.crossFacadeEvents++}async performHealthCheck(){let t={overall:"good",facades:{visual:{ok:!0,details:"Visual systems operational",systemCount:0},nonVisual:{ok:!0,details:"Non-visual systems operational",systemCount:0}},sharedResources:{simplePerformanceCoordinator:{ok:!0,details:"Simple performance coordinator operational"},cssVariableController:{ok:!0,details:"CSS variable batcher operational"},musicSyncService:{ok:!0,details:"Music sync service operational"},performanceAnalyzer:{ok:!0,details:"Legacy performance analyzer operational"}},recommendations:[],timestamp:performance.now()};if(this.visualBridge)try{let a=await this.visualBridge.performVisualHealthCheck();t.facades.visual.ok=a.overall==="excellent"||a.overall==="good",t.facades.visual.details=`Visual systems: ${a.overall}`,t.facades.visual.systemCount=a.systems.size}catch(a){t.facades.visual.ok=!1,t.facades.visual.details=`Visual facade error: ${a}`}if(this.nonVisualFacade)try{let a=await this.nonVisualFacade.performHealthCheck();t.facades.nonVisual.ok=a.overall==="excellent"||a.overall==="good",t.facades.nonVisual.details=`Non-visual systems: ${a.overall}`,t.facades.nonVisual.systemCount=a.systems.size}catch(a){t.facades.nonVisual.ok=!1,t.facades.nonVisual.details=`Non-visual facade error: ${a}`}if(this.sharedSimplePerformanceCoordinator)try{let a=await this.sharedSimplePerformanceCoordinator.healthCheck();t.sharedResources.simplePerformanceCoordinator.ok=a.healthy,t.sharedResources.simplePerformanceCoordinator.details=a.details||"Simple performance coordinator operational"}catch(a){t.sharedResources.simplePerformanceCoordinator.ok=!1,t.sharedResources.simplePerformanceCoordinator.details=`Simple performance coordinator error: ${a}`}if(this.sharedSimplePerformanceCoordinator)try{let a=await this.sharedSimplePerformanceCoordinator.healthCheck();t.sharedResources.performanceAnalyzer={ok:a.healthy,details:a.details||"Simple performance coordinator operational"}}catch(a){t.sharedResources.performanceAnalyzer={ok:!1,details:`Simple performance coordinator error: ${a}`}}if(this.sharedUnifiedCSSVariableManager)try{let a=await this.sharedUnifiedCSSVariableManager.healthCheck();t.sharedResources.cssVariableController.ok=a.healthy||a.ok||!1,t.sharedResources.cssVariableController.details=a.details||"CSS variable controller operational"}catch(a){t.sharedResources.cssVariableController.ok=!1,t.sharedResources.cssVariableController.details=`CSS variable controller error: ${a}`}if(this.sharedMusicSyncService)try{let a=await this.sharedMusicSyncService.healthCheck();t.sharedResources.musicSyncService.ok=a.status==="healthy",t.sharedResources.musicSyncService.details=a.message||"Music sync service operational"}catch(a){t.sharedResources.musicSyncService.ok=!1,t.sharedResources.musicSyncService.details=`Music sync service error: ${a}`}if(this.sharedSemanticColorManager)try{let a=await this.sharedSemanticColorManager.healthCheck(),r=a.healthy;t.sharedResources.semanticColorManager={ok:r,details:a.details||"Semantic color manager operational"}}catch(a){t.sharedResources.semanticColorManager={ok:!1,details:`Semantic color manager error: ${a}`}}let e=t.facades.visual.ok&&t.facades.nonVisual.ok,i=t.sharedResources.simplePerformanceCoordinator.ok&&t.sharedResources.cssVariableController.ok&&t.sharedResources.musicSyncService.ok&&t.sharedResources.semanticColorManager?.ok!==!1&&t.sharedResources.performanceAnalyzer?.ok!==!1;return e&&i?t.overall="excellent":e||i?t.overall="good":(t.overall="critical",t.recommendations.push("Multiple system failures detected - consider system restart")),this.currentMetrics.totalMemoryMB>120&&t.recommendations.push("High memory usage - consider optimizing system memory"),this.currentMetrics.totalInitTime>6e3&&t.recommendations.push("High initialization time - consider optimizing system startup"),this.lastHealthCheck=t,this.onHealthChange&&this.onHealthChange(t),t}createInitialMetrics(){return{totalSystems:0,visualSystems:0,nonVisualSystems:0,activeSystems:0,failedSystems:0,totalMemoryMB:0,totalInitTime:0,averageSystemInitTime:0,crossFacadeLatency:0,overallHealth:"good",visualHealth:"good",nonVisualHealth:"good",sharedDependencies:6,crossFacadeEvents:0,resourceOptimization:0}}startMonitoring(){this.coordinationConfig.enableUnifiedPerformanceMonitoring&&(this.healthCheckInterval=window.setInterval(async()=>{await this.performHealthCheck()},2e4),this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},2e3))}updateMetrics(){if(this.visualBridge){let e=this.visualBridge.getMetrics();this.currentMetrics.visualHealth=e.systemHealth}if(this.nonVisualFacade){let e=this.nonVisualFacade.getMetrics();this.currentMetrics.nonVisualHealth=e.systemHealth}let t=performance.memory;t&&(this.currentMetrics.totalMemoryMB=t.usedJSHeapSize/(1024*1024)),this.currentMetrics.visualHealth==="excellent"&&this.currentMetrics.nonVisualHealth==="excellent"?this.currentMetrics.overallHealth="excellent":this.currentMetrics.visualHealth==="critical"||this.currentMetrics.nonVisualHealth==="critical"?this.currentMetrics.overallHealth="critical":this.currentMetrics.visualHealth==="degraded"||this.currentMetrics.nonVisualHealth==="degraded"?this.currentMetrics.overallHealth="degraded":this.currentMetrics.overallHealth="good",this.onPerformanceChange&&this.onPerformanceChange(this.currentMetrics)}setupCoordinationPhases(){this.systemDependencies.set("MusicSyncService",[]),this.systemDependencies.set("ColorHarmonyEngine",["MusicSyncService","SemanticColorManager"]),this.systemDependencies.set("PerformanceAnalyzer",[]),this.systemDependencies.set("UnifiedCSSVariableManager",["PerformanceAnalyzer"]),this.systemDependencies.set("SettingsManager",[]),this.systemDependencies.set("SemanticColorManager",["UnifiedCSSVariableManager"]),this.initializationOrder.set("core",["PerformanceAnalyzer","UnifiedCSSVariableManager"]),this.initializationOrder.set("services",["SettingsManager","MusicSyncService","SemanticColorManager"]),this.initializationOrder.set("visual-systems",["ColorHarmonyEngine"]),this.initializationOrder.set("integration",["VisualSystemCoordinator","NonVisualSystemFacade"]);for(let[t,e]of this.initializationOrder.entries())for(let i of e)this.systemStates.set(i,"uninitialized");u?.debug?.log("SystemCoordinator","Coordination phases configured",{phases:Array.from(this.initializationOrder.keys()),totalSystems:this.systemStates.size,dependencies:Object.fromEntries(this.systemDependencies)})}async executeCoordinatedInitialization(){let t=["core","services","visual-systems","integration"];for(let e of t){u?.debug?.log("SystemCoordinator",`Starting phase: ${e}`),this.currentPhase=e;try{await this.executePhase(e),u?.debug?.log("SystemCoordinator",`Phase ${e} completed successfully`)}catch(i){throw u?.debug?.error("SystemCoordinator",`Phase ${e} failed:`,i),new Error(`Orchestration failed at phase ${e}: ${i}`)}}this.currentPhase="completed",this.setupCrossFacadeCommunication(),await this.setupGradientSystemCoordination(),this.setupDefaultColorDependentSystems(),this.startMonitoring(),await this.performHealthCheck()}async executePhase(t){let e=this.initializationOrder.get(t);if(!e)throw new Error(`Unknown phase: ${t}`);let i=[];for(let a of e)i.push(this.initializeSystemWithDependencies(a));await Promise.all(i);for(let a of e){let r=this.systemStates.get(a);if(r!=="ready")throw new Error(`System ${a} not ready after phase ${t} (state: ${r})`)}}async initializeSystemWithDependencies(t){if(this.systemStates.get(t)!=="ready"){this.systemStates.set(t,"initializing");try{let e=this.systemDependencies.get(t)||[];for(let i of e)await this.waitForSystemReady(i);switch(t){case"PerformanceAnalyzer":await this.initializePerformanceAnalyzer();break;case"UnifiedCSSVariableManager":await this.initializeUnifiedCSSController();break;case"SettingsManager":await this.initializeSettingsManager();break;case"MusicSyncService":await this.initializeMusicSyncService();break;case"ColorHarmonyEngine":await this.initializeColorHarmonyEngine();break;case"SemanticColorManager":await this.initializeSemanticColorManager();break;case"VisualSystemCoordinator":await this.initializeVisualFacade();break;case"NonVisualSystemFacade":await this.initializeNonVisualFacade();break;default:throw new Error(`Unknown system: ${t}`)}this.systemStates.set(t,"ready"),u?.debug?.log("SystemCoordinator",`System ${t} initialized successfully`)}catch(e){throw this.systemStates.set(t,"failed"),u?.debug?.error("SystemCoordinator",`System ${t} initialization failed:`,e),e}}}async waitForSystemReady(t){let e=this.coordinationConfig.coordination.systemReadinessTimeout,i=Date.now();for(;Date.now()-i<e;){let a=this.systemStates.get(t);if(a==="ready")return;if(a==="failed")throw new Error(`Dependency ${t} failed to initialize`);await new Promise(r=>setTimeout(r,50))}throw new Error(`Timeout waiting for dependency ${t} to be ready`)}async initializePerformanceAnalyzer(){this.sharedDeviceCapabilityDetector||(this.sharedDeviceCapabilityDetector=new O({enableDebug:!0,spicetifyContext:!0}),await this.sharedDeviceCapabilityDetector.initialize()),this.sharedEnhancedDeviceTierDetector=new de,this.sharedWebGLSystemsIntegration=new nt(this.sharedDeviceCapabilityDetector),await this.sharedWebGLSystemsIntegration.initialize(),this.sharedSimplePerformanceCoordinator=new Ue(this.sharedEnhancedDeviceTierDetector,this.sharedWebGLSystemsIntegration),await this.sharedSimplePerformanceCoordinator.initialize()}async initializeUnifiedCSSController(){if(!this.sharedSimplePerformanceCoordinator)throw new Error("SimplePerformanceCoordinator dependency not available");try{this.sharedDeviceCapabilityDetector=new O({enableDebug:this.config.enableDebug||!1,runStressTests:!1}),await this.sharedDeviceCapabilityDetector.initialize(),this.sharedPerformanceBudgetManager=new Pe({budgets:{animationFrame:16,cssVariableUpdate:2,domObservation:1,audioAnalysis:5,visualEffects:8,userInteraction:100},autoOptimize:{enabled:!0,violationThreshold:3,recoveryThreshold:.8},enableDebug:this.config.enableDebug||!1},this.sharedSimplePerformanceCoordinator);let t=this.sharedDeviceCapabilityDetector.getCapabilities(),e={getCurrentPerformanceMode:()=>({name:"balanced",qualityLevel:.8,animationQuality:.8,effectQuality:.8,blurQuality:.8,shadowQuality:.8,frameRate:60,optimizationLevel:1}),getDeviceCapabilities:()=>t||{performanceTier:"mid",memoryGB:8,isMobile:!1,gpuAcceleration:!0},getBatteryState:()=>({level:1,charging:!1}),getThermalState:()=>({temperature:"normal"})};this.sharedUnifiedCSSVariableManager=new me(this.config,e,{enableAdaptiveThrottling:!0,batchIntervalMs:16,maxBatchSize:50,priorityMappings:{critical:["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift","--sn-enhanced-base-hex","--sn-enhanced-accent-hex"],high:["--sn-gradient-primary","--sn-gradient-secondary","--sn-gradient-accent","--sn-color-base-hex","--sn-color-accent-hex"],normal:["--sn-gradient-","--sn-rs-","--sn-color-"],low:["--sn-debug-","--sn-dev-","--sn-meta-"]},thresholds:{excellentFPS:55,goodFPS:45,poorFPS:30}}),za(this.sharedUnifiedCSSVariableManager),await this.sharedUnifiedCSSVariableManager.initialize()}catch(t){u?.debug?.warn("SystemCoordinator","Failed to initialize OptimizedCSSVariableManager:",t),this.sharedUnifiedCSSVariableManager=null}}async initializeSettingsManager(){this.sharedSettingsManager=new ae,await this.sharedSettingsManager.initialize()}async initializeMusicSyncService(){this.sharedMusicSyncService=new we({ADVANCED_SYSTEM_CONFIG:this.config,ThemeUtilities:this.utils,performanceMonitor:this.sharedSimplePerformanceCoordinator,settingsManager:this.sharedSettingsManager||void 0,year3000System:this.year3000System}),await this.sharedMusicSyncService.initialize()}async initializeSemanticColorManager(){if(!this.sharedUnifiedCSSVariableManager)throw new Error("OptimizedCSSVariableManager dependency not available");this.sharedSemanticColorManager=new mt({enableDebug:this.config.enableDebug||!1,fallbackToSpiceColors:!0,cacheDuration:5e3}),await this.sharedSemanticColorManager.initialize(this.sharedUnifiedCSSVariableManager),u?.debug?.log("SystemCoordinator","SemanticColorManager initialized successfully",{systemMetrics:this.sharedSemanticColorManager.getSystemMetrics()})}async initializeColorHarmonyEngine(){if(!this.sharedMusicSyncService)throw new Error("MusicSyncService dependency not available");if(!this.sharedSemanticColorManager)throw new Error("SemanticColorManager dependency not available");this.sharedColorHarmonyEngine=new at(this.config,this.utils,this.sharedSimplePerformanceCoordinator||void 0,this.sharedSettingsManager||void 0),await this.sharedColorHarmonyEngine.initialize()}async initializeVisualFacade(){this.visualBridge=new Ht(this.config,this.utils,this,this.sharedUnifiedCSSVariableManager,this.sharedSimplePerformanceCoordinator,this.sharedMusicSyncService,this.sharedSettingsManager,this.sharedColorHarmonyEngine||void 0,this.eventBus),await this.visualBridge.initialize()}async initializeNonVisualFacade(){this.nonVisualFacade=new Ft(this.config,this.utils,{performanceAnalyzer:this.sharedSimplePerformanceCoordinator,unifiedCSSConsciousnessController:this.sharedUnifiedCSSVariableManager,musicSyncService:this.sharedMusicSyncService,settingsManager:this.sharedSettingsManager,colorHarmonyEngine:this.sharedColorHarmonyEngine,performanceOrchestrator:this.sharedSimplePerformanceCoordinator,semanticColorManager:this.sharedSemanticColorManager}),await this.nonVisualFacade.initialize()}async executeLegacyInitialization(){await this.initializeSharedDependencies(),await this.initializeFacades(),this.setupCrossFacadeCommunication(),await this.setupGradientSystemCoordination(),this.setupDefaultColorDependentSystems(),this.startMonitoring(),await this.performHealthCheck()}getCurrentPhase(){return this.currentPhase}getSystemState(t){return this.systemStates.get(t)}getAllSystemStates(){return new Map(this.systemStates)}isOrchestrationEnabled(){return this.coordinationConfig.coordination.enforceSequentialInitialization}async cleanup(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this.visualBridge&&(await this.visualBridge.destroy(),this.visualBridge=null),this.nonVisualFacade&&(await this.nonVisualFacade.destroy(),this.nonVisualFacade=null),this.sharedSimplePerformanceCoordinator&&(this.sharedSimplePerformanceCoordinator.destroy(),this.sharedSimplePerformanceCoordinator=null),this.sharedWebGLSystemsIntegration&&(this.sharedWebGLSystemsIntegration.destroy(),this.sharedWebGLSystemsIntegration=null),this.sharedEnhancedDeviceTierDetector&&(this.sharedEnhancedDeviceTierDetector=null),this.sharedSemanticColorManager&&(this.sharedSemanticColorManager.destroy(),this.sharedSemanticColorManager=null),this.sharedColorHarmonyEngine&&(this.sharedColorHarmonyEngine.destroy(),this.sharedColorHarmonyEngine=null),this.sharedMusicSyncService&&(this.sharedMusicSyncService.destroy(),this.sharedMusicSyncService=null),this.sharedSettingsManager&&(this.sharedSettingsManager.destroy(),this.sharedSettingsManager=null),this.sharedUnifiedCSSVariableManager&&(this.sharedUnifiedCSSVariableManager.destroy(),this.sharedUnifiedCSSVariableManager=null),this.sharedSimplePerformanceCoordinator&&(this.sharedSimplePerformanceCoordinator.destroy(),this.sharedSimplePerformanceCoordinator=null),this.sharedPerformanceBudgetManager&&(this.sharedPerformanceBudgetManager.destroy(),this.sharedPerformanceBudgetManager=null),this.sharedDeviceCapabilityDetector&&(this.sharedDeviceCapabilityDetector.destroy(),this.sharedDeviceCapabilityDetector=null),this.crossFacadeEventListeners.clear()}getMetrics(){return{...this.currentMetrics}}getLastHealthCheck(){return this.lastHealthCheck}getConfiguration(){return{...this.coordinationConfig}}async setConfiguration(t){this.coordinationConfig={...this.coordinationConfig,...t}}setOnSystemCreated(t){this.onSystemCreated=t}setOnHealthChange(t){this.onHealthChange=t}setOnPerformanceChange(t){this.onPerformanceChange=t}getSystemStatus(){return{initialized:this.isInitialized,visualSystems:this.visualBridge?.getSystemStatus()?.systemsActive||0,nonVisualSystems:this.nonVisualFacade?.getSystemStatus()?.systemsActive||0,healthy:this.currentMetrics.overallHealth==="excellent"||this.currentMetrics.overallHealth==="good"}}async setupGradientSystemCoordination(){if(!this.visualBridge){u?.debug?.warn("SystemCoordinator","VisualSystemCoordinator not available - skipping gradient system coordination");return}u?.debug?.log("SystemCoordinator","Setting up gradient system coordination");let t=performance.now(),e=0;try{await this.coordinateGradientConductor(),e++,await this.coordinateWebGLGradientSystem(),e++,this.setupGradientSystemRefreshCallbacks(),this.setupGradientSystemCommunication();let i=performance.now()-t;u?.debug?.log("SystemCoordinator","Gradient system coordination completed",{coordinatedSystems:e,duration:`${i.toFixed(2)}ms`,systems:["GradientConductor","WebGLGradientBackgroundSystem","GradientTransitionOrchestrator"]})}catch(i){throw u?.debug?.error("SystemCoordinator","Failed to setup gradient system coordination:",i),i}}async coordinateGradientConductor(){try{let t=this.visualBridge.getVisualSystem("GradientConductor");if(!t){u?.debug?.warn("SystemCoordinator","GradientConductor not available via VisualSystemCoordinator");return}this.addEventListener("gradient-conductor-event",e=>{t&&typeof t.handleSystemEvent=="function"&&t.handleSystemEvent(e)}),this.registerColorDependentSystem("GradientConductor",async e=>{if(t&&typeof t.refreshColorState=="function")await t.refreshColorState(e);else if(t&&typeof t.setPalette=="function"){let i=this.sharedColorHarmonyEngine;if(i)try{let a=await i.getCurrentGradient();a&&t.setPalette(a)}catch(a){u?.debug?.warn("SystemCoordinator","Failed to refresh GradientConductor colors:",a)}}}),u?.debug?.log("SystemCoordinator","GradientConductor coordination established")}catch(t){u?.debug?.error("SystemCoordinator","Failed to coordinate GradientConductor:",t)}}async coordinateWebGLGradientSystem(){try{let t=this.visualBridge.getVisualSystem("WebGLBackground");if(!t){u?.debug?.warn("SystemCoordinator","WebGLGradientBackgroundSystem not available via VisualSystemCoordinator");return}this.addEventListener("webgl-gradient-event",e=>{t&&typeof t.handleSystemEvent=="function"&&t.handleSystemEvent(e)}),this.registerColorDependentSystem("WebGLGradientBackgroundSystem",async e=>{t&&typeof t.refreshColorState=="function"?await t.refreshColorState(e):t&&typeof t.updateGradientTexture=="function"&&await t.updateGradientTexture()}),u?.debug?.log("SystemCoordinator","WebGLGradientBackgroundSystem coordination established")}catch(t){u?.debug?.error("SystemCoordinator","Failed to coordinate WebGLGradientBackgroundSystem:",t)}}setupGradientSystemRefreshCallbacks(){try{this.registerColorDependentSystem("GradientTransitionOrchestrator"),u?.debug?.log("SystemCoordinator","GradientTransitionOrchestrator registered for color updates")}catch(t){u?.debug?.warn("SystemCoordinator","Failed to register GradientTransitionOrchestrator:",t)}}setupGradientSystemCommunication(){this.addEventListener("color-harmony-updated",async t=>{try{await this.refreshColorDependentSystems("color-harmony-update"),this.emitEvent("gradient-systems-updated",{trigger:"color-harmony-update",timestamp:Date.now(),systems:["GradientConductor","WebGLGradientBackgroundSystem","GradientTransitionOrchestrator"]})}catch(e){u?.debug?.error("SystemCoordinator","Failed to propagate color harmony update to gradient systems:",e)}}),this.addEventListener("performance-event",t=>{try{this.emitEvent("gradient-performance-event",{...t,timestamp:Date.now()})}catch(e){u?.debug?.error("SystemCoordinator","Failed to propagate performance event to gradient systems:",e)}}),u?.debug?.log("SystemCoordinator","Gradient system communication established")}getGradientSystemStatus(){let t=["GradientConductor","WebGLGradientBackgroundSystem","GradientTransitionOrchestrator"],e=t.filter(i=>this.colorDependentSystems.has(i));return{coordinatedSystems:t,colorDependentGradientSystems:e,communicationActive:this.crossFacadeEventListeners.size>0}}registerColorDependentSystem(t,e){this.colorDependentSystems.add(t),e&&this.colorSystemRefreshCallbacks.set(t,e),u?.debug?.log("SystemCoordinator",`Registered color-dependent system: ${t}`)}unregisterColorDependentSystem(t){this.colorDependentSystems.delete(t),this.colorSystemRefreshCallbacks.delete(t),u?.debug?.log("SystemCoordinator",`Unregistered color-dependent system: ${t}`)}getColorDependentSystems(){return Array.from(this.colorDependentSystems)}async refreshColorDependentSystems(t){if(this.colorDependentSystems.size===0){u?.debug?.log("SystemCoordinator","No color-dependent systems to refresh");return}let e=performance.now(),i=[],a=0,r=0;u?.debug?.log("SystemCoordinator",`Refreshing ${this.colorDependentSystems.size} color-dependent systems for trigger: ${t}`);for(let o of this.colorDependentSystems){let c=this.colorSystemRefreshCallbacks.get(o);c?i.push(c(t).then(()=>{a++,u?.debug?.log("SystemCoordinator",`Successfully refreshed color system: ${o}`)}).catch(m=>{r++,u?.debug?.warn("SystemCoordinator",`Failed to refresh color system ${o}:`,m)})):i.push(this.getSystemAndRefresh(o,t).then(()=>{a++}).catch(m=>{r++,u?.debug?.warn("SystemCoordinator",`Failed to refresh color system ${o}:`,m)}))}await Promise.all(i);let s=performance.now()-e;u?.debug?.log("SystemCoordinator","Color system refresh completed",{trigger:t,duration:`${s.toFixed(2)}ms`,success:a,failures:r,totalSystems:this.colorDependentSystems.size}),this.emitEvent("color-systems-refreshed",{trigger:t,duration:s,successCount:a,failureCount:r,totalSystems:this.colorDependentSystems.size,timestamp:Date.now()})}async getSystemAndRefresh(t,e){if(this.visualBridge)try{let i=this.visualBridge.getVisualSystem(t);if(i&&typeof i.refreshColorState=="function"){await i.refreshColorState(e);return}}catch{}if(this.nonVisualFacade)try{let i=await this.nonVisualFacade.getSystem(t);if(i&&typeof i.refreshColorState=="function"){await i.refreshColorState(e);return}}catch{}u?.debug?.warn("SystemCoordinator",`System ${t} not found or doesn't support color refresh`)}setupDefaultColorDependentSystems(){let t=["CinematicDrama","EtherealBeauty","NaturalHarmony","FluidGradientBackgroundSystem","WebGLGradientBackgroundSystem","IridescentShimmerEffectsSystem","ColorHarmonyEngine","GradientTransitionOrchestrator","GradientConductor","SemanticColorManager","Card3DManager","GlassmorphismManager"];for(let e of t)this.registerColorDependentSystem(e);u?.debug?.log("SystemCoordinator",`Auto-registered ${t.length} default color-dependent systems`)}async destroy(){await this.cleanup(),this.isInitialized=!1,u?.debug?.log("SystemCoordinator","System coordinator destroyed")}getSharedMusicSyncService(){return this.sharedMusicSyncService||void 0}getSharedColorHarmonyEngine(){return this.sharedColorHarmonyEngine||void 0}getSharedSettingsManager(){return this.sharedSettingsManager||void 0}getSharedSemanticColorManager(){return this.sharedSemanticColorManager||void 0}getSharedSimplePerformanceCoordinator(){return this.sharedSimplePerformanceCoordinator||void 0}getSharedWebGLSystemsIntegration(){return this.sharedWebGLSystemsIntegration||void 0}getSharedEnhancedDeviceTierDetector(){return this.sharedEnhancedDeviceTierDetector||void 0}getSharedPerformanceAnalyzer(){return this.sharedSimplePerformanceCoordinator||void 0}getSharedPerformanceOrchestrator(){return this.sharedSimplePerformanceCoordinator||void 0}}});var Er,Us,Os=y(()=>{"use strict";k();U();Tt();Er=class{constructor(t){this.initialized=!1;this.settingsManager=null;this.currentState=null;this.isUpdating=!1;this.updateCount=0;this.lastUpdateTime=0;this.settingsManager=t||null}async initialize(){if(this.initialized)return;let t=globalThis.year3000System;this.cssController=t?.cssController||P(),p.subscribe("settings:changed",this.handleSettingsChange.bind(this),"ColorStateManager"),p.subscribe("colors:harmonized",this.handleProcessedColors.bind(this),"ColorStateManager"),p.subscribe("colors:extracted",this.handleExtractedColors.bind(this),"ColorStateManager"),p.subscribe("visual-effects:state-updated",this.handleVisualEffectsUpdate.bind(this),"ColorStateManager"),p.subscribe("music:energy",this.handleMusicEnergyUpdate.bind(this),"ColorStateManager"),p.subscribe("system:css-variables",this.handleSystemCSSVariables.bind(this),"ColorStateManager"),this.settingsManager||(this.settingsManager=globalThis.__SN_settingsManager||globalThis.Y3K?.system?.settingsManager),this.settingsManager&&await this.applyInitialColorState(),this.initialized=!0,console.log("\u{1F3A8} [ColorStateManager] Initialized successfully")}async healthCheck(){let t=[];this.settingsManager||t.push("SettingsManager not available"),this.currentState||t.push("No current color state"),this.updateCount===0&&t.push("No color updates performed yet");let e=Date.now()-this.lastUpdateTime;return e>3e5&&t.push(`Last update was ${Math.round(e/1e3)}s ago`),{healthy:t.length===0,ok:t.length===0,details:`Color state manager - ${this.updateCount} updates performed`,issues:t,system:"ColorStateManager"}}updateAnimation(t){}destroy(){p.unsubscribeAll("ColorStateManager"),this.currentState=null,this.initialized=!1}getCurrentConfig(){return this.settingsManager?{paletteSystemFlavor:this.settingsManager.get("catppuccin-flavor")||K.getCurrentDefaultFlavor(),brightnessMode:this.settingsManager.get("sn-brightness-mode"),accentColor:this.settingsManager.get("catppuccin-accentColor"),preserveAlbumArt:!0,enableTransitions:!0}:{paletteSystemFlavor:K.getCurrentDefaultFlavor(),brightnessMode:"balanced",accentColor:"mauve",preserveAlbumArt:!0,enableTransitions:!0}}calculateColorState(t){let{paletteSystemFlavor:e,brightnessMode:i,accentColor:a,dynamicAlbumColors:r}=t,n=Dn(e,i),s=Ln(e,i),o;a==="dynamic"&&r?o=r.accent:a==="dynamic"?o=_a(e):o=kn(a,e);let m=K.getCurrentPalette()[e];if(!m)throw new Error(`Flavor '${e}' not found in current palette system`);let d=m.text;return{baseColor:n,surfaceColor:s,accentColor:o,textColor:d,effectiveConfig:t,timestamp:Date.now()}}async applyColorStateToCSSVariables(t){let e=performance.now(),i={"--sn-cosmic-base-hex":t.baseColor.hex,"--sn-cosmic-accent-hex":t.accentColor.hex,"--spice-accent":t.accentColor.hex,"--spice-base":t.baseColor.hex,"--sn-color-base-hex":t.baseColor.hex,"--sn-color-base-rgb":t.baseColor.rgb,"--sn-color-surface-hex":t.surfaceColor.hex,"--sn-color-surface-rgb":t.surfaceColor.rgb,"--sn-color-accent-hex":t.accentColor.hex,"--sn-color-accent-rgb":t.accentColor.rgb,"--sn-dynamic-accent-hex":t.accentColor.hex,"--sn-dynamic-accent-rgb":t.accentColor.rgb,"--sn-cosmic-base-rgb":t.baseColor.rgb,"--sn-cosmic-surface-hex":t.surfaceColor.hex,"--sn-cosmic-surface-rgb":t.surfaceColor.rgb,"--sn-cosmic-accent-rgb":t.accentColor.rgb,"--sn-color-text-hex":t.textColor.hex,"--sn-color-text-rgb":t.textColor.rgb,"--sn-cosmic-text-hex":t.textColor.hex,"--sn-cosmic-text-rgb":t.textColor.rgb,"--spice-surface1":t.surfaceColor.hex,"--spice-text":t.textColor.hex,"--spice-rgb-base":t.baseColor.rgb,"--spice-rgb-surface1":t.surfaceColor.rgb,"--spice-rgb-accent":t.accentColor.rgb,"--spice-rgb-text":t.textColor.rgb,"--sn-bg-gradient-primary-rgb":t.accentColor.rgb,"--sn-bg-gradient-secondary-rgb":t.surfaceColor.rgb,"--sn-bg-gradient-accent-rgb":t.accentColor.rgb,"--sn-brightness-mode":`"${t.effectiveConfig.brightnessMode}"`,"--sn-brightness-data-attr":t.effectiveConfig.brightnessMode,"--sn-color-state-flavor":`"${t.effectiveConfig.paletteSystemFlavor}"`,"--sn-color-state-brightness":`"${t.effectiveConfig.brightnessMode}"`,"--sn-color-state-accent":`"${t.effectiveConfig.accentColor}"`,"--sn-color-state-palette-system":`"${K.getCurrentPaletteSystem()}"`,"--sn-color-state-timestamp":t.timestamp.toString()};await this.applyColorVariablesWithPriorities(i);let r=performance.now()-e;console.log(`\u{1F3A8} [ColorStateManager] Applied ${Object.keys(i).length} CSS variables in ${r.toFixed(2)}ms (via OptimizedCSSVariableManager)`)}async applyColorVariablesWithPriorities(t){let e=["--sn-cosmic-base-hex","--sn-cosmic-accent-hex","--spice-accent","--spice-base"],i=["--sn-color-","--sn-dynamic-accent-","--sn-brightness-mode","--sn-brightness-data-attr"],a={},r={},n={},s={};Object.entries(t).forEach(([o,c])=>{e.some(m=>o.includes(m))?a[o]=c:i.some(m=>o.includes(m))?r[o]=c:o.includes("state-")||o.includes("timestamp")?s[o]=c:n[o]=c}),Object.keys(a).length>0&&this.cssController.batchSetVariables("ColorStateManager",a,"critical","color-state-critical"),Object.keys(r).length>0&&this.cssController.batchSetVariables("ColorStateManager",r,"high","color-state-high"),Object.keys(n).length>0&&this.cssController.batchSetVariables("ColorStateManager",n,"normal","color-state-normal"),Object.keys(s).length>0&&this.cssController.batchSetVariables("ColorStateManager",s,"low","color-state-meta")}queueCSSVariableUpdate(t,e,i="normal"){let a=i==="critical"?"critical":i==="high"?"high":i==="low"?"low":"normal";this.cssController.setVariable("ColorStateManager",t,e,a,"color-state-queue")}async verifyCSSVariablesApplied(t){let e=["--sn-cosmic-base-hex","--sn-cosmic-accent-hex","--spice-base"];for(let i of e)if(t[i]){let a=getComputedStyle(document.documentElement).getPropertyValue(i).trim(),r=t[i];if(a!==r)return console.warn(`\u{1F3A8} [ColorStateManager] Variable verification failed: ${i} = "${a}" (expected "${r}")`),!1}return!0}async updateColorState(t="settings"){if(!this.isUpdating){this.isUpdating=!0;try{let e=this.getCurrentConfig(),i=this.calculateColorState(e);if(!this.currentState||this.currentState.baseColor.hex!==i.baseColor.hex||this.currentState.surfaceColor.hex!==i.surfaceColor.hex||this.currentState.accentColor.hex!==i.accentColor.hex||this.currentState.effectiveConfig.paletteSystemFlavor!==i.effectiveConfig.paletteSystemFlavor||this.currentState.effectiveConfig.brightnessMode!==i.effectiveConfig.brightnessMode){let r=this.currentState;await this.applyColorStateToCSSVariables(i),await this.applyBrightnessModeOverrides(i.effectiveConfig.brightnessMode),this.currentState=i,this.updateCount++,this.lastUpdateTime=Date.now(),p.emit("colors:applied",{oldState:r,newState:i,trigger:t,cssVariables:{"--sn-cosmic-base-hex":i.baseColor.hex,"--sn-cosmic-accent-hex":i.accentColor.hex},accentHex:i.accentColor.hex,accentRgb:i.accentColor.rgb,appliedAt:Date.now()}),console.log(`\u{1F3A8} [ColorStateManager] Color state updated (${t}):`,{flavor:i.effectiveConfig.paletteSystemFlavor,brightness:i.effectiveConfig.brightnessMode,accent:i.effectiveConfig.accentColor,paletteSystem:K.getCurrentPaletteSystem(),base:i.baseColor.hex,surface:i.surfaceColor.hex,accentHex:i.accentColor.hex})}}finally{this.isUpdating=!1}}}async applyBrightnessModeOverrides(t){let e=this.getCurrentConfig(),i=_a(e.paletteSystemFlavor),a=i;if(t==="dark"){let n=i.rgb.split(", ").map(Number);if(n.length===3&&n.every(s=>!isNaN(s)&&s!==void 0)){let s=n[0],o=n[1],c=n[2],m=Math.floor(s*.85),d=Math.floor(o*.85),h=Math.floor(c*.85);a={...i,rgb:`${m}, ${d}, ${h}`,hex:`#${m.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}${h.toString(16).padStart(2,"0")}`}}}else if(t==="bright"){let n=i.rgb.split(", ").map(Number);if(n.length===3&&n.every(s=>!isNaN(s)&&s!==void 0)){let s=n[0],o=n[1],c=n[2],m=Math.min(255,Math.floor(s*1.1)),d=Math.min(255,Math.floor(o*1.1)),h=Math.min(255,Math.floor(c*1.1));a={...i,rgb:`${m}, ${d}, ${h}`,hex:`#${m.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}${h.toString(16).padStart(2,"0")}`}}}let r={"--sn-brightness-mode":`"${t}"`,"--sn-brightness-data-attr":t,"--sn-brightness-adjusted-accent-hex":a.hex,"--sn-brightness-adjusted-accent-rgb":a.rgb,"--sn-bg-gradient-saturation":`var(--sn-brightness-${t}-saturation)`,"--sn-bg-gradient-brightness":`var(--sn-brightness-${t}-brightness)`,"--sn-bg-gradient-contrast":`var(--sn-brightness-${t}-contrast)`,"--sn-bg-gradient-opacity":`var(--sn-brightness-${t}-opacity)`};this.cssController.batchSetVariables("ColorStateManager",r,"critical","brightness-mode-overrides"),console.log(`\u{1F3A8} [ColorStateManager] Applied brightness mode overrides: ${t}`)}async applyInitialColorState(){await this.updateColorState("initialization")}async handleSettingsChange(t){let{settingKey:e,newValue:i,oldValue:a}=t;if(["catppuccin-flavor","sn-brightness-mode","catppuccin-accentColor"].includes(e)){let r="settings";e==="catppuccin-flavor"?r="flavor":e==="sn-brightness-mode"?r="brightness":e==="catppuccin-accentColor"&&(r="accent"),p.emit(`colorState:${r}Changed`,{settingKey:e,newValue:i,oldValue:a,timestamp:Date.now()}),await this.updateColorState(r)}}async handleProcessedColors(t){let{processedColors:e,accentHex:i,accentRgb:a,strategies:r,coordinationMetrics:n}=t,s={};Object.entries(e).forEach(([o,c])=>{if(c){let m=o.startsWith("--")?o:`--sn-${o.toLowerCase().replace(/_/g,"-")}`;s[m]=c}}),i&&(s["--sn-accent-hex"]=i,s["--sn-processed-accent-hex"]=i),a&&(s["--sn-accent-rgb"]=a,s["--sn-processed-accent-rgb"]=a),n&&(n.emotionalState&&(s["--sn-emotional-state"]=`"${n.emotionalState}"`),n.musicInfluenceStrength!==void 0&&(s["--sn-music-influence"]=n.musicInfluenceStrength.toFixed(3))),Object.entries(s).forEach(([o,c])=>{let m="normal";o.includes("accent-hex")||o.includes("accent-rgb")?m="high":(o.includes("debug")||o.includes("state")||o.includes("influence"))&&(m="low"),this.queueCSSVariableUpdate(o,c,m)}),console.log(`\u{1F3A8} [ColorStateManager] Applied ${Object.keys(s).length} processed color variables`)}async handleExtractedColors(t){let{rawColors:e,trackUri:i,musicData:a}=t,r={};Object.entries(e).forEach(([n,s])=>{s&&(r[`--sn-extracted-${n.toLowerCase()}`]=s)}),i&&(r["--sn-current-track-id"]=`"${i}"`),Object.entries(r).forEach(([n,s])=>{this.queueCSSVariableUpdate(n,s,"low")})}async handleVisualEffectsUpdate(t){let{payload:e}=t;if(!e)return;let i={"--sn-visual-effects-level":(e.visualEffectsLevel||0).toFixed(3),"--sn-emotional-temperature":(e.emotionalTemperature||6500).toString(),"--sn-transcendence-level":(e.transcendenceLevel||0).toFixed(3),"--sn-volumetric-depth":(e.volumetricDepth||0).toFixed(3),"--sn-data-stream-intensity":(e.dataStreamIntensity||0).toFixed(3),"--sn-cosmic-resonance":(e.cosmicResonance||0).toFixed(3)};Object.entries(i).forEach(([a,r])=>{this.queueCSSVariableUpdate(a,r,"normal")})}async handleMusicEnergyUpdate(t){let{energy:e,valence:i,tempo:a}=t,r={};e!==void 0&&(r["--sn-music-energy"]=e.toFixed(3)),i!==void 0&&(r["--sn-music-valence"]=i.toFixed(3)),a!==void 0&&(r["--sn-music-tempo"]=a.toString()),Object.entries(r).forEach(([n,s])=>{this.queueCSSVariableUpdate(n,s,"high")})}async handleSystemCSSVariables(t){let{source:e,variables:i,timestamp:a}=t;!i||typeof i!="object"||(Object.entries(i).forEach(([r,n])=>{let s="normal";r.includes("harmony")||r.includes("glow")||r.includes("pulse")?s="high":(r.includes("debug")||r.includes("animation"))&&(s="low"),this.queueCSSVariableUpdate(r,n,s)}),console.log(`\u{1F3A8} [ColorStateManager] Applied ${Object.keys(i).length} CSS variables from ${e}`))}getCurrentState(){return this.currentState?{...this.currentState}:null}async refresh(){await this.updateColorState("settings")}},Us=new Er});function Ns(l,t=!1){let e=document.querySelector(L.nowPlayingBar);if(!e)return t&&console.warn("\u{1F3B5} [NowPlayingDomWatcher] nowPlayingBar element not found \u2013 watcher inactive"),()=>{};let i=new MutationObserver(()=>{l(),t&&console.log("\u{1F3B5} [NowPlayingDomWatcher] DOM mutation detected \u2192 onChange dispatched")});return i.observe(e,{childList:!0,subtree:!0}),t&&console.log("\u{1F3B5} [NowPlayingDomWatcher] watcher active"),()=>{i.disconnect(),t&&console.log("\u{1F3B5} [NowPlayingDomWatcher] watcher disposed")}}var $s=y(()=>{"use strict";ur()});function Nl(){let l=document.querySelector(".sn-stars-container");if(l)return l;let t=document.createElement("div");t.className="sn-stars-container";for(let e=1;e<=5;e++){let i=document.createElement("div");i.className="star",Math.random()>.7&&i.classList.add("twinkle"),t.appendChild(i)}return document.body.appendChild(t),t}function Ut(l,t){M.enableDebug&&console.log("[StarryNightEffects] Applying consolidated effect settings:",{effectIntensity:l});let e=document.body,i=["sn-gradient-disabled","sn-gradient-minimal","sn-gradient-balanced","sn-gradient-intense"],a=["sn-stars-disabled","sn-stars-minimal","sn-stars-balanced","sn-stars-intense"];e.classList.remove(...i,...a),l!=="balanced"&&(e.classList.add(`sn-gradient-${l}`),e.classList.add(`sn-stars-${l}`));let r=document.querySelector(".sn-stars-container");l==="disabled"?r?.remove():r||Nl()}var Mr=y(()=>{"use strict";st();G()});var Ot,wr,Ws,Tr=y(()=>{"use strict";zs();Os();sr();k();G();Z();$s();Mr();Ot=class{constructor(t=M){this.healthCheckInterval=null;this.facadeCoordinator=null;this.colorStateManager=null;this._initializationResults=null;this._dynamicCatppuccinBridge=null;this.processingState={isProcessingSongChange:!1,lastProcessedTrackUri:null,lastProcessingTime:0,processingChain:[],eventLoopDetected:!1};this.colorEventState={processedEvents:new Map,isProcessingColorEvent:!1,eventTimeout:null};this.PROCESSING_TIMEOUT=5e3;this.MAX_CHAIN_LENGTH=10;this.COLOR_EVENT_CACHE_TTL=2e3;this.availableAPIs=null;this._songChangeHandler=null;this._lastInitializationTime=null;this._initializationRetryHistory=[];this._systemStartTime=null;this._disposeNowPlayingWatcher=null;this.allowHarmonicEvolution=!0;this.performanceGuardActive=!1;this.ADVANCED_SYSTEM_CONFIG=this._deepCloneConfig(t),typeof this.ADVANCED_SYSTEM_CONFIG.init=="function"&&this.ADVANCED_SYSTEM_CONFIG.init(),this.utils=D,this.initialized=!1,this._systemStartTime=Date.now(),this._initializationResults=null,this.ADVANCED_SYSTEM_CONFIG?.enableDebug&&console.log("\u{1F31F} [Year3000System] Constructor: Instance created with Enhanced Master Animation Coordinator"),this._boundExternalSettingsHandler=this._handleExternalSettingsChange.bind(this),document.addEventListener("year3000SystemSettingsChanged",this._boundExternalSettingsHandler),this._boundArtisticModeHandler=this._onArtisticModeChanged.bind(this),document.addEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),this._boundVisibilityChangeHandler=this._handleVisibilityChange.bind(this),document.addEventListener("visibilitychange",this._boundVisibilityChangeHandler),this._disposeNowPlayingWatcher=Ns(()=>{let e=Date.now().toString();this.queueCSSVariableUpdate("--sn-force-refresh",e),p.emit("music:track-changed",{timestamp:parseInt(e),trackUri:"unknown",artist:"unknown",title:"unknown"})},this.ADVANCED_SYSTEM_CONFIG.enableDebug),this.allowHarmonicEvolution=this.ADVANCED_SYSTEM_CONFIG.colorHarmonyEvolution??!0,setTimeout(()=>{this._applyPerformanceProfile()},0)}get enhancedMasterAnimationCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("EnhancedMasterAnimationCoordinator")||null}get timerConsolidationSystem(){return this.facadeCoordinator?.getCachedNonVisualSystem("TimerConsolidationSystem")||null}get cssVariableController(){return this.facadeCoordinator?.getCachedNonVisualSystem("OptimizedCSSVariableManager")||null}get simplePerformanceCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimplePerformanceCoordinator")||null}get simpleTierBasedPerformanceSystem(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimpleTierBasedPerformanceSystem")||null}get enhancedDeviceTierDetector(){return this.facadeCoordinator?.getCachedNonVisualSystem("EnhancedDeviceTierDetector")||null}get webglSystemsIntegration(){return this.facadeCoordinator?.getCachedNonVisualSystem("WebGLSystemsIntegration")||null}get unifiedCSSManager(){return this.cssVariableController||null}get performanceCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedPerformanceCoordinator")||null}get deviceCapabilityDetector(){return this.facadeCoordinator?.getCachedNonVisualSystem("DeviceCapabilityDetector")||null}get performanceAnalyzer(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimplePerformanceCoordinator")||null}get unifiedPerformanceCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedPerformanceCoordinator")||null}get performanceCSSIntegration(){return this.cssVariableController||null}get performanceOrchestrator(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimplePerformanceCoordinator")||null}get performanceBudgetManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("PerformanceBudgetManager")||null}get systemHealthMonitor(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedDebugManager")||null}get settingsManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("SettingsManager")||null}get colorHarmonyEngine(){return this.facadeCoordinator?.getCachedNonVisualSystem("ColorHarmonyEngine")||null}get unifiedColorProcessingEngine(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedColorProcessingEngine")||null}get musicColorIntegrationBridge(){return null}get colorEventOrchestrator(){let t=this.unifiedColorProcessingEngine;return t||null}get colorOrchestrator(){let t=this.unifiedColorProcessingEngine;return t||null}get enhancedColorOrchestrator(){let t=this.unifiedColorProcessingEngine;return t||null}get colorEffectsState(){return this.visualEffectsCoordinator||null}get musicSyncService(){return this.facadeCoordinator?.getCachedNonVisualSystem("MusicSyncService")||null}get glassmorphismManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("GlassmorphismManager")||null}get card3DManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("Card3DManager")||null}get genreGradientEvolution(){return this.facadeCoordinator?.getCachedNonVisualSystem("GenreGradientEvolution")||null}get musicEmotionAnalyzer(){return this.facadeCoordinator?.getCachedNonVisualSystem("MusicEmotionAnalyzer")||null}get visualEffectsCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("VisualEffectsCoordinator")||null}get colorEffectsManager(){return this.visualEffectsCoordinator||null}get dynamicCatppuccinBridge(){return this._dynamicCatppuccinBridge||this.visualEffectsCoordinator||null}set dynamicCatppuccinBridge(t){this._dynamicCatppuccinBridge=t}get particleVisualEffectsModule(){return this.facadeCoordinator?.getVisualSystem("Particle")||null}get sidebarVisualEffectsController(){return this.facadeCoordinator?.getVisualSystem("SidebarVisualEffects")||null}get uiVisualEffectsController(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get headerVisualEffectsController(){return this.facadeCoordinator?.getVisualSystem("HeaderVisualEffects")||null}get lightweightParticleSystem(){return this.facadeCoordinator?.getVisualSystem("Particle")||null}get iridescentShimmerEffectsSystem(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get interactionTrackingSystem(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get whiteLayerDiagnosticSystem(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get audioVisualController(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get prismaticScrollSheenSystem(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get beatSyncVisualSystem(){return this.facadeCoordinator?.getVisualSystem("MusicBeatSync")||null}get webGLGradientBackgroundSystem(){return this.facadeCoordinator?.getVisualSystem("WebGLBackground")||null}get particleFieldSystem(){return this.facadeCoordinator?.getVisualSystem("Particle")||null}get animationCoordinator(){return this.enhancedMasterAnimationCoordinator||null}get emergentChoreographyEngine(){return this.animationCoordinator}get spotifyUIApplicationSystem(){return this.facadeCoordinator?.getVisualSystem("SpotifyUIApplication")||null}get musicBeatSyncVisualEffects(){return this.facadeCoordinator?.getVisualSystem("MusicBeatSync")||this.beatSyncVisualSystem}get sidebarSystemsIntegration(){return this.facadeCoordinator?.getCachedNonVisualSystem("SidebarSystemsIntegration")||null}_deepCloneConfig(t){return t}updateConfiguration(t,e){if(!this.ADVANCED_SYSTEM_CONFIG){console.warn("[Year3000System] Cannot update configuration - config not initialized");return}let i=t.split(".").filter(Boolean);if(!i.length)return;let a=this.ADVANCED_SYSTEM_CONFIG,r=i.pop();if(!r)return;for(let s of i)(typeof a[s]!="object"||a[s]===null)&&(a[s]={}),a=a[s];let n=a[r];a[r]=e,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`[Year3000System] Configuration updated: ${t} = ${e} (was: ${n})`),this._notifyConfigurationChange(t,e,n)}_notifyConfigurationChange(t,e,i){}async initializeAllSystems(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] initializeAllSystems(): Starting full system initialization..."),this._systemStartTime=Date.now();let t=performance.now(),e={success:[],failed:[],skipped:[]};this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing Facade Coordination System...");try{this.facadeCoordinator=new zt(this.ADVANCED_SYSTEM_CONFIG,this.utils,this),await this.facadeCoordinator.initialize({mode:"unified",enableSharedDependencies:!0,enableCrossFacadeCommunication:!0,enableUnifiedPerformanceMonitoring:!0,enableResourceOptimization:!0,coordination:{enforceSequentialInitialization:!0,dependencyValidation:!0,enableInitializationGates:!0,systemReadinessTimeout:5e3,phaseTransitionTimeout:1e4},performanceThresholds:{maxTotalMemoryMB:100,maxTotalInitTime:5e3,maxCrossCommLatency:50},coordinationPreferences:{preferSharedResources:!0,enableEventPropagation:!0,enableHealthCoordination:!0}}),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Facade Coordination System initialized successfully"),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing ColorStateManager...");try{this.colorStateManager=Us,this.colorStateManager.initialized||await this.colorStateManager.initialize(),e.success.push("ColorStateManager"),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] ColorStateManager initialized successfully")}catch(a){console.error("\u{1F30C} [Year3000System] Failed to initialize ColorStateManager:",a),e.failed.push("ColorStateManager")}await this._initializeFacadeSystems()}catch(a){throw console.error("\u{1F30C} [Year3000System] Failed to initialize Facade Coordination System:",a),a}e.success.push("FacadeCoordinationSystem"),this.performanceAnalyzer&&(this.performanceAnalyzer.startMonitoring(),this.performanceGuardActive=!0),this.enhancedMasterAnimationCoordinator?(await this._registerEnhancedAnimationSystems(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3AC} [Year3000System] Enhanced animation system registration phase complete")):console.warn("[Year3000System] EnhancedMasterAnimationCoordinator not available for enhanced registration phase"),this._initializationResults=e,this.initialized=!0;let i=performance.now();this._lastInitializationTime=i-t,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&(console.log(`[Year3000System] System initialization complete in ${this._lastInitializationTime.toFixed(2)}ms.`),console.log(`[Year3000System] Results: ${e.success.length} success, ${e.failed.length} failed.`),e.failed.length>0&&console.warn(`[Year3000System] Failed systems: ${e.failed.join(", ")}`),e.skipped&&e.skipped.length>0&&console.info(`[Year3000System] Skipped systems: ${e.skipped.join(", ")}`),e.success.length>0&&console.info(`[Year3000System] Successful systems: ${e.success.join(", ")}`),this.systemHealthMonitor&&this.systemHealthMonitor.logHealthReport())}async _initializeEssentialFacadeSystems(){if(!this.facadeCoordinator)throw new Error("Facade coordinator not available for essential system initialization");this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing essential systems for degraded mode...");try{let t=["SimplePerformanceCoordinator","UnifiedCSSVariableManager","UnifiedDebugManager","DeviceCapabilityDetector","TimerConsolidationSystem"];for(let e of t)try{let i=await this.facadeCoordinator.getNonVisualSystem(e);i&&typeof i.initialize=="function"&&(await i.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] Essential: Initialized ${e} via facade`))}catch(i){console.error(`\u{1F30C} [Year3000System] Failed to initialize essential ${e}:`,i)}this.performanceAnalyzer&&(this.performanceAnalyzer.startMonitoring(),this.performanceGuardActive=!0,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Essential: Performance monitoring started"))}catch(t){throw console.error("\u{1F30C} [Year3000System] Essential facade system initialization failed:",t),t}}async _initializeFacadeSystems(){if(!this.facadeCoordinator)throw new Error("Facade coordinator not available for system initialization");this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing essential systems through facades...");try{let t=["SimplePerformanceCoordinator","UnifiedDebugManager","SettingsManager","DeviceCapabilityDetector","TimerConsolidationSystem"],e=["UnifiedCSSVariableManager","UnifiedPerformanceCoordinator"],i=["MusicSyncService","ColorHarmonyEngine","GenreGradientEvolution","MusicEmotionAnalyzer"],a=["GlassmorphismManager","Card3DManager"];this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing foundation systems in parallel...");let r=t.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(r),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing dependent systems in parallel...");let n=e.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(n),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing event-driven systems in parallel...");let s=i.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(s),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing UI systems in parallel...");let o=a.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(o);try{await _i.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] ColorOrchestrator initialized for strategy pattern coordination")}catch(d){console.error("\u{1F3A8} [Year3000System] Failed to initialize ColorOrchestrator:",d)}this.performanceAnalyzer&&(this.performanceAnalyzer.startMonitoring(),this.performanceGuardActive=!0,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Performance monitoring started"));let c=["Particle","WebGLBackground","SpotifyUIApplication","OrganicBeatSync","HeaderVisualEffects","InteractionTracking"];this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing visual systems in parallel...");let m=c.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=this.facadeCoordinator.getVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 Visual ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize visual ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(m),await this._linkSystemDependencies(),await this._validateFacadeIntegration(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Facade system initialization complete")}catch(t){throw console.error("\u{1F30C} [Year3000System] Facade system initialization failed:",t),t}}async _validateFacadeIntegration(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F50D} [Year3000System] Performing facade integration validation...");let t={cssControllerAlias:!1,strategyPatternSystems:!1,parallelInitialization:!1,facadeHealthCheck:!1,errors:[]};try{if(this.facadeCoordinator){try{let s=await this.facadeCoordinator.getNonVisualSystem("UnifiedCSSVariableManager"),o=await this.facadeCoordinator.getNonVisualSystem("OptimizedCSSVariableManager");s&&o?(t.cssControllerAlias=!0,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u2713 [Validation] CSS Controller alias registration working")):t.errors.push("CSS Controller alias registration failed")}catch(s){t.errors.push(`CSS Controller validation error: ${s}`)}let a=["ColorHarmonyEngine","GenreGradientEvolution","MusicEmotionAnalyzer"],r=0;for(let s of a)try{await this.facadeCoordinator.getNonVisualSystem(s)&&r++}catch(o){t.errors.push(`Strategy system ${s} not found: ${o}`)}t.strategyPatternSystems=r===a.length,t.strategyPatternSystems&&this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u2713 [Validation] Strategy pattern systems registration working");let n=performance.now();try{let s=await this.facadeCoordinator.getNonVisualSystem("PerformanceAnalyzer"),c=performance.now()-n;t.parallelInitialization=c<100,t.parallelInitialization&&this.ADVANCED_SYSTEM_CONFIG.enableDebug?console.log(`\u2713 [Validation] Parallel initialization optimization working (${c.toFixed(2)}ms)`):this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.warn(`\u26A0 [Validation] Initialization may be slow (${c.toFixed(2)}ms)`)}catch(s){t.errors.push(`Parallel initialization test failed: ${s}`)}try{let s=await this.facadeCoordinator.performHealthCheck();t.facadeHealthCheck=s.overall==="excellent"||s.overall==="good",t.facadeHealthCheck&&this.ADVANCED_SYSTEM_CONFIG.enableDebug?console.log(`\u2713 [Validation] Facade health check passed (${s.overall})`):(t.errors.push(`Facade health check failed: ${s.overall}`),s.recommendations?.length>0&&console.warn("\u{1F527} [Validation] Health recommendations:",s.recommendations))}catch(s){t.errors.push(`Facade health check error: ${s}`)}}else t.errors.push("Facade coordinator not available for validation");let e=4,i=[t.cssControllerAlias,t.strategyPatternSystems,t.parallelInitialization,t.facadeHealthCheck].filter(Boolean).length;this.ADVANCED_SYSTEM_CONFIG.enableDebug&&(console.log(`\u{1F50D} [Year3000System] Facade validation complete: ${i}/${e} tests passed`),t.errors.length>0&&console.warn("\u26A0 [Year3000System] Validation errors:",t.errors),i===e&&console.log("\u{1F389} [Year3000System] All facade integration fixes validated successfully!")),window.Y3K_FACADE_VALIDATION=t}catch(e){console.error("\u{1F50D} [Year3000System] Facade validation failed:",e),t.errors.push(`Validation process error: ${e}`)}}async _linkSystemDependencies(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Linking system dependencies...");try{if(this.musicSyncService&&this.colorHarmonyEngine&&(this.musicSyncService.setColorHarmonyEngine(this.colorHarmonyEngine),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] ColorHarmonyEngine linked to MusicSyncService")),this.colorHarmonyEngine&&this.enhancedMasterAnimationCoordinator&&(this.colorHarmonyEngine.setEmergentEngine(this.enhancedMasterAnimationCoordinator),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] EnhancedMasterAnimationCoordinator (with adaptive functionality) linked to ColorHarmonyEngine")),this.systemHealthMonitor){let t=[{name:"MusicSyncService",system:this.musicSyncService},{name:"ColorHarmonyEngine",system:this.colorHarmonyEngine},{name:"SettingsManager",system:this.settingsManager}];for(let{name:e,system:i}of t)i&&this.systemHealthMonitor.registerSystem(e,i);this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Systems registered with health monitor")}}catch(t){console.error("\u{1F30C} [Year3000System] Failed to link system dependencies:",t)}}_shouldSkipPredictionSystem(t){return!1}async _initializeVisualSystems(t){if(!this.performanceAnalyzer||!this.musicSyncService||!this.settingsManager){console.error("[Year3000System] Cannot initialize visual systems due to missing core dependencies (SimplePerformanceCoordinator, MusicSyncService, or SettingsManager)."),["InteractionTrackingSystem","BeatSyncVisualSystem","SidebarSystemsIntegration"].forEach(i=>t.skipped.push(i));return}this.colorHarmonyEngine&&this.enhancedMasterAnimationCoordinator&&(this.colorHarmonyEngine.setEmergentEngine(this.enhancedMasterAnimationCoordinator),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F517} [Year3000System] EnhancedMasterAnimationCoordinator (adaptive functionality) linked to ColorHarmonyEngine."))}async destroyAllSystems(){this.facadeCoordinator&&(await this.facadeCoordinator.destroy(),this.facadeCoordinator=null),this._initializationResults=null,Spicetify.Player&&this._songChangeHandler&&Spicetify.Player.removeEventListener("songchange",this._songChangeHandler),this.initialized=!1,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F525} [Year3000System] All systems have been destroyed."),document.removeEventListener("year3000SystemSettingsChanged",this._boundExternalSettingsHandler),document.removeEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),document.removeEventListener("visibilitychange",this._boundVisibilityChangeHandler),this._disposeNowPlayingWatcher&&(this._disposeNowPlayingWatcher(),this._disposeNowPlayingWatcher=null)}async applyInitialSettings(t){if(!this.settingsManager){console.warn("[Year3000System] SettingsManager not ready, cannot apply initial settings.");return}this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F3A8} [Year3000System] Inside applyInitialSettings. Trigger: ${t||"full"}, SettingsManager valid:`,!!this.settingsManager);try{if(t==="flavor"||t==="brightness"||t==="accent"){console.log(`\u{1F3A8} [Year3000System] Selective update for trigger: ${t}`),await this.updateColorStateOnly(t),await this.refreshColorDependentSystems(t);return}if(console.log("\u{1F3A8} [Year3000System] applyInitialSettings: Getting initial settings..."),this.colorStateManager&&!this.colorStateManager.initialized&&(console.log("\u{1F3A8} [Year3000System] Initializing ColorStateManager..."),await this.colorStateManager.initialize()),this.colorStateManager?.initialized)console.log("\u{1F3A8} [Year3000System] Applying initial color state via ColorStateManager..."),await this.colorStateManager.applyInitialColorState();else{console.warn("\u{1F3A8} [Year3000System] ColorStateManager not available, using legacy color application");let c=this.settingsManager.get("catppuccin-accentColor");c!=="dynamic"&&await this._applyCatppuccinAccent(c)}let e=this.settingsManager.get("sn-gradient-intensity"),i=e,a=this.settingsManager.get("sn-harmonic-intensity"),r=this.settingsManager.get("sn-harmonic-evolution"),n=this.settingsManager.get("sn-current-harmonic-mode");n&&(this.ADVANCED_SYSTEM_CONFIG.currentColorHarmonyMode=String(n)),console.log(`\u{1F3A8} [Year3000System] applyInitialSettings: Gradient=${e}, Stars=${i}, ColorState=${!!this.colorStateManager?.initialized}`),await this._applyStarryNightSettings(e,i);let s=parseFloat(a);Number.isNaN(s)||(this.colorHarmonyEngine&&this.colorHarmonyEngine.setIntensity?.(s),this.ADVANCED_SYSTEM_CONFIG.colorHarmonyIntensity=s);let o=r==="true";this.allowHarmonicEvolution=o,this.ADVANCED_SYSTEM_CONFIG.colorHarmonyEvolution=o,console.log("\u{1F3A8} [Year3000System] applyInitialSettings: Successfully applied initial settings.")}catch(e){console.error("[Year3000System] Error applying initial settings:",e)}}async updateColorStateOnly(t){if(!this.colorStateManager?.initialized){console.warn(`\u{1F3A8} [Year3000System] ColorStateManager not available for ${t} update`);return}console.log(`\u{1F3A8} [Year3000System] Updating color state for trigger: ${t}`),await this.colorStateManager.updateColorState(t)}async refreshColorDependentSystems(t){if(!this.facadeCoordinator){console.warn(`\u{1F3A8} [Year3000System] No facade coordinator available for ${t} refresh`);return}console.log(`\u{1F3A8} [Year3000System] Refreshing color-dependent systems for trigger: ${t}`),await this.facadeCoordinator.refreshColorDependentSystems(t)}async _applyCatppuccinAccent(t){if(t==="dynamic"){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] _applyCatppuccinAccent: 'dynamic' accent selected \u2013 skipping static accent overrides.");return}console.log(`\u{1F3A8} [Year3000System] _applyCatppuccinAccent: Applying accent color '${t}'`);let e=t==="none"?"text":t,i=Spicetify.Config.color_scheme||"mocha",a=document.querySelector("body > script.marketplaceScript")?`url('https://github.com/catppuccin/spicetify/blob/main/catppuccin/assets/${i}/equalizer-animated-${e}.gif?raw=true')`:`url('${i}/equalizer-animated-${e}.gif')`;this.cssVariableController?.queueCSSVariableUpdate("--spice-text",`var(--spice-${e})`),this.cssVariableController?.queueCSSVariableUpdate("--spice-button-active",`var(--spice-${e})`),this.cssVariableController?.queueCSSVariableUpdate("--spice-equalizer",a),this.cssVariableController?.flushCSSVariableBatch(),console.log("\u{1F3A8} [Year3000System] _applyCatppuccinAccent: Flushed CSS variables for accent color.")}async _applyStarryNightSettings(t,e){try{Ut(t,e)}catch{console.error("[Year3000System] Failed to apply starry night settings")}}applyColorsToTheme(t={}){let e=t;if(this.colorHarmonyEngine)try{e=this.colorHarmonyEngine.blendWithCatppuccin(t)}catch(r){console.error("[Year3000System] ColorHarmonyEngine blend failed:",r)}let i=e.accentHex||e.VIBRANT||e.PROMINENT||Object.values(e)[0]||"#37416b",a=e.accentRgb||(()=>{let r=this.utils.hexToRgb(i);return r?`${r.r},${r.g},${r.b}`:"166,173,200"})();this._applyColorsViaFacadeSystem(e,i,a)}handleColorHarmonizedEvent(t){if(this.colorEventState.isProcessingColorEvent){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.warn("\u{1F504} [Year3000System] Already processing color event - skipping to prevent recursion");return}let e=JSON.stringify(t).substring(0,100),i=this._generateEventHash(e),a=Date.now();if(this.colorEventState.processedEvents.has(i)){let r=this.colorEventState.processedEvents.get(i);if(a-r<this.COLOR_EVENT_CACHE_TTL){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.warn("\u{1F504} [Year3000System] Event recently processed - skipping duplicate");return}}this.colorEventState.isProcessingColorEvent=!0,this.colorEventState.processedEvents.set(i,a),this.colorEventState.eventTimeout=window.setTimeout(()=>{this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.warn("\u{1F504} [Year3000System] Color event processing timeout - resetting state"),this._resetColorEventState()},this.PROCESSING_TIMEOUT);try{if(this.processingState.processingChain.push("handleColorHarmonizedEvent"),this.processingState.processingChain.length>this.MAX_CHAIN_LENGTH){this.processingState.eventLoopDetected=!0,console.error("\u{1F504} [Year3000System] CRITICAL: Event loop detected - chain length exceeded",this.processingState.processingChain),this._resetProcessingState();return}let r,n,s,o,c;if(t.processedColors&&t.accentHex&&t.accentRgb)r=t.processedColors,n=t.accentHex,s=t.accentRgb,o=t.strategies||["ColorHarmonyEngine"],c=t.processingTime||0;else if(t.payload&&t.payload.processedColors)r=t.payload.processedColors,n=t.payload.accentHex||Object.values(r)[0]||"#a6adc8",s=this.utils.hexToRgb(n)?.r+","+this.utils.hexToRgb(n)?.g+","+this.utils.hexToRgb(n)?.b||"166,173,200",o=[t.payload.metadata?.strategy||"Unknown"],c=t.payload.metadata?.processingTime||0;else{if(t.type==="colors/harmonized")return;this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.warn("\u{1F3A8} [Year3000System] Unrecognized colors:harmonized event format:",t);return}this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Processing colors:harmonized event:",{strategies:o,processingTime:c,colorsCount:Object.keys(r).length,accentHex:n,accentRgb:s,chainLength:this.processingState.processingChain.length}),this._applyColorsViaFacadeSystem(r,n,s)}catch(r){console.error("[Year3000System] Failed to handle colors:harmonized event:",r)}finally{this._resetColorEventState();let r=this.processingState.processingChain.indexOf("handleColorHarmonizedEvent");r>-1&&this.processingState.processingChain.splice(r,1)}}_generateEventHash(t){let e=0;for(let i=0;i<t.length;i++){let a=t.charCodeAt(i);e=(e<<5)-e+a,e=e&e}return e.toString()}_resetColorEventState(){this.colorEventState.isProcessingColorEvent=!1,this.colorEventState.eventTimeout&&(clearTimeout(this.colorEventState.eventTimeout),this.colorEventState.eventTimeout=null);let t=Date.now();for(let[e,i]of this.colorEventState.processedEvents.entries())t-i>this.COLOR_EVENT_CACHE_TTL&&this.colorEventState.processedEvents.delete(e)}_resetProcessingState(){this.processingState.isProcessingSongChange=!1,this.processingState.processingChain=[],this.processingState.eventLoopDetected=!1,this.processingState.lastProcessingTime=Date.now(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F504} [Year3000System] Processing state reset")}_applyColorsViaFacadeSystem(t,e,i){try{let a={};Object.entries(t).forEach(([n,s])=>{if(this.utils.isValidHexColor(s)){let o=this.utils.hexToRgb(s);o&&(a[`--sn-processed-${n.toLowerCase()}-hex`]=s,a[`--sn-processed-${n.toLowerCase()}-rgb`]=`${o.r},${o.g},${o.b}`)}else this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.debug(`[Year3000System] Skipping non-hex processedColor: ${n}=${s}`)});let r={"--sn-musical-harmony-primary-rgb":t.VIBRANT||t.PRIMARY||i,"--sn-musical-harmony-secondary-rgb":t.DARK_VIBRANT||t.SECONDARY||i,"--sn-musical-harmony-tertiary-rgb":t.VIBRANT_NON_ALARMING||t.LIGHT_VIBRANT||i,"--sn-musical-harmony-quaternary-rgb":t.DESATURATED||t.EMOTIONAL_BLEND||i,"--sn-musical-harmony-primary-hex":t.VIBRANT||t.PRIMARY||e,"--sn-musical-harmony-secondary-hex":t.DARK_VIBRANT||t.SECONDARY||e,"--sn-musical-harmony-tertiary-hex":t.VIBRANT_NON_ALARMING||t.LIGHT_VIBRANT||e,"--sn-musical-harmony-quaternary-hex":t.DESATURATED||t.EMOTIONAL_BLEND||e,"--sn-musical-oklab-primary-rgb":t.VIBRANT||t.PRIMARY||t.PROMINENT||i,"--sn-musical-oklab-accent-rgb":t.DARK_VIBRANT||t.DESATURATED||i,"--sn-musical-oklab-highlight-rgb":t.VIBRANT_NON_ALARMING||t.LIGHT_VIBRANT||i,"--sn-musical-oklab-shadow-rgb":t.DARK_VIBRANT||t.DESATURATED||i,"--sn-musical-oklab-complementary-rgb":t.SECONDARY||t.EMOTIONAL_BLEND||i,"--sn-musical-oklab-triadic-rgb":t.LIGHT_VIBRANT||t.VIBRANT_NON_ALARMING||i};Object.entries(r).forEach(([n,s])=>{if(!(!s||typeof s!="string")){if(n.includes("-hex"))a[n]=s;else if(n.includes("-rgb"))if(this.utils.isValidHexColor(s)){let o=this.utils.hexToRgb(s);o&&(a[n]=`${o.r},${o.g},${o.b}`)}else s.includes(",")&&(a[n]=s)}}),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Musical Harmony Color Processing:",{colorHarmonyKeys:Object.keys(t),colorHarmonyValues:t,musicalHarmonyVariables:r,expectedCSSChain:["--sn-musical-oklab-primary-rgb","--sn-musical-harmony-primary-rgb","--sn-gradient-primary-rgb"],totalVariablesSet:Object.keys(a).length,cssAuthorityDelegation:"ColorStateManager + DynamicCatppuccinBridge"}),this.cssVariableController&&typeof this.cssVariableController.batchSetVariables=="function"?this.cssVariableController.batchSetVariables("Year3000System-ColorHarmonized",a,"high","color-harmony-event-application"):this._applyCSSVariables(a),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F527} [Year3000System] Applied musical harmony variables via CSS coordination:",{totalVariables:Object.keys(a).length,accentColor:e,cssControllerUsed:!!this.cssVariableController,spicetifyDelegation:"ColorStateManager + DynamicCatppuccinBridge handle --spice-* variables"})}catch(a){console.error("[Year3000System] Failed to apply musical harmony variables:",a);let r={"--sn-musical-harmony-primary-hex":e,"--sn-musical-harmony-primary-rgb":i};this._applyCSSVariables(r)}}_applyCSSVariables(t){try{let e=document.documentElement;for(let[i,a]of Object.entries(t))i&&a&&e.style.setProperty(i,a);this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Applied CSS variables directly",{variablesCount:Object.keys(t).length,variables:Object.keys(t)})}catch(e){console.error("[Year3000System] Failed to apply CSS variables:",e)}}queueCSSVariableUpdate(t,e,i=null){this.unifiedCSSManager?this.unifiedCSSManager.queueUpdate(t,e,"normal","Year3000System"):this.cssVariableController?this.cssVariableController.queueCSSVariableUpdate(t,e,i||void 0):(i||document.documentElement).style.setProperty(t,e)}setGradientParameters(){this.colorHarmonyEngine}async updateColorsFromCurrentTrack(){this.musicSyncService&&await this.musicSyncService.processSongUpdate()}evolveHarmonicSignature(t,e){if(this.colorHarmonyEngine){let i=this.utils.hexToRgb(e);if(i){let a=this.colorHarmonyEngine.generateHarmonicVariations(i);return{derivedDarkVibrantHex:a.darkVibrantHex,derivedLightVibrantHex:a.lightVibrantHex}}}return null}async waitForTrackData(t=10,e=100){for(let i=0;i<t;i++){if(Spicetify.Player.data?.track?.uri)return Spicetify.Player.data;await this.utils.sleep(e)}return null}updateHarmonicBaseColor(t){if(this.colorHarmonyEngine&&this.cssVariableController){let e=this.utils.hexToRgb(t);if(e){let i=this.colorHarmonyEngine.generateHarmonicVariations(e);this.cssVariableController.queueCSSVariableUpdate("--sn-harmonic-base-dark-vibrant",i.darkVibrantHex),this.cssVariableController.queueCSSVariableUpdate("--sn-harmonic-base-light-vibrant",i.lightVibrantHex),this.cssVariableController.flushCSSVariableBatch()}}}async processColorsViaFacade(t){try{let e=await this.facadeCoordinator?.getNonVisualSystem("ColorOrchestrator");e&&typeof e.handleColorExtraction=="function"?(await e.handleColorExtraction(t),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Color processing routed through facade pattern - ColorOrchestrator",{context:t?.trackUri||"unknown",rawColorsCount:t?.rawColors?Object.keys(t.rawColors).length:0})):this.colorHarmonyEngine&&typeof this.colorHarmonyEngine.processColors=="function"?(await this.colorHarmonyEngine.processColors(t),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Color processing fallback to direct ColorHarmonyEngine")):console.warn("[Year3000System] No color processing system available via facade pattern")}catch(e){console.error("[Year3000System] Failed to process colors via facade pattern:",e),t?.rawColors&&this.applyColorsToTheme(t.rawColors)}}setupMusicAnalysisAndColorExtraction(){if(console.log("\u{1F3B5} [Year3000System] setupMusicAnalysisAndColorExtraction called"),!this.musicSyncService){console.error("[Year3000System] MusicSyncService is not available to set up song change handler.");return}if(console.log("\u{1F3B5} [Year3000System] MusicSyncService available, checking Spicetify Player..."),!window.Spicetify?.Player){console.warn("[Year3000System] Spicetify.Player not available - music analysis disabled");return}try{p.subscribe("colors:harmonized",e=>{this.handleColorHarmonizedEvent(e)},"Year3000System"),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Subscribed to colors:harmonized events for event-driven color application")}catch(e){console.error("[Year3000System] Failed to subscribe to colors:harmonized events:",e)}let t=async()=>{console.log("\u{1F3B5} [Year3000System] processSongUpdate triggered - checking MusicSyncService..."),this.musicSyncService?(console.log("\u{1F3B5} [Year3000System] Calling musicSyncService.processSongUpdate()"),await this.musicSyncService.processSongUpdate(),console.log("\u2705 [Year3000System] musicSyncService.processSongUpdate() completed")):console.error("\u274C [Year3000System] MusicSyncService not available in processSongUpdate")};this._songChangeHandler=t;try{console.log("\u{1F3B5} [Year3000System] Adding songchange event listener..."),window.Spicetify.Player.addEventListener("songchange",this._songChangeHandler),console.log("\u2705 [Year3000System] Music analysis and color extraction set up successfully - song change listener active"),console.log("\u{1F3B5} [Year3000System] Triggering initial song processing..."),setTimeout(t,1e3)}catch(e){console.error("[Year3000System] Failed to set up music analysis:",e),this._songChangeHandler=null}}updateFromMusicAnalysis(t,e,i){t&&this._updateGlobalKinetics(t)}_updateGlobalKinetics(t){let e=this.utils.getRootStyle();if(!e)return;let i=(c,m=0)=>Number.isFinite(c)?c:m,a=i(t.processedEnergy),r=i(t.valence),n=i(t.enhancedBPM),s=i(t.beatInterval),o=i(t.animationSpeedFactor,1);e.style.setProperty("--sn-kinetic-energy",a.toFixed(3)),e.style.setProperty("--sn-kinetic-valence",r.toFixed(3)),e.style.setProperty("--sn-kinetic-bpm",n.toFixed(2)),e.style.setProperty("--sn-kinetic-beat-interval",`${s.toFixed(0)}ms`),e.style.setProperty("--sn-kinetic-animation-speed",o.toFixed(3))}registerAnimationSystem(t,e,i="normal",a=60){return this.enhancedMasterAnimationCoordinator?(this.enhancedMasterAnimationCoordinator.registerAnimationSystem(t,e,i,a),!0):(console.warn(`[Year3000System] Cannot register ${t} - EnhancedMasterAnimationCoordinator not ready`),!1)}unregisterAnimationSystem(t){return this.enhancedMasterAnimationCoordinator?(this.enhancedMasterAnimationCoordinator.unregisterAnimationSystem(t),!0):!1}getSystem(t){if(!t)return null;if(this.facadeCoordinator){let i=this.facadeCoordinator.getVisualSystem(t);if(i)return i;let a=this.facadeCoordinator.getCachedNonVisualSystem(t);if(a)return a}let e=t.charAt(0).toLowerCase()+t.slice(1);if(this[e])return this[e];for(let i of Object.keys(this)){let a=this[i];if(a&&a.constructor?.name===t)return a}return null}async getFacadeSystemHealthStatus(){return this.facadeCoordinator?await this.facadeCoordinator.performHealthCheck():null}async _registerAnimationSystems(){if(!this.enhancedMasterAnimationCoordinator){console.warn("[Year3000System] EnhancedMasterAnimationCoordinator not available for visual system registration");return}let t=[{name:"BeatSyncVisualSystem",system:this.beatSyncVisualSystem,priority:"critical"},{name:"SidebarSystemsIntegration",system:this.sidebarSystemsIntegration,priority:"normal"},{name:"ParticleConsciousnessModule",system:this.particleVisualEffectsModule,priority:"background"},{name:"InteractionTrackingSystem",system:this.interactionTrackingSystem,priority:"background"},{name:"SpotifyUIApplicationSystem",system:this.spotifyUIApplicationSystem,priority:"normal"}];for(let{name:e,system:i,priority:a}of t)if(i&&(typeof i.onAnimate=="function"||typeof i.updateAnimation=="function")){let r=a,n=60,s=i.currentPerformanceProfile;if(s?.frameRate)n=s.frameRate;else if(s?.quality){let o=s.quality;n=o==="high"?60:o==="low"?30:45}e.includes("BeatSync")?r="critical":(e.includes("Particle")||e.includes("DataGlyph"))&&(r="background",n=Math.min(n,30)),this.enhancedMasterAnimationCoordinator.registerAnimationSystem(e,i,r,n),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F3AC} [Year3000System] Registered ${e} with Enhanced Master Animation Coordinator (${r} priority, ${n}fps) - using ${typeof i.onAnimate=="function"?"onAnimate":"updateAnimation"} hook`)}}async _registerEnhancedAnimationSystems(){if(!this.enhancedMasterAnimationCoordinator){console.warn("[Year3000System] EnhancedMasterAnimationCoordinator not available for enhanced visual system registration");return}let t=[{name:"BeatSyncVisualSystem",system:this.beatSyncVisualSystem,priority:"critical",type:"animation"},{name:"SidebarSystemsIntegration",system:this.sidebarSystemsIntegration,priority:"normal",type:"animation"},{name:"ParticleConsciousnessModule",system:this.particleVisualEffectsModule,priority:"background",type:"animation"},{name:"InteractionTrackingSystem",system:this.interactionTrackingSystem,priority:"background",type:"animation"},{name:"SpotifyUIApplicationSystem",system:this.spotifyUIApplicationSystem,priority:"normal",type:"animation"}];for(let{name:e,system:i,priority:a,type:r}of t)if(i)try{let n=!1;r==="animation"&&(typeof i.onAnimate=="function"||typeof i.updateAnimation=="function")&&(n=this.enhancedMasterAnimationCoordinator.registerAnimationSystem(e,i,a,60)),n&&this.ADVANCED_SYSTEM_CONFIG.enableDebug?console.log(`\u{1F3AC} [Year3000System] Enhanced registration: ${e} (${a} priority, ${r} type)`):n||console.warn(`[Year3000System] Failed to register ${e} with EnhancedMasterAnimationCoordinator`)}catch(n){console.error(`[Year3000System] Error registering ${e} with EnhancedMasterAnimationCoordinator:`,n)}}async initializeWithAvailableAPIs(t){this.availableAPIs=t,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&(console.log(`\u{1F31F} [Year3000System] Progressive initialization mode: ${t.degradedMode?"DEGRADED":"FULL"}`),console.log("\u{1F31F} [Year3000System] Available APIs:",{player:!!t.player,platform:!!t.platform,config:!!t.config})),t.degradedMode?(console.log("\u{1F31F} [Year3000System] Initializing in degraded mode (visual-only systems)"),await this.initializeVisualOnlySystems()):(console.log("\u{1F31F} [Year3000System] Initializing in full mode (all systems)"),await this.initializeAllSystems()),t.degradedMode&&this.setupProgressiveEnhancement()}async initializeVisualOnlySystems(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Starting visual-only system initialization...");let t=performance.now(),e={success:[],failed:[],skipped:[]};try{this.facadeCoordinator=new zt(this.ADVANCED_SYSTEM_CONFIG,this.utils,this),await this.facadeCoordinator.initialize({mode:"performance-optimized",enableSharedDependencies:!0,enableCrossFacadeCommunication:!1,enableUnifiedPerformanceMonitoring:!0,enableResourceOptimization:!0,performanceThresholds:{maxTotalMemoryMB:50,maxTotalInitTime:3e3,maxCrossCommLatency:100},coordinationPreferences:{preferSharedResources:!0,enableEventPropagation:!1,enableHealthCoordination:!0}}),await this._initializeEssentialFacadeSystems(),e.success.push("FacadeCoordinationSystem")}catch(n){console.error("\u{1F30C} [Year3000System] Failed to initialize degraded facade system:",n),e.failed.push("FacadeCoordinationSystem")}let i=["SettingsManager","MusicSyncService","ColorHarmonyEngine","GlassmorphismManager","Card3DManager","All Visual Systems"];e.skipped.push(...i),this._initializationResults=e,this.initialized=!0;let r=performance.now()-t;this.ADVANCED_SYSTEM_CONFIG.enableDebug&&(console.log(`\u{1F31F} [Year3000System] Visual-only initialization complete in ${r.toFixed(2)}ms`),console.log(`\u{1F31F} [Year3000System] Results: ${e.success.length} success, ${e.failed.length} failed, ${e.skipped.length} skipped`))}setupProgressiveEnhancement(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Setting up progressive enhancement monitoring...");let t=0,e=30,i=setInterval(()=>{t++;let a=!!window.Spicetify?.Player,r=!!window.Spicetify?.Platform;a&&r&&this.availableAPIs?.degradedMode&&(this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] APIs now available! Triggering upgrade to full mode..."),clearInterval(i),this.upgradeToFullMode().catch(n=>{console.error("[Year3000System] Upgrade to full mode failed:",n)})),t>=e&&(this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Progressive enhancement monitoring stopped (timeout)"),clearInterval(i))},2e3)}async upgradeToFullMode(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Upgrading from degraded mode to full mode..."),this.availableAPIs={player:window.Spicetify?.Player,platform:window.Spicetify?.Platform,config:window.Spicetify?.Config,degradedMode:!1};try{let t={success:[],failed:[],skipped:[]};try{this.systemHealthMonitor&&this.systemHealthMonitor.registerSystem("SettingsManager",this.settingsManager),t.success.push("SettingsManager")}catch(e){t.failed.push("SettingsManager"),console.error("[Year3000System] Failed to upgrade SettingsManager:",e)}if(this.settingsManager)try{}catch{}if(this.performanceAnalyzer&&this.settingsManager){try{}catch{}this.enhancedMasterAnimationCoordinator&&await this._registerAnimationSystems()}this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("[Year3000System] Checking music analysis setup conditions:",{musicSyncService:!!this.musicSyncService,playerAPI:!!this.availableAPIs.player,musicSyncInitialized:this.musicSyncService?.initialized}),this.musicSyncService&&this.availableAPIs.player?(console.log("\u{1F3B5} [Year3000System] Setting up music analysis and color extraction..."),this.setupMusicAnalysisAndColorExtraction()):console.warn("\u26A0\uFE0F [Year3000System] Music analysis setup skipped - missing dependencies:",{musicSyncService:!!this.musicSyncService,playerAPI:!!this.availableAPIs.player}),this.settingsManager&&await this.applyInitialSettings(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&(console.log(`\u{1F31F} [Year3000System] Upgrade complete: ${t.success.length} success, ${t.failed.length} failed`),t.failed.length>0&&console.warn(`\u{1F31F} [Year3000System] Upgrade failed systems: ${t.failed.join(", ")}`),t.skipped&&t.skipped.length>0&&console.info(`\u{1F31F} [Year3000System] Upgrade skipped systems: ${t.skipped.join(", ")}`),t.success.length>0&&console.info(`\u{1F31F} [Year3000System] Upgrade successful systems: ${t.success.join(", ")}`))}catch(t){console.error("[Year3000System] Error during upgrade to full mode:",t)}}_handleExternalSettingsChange(t){let{key:e,value:i}=t.detail||{};if(e){switch(e){case"artisticMode":{try{typeof this.ADVANCED_SYSTEM_CONFIG.safeSetArtisticMode=="function"&&this.ADVANCED_SYSTEM_CONFIG.safeSetArtisticMode(i)}catch(a){console.warn("[Year3000System] Failed to apply artistic mode",a)}break}case"harmonicIntensity":{let a=parseFloat(i);Number.isNaN(a)||(this.ADVANCED_SYSTEM_CONFIG.colorHarmonyIntensity=a,this.colorHarmonyEngine&&(this.colorHarmonyEngine.setIntensity?.(a),this.updateColorsFromCurrentTrack?.()));break}case"harmonicEvolution":{let a=i==="true"||i===!0;this.allowHarmonicEvolution=a,this.ADVANCED_SYSTEM_CONFIG.colorHarmonyEvolution=a;break}case"manualBaseColor":{typeof i=="string"&&i.trim()!==""&&i.startsWith("#")?(this.updateHarmonicBaseColor(i),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Manual base color applied:",i)):this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Manual base color cleared - using album art colors");break}case"harmonicMode":{i!=null&&(this.ADVANCED_SYSTEM_CONFIG.currentColorHarmonyMode=String(i),this.updateColorsFromCurrentTrack?.());break}default:break}this._broadcastSettingChange(e,i),this._refreshConditionalSystems()}}_broadcastSettingChange(t,e){[this.colorHarmonyEngine,this.glassmorphismManager,this.card3DManager,this.lightweightParticleSystem,this.interactionTrackingSystem,this.beatSyncVisualSystem,this.sidebarSystemsIntegration,this.particleFieldSystem].forEach(a=>{if(a&&typeof a.applyUpdatedSettings=="function")try{a.applyUpdatedSettings(t,e)}catch(r){console.warn(`[Year3000System] ${a.systemName||a.constructor?.name||"UnknownSystem"} failed to applyUpdatedSettings`,r)}})}_applyPerformanceProfile(){}_refreshConditionalSystems(){}_onArtisticModeChanged(){try{this.updateColorsFromCurrentTrack?.()}catch(t){console.warn("[Year3000System] _onArtisticModeChanged stub error",t)}}_handleVisibilityChange(){if(document.visibilityState==="hidden")try{this.cssVariableController?.flushCSSVariableBatch?.();try{}catch{}this.ADVANCED_SYSTEM_CONFIG?.enableDebug&&console.log("\u{1F31F} [Year3000System] Visibility hidden \u2192 forced flush of pending style updates")}catch(t){this.ADVANCED_SYSTEM_CONFIG?.enableDebug&&console.warn("[Year3000System] VisibilityChange flush error",t)}}async destroy(){try{await this.destroyAllSystems(),document.removeEventListener("visibilitychange",this._handleVisibilityChange.bind(this)),this.initialized=!1,console.log("\u{1F31F} [AdvancedThemeSystem] System destroyed successfully")}catch(t){console.error("\u274C [AdvancedThemeSystem] Error during destroy:",t)}}},wr=new Ot;typeof window<"u"&&(window.advancedThemeSystem=wr,window.year3000System=wr);Ws=wr});var Xs={};te(Xs,{enableDragCartography:()=>Yl,getDragMap:()=>jl});function Yl(){let l=globalThis;l.__SN_dragCartographer||(l.__SN_dragCartographer=new ta,console.info("\u{1F6F0}\uFE0F  DragCartographer enabled \u2013 logging dragstart events"))}function jl(){return ta.getDragMap()}var Ke,ta,Zs=y(()=>{"use strict";Ke=class Ke{constructor(){this.seen=new WeakSet;this.handleDragStart=t=>{let e=t.target;if(!e||this.seen.has(e))return;this.seen.add(e);let i=Ke.buildSelectorPath(e),a={time:new Date().toLocaleTimeString(),selector:i};try{let s=t.dataTransfer;if(s){let o=s.getData("text/spotify")||s.getData("text/uri-list");o&&(a.uris=o.split(/\n|,/).filter(Boolean));let c=s.getData("text/plain");c&&(a.label=c)}}catch{}let r=Ke.aggregate,n=r.get(i);n?(n.count+=1,n.samples.length<3&&n.samples.push(a)):r.set(i,{selector:i,count:1,samples:[a]}),console.groupCollapsed(`%c[DragCartographer] dragstart \u2192 ${i}`,"color:#7dd3fc;font-weight:600"),console.table(a),console.log("Event:",t),console.log("Target element snapshot:",e),console.groupEnd()};document.addEventListener("dragstart",this.handleDragStart,!0)}static buildSelectorPath(t){let e=[],i=t,a=0;for(;i&&a<Ke.MAX_PATH_DEPTH;){let r=i.tagName.toLowerCase(),n=i.id?`#${i.id}`:"",s=i.className&&typeof i.className=="string"?"."+i.className.split(/\s+/).slice(0,2).join("."):"";e.push(`${r}${n}${s}`),i=i.parentElement,a+=1}return e.join(" > ")}static getDragMap(){return Array.from(Ke.aggregate.values()).sort((t,e)=>e.count-t.count)}};Ke.MAX_PATH_DEPTH=4,Ke.aggregate=new Map;ta=Ke});function eo(l,t,e={}){let i=`${l}|${t}|${e.size}|${e.dpr}`,a=Js.get(i);if(a)return a;let r=e.size??72,n=e.dpr??(window.devicePixelRatio||1),s=e.borderRadius??8,o=document.createElement("canvas");o.width=r*n,o.height=r*n,o.style.width=`${r}px`,o.style.height=`${r}px`;let c=o.getContext("2d");c.scale(n,n),c.fillStyle="rgba(32,32,35,0.9)",c.roundRect(0,0,r,r,s),c.fill(),e.shadow!==!1&&(c.shadowColor="rgba(0,0,0,0.4)",c.shadowBlur=6);let m=r-16;if(t){let h=new Image;h.src=t;let g=()=>{c.save(),c.beginPath(),c.roundRect(8,8,m,m,s-2),c.clip(),c.drawImage(h,8,8,m,m),c.restore(),d()};h.complete?g():(h.onload=g,h.onerror=d)}else d();function d(){c.fillStyle="#fff",c.font="500 12px Inter, sans-serif",c.textAlign="center",c.textBaseline="middle";let h=r-10,g=l;for(;c.measureText(g).width>h&&g.length>4;)g=g.slice(0,-2);g!==l&&(g=g.slice(0,-1)+"\u2026"),c.fillText(g,r/2,r-10)}return Js.set(i,o),o}var Js,to=y(()=>{"use strict";Js=new Map});var ao={};te(ao,{enableEnhancedDragPreview:()=>ec});function Ql(l,t){try{return eo(l,t)}catch{let e=document.createElement("div");return e.textContent=l,e.style.padding="4px 6px",e.style.fontSize="12px",e.style.background="rgba(32,32,35,0.9)",e.style.color="#fff",e}}function io(l){let t=l.querySelector("img[src]");if(t?.src)return t.src;let e=getComputedStyle(l).backgroundImage,i=e&&/url\("?([^\"]+)"?\)/.exec(e);return i?i[1]:void 0}function Xl(l){let t=l.getAttribute("aria-label")||l.getAttribute("title");return t||(document.createTreeWalker(l,NodeFilter.SHOW_TEXT,{acceptNode(a){return a.textContent?.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}}).nextNode()?.textContent?.trim()||"").slice(0,60)}function Zl(l){if(Ar.has(l))return Ar.get(l);let t=Xl(l);if(!t)return null;let e=io(l),i=e?{label:t,img:e}:{label:t};return Ar.set(l,i),i}function Jl(l){try{if(!l.dataTransfer||typeof l.dataTransfer.setDragImage!="function")return;let t=l.target;if(!t)return;let e=l.dataTransfer.getData("text/plain"),i;if(e)i=io(t);else{let s=Zl(t);if(!s)return;e=s.label,i=s.img}let a=Ql(e,i);document.body.appendChild(a);let r=a.offsetWidth/2;l.dataTransfer.setDragImage(a,r,r);let n=()=>{a.remove(),window.removeEventListener("dragend",n,!0)};window.addEventListener("dragend",n,!0)}catch(t){console.debug("[StarryNight] DragPreviewManager failed:",t)}}function ec(l={}){let t=globalThis;t.__SN_enhancedDragPreview||(t.__SN_enhancedDragPreview=!0,Object.assign(Kl,l),document.addEventListener("dragstart",Jl,!0),console.info("\u{1F320} Enhanced drag preview enabled"))}var Kl,Ar,ro=y(()=>{"use strict";to();Kl={size:72,borderRadius:8,fontSize:12},Ar=new WeakMap});function ia(l){let t=l.stiffness??260,e=l.damping??24,i=l.mass??1,a={},r={},n={},s=null;function o(){let c=!0,m=1/60;for(let d in n){let h=a[d]??0,g=r[d]??0,f=n[d]??0,v=-t*(h-f),C=-e*g,T=(v+C)/i,w=g+T*m,V=h+w*m;r[d]=w,a[d]=V,(Math.abs(w)>.1||Math.abs(V-f)>.1)&&(c=!1)}l.onUpdate(a),c||(s=requestAnimationFrame(o))}return{to(c){n=c,s||(s=requestAnimationFrame(o))}}}var Ir=y(()=>{"use strict";window.snFlipSpringLoaded=!0});function Dr(){let l=document.querySelector(tc);if(!l)return null;let t=l.getBoundingClientRect();return{node:l,rect:t}}function Lr(){let l=!!Dr(),t=typeof Element.prototype.cloneNode=="function",e=!!window.snFlipSpringLoaded;return l&&t&&e}var tc,kr=y(()=>{"use strict";tc='[data-testid="rootlist-container"]'});var oo={};te(oo,{destroySidebarClone:()=>aa,launchSidebarClone:()=>ic});function ic(l){Xe&&(Xe.abort(),Xe=null),Qe&&aa(),Xe=new AbortController;let{signal:t}=Xe;if(Qe)return;let e=Dr();if(!e)return;let i=e.node.cloneNode(!0);i.id="",i.setAttribute("aria-hidden","true"),i.classList.add("sn-clone-overlay"),i.style.position="fixed",i.style.top=`${e.rect.top}px`,i.style.left=`${e.rect.left}px`,i.style.width=`${e.rect.width}px`,i.style.height=`${e.rect.height}px`,i.style.zIndex="9999",i.style.willChange="transform, opacity",i.style.contain="paint",function(f){let v=document.createTreeWalker(f,NodeFilter.SHOW_ELEMENT);for(;v.nextNode();){let C=v.currentNode;C.hasAttribute("aria-label")&&C.removeAttribute("aria-label"),C.tabIndex>=0&&(C.tabIndex=-1)}}(i),document.body.appendChild(i),Qe=i;let a=0,r=0,n=1,s=l.cursorX-e.rect.left-e.rect.width*.2,o=l.cursorY-e.rect.top-e.rect.height*.2,c=.6;if(window.matchMedia("(prefers-reduced-motion: reduce)").matches){i.style.transform=`translate(${s}px, ${o}px) scale(${c})`,so(i,l);return}let d=ia({stiffness:220,damping:20,onUpdate:g=>{t.aborted||(i.style.transform=`translate(${g.x}px, ${g.y}px) scale(${g.s})`)}});i.style.transformOrigin="top left",i.style.transform=`translate(${a}px, ${r}px) scale(${n})`,requestAnimationFrame(()=>d.to({x:s,y:o,s:c}));let h=setTimeout(()=>{!t.aborted&&Qe&&so(Qe,l)},400);t.addEventListener("abort",()=>clearTimeout(h)),t.addEventListener("abort",()=>aa())}function aa(){Rr.forEach(l=>l()),Rr.length=0,Qe&&(Qe.remove(),Qe=null),Xe&&(Xe.abort(),Xe=null)}function ac(l,t){try{let e=window.Spicetify?.CosmosAsync;if(!e)return;let i=`/v1/playlists/${l.split(":").pop()}/tracks`;e.post(i,{uris:t})}catch{}}function so(l,t){let e=Array.from(l.querySelectorAll('[data-uri^="spotify:playlist:"]'));if(!e.length)return;let i=e.slice(0,5);e.slice(5).forEach(r=>{r.classList.add("sn-prune-out"),setTimeout(()=>r.remove(),180)}),i.forEach((r,n)=>{r.setAttribute("data-index",String(n+1)),r.setAttribute("role","button"),r.tabIndex=0,r.style.setProperty("--sn-glow-level","0"),r.style.backgroundImage="paint(sn-aura)",r.addEventListener("mouseenter",()=>r.style.setProperty("--sn-glow-level","1")),r.addEventListener("mouseleave",()=>r.style.setProperty("--sn-glow-level","0"));let s=r.getAttribute("data-uri");if(!s)return;let o=t.uris,c=m=>{m.preventDefault(),m.stopPropagation();let d=r.querySelector("img");rc(s,d?.src||"",r.textContent?.trim()||"Playlist"),ac(s,o),nc("Track added to "+(r.textContent?.trim()||"playlist")),aa()};r.addEventListener("click",c),r.addEventListener("keydown",m=>{(m.key==="Enter"||m.key===" ")&&c(m)})});let a=r=>{let n=parseInt(r.key,10);n>=1&&n<=i.length&&i[n-1]?.click()};window.addEventListener("keydown",a,{capture:!0}),Rr.push(()=>window.removeEventListener("keydown",a,{capture:!0}))}function rc(l,t,e){try{let i=localStorage.getItem(no),a=i?JSON.parse(i):[],r=a.findIndex(n=>n.uri===l);r!==-1&&a.splice(r,1),a.unshift({uri:l,image:t,name:e}),localStorage.setItem(no,JSON.stringify(a.slice(0,10)))}catch{}}function nc(l){let t=document.getElementById("sn-live");t&&(t.textContent=l)}var Qe,Rr,Xe,no,lo=y(()=>{"use strict";Ir();kr();Qe=null,Rr=[],Xe=null,no="sn-recent-playlists"});var uo={};te(uo,{enableQuickAddRadialMenu:()=>Sc});function lc(){let l=document.getElementById(Gr);return l||(l=document.createElement("div"),l.id=Gr,l.setAttribute("aria-live","polite"),l.style.position="absolute",l.style.width="1px",l.style.height="1px",l.style.overflow="hidden",l.style.clipPath="inset(100%)",l.style.clip="rect(1px,1px,1px,1px)",l.style.whiteSpace="nowrap",document.body.appendChild(l)),l}function cc(l,t,e,i){let a=l-e,r=t-i;return Math.sqrt(a*a+r*r)}function co(){try{let l=localStorage.getItem("sn-recent-playlists");if(!l)return[];let t=JSON.parse(l);return Array.isArray(t)?t.slice(0,ra):[]}catch{return[]}}function uc(l,t){try{let e=`/v1/playlists/${l.split(":").pop()}/tracks`;window.Spicetify?.CosmosAsync.post(e,{uris:t})}catch(e){console.warn("[StarryNight] QuickAddRadial failed to add tracks:",e)}}function mc(l){try{let t=co(),e=t.findIndex(a=>a.uri===l.uri);e!==-1&&t.splice(e,1),t.unshift(l);let i=t.slice(0,10);localStorage.setItem("sn-recent-playlists",JSON.stringify(i))}catch{}}function dc(l,t,e){if(!e.length)return;_r(),ce=document.createElement("div"),ce.className="sn-quick-add-overlay",ce.style.position="fixed",ce.style.inset="0",ce.style.pointerEvents="none",ce.style.zIndex="9999";let i=document.createElement("div");i.className="sn-quick-add-center",i.style.position="absolute",i.style.left=`${l}px`,i.style.top=`${t}px`,i.style.width="0",i.style.height="0",ce.appendChild(i),document.body.appendChild(ce);let a=90,r=Math.PI*2/e.length;e.forEach((s,o)=>{let c=r*o-Math.PI/2,m=document.createElement("button");m.className="sn-quick-add-btn",m.style.position="absolute",m.style.width="64px",m.style.height="64px",m.style.borderRadius="50%",m.style.border="2px solid rgba(255,255,255,0.4)",m.style.background=`url('${s.image}') center/cover no-repeat`,m.style.cursor="pointer",m.style.pointerEvents="auto";let d=a*Math.cos(c),h=a*Math.sin(c);m.style.transform=`translate(${d-32}px, ${h-32}px)`,m.style.transformOrigin="center center";let g=0,f=0;m.style.transform=`translate(${g}px, ${f}px) scale(0.1)`,requestAnimationFrame(()=>{ia({stiffness:220,damping:20,onUpdate:C=>{m.style.transform=`translate(${C.x}px, ${C.y}px) scale(${C.s})`}}).to({x:d-32,y:h-32,s:1})}),m.title=`Add to ${s.name}`,m.addEventListener("click",v=>{v.preventDefault(),v.stopPropagation(),jt&&uc(s.uri,jt),mc(s),_r()}),i.appendChild(m)});let n=lc();n.textContent="Quick-add menu open. Press number keys 1 to 5 to pick a playlist or continue dragging."}function _r(){ce?.remove(),ce=null;let l=document.getElementById(Gr);l&&(l.textContent="")}function Hr(){Yt&&(clearTimeout(Yt),Yt=null)}function hc(l){Vr=l.clientX,Br=l.clientY,jt=(l.dataTransfer?.getData("text/spotify")||"").split(/[\n,]/).filter(Boolean);let t=Lr();Hr(),Yt=window.setTimeout(async()=>{if(t)(await Promise.resolve().then(()=>(lo(),oo))).launchSidebarClone({cursorX:Fr.x,cursorY:Fr.y,uris:jt??[]});else{let e=await bc();dc(Vr,Br,e)}},sc)}function gc(){Hr(),_r(),jt=null}function pc(l){Fr={x:l.clientX,y:l.clientY},Yt&&cc(Vr,Br,l.clientX,l.clientY)>oc&&Hr()}async function fc(){try{let l=window.Spicetify?.CosmosAsync;if(!l)return[];let t=await l.get("https://api.spotify.com/v1/me/playlists?limit=10");return t?.items?t.items.slice(0,ra).map(e=>({uri:e.uri,name:e.name,image:e.images?.[0]?.url||""})):[]}catch{return[]}}function yc(){try{let l=Array.from(document.querySelectorAll('[data-testid="rootlist-card"]')),t=[];for(let e of l){let i=e.getAttribute("data-uri")||e.querySelector("a")?.getAttribute("href")?.replace("/playlist/","spotify:playlist:");if(!i)continue;let a=e.querySelector("img"),r=a?.src||"",n=a?.alt||e.textContent?.trim()||"Playlist";if(t.push({uri:i,image:r,name:n}),t.length>=ra)break}return t}catch{return[]}}async function bc(){let l=co();if(l.length)return l;let t=yc();return t.length?t:await fc()}function Sc(){let l=globalThis;l.__SN_quickAddRadial||(l.__SN_quickAddRadial=!0,window.addEventListener("dragstart",hc,!0),window.addEventListener("dragend",gc,!0),window.addEventListener("pointermove",pc,!0),console.info("\u{1F30C} Quick-Add radial menu enabled"),console.info(`[StarryNight] Sidebar clone capability: ${Lr()}`))}var sc,oc,ra,Yt,Vr,Br,ce,jt,Fr,Gr,mo=y(()=>{"use strict";Ir();kr();sc=250,oc=8,ra=5,Yt=null,Vr=0,Br=0,ce=null,jt=null,Fr={x:0,y:0},Gr="sn-live";document.addEventListener("keydown",l=>{if(!ce)return;let t=parseInt(l.key,10);t>=1&&t<=ra&&ce.querySelectorAll(".sn-quick-add-btn")[t-1]?.click()})});var go={};te(go,{PrismaticScrollSheenSystem:()=>na,initializePrismaticScrollSheen:()=>ho});function ho(){try{let l=new na;Ws?.registerVisualSystem?.(l,"background")}catch(l){console.error("[PrismaticScrollSheen] Failed to init:",l)}}var vc,na,po=y(()=>{"use strict";Tr();U();vc=6e3,na=class{constructor(t=vc){this.cyclePx=t;this.systemName="PrismaticScrollSheen";this._lastRatio=-1;let e=globalThis.year3000System;this.cssController=e?.cssController||P(),this.cssController.setVariable("PrismaticScrollSheenSystem","--sn-scroll-cycle-px",String(t),"normal","scroll-cycle-init")}onAnimate(t,e){let i=e.scrollRatio??0;if(Math.abs(i-this._lastRatio)<.001)return;this._lastRatio=i;let a={"--sn-cdf-scroll-ratio":i.toFixed(4),"--sn-scroll-ratio":i.toFixed(4)};this.cssController.batchSetVariables("PrismaticScrollSheenSystem",a,"high","scroll-ratio-update")}onPerformanceModeChange(){}destroy(){}};window.Y3K?.system?.registerVisualSystem&&ho()});var q,fo,sa,yo=y(()=>{"use strict";q=jr(Yr("react")),fo=jr(Yr("react-dom")),sa=class{constructor(t,e,i={}){this.name=t;this.settingsId=e;this.initialSettingsFields=i;this.settingsFields=this.initialSettingsFields;this.setRerender=null;this.pushSettings=async()=>{for(Object.entries(this.settingsFields).forEach(([t,e])=>{e.type!=="button"&&this.getFieldValue(t)===void 0&&this.setFieldValue(t,e.defaultValue)});!window.Spicetify?.Platform?.History?.listen;)await new Promise(t=>setTimeout(t,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=window.Spicetify.Platform.History.listen(t=>{t.pathname==="/preferences"&&this.render()}),window.Spicetify.Platform.History.location.pathname==="/preferences"&&await this.render()};this.rerender=()=>{this.setRerender?.(Math.random())};this.addDropDown=(t,e,i,a,r,n)=>{this.settingsFields[t]={type:"dropdown",description:e,defaultValue:i[a],options:i,events:n}};this.addToggle=(t,e,i,a)=>{this.settingsFields[t]={type:"toggle",description:e,defaultValue:i,events:a}};this.addInput=(t,e,i,a="text",r)=>{this.settingsFields[t]={type:"input",description:e,defaultValue:i,inputType:a,events:r}};this.getFieldValue=t=>{let e=window.Spicetify?.LocalStorage.get(t);if(e==null){let i=`${this.settingsId}.${t}`,a=window.Spicetify?.LocalStorage.get(i);if(a)try{let n=JSON.parse(a)?.value??a;return window.Spicetify?.LocalStorage.set(t,n),window.Spicetify?.LocalStorage.remove(i),n}catch{return a}return}return e};this.FieldsContainer=()=>{let[t,e]=(0,q.useState)(0);return this.setRerender=e,q.default.createElement("div",{className:"x-settings-section",key:t},q.default.createElement("h2",{className:"TypeElement-cello-textBase-type"},this.name),Object.entries(this.settingsFields).map(([i,a])=>q.default.createElement(this.Field,{key:i,nameId:i,field:a})))};this.Field=({nameId:t,field:e})=>{let i=`${this.settingsId}.${t}`,a=e.type==="button"?e.value:this.getFieldValue(t)??e.defaultValue,[r,n]=(0,q.useState)(a),s=m=>{n(m),this.setFieldValue(t,m);try{let d=new CustomEvent("year3000SystemSettingsChanged",{detail:{key:t,value:m}});document.dispatchEvent(d)}catch(d){console.warn(`[SettingsSection] Failed to emit settings change event for ${t}:`,d)}};if(e.type==="hidden")return q.default.createElement(q.default.Fragment,null);let o=q.default.createElement("label",{className:"TypeElement-viola-textSubdued-type",htmlFor:i},e.description||""),c=null;switch(e.type){case"dropdown":c=q.default.createElement("select",{className:"main-dropDown-dropDown",id:i,...e.events,onChange:m=>{let d=m.currentTarget.selectedIndex,h=e.options[d];s(h),e.events?.onChange?.(m)}},e.options.map((m,d)=>q.default.createElement("option",{key:m,value:m,selected:m===r},m)));break;case"toggle":c=q.default.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},q.default.createElement("input",{id:i,className:"x-toggle-input",type:"checkbox",checked:!!r,...e.events,onClick:m=>{let d=m.currentTarget.checked;s(d),e.events?.onClick?.(m)}}),q.default.createElement("span",{className:"x-toggle-indicatorWrapper"},q.default.createElement("span",{className:"x-toggle-indicator"})));break;case"input":c=q.default.createElement("input",{className:"x-settings-input",id:i,dir:"ltr",value:r,type:e.inputType||"text",...e.events,onChange:m=>{s(m.currentTarget.value),e.events?.onChange?.(m)}});break;case"button":c=q.default.createElement("button",{id:i,className:"Button-sc-y0gtbx-0 Button-small-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button",...e.events,onClick:m=>{e.events?.onClick?.(m)},type:"button"},r);break;default:c=null}return q.default.createElement("div",{className:"x-settings-row"},q.default.createElement("div",{className:"x-settings-firstColumn"},o),q.default.createElement("div",{className:"x-settings-secondColumn"},c))}}async render(){for(;!document.getElementById("desktop.settings.selectLanguage");){if(window.Spicetify.Platform.History.location.pathname!=="/preferences")return;await new Promise(i=>setTimeout(i,100))}let t=document.querySelector(".main-view-container__scroll-node-child main div");if(!t)return console.error("[StarryNight] settings container not found");let e=Array.from(t.children).find(i=>i.id===this.settingsId);e||(e=document.createElement("div"),e.id=this.settingsId,t.appendChild(e)),fo.default.render(q.default.createElement(this.FieldsContainer,null),e)}setFieldValue(t,e){window.Spicetify?.LocalStorage.set(t,e)}}});var zr={};te(zr,{initializeStarryNightSettings:()=>Cc});function bo(){return globalThis.year3000System?.cssController||P()}async function Cc(){let l=new sa("StarryNight Theme","starrynight-settings"),t=["dynamic","rosewater","flamingo","pink","mauve","red","maroon","peach","yellow","green","teal","sky","sapphire","blue","lavender"];function e(){let B=window.Y3K?.system?.settingsManager;if(B)return B;let F=globalThis.__SN_settingsManager;if(F)return F;let H=new ae;return globalThis.__SN_settingsManager=H,H}let i=e(),a=i.get("catppuccin-accentColor");l.addDropDown("catppuccin-accentColor","Accent colour (primary theme color)",t,Math.max(0,t.indexOf(a)),void 0,{onChange:B=>{try{let F=B?.currentTarget?.selectedIndex??0,H=t[F]??"mauve";i.set("catppuccin-accentColor",H);let Qt=i.get("sn-gradient-intensity");Ut(Qt,Qt);try{globalThis.Y3K?.system?.applyInitialSettings?.("accent")}catch(oa){console.warn("[StarryNight] Unable to trigger Year3000System colour refresh",oa)}}catch(F){console.error("[StarryNight] Failed to update accent colour",F)}}});let r=["disabled","minimal","balanced","intense"],n=i.get("sn-gradient-intensity");l.addDropDown("sn-gradient-intensity","Background effects intensity (stars, nebula, flow gradients)",r,Math.max(0,r.indexOf(n)),void 0,{onChange:B=>{let F=B?.currentTarget?.selectedIndex??0,H=r[F]??"balanced";i.set("sn-gradient-intensity",H),Ut(H,H)}});let s=["bright","balanced","dark"],o=i.get("sn-brightness-mode")||"balanced";l.addDropDown("sn-brightness-mode","Brightness mode",s,Math.max(0,s.indexOf(o)),void 0,{onChange:B=>{let F=B?.currentTarget?.selectedIndex??0,H=s[F]??"bright";i.set("sn-brightness-mode",H);let Qt=bo(),oa={"--sn-brightness-mode":`"${H}"`,"--sn-brightness-data-attr":H};Qt.batchSetVariables("StarryNightSettings",oa,"high","brightness-mode-change"),document.documentElement.setAttribute("data-sn-brightness",H);try{globalThis.Y3K?.system?.applyInitialSettings?.("brightness"),console.log(`[StarryNight] Brightness mode changed to: ${H}`)}catch(To){console.warn("[StarryNight] Unable to trigger Year3000System brightness refresh",To)}}});let c=["latte","frappe","macchiato","mocha"],m=i.get("catppuccin-flavor");l.addDropDown("catppuccin-flavor","Catppuccin flavour (light/dark theme base)",c,Math.max(0,c.indexOf(m)),void 0,{onChange:B=>{let F=B?.currentTarget?.selectedIndex??0;i.set("catppuccin-flavor",c[F]);try{globalThis.Y3K?.system?.applyInitialSettings?.("flavor")}catch(H){console.warn("[StarryNight] Unable to trigger flavor refresh",H)}}});let d=["catppuccin","year3000"],h=["Catppuccin Classic","Year 3000 Cinematic"],g=i.get("sn-palette-system");l.addDropDown("sn-palette-system","Palette system (color foundation vs enhancement)",h,Math.max(0,d.indexOf(g)),void 0,{onChange:B=>{let F=B?.currentTarget?.selectedIndex??0;i.set("sn-palette-system",d[F]);try{globalThis.Y3K?.system?.applyInitialSettings?.("palette")}catch(H){console.warn("[StarryNight] Unable to trigger palette system refresh",H)}}});let f=["disabled","minimal","moderate","intense"],v=i.get("sn-glassmorphism-level");l.addDropDown("sn-glassmorphism-level","Glassmorphism",f,Math.max(0,f.indexOf(v)),void 0,{onChange:B=>{let F=B?.currentTarget?.selectedIndex??0;i.set("sn-glassmorphism-level",f[F])}});let C=["corporate-safe","artist-vision","cosmic-maximum"],T=i.get("sn-artistic-mode");l.addDropDown("sn-artistic-mode","Artistic mode",C,Math.max(0,C.indexOf(T)),void 0,{onChange:B=>{let F=B?.currentTarget?.selectedIndex??0,H=C[F];i.set("sn-artistic-mode",H),globalThis.year3000System?.ADVANCED_SYSTEM_CONFIG?.safeSetArtisticMode?.(H)}});let w=Object.keys(ve),V=i.get("sn-current-harmonic-mode");w.length&&l.addDropDown("sn-current-harmonic-mode","Harmonic colour mode",w,Math.max(0,w.indexOf(V)),void 0,{onChange:B=>{let F=B?.currentTarget?.selectedIndex??0,H=w[F];i.set("sn-current-harmonic-mode",H),globalThis.Y3K?.system?.evolveHarmonicSignature?.(H)}});let W=i.get("sn-harmonic-intensity")||"0.7";l.addInput("sn-harmonic-intensity","Harmonic intensity (music-color sync strength 0-1)",W,"number",{onChange:B=>{let F=B.currentTarget.value;i.set("sn-harmonic-intensity",F)}});let $=i.get("sn-harmonic-evolution")==="true";l.addToggle("sn-harmonic-evolution","Allow harmonic evolution",$,{onClick:B=>{let F=B.currentTarget.checked;i.set("sn-harmonic-evolution",F?"true":"false")}});let _=i.get("sn-webgl-enabled")==="true";l.addToggle("sn-webgl-enabled","WebGL effects (master toggle for all WebGL backgrounds)",_,{onClick:B=>{let F=B.currentTarget.checked;i.set("sn-webgl-enabled",F?"true":"false")}});let j=["low","medium","high"],z=i.get("sn-webgl-quality")||"medium";l.addDropDown("sn-webgl-quality","WebGL quality (performance vs visual quality)",j,Math.max(0,j.indexOf(z)),void 0,{onChange:B=>{let F=B?.currentTarget?.selectedIndex??1,H=j[F]??"medium";i.set("sn-webgl-quality",H)}});let I=["auto","low","high"],re=i.get("sn-animation-quality")||"auto";l.addDropDown("sn-animation-quality","Animation quality (auto/low/high performance)",I,Math.max(0,I.indexOf(re)),void 0,{onChange:B=>{let F=B?.currentTarget?.selectedIndex??0,H=I[F]??"auto";i.set("sn-animation-quality",H)}}),await l.pushSettings(),console.log("\u2728 [StarryNight] spcr-settings panel initialised");let De=i.get("sn-brightness-mode")||"balanced",ye=bo(),ot={"--sn-brightness-mode":`"${De}"`,"--sn-brightness-data-attr":De};ye.batchSetVariables("StarryNightSettings",ot,"high","brightness-mode-init"),document.documentElement.setAttribute("data-sn-brightness",De),console.log(`[StarryNight] Initial brightness mode set to: ${De}`);let Wr=()=>l.rerender(),qr=globalThis.Spicetify?.Platform?.History;try{qr?.listen&&qr.listen(({location:B})=>{B?.pathname==="/settings"&&setTimeout(Wr,100)})}catch(B){console.warn("[StarryNight] Could not hook navigation for settings",B)}window.location.pathname==="/settings"&&setTimeout(Wr,300)}var Ur=y(()=>{"use strict";G();U();yo();st();Mr()});var So={};te(So,{DepthVisualEffectsController:()=>Or});var Or,vo=y(()=>{"use strict";G();U();A();Z();ne();Or=class extends N{constructor(e=M,i=D,a=null,r=null,n=null){super(e,i,a,r,n);this.contentAreas=new Map;this.chromeAreas=new Set;this.userState={isScrolling:!1,isHovering:!1,lastInteractionTime:0,readingModeActive:!1,interactionTarget:null,currentMode:"browsing",focusDepth:.3,scrollVelocity:0,dwellTime:0,interactionPattern:"casual",contentEngagement:.5};this.musicalState={energy:.5,valence:.5,instrumental:!1,tempo:120,emotionalTemperature:.5,musicSyncStrength:.7,genreVisualEffectsProfile:{ambientLevel:.5,energyResponse:.6,visualComplexity:.5},musicalMemoryPatterns:.4};this.readingModeTimer=0;this.interactionTimer=0;this.visualEffectsUpdateInterval=0;this.lastUpdate=0;this.updateThreshold=100;this.visualEffectsIntensity=.7;this.adaptiveProtectionMap=new Map;this.scrollVelocityHistory=[];this.dwellTimeTracker=new Map}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{let e=globalThis.year3000System;this.cssController=e?.cssVisualEffectsController||P(),this.detectContentAndChromeAreas(),this.setupInteractionListeners(),this.initializeVisualEffectsVariables(),this.startVisualEffectsUpdate(),u?.debug?.log("DepthVisualEffectsController","VisualEffects system awakened")}catch(e){u?.debug?.error("DepthVisualEffectsController","Failed to initialize visualEffects:",e)}}detectContentAndChromeAreas(){let e={text:[".main-view-container__scroll-node",".main-trackList-trackListRow",'[data-testid*="tracklist"]','[data-testid*="playlist"]',".main-entityHeader-titleText",".main-entityHeader-subtitle",".main-trackList-rowTitle",".main-trackList-rowSubTitle","h1, h2, h3, h4, h5, h6","p",".lyrics-lyricsContainer-container",".main-cardSubHeader-root",".main-trackList-indexNumber",".main-trackInfo-name",".main-trackInfo-artists"],interactive:["button","a[role='button']","[tabindex='0']",".main-playButton-button",".main-addButton-button",".main-moreButton-button",".main-trackList-rowPlayPause",".control-button","input","select"],visual:[".main-image-container",".main-entityHeader-image",".cover-art",".main-coverSlot-container",".main-image-image"],media:["video","audio",".main-nowPlayingWidget-trackInfo",".main-coverSlot-container",".main-nowPlayingView-coverArt"],navigation:[".main-navBar-navBarLink",".main-rootlist-rootlistItem",".main-collectionLinkText-text"]},i=[".Root__nav-bar",".Root__top-bar",".Root__now-playing-bar",".main-topBar-container",".main-navBar-navBar",".main-entityHeader-container",".main-actionBar-container",".main-view-container",".Root__main-view",".main-rootlist-wrapper"];Object.entries(e).forEach(([r,n])=>{n.forEach(s=>{document.querySelectorAll(s).forEach(o=>{let c={element:o,type:r,protectionLevel:this.calculateAdvancedProtectionLevel(o,r),lastInteraction:0,visualEffectsLevel:this.calculateVisualEffectsLevel(o),readingIntensity:0,contextualImportance:this.calculateContextualImportance(o),adaptiveProtection:this.calculateProtectionLevel(o)};this.contentAreas.set(o,c),o.classList.add("content-sanctuary"),o.classList.add(`content-${r}`),o.setAttribute("data-visualEffects-protected","true"),o.setAttribute("data-content-type",c.type),o.setAttribute("data-visualEffects-level",c.visualEffectsLevel.toString()),o.setAttribute("data-contextual-importance",c.contextualImportance.toString()),this.adaptiveProtectionMap.set(o,c.adaptiveProtection),this.dwellTimeTracker.set(o,0)})})}),i.forEach(r=>{document.querySelectorAll(r).forEach(n=>{this.chromeAreas.add(n),n.classList.add("ui-chrome-area"),n.setAttribute("data-visualEffects-enhanced","true")})});let a=this.analyzeContentDistribution();u?.debug?.log("DepthVisualEffectsController",`Enhanced detection: ${this.contentAreas.size} content areas, ${this.chromeAreas.size} chrome areas`,a)}determineContentType(e){return e.matches("h1, h2, h3, h4, h5, h6, .main-entityHeader-titleText")?"text":e.matches('button, a, [role="button"], [tabindex], input, select')?"interactive":e.matches(".main-image-container, .main-entityHeader-image, .cover-art")?"visual":e.matches(".Root__nav-bar, .Root__top-bar, .main-topBar-container")?"chrome":"text"}calculateProtectionLevel(e){switch(this.determineContentType(e)){case"text":return .95;case"interactive":return .9;case"visual":return .6;case"chrome":return .3;case"media":return .5;case"navigation":return .7;default:return .85}}calculateAdvancedProtectionLevel(e,i){let a=this.calculateProtectionLevel(e),r=0;i==="text"&&e.textContent&&e.textContent.length>50&&(r+=.05);let n=e.getBoundingClientRect();return n.top>=0&&n.left>=0&&n.bottom<=window.innerHeight&&n.right<=window.innerWidth&&(r+=.02),e.matches('h1, h2, .main-entityHeader-titleText, [data-testid*="title"]')&&(r+=.03),Math.min(a+r,.98)}calculateVisualEffectsLevel(e){let i=e.getBoundingClientRect(),a=i.width*i.height,r=window.innerWidth*window.innerHeight,n=a/r,s=Math.min(n*2,.8);return e.matches(".Root__main-view, .main-view-container")&&(s+=.3),e.matches(".main-nowPlayingBar-container")&&(s+=.4),Math.min(s,1)}calculateContextualImportance(e){let i=.5;return e.matches('button, a, [role="button"], [tabindex="0"]')&&(i+=.2),e.matches(".main-view-container, .main-entityHeader, .main-trackList")&&(i+=.3),e.matches(".main-nowPlayingWidget, .main-nowPlayingBar")&&(i+=.4),e.matches(":focus, :focus-within, :hover")&&(i+=.2),Math.min(i,1)}analyzeContentDistribution(){let e={totalAreas:this.contentAreas.size,textAreas:0,interactiveAreas:0,visualAreas:0,mediaAreas:0,navigationAreas:0,chromeAreas:this.chromeAreas.size,averageProtection:0,highProtectionAreas:0},i=0;return this.contentAreas.forEach(a=>{switch(a.type){case"text":e.textAreas++;break;case"interactive":e.interactiveAreas++;break;case"visual":e.visualAreas++;break;case"media":e.mediaAreas++;break;case"navigation":e.navigationAreas++;break}i+=a.protectionLevel,a.protectionLevel>.8&&e.highProtectionAreas++}),e.averageProtection=i/this.contentAreas.size||0,e}analyzeScrollingBehavior(){if(this.scrollVelocityHistory.length<3)return;let e=this.scrollVelocityHistory.reduce((a,r)=>a+r,0)/this.scrollVelocityHistory.length,i=this.scrollVelocityHistory.reduce((a,r)=>a+Math.pow(r-e,2),0)/this.scrollVelocityHistory.length;i<100&&e<300?(this.userState.contentEngagement=Math.min(this.userState.contentEngagement+.05,1),this.userState.interactionPattern="contemplative"):e>1500&&i>500?(this.userState.contentEngagement=Math.max(this.userState.contentEngagement-.1,.1),this.userState.interactionPattern="rapid"):this.userState.interactionPattern="casual",this.userState.contentEngagement>.7?this.visualEffectsIntensity=Math.min(this.visualEffectsIntensity+.05,.9):this.userState.contentEngagement<.3&&(this.visualEffectsIntensity=Math.max(this.visualEffectsIntensity-.1,.3))}calculateInteractionModifier(){let e=0;if(this.userState.readingModeActive&&(e-=.6),this.userState.isHovering){let i=this.contentAreas.get(this.userState.interactionTarget);if(i){let a=i.type==="text"?.4:i.type==="interactive"?.3:i.type==="chrome"?.1:.2;e-=a}}return this.userState.scrollVelocity>1e3&&(e-=.2),this.userState.focusDepth>.7&&!this.userState.readingModeActive&&(e+=.2),e}calculateContextualModifier(){let e=0;return this.userState.interactionTarget?.matches(".main-nowPlayingBar, .main-nowPlayingWidget")&&(e+=.3),this.userState.interactionTarget?.matches(".main-trackList, .main-entityHeader-subtitle")&&(e-=this.userState.currentMode==="exploring"?.1:.3),this.userState.currentMode==="ambient"&&(e+=.4),this.userState.currentMode==="navigating"&&(e-=.2),e}getModeNumericValue(e){return{reading:0,browsing:1,exploring:2,navigating:3,ambient:4}[e]/4}getPatternNumericValue(e){return{contemplative:0,casual:1,deliberate:2,rapid:3}[e]/3}calculateSurfaceFluidityIndex(){let e=.5;return e+=this.musicalState.energy*.3,e+=this.userState.contentEngagement*.2,e+=this.musicalState.emotionalTemperature*.2,this.userState.interactionPattern==="contemplative"?e-=.2:this.userState.interactionPattern==="rapid"&&(e+=.3),Math.max(.1,Math.min(1,e))}calculateGenreVisualEffectsShift(){if(!this.musicalState.genre)return .5;let i={ambient:.8,electronic:.7,classical:.6,jazz:.5,rock:.4,pop:.3,"hip-hop":.2}[this.musicalState.genre.toLowerCase()]||.5,a=0;return this.musicalState.valence>.7&&(a+=.1),this.musicalState.energy>.8&&(a+=.1),Math.max(.1,Math.min(1,i+a))}setupInteractionListeners(){let e,i=window.scrollY,a=Date.now();document.addEventListener("scroll",()=>{let s=Date.now(),o=window.scrollY,c=s-a,m=Math.abs(o-i);this.userState.scrollVelocity=c>0?m/c*1e3:0,this.scrollVelocityHistory.push(this.userState.scrollVelocity),this.scrollVelocityHistory.length>10&&this.scrollVelocityHistory.shift();let d=this.scrollVelocityHistory.reduce((h,g)=>h+g,0)/this.scrollVelocityHistory.length;d>2e3?(this.userState.interactionPattern="rapid",this.userState.currentMode="browsing"):d>500?(this.userState.interactionPattern="deliberate",this.userState.currentMode="exploring"):this.userState.interactionPattern="contemplative",this.userState.isScrolling=!0,this.userState.lastInteractionTime=s,i=o,a=s,clearTimeout(e),e=window.setTimeout(()=>{this.userState.isScrolling=!1,this.analyzeScrollingBehavior()},150),this.updateUserInteractionState()},{passive:!0}),this.contentAreas.forEach((s,o)=>{let c=0;o.addEventListener("mouseenter",()=>{c=Date.now(),this.userState.isHovering=!0,this.userState.interactionTarget=o,this.userState.lastInteractionTime=c,s.lastInteraction=c,this.dwellTimeTracker.set(o,c),this.userState.focusDepth=Math.min(this.userState.focusDepth+.1,1),s.type==="text"&&(this.userState.focusDepth=Math.min(this.userState.focusDepth+.2,1)),this.updateUserInteractionState()}),o.addEventListener("mouseleave",()=>{let d=Date.now()-c;if(this.userState.dwellTime=d,s.readingIntensity=Math.min(d/5e3,1),s.type==="text"&&d>1e3&&(this.userState.contentEngagement=Math.min(this.userState.contentEngagement+.1,1),s.contextualImportance=Math.min(s.contextualImportance+.05,1)),d>3e3){let h=this.adaptiveProtectionMap.get(o)||s.protectionLevel;this.adaptiveProtectionMap.set(o,Math.min(h+.05,.98))}this.userState.isHovering=!1,this.userState.interactionTarget=null,this.userState.focusDepth=Math.max(this.userState.focusDepth-.05,.1),this.updateUserInteractionState()})}),document.addEventListener("mousemove",()=>{clearTimeout(this.readingModeTimer),this.userState.readingModeActive=!1,this.userState.focusDepth>.7?this.userState.currentMode="reading":this.userState.scrollVelocity>1e3?this.userState.currentMode="browsing":this.userState.currentMode="exploring";let s=this.userState.currentMode==="reading"?1500:2e3;this.readingModeTimer=window.setTimeout(()=>{if(this.userState.interactionTarget&&this.contentAreas.has(this.userState.interactionTarget)){this.userState.readingModeActive=!0,this.userState.currentMode="reading",this.userState.focusDepth=Math.min(this.userState.focusDepth+.3,1);let o=this.contentAreas.get(this.userState.interactionTarget);if(o&&o.type==="text"){let c=this.adaptiveProtectionMap.get(this.userState.interactionTarget)||o.protectionLevel;this.adaptiveProtectionMap.set(this.userState.interactionTarget,Math.min(c+.1,.98))}this.updateUserInteractionState()}},s)});let r,n=()=>{clearTimeout(r),r=window.setTimeout(()=>{this.userState.currentMode="ambient",this.userState.focusDepth=Math.max(this.userState.focusDepth-.5,.1),this.updateUserInteractionState()},3e4)};["mousedown","mousemove","keydown","scroll","touchstart"].forEach(s=>{document.addEventListener(s,n,{passive:!0})}),n(),document.addEventListener("music-state-change",s=>{let o=s;o.detail&&this.syncWithMusic(o.detail)}),document.addEventListener("beat-detected",()=>{this.handleBeatPulse()})}initializeVisualEffectsVariables(){let e={"--sn-visual-effects-system-active":"1","--sn-visual-effects-content-protection-level":"0.95","--sn-visual-effects-chrome-enhancement-level":"2.0","--sn-visual-effects-field-animation-rate":"4s","--sn-music-energy-level":"0.5","--sn-feature-reading-mode-active":"0","--sn-visual-effects-user-interaction-detected":"0"};this.cssController.batchSetVariables("DepthVisualEffectsController",e,"normal","visualEffects-initialization")}startVisualEffectsUpdate(){let e=()=>{if(!this.isActive)return;let i=performance.now();i-this.lastUpdate>=this.updateThreshold&&(this.updateVisualEffectsState(),this.lastUpdate=i),requestAnimationFrame(e)};e()}updateVisualEffectsState(){let e=document.documentElement,i=this.visualEffectsIntensity,a=this.musicalState.energy*this.musicalState.musicSyncStrength*.3,r=this.calculateInteractionModifier(),n=this.calculateContextualModifier(),s=this.musicalState.emotionalTemperature*.2,c={"--sn-visual-effects-field-intensity":Math.max(.05,Math.min(1,i+a+r+n+s)).toString(),"--sn-visual-effects-level":this.visualEffectsIntensity.toString(),"--sn-visual-effects-awareness-level":this.userState.focusDepth.toString(),"--sn-music-energy-level":this.musicalState.energy.toString(),"--sn-visual-effects-music-sync-strength":this.musicalState.musicSyncStrength.toString(),"--sn-color-shift-temperature":this.musicalState.emotionalTemperature.toString(),"--sn-feature-reading-mode-active":this.userState.readingModeActive?"1":"0","--sn-visual-effects-user-interaction-detected":this.userState.isScrolling||this.userState.isHovering?"1":"0","--sn-visual-effects-interaction-mode":this.getModeNumericValue(this.userState.currentMode).toString(),"--sn-visual-effects-focus-depth":this.userState.focusDepth.toString(),"--sn-visual-effects-content-engagement":this.userState.contentEngagement.toString(),"--sn-visual-effects-scroll-velocity":Math.min(this.userState.scrollVelocity/2e3,1).toString(),"--sn-visual-effects-dwell-time-factor":Math.min(this.userState.dwellTime/5e3,1).toString(),"--sn-visual-effects-interaction-pattern":this.getPatternNumericValue(this.userState.interactionPattern).toString(),"--sn-visual-effects-temporal-flow-direction-x":(Math.sin(Date.now()*1e-4)*.5+.5).toString(),"--sn-visual-effects-temporal-flow-direction-y":(Math.cos(Date.now()*1e-4)*.5+.5).toString(),"--sn-visual-effects-memory-intensity":this.musicalState.musicalMemoryPatterns.toString(),"--sn-visual-effects-fluidity-index":this.calculateSurfaceFluidityIndex().toString(),"--sn-visual-effects-genre-shift":this.calculateGenreVisualEffectsShift().toString()};this.cssController.batchSetVariables("DepthVisualEffectsController",c,"normal","visualEffects-state-update"),e.classList.remove("music-energy-high","music-energy-calm"),this.musicalState.energy>.7?e.classList.add("music-energy-high"):this.musicalState.energy<.3&&e.classList.add("music-energy-calm"),e.setAttribute("data-user-interacting",(this.userState.isScrolling||this.userState.isHovering).toString()),e.setAttribute("data-reading-mode",this.userState.readingModeActive.toString())}updateUserInteractionState(){this.updateVisualEffectsState()}syncWithMusic(e){if(Object.assign(this.musicalState,e),e.tempo){let i=Math.max(2,Math.min(8,60/(e.tempo/60)*4));this.cssController.setVariable("DepthVisualEffectsController","--sn-visual-effects-field-animation-rate",`${i}s`,"high","musical-tempo-sync")}this.updateVisualEffectsState(),u?.debug?.log("DepthVisualEffectsController",`Musical visualEffects sync: energy=${e.energy}, tempo=${e.tempo}`)}handleBeatPulse(){if(this.userState.readingModeActive)return;let e=document.documentElement,i=parseFloat(e.style.getPropertyValue("--sn-visual-effects-field-intensity")||"0.5"),a=Math.min(1,i+.1);this.cssController.setVariable("DepthVisualEffectsController","--sn-visual-effects-field-intensity",a.toString(),"high","beat-pulse"),setTimeout(()=>{this.isActive&&this.updateVisualEffectsState()},100)}protectNewContent(e){if(this.contentAreas.has(e))return;let i={element:e,type:this.determineContentType(e),protectionLevel:this.calculateProtectionLevel(e),lastInteraction:0,visualEffectsLevel:.5,readingIntensity:0,contextualImportance:this.calculateProtectionLevel(e),adaptiveProtection:.5};this.contentAreas.set(e,i),e.classList.add("content-sanctuary"),e.setAttribute("data-visualEffects-protected","true"),e.setAttribute("data-content-type",i.type),u?.debug?.log("DepthVisualEffectsController",`Protected new content element: ${e.tagName}.${e.className}`)}enhanceNewChrome(e){this.chromeAreas.has(e)||(this.chromeAreas.add(e),e.classList.add("ui-chrome-area"),e.setAttribute("data-visualEffects-enhanced","true"),u?.debug?.log("DepthVisualEffectsController",`Enhanced new chrome element: ${e.tagName}.${e.className}`))}forceReadingMode(e){this.userState.readingModeActive=e,this.updateUserInteractionState(),u?.debug?.log("DepthVisualEffectsController",`Reading mode ${e?"activated":"deactivated"}`)}getVisualEffectsMetrics(){return{contentAreas:this.contentAreas.size,chromeAreas:this.chromeAreas.size,visualEffectsIntensity:parseFloat(document.documentElement.style.getPropertyValue("--sn-visual-effects-field-intensity")||"0.5"),readingModeActive:this.userState.readingModeActive,userInteracting:this.userState.isScrolling||this.userState.isHovering,musicalEnergy:this.musicalState.energy}}async healthCheck(){let e=this.getVisualEffectsMetrics(),i=e.contentAreas>0&&e.chromeAreas>0;return{healthy:i,issues:i?[]:["VisualEffects system not properly initialized"],metrics:{visualEffectsLevel:e.contentAreas>0?1:0,protectedAreas:e.contentAreas,enhancedAreas:e.chromeAreas,musicalEnergy:e.musicalEnergy}}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),clearTimeout(this.readingModeTimer),clearTimeout(this.interactionTimer),this.contentAreas.forEach((a,r)=>{r.classList.remove("content-sanctuary"),r.removeAttribute("data-visualEffects-protected"),r.removeAttribute("data-content-type")}),this.chromeAreas.forEach(a=>{a.classList.remove("ui-chrome-area"),a.removeAttribute("data-visualEffects-enhanced")});let e={"--sn-visual-effects-system-active":"","--sn-visual-effects-field-intensity":"","--sn-feature-reading-mode-active":"","--sn-visual-effects-user-interaction-detected":"","--sn-visual-effects-field-animation-rate":"","--sn-music-energy-level":"","--sn-visual-effects-content-protection-level":"","--sn-visual-effects-chrome-enhancement-level":""};this.cssController.batchSetVariables("DepthVisualEffectsController",e,"critical","system-cleanup");let i=document.documentElement;i.classList.remove("music-energy-high","music-energy-calm"),i.removeAttribute("data-user-interacting"),i.removeAttribute("data-reading-mode"),u?.debug?.log("DepthVisualEffectsController","VisualEffects system deactivated")}}});var Co={};te(Co,{DynamicCatppuccinBridge:()=>Nr});var Nr,Eo=y(()=>{"use strict";G();k();U();A();Z();ne();Nr=class extends N{constructor(e=M,i=D,a=null,r=null,n=null){super(e,i,a,r,n);this.colorHarmonyEngine=null;this.depthVisualController=null;this.dynamicColorState={currentAccentHex:"#675c8f",currentAccentRgb:"203,166,247",baseBackgroundHex:"#0d1117",baseBackgroundRgb:"13,17,23",lastUpdateTime:0,musicEnergy:.5,transitionInProgress:!1};this.integrationConfig={accentUpdateEnabled:!0,baseTransformationEnabled:!0,visualIntegrationEnabled:!0,smoothTransitionDuration:800,energyResponseMultiplier:1.2};this.transitionTimer=0;this.lastTransitionStartTime=0;this.transitionFromAccent="";this.transitionToAccent=""}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{let e=globalThis.year3000System;this.cssController=e?.cssController||P(),this.setupColorExtractionListeners(),this.setupSettingsListeners(),this.initializeCurrentState();let i=this.checkDynamicAccentEnabled();this.integrationConfig.accentUpdateEnabled=i,i?u?.debug?.log("DynamicCatppuccinBridge","Dynamic accent enabled - bridge active"):u?.debug?.log("DynamicCatppuccinBridge","Dynamic accent disabled - bridge standby (will activate when enabled)"),u?.debug?.log("DynamicCatppuccinBridge","Color Extension Facade initialized successfully")}catch(e){u?.debug?.error("DynamicCatppuccinBridge","Failed to initialize facade:",e)}}checkDynamicAccentEnabled(){try{if(!this.settingsManager)return!1;let e=this.settingsManager.get("catppuccin-accentColor"),i=String(e)==="dynamic";return this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinBridge",`Accent setting: ${e}, Dynamic: ${i}`),i}catch(e){return u?.debug?.error("DynamicCatppuccinBridge","Error checking dynamic accent setting:",e),!1}}setupColorExtractionListeners(){p.subscribe("colors:extracted",e=>{e.rawColors&&this.handleExtractedColors(e.rawColors)},"DynamicCatppuccinBridge"),p.subscribe("colors:harmonized",e=>{e.processedColors&&this.handleHarmonizedColors(e.processedColors)},"DynamicCatppuccinBridge"),p.subscribe("colors:applied",e=>{e.cssVariables&&this.integrationConfig.accentUpdateEnabled&&this.handleCSSVariablesApplied(e.cssVariables,e.accentHex,e.accentRgb)},"DynamicCatppuccinBridge"),document.addEventListener("colors-extracted",e=>{let i=e;i.detail&&i.detail.extractedColors&&this.handleExtractedColors(i.detail.extractedColors)}),document.addEventListener("colors-harmonized",e=>{let i=e;i.detail&&i.detail.harmonizedColors&&this.handleHarmonizedColors(i.detail.harmonizedColors)}),document.addEventListener("music-state-change",e=>{let i=e;i.detail&&this.handleMusicStateChange(i.detail)}),document.addEventListener("spice-colors/update-request",e=>{let i=e;i.detail&&this.integrationConfig.accentUpdateEnabled&&this.handleSpiceColorUpdateRequest(i.detail)}),u?.debug?.log("DynamicCatppuccinBridge","Enhanced color extraction and coordination listeners setup complete (UnifiedEventBus + DOM)")}handleSpiceColorUpdateRequest(e){let{accentHex:i,primaryHex:a,secondaryHex:r,source:n}=e;this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinBridge",`Received spice color update request from ${n}:`,{accent:i,primary:a,secondary:r}),i&&i!==this.dynamicColorState.currentAccentHex&&this.scheduleSmoothAccentTransition(i),a&&this.updateLivingBaseBackground(a),document.dispatchEvent(new CustomEvent("spice-colors/updated",{detail:{source:"DynamicCatppuccinBridge",applied:{accent:i,primary:a,secondary:r},timestamp:Date.now()}}))}setupSettingsListeners(){document.addEventListener("year3000SystemSettingsChanged",e=>{let i=e,{key:a,value:r}=i.detail||{};if(a==="catppuccin-accentColor"){let n=String(r)==="dynamic";this.integrationConfig.accentUpdateEnabled=n,n&&!this.isActive?this.initialize():!n&&this.isActive&&this.destroy(),u?.debug?.log("DynamicCatppuccinBridge",`Accent setting changed to: ${r}, Bridge active: ${this.isActive}`)}})}initializeCurrentState(){let e=document.documentElement,i=getComputedStyle(e),a=i.getPropertyValue("--sn-accent-hex").trim()||i.getPropertyValue("--sn-musical-harmony-primary-hex").trim()||i.getPropertyValue("--sn-dynamic-accent-hex").trim()||i.getPropertyValue("--sn-cosmic-accent-hex").trim()||i.getPropertyValue("--spice-accent").trim();if(a){this.dynamicColorState.currentAccentHex=a;let s=this.utils.hexToRgb(a);s&&(this.dynamicColorState.currentAccentRgb=`${s.r},${s.g},${s.b}`)}let r=i.getPropertyValue("--sn-cosmic-base-hex").trim()||i.getPropertyValue("--spice-base").trim()||"#0d1117";this.dynamicColorState.baseBackgroundHex=r;let n=this.utils.hexToRgb(r);n&&(this.dynamicColorState.baseBackgroundRgb=`${n.r},${n.g},${n.b}`),this.dynamicColorState.lastUpdateTime=Date.now(),u?.debug?.log("DynamicCatppuccinBridge","Current state initialized:",{accent:this.dynamicColorState.currentAccentHex,base:this.dynamicColorState.baseBackgroundHex})}handleExtractedColors(e){if(this.integrationConfig.accentUpdateEnabled)try{let i=this.selectBestAccentColor(e);i&&i!==this.dynamicColorState.currentAccentHex&&this.scheduleSmoothAccentTransition(i),u?.debug?.log("DynamicCatppuccinBridge","Processed extracted colors:",{input:Object.keys(e),selectedAccent:i})}catch(i){u?.debug?.error("DynamicCatppuccinBridge","Error handling extracted colors:",i)}}handleHarmonizedColors(e){if(this.integrationConfig.accentUpdateEnabled)try{let i=e.VIBRANT||e.PROMINENT||e.VIBRANT_NON_ALARMING||e.LIGHT_VIBRANT||e.PRIMARY||Object.values(e)[0];i&&i!==this.dynamicColorState.currentAccentHex&&(this.config.enableDebug&&console.log("\u{1F3A8} [DynamicCatppuccinBridge] Applying harmonized accent color:",{from:this.dynamicColorState.currentAccentHex,to:i,source:"ColorHarmonyEngine harmonized colors"}),this.scheduleSmoothAccentTransition(i)),this.applyHarmonizedColorsToDynamicSystem(e)}catch(i){console.error("\u{1F3A8} [DynamicCatppuccinBridge] Error handling harmonized colors:",i)}}handleCSSVariablesApplied(e,i,a){if(this.integrationConfig.accentUpdateEnabled)try{i&&i!==this.dynamicColorState.currentAccentHex&&(this.dynamicColorState.currentAccentHex=i,this.dynamicColorState.currentAccentRgb=a,this.dynamicColorState.lastUpdateTime=Date.now());let r={},n=e["--sn-accent-hex"]||e["--spice-accent"]||i,s=e["--sn-accent-rgb"]||e["--spice-rgb-accent"]||a;n&&s&&(r["--sn-dynamic-accent-hex"]=n,r["--sn-dynamic-accent-rgb"]=s,r["--sn-dynamic-primary-hex"]=n,r["--sn-dynamic-primary-rgb"]=s,Object.keys(r).length>0&&this.cssController.batchSetVariables("DynamicCatppuccinBridge",r,"critical","css-variables-applied-enhancement")),u?.debug?.log("DynamicCatppuccinBridge","Processed colors:applied event:",{accentHex:n,accentRgb:s,variablesProcessed:Object.keys(e).length,enhancedVariables:Object.keys(r).length})}catch(r){u?.debug?.error("DynamicCatppuccinBridge","Error handling CSS variables applied:",r)}}handleMusicStateChange(e){e.energy!==void 0&&(this.dynamicColorState.musicEnergy=e.energy,this.integrationConfig.visualIntegrationEnabled&&this.updateVisualWithMusicEnergy(e.energy))}selectBestAccentColor(e){let i=["VIBRANT_NON_ALARMING","VIBRANT","LIGHT_VIBRANT","PROMINENT","PRIMARY","DARK_VIBRANT"];for(let a of i){let r=e[a];if(r&&this.utils.hexToRgb(r))return r}return null}scheduleSmoothAccentTransition(e){if(this.dynamicColorState.transitionInProgress){this.transitionToAccent=e;return}this.transitionFromAccent=this.dynamicColorState.currentAccentHex,this.transitionToAccent=e,this.dynamicColorState.transitionInProgress=!0,this.lastTransitionStartTime=Date.now(),this.animateAccentTransition(),u?.debug?.log("DynamicCatppuccinBridge",`Accent transition scheduled: ${this.transitionFromAccent} \u2192 ${e}`)}animateAccentTransition(){let e=()=>{if(!this.dynamicColorState.transitionInProgress)return;let i=Date.now()-this.lastTransitionStartTime,a=Math.min(i/this.integrationConfig.smoothTransitionDuration,1),r=1-Math.pow(1-a,3),n=this.interpolateColors(this.transitionFromAccent,this.transitionToAccent,r);if(n&&this.applyDynamicAccent(n),a>=1){this.dynamicColorState.transitionInProgress=!1,this.dynamicColorState.currentAccentHex=this.transitionToAccent,this.dynamicColorState.lastUpdateTime=Date.now();let s=this.utils.hexToRgb(this.transitionToAccent);s&&(this.dynamicColorState.currentAccentRgb=`${s.r},${s.g},${s.b}`),u?.debug?.log("DynamicCatppuccinBridge",`Accent transition complete: ${this.transitionToAccent}`)}else requestAnimationFrame(e)};requestAnimationFrame(e)}interpolateColors(e,i,a){let r=this.utils.hexToRgb(e),n=this.utils.hexToRgb(i);if(!r||!n)return null;let s=Math.round(r.r+(n.r-r.r)*a),o=Math.round(r.g+(n.g-r.g)*a),c=Math.round(r.b+(n.b-r.b)*a);return this.utils.rgbToHex(s,o,c)}applyDynamicAccent(e){console.log("\u{1F3A8} [DynamicCatppuccinBridge] Applying dynamic accent color:",{accentHex:e,previousAccent:this.dynamicColorState.currentAccentHex,timestamp:Date.now()});let i=document.documentElement,a=this.utils.hexToRgb(e);if(!a){console.error("\u{1F3A8} [DynamicCatppuccinBridge] Failed to convert accent hex to RGB:",e);return}let r=`${a.r},${a.g},${a.b}`,n={"--sn-dynamic-accent-hex":e,"--sn-dynamic-accent-rgb":r,"--sn-dynamic-primary-hex":e,"--sn-dynamic-primary-rgb":r,"--spice-accent":e,"--spice-button":e,"--spice-button-active":e,"--spice-rgb-accent":r,"--spice-rgb-button":r,"--sn-color-extracted-primary-rgb":r,"--sn-color-extracted-vibrant-rgb":r,"--sn-color-extracted-dominant-rgb":r};console.log("\u{1F3A8} [DynamicCatppuccinBridge] Setting CSS variables:",n),this.cssController.batchSetVariables("DynamicCatppuccinBridge",n,"critical","dynamic-accent-application"),this.integrationConfig.visualIntegrationEnabled&&this.updateVisualWithAccent(e,r),this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinBridge",`Applied gradient colors: --sn-bg-gradient-primary=${e}, --sn-bg-gradient-primary-rgb=${r}`)}applyHarmonizedColorsToDynamicSystem(e){let i=e.VIBRANT||e.PRIMARY;i&&this.integrationConfig.baseTransformationEnabled&&this.updateLivingBaseBackground(i)}updateVisualWithAccent(e,i){let a=document.documentElement,r={"--sn-holographic-rgb":i,"--holographic-scanline-rgb":i,"--visual-intensity":`calc(0.5 + var(--musical-sync-intensity) * ${this.integrationConfig.energyResponseMultiplier}),`};this.cssController.batchSetVariables("DynamicCatppuccinBridge",r,"high","visual-accent-update"),this.depthVisualController&&u?.debug?.log("DynamicCatppuccinBridge","Notifying depth visual controller of accent change")}updateVisualWithMusicEnergy(e){let i=document.documentElement,a=e*this.integrationConfig.energyResponseMultiplier,r={"--musical-sync-intensity":a.toString(),"--holographic-music-flicker-intensity":a.toString()};this.cssController.batchSetVariables("DynamicCatppuccinBridge",r,"high","musical-energy-update");let s=Math.max(.1,Math.min(1,.5+a*.3));this.cssController.setVariable("DynamicCatppuccinBridge","--visual-intensity",s.toString(),"high","visual-intensity-update")}updateLivingBaseBackground(e){let i=document.documentElement,a=this.utils.hexToRgb(e);if(!a)return;let r=`${a.r},${a.g},${a.b}`,n={"--sn-dynamic-secondary-hex":e,"--sn-dynamic-secondary-rgb":r,"--sn-color-extracted-secondary-rgb":r,"--sn-color-harmony-complementary-rgb":r};this.cssController.batchSetVariables("DynamicCatppuccinBridge",n,"high","secondary-color-update");let s=`
      linear-gradient(135deg,
        var(--spice-base) 0%,
        rgba(${r}, 0.08) 30%,
        var(--spice-base) 70%
      ),
      var(--spice-base)
    `,o={"--living-base-gradient":s,"--visual-base-gradient":s};this.cssController.batchSetVariables("DynamicCatppuccinBridge",o,"normal","living-gradient-update"),this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinBridge",`Living base updated: --sn-bg-gradient-secondary=${e}, --sn-bg-gradient-secondary-rgb=${r}`)}linkWithColorHarmonyEngine(e){this.colorHarmonyEngine=e,u?.debug?.log("DynamicCatppuccinBridge","Linked with ColorHarmonyEngine")}linkWithDepthVisual(e){this.depthVisualController=e,u?.debug?.log("DynamicCatppuccinBridge","Linked with DepthLayerController")}getDynamicColorState(){return{...this.dynamicColorState}}getFacadeVariableStatus(){let e=document.documentElement,i=getComputedStyle(e);return{spicetifyVars:{accent:i.getPropertyValue("--spice-accent").trim(),button:i.getPropertyValue("--spice-button").trim(),rgbAccent:i.getPropertyValue("--spice-rgb-accent").trim(),base:i.getPropertyValue("--spice-base").trim()},visualVars:{gradientPrimary:i.getPropertyValue("--sn-bg-gradient-primary-rgb").trim(),accentHex:i.getPropertyValue("--sn-color-accent-hex").trim(),accentRgb:i.getPropertyValue("--sn-color-accent-rgb").trim(),extractedPrimary:i.getPropertyValue("--sn-color-extracted-primary-rgb").trim(),livingBaseGradient:i.getPropertyValue("--living-base-gradient").trim()},config:{dynamicAccentEnabled:this.checkDynamicAccentEnabled(),accentUpdateEnabled:this.integrationConfig.accentUpdateEnabled,visualEnabled:this.integrationConfig.visualIntegrationEnabled,isActive:this.isActive}}}updateConfig(e){this.integrationConfig={...this.integrationConfig,...e},u?.debug?.log("DynamicCatppuccinBridge","Configuration updated:",e)}async healthCheck(){let e=this.checkDynamicAccentEnabled(),i=Date.now()-this.dynamicColorState.lastUpdateTime<3e4;return{healthy:this.isActive&&e,issues:this.isActive&&!e?["Dynamic accent not enabled in settings"]:[],metrics:{dynamicAccentEnabled:e,currentAccent:this.dynamicColorState.currentAccentHex,lastUpdateAge:Date.now()-this.dynamicColorState.lastUpdateTime,hasRecentUpdate:i,transitionInProgress:this.dynamicColorState.transitionInProgress,musicEnergy:this.dynamicColorState.musicEnergy}}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=0),this.dynamicColorState.transitionInProgress=!1,p.unsubscribeAll("DynamicCatppuccinBridge"),u?.debug?.log("DynamicCatppuccinBridge","Dynamic Catppuccin bridge cleaned up (including UnifiedEventBus subscriptions)")}}});var Mo={};te(Mo,{CDFVariableBridge:()=>$r});var $r,wo=y(()=>{"use strict";k();$r=class{constructor(t){this.batcher=t;this.reduceMotionMQ=null;this._mqHandler=null;let e=p.subscribe("performance:frame",i=>{let a={deltaMs:i.deltaTime||16.67,timestamp:i.timestamp||Date.now(),performanceMode:"performance",frameBudget:16.67};this._handleFrame(a)},"CDFVariableBridge");if(this.unsubscribe=()=>p.unsubscribe(e),typeof window<"u"&&window.matchMedia){this.reduceMotionMQ=window.matchMedia("(prefers-reduced-motion: reduce)"),this._syncReducedMotion(this.reduceMotionMQ.matches),this._mqHandler=i=>{this._syncReducedMotion(i.matches)};try{this.reduceMotionMQ.addEventListener("change",this._mqHandler)}catch{this.reduceMotionMQ.addListener(this._mqHandler)}}}destroy(){if(this.unsubscribe?.(),this.reduceMotionMQ&&this._mqHandler)try{this.reduceMotionMQ.removeEventListener("change",this._mqHandler)}catch{this.reduceMotionMQ.removeListener(this._mqHandler)}}_handleFrame(t){if(typeof t.scrollRatio=="number"&&(this.batcher.queueCSSVariableUpdate("--sn-cdf-scroll-ratio",t.scrollRatio.toFixed(3)),this.batcher.queueCSSVariableUpdate("--sn-scroll-ratio",t.scrollRatio.toFixed(3))),typeof t.beatIntensity=="number"){let e=t.beatIntensity.toFixed(3);this.batcher.queueCSSVariableUpdate("--sn-cdf-energy",e),this.batcher.queueCSSVariableUpdate("--sn-beat-intensity",e)}}_syncReducedMotion(t){this.batcher.queueCSSVariableUpdate("--sn-cdf-enabled",t?"0":"1")}}});G();Tr();A();Z();async function qs(l=1e4,t=100){let e=Date.now();for(;Date.now()-e<l;){let i=window.Spicetify;if(i?.showNotification&&i?.Platform)return!0;await new Promise(a=>setTimeout(a,t))}return!1}U();var Xi=class{constructor(t,e=null){this.parent=t;this.y3k=e;this.gl=null;this.program=null;this.tex=null;this.strength=.4;this.rafId=null;this.frameStart=0;this._defaultSize=256;this._boundContextLost=t=>this._handleContextLost(t);this._boundContextRestored=()=>this._handleContextRestored();this.canvas=document.createElement("canvas"),this.canvas.width=this._defaultSize,this.canvas.height=this._defaultSize,this.canvas.style.width="100%",this.canvas.style.height="100%",Object.assign(this.canvas.style,{position:"absolute",inset:"0",pointerEvents:"none",mixBlendMode:"overlay",zIndex:"-1",opacity:"0.6"}),this.parent.appendChild(this.canvas),this.perf=e?.performanceAnalyzer??null,this.canvas.addEventListener("webglcontextlost",this._boundContextLost,!1),this.canvas.addEventListener("webglcontextrestored",this._boundContextRestored,!1),this._initGL()}_initGL(){let t=this.canvas.getContext("webgl",{premultipliedAlpha:!1,alpha:!0,antialias:!1});if(!t){console.warn("[AberrationCanvas] WebGL not available \u2013 effect disabled");return}this.gl=t;let e="attribute vec2 aPos; varying vec2 vUv; void main(){ vUv = (aPos+1.0)*0.5; gl_Position = vec4(aPos,0.0,1.0); }",i="precision mediump float; uniform sampler2D uTex; uniform float uStrength; uniform float uTime; varying vec2 vUv; void main(){ float freq = 8.0; vec2 offset = vec2(sin(vUv.y*freq+uTime)*uStrength, 0.0); vec4 c; c.r = texture2D(uTex, vUv + offset).r; c.g = texture2D(uTex, vUv).g; c.b = texture2D(uTex, vUv - offset).b; c.a = clamp(uStrength * 1.5, 0.0, 0.6); gl_FragColor = c; }",a=(h,g)=>{let f=t.createShader(h);return t.shaderSource(f,g),t.compileShader(f),f},r=a(t.VERTEX_SHADER,e),n=a(t.FRAGMENT_SHADER,i),s=t.createProgram();if(t.attachShader(s,r),t.attachShader(s,n),t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS)){console.error("[AberrationCanvas] Shader link failed");return}this.program=s,t.useProgram(s);let o=new Float32Array([-1,-1,1,-1,-1,1,1,1]),c=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,c),t.bufferData(t.ARRAY_BUFFER,o,t.STATIC_DRAW);let m=t.getAttribLocation(s,"aPos");t.enableVertexAttribArray(m),t.vertexAttribPointer(m,2,t.FLOAT,!1,0,0);let d=t.createTexture();t.bindTexture(t.TEXTURE_2D,d),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,0,0])),this.tex=d}setStrength(t){this.strength=t}updateSourceBitmap(t){if(!this.gl||!this.tex)return;let e=this.gl;e.bindTexture(e.TEXTURE_2D,this.tex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t)}render(t){if(!this.gl||!this.program)return;let e=this.gl;this.perf&&(this.frameStart=performance.now()),e.viewport(0,0,this.canvas.width,this.canvas.height),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT),e.useProgram(this.program);let i=e.getUniformLocation(this.program,"uTex"),a=e.getUniformLocation(this.program,"uStrength"),r=e.getUniformLocation(this.program,"uTime");if(e.uniform1i(i,0),e.uniform1f(a,this.strength),e.uniform1f(r,t*.001),e.drawArrays(e.TRIANGLE_STRIP,0,4),this.perf){let n=performance.now()-this.frameStart;n>.5&&console.warn(`[AberrationCanvas] Frame ${n.toFixed(2)} ms exceeds 0.5 ms budget`)}}destroy(){this.rafId&&cancelAnimationFrame(this.rafId),this.gl&&this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.canvas.removeEventListener("webglcontextlost",this._boundContextLost),this.canvas.removeEventListener("webglcontextrestored",this._boundContextRestored),this.canvas.remove()}setPixelSize(t){t!==this.canvas.width&&(this.canvas.width=t,this.canvas.height=t)}_handleContextLost(t){t.preventDefault(),console.warn("[AberrationCanvas] WebGL context lost \u2013 waiting for restore"),this.gl=null,this.program=null}_handleContextRestored(){console.info("[AberrationCanvas] WebGL context restored \u2013 re-initializing GL"),this._initGL()}};var Zi=class{constructor(t,e){this.systemName="AberrationCanvas";this._elapsed=0;this._canvas=t,this._perf=e}onAnimate(t,e){this._elapsed+=t;let i=0;this._perf&&(i=this._perf.startTiming("AberrationVisualSystem")),this._canvas.render(this._elapsed),this._perf&&i&&this._perf.endTiming("AberrationVisualSystem",i)}onPerformanceModeChange(t){t==="performance"?(this._canvas.setPixelSize(128),this._canvas.setStrength(.25)):(this._canvas.setPixelSize(256),this._canvas.setStrength(.4))}destroy(){this._canvas.destroy()}};var $l=[".main-view-container__scroll-node",".main-viewContainer-scrollNode",".main-viewContainer__scrollNode"].join(", ");function Ys(){return document.querySelector($l)}var ee=null,Ji=null;function Pr(l){return(l||globalThis.year3000System)?.cssController||P()}function Wl(){return!1}function Nt(l){if(!Wl()){$t(!1,l),Wt(!1,l);return}let t=Ys();t&&(ee&&ee.parent===t||(ee?.destroy(),ee=new Xi(t,l),window.__SN_DEBUG_ABERRATION&&console.log("[AberrationManager] canvas attached",t),$t(!0,l),Wt(!0,l),l&&ee&&(Ji=new Zi(ee,l.performanceAnalyzer||void 0),l?.registerVisualSystem?.(Ji,"critical"),console.log("[AberrationManager] AberrationCanvas attached"))))}function $t(l,t){Pr(t).setVariable("AberrationManager","--sn-nebula-noise-opacity",l?"0.03":"0","normal","nebula-noise-toggle")}function Wt(l,t){let e={"--aberration-webgl-active":l?"1":"0","--aberration-css-enabled":l?"1":"0","--aberration-hybrid-mode":l?"1":"0"};Pr(t).batchSetVariables("AberrationManager",e,"normal","css-aberration-toggle")}function js(l=null){Nt(l),ee||($t(!1,l),Wt(!1,l));let t=window.Spicetify?.Platform?.History;t?.listen&&t.listen(()=>setTimeout(()=>Nt(l),0)),document.addEventListener("spicetify:appchange",()=>Nt(l));let e=new MutationObserver(()=>{ee?e.disconnect():(Nt(l),ee||($t(!1,l),Wt(!1,l)))});e.observe(document.documentElement,{childList:!0,subtree:!0}),document.addEventListener("year3000SystemSettingsChanged",i=>{let{key:a,value:r}=i.detail||{};if(a==="sn-enable-aberration"){let n=r==="true";n&&!ee?Nt(l):!n&&ee&&(ee.destroy(),ee=null,l?.unregisterAnimationSystem("AberrationCanvas"),Ji?.destroy(),Ji=null,console.log("[AberrationManager] AberrationCanvas detached")),$t(n&&!!ee,l),Wt(n&&!!ee,l)}if(a==="sn-nebula-aberration-strength"){let n=parseFloat(r);!Number.isNaN(n)&&ee&&ee.setStrength(n),Pr(l).setVariable("AberrationManager","--sn-nebula-aberration-strength",String(r),"normal","aberration-strength-update")}})}U();k();var Ks="sn_seen_genres_v1",ea=class{constructor(){let t=typeof localStorage<"u"?localStorage.getItem(Ks):null;this.seen=new Set(t?JSON.parse(t):[])}hasSeen(t){return this.seen.has(t.toLowerCase())}markSeen(t){let e=t.toLowerCase();this.seen.has(e)||(this.seen.add(e),this._persist())}_persist(){try{typeof localStorage<"u"&&localStorage.setItem(Ks,JSON.stringify([...this.seen]))}catch{}}};function ql(l){if(!l.length)return 0;let t=[...l].sort((r,n)=>r-n),e=Math.floor(t.length/2);if(t.length%2!==0)return t[e]??0;let i=t[e-1]??0,a=t[e]??0;return(i+a)/2}var qt=class qt{constructor(t=null,e,i){this.perf=null;this.unsubscribers=[];this.frameDurations=[];this.enabled=!0;this.intensitySetting="balanced";this.intensityFactor=1;this.genreHistory=new ea;this.activeGlowTimeout=null;this.interactionOffHandler=null;this.year3000System=t,this.cssController=e??t?.cssVariableController??P(),this.perf=i||(t?.performanceAnalyzer??null);let a=window.matchMedia("(prefers-reduced-motion: reduce)").matches,r=t?.deviceCapabilityDetector?.deviceCapabilities?.overall,n=t?.settingsManager;switch(n&&(this.intensitySetting=n.get("sn-gradient-intensity")??"balanced"),this.intensitySetting){case"disabled":this.enabled=!1;break;case"minimal":this.intensityFactor=.6;break;case"balanced":this.intensityFactor=1;break;case"intense":this.intensityFactor=1.4;break}(a||r==="low")&&(this.enabled=!1),this.enabled?this._subscribe():this.cssController.setVariable("AudioVisualController","--sn-nebula-beat-intensity","0","low","disabled-initialization")}_subscribe(){let t=[p.subscribe("music:beat",e=>{this._handleBeat({energy:e.intensity,bpm:e.bpm})},"AudioVisualController"),p.subscribe("music:track-changed",e=>{this._handleGenreChange({genre:"unknown"})},"AudioVisualController"),p.subscribe("user:scroll",e=>{this._handleScroll({velocity:e.velocity?.x||e.velocity?.y||0,direction:e.direction==="up"?"up":"down"})},"AudioVisualController")];this.unsubscribers=t.map(e=>()=>p.unsubscribe(e))}_handleBeat(t){let e=performance.now(),i=typeof t.energy=="number"?t.energy:.5,a=(.8+Math.min(Math.max(i,0),1)*.6)*this.intensityFactor;this._queueVar("--sn-nebula-beat-intensity",a.toFixed(3),"high","beat-sync");let r=(i*.6).toFixed(3);this._queueVar("--sn-nebula-aberration-strength",r,"normal","beat-aberration"),this._recordDuration(e)}_handleGenreChange(t){let e=performance.now();if(this.genreHistory.hasSeen(t.genre))return;this.genreHistory.markSeen(t.genre);let i=.18*this.intensityFactor;this._queueVar("--sn-nebula-layer-0-opacity",i.toFixed(3),"high","genre-discovery");let a=()=>{this.year3000System?.timerConsolidationSystem?this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer("AudioVisualController-glowTimeout"):this.activeGlowTimeout&&(clearTimeout(this.activeGlowTimeout),this.activeGlowTimeout=null),this._queueVar("--sn-nebula-layer-0-opacity","0.05","normal","genre-clear"),this.interactionOffHandler&&(document.removeEventListener("pointerdown",this.interactionOffHandler),document.removeEventListener("keydown",this.interactionOffHandler),this.interactionOffHandler=null)};this.year3000System?.timerConsolidationSystem?(this.year3000System.timerConsolidationSystem.registerConsolidatedTimer("AudioVisualController-glowTimeout",a,4e3,"normal"),this.activeGlowTimeout=null):this.activeGlowTimeout=setTimeout(a,4e3),this.interactionOffHandler=()=>a(),document.addEventListener("pointerdown",this.interactionOffHandler,{once:!0}),document.addEventListener("keydown",this.interactionOffHandler,{once:!0}),this._queueVar("--sn-nebula-ease-t","1","normal","ease-trigger"),this._recordDuration(e)}_handleScroll(t){let e=performance.now(),i=typeof t.velocity=="number"?t.velocity:0,r=Math.min(Math.abs(i),50)/50*2*this.intensityFactor;this._queueVar("--sn-nebula-layer-3-blur",`calc(var(--sn-depth-layer-3-blur) + ${r.toFixed(2)}px)`,"normal","scroll-blur");let n=150,o=Math.max(Math.min(t.velocity??0,50),-50)/50*50,c=Math.max(140,Math.min(200,n+o));this._queueVar("--sn-nebula-noise-scale-y",`${c.toFixed(1)}%`,"normal","scroll-noise"),this._recordDuration(e)}_queueVar(t,e,i="normal",a="audio-visual"){this.enabled&&this.cssController.setVariable("AudioVisualController",t,e,i,a)}_recordDuration(t){let e=performance.now()-t;if(this.frameDurations.push(e),this.frameDurations.length>qt.FRAME_HISTORY&&this.frameDurations.shift(),this.frameDurations.length===qt.FRAME_HISTORY){let i=ql(this.frameDurations);i>2&&(console.warn(`[AudioVisualController] Median scripting cost ${i.toFixed(2)} ms exceeds 2 ms budget.`),this._queueVar("--sn-nebula-blend-mode","screen","critical","performance-fallback"))}}destroy(){this.year3000System?.timerConsolidationSystem&&this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer("AudioVisualController-glowTimeout"),this.activeGlowTimeout&&(clearTimeout(this.activeGlowTimeout),this.activeGlowTimeout=null),this.interactionOffHandler&&(document.removeEventListener("pointerdown",this.interactionOffHandler),document.removeEventListener("keydown",this.interactionOffHandler),this.interactionOffHandler=null),this.unsubscribers.forEach(t=>t()),this.unsubscribers=[]}};qt.FRAME_HISTORY=120;var xr=qt;function Qs(l=null){let t=globalThis;if(t.__SN_audioVisualController)return t.__SN_audioVisualController;let e=new xr(l);return t.__SN_audioVisualController=e,e}async function Kt(l,t=5e3){let e=Date.now(),i=null,a=0;for(;Date.now()-e<t;){a++;try{let s=l.split(".").reduce((o,c)=>o?.[c],window);if(s)return console.log(`\u2705 [StarryNight] API ${l} available after ${a} attempts (${Date.now()-e}ms)`),s}catch(s){i=s}await new Promise(s=>setTimeout(s,100))}console.warn(`\u274C [StarryNight] API ${l} timeout after ${t}ms (${a} attempts)`),i&&console.warn(`\u274C [StarryNight] Last error for ${l}:`,i.message);let r=l.split("."),n=window;for(let s=0;s<r.length;s++){let o=r[s];if(!o||!n||typeof n!="object"||n[o]===void 0){console.warn(`\u274C [StarryNight] API path ${l} breaks at '${o}' (step ${s+1}/${r.length})`);break}n=n[o]}return null}async function Ec(l,t=5e3){let e=Date.now(),i=0;for(;Date.now()-e<t;){i++;try{let a=document.querySelector(l);if(a)return console.log(`\u2705 [StarryNight] DOM element '${l}' found after ${i} attempts (${Date.now()-e}ms)`),a}catch(a){console.warn(`\u274C [StarryNight] DOM query error for '${l}':`,a)}await new Promise(a=>setTimeout(a,200))}return console.warn(`\u274C [StarryNight] DOM element '${l}' not found after ${t}ms (${i} attempts)`),null}async function Mc(l=5e3){let t=Date.now();for(;Date.now()-t<l;){try{let e=getComputedStyle(document.documentElement),i=e.getPropertyValue("--spice-base").trim(),a=e.getPropertyValue("--spice-accent").trim(),r=e.getPropertyValue("--spice-text").trim(),n=s=>{let o=s.toLowerCase();return s&&!o.includes("#ffffff")&&!o.includes("#fff")&&!o.includes("white")&&o.match(/^#[0-9a-f]{6}$/i)};if(n(i)&&n(a)&&n(r))return console.log(`\u{1F3A8} [StarryNight] Catppuccin theme loaded: base=${i}, accent=${a}, text=${r}`),!0;console.log(`\u{1F3A8} [StarryNight] Waiting for Catppuccin theme... (base=${i}, accent=${a})`)}catch{}await new Promise(e=>setTimeout(e,200))}return console.warn(`\u{1F3A8} [StarryNight] Catppuccin theme not fully loaded after ${l}ms - proceeding with fallbacks`),!1}function wc(){let l=globalThis;if(l.__STARLIGHT_REACT_SHIM__)return;let t=e=>{if(e==="react")return l.Spicetify?.React;if(e==="react-dom")return l.Spicetify?.ReactDOM;throw new Error(`[StarryNight shim] Module '${e}' not available`)};if(typeof l.require=="function"){let e=l.require.bind(l);l.require=i=>i==="react"||i==="react-dom"?t(i):e(i)}else l.require=t;l.__STARLIGHT_REACT_SHIM__=!0}wc();(async function(){let t=Date.now();if(console.log("\u{1F31F} [Catppuccin StarryNight] Theme entry point starting..."),await qs(1e4)?console.log("\u2705 [StarryNight] Spicetify platform fully ready"):(console.error("\u274C [StarryNight] CRITICAL: Spicetify not fully ready after 10s \u2013 proceeding with degraded visual-only mode."),console.error("\u274C [StarryNight] Available Spicetify objects:",{Spicetify:!!window.Spicetify,showNotification:!!window.Spicetify?.showNotification,Platform:!!window.Spicetify?.Platform})),await Mc(8e3))console.log("\u2705 [StarryNight] Catppuccin theme fully loaded");else{console.error("\u274C [StarryNight] CRITICAL: Catppuccin theme not fully loaded after 8s \u2013 may experience color issues");let h=getComputedStyle(document.documentElement);console.error("\u274C [StarryNight] Current CSS variables:",{base:h.getPropertyValue("--spice-base").trim(),accent:h.getPropertyValue("--spice-accent").trim(),text:h.getPropertyValue("--spice-text").trim()})}let a={player:await Kt("Spicetify.Player",3e3),platform:await Kt("Spicetify.Platform",3e3),menu:await Kt("Spicetify.Menu",2e3),react:await Kt("Spicetify.React",2e3),reactDOM:await Kt("Spicetify.ReactDOM",2e3)},r=[".main-viewContainer-scrollNode",".main-view-container__scroll-node-child",".main-view-container",".main-container","#main","[data-testid='main-container']"],n=null;for(let h of r)if(n=await Ec(h,1e3),n){console.log(`\u2705 [StarryNight] Found main container using selector: ${h}`);break}n?console.log("\u2705 [StarryNight] Enhanced UI features initialized with DOM container"):(console.warn("\u26A0\uFE0F [StarryNight] No suitable main container found - enhanced UI features disabled"),console.warn("\u26A0\uFE0F [StarryNight] Tried selectors:",r.join(", ")),console.warn("\u26A0\uFE0F [StarryNight] Core functionality (music sync, color extraction) will still work"));let o=!(a.player&&a.platform);o?(console.error("\u274C [StarryNight] DEGRADED MODE: Initializing with limited functionality due to missing APIs"),console.error("\u274C [StarryNight] API availability status:",{player:!!a.player,platform:!!a.platform,menu:!!a.menu,react:!!a.react,reactDOM:!!a.reactDOM,mainContainer:!!n+" (optional)"}),console.error("\u274C [StarryNight] DEGRADED MODE limitations:"),console.error("  - Music synchronization disabled"),console.error("  - Advanced visual effects may not function"),console.error("  - UI integration features disabled"),console.error("  - Color extraction from album art disabled")):console.log("\u2705 [StarryNight] FULL MODE: All required APIs available - initializing complete functionality"),!0&&(M.enableDebug=!0,Promise.resolve().then(()=>(Zs(),Xs)).then(h=>{h.enableDragCartography?.(),window.getDragMap=h.getDragMap}));let m=new Ot(M);try{if(o)await m.initializeWithAvailableAPIs({player:a.player,platform:a.platform,config:window.Spicetify?.Config,degradedMode:!0}),console.log("\u{1F31F} [StarryNight] Initialized in degraded mode - visual systems only"),Tc(m,a);else{await m.initializeAllSystems(),m.setupMusicAnalysisAndColorExtraction(),console.log("\u{1F31F} [StarryNight] Full initialization complete");try{Qs(m),js(m),Promise.resolve().then(()=>(ro(),ao)).then(h=>h.enableEnhancedDragPreview?.()),Promise.resolve().then(()=>(mo(),uo)).then(h=>h.enableQuickAddRadialMenu?.()),n&&Promise.resolve().then(()=>(po(),go)).then(h=>h.initializePrismaticScrollSheen?.()),console.log("\u{1F31F} [StarryNight] UI controllers initialized successfully")}catch(h){console.error("[StarryNight] UI controller initialization failed:",h)}}}catch(h){console.error("[StarryNight] System initialization failed:",h)}try{a.react&&a.reactDOM?(await(await Promise.resolve().then(()=>(Ur(),zr))).initializeStarryNightSettings?.(),console.log("\u{1F31F} [StarryNight] Spicetify native settings with Year3000System integration initialized")):console.warn("\u{1F31F} [StarryNight] React APIs not available - continuing with CSS-only theme")}catch(h){console.error("[StarryNight] Failed to initialize native settings:",h),console.warn("\u{1F31F} [StarryNight] Continuing with CSS-only theme (no settings UI)")}M.enableDebug&&(window.Y3K={system:m,music:m.musicSyncService,settings:m.settingsManager,debug:u.debug,health:m.systemHealthMonitor,mode:o?"degraded":"full",availableAPIs:a});try{let{SidebarVisualEffectsSystem:h}=await Promise.resolve().then(()=>(Di(),ss)),{SidebarPerformanceCoordinator:g}=await Promise.resolve().then(()=>(mr(),Cs));if(m.performanceAnalyzer){let f=g.getInstance({enableDebug:M.enableDebug,performanceAnalyzer:m.performanceAnalyzer,onFlushComplete:()=>{m.performanceAnalyzer?.emitTrace?.("[SidebarPerformanceCoordinator] Flush completed")}}),v=new h(M,D,m.performanceAnalyzer,m.musicSyncService,m.settingsManager,m);await v.initialize(),m.sidebarVisualEffectsSystem=v,m.sidebarCoordinator=f}}catch(h){console.error("[StarryNight] Failed to initialize Consolidated Sidebar System",h)}try{let{DepthVisualEffectsController:h}=await Promise.resolve().then(()=>(vo(),So)),g=new h(M,D,m.performanceAnalyzer,m.musicSyncService,m.settingsManager);await g.initialize(),m.depthController=g,m.depthConsciousnessController=g,console.log("\u{1F30A} [StarryNight] Depth Visual Effects Controller initialized")}catch(h){console.error("[StarryNight] Failed to initialize DepthVisualEffectsController",h)}try{let{DynamicCatppuccinBridge:h}=await Promise.resolve().then(()=>(Eo(),Co)),g=new h(M,D,m.performanceAnalyzer,m.musicSyncService,m.settingsManager);await g.initialize(),m.colorHarmonyEngine&&g.linkWithColorHarmonyEngine(m.colorHarmonyEngine),m.depthController&&g.linkWithDepthVisual(m.depthController),m.dynamicCatppuccinBridge=g,console.log("\u{1F3A8} [StarryNight] Dynamic Catppuccin Bridge connected")}catch(h){console.error("[StarryNight] Failed to initialize DynamicCatppuccinBridge",h)}try{let{DynamicGradientStrategy:h}=await Promise.resolve().then(()=>(nr(),ds)),g=new h(M,D,m.performanceAnalyzer,m.musicSyncService,m.settingsManager);await g.initialize(),m.dynamicCatppuccinBridge&&console.log("\u{1F30A} [StarryNight] Consolidated Dynamic Gradient System linked with Dynamic Catppuccin Bridge"),m.depthController&&console.log("\u{1F30A} [StarryNight] Consolidated Dynamic Gradient System linked with Depth Controller"),m.dynamicGradientSystem=g,m.livingGradientStrategy=g,console.log("\u{1F30A} [StarryNight] Consolidated Dynamic Gradient Strategy System awakened - unified color processing and visual system lifecycle with performance optimizations")}catch(h){console.error("[StarryNight] Failed to initialize Consolidated Dynamic Gradient Strategy System",h)}try{let{CDFVariableBridge:h}=await Promise.resolve().then(()=>(wo(),Mo));m.cssVariableController&&new h(m.cssVariableController)}catch(h){console.error("[StarryNight] Failed to initialize CDFVariableBridge",h)}let d=Date.now()-t;console.log(`\u{1F30C} Catppuccin StarryNight Theme initialized in ${d}ms (${o?"degraded":"full"} mode). Welcome to the future of sound!`)})();function Tc(l,t){console.log("\u{1F504} [StarryNight] Setting up progressive enhancement monitoring...");let e=0,i=30,a=1e4,r=()=>{e++;let o={player:window.Spicetify?.Player,platform:window.Spicetify?.Platform,menu:window.Spicetify?.Menu,react:window.Spicetify?.React,reactDOM:window.Spicetify?.ReactDOM};if(o.player&&o.platform){console.log("\u2705 [StarryNight] Required APIs now available - upgrading to full mode!"),clearInterval(n),Pc(l,o).then(()=>{console.log("\u{1F31F} [StarryNight] Successfully upgraded from degraded mode to full mode!"),window.Y3K&&(window.Y3K.mode="full",window.Y3K.availableAPIs=o)}).catch(m=>{console.error("\u274C [StarryNight] Failed to upgrade to full mode:",m)});return}if(e>=i){console.log(`\u23F0 [StarryNight] Progressive enhancement monitoring ended after ${e} attempts (${e*a/1e3}s)`),clearInterval(n);return}e%5===0&&(console.log(`\u{1F504} [StarryNight] Still monitoring for API availability... (attempt ${e}/${i})`),console.log("\u{1F504} [StarryNight] Current API status:",{player:!!o.player,platform:!!o.platform,menu:!!o.menu,react:!!o.react,reactDOM:!!o.reactDOM}))},n=setInterval(r,a),s=()=>{console.log("\u{1F3B5} [StarryNight] Spicetify ready event detected - checking for upgrade..."),r()};window.Spicetify&&window.Spicetify.Player&&window.Spicetify.Player.addEventListener?.("songchange",s),setTimeout(()=>{window.Spicetify?.Player&&window.Spicetify.Player.removeEventListener?.("songchange",s)},i*a)}async function Pc(l,t){try{if(console.log("\u{1F680} [StarryNight] Beginning upgrade to full mode..."),!l)throw new Error("Year3000System instance not available");if(typeof l.upgradeToFullMode=="function")console.log("\u{1F527} [StarryNight] Using system's built-in upgrade method..."),await l.upgradeToFullMode({player:t.player,platform:t.platform,config:window.Spicetify?.Config,degradedMode:!1});else if(console.log("\u{1F527} [StarryNight] System upgrade method not available - attempting manual initialization..."),l.setupMusicAnalysisAndColorExtraction&&(console.log("\u{1F3B5} [StarryNight] Setting up music analysis and color extraction..."),await l.setupMusicAnalysisAndColorExtraction()),t.react&&t.reactDOM)try{console.log("\u2699\uFE0F [StarryNight] Initializing settings UI..."),await(await Promise.resolve().then(()=>(Ur(),zr))).initializeStarryNightSettings?.(),console.log("\u2705 [StarryNight] Settings UI initialized successfully")}catch(e){console.warn("\u26A0\uFE0F [StarryNight] Failed to initialize settings UI during upgrade:",e)}l.eventBus?.emitSync&&l.eventBus.emitSync("system:upgraded-to-full-mode",{timestamp:Date.now(),availableAPIs:{player:!!t.player,platform:!!t.platform,menu:!!t.menu,react:!!t.react,reactDOM:!!t.reactDOM}}),console.log("\u{1F31F} [StarryNight] Upgrade to full mode completed successfully!")}catch(e){throw console.error("\u274C [StarryNight] Upgrade to full mode failed:",e),e}}})();
