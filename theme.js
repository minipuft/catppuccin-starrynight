"use strict";(()=>{var Io=Object.create;var Qt=Object.defineProperty;var Do=Object.getOwnPropertyDescriptor;var ko=Object.getOwnPropertyNames;var Lo=Object.getPrototypeOf,Ro=Object.prototype.hasOwnProperty;var Wr=(c=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(c,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):c)(function(c){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+c+'" is not supported')});var y=(c,e)=>()=>(c&&(e=c(c=0)),e);var ie=(c,e)=>{for(var t in e)Qt(c,t,{get:e[t],enumerable:!0})},qr=(c,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of ko(e))!Ro.call(c,a)&&a!==t&&Qt(c,a,{get:()=>e[a],enumerable:!(i=Do(e,a))||i.enumerable});return c};var Yr=(c,e,t)=>(t=c!=null?Io(Lo(c)):{},qr(e||!c||!c.__esModule?Qt(t,"default",{value:c,enumerable:!0}):t,c)),Bo=c=>qr(Qt({},"__esModule",{value:!0}),c);var Kr,jr,at,ra=y(()=>{"use strict";Kr={latte:{name:"Latte",base:"#eff1f5",text:"#4c4f69",isDark:!1},frappe:{name:"Frapp\xE9",base:"#303446",text:"#c6d0f5",isDark:!0},macchiato:{name:"Macchiato",base:"#24273a",text:"#cad3f5",isDark:!0},mocha:{name:"Mocha",base:"#1e1e2e",text:"#cdd6f4",isDark:!0}},jr=["rosewater","flamingo","pink","mauve","red","maroon","peach","yellow","green","teal","sky","sapphire","blue","lavender","text","none"],at={flavor:c=>typeof c=="string"&&c in Kr,accentColor:c=>typeof c=="string"&&jr.includes(c),brightnessMode:c=>typeof c=="string"&&["bright","balanced","dark"].includes(c),paletteSystem:c=>typeof c=="string"&&["catppuccin","year3000"].includes(c),gradientIntensity:c=>typeof c=="string"&&["disabled","minimal","balanced","intense"].includes(c),glassmorphismLevel:c=>typeof c=="string"&&["disabled","minimal","moderate","intense"].includes(c),webglEnabled:c=>typeof c=="boolean"||typeof c=="string"&&["true","false"].includes(c),animationQuality:c=>typeof c=="string"&&["auto","low","high"].includes(c),webglQuality:c=>typeof c=="string"&&["low","medium","high"].includes(c)}});var yt,na,sa,rt,Xt=y(()=>{"use strict";yt={"analogous-flow":{rule:"analogous",angle:30,description:"Flowing cinematic gradients with adjacent hues"},"triadic-trinity":{rule:"triadic",angle:120,description:"Dramatic three-color gradient dynamics"},"complementary-yin-yang":{rule:"complementary",angle:180,description:"Electric contrast gradients with opposing forces"},"tetradic-advanced-cross":{rule:"tetradic",angle:90,description:"Complex four-color gradient matrix"},"split-complementary-spectrum":{rule:"split-complementary",angle:150,description:"Spectrum-like gradient flows with polar contrasts"},"monochromatic-calm":{rule:"monochromatic",angle:0,description:"Intense single-hue gradient depth"}},na={energyScaling:{low:.8,medium:1.2,high:1.8},valenceScaling:{sad:1,neutral:1.2,happy:1.6},danceabilityEffects:{enable:!0,animationSpeedMultiplier:1.5,blurVariation:.3}},sa={enable:!0,useSmartCalculation:!0,useRealisticData:!0,danceabilityEstimation:{highDance:{min:120,max:140,value:.8},mediumDance:{min:100,max:160,value:.6},lowMediumDance:{min:80,max:180,value:.4},lowDance:{value:.2}},energyEstimation:{tempoWeight:.6,loudnessWeight:.4,tempoRange:{min:60,max:180},loudnessRange:{min:-60,max:0}},danceabilityThresholds:{high:.7,low:.3},energyMultiplierRange:{min:.8,max:1.4},tempoMultipliers:{highDance:1,mediumDance:.75,lowDance:.5},fallbacks:{tempo:120,loudness:-10,danceability:.5,energy:.5,key:0,timeSignature:4}},rt={...yt,"tetradic-cosmic-cross":yt["tetradic-advanced-cross"],"split-complementary-aurora":yt["split-complementary-spectrum"],"monochromatic-meditation":yt["monochromatic-calm"]}});var ke,Zt=y(()=>{"use strict";ke={"corporate-safe":{displayName:"Corporate Safe",description:"Subtle gradient elegance with professional restraint and refined color transitions",philosophy:"Gentle gradient flows that maintain workspace harmony while providing sophisticated visual depth",multipliers:{opacity:.2,saturation:1.15,brightness:1.08,contrast:1.05,musicEnergyBoost:.4,animationIntensity:.3,timeBasedEffectFactor:.2,interactionStrength:.2,advancedAnimations:!1,visualIntensityBase:.9,kineticIntensity:.3,timeBasedPlayFactor:.2,aestheticGravityStrength:.2,emergentChoreography:!1},features:{rippleEffects:!1,timeBasedEcho:!1,particleStreams:!1,predictiveHighlights:!0,glassEffects:!0,beatSync:!1,colorHarmony:!1,userInteractions:!1,aestheticGravity:!1},performance:{maxParticles:0,animationThrottle:32,enableGPUAcceleration:!1,reducedMotion:!0}},"artist-vision":{displayName:"Artist Vision",description:"Cinematic gradient expression with vibrant, flowing color transitions",philosophy:"Dramatic gradient harmonies that create depth and emotional resonance through bold color interactions",multipliers:{opacity:.35,saturation:1.45,brightness:1.25,contrast:1.3,musicEnergyBoost:1.2,animationIntensity:.8,timeBasedEffectFactor:.7,interactionStrength:.6,advancedAnimations:!0,visualIntensityBase:1.2,kineticIntensity:.8,timeBasedPlayFactor:.7,aestheticGravityStrength:.6,emergentChoreography:!0},features:{rippleEffects:!0,timeBasedEcho:!0,particleStreams:!0,predictiveHighlights:!0,glassEffects:!0,beatSync:!0,colorHarmony:!0,userInteractions:!0,aestheticGravity:!0},performance:{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1}},"advanced-maximum":{displayName:"Advanced Maximum",description:"Ultra-intense cinematic gradients with maximum color saturation and fluid dynamics",philosophy:"Maximum gradient intensity through electric color combinations that create immersive visual landscapes",multipliers:{opacity:.55,saturation:1.65,brightness:1.35,contrast:1.5,musicEnergyBoost:2.5,animationIntensity:2,timeBasedEffectFactor:3,interactionStrength:2,advancedAnimations:!0,visualIntensityBase:1.8,kineticIntensity:2,timeBasedPlayFactor:3,aestheticGravityStrength:2,emergentChoreography:!0},features:{rippleEffects:!0,timeBasedEcho:!0,particleStreams:!0,predictiveHighlights:!0,glassEffects:!0,beatSync:!0,colorHarmony:!0,userInteractions:!0,aestheticGravity:!0},performance:{maxParticles:50,animationThrottle:30,enableGPUAcceleration:!0,reducedMotion:!1}}};ke["cosmic-maximum"]={...ke["advanced-maximum"],displayName:"Cosmic Maximum",description:"Ultra-intense cinematic gradients with maximum color saturation and fluid dynamics",philosophy:"Maximum gradient intensity through electric color combinations that create immersive visual landscapes"}});var Jt,oa,ca=y(()=>{"use strict";Jt={low:{maxParticles:15,animationThrottle:32,enableGPUAcceleration:!1,enableAdvancedShaders:!1,textureResolution:.5},balanced:{maxParticles:40,animationThrottle:16,enableGPUAcceleration:!0,enableAdvancedShaders:!1,textureResolution:1},high:{maxParticles:75,animationThrottle:16,enableGPUAcceleration:!0,enableAdvancedShaders:!0,textureResolution:1},ultra:{maxParticles:150,animationThrottle:8,enableGPUAcceleration:!0,enableAdvancedShaders:!0,textureResolution:2}},oa={level:"info",performance:{enableFrameBudgetWarnings:!0,throttleWarnings:!0,throttleInterval:5e3,enableAdaptiveDegradation:!0}}});var Qr,Xr,Zr,ei=y(()=>{"use strict";Qr="sn-harmonic-intensity",Xr="sn-harmonic-evolution",Zr="sn-glassmorphism-level"});function ti(c,e){return ye[c].validator(e)}function ii(c,e){let t=ye[c];return t.parser?t.parser(e):t.validator(e)?e:null}function la(c,e){let t=ye[c];return t.serializer?t.serializer(e):String(e)}function ai(c){return ye[c].defaultValue}function bt(){return Object.keys(ye)}function ri(c){return c in ye}var ye,ua=y(()=>{"use strict";Xt();Zt();ra();ye={"catppuccin-flavor":{defaultValue:"mocha",validator:at.flavor,description:"Catppuccin color theme variant",category:"core"},"catppuccin-accentColor":{defaultValue:"mauve",validator:at.accentColor,description:"Primary accent color for UI elements",category:"core"},"sn-brightness-mode":{defaultValue:"bright",validator:at.brightnessMode,description:"Overall theme brightness level",category:"core"},"sn-palette-system":{defaultValue:"catppuccin",validator:at.paletteSystem,description:"Color palette system (Catppuccin or Year 3000)",category:"advanced"},"sn-artistic-mode":{defaultValue:"artist-vision",validator:c=>typeof c=="string"&&c in ke,description:"Visual intensity and behavior preset",category:"advanced"},"sn-current-harmonic-mode":{defaultValue:"analogous-flow",validator:c=>typeof c=="string"&&c in rt,description:"Color harmony rule for music synchronization",category:"advanced"},"sn-harmonic-intensity":{defaultValue:.7,validator:c=>typeof c=="number"&&c>=0&&c<=1,parser:c=>{let e=parseFloat(c);return!isNaN(e)&&e>=0&&e<=1?e:null},serializer:c=>c.toString(),description:"Intensity of color harmony effects (0-1)",category:"advanced"},"sn-harmonic-evolution":{defaultValue:!0,validator:c=>typeof c=="boolean",parser:c=>c==="true"?!0:c==="false"?!1:null,serializer:c=>c.toString(),description:"Enable dynamic color harmony evolution",category:"advanced"},"sn-gradient-intensity":{defaultValue:"balanced",validator:c=>typeof c=="string"&&["disabled","minimal","balanced","intense"].includes(c),description:"Master control for all gradient background effects",category:"visual"},"sn-glassmorphism-level":{defaultValue:"balanced",validator:c=>typeof c=="string"&&["disabled","minimal","balanced","intense"].includes(c),description:"Glass-like transparency effects intensity",category:"visual"},"sn-webgl-enabled":{defaultValue:!0,validator:c=>typeof c=="boolean",parser:c=>c==="true"?!0:c==="false"?!1:null,serializer:c=>c.toString(),description:"Enable WebGL-accelerated visual effects",category:"performance"},"sn-animation-quality":{defaultValue:"auto",validator:c=>typeof c=="string"&&["auto","low","high"].includes(c),description:"Animation performance vs quality balance",category:"performance"},"sn-webgl-quality":{defaultValue:"medium",validator:c=>typeof c=="string"&&["low","medium","high"].includes(c),description:"WebGL rendering quality level",category:"performance"}}});var vt,ma=y(()=>{"use strict";ua();vt=class{constructor(e){this.changeListeners=new Set;this.cache=new Map;this.storage=e}get(e){if(this.cache.has(e))return this.cache.get(e);let t=ye[e],i=this.storage.get(e);if(i==null){let r=t.defaultValue;return this.cache.set(e,r),r}let a=ii(e,i);if(a===null){console.warn(`[TypedSettingsManager] Invalid stored value for ${e}: "${i}", using default`);let r=t.defaultValue;return this.cache.set(e,r),r}return this.cache.set(e,a),a}set(e,t){if(!ti(e,t))return console.error(`[TypedSettingsManager] Invalid value for ${e}:`,t),!1;let i=this.cache.get(e)??this.get(e),a=la(e,t),r=this.storage.set(e,a);if(r){this.cache.set(e,t);let n={settingKey:e,oldValue:i,newValue:t,timestamp:Date.now()};this.notifyChangeListeners(n)}return r}getMultiple(e){let t={};for(let i of e)t[i]=this.get(i);return t}setMultiple(e){let t={};for(let[i,a]of Object.entries(e))ri(i)&&(t[i]=this.set(i,a));return t}getAllSettings(){let e={};for(let t of bt())e[t]=this.get(t);return e}reset(e){let t=ai(e);return this.set(e,t)}resetAll(){let e={};for(let t of bt())e[t]=this.reset(t);return e}exists(e){return this.storage.get(e)!==null}remove(e){let t=this.storage.remove(e);return t&&this.cache.delete(e),t}clearCache(){this.cache.clear()}onChange(e){this.changeListeners.add(e)}offChange(e){this.changeListeners.delete(e)}notifyChangeListeners(e){for(let t of this.changeListeners)try{t(e)}catch(i){console.error("[TypedSettingsManager] Error in change listener:",i)}}validateAllSettings(){let e={valid:0,invalid:[],missing:[]};for(let t of bt()){let i=this.storage.get(t);if(i===null){e.missing.push({key:t,usingDefault:ai(t)});continue}ii(t,i)===null?e.invalid.push({key:t,value:i,error:"Failed to parse or validate value"}):e.valid++}return e}export(){return this.getAllSettings()}import(e){let t={imported:0,failed:[]};for(let[i,a]of Object.entries(e)){if(!ri(i)){t.failed.push({key:i,error:"Unknown setting key"});continue}if(!ti(i,a)){t.failed.push({key:i,error:"Invalid value for setting"});continue}this.set(i,a)?t.imported++:t.failed.push({key:i,error:"Failed to store setting"})}return t}}});function da(){return new Ke}var Ke,ha=y(()=>{"use strict";Ke=class{constructor(){this._available=null}isAvailable(){if(this._available!==null)return this._available;try{return this._available=typeof Spicetify<"u"&&typeof Spicetify.LocalStorage?.get=="function"&&typeof Spicetify.LocalStorage?.set=="function",this._available&&Spicetify.LocalStorage.get("__test__"),this._available}catch(e){return console.warn("[SpicetifyStorageAdapter] Spicetify.LocalStorage not available:",e),this._available=!1,!1}}get(e){if(!this.isAvailable())return console.warn(`[SpicetifyStorageAdapter] Cannot get ${e}: Spicetify not available`),null;try{return Spicetify.LocalStorage.get(e)}catch(t){return console.error(`[SpicetifyStorageAdapter] Error reading key ${e}:`,t),null}}set(e,t){if(!this.isAvailable())return console.warn(`[SpicetifyStorageAdapter] Cannot set ${e}: Spicetify not available`),!1;try{return Spicetify.LocalStorage.set(e,t),!0}catch(i){return console.error(`[SpicetifyStorageAdapter] Error setting key ${e}:`,i),!1}}remove(e){if(!this.isAvailable())return console.warn(`[SpicetifyStorageAdapter] Cannot remove ${e}: Spicetify not available`),!1;try{return typeof Spicetify.LocalStorage.remove=="function"?Spicetify.LocalStorage.remove(e):Spicetify.LocalStorage.set(e,null),!0}catch(t){return console.error(`[SpicetifyStorageAdapter] Error removing key ${e}:`,t),!1}}healthCheck(){let e={available:!1,readable:!1,writable:!1,issues:[]};if(e.available=this.isAvailable(),!e.available)return e.issues.push("Spicetify.LocalStorage not available"),e;try{this.get("__health_check_read__"),e.readable=!0}catch(t){e.issues.push(`Read test failed: ${t}`)}try{let t="__health_check_write__",i="test_"+Date.now();this.set(t,i)?this.get(t)===i?(e.writable=!0,this.remove(t)):e.issues.push("Write-read consistency test failed"):e.issues.push("Write operation failed")}catch(t){e.issues.push(`Write test failed: ${t}`)}return e}getDiagnostics(){let e=[];return typeof Spicetify<"u"&&Spicetify.LocalStorage&&e.push(...Object.getOwnPropertyNames(Spicetify.LocalStorage)),{spicetifyVersion:typeof Spicetify<"u"?Spicetify.version:void 0,apiMethods:e,testResults:this.healthCheck()}}}});function ga(c){return new nt(c)}var nt,pa=y(()=>{"use strict";nt=class{constructor(e="sn-"){this.prefix=e}getPrefixedKey(e){return e.startsWith(this.prefix)?e:`${this.prefix}${e}`}isAvailable(){try{return typeof localStorage<"u"&&localStorage!==null}catch{return!1}}get(e){if(!this.isAvailable())return console.warn(`[BrowserStorageAdapter] localStorage not available for key: ${e}`),null;try{return localStorage.getItem(this.getPrefixedKey(e))}catch(t){return console.error(`[BrowserStorageAdapter] Error reading key ${e}:`,t),null}}set(e,t){if(!this.isAvailable())return console.warn(`[BrowserStorageAdapter] localStorage not available for key: ${e}`),!1;try{return localStorage.setItem(this.getPrefixedKey(e),t),!0}catch(i){return console.error(`[BrowserStorageAdapter] Error setting key ${e}:`,i),!1}}remove(e){if(!this.isAvailable())return console.warn(`[BrowserStorageAdapter] localStorage not available for key: ${e}`),!1;try{return localStorage.removeItem(this.getPrefixedKey(e)),!0}catch(t){return console.error(`[BrowserStorageAdapter] Error removing key ${e}:`,t),!1}}getAllKeys(){if(!this.isAvailable())return[];let e=[];try{for(let t=0;t<localStorage.length;t++){let i=localStorage.key(t);i&&i.startsWith(this.prefix)&&e.push(i.substring(this.prefix.length))}}catch(t){console.error("[BrowserStorageAdapter] Error enumerating keys:",t)}return e}clear(){if(!this.isAvailable())return!1;try{let e=this.getAllKeys();for(let t of e)localStorage.removeItem(this.getPrefixedKey(t));return!0}catch(e){return console.error("[BrowserStorageAdapter] Error clearing storage:",e),!1}}getUsageStats(){let e={totalKeys:0,totalSize:0,avgKeySize:0};if(!this.isAvailable())return e;try{let t=this.getAllKeys();e.totalKeys=t.length;for(let i of t){let a=this.get(i);a!==null&&(e.totalSize+=i.length+a.length)}e.avgKeySize=e.totalKeys>0?e.totalSize/e.totalKeys:0,typeof navigator<"u"&&"storage"in navigator&&"estimate"in navigator.storage&&navigator.storage.estimate().then(i=>{i.quota!==void 0&&(e.availableQuota=i.quota)}).catch(()=>{})}catch(t){console.error("[BrowserStorageAdapter] Error calculating usage stats:",t)}return e}}});function Jr(){return fa||(fa=new ni),fa}function je(){return Jr().getSettings()}var ni,fa,A,en=y(()=>{"use strict";ma();ha();pa();ni=class{constructor(e){this.storageAdapter=e||this.detectBestStorage(),this.settingsManager=new vt(this.storageAdapter)}detectBestStorage(){let e=da(),t=e.healthCheck();if(t.available&&t.readable&&t.writable)return console.log("[SettingsProvider] Using Spicetify storage adapter"),e;let i=ga();return console.log("[SettingsProvider] Using browser storage adapter (localStorage)"),i}getSettings(){return this.settingsManager}getStorage(){return this.storageAdapter}getDiagnostics(){let e=this.storageAdapter instanceof Ke?"spicetify":this.storageAdapter instanceof nt?"browser":"unknown",t=null;return this.storageAdapter instanceof Ke&&(t=this.storageAdapter.healthCheck()),{storageType:e,storageHealth:t,settingsValidation:this.settingsManager.validateAllSettings(),totalSettings:Object.keys(this.settingsManager.getAllSettings()).length}}async migrateFromLegacyStorage(e){console.log("[SettingsProvider] Starting legacy settings migration...");let t=this.settingsManager.import(e);return t.imported>0&&console.log(`[SettingsProvider] Successfully migrated ${t.imported} settings`),t.failed.length>0&&console.warn(`[SettingsProvider] Failed to migrate ${t.failed.length} settings:`,t.failed),{migrated:t.imported,failed:t.failed}}healthCheck(){let e=this.getDiagnostics(),t=e.settingsValidation,i={overall:"healthy",storage:{type:e.storageType,available:!0,issues:[]},settings:{valid:t.valid,invalid:t.invalid.length,missing:t.missing.length},recommendations:[]};return e.storageHealth&&(i.storage.available=e.storageHealth.available,e.storageHealth.issues&&(i.storage.issues=e.storageHealth.issues)),!i.storage.available||i.storage.issues.length>0?(i.overall="unhealthy",i.recommendations.push("Storage system needs attention")):i.settings.invalid>0?(i.overall="degraded",i.recommendations.push("Some settings have invalid values")):i.settings.missing>5&&(i.overall="degraded",i.recommendations.push("Many settings are using defaults")),i.settings.invalid>0&&i.recommendations.push("Run settings validation and repair"),e.storageType==="browser"&&i.recommendations.push("Consider using in Spicetify environment for better integration"),i}},fa=null;A={get:c=>je().get(c),set:(c,e)=>je().set(c,e),reset:c=>je().reset(c),onChange:c=>je().onChange(c),export:()=>je().export(),import:c=>je().import(c)}});var be=y(()=>{"use strict";ra();Xt();Zt();ca();ei();ma();ua();en();ha();pa();be()});var ve,Qe,E,U=y(()=>{"use strict";be();Xt();Zt();ca();ve=rt,Qe=ke,E={enableDebug:!0,enableContextualIntelligence:!0,paletteSystem:"catppuccin",performanceProfiles:Jt,logging:oa,healthCheckInterval:1e4,visual:{lightweightParticleSystem:{mode:"artist-vision"},spatialNexusSystem:{mode:"artist-vision"},dataGlyphSystem:{mode:"artist-vision"},beatSyncVisualSystem:{mode:"artist-vision"},behavioralPredictionEngine:{mode:"artist-vision"},predictiveMaterializationSystem:{mode:"artist-vision"},sidebarVisualStateSystem:{mode:"artist-vision"}},enableColorExtraction:!0,enableMusicAnalysis:!0,enableAdvancedSync:!0,musicModulationIntensity:.4,artisticMode:"artist-vision",boundGetCurrentMultipliers:null,boundGetCurrentFeatures:null,boundGetCurrentPerformanceSettings:null,_pendingArtisticMode:null,init(){return this.boundGetCurrentMultipliers=this.getCurrentMultipliers.bind(this),this.boundGetCurrentFeatures=this.getCurrentFeatures.bind(this),this.boundGetCurrentPerformanceSettings=this.getCurrentPerformanceSettings.bind(this),!this.artisticMode||!this.paletteSystem?(this.enableDebug&&console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Loading preferences (current: artistic=${this.artisticMode}, palette=${this.paletteSystem})`),this.loadArtisticPreference()):this.enableDebug&&console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Skipping preference load (current: artistic=${this.artisticMode}, palette=${this.paletteSystem})`),this._pendingArtisticMode&&this.isFullyInitialized()&&(this.enableDebug&&console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Applying pending artistic mode: ${this._pendingArtisticMode}`),this.setArtisticMode(this._pendingArtisticMode),this._pendingArtisticMode=null),this.enableDebug&&console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Initialized with context-bound methods"),this},currentColorHarmonyMode:"analogous-flow",colorHarmonyBaseColor:null,colorHarmonyIntensity:.85,colorHarmonyEvolution:!0,musicVisualSync:{...na,enhancedBPM:sa},getCurrentModeProfile(){let c=this.artisticMode||"artist-vision";return Qe[c]||Qe["artist-vision"]},getCurrentMultipliers(){try{if(typeof this.getCurrentModeProfile!="function")return console.warn("[ADVANCED_SYSTEM_CONFIG] getCurrentModeProfile method not available, using fallback multipliers"),this.artisticMultipliers;let c=this.getCurrentModeProfile();return!c||!c.multipliers?(console.warn("[ADVANCED_SYSTEM_CONFIG] Invalid profile or missing multipliers, using fallback"),this.artisticMultipliers):c.multipliers}catch(c){return console.error("[ADVANCED_SYSTEM_CONFIG] Error in getCurrentMultipliers:",c),this.artisticMultipliers}},getCurrentFeatures(){try{if(typeof this.getCurrentModeProfile!="function")return console.warn("[ADVANCED_SYSTEM_CONFIG] getCurrentModeProfile method not available, using fallback features"),{enableAdvancedEffects:!0,enableHarmony:!0,beatSync:!0,colorHarmony:!0};let c=this.getCurrentModeProfile();return!c||!c.features?(console.warn("[ADVANCED_SYSTEM_CONFIG] Invalid profile or missing features, using fallback"),{enableAdvancedEffects:!0,enableHarmony:!0,beatSync:!0,colorHarmony:!0}):c.features}catch(c){return console.error("[ADVANCED_SYSTEM_CONFIG] Error in getCurrentFeatures:",c),{enableAdvancedEffects:!0,enableHarmony:!0,beatSync:!0,colorHarmony:!0}}},getCurrentPerformanceSettings(){try{if(typeof this.getCurrentModeProfile!="function")return console.warn("[ADVANCED_SYSTEM_CONFIG] getCurrentModeProfile method not available, using fallback performance settings"),{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1};let c=this.getCurrentModeProfile();return!c||!c.performance?(console.warn("[ADVANCED_SYSTEM_CONFIG] Invalid profile or missing performance settings, using fallback"),{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1}):c.performance}catch(c){return console.error("[ADVANCED_SYSTEM_CONFIG] Error in getCurrentPerformanceSettings:",c),{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1}}},isFullyInitialized(){return["setArtisticMode","getCurrentModeProfile","getCurrentMultipliers","getCurrentFeatures","getCurrentPerformanceSettings"].every(e=>typeof this[e]=="function")},safeSetArtisticMode(c){return this.isFullyInitialized()?this.setArtisticMode(c):(console.warn("[ADVANCED_SYSTEM_CONFIG] Not fully initialized, deferring artistic mode change"),this._pendingArtisticMode=c,!1)},setArtisticMode(c){let e=Object.keys(Qe);if(e.includes(c)){let t=this.artisticMode;return this.artisticMode=c,this.enableDebug&&(console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Artistic mode changed: ${t} \u2192 ${c}`),console.log("\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] New profile:",this.getCurrentModeProfile())),typeof document<"u"&&document.dispatchEvent(new CustomEvent("year3000ArtisticModeChanged",{detail:{previousMode:t,newMode:c,profile:this.getCurrentModeProfile()}})),typeof globalThis.year3000System<"u"&&globalThis.year3000System.setGradientParameters&&globalThis.year3000System.setGradientParameters(document.documentElement),!0}return console.warn(`[ADVANCED_SYSTEM_CONFIG] Invalid artistic mode: ${c}. Valid modes:`,e),!1},setLoggingLevel(c){let e=["off","error","warn","info","debug","verbose"];return e.includes(c)?(this.logging.level=c,c!=="off"&&console.log(`\u{1F527} [ADVANCED_SYSTEM_CONFIG] Logging level set to: ${c}`),!0):(console.warn(`[ADVANCED_SYSTEM_CONFIG] Invalid logging level: ${c}. Valid levels:`,e),!1)},disablePerformanceWarnings(){this.logging.performance.enableFrameBudgetWarnings=!1,console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Performance warnings disabled")},enablePerformanceWarnings(){this.logging.performance.enableFrameBudgetWarnings=!0,console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Performance warnings enabled")},setPerformanceWarningThrottle(c){return typeof c=="number"&&c>=0?(this.logging.performance.throttleInterval=c,this.logging.performance.throttleWarnings=c>0,console.log(`\u{1F527} [ADVANCED_SYSTEM_CONFIG] Performance warning throttle set to: ${c}ms`),!0):(console.warn("[ADVANCED_SYSTEM_CONFIG] Invalid throttle interval. Must be a non-negative number."),!1)},setupForProduction(){this.setLoggingLevel("warn"),this.disablePerformanceWarnings(),this.logging.performance.enableAdaptiveDegradation=!0,console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Configured for production environment")},setupForDevelopment(){this.setLoggingLevel("debug"),this.enablePerformanceWarnings(),this.setPerformanceWarningThrottle(2e3),this.logging.performance.enableAdaptiveDegradation=!0,console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Configured for development environment")},setupForDebugging(){this.setLoggingLevel("verbose"),this.enablePerformanceWarnings(),this.setPerformanceWarningThrottle(500),this.logging.performance.enableAdaptiveDegradation=!1,console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Configured for debugging environment")},validateConfigHealth(){let c={overallStatus:"healthy",issues:[],dynamicChecks:{}},t=Object.keys(this).filter(a=>typeof this[a]=="function");for(let a of t)this.hasOwnProperty(a)||c.issues.push({key:String(a),severity:"warning",message:`Method ${a} is not an own property, may indicate prototype chain issues.`});let i=a=>{if(!Qe[a]){c.issues.push({key:`artisticMode:${a}`,severity:"critical",message:`Artistic mode profile for '${a}' is missing.`});return}c.dynamicChecks[`${a}Profile`]="ok"};return i(this.artisticMode),i("artist-vision"),i("corporate-safe"),c.issues.length>0&&(c.overallStatus=c.issues.some(a=>a.severity==="critical")?"critical":"unhealthy"),this.enableDebug&&console.log("[ADVANCED_SYSTEM_CONFIG] Health Check Report:",c),c},loadArtisticPreference(){try{let c=A.get("sn-artistic-mode"),e=Object.keys(Qe);c&&e.includes(String(c))&&this.artisticMode!==c?(this.artisticMode=String(c),this.enableDebug&&console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Updated artistic mode from storage: ${c}`)):!c&&this.artisticMode!=="artist-vision"&&(this.artisticMode="artist-vision",this.enableDebug&&console.log("\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Reset artistic mode to default: artist-vision"));let t=A.get("sn-palette-system");t&&["catppuccin","year3000"].includes(String(t))&&this.paletteSystem!==t?(this.paletteSystem=String(t),this.enableDebug&&console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Updated palette system from storage: ${t}`)):!t&&this.paletteSystem!=="catppuccin"&&(this.paletteSystem="catppuccin",this.enableDebug&&console.log("\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Reset palette system to default: catppuccin")),this.enableDebug&&(console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Current artistic preference: ${this.artisticMode}`),console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Current palette system: ${this.paletteSystem}`))}catch(c){this.enableDebug&&console.warn("\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Failed to load preferences:",c),this.artisticMode="artist-vision",this.paletteSystem="catppuccin"}}};typeof E.init=="function"&&E.init()});var le,u,tn,x=y(()=>{"use strict";U();le=class c{constructor(e={}){this.registeredSystems=new Map;this.reportHistory=[];this.monitoring=!1;this.monitoringInterval=null;this.performanceMetrics=new Map;this.config={enableConsoleReporting:E.enableDebug,reportingInterval:3e4,enablePerformanceTracking:!0,enableSystemHealthMonitoring:!0,maxHistoryEntries:50,verboseLogging:E.enableDebug,...e},this.config.enableConsoleReporting&&console.log("\u{1F527} [UnifiedDebugManager] Debug system initialized")}static getInstance(e){return c.instance||(c.instance=new c(e)),c.instance}registerSystem(e,t,i="unified"){let a={name:e,type:i,initialized:t.initialized||!1,healthy:!0,lastUpdate:Date.now(),issues:[],metrics:{}};this.registeredSystems.set(e,a),this.config.verboseLogging&&console.log(`\u{1F527} [UnifiedDebugManager] Registered system: ${e} (${i})`),this.registeredSystems.size===1&&!this.monitoring&&this.startMonitoring()}unregisterSystem(e){this.registeredSystems.delete(e),this.performanceMetrics.delete(e),this.config.verboseLogging&&console.log(`\u{1F527} [UnifiedDebugManager] Unregistered system: ${e}`),this.registeredSystems.size===0&&this.stopMonitoring()}updateSystem(e,t){let i=this.registeredSystems.get(e);i&&(Object.assign(i,t,{lastUpdate:Date.now()}),this.registeredSystems.set(e,i))}recordMetric(e,t,i){if(!this.config.enablePerformanceTracking)return;let a=this.registeredSystems.get(e);a&&(a.metrics[t]=i,a.lastUpdate=Date.now());let r=`${e}_${t}`,n=this.performanceMetrics.get(r)||[];n.push(i),n.length>100&&n.splice(0,n.length-100),this.performanceMetrics.set(r,n)}recordIssue(e,t){let i=this.registeredSystems.get(e);i&&(i.issues.push(t),i.healthy=!1,i.lastUpdate=Date.now(),this.config.verboseLogging&&console.warn(`\u26A0\uFE0F [${e}] ${t}`))}async performHealthCheck(){let e=Date.now(),t=[],i=0,a=0,r=0,n=0,s=0;for(let[h,g]of this.registeredSystems)try{let f=null,S=g.initialized,C=globalThis.year3000System;if(C){if(C.facadeCoordinator){try{f=C.facadeCoordinator.getCachedNonVisualSystem?.(h)||await C.facadeCoordinator.getNonVisualSystem?.(h)}catch{}if(!f)try{f=C.facadeCoordinator.getVisualSystem?.(h)}catch{}}if(!f){let w=h.charAt(0).toLowerCase()+h.slice(1);f=C[w]||C[h]}}if(f||(f=globalThis[h]),f){if(typeof f.initialized=="boolean")S=f.initialized;else if(typeof f.isInitialized=="function")try{S=await f.isInitialized()}catch{}else if(typeof f.getInitializationStatus=="function")try{let w=await f.getInitializationStatus();S=w?.initialized??w?.ready??!1}catch{}}let T=g.initialized;if(g.initialized=S,g.lastUpdate=e,this.config.verboseLogging&&T!==S&&console.log(`\u{1F527} [UnifiedDebugManager] ${h} initialization status updated: ${T} \u2192 ${S}`),f&&typeof f.healthCheck=="function"){let w=await f.healthCheck();g.healthy=w.healthy??w.ok,w.ok?g.issues=[]:g.issues=[w.details||"Health check failed"]}else g.healthy=S,S?g.issues=[]:g.issues=["System not initialized"];g.frameTime&&(r+=g.frameTime,s++),g.memoryUsage&&(n+=g.memoryUsage),g.healthy?i++:a+=g.issues.length,t.push({...g})}catch(f){g.healthy=!1,g.issues=[`Health check error: ${f}`],a++,this.config.verboseLogging&&console.error(`\u274C [${h}] Health check failed:`,f)}let o=this.registeredSystems.size>0?i/this.registeredSystems.size:1,l;if(o>=.9?l="excellent":o>=.7?l="good":o>=.5?l="degraded":l="critical",this.config.verboseLogging){console.log("\u{1F527} [UnifiedDebugManager] System initialization status for recommendations:");for(let h of t)console.log(`   ${h.name}: ${h.initialized?"\u2705":"\u274C"} initialized`)}let m=this.generateRecommendations(t,l),d={timestamp:e,overallHealth:l,systemCount:this.registeredSystems.size,healthySystems:i,totalIssues:a,systemDetails:t,performance:{avgFrameTime:s>0?r/s:0,totalMemoryMB:n,cpuUsageEstimate:this.estimateCPUUsage()},recommendations:m};return this.reportHistory.push(d),this.reportHistory.length>this.config.maxHistoryEntries&&this.reportHistory.splice(0,this.reportHistory.length-this.config.maxHistoryEntries),d}generateRecommendations(e,t){let i=[];t==="critical"&&i.push("\u{1F6A8} Critical: Multiple systems failing - check console for errors");let a=e.filter(s=>!s.initialized);a.length>0&&i.push(`\u26A0\uFE0F ${a.length} systems not initialized: ${a.map(s=>s.name).join(", ")}`);let r=e.filter(s=>s.frameTime&&s.frameTime>16.67);r.length>0&&i.push(`\u{1F40C} Performance: ${r.length} systems exceeding 16.67ms frame time`);let n=e.filter(s=>s.memoryUsage&&s.memoryUsage>50);return n.length>0&&i.push(`\u{1F4BE} Memory: ${n.length} systems using >50MB`),i.length===0&&i.push("\u2705 All systems operating within normal parameters"),i}estimateCPUUsage(){let e=0,t=0;for(let a of this.registeredSystems.values())a.frameTime&&(e+=a.frameTime,t++);if(t===0)return 0;let i=e/t;return Math.min(100,i/16.67*5)}startMonitoring(){this.monitoring||(this.monitoring=!0,this.monitoringInterval=window.setInterval(()=>{this.performHealthCheck().then(e=>{this.config.enableConsoleReporting&&this.logHealthReport(e)})},this.config.reportingInterval),this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] Monitoring started"))}stopMonitoring(){this.monitoring&&(this.monitoring=!1,this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] Monitoring stopped"))}logHealthReport(e){if(!e){this.performHealthCheck().then(i=>this.logHealthReport(i));return}let t={excellent:"\u{1F31F}",good:"\u2705",degraded:"\u26A0\uFE0F",critical:"\u{1F6A8}"}[e.overallHealth];console.group(`${t} Year 3000 System Health Report - ${new Date().toLocaleTimeString()}`),console.log(`\u{1F4CA} Overall: ${e.overallHealth.toUpperCase()} (${e.healthySystems}/${e.systemCount} healthy)`),e.totalIssues>0&&console.log(`\u{1F6A8} Issues: ${e.totalIssues} total`),console.log(`\u26A1 Performance: ${e.performance.avgFrameTime.toFixed(2)}ms avg frame, ${e.performance.totalMemoryMB.toFixed(1)}MB memory, ~${e.performance.cpuUsageEstimate.toFixed(1)}% CPU`),e.systemDetails.length>0&&(console.group("\u{1F527} System Details"),e.systemDetails.forEach(i=>{let a=i.healthy?"\u2705":"\u274C",r=i.frameTime?` (${i.frameTime.toFixed(2)}ms)`:"";console.log(`${a} ${i.name} [${i.type}]${r}`),i.issues.length>0&&i.issues.forEach(n=>{console.log(`    \u26A0\uFE0F ${n}`)})}),console.groupEnd()),e.recommendations.length>0&&(console.group("\u{1F4A1} Recommendations"),e.recommendations.forEach(i=>console.log(`  ${i}`)),console.groupEnd()),console.groupEnd()}getLatestReport(){return this.reportHistory[this.reportHistory.length-1]||null}getReportHistory(){return[...this.reportHistory]}getSystemInfo(e){return this.registeredSystems.get(e)||null}getAllSystems(){return Array.from(this.registeredSystems.values())}async checkHealth(){let e=await this.performHealthCheck();this.logHealthReport(e)}updateConfig(e){this.config={...this.config,...e},this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] Configuration updated:",e)}reset(){this.stopMonitoring(),this.registeredSystems.clear(),this.reportHistory=[],this.performanceMetrics.clear(),this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] System reset")}destroy(){this.reset(),c.instance=null}},u={debug:{log:(c,e,...t)=>{E?.enableDebug&&console.log(`[${c}] ${e}`,...t)},error:(c,e,t)=>{console.error(`[${c}] ${e}`,t),le.getInstance().recordIssue(c,`${e}${t?`: ${t}`:""}`)},warn:(c,e,...t)=>{console.warn(`[${c}] ${e}`,...t),le.getInstance().recordIssue(c,e)},metric:(c,e,t)=>{le.getInstance().recordMetric(c,e,t)},register:(c,e,t)=>{le.getInstance().registerSystem(c,e,t)},unregister:c=>{le.getInstance().unregisterSystem(c)},checkHealth:()=>le.getInstance().checkHealth(),getReport:()=>le.getInstance().getLatestReport()}};typeof window<"u"&&(window.UnifiedDebugManager=le,window.Y3K=u,console.log("\u{1F527} [UnifiedDebugManager] Global debug interface available:"),console.log("  Y3K.debug.checkHealth() - Check system health"),console.log("  Y3K.debug.getReport() - Get latest debug report"),console.log("  UnifiedDebugManager.getInstance() - Get debug manager"));tn=le});var st,ya=y(()=>{"use strict";x();st=class{constructor(e,t=null,i=null,a=null){this.musicSyncService=null;this.emotionalGradientMapper=null;this.settingsManager=null;this.currentGenre="unknown";this.genreConfidence=0;this.genreHistory=[];this.maxHistorySize=30;this.genreAnalysisBuffer=[];this.bufferSize=10;this.isActive=!1;this.boundSpectralHandler=null;this.boundEmotionalHandler=null;this.genreProfiles={electronic:{bassEmphasis:.8,midFrequencyPattern:.6,trebleSharpness:.9,dynamicRange:.7,rhythmComplexity:.6,syncopation:.4,grooveWeight:.7,tempoVariability:.3,musicalComplexity:.5,harmonicComplexity:.5,dissonanceTolerance:.6,modalInfluence:.4,microtonal:.2,compression:.8,saturation:.6,stereoWidth:.8,artificialProcessing:.9,smoothness:.2,accessibility:.6,experimentalFactor:.7,emotionalRange:.6},rock:{bassEmphasis:.7,midFrequencyPattern:.8,trebleSharpness:.7,dynamicRange:.8,rhythmComplexity:.6,syncopation:.3,grooveWeight:.8,tempoVariability:.4,musicalComplexity:.6,harmonicComplexity:.6,dissonanceTolerance:.5,modalInfluence:.3,microtonal:.1,compression:.6,saturation:.7,stereoWidth:.7,artificialProcessing:.4,smoothness:.6,accessibility:.8,experimentalFactor:.4,emotionalRange:.8},classical:{bassEmphasis:.5,midFrequencyPattern:.7,trebleSharpness:.6,dynamicRange:.9,rhythmComplexity:.8,syncopation:.2,grooveWeight:.4,tempoVariability:.7,musicalComplexity:.9,harmonicComplexity:.9,dissonanceTolerance:.4,modalInfluence:.6,microtonal:.3,compression:.3,saturation:.2,stereoWidth:.8,artificialProcessing:.1,smoothness:.9,accessibility:.4,experimentalFactor:.6,emotionalRange:.9},jazz:{bassEmphasis:.6,midFrequencyPattern:.8,trebleSharpness:.5,dynamicRange:.8,rhythmComplexity:.9,syncopation:.8,grooveWeight:.9,tempoVariability:.6,musicalComplexity:.9,harmonicComplexity:.9,dissonanceTolerance:.7,modalInfluence:.8,microtonal:.4,compression:.4,saturation:.3,stereoWidth:.7,artificialProcessing:.2,smoothness:.8,accessibility:.5,experimentalFactor:.8,emotionalRange:.8},"hip-hop":{bassEmphasis:.9,midFrequencyPattern:.7,trebleSharpness:.8,dynamicRange:.6,rhythmComplexity:.7,syncopation:.6,grooveWeight:.9,tempoVariability:.3,musicalComplexity:.4,harmonicComplexity:.4,dissonanceTolerance:.5,modalInfluence:.3,microtonal:.1,compression:.8,saturation:.6,stereoWidth:.6,artificialProcessing:.7,smoothness:.4,accessibility:.8,experimentalFactor:.5,emotionalRange:.7},ambient:{bassEmphasis:.4,midFrequencyPattern:.5,trebleSharpness:.3,dynamicRange:.9,rhythmComplexity:.2,syncopation:.1,grooveWeight:.2,tempoVariability:.8,musicalComplexity:.6,harmonicComplexity:.6,dissonanceTolerance:.6,modalInfluence:.7,microtonal:.5,compression:.5,saturation:.4,stereoWidth:.9,artificialProcessing:.6,smoothness:.7,accessibility:.3,experimentalFactor:.8,emotionalRange:.6},pop:{bassEmphasis:.6,midFrequencyPattern:.8,trebleSharpness:.7,dynamicRange:.6,rhythmComplexity:.4,syncopation:.3,grooveWeight:.7,tempoVariability:.2,musicalComplexity:.5,harmonicComplexity:.5,dissonanceTolerance:.3,modalInfluence:.2,microtonal:.1,compression:.8,saturation:.5,stereoWidth:.6,artificialProcessing:.5,smoothness:.5,accessibility:.9,experimentalFactor:.2,emotionalRange:.7},metal:{bassEmphasis:.8,midFrequencyPattern:.7,trebleSharpness:.9,dynamicRange:.7,rhythmComplexity:.7,syncopation:.4,grooveWeight:.8,tempoVariability:.3,musicalComplexity:.6,harmonicComplexity:.6,dissonanceTolerance:.8,modalInfluence:.5,microtonal:.2,compression:.7,saturation:.9,stereoWidth:.7,artificialProcessing:.6,smoothness:.4,accessibility:.6,experimentalFactor:.5,emotionalRange:.8},folk:{bassEmphasis:.4,midFrequencyPattern:.7,trebleSharpness:.5,dynamicRange:.7,rhythmComplexity:.4,syncopation:.2,grooveWeight:.6,tempoVariability:.5,musicalComplexity:.5,harmonicComplexity:.5,dissonanceTolerance:.3,modalInfluence:.6,microtonal:.2,compression:.3,saturation:.2,stereoWidth:.5,artificialProcessing:.1,smoothness:.9,accessibility:.7,experimentalFactor:.3,emotionalRange:.7},funk:{bassEmphasis:.9,midFrequencyPattern:.8,trebleSharpness:.6,dynamicRange:.7,rhythmComplexity:.8,syncopation:.9,grooveWeight:1,tempoVariability:.4,musicalComplexity:.6,harmonicComplexity:.6,dissonanceTolerance:.5,modalInfluence:.4,microtonal:.2,compression:.6,saturation:.5,stereoWidth:.6,artificialProcessing:.3,smoothness:.7,accessibility:.7,experimentalFactor:.4,emotionalRange:.6},indie:{bassEmphasis:.5,midFrequencyPattern:.7,trebleSharpness:.6,dynamicRange:.7,rhythmComplexity:.6,syncopation:.4,grooveWeight:.6,tempoVariability:.5,musicalComplexity:.6,harmonicComplexity:.6,dissonanceTolerance:.5,modalInfluence:.5,microtonal:.3,compression:.5,saturation:.4,stereoWidth:.7,artificialProcessing:.3,smoothness:.7,accessibility:.6,experimentalFactor:.6,emotionalRange:.7},reggae:{bassEmphasis:.8,midFrequencyPattern:.6,trebleSharpness:.5,dynamicRange:.6,rhythmComplexity:.5,syncopation:.7,grooveWeight:.8,tempoVariability:.3,musicalComplexity:.4,harmonicComplexity:.4,dissonanceTolerance:.3,modalInfluence:.4,microtonal:.2,compression:.6,saturation:.4,stereoWidth:.6,artificialProcessing:.3,smoothness:.6,accessibility:.7,experimentalFactor:.3,emotionalRange:.6},blues:{bassEmphasis:.6,midFrequencyPattern:.8,trebleSharpness:.6,dynamicRange:.8,rhythmComplexity:.5,syncopation:.4,grooveWeight:.8,tempoVariability:.6,musicalComplexity:.6,harmonicComplexity:.6,dissonanceTolerance:.4,modalInfluence:.7,microtonal:.3,compression:.4,saturation:.5,stereoWidth:.5,artificialProcessing:.2,smoothness:.8,accessibility:.7,experimentalFactor:.4,emotionalRange:.8},country:{bassEmphasis:.5,midFrequencyPattern:.7,trebleSharpness:.6,dynamicRange:.7,rhythmComplexity:.4,syncopation:.3,grooveWeight:.6,tempoVariability:.4,musicalComplexity:.4,harmonicComplexity:.4,dissonanceTolerance:.2,modalInfluence:.3,microtonal:.1,compression:.5,saturation:.3,stereoWidth:.6,artificialProcessing:.2,smoothness:.8,accessibility:.8,experimentalFactor:.2,emotionalRange:.7},techno:{bassEmphasis:.9,midFrequencyPattern:.5,trebleSharpness:.8,dynamicRange:.5,rhythmComplexity:.6,syncopation:.3,grooveWeight:.8,tempoVariability:.2,musicalComplexity:.4,harmonicComplexity:.4,dissonanceTolerance:.6,modalInfluence:.3,microtonal:.3,compression:.9,saturation:.7,stereoWidth:.8,artificialProcessing:1,smoothness:.1,accessibility:.5,experimentalFactor:.6,emotionalRange:.5},house:{bassEmphasis:.8,midFrequencyPattern:.6,trebleSharpness:.7,dynamicRange:.6,rhythmComplexity:.5,syncopation:.4,grooveWeight:.9,tempoVariability:.2,musicalComplexity:.5,harmonicComplexity:.5,dissonanceTolerance:.4,modalInfluence:.3,microtonal:.2,compression:.8,saturation:.6,stereoWidth:.7,artificialProcessing:.8,smoothness:.3,accessibility:.8,experimentalFactor:.4,emotionalRange:.6},trance:{bassEmphasis:.7,midFrequencyPattern:.7,trebleSharpness:.8,dynamicRange:.8,rhythmComplexity:.5,syncopation:.2,grooveWeight:.7,tempoVariability:.3,musicalComplexity:.6,harmonicComplexity:.6,dissonanceTolerance:.5,modalInfluence:.4,microtonal:.3,compression:.7,saturation:.5,stereoWidth:.9,artificialProcessing:.8,smoothness:.2,accessibility:.6,experimentalFactor:.5,emotionalRange:.8},dubstep:{bassEmphasis:1,midFrequencyPattern:.5,trebleSharpness:.9,dynamicRange:.9,rhythmComplexity:.7,syncopation:.6,grooveWeight:.8,tempoVariability:.4,musicalComplexity:.4,harmonicComplexity:.4,dissonanceTolerance:.8,modalInfluence:.3,microtonal:.4,compression:.8,saturation:.8,stereoWidth:.8,artificialProcessing:.9,smoothness:.1,accessibility:.4,experimentalFactor:.7,emotionalRange:.6},unknown:{bassEmphasis:.5,midFrequencyPattern:.5,trebleSharpness:.5,dynamicRange:.5,rhythmComplexity:.5,syncopation:.5,grooveWeight:.5,tempoVariability:.5,musicalComplexity:.5,harmonicComplexity:.5,dissonanceTolerance:.5,modalInfluence:.5,microtonal:.5,compression:.5,saturation:.5,stereoWidth:.5,artificialProcessing:.5,smoothness:.5,accessibility:.5,experimentalFactor:.5,emotionalRange:.5}};this.genreVisualStyles={electronic:{primaryHueRange:[180,270],saturationProfile:[.8,.3],brightnessProfile:[1.1,.4],contrastLevel:.8,gradientComplexity:.8,shapeGeometry:"geometric",edgeSharpness:.9,symmetryLevel:.7,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"linear",transitionCharacter:"mechanical",layerBlending:"contrasting",depthIllusion:.6,particleInfluence:.8,nebulaCharacter:"structured",memoryInfluence:.3,adaptationSpeed:.8,stabilityPreference:.6,emergencePattern:"sudden"},rock:{primaryHueRange:[330,30],saturationProfile:[1.2,.5],brightnessProfile:[1.2,.3],contrastLevel:.9,gradientComplexity:.7,shapeGeometry:"hybrid",edgeSharpness:.7,symmetryLevel:.5,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"sharp",layerBlending:"harmonious",depthIllusion:.7,particleInfluence:.6,nebulaCharacter:"dense",memoryInfluence:.4,adaptationSpeed:.7,stabilityPreference:.7,emergencePattern:"gradual"},classical:{primaryHueRange:[45,135],saturationProfile:[.6,.4],brightnessProfile:[1,.5],contrastLevel:.6,gradientComplexity:.9,shapeGeometry:"smooth",edgeSharpness:.3,symmetryLevel:.8,animationStyle:"smooth",pulseBehavior:"subtle",flowDirection:"spiral",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.9,particleInfluence:.4,nebulaCharacter:"ethereal",memoryInfluence:.8,adaptationSpeed:.3,stabilityPreference:.9,emergencePattern:"progressive"},jazz:{primaryHueRange:[30,90],saturationProfile:[.7,.6],brightnessProfile:[.9,.6],contrastLevel:.7,gradientComplexity:.8,shapeGeometry:"abstract",edgeSharpness:.5,symmetryLevel:.3,animationStyle:"chaotic",pulseBehavior:"syncopated",flowDirection:"random",transitionCharacter:"smooth",layerBlending:"complementary",depthIllusion:.8,particleInfluence:.7,nebulaCharacter:"wispy",memoryInfluence:.6,adaptationSpeed:.6,stabilityPreference:.4,emergencePattern:"cyclical"},"hip-hop":{primaryHueRange:[270,330],saturationProfile:[1,.4],brightnessProfile:[1.1,.3],contrastLevel:.8,gradientComplexity:.6,shapeGeometry:"geometric",edgeSharpness:.8,symmetryLevel:.6,animationStyle:"rhythmic",pulseBehavior:"syncopated",flowDirection:"linear",transitionCharacter:"sharp",layerBlending:"contrasting",depthIllusion:.5,particleInfluence:.9,nebulaCharacter:"structured",memoryInfluence:.2,adaptationSpeed:.9,stabilityPreference:.5,emergencePattern:"sudden"},ambient:{primaryHueRange:[180,240],saturationProfile:[.4,.3],brightnessProfile:[.8,.4],contrastLevel:.3,gradientComplexity:.9,shapeGeometry:"smooth",edgeSharpness:.2,symmetryLevel:.4,animationStyle:"minimal",pulseBehavior:"subtle",flowDirection:"spiral",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.9,particleInfluence:.3,nebulaCharacter:"ethereal",memoryInfluence:.9,adaptationSpeed:.1,stabilityPreference:.9,emergencePattern:"gradual"},pop:{primaryHueRange:[300,60],saturationProfile:[1.1,.3],brightnessProfile:[1.2,.2],contrastLevel:.7,gradientComplexity:.6,shapeGeometry:"hybrid",edgeSharpness:.6,symmetryLevel:.7,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.6,particleInfluence:.5,nebulaCharacter:"dense",memoryInfluence:.5,adaptationSpeed:.7,stabilityPreference:.8,emergencePattern:"gradual"},metal:{primaryHueRange:[0,30],saturationProfile:[.9,.4],brightnessProfile:[.7,.4],contrastLevel:1,gradientComplexity:.7,shapeGeometry:"geometric",edgeSharpness:.9,symmetryLevel:.6,animationStyle:"chaotic",pulseBehavior:"irregular",flowDirection:"radial",transitionCharacter:"sharp",layerBlending:"clashing",depthIllusion:.8,particleInfluence:.7,nebulaCharacter:"dense",memoryInfluence:.3,adaptationSpeed:.8,stabilityPreference:.3,emergencePattern:"sudden"},folk:{primaryHueRange:[60,120],saturationProfile:[.6,.3],brightnessProfile:[.9,.3],contrastLevel:.5,gradientComplexity:.5,shapeGeometry:"smooth",edgeSharpness:.3,symmetryLevel:.5,animationStyle:"smooth",pulseBehavior:"subtle",flowDirection:"spiral",transitionCharacter:"smooth",layerBlending:"harmonious",depthIllusion:.6,particleInfluence:.3,nebulaCharacter:"wispy",memoryInfluence:.7,adaptationSpeed:.4,stabilityPreference:.8,emergencePattern:"progressive"},funk:{primaryHueRange:[30,90],saturationProfile:[1,.5],brightnessProfile:[1,.4],contrastLevel:.8,gradientComplexity:.7,shapeGeometry:"abstract",edgeSharpness:.6,symmetryLevel:.4,animationStyle:"rhythmic",pulseBehavior:"syncopated",flowDirection:"random",transitionCharacter:"smooth",layerBlending:"complementary",depthIllusion:.7,particleInfluence:.8,nebulaCharacter:"wispy",memoryInfluence:.4,adaptationSpeed:.8,stabilityPreference:.5,emergencePattern:"cyclical"},indie:{primaryHueRange:[120,240],saturationProfile:[.7,.4],brightnessProfile:[.9,.4],contrastLevel:.6,gradientComplexity:.7,shapeGeometry:"hybrid",edgeSharpness:.4,symmetryLevel:.5,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"spiral",transitionCharacter:"fluid",layerBlending:"complementary",depthIllusion:.7,particleInfluence:.5,nebulaCharacter:"wispy",memoryInfluence:.6,adaptationSpeed:.5,stabilityPreference:.7,emergencePattern:"progressive"},reggae:{primaryHueRange:[90,150],saturationProfile:[.8,.3],brightnessProfile:[1,.3],contrastLevel:.6,gradientComplexity:.5,shapeGeometry:"smooth",edgeSharpness:.4,symmetryLevel:.6,animationStyle:"rhythmic",pulseBehavior:"syncopated",flowDirection:"linear",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.5,particleInfluence:.4,nebulaCharacter:"wispy",memoryInfluence:.6,adaptationSpeed:.5,stabilityPreference:.7,emergencePattern:"cyclical"},blues:{primaryHueRange:[200,260],saturationProfile:[.6,.4],brightnessProfile:[.8,.4],contrastLevel:.6,gradientComplexity:.6,shapeGeometry:"smooth",edgeSharpness:.4,symmetryLevel:.4,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.7,particleInfluence:.4,nebulaCharacter:"ethereal",memoryInfluence:.7,adaptationSpeed:.4,stabilityPreference:.8,emergencePattern:"progressive"},country:{primaryHueRange:[30,90],saturationProfile:[.7,.3],brightnessProfile:[1,.3],contrastLevel:.5,gradientComplexity:.5,shapeGeometry:"smooth",edgeSharpness:.3,symmetryLevel:.6,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"smooth",layerBlending:"harmonious",depthIllusion:.5,particleInfluence:.3,nebulaCharacter:"wispy",memoryInfluence:.7,adaptationSpeed:.4,stabilityPreference:.8,emergencePattern:"gradual"},techno:{primaryHueRange:[240,300],saturationProfile:[1,.4],brightnessProfile:[1.1,.3],contrastLevel:.9,gradientComplexity:.6,shapeGeometry:"geometric",edgeSharpness:1,symmetryLevel:.8,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"linear",transitionCharacter:"mechanical",layerBlending:"contrasting",depthIllusion:.5,particleInfluence:.9,nebulaCharacter:"structured",memoryInfluence:.2,adaptationSpeed:.9,stabilityPreference:.4,emergencePattern:"sudden"},house:{primaryHueRange:[300,360],saturationProfile:[.9,.3],brightnessProfile:[1.1,.3],contrastLevel:.7,gradientComplexity:.6,shapeGeometry:"hybrid",edgeSharpness:.7,symmetryLevel:.7,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.6,particleInfluence:.7,nebulaCharacter:"dense",memoryInfluence:.4,adaptationSpeed:.7,stabilityPreference:.6,emergencePattern:"gradual"},trance:{primaryHueRange:[180,270],saturationProfile:[.8,.5],brightnessProfile:[1,.5],contrastLevel:.7,gradientComplexity:.8,shapeGeometry:"abstract",edgeSharpness:.5,symmetryLevel:.6,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"spiral",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.8,particleInfluence:.6,nebulaCharacter:"ethereal",memoryInfluence:.6,adaptationSpeed:.5,stabilityPreference:.7,emergencePattern:"progressive"},dubstep:{primaryHueRange:[120,180],saturationProfile:[1.2,.6],brightnessProfile:[1.1,.6],contrastLevel:1,gradientComplexity:.8,shapeGeometry:"geometric",edgeSharpness:.9,symmetryLevel:.5,animationStyle:"chaotic",pulseBehavior:"irregular",flowDirection:"random",transitionCharacter:"sharp",layerBlending:"clashing",depthIllusion:.7,particleInfluence:1,nebulaCharacter:"structured",memoryInfluence:.2,adaptationSpeed:1,stabilityPreference:.2,emergencePattern:"sudden"},unknown:{primaryHueRange:[0,360],saturationProfile:[.7,.3],brightnessProfile:[1,.3],contrastLevel:.6,gradientComplexity:.6,shapeGeometry:"hybrid",edgeSharpness:.5,symmetryLevel:.5,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.6,particleInfluence:.5,nebulaCharacter:"wispy",memoryInfluence:.5,adaptationSpeed:.5,stabilityPreference:.6,emergencePattern:"gradual"}};this.cssVariableController=e,this.musicSyncService=t,this.emotionalGradientMapper=i,this.settingsManager=a,this.boundSpectralHandler=this.handleSpectralData.bind(this),this.boundEmotionalHandler=this.handleEmotionalData.bind(this)}async initialize(){this.boundSpectralHandler&&document.addEventListener("music-sync:spectral-data",this.boundSpectralHandler),this.boundEmotionalHandler&&document.addEventListener("emotional-gradient:profile-updated",this.boundEmotionalHandler),this.isActive=!0,u?.debug?.log("GenreGradientEvolution","Genre-responsive gradient evolution system initialized")}handleSpectralData(e){if(!this.isActive)return;let i=e.detail;i&&(this.genreAnalysisBuffer.push(i),this.genreAnalysisBuffer.length>this.bufferSize&&this.genreAnalysisBuffer.shift(),this.genreAnalysisBuffer.length>=this.bufferSize&&this.analyzeGenre())}handleEmotionalData(e){this.isActive&&this.updateVisualEvolution()}analyzeGenre(){if(this.genreAnalysisBuffer.length===0)return;let e=this.calculateAverageMusicData(),t={};for(let r of Object.keys(this.genreProfiles))t[r]=this.calculateGenreSimilarity(e,this.genreProfiles[r]);let a=Object.entries(t).sort(([,r],[,n])=>n-r)[0];if(a){let[r,n]=a;this.updateGenreDetection(r,n)}}calculateAverageMusicData(){let e=this.genreAnalysisBuffer.reduce((i,a)=>({energy:(i.energy||0)+(a.energy||0),valence:(i.valence||0)+(a.valence||0),danceability:(i.danceability||0)+(a.danceability||0),tempo:(i.tempo||0)+(a.tempo||0),loudness:(i.loudness||0)+(a.loudness||0),acousticness:(i.acousticness||0)+(a.acousticness||0),instrumentalness:(i.instrumentalness||0)+(a.instrumentalness||0),speechiness:(i.speechiness||0)+(a.speechiness||0),mode:a.mode!==void 0?a.mode:i.mode||0,key:(i.key||0)+(a.key||0),genre:a.genre||i.genre||"unknown"}),{energy:0,valence:0,danceability:0,tempo:0,loudness:0,acousticness:0,instrumentalness:0,speechiness:0,mode:0,key:0,genre:"unknown"}),t=this.genreAnalysisBuffer.length;return{energy:(e.energy||0)/t,valence:(e.valence||0)/t,danceability:(e.danceability||0)/t,tempo:(e.tempo||0)/t,loudness:(e.loudness||0)/t,acousticness:(e.acousticness||0)/t,instrumentalness:(e.instrumentalness||0)/t,speechiness:(e.speechiness||0)/t,mode:e.mode||0,key:(e.key||0)/t,genre:e.genre||"unknown"}}calculateGenreSimilarity(e,t){let i={energy:.25,valence:.2,danceability:.2,acousticness:.15,tempo:.1,speechiness:.05,instrumentalness:.05},a=1-Math.abs((e.energy||.5)-(t.dynamicRange*.5+t.rhythmComplexity*.5)),r=1-Math.abs((e.valence||.5)-(t.accessibility*.6+t.emotionalRange*.4)),n=1-Math.abs((e.danceability||.5)-(t.grooveWeight*.7+(1-t.syncopation)*.3)),s=1-Math.abs((e.acousticness||.5)-(t.smoothness*.8+(1-t.artificialProcessing)*.2)),o=60+t.rhythmComplexity*80+t.grooveWeight*60,l=1-Math.min(1,Math.abs((e.tempo||120)-o)/100),m=1-Math.abs((e.speechiness||.1)-(t.artificialProcessing*.3+t.accessibility*.1)),d=1-Math.abs((e.instrumentalness||.5)-(t.experimentalFactor*.6+(t.musicalComplexity||t.harmonicComplexity||.5)*.4));return a*i.energy+r*i.valence+n*i.danceability+s*i.acousticness+l*i.tempo+m*i.speechiness+d*i.instrumentalness}updateGenreDetection(e,t){let i=performance.now();this.genreHistory.push({genre:e,confidence:t,timestamp:i}),this.genreHistory.length>this.maxHistorySize&&this.genreHistory.shift();let a=this.genreHistory.slice(-10),r=this.calculateGenreConsensus(a);r.confidence>.6&&(r.genre!==this.currentGenre||r.confidence>this.genreConfidence)&&(this.currentGenre=r.genre,this.genreConfidence=r.confidence,u?.debug?.log("GenreGradientEvolution",`Genre detected: ${this.currentGenre} (confidence: ${this.genreConfidence.toFixed(2)})`),this.updateVisualEvolution(),document.dispatchEvent(new CustomEvent("genre-gradient:genre-detected",{detail:{genre:this.currentGenre,confidence:this.genreConfidence}})))}calculateGenreConsensus(e){let t={};e.forEach((r,n)=>{let s=(n+1)/e.length,o=r.confidence*s;t[r.genre]=(t[r.genre]||0)+o});let i="unknown",a=0;for(let[r,n]of Object.entries(t))n!==void 0&&n>a&&(a=n,i=r);return{genre:i,confidence:a/e.length}}updateVisualEvolution(){if(this.currentGenre==="unknown")return;let e=this.genreVisualStyles[this.currentGenre],t=this.emotionalGradientMapper?.getCurrentEmotionalProfile()||null;this.applyGenreVisualStyle(e,t)}applyGenreVisualStyle(e,t){let i=e.primaryHueRange[1]-e.primaryHueRange[0],a=e.primaryHueRange[0]+i*.5,r=t?(t.valence-.5)*i*.3:0;this.cssVariableController.setProperty("--sn-genre-base-hue",`${a+r}deg`),this.cssVariableController.setProperty("--sn-genre-hue-range",`${i}deg`);let n=t?t.arousal*.3:0,s=t?t.energy*.2:0;this.cssVariableController.setProperty("--sn-genre-saturation-base",(e.saturationProfile[0]+n).toString()),this.cssVariableController.setProperty("--sn-genre-saturation-variation",e.saturationProfile[1].toString()),this.cssVariableController.setProperty("--sn-genre-brightness-base",(e.brightnessProfile[0]+s).toString()),this.cssVariableController.setProperty("--sn-genre-brightness-variation",e.brightnessProfile[1].toString()),this.cssVariableController.setProperty("--sn-genre-contrast-level",e.contrastLevel.toString()),this.cssVariableController.setProperty("--sn-genre-edge-sharpness",e.edgeSharpness.toString()),this.cssVariableController.setProperty("--sn-genre-gradient-complexity",e.gradientComplexity.toString());let o=t?.5+t.energy:1;this.cssVariableController.setProperty("--sn-genre-animation-speed",o.toString()),this.cssVariableController.setProperty("--sn-genre-pulse-intensity",e.depthIllusion.toString());let l=this.mapLayerBlending(e.layerBlending);this.cssVariableController.setProperty("--sn-genre-layer-harmony",l.toString()),this.cssVariableController.setProperty("--sn-genre-depth-illusion",e.depthIllusion.toString()),this.cssVariableController.setProperty("--sn-genre-particle-influence",e.particleInfluence.toString()),this.cssVariableController.setProperty("--sn-genre-memory-influence",e.memoryInfluence.toString()),this.cssVariableController.setProperty("--sn-genre-adaptation-speed",e.adaptationSpeed.toString()),this.cssVariableController.setProperty("--sn-genre-stability-preference",e.stabilityPreference.toString()),this.cssVariableController.setProperty("--sn-current-genre",this.currentGenre),this.cssVariableController.setProperty("--sn-genre-confidence",this.genreConfidence.toString()),this.updateGenreGradientCoordination(e,t)}updateGenreGradientCoordination(e,t){let i=getComputedStyle(document.documentElement),a=i.getPropertyValue("--sn-bg-gradient-primary").trim(),r=i.getPropertyValue("--sn-bg-gradient-secondary").trim(),n=i.getPropertyValue("--sn-bg-gradient-accent").trim();if(a||r||n){let s=t?.5+t.energy:1,o=this.calculateGenreAngle(e);this.cssVariableController.setProperty("--sn-bg-gradient-angle",`${o}deg`);let l=this.calculateGenreOpacity(e,t);this.cssVariableController.setProperty("--sn-bg-gradient-opacity",l.toString());let m=Math.max(60,120*(1-e.edgeSharpness));this.cssVariableController.setProperty("--sn-bg-gradient-blur",`${m}px`);let d=t?t.arousal*.3:0,h=t?t.energy*.2:0;this.cssVariableController.setProperty("--sn-bg-gradient-saturation",(e.saturationProfile[0]+d).toString()),this.cssVariableController.setProperty("--sn-bg-gradient-brightness",(e.brightnessProfile[0]+h).toString()),this.cssVariableController.setProperty("--sn-bg-gradient-contrast",e.contrastLevel.toString()),u?.debug?.log("GenreGradientEvolution",`Coordinated genre "${this.currentGenre}" modifications with gradient system: angle=${o}\xB0, opacity=${l}`)}}calculateGenreAngle(e){return{electronic:135,rock:45,classical:90,jazz:120,"hip-hop":0,ambient:180,pop:315,metal:225,folk:60,funk:30,indie:150,reggae:210,blues:270,country:45,techno:135,house:315,trance:90,dubstep:180,unknown:45}[this.currentGenre]||45}calculateGenreOpacity(e,t){let i=.8;switch(this.currentGenre){case"ambient":case"classical":i=.6;break;case"metal":case"rock":case"dubstep":i=.9;break;case"jazz":case"blues":i=.75;break;default:i=.8}return t&&(i*=.7+t.energy*.3),Math.max(.3,Math.min(1,i))}mapLayerBlending(e){switch(e){case"harmonious":return .9;case"complementary":return .7;case"contrasting":return .5;case"clashing":return .3;default:return .7}}getCurrentGenre(){return this.currentGenre}getGenreConfidence(){return this.genreConfidence}getGenreHistory(){return[...this.genreHistory]}setGenreOverride(e,t=1e4){this.currentGenre=e,this.genreConfidence=1,this.updateVisualEvolution(),u?.debug?.log("GenreGradientEvolution",`Genre override: ${e} for ${t}ms`),setTimeout(()=>{this.genreConfidence=0,u?.debug?.log("GenreGradientEvolution","Genre override expired, returning to automatic detection")},t)}getGenreCharacteristics(e){return this.genreProfiles[e||this.currentGenre]}getGenreVisualStyle(e){return this.genreVisualStyles[e||this.currentGenre]}destroy(){this.isActive=!1,this.boundSpectralHandler&&document.removeEventListener("music-sync:data-updated",this.boundSpectralHandler),this.boundEmotionalHandler&&document.removeEventListener("emotional-gradient:profile-updated",this.boundEmotionalHandler),this.genreAnalysisBuffer=[],this.genreHistory=[],u?.debug?.log("GenreGradientEvolution","Genre evolution system destroyed")}}});var Le,ba,p,L=y(()=>{"use strict";x();Le=class Le{constructor(){this.subscriptions=new Map;this.eventMetrics={totalEvents:0,totalSubscriptions:0,activeSubscriptions:0,eventsPerSecond:0,topEvents:[],memoryUsage:0};this.eventQueue=[];this.processingQueue=!1;this.maxQueueSize=1e3;this.subscriptionCleanupInterval=null;this.metricsUpdateInterval=null;this.startMetricsMonitoring(),this.startSubscriptionCleanup(),u?.debug?.log("UnifiedEventBus","Unified event bus initialized")}static getInstance(){return Le.instance||(Le.instance=new Le),Le.instance}subscribe(e,t,i="anonymous",a={}){let r=this.generateSubscriptionId();this.subscriptions.has(e)||this.subscriptions.set(e,new Map);let n={id:r,eventName:e,handler:t,subscriberName:i,once:a.once||!1,createdAt:Date.now(),triggerCount:0};return this.subscriptions.get(e).set(r,n),this.eventMetrics.totalSubscriptions++,this.eventMetrics.activeSubscriptions++,u?.debug?.log("UnifiedEventBus",`Subscription added: ${i} -> ${e}`,{subscriptionId:r,totalSubscriptions:this.eventMetrics.activeSubscriptions}),r}once(e,t,i="anonymous"){return this.subscribe(e,t,i,{once:!0})}unsubscribe(e){for(let[t,i]of this.subscriptions.entries())if(i.has(e)){let a=i.get(e);return i.delete(e),i.size===0&&this.subscriptions.delete(t),this.eventMetrics.activeSubscriptions--,u?.debug?.log("UnifiedEventBus",`Subscription removed: ${a.subscriberName} -> ${t}`,{subscriptionId:e,remainingSubscriptions:this.eventMetrics.activeSubscriptions}),!0}return!1}unsubscribeAll(e){let t=0;for(let[i,a]of this.subscriptions.entries()){let r=Array.from(a.values()).filter(n=>n.subscriberName===e);for(let n of r)a.delete(n.id),t++,this.eventMetrics.activeSubscriptions--;a.size===0&&this.subscriptions.delete(i)}return t>0&&u?.debug?.log("UnifiedEventBus",`Removed ${t} subscriptions for: ${e}`),t}async emit(e,t){let i=Date.now();if(this.processingQueue||this.eventQueue.length>0){if(this.eventQueue.length>=this.maxQueueSize){u?.debug?.warn("UnifiedEventBus",`Event queue full, dropping event: ${e}`);return}this.eventQueue.push({eventName:e,data:t,timestamp:i}),this.processEventQueue();return}await this.processEvent(e,t,i)}emitSync(e,t){let i=Date.now();this.processEventSync(e,t,i)}async processEvent(e,t,i){let a=this.subscriptions.get(e);if(!a||a.size===0)return;this.eventMetrics.totalEvents++;let r=[],n=[];for(let[o,l]of a.entries())r.push({subscription:l,handler:l.handler}),l.once&&n.push(o),l.lastTriggered=i,l.triggerCount++;let s=r.map(async({subscription:o,handler:l})=>{try{await l(t)}catch(m){u?.debug?.error("UnifiedEventBus",`Handler error in ${o.subscriberName} for ${e}:`,m),this.emitSync("system:error",{systemName:o.subscriberName,error:m instanceof Error?m.message:"Unknown error",severity:"error",timestamp:Date.now()})}});await Promise.all(s);for(let o of n)a.delete(o),this.eventMetrics.activeSubscriptions--;a.size===0&&this.subscriptions.delete(e),u?.debug?.log("UnifiedEventBus",`Event processed: ${e}`,{handlerCount:r.length,processingTime:Date.now()-i})}processEventSync(e,t,i){let a=this.subscriptions.get(e);if(!a||a.size===0)return;this.eventMetrics.totalEvents++;let r=[];for(let[n,s]of a.entries())try{s.handler(t),s.lastTriggered=i,s.triggerCount++,s.once&&r.push(n)}catch(o){u?.debug?.error("UnifiedEventBus",`Sync handler error in ${s.subscriberName} for ${e}:`,o)}for(let n of r)a.delete(n),this.eventMetrics.activeSubscriptions--;a.size===0&&this.subscriptions.delete(e)}async processEventQueue(){if(!this.processingQueue){for(this.processingQueue=!0;this.eventQueue.length>0;){let e=this.eventQueue.shift();await this.processEvent(e.eventName,e.data,e.timestamp)}this.processingQueue=!1}}getMetrics(){return{...this.eventMetrics}}getActiveSubscriptions(){let e=[];for(let[t,i]of this.subscriptions.entries())for(let[a,r]of i.entries())e.push({eventName:t,subscriberName:r.subscriberName,subscriptionId:a,createdAt:r.createdAt,triggerCount:r.triggerCount});return e.sort((t,i)=>i.createdAt-t.createdAt)}startMetricsMonitoring(){this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},5e3)}startSubscriptionCleanup(){this.subscriptionCleanupInterval=window.setInterval(()=>{this.cleanupAbandonedSubscriptions()},6e4)}updateMetrics(){let e=Date.now(),t=this.eventMetrics.totalEvents,i=new Map;for(let[a,r]of this.subscriptions.entries()){let n=0;for(let s of r.values())n+=s.triggerCount;i.set(a,n)}this.eventMetrics.topEvents=Array.from(i.entries()).sort((a,r)=>r[1]-a[1]).slice(0,10).map(([a,r])=>({eventName:a,count:r})),this.eventMetrics.memoryUsage=this.eventMetrics.activeSubscriptions*256}cleanupAbandonedSubscriptions(){let e=Date.now()-3e5,t=0;for(let[i,a]of this.subscriptions.entries()){let r=Array.from(a.values()).filter(n=>!n.lastTriggered&&n.createdAt<e);for(let n of r)a.delete(n.id),t++,this.eventMetrics.activeSubscriptions--;a.size===0&&this.subscriptions.delete(i)}t>0&&u?.debug?.log("UnifiedEventBus",`Cleaned up ${t} abandoned subscriptions`)}generateSubscriptionId(){return`sub_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}destroy(){this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this.subscriptionCleanupInterval&&(clearInterval(this.subscriptionCleanupInterval),this.subscriptionCleanupInterval=null),this.subscriptions.clear(),this.eventQueue=[],this.eventMetrics={totalEvents:0,totalSubscriptions:0,activeSubscriptions:0,eventsPerSecond:0,topEvents:[],memoryUsage:0},u?.debug?.log("UnifiedEventBus","Unified event bus destroyed"),Le.instance=null}};Le.instance=null;ba=Le,p=ba.getInstance()});var rn={};ie(rn,{MusicalLerpOrchestrator:()=>si,musicalLerpCoordinator:()=>an,musicalLerpOrchestrator:()=>va});var si,an,va,Sa=y(()=>{"use strict";si=class{constructor(e=!1){this.baseHalfLifeValues={pulse:.08,flow:.15,emotional:.25,smooth:.12,precise:.06,crystalline:.06};this.beatPhaseConfig={attack:{start:0,end:.15,baseMultiplier:.3},sustain:{start:.15,end:.5,baseMultiplier:1},decay:{start:.5,end:.85,baseMultiplier:1.4},rest:{start:.85,end:1,baseMultiplier:.8}};this.modulationConfig={tempo:{reference:120,minFactor:.6,maxFactor:1.8,curve:.3},energy:{attackRange:.7,decayRange:.5,baseline:1},danceability:{fluidityMin:.5,fluidityMax:1,fluidThreshold:.6},temperature:{neutral:4e3,range:16e3,warmthInfluence:.3,coolPrecision:.4}};this.debugMode=!1;this.debugMode=e}calculateMusicalLerp(e,t="flow",i){return this.calculateMusicalLerpWithPerformance(e,t,i,null)}calculateMusicalLerpWithPerformance(e,t="flow",i,a,r){let n=performance.now(),s=i||this.baseHalfLifeValues[t],o=r&&a,l=!1,m=1,d=1,h=1,g=1,f=1;o&&r?(l=!0,r.useSimplifiedCalculations?(m=Math.max(.7,Math.min(1.5,e.tempo/120)),r.enableEnergyModulation&&(d=1+e.energy*.2),h=.8+e.danceability*.4):(m=this.calculateTempoFactor(e.tempo),r.enableEnergyModulation&&(d=this.calculateEnergyFactor(e.energy)),h=this.calculateDanceabilityFactor(e.danceability),r.enableTemperatureMapping&&(g=this.calculateTemperatureFactor(e.emotionalTemperature)),r.enableBeatPhase&&(f=this.calculateBeatPhaseFactor(e.beatPhase,e.timeSinceLastBeat,e.beatInterval)))):(m=this.calculateTempoFactor(e.tempo),d=this.calculateEnergyFactor(e.energy),h=this.calculateDanceabilityFactor(e.danceability),g=this.calculateTemperatureFactor(e.emotionalTemperature),f=this.calculateBeatPhaseFactor(e.beatPhase,e.timeSinceLastBeat,e.beatInterval));let S=m*d*h*g*f;if(r?.performanceMultiplier&&(S*=r.performanceMultiplier),r?.complexityReduction&&r.complexityReduction>0){let W=1-r.complexityReduction;S=1+(S-1)*W}let C=s*S,T,w;o&&r?.useSimplifiedCalculations?(T=e.energy<.5?1.2:.8,w=e.valence>.5?1.3:1):(T=this.calculateAttackMultiplier(e.energy,e.beatPhase),w=this.calculateDecayMultiplier(e.energy,e.valence));let R=this.calculateFluidityFactor(e.danceability,e.emotionalTemperature),O=this.calculateVisualEffectsLevel(e),F={halfLife:Math.max(.01,Math.min(2,C)),attackMultiplier:T,decayMultiplier:w,fluidityFactor:R,visualEffectsLevel:O,performanceOptimized:l};if(this.debugMode){F.debugInfo={tempoFactor:m,energyFactor:d,danceabilityFactor:h,temperatureFactor:g,beatPhaseFactor:f},r?.performanceMultiplier!==void 0&&(F.debugInfo.performanceMultiplier=r.performanceMultiplier),r?.complexityReduction!==void 0&&(F.debugInfo.complexityReduction=r.complexityReduction);let B=performance.now()-n;B>.5&&console.log(`\u{1F3B5} [MusicalLerpOrchestrator] Calculation time: ${B.toFixed(3)}ms (performance-optimized: ${l})`)}return F}calculateTempoFactor(e){let{reference:t,minFactor:i,maxFactor:a,curve:r}=this.modulationConfig.tempo,n=e/t,s=Math.pow(n,r);return Math.max(i,Math.min(a,s))}calculateEnergyFactor(e){let{baseline:t}=this.modulationConfig.energy;return t+e*.3}calculateDanceabilityFactor(e){let{fluidityMin:t,fluidityMax:i}=this.modulationConfig.danceability;return t+e*(i-t)}calculateTemperatureFactor(e){let{neutral:t,range:i,warmthInfluence:a}=this.modulationConfig.temperature;return 1+(e-t)/i*a}calculateBeatPhaseFactor(e,t,i){let a=this.beatPhaseConfig[e],r=Math.min(1,t/i),n=a.baseMultiplier;if(e==="attack"&&r>.1){let s=(.15-r)/.05;n=a.baseMultiplier+(1-a.baseMultiplier)*(1-s)}return n}calculateAttackMultiplier(e,t){let{attackRange:i,baseline:a}=this.modulationConfig.energy,r=a-e*i;return t==="attack"&&(r*=.5),Math.max(.1,r)}calculateDecayMultiplier(e,t){let{decayRange:i,baseline:a}=this.modulationConfig.energy,r=a+e*i;return r+=t*.3,Math.max(.8,Math.min(2,r))}calculateFluidityFactor(e,t){let{fluidityMin:i,fluidityMax:a,fluidThreshold:r}=this.modulationConfig.danceability,{neutral:n,range:s}=this.modulationConfig.temperature,o=i+e*(a-i),l=(t-n)/s;return o+=l*.2,Math.max(.3,Math.min(1.2,o))}calculateVisualEffectsLevel(e){let{energy:t,valence:i,danceability:a,beatConfidence:r}=e,n=t*.3,s=i*.2,o=a*.25,l=r*.25;return Math.max(.1,Math.min(1,n+s+o+l))}getCurrentBeatPhase(e,t){let i=Math.min(1,e/t);return i<=.15?"attack":i<=.5?"sustain":i<=.85?"decay":"rest"}createMusicalContext(e,t=0){let i=e.getCurrentMusicState();if(!i)return null;let{emotion:a,beat:r,intensity:n}=i,o=Date.now()-t,l=r?.tempo?6e4/r.tempo:500;return{tempo:r?.tempo||120,energy:r?.energy||n||.5,valence:a?.valence||.5,danceability:a?.danceability||.5,emotionalTemperature:a?.temperature||4e3,beatPhase:this.getCurrentBeatPhase(o,l),beatConfidence:r?.confidence||.5,beatInterval:l,timeSinceLastBeat:o}}setDebugMode(e){this.debugMode=e}getConfiguration(){return{baseHalfLifeValues:{...this.baseHalfLifeValues},beatPhaseConfig:{...this.beatPhaseConfig},modulationConfig:{...this.modulationConfig}}}},an=new si(!1),va=an});var D={};ie(D,{adjustColor:()=>rc,bpmToAnimationFrameRate:()=>Oo,bpmToInterval:()=>St,calculateBreathingScale:()=>Ko,calculateContrastRatio:()=>Ho,calculateNavigationScale:()=>jo,calculateOklabDerivedProperties:()=>Qo,calculateRhythmPhase:()=>Yo,colorDifference:()=>Jo,debounce:()=>Fo,easeBeatAnimation:()=>qo,findRequiredLuminance:()=>ic,generateHarmonicOklabColors:()=>Xo,getBeatPhase:()=>$o,getCanonicalAccent:()=>nc,getHealthMonitor:()=>tc,getNextBeatTime:()=>Wo,getRootStyle:()=>nn,hexToRgb:()=>ne,hslToRgb:()=>on,intervalToBpm:()=>Uo,isOnBeat:()=>No,isValidHexColor:()=>sn,lerp:()=>Zo,lerpSmooth:()=>H,lerpSmoothMusical:()=>cn,lerpSmoothMusicalPerformance:()=>_o,lerpSmoothSimpleMusical:()=>zo,oklabToRgb:()=>wa,processOklabColor:()=>Ta,rgbToHex:()=>Se,rgbToHsl:()=>Ea,rgbToOklab:()=>Ca,sanitizeColorMap:()=>Go,sleep:()=>ac,throttle:()=>Vo});function nn(){return document.documentElement}function Vo(c,e){let t;return function(...a){t||(c(...a),t=!0,setTimeout(()=>t=!1,e))}}function Fo(c,e){let t;return function(...a){clearTimeout(t),t=window.setTimeout(()=>c(...a),e)}}function sn(c){if(typeof c!="string")return!1;let e=c.trim(),t=e.startsWith("#")?e:`#${e}`;return/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/.test(t)}function ne(c){if(typeof c!="string")return{r:0,g:0,b:0};if(!sn(c))return{r:0,g:0,b:0};let e=c.trim(),t=e.startsWith("#")?e:`#${e}`;t=t.replace(/##+/g,"#"),t.length===4&&(t=`#${t[1]}${t[1]}${t[2]}${t[2]}${t[3]}${t[3]}`);let i=/^#([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(i)try{return{r:parseInt(i[1]||"0",16),g:parseInt(i[2]||"0",16),b:parseInt(i[3]||"0",16)}}catch{return{r:0,g:0,b:0}}else return{r:0,g:0,b:0}}function Go(c){console.log("\u{1F3A8} [ThemeUtilities] sanitizeColorMap input:",{input:c,inputKeys:c?Object.keys(c):[],inputEntries:c?Object.entries(c):[]});let e=/^#?[0-9a-fA-F]{3}(?:[0-9a-fA-F]{3})?$/,t={};if(!c||typeof c!="object")return console.warn("\u{1F3A8} [ThemeUtilities] sanitizeColorMap: Invalid input type"),t;let i=[];return Object.entries(c).forEach(([a,r])=>{if(typeof r!="string"){i.push([a,r]),console.warn(`\u{1F3A8} [ThemeUtilities] Dropped non-string color: ${a} = ${r} (type: ${typeof r})`);return}let n=r.trim();if(!n||n==="undefined"){i.push([a,r]),console.warn(`\u{1F3A8} [ThemeUtilities] Dropped empty/undefined color: ${a} = "${r}"`);return}if(!e.test(n)){i.push([a,r]),console.warn(`\u{1F3A8} [ThemeUtilities] Dropped invalid hex color: ${a} = "${r}"`);return}let s=n.startsWith("#")?n:`#${n}`;t[a]=s}),console.log("\u{1F3A8} [ThemeUtilities] sanitizeColorMap output:",{sanitized:t,sanitizedKeys:Object.keys(t),sanitizedEntries:Object.entries(t),droppedCount:i.length,droppedEntries:i}),E?.enableDebug&&Object.keys(c).length!==Object.keys(t).length&&console.warn(`[StarryNight sanitizeColorMap] Dropped ${Object.keys(c).length-Object.keys(t).length} invalid colour entries.`),t}function Ea(c,e,t){c/=255,e/=255,t/=255;let i=Math.max(c,e,t),a=Math.min(c,e,t),r=0,n=0,s=(i+a)/2;if(i!==a){let o=i-a;switch(n=s>.5?o/(2-i-a):o/(i+a),i){case c:r=(e-t)/o+(e<t?6:0);break;case e:r=(t-c)/o+2;break;case t:r=(c-e)/o+4;break}r/=6}return{h:r*360,s:n*100,l:s*100}}function on(c,e,t){c/=360,e/=100,t/=100;let i=(s,o,l)=>(l<0&&(l+=1),l>1&&(l-=1),l<1/6?s+(o-s)*6*l:l<1/2?o:l<2/3?s+(o-s)*(2/3-l)*6:s),a,r,n;if(e===0)a=r=n=t;else{let s=t<.5?t*(1+e):t+e-t*e,o=2*t-s;a=i(o,s,c+1/3),r=i(o,s,c),n=i(o,s,c-1/3)}return{r:Math.round(a*255),g:Math.round(r*255),b:Math.round(n*255)}}function Se(c,e,t){let i=s=>{if(!Number.isFinite(s))return 0;let o=s<=1?s*255:s;return Math.min(255,Math.max(0,Math.round(o)))},[a,r,n]=[i(c),i(e),i(t)];return"#"+[a,r,n].map(s=>s.toString(16).padStart(2,"0")).join("")}function Ho(c,e){let t=l=>{let[m=0,d=0,h=0]=[l.r,l.g,l.b].map(g=>(g=g/255,g<=.03928?g/12.92:Math.pow((g+.055)/1.055,2.4)));return .2126*m+.7152*d+.0722*h},i=ne(c),a=ne(e);if(!i||!a)return 1;let r=t(i),n=t(a),s=Math.max(r,n),o=Math.min(r,n);return(s+.05)/(o+.05)}function H(c,e,t,i){return i<=1e-5||t<=0?(E?.enableDebug&&i<=1e-5,e):e+(c-e)*Math.pow(2,-t/i)}function cn(c,e,t,i,a="flow",r){let{musicalLerpOrchestrator:n}=(Sa(),Bo(rn)),s=n.calculateMusicalLerp(i,a,r);return H(c,e,t,s.halfLife)}function _o(c,e,t,i,a,r="flow",n){return a?.calculatePerformanceAwareMusicalLerp?a.calculatePerformanceAwareMusicalLerp(c,e,t,i,r,n):cn(c,e,t,i,r,n)}function zo(c,e,t,i=120,a=.5,r=.15){let n=Math.pow(i/120,.3),s=1+a*.3,o=r/n*s;return H(c,e,t,o)}function St(c){return!c||c<=0?500:6e4/c}function Uo(c){return!c||c<=0?120:6e4/c}function Oo(c,e=4){return St(c)/e}function No(c,e,t,i=50){let a=St(t),n=(c-e)%a;return n<=i||n>=a-i}function $o(c,e,t){let i=St(t);return(c-e)%i/i}function Wo(c,e,t){let i=St(t),a=c-e,r=Math.floor(a/i);return e+(r+1)*i}function qo(c,e="ease-out"){switch(e){case"ease-in":return c*c;case"linear":return c;case"ease-out":default:return c*(2-c)}}function Yo(c,e=1){let t=.001*e;return c*t%(2*Math.PI)}function Ko(c,e=.5){let i=.02*e;return 1+Math.sin(c)*i}function jo(c=.5,e="neutral"){let i=e==="energetic"?1.2:e==="calm"?.8:1;return 1+.05*c*i}function Ca(c,e,t){let i=c/255,a=e/255,r=t/255,n=.4122214708*i+.5363325363*a+.0514459929*r,s=.2119034982*i+.6806995451*a+.1073969566*r,o=.0883024619*i+.2817188376*a+.6299787005*r,l=Math.cbrt(n),m=Math.cbrt(s),d=Math.cbrt(o);return{L:.2104542553*l+.793617785*m-.0040720468*d,a:1.9779984951*l-2.428592205*m+.4505937099*d,b:.0259040371*l+.7827717662*m-.808675766*d}}function wa(c,e,t){let i=c+.3963377774*e+.2158037573*t,a=c-.1055613458*e-.0638541728*t,r=c-.0894841775*e-1.291485548*t,n=i*i*i,s=a*a*a,o=r*r*r,l=4.0767416621*n-3.3077115913*s+.2309699292*o,m=-1.2684380046*n+2.6097574011*s-.3413193965*o,d=-.0041960863*n-.7034186147*s+1.707614701*o;return l=Math.round(Math.max(0,Math.min(1,l))*255),m=Math.round(Math.max(0,Math.min(1,m))*255),d=Math.round(Math.max(0,Math.min(1,d))*255),{r:l,g:m,b:d}}function Ta(c,e={}){let{L:t,a:i,b:a}=c,r=Math.sqrt(i*i+a*a),n=Math.atan2(a,i);n<0&&(n+=2*Math.PI);let s=n*(180/Math.PI),{energy:o=.5,valence:l=.5,artisticMode:m="artist-vision"}=e,d=E.getCurrentMultipliers(),h=t*(1+(l-.5)*.1),g=r*(1+(o-.5)*.2)*(d?.saturation||1);return h=Math.max(0,Math.min(1,h*(d?.brightness||1))),{L:h,C:g,h:r>.001?s:null}}function Qo(c){let{L:e,C:t,h:i}=Ta(c),a=i!==null?i>=0&&i<90||i>=270&&i<=360:!1,r=i!==null?i>=90&&i<270:!1,n="neutral";return e>.7&&t>.1?n="bright":e<.4?n="dark":a&&t>.1?n="warm":r&&t>.1&&(n="cool"),{lightness:e,chroma:t,hue:i,isWarm:a,isCool:r,mood:n}}function Xo(c,e="analogous",t=30){let i=Ta(c);if(i.h===null)return[c];let a=(l,m,d)=>{let h=d*(Math.PI/180),g=m*Math.cos(h),f=m*Math.sin(h);return{L:l,a:g,b:f}},r=[c],{L:n,C:s,h:o}=i;switch(e){case"complementary":r.push(a(n,s,(o+180)%360));break;case"analogous":r.push(a(n,s,(o+t)%360)),r.push(a(n,s,(o-t+360)%360));break;case"triadic":r.push(a(n,s,(o+120)%360)),r.push(a(n,s,(o+240)%360));break;case"tetradic":r.push(a(n,s,(o+90)%360)),r.push(a(n,s,(o+180)%360)),r.push(a(n,s,(o+270)%360));break;case"split-complementary":r.push(a(n,s,(o+180-t)%360)),r.push(a(n,s,(o+180+t)%360));break;case"monochromatic":r.push({L:Math.max(0,n-.2),a:c.a,b:c.b}),r.push({L:Math.min(1,n+.2),a:c.a,b:c.b});break}return r}function Zo(c,e,t){return(1-t)*c+t*e}function Jo(c,e){let t=Ca(c.r,c.g,c.b),i=Ca(e.r,e.g,e.b),a=t.L-i.L,r=t.a-i.a,n=t.b-i.b;return Math.sqrt(a*a+r*r+n*n)}function tc(){return ec}function ic(c,e,t){let i=l=>{let[m=0,d=0,h=0]=[l.r,l.g,l.b].map(g=>(g=g/255,g<=.03928?g/12.92:Math.pow((g+.055)/1.055,2.4)));return .2126*m+.7152*d+.0722*h},a=i(e),r;r=t*(a+.05)-.05;let n=Ea(c.r,c.g,c.b),s=i(c),o=r/s;return n.l}function ac(c){return new Promise(e=>setTimeout(e,c))}function rc(c,{brightness:e=1,saturation:t=1,hue:i=0}){let a=Ea(c.r,c.g,c.b);return a.h=(a.h+i)%360,a.s=Math.max(0,Math.min(100,a.s*t)),a.l=Math.max(0,Math.min(100,a.l*e)),on(a.h,a.s,a.l)}function nc(){let c=nn(),e=getComputedStyle(c),t=e.getPropertyValue("--sn-accent-hex").trim(),i=e.getPropertyValue("--sn-accent-rgb").trim();if(!t&&i){let[a="0",r="0",n="0"]=i.split(/\s*,\s*/),s=parseInt(a,10)||0,o=parseInt(r,10)||0,l=parseInt(n,10)||0;t=Se(s,o,l)}if(!i&&t){let a=ne(t);a&&(i=`${a.r},${a.g},${a.b}`)}return{hex:t,rgb:i}}var Ma,ec,X=y(()=>{"use strict";U();Ma=class{registerSystem(e,t){}updateSystemMetrics(e,t){}},ec=new Ma});var Ce,M,ae=y(()=>{"use strict";x();X();Ce=class Ce{constructor(e=!1){this.utils=D;this.debugEnabled=e}processColor(e,t=Ce.PRESETS.STANDARD){let i=performance.now(),a=null;try{if(a=this.utils.hexToRgb(e),!a)throw new Error(`Invalid hex color: ${e}`);let r=this.utils.rgbToOklab(a.r,a.g,a.b),n=this.enhanceOKLABColor(r,t),s=this.generateShadowColor(r,t),o=this.utils.oklabToRgb(n.L,n.a,n.b),l=this.utils.oklabToRgb(s.L,s.a,s.b),m=this.utils.rgbToHex(o.r,o.g,o.b),d=this.utils.rgbToHex(l.r,l.g,l.b),h=this.convertOklabToOklch(n),g=performance.now()-i,f={originalHex:e,originalRgb:a,enhancedHex:m,enhancedRgb:o,shadowHex:d,shadowRgb:l,oklabOriginal:r,oklabEnhanced:n,oklabShadow:s,oklchEnhanced:h,processingTime:g};return this.debugEnabled&&u?.debug?.log("OKLABColorProcessor","Color processed:",{input:e,enhanced:m,shadow:d,preset:t.name,processingTime:`${g.toFixed(2)}ms`}),f}catch(r){this.debugEnabled&&u?.debug?.error("OKLABColorProcessor","Color processing failed:",r);let n=a||{r:124,g:58,b:237};return this.createFallbackResult(e,n)}}processColorPalette(e,t=Ce.PRESETS.STANDARD){let i={};return Object.entries(e).forEach(([a,r])=>{r&&this.utils.hexToRgb(r)&&(i[a]=this.processColor(r,t))}),i}generateCSSVariables(e,t="sn-oklab"){let i={};return i[`--${t}-enhanced-hex`]=e.enhancedHex,i[`--${t}-enhanced-rgb`]=`${e.enhancedRgb.r},${e.enhancedRgb.g},${e.enhancedRgb.b}`,i[`--${t}-enhanced-r`]=Math.round(e.enhancedRgb.r).toString(),i[`--${t}-enhanced-g`]=Math.round(e.enhancedRgb.g).toString(),i[`--${t}-enhanced-b`]=Math.round(e.enhancedRgb.b).toString(),i[`--${t}-shadow-hex`]=e.shadowHex,i[`--${t}-shadow-rgb`]=`${e.shadowRgb.r},${e.shadowRgb.g},${e.shadowRgb.b}`,i[`--${t}-lightness`]=e.oklabEnhanced.L.toFixed(3),i[`--${t}-chroma-a`]=e.oklabEnhanced.a.toFixed(3),i[`--${t}-chroma-b`]=e.oklabEnhanced.b.toFixed(3),i[`--${t}-oklch-l`]=e.oklchEnhanced.L.toFixed(3),i[`--${t}-oklch-c`]=e.oklchEnhanced.C.toFixed(3),i[`--${t}-oklch-h`]=e.oklchEnhanced.H.toFixed(1),i}interpolateOKLAB(e,t,i,a=Ce.PRESETS.STANDARD){let r=this.utils.hexToRgb(e),n=this.utils.hexToRgb(t);if(!r||!n)throw new Error("Invalid hex colors for interpolation");let s=this.utils.rgbToOklab(r.r,r.g,r.b),o=this.utils.rgbToOklab(n.r,n.g,n.b),l={L:s.L+(o.L-s.L)*i,a:s.a+(o.a-s.a)*i,b:s.b+(o.b-s.b)*i},m=this.utils.oklabToRgb(l.L,l.a,l.b),d=this.utils.rgbToHex(m.r,m.g,m.b);return this.processColor(d,a)}generateOKLABGradient(e,t,i=5,a=Ce.PRESETS.STANDARD){let r=[];for(let n=0;n<i;n++){let s=n/(i-1),o=this.interpolateOKLAB(e,t,s,a);r.push(o)}return r}enhanceOKLABColor(e,t){let i=Math.sqrt(e.a*e.a+e.b*e.b),a=Math.min(1,Math.max(0,e.L*t.lightnessBoost)),r=i>t.vibrantThreshold?t.chromaBoost:1,n=e.a*r,s=e.b*r;return{L:a,a:n,b:s}}generateShadowColor(e,t){return{L:Math.max(.02,e.L*t.shadowReduction),a:e.a*.8,b:e.b*.8}}convertOklabToOklch(e){let t=e.L,i=Math.sqrt(e.a*e.a+e.b*e.b),a=Math.atan2(e.b,e.a)*(180/Math.PI);return a<0&&(a+=360),{L:t,C:i,H:a}}createFallbackResult(e,t){let i=this.utils.rgbToOklab(t.r,t.g,t.b);return{originalHex:e,originalRgb:t,enhancedHex:e,enhancedRgb:t,shadowHex:"#000000",shadowRgb:{r:0,g:0,b:0},oklabOriginal:i,oklabEnhanced:i,oklabShadow:{L:.05,a:0,b:0},oklchEnhanced:this.convertOklabToOklch(i),processingTime:0}}static getPreset(e){return Ce.PRESETS[e.toUpperCase()]||Ce.PRESETS.STANDARD}static createCustomPreset(e,t,i,a,r=.3,n=.1){return{name:e,description:t,lightnessBoost:Math.max(.5,Math.min(1.5,i)),chromaBoost:Math.max(.5,Math.min(2,a)),shadowReduction:Math.max(.1,Math.min(.5,r)),vibrantThreshold:Math.max(.05,Math.min(.2,n))}}};Ce.PRESETS={SUBTLE:{name:"Subtle Enhancement",description:"Minimal color enhancement for conservative aesthetics",lightnessBoost:1.05,chromaBoost:1.1,shadowReduction:.4,vibrantThreshold:.08},STANDARD:{name:"Standard Enhancement",description:"Balanced color enhancement for general use",lightnessBoost:1.1,chromaBoost:1.15,shadowReduction:.3,vibrantThreshold:.1},VIBRANT:{name:"Vibrant Enhancement",description:"Enhanced vibrancy for dynamic color experiences",lightnessBoost:1.15,chromaBoost:1.25,shadowReduction:.25,vibrantThreshold:.12},COSMIC:{name:"Cosmic Enhancement",description:"Maximum enhancement for Year 3000 visual-effects experiences",lightnessBoost:1.2,chromaBoost:1.35,shadowReduction:.2,vibrantThreshold:.15}};M=Ce});var oi,Z,Me=y(()=>{"use strict";ae();oi={calm:{temperatureRange:[2700,4e3],baseTemperature:3200,characteristics:{energy:[0,.3],valence:[.4,.8],intensity:.6},cssClass:"smooth-emotion-calm",description:"Warm, soothing, meditative states",oklabBaseColor:"#89b4fa",oklabPreset:"SUBTLE",perceptualCharacteristics:{lightness:[.6,.8],chromaBoost:.9,hueShift:15}},melancholy:{temperatureRange:[2200,3500],baseTemperature:2800,characteristics:{energy:[0,.4],valence:[0,.4],intensity:.8},cssClass:"smooth-emotion-melancholy",description:"Deep, introspective, amber-golden tones",oklabBaseColor:"#f9e2af",oklabPreset:"STANDARD",perceptualCharacteristics:{lightness:[.4,.6],chromaBoost:1.1,hueShift:-10}},energetic:{temperatureRange:[5500,7500],baseTemperature:6500,characteristics:{energy:[.6,1],valence:[.5,1],intensity:1},cssClass:"smooth-emotion-energetic",description:"Bright, vibrant, high-energy states",oklabBaseColor:"#a6e3a1",oklabPreset:"VIBRANT",perceptualCharacteristics:{lightness:[.7,.9],chromaBoost:1.3,hueShift:5}},aggressive:{temperatureRange:[8e3,12e3],baseTemperature:1e4,characteristics:{energy:[.7,1],valence:[0,.6],intensity:1.2},cssClass:"smooth-emotion-aggressive",description:"Cool, intense, high-energy negative valence",oklabBaseColor:"#f38ba8",oklabPreset:"COSMIC",perceptualCharacteristics:{lightness:[.5,.7],chromaBoost:1.4,hueShift:-5}},happy:{temperatureRange:[4500,6500],baseTemperature:5500,characteristics:{energy:[.4,.8],valence:[.6,1],intensity:.9},cssClass:"smooth-emotion-happy",description:"Balanced, joyful, warm-white tones",oklabBaseColor:"#fab387",oklabPreset:"STANDARD",perceptualCharacteristics:{lightness:[.75,.85],chromaBoost:1.15,hueShift:8}},romantic:{temperatureRange:[2500,3500],baseTemperature:3e3,characteristics:{energy:[.2,.6],valence:[.5,.9],intensity:.7},cssClass:"smooth-emotion-romantic",description:"Soft, intimate, warm tones with pink accent",oklabBaseColor:"#f5c2e7",oklabPreset:"SUBTLE",perceptualCharacteristics:{lightness:[.65,.8],chromaBoost:1,hueShift:12}},mysterious:{temperatureRange:[1800,2800],baseTemperature:2300,characteristics:{energy:[.1,.5],valence:[.1,.5],intensity:.9},cssClass:"smooth-emotion-mysterious",description:"Deep, enigmatic, low temperature with purple accent",oklabBaseColor:"#cba6f7",oklabPreset:"VIBRANT",perceptualCharacteristics:{lightness:[.3,.5],chromaBoost:1.2,hueShift:-15}},epic:{temperatureRange:[7e3,15e3],baseTemperature:11e3,characteristics:{energy:[.6,1],valence:[.3,.8],intensity:1.3},cssClass:"smooth-emotion-epic",description:"Grand, cinematic, high contrast blue-gold",oklabBaseColor:"#74c7ec",oklabPreset:"COSMIC",perceptualCharacteristics:{lightness:[.6,.9],chromaBoost:1.35,hueShift:20}},ambient:{temperatureRange:[3e3,5e3],baseTemperature:4e3,characteristics:{energy:[.1,.4],valence:[.3,.7],intensity:.5},cssClass:"smooth-emotion-ambient",description:"Atmospheric, floating, neutral temperature",oklabBaseColor:"#94e2d5",oklabPreset:"SUBTLE",perceptualCharacteristics:{lightness:[.5,.7],chromaBoost:.8,hueShift:0}}},Z=class{constructor(e=!1){this.enableDebug=e,this.oklabProcessor=new M(e)}mapMusicToEmotionalTemperature(e){let{energy:t=.5,valence:i=.5,danceability:a=.5,tempo:r=120,mode:n=1}=e,s,o,l=1;if(t>=.6&&i>=.6?(s=a>.7?"energetic":"happy",t>.8&&i>.8&&(o="epic",l=.7)):t>=.6&&i<.5?(s=t>.8?"aggressive":"epic",i<.3&&(o="mysterious",l=.8)):t<.4&&i>=.5?(s=i>.7?"calm":"romantic",t<.2&&(o="ambient",l=.6)):(s=i<.3?"melancholy":"mysterious",t<.2&&i<.2&&(o="ambient",l=.8)),e.genre){let I=this.getGenreEmotionalAdjustment(e.genre,s);I&&(I.override&&(s=I.override),I.secondary&&(o=I.secondary,l=I.blendRatio||.7))}let m=oi[s].characteristics.intensity,d=t*.3,h=Math.abs(i-.5)*.2,g=r>140?.1:r<80?-.1:0,f=Math.max(.1,Math.min(1.5,m+d+h+g)),S=oi[s],[C,T]=S.temperatureRange,w=t*.6+i*.4,R=C+(T-C)*w,O=M.getPreset(S.oklabPreset),F,B;try{let I=this.createContextualOKLABPreset(S,f,t,i);F=this.oklabProcessor.processColor(S.oklabBaseColor,I),B=F.enhancedHex,this.enableDebug&&console.log("\u{1F321}\uFE0F [EmotionalTemperatureMapper] OKLAB processing:",{emotion:s,baseColor:S.oklabBaseColor,preset:I.name,enhanced:B,oklabCoords:F.oklabEnhanced})}catch(I){this.enableDebug&&console.warn("\u{1F321}\uFE0F [EmotionalTemperatureMapper] OKLAB processing failed:",I),B=S.oklabBaseColor}let W=this.generateEmotionalCSSVariables(s,o,f,R,l,F,B),z={primaryEmotion:s,...o&&{secondaryEmotion:o},intensity:f,temperature:Math.round(R),blendRatio:l,cssClass:S.cssClass,cssVariables:W,oklabPreset:O,...F&&{oklabResult:F},...B&&{perceptualColorHex:B}};return this.enableDebug&&console.log("\u{1F321}\uFE0F [EmotionalTemperatureMapper] Music analysis result:",{input:{energy:t,valence:i,genre:e.genre},output:z,reasoning:{energyValenceQuadrant:this.getEnergyValenceQuadrant(t,i),genreInfluence:e.genre,intensityFactors:{baseIntensity:m,energyBoost:d,valenceInfluence:h,tempoInfluence:g}}}),z}createContextualOKLABPreset(e,t,i,a){let r=M.getPreset(e.oklabPreset),n=e.perceptualCharacteristics,s=i*.5+a*.3+.2,o=n.lightness[0]+(n.lightness[1]-n.lightness[0])*s,l=n.chromaBoost*t*(.8+i*.4);return M.createCustomPreset(`${e.cssClass}-contextual`,`Contextual ${r.description} for ${e.description}`,o/.5,l,r.shadowReduction,r.vibrantThreshold)}getGenreEmotionalAdjustment(e,t){let i={edm:{secondary:"energetic",blendRatio:.8},house:{secondary:"energetic",blendRatio:.7},ambient:{override:"ambient"},downtempo:{override:"calm",secondary:"ambient",blendRatio:.6},metal:{override:"aggressive"},"hard-rock":{secondary:"aggressive",blendRatio:.8},alternative:{secondary:"epic",blendRatio:.7},classical:{override:"epic",secondary:"calm",blendRatio:.6},soundtrack:{override:"epic"},orchestral:{override:"epic"},jazz:{override:"mysterious",secondary:"romantic",blendRatio:.7},blues:{override:"melancholy"},soul:{secondary:"romantic",blendRatio:.6},folk:{override:"calm",secondary:"melancholy",blendRatio:.6},acoustic:{override:"romantic",secondary:"calm",blendRatio:.7},"hip-hop":{secondary:"aggressive",blendRatio:.8},trap:{secondary:"aggressive",blendRatio:.9},pop:{secondary:"happy",blendRatio:.7},"indie-pop":{secondary:"happy",blendRatio:.6}},a=e.toLowerCase().replace(/[\s-_]/g,"-");return i[a]||null}getEnergyValenceQuadrant(e,t){return e>=.5&&t>=.5?"High Energy + Positive":e>=.5&&t<.5?"High Energy + Negative":e<.5&&t>=.5?"Low Energy + Positive":"Low Energy + Negative"}generateEmotionalCSSVariables(e,t,i,a,r,n,s){let o={};o["--smooth-current-emotion"]=e,o["--smooth-emotional-intensity"]=i.toString(),o["--smooth-current-temperature"]=a.toString(),o["--smooth-emotion-primary"]=e,t&&(o["--smooth-emotion-secondary"]=t,o["--smooth-emotion-blend-ratio"]=r.toString()),o["--smooth-emotional-saturation"]=Math.max(.5,i).toString(),o["--smooth-cinematic-contrast"]=Math.max(.8,i*1.2).toString(),o["--smooth-warmth"]=this.calculateWarmth(a).toString();let l=this.calculatePulsingSpeed(e,i);o["--smooth-pulsing-cycle"]=`${l}s`;let m=this.calculateTemperatureFilters(a,i);return Object.assign(o,m),n&&s&&(o["--smooth-emotion-oklab-hex"]=s,o["--smooth-emotion-oklab-rgb"]=`${n.enhancedRgb.r},${n.enhancedRgb.g},${n.enhancedRgb.b}`,o["--smooth-emotion-oklab-l"]=n.oklabEnhanced.L.toFixed(3),o["--smooth-emotion-oklab-a"]=n.oklabEnhanced.a.toFixed(3),o["--smooth-emotion-oklab-b"]=n.oklabEnhanced.b.toFixed(3),o["--smooth-emotion-oklch-l"]=n.oklchEnhanced.L.toFixed(3),o["--smooth-emotion-oklch-c"]=n.oklchEnhanced.C.toFixed(3),o["--smooth-emotion-oklch-h"]=n.oklchEnhanced.H.toFixed(1),o["--smooth-emotion-oklab-shadow-hex"]=n.shadowHex,o["--smooth-emotion-oklab-shadow-rgb"]=`${n.shadowRgb.r},${n.shadowRgb.g},${n.shadowRgb.b}`,o["--smooth-perceptual-emotion-color"]=s,o["--smooth-perceptual-emotion-rgb"]=`${n.enhancedRgb.r},${n.enhancedRgb.g},${n.enhancedRgb.b}`,this.enableDebug&&console.log("\u{1F3A8} [EmotionalTemperatureMapper] Generated OKLAB CSS variables:",{emotion:e,perceptualColor:s,oklabCoords:n.oklabEnhanced,oklchCoords:n.oklchEnhanced})),o}calculateWarmth(e){return e<=4e3?.7+(4e3-e)/2200*.3:e>=7e3?Math.max(.2,.7-(e-7e3)/8e3*.5):.5+(7e3-e)/3e3*.2}calculatePulsingSpeed(e,t){let a={calm:6,melancholy:8,energetic:2,aggressive:1.5,happy:3,romantic:5,mysterious:7,epic:2.5,ambient:10}[e],r=Math.max(.5,Math.min(2,2-t));return a*r}calculateTemperatureFilters(e,t){let i={},a=this.mapTemperatureToHue(e);i["--smooth-temperature-hue-shift"]=`${a}deg`;let r=Math.max(.8,Math.min(1.5,1+(t-.5)*.4));i["--smooth-temperature-saturation"]=r.toString();let n=this.mapTemperatureToBrightness(e);return i["--smooth-temperature-brightness"]=n.toString(),i}mapTemperatureToHue(e){return e<=4e3?-15+(4e3-e)/2e3*-15:e>=8e3?10+(e-8e3)/7e3*20:-5+(e-4e3)/4e3*15}mapTemperatureToBrightness(e){return .9+(e-2e3)/13e3*.3}applyEmotionalTemperature(e,t){let i=Array.from(e.classList).filter(a=>a.startsWith("smooth-emotion-"));e.classList.remove(...i),e.classList.add(t.cssClass),t.secondaryEmotion&&e.classList.add(`smooth-emotion-blend-${t.secondaryEmotion}`),Object.entries(t.cssVariables).forEach(([a,r])=>{e.style.setProperty(a,r)}),this.enableDebug&&console.log("\u{1F3A8} [EmotionalTemperatureMapper] Applied emotional temperature:",{element:e.tagName,emotion:t.primaryEmotion,secondary:t.secondaryEmotion,intensity:t.intensity,temperature:t.temperature})}static getAvailableEmotions(){return Object.keys(oi)}static getEmotionCharacteristics(e){return oi[e]}}});function b(c,e,t,i){let a=parseInt(c.slice(1,3),16),r=parseInt(c.slice(3,5),16),n=parseInt(c.slice(5,7),16),s=(.299*a+.587*r+.114*n)/255;return{hex:c,rgb:`${a}, ${r}, ${n}`,hsl:[e,t,i],brightness:s}}function ln(c,e){let t=Re[c],i=sc[e];switch(e){case"bright":return c==="latte"?t.surface1:t.surface0;case"balanced":return c==="latte"?t.base:t.surface0;case"dark":return c==="latte"?t.mantle:t.base;default:return t.base}}function un(c,e){let t=Re[c];switch(e){case"bright":return c==="latte"?t.surface2:t.surface1;case"balanced":return c==="latte"?t.surface0:t.surface1;case"dark":return t.surface0;default:return t.surface1}}function mn(c,e){return Re[c][e]}function dn(c){let e=Re[c];return c==="latte"?e.blue:e.mauve}var Re,sc,Pa=y(()=>{"use strict";Re={mocha:{rosewater:b("#f5e0dc",10,56,91),flamingo:b("#f2cdcd",0,59,88),pink:b("#f5c2e7",316,72,86),mauve:b("#cba6f7",267,84,81),red:b("#f38ba8",343,81,75),maroon:b("#eba0ac",350,65,77),peach:b("#fab387",23,92,75),yellow:b("#f9e2af",41,86,83),green:b("#a6e3a1",115,54,76),teal:b("#94e2d5",174,57,73),sky:b("#89dceb",189,71,73),sapphire:b("#74c7ec",199,76,69),blue:b("#89b4fa",217,92,76),lavender:b("#b4befe",232,97,85),text:b("#cdd6f4",226,64,88),subtext1:b("#bac2de",227,35,80),subtext0:b("#a6adc8",228,24,72),overlay2:b("#9399b2",228,17,64),overlay1:b("#7f849c",230,13,55),overlay0:b("#6c7086",231,11,47),surface2:b("#585b70",233,12,39),surface1:b("#45475a",234,13,31),surface0:b("#313244",237,16,23),base:b("#1e1e2e",240,21,15),mantle:b("#181825",240,18,13),crust:b("#11111b",240,23,9)},latte:{rosewater:b("#dc8a78",11,59,67),flamingo:b("#dd7878",0,60,67),pink:b("#ea76cb",316,73,69),mauve:b("#8839ef",266,85,58),red:b("#d20f39",347,87,44),maroon:b("#e64553",355,76,59),peach:b("#fe640b",22,99,52),yellow:b("#df8e1d",35,77,49),green:b("#40a02b",109,58,40),teal:b("#179299",183,74,35),sky:b("#04a5e5",197,97,46),sapphire:b("#209fb5",189,70,42),blue:b("#1e66f5",220,91,54),lavender:b("#7287fd",231,97,72),text:b("#4c4f69",234,16,35),subtext1:b("#5c5f77",233,13,41),subtext0:b("#6c6f85",233,10,47),overlay2:b("#7c7f93",232,10,53),overlay1:b("#8c8fa1",231,10,59),overlay0:b("#9ca0b0",228,11,65),surface2:b("#acb0be",227,12,71),surface1:b("#bcc0cc",226,14,77),surface0:b("#ccd0da",225,16,83),base:b("#eff1f5",220,23,95),mantle:b("#e6e9ef",220,22,92),crust:b("#dce0e8",220,21,89)},frappe:{rosewater:b("#f2d5cf",10,57,88),flamingo:b("#eebebe",0,58,84),pink:b("#f4b8e4",316,73,84),mauve:b("#ca9ee6",277,59,76),red:b("#e78284",359,68,71),maroon:b("#ea999c",358,56,76),peach:b("#ef9f76",20,79,70),yellow:b("#e5c890",40,62,73),green:b("#a6d189",96,44,68),teal:b("#81c8be",172,39,65),sky:b("#99d1db",189,48,73),sapphire:b("#85c1dc",199,55,69),blue:b("#8caaee",222,74,74),lavender:b("#babbf1",239,66,84),text:b("#c6d0f5",227,70,87),subtext1:b("#b5bfe2",229,44,80),subtext0:b("#a5adce",230,34,72),overlay2:b("#949cbb",231,19,64),overlay1:b("#838ba7",232,16,56),overlay0:b("#737994",232,13,49),surface2:b("#626880",233,16,42),surface1:b("#51576d",234,16,35),surface0:b("#414559",235,16,30),base:b("#303446",229,19,23),mantle:b("#292c3c",231,19,20),crust:b("#232634",229,20,17)},macchiato:{rosewater:b("#f4dbd6",10,58,90),flamingo:b("#f0c6c6",0,58,86),pink:b("#f5bde6",316,74,85),mauve:b("#c6a0f6",267,83,79),red:b("#ed8796",351,74,73),maroon:b("#ee99a0",357,70,77),peach:b("#f5a97f",21,86,73),yellow:b("#eed49f",42,79,78),green:b("#a6da95",105,48,72),teal:b("#8bd5ca",172,47,69),sky:b("#91d7e3",189,59,73),sapphire:b("#7dc4e4",199,66,69),blue:b("#8aadf4",220,83,75),lavender:b("#b7bdf8",238,82,84),text:b("#cad3f5",227,68,88),subtext1:b("#b8c0e0",228,39,81),subtext0:b("#a5adcb",227,27,72),overlay2:b("#939ab7",228,20,64),overlay1:b("#8087a2",230,15,56),overlay0:b("#6e738d",230,12,48),surface2:b("#5b6078",233,16,40),surface1:b("#494d64",234,15,33),surface0:b("#363a4f",235,16,26),base:b("#24273a",232,23,19),mantle:b("#1e2030",233,23,16),crust:b("#181926",236,23,13)}},sc={bright:{baseColorTarget:.25,surfaceColorTarget:.35,textContrastMin:4.5},balanced:{baseColorTarget:.15,surfaceColorTarget:.25,textContrastMin:4.5},dark:{baseColorTarget:.08,surfaceColorTarget:.15,textContrastMin:3}}});function v(c,e,t,i){let a=parseInt(c.slice(1,3),16),r=parseInt(c.slice(3,5),16),n=parseInt(c.slice(5,7),16),s=(.299*a+.587*r+.114*n)/255;return{hex:c,rgb:`${a}, ${r}, ${n}`,hsl:[e,t,i],brightness:s}}function hn(c,e){let t=Be[c],i=cc[e];switch(e){case"bright":return t.surface1;case"balanced":return t.surface0;case"dark":return t.base;default:return t.base}}function gn(c,e){let t=Be[c];switch(e){case"bright":return t.surface2;case"balanced":return t.surface1;case"dark":return t.surface0;default:return t.surface1}}function pn(c,e){return Be[c][e]}function fn(c){return Be[c].mauve}function yn(c,e="medium"){let t=Be[c];switch(e){case"low":return[t.mauve,t.blue];case"medium":return[t.pink,t.peach];case"high":return[t.red,t.teal];default:return[t.mauve,t.pink]}}function bn(c){let e=Be[c];return{primary:e.mauve,secondary:e.pink,tertiary:e.sky,atmosphere:e.base}}var Be,cc,Aa=y(()=>{"use strict";Be={subtle:{rosewater:v("#e8d5d1",15,45,85),flamingo:v("#e5c3c3",0,45,82),pink:v("#d8a8cc",316,40,75),mauve:v("#9d7bc7",267,45,65),red:v("#c85a7a",343,45,60),maroon:v("#c27882",350,35,65),peach:v("#d18a5f",23,50,60),yellow:v("#d4c285",41,45,70),green:v("#8cc98a",115,35,65),teal:v("#7bc5b8",174,35,65),sky:v("#7ab5c7",189,40,65),sapphire:v("#6baac7",199,45,60),blue:v("#7d9dd4",217,50,65),lavender:v("#a8aed9",232,45,75),text:v("#c2c8d4",226,25,80),subtext1:v("#b2b8c8",227,20,72),subtext0:v("#9ca4b8",228,15,65),overlay2:v("#868ea8",228,12,58),overlay1:v("#757d95",230,10,52),overlay0:v("#656c82",231,8,45),surface2:v("#555c70",233,8,38),surface1:v("#454c5a",234,8,32),surface0:v("#353a46",237,10,25),base:v("#252832",240,12,17),mantle:v("#1f222a",240,10,15),crust:v("#181b22",240,15,12)},balanced:{rosewater:v("#f2d8d3",15,60,88),flamingo:v("#eec6c6",0,60,85),pink:v("#e8b3d8",316,55,80),mauve:v("#b388d6",267,55,70),red:v("#d16b8a",343,55,65),maroon:v("#d08692",350,45,70),peach:v("#e59a6f",23,65,65),yellow:v("#e0d295",41,55,75),green:v("#9cd49a",115,40,70),teal:v("#8bd0c3",174,40,70),sky:v("#8ac0d2",189,50,70),sapphire:v("#7bb5d2",199,55,65),blue:v("#8da8e0",217,60,70),lavender:v("#b8bee5",232,55,80),text:v("#ced4e0",226,35,85),subtext1:v("#bec4d3",227,25,77),subtext0:v("#a8b0c3",228,20,70),overlay2:v("#929ab3",228,15,63),overlay1:v("#8289a0",230,12,57),overlay0:v("#72798f",231,10,50),surface2:v("#62697d",233,10,43),surface1:v("#525968",234,10,37),surface0:v("#424954",237,12,30),base:v("#2f323e",240,15,22),mantle:v("#282b36",240,12,19),crust:v("#21242e",240,18,16)},cinematic:{rosewater:v("#fce0db",15,85,92),flamingo:v("#f5c9c9",0,85,88),pink:v("#ff6b9d",316,100,70),mauve:v("#6c5ce7",267,85,65),red:v("#ff4757",343,100,65),maroon:v("#e84393",350,80,70),peach:v("#fd7f28",23,95,58),yellow:v("#f39c12",41,88,52),green:v("#a6e3a1",115,54,76),teal:v("#00cec9",174,100,40),sky:v("#74b9ff",189,100,72),sapphire:v("#0984e3",199,100,46),blue:v("#a29bfe",217,95,80),lavender:v("#c77dff",232,100,75),text:v("#e8f0ff",226,100,95),subtext1:v("#d0d8f0",227,65,88),subtext0:v("#b8c0d8",228,45,80),overlay2:v("#a0a8c0",228,30,70),overlay1:v("#8890a8",230,20,60),overlay0:v("#707890",231,15,50),surface2:v("#586078",233,15,42),surface1:v("#485060",234,15,35),surface0:v("#384048",237,18,28),base:v("#202030",240,25,16),mantle:v("#181828",240,22,13),crust:v("#101020",240,30,9)},maximum:{rosewater:v("#ffe5e0",15,100,95),flamingo:v("#ffcccc",0,100,90),pink:v("#ff3d7f",316,100,62),mauve:v("#5a4fcf",267,100,55),red:v("#ff2942",343,100,58),maroon:v("#e6337a",350,90,65),peach:v("#ff6500",23,100,50),yellow:v("#f1c40f",48,89,50),green:v("#00ff88",150,100,50),teal:v("#00ffff",180,100,50),sky:v("#4da6ff",189,100,65),sapphire:v("#0066ff",199,100,50),blue:v("#8a7fff",217,100,75),lavender:v("#b347ff",232,100,65),text:v("#ffffff",0,0,100),subtext1:v("#e8e8ff",240,100,95),subtext0:v("#d0d0ff",240,100,90),overlay2:v("#b8b8ff",240,100,85),overlay1:v("#a0a0ff",240,100,80),overlay0:v("#8888ff",240,100,75),surface2:v("#4040aa",240,60,45),surface1:v("#303088",240,65,35),surface0:v("#202066",240,70,25),base:v("#0f0f33",240,70,13),mantle:v("#0a0a22",240,75,10),crust:v("#050511",240,80,5)}},cc={bright:{baseColorTarget:.25,surfaceColorTarget:.35,textContrastMin:4.5},balanced:{baseColorTarget:.15,surfaceColorTarget:.25,textContrastMin:4.5},dark:{baseColorTarget:.08,surfaceColorTarget:.15,textContrastMin:3}}});function vn(c,e="balanced"){return K.getBrightnessAdjustedBaseColor(c,e)}function Sn(c,e="balanced"){return K.getBrightnessAdjustedSurfaceColor(c,e)}function Cn(c){return K.getDefaultAccentColor(c)}function Mn(c,e){return K.getAccentColor(c,e)}var xa,K,Ct=y(()=>{"use strict";U();Pa();Aa();Pa();Aa();xa=class c{constructor(){}static getInstance(){return c.instance||(c.instance=new c),c.instance}getCurrentPaletteSystem(){return E.paletteSystem||"catppuccin"}getCurrentPalette(){return this.getCurrentPaletteSystem()==="year3000"?Be:Re}getCurrentDefaultFlavor(){return this.getCurrentPaletteSystem()==="year3000"?"balanced":"mocha"}getBrightnessAdjustedBaseColor(e,t="balanced"){let i=this.getCurrentPaletteSystem(),a=e||this.getCurrentDefaultFlavor();return i==="year3000"?hn(a,t):ln(a,t)}getBrightnessAdjustedSurfaceColor(e,t="balanced"){let i=this.getCurrentPaletteSystem(),a=e||this.getCurrentDefaultFlavor();return i==="year3000"?gn(a,t):un(a,t)}getDefaultAccentColor(e){let t=this.getCurrentPaletteSystem(),i=e||this.getCurrentDefaultFlavor();return t==="year3000"?fn(i):dn(i)}getAccentColor(e,t){let i=this.getCurrentPaletteSystem(),a=t||this.getCurrentDefaultFlavor();return i==="year3000"?pn(a,e):mn(a,e)}getCinematicGradientPair(e,t="medium"){let i=this.getCurrentPaletteSystem(),a=e||this.getCurrentDefaultFlavor();if(i==="year3000")return yn(a,t);{let r=Re[a];switch(t){case"low":return[r.mauve,r.blue];case"medium":return[r.pink,r.peach];case"high":return[r.red,r.teal];default:return[r.mauve,r.pink]}}}getAnimatedFlowColors(e){let t=this.getCurrentPaletteSystem(),i=e||this.getCurrentDefaultFlavor();if(t==="year3000")return bn(i);{let a=Re[i];return{primary:a.mauve,secondary:a.pink,tertiary:a.blue,atmosphere:a.base}}}supportsCinematicFeatures(){return this.getCurrentPaletteSystem()==="year3000"}getPaletteSystemDisplayName(){return this.getCurrentPaletteSystem()==="year3000"?"Year 3000 Cinematic":"Catppuccin Classic"}},K=xa.getInstance()});var ci,li,En=y(()=>{"use strict";ci={jazz:{temperatureShift:15,saturationBoost:1.1,warmth:.8},electronic:{temperatureShift:-10,saturationBoost:1.2,warmth:.2},classical:{temperatureShift:5,saturationBoost:.9,warmth:.6},rock:{temperatureShift:0,saturationBoost:1.15,warmth:.5},ambient:{temperatureShift:-5,saturationBoost:.8,warmth:.3},hiphop:{temperatureShift:8,saturationBoost:1.25,warmth:.7},pop:{temperatureShift:0,saturationBoost:1,warmth:.5},metal:{temperatureShift:-15,saturationBoost:1.3,warmth:.1},indie:{temperatureShift:10,saturationBoost:.95,warmth:.6},default:{temperatureShift:0,saturationBoost:1,warmth:.5}},li=class{constructor(e,t){this.paletteCache={};this.cacheTTL=3e5;this.maxCacheSize=50;this.config=e,this.utils=t}async loadCustomPalette(e,t){let i=this.paletteCache[e];if(i&&Date.now()-i.timestamp<this.cacheTTL&&i.isValid)return this.config.enableDebug&&console.log(`[PaletteExtensionManager] Cache hit for palette: ${e}`),i.palette;try{let a=this.generateFallbackPalette(e);if(this.validatePalette(a))return this.cachePalette(e,a,!0),a}catch(a){this.config.enableDebug&&console.warn(`[PaletteExtensionManager] Failed to load palette ${e}:`,a)}return null}generateFallbackPalette(e){let t=this.utils.getRootStyle(),i=getComputedStyle(t),a=i.getPropertyValue("--spice-main").trim()||i.getPropertyValue("--spice-base").trim()||"#1e1e2e",r=i.getPropertyValue("--sn-gradient-accent").trim()||i.getPropertyValue("--spice-button").trim()||i.getPropertyValue("--sn-dynamic-accent").trim()||i.getPropertyValue("--spice-accent").trim()||"#8caaee",n=this.utils.hexToRgb(a.startsWith("#")?a:`#${a}`),s=this.utils.hexToRgb(r.startsWith("#")?r:`#${r}`);if(!n||!s){let m=i.getPropertyValue("--sn-dynamic-accent").trim(),d=i.getPropertyValue("--spice-base").trim();return{name:e,version:"1.0.0",accents:{mauve:m||"#ca9ee6",pink:"#f4b8e4",blue:m||"#8caaee",sapphire:"#85c1dc",sky:"#99d1db",teal:"#81c8be",green:"#a6d189",yellow:"#e5c890",peach:"#ef9f76",red:"#e78284",lavender:"#babbf1"},neutrals:{base:d||"#1e1e2e",surface0:"#313244",surface1:"#45475a",surface2:"#585b70",overlay0:"#6c7086",overlay1:"#7f849c",overlay2:"#9399b2",text:"#cdd6f4"},metadata:{author:"PaletteExtensionManager",description:`Generated fallback for ${e}`,temperature:"neutral"}}}let o=this.utils.rgbToHsl(n.r,n.g,n.b),l=this.utils.rgbToHsl(s.r,s.g,s.b);return{name:e,version:"1.0.0",accents:this.generateAccentVariations(l),neutrals:this.generateNeutralVariations(o),metadata:{author:"PaletteExtensionManager",description:`Generated palette for ${e}`,temperature:this.detectTemperature(o,l)}}}applyGenreAwareModifications(e,t){let i=ci[t]||ci.default;this.config.enableDebug&&console.log(`[PaletteExtensionManager] Applying ${t} hints to palette:`,i);let a={...e,accents:{},neutrals:{},metadata:{...e.metadata,genre:[...e.metadata?.genre||[],t]}};for(let[r,n]of Object.entries(e.accents))a.accents[r]=this.applyGenreColorModification(n,i.temperatureShift,i.saturationBoost);for(let[r,n]of Object.entries(e.neutrals))a.neutrals[r]=this.applyGenreColorModification(n,i.temperatureShift*.3,i.saturationBoost*.7);return a}validatePalette(e){if(!e||typeof e!="object"||!e.name||typeof e.name!="string"||!e.version||typeof e.version!="string"||!e.accents||typeof e.accents!="object"||!e.neutrals||typeof e.neutrals!="object")return!1;let t=[...Object.values(e.accents),...Object.values(e.neutrals)];for(let i of t)if(typeof i!="string"||!this.isValidHexColor(i))return!1;return!0}cachePalette(e,t,i){if(Object.keys(this.paletteCache).length>=this.maxCacheSize){let r=Object.entries(this.paletteCache).sort(([,n],[,s])=>n.timestamp-s.timestamp)[0]?.[0];r&&this.paletteCache[r]&&delete this.paletteCache[r]}this.paletteCache[e]={palette:t,timestamp:Date.now(),isValid:i}}generateAccentVariations(e){let t={},i=[0,30,60,120,180,210,240,300,330,45,90],a=["primary","secondary","tertiary","complement","opposite","warm1","cool1","accent1","accent2","highlight","emphasis"];return i.forEach((r,n)=>{let s=a[n]||`variant${n}`,o=(e.h+r)%360,l=this.utils.hslToRgb(o,e.s,e.l);l&&(t[s]=this.utils.rgbToHex(l.r,l.g,l.b))}),t}generateNeutralVariations(e){let t={};return[{name:"base",l:e.l},{name:"surface0",l:Math.min(95,e.l+10)},{name:"surface1",l:Math.min(90,e.l+20)},{name:"surface2",l:Math.min(85,e.l+30)},{name:"overlay0",l:Math.min(80,e.l+40)},{name:"overlay1",l:Math.min(75,e.l+50)},{name:"text",l:Math.min(95,e.l+60)}].forEach(a=>{let r=this.utils.hslToRgb(e.h,Math.max(0,e.s-20),a.l);r&&(t[a.name]=this.utils.rgbToHex(r.r,r.g,r.b))}),t}detectTemperature(e,t){let i=(e.h+t.h)/2;return i>=0&&i<=60||i>=300&&i<=360?"warm":i>=120&&i<=240?"cool":"neutral"}applyGenreColorModification(e,t,i){let a=this.utils.hexToRgb(e);if(!a)return e;let r=this.utils.rgbToHsl(a.r,a.g,a.b),n=(r.h+t+360)%360,s=Math.max(0,Math.min(100,r.s*i)),o=this.utils.hslToRgb(n,s,r.l);return o?this.utils.rgbToHex(o.r,o.g,o.b):e}isValidHexColor(e){return/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(e)}getGenreHints(e){return ci[e]||ci.default}clearCache(){this.paletteCache={},this.config.enableDebug&&console.log("[PaletteExtensionManager] Palette cache cleared")}}});var Mt,se,ui,wn=y(()=>{"use strict";L();Mt=new Set(["--sn-beat-pulse-intensity","--sn-animation-scale","--sn-accent-hex","--sn-accent-rgb","--sn.music.beat.pulse.intensity","--sn.music.animation.scale","--sn.music.rhythm.phase","--sn.music.spectrum.phase","--sn.color.accent.hex","--sn.color.accent.rgb","--sn.bg.webgl.ready","--sn.bg.active-backend"]),se=class se{constructor(e,t){this.initialized=!1;this.cssVariableQueue=new Map;this.batchUpdateTimer=null;this.rafHandle=null;this.microtaskScheduled=!1;this.pendingTransactions=new Map;this.transactionCounter=0;this.updateQueue=new Map;this.flushTimer=null;this.currentDeviceCapabilities=null;this.currentPerformanceMode=null;this.lastCSSUpdate=0;this.cssUpdateThrottle=100;this.appliedClasses=new Set;this.visualEffectsState=null;this.visualEffectsUpdateTimer=null;this.lastVisualEffectsUpdate=0;this.performanceMetrics={totalBatches:0,totalUpdates:0,totalBatchTime:0,maxBatchTime:0,averageBatchSize:0,overBudgetBatches:0,conflictResolutions:0,transactionCount:0,visualEffectsUpdates:0};this.PRIORITY_WEIGHTS={low:1,normal:2,high:3,critical:4};this.config=e,this.performanceCoordinator=t,this.eventBus=p,this.cssConfig={batchIntervalMs:0,maxBatchSize:50,enableDebug:e.enableDebug,useCssTextFastPath:!1,autoHijack:!0,enableAdaptiveOptimization:!0,enableThermalThrottling:!0,enableBatteryOptimization:!0,enableDeviceTierOptimization:!0,debugPerformanceClasses:e.enableDebug,enableVisualEffectsIntegration:!0,visualEffectsUpdateInterval:16,enableMusicVisualEffects:!0,enableAestheticVisualEffects:!0},this.currentDeviceCapabilities=this.performanceCoordinator.getDeviceCapabilities(),this.currentPerformanceMode=this.performanceCoordinator.getCurrentPerformanceMode(),this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Created with visual-effects-driven CSS management")}async initialize(){this.initialized||(this.subscribeToEvents(),this.applyInitialOptimizations(),this.cssConfig.enableVisualEffectsIntegration&&this.startVisualEffectsIntegration(),this.cssConfig.autoHijack&&this.enableGlobalHijack(),this.initialized=!0,this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Initialized with device tier:",this.currentDeviceCapabilities?.performanceTier))}updateAnimation(e){}async healthCheck(){let e=this.cssVariableQueue.size+this.updateQueue.size,t=this.pendingTransactions.size,i=e<=1e3&&t<=100;return{system:"UnifiedCSSVariableManager",healthy:i,ok:i,details:i?"CSS visual-effects controller operating normally":"High queue size or pending transactions",metrics:{queueSize:e,pendingTransactions:t,performanceMetrics:this.performanceMetrics,visualEffectsActive:this.visualEffectsState!==null,deviceTier:this.currentDeviceCapabilities?.performanceTier,performanceMode:this.currentPerformanceMode?.name}}}destroy(){this.visualEffectsUpdateTimer&&(clearTimeout(this.visualEffectsUpdateTimer),this.visualEffectsUpdateTimer=null),this.flushTimer&&(clearTimeout(this.flushTimer),this.flushTimer=null),this.rafHandle!==null&&(cancelAnimationFrame(this.rafHandle),this.rafHandle=null),this.flushCSSVariableBatch();for(let e of this.appliedClasses)document.body.classList.remove(e);this.appliedClasses.clear(),this.cssVariableQueue.clear(),this.updateQueue.clear(),this.pendingTransactions.clear(),this.initialized=!1,this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Destroyed")}forceRepaint(e){this.flushCSSVariableBatch(),this.config.enableDebug&&e&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Force repaint: ${e}`)}queueCSSVariableUpdate(e,t,i=null,a="normal",r="unknown"){if(Mt.has(e)){let d=(i||document.documentElement).style;se.nativeSetProperty?se.nativeSetProperty.call(d,e,t):d.setProperty(e,t);return}let n=i||document.documentElement,o=`${i?`element_${i.id||i.className||"unnamed"}`:"root"}:${e}`,l={element:n,property:e,value:t,timestamp:performance.now(),priority:a,source:r},m=this.cssVariableQueue.get(o);m?this.shouldReplaceUpdate(m,l)&&(this.cssVariableQueue.set(o,l),this.performanceMetrics.conflictResolutions++):this.cssVariableQueue.set(o,l),this.performanceMetrics.totalUpdates++,this.scheduleFlush(a),(a==="critical"||this.cssVariableQueue.size>=this.cssConfig.maxBatchSize)&&this.flushCSSVariableBatch()}updateVariables(e,t="normal",i="unknown"){let a=`tx_${++this.transactionCounter}`,r=new Map(Object.entries(e)),n={id:a,variables:r,timestamp:performance.now(),priority:t,completed:!1};this.pendingTransactions.set(a,n);for(let[s,o]of r)this.queueCSSVariableUpdate(s,o,null,t,`${i}:${a}`);this.performanceMetrics.transactionCount++,this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Transaction ${a} queued with ${r.size} variables`)}updateVisualEffectsVariables(e){if(!this.cssConfig.enableVisualEffectsIntegration)return;this.visualEffectsState=e,this.performanceMetrics.visualEffectsUpdates++;let t={};e.musicState&&this.cssConfig.enableMusicVisualEffects&&(t["--sn.music.beat.pulse.intensity"]=e.musicState.intensity.toString(),t["--sn.music.tempo.bpm"]=e.musicState.bpm.toString(),t["--sn.music.rhythm.phase"]=`${e.musicState.rhythmPhase}deg`,t["--sn.music.animation.scale"]=e.musicState.animationScale.toString(),t["--sn.music.energy.level"]=e.musicState.energy.toString(),t["--sn.music.valence"]=e.musicState.valence.toString()),e.aestheticState&&this.cssConfig.enableAestheticVisualEffects&&(t["--sn.aesthetic.harmony.level"]=e.aestheticState.harmonyLevel.toString(),t["--sn.aesthetic.evolution.factor"]=e.aestheticState.evolutionFactor.toString(),t["--sn.color.temperature"]=e.aestheticState.colorTemperature.toString()),e.performanceState&&(t["--sn.performance.mode"]=e.performanceState.mode,t["--sn.device.tier"]=e.performanceState.deviceTier,t["--sn.performance.optimization.level"]=e.performanceState.optimizationLevel.toString()),this.updateVariables(t,"high","visual-effects-system"),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Consciousness state updated with ${Object.keys(t).length} variables`)}applyPerformanceOptimizations(e){if(!this.cssConfig.enableAdaptiveOptimization)return;this.currentPerformanceMode=e;let t={"--sn.performance.mode":e.name,"--sn.performance.quality.level":e.qualityLevel.toString(),"--sn.performance.fps.target":e.frameRate.toString(),"--sn.performance.frame.budget":(1e3/e.frameRate).toString(),"--sn.performance.optimization.level":e.optimizationLevel.toString(),"--sn.performance.blur.quality":e.blurQuality.toString(),"--sn.performance.shadow.quality":e.shadowQuality.toString(),"--sn.performance.animation.quality":e.animationQuality.toString(),"--sn.performance.effect.quality":e.effectQuality.toString()};this.updateVariables(t,"high","performance-coordinator"),this.applyPerformanceModeOptimizations(),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Performance optimizations applied for mode: ${e.name}`)}getVariable(e){return getComputedStyle(document.documentElement).getPropertyValue(e).trim()||null}flushUpdates(){this.flushCSSVariableBatch()}flushCSSVariableBatch(){if(this.cssVariableQueue.size===0)return;let e=performance.now(),t=8,i=Array.from(this.cssVariableQueue.values());this.cssVariableQueue.clear(),this.rafHandle!==null&&(cancelAnimationFrame(this.rafHandle),this.rafHandle=null),this.microtaskScheduled=!1;try{let a=new Map;for(let n of i)a.has(n.element)||a.set(n.element,[]),a.get(n.element).push(n);for(let[n,s]of a.entries()){if(performance.now()-e>t){for(let o of s){let l=`${o.element.id||"root"}:${o.property}`;this.cssVariableQueue.set(l,o)}this.scheduleFlush("high");break}if(s.length>=3)this.applyCSSTextBatch(n,s);else for(let o of s)se.nativeSetProperty?se.nativeSetProperty.call(n.style,o.property,o.value):n.style.setProperty(o.property,o.value)}let r=performance.now()-e;this.updatePerformanceMetrics(r,i.length),r>t&&this.config.enableDebug?console.warn(`\u{1F30C} [UnifiedCSSVariableManager] CSS batch exceeded frame budget: ${r.toFixed(2)}ms (${i.length} updates)`):this.config.enableDebug&&Math.random()<.05&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Efficient CSS batch: ${i.length} updates in ${r.toFixed(2)}ms`)}catch(a){console.error("[UnifiedCSSVariableManager] Error in optimized CSS batch processing:",a),this.applyUpdatesWithFallback(i)}}applyCSSTextBatch(e,t){try{let i=e.style.cssText,a=new Map;if(i){let n=i.split(";");for(let s of n){let o=s.indexOf(":");if(o>0){let l=s.slice(0,o).trim(),m=s.slice(o+1).trim();l&&m&&a.set(l,m)}}}for(let n of t)a.set(n.property,n.value);let r=[];for(let[n,s]of a)r.push(`${n}:${s}`);e.style.cssText=r.join(";")}catch{for(let a of t)try{e.style.setProperty(a.property,a.value)}catch(r){console.warn(`Failed to apply ${a.property}:`,r)}}}applyUpdatesWithFallback(e){for(let t of e)try{se.nativeSetProperty?se.nativeSetProperty.call(t.element.style,t.property,t.value):t.element.style.setProperty(t.property,t.value)}catch(i){console.warn(`[UnifiedCSSVariableManager] Failed to apply CSS property ${t.property}:`,i)}}setMusicMetrics(e){let t={};e.beatIntensity!==void 0&&(t["--sn.music.beat.pulse.intensity"]=e.beatIntensity.toString()),e.rhythmPhase!==void 0&&(t["--sn.music.rhythm.phase"]=`${e.rhythmPhase}deg`),e.animationScale!==void 0&&(t["--sn.music.animation.scale"]=e.animationScale.toString()),e.spectrumPhase!==void 0&&(t["--sn.music.spectrum.phase"]=`${e.spectrumPhase}deg`),e.energy!==void 0&&(t["--sn.music.energy.level"]=e.energy.toString()),e.valence!==void 0&&(t["--sn.music.valence"]=e.valence.toString()),e.bpm!==void 0&&(t["--sn.music.tempo.bpm"]=e.bpm.toString()),this.updateVariables(t,"critical","music-system")}setColorTokens(e){let t={};e.accentHex&&(t["--sn.color.accent.hex"]=e.accentHex),e.accentRgb&&(t["--sn.color.accent.rgb"]=e.accentRgb),e.primaryRgb&&(t["--sn.bg.gradient.primary.rgb"]=e.primaryRgb),e.secondaryRgb&&(t["--sn.bg.gradient.secondary.rgb"]=e.secondaryRgb),e.gradientOpacity!==void 0&&(t["--sn.bg.gradient.opacity"]=e.gradientOpacity.toString()),e.gradientBlur&&(t["--sn.bg.gradient.blur"]=e.gradientBlur),this.updateVariables(t,"high","color-system")}setPerformanceTokens(e){let t={};e.webglReady!==void 0&&(t["--sn.bg.webgl.ready"]=e.webglReady?"1":"0"),e.activeBackend&&(t["--sn.bg.active-backend"]=e.activeBackend),e.qualityLevel&&(t["--sn.perf.quality.level"]=e.qualityLevel),e.reducedMotion!==void 0&&(t["--sn.anim.motion.reduced"]=e.reducedMotion?"1":"0"),e.gpuAcceleration!==void 0&&(t["--sn.perf.gpu.acceleration.enabled"]=e.gpuAcceleration?"1":"0"),this.updateVariables(t,"high","performance-system")}setProperty(e,t,i=null){if(e.startsWith("--spice-")&&this.config.enableSpiceVariableDebug){let a=new Error().stack?.split(`
`)[2]?.trim().replace(/^\s*at\s+/,"")||"unknown";console.log(`\u{1F527} [CSS Debug] Setting ${e} = ${t} (from: ${a})`)}this.queueCSSVariableUpdate(e,t,i)}applyDeviceOptimizations(){if(!this.cssConfig.enableDeviceTierOptimization||!this.currentDeviceCapabilities)return;this.removeClassesByPrefix("device-tier-"),this.removeClassesByPrefix("device-mobile-"),this.removeClassesByPrefix("device-gpu-");let e=`device-tier-${this.currentDeviceCapabilities.performanceTier}`;this.addCSSClass(e),this.currentDeviceCapabilities.isMobile&&this.addCSSClass("device-mobile-optimized"),this.currentDeviceCapabilities.gpuAcceleration?this.addCSSClass("device-gpu-accelerated"):this.addCSSClass("device-gpu-fallback");let t=this.getMemoryTier(this.currentDeviceCapabilities.memoryGB);this.addCSSClass(`device-memory-${t}`)}applyPerformanceModeOptimizations(){if(!this.currentPerformanceMode)return;this.removeClassesByPrefix("performance-mode-");let e=`performance-mode-${this.currentPerformanceMode.name}`;this.addCSSClass(e);let t=`optimization-level-${this.currentPerformanceMode.optimizationLevel}`;this.addCSSClass(t)}getPerformanceReport(){let e=this.performanceMetrics.totalBatches>0?this.performanceMetrics.totalBatchTime/this.performanceMetrics.totalBatches:0;return{enabled:!0,pendingUpdates:this.cssVariableQueue.size+this.updateQueue.size,totalUpdates:this.performanceMetrics.totalUpdates,totalBatches:this.performanceMetrics.totalBatches,averageBatchSize:Math.round(this.performanceMetrics.averageBatchSize*10)/10,averageBatchTime:Math.round(e*100)/100,maxBatchTime:Math.round(this.performanceMetrics.maxBatchTime*100)/100,overBudgetBatches:this.performanceMetrics.overBudgetBatches,conflictResolutions:this.performanceMetrics.conflictResolutions,transactionCount:this.performanceMetrics.transactionCount,visualEffectsUpdates:this.performanceMetrics.visualEffectsUpdates,visualEffectsActive:this.visualEffectsState!==null,deviceTier:this.currentDeviceCapabilities?.performanceTier,performanceMode:this.currentPerformanceMode?.name}}subscribeToEvents(){this.eventBus.subscribe("performance:tier-changed",e=>{this.currentPerformanceMode=this.performanceCoordinator.getCurrentPerformanceMode(),this.applyPerformanceModeOptimizations(),this.updateCSSPerformanceVariables()},"UnifiedCSSVariableManager"),this.eventBus.subscribe("performance:frame",e=>{e.temperature&&e.temperature>80&&this.applyThermalOptimizations(e.temperature)},"UnifiedCSSVariableManager")}applyInitialOptimizations(){try{this.applyDeviceOptimizations(),this.applyPerformanceModeOptimizations(),this.updateCSSPerformanceVariables(),this.cssConfig.debugPerformanceClasses&&this.addCSSClass("debug-performance")}catch(e){this.config.enableDebug&&console.warn("[UnifiedCSSVariableManager] Error applying initial optimizations:",e)}}applyCurrentOptimizations(){this.applyDeviceOptimizations(),this.applyPerformanceModeOptimizations();let e=this.performanceCoordinator.getBatteryState(),t=this.performanceCoordinator.getThermalState();e&&this.applyBatteryOptimizations(e.level,e.charging);let i=t.temperature||"normal";this.applyThermalOptimizations(i)}updateCSSPerformanceVariables(){let e=Date.now();if(!(e-this.lastCSSUpdate<this.cssUpdateThrottle)&&(this.lastCSSUpdate=e,!(!this.currentPerformanceMode||!this.currentDeviceCapabilities)))try{let t={"--sn.performance.mode":this.currentPerformanceMode.name||"balanced","--sn.performance.quality.level":(this.currentPerformanceMode.qualityLevel??.8).toString(),"--sn.performance.fps.target":(this.currentPerformanceMode.frameRate??60).toString(),"--sn.performance.frame.budget":(1e3/(this.currentPerformanceMode.frameRate??60)).toString(),"--sn.performance.optimization.level":(this.currentPerformanceMode.optimizationLevel??1).toString(),"--sn.device.tier":this.currentDeviceCapabilities.performanceTier??"mid","--sn.device.memory":(this.currentDeviceCapabilities.memoryGB??8).toString(),"--sn.device.gpu":this.currentDeviceCapabilities.gpuAcceleration??!0?"1":"0","--sn.device.mobile":this.currentDeviceCapabilities.isMobile??!1?"1":"0","--sn.performance.blur.quality":(this.currentPerformanceMode.blurQuality??.8).toString(),"--sn.performance.shadow.quality":(this.currentPerformanceMode.shadowQuality??.8).toString(),"--sn.performance.animation.quality":(this.currentPerformanceMode.animationQuality??.8).toString(),"--sn.performance.effect.quality":(this.currentPerformanceMode.effectQuality??.8).toString()};this.updateVariables(t,"high","performance-coordinator")}catch(t){this.config.enableDebug&&console.warn("[UnifiedCSSVariableManager] Error updating CSS performance variables:",t)}}startVisualEffectsIntegration(){if(this.visualEffectsUpdateTimer)return;let e=()=>{let t=performance.now();t-this.lastVisualEffectsUpdate>=this.cssConfig.visualEffectsUpdateInterval&&(this.lastVisualEffectsUpdate=t,this.visualEffectsState&&this.updateVisualEffectsVariables(this.visualEffectsState)),this.visualEffectsUpdateTimer=setTimeout(e,this.cssConfig.visualEffectsUpdateInterval)};e()}shouldReplaceUpdate(e,t){let i=this.PRIORITY_WEIGHTS[e.priority],a=this.PRIORITY_WEIGHTS[t.priority];return a>i?!0:a===i?t.timestamp>e.timestamp:!1}scheduleFlush(e){if(this.rafHandle!==null||this.microtaskScheduled)return;let t=()=>{this.rafHandle=null,this.microtaskScheduled=!1,this.flushCSSVariableBatch()};typeof document<"u"&&document.visibilityState==="hidden"?(this.microtaskScheduled=!0,queueMicrotask(t)):typeof requestAnimationFrame=="function"?this.rafHandle=requestAnimationFrame(t):setTimeout(t,0)}updatePerformanceMetrics(e,t){this.performanceMetrics.totalBatches++,this.performanceMetrics.totalBatchTime+=e,this.performanceMetrics.maxBatchTime=Math.max(this.performanceMetrics.maxBatchTime,e),this.performanceMetrics.averageBatchSize=(this.performanceMetrics.averageBatchSize*(this.performanceMetrics.totalBatches-1)+t)/this.performanceMetrics.totalBatches,e>8&&(this.performanceMetrics.overBudgetBatches++,this.config.enableDebug&&console.warn(`[UnifiedCSSVariableManager] CSS batch took ${e.toFixed(2)}ms for ${t} updates`))}enableGlobalHijack(){if(se.hijackEnabled)return;let e=CSSStyleDeclaration.prototype.setProperty;se.nativeSetProperty=e;let t=this;CSSStyleDeclaration.prototype.setProperty=function(i,a,r){i&&(i.startsWith("--sn-")||i.startsWith("--sn."))&&t?t.queueCSSVariableUpdate(i,String(a??"")):e.call(this,i,a,r)},se.hijackEnabled=!0,this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Global setProperty hijack enabled (--sn- and --sn. namespaces)")}addCSSClass(e){this.appliedClasses.has(e)||(document.body.classList.add(e),this.appliedClasses.add(e))}removeCSSClass(e){this.appliedClasses.has(e)&&(document.body.classList.remove(e),this.appliedClasses.delete(e))}removeClassesByPrefix(e){let t=Array.from(this.appliedClasses).filter(i=>i.startsWith(e));for(let i of t)this.removeCSSClass(i)}getMemoryTier(e){return e>=16?"high":e>=8?"medium":e>=4?"low":"minimal"}applyThermalOptimizations(e){if(!this.cssConfig.enableThermalThrottling)return;this.removeClassesByPrefix("thermal-");let t=`thermal-${e}`;this.addCSSClass(t)}applyBatteryOptimizations(e,t){this.cssConfig.enableBatteryOptimization&&(this.removeClassesByPrefix("battery-"),e<.2?this.addCSSClass("battery-low"):e<.5?this.addCSSClass("battery-medium"):this.addCSSClass("battery-high"),t&&this.addCSSClass("battery-charging"))}updateMusicVariables(e){let t={};for(let[i,a]of Object.entries(e))if(a!==void 0){let r=`--sn-music-${i.replace(/\./g,"-")}`;t[r]=String(a)}this.updateVariables(t,"critical","music-system")}updateColorVariables(e){let t={};for(let[i,a]of Object.entries(e))if(a!==void 0){let r=`--sn-color-${i.replace(/\./g,"-")}`;t[r]=String(a)}this.updateVariables(t,"high","color-system")}updateAnimationVariables(e){let t={};for(let[i,a]of Object.entries(e))if(a!==void 0){let r=`--sn-anim-${i.replace(/\./g,"-")}`;t[r]=typeof a=="boolean"?a?"1":"0":String(a)}this.updateVariables(t,"normal","animation-system")}updatePerformanceVariables(e){let t={};for(let[i,a]of Object.entries(e))if(a!==void 0){let r=`--sn-performance-${i.replace(/\./g,"-")}`;t[r]=typeof a=="boolean"?a?"1":"0":String(a)}this.updateVariables(t,"high","performance-system")}updateUtilityVariables(e){let t={};for(let[i,a]of Object.entries(e))if(a!==void 0){let r=`--sn-${i.replace(/\./g,"-")}`;t[r]=typeof a=="boolean"?a?"1":"0":String(a)}this.updateVariables(t,"low","utility-system")}queueUpdate(e,t,i="normal",a="unknown"){this.queueCSSVariableUpdate(e,t,null,i,a)}queueTransaction(e,t="normal",i="unknown"){let a=`tx_${++this.transactionCounter}`,r=new Map(Object.entries(e)),n={id:a,variables:r,timestamp:performance.now(),priority:t,completed:!1};this.pendingTransactions.set(a,n);for(let[s,o]of r)this.queueUpdate(s,o,t,`${i}:${a}`);return this.performanceMetrics.transactionCount++,this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Transaction ${a} queued with ${r.size} variables`),a}forceFlush(){this.flushCSSVariableBatch()}registerVariableGroup(e,t="normal",i=50,a=16){this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Variable group registration: ${e} (handled internally)`)}updateVariableGroup(e,t,i="unknown"){this.updateVariables(t,"normal",`group:${e}:${i}`)}updateConfig(e){this.cssConfig={...this.cssConfig,...e},this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Configuration updated:",e)}flushNow(){this.flushCSSVariableBatch()}setBatchingEnabled(e){this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Batching ${e?"enabled":"disabled"}`)}addCriticalVariable(e){Mt.add(e),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Added critical variable: ${e}`)}removeCriticalVariable(e){Mt.delete(e),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Removed critical variable: ${e}`)}isCriticalVariable(e){return Mt.has(e)}getCriticalVariables(){return Array.from(Mt)}updateVisualEffectsIntensity(e,t,i){let a=Math.max(0,Math.min(1,e));this.queueCSSVariableUpdate("--visual-effects-intensity",a.toString(),null,"high",`visual-effects-${t}`),this.eventBus&&this.eventBus.emitSync("visual-effects:intensity-changed",{intensity:a,userEngagement:.5,timestamp:Date.now(),sourceStrategy:t,musicEnergy:i??0}),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Consciousness intensity updated by ${t}: ${a}`)}updateCrossfadeOpacity(e,t,i){let a=Math.max(0,Math.min(1,e));i||(a=0),this.queueCSSVariableUpdate("--sn-gradient-crossfade-opacity",a.toString(),null,"high",`crossfade-${t}`),this.eventBus&&this.eventBus.emitSync("gradient:crossfade-changed",{opacity:a,sourceStrategy:t,webglEnabled:i,timestamp:Date.now()}),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Crossfade opacity updated by ${t}: ${a} (WebGL: ${i})`)}subscribeToVisualEffectsChanges(e){if(!this.eventBus)return console.warn("[UnifiedCSSVariableManager] No UnifiedEventBus available for visual-effects subscriptions"),()=>{};let t=this.eventBus.subscribe("visual-effects:intensity-changed",e,"UnifiedCSSVariableManager");return()=>this.eventBus?.unsubscribe(t)}subscribeToCrossfadeChanges(e){if(!this.eventBus)return console.warn("[UnifiedCSSVariableManager] No UnifiedEventBus available for crossfade subscriptions"),()=>{};let t=this.eventBus.subscribe("gradient:crossfade-changed",e,"UnifiedCSSVariableManager");return()=>this.eventBus?.unsubscribe(t)}};se.hijackEnabled=!1;ui=se});function Da(c){Ia=c}function P(){if(!Ia)throw console.warn("[OptimizedCSSVariableManager] Global instance not initialized yet. This may indicate an initialization order issue."),new Error("Global OptimizedCSSVariableManager not initialized. Call setGlobalOptimizedCSSController() first.");return Ia}var Ee,Ia,$=y(()=>{"use strict";wn();Ee=class extends ui{constructor(t,i,a={}){super(t,i);this.lastFPSCheck=0;this.currentPerformanceLevel="good";this.adaptiveThrottleLevel=1;this.priorityQueues=new Map;this.optimizedConfig={batchIntervalMs:16,maxBatchSize:50,enableDebug:t.enableDebug,enableAdaptiveThrottling:!0,priorityMappings:{critical:["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift"],high:["--sn-gradient-primary","--sn-gradient-secondary","--sn-gradient-accent"],normal:["--sn-gradient-","--sn-rs-"],low:["--sn-debug-","--sn-dev-"]},thresholds:{excellentFPS:55,goodFPS:45,poorFPS:30},...a},a.performanceAnalyzer&&(this.performanceAnalyzer=a.performanceAnalyzer),a.budgetManager&&(this.budgetManager=a.budgetManager),this.initializePriorityQueues(),this.optimizedConfig.enableAdaptiveThrottling&&this.startAdaptiveMonitoring()}initializePriorityQueues(){this.priorityQueues.set("critical",new Map),this.priorityQueues.set("high",new Map),this.priorityQueues.set("normal",new Map),this.priorityQueues.set("low",new Map)}startAdaptiveMonitoring(){setInterval(()=>{this.updatePerformanceLevel(),this.adjustBatchingStrategy()},1e3)}updatePerformanceLevel(){if(!this.performanceAnalyzer)return;let t=this.performanceAnalyzer.getMedianFPS(),{excellentFPS:i,goodFPS:a,poorFPS:r}=this.optimizedConfig.thresholds,n=this.currentPerformanceLevel;t>=i?this.currentPerformanceLevel="excellent":t>=a?this.currentPerformanceLevel="good":t<r&&(this.currentPerformanceLevel="poor"),n!==this.currentPerformanceLevel&&this.optimizedConfig.enableDebug&&console.log(`\u{1F3A8} [OptimizedCSSVariableManager] Performance level changed: ${n} \u2192 ${this.currentPerformanceLevel} (${t} FPS)`)}adjustBatchingStrategy(){let t,i;switch(this.currentPerformanceLevel){case"excellent":t=Math.max(8,this.optimizedConfig.batchIntervalMs/2),i=Math.min(100,this.optimizedConfig.maxBatchSize*2),this.adaptiveThrottleLevel=.5;break;case"good":t=this.optimizedConfig.batchIntervalMs,i=this.optimizedConfig.maxBatchSize,this.adaptiveThrottleLevel=1;break;case"poor":t=this.optimizedConfig.batchIntervalMs*2,i=Math.max(10,this.optimizedConfig.maxBatchSize/2),this.adaptiveThrottleLevel=2;break}this.updateConfig({batchIntervalMs:t,maxBatchSize:i})}queueCSSVariableUpdate(t,i,a=null,r="normal",n="unknown"){let s=a||document.documentElement,o=r||this.determineVariablePriority(t);if(o==="critical"){this.applyCriticalUpdate(t,i,s);return}let l=this.priorityQueues.get(o);if(l){let m=`${t}:${s.tagName||"ROOT"}`;l.set(m,{property:t,value:i,timestamp:performance.now()})}this.scheduleOptimizedFlush(o)}determineVariablePriority(t){let{priorityMappings:i}=this.optimizedConfig;for(let[a,r]of Object.entries(i))if(r.includes(t))return a;for(let[a,r]of Object.entries(i))for(let n of r)if(t.startsWith(n))return a;return"normal"}applyCriticalUpdate(t,i,a){try{a.style.setProperty(t,i)}catch(r){console.error(`\u{1F3A8} [OptimizedCSSVariableManager] Critical update failed for ${t}:`,r)}}scheduleOptimizedFlush(t){let i=this.getFlushDelay(t);setTimeout(()=>{this.flushPriorityQueue(t)},i)}getFlushDelay(t){let i=this.optimizedConfig.batchIntervalMs,a=this.adaptiveThrottleLevel;switch(t){case"critical":return 0;case"high":return Math.max(4,i*.5*a);case"normal":return i*a;case"low":return i*2*a;default:return i*a}}flushPriorityQueue(t){let i=this.priorityQueues.get(t);if(!i||i.size===0)return;let a=Array.from(i.values());i.clear();for(let r of a)super.queueCSSVariableUpdate(r.property,r.value,null,"normal",r.timestamp.toString())}getOptimizationMetrics(){let t={};for(let[a,r]of this.priorityQueues)t[a]=r.size;let i={performanceLevel:this.currentPerformanceLevel,adaptiveThrottleLevel:this.adaptiveThrottleLevel,queueSizes:t};return i.budgetViolations=[],i}flushAllQueues(){for(let t of["critical","high","normal","low"])this.flushPriorityQueue(t);this.flushUpdates()}updatePriorityMappings(t){this.optimizedConfig.priorityMappings={...this.optimizedConfig.priorityMappings,...t}}async batchSetVariables(t,i,a="normal",r="unknown"){this.updateVariables(i,a,`${t}:${r}`)}async setVariable(t,i,a,r="normal",n="unknown"){this.updateVariables({[i]:a},r,`${t}:${n}`)}applyDirect(t){let i=document.documentElement;for(let[a,r]of Object.entries(t))i.style.setProperty(a,r)}static getGlobalInstance(){return P()}destroy(){for(let t of this.priorityQueues.values())t.clear();this.priorityQueues.clear(),super.destroy()}},Ia=null});var Ve,ot,ka=y(()=>{"use strict";$();L();X();Ve=class Ve{constructor(e={}){this.colorCache=new Map;this.lastCacheUpdate=0;this.initialized=!1;this.eventSubscriptionIds=[];this.lastColorUpdate=0;this.colorUpdateCount=0;this.config={enableDebug:!1,fallbackToSpiceColors:!0,cacheDuration:5e3,...e}}async initialize(e){if(this.initialized){console.warn("[SemanticColorManager] Already initialized, skipping");return}try{this.cssController=e||P(),this.setupEventSubscriptions(),this.initialized=!0,this.lastColorUpdate=Date.now(),this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Initialized as IManagedSystem with",{mappings:Ve.SEMANTIC_MAPPINGS.length,batcherAvailable:!!this.cssController,spicetifyAvailable:this.isSpicetifyAvailable(),eventSubscriptions:this.eventSubscriptionIds.length}),p.emitSync("system:initialized",{systemName:"SemanticColorManager",timestamp:Date.now(),metadata:{mappings:Ve.SEMANTIC_MAPPINGS.length,spicetifyAvailable:this.isSpicetifyAvailable()?1:0}})}catch(t){throw console.error("[SemanticColorManager] Initialization failed:",t),p.emitSync("system:error",{systemName:"SemanticColorManager",error:t instanceof Error?t.message:"Initialization failed",severity:"critical",timestamp:Date.now()}),t}}async updateSemanticColors(){if(!this.initialized){console.warn("[SemanticColorManager] Not initialized, cannot update colors");return}let e=Date.now();if(!(e-this.lastCacheUpdate<(this.config.cacheDuration||5e3))){console.log("\u{1F3A8} [SemanticColorManager] Starting semantic color update...");try{let t={},i={},a={};for(let r of Ve.SEMANTIC_MAPPINGS){let n=await this.getSemanticColor(r.semanticColor);t[r.cssVariable]={semanticColor:r.semanticColor,retrievedColor:n,fallbackColor:r.fallbackColor,description:r.description},i[r.cssVariable]=n;let s=ne(n);if(s){let o=r.cssVariable.replace("--spice-","--spice-rgb-");a[o]=`${s.r},${s.g},${s.b}`,t[o]=`${s.r},${s.g},${s.b}`}}this.cssController.batchSetVariables("SemanticColorManager",i,"high","semantic-color-update"),this.cssController.batchSetVariables("SemanticColorManager",a,"high","semantic-rgb-update"),console.log("\u{1F3A8} [SemanticColorManager] Color update complete:",t),this.lastCacheUpdate=e,this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Updated all semantic colors")}catch(t){console.error("[SemanticColorManager] Failed to update semantic colors:",t)}}}async getSemanticColor(e){let t=this.colorCache.get(e);if(t&&Date.now()-this.lastCacheUpdate<(this.config.cacheDuration||5e3))return t;let i;try{this.isSpicetifyAvailable()&&Spicetify.Platform?.getSemanticColors?(i=(await Spicetify.Platform.getSemanticColors())[e],console.log(`\u{1F3A8} [SemanticColorManager] Spicetify returned for ${e}:`,{rawValue:i,type:typeof i,isWhite:i==="#ffffff"||i==="#fff"||i==="white",isInvalid:!i||i==="undefined"||i==="null"})):(console.warn(`\u{1F3A8} [SemanticColorManager] Spicetify not available, using fallback for ${e}`),i=this.getFallbackColor(e))}catch(a){this.config.enableDebug&&console.warn(`[SemanticColorManager] Failed to get semantic color ${e}:`,a),i=this.getFallbackColor(e)}return i=this.validateColor(i,e),this.colorCache.set(e,i),i}validateColor(e,t){let i=e?.toLowerCase().trim();if(!i||["#ffffff","#fff","white","#000000","#000","black","","undefined","null","transparent"].includes(i)){let r=this.getFallbackColor(t);return this.config.enableDebug&&console.warn(`\u{1F527} [SemanticColorManager] Invalid color "${e}" for ${t}, using fallback: ${r}`),r}if(!i.match(/^#[0-9a-f]{6}$/i)&&!i.match(/^#[0-9a-f]{3}$/i)){let r=this.getFallbackColor(t);return this.config.enableDebug&&console.warn(`\u{1F527} [SemanticColorManager] Malformed color "${e}" for ${t}, using fallback: ${r}`),r}return e}getFallbackColor(e){let t=Ve.SEMANTIC_MAPPINGS.find(i=>i.semanticColor===e);return t?t.fallbackColor:e.startsWith("text")?"#cad3f5":e.startsWith("background")?"#24273a":e.startsWith("essential")?"#c6a0f6":e.startsWith("decorative")?"#939ab7":"#cad3f5"}applyColorToCSS(e,t,i="normal",a="semantic-color-manager"){this.cssController.setVariable("SemanticColorManager",e,t,i,a)}isSpicetifyAvailable(){return typeof Spicetify<"u"&&Spicetify.Platform&&typeof Spicetify.Platform.getSemanticColors=="function"}flushUpdates(){this.cssController&&this.cssController.flushUpdates()}clearCache(){this.colorCache.clear(),this.lastCacheUpdate=0}updateWithAlbumColors(e){if(!this.initialized){console.warn("[SemanticColorManager] Not initialized, cannot update with album colors");return}try{let t=e.OKLAB_PRIMARY||e.VIBRANT||e.PRIMARY,i=e.OKLAB_ACCENT||e.LIGHT_VIBRANT||e.SECONDARY,a=e.OKLAB_SHADOW||e.DARK_VIBRANT||e.DARK,r=e.OKLAB_HIGHLIGHT||e.VIBRANT_NON_ALARMING||e.LIGHT;if(!t){console.warn("[SemanticColorManager] No primary color found in OKLAB result, skipping update");return}let n=this.generateIntelligentColorDistribution(t,i,a,r),s=this.convertColorsToRgb(n),o={"--spice-accent":n.primary,"--spice-rgb-accent":s.primary,"--spice-surface1":n.surface1,"--spice-rgb-surface1":s.surface1,"--spice-button-active":n.primary,"--spice-rgb-button-active":s.primary,"--spice-highlight":n.highlight,"--spice-rgb-highlight":s.highlight,"--spice-press":n.shadow,"--spice-rgb-press":s.shadow},l={"--spice-surface0":n.surface0,"--spice-rgb-surface0":s.surface0,"--spice-surface2":n.surface2,"--spice-rgb-surface2":s.surface2,"--spice-base":n.base,"--spice-rgb-base":s.base},m={"--spice-main":n.base,"--spice-rgb-main":s.base,"--spice-main-elevated":n.surface0,"--spice-rgb-main-elevated":s.surface0,"--spice-sidebar":n.surface1,"--spice-rgb-sidebar":s.surface1,"--spice-text":this.generateTextColor(n.base),"--spice-rgb-text":this.hexToRgb(this.generateTextColor(n.base)),"--spice-subtext":this.generateSubtextColor(n.base),"--spice-rgb-subtext":this.hexToRgb(this.generateSubtextColor(n.base)),"--spice-highlight-elevated":n.surface2,"--spice-rgb-highlight-elevated":s.surface2,"--spice-overlay0":this.generateOverlayColor(n.base,.04),"--spice-rgb-overlay0":this.hexToRgb(this.generateOverlayColor(n.base,.04)),"--spice-overlay1":this.generateOverlayColor(n.base,.08),"--spice-rgb-overlay1":this.hexToRgb(this.generateOverlayColor(n.base,.08)),"--spice-overlay2":this.generateOverlayColor(n.base,.12),"--spice-rgb-overlay2":this.hexToRgb(this.generateOverlayColor(n.base,.12)),"--spice-crust":this.generateCrustColor(n.base),"--spice-rgb-crust":this.hexToRgb(this.generateCrustColor(n.base)),"--spice-mantle":this.generateMantleColor(n.base),"--spice-rgb-mantle":this.hexToRgb(this.generateMantleColor(n.base))},d={"--spice-blue":n.harmonyPrimary,"--spice-rgb-blue":s.harmonyPrimary,"--spice-mauve":n.harmonySecondary,"--spice-rgb-mauve":s.harmonySecondary,"--spice-teal":n.harmonyTertiary,"--spice-rgb-teal":s.harmonyTertiary,"--spice-flamingo":this.generateZoneColor(n.primary,"flamingo"),"--spice-rgb-flamingo":this.hexToRgb(this.generateZoneColor(n.primary,"flamingo")),"--spice-lavender":this.generateZoneColor(n.highlight,"lavender"),"--spice-rgb-lavender":this.hexToRgb(this.generateZoneColor(n.highlight,"lavender")),"--spice-peach":this.generateZoneColor(n.surface2,"peach"),"--spice-rgb-peach":this.hexToRgb(this.generateZoneColor(n.surface2,"peach")),"--spice-rosewater":this.generateZoneColor(n.surface1,"rosewater"),"--spice-rgb-rosewater":this.hexToRgb(this.generateZoneColor(n.surface1,"rosewater")),"--spice-sapphire":this.generateZoneColor(n.harmonyPrimary,"sapphire"),"--spice-rgb-sapphire":this.hexToRgb(this.generateZoneColor(n.harmonyPrimary,"sapphire"))},h={"--spice-pink":this.generatePaletteColor(n.primary,"pink"),"--spice-rgb-pink":this.hexToRgb(this.generatePaletteColor(n.primary,"pink")),"--spice-sky":this.generatePaletteColor(n.harmonyPrimary,"sky"),"--spice-rgb-sky":this.hexToRgb(this.generatePaletteColor(n.harmonyPrimary,"sky")),"--spice-red":this.generatePaletteColor(n.highlight,"red"),"--spice-rgb-red":this.hexToRgb(this.generatePaletteColor(n.highlight,"red")),"--spice-maroon":this.generatePaletteColor(n.shadow,"maroon"),"--spice-rgb-maroon":this.hexToRgb(this.generatePaletteColor(n.shadow,"maroon")),"--spice-yellow":this.generatePaletteColor(n.surface2,"yellow"),"--spice-rgb-yellow":this.hexToRgb(this.generatePaletteColor(n.surface2,"yellow")),"--spice-green":this.generatePaletteColor(n.harmonyTertiary,"green"),"--spice-rgb-green":this.hexToRgb(this.generatePaletteColor(n.harmonyTertiary,"green")),"--spice-misc":n.surface1,"--spice-rgb-misc":s.surface1},g={"--spice-shimmer-primary":n.harmonyPrimary,"--spice-rgb-shimmer-primary":s.harmonyPrimary,"--spice-shimmer-secondary":n.harmonySecondary,"--spice-rgb-shimmer-secondary":s.harmonySecondary,"--spice-shimmer-tertiary":n.harmonyTertiary,"--spice-rgb-shimmer-tertiary":s.harmonyTertiary,"--spice-shimmer-quaternary":n.primary,"--spice-rgb-shimmer-quaternary":s.primary,"--spice-particle-glow":n.highlight,"--spice-rgb-particle-glow":s.highlight,"--spice-particle-core":n.primary,"--spice-rgb-particle-core":s.primary,"--spice-particle-trail":n.shadow,"--spice-rgb-particle-trail":s.shadow,"--spice-cinematic-red":this.generateCinematicRed(n.primary),"--spice-rgb-cinematic-red":this.hexToRgb(this.generateCinematicRed(n.primary)),"--spice-cinematic-cyan":this.generateCinematicCyan(n.primary),"--spice-rgb-cinematic-cyan":this.hexToRgb(this.generateCinematicCyan(n.primary)),"--spice-cinematic-yellow":this.generateCinematicYellow(n.highlight),"--spice-rgb-cinematic-yellow":this.hexToRgb(this.generateCinematicYellow(n.highlight)),"--spice-holographic-primary":this.generateHolographicPrimary(n.primary),"--spice-rgb-holographic-primary":this.hexToRgb(this.generateHolographicPrimary(n.primary)),"--spice-holographic-accent":this.generateHolographicAccent(n.harmonyPrimary),"--spice-rgb-holographic-accent":this.hexToRgb(this.generateHolographicAccent(n.harmonyPrimary)),"--spice-holographic-glow":this.generateHolographicGlow(n.highlight),"--spice-rgb-holographic-glow":this.hexToRgb(this.generateHolographicGlow(n.highlight))},f={...o,...l,...m,...d,...h,...g};this.cssController.batchSetVariables("SemanticColorManager",f,"critical","album-spicetify-update");let S={"--sn-bg-gradient-accent":n.primary,"--sn-bg-gradient-accent-rgb":s.primary,"--sn-bg-gradient-primary":n.primary,"--sn-bg-gradient-primary-rgb":s.primary,"--sn-bg-gradient-secondary":n.surface1,"--sn-bg-gradient-secondary-rgb":s.surface1};this.cssController.batchSetVariables("SemanticColorManager",S,"critical","album-starrynight-update");let C={"--sn-color-accent-hex":n.primary,"--sn-color-accent-rgb":s.primary,"--sn-accent-hex":n.primary,"--sn-accent-rgb":s.primary,"--sn-color-extracted-primary-rgb":s.primary,"--sn-color-extracted-secondary-rgb":s.surface1,"--sn-color-harmony-complementary-rgb":s.shadow,"--sn-color-harmony-analogous-rgb":s.highlight,"--sn-color-harmony-triadic-rgb":s.harmonyPrimary};this.cssController.batchSetVariables("SemanticColorManager",C,"critical","album-y3k-integration-update"),this.clearCache(),this.lastColorUpdate=Date.now(),this.colorUpdateCount++;let T=Object.keys(f).length+Object.keys(S).length+Object.keys(C).length;p.emitSync("colors:applied",{cssVariables:{...f,...S,...C},accentHex:n.primary,accentRgb:s.primary,appliedAt:this.lastColorUpdate}),this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Comprehensive Spicetify variable update with OKLAB album colors:",{primaryColor:n.primary,accentColor:n.surface1,shadowColor:n.shadow,highlightColor:n.highlight,surfaceProgression:[n.base,n.surface0,n.surface1,n.surface2],harmonyColors:[n.harmonyPrimary,n.harmonySecondary,n.harmonyTertiary],effectColors:{shimmerColors:4,particleColors:3,cinematicColors:3,holographicColors:3},totalSpicetifyVariablesUpdated:Object.keys(f).length,coreLayoutVariablesUpdated:Object.keys(m).length,starryNightVariablesUpdated:Object.keys(S).length,snColorVariablesUpdated:Object.keys(C).length,effectVariablesAdded:Object.keys(g).length,eventEmitted:!0,totalVariablesUpdated:T})}catch(t){console.error("[SemanticColorManager] Failed to update with album colors:",t)}}generateIntelligentColorDistribution(e,t,i,a){let r=e,n=t||e,s=i||this.generateDarkerVariant(e,.3),o=a||this.generateLighterVariant(e,.2),l=this.generateDarkerVariant(e,.6),m=this.generateDarkerVariant(e,.4),d=n,h=this.generateLighterVariant(n,.15),g=this.generateHueRotatedColor(e,120),f=this.generateHueRotatedColor(e,-60),S=this.generateHueRotatedColor(e,180);return{primary:r,surface0:m,surface1:d,surface2:h,base:l,shadow:s,highlight:o,harmonyPrimary:g,harmonySecondary:f,harmonyTertiary:S}}convertColorsToRgb(e){let t={};return Object.entries(e).forEach(([i,a])=>{t[i]=this.hexToRgb(a)}),t}generateDarkerVariant(e,t){try{let i=this.hexToRgbObject(e);if(!i)return e;let a=Math.max(0,Math.round(i.r*(1-t))),r=Math.max(0,Math.round(i.g*(1-t))),n=Math.max(0,Math.round(i.b*(1-t)));return this.rgbToHex(a,r,n)}catch(i){return console.warn("[SemanticColorManager] Failed to generate darker variant:",i),e}}generateLighterVariant(e,t){try{let i=this.hexToRgbObject(e);if(!i)return e;let a=Math.min(255,Math.round(i.r+(255-i.r)*t)),r=Math.min(255,Math.round(i.g+(255-i.g)*t)),n=Math.min(255,Math.round(i.b+(255-i.b)*t));return this.rgbToHex(a,r,n)}catch(i){return console.warn("[SemanticColorManager] Failed to generate lighter variant:",i),e}}generateHueRotatedColor(e,t){try{let i=this.hexToRgbObject(e);if(!i)return e;let a=this.rgbToHsl(i.r,i.g,i.b);a.h=(a.h+t)%360,a.h<0&&(a.h+=360);let r=this.hslToRgb(a.h,a.s,a.l);return this.rgbToHex(r.r,r.g,r.b)}catch(i){return console.warn("[SemanticColorManager] Failed to generate hue-rotated color:",i),e}}hexToRgbObject(e){let t=e.replace("#","");if(t.length!==6)return null;let i=parseInt(t.substring(0,2),16),a=parseInt(t.substring(2,4),16),r=parseInt(t.substring(4,6),16);return{r:i,g:a,b:r}}rgbToHex(e,t,i){let a=r=>{let n=Math.round(Math.max(0,Math.min(255,r))).toString(16);return n.length===1?"0"+n:n};return`#${a(e)}${a(t)}${a(i)}`}rgbToHsl(e,t,i){e/=255,t/=255,i/=255;let a=Math.max(e,t,i),r=Math.min(e,t,i),n=0,s=0,o=(a+r)/2;if(a===r)n=s=0;else{let l=a-r;switch(s=o>.5?l/(2-a-r):l/(a+r),a){case e:n=(t-i)/l+(t<i?6:0);break;case t:n=(i-e)/l+2;break;case i:n=(e-t)/l+4;break}n/=6}return{h:n*360,s:s*100,l:o*100}}hslToRgb(e,t,i){e/=360,t/=100,i/=100;let a=(o,l,m)=>(m<0&&(m+=1),m>1&&(m-=1),m<1/6?o+(l-o)*6*m:m<1/2?l:m<2/3?o+(l-o)*(2/3-m)*6:o),r,n,s;if(t===0)r=n=s=i;else{let o=i<.5?i*(1+t):i+t-i*t,l=2*i-o;r=a(l,o,e+1/3),n=a(l,o,e),s=a(l,o,e-1/3)}return{r:Math.round(r*255),g:Math.round(n*255),b:Math.round(s*255)}}hexToRgb(e){let t=e.replace("#",""),i=parseInt(t.substring(0,2),16),a=parseInt(t.substring(2,4),16),r=parseInt(t.substring(4,6),16);return`${i}, ${a}, ${r}`}getColorMappings(){return Ve.SEMANTIC_MAPPINGS}generateCinematicRed(e){try{let t=this.hexToRgbObject(e);if(!t)return"#FF0000";let i=Math.min(255,t.r+100),a=Math.max(0,Math.min(t.g*.3,100)),r=Math.max(0,Math.min(t.b*.2,80));return this.rgbToHex(i,a,r)}catch(t){return console.warn("[SemanticColorManager] Failed to generate cinematic red:",t),"#FF0000"}}generateCinematicCyan(e){try{let t=this.hexToRgbObject(e);if(!t)return"#00FFFF";let i=Math.min(255,t.g+120),a=Math.min(255,t.b+140),r=Math.max(0,Math.min(t.r*.2,60));return this.rgbToHex(r,i,a)}catch(t){return console.warn("[SemanticColorManager] Failed to generate cinematic cyan:",t),"#00FFFF"}}generateCinematicYellow(e){try{let t=this.hexToRgbObject(e);if(!t)return"#FFFF00";let i=Math.min(255,t.r+80),a=Math.min(255,t.g+100),r=Math.max(0,Math.min(t.b*.3,120));return this.rgbToHex(i,a,r)}catch(t){return console.warn("[SemanticColorManager] Failed to generate cinematic yellow:",t),"#FFFF00"}}generateHolographicPrimary(e){try{let t=this.hexToRgbObject(e);if(!t)return"#8A2BE2";let i=this.rgbToHsl(t.r,t.g,t.b),a=Math.min(1,i.s+.3),r=Math.min(.8,Math.max(.4,i.l+.1)),n=this.hslToRgb(i.h,a,r);return this.rgbToHex(n.r,n.g,n.b)}catch(t){return console.warn("[SemanticColorManager] Failed to generate holographic primary:",t),"#8A2BE2"}}generateHolographicAccent(e){try{return this.generateHueRotatedColor(e,45)}catch(t){return console.warn("[SemanticColorManager] Failed to generate holographic accent:",t),"#FF00FF"}}generateHolographicGlow(e){try{let t=this.hexToRgbObject(e);if(!t)return"#E0E0FF";let i=.7,a=Math.min(255,t.r+(255-t.r)*i),r=Math.min(255,t.g+(255-t.g)*i),n=Math.min(255,t.b+(255-t.b)*i);return this.rgbToHex(a,r,n)}catch(t){return console.warn("[SemanticColorManager] Failed to generate holographic glow:",t),"#E0E0FF"}}generateTextColor(e){try{let t=this.hexToRgbObject(e);return t&&(.299*t.r+.587*t.g+.114*t.b)/255>.5?"#24273A":"#CAD3F5"}catch(t){return console.warn("[SemanticColorManager] Failed to generate text color:",t),"#CAD3F5"}}generateSubtextColor(e){try{let t=this.hexToRgbObject(e);return t&&(.299*t.r+.587*t.g+.114*t.b)/255>.5?"#5B6078":"#A5ADCB"}catch(t){return console.warn("[SemanticColorManager] Failed to generate subtext color:",t),"#A5ADCB"}}generateOverlayColor(e,t){try{let i=this.hexToRgbObject(e);if(!i)return`rgba(88,91,112,${t})`;if((.299*i.r+.587*i.g+.114*i.b)/255>.5){let r=1-t*2,n=Math.max(0,Math.round(i.r*r)),s=Math.max(0,Math.round(i.g*r)),o=Math.max(0,Math.round(i.b*r));return this.rgbToHex(n,s,o)}else{let r=t*255,n=Math.min(255,Math.round(i.r+r)),s=Math.min(255,Math.round(i.g+r)),o=Math.min(255,Math.round(i.b+r));return this.rgbToHex(n,s,o)}}catch(i){return console.warn("[SemanticColorManager] Failed to generate overlay color:",i),`rgba(88,91,112,${t})`}}generateCrustColor(e){try{let t=this.hexToRgbObject(e);if(!t)return"#232634";if((.299*t.r+.587*t.g+.114*t.b)/255>.5){let a=Math.max(0,Math.round(t.r*.8)),r=Math.max(0,Math.round(t.g*.8)),n=Math.max(0,Math.round(t.b*.8));return this.rgbToHex(a,r,n)}else{let a=Math.min(255,Math.round(t.r+20)),r=Math.min(255,Math.round(t.g+20)),n=Math.min(255,Math.round(t.b+20));return this.rgbToHex(a,r,n)}}catch(t){return console.warn("[SemanticColorManager] Failed to generate crust color:",t),"#232634"}}generateMantleColor(e){try{let t=this.hexToRgbObject(e);if(!t)return"#1e2030";if((.299*t.r+.587*t.g+.114*t.b)/255>.5){let a=Math.max(0,Math.round(t.r*.95)),r=Math.max(0,Math.round(t.g*.95)),n=Math.max(0,Math.round(t.b*.95));return this.rgbToHex(a,r,n)}else{let a=Math.min(255,Math.round(t.r+10)),r=Math.min(255,Math.round(t.g+10)),n=Math.min(255,Math.round(t.b+10));return this.rgbToHex(a,r,n)}}catch(t){return console.warn("[SemanticColorManager] Failed to generate mantle color:",t),"#1e2030"}}generateZoneColor(e,t){try{let i=ne(e);if(!i)return console.warn(`\u{1F527} [SemanticColorManager] Failed to parse RGB from ${e}`),e;let r={flamingo:{rAdjust:20,gAdjust:-10,bAdjust:-5},lavender:{rAdjust:10,gAdjust:-5,bAdjust:15},peach:{rAdjust:25,gAdjust:10,bAdjust:-15},rosewater:{rAdjust:15,gAdjust:-8,bAdjust:0},sapphire:{rAdjust:-20,gAdjust:-10,bAdjust:25}}[t],n=Math.max(0,Math.min(255,i.r+r.rAdjust)),s=Math.max(0,Math.min(255,i.g+r.gAdjust)),o=Math.max(0,Math.min(255,i.b+r.bAdjust)),l=Se(n,s,o);return this.config.enableDebug&&console.log(`\u{1F3A8} [SemanticColorManager] Generated ${t} color: ${e} \u2192 ${l} (RGB: ${i.r},${i.g},${i.b} \u2192 ${n},${s},${o})`),l}catch(i){return console.warn(`\u{1F527} [SemanticColorManager] Failed to generate ${t} color for "${e}":`,i),e}}generatePaletteColor(e,t){try{let i=ne(e);if(!i)return console.warn(`\u{1F527} [SemanticColorManager] Failed to parse RGB from ${e}`),e;let r={pink:{rAdjust:30,gAdjust:-20,bAdjust:-10},sky:{rAdjust:-30,gAdjust:10,bAdjust:30},red:{rAdjust:35,gAdjust:-25,bAdjust:-15},maroon:{rAdjust:25,gAdjust:-15,bAdjust:-10},yellow:{rAdjust:30,gAdjust:25,bAdjust:-30},green:{rAdjust:-25,gAdjust:30,bAdjust:-20}}[t],n=Math.max(0,Math.min(255,i.r+r.rAdjust)),s=Math.max(0,Math.min(255,i.g+r.gAdjust)),o=Math.max(0,Math.min(255,i.b+r.bAdjust)),l=Se(n,s,o);return this.config.enableDebug&&console.log(`\u{1F3A8} [SemanticColorManager] Generated ${t} color: ${e} \u2192 ${l} (RGB: ${i.r},${i.g},${i.b} \u2192 ${n},${s},${o})`),l}catch(i){return console.warn(`\u{1F527} [SemanticColorManager] Failed to generate ${t} color for "${e}":`,i),e}}destroy(){try{this.cleanupEventSubscriptions(),this.clearCache(),this.cssController=null,this.initialized=!1,this.lastColorUpdate=0,this.colorUpdateCount=0,p.emitSync("system:destroyed",{systemName:"SemanticColorManager",timestamp:Date.now(),reason:"Manual destruction"}),this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] System destroyed and cleaned up")}catch(e){console.error("[SemanticColorManager] Error during destruction:",e)}}updateAnimation(e){}async healthCheck(){let e={system:"SemanticColorManager",healthy:!0,details:"SemanticColorManager operational",issues:[],metrics:{initialized:this.initialized,spicetifyAvailable:this.isSpicetifyAvailable(),cssControllerAvailable:!!this.cssController,lastColorUpdate:this.lastColorUpdate,colorUpdateCount:this.colorUpdateCount,eventSubscriptions:this.eventSubscriptionIds.length,cacheSize:this.colorCache.size,lastCacheUpdate:this.lastCacheUpdate}};return this.initialized||(e.healthy=!1,e.issues.push("System not initialized")),this.isSpicetifyAvailable()||(e.healthy=!1,e.issues.push("Spicetify API not available")),this.colorUpdateCount===0&&this.initialized&&e.issues.push("No color updates performed since initialization"),this.eventSubscriptionIds.length===0&&this.initialized&&e.issues.push("No event subscriptions active"),e.issues.length>0&&(e.details=`Issues detected: ${e.issues.join(", ")}`,e.issues.length>=2&&(e.healthy=!1)),e}setupEventSubscriptions(){let e=p.subscribe("music:track-changed",async i=>{this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Track changed, preparing for color refresh:",i.trackUri),this.clearCache()},"SemanticColorManager"),t=p.subscribe("settings:changed",async i=>{(i.settingKey.includes("color")||i.settingKey.includes("theme"))&&(this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Color-related setting changed:",i.settingKey),this.clearCache())},"SemanticColorManager");this.eventSubscriptionIds=[e,t],this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Event subscriptions established:",this.eventSubscriptionIds.length)}cleanupEventSubscriptions(){for(let e of this.eventSubscriptionIds)p.unsubscribe(e);this.eventSubscriptionIds=[],this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Event subscriptions cleaned up")}getSystemMetrics(){return{initialized:this.initialized,lastColorUpdate:this.lastColorUpdate,colorUpdateCount:this.colorUpdateCount,eventSubscriptions:this.eventSubscriptionIds.length,cacheSize:this.colorCache.size,spicetifyAvailable:this.isSpicetifyAvailable()}}};Ve.SEMANTIC_MAPPINGS=[{semanticColor:"textBase",cssVariable:"--spice-text",fallbackColor:"#cad3f5",description:"Primary text color"},{semanticColor:"textSubdued",cssVariable:"--spice-subtext",fallbackColor:"#a5adcb",description:"Secondary text color"},{semanticColor:"textBrightAccent",cssVariable:"--spice-accent",fallbackColor:"#c6a0f6",description:"Accent text color"},{semanticColor:"textNegative",cssVariable:"--spice-red",fallbackColor:"#ed8796",description:"Error text color"},{semanticColor:"textWarning",cssVariable:"--spice-yellow",fallbackColor:"#eed49f",description:"Warning text color"},{semanticColor:"textPositive",cssVariable:"--spice-green",fallbackColor:"#a6da95",description:"Success text color"},{semanticColor:"textAnnouncement",cssVariable:"--spice-blue",fallbackColor:"#8aadf4",description:"Info text color"},{semanticColor:"essentialBase",cssVariable:"--spice-button",fallbackColor:"#cad3f5",description:"Primary button color"},{semanticColor:"essentialSubdued",cssVariable:"--spice-button-disabled",fallbackColor:"#6e738d",description:"Disabled button color"},{semanticColor:"essentialBrightAccent",cssVariable:"--spice-button-active",fallbackColor:"#c6a0f6",description:"Active button color"},{semanticColor:"essentialNegative",cssVariable:"--spice-notification-error",fallbackColor:"#ed8796",description:"Error button color"},{semanticColor:"essentialWarning",cssVariable:"--spice-notification-warning",fallbackColor:"#eed49f",description:"Warning button color"},{semanticColor:"essentialPositive",cssVariable:"--spice-notification-success",fallbackColor:"#a6da95",description:"Success button color"},{semanticColor:"backgroundBase",cssVariable:"--spice-main",fallbackColor:"#24273a",description:"Main background color"},{semanticColor:"backgroundHighlight",cssVariable:"--spice-highlight",fallbackColor:"#363a4f",description:"Highlight background color"},{semanticColor:"backgroundPress",cssVariable:"--spice-press",fallbackColor:"#494d64",description:"Press state background color"},{semanticColor:"backgroundElevatedBase",cssVariable:"--spice-card",fallbackColor:"#1e2030",description:"Card background color"},{semanticColor:"backgroundElevatedHighlight",cssVariable:"--spice-card-highlight",fallbackColor:"#363a4f",description:"Card highlight background"},{semanticColor:"backgroundTintedBase",cssVariable:"--spice-sidebar",fallbackColor:"#363a4f",description:"Sidebar background color"},{semanticColor:"backgroundTintedHighlight",cssVariable:"--spice-sidebar-highlight",fallbackColor:"#494d64",description:"Sidebar highlight background"},{semanticColor:"decorativeBase",cssVariable:"--spice-decorative",fallbackColor:"#cad3f5",description:"Decorative element color"},{semanticColor:"decorativeSubdued",cssVariable:"--spice-decorative-subdued",fallbackColor:"#939ab7",description:"Subdued decorative color"}];ot=Ve});function Pn(){try{let e=document.createElement("canvas").getContext("webgl2");if(!e)return!1;let t=e.getExtension("EXT_color_buffer_float")!==null;return!0}catch{return!1}}function uc(c,e){try{let t={alpha:e.alpha??!0,antialias:e.antialias??!0,preserveDrawingBuffer:e.preserveDrawingBuffer??!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1},i=c.getContext("webgl2",t);if(!i)return null;let a=i.getParameter(i.MAX_TEXTURE_SIZE);return{canvas:c,ctx:i,type:"webgl2",capabilities:{supportsGPUAcceleration:!0,supports3D:!0,maxTextureSize:a}}}catch(t){return console.warn("[VisualCanvasFactory] WebGL2 context creation failed:",t),null}}function Tn(c,e){let t={alpha:e.alpha??!0,desynchronized:!0},i=c.getContext("2d",t);return{canvas:c,ctx:i,type:"2d",capabilities:{supportsGPUAcceleration:!1,supports3D:!1}}}async function An(c){let e=document.createElement("canvas");e.id=c.id,e.width=c.width??window.innerWidth,e.height=c.height??window.innerHeight;let t=c.fallbackChain??["webgl2","2d"];if(c.preferredType){let i=[c.preferredType,...t.filter(a=>a!==c.preferredType)];t.splice(0,t.length,...i)}for(let i of t){let a=null;switch(i){case"webgl2":Pn()&&(a=uc(e,c));break;case"2d":a=Tn(e,c);break}if(a)return a}return Tn(e,c)}function xn(){let c=Pn(),e="2d";return c&&(e="webgl2"),{webgl2:c,recommendedType:e}}var In=y(()=>{"use strict"});function Dn(c,e,t={}){let{trace:i}=t;if(!e||typeof e!="object")return i?.("[visualPerformance] No performanceProfiles provided \u2013 skipping selection"),null;let a=e[c];if(a||(i?.(`[visualPerformance] Profile '${c}' not found, falling back to 'balanced'`),a=e.balanced),!a){let r=Object.keys(e)[0];a=e[r],i?.(`[visualPerformance] Using first available profile '${r}' as fallback`)}return a}var kn=y(()=>{"use strict"});var j,de=y(()=>{"use strict";U();In();X();kn();j=class{constructor(e=E,t=D,i,a,r){this.canvasCapabilities=null;this.activeCanvasResults=new Map;this.config=e,this.utils=t,this.performanceMonitor=i,this.musicSyncService=a,this.settingsManager=r,this.systemName=this.constructor.name,this.initialized=!1,this.isActive=!1,this.currentPerformanceProfile={},this.metrics={initializationTime:0,updates:0,errors:0},this._resizeHandler=null,this.boundHandleSettingsChange=this.handleSettingsChange.bind(this),this.config.enableDebug&&console.log(`[${this.systemName}] Constructor`)}async initialize(){let e=this.config.enableDebug?performance.now():0;if(this.config.enableDebug&&console.log(`[${this.systemName}] Initializing...`),this.settingsManager){document.addEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange);try{let t=globalThis.year3000System?.deviceCapabilityDetector,i="balanced";t?.isInitialized&&(i=t.recommendPerformanceQuality()),this.config.enableDebug&&console.log(`[${this.systemName}] Auto-selected performance quality '${i}' based on device capability.`),this._applyPerformanceProfile(i)}catch(t){this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Device capability detection failed; defaulting to 'balanced'.`,t),this._applyPerformanceProfile("balanced")}}if(await this._performSystemSpecificInitialization(),this.initialized=!0,this.isActive=!0,this.musicSyncService&&(this._validateDependenciesForSubscription()?(this.musicSyncService.subscribe(this,this.systemName),this.config.enableDebug&&console.log(`[${this.systemName}] Subscribed to MusicSyncService.`)):console.warn(`[${this.systemName}] Dependency validation failed; subscription skipped.`)),this.config.enableDebug){let t=performance.now()-e;console.log(`[${this.systemName}] Initialization complete in ${t.toFixed(2)}ms`)}}async _performSystemSpecificInitialization(){this.canvasCapabilities=xn(),this.canvasCapabilities&&this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Canvas capabilities detected: WebGL2=${this.canvasCapabilities.webgl2}, Recommended=${this.canvasCapabilities.recommendedType}`)}_validateDependenciesForSubscription(){return typeof this.updateFromMusicAnalysis!="function"?(console.error(`[${this.systemName}] Missing updateFromMusicAnalysis method.`),!1):this.initialized?this._performAdditionalDependencyValidation():(console.warn(`[${this.systemName}] System not initialized.`),!1)}_performAdditionalDependencyValidation(){return!0}destroy(){this.config.enableDebug&&console.log(`[${this.systemName}] Destroying...`);try{this.initialized=!1,this.isActive=!1,this.musicSyncService&&this.musicSyncService.unsubscribe(this.systemName),this.settingsManager&&this.boundHandleSettingsChange&&document.removeEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange),this._resizeHandler&&(window.removeEventListener("resize",this._resizeHandler),this._resizeHandler=null),this._performSystemSpecificCleanup()}catch(e){console.error(`[${this.systemName}] Error during destruction:`,e),this.metrics.errors++}}_performSystemSpecificCleanup(){for(let[e,t]of this.activeCanvasResults){let i=t.canvas;i.parentNode&&i.parentNode.removeChild(i),this.config.enableDebug&&console.log(`[${this.systemName}] Cleaned up canvas: ${e} (type: ${t.type})`)}this.activeCanvasResults.clear()}updateFromMusicAnalysis(e,...t){}onAnimate(e){}updateAnimation(e){this.onAnimate(e)}async healthCheck(){let e=this.initialized&&this.isActive&&this.metrics.errors===0;return{system:this.systemName,healthy:e,metrics:{initialized:this.initialized,active:this.isActive,errors:this.metrics.errors,updates:this.metrics.updates,initializationTime:this.metrics.initializationTime},issues:e?[]:[...this.initialized?[]:["System not initialized"],...this.isActive?[]:["System not active"],...this.metrics.errors===0?[]:[`${this.metrics.errors} errors detected`]]}}updateModeConfiguration(e){}handleSettingsChange(e){}_applyPerformanceProfile(e){if(!this.config?.performanceProfiles){this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Performance profiles not found in config.`);return}let t=Dn(e,this.config.performanceProfiles,{trace:i=>this.performanceMonitor?.emitTrace(i)});t?(this.currentPerformanceProfile=t,this.performanceMonitor?.emitTrace?.(`[BaseVisualSystem (${this.systemName})] Applied performance profile '${e}'`,t)):this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Performance profile '${e}' not found.`)}getCosmicState(){if(typeof document>"u")return{};let e=document.documentElement,t=getComputedStyle(e);return{energy:parseFloat(t.getPropertyValue("--sn-kinetic-energy"))||.5,valence:parseFloat(t.getPropertyValue("--sn-kinetic-valence"))||.5,bpm:parseFloat(t.getPropertyValue("--sn-kinetic-bpm"))||120,tempoMultiplier:parseFloat(t.getPropertyValue("--sn-kinetic-tempo-multiplier"))||1,beatPhase:parseFloat(t.getPropertyValue("--sn-kinetic-beat-phase"))||0,beatPulse:parseFloat(t.getPropertyValue("--sn-kinetic-beat-pulse"))||0}}async _createOptimizedKineticCanvas(e,t=5,i="screen",a="pulse"){let r=document.getElementById(e);r&&r.remove();let n="2d";this.canvasCapabilities&&this.currentPerformanceProfile&&(this.currentPerformanceProfile.quality||"balanced")!=="low"&&this.canvasCapabilities.webgl2&&(n="webgl2");let s=await An({id:e,width:window.innerWidth,height:window.innerHeight,alpha:!0,antialias:!0,preferredType:n}),o=s.canvas;o.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: ${t};
      pointer-events: none;
      mix-blend-mode: ${i};
    `,o.classList.add("year3000-kinetic-canvas"),o.dataset.kineticMode=a,o.dataset.systemName=this.systemName,o.dataset.canvasType=s.type;let l=this._getKineticStyles(a);return Object.assign(o.style,l),document.body.appendChild(o),this.activeCanvasResults.set(e,s),this._resizeHandler=()=>{o.width=window.innerWidth,o.height=window.innerHeight,typeof this.handleResize=="function"&&this.handleResize()},window.addEventListener("resize",this._resizeHandler),this._resizeHandler(),this.config.enableDebug&&console.log(`[BaseVisualSystem (${this.systemName})] Created optimized kinetic canvas: ${s.type} (mode: ${a})`),s}getCanvasCapabilities(){return this.canvasCapabilities}hasGPUAcceleration(){return this.canvasCapabilities?.webgl2||!1}_createKineticCanvas(e,t=5,i="screen",a="pulse"){let r=this._createCanvasElement(e,t,i);r.classList.add("year3000-kinetic-canvas"),r.dataset.kineticMode=a,r.dataset.systemName=this.systemName;let n=this._getKineticStyles(a);return Object.assign(r.style,n),this.config.enableDebug&&console.log(`[BaseVisualSystem (${this.systemName})] Created kinetic canvas with mode: ${a}`),r}_getKineticStyles(e){let t={transition:"all 150ms cubic-bezier(0.25, 0.46, 0.45, 0.94)"};switch(e){case"pulse":return{...t,animation:"year3000-pulse calc(var(--sn-kinetic-tempo-multiplier, 1) * 1s) ease-in-out infinite"};case"breathe":return{...t,animation:"year3000-breathe calc(var(--sn-kinetic-tempo-multiplier, 1) * 4s) ease-in-out infinite"};case"flow":return{...t,animation:"year3000-flow calc(var(--sn-kinetic-tempo-multiplier, 1) * 8s) linear infinite"};default:return t}}_createCanvasElement(e,t,i){let a=document.getElementById(e);a&&a.remove();let r=document.createElement("canvas");return r.id=e,r.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: ${t};
      pointer-events: none;
      mix-blend-mode: ${i};
    `,document.body.appendChild(r),this._resizeHandler=()=>{r.width=window.innerWidth,r.height=window.innerHeight,typeof this.handleResize=="function"&&this.handleResize()},window.addEventListener("resize",this._resizeHandler),this._resizeHandler(),r}applyPerformanceSettings(e){this.currentPerformanceProfile=e,e.quality&&typeof this._applyPerformanceProfile=="function"&&this._applyPerformanceProfile?.(e.quality),this.config.enableDebug&&this.performanceMonitor?.emitTrace?.(`[BaseVisualSystem (${this.systemName})] Performance settings applied`,e)}applyUpdatedSettings(e,t){let i=new CustomEvent("year3000SystemSettingsChanged",{detail:{key:e,value:t}});try{this.handleSettingsChange(i)}catch(a){this.config.enableDebug&&console.warn(`[BaseVisualSystem] ${this.systemName} applyUpdatedSettings error`,a)}}forceRepaint(e){this.config.enableDebug&&console.log(`[${this.systemName}] Force repaint requested: ${e||"Unknown reason"}`)}}});var N,ue=y(()=>{"use strict";N=class{constructor(e={}){this.deviceCapabilities=null;this.isInitialized=!1;this.benchmarkCache=new Map;this.detectionStartTime=0;this.config={enableDebug:e.enableDebug||!1,runStressTests:e.runStressTests!==!1,spicetifyContext:e.spicetifyContext||this._detectSpicetifyContext(),...e},this.config.enableDebug&&console.log("\u{1F50D} [DeviceCapabilityDetector] Initialized",this.config.spicetifyContext?"(Spicetify-optimized)":"(Standard)")}_detectSpicetifyContext(){return!!window.Spicetify}async initialize(){if(this.isInitialized)return this.deviceCapabilities;this.detectionStartTime=performance.now(),this.config.enableDebug&&console.log("\u{1F50D} [DeviceCapabilityDetector] Starting enhanced capability detection...",this.config.spicetifyContext?"(Spicetify mode)":"(Standard mode)");let e=await this._analyzeMemoryCapabilities(),t=await this._analyzeCPUCapabilities(),i=await this._analyzeGPUCapabilities();this.deviceCapabilities={memory:e,cpu:t,gpu:i,browser:{supportsOffscreenCanvas:this._detectOffscreenCanvasSupport(),supportsWorkers:this._detectWorkerSupport(),supportsSharedArrayBuffer:this._detectSharedArrayBufferSupport(),supportsWASM:this._detectWASMSupport(),supportsCSSHoudini:this._detectCSSHoudiniSupport()},display:{pixelRatio:window.devicePixelRatio||1,refreshRate:await this._detectRefreshRate(),colorGamut:this._detectColorGamut(),contrastRatio:this._detectContrastCapability(),reducedMotion:this._detectReducedMotion()},network:{effectiveType:navigator.connection?.effectiveType||"unknown",downlink:navigator.connection?.downlink||0,rtt:navigator.connection?.rtt||0,saveData:navigator.connection?.saveData||!1},overall:"detecting",spicetifyProfile:await this._createSpicetifyProfile(e,t,i)},this.config.runStressTests&&(await this._runCapabilityTests(),this.deviceCapabilities.spicetifyProfile=await this._createSpicetifyProfile(this.deviceCapabilities.memory,this.deviceCapabilities.cpu,this.deviceCapabilities.gpu)),this.deviceCapabilities.overall=this._calculateOverallPerformanceLevel(),this.isInitialized=!0;let a=performance.now()-this.detectionStartTime;return this.config.enableDebug&&console.log("\u{1F4CA} [DeviceCapabilityDetector] Enhanced detection completed in",`${a.toFixed(1)}ms`,`
Spicetify Profile:`,this.deviceCapabilities.spicetifyProfile),this.config.enableDebug&&console.log("\u{1F4CA} [DeviceCapabilityDetector] Capabilities detected:",this.deviceCapabilities),this.deviceCapabilities}getSpicetifyProfile(){return this.deviceCapabilities?.spicetifyProfile||null}getRecommendedQualityLevel(){return this.deviceCapabilities?.spicetifyProfile?.recommendedQualityLevel||50}async _analyzeMemoryCapabilities(){let e=navigator.deviceMemory,t=typeof e=="number",i=e||this._estimateMemoryFromOtherSources(),a=performance.memory?.jsHeapSizeLimit||0,r=this._estimateAvailableMemory(),n=this.config.spicetifyContext?this._estimateSpicetifyOverhead():0,s=this._calculateMemoryScore(i,a,r);return{total:i,score:s,level:s>=7?"high":s>=4?"medium":"low",jsHeapSizeLimit:a,estimatedAvailable:r,spicetifyOverhead:n,confidenceLevel:t?.9:.6}}_detectMemoryLevel(){let e=navigator.deviceMemory||6;return e>=8?"high":e>=4?"medium":"low"}_estimateAvailableMemory(){return performance.memory?performance.memory.jsHeapSizeLimit-performance.memory.usedJSHeapSize:(navigator.deviceMemory||4)*1024*1024*1024*.7}async _analyzeCPUCapabilities(){let e=navigator.hardwareConcurrency||4,t=await this._benchmarkSingleThreadPerformance(),i=this._estimateThermalThrottlingRisk(e),a=this._calculateCPUScore(e,t);return{cores:e,score:a,level:a>=7?"high":a>=4?"medium":"low",singleThreadPerformance:t,thermalThrottlingRisk:i,confidenceLevel:e>1?.8:.5}}_detectCPULevel(){let e=navigator.hardwareConcurrency||4;return e>=8?"high":e>=4?"medium":"low"}_detectWebGLSupport(){try{let e=document.createElement("canvas");return!!(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch{return!1}}_detectWebGL2Support(){try{return!!document.createElement("canvas").getContext("webgl2")}catch{return!1}}_getMaxTextureSize(){try{let e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");return t?t.getParameter(t.MAX_TEXTURE_SIZE):0}catch{return 0}}_getGPUVendor(){try{let e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return"unknown";let i=t.getExtension("WEBGL_debug_renderer_info");return i?t.getParameter(i.UNMASKED_VENDOR_WEBGL):"unknown"}catch{return"unknown"}}_getGPURenderer(){try{let e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return"unknown";let i=t.getExtension("WEBGL_debug_renderer_info");return i?t.getParameter(i.UNMASKED_RENDERER_WEBGL):"unknown"}catch{return"unknown"}}async _analyzeGPUCapabilities(){let e=this._detectWebGLSupport(),t=this._detectWebGL2Support(),i=this._getMaxTextureSize(),a=this._getGPUVendor(),r=this._getGPURenderer(),n=await this._benchmarkWebGLCapabilities(),s=this._calculateGPUScore(r,n,t,i);return{supportsWebGL:e,supportsWebGL2:t,maxTextureSize:i,score:s,level:s>=7?"high":s>=4?"medium":"low",vendor:a,renderer:r,webglCapabilityScore:n,confidenceLevel:e?.8:.3}}_detectGPULevel(){let e=this._getGPURenderer().toLowerCase();return/rtx|radeon rx|gtx 16|gtx 20|apple m[1-9]|iris xe/.test(e)?"high":/gtx|radeon|intel iris|intel uhd|vega|ryzen/.test(e)?"medium":"low"}_detectOffscreenCanvasSupport(){return typeof OffscreenCanvas<"u"}_detectWorkerSupport(){return typeof Worker<"u"}_detectSharedArrayBufferSupport(){return typeof SharedArrayBuffer<"u"}_detectWASMSupport(){return typeof WebAssembly<"u"}_detectCSSHoudiniSupport(){return typeof CSS<"u"&&CSS.paintWorklet!==void 0}async _detectRefreshRate(){return new Promise(e=>{let t=performance.now(),i=0,a=[],r=()=>{let n=performance.now(),s=n-t;if(a.push(1e3/s),t=n,i++,i<10)requestAnimationFrame(r);else{let o=a.reduce((l,m)=>l+m,0)/a.length;e(Math.round(o))}};requestAnimationFrame(r)})}_detectColorGamut(){return window.matchMedia("(color-gamut: p3)").matches?"p3":window.matchMedia("(color-gamut: srgb)").matches?"srgb":"limited"}_detectContrastCapability(){return window.matchMedia("(dynamic-range: high)").matches||window.matchMedia("(contrast: high)").matches?"high":"standard"}_detectReducedMotion(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}async _runCapabilityTests(){this.deviceCapabilities&&(this.deviceCapabilities.gpu.stressTestScore=await this._runGPUStressTest(),this.deviceCapabilities.memory.stressTestScore=await this._runMemoryStressTest()),this.config.enableDebug&&console.log("\u26A1 [DeviceCapabilityDetector] Capability tests completed")}async _runGPUStressTest(){return 0}async _runMemoryStressTest(){return 0}_estimateMemoryFromOtherSources(){let e=navigator.hardwareConcurrency||4,t=window.screen,i=4;return e>=8?i=16:e>=6?i=12:e>=4?i=8:e>=2&&(i=6),t.width*t.height>2073600&&(i*=1.5),Math.round(i)}_estimateSpicetifyOverhead(){return this.config.spicetifyContext?.15:0}_calculateMemoryScore(e,t,i){let a=Math.min(e/2,10);if(t>0){let r=t/1073741824;a=Math.max(a,Math.min(r,10))}return this.config.spicetifyContext&&(a*=.85),Math.min(Math.max(a,1),10)}async _benchmarkSingleThreadPerformance(){let e="singleThreadPerf";return this.benchmarkCache.has(e)?this.benchmarkCache.get(e):new Promise(t=>{let i=performance.now(),a=0;for(let s=0;s<5e5;s++)a+=Math.sin(s)*Math.cos(s);let r=performance.now()-i,n=Math.max(1,Math.min(10,50/r));this.benchmarkCache.set(e,n),t(n)})}_estimateThermalThrottlingRisk(e){let t=/Mobi|Android/i.test(navigator.userAgent),i=.1;return e>=8&&(i+=.2),t&&(i+=.3),Math.min(i,1)}_calculateCPUScore(e,t){let i=Math.min(e/2,10),a=.7;return Math.min(i*(1-a)+t*a,10)}async _benchmarkWebGLCapabilities(){let e="webglCapability";if(this.benchmarkCache.has(e))return this.benchmarkCache.get(e);if(!this._detectWebGLSupport())return this.benchmarkCache.set(e,0),0;let t=document.createElement("canvas"),i=t.getContext("webgl2")||t.getContext("webgl");if(!i)return this.benchmarkCache.set(e,0),0;let a=2;i.getExtension("OES_texture_float")&&(a+=1),i.getExtension("WEBGL_depth_texture")&&(a+=1),i.getExtension("OES_element_index_uint")&&(a+=1);let r=i.getParameter(i.MAX_TEXTURE_SIZE);return r>=4096?a+=2:r>=2048&&(a+=1),i.getParameter(i.MAX_VERTEX_ATTRIBS)>=16&&(a+=1),i instanceof WebGL2RenderingContext&&(a+=2),this.benchmarkCache.set(e,Math.min(a,10)),Math.min(a,10)}_calculateGPUScore(e,t,i,a){let r=t,n=e.toLowerCase();return/rtx|radeon rx|apple m[1-9]|arc a/.test(n)?r+=2:/gtx|radeon|vega|iris xe|ryzen/.test(n)?r+=1:/intel|qualcomm|mali|adreno/.test(n)&&(r+=.5),Math.min(Math.max(r,1),10)}async _createSpicetifyProfile(e,t,i){let a=e.score,r=t.score,n=i.score,s=Math.round((a*.3+r*.4+n*.3)*10),o=Math.min(s,100);this.config.spicetifyContext&&(o*=1-e.spicetifyOverhead),o=Math.max(o,20);let l=(e.confidenceLevel+t.confidenceLevel+i.confidenceLevel)/3;return{memoryScore:a,cpuScore:r,gpuScore:n,compositeScore:s,spicetifyOverhead:e.spicetifyOverhead,userQualityPreference:"auto",confidenceLevel:l,recommendedQualityLevel:Math.round(o)}}_calculateOverallPerformanceLevel(){if(!this.deviceCapabilities)return"low";let e=this.deviceCapabilities.spicetifyProfile.compositeScore,t=this.deviceCapabilities.spicetifyProfile.confidenceLevel,i=e*(.7+t*.3);return i>=70?"high":i>=40?"medium":"low"}getCapabilities(){return this.isInitialized?this.deviceCapabilities:(console.warn("[DeviceCapabilityDetector] Not initialized - call initialize() first"),null)}hasWebGLSupport(){return this.isInitialized&&this.deviceCapabilities?this.deviceCapabilities.gpu.supportsWebGL:this._detectWebGLSupport()}hasWebGL2Support(){return this.isInitialized&&this.deviceCapabilities?this.deviceCapabilities.gpu.supportsWebGL2:this._detectWebGL2Support()}destroy(){this.deviceCapabilities=null,this.isInitialized=!1,this.config.enableDebug&&console.log("\u{1F50D} [DeviceCapabilityDetector] Destroyed")}recommendPerformanceQuality(){if(!this.isInitialized||!this.deviceCapabilities)return"balanced";switch(this.deviceCapabilities.overall){case"high":return"high";case"medium":return"balanced";case"low":default:return"low"}}}});var ee,Fe=y(()=>{"use strict";U();X();be();ee=class{constructor(e=E,t=ve,i=D){this.initialized=!1;this.initialized=!0,e?.enableDebug&&console.log("[SettingsManager] Initialized with new type-safe backend")}forceRepaint(e){typeof document<"u"&&(document.documentElement.style.display="none",document.documentElement.offsetHeight,document.documentElement.style.display="")}async initialize(){this.initialized=!0}async healthCheck(){return{healthy:this.initialized,system:"SettingsManager",details:this.initialized?"Settings manager operational":"Settings manager not initialized"}}updateAnimation(){}destroy(){this.initialized=!1}get(e){try{switch(e){case"artisticMode":return A.get("sn-artistic-mode");case"paletteSystem":return A.get("sn-palette-system");case"gradientIntensity":return A.get("sn-gradient-intensity");case"webglEnabled":return A.get("sn-webgl-enabled");case"animationQuality":return A.get("sn-animation-quality");default:return typeof e=="string"&&e.startsWith("sn-")?A.get(e):void 0}}catch(t){console.warn(`[SettingsManager] Failed to get setting ${String(e)}:`,t);return}}getAllowedValues(e){switch(e){case"artisticMode":return Object.keys(Qe);case"paletteSystem":return["catppuccin","year3000"];case"gradientIntensity":return["disabled","minimal","balanced","intense"];case"webglEnabled":return[!0,!1];case"animationQuality":return["auto","low","high"];default:return}}set(e,t){try{switch(e){case"artisticMode":return A.set("sn-artistic-mode",t);case"paletteSystem":return A.set("sn-palette-system",t);case"gradientIntensity":return A.set("sn-gradient-intensity",t);case"webglEnabled":return A.set("sn-webgl-enabled",!!t);case"animationQuality":return A.set("sn-animation-quality",t);default:return typeof e=="string"&&e.startsWith("sn-")?A.set(e,t):(console.warn(`[SettingsManager] Unknown setting key: ${String(e)}`),!1)}}catch(i){return console.warn(`[SettingsManager] Failed to set setting ${String(e)}:`,i),!1}}getAllSettings(){return{artisticMode:this.get("artisticMode")||"artist-vision",paletteSystem:this.get("paletteSystem")||"catppuccin",gradientIntensity:this.get("gradientIntensity")||"balanced",webglEnabled:this.get("webglEnabled")??!0,animationQuality:this.get("animationQuality")||"auto"}}validateAndRepair(){console.log("[SettingsManager] Settings validation handled by typed system")}resetAllToDefaults(){try{A.set("sn-artistic-mode","artist-vision"),A.set("sn-palette-system","catppuccin"),A.set("sn-gradient-intensity","balanced"),A.set("sn-webgl-enabled",!0),A.set("sn-animation-quality","auto"),console.log("[SettingsManager] Reset all settings to defaults")}catch(e){console.warn("[SettingsManager] Failed to reset settings:",e)}}getCurrentHarmonicMode(){let e=A.get("sn-artistic-mode")||"artist-vision",i={"artist-vision":"analogous-flow","cosmic-maximum":"triadic-balance","corporate-safe":"monochromatic-smooth"}[String(e)]||"analogous-flow";return ve[i]||ve["analogous-flow"]}getHarmonicMode(e){return ve[e]}}});var mi,Ln=y(()=>{"use strict";U();$();ue();x();be();X();mi=class{constructor(){this.utils=D;this.config=E;this.cssController=null;this.depthState={containerElement:null,backgroundContainer:null,depthLayers:new Map,animationFrameId:null,lastAnimationTime:0,scrollY:0,scrollX:0,lastUpdateTime:0,isInitialized:!1,stylesInjected:!1};this.depthSettings={enabled:!0,layerCount:6,maxDepth:1e3,parallaxStrength:.5,depthFogIntensity:.7,infiniteScrolling:!0,qualityLevel:"medium",performanceMode:!1,musicResponsiveness:1};this.performanceMetrics={totalLayers:0,visibleLayers:0,averageDepth:0,parallaxRange:0,renderTime:0,memoryUsage:0};this.layerTemplates={cosmic:{animation:"cosmic-drift",duration:"120s",baseGradient:"radial-gradient(ellipse at center, {primary} 0%, {secondary} 50%, {base} 100%)"},nebula:{animation:"nebula-flow",duration:"180s",baseGradient:"conic-gradient(from 45deg, {primary} 0%, {secondary} 25%, {tertiary} 50%, {quaternary} 75%, {primary} 100%)"},stellar:{animation:"stellar-motion",duration:"240s",baseGradient:"linear-gradient(45deg, {primary} 0%, {secondary} 25%, {tertiary} 50%, {quaternary} 75%, {primary} 100%)"},quantum:{animation:"quantum-field",duration:"300s",baseGradient:"radial-gradient(circle at 30% 70%, {primary} 0%, transparent 50%), radial-gradient(circle at 70% 30%, {secondary} 0%, transparent 50%)"},dimensional:{animation:"dimensional-shift",duration:"360s",baseGradient:"linear-gradient(135deg, {primary} 0%, {secondary} 20%, {tertiary} 40%, {quaternary} 60%, {primary} 80%, {secondary} 100%)"},void:{animation:"void-expansion",duration:"480s",baseGradient:"radial-gradient(ellipse at center, {base} 0%, {secondary} 30%, {primary} 60%, transparent 100%)"}};this.boundScrollHandler=null;this.boundResizeHandler=null;this.deviceDetector=new N,this.cssController=P(),this.loadDepthSettings(),this.adaptToDeviceCapabilities(),this.boundScrollHandler=this.handleScroll.bind(this),this.boundResizeHandler=this.handleResize.bind(this),u?.debug?.log("DepthLayeredStrategy","Depth layered strategy initialized",{layerCount:this.depthSettings.layerCount,qualityLevel:this.depthSettings.qualityLevel,deviceCapability:this.deviceDetector.recommendPerformanceQuality()})}getStrategyName(){return"depth-layered"}canProcess(e){return this.depthSettings.enabled}getEstimatedProcessingTime(e){let i=this.depthSettings.layerCount/6,a=this.depthSettings.qualityLevel==="high"?1.3:this.depthSettings.qualityLevel==="low"?.7:1;return Math.round(15*i*a)}async processColors(e){let t=performance.now();try{this.depthState.isInitialized||await this.initializeDepthSystem();let i=this.extractDepthColors(e.rawColors);await this.updateDepthLayers(i),this.depthState.animationFrameId||this.startDepthAnimation(),e.musicData?.energy!==void 0&&this.updateDepthWithMusicEnergy(e.musicData.energy),this.depthState.lastUpdateTime=Date.now(),this.updatePerformanceMetrics();let a=performance.now()-t,r={processedColors:{depthLayers:this.depthState.depthLayers.size.toString(),depthEnabled:this.depthSettings.enabled.toString(),qualityLevel:this.depthSettings.qualityLevel,...e.rawColors},accentHex:this.selectPrimaryColor(e.rawColors)||"#cba6f7",accentRgb:this.convertToRgbString(this.selectPrimaryColor(e.rawColors)||"#cba6f7"),metadata:{strategy:this.getStrategyName(),processingTime:a,cacheKey:`depth-layered-${e.trackUri}`,harmonicIntensity:this.depthSettings.parallaxStrength,layerCount:this.depthState.depthLayers.size},context:e};return u?.debug?.log("DepthLayeredStrategy","Depth layered processing completed",{layerCount:this.depthState.depthLayers.size,processingTime:a,trackUri:e.trackUri}),r}catch(i){let a=performance.now()-t;return u?.debug?.error("DepthLayeredStrategy","Depth layered processing failed:",i),{processedColors:e.rawColors,accentHex:this.selectPrimaryColor(e.rawColors)||"#cba6f7",accentRgb:this.convertToRgbString(this.selectPrimaryColor(e.rawColors)||"#cba6f7"),metadata:{strategy:this.getStrategyName(),processingTime:a,error:i instanceof Error?i.message:"Unknown error"},context:e}}}loadDepthSettings(){try{let e=A.get("sn-gradient-intensity");if(e){let i=e==="intense"?"high":e==="balanced"?"medium":e==="minimal"?"low":"medium";this.depthSettings.qualityLevel=i,this.adjustQualitySettings()}let t=e!=="disabled";t!==void 0&&(this.depthSettings.enabled=t)}catch(e){u?.debug?.warn("DepthLayeredStrategy","Failed to load settings:",e)}}adaptToDeviceCapabilities(){switch(this.deviceDetector.recommendPerformanceQuality()){case"low":this.depthSettings.qualityLevel="low",this.depthSettings.layerCount=3,this.depthSettings.performanceMode=!0,this.depthSettings.parallaxStrength=.3,this.depthSettings.depthFogIntensity=.5;break;case"balanced":this.depthSettings.qualityLevel="medium",this.depthSettings.layerCount=6,this.depthSettings.performanceMode=!1,this.depthSettings.parallaxStrength=.5,this.depthSettings.depthFogIntensity=.7;break;case"high":this.depthSettings.qualityLevel="high",this.depthSettings.layerCount=9,this.depthSettings.performanceMode=!1,this.depthSettings.parallaxStrength=.8,this.depthSettings.depthFogIntensity=.9;break}}adjustQualitySettings(){switch(this.depthSettings.qualityLevel){case"low":this.depthSettings.layerCount=3,this.depthSettings.parallaxStrength=.3,this.depthSettings.depthFogIntensity=.5;break;case"medium":this.depthSettings.layerCount=6,this.depthSettings.parallaxStrength=.5,this.depthSettings.depthFogIntensity=.7;break;case"high":this.depthSettings.layerCount=9,this.depthSettings.parallaxStrength=.8,this.depthSettings.depthFogIntensity=.9;break}}async initializeDepthSystem(){this.createContainerElements(),this.injectDepthAnimations(),this.setupEventListeners(),this.depthState.isInitialized=!0,u?.debug?.log("DepthLayeredStrategy","Depth system initialized successfully")}createContainerElements(){this.depthState.containerElement=document.querySelector(".Root__main-view")||document.querySelector(".main-view-container")||document.body,this.depthState.backgroundContainer=document.createElement("div"),this.depthState.backgroundContainer.className="sn-depth-background-container",this.depthState.backgroundContainer.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -20;
      pointer-events: none;
      overflow: hidden;
      perspective: 1000px;
      transform-style: preserve-3d;
    `,this.depthState.containerElement.insertBefore(this.depthState.backgroundContainer,this.depthState.containerElement.firstChild)}injectDepthAnimations(){if(this.depthState.stylesInjected)return;let e=document.createElement("style");e.textContent=`
      .sn-depth-layer {
        position: absolute;
        width: 120%;
        height: 120%;
        top: -10%;
        left: -10%;
        pointer-events: none;
        transform-style: preserve-3d;
        will-change: transform, opacity;
      }

      @keyframes cosmic-drift {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        25% { transform: translate3d(-2%, 1%, 0) rotate(0.5deg) scale(1.02); }
        50% { transform: translate3d(0, -1%, 0) rotate(0deg) scale(0.98); }
        75% { transform: translate3d(2%, 0.5%, 0) rotate(-0.5deg) scale(1.01); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes nebula-flow {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        33% { transform: translate3d(1%, -1%, 0) rotate(1deg) scale(1.03); }
        66% { transform: translate3d(-1%, 1%, 0) rotate(-1deg) scale(0.97); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes stellar-motion {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        20% { transform: translate3d(-1%, 0.5%, 0) rotate(0.3deg) scale(1.01); }
        40% { transform: translate3d(0.5%, -0.5%, 0) rotate(-0.3deg) scale(0.99); }
        60% { transform: translate3d(1%, 0.5%, 0) rotate(0.2deg) scale(1.02); }
        80% { transform: translate3d(-0.5%, 1%, 0) rotate(-0.2deg) scale(0.98); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes quantum-field {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); filter: blur(0px); }
        25% { transform: translate3d(0.5%, -0.5%, 0) rotate(0.1deg) scale(1.01); filter: blur(0.5px); }
        50% { transform: translate3d(-0.5%, 0.5%, 0) rotate(-0.1deg) scale(0.99); filter: blur(1px); }
        75% { transform: translate3d(0.3%, 0.3%, 0) rotate(0.05deg) scale(1.005); filter: blur(0.3px); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); filter: blur(0px); }
      }

      @keyframes dimensional-shift {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        16% { transform: translate3d(0.2%, -0.2%, 0) rotate(0.1deg) scale(1.005); }
        32% { transform: translate3d(-0.2%, 0.2%, 0) rotate(-0.1deg) scale(0.995); }
        48% { transform: translate3d(0.1%, 0.1%, 0) rotate(0.05deg) scale(1.002); }
        64% { transform: translate3d(-0.1%, -0.1%, 0) rotate(-0.05deg) scale(0.998); }
        80% { transform: translate3d(0.15%, 0%, 0) rotate(0.02deg) scale(1.001); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes void-expansion {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.9; }
        50% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1.1); opacity: 0.6; }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.9; }
      }

      @media (prefers-reduced-motion: reduce) {
        .sn-depth-layer {
          animation: none !important;
        }
      }
    `,document.head.appendChild(e),this.depthState.stylesInjected=!0}setupEventListeners(){this.boundScrollHandler&&window.addEventListener("scroll",this.boundScrollHandler,{passive:!0}),this.boundResizeHandler&&window.addEventListener("resize",this.boundResizeHandler,{passive:!0})}extractDepthColors(e){let t=["PRIMARY","VIBRANT","LIGHT_VIBRANT","DARK_VIBRANT","VIBRANT_NON_ALARMING","PROMINENT","SECONDARY","DESATURATED"],i=[],a=new Set;for(let r of t){let n=e[r];if(n&&!a.has(n)&&this.utils.hexToRgb(n)&&(i.push(n),a.add(n),i.length>=this.depthSettings.layerCount))break}for(;i.length<this.depthSettings.layerCount;){let r=i[0]||"#cba6f7",n=this.createColorVariation(r,i.length);i.push(n)}return i}createColorVariation(e,t){let i=this.utils.hexToRgb(e);if(!i)return e;let a=.8-t*.1,r=Math.round(i.r*a),n=Math.round(i.g*a),s=Math.round(i.b*a);return this.utils.rgbToHex(r,n,s)}async updateDepthLayers(e){if(!this.depthState.backgroundContainer)return;this.depthState.depthLayers.forEach(i=>{i.element.parentNode&&i.element.parentNode.removeChild(i.element)}),this.depthState.depthLayers.clear();let t=Object.keys(this.layerTemplates);for(let i=0;i<this.depthSettings.layerCount;i++){let a=(i+1)*(this.depthSettings.maxDepth/this.depthSettings.layerCount),r=t[i%t.length],n=this.layerTemplates[r],s=document.createElement("div");s.className="sn-depth-layer",s.id=`sn-depth-layer-${i}`;let o=a/this.depthSettings.maxDepth,l=1-o*this.depthSettings.parallaxStrength,m=1-o*this.depthSettings.depthFogIntensity,d=1+o*.2,h=o*3,g=this.createDepthGradient(n.baseGradient,e,i);s.style.cssText=`
        background: ${g};
        transform: translate3d(0, 0, ${-a}px) scale(${d});
        opacity: ${m};
        filter: blur(${h}px);
        animation: ${n.animation} ${n.duration} ease-in-out infinite;
        animation-delay: ${i*.5}s;
      `;let f={id:`depth-layer-${i}`,element:s,depth:a,parallaxFactor:l,opacityRange:[m*.5,m],scaleRange:[d*.95,d*1.05],rotationSpeed:.01+i*.001,colorShift:i*30,blurAmount:h,animationPhase:i*Math.PI/4,enabled:!0,gradientColors:e.slice(i,i+4)};this.depthState.depthLayers.set(f.id,f),this.depthState.backgroundContainer.appendChild(s)}u?.debug?.log("DepthLayeredStrategy",`Updated ${this.depthState.depthLayers.size} depth layers with new colors`)}createDepthGradient(e,t,i){let a=t.length,r=i%a,n=(i+1)%a,s=(i+2)%a,o=(i+3)%a,m=.8-i/this.depthSettings.layerCount*.6,d=this.convertToRgba(t[r]||"#cba6f7",m),h=this.convertToRgba(t[n]||"#f5c2e7",m*.7),g=this.convertToRgba(t[s]||"#fab387",m*.5),f=this.convertToRgba(t[o]||"#a6e3a1",m*.3),S=this.convertToRgba("#1e1e2e",m*.9);return e.replace(/\{primary\}/g,d).replace(/\{secondary\}/g,h).replace(/\{tertiary\}/g,g).replace(/\{quaternary\}/g,f).replace(/\{base\}/g,S)}convertToRgba(e,t){let i=this.utils.hexToRgb(e);return i?`rgba(${i.r}, ${i.g}, ${i.b}, ${t})`:`rgba(203, 166, 247, ${t})`}startDepthAnimation(){this.depthState.lastAnimationTime=performance.now();let e=()=>{if(!this.depthState.isInitialized)return;let t=performance.now(),i=t-this.depthState.lastAnimationTime;if(i<33){this.depthState.animationFrameId=requestAnimationFrame(e);return}this.depthState.lastAnimationTime=t,this.updateDepthAnimations(i),this.updatePerformanceMetrics(),this.depthState.animationFrameId=requestAnimationFrame(e)};this.depthState.animationFrameId=requestAnimationFrame(e)}updateDepthAnimations(e){this.depthState.depthLayers.forEach(t=>{t.animationPhase+=t.rotationSpeed*e*.001;let i=Math.sin(t.animationPhase)*.05,r=parseFloat(t.element.style.opacity)+i;t.element.style.opacity=Math.max(0,Math.min(1,r)).toString()})}updateDepthWithMusicEnergy(e){let t=e*this.depthSettings.musicResponsiveness*.3;this.depthState.depthLayers.forEach(i=>{let a=i.opacityRange[0],r=i.opacityRange[1],n=a+t*(r-a);i.element.style.opacity=Math.max(0,Math.min(1,n)).toString()})}handleScroll(e){this.depthSettings.infiniteScrolling&&(this.depthState.scrollY=window.scrollY,this.depthState.scrollX=window.scrollX,this.updateParallaxEffects())}handleResize(e){this.updateLayerDimensions()}updateParallaxEffects(){this.depthState.depthLayers.forEach(e=>{let t=this.depthState.scrollY*e.parallaxFactor,i=this.depthState.scrollX*e.parallaxFactor*.5,r=e.element.style.transform.replace(/translate3d\([^)]*\)/,`translate3d(${i}px, ${t}px, ${-e.depth}px)`);e.element.style.transform=r})}updateLayerDimensions(){this.depthState.depthLayers.forEach(e=>{let i=1+e.depth/this.depthSettings.maxDepth*.2,r=e.element.style.transform.replace(/scale\([^)]*\)/,`scale(${i})`);e.element.style.transform=r})}updatePerformanceMetrics(){this.performanceMetrics.totalLayers=this.depthState.depthLayers.size,this.performanceMetrics.visibleLayers=Array.from(this.depthState.depthLayers.values()).filter(e=>parseFloat(e.element.style.opacity)>.01).length,this.performanceMetrics.averageDepth=Array.from(this.depthState.depthLayers.values()).reduce((e,t)=>e+t.depth,0)/this.depthState.depthLayers.size,this.performanceMetrics.parallaxRange=this.depthSettings.parallaxStrength,this.performanceMetrics.renderTime=performance.now()-this.depthState.lastAnimationTime,this.cssController&&(this.cssController.queueCSSVariableUpdate("--sn-depth-layers-total",this.performanceMetrics.totalLayers.toString()),this.cssController.queueCSSVariableUpdate("--sn-depth-layers-visible",this.performanceMetrics.visibleLayers.toString()))}selectPrimaryColor(e){let t=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let i of t){let a=e[i];if(a&&this.utils.hexToRgb(a))return a}return null}convertToRgbString(e){let t=this.utils.hexToRgb(e);return t?`${t.r},${t.g},${t.b}`:"203,166,247"}updateConfig(e){this.depthSettings={...this.depthSettings,...e},e.qualityLevel&&this.adjustQualitySettings(),u?.debug?.log("DepthLayeredStrategy","Configuration updated:",e)}async healthCheck(){let e=Date.now()-this.depthState.lastUpdateTime<3e4;return{healthy:this.depthState.isInitialized&&this.depthSettings.enabled,canProcess:this.canProcess({}),issues:this.depthState.isInitialized?this.depthSettings.enabled?[]:["Depth layers disabled in settings"]:["Depth system not initialized"],metrics:{isInitialized:this.depthState.isInitialized,depthEnabled:this.depthSettings.enabled,layerCount:this.depthState.depthLayers.size,qualityLevel:this.depthSettings.qualityLevel,parallaxStrength:this.depthSettings.parallaxStrength,hasRecentUpdate:e,animationActive:this.depthState.animationFrameId!==null,performanceMetrics:this.performanceMetrics}}}destroy(){this.depthState.animationFrameId&&(cancelAnimationFrame(this.depthState.animationFrameId),this.depthState.animationFrameId=null),this.boundScrollHandler&&(window.removeEventListener("scroll",this.boundScrollHandler),this.boundScrollHandler=null),this.boundResizeHandler&&(window.removeEventListener("resize",this.boundResizeHandler),this.boundResizeHandler=null),this.depthState.depthLayers.forEach(e=>{e.element.parentNode&&e.element.parentNode.removeChild(e.element)}),this.depthState.depthLayers.clear(),this.depthState.backgroundContainer&&this.depthState.backgroundContainer.parentNode&&(this.depthState.backgroundContainer.parentNode.removeChild(this.depthState.backgroundContainer),this.depthState.backgroundContainer=null),this.depthState.isInitialized=!1,this.depthState.containerElement=null,u?.debug?.log("DepthLayeredStrategy","Depth layered strategy destroyed")}}});var di,Rn=y(()=>{"use strict";U();$();x();be();ae();Ct();X();di=class{constructor(e){this.utils=D;this.config=E;this.dynamicColorState=this.getInitialColorState();this.integrationConfig={accentUpdateEnabled:!0,baseTransformationEnabled:!0,visualEffectsIntegrationEnabled:!0,oklabEnhancementEnabled:!0,smoothTransitionDuration:800,energyResponseMultiplier:1.2,oklabPreset:"VIBRANT"};this.transitionTimer=0;this.lastTransitionStartTime=0;this.transitionFromAccent="";this.transitionToAccent="";this.cssController=e||P(),this.oklabProcessor=new M(this.config.enableDebug),this.initializeCurrentState(),u?.debug?.log("DynamicCatppuccinStrategy","Color strategy initialized with CSS coordinator and OKLAB processing")}getInitialColorState(){try{let e=K.getDefaultAccentColor(),t=K.getBrightnessAdjustedBaseColor();return{currentAccentHex:e.hex,currentAccentRgb:e.rgb,baseBackgroundHex:t.hex,baseBackgroundRgb:t.rgb,lastUpdateTime:0,musicEnergy:.5,transitionInProgress:!1}}catch(e){return console.warn("[DynamicCatppuccinStrategy] Failed to get initial colors, using fallback:",e),{currentAccentHex:"#7c3aed",currentAccentRgb:"124,58,237",baseBackgroundHex:"#0d1117",baseBackgroundRgb:"13,17,23",lastUpdateTime:0,musicEnergy:.5,transitionInProgress:!1}}}getStrategyName(){return"dynamic-catppuccin"}canProcess(e){return this.checkDynamicAccentEnabled()}getEstimatedProcessingTime(e){return 5}async processColors(e){let t=performance.now();try{let i=this.selectBestAccentColor(e.rawColors);if(!i)throw new Error("No suitable accent color found in extracted colors");let a=i,r=this.utils.hexToRgb(i),n=null;if(this.integrationConfig.oklabEnhancementEnabled){let l=M.getPreset(this.integrationConfig.oklabPreset);n=this.oklabProcessor.processColor(i,l),a=n.enhancedHex,r=n.enhancedRgb,u?.debug?.log("DynamicCatppuccinStrategy","OKLAB color enhancement applied:",{original:i,enhanced:a,preset:l.name,processingTime:`${n.processingTime.toFixed(2)}ms`})}await this.applyColorFacade(a,e.rawColors,n),this.dynamicColorState.currentAccentHex=a,r&&(this.dynamicColorState.currentAccentRgb=`${r.r},${r.g},${r.b}`),this.dynamicColorState.lastUpdateTime=Date.now(),e.musicData?.energy!==void 0&&(this.dynamicColorState.musicEnergy=e.musicData.energy,await this.updateVisualEffectsWithMusicEnergy(e.musicData.energy));let s=performance.now()-t,o={processedColors:{accent:a,primary:a,originalAccent:i,...e.rawColors},accentHex:a,accentRgb:this.dynamicColorState.currentAccentRgb,metadata:{strategy:this.getStrategyName(),processingTime:s,cacheKey:`dynamic-catppuccin-${e.trackUri}`,harmonicIntensity:this.integrationConfig.energyResponseMultiplier,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,oklabPreset:this.integrationConfig.oklabPreset,...n&&{oklabMetadata:{originalHex:n.originalHex,enhancedHex:n.enhancedHex,shadowHex:n.shadowHex,oklabProcessingTime:n.processingTime}}},context:e};return u?.debug?.log("DynamicCatppuccinStrategy","Color processing completed",{originalAccent:i,processedAccent:a,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,processingTime:s,trackUri:e.trackUri}),o}catch(i){let a=performance.now()-t;return u?.debug?.error("DynamicCatppuccinStrategy","Color processing failed:",i),{processedColors:e.rawColors,accentHex:this.dynamicColorState.currentAccentHex,accentRgb:this.dynamicColorState.currentAccentRgb,metadata:{strategy:this.getStrategyName(),processingTime:a,error:i instanceof Error?i.message:"Unknown error"},context:e}}}checkDynamicAccentEnabled(){try{let e=A.get("catppuccin-accentColor"),t=String(e)==="dynamic";return this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinStrategy",`Accent setting: ${e}, Dynamic: ${t}`),t}catch(e){return u?.debug?.error("DynamicCatppuccinStrategy","Error checking dynamic accent setting:",e),!1}}initializeCurrentState(){let e=document.documentElement,t=getComputedStyle(e),i=t.getPropertyValue("--spice-accent").trim()||t.getPropertyValue("--sn-color-accent-hex").trim();if(i){this.dynamicColorState.currentAccentHex=i;let n=this.utils.hexToRgb(i);n&&(this.dynamicColorState.currentAccentRgb=`${n.r},${n.g},${n.b}`)}let a=t.getPropertyValue("--spice-base").trim()||"#1e1e2e";this.dynamicColorState.baseBackgroundHex=a;let r=this.utils.hexToRgb(a);r&&(this.dynamicColorState.baseBackgroundRgb=`${r.r},${r.g},${r.b}`),this.dynamicColorState.lastUpdateTime=Date.now(),u?.debug?.log("DynamicCatppuccinStrategy","Current state initialized:",{accent:this.dynamicColorState.currentAccentHex,base:this.dynamicColorState.baseBackgroundHex})}selectBestAccentColor(e){let t=["VIBRANT_NON_ALARMING","VIBRANT","LIGHT_VIBRANT","PROMINENT","PRIMARY","DARK_VIBRANT"];for(let i of t){let a=e[i];if(a&&this.utils.hexToRgb(a))return a}return null}async applyColorFacade(e,t,i){let a=this.utils.hexToRgb(e);if(!a)return;let r=`${a.r},${a.g},${a.b}`,n={"--sn-dynamic-accent-hex":e,"--sn-dynamic-accent-rgb":r,"--sn-dynamic-primary-hex":e,"--sn-dynamic-primary-rgb":r,"--spice-accent":e,"--spice-button":e,"--spice-button-active":e,"--spice-rgb-accent":r,"--spice-rgb-button":r,"--sn-color-extracted-primary-rgb":r,"--sn-color-extracted-vibrant-rgb":r,"--sn-color-extracted-dominant-rgb":r};if(i&&this.integrationConfig.oklabEnhancementEnabled){let o=this.oklabProcessor.generateCSSVariables(i,"sn-oklab-accent");Object.assign(n,{...o,"--sn-dynamic-shadow-hex":i.shadowHex,"--sn-dynamic-shadow-rgb":`${i.shadowRgb.r},${i.shadowRgb.g},${i.shadowRgb.b}`,"--sn-accent-oklch-l":i.oklchEnhanced.L.toFixed(3),"--sn-accent-oklch-c":i.oklchEnhanced.C.toFixed(3),"--sn-accent-oklch-h":i.oklchEnhanced.H.toFixed(1)}),u?.debug?.log("DynamicCatppuccinStrategy","Added OKLAB-enhanced CSS variables:",{oklabVarsCount:Object.keys(o).length,enhancedHex:i.enhancedHex,shadowHex:i.shadowHex})}this.cssController&&this.cssController.updateVariables(n,"high","core-spicetify-facade");let s=t.PRIMARY||t.VIBRANT;s&&await this.updateLivingBaseBackground(s),this.integrationConfig.visualEffectsIntegrationEnabled&&await this.updateVisualEffectsWithAccent(e,r),u?.debug?.log("DynamicCatppuccinStrategy",`Applied coordinated color facade - Spicetify: ${e}, Visual-effects extensions updated`,{oklabProcessing:!!i,variableCount:Object.keys(n).length})}async updateLivingBaseBackground(e){let t=this.utils.hexToRgb(e);if(!t)return;let i=`${t.r},${t.g},${t.b}`,a=`
      linear-gradient(135deg,
        var(--spice-base) 0%,
        rgba(${i}, 0.08) 30%,
        var(--spice-base) 70%
      ),
      var(--spice-base)
    `,r={"--sn-dynamic-secondary-hex":e,"--sn-dynamic-secondary-rgb":i,"--sn-color-extracted-secondary-rgb":i,"--sn-color-harmony-complementary-rgb":i,"--living-base-gradient":a,"--visual-effects-base-gradient":a};this.cssController&&this.cssController.updateVariables(r,"normal","living-base-background"),u?.debug?.log("DynamicCatppuccinStrategy",`Coordinated living base facade updated - Primary: ${e}, preserving --spice-base`)}async updateVisualEffectsWithAccent(e,t){let i={"--sn-holographic-rgb":t,"--holographic-scanline-rgb":t,"--visual-effects-intensity":`calc(0.5 + var(--musical-sync-intensity) * ${this.integrationConfig.energyResponseMultiplier})`};this.cssController&&this.cssController.updateVariables(i,"normal","visual-effects-accent-integration")}async updateVisualEffectsWithMusicEnergy(e){let t=e*this.integrationConfig.energyResponseMultiplier,a=Math.max(.1,Math.min(1,.5+t*.3)),r={"--musical-sync-intensity":t.toString(),"--holographic-music-flicker-intensity":t.toString(),"--visual-effects-intensity":a.toString()};this.cssController&&(this.cssController.updateVariables(r,"high","visual-effects-music-energy"),this.cssController.updateVisualEffectsIntensity(parseFloat(a.toString()),"DynamicCatppuccinStrategy",t))}getDynamicColorState(){return{...this.dynamicColorState}}updateConfig(e){this.integrationConfig={...this.integrationConfig,...e},("oklabEnhancementEnabled"in e||"oklabPreset"in e)&&(this.oklabProcessor=new M(this.config.enableDebug)),u?.debug?.log("DynamicCatppuccinStrategy","Configuration updated:",{...e,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,oklabPreset:this.integrationConfig.oklabPreset})}async healthCheck(){let e=this.checkDynamicAccentEnabled(),t=Date.now()-this.dynamicColorState.lastUpdateTime<3e4;return{healthy:e,canProcess:e,issues:e?[]:["Dynamic accent not enabled in settings"],metrics:{dynamicAccentEnabled:e,currentAccent:this.dynamicColorState.currentAccentHex,lastUpdateAge:Date.now()-this.dynamicColorState.lastUpdateTime,hasRecentUpdate:t,transitionInProgress:this.dynamicColorState.transitionInProgress,musicEnergy:this.dynamicColorState.musicEnergy,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,oklabPreset:this.integrationConfig.oklabPreset,visualEffectsIntegration:this.integrationConfig.visualEffectsIntegrationEnabled}}}destroy(){this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=0),this.dynamicColorState.transitionInProgress=!1,u?.debug?.log("DynamicCatppuccinStrategy","Dynamic Catppuccin strategy destroyed")}}});var Bn={};ie(Bn,{LivingGradientStrategy:()=>Et});var Et,La=y(()=>{"use strict";U();$();L();ue();x();ae();X();de();Et=class extends j{constructor(t=E,i=D,a=null,r=null,n,s){super(t,i,a,r,null);this.utils=D;this.config=E;this.livingBaseState={currentBaseHex:"#1e1e2e",currentBaseRgb:"30,30,46",currentPrimaryHex:"#cba6f7",currentPrimaryRgb:"203,166,247",visualEffectsIntensity:.5,musicEnergy:.5,lastUpdateTime:0,webglIntegrationActive:!1,oklabGradientStops:[]};this.gradientConfig={baseTransformationEnabled:!0,webglIntegrationEnabled:!0,animationAnimationEnabled:!0,visualEffectsLayerOpacity:.08,dynamicFlowIntensity:1.2,musicResponsiveness:1,oklabInterpolationEnabled:!0,oklabPreset:"STANDARD",gradientSmoothness:.8,animationThrottleFps:30,enablePerformanceBudget:!0,maxFrameTimeMs:16};this.cssAnimationManager=null;this.oklabCache=new Map;this.gradientCache=new Map;this.cacheValidityMs=5e3;this.lastCacheCleanup=0;this.musicEventDebounceTimers={musicState:0,harmonizedColors:0,webglState:0,visualEffectsIntensity:0};this.eventDebounceMs=100;this.cssController=n||P(),this.oklabProcessor=new M(this.config.enableDebug),this.deviceDetector=new N,this.cssAnimationManager=s,this.initializeBaseState(),this.applyDeviceAwareSettings().catch(o=>{u?.debug?.warn("LivingGradientStrategy","Failed to apply device-aware settings:",o)}),u?.debug?.log("LivingGradientStrategy","Living gradient strategy initialized with OKLAB interpolation and device-aware performance")}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{this.setupConsciousnessListeners(),this.setupWebGLIntegrationListeners(),this.initializeBaseState(),this.initializeConsciousnessBreathing(),await this.applyLivingConsciousnessBase(),u?.debug?.log("LivingGradientStrategy","Living gradient system awakened with visual system lifecycle")}catch(t){u?.debug?.error("LivingGradientStrategy","Failed to initialize living gradient system:",t)}}setupConsciousnessListeners(){typeof p<"u"&&p.subscribe("colors:harmonized",t=>{t&&t.processedColors&&this.handleHarmonizedColorUpdate(t.processedColors)},"LivingGradientStrategy"),document.addEventListener("music-state-change",t=>{let i=t;i.detail&&this.handleMusicStateChange(i.detail)}),document.addEventListener("visualEffects-intensity-change",t=>{let i=t;i.detail&&typeof i.detail.intensity=="number"&&this.updateConsciousnessIntensity(i.detail.intensity)}),u?.debug?.log("LivingGradientStrategy","Consciousness listeners established")}setupWebGLIntegrationListeners(){document.addEventListener("webgl-state-change",t=>{let i=t;i.detail&&this.handleWebGLStateChange(i.detail)}),document.addEventListener("webgl-gradient-update",t=>{let i=t;i.detail&&this.coordinateWithWebGLGradient(i.detail)}),u?.debug?.log("LivingGradientStrategy","WebGL integration listeners established")}handleHarmonizedColorUpdate(t){this.debouncedEventHandler("harmonizedColors",()=>{let i=t.VIBRANT||t.PRIMARY||t.PROMINENT;if(i&&i!==this.livingBaseState.currentPrimaryHex){this.livingBaseState.currentPrimaryHex=i;let a=this.utils.hexToRgb(i);a&&(this.livingBaseState.currentPrimaryRgb=`${a.r},${a.g},${a.b}`),this.updateLivingConsciousnessBase(),this.triggerConsciousnessBreathing(),u?.debug?.log("LivingGradientStrategy","Living base updated with harmonized colors:",i)}})}handleMusicStateChange(t){this.debouncedEventHandler("musicState",()=>{if(t.energy!==void 0){this.livingBaseState.musicEnergy=t.energy;let i=.5,a=t.energy*this.gradientConfig.musicResponsiveness;this.livingBaseState.visualEffectsIntensity=Math.max(.1,Math.min(1,i+a*.3)),this.updateMusicResponsiveVariables()}})}handleWebGLStateChange(t){this.debouncedEventHandler("webglState",()=>{t.enabled!==void 0&&(this.livingBaseState.webglIntegrationActive=t.enabled,this.coordinateWithWebGLSystem(t.enabled),u?.debug?.log("LivingGradientStrategy",`WebGL integration ${t.enabled?"activated":"deactivated"}`))})}updateConsciousnessIntensity(t){this.debouncedEventHandler("visualEffectsIntensity",()=>{this.livingBaseState.visualEffectsIntensity=Math.max(0,Math.min(1,t)),this.updateConsciousnessVariables()})}debouncedEventHandler(t,i){let a=performance.now();a-this.musicEventDebounceTimers[t]>=this.eventDebounceMs&&(i(),this.musicEventDebounceTimers[t]=a)}initializeConsciousnessBreathing(){if(this.gradientConfig.animationAnimationEnabled){if(!this.cssAnimationManager){u?.debug?.warn("LivingGradientStrategy","CSSAnimationManager not available, falling back to basic visualEffects");return}this.triggerConsciousnessBreathing(),u?.debug?.log("LivingGradientStrategy","CSS-first visualEffects animation initialized")}}triggerConsciousnessBreathing(){if(!this.cssAnimationManager||!this.gradientConfig.animationAnimationEnabled)return;let t=document.querySelectorAll(".Root__main-view::before, .Root__main-view, [data-visualEffects-animation]");if(t.length===0){let i=document.querySelector(".Root__main-view")||document.body;i&&(i.setAttribute("data-visualEffects-animation","true"),this.cssAnimationManager.triggerConsciousnessBreathing([i],this.livingBaseState.musicEnergy,120))}else this.cssAnimationManager.triggerConsciousnessBreathing(t,this.livingBaseState.musicEnergy,120);u?.debug?.log("LivingGradientStrategy",`CSS-first visualEffects animation triggered for ${t.length} elements`)}async applyDeviceAwareSettings(){if(!this.deviceDetector.isInitialized)try{await this.deviceDetector.initialize()}catch(a){u?.debug?.warn("LivingGradientStrategy","Device detection failed, using default settings:",a);return}let t=this.deviceDetector.getCapabilities();if(!t){u?.debug?.warn("LivingGradientStrategy","No device capabilities available, using default settings");return}let i=t.overall;switch(i){case"high":this.gradientConfig.animationThrottleFps=30,this.gradientConfig.maxFrameTimeMs=16,this.gradientConfig.enablePerformanceBudget=!0;break;case"medium":this.gradientConfig.animationThrottleFps=20,this.gradientConfig.maxFrameTimeMs=20,this.gradientConfig.enablePerformanceBudget=!0;break;case"low":this.gradientConfig.animationThrottleFps=15,this.gradientConfig.maxFrameTimeMs=33,this.gradientConfig.enablePerformanceBudget=!0,this.gradientConfig.visualEffectsLayerOpacity*=.7,this.gradientConfig.dynamicFlowIntensity*=.8,this.gradientConfig.oklabInterpolationEnabled=!1;break;default:this.gradientConfig.animationThrottleFps=20,this.gradientConfig.maxFrameTimeMs=20;break}t.gpu.supportsWebGL||(this.gradientConfig.webglIntegrationEnabled=!1),t.memory.level==="low"&&(this.cacheValidityMs=2e3),t.cpu.cores<=2&&(this.gradientConfig.animationThrottleFps=Math.min(this.gradientConfig.animationThrottleFps,15)),t.display.reducedMotion&&(this.gradientConfig.animationAnimationEnabled=!1,u?.debug?.log("LivingGradientStrategy","Breathing animation disabled due to reduced motion preference")),u?.debug?.log("LivingGradientStrategy",`Device-aware settings applied for ${i}: ${this.gradientConfig.animationThrottleFps}fps, CSS-first animation coordination`)}getStrategyName(){return"living-gradient"}canProcess(t){return this.gradientConfig.baseTransformationEnabled}getEstimatedProcessingTime(t){return 8}async processColors(t){let i=performance.now();try{let a=this.selectPrimaryColor(t.rawColors),r=this.selectSecondaryColor(t.rawColors);if(!a)throw new Error("No suitable primary color found for living gradient");let n=a,s=r,o=[];if(this.gradientConfig.oklabInterpolationEnabled&&a){let d=M.getPreset(this.gradientConfig.oklabPreset);if(n=this.oklabProcessor.processColor(a,d).enhancedHex,r){s=this.oklabProcessor.processColor(r,d).enhancedHex;let f=Math.ceil(5*this.gradientConfig.gradientSmoothness)+3;o=this.oklabProcessor.generateOKLABGradient(n,s,f,d)}else{let g=this.livingBaseState.currentBaseHex;o=this.oklabProcessor.generateOKLABGradient(n,g,5,d),s=o[o.length-1]?.enhancedHex||n}u?.debug?.log("LivingGradientStrategy","OKLAB gradient processing applied:",{originalPrimary:a,processedPrimary:n,originalSecondary:r,processedSecondary:s,gradientStops:o.length,preset:d.name})}await this.updateLivingBaseState(n,s,t,o),await this.applyLivingConsciousnessBase(),this.triggerConsciousnessBreathing(),await this.updateWebGLIntegration();let l=performance.now()-i,m={processedColors:{primary:n,secondary:s||n,originalPrimary:a,...r&&{originalSecondary:r},livingBase:this.livingBaseState.currentBaseHex,...t.rawColors},accentHex:n,accentRgb:this.livingBaseState.currentPrimaryRgb,metadata:{strategy:this.getStrategyName(),processingTime:l,cacheKey:`living-gradient-${t.trackUri}`,harmonicIntensity:this.gradientConfig.dynamicFlowIntensity,oklabInterpolation:this.gradientConfig.oklabInterpolationEnabled,oklabPreset:this.gradientConfig.oklabPreset,gradientStopCount:o.length,gradientSmoothness:this.gradientConfig.gradientSmoothness},context:t};return u?.debug?.log("LivingGradientStrategy","Living gradient processing completed",{originalPrimary:a,processedPrimary:n,originalSecondary:r,processedSecondary:s,oklabProcessing:this.gradientConfig.oklabInterpolationEnabled,gradientStops:o.length,processingTime:l,trackUri:t.trackUri}),m}catch(a){let r=performance.now()-i;return u?.debug?.error("LivingGradientStrategy","Living gradient processing failed:",a),{processedColors:t.rawColors,accentHex:this.livingBaseState.currentPrimaryHex,accentRgb:this.livingBaseState.currentPrimaryRgb,metadata:{strategy:this.getStrategyName(),processingTime:r,error:a instanceof Error?a.message:"Unknown error"},context:t}}}initializeBaseState(){let t=document.documentElement,i=getComputedStyle(t),a=i.getPropertyValue("--spice-base").trim()||"#1e1e2e";this.livingBaseState.currentBaseHex=a;let r=this.utils.hexToRgb(a);r&&(this.livingBaseState.currentBaseRgb=`${r.r},${r.g},${r.b}`);let n=i.getPropertyValue("--sn-bg-gradient-primary-rgb").trim();if(n){let s=n.split(",").map(o=>parseInt(o.trim()));s.length===3&&(this.livingBaseState.currentPrimaryRgb=n,this.livingBaseState.currentPrimaryHex=this.utils.rgbToHex(s[0],s[1],s[2]))}this.livingBaseState.lastUpdateTime=Date.now(),u?.debug?.log("LivingGradientStrategy","Base state initialized:",{base:this.livingBaseState.currentBaseHex,primary:this.livingBaseState.currentPrimaryHex})}selectPrimaryColor(t){let i=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let a of i){let r=t[a];if(r&&this.utils.hexToRgb(r))return r}return null}selectSecondaryColor(t){let i=["SECONDARY","DARK_VIBRANT","DESATURATED","LIGHT_VIBRANT"];for(let a of i){let r=t[a];if(r&&this.utils.hexToRgb(r))return r}return null}async updateLivingBaseState(t,i,a,r=[]){let n=this.utils.hexToRgb(t);if(n){if(this.livingBaseState.currentPrimaryHex=t,this.livingBaseState.currentPrimaryRgb=`${n.r},${n.g},${n.b}`,this.livingBaseState.oklabGradientStops=r,a.musicData?.energy!==void 0){this.livingBaseState.musicEnergy=a.musicData.energy;let s=this.gradientConfig.visualEffectsLayerOpacity,o=1+a.musicData.energy*this.gradientConfig.musicResponsiveness;this.livingBaseState.visualEffectsIntensity=Math.max(.05,Math.min(1,s*o))}this.livingBaseState.lastUpdateTime=Date.now()}}async applyLivingConsciousnessBase(){let t=this.createLivingGradient(this.livingBaseState.oklabGradientStops),a=performance.now()/4e3*Math.PI*2,r=1+Math.sin(a)*.2,n=this.livingBaseState.visualEffectsIntensity*r,s=Math.sin(a*.7)*this.gradientConfig.dynamicFlowIntensity,o=Math.cos(a*.5)*this.gradientConfig.dynamicFlowIntensity,l=4e3,m=.5+this.livingBaseState.musicEnergy*1.5,d=l/m,h={"--living-base-gradient":t,"--visualEffects-base-gradient":t,"--visualEffects-layer-opacity":n.toString(),"--visualEffects-flow-x":`${s}%`,"--visualEffects-flow-y":`${o}%`,"--visualEffects-animation-duration":`${d}ms`};await this.cssController.batchSetVariables("LivingGradientStrategy",h,"high","living-visualEffects-base"),u?.debug?.log("LivingGradientStrategy","Applied coordinated living visualEffects base gradient")}createGradientCacheKey(t,i,a,r){let n=a.map((s,o)=>`${s.enhancedHex}-${o}`).join("|");return`${t}-${i}-${n}-${Math.floor(r*10)}`}cleanupCache(){let t=Date.now();t-this.lastCacheCleanup<1e4||(this.lastCacheCleanup=t,this.gradientCache.clear(),this.config.enableDebug&&u?.debug?.log("LivingGradientStrategy","Cache cleanup completed"))}createLivingGradient(t=[]){let i=this.livingBaseState.currentPrimaryRgb,a=this.livingBaseState.currentBaseRgb,n=performance.now()/4e3*Math.PI*2,s=this.createGradientCacheKey(i,a,t,n),o=this.gradientCache.get(s);if(o)return this.cleanupCache(),o;let l=this.generateLivingGradient(i,a,t);return this.gradientCache.set(s,l),l}generateLivingGradient(t,i,a){return this.gradientConfig.oklabInterpolationEnabled&&a.length>0?`
        radial-gradient(
          ellipse at calc(50% + var(--visualEffects-flow-x)) calc(50% + var(--visualEffects-flow-y)),
          ${a.map((n,s)=>{let o=s/(a.length-1)*100,l=`${n.enhancedRgb.r},${n.enhancedRgb.g},${n.enhancedRgb.b}`,m=.6*(1-s/a.length)+.1;return`rgba(${l}, calc(var(--visualEffects-layer-opacity) * ${m})) ${o}%`}).join(", ")}
        ),
        linear-gradient(
          135deg,
          rgba(${a[0]?.enhancedRgb.r||t.split(",")[0]},${a[0]?.enhancedRgb.g||t.split(",")[1]},${a[0]?.enhancedRgb.b||t.split(",")[2]}, calc(var(--visualEffects-layer-opacity) * 0.4)) 0%,
          var(--spice-base) 50%,
          rgba(${a[a.length-1]?.enhancedRgb.r||t.split(",")[0]},${a[a.length-1]?.enhancedRgb.g||t.split(",")[1]},${a[a.length-1]?.enhancedRgb.b||t.split(",")[2]}, calc(var(--visualEffects-layer-opacity) * 0.2)) 100%
        ),
        var(--spice-base)
      `:`
      radial-gradient(
        ellipse at calc(50% + var(--visualEffects-flow-x)) calc(50% + var(--visualEffects-flow-y)),
        rgba(${t}, calc(var(--visualEffects-layer-opacity) * 0.6)) 0%,
        rgba(${t}, calc(var(--visualEffects-layer-opacity) * 0.3)) 30%,
        rgba(${i}, calc(var(--visualEffects-layer-opacity) * 0.1)) 60%,
        var(--spice-base) 100%
      ),
      linear-gradient(
        135deg,
        rgba(${t}, calc(var(--visualEffects-layer-opacity) * 0.4)) 0%,
        var(--spice-base) 50%,
        rgba(${t}, calc(var(--visualEffects-layer-opacity) * 0.2)) 100%
      ),
      var(--spice-base)
    `}updateBreathingAnimation(){this.triggerConsciousnessBreathing()}startBreathingAnimation(){this.triggerConsciousnessBreathing(),u?.debug?.log("LivingGradientStrategy","CSS-first visualEffects animation started - 90%+ JavaScript overhead eliminated")}scheduleDebouncedCssUpdate(){u?.debug?.log("LivingGradientStrategy","Debounced CSS updates eliminated - using CSS-first animation")}async updateWebGLIntegration(){if(!this.gradientConfig.webglIntegrationEnabled)return;let t={"--sn-bg-gradient-primary-rgb":this.livingBaseState.currentPrimaryRgb,"--sn-webgl-living-gradient-sync":"1","--sn-gradient-visualEffects-level":this.livingBaseState.visualEffectsIntensity.toString()};await this.cssController.batchSetVariables("LivingGradientStrategy",t,"high","webgl-living-gradient-integration"),this.livingBaseState.webglIntegrationActive=!0,u?.debug?.log("LivingGradientStrategy","WebGL integration updated")}getLivingBaseState(){return{...this.livingBaseState}}updateLivingConsciousnessBase(){this.applyLivingConsciousnessBase().catch(i=>{u?.debug?.error("LivingGradientStrategy","Failed to update living visualEffects base:",i)});let t=new CustomEvent("living-base-update",{detail:{baseHex:this.livingBaseState.currentBaseHex,primaryHex:this.livingBaseState.currentPrimaryHex,visualEffectsIntensity:this.livingBaseState.visualEffectsIntensity,timestamp:Date.now()}});document.dispatchEvent(t)}updateMusicResponsiveVariables(){let t={"--visualEffects-music-energy":this.livingBaseState.musicEnergy.toString(),"--visualEffects-music-intensity":this.livingBaseState.visualEffectsIntensity.toString()};this.cssController.batchSetVariables("LivingGradientStrategy",t,3,"music-responsive").catch(i=>{u?.debug?.error("LivingGradientStrategy","Failed to update music responsive variables:",i)})}updateConsciousnessVariables(){let t={"--visualEffects-intensity-global":this.livingBaseState.visualEffectsIntensity.toString(),"--visualEffects-layer-opacity":(this.gradientConfig.visualEffectsLayerOpacity*this.livingBaseState.visualEffectsIntensity).toString()};this.cssController.batchSetVariables("LivingGradientStrategy",t,3,"visualEffects-vars").catch(i=>{u?.debug?.error("LivingGradientStrategy","Failed to update visualEffects variables:",i)})}coordinateWithWebGLSystem(t){let i=t?{"--visualEffects-webgl-coordination":"0.7","--visualEffects-css-fallback":"0.3"}:{"--visualEffects-webgl-coordination":"0","--visualEffects-css-fallback":"1.0"};this.cssController.batchSetVariables("LivingGradientStrategy",i,"high","webgl-coordination").catch(a=>{u?.debug?.error("LivingGradientStrategy","Failed to coordinate with WebGL system:",a)}),u?.debug?.log("LivingGradientStrategy",`WebGL coordination ${t?"enabled":"disabled"}`)}coordinateWithWebGLGradient(t){this.gradientConfig.webglIntegrationEnabled&&(t.flowState&&this.updateFlowStateFromWebGL(t.flowState),t.colorState&&this.updateColorStateFromWebGL(t.colorState))}updateFlowStateFromWebGL(t){let i={};t.flowX!==void 0&&(i["--visualEffects-webgl-flow-x"]=`${t.flowX}%`),t.flowY!==void 0&&(i["--visualEffects-webgl-flow-y"]=`${t.flowY}%`),t.flowScale!==void 0&&(i["--visualEffects-webgl-scale"]=t.flowScale.toString()),Object.keys(i).length>0&&this.cssController.batchSetVariables("LivingGradientStrategy",i,3,"webgl-flow").catch(a=>{u?.debug?.error("LivingGradientStrategy","Failed to update WebGL flow state:",a)})}updateColorStateFromWebGL(t){t.primaryColor&&(this.livingBaseState.currentPrimaryRgb=t.primaryColor,this.updateLivingConsciousnessBase())}async healthCheck(){let t=await this.getStrategyHealthCheck();return{healthy:t.healthy&&this.isActive,canProcess:t.canProcess,issues:t.issues||[],metrics:{...t.metrics,systemType:"consolidated-living-gradient",isVisualSystem:!0,isColorProcessor:!0,isActive:this.isActive,initialized:this.initialized}}}async getStrategyHealthCheck(){let t=Date.now()-this.livingBaseState.lastUpdateTime<3e4;return{healthy:this.gradientConfig.baseTransformationEnabled,canProcess:this.gradientConfig.baseTransformationEnabled,issues:this.gradientConfig.baseTransformationEnabled?[]:["Base transformation disabled in configuration"],metrics:{baseTransformationEnabled:this.gradientConfig.baseTransformationEnabled,animationAnimationEnabled:this.gradientConfig.animationAnimationEnabled,webglIntegrationActive:this.livingBaseState.webglIntegrationActive,visualEffectsIntensity:this.livingBaseState.visualEffectsIntensity,musicEnergy:this.livingBaseState.musicEnergy,hasRecentUpdate:t,cssFirstBreathing:!0,oklabInterpolation:this.gradientConfig.oklabInterpolationEnabled,oklabPreset:this.gradientConfig.oklabPreset,gradientSmoothness:this.gradientConfig.gradientSmoothness,oklabGradientStops:this.livingBaseState.oklabGradientStops.length}}}destroy(){this.cssAnimationManager&&this.cssAnimationManager.stopConsciousnessBreathing(),this.oklabCache.clear(),this.gradientCache.clear(),super.destroy(),u?.debug?.log("LivingGradientStrategy","Consolidated living gradient system destroyed with complete cleanup")}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),u?.debug?.log("LivingGradientStrategy","Living gradient system cleaned up")}updateConfig(t){this.gradientConfig={...this.gradientConfig,...t},("oklabInterpolationEnabled"in t||"oklabPreset"in t)&&(this.oklabProcessor=new M(this.config.enableDebug)),u?.debug?.log("LivingGradientStrategy","Configuration updated:",{...t,oklabInterpolation:this.gradientConfig.oklabInterpolationEnabled,oklabPreset:this.gradientConfig.oklabPreset,gradientSmoothness:this.gradientConfig.gradientSmoothness})}stopBreathingAnimation(){this.cssAnimationManager&&this.cssAnimationManager.stopConsciousnessBreathing(),u?.debug?.log("LivingGradientStrategy","CSS-first visualEffects animation stopped")}}});var Ra={};ie(Ra,{DEFAULT_VERTEX_SHADER:()=>wt,ShaderLoader:()=>te,createGradientTexture:()=>oe});function oe(c,e,t=256){try{if(!c)return u?.debug?.error("ShaderLoader","WebGL context is null or undefined"),null;if(!e||e.length===0)return u?.debug?.error("ShaderLoader","Invalid or empty color stops array"),null;if(t<=0||t>8192)return u?.debug?.error("ShaderLoader",`Invalid texture width: ${t}`),null;let i=c.getError();if(i!==c.NO_ERROR&&u?.debug?.warn("ShaderLoader",`WebGL context has pending error: ${i}`),c.isContextLost())return u?.debug?.error("ShaderLoader","WebGL context is lost"),null;let a=document.createElement("canvas");if(!a)return u?.debug?.error("ShaderLoader","Failed to create canvas element"),null;a.width=t,a.height=1;let r=a.getContext("2d",{willReadFrequently:!1});if(!r)return u?.debug?.error("ShaderLoader","Failed to get 2D canvas context"),null;let n=e.filter(l=>typeof l.r!="number"||typeof l.g!="number"||typeof l.b!="number"||typeof l.a!="number"||typeof l.position!="number"?(u?.debug?.warn("ShaderLoader","Invalid color stop found, skipping"),!1):((l.position<0||l.position>1)&&(u?.debug?.warn("ShaderLoader",`Invalid color stop position: ${l.position}, clamping`),l.position=Math.max(0,Math.min(1,l.position))),!0));if(n.length===0)return u?.debug?.error("ShaderLoader","No valid color stops after validation"),null;n.sort((l,m)=>l.position-m.position);let s=r.createLinearGradient(0,0,t,0);if(!s)return u?.debug?.error("ShaderLoader","Failed to create linear gradient"),null;try{n.forEach((l,m)=>{let d=Math.max(0,Math.min(255,Math.round(l.r*255))),h=Math.max(0,Math.min(255,Math.round(l.g*255))),g=Math.max(0,Math.min(255,Math.round(l.b*255))),f=Math.max(0,Math.min(1,l.a)),S=`rgba(${d}, ${h}, ${g}, ${f})`;s.addColorStop(l.position,S)})}catch(l){return u?.debug?.error("ShaderLoader","Failed to add color stops to gradient:",l),null}try{r.fillStyle=s,r.fillRect(0,0,t,1)}catch(l){return u?.debug?.error("ShaderLoader","Failed to fill canvas with gradient:",l),null}let o=c.createTexture();if(!o)return u?.debug?.error("ShaderLoader","Failed to create WebGL texture - gl.createTexture() returned null"),null;try{c.bindTexture(c.TEXTURE_2D,o);let l=c.getError();if(l!==c.NO_ERROR)return u?.debug?.error("ShaderLoader",`WebGL error after texture binding: ${l}`),c.deleteTexture(o),null;c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,a);let m=c.getError();if(m!==c.NO_ERROR)return u?.debug?.error("ShaderLoader",`WebGL error after texture upload: ${m}`),c.deleteTexture(o),null;c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);let d=c.getError();return d!==c.NO_ERROR?(u?.debug?.error("ShaderLoader",`WebGL error after setting texture parameters: ${d}`),c.deleteTexture(o),null):(c.bindTexture(c.TEXTURE_2D,null),u?.debug?.log("ShaderLoader",`Gradient texture created successfully: ${t}x1, ${n.length} stops`),o)}catch(l){return u?.debug?.error("ShaderLoader","Exception during WebGL texture operations:",l),o&&c.deleteTexture(o),null}}catch(i){return u?.debug?.error("ShaderLoader",`Gradient texture creation failed: ${i instanceof Error?i.message:"Unknown error"}`),null}}var te,wt,Tt=y(()=>{"use strict";x();te=class{static loadFragment(e,t,i){let a=i||this.hashSource(t),r=this.getContextCache(e);if(r[a])return r[a];try{let n=this.compileShader(e,e.FRAGMENT_SHADER,t);return n&&(r[a]=n,u?.debug?.log("ShaderLoader",`Fragment shader compiled: ${a.substring(0,8)}...`)),n}catch(n){return u?.debug?.error("ShaderLoader",`Fragment shader compilation failed: ${n}`),null}}static loadVertex(e,t,i){let a=i||this.hashSource(t),r=this.getContextCache(e);if(r[a])return r[a];try{let n=this.compileShader(e,e.VERTEX_SHADER,t);return n&&(r[a]=n,u?.debug?.log("ShaderLoader",`Vertex shader compiled: ${a.substring(0,8)}...`)),n}catch(n){return u?.debug?.error("ShaderLoader",`Vertex shader compilation failed: ${n}`),null}}static createProgram(e,t,i){try{let a=e.createProgram();if(!a)return null;if(e.attachShader(a,t),e.attachShader(a,i),e.linkProgram(a),!e.getProgramParameter(a,e.LINK_STATUS)){let r=e.getProgramInfoLog(a);throw e.deleteProgram(a),new Error(`Program linking failed: ${r}`)}return a}catch(a){return u?.debug?.error("ShaderLoader",`Program creation failed: ${a}`),null}}static clearCache(e){let t=this.cache.get(e);t&&(Object.values(t).forEach(i=>{e.deleteShader(i)}),this.cache.delete(e))}static clearAllCaches(){this.cache.clear()}static compileShader(e,t,i){let a=e.createShader(t);if(!a)return null;if(e.shaderSource(a,i),e.compileShader(a),!e.getShaderParameter(a,e.COMPILE_STATUS)){let r=e.getShaderInfoLog(a);throw e.deleteShader(a),new Error(`Shader compilation failed: ${r}`)}return a}static clearContextCache(e){if(this.cache.has(e)){let t=this.cache.get(e);Object.values(t).forEach(i=>{if(i&&e&&!e.isContextLost())try{e.deleteShader(i)}catch{}}),this.cache.set(e,{}),u?.debug?.log("ShaderLoader","Context cache cleared due to WebGL context loss/restore")}}static getContextCache(e){return this.cache.has(e)||this.cache.set(e,{}),this.cache.get(e)}static hashSource(e){let t=0;for(let i=0;i<e.length;i++){let a=e.charCodeAt(i);t=(t<<5)-t+a,t=t&t}return t.toString(16)}};te.cache=new Map;wt=`#version 300 es
precision mediump float;

in vec2 a_position;
out vec2 v_uv;

void main() {
  v_uv = a_position * 0.5 + 0.5;
  gl_Position = vec4(a_position, 0.0, 1.0);
}`});var mc,Pt,Vn=y(()=>{"use strict";U();$();ue();x();be();ae();Ct();X();Tt();mc=`#version 300 es
precision mediump float;

uniform float u_time;
uniform sampler2D u_gradientTex;
uniform vec2 u_resolution;
uniform float u_flowStrength;
uniform float u_noiseScale;

// Wave stack uniforms
uniform float u_waveY[2];
uniform float u_waveHeight[2];
uniform float u_waveOffset[2];
uniform float u_blurExp;
uniform float u_blurMax;

out vec4 fragColor;

// Simplex noise implementation
vec3 mod289(vec3 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec2 mod289(vec2 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec3 permute(vec3 x) {
  return mod289(((x*34.0)+1.0)*x);
}

float snoise(vec2 v) {
  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0
                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)
                     -0.577350269189626,  // -1.0 + 2.0 * C.x
                      0.024390243902439); // 1.0 / 41.0
  vec2 i  = floor(v + dot(v, C.yy) );
  vec2 x0 = v -   i + dot(i, C.xx);

  vec2 i1;
  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
  vec4 x12 = x0.xyxy + C.xxzz;
  x12.xy -= i1;

  i = mod289(i);
  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))
    + i.x + vec3(0.0, i1.x, 1.0 ));

  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
  m = m*m ;
  m = m*m ;

  vec3 x = 2.0 * fract(p * C.www) - 1.0;
  vec3 h = abs(x) - 0.5;
  vec3 ox = floor(x + 0.5);
  vec3 a0 = x - ox;

  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );

  vec3 g;
  g.x  = a0.x  * x0.x  + h.x  * x0.y;
  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
  return 130.0 * dot(m, g);
}

// Octave noise for richer detail
float octaveNoise(vec2 uv, float octaves, float persistence, float scale) {
  float value = 0.0;
  float amplitude = 1.0;
  float frequency = scale;
  float maxValue = 0.0;

  for(float i = 0.0; i < octaves; i++) {
    value += snoise(uv * frequency) * amplitude;
    maxValue += amplitude;
    amplitude *= persistence;
    frequency *= 2.0;
  }

  return value / maxValue;
}

// Wave alpha calculation with smooth transitions
float wave_alpha(vec2 uv, int waveIndex) {
  float y = uv.y;
  float waveCenter = u_waveY[waveIndex];
  float waveHeight = u_waveHeight[waveIndex];

  float distance = abs(y - waveCenter);
  float alpha = 1.0 - smoothstep(0.0, waveHeight * 0.5, distance);

  return alpha;
}

// Dynamic blur calculation using power function
float calc_blur(vec2 uv) {
  vec2 center = vec2(0.5, 0.5);
  float distance = length(uv - center);

  float blur = pow(distance, u_blurExp);
  blur = clamp(blur, 0.0, u_blurMax);

  return blur;
}

// Background noise generator with time offset
float background_noise(vec2 uv, float timeOffset) {
  vec2 flowUV = uv;
  float adjustedTime = u_time + timeOffset;

  flowUV.x += adjustedTime * 0.02 * u_flowStrength;
  flowUV.y += sin(adjustedTime * 0.03 + uv.x * 3.14159) * 0.01 * u_flowStrength;

  float noise1 = octaveNoise(flowUV * u_noiseScale, 4.0, 0.5, 1.0);
  float noise2 = octaveNoise(flowUV * u_noiseScale * 2.0 + vec2(100.0), 3.0, 0.4, 1.0);

  return (noise1 + noise2 * 0.3) * 0.5 + 0.5;
}

void main() {
  vec2 uv = gl_FragCoord.xy / u_resolution.xy;

  // Generate three distinct background noise fields with time offsets
  float noise1 = background_noise(uv, u_waveOffset[0]);
  float noise2 = background_noise(uv, u_waveOffset[1]);
  float noise3 = background_noise(uv, 0.0); // Base noise without offset

  // Calculate wave alphas for blending
  float alpha1 = wave_alpha(uv, 0);
  float alpha2 = wave_alpha(uv, 1);
  float alpha3 = 1.0 - alpha1 - alpha2; // Remaining area
  alpha3 = max(alpha3, 0.0); // Ensure non-negative

  // Normalize alphas to ensure they sum to 1.0
  float totalAlpha = alpha1 + alpha2 + alpha3;
  if (totalAlpha > 0.0) {
    alpha1 /= totalAlpha;
    alpha2 /= totalAlpha;
    alpha3 /= totalAlpha;
  }

  // Blend the three noise fields based on wave alphas
  float t = noise1 * alpha1 + noise2 * alpha2 + noise3 * alpha3;
  t = clamp(t, 0.0, 1.0);

  // Sample gradient texture
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));

  // Apply dynamic blur based on position
  float blurAmount = calc_blur(uv);

  // Apply subtle vignette with blur modulation
  vec2 center = uv - 0.5;
  float vignette = 1.0 - dot(center, center) * (0.3 + blurAmount * 0.2);
  color.rgb *= vignette;

  // Apply blur effect to alpha channel for depth
  color.a *= (1.0 - blurAmount * 0.3);

  fragColor = color;
}`,Pt=class{constructor(e){this.utils=D;this.config=E;this.webglState={canvas:null,wrapper:null,gl:null,shaderProgram:null,gradientTexture:null,vertexBuffer:null,vao:null,isWebGLAvailable:!1,webglReady:!1,animationId:null,startTime:0,lastFrameTime:0,lastUpdateTime:0,currentFlowStrength:.3,targetFlowStrength:.3,currentNoiseScale:1,targetNoiseScale:1,currentBlurExp:1.2,targetBlurExp:1.2,currentBlurMax:.5,targetBlurMax:.5,currentWaveY:[.3,.7],targetWaveY:[.3,.7],currentWaveHeight:[.4,.3],targetWaveHeight:[.4,.3],currentWaveOffset:[.1,.6],targetWaveOffset:[.1,.6]};this.uniforms={u_time:null,u_gradientTex:null,u_resolution:null,u_flowStrength:null,u_noiseScale:null,u_waveY:null,u_waveHeight:null,u_waveOffset:null,u_blurExp:null,u_blurMax:null};this.flowSettings={enabled:!0,intensity:"balanced",flowStrength:.7,noiseScale:1.2,waveY:[.25,.75],waveHeight:[.4,.3],waveOffset:[2.5,-1.8],blurExp:1.2,blurMax:.6,frameThrottleInterval:1e3/45,oklabProcessingEnabled:!0,oklabPreset:"VIBRANT",gradientTextureSize:512};this.prefersReducedMotion=!1;this.animateWebGL=()=>{if(!this.webglState.webglReady||!this.webglState.gl||!this.webglState.canvas)return;let e=performance.now();if(e-this.webglState.lastFrameTime<this.flowSettings.frameThrottleInterval){this.webglState.animationId=requestAnimationFrame(this.animateWebGL);return}this.webglState.lastFrameTime=e,this.renderWebGLFrame(e),this.webglState.animationId=requestAnimationFrame(this.animateWebGL)};this.lerpHalfLifeValues={flowStrength:.25,noiseScale:.3,blur:.2,wave:.35};this.resizeWebGLCanvas=()=>{if(!this.webglState.canvas)return;let e=window.devicePixelRatio||1,t=window.innerWidth,i=window.innerHeight;this.webglState.canvas.width=t*e,this.webglState.canvas.height=i*e,this.webglState.canvas.style.width=t+"px",this.webglState.canvas.style.height=i+"px"};this.deviceDetector=new N,this.cssController=e||P(),this.oklabProcessor=new M(this.config.enableDebug),this.cssController=P(),this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.webglState.isWebGLAvailable=this.checkWebGL2Support(),this.loadFlowSettings(),u?.debug?.log("WebGLGradientStrategy","\u{1F30A} WebGL gradient strategy initialized - Flow Gradient Recovery Debug",{webglAvailable:this.webglState.isWebGLAvailable,deviceCapability:this.deviceDetector.recommendPerformanceQuality(),oklabProcessing:this.flowSettings.oklabProcessingEnabled,flowSettings:{enabled:this.flowSettings.enabled,intensity:this.flowSettings.intensity,flowStrength:this.flowSettings.flowStrength,noiseScale:this.flowSettings.noiseScale},prefersReducedMotion:this.prefersReducedMotion,webgl2ContextTest:this.checkWebGL2Support()})}getStrategyName(){return"webgl-gradient"}canProcess(e){return u?.debug?.log("WebGLGradientStrategy","\u{1F50D} canProcess() - WebGL Gradient Capability Check",{isWebGLAvailable:this.webglState.isWebGLAvailable,flowSettingsEnabled:this.flowSettings.enabled,webglReady:this.webglState.webglReady,contextTrackUri:e.trackUri,contextColorCount:Object.keys(e.rawColors).length}),this.webglState.isWebGLAvailable?this.flowSettings.enabled?A.get("sn-webgl-enabled")?(u?.debug?.log("WebGLGradientStrategy","canProcess: WebGL force enabled - bypassing device restrictions"),!0):(this.deviceDetector.recommendPerformanceQuality()==="low"&&u?.debug?.log("WebGLGradientStrategy","canProcess: Low performance device detected, allowing based on strategy selection (not force mode)"),!0):(u?.debug?.warn("WebGLGradientStrategy","\u274C canProcess: WebGL strategy disabled in settings"),!1):(u?.debug?.warn("WebGLGradientStrategy","\u274C canProcess: WebGL not available - failed WebGL2 context check"),!1)}getEstimatedProcessingTime(e){let i=this.flowSettings.intensity==="intense"?1.3:1;return Math.round(12*i)}async processColors(e){let t=performance.now(),i={};try{this.webglState.webglReady||await this.initializeWebGLGradient();let a=e.rawColors;if(this.flowSettings.oklabProcessingEnabled){let l=M.getPreset(this.flowSettings.oklabPreset);i=this.oklabProcessor.processColorPalette(e.rawColors,l),a=Object.fromEntries(Object.entries(i).map(([m,d])=>[m,d.enhancedHex])),u?.debug?.log("WebGLGradientStrategy","OKLAB color enhancement applied:",{originalColors:Object.keys(e.rawColors).length,processedColors:Object.keys(a).length,preset:l.name})}let r=this.createGradientStops(a,i);await this.updateGradientTexture(r),await this.enableHybridCoordination(),this.webglState.animationId||this.startWebGLAnimation(),e.musicData?.energy!==void 0&&await this.updateFlowWithMusicEnergy(e.musicData.energy),this.webglState.lastUpdateTime=Date.now();let n=performance.now()-t,s=this.selectPrimaryColor(a)||K.getDefaultAccentColor().hex,o={processedColors:{webgl:"active",gradientStops:r.length.toString(),...a,...Object.keys(e.rawColors).length>0&&{originalColors:JSON.stringify(e.rawColors)}},accentHex:s,accentRgb:this.convertToRgbString(s),metadata:{strategy:this.getStrategyName(),processingTime:n,cacheKey:`webgl-gradient-${e.trackUri}`,harmonicIntensity:this.flowSettings.flowStrength,webglReady:this.webglState.webglReady,oklabProcessing:this.flowSettings.oklabProcessingEnabled,oklabPreset:this.flowSettings.oklabPreset,gradientTextureSize:this.flowSettings.gradientTextureSize,oklabResultsCount:Object.keys(i).length},context:e};return u?.debug?.log("WebGLGradientStrategy","WebGL gradient processing completed",{gradientStops:r.length,processingTime:n,trackUri:e.trackUri}),o}catch(a){let r=performance.now()-t;u?.debug?.error("WebGLGradientStrategy","WebGL gradient processing failed:",a);let n=await this.executeProgressiveFallback(e,a);return{...n,metadata:{...n.metadata,strategy:this.getStrategyName(),processingTime:r,error:a instanceof Error?a.message:"Unknown error"},context:e}}}checkWebGL2Support(){return document.createElement("canvas").getContext("webgl2")!==null}loadFlowSettings(){try{let e=A.get("sn-gradient-intensity");if(e==="disabled"){this.flowSettings.enabled=!1;return}switch(this.flowSettings.intensity=e||"balanced",this.flowSettings.intensity){case"minimal":this.flowSettings.flowStrength=.4,this.flowSettings.noiseScale=.8,this.flowSettings.waveHeight=[.3,.2],this.flowSettings.waveOffset=[1.5,-1],this.flowSettings.blurExp=1,this.flowSettings.blurMax=.4;break;case"balanced":this.flowSettings.flowStrength=.7,this.flowSettings.noiseScale=1.2,this.flowSettings.waveHeight=[.4,.3],this.flowSettings.waveOffset=[2.5,-1.8],this.flowSettings.blurExp=1.2,this.flowSettings.blurMax=.6;break;case"intense":this.flowSettings.flowStrength=1,this.flowSettings.noiseScale=1.6,this.flowSettings.waveHeight=[.5,.4],this.flowSettings.waveOffset=[3.5,-2.5],this.flowSettings.blurExp=1.4,this.flowSettings.blurMax=.8;break}}catch(e){u?.debug?.warn("WebGLGradientStrategy","Failed to load settings, using defaults:",e)}}async initializeWebGLGradient(){if(!this.webglState.isWebGLAvailable)throw new Error("WebGL2 not available");await this.createWebGLCanvas(),await this.initializeWebGLContext(),await this.compileWebGLShaders(),this.createWebGLGeometry(),this.setupWebGLUniforms(),this.resizeWebGLCanvas(),this.attachWebGLToDom(),window.addEventListener("resize",this.resizeWebGLCanvas.bind(this)),this.webglState.webglReady=!0;try{let e=P();e.setPerformanceTokens({webglReady:!0,activeBackend:"webgl-strategy",qualityLevel:"high",gpuAcceleration:!0}),u?.debug?.log("WebGLGradientStrategy","\u{1F3A8} WebGL readiness announced to CSS visual effects system - CSS Variables Set",{webglReady:!0,activeBackend:"webgl-strategy",qualityLevel:"high",gpuAcceleration:!0,cssControllerReady:!!e})}catch(e){u?.debug?.warn("WebGLGradientStrategy","\u274C Failed to announce WebGL readiness - CSS Variables NOT Set:",e)}u?.debug?.log("WebGLGradientStrategy","WebGL gradient system initialized successfully")}async createWebGLCanvas(){u?.debug?.log("WebGLGradientStrategy","\u{1F3A8} Creating WebGL canvas and wrapper elements"),this.webglState.wrapper=document.createElement("div"),this.webglState.wrapper.className="sn-webgl-gradient-wrapper",this.webglState.wrapper.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -11;
      pointer-events: none;
      overflow: hidden;
    `,this.webglState.canvas=document.createElement("canvas"),this.webglState.canvas.id="sn-webgl-gradient-strategy",this.webglState.canvas.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    `,this.webglState.wrapper.appendChild(this.webglState.canvas),u?.debug?.log("WebGLGradientStrategy","\u2705 WebGL canvas and wrapper created successfully",{wrapperId:this.webglState.wrapper.className,canvasId:this.webglState.canvas.id,wrapperStyle:this.webglState.wrapper.style.cssText.replace(/\s+/g," ").trim()})}async initializeWebGLContext(){if(!this.webglState.canvas)throw new Error("Canvas not created");if(this.webglState.gl=this.webglState.canvas.getContext("webgl2",{alpha:!0,antialias:!1,depth:!1,stencil:!1,powerPreference:"default"}),!this.webglState.gl)throw new Error("Failed to get WebGL2 context")}async compileWebGLShaders(){if(!this.webglState.gl)throw new Error("WebGL context not available");let e=te.loadVertex(this.webglState.gl,wt),t=te.loadFragment(this.webglState.gl,mc);if(!e||!t)throw new Error("Failed to compile shaders");if(this.webglState.shaderProgram=te.createProgram(this.webglState.gl,e,t),!this.webglState.shaderProgram)throw new Error("Failed to create shader program")}createWebGLGeometry(){if(!this.webglState.gl||!this.webglState.shaderProgram)return;let e=new Float32Array([-1,-1,3,-1,-1,3]);this.webglState.vertexBuffer=this.webglState.gl.createBuffer(),this.webglState.gl.bindBuffer(this.webglState.gl.ARRAY_BUFFER,this.webglState.vertexBuffer),this.webglState.gl.bufferData(this.webglState.gl.ARRAY_BUFFER,e,this.webglState.gl.STATIC_DRAW),this.webglState.vao=this.webglState.gl.createVertexArray(),this.webglState.gl.bindVertexArray(this.webglState.vao);let t=this.webglState.gl.getAttribLocation(this.webglState.shaderProgram,"a_position");this.webglState.gl.enableVertexAttribArray(t),this.webglState.gl.vertexAttribPointer(t,2,this.webglState.gl.FLOAT,!1,0,0),this.webglState.gl.bindVertexArray(null)}setupWebGLUniforms(){!this.webglState.gl||!this.webglState.shaderProgram||(this.uniforms.u_time=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_time"),this.uniforms.u_gradientTex=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_gradientTex"),this.uniforms.u_resolution=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_resolution"),this.uniforms.u_flowStrength=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_flowStrength"),this.uniforms.u_noiseScale=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_noiseScale"),this.uniforms.u_waveY=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_waveY"),this.uniforms.u_waveHeight=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_waveHeight"),this.uniforms.u_waveOffset=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_waveOffset"),this.uniforms.u_blurExp=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_blurExp"),this.uniforms.u_blurMax=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_blurMax"))}createGradientStops(e,t={}){let i=["PRIMARY","VIBRANT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT","DARK_VIBRANT","PROMINENT"],a=[],r=new Set,n=0;for(let s of i){let o=e[s];if(o&&!r.has(o)){let l=t[s],m=l?l.enhancedHex:o,d=this.utils.hexToRgb(m);if(d&&(a.push({r:d.r/255,g:d.g/255,b:d.b/255,a:1,position:n/(Math.min(i.length,4)-1),...l&&{oklabOriginal:l.originalHex,oklabEnhanced:l.enhancedHex}}),r.add(o),n++,a.length>=4))break}}return a.length===0?this.getDefaultGradientStops():a}getDefaultGradientStops(){return[{r:.196,g:.165,b:.282,a:1,position:0},{r:.549,g:.408,b:.878,a:1,position:.3},{r:.788,g:.557,b:.902,a:1,position:.6},{r:.957,g:.761,b:.494,a:1,position:1}]}async updateGradientTexture(e){if(this.webglState.gl){if(this.webglState.gradientTexture&&this.webglState.gl.deleteTexture(this.webglState.gradientTexture),this.webglState.gradientTexture=oe(this.webglState.gl,e),!this.webglState.gradientTexture)throw new Error("Failed to create gradient texture");await this.updateCSSFallbackVariables(e)}}async updateCSSFallbackVariables(e){let t=Math.min(8,e.length),i={"--sn-grad-stop-count":String(t)};for(let a=0;a<t;a++){let r=e[a];r&&(i[`--sn-grad-stop-${a}-rgb`]=`${Math.round(r.r*255)},${Math.round(r.g*255)},${Math.round(r.b*255)}`)}await this.cssController.batchSetVariables("WebGLGradientStrategy",i,"normal","gradient-stops-configuration")}async enableHybridCoordination(){let e={"--sn-webgl-ready":"1","--sn-webgl-enabled":"1","--sn-current-backend":"hybrid","--sn-gradient-crossfade-opacity":"0.5"};u?.debug?.log("WebGLGradientStrategy","\u{1F517} Setting hybrid coordination CSS variables - WebGL Gradient Activation",{variables:e,cssControllerReady:!!this.cssController}),await this.cssController.batchSetVariables("WebGLGradientStrategy",e,"high","hybrid-coordination-enable"),u?.debug?.log("WebGLGradientStrategy","\u2705 Hybrid coordination CSS variables set successfully")}startWebGLAnimation(){this.webglState.startTime=performance.now(),this.webglState.lastFrameTime=this.webglState.startTime,this.animateWebGL()}updateUniformsWithLERP(e){this.webglState.targetFlowStrength=this.flowSettings.flowStrength,this.webglState.targetNoiseScale=this.flowSettings.noiseScale,this.webglState.targetBlurExp=this.flowSettings.blurExp,this.webglState.targetBlurMax=this.flowSettings.blurMax,this.webglState.targetWaveY=[this.flowSettings.waveY[0],this.flowSettings.waveY[1]],this.webglState.targetWaveHeight=[this.flowSettings.waveHeight[0],this.flowSettings.waveHeight[1]],this.webglState.targetWaveOffset=[this.flowSettings.waveOffset[0],this.flowSettings.waveOffset[1]],this.webglState.currentFlowStrength=H(this.webglState.currentFlowStrength,this.webglState.targetFlowStrength,e,this.lerpHalfLifeValues.flowStrength),this.webglState.currentNoiseScale=H(this.webglState.currentNoiseScale,this.webglState.targetNoiseScale,e,this.lerpHalfLifeValues.noiseScale),this.webglState.currentBlurExp=H(this.webglState.currentBlurExp,this.webglState.targetBlurExp,e,this.lerpHalfLifeValues.blur),this.webglState.currentBlurMax=H(this.webglState.currentBlurMax,this.webglState.targetBlurMax,e,this.lerpHalfLifeValues.blur);let t=0,i=1;this.webglState.currentWaveY[t]=H(this.webglState.currentWaveY[t],this.webglState.targetWaveY[t],e,this.lerpHalfLifeValues.wave),this.webglState.currentWaveY[i]=H(this.webglState.currentWaveY[i],this.webglState.targetWaveY[i],e,this.lerpHalfLifeValues.wave),this.webglState.currentWaveHeight[t]=H(this.webglState.currentWaveHeight[t],this.webglState.targetWaveHeight[t],e,this.lerpHalfLifeValues.wave),this.webglState.currentWaveHeight[i]=H(this.webglState.currentWaveHeight[i],this.webglState.targetWaveHeight[i],e,this.lerpHalfLifeValues.wave),this.webglState.currentWaveOffset[t]=H(this.webglState.currentWaveOffset[t],this.webglState.targetWaveOffset[t],e,this.lerpHalfLifeValues.wave),this.webglState.currentWaveOffset[i]=H(this.webglState.currentWaveOffset[i],this.webglState.targetWaveOffset[i],e,this.lerpHalfLifeValues.wave)}renderWebGLFrame(e){if(!this.webglState.gl||!this.webglState.shaderProgram||!this.webglState.vao||!this.webglState.gradientTexture)return;let t=(e-this.webglState.lastFrameTime)/1e3;this.updateUniformsWithLERP(t),this.webglState.gl.viewport(0,0,this.webglState.canvas.width,this.webglState.canvas.height),this.webglState.gl.clearColor(0,0,0,0),this.webglState.gl.clear(this.webglState.gl.COLOR_BUFFER_BIT),this.webglState.gl.useProgram(this.webglState.shaderProgram),this.webglState.gl.bindVertexArray(this.webglState.vao);let i=this.prefersReducedMotion?0:(e-this.webglState.startTime)/1e3;this.uniforms.u_time&&this.webglState.gl.uniform1f(this.uniforms.u_time,i),this.uniforms.u_resolution&&this.webglState.gl.uniform2f(this.uniforms.u_resolution,this.webglState.canvas.width,this.webglState.canvas.height),this.uniforms.u_flowStrength&&this.webglState.gl.uniform1f(this.uniforms.u_flowStrength,this.webglState.currentFlowStrength),this.uniforms.u_noiseScale&&this.webglState.gl.uniform1f(this.uniforms.u_noiseScale,this.webglState.currentNoiseScale),this.uniforms.u_waveY&&this.webglState.gl.uniform1fv(this.uniforms.u_waveY,this.webglState.currentWaveY),this.uniforms.u_waveHeight&&this.webglState.gl.uniform1fv(this.uniforms.u_waveHeight,this.webglState.currentWaveHeight),this.uniforms.u_waveOffset&&this.webglState.gl.uniform1fv(this.uniforms.u_waveOffset,this.webglState.currentWaveOffset),this.uniforms.u_blurExp&&this.webglState.gl.uniform1f(this.uniforms.u_blurExp,this.webglState.currentBlurExp),this.uniforms.u_blurMax&&this.webglState.gl.uniform1f(this.uniforms.u_blurMax,this.webglState.currentBlurMax),this.webglState.gl.activeTexture(this.webglState.gl.TEXTURE0),this.webglState.gl.bindTexture(this.webglState.gl.TEXTURE_2D,this.webglState.gradientTexture),this.uniforms.u_gradientTex&&this.webglState.gl.uniform1i(this.uniforms.u_gradientTex,0),this.webglState.gl.drawArrays(this.webglState.gl.TRIANGLES,0,3),this.webglState.gl.bindVertexArray(null)}async updateFlowWithMusicEnergy(e){let t=this.flowSettings.flowStrength,i=1+e*.5,a=t*i;await this.cssController.setVariable("WebGLGradientStrategy","--sn-flow-strength",a.toString(),"high","music-energy-flow-strength")}attachWebGLToDom(){if(!this.webglState.wrapper){u?.debug?.error("WebGLGradientStrategy","\u274C Cannot attach to DOM - wrapper element not created");return}u?.debug?.log("WebGLGradientStrategy","\u{1F517} Attaching WebGL canvas to DOM - Searching for container");let e=[".Root__main-view",".main-view-container",".main-gridContainer-gridContainer",".Root__top-container","body"],t=null,i=[];for(let a of e)if(t=document.querySelector(a),i.push({selector:a,found:!!t}),t)break;t||(t=document.body),t.appendChild(this.webglState.wrapper),u?.debug?.log("WebGLGradientStrategy","\u2705 WebGL canvas attached to DOM successfully",{containerSearch:i,selectedContainer:t?.tagName||"unknown",containerClass:t?.className||"none",wrapperId:this.webglState.wrapper.className,canvasId:this.webglState.canvas?.id||"not-created"})}async executeProgressiveFallback(e,t){let i=this.selectPrimaryColor(e.rawColors)||K.getDefaultAccentColor().hex;try{return u?.debug?.warn("WebGLGradientStrategy","Attempting CSS gradient fallback"),await this.fallbackToCSSGradient(),{processedColors:{...e.rawColors,fallbackMethod:"css-gradient"},accentHex:i,accentRgb:this.convertToRgbString(i),metadata:{strategy:this.getStrategyName(),processingTime:0,fallbackMode:"css-gradient",fallbackReason:"webgl-failed",gradientStops:Object.keys(e.rawColors).length},context:e}}catch(a){return u?.debug?.error("WebGLGradientStrategy","CSS gradient fallback failed, using solid color:",a),await this.fallbackToSolidColor(e,i,t,a)}}async fallbackToSolidColor(e,t,i,a){try{return await this.cssController?.queueUpdate("--sn-accent-color",t,"critical","solid-color-fallback"),{processedColors:{accentColor:t,fallbackMethod:"solid-color",originalColors:JSON.stringify(e.rawColors)},accentHex:t,accentRgb:this.convertToRgbString(t),metadata:{strategy:this.getStrategyName(),processingTime:0,fallbackMode:"solid-color",fallbackReason:"all-gradients-failed",webglError:i instanceof Error?i.message:"Unknown WebGL error",cssError:a instanceof Error?a.message:"Unknown CSS error",emergencyMode:!0},context:e}}catch(r){return u?.debug?.error("WebGLGradientStrategy","All fallback methods failed, using emergency mode:",r),{processedColors:{emergencyMode:"true"},accentHex:"#ff6b9d",accentRgb:"rgb(255, 107, 157)",metadata:{strategy:this.getStrategyName(),processingTime:0,fallbackMode:"emergency",fallbackReason:"complete-system-failure",criticalError:!0},context:e}}}async fallbackToCSSGradient(){let e={"--sn-webgl-ready":"0","--sn-webgl-enabled":"0","--sn-current-backend":"css","--sn-gradient-crossfade-opacity":"0"};await this.cssController.batchSetVariables("WebGLGradientStrategy",e,"critical","css-gradient-fallback"),this.cssController&&this.startCSSFallbackAnimation(),u?.debug?.log("WebGLGradientStrategy","Using CSS gradient fallback")}startCSSFallbackAnimation(){if(!this.cssController)return;let e=()=>{if(!this.webglState.webglReady)return;let t=performance.now()/1e3,i=Math.sin(t*.04)*20+Math.sin(t*.07)*8,a=Math.cos(t*.05)*20+Math.cos(t*.09)*6,r=1.15+Math.sin(t*.03)*.2;this.cssController.queueCSSVariableUpdate("--sn-gradient-flow-x",`${i}%`),this.cssController.queueCSSVariableUpdate("--sn-gradient-flow-y",`${a}%`),this.cssController.queueCSSVariableUpdate("--sn-gradient-flow-scale",r.toString()),setTimeout(e,this.flowSettings.frameThrottleInterval)};e()}selectPrimaryColor(e){let t=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let i of t){let a=e[i];if(a&&this.utils.hexToRgb(a))return a}return null}convertToRgbString(e){let t=this.utils.hexToRgb(e);return t?`${t.r},${t.g},${t.b}`:"203,166,247"}updateConfig(e){this.flowSettings={...this.flowSettings,...e},("oklabProcessingEnabled"in e||"oklabPreset"in e)&&(this.oklabProcessor=new M(this.config.enableDebug)),u?.debug?.log("WebGLGradientStrategy","Configuration updated:",{...e,oklabProcessing:this.flowSettings.oklabProcessingEnabled,oklabPreset:this.flowSettings.oklabPreset,gradientTextureSize:this.flowSettings.gradientTextureSize})}async healthCheck(){let e=Date.now()-this.webglState.lastUpdateTime<3e4;return{healthy:this.webglState.webglReady&&this.flowSettings.enabled,canProcess:this.canProcess({}),issues:this.webglState.webglReady?this.flowSettings.enabled?[]:["WebGL gradient disabled in settings"]:["WebGL system not ready"],metrics:{webglAvailable:this.webglState.isWebGLAvailable,webglReady:this.webglState.webglReady,flowEnabled:this.flowSettings.enabled,intensity:this.flowSettings.intensity,deviceCapability:this.deviceDetector.recommendPerformanceQuality(),hasRecentUpdate:e,animationActive:this.webglState.animationId!==null,oklabProcessing:this.flowSettings.oklabProcessingEnabled,oklabPreset:this.flowSettings.oklabPreset,gradientTextureSize:this.flowSettings.gradientTextureSize,canvasSize:this.webglState.canvas?{width:this.webglState.canvas.width,height:this.webglState.canvas.height}:null}}}destroy(){this.webglState.animationId&&(cancelAnimationFrame(this.webglState.animationId),this.webglState.animationId=null),this.webglState.gl&&(this.webglState.gradientTexture&&(this.webglState.gl.deleteTexture(this.webglState.gradientTexture),this.webglState.gradientTexture=null),this.webglState.vertexBuffer&&(this.webglState.gl.deleteBuffer(this.webglState.vertexBuffer),this.webglState.vertexBuffer=null),this.webglState.vao&&(this.webglState.gl.deleteVertexArray(this.webglState.vao),this.webglState.vao=null),this.webglState.shaderProgram&&(this.webglState.gl.deleteProgram(this.webglState.shaderProgram),this.webglState.shaderProgram=null),te.clearCache(this.webglState.gl)),this.webglState.wrapper&&this.webglState.wrapper.parentNode&&(this.webglState.wrapper.parentNode.removeChild(this.webglState.wrapper),this.webglState.wrapper=null),this.webglState.canvas=null,this.webglState.gl=null,this.webglState.webglReady=!1,window.removeEventListener("resize",this.resizeWebGLCanvas);let e={"--sn-webgl-ready":"0","--sn-webgl-enabled":"0","--sn-current-backend":"css","--sn-gradient-crossfade-opacity":"0"};this.cssController.batchSetVariables("WebGLGradientStrategy",e,"critical","strategy-destroy-cleanup").catch(t=>{u?.debug?.error("WebGLGradientStrategy","Error during destroy cleanup:",t)}),u?.debug?.log("WebGLGradientStrategy","WebGL gradient strategy destroyed")}}});var ct,Ba=y(()=>{"use strict";ue();x();be();Ln();Rn();La();Vn();ct=class{constructor(){this.strategyInstances=new Map;this.strategyMetadata=new Map;this.deviceDetector=new N,this.initializeStrategyMetadata(),u?.debug?.log("BackgroundStrategySelector","Strategy selector initialized")}initializeStrategyMetadata(){this.strategyMetadata.set("dynamic-catppuccin",{name:"dynamic-catppuccin",priority:10,estimatedProcessingTime:5,memoryImpact:2,qualityScore:9,compatibilityScore:10}),this.strategyMetadata.set("living-gradient",{name:"living-gradient",priority:8,estimatedProcessingTime:8,memoryImpact:3,qualityScore:8,compatibilityScore:9}),this.strategyMetadata.set("webgl-gradient",{name:"webgl-gradient",priority:6,estimatedProcessingTime:12,memoryImpact:7,qualityScore:10,compatibilityScore:6}),this.strategyMetadata.set("webgl-gradient-degraded",{name:"webgl-gradient-degraded",priority:5,estimatedProcessingTime:8,memoryImpact:4,qualityScore:6,compatibilityScore:8}),this.strategyMetadata.set("depth-layered",{name:"depth-layered",priority:7,estimatedProcessingTime:15,memoryImpact:5,qualityScore:9,compatibilityScore:7})}selectStrategies(e,t){let i=performance.now(),a=[];try{let r=t.deviceContext||this.buildDeviceContext(),n=t.settingsContext||this.buildSettingsContext();u?.debug?.log("BackgroundStrategySelector","\u{1F3AF} Strategy Selection Debug - WebGL Gradient Analysis",{trackUri:e.trackUri,colorCount:Object.keys(e.rawColors).length,deviceContext:{supportsWebGL:r.supportsWebGL,performanceLevel:r.performanceLevel,memoryCapacity:r.memoryCapacity,isMobile:r.isMobile},settingsContext:{webglEnabled:n.webglEnabled,webglForceEnabled:n.webglForceEnabled,gradientIntensity:n.gradientIntensity,visualEffectsLevel:n.visualEffectsLevel}});let s=this.analyzeStrategyCompatibility(e,{...t,deviceContext:r,settingsContext:n});for(let l of s)if(u?.debug?.log("BackgroundStrategySelector",`Strategy decision: ${l.strategyName}`,{shouldInclude:l.shouldInclude,reason:l.reason,score:l.score}),l.shouldInclude){let m=this.getOrCreateStrategy(l.strategyName);if(m){let d=m.canProcess(e);u?.debug?.log("BackgroundStrategySelector",`Strategy ${l.strategyName} canProcess check`,{canProcess:d,strategyName:l.strategyName,contextColors:Object.keys(e.rawColors).length}),d?(a.push(m),u?.debug?.log("BackgroundStrategySelector",`\u2705 Selected strategy: ${l.strategyName}`)):u?.debug?.warn("BackgroundStrategySelector",`\u274C Strategy rejected by canProcess(): ${l.strategyName}`)}else u?.debug?.error("BackgroundStrategySelector",`Failed to create strategy: ${l.strategyName}`)}if(a.length===0){let l=this.getOrCreateStrategy("living-gradient");l?.canProcess(e)&&a.push(l)}let o=performance.now()-i;return u?.debug?.log("BackgroundStrategySelector","\u{1F3AF} Strategy selection completed",{selectedCount:a.length,strategies:a.map(l=>l.getStrategyName()),processingTime:o,deviceLevel:r.performanceLevel,visualGuideMode:n.visualGuideMode,webglEnabled:n.webglEnabled,webglForceEnabled:n.webglForceEnabled,supportsWebGL:r.supportsWebGL,totalDecisions:s.length,includedDecisions:s.filter(l=>l.shouldInclude).length}),a}catch(r){u?.debug?.error("BackgroundStrategySelector","Strategy selection failed:",r);let n=this.getOrCreateStrategy("living-gradient");return n?[n]:[]}}analyzeStrategyCompatibility(e,t){let i=[],a=this.scoreDynamicCatppuccinStrategy(t);i.push({strategyName:"dynamic-catppuccin",shouldInclude:t.settingsContext.dynamicAccentEnabled&&a>.5,reason:t.settingsContext.dynamicAccentEnabled?`Dynamic accent enabled (score: ${a.toFixed(2)})`:"Dynamic accent disabled in settings",score:a});let r=this.scoreLivingGradientStrategy(t);i.push({strategyName:"living-gradient",shouldInclude:r>.3,reason:`Living gradient foundation (score: ${r.toFixed(2)})`,score:r});let n=this.scoreWebGLGradientStrategy(t),s=this.scoreWebGLDegradedStrategy(t),o=t.settingsContext.webglEnabled&&t.deviceContext.supportsWebGL&&(t.deviceContext.performanceLevel!=="low"||t.settingsContext.webglForceEnabled)&&n>.6;i.push({strategyName:"webgl-gradient",shouldInclude:o,reason:`WebGL full quality (score: ${n.toFixed(2)}, device: ${t.deviceContext.performanceLevel}${t.settingsContext.webglForceEnabled?", FORCED":""})`,score:n}),i.push({strategyName:"webgl-gradient-degraded",shouldInclude:t.settingsContext.webglEnabled&&t.deviceContext.supportsWebGL&&t.deviceContext.performanceLevel==="low"&&!t.settingsContext.webglForceEnabled&&s>.4,reason:`WebGL degraded mode (score: ${s.toFixed(2)}, device: low${t.settingsContext.webglForceEnabled?", skipped due to force":""})`,score:s});let l=this.scoreDepthLayeredStrategy(t);return i.push({strategyName:"depth-layered",shouldInclude:t.settingsContext.depthLayersEnabled&&t.settingsContext.visualEffectsLevel>.4&&t.deviceContext.performanceLevel!=="low"&&l>.5,reason:`Depth visual effects (score: ${l.toFixed(2)}, visual-effects: ${t.settingsContext.visualEffectsLevel})`,score:l}),i}scoreDynamicCatppuccinStrategy(e){let t=.8;return e.settingsContext.dynamicAccentEnabled&&(t+=.2),e.musicContext?.energy&&e.musicContext.energy>.7&&(t+=.1),["cosmic","cinematic","ethereal","natural"].includes(e.settingsContext.visualGuideMode)&&(t+=.1),t+=.1,Math.min(1,t)}scoreLivingGradientStrategy(e){let t=.9;return e.settingsContext.pulsingAnimationEnabled&&(t+=.1),t+=e.settingsContext.visualEffectsLevel*.2,e.musicContext?.valence!==void 0&&(t+=.05),e.deviceContext.performanceLevel==="high"&&(t+=.05),Math.min(1,t)}scoreWebGLGradientStrategy(e){let t=0;if(!e.deviceContext.supportsWebGL||!e.settingsContext.webglEnabled)return 0;switch(t=.6,e.settingsContext.webglForceEnabled&&(t+=.4,u?.debug?.log("BackgroundStrategySelector","WebGL force enabled - boosting score by 0.4")),e.deviceContext.performanceLevel){case"high":t+=.3;break;case"medium":t+=.2;break;case"low":if(!e.settingsContext.webglForceEnabled)return 0;t+=.1;break}return e.deviceContext.memoryCapacity>4e3&&(t+=.1),e.deviceContext.memoryCapacity>8e3&&(t+=.1),e.settingsContext.visualEffectsLevel>.7&&(t+=.1),e.musicContext?.energy&&e.musicContext.energy>.8&&(t+=.1),e.deviceContext.isMobile&&(t-=.2),Math.min(1,Math.max(0,t))}scoreWebGLDegradedStrategy(e){let t=0;return!e.deviceContext.supportsWebGL||!e.settingsContext.webglEnabled||e.deviceContext.performanceLevel!=="low"?0:(t=.5,t+=.3,e.settingsContext.visualEffectsLevel>.5&&(t+=.1),e.musicContext?.energy&&e.musicContext.energy>.6&&(t+=.05),e.deviceContext.isMobile&&(t-=.1),e.deviceContext.memoryCapacity>2e3&&(t+=.05),Math.min(1,Math.max(0,t)))}scoreDepthLayeredStrategy(e){let t=0;if(!e.settingsContext.depthLayersEnabled)return 0;switch(t=.5,t+=e.settingsContext.visualEffectsLevel*.4,e.deviceContext.performanceLevel){case"high":t+=.2;break;case"medium":t+=.1;break;case"low":return t=0,0}return["cosmic","cinematic"].includes(e.settingsContext.visualGuideMode)&&(t+=.2),e.musicContext?.tempo&&e.musicContext.tempo<100&&(t+=.1),e.deviceContext.memoryCapacity>6e3&&(t+=.1),e.deviceContext.isMobile&&(t-=.15),Math.min(1,Math.max(0,t))}buildDeviceContext(){let e=window.navigator.deviceMemory?window.navigator.deviceMemory*1024:4096,t=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);return{supportsWebGL:this.deviceDetector.hasWebGLSupport(),performanceLevel:this.deviceDetector.recommendPerformanceQuality(),memoryCapacity:e,isMobile:t}}buildSettingsContext(){try{return{dynamicAccentEnabled:!0,gradientIntensity:A.get("sn-gradient-intensity"),webglEnabled:A.get("sn-webgl-enabled"),webglForceEnabled:A.get("sn-webgl-enabled"),visualGuideMode:A.get("sn-artistic-mode"),depthLayersEnabled:A.get("sn-gradient-intensity")!=="disabled",visualEffectsLevel:.8,pulsingAnimationEnabled:!0}}catch(e){return u?.debug?.warn("BackgroundStrategySelector","Failed to load settings, using defaults:",e),{dynamicAccentEnabled:!0,gradientIntensity:"balanced",webglEnabled:!0,webglForceEnabled:!1,visualGuideMode:"cosmic",depthLayersEnabled:!0,visualEffectsLevel:.8,pulsingAnimationEnabled:!0}}}getOrCreateStrategy(e){if(this.strategyInstances.has(e))return this.strategyInstances.get(e);let t=null;try{switch(e){case"dynamic-catppuccin":t=new di;break;case"living-gradient":t=new Et;break;case"webgl-gradient":t=new Pt;break;case"webgl-gradient-degraded":t=new Pt;break;case"depth-layered":t=new mi;break;default:return u?.debug?.warn("BackgroundStrategySelector",`Unknown strategy: ${e}`),null}t&&(this.strategyInstances.set(e,t),u?.debug?.log("BackgroundStrategySelector",`Created strategy instance: ${e}`))}catch(i){return u?.debug?.error("BackgroundStrategySelector",`Failed to create strategy ${e}:`,i),null}return t}getEstimatedProcessingTime(e,t){return e.reduce((i,a)=>i+a.getEstimatedProcessingTime(t),0)}getStrategyMetadata(e){return this.strategyMetadata.get(e)||null}getAvailableStrategyNames(){return Array.from(this.strategyMetadata.keys())}updateSelectionCriteria(e){u?.debug?.log("BackgroundStrategySelector","Strategy selection criteria updated:",e)}destroy(){this.strategyInstances.forEach((e,t)=>{if("destroy"in e&&typeof e.destroy=="function")try{e.destroy()}catch(i){u?.debug?.warn("BackgroundStrategySelector",`Error destroying strategy ${t}:`,i)}}),this.strategyInstances.clear(),this.strategyMetadata.clear(),u?.debug?.log("BackgroundStrategySelector","Strategy selector destroyed")}}});var Va,Fa,lt,hi=y(()=>{"use strict";U();L();ue();x();Fe();ae();X();Ba();Va=class{constructor(){this.strategies=new Map;this.defaultStrategy=null}register(e){let t=e.getStrategyName();this.strategies.set(t,e),this.defaultStrategy||(this.defaultStrategy=e),u?.debug?.log("ColorStrategyRegistry",`Registered strategy: ${t}`)}selectStrategy(e){if(e.performance==="high"&&e.quality==="basic")for(let t of this.strategies.values()){let i=t.getStrategyName().toLowerCase();if(i.includes("lightweight")||i.includes("fast"))return t}if(e.quality==="premium"&&e.performance==="low")for(let t of this.strategies.values()){let i=t.getStrategyName().toLowerCase();if(i.includes("harmony")||i.includes("advanced"))return t}if(e.deviceCapabilities?.isMobile)for(let t of this.strategies.values()){let i=t.getStrategyName().toLowerCase();if(i.includes("mobile")||i.includes("optimized"))return t}return this.defaultStrategy}getStrategies(){return Array.from(this.strategies.values())}getStrategy(e){return this.strategies.get(e)||null}setDefaultStrategy(e){this.defaultStrategy=e}getStatus(){return{strategyCount:this.strategies.size,strategies:Array.from(this.strategies.keys()),defaultStrategy:this.defaultStrategy?.getStrategyName()||null}}},Fa=class{constructor(){this.systemName="ColorCoordinator";this.initialized=!1;this.isInitialized=!1;this.processingQueue=[];this.isProcessing=!1;this.currentStrategy=null;this.oklabCoordinationEnabled=!0;this.processedContexts=new Map;this.CONTEXT_CACHE_TTL=2e3;this.MAX_QUEUE_SIZE=10;this.resultCache=new Map;this.cacheMaxSize=50;this.cacheTimeoutMs=3e5;this.orchestrationMetrics={totalProcessingTime:0,strategiesProcessed:0,strategiesSucceeded:0,strategiesFailed:0,cacheHits:0,averageStrategyTime:0,memoryUsage:0,oklabCoordinations:0,oklabProcessingTime:0};this.processedCount=0;this.totalProcessingTime=0;this.lastProcessingTime=0;this.registry=new Va,this.settingsManager=new ee;let e=globalThis.year3000System;this.performanceAnalyzer=e?.performanceAnalyzer||e?.facadeCoordinator?.getCachedNonVisualSystem?.("SimplePerformanceCoordinator")||null,this.deviceDetector=new N,this.strategySelector=new ct,this.oklabProcessor=new M(E.enableDebug),this.selectionCriteria={performance:"medium",quality:"enhanced",deviceCapabilities:{hasWebGL:!!window.WebGLRenderingContext,memoryMB:this.estimateMemoryMB(),isMobile:this.detectMobile()},userPreferences:{harmonicMode:"cosmic",intensity:.8,enableAdvancedBlending:!0}},this.updateDeviceCapabilities(),u?.debug?.log("ColorOrchestrator","Enhanced color orchestrator created with multi-strategy coordination")}async initialize(){if(this.isInitialized){u?.debug?.warn("ColorOrchestrator","Already initialized");return}try{p.subscribe("colors:extracted",this.handleColorExtractionEvent.bind(this),"ColorOrchestrator"),this.updateDeviceCapabilities(),this.loadUserPreferences(),await this.registerDefaultStrategies(),this.isInitialized=!0,this.initialized=!0,u?.debug?.log("ColorOrchestrator","Enhanced color orchestrator initialized",{strategies:this.registry.getStatus().strategyCount,criteria:this.selectionCriteria,oklabEnabled:this.oklabCoordinationEnabled,deviceLevel:this.deviceDetector.recommendPerformanceQuality()})}catch(e){throw u?.debug?.error("ColorOrchestrator","Enhanced initialization failed:",e),e}}async handleColorExtractionEvent(e){let t=e;await this.handleColorExtraction(t)}async handleColorExtraction(e){let t=Date.now(),i=e.trackUri||"unknown";u?.debug?.log("ColorOrchestrator","\u{1F3B5} Color Extraction Event Received - WebGL Gradient Entry Point",{trackUri:i,rawColors:e.rawColors,colorCount:Object.keys(e.rawColors).length,isProcessing:this.isProcessing,queueLength:this.processingQueue.length,entryPoint:"handleColorExtraction"});let a=this.processedContexts.get(i);if(a&&t-a<this.CONTEXT_CACHE_TTL){u?.debug?.warn("ColorOrchestrator",`Skipping recent context to prevent recursion: ${i}`,{lastProcessed:new Date(a).toISOString(),timeDiff:t-a});return}let r=this.generateCacheKey(e),n=this.getCachedResult(r);if(n){this.orchestrationMetrics.cacheHits++,await this.applyColorResult(n),u?.debug?.log("ColorOrchestrator","Using cached color result",{cacheKey:r});return}this.processingQueue.length>=this.MAX_QUEUE_SIZE&&(u?.debug?.warn("ColorOrchestrator",`Queue overflow protection: dropping context ${i}`,{queueSize:this.processingQueue.length,maxSize:this.MAX_QUEUE_SIZE}),this.processingQueue.shift()),this.cleanupProcessedContexts(t),this.processingQueue.push(e),this.isProcessing||await this.processQueue()}async processQueue(){if(!(this.isProcessing||this.processingQueue.length===0)){this.isProcessing=!0;try{for(;this.processingQueue.length>0;){let e=this.processingQueue.shift();await this.processColorContext(e)}}catch(e){u?.debug?.error("ColorOrchestrator","Queue processing failed:",e)}finally{this.isProcessing=!1,this.currentStrategy=null}}}cleanupProcessedContexts(e){for(let[t,i]of this.processedContexts.entries())e-i>this.CONTEXT_CACHE_TTL&&this.processedContexts.delete(t)}async processColorContext(e){let t=performance.now(),i=e.trackUri||"unknown";u?.debug?.log("ColorOrchestrator","\u{1F3A8} Processing Color Context - WebGL Gradient Recovery Debug",{trackUri:i,rawColors:e.rawColors,colorCount:Object.keys(e.rawColors).length,musicData:e.musicData,timestamp:new Date().toISOString()});try{let a=this.strategySelector.selectStrategies(e,this.buildStrategySelectionCriteria(e));if(a.length===0){let l=this.selectStrategy(e);if(l)a.push(l);else throw new Error("No suitable strategies selected for color processing")}let r=await this.processWithStrategies(e,a);this.oklabCoordinationEnabled&&r.filter(l=>l.success).length>1&&await this.coordinateOKLABProcessing(r,e);let n=this.mergeStrategyResults(r,e),s=this.generateCacheKey(e);this.cacheResult(s,n),await this.applyColorResult(n),this.processedContexts.set(i,Date.now());let o=performance.now()-t;this.updateOrchestrationMetrics(r,o),this.lastProcessingTime=o,this.totalProcessingTime+=o,this.processedCount++,u?.debug?.log("ColorOrchestrator","Enhanced color processing completed",{strategies:a.map(l=>l.getStrategyName()),processingTime:o,trackUri:e.trackUri,oklabCoordination:this.oklabCoordinationEnabled,successfulStrategies:r.filter(l=>l.success).length})}catch(a){let r=performance.now();this.lastProcessingTime=r-t,u?.debug?.error("ColorOrchestrator","Enhanced color processing failed:",{error:a,strategy:this.currentStrategy,trackUri:e.trackUri}),await this.applyFallbackColors(e)}}selectStrategy(e){let t={...this.selectionCriteria};return e.performanceHints&&(e.performanceHints.preferLightweight&&(t.performance="high",t.quality="basic"),e.performanceHints.enableAdvancedBlending&&(t.quality="premium")),e.musicData&&e.musicData.energy&&e.musicData.energy>.8&&(t.quality="premium"),this.registry.selectStrategy(t)}async registerDefaultStrategies(){u?.debug?.log("ColorOrchestrator","Default strategies registration completed")}async processWithStrategies(e,t){let i=[],a=t.map(async n=>{let s=performance.now();this.currentStrategy=n.getStrategyName();try{let o=await n.processColors(e),l=performance.now()-s;return{strategy:n,result:o,processingTime:l,success:!0}}catch(o){let l=performance.now()-s;return u?.debug?.error("ColorOrchestrator",`Strategy ${n.getStrategyName()} failed:`,o),{strategy:n,result:this.createErrorResult(e,n,o),processingTime:l,success:!1,error:o instanceof Error?o.message:"Unknown error"}}});return await Promise.all(a)}mergeStrategyResults(e,t){let i=e.filter(r=>r.success);if(i.length===0)return this.createFallbackResult(t);if(i.length===1)return i[0].result;let a={priorityWeighting:!0,conflictResolution:"merge",preserveMetadata:!0,visualEffectsBlending:!0,oklabCoordination:this.oklabCoordinationEnabled};return this.performResultMerge(i,t,a)}performResultMerge(e,t,i){let a=e.sort((s,o)=>{let l=this.strategySelector.getStrategyMetadata(s.strategy.getStrategyName())?.priority||0;return(this.strategySelector.getStrategyMetadata(o.strategy.getStrategyName())?.priority||0)-l}),r=a[0].result,n={processedColors:{...r.processedColors},accentHex:r.accentHex,accentRgb:r.accentRgb,metadata:{...r.metadata,strategy:"enhanced-orchestrator",mergedStrategies:a.map(s=>s.strategy.getStrategyName()),totalProcessingTime:a.reduce((s,o)=>s+o.processingTime,0)},context:t};for(let s=1;s<a.length;s++){let o=a[s].result;if(Object.entries(o.processedColors).forEach(([l,m])=>{if(i.conflictResolution==="override")s===1&&(n.processedColors[l]=m);else if(i.conflictResolution==="merge"){let d=o.metadata.strategy;n.processedColors[`${d}-${l}`]=m}}),i.preserveMetadata){let l=o.metadata.strategy;n.metadata[`${l}-metadata`]=o.metadata}}return i.visualEffectsBlending&&this.applyVisualEffectsBlending(n,a),i.oklabCoordination&&this.applyOKLABCoordination(n,a),n}applyVisualEffectsBlending(e,t){let i=0,a=0,r=0,n=0;if(t.forEach(s=>{let l=(this.strategySelector.getStrategyMetadata(s.strategy.getStrategyName())?.qualityScore||5)/10,m=this.hexToRgb(s.result.accentHex);m&&(a+=m.r*l,r+=m.g*l,n+=m.b*l,i+=l)}),i>0){let s=Math.round(a/i),o=Math.round(r/i),l=Math.round(n/i);e.accentHex=this.rgbToHex(s,o,l),e.accentRgb=`${s},${o},${l}`,e.metadata.visualEffectsBlending={strategyCount:t.length,totalWeight:i,blendedAccent:e.accentHex}}}async coordinateOKLABProcessing(e,t){let i=performance.now();try{let a=e.filter(l=>l.success),r={};a.forEach(l=>{Object.entries(l.result.processedColors).forEach(([m,d])=>{d&&d.startsWith("#")&&(r[`${l.strategy.getStrategyName()}-${m}`]=d)})});let n=this.getOptimalOKLABPreset(t),s=this.oklabProcessor.processColorPalette(r,n);a.forEach(l=>{let m=l.strategy.getStrategyName();l.oklabData=Object.values(s).filter(d=>d.originalHex in r&&Object.keys(r).find(h=>h.startsWith(m)&&r[h]===d.originalHex))});let o=performance.now()-i;this.orchestrationMetrics.oklabCoordinations++,this.orchestrationMetrics.oklabProcessingTime+=o,u?.debug?.log("ColorOrchestrator","OKLAB coordination completed",{strategiesCoordinated:a.length,colorsProcessed:Object.keys(r).length,preset:n.name,processingTime:o})}catch(a){u?.debug?.error("ColorOrchestrator","OKLAB coordination failed:",a)}}applyOKLABCoordination(e,t){try{let i=[];if(t.forEach(r=>{r.oklabData&&i.push(...r.oklabData)}),i.length===0)return;let a=this.calculatePerceptuallyUniformAccent(i);if(a){e.accentHex=a.enhancedHex,e.accentRgb=`${a.enhancedRgb.r},${a.enhancedRgb.g},${a.enhancedRgb.b}`;let r=this.oklabProcessor.generateCSSVariables(a,"sn-oklab-unified");Object.entries(r).forEach(([n,s])=>{e.processedColors[n]=s}),e.metadata.oklabCoordination={enabled:!0,strategiesCoordinated:t.length,colorsProcessed:i.length,perceptualAccent:a.enhancedHex,lightness:a.oklabEnhanced.L,chroma:a.oklchEnhanced.C,hue:a.oklchEnhanced.H}}}catch(i){u?.debug?.error("ColorOrchestrator","OKLAB coordination application failed:",i)}}calculatePerceptuallyUniformAccent(e){if(e.length===0)return null;if(e.length===1)return e[0]||null;let t=0,i=0,a=0,r=0;if(e.forEach(m=>{let d=Math.sqrt(m.oklabEnhanced.a**2+m.oklabEnhanced.b**2),h=Math.max(.1,d);i+=m.oklabEnhanced.L*h,a+=m.oklabEnhanced.a*h,r+=m.oklabEnhanced.b*h,t+=h}),t===0)return e[0]||null;let n={L:i/t,a:a/t,b:r/t},s=wa(n.L,n.a,n.b),o=Se(s.r,s.g,s.b),l=M.getPreset("STANDARD");return this.oklabProcessor.processColor(o,l)}getStatus(){return{isProcessing:this.isProcessing,...this.currentStrategy?{currentStrategy:this.currentStrategy}:{},queueSize:this.processingQueue.length,processedContextsCount:this.processedContexts.size,maxQueueSize:this.MAX_QUEUE_SIZE,contextCacheTTL:this.CONTEXT_CACHE_TTL,orchestrationMetrics:{...this.orchestrationMetrics},oklabCoordinationEnabled:this.oklabCoordinationEnabled}}setSelectionCriteria(e){this.selectionCriteria={...this.selectionCriteria,...e},u?.debug?.log("ColorOrchestrator","Selection criteria updated",e)}getPerformanceMetrics(){return{processedCount:this.processedCount,averageProcessingTime:this.processedCount>0?this.totalProcessingTime/this.processedCount:0,lastProcessingTime:this.lastProcessingTime,totalProcessingTime:this.totalProcessingTime}}registerStrategy(e){this.registry.register(e)}getRegistry(){return this.registry}estimateMemoryMB(){let e=performance.memory;return e&&e.usedJSHeapSize&&e.jsHeapSizeLimit?(e.jsHeapSizeLimit-e.usedJSHeapSize)/(1024*1024):this.detectMobile()?256:1024}detectMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}buildStrategySelectionCriteria(e){return{...this.selectionCriteria,settingsContext:{dynamicAccentEnabled:this.settingsManager.get("sn-dynamic-accent-enabled")??!0,gradientIntensity:this.settingsManager.get("sn-gradient-intensity")??"balanced",webglEnabled:this.settingsManager.get("sn-webgl-enabled")??!0,visualGuideMode:this.settingsManager.get("sn-visual-guide-mode")??"cosmic",depthLayersEnabled:this.settingsManager.get("sn-depth-enabled")??!0,visualEffectsLevel:this.settingsManager.get("sn-visual-effects-level")??.8,pulsingAnimationEnabled:this.settingsManager.get("sn-pulsing-enabled")??!0},musicContext:e.musicData,deviceContext:{supportsWebGL:this.deviceDetector.hasWebGLSupport?this.deviceDetector.hasWebGLSupport():!1,performanceLevel:this.deviceDetector.recommendPerformanceQuality(),memoryCapacity:window.navigator.deviceMemory?window.navigator.deviceMemory*1024:4096,isMobile:/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}}}getOptimalOKLABPreset(e){let t=this.selectionCriteria.userPreferences?.intensity||.8,i=e.musicData?.energy||.5,a=(t+i)/2;return a>=.8?M.getPreset("COSMIC"):a>=.6?M.getPreset("VIBRANT"):a>=.4?M.getPreset("STANDARD"):M.getPreset("SUBTLE")}async applyColorResult(e){try{p.emit("colors:harmonized",{processedColors:e.processedColors,accentHex:e.accentHex||"#cba6f7",accentRgb:e.accentRgb||"203,166,247",strategies:[e.metadata.strategy],processingTime:e.metadata.processingTime,trackUri:e.metadata.trackUri,coordinationMetrics:{detectedGenre:e.metadata.genre||"unknown",emotionalState:e.metadata.emotion||"neutral",oklabPreset:e.metadata.oklabPreset||"default",coordinationStrategy:e.metadata.strategy,musicInfluenceStrength:e.metadata.intensity||.5},processingMode:"orchestrated"});let t=new CustomEvent("colors/harmonized",{detail:{type:"colors/harmonized",payload:{...e,cssVariables:e.processedColors}}});document.dispatchEvent(t)}catch(t){u?.debug?.error("ColorOrchestrator","Failed to apply color result:",t)}}generateCacheKey(e){return`${e.trackUri}-${e.timestamp}-${JSON.stringify(e.musicData||{})}`}getCachedResult(e){return this.resultCache.get(e)||null}cacheResult(e,t){if(this.resultCache.size>=this.cacheMaxSize){let i=this.resultCache.keys().next().value;i&&this.resultCache.delete(i)}this.resultCache.set(e,t),setTimeout(()=>{this.resultCache.delete(e)},this.cacheTimeoutMs)}updateDeviceCapabilities(){this.selectionCriteria.deviceCapabilities={hasWebGL:this.deviceDetector.hasWebGLSupport?this.deviceDetector.hasWebGLSupport():!1,memoryMB:window.navigator.deviceMemory?window.navigator.deviceMemory*1024:4096,isMobile:/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}}loadUserPreferences(){try{this.selectionCriteria.userPreferences={harmonicMode:this.settingsManager.get("sn-visual-guide-mode")??"cosmic",intensity:this.settingsManager.get("sn-visual-effects-level")??.8,enableAdvancedBlending:this.settingsManager.get("sn-advanced-blending")??!0}}catch(e){u?.debug?.warn("ColorOrchestrator","Failed to load user preferences:",e)}}createErrorResult(e,t,i){return{processedColors:e.rawColors,accentHex:"#cba6f7",accentRgb:"203,166,247",metadata:{strategy:t.getStrategyName(),processingTime:0,error:i instanceof Error?i.message:"Unknown error"},context:e}}createFallbackResult(e){return{processedColors:e.rawColors,accentHex:"#cba6f7",accentRgb:"203,166,247",metadata:{strategy:"fallback",processingTime:0,error:"All strategies failed"},context:e}}async applyFallbackColors(e){let t=this.createFallbackResult(e);await this.applyColorResult(t)}updateOrchestrationMetrics(e,t){this.orchestrationMetrics.totalProcessingTime+=t,this.orchestrationMetrics.strategiesProcessed+=e.length,this.orchestrationMetrics.strategiesSucceeded+=e.filter(a=>a.success).length,this.orchestrationMetrics.strategiesFailed+=e.filter(a=>!a.success).length;let i=e.filter(a=>a.success).map(a=>a.processingTime);i.length>0&&(this.orchestrationMetrics.averageStrategyTime=i.reduce((a,r)=>a+r,0)/i.length)}hexToRgb(e){let t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}rgbToHex(e,t,i){return"#"+((1<<24)+(e<<16)+(t<<8)+i).toString(16).slice(1)}getOrchestrationMetrics(){return{...this.orchestrationMetrics}}clearCache(){this.resultCache.clear(),u?.debug?.log("ColorOrchestrator","Result cache cleared")}setOKLABCoordinationEnabled(e){this.oklabCoordinationEnabled=e,u?.debug?.log("ColorOrchestrator",`OKLAB coordination ${e?"enabled":"disabled"}`)}isOKLABCoordinationEnabled(){return this.oklabCoordinationEnabled}getOKLABProcessor(){return this.oklabProcessor}updateAnimation(e){if(this.initialized)try{!this.isProcessing&&this.processingQueue.length>0&&this.processQueue().catch(i=>{u?.debug?.error("ColorCoordinator","Queue processing error in animation loop:",i)});let t=performance.memory;t&&(this.orchestrationMetrics.memoryUsage=t.usedJSHeapSize/(1024*1024))}catch(t){u?.debug?.error("ColorCoordinator","Animation update error:",t)}}async healthCheck(){try{let e=this.getOrchestrationMetrics(),t=this.registry.getStatus(),i="healthy",a=[];this.isInitialized||(i="critical",a.push("System not initialized")),t.strategyCount===0&&(i="critical",a.push("No color processing strategies registered")),this.processingQueue.length>=this.MAX_QUEUE_SIZE*.8&&(i=i==="critical"?"critical":"degraded",a.push(`Processing queue near capacity: ${this.processingQueue.length}/${this.MAX_QUEUE_SIZE}`));let r=e.strategiesSucceeded+e.strategiesFailed;if(r>0){let s=e.strategiesFailed/r;s>.5?(i="critical",a.push(`High failure rate: ${(s*100).toFixed(1)}%`)):s>.2&&(i=i==="critical"?"critical":"degraded",a.push(`Moderate failure rate: ${(s*100).toFixed(1)}%`))}e.memoryUsage>100&&(i=i==="critical"?"critical":"degraded",a.push(`High memory usage: ${e.memoryUsage.toFixed(1)}MB`));let n=a.length===0?`Color coordination system healthy (${t.strategyCount} strategies)`:`Color coordination issues: ${a.join(", ")}`;return{healthy:i==="healthy",ok:i!=="critical",details:`${n} - Status: ${i}`,system:"ColorCoordinator",issues:a,metrics:{initialized:this.isInitialized,strategies:t,orchestrationMetrics:e,queueSize:this.processingQueue.length,isProcessing:this.isProcessing,oklabEnabled:this.oklabCoordinationEnabled,status:i}}}catch(e){return{healthy:!1,ok:!1,details:`Health check failed: ${e}`,system:"ColorCoordinator",issues:["Health check exception"],metrics:{error:String(e)}}}}forceRepaint(e){u?.debug?.log("ColorCoordinator",`Force repaint requested${e?`: ${e}`:""}`);try{this.clearCache(),this.processedContexts.clear(),this.loadUserPreferences(),this.updateDeviceCapabilities(),this.processingQueue.length>0&&!this.isProcessing&&this.processQueue().catch(t=>{u?.debug?.error("ColorCoordinator","Force repaint queue processing error:",t)}),u?.debug?.log("ColorCoordinator","Force repaint completed",{cacheCleared:!0,contextsCleared:this.processedContexts.size===0,queueSize:this.processingQueue.length})}catch(t){u?.debug?.error("ColorCoordinator","Force repaint error:",t)}}async destroy(){p.unsubscribeAll("ColorOrchestrator"),this.clearCache(),this.processingQueue=[],this.isProcessing=!1,this.isInitialized=!1,this.initialized=!1,this.processedContexts.clear(),this.strategySelector.destroy(),u?.debug?.log("ColorOrchestrator","Enhanced color orchestrator destroyed")}},lt=new Fa});var ut,Ga,Ha,_a,za,Ua=y(()=>{"use strict";ut=class{constructor(e={}){this.initialized=!1;this.emotionHistory=[];this.currentEmotion=null;this.emotionCache=new Map;this.emotionSubscribers=new Set;this.config={emotionSensitivity:.7,confidenceThreshold:.6,smoothingFactor:.3,memoryDecay:.1,visualEffectsAwareness:!0,smoothFlowDetection:!0,cinematicAnalysis:!0,analysisInterval:500,cacheSize:100,...e},this.valenceEnergyMapper=new Ga,this.audioFeatureAnalyzer=new Ha,this.temperatureCalculator=new _a,this.visualEffectsDetector=new za}async initialize(){if(!this.initialized)try{await this.valenceEnergyMapper.initialize(),await this.audioFeatureAnalyzer.initialize(),await this.temperatureCalculator.initialize(),this.config.visualEffectsAwareness&&await this.visualEffectsDetector.initialize(),this.initialized=!0,console.log("\u{1F3B5} MusicEmotionAnalyzer initialized with visual effects awareness")}catch(e){throw console.error("\u274C Failed to initialize MusicEmotionAnalyzer:",e),e}}updateAnimation(e){}async healthCheck(){let e=[];return this.initialized||e.push("MusicEmotionAnalyzer not initialized"),this.emotionHistory.length===0&&e.push("No emotion analysis history available"),this.currentEmotion&&this.currentEmotion.confidence<this.config.confidenceThreshold&&e.push(`Low emotion confidence: ${this.currentEmotion.confidence.toFixed(2)}`),{healthy:e.length===0,issues:e,metrics:{emotionHistorySize:this.emotionHistory.length,currentConfidence:this.currentEmotion?.confidence??0,subscriberCount:this.emotionSubscribers.size,cacheSize:this.emotionCache.size}}}destroy(){this.emotionSubscribers.clear(),this.emotionHistory=[],this.emotionCache.clear(),this.currentEmotion=null,this.initialized=!1}async analyzeEmotion(e,t){if(!this.initialized)throw new Error("MusicEmotionAnalyzer must be initialized before analysis");try{let i=this.createCacheKey(e);if(this.emotionCache.has(i)){let r=this.emotionCache.get(i);if(r)return this.updateCurrentEmotion(r),r}let a=await this.performEmotionAnalysis(e,t);return this.cacheEmotion(i,a),this.updateCurrentEmotion(a),this.notifyEmotionUpdate(a),a}catch(i){return console.error("\u274C Error analyzing emotion:",i),this.createNeutralEmotion(e)}}getCurrentEmotion(){return this.currentEmotion}getEmotionHistory(e){return e?this.emotionHistory.slice(-e):[...this.emotionHistory]}onEmotionUpdate(e){return this.emotionSubscribers.add(e),()=>{this.emotionSubscribers.delete(e)}}updateConfig(e){this.config={...this.config,...e}}async performEmotionAnalysis(e,t){let i=this.audioFeatureAnalyzer.extractCharacteristics(e),a=this.valenceEnergyMapper.mapToEmotion(e.valence,e.energy,i),r=this.temperatureCalculator.calculateTemperature(a,i),n={};this.config.visualEffectsAwareness&&(n=await this.visualEffectsDetector.analyze(e,i,t));let s=this.applyTemporalSmoothing(a,i);return{primary:s.primary,secondary:s.secondary,intensity:s.intensity,confidence:s.confidence,valence:e.valence,arousal:e.energy,dominance:this.calculateDominance(e,i),colorTemperature:r,timestamp:Date.now(),duration:this.calculateEmotionDuration(s,i),musicalCharacteristics:{...i,smoothFlow:n.smoothFlow??i.smoothFlow,cinematicDepth:n.cinematicDepth??i.cinematicDepth,visualEffectsResonance:n.visualEffectsResonance??.5}}}applyTemporalSmoothing(e,t){if(!this.currentEmotion||this.config.smoothingFactor===0)return e;let i=this.config.smoothingFactor,a=e.intensity*(1-i)+this.currentEmotion.intensity*i,r=e.confidence*(1-i)+this.currentEmotion.confidence*i;return{primary:e.confidence>this.config.confidenceThreshold?e.primary:this.currentEmotion.primary,secondary:e.secondary,intensity:a,confidence:r}}calculateDominance(e,t){let i=Math.min(t.tempo/140,1),a=e.energy,r=Math.min((e.loudness+60)/60,1);return i*.3+a*.4+r*.3}calculateEmotionDuration(e,t){let a=6e4/t.tempo,r=e.confidence*2;return Math.min(2e3*a*r,1e4)}createCacheKey(e){return[Math.round(e.valence*100),Math.round(e.energy*100),Math.round(e.danceability*100),Math.round(e.acousticness*100),e.key,e.mode].join("-")}cacheEmotion(e,t){if(this.emotionCache.size>=this.config.cacheSize){let i=this.emotionCache.keys().next().value;i!==void 0&&this.emotionCache.delete(i)}this.emotionCache.set(e,t)}updateCurrentEmotion(e){this.currentEmotion=e,this.emotionHistory.push(e),this.emotionHistory.length>1e3&&(this.emotionHistory=this.emotionHistory.slice(-500))}notifyEmotionUpdate(e){this.emotionSubscribers.forEach(t=>{try{t(e)}catch(i){console.error("\u274C Error in emotion subscriber callback:",i)}})}createNeutralEmotion(e){return{primary:"serenity",secondary:[],intensity:.5,confidence:.3,valence:e.valence??.5,arousal:e.energy??.5,dominance:.5,colorTemperature:6500,timestamp:Date.now(),duration:3e3,musicalCharacteristics:this.audioFeatureAnalyzer.extractCharacteristics(e)}}},Ga=class{async initialize(){}mapToEmotion(e,t,i){let a,r=[],n,s=.8;return e>=.6&&t>=.6?(a=i.danceability>.7?"excitement":"joy",r=["joy","excitement"],n=Math.min(e+t-.2,1)):e>=.6&&t<.4?(a=i.acousticness>.6?"serenity":"love",r=["serenity","love"],n=e*.8):e<.4&&t>=.6?(a=i.mode===0?"anger":"fear",r=["anger","fear"],n=t):e<.4&&t<.4?(a=i.acousticness>.5?"melancholy":"sadness",r=["sadness","melancholy"],n=(1-e)*.8):(i.instrumentalness>.8?(a="transcendence",r=["transcendence","visual-effects"]):(a="nostalgia",r=["nostalgia"]),n=Math.abs(e-.5)+Math.abs(t-.5),s=.6),i.smoothFlow>.8&&r.push("smooth-flow"),i.visualEffectsResonance>.7&&r.push("visual-effects"),{primary:a,secondary:r,intensity:n,confidence:s}}},Ha=class{async initialize(){}extractCharacteristics(e){return{tempo:e.tempo,key:e.key,mode:e.mode,timeSignature:e.timeSignature,energy:e.energy,danceability:e.danceability,acousticness:e.acousticness,instrumentalness:e.instrumentalness,liveness:e.liveness,speechiness:e.speechiness,smoothFlow:this.calculateSmoothFlow(e),cinematicDepth:this.calculateCinematicDepth(e),visualEffectsResonance:this.calculateVisualEffectsResonance(e)}}calculateSmoothFlow(e){let t=e.acousticness*.4,i=(1-Math.min(e.tempo/140,1))*.3,a=(1-e.energy)*.2,r=e.danceability*.1;return Math.min(t+i+a+r,1)}calculateCinematicDepth(e){let t=e.instrumentalness*.4,i=(1-e.liveness)*.2,a=(1-e.speechiness)*.2,r=Math.abs(e.energy-.5)*.2;return Math.min(t+i+a+r,1)}calculateVisualEffectsResonance(e){let t=1-Math.abs(e.valence-.5)*2,i=1-Math.abs(e.energy-.4)*2,a=e.instrumentalness*.3,r=e.acousticness*.2;return Math.max(0,(t+i)*.5+a+r)}},_a=class{async initialize(){}calculateTemperature(e,t){let i;switch(e.primary){case"joy":case"excitement":i=8e3;break;case"love":case"serenity":i=3e3;break;case"anger":i=15e3;break;case"fear":i=12e3;break;case"sadness":case"melancholy":i=2e3;break;case"nostalgia":i=2500;break;case"transcendence":case"visual-effects":i=6500;break;case"smooth-flow":i=4e3;break;default:i=6500}let a=(e.intensity-.5)*2e3,r=(t.tempo-120)*10,n=(t.energy-.5)*1e3,s=i+a+r+n;return Math.max(1e3,Math.min(2e4,s))}},za=class{async initialize(){}async analyze(e,t,i){let a=t.smoothFlow,r=t.cinematicDepth,n=t.visualEffectsResonance;if(i?.waveform){let s=this.analyzeWaveformPatterns(i.waveform);a=Math.min(1,a+s.smoothness*.2),r=Math.min(1,r+s.dynamicRange*.3),n=Math.min(1,n+s.harmonicComplexity*.2)}return{smoothFlow:a,cinematicDepth:r,visualEffectsResonance:n}}analyzeWaveformPatterns(e){let t=0,i=0,a=0;if(e.length>1){let r=0;for(let o=1;o<e.length;o++){let l=e[o],m=e[o-1];l!==void 0&&m!==void 0&&(r+=Math.abs(l-m))}t=1-Math.min(r/e.length,1);let n=Math.max(...e),s=Math.min(...e);i=n-s,a=Math.min(this.estimateHarmonicContent(e),1)}return{smoothness:t,dynamicRange:i,harmonicComplexity:a}}estimateHarmonicContent(e){let t=0;for(let i=1;i<e.length;i++){let a=e[i],r=e[i-1];a!==void 0&&r!==void 0&&a>=0!=r>=0&&t++}return Math.min(t/(e.length*.1),1)}}});var Ge,Xe,Oa=y(()=>{"use strict";ei();ya();L();x();Me();ae();Ct();En();X();ka();de();hi();Ua();Ge=class Ge extends j{constructor(t,i,a,r){super(t,i||D,a,null,r||null);this.animationEngine=null;this.userIntensity=.7;this.evolutionEnabled=!0;this._evolutionTimer=null;this._pendingPaletteRefresh=null;this._lastGenre=null;this.systemName="ColorHarmonyEngine",this.paletteExtensionManager=new li(this.config,this.utils),this.semanticColorManager=new ot({enableDebug:this.config.enableDebug,fallbackToSpiceColors:!0,cacheDuration:5e3}),this.currentTheme=this.detectCurrentTheme();let n=t;if(n&&typeof n.colorHarmonyIntensity=="number"&&Number.isFinite(n.colorHarmonyIntensity)){let s=Math.max(0,Math.min(1,n.colorHarmonyIntensity));this.userIntensity=s}this.harmonyMetrics={totalHarmonyCalculations:0,musicInfluencedAdjustments:0,temporalMemoryEvents:0,performance:[]},this.musicalMemory={recentTracks:[],userColorPreferences:new Map,energyHistory:[],maxMemorySize:50},this.kineticState={currentPulse:0,animationPhase:0,lastBeatTime:0,visualMomentum:0},this.catppuccinPalettes={frappe:{accents:{rosewater:"#f2d5cf",flamingo:"#eebebe",pink:"#ff6b9d",mauve:"#c77dff",red:"#ff4757",maroon:"#ea999c",peach:"#ff7675",yellow:"#fdcb6e",green:"#6c5ce7",teal:"#00cec9",sky:"#74b9ff",sapphire:"#0984e3",blue:"#a29bfe",lavender:"#fd79a8"},neutrals:{base:"#303446",surface0:"#414559",surface1:"#51576d",surface2:"#626880"}},latte:{accents:{rosewater:"#dc8a78",flamingo:"#dd7878",pink:"#e84393",mauve:"#a55eea",red:"#fd79a8",maroon:"#e64553",peach:"#fd7f28",yellow:"#f39c12",green:"#00b894",teal:"#00cec9",sky:"#0984e3",sapphire:"#6c5ce7",blue:"#74b9ff",lavender:"#a29bfe"},neutrals:{base:"#eff1f5",surface0:"#e6e9ef",surface1:"#dce0e8",surface2:"#c5c9d1"}},macchiato:{accents:{rosewater:"#f4dbd6",flamingo:"#f0c6c6",pink:"#ff6b9d",mauve:"#c77dff",red:"#ff4757",maroon:"#ee99a0",peach:"#ff7675",yellow:"#fdcb6e",green:"#6c5ce7",teal:"#00cec9",sky:"#74b9ff",sapphire:"#0984e3",blue:"#a29bfe",lavender:"#fd79a8"},neutrals:{base:"#24273a",surface0:"#363a4f",surface1:"#494d64",surface2:"#5b6078"}},mocha:{accents:{rosewater:"#f5e0dc",flamingo:"#f2cdcd",pink:"#ff6b9d",mauve:"#c77dff",red:"#ff4757",maroon:"#eba0ac",peach:"#ff7675",yellow:"#fdcb6e",green:"#6c5ce7",teal:"#00cec9",sky:"#74b9ff",sapphire:"#0984e3",blue:"#a29bfe",lavender:"#fd79a8"},neutrals:{base:"#1e1e2e",surface0:"#313244",surface1:"#45475a",surface2:"#585b70"}}},this.vibrancyConfig={defaultBlendRatio:.75,minimumSaturation:.6,maximumDesaturation:.1,contrastBoostIntensity:1.4,harmonyTolerance:.3,artisticSaturationBoost:1.35,enhancedLuminanceBoost:1.25,energyResponsiveness:.8,getBlendRatio(s="artist-vision"){return{"corporate-safe":.6,"artist-vision":.75,"advanced-maximum":.85,"cosmic-maximum":.85}[s]||this.defaultBlendRatio}},this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Initialized with Year 3000 Quantum Empathy"),t&&typeof t.colorHarmonyEvolution=="boolean"?this.evolutionEnabled=t.colorHarmonyEvolution:t&&typeof t.harmonicEvolution=="boolean"&&(this.evolutionEnabled=t.harmonicEvolution),this.emotionalTemperatureMapper=new Z(this.config.enableDebug),this.oklabProcessor=new M(this.config.enableDebug),this.musicEmotionAnalyzer=new ut({emotionSensitivity:.7,confidenceThreshold:.6,visualEffectsAwareness:!0,smoothFlowDetection:!0,cinematicAnalysis:!0,analysisInterval:500}),this.genreGradientEvolution=new st(void 0,null,null,this.settingsManager),this.oklabState={currentPreset:M.PRESETS.STANDARD,processedPalette:{},perceptualGradientCache:new Map,colorHarmonyCache:new Map,lastProcessingTime:0},this.emotionalState={currentEmotion:null,emotionHistory:[],lastEmotionUpdate:0,emotionInfluenceIntensity:.8},this.genreState={currentGenre:"unknown",genreConfidence:0,genreHistory:[],lastGenreUpdate:0,genreInfluenceIntensity:.7},this._boundSettingsChangeHandler=this._handleSettingsChange.bind(this),this._boundArtisticModeHandler=this._handleArtisticModeChanged.bind(this),document.addEventListener("year3000SystemSettingsChanged",this._boundSettingsChangeHandler),document.addEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),this.evolutionEnabled&&this._startEvolutionLoop()}getCurrentActivePalette(){try{if(K.getCurrentPaletteSystem()==="year3000"){let i=K.getCurrentPalette(),a=K.getCurrentDefaultFlavor(),r=i[a];if(!r)throw new Error(`No palette found for flavor: ${a}`);let n={},s={};return Object.entries(r).forEach(([o,l])=>{["base","surface0","surface1","surface2","mantle","crust"].includes(o)?s[o]=l.hex:n[o]=l.hex}),{accents:n,neutrals:s}}else return this.catppuccinPalettes[this.currentTheme]}catch(t){return console.warn("[ColorHarmonyEngine] Failed to get active palette, using fallback:",t),this.catppuccinPalettes[this.currentTheme]}}updateAnimation(t,i){let a=i??t;this.onAnimate(a)}onAnimate(t){this._updateCSSVariables(t),this._calculateBeatPulse(t),p.emitSync("performance:frame",{deltaTime:t,fps:60,memoryUsage:performance.memory?.usedJSHeapSize||0,timestamp:performance.now()})}_updateCSSVariables(t){let i={"--sn-harmony-energy":this.kineticState.visualMomentum.toFixed(3),"--sn-harmony-pulse":this.kineticState.currentPulse.toFixed(3),"--sn-harmony-animation-phase":(Math.sin(this.kineticState.animationPhase)*.5+.5).toFixed(3)};this.kineticState.musicIntensityMultiplier!==void 0&&(i["--sn-harmony-intensity"]=this.kineticState.musicIntensityMultiplier.toFixed(3)),this.kineticState.valenceGravity!==void 0&&(i["--sn-harmony-valence"]=this.kineticState.valenceGravity.toFixed(3)),this.kineticState.beatPhase!==void 0&&(i["--sn-harmony-beat-phase"]=this.kineticState.beatPhase.toFixed(3)),this.kineticState.hueShift!==void 0&&(i["--sn-harmony-hue-shift"]=`${this.kineticState.hueShift.toFixed(1)}deg`);let a=Math.max(0,Math.min(1,this.kineticState.currentPulse*1.2));i["--sn-text-glow-intensity"]=a.toFixed(3),p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:i,timestamp:Date.now()})}_calculateBeatPulse(t){this.kineticState.currentPulse*=Math.pow(.95,t/16.67),this.kineticState.animationPhase+=t/1e3*.5,this.kineticState.animationPhase>2*Math.PI&&(this.kineticState.animationPhase-=2*Math.PI),this._emitGradientAnimationEvents(t)}_emitGradientAnimationEvents(t){let i=this._calculateCurrentEnergyLevel(),a=this._detectBeatFromAudioAnalysis();Math.random()<.1&&p.emit("music:energy",{energy:i.energy,valence:i.valence,tempo:120,timestamp:performance.now()}),a.detected&&p.emit("music:beat",{intensity:a.intensity,confidence:a.confidence,timestamp:performance.now(),bpm:120})}_calculateCurrentEnergyLevel(){let t=.5+Math.sin(this.kineticState.animationPhase)*.3;return{energy:Math.max(.2,t),valence:.5+this.kineticState.currentPulse*.3,arousal:.4+this.kineticState.currentPulse*.4}}_detectBeatFromAudioAnalysis(){let i=this.kineticState.currentPulse;return i>.3?{detected:!0,intensity:Math.min(1,i*1.5),confidence:Math.min(1,(i-.3)/(1-.3))}:Math.sin(this.kineticState.animationPhase)>.8?{detected:!0,intensity:.4,confidence:.6}:{detected:!1,intensity:0,confidence:0}}async initialize(){await super.initialize();let t=this.performanceMonitor?this.performanceMonitor.cssVisualEffectsController:void 0;this.semanticColorManager.initialize(t),p.subscribe("colors:extracted",this.handleColorExtraction.bind(this),"ColorHarmonyEngine");try{lt.registerStrategy(this),this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Registered with ColorOrchestrator as strategy processor.")}catch(i){console.warn("\u{1F3A8} [ColorHarmonyEngine] Failed to register with ColorOrchestrator:",i)}try{await this.musicEmotionAnalyzer.initialize(),this.musicEmotionAnalyzer.onEmotionUpdate(i=>{this.handleEmotionUpdate(i)}),this.config.enableDebug&&console.log("\u{1F3AD} [ColorHarmonyEngine] MusicEmotionAnalyzer initialized with audioAnalysis awareness")}catch(i){console.warn("\u{1F3AD} [ColorHarmonyEngine] Failed to initialize MusicEmotionAnalyzer:",i)}try{await this.genreGradientEvolution.initialize(),this.config.enableDebug&&console.log("\u{1F3B6} [ColorHarmonyEngine] GenreGradientEvolution initialized with aesthetic intelligence")}catch(i){console.warn("\u{1F3B6} [ColorHarmonyEngine] Failed to initialize GenreGradientEvolution:",i)}this.config.enableDebug&&(console.log("\u{1F3A8} [ColorHarmonyEngine] Initialized with Year 3000 Quantum Empathy via BaseVisualSystem and SemanticColorManager."),console.log("\u{1F3A8} [ColorHarmonyEngine] Subscribed to 'colors/extracted' events for strategy pattern processing.")),this.initialized=!0}handleEmotionUpdate(t){if(this.initialized)try{this.emotionalState.currentEmotion=t,this.emotionalState.emotionHistory.push(t),this.emotionalState.lastEmotionUpdate=Date.now(),this.emotionalState.emotionHistory.length>50&&(this.emotionalState.emotionHistory=this.emotionalState.emotionHistory.slice(-25)),p.emit("music:emotion-analyzed",{emotion:t,colorTemperature:t.colorTemperature,visualEffectsLevel:t.musicalCharacteristics.visualEffectsResonance,smoothFlow:t.musicalCharacteristics.smoothFlow,cinematicDepth:t.musicalCharacteristics.cinematicDepth,timestamp:t.timestamp}),this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Emotion updated: ${t.primary} (intensity: ${t.intensity.toFixed(2)}, confidence: ${t.confidence.toFixed(2)})`),this.triggerEmotionalColorUpdate(t)}catch(i){console.error("\u{1F3AD} [ColorHarmonyEngine] Error handling emotion update:",i)}}triggerEmotionalColorUpdate(t){this.emotionalState.emotionInfluenceIntensity>0&&t.confidence>.6&&(this._pendingPaletteRefresh&&clearTimeout(this._pendingPaletteRefresh),this._pendingPaletteRefresh=setTimeout(()=>{this.refreshPaletteWithEmotion(t),this._pendingPaletteRefresh=null},100))}async refreshPaletteWithEmotion(t){try{let i={primaryEmotion:t.primary,emotionIntensity:t.intensity,colorTemperature:t.colorTemperature,valence:t.valence,arousal:t.arousal,dominance:t.dominance,smoothFlow:t.musicalCharacteristics.smoothFlow,cinematicDepth:t.musicalCharacteristics.cinematicDepth,visualEffectsResonance:t.musicalCharacteristics.visualEffectsResonance};p.emit("music:emotional-context-updated",i),this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Refreshing colors with ${t.primary} emotion influence`)}catch(i){console.error("\u{1F3AD} [ColorHarmonyEngine] Error refreshing palette with emotion:",i)}}async healthCheck(){return this.getCurrentActivePalette()?{healthy:!0,ok:!0,details:"Palettes are loaded correctly.",issues:[],system:"ColorHarmonyEngine"}:{healthy:!1,ok:!1,details:`Current theme '${this.currentTheme}' not found in palettes.`,issues:[`Current theme '${this.currentTheme}' not found in palettes.`],system:"ColorHarmonyEngine"}}async processColors(t){let i=performance.now();try{let{rawColors:a,trackUri:r,musicData:n}=t,s=this.determineOptimalOKLABPreset(t);this.oklabState.currentPreset=s;let o=await this.analyzeGenreAesthetics(n,a),l=await this.getAdvancedEmotionalTemperature(n,a),m=await this.blendWithAdvancedOKLAB(a,n,l,o||void 0),d=m.VIBRANT||m.PROMINENT||Object.values(m)[0]||"#a6adc8",h=this.utils.hexToRgb(d),g=h?`${h.r},${h.g},${h.b}`:"166,173,200";try{let T={processedColors:m,accentHex:d,accentRgb:g,originalColors:a,trackUri:r,musicData:n,timestamp:Date.now(),strategies:["ColorHarmonyEngine"],processingTime:performance.now()-i,coordinationMetrics:{detectedGenre:o?.genre||"unknown",genreConfidence:o?.confidence||0,emotionalState:this.emotionalState.currentEmotion?.primary||"neutral",oklabPreset:s?.name||"standard",coordinationStrategy:"genre-emotion-color-unified",musicInfluenceStrength:this.genreState.genreInfluenceIntensity}};p.emitSync("colors:harmonized",T),this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Emitted colors:harmonized via UnifiedEventBus (facade pattern):",{processedColors:Object.keys(m),accentHex:d,noDomEvents:"correct architecture"})}catch(T){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Failed to emit colors:harmonized event:",T)}let f=performance.now()-i;this.harmonyMetrics.totalHarmonyCalculations++,this.harmonyMetrics.performance.push(f);let S={processedColors:m,accentHex:d,accentRgb:g,metadata:{strategy:"CatppuccinHarmony",processingTime:f,cacheKey:`catppuccin-${r}-${this.currentTheme}`,colorHarmonyIntensity:this.userIntensity},context:t},C=this.generateAdvancedOKLABCSSVariables(S);return this.applyCSSVariablesToDOM(C),this.generatePerceptualGradientData(S),this.updateAdvancedHarmonyMetrics(S,f),p.emitSync("colors:harmonized",{processedColors:S.processedColors,accentHex:S.accentHex,accentRgb:S.accentRgb,strategies:S.metadata?.strategy?[S.metadata.strategy]:["ColorHarmonyEngine"],processingTime:f,trackUri:S.context.trackUri}),this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Processed colors via strategy pattern in ${f.toFixed(2)}ms`,{accentHex:d,strategy:"CatppuccinHarmony",cssVariablesCount:Object.keys(C).length}),S}catch(a){return console.error("[ColorHarmonyEngine] Strategy processing failed:",a),{processedColors:{VIBRANT:"#a6adc8"},accentHex:"#a6adc8",accentRgb:"166,173,200",metadata:{strategy:"CatppuccinHarmony",processingTime:performance.now()-i,error:String(a)},context:t}}}getStrategyName(){return"CatppuccinHarmony"}canProcess(t){return t&&t.rawColors&&Object.keys(t.rawColors).length>0}getEstimatedProcessingTime(t){let a=Object.keys(t.rawColors||{}).length;return 5*Math.max(1,a/5)}async handleColorExtraction(t){try{if(!this.initialized){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Received color extraction event but not initialized");return}let i={rawColors:t.rawColors,trackUri:t.trackUri,timestamp:t.timestamp,colorHarmonyMode:this.currentTheme,harmonicMode:this.currentTheme,musicData:t.musicData,performanceHints:{preferLightweight:!1,enableAdvancedBlending:!0,maxProcessingTime:100}};this.canProcess(i)?await this.processColors(i):this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Cannot process color context:",i)}catch(i){console.error("[ColorHarmonyEngine] Error handling color extraction event:",i)}}generateCSSVariables(t){let i={};i["--sn-accent-hex"]=t.accentHex,i["--sn-accent-rgb"]=t.accentRgb,i[Ge.CANONICAL_HEX_VAR]=t.accentHex,i[Ge.CANONICAL_RGB_VAR]=t.accentRgb;let a=t.processedColors,r=a.VIBRANT||a.PROMINENT||t.accentHex,n=a.DARK_VIBRANT||a.DESATURATED||r,s=a.VIBRANT_NON_ALARMING||a.LIGHT_VIBRANT||r;i["--sn-bg-gradient-primary"]=r,i["--sn-bg-gradient-secondary"]=n,i["--sn-bg-gradient-accent"]=s;let o=this.utils.hexToRgb(r),l=this.utils.hexToRgb(n),m=this.utils.hexToRgb(s);return o&&(i["--sn-bg-gradient-primary-rgb"]=`${o.r},${o.g},${o.b}`),l&&(i["--sn-bg-gradient-secondary-rgb"]=`${l.r},${l.g},${l.b}`),m&&(i["--sn-bg-gradient-accent-rgb"]=`${m.r},${m.g},${m.b}`),this.generateOKLABVariables(i,t),this.config.enableDebug&&console.log("\u{1F527} [ColorHarmonyEngine] Generated background gradient CSS variables:",{primary:`${r} -> ${i["--sn-bg-gradient-primary-rgb"]}`,secondary:`${n} -> ${i["--sn-bg-gradient-secondary-rgb"]}`,accent:`${s} -> ${i["--sn-bg-gradient-accent-rgb"]}`,totalVariables:Object.keys(i).length,note:"CSS mapping automatically updates --sn-gradient-* variables"}),i}generateOKLABVariables(t,i){try{let a=i.accentHex,r=i.processedColors,n=r.DARK_VIBRANT||r.DESATURATED||a,s=this.utils.hexToRgb(a),o=this.utils.hexToRgb(n);if(s){let l=this.utils.rgbToOklab(s.r,s.g,s.b),m={L:Math.min(1,l.L*1.1),a:l.a*1.15,b:l.b*1.15},d=this.utils.oklabToRgb(m.L,m.a,m.b);t["--sn-color-oklab-bright-highlight-rgb"]=`${d.r},${d.g},${d.b}`,t["--sn-color-oklab-primary-r"]=Math.round(d.r).toString(),t["--sn-color-oklab-primary-g"]=Math.round(d.g).toString(),t["--sn-color-oklab-primary-b"]=Math.round(d.b).toString(),t["--sn-color-oklab-accent-r"]=Math.round(d.r).toString(),t["--sn-color-oklab-accent-g"]=Math.round(d.g).toString(),t["--sn-color-oklab-accent-b"]=Math.round(d.b).toString(),t["--sn-color-oklab-accent-luminance"]=m.L.toFixed(3);let h=this.convertOklabToOklch(m);t["--sn-color-oklch-accent-l"]=h.L.toFixed(3),t["--sn-color-oklch-accent-c"]=h.C.toFixed(3),t["--sn-color-oklch-accent-h"]=h.H.toFixed(1),t["--sn-color-oklch-primary-l"]=h.L.toFixed(3),t["--sn-color-oklch-primary-c"]=h.C.toFixed(3),t["--sn-color-oklch-primary-h"]=h.H.toFixed(1)}if(o){let l=this.utils.rgbToOklab(o.r,o.g,o.b),m={L:Math.max(.05,l.L*.3),a:l.a*.8,b:l.b*.8},d=this.utils.oklabToRgb(m.L,m.a,m.b);t["--sn-color-oklab-dynamic-shadow-rgb"]=`${d.r},${d.g},${d.b}`,t["--sn-color-oklab-base-luminance"]=m.L.toFixed(3)}this.config.enableDebug&&console.log("\u{1F52C} [ColorHarmonyEngine] Generated OKLAB-processed variables:",{primaryColor:a,secondaryColor:n,oklabVariablesCount:Object.keys(t).filter(l=>l.includes("oklab")).length,oklchVariablesCount:Object.keys(t).filter(l=>l.includes("oklch")).length})}catch(a){this.config.enableDebug&&console.warn("\u{1F52C} [ColorHarmonyEngine] OKLAB processing failed, using fallbacks:",a);let r=this.utils.hexToRgb(i.accentHex);r&&(t["--sn-color-oklab-bright-highlight-rgb"]=`${r.r},${r.g},${r.b}`,t["--sn-color-oklab-dynamic-shadow-rgb"]=`${Math.round(r.r*.3)},${Math.round(r.g*.3)},${Math.round(r.b*.3)}`)}}convertOklabToOklch(t){let i=t.L,a=Math.sqrt(t.a*t.a+t.b*t.b),r=Math.atan2(t.b,t.a)*(180/Math.PI);return r<0&&(r+=360),{L:i,C:a,H:r}}detectCurrentTheme(){let t=this.utils.getRootStyle();if(!t)return console.warn("[ColorHarmonyEngine detectCurrentTheme] Root element not found. Defaulting to mocha."),"mocha";let a=getComputedStyle(t).getPropertyValue("--spice-main").trim(),r=a.startsWith("#")?a.substring(1).toUpperCase():a.toUpperCase(),s={303446:"frappe",EFF1F5:"latte","24273A":"macchiato","1E1E2E":"mocha"}[r];if(s)return this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Detected Catppuccin theme: ${s}`),s;this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Unknown theme detected (${r}), attempting to generate fallback`);let o=`custom-${r.toLowerCase()}`;try{let l=this.paletteExtensionManager.generateFallbackPalette(o);this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Generated fallback palette for theme: ${o}`,l)}catch(l){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Failed to generate fallback palette:",l)}return this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Falling back to mocha theme for unknown base color: ${r}`),"mocha"}async _getGenreAwarePalette(t){let i=this.getCurrentActivePalette();if(!t||!i)return i;try{let a={name:this.currentTheme,version:"1.0.0",accents:i.accents,neutrals:i.neutrals,metadata:{author:"Catppuccin",description:`${this.currentTheme} flavor`,temperature:"neutral"}},r=this.paletteExtensionManager.applyGenreAwareModifications(a,t);return{accents:r.accents,neutrals:r.neutrals}}catch(a){return this.config.enableDebug&&console.warn(`[ColorHarmonyEngine] Failed to apply genre modifications for ${t}:`,a),i}}getMusicIntensityMultiplier(t=.5,i=.5){let a=this.config.getCurrentMultipliers().musicEnergyBoost,r=t>.7?1.3:t>.4?1:.8,n=i>.6?1.2:i<.4?.9:1;return a*r*n}validateColorHarmony(t,i="general"){let a=performance.now();this.harmonyMetrics.totalHarmonyCalculations++;let r={general:{minContrast:1.8,minHarmony:this.vibrancyConfig.harmonyTolerance},search:{minContrast:2.8,minHarmony:.4},navigation:{minContrast:2.5,minHarmony:.45},text:{minContrast:4.5,minHarmony:.6},accent:{minContrast:1.5,minHarmony:.3}},n=r[i]||r.general,s=this.getCurrentActivePalette();if(!s?.neutrals?.base){let T=`[StarryNight] Catppuccin palette or base neutral not found for theme: ${this.currentTheme}`;return console.error(T),{isValid:!1,error:"Palette configuration error.",contrastRatio:0,harmonyScore:0,meetsContrast:!1,isHarmonious:!1,artisticMode:this.config.artisticMode,adjustedRequirements:n,recommendations:[]}}let o=s.neutrals.base,l=this.utils.rgbToHex(t.r,t.g,t.b),m=this.utils.calculateContrastRatio(l,o),d=this.calculateHarmonyScore(t,s),h=this.config.artisticMode,g={...n};h==="advanced-maximum"||h==="cosmic-maximum"?(g.minContrast*=.7,g.minHarmony*=.6):h==="artist-vision"&&(g.minContrast*=.85,g.minHarmony*=.8);let f=m>=g.minContrast,S=d>=g.minHarmony,C=performance.now();return this.harmonyMetrics.performance.push(C-a),{isValid:f&&S,contrastRatio:m,harmonyScore:d,meetsContrast:f,isHarmonious:S,artisticMode:h,adjustedRequirements:g,recommendations:this.generateRecommendations(t,m,d,g)}}calculateHarmonyScore(t,i){let a=this.utils.rgbToHsl(t.r,t.g,t.b),r=0,n=Object.values(i.accents);for(let s of n){let o=this.utils.hexToRgb(s);if(!o)continue;let l=this.utils.rgbToHsl(o.r,o.g,o.b),m=Math.abs(a.h-l.h),d=Math.min(m,360-m),h=[0,30,60,90,120,150,180,210,240,270,300,330];if(h.some(f=>Math.abs(d-f)<20)){let f=1-Math.min(...h.map(S=>Math.abs(d-S)))/20;r=Math.max(r,f)}}return r}findBestHarmoniousAccent(t,i){let a={name:"mauve",hex:this.utils.getRootStyle()?.style.getPropertyValue("--sn-dynamic-accent")?.trim()||this.utils.getRootStyle()?.style.getPropertyValue("--spice-accent")?.trim()||"#cba6f7",rgb:{r:203,g:166,b:247}},r=["mauve","lavender","blue","sapphire","sky","pink","peach","teal"],n=-1,s=this.utils.rgbToHsl(t.r,t.g,t.b);for(let o of r){let l=i.accents[o];if(l){let m=this.utils.hexToRgb(l);if(!m)continue;let d=this.utils.rgbToHsl(m.r,m.g,m.b),h=Math.abs(s.h-d.h),f=1-Math.min(h,360-h)/180,S=d.s*.3,C=f+S;C>n&&(n=C,a={name:o,hex:l,rgb:m})}}return a}blendColors(t,i,a=this.vibrancyConfig.defaultBlendRatio){let r=Math.max(0,Math.min(1,a)),n=this.utils.rgbToOklab(t.r,t.g,t.b),s=this.utils.rgbToOklab(i.r,i.g,i.b),o=(R,O)=>R*r+O*(1-r),l={L:o(n.L,s.L),a:o(n.a,s.a),b:o(n.b,s.b)},m=this.utils.oklabToRgb(l.L,l.a,l.b),d=this.utils.rgbToHsl(m.r,m.g,m.b),h=this.config?.artisticMode??"artist-vision",g=this.animationEngine?.getCurrentMultipliers?.()||void 0,f=(h==="advanced-maximum"||h==="cosmic-maximum")&&!!g,S=g||{},C=f?(S.visualIntensityBase||1)*1.25:this.vibrancyConfig.artisticSaturationBoost,T=f?(S.aestheticGravityStrength||1)*1.15:this.vibrancyConfig.enhancedLuminanceBoost;d.s=Math.max(d.s,this.vibrancyConfig.minimumSaturation*100),d.s=Math.min(100,d.s*C),h!=="corporate-safe"&&(d.l=Math.min(95,d.l*T));let w=this.utils.hslToRgb(d.h,d.s,d.l);return{r:w.r,g:w.g,b:w.b}}blendWithCatppuccin(t,i=null){this.performanceMonitor?.emitTrace?.("[ColorHarmonyEngine] Starting blendWithCatppuccin");let a=null;if(i)try{let s={energy:i.energy||.5,valence:i.valence||.5,danceability:i.danceability,tempo:i.enhancedBPM||i.tempo,loudness:i.loudness,acousticness:i.acousticness,instrumentalness:i.instrumentalness,speechiness:i.speechiness,mode:i.mode,key:i.key,genre:i.genre};a=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(s),a&&(p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:a.cssVariables,timestamp:Date.now()}),document.body.classList.remove(...Array.from(document.body.classList).filter(o=>o.startsWith("smooth-emotion-"))),document.body.classList.add(a.cssClass),a.secondaryEmotion&&document.body.classList.add(`smooth-emotion-blend-${a.secondaryEmotion}`)),this.config.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Applied emotional temperature:",a)}catch(s){this.config.enableDebug&&console.warn("\u{1F321}\uFE0F [ColorHarmonyEngine] Failed to apply emotional temperature:",s)}this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] blendWithCatppuccin debug:",{extractedColors:t,musicContext:i,emotionalTemperature:a,currentTheme:this.currentTheme,vibrancyConfig:this.vibrancyConfig,userIntensity:this.userIntensity});let r=this.getCurrentActivePalette();if(!r)return console.error(`[StarryNight] Catppuccin palette not found for theme: ${this.currentTheme}`),t;let n={};for(let[s,o]of Object.entries(t)){if(!o)continue;let l=this.utils.hexToRgb(o);if(!l){this.config.enableDebug&&console.warn(`\u{1F3A8} [ColorHarmonyEngine] Failed to parse color for role ${s}: ${o}`),n[s]=o;continue}let m=this.utils.rgbToHsl(l.r,l.g,l.b),d=m.s>=this.vibrancyConfig.minimumSaturation*100;this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Processing color ${s}:`,{originalColor:o,rgb:l,hsl:m,saturationCheck:d,minimumSaturationRequired:this.vibrancyConfig.minimumSaturation*100,actualSaturation:m.s});let h=this.findBestHarmoniousAccent(l,r);if(!h?.rgb){console.warn(`[StarryNight] Could not find a valid harmonious accent for role: ${s}. Using original color.`),n[s]=o;continue}let g=this.vibrancyConfig.getBlendRatio(this.config.artisticMode);if(a){let C=a.intensity;g*=C*this.userIntensity;let T=this.calculateTemperatureBlendInfluence(a.temperature);g*=T,g=Math.max(0,Math.min(1,g)),this.config.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Emotional temperature blend adjustment:",{originalRatio:this.vibrancyConfig.getBlendRatio(this.config.artisticMode),emotionalIntensity:C,temperatureInfluence:T,finalBlendRatio:g,temperature:a.temperature})}else if(i){let C=this.getMusicIntensityMultiplier(i.energy,i.valence);g*=C*this.userIntensity,g=Math.max(0,Math.min(1,g))}this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Blending ${s}:`,{extractedRgb:l,bestAccent:h.hex,blendRatio:g,artisticMode:this.config.artisticMode});let f=this.blendColors(l,h.rgb,g),S=this.utils.rgbToHex(f.r,f.g,f.b);n[s]=S,this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Final color for ${s}: ${o} \u2192 ${S}`)}return this.harmonyMetrics.musicInfluencedAdjustments++,this.performanceMonitor?.emitTrace?.("[ColorHarmonyEngine] Completed blendWithCatppuccin"),this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Final harmonized result:",{inputColors:t,outputColors:n,colorCount:Object.keys(n).length}),this.updateSemanticColorsWithHarmonizedPalette(n),n}updateSemanticColorsWithHarmonizedPalette(t){if(this.semanticColorManager)try{this.semanticColorManager.updateWithAlbumColors(t);let i=t.VIBRANT||t.PRIMARY,a=t.DARK_VIBRANT||t.SECONDARY,r=t.VIBRANT_NON_ALARMING||t.LIGHT_VIBRANT;i&&this.semanticColorManager.getSemanticColor("essentialBrightAccent").then(n=>{let s=this.blendWithSemanticColor(i,n,.7);this.applyCSSVariable("--spice-accent",s),this.applyCSSVariable("--spice-button-active",s)}),a&&this.semanticColorManager.getSemanticColor("backgroundElevatedHighlight").then(n=>{let s=this.blendWithSemanticColor(a,n,.5);this.applyCSSVariable("--spice-highlight",s)}),r&&this.semanticColorManager.getSemanticColor("textBrightAccent").then(n=>{let s=this.blendWithSemanticColor(r,n,.6);this.applyCSSVariable("--spice-text-accent",s)}),this.semanticColorManager.flushUpdates()}catch(i){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Failed to update semantic colors:",i)}}blendWithSemanticColor(t,i,a){let r=this.utils.hexToRgb(t),n=this.utils.hexToRgb(i);if(!r||!n)return t;let s=this.blendColors(r,n,a);return this.utils.rgbToHex(s.r,s.g,s.b)}applyCSSVariable(t,i){p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:{[t]:i},timestamp:Date.now()})}applyCSSVariablesToDOM(t){let i=globalThis.year3000System,a=i?.cssVisualEffectsController||this.performanceMonitor?.cssVisualEffectsController||i?.facadeCoordinator?.getCachedNonVisualSystem?.("UnifiedCSSVariableManager"),r=this.enhanceCSSVariablesForUIComponents(t);if(a&&typeof a.batchSetVariables=="function")try{a.batchSetVariables("ColorHarmonyEngine",r,"high","color-harmony-oklab-processing"),this.config.enableDebug&&console.log("\u{1F527} [ColorHarmonyEngine] Applied CSS variables via cssVisualEffectsController batcher")}catch(n){this.config.enableDebug&&console.warn("\u{1F527} [ColorHarmonyEngine] cssVisualEffectsController.batchSetVariables failed, using direct application:",n),this.applyVariablesDirectly(r)}else this.config.enableDebug&&console.log("\u{1F527} [ColorHarmonyEngine] cssVisualEffectsController not available, using direct DOM application"),this.applyVariablesDirectly(r);p.emitSync("colors:applied",{cssVariables:r,accentHex:r["--sn-accent-hex"]||"#a6adc8",accentRgb:r["--sn-accent-rgb"]||"166,173,200",appliedAt:Date.now()}),this.config.enableDebug&&console.log("\u{1F52C} [ColorHarmonyEngine] Applied enhanced CSS variables to DOM:",{totalVariables:Object.keys(r).length,oklabVariables:Object.keys(r).filter(n=>n.includes("oklab")).length,oklchVariables:Object.keys(r).filter(n=>n.includes("oklch")).length,gradientVariables:Object.keys(r).filter(n=>n.includes("gradient")).length,spiceVariables:Object.keys(r).filter(n=>n.includes("spice")).length,sidebarVariables:Object.keys(r).filter(n=>n.includes("sidebar")).length,cssVisualEffectsControllerUsed:!!a})}enhanceCSSVariablesForUIComponents(t){let i={...t},a=i["--sn-accent-hex"]||i[Ge.CANONICAL_HEX_VAR],r=i["--sn-accent-rgb"]||i[Ge.CANONICAL_RGB_VAR],n=i["--sn-bg-gradient-primary"],s=i["--sn-bg-gradient-primary-rgb"],o=i["--sn-bg-gradient-secondary"],l=i["--sn-bg-gradient-secondary-rgb"];a&&r&&(i["--spice-accent"]=a,i["--spice-button"]=a,i["--spice-button-active"]=a,i["--spice-rgb-accent"]=r,i["--spice-rgb-button"]=r,i["--spice-text-accent"]=a,i["--sn-sidebar-entanglement-color-rgb"]=r,i["--sn-sidebar-accent-color"]=a,i["--sn-sidebar-accent-rgb"]=r,i["--sn-sidebar-dynamic-accent"]=a,i["--sn-nowplaying-accent-color"]=a,i["--sn-nowplaying-accent-rgb"]=r,i["--sn-nowplaying-primary-color"]=a,i["--sn-nowplaying-primary-rgb"]=r,i["--sn-main-feed-accent-color"]=a,i["--sn-main-feed-accent-rgb"]=r,i["--sn-content-accent-color"]=a,i["--sn-content-accent-rgb"]=r),n&&s&&(i["--sn-primary-gradient-color"]=n,i["--sn-primary-gradient-rgb"]=s,i["--sn-main-feed-primary-color"]=n,i["--sn-main-feed-primary-rgb"]=s),o&&l&&(i["--sn-secondary-gradient-color"]=o,i["--sn-secondary-gradient-rgb"]=l,i["--sn-main-feed-secondary-color"]=o,i["--sn-main-feed-secondary-rgb"]=l);let m=i["--sn-color-oklab-bright-highlight-rgb"];m&&(i["--sn-audioAnalysis-bright-accent-rgb"]=m,i["--sn-layered-accent-rgb"]=m,i["--smooth-layered-rgb"]=m,i["--sn-holographic-accent-rgb"]=m,i["--smooth-holographic-rgb"]=m);let d=i["--sn-color-oklab-dynamic-shadow-rgb"];return d&&(i["--sn-audioAnalysis-shadow-rgb"]=d,i["--sn-depth-shadow-rgb"]=d),i}applyVariablesDirectly(t){p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:t,timestamp:Date.now()})}generateRecommendations(t,i,a,r){let n=[],s=this.getCurrentActivePalette(),o=this.utils.hexToRgb(s?.neutrals?.base||"#1e1e2e");if(!o)return[];if(i<r.minContrast){let l=this.utils.findRequiredLuminance(t,o,r.minContrast),m=this.utils.rgbToHsl(t.r,t.g,t.b),d=this.utils.hslToRgb(m.h,m.s,l),h={r:d.r,g:d.g,b:d.b};n.push({type:"contrast",suggestion:`Adjust luminance to meet contrast of ${r.minContrast}`,recommendedColor:this.utils.rgbToHex(h.r,h.g,h.b)})}if(a<r.minHarmony){let l=this.findBestHarmoniousAccent(t,s),m=this.blendColors(t,l.rgb,.5);n.push({type:"harmony",suggestion:`Blend with harmonious accent color to improve score to at least ${r.minHarmony}`,recommendedColor:this.utils.rgbToHex(m.r,m.g,m.b)})}return n}getPerformanceReport(){return{system:this.systemName,metrics:this.harmonyMetrics,kineticState:this.kineticState,musicalMemorySize:this.musicalMemory.recentTracks.length,currentTheme:this.currentTheme}}updateFromMusicAnalysis(t,i,a){if(!t)return;let r=t.genre;r&&r!==this._lastGenre&&this._applyGenrePalette(r).then(()=>{this._lastGenre=r,this._forcePaletteRepaint()}),this._updateMusicalMemory(t,a),this._updateKineticState(t),this._applyAestheticGravity(t),this._calculateMusicAwareDynamics(t)}_calculateMusicAwareDynamics(t){let{energy:i=.5,valence:a=.5,enhancedBPM:r=120,beatOccurred:n=!1}=t,s=this._calculateMusicIntensityMultiplier(i,a),o=this._calculateBeatPhase(r),l=(a-.5)*2,m=this._calculateHueShift(n,i,o);this.kineticState={...this.kineticState,musicIntensityMultiplier:s,beatPhase:o,valenceGravity:l,hueShift:m}}_calculateMusicIntensityMultiplier(t,i){let a=t*.7+i*.3,r=Math.abs(i-.5)*.4;return Math.max(.1,Math.min(2,a+r))}_calculateBeatPhase(t){let i=performance.now(),a=6e4/t;return i%a/a}_calculateHueShift(t,i,a){if(window.matchMedia("(prefers-reduced-motion: reduce)").matches)return 0;let r=this.config.artisticMode,n=r==="advanced-maximum"||r==="cosmic-maximum"?8:5,s=Math.sin(a*2*Math.PI)*n;t&&(s+=i*(r==="advanced-maximum"||r==="cosmic-maximum"?12:10));let o=r==="advanced-maximum"||r==="cosmic-maximum"?25:15;return Math.max(-o,Math.min(o,s))}_updateMusicalMemory(t,i){this.musicalMemory.recentTracks.unshift({trackUri:i,...t,timestamp:Date.now()}),this.musicalMemory.recentTracks.length>this.musicalMemory.maxMemorySize&&this.musicalMemory.recentTracks.pop(),this.musicalMemory.energyHistory.unshift(t.energy),this.musicalMemory.energyHistory.length>20&&this.musicalMemory.energyHistory.pop(),this.harmonyMetrics.temporalMemoryEvents++}_updateKineticState(t){let{energy:i,enhancedBPM:a,beatOccurred:r}=t,n=performance.now();r?(this.kineticState.lastBeatTime=n,this.kineticState.currentPulse=1):this.kineticState.currentPulse*=.95;let s=n-this.kineticState.lastBeatTime,o=6e4/(a||120);this.kineticState.animationPhase=s%o/o*2*Math.PI,this.kineticState.visualMomentum=this.utils.lerp(this.kineticState.visualMomentum,i,.1)}_applyAestheticGravity(t){let{visualIntensity:i,valence:a,energy:r}=t,n=(a-.5)*2,s=(r-.5)*2,o=i;p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:{"--sn-gravity-x":n.toFixed(3),"--sn-gravity-y":s.toFixed(3),"--sn-gravity-strength":o.toFixed(3)},timestamp:Date.now()})}generateHarmonicVariations(t){let i=this.utils.rgbToOklab(t.r,t.g,t.b),a=Math.max(0,Math.min(1,i.L*.75)),r=this.utils.oklabToRgb(a,i.a,i.b),n=Math.max(0,Math.min(1,i.L*1.25)),s=this.utils.oklabToRgb(n,i.a,i.b);return{darkVibrantHex:this.utils.rgbToHex(r.r,r.g,r.b),lightVibrantHex:this.utils.rgbToHex(s.r,s.g,s.b)}}getCurrentGradient(t=5){try{if(!this.getCurrentActivePalette())return null;let a=this.utils.getRootStyle();if(!a)return this.generateFallbackGradient(t);let r=getComputedStyle(a),n=this.getInheritedGradientColors(r);if(!n)return u?.debug?.warn("ColorHarmonyEngine","Failed to inherit processed gradient variables, using fallback"),this.generateFallbackGradient(t);let s=[],o=this.kineticState.musicIntensityMultiplier||1,l=this.kineticState.hueShift||0,m=this.kineticState.valenceGravity||.5,d=this.emotionalState?.currentEmotion?.colorTemperature||.5,{primary:h,secondary:g,accent:f,emotional:S,tertiary:C}=n,T=[h,g,f,S,C];for(let w=0;w<t;w++){let R=w/(t-1),O;if(t===1)O=f;else{let B=R*(T.length-1),W=Math.floor(B),z=Math.min(W+1,T.length-1),I=B-W,re=Math.sin(d*Math.PI)*.3,De=Math.max(0,Math.min(1,I+re)),fe=T[W],it=T[z];fe&&it?O={r:fe.r+(it.r-fe.r)*De,g:fe.g+(it.g-fe.g)*De,b:fe.b+(it.b-fe.b)*De}:O=f}let F=this._applyVisualEffectsModulation(O,{musicInfluence:o,valenceGravity:m,hueShift:l,emotionalTemperature:d,position:R});s.push({r:Math.round(Math.max(0,Math.min(255,F.r))),g:Math.round(Math.max(0,Math.min(255,F.g))),b:Math.round(Math.max(0,Math.min(255,F.b)))})}return this.config?.enableDebug&&console.log(`[ColorHarmonyEngine] Generated gradient with ${t} stops:`,s),s}catch(i){let a=i instanceof Error?i.message:"Unknown error",r={method:"getCurrentGradient",stopCount:t,currentTheme:this.currentTheme,kineticState:this.kineticState,timestamp:Date.now(),error:a};u?.debug?.error("ColorHarmonyEngine","Failed to generate gradient colors",r),p.emit("system:error",{systemName:"ColorHarmonyEngine",error:`Gradient generation failed: ${a}`,severity:"error",timestamp:Date.now()});try{let n=this.generateFallbackGradient(t);if(n&&n.length>0)return u?.debug?.warn("ColorHarmonyEngine","Using fallback gradient after error",{fallbackColorCount:n.length}),n}catch(n){u?.debug?.error("ColorHarmonyEngine","Fallback gradient generation also failed",n)}return null}}getInheritedGradientColors(t){try{let i=this.parseRGBVariable(t,"--sn-oklab-processed-primary-rgb")||this.parseRGBVariable(t,"--sn-bg-gradient-primary-rgb")||this.parseRGBVariable(t,"--sn-musical-harmony-primary-rgb"),a=this.parseRGBVariable(t,"--sn-oklab-processed-secondary-rgb")||this.parseRGBVariable(t,"--sn-bg-gradient-secondary-rgb")||this.parseRGBVariable(t,"--sn-musical-harmony-secondary-rgb"),r=this.parseRGBVariable(t,"--sn-oklab-processed-accent-rgb")||this.parseRGBVariable(t,"--sn-bg-gradient-accent-rgb")||this.parseRGBVariable(t,"--sn-color-accent-rgb"),n=this.parseRGBVariable(t,"--sn-oklab-emotional-temperature-rgb")||this.parseRGBVariable(t,"--sn-emotional-temperature-warm-rgb")||r,s=this.parseRGBVariable(t,"--sn-oklab-processed-bright-highlight-rgb")||this.parseRGBVariable(t,"--sn-audioAnalysis-flow-rgb")||this.parseRGBVariable(t,"--sn-musical-harmony-tertiary-rgb");return!i||!r?(u?.debug?.warn("ColorHarmonyEngine","Missing essential inherited colors",{hasPrimary:!!i,hasAccent:!!r}),null):{primary:i,secondary:a||i,accent:r,emotional:n||r,tertiary:s||r}}catch(i){return u?.debug?.error("ColorHarmonyEngine","Failed to inherit gradient colors:",i),null}}parseRGBVariable(t,i){try{let a=t.getPropertyValue(i).trim();if(!a)return null;let r=a.match(/(\d+),\s*(\d+),\s*(\d+)/);return r&&r[1]&&r[2]&&r[3]?{r:parseInt(r[1],10),g:parseInt(r[2],10),b:parseInt(r[3],10)}:null}catch{return null}}interpolateOKLABColors(t,i,a){let n=Math.pow(t.r/255,2.2),s=Math.pow(t.g/255,2.2),o=Math.pow(t.b/255,2.2),l=Math.pow(i.r/255,2.2),m=Math.pow(i.g/255,2.2),d=Math.pow(i.b/255,2.2),h=n+(l-n)*a,g=s+(m-s)*a,f=o+(d-o)*a;return{r:Math.round(Math.pow(h,1/2.2)*255),g:Math.round(Math.pow(g,1/2.2)*255),b:Math.round(Math.pow(f,1/2.2)*255)}}_applyVisualEffectsModulation(t,i){try{let a=this.utils.rgbToHsl(t.r,t.g,t.b),{h:r,s:n,l:s}=a;n=Math.max(0,Math.min(1,n*(.7+i.musicInfluence*.6))),r=(r+i.hueShift+(i.emotionalTemperature-.5)*60)%360;let o=i.valenceGravity*.2*Math.sin(i.position*Math.PI);s=Math.max(.1,Math.min(.9,s+o));let l=this.utils.hslToRgb(r,n,s);return{r:l.r,g:l.g,b:l.b}}catch{return t}}generateFallbackGradient(t){try{let i=["#1e1e2e","#313244","#45475a","#585b70","#cba6f7","#f5c2e7","#fab387"];(t<2||t>i.length)&&(u?.debug?.warn("ColorHarmonyEngine",`Invalid fallback stopCount: ${t}, using default`),t=Math.min(Math.max(t,2),i.length));let a=[];for(let r=0;r<t;r++){let n=Math.floor(r/(t-1)*(i.length-1)),s=i[n],o=s?this.utils.hexToRgb(s):null;o?a.push(o):a.push({r:203,g:166,b:247})}return a.length<2&&a.push({r:30,g:30,b:46},{r:203,g:166,b:247}),u?.debug?.log("ColorHarmonyEngine",`Generated fallback gradient with ${a.length} colors`,a),a}catch(i){return u?.debug?.error("ColorHarmonyEngine","Critical error in fallback gradient generation",i),null}}async analyzeMusicEmotion(t,i){if(!this.initialized||!this.musicEmotionAnalyzer)return this.config.enableDebug&&console.warn("\u{1F3AD} [ColorHarmonyEngine] Cannot analyze music emotion: not initialized"),null;try{let a=await this.musicEmotionAnalyzer.analyzeEmotion(t,i);return this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Analyzed music emotion: ${a.primary} (${a.intensity.toFixed(2)} intensity, ${a.confidence.toFixed(2)} confidence)`),a}catch(a){return console.error("\u{1F3AD} [ColorHarmonyEngine] Error analyzing music emotion:",a),null}}getCurrentEmotion(){return this.emotionalState?.currentEmotion||null}getEmotionHistory(t=10){return this.emotionalState?.emotionHistory?this.emotionalState.emotionHistory.slice(-t):[]}setEmotionInfluenceIntensity(t){this.emotionalState&&(this.emotionalState.emotionInfluenceIntensity=Math.max(0,Math.min(1,t)),this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Emotion influence intensity set to ${this.emotionalState.emotionInfluenceIntensity}`))}_createVariant(t,i,a,r){let n=this.utils.rgbToOklab(t.r,t.g,t.b),s=Math.max(0,Math.min(1,n.L+i*.2)),o=.8+a*.4,l=n.a*o,m=n.b*o,d=r*.1,h=l*Math.cos(d)-m*Math.sin(d),g=l*Math.sin(d)+m*Math.cos(d);return this.utils.oklabToRgb(s,h,g)}_applyMusicInfluence(t,i,a){let r=1+Math.sin(a*Math.PI)*.2,n=Math.max(.7,Math.min(1.3,i*r));return{r:t.r*n,g:t.g*n,b:t.b*n}}setIntensity(t){let i=Math.max(0,Math.min(1,t));this.userIntensity=i,this.config?.enableDebug&&console.log(`[ColorHarmonyEngine] User color harmony intensity set to ${i}`)}updatePalette(t){t?.length&&(this.config?.enableDebug&&console.log("[ColorHarmonyEngine] updatePalette invoked",{count:t.length}),this.forceRepaint("external-palette"))}_handleSettingsChange(t){let{key:i,value:a}=t.detail||{};switch(i){case Qr:{let r=parseFloat(a);Number.isNaN(r)||this.setIntensity(r);break}case Xr:{let r=a==="true"||a===!0;this._setEvolutionEnabled(r);break}}}_handleArtisticModeChanged(){this.currentTheme=this.detectCurrentTheme(),this._pendingPaletteRefresh||(this._pendingPaletteRefresh=setTimeout(()=>{this._pendingPaletteRefresh=null,this.refreshPalette()},80))}_forcePaletteRepaint(){this.kineticState.hueShift=(this.kineticState.hueShift||0)+.01}_startEvolutionLoop(){if(this._evolutionTimer)return;let i=3e4/Math.max(.1,this.userIntensity);this._evolutionTimer=setInterval(()=>{let a=2*this.userIntensity,r=this.kineticState.hueShift??0;this.kineticState.hueShift=(r+a+360)%360-180},i)}_stopEvolutionLoop(){this._evolutionTimer&&(clearInterval(this._evolutionTimer),this._evolutionTimer=null)}_setEvolutionEnabled(t){this.evolutionEnabled!==t&&(this.evolutionEnabled=t,t?this._startEvolutionLoop():this._stopEvolutionLoop())}destroy(){this._stopEvolutionLoop(),document.removeEventListener("year3000SystemSettingsChanged",this._boundSettingsChangeHandler),document.removeEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),this.semanticColorManager&&this.semanticColorManager.destroy(),this.musicEmotionAnalyzer&&this.musicEmotionAnalyzer.destroy(),this.emotionalState&&(this.emotionalState.currentEmotion=null,this.emotionalState.emotionHistory=[]),super.destroy?.()}async refreshPalette(){try{let t=globalThis.year3000System;if(t?.updateColorsFromCurrentTrack){await t.updateColorsFromCurrentTrack();return}let i=this.utils.getRootStyle();if(!i)return;let r=getComputedStyle(i).getPropertyValue("--sn-gradient-primary").trim();if(r){let n=this.utils.hexToRgb(r),s={"--sn-bg-gradient-primary":r};n&&(s["--sn-bg-gradient-primary-rgb"]=`${n.r},${n.g},${n.b}`),p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:s,timestamp:Date.now()})}}catch(t){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] refreshPalette failed",t)}}async _applyGenrePalette(t){try{let i=await this._getGenreAwarePalette(t);if(!i)return;this.catppuccinPalettes[this.currentTheme]=i,await this.refreshPalette(),this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Genre changed to: ${t}`)}catch(i){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] _applyGenrePalette failed",i)}}setEmergentEngine(t){this.animationEngine=t}calculateTemperatureBlendInfluence(t){let i=Math.max(0,Math.min(1,(t-1e3)/19e3));return t<=4e3?1+(4e3-t)/3e3*.3:t>=8e3?1.1+(t-8e3)/12e3*.2:.9+Math.abs(t-6e3)/2e3*.2}forceRepaint(t="settings-change"){this.refreshPalette?.()}determineOptimalOKLABPreset(t){let i=t.musicData,a=M.PRESETS.STANDARD;if(i){let{energy:r=.5,valence:n=.5}=i;r>.8&&n>.7?a=M.PRESETS.COSMIC:r>.7&&n<.4?a=M.PRESETS.VIBRANT:r<.3&&(a=M.PRESETS.SUBTLE)}return t.performanceHints?.preferLightweight&&(a=M.PRESETS.SUBTLE),this.config?.enableDebug&&console.log("\u{1F52C} [ColorHarmonyEngine] OKLAB preset selection:",{energy:i?.energy,valence:i?.valence,selectedPreset:a.name,reason:this.getPresetSelectionReason(i,t)}),a}async getAdvancedEmotionalTemperature(t,i){if(!this.emotionalTemperatureMapper||!t)return null;try{let a={energy:t.energy||.5,valence:t.valence||.5,danceability:t.danceability,tempo:t.tempo,loudness:t.loudness,acousticness:t.acousticness,instrumentalness:t.instrumentalness,speechiness:t.speechiness,mode:t.mode,key:t.key,genre:t.genre},r=await this.enhanceWithAlbumArtPsychology(a,i),n=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(r);return this.config?.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Advanced emotional temperature with album art enhancement:",{input:a,enhanced:r,albumArtInfluence:i?Object.keys(i).length+" colors":"None",emotion:n.primaryEmotion,secondaryEmotion:n.secondaryEmotion,intensity:n.intensity,temperature:n.temperature,oklabPreset:n.oklabPreset.name,perceptualColor:n.perceptualColorHex}),n}catch(a){return console.warn("[ColorHarmonyEngine] Advanced emotional temperature analysis failed:",a),null}}async enhanceWithAlbumArtPsychology(t,i){if(!i||Object.keys(i).length===0)return t;try{let a=this.analyzeAlbumArtPsychology(i),r={...t},n=r.energy||.5,s=r.valence||.5;if(a.warmth>.6&&(r.energy=Math.min(1,n*(1+a.warmth*.3)),r.valence=Math.min(1,s+a.warmth*.2)),a.coolness>.6&&(r.energy=Math.max(0,n*(1-a.coolness*.2)),a.saturation>.5&&(r.valence=Math.min(1,s+a.coolness*.15))),a.saturation>.7&&(r.energy=Math.min(1,n+a.saturation*.2)),a.saturation<.3&&(r.valence=Math.max(0,s-.15),r.energy=Math.max(0,n-.1)),a.darkness>.7){let o=r.energy||n;o>.6?r.energy=Math.min(1,o+.1):r.valence=Math.max(0,(r.valence||s)-.2)}return a.brightness>.8&&(r.valence=Math.min(1,(r.valence||s)+a.brightness*.2)),a.harmony>.8?r.valence=Math.min(1,(r.valence||s)+.1):a.harmony<.3&&(r.energy=Math.min(1,(r.energy||n)+.15)),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Album art psychology enhancement:",{original:{energy:t.energy||.5,valence:t.valence||.5},enhanced:{energy:r.energy||.5,valence:r.valence||.5},colorPsychology:a,adjustments:{energyChange:(r.energy||.5)-(t.energy||.5),valenceChange:(r.valence||.5)-(t.valence||.5)}}),r}catch(a){return console.warn("[ColorHarmonyEngine] Album art psychology enhancement failed:",a),t}}analyzeAlbumArtPsychology(t){try{let i=Object.values(t);if(i.length===0)return{warmth:.5,coolness:.5,saturation:.5,brightness:.5,darkness:.5,harmony:.5,dominantHue:180,emotionalIntensity:.5,genreIndicators:{electronicLikelihood:.5,smoothLikelihood:.5,metalHardcoreLikelihood:.5,popCommercialLikelihood:.5,jazzClassicalLikelihood:.5,folkAcousticLikelihood:.5},artistAwareness:{visualSophistication:.5,artisticIntention:.5,culturalIndicators:[],emotionalDepth:.5}};let a=0,r=0,n=0,s=0,o=0,l=[];for(let F of i){let B=this.utils.hexToRgb(F);if(!B)continue;let W=this.utils.rgbToHsl(B.r,B.g,B.b),{h:z,s:I,l:re}=W;l.push(z),z>=0&&z<=60||z>=300&&z<=360?a+=I*re:z>=120&&z<=240&&(r+=I*re),n+=I,s+=re,o+=1-re}let m=i.length,d=a/m,h=r/m,g=n/m,f=s/m,S=o/m,C=this.calculateColorHarmony(l),T=this.calculateDominantHue(l),w=Math.min(1,(g+this.calculateContrast(i))/2),R=this._analyzeGenreIndicatorsFromColors({warmth:Math.min(1,d),coolness:Math.min(1,h),saturation:g,brightness:f,darkness:S,harmony:C,dominantHue:T,emotionalIntensity:w}),O=this._analyzeArtistAwareness(i,{avgSaturation:g,avgBrightness:f,harmony:C,emotionalIntensity:w,colorCount:i.length});return{warmth:Math.min(1,d),coolness:Math.min(1,h),saturation:g,brightness:f,darkness:S,harmony:C,dominantHue:T,emotionalIntensity:w,genreIndicators:R,artistAwareness:O}}catch(i){return console.warn("[ColorHarmonyEngine] Album art psychology analysis failed:",i),{warmth:.5,coolness:.5,saturation:.5,brightness:.5,darkness:.5,harmony:.5,dominantHue:180,emotionalIntensity:.5,genreIndicators:{electronicLikelihood:.5,smoothLikelihood:.5,metalHardcoreLikelihood:.5,popCommercialLikelihood:.5,jazzClassicalLikelihood:.5,folkAcousticLikelihood:.5},artistAwareness:{visualSophistication:.5,artisticIntention:.5,culturalIndicators:[],emotionalDepth:.5}}}}calculateColorHarmony(t){if(t.length<=1)return 1;let i=0,a=[60,120,30,90];for(let n=0;n<t.length;n++)for(let s=n+1;s<t.length;s++){let o=t[n],l=t[s];if(o===void 0||l===void 0)continue;let m=Math.abs(o-l),d=Math.min(m,360-m);for(let h of a)Math.abs(d-h)<=15&&(i+=1)}let r=t.length*(t.length-1)/2;return Math.min(1,i/r)}calculateDominantHue(t){if(t.length===0)return 180;let i=new Array(12).fill(0);for(let r of t){let n=Math.floor(r/30);i[n]++}return i.indexOf(Math.max(...i))*30+15}calculateContrast(t){if(t.length<=1)return 0;let i=0,a=0;for(let r=0;r<t.length;r++)for(let n=r+1;n<t.length;n++){let s=t[r],o=t[n];if(!s||!o)continue;let l=this.utils.hexToRgb(s),m=this.utils.hexToRgb(o);if(l&&m){let d=(l.r*.299+l.g*.587+l.b*.114)/255,h=(m.r*.299+m.g*.587+m.b*.114)/255;i+=Math.abs(d-h),a++}}return a>0?i/a:0}async blendWithAdvancedOKLAB(t,i,a,r){let n={...t};try{let s=a?.oklabPreset||this.oklabState.currentPreset,o=s;r&&r.confidence>.5&&this.genreState.genreInfluenceIntensity>0&&(o=this.applyGenreColorAesthetics(s,r));let l=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let d of l){let h=t[d];if(h&&this.isValidHex(h))try{let g=r?`-${r.genre}`:"",f=`${h}-${o.name}${g}`;if(this.oklabState.processedPalette[f]){n[d]=this.oklabState.processedPalette[f].enhancedHex;continue}let S=this.oklabProcessor.processColor(h,o);n[d]=S.enhancedHex,this.oklabState.processedPalette[f]=S,this.config?.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] OKLAB enhanced ${d}:`,{original:h,enhanced:S.enhancedHex,preset:s.name,processingTime:S.processingTime})}catch(g){console.warn(`[ColorHarmonyEngine] OKLAB processing failed for ${d}:`,g)}}if(a?.perceptualColorHex&&n.PRIMARY)try{let d=this.oklabProcessor.interpolateOKLAB(n.PRIMARY,a.perceptualColorHex,a.intensity*.3,s);n.EMOTIONAL_BLEND=d.enhancedHex,this.config?.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Emotional color blending:",{primary:n.PRIMARY,emotionalColor:a.perceptualColorHex,blendFactor:a.intensity*.3,result:d.enhancedHex})}catch(d){console.warn("[ColorHarmonyEngine] Emotional color blending failed:",d)}this.oklabState.lastProcessingTime=Date.now();let m=this.getAlbumArtInfluenceSetting();if(m>0&&t&&Object.keys(t).length>0)try{let d=await this._applyDirectAlbumColorBlending(n,t,m,o);Object.assign(n,d),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Applied direct album color blending:",{albumInfluence:(m*100).toFixed(1)+"%",blendedKeys:Object.keys(d),note:"album colors now directly influence final UI colors"})}catch(d){console.warn("[ColorHarmonyEngine] Direct album color blending failed:",d)}if(this.semanticColorManager)try{this.semanticColorManager.updateWithAlbumColors(n),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Applied comprehensive Spicetify variable updates via strategy pattern:",{processedColorCount:Object.keys(n).length,methodUsed:"blendWithAdvancedOKLAB"})}catch(d){console.warn("[ColorHarmonyEngine] Failed to update Spicetify variables via strategy pattern:",d)}}catch(s){console.error("[ColorHarmonyEngine] Advanced OKLAB blending failed:",s)}return n}generateAdvancedOKLABCSSVariables(t){let i={};try{if(Object.entries(t.processedColors).forEach(([a,r])=>{r&&typeof r=="string"&&(i[`--sn-processed-${a.toLowerCase()}`]=r)}),Object.entries(this.oklabState.processedPalette).forEach(([a,r])=>{let[n,s]=a.split("-");if(n&&s){let o=`sn-oklab-${s.toLowerCase()}`,l=this.oklabProcessor.generateCSSVariables(r,o);Object.assign(i,l)}}),this.oklabState.perceptualGradientCache.size>0){let a=Array.from(this.oklabState.perceptualGradientCache.entries()),[r,n]=a[0]||[];if(n&&n.length>0){n.forEach((o,l)=>{let m=l/(n.length-1)*100;i[`--sn-oklab-gradient-stop-${l}`]=o.enhancedHex,i[`--sn-oklab-gradient-stop-${l}-rgb`]=`${o.enhancedRgb.r},${o.enhancedRgb.g},${o.enhancedRgb.b}`,i[`--sn-oklab-gradient-stop-${l}-pos`]=`${m}%`});let s=n.map((o,l)=>{let m=l/(n.length-1)*100;return`${o.enhancedHex} ${m}%`}).join(", ");i["--sn-oklab-perceptual-gradient"]=`linear-gradient(135deg, ${s})`,i["--sn-oklab-gradient-stop-count"]=n.length.toString()}}if(t.processedColors.EMOTIONAL_BLEND){i["--sn-audioAnalysis-emotional-color"]=t.processedColors.EMOTIONAL_BLEND;let a=ne(t.processedColors.EMOTIONAL_BLEND);a&&(i["--sn-audioAnalysis-emotional-rgb"]=`${a.r},${a.g},${a.b}`)}i["--sn-oklab-preset-active"]=this.oklabState.currentPreset.name,i["--sn-oklab-cache-size"]=Object.keys(this.oklabState.processedPalette).length.toString(),i["--sn-oklab-last-processing"]=this.oklabState.lastProcessingTime.toString(),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Generated advanced OKLAB CSS variables:",{totalVariables:Object.keys(i).length,gradientStops:this.oklabState.perceptualGradientCache.size,oklabProcessedColors:Object.keys(this.oklabState.processedPalette).length})}catch(a){console.error("[ColorHarmonyEngine] Advanced OKLAB CSS variable generation failed:",a)}return i}generatePerceptualGradientData(t){try{let i=t.processedColors.PRIMARY,a=t.processedColors.SECONDARY||t.processedColors.EMOTIONAL_BLEND;if(!i||!this.isValidHex(i))return;let r=i,n=a&&this.isValidHex(a)?a:this.generateComplementaryColor(i),s=`${r}-${n}-${this.oklabState.currentPreset.name}`;if(this.oklabState.perceptualGradientCache.has(s))return;let o=7,l=this.oklabProcessor.generateOKLABGradient(r,n,o,this.oklabState.currentPreset);if(this.oklabState.perceptualGradientCache.set(s,l),this.oklabState.perceptualGradientCache.size>10){let m=this.oklabState.perceptualGradientCache.keys().next().value;m&&this.oklabState.perceptualGradientCache.delete(m)}this.config?.enableDebug&&console.log("\u{1F308} [ColorHarmonyEngine] Generated perceptual gradient data:",{startColor:r,endColor:n,stopCount:o,preset:this.oklabState.currentPreset.name,cacheKey:s,cacheSize:this.oklabState.perceptualGradientCache.size})}catch(i){console.error("[ColorHarmonyEngine] Perceptual gradient generation failed:",i)}}updateAdvancedHarmonyMetrics(t,i){try{let a=t.processedColors.PRIMARY,r=t.processedColors.SECONDARY,n=.5;if(a&&this.isValidHex(a)){let o=ne(a);if(o){let l=this.calculateColorVibrancy(o);n=Math.min(1,l*.8+.2)}}let s={processingTime:i,harmonyScore:n,oklabProcessedColors:Object.keys(this.oklabState.processedPalette).length,perceptualGradientsCached:this.oklabState.perceptualGradientCache.size,currentPreset:this.oklabState.currentPreset.name,lastUpdate:Date.now()};t.metadata&&(t.metadata.advancedHarmonyMetrics=s),this.config?.enableDebug&&console.log("\u{1F4CA} [ColorHarmonyEngine] Advanced harmony metrics updated:",s)}catch(a){console.error("[ColorHarmonyEngine] Advanced harmony metrics update failed:",a)}}getPresetSelectionReason(t,i){if(!t)return"No music data available";let{energy:a=.5,valence:r=.5}=t;return i.performanceHints?.preferLightweight?"Performance optimization requested":a>.8&&r>.7?"High energy + positive valence":a>.7&&r<.4?"High energy + negative valence":a<.3?"Low energy music":"Standard balanced processing"}generateComplementaryColor(t){try{let i=ne(t);if(!i)return t;let a=this.rgbToHsl(i.r,i.g,i.b),r=(a.h+180)%360,n=this.hslToRgb(r,a.s,a.l);return Se(n.r,n.g,n.b)}catch(i){return console.warn("[ColorHarmonyEngine] Complementary color generation failed:",i),t}}calculateColorVibrancy(t){let i=Math.max(t.r,t.g,t.b),a=Math.min(t.r,t.g,t.b),r=i-a;if(i===0)return 0;let n=r/i,s=i/255,o=1-Math.abs(s-.5)*2;return n*o}isValidHex(t){return/^#[0-9A-Fa-f]{6}$/.test(t)}rgbToHsl(t,i,a){t/=255,i/=255,a/=255;let r=Math.max(t,i,a),n=Math.min(t,i,a),s=r-n,o=0,l=0,m=(r+n)/2;if(s!==0){switch(l=m>.5?s/(2-r-n):s/(r+n),r){case t:o=(i-a)/s+(i<a?6:0);break;case i:o=(a-t)/s+2;break;case a:o=(t-i)/s+4;break}o/=6}return{h:o*360,s:l,l:m}}hslToRgb(t,i,a){t/=360;let r=(l,m,d)=>(d<0&&(d+=1),d>1&&(d-=1),d<1/6?l+(m-l)*6*d:d<1/2?m:d<2/3?l+(m-l)*(2/3-d)*6:l),n,s,o;if(i===0)n=s=o=a;else{let l=a<.5?a*(1+i):a+i-a*i,m=2*a-l;n=r(m,l,t+1/3),s=r(m,l,t),o=r(m,l,t-1/3)}return{r:Math.round(n*255),g:Math.round(s*255),b:Math.round(o*255)}}async analyzeGenreAesthetics(t,i){try{if(!this.genreGradientEvolution)return null;let a=this.genreGradientEvolution.getCurrentGenre(),r=this.genreGradientEvolution.getGenreConfidence();if(r<.3)return null;let n=this.genreGradientEvolution.getGenreCharacteristics(a),s=this.genreGradientEvolution.getGenreVisualStyle(a),o=1,l=r;if(i&&Object.keys(i).length>0)try{o=this._analyzeAlbumGenreHarmony(i,a,n).harmonyScore,l=r*o,this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Album-Genre harmony analysis:",{genre:a,originalConfidence:(r*100).toFixed(1)+"%",harmonyScore:(o*100).toFixed(1)+"%",validatedConfidence:(l*100).toFixed(1)+"%",albumColorCount:Object.keys(i).length})}catch(m){console.warn("[ColorHarmonyEngine] Album-genre harmony analysis failed:",m)}return this.genreState.currentGenre=a,this.genreState.genreConfidence=l,this.genreState.lastGenreUpdate=Date.now(),this.genreState.genreHistory.unshift({genre:a,confidence:l,timestamp:Date.now()}),this.genreState.genreHistory.length>10&&(this.genreState.genreHistory=this.genreState.genreHistory.slice(0,10)),this.config.enableDebug&&console.log(`\u{1F3B6} [ColorHarmonyEngine] Genre aesthetic analysis: ${a} (${(l*100).toFixed(1)}% album-validated confidence)`),{genre:a,confidence:l,characteristics:n,visualStyle:s}}catch(a){return console.warn("[ColorHarmonyEngine] Error analyzing genre aesthetics:",a),null}}applyGenreColorAesthetics(t,i){let{characteristics:a,visualStyle:r,confidence:n}=i,s={...t,name:`${t.name}-${i.genre}`,description:`${t.description} with ${i.genre} aesthetic characteristics`},o=n*this.genreState.genreInfluenceIntensity;return a.saturation>.7?s.chromaBoost=Math.min(2,t.chromaBoost+.3*o):a.saturation<.3&&(s.chromaBoost=Math.max(.8,t.chromaBoost-.2*o)),a.musicalComplexity>.7?s.vibrantThreshold=Math.max(.05,t.vibrantThreshold-.05*o):a.musicalComplexity<.3&&(s.vibrantThreshold=Math.min(.2,t.vibrantThreshold+.03*o)),a.emotionalRange>.7&&a.smoothness>.6?s.lightnessBoost=Math.max(.9,t.lightnessBoost-.1*o):a.artificialProcessing>.7&&(s.lightnessBoost=Math.min(1.4,t.lightnessBoost+.2*o)),r.contrastLevel>.7?s.shadowReduction=Math.max(.1,t.shadowReduction-.1*o):a.smoothness>.6&&(s.shadowReduction=Math.min(.5,t.shadowReduction+.1*o)),this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Applied ${i.genre} aesthetics to ${t.name} preset:`,{chromaBoost:`${t.chromaBoost} \u2192 ${s.chromaBoost}`,lightnessBoost:`${t.lightnessBoost} \u2192 ${s.lightnessBoost}`,vibrantThreshold:`${t.vibrantThreshold} \u2192 ${s.vibrantThreshold}`,genreInfluence:`${(o*100).toFixed(1)}%`}),s}_analyzeAlbumGenreHarmony(t,i,a){try{let r=1,n=[],s=Object.entries(t).map(([z,I])=>{let re=this.utils.hexToRgb(I);return re?this.utils.rgbToHsl(re.r,re.g,re.b):null}).filter(z=>z!==null);if(s.length===0)return{harmonyScore:1,explanation:"No valid album colors found"};let o=s.reduce((z,I)=>z+I.s,0)/s.length,l=a.saturation||.5,m=Math.abs(o/100-l);m<.2?(r*=1.1,n.push(`album saturation matches genre (\xB1${(m*100).toFixed(1)}%)`)):m>.4&&(r*=.85,n.push(`album saturation differs from genre expectations (${(m*100).toFixed(1)}% diff)`));let d=s.reduce((z,I)=>z+I.h,0)/s.length,h=d>=15&&d<=45||d>=315&&d<=345,g=d>=180&&d<=270,f=a.energyLevel||.5;f>.6&&h?(r*=1.15,n.push("warm album colors match high-energy genre")):f<.4&&g?(r*=1.1,n.push("cool album colors match low-energy genre")):(f>.6&&g||f<.4&&h)&&(r*=.9,n.push("album color temperature differs from genre energy"));let S=s.reduce((z,I)=>z+I.l,0)/s.length,C=S<40,T=S>70;i.includes("metal")||i.includes("goth")||i.includes("dark")?C?(r*=1.2,n.push("dark album aesthetic matches genre")):T&&(r*=.8,n.push("bright album conflicts with dark genre aesthetic")):(i.includes("pop")||i.includes("dance")||i.includes("electronic"))&&T&&(r*=1.15,n.push("bright album aesthetic matches energetic genre"));let w=s.map(z=>z.h),R=Math.max(...w)-Math.min(...w),O=R<30,F=R>120,B=a.musicalComplexity||a.harmonicComplexity||.5;B>.7&&F?(r*=1.1,n.push("diverse album colors match complex genre")):B<.3&&O&&(r*=1.1,n.push("unified album colors match simple genre")),r=Math.max(.7,Math.min(1.3,r));let W=n.length>0?n.join("; "):"album colors analyzed for genre harmony";return{harmonyScore:r,explanation:W}}catch(r){return console.warn("[ColorHarmonyEngine] Album-genre harmony analysis error:",r),{harmonyScore:1,explanation:"harmony analysis failed, using default confidence"}}}getAlbumArtInfluenceSetting(){return .5}async _applyDirectAlbumColorBlending(t,i,a,r){let n={};try{let s=this._extractDominantAlbumColors(i);if(s.length===0)return{};let o=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING"];for(let l of o){let m=t[l];if(!(!m||!this.isValidHex(m)))try{let d=this._selectHarmoniousAlbumColor(m,s);if(d){let h=this.oklabProcessor.interpolateOKLAB(m,d,a*.6,r);n[l]=h.enhancedHex,this.config?.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Album-blended ${l}:`,{original:m,albumColor:d,blended:h.enhancedHex,blendFactor:(a*.6).toFixed(2)})}}catch(d){console.warn(`[ColorHarmonyEngine] Album blending failed for ${l}:`,d)}}if(s.length>0&&a>.3)try{let l=this._selectMostVibrantColor(s);if(l){let m=this.oklabProcessor.processColor(l,r);n.ALBUM_ACCENT=m.enhancedHex,this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Created ALBUM_ACCENT:",{source:l,enhanced:m.enhancedHex})}}catch(l){console.warn("[ColorHarmonyEngine] Album accent creation failed:",l)}return n}catch(s){return console.error("[ColorHarmonyEngine] Direct album color blending error:",s),{}}}_extractDominantAlbumColors(t){let i=[],a=["VIBRANT","DOMINANT","PRIMARY","PROMINENT","LIGHT_VIBRANT","DARK_VIBRANT"];for(let r of a){let n=t[r];n&&this.isValidHex(n)&&i.push(n)}return i.length<3&&Object.values(t).forEach(r=>{r&&this.isValidHex(r)&&!i.includes(r)&&i.push(r)}),i.slice(0,5)}_selectHarmoniousAlbumColor(t,i){if(i.length===0)return null;try{let a=this.utils.hexToRgb(t);if(!a)return i[0]||null;let r=this.utils.rgbToHsl(a.r,a.g,a.b),n=i[0]||null,s=0;for(let o of i){let l=this.utils.hexToRgb(o);if(!l)continue;let m=this.utils.rgbToHsl(l.r,l.g,l.b),d=Math.abs(r.h-m.h),h=Math.min(d,360-d),g=0;h<30?g=.9:h>150&&h<210?g=.8:h>90&&h<150?g=.6:g=.4,Math.abs(r.s-m.s)<20&&(g+=.1),g>s&&(s=g,n=o)}return n}catch(a){return console.warn("[ColorHarmonyEngine] Harmonious color selection failed:",a),i[0]||null}}_selectMostVibrantColor(t){if(t.length===0)return null;try{let i=t[0]||null,a=0;for(let r of t){let n=this.utils.hexToRgb(r);if(!n)continue;let s=this.utils.rgbToHsl(n.r,n.g,n.b),o=s.s/100*(1-Math.abs(s.l-50)/50);o>a&&(a=o,i=r)}return i}catch(i){return console.warn("[ColorHarmonyEngine] Most vibrant color selection failed:",i),t[0]||null}}_analyzeGenreIndicatorsFromColors(t){let{warmth:i,coolness:a,saturation:r,brightness:n,darkness:s,harmony:o,dominantHue:l,emotionalIntensity:m}=t,d=Math.min(1,r*.4+a*.3+(n>.7||s<.3?.2:0)+(l>=180&&l<=270?.1:0)),h=Math.min(1,(i>a?i:0)*.3+(r>=.3&&r<=.7?.3:0)+(n>=.4&&n<=.7?.2:0)+o*.2),g=Math.min(1,s*.4+m*.3+(l>=0&&l<=30||l>=330?.2:0)+(r>.6||r<.2?.1:0)),f=Math.min(1,(n>.6?n*.3:0)+r*.3+(i>.5?i*.2:0)+(m>.5?.2:0)),S=Math.min(1,o*.4+(r>=.4&&r<=.8?.3:0)+(n>=.3&&n<=.8?.2:0)+(i+a)/2*.1),C=Math.min(1,i*.4+(r>=.2&&r<=.6?.3:0)+o*.2+(l>=15&&l<=60?.1:0));return{electronicLikelihood:d,smoothLikelihood:h,metalHardcoreLikelihood:g,popCommercialLikelihood:f,jazzClassicalLikelihood:S,folkAcousticLikelihood:C}}_analyzeArtistAwareness(t,i){let{avgSaturation:a,avgBrightness:r,harmony:n,emotionalIntensity:s,colorCount:o}=i,l=Math.min(1,n*.4+(o>2&&o<=5?.3:.1)+(a>=.3&&a<=.8?.2:0)+(r>=.2&&r<=.8?.1:0)),m=Math.min(1,n*.5+s*.3+(o>=2&&o<=4?.2:0)),d=[];a>.8&&s>.7&&d.push("high-energy-culture"),n>.7&&a<.6&&d.push("minimalist-aesthetic"),r<.3&&s>.6&&d.push("dark-artistic"),r>.7&&a>.6&&d.push("commercial-pop");let h=Math.min(1,s*.5+(a>.4?.2:0)+(n>.5?.2:0)+(o>=3?.1:0));return{visualSophistication:l,artisticIntention:m,culturalIndicators:d,emotionalDepth:h}}};Ge.CANONICAL_HEX_VAR="--sn-accent-hex",Ge.CANONICAL_RGB_VAR="--sn-accent-rgb";Xe=Ge});var mt,Fn=y(()=>{"use strict";mt=class{static async getAudioData(){try{return typeof Spicetify<"u"&&Spicetify.getAudioData?await Spicetify.getAudioData():(console.warn("[SpicetifyCompat] Spicetify.getAudioData not available"),null)}catch(e){return console.error("[SpicetifyCompat] Error fetching audio data:",e),null}}static isAvailable(){return typeof Spicetify<"u"&&!!Spicetify.getAudioData}static async getAudioDataWithRetry(e=200,t=10){for(let i=0;i<t;i++)try{let a=await this.getAudioData();if(a)return a}catch(a){i<t-1?(console.log(`[SpicetifyCompat] Retrying audio data fetch (${i+1}/${t})...`),await new Promise(r=>setTimeout(r,e))):console.warn(`[SpicetifyCompat] Audio data fetch failed after ${t} attempts:`,a)}return null}}});var Ze,He,gi=y(()=>{"use strict";U();ae();Ze={electronic:{energyBoost:1.1,beatEmphasis:1.2,precision:.9,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"dynamic"}},dance:{energyBoost:1.2,beatEmphasis:1.25,precision:.95,oklabPreset:"COSMIC",colorCharacteristics:{vibrancyLevel:"cosmic",emotionalRange:"extreme",colorTemperature:"dynamic"}},house:{energyBoost:1.2,beatEmphasis:1.25,precision:.95,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"warm"}},techno:{energyBoost:1.15,beatEmphasis:1.3,precision:1,oklabPreset:"COSMIC",colorCharacteristics:{vibrancyLevel:"cosmic",emotionalRange:"extreme",colorTemperature:"cool"}},trance:{energyBoost:1.15,beatEmphasis:1.1,precision:.85,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"dynamic"}},rock:{energyBoost:1.05,intensityMultiplier:1.1,dynamicRange:1.1,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"warm"}},metal:{energyBoost:1.15,intensityMultiplier:1.2,dynamicRange:1.2,oklabPreset:"COSMIC",colorCharacteristics:{vibrancyLevel:"cosmic",emotionalRange:"extreme",colorTemperature:"cool"}},punk:{energyBoost:1.2,intensityMultiplier:1.1,precision:.8,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"dynamic"}},hiphop:{beatEmphasis:1.3,grooveFactor:1.2,tempoMultiplier:.95,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"warm"}},rap:{beatEmphasis:1.3,grooveFactor:1.2,tempoMultiplier:.95,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"}},jazz:{adaptiveVariation:!0,complexity:1.2,smoothingFactor:1.3,oklabPreset:"SUBTLE",colorCharacteristics:{vibrancyLevel:"subtle",emotionalRange:"wide",colorTemperature:"warm"}},classical:{gentleMode:!0,dynamicRange:1.4,tempoVariationHandling:"adaptive",oklabPreset:"SUBTLE",colorCharacteristics:{vibrancyLevel:"subtle",emotionalRange:"extreme",colorTemperature:"neutral"}},ambient:{subtleMode:!0,intensityReduction:.7,smoothingFactor:1.5,oklabPreset:"SUBTLE",colorCharacteristics:{vibrancyLevel:"subtle",emotionalRange:"narrow",colorTemperature:"cool"}},pop:{energyBoost:1.05,beatEmphasis:1.1,precision:.85,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"warm"}},rnb:{grooveFactor:1.25,smoothingFactor:1.1,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"warm"}},soul:{grooveFactor:1.3,smoothingFactor:1.15,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"wide",colorTemperature:"warm"}},default:{balanced:!0,energyBoost:1,beatEmphasis:1,precision:1,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"}}},He=class{constructor(e={}){this.config=e.ADVANCED_SYSTEM_CONFIG||e.YEAR3000_CONFIG||E,this.config.enableDebug&&console.log("\u{1F9EC} [GenreProfileManager] Initialized")}_getGenreFromAudioFeatures(e){if(!e)return"default";let{danceability:t=.5,energy:i=.5,acousticness:a=.5,instrumentalness:r=.5,tempo:n=120}=e;return r>.6&&a<.2&&i>.6?n>120?"techno":"electronic":t>.7&&i>.7?"dance":a>.7&&i<.4?"classical":a>.5&&r<.1?"jazz":i>.7&&r<.1&&t>.5?"rock":t>.7&&r<.2&&i>.5&&n<110?"hiphop":"default"}getProfileForTrack(e){let t=this._getGenreFromAudioFeatures(e),i=Ze[t];if(this.config.enableDebug&&console.log(`[GenreProfileManager] Detected genre: '${t}'. Applying profile.`),i)return i;let a=Ze.default;if(a)return a;throw new Error("[GenreProfileManager] Critical: Default genre profile is missing.")}detectGenre(e){return this._getGenreFromAudioFeatures(e)}getOKLABPresetForGenre(e){let t=Ze[e]||Ze.default,i=t.oklabPreset||"STANDARD";try{let a=M.getPreset(i);return this.config.enableDebug&&console.log(`\u{1F9EC} [GenreProfileManager] OKLAB preset for genre '${e}':`,{genre:e,preset:i,colorCharacteristics:t.colorCharacteristics}),a}catch(a){return this.config.enableDebug&&console.warn(`\u{1F9EC} [GenreProfileManager] Failed to get OKLAB preset '${i}' for genre '${e}', using STANDARD:`,a),M.getPreset("STANDARD")}}getOKLABPresetForTrack(e){let t=this.detectGenre(e);return this.getOKLABPresetForGenre(t)}getColorCharacteristicsForGenre(e){let i=(Ze[e]||Ze.default).colorCharacteristics||{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"};return this.config.enableDebug&&console.log(`\u{1F9EC} [GenreProfileManager] Color characteristics for genre '${e}':`,i),i}getColorCharacteristicsForTrack(e){let t=this.detectGenre(e);return this.getColorCharacteristicsForGenre(t)}createContextualOKLABPreset(e,t=1,i="contextual"){let a=this.detectGenre(e),r=this.getOKLABPresetForGenre(a),n=this.getColorCharacteristicsForGenre(a),s=e.energy||.5,o=e.danceability||.5,l=(s+o)/2*t,m=r.chromaBoost*(.8+l*.4),d=r.lightnessBoost*(.9+l*.2),h=M.createCustomPreset(`${a}-${i}`,`Contextual ${r.description} for ${a}`,d,m,r.shadowReduction,r.vibrantThreshold);return this.config.enableDebug&&console.log("\u{1F9EC} [GenreProfileManager] Created contextual OKLAB preset:",{genre:a,basePreset:r.name,contextualPreset:h.name,adjustments:{chromaBoost:`${r.chromaBoost} \u2192 ${m}`,lightnessBoost:`${r.lightnessBoost} \u2192 ${d}`,intensityMultiplier:t,combinedIntensity:l}}),h}getAllGenreOKLABMappings(){let e={};return Object.entries(Ze).forEach(([t,i])=>{e[t]={preset:i.oklabPreset||"STANDARD",characteristics:i.colorCharacteristics}}),this.config.enableDebug&&console.log("\u{1F9EC} [GenreProfileManager] All genre-OKLAB mappings:",e),e}}});var Y,we,pi=y(()=>{"use strict";U();L();X();Fn();be();gi();ae();Me();Y={enableDebug:!0,enableBeatSynchronization:!0,enableGenreAnalysis:!0,enableMoodAdaptation:!0,bpmCalculation:{useEnhancedAlgorithm:!0,danceabilityWeight:.9,energyWeight:.6,bpmWeight:.6,energyThreshold:.5,danceabilityThreshold:.5,bpmThreshold:.8,maxBPM:180,minBPM:60},performance:{cacheSize:100,cacheTTL:3e5,maxRetries:10,retryDelay:200,enableMetrics:!0,processingTimeTarget:50},synchronization:{beatAccuracyTarget:50,maxSyncDelay:1e3,adaptiveQuality:!0,predictiveCaching:!0,debounceRapidChanges:200},genreProfiles:{electronic:{intensityMultiplier:1.2,precisionBoost:1.1},jazz:{smoothingFactor:1.3,adaptiveVariation:!0},classical:{gentleMode:!0,tempoVariationHandling:"adaptive"},rock:{energyBoost:1.15,consistentTiming:!0},ambient:{subtleMode:!0,intensityReduction:.7},hiphop:{beatEmphasis:1.25,rhythmPrecision:"high"},default:{balanced:!0}},musicVisualSync:{enhancedBPM:{fallbacks:{tempo:120,loudness:-5,key:0,timeSignature:4},danceabilityEstimation:{highDance:{min:125,max:145,value:.8},mediumDance:{min:100,max:124,value:.7},lowMediumDance:{min:80,max:99,value:.6},lowDance:{value:.5}},energyEstimation:{tempoRange:{min:80,max:160},loudnessRange:{min:-15,max:0},tempoWeight:.6,loudnessWeight:.4}}}},we=class{constructor(e={}){this.isInitialized=!1;this.currentTrack=null;this.audioData=null;this.currentTrackUri=null;this.latestProcessedData=null;this.beatSchedulerTimer=null;this.songChangeDebounceTimer=null;this.nextBeatIndex=0;this.currentSongBeats=[];this.songStartTimestamp=0;this.metrics={bpmCalculations:0,beatSyncs:0,cacheHits:0,cacheMisses:0,avgProcessingTime:0,performance:[],errors:0,updates:0};this.unifiedCache=new Map;this.subscribers=new Map;this.beatSync={lastBeatTime:0,nextBeatTime:0,beatInterval:0,confidence:0,isActive:!1};this.performanceInterval=null;this.cacheCleanupInterval=null;this.CACHE_KEY_VERSION_PREFIX="v3";this.eventProcessingState={isProcessingEvent:!1,eventChain:[],lastEventTime:0,consecutiveEvents:0};this.MAX_CONSECUTIVE_EVENTS=5;this.EVENT_RESET_TIMEOUT=3e3;this.currentBeatVector={x:0,y:0};this.config=e.ADVANCED_SYSTEM_CONFIG||e.YEAR3000_CONFIG||E,this.utils=e.ThemeUtilities||D,this.settingsManager=e.settingsManager||null,this.year3000System=e.year3000System||null,this.genreProfileManager=e.genreProfileManager||new He({ADVANCED_SYSTEM_CONFIG:this.config}),this.oklabProcessor=new M(this.config.enableDebug),this.emotionalTemperatureMapper=new Z(this.config.enableDebug),this.cacheTTL=Y.performance.cacheTTL,this.userPreferences=this.loadUserPreferences(),this.config.enableDebug&&(console.log("\u{1F3B5} MusicSyncService constructor called"),console.log("\u{1F3B5} [MusicSyncService] Initialized with GenreProfileManager support"))}get initialized(){return this.isInitialized}async initialize(){try{this.config.enableDebug&&console.log("\u{1F3B5} Initializing unified MusicSyncService..."),mt.isAvailable()||console.warn("[MusicSyncService] Spicetify audio data API not available at initialization. Some features may be limited."),this.setupCacheManagement(),Y.performance.enableMetrics&&this.setupPerformanceMonitoring(),this.isInitialized=!0,this.config.enableDebug&&console.log("\u{1F31F} MusicSyncService initialized successfully!")}catch(e){console.error("\u274C MusicSyncService initialization failed:",e),this.metrics.errors++}}subscribe(e,t){if(!e||typeof e.updateFromMusicAnalysis!="function"){console.warn(`[MusicSyncService] Invalid system or missing updateFromMusicAnalysis method: ${t}`);return}if(this.subscribers.has(t)){this.config.enableDebug&&console.warn(`[MusicSyncService] System ${t} already subscribed.`);return}if(this.subscribers.set(t,e),this.config.enableDebug&&console.log(`[MusicSyncService] System subscribed: ${t}`),this.latestProcessedData&&e.initialized)try{e.updateFromMusicAnalysis(this.latestProcessedData,null,this.currentTrackUri)}catch(i){console.error(`[MusicSyncService] Error notifying new subscriber ${t}:`,i)}}unsubscribe(e){this.subscribers.has(e)&&(this.subscribers.delete(e),this.config.enableDebug&&console.log(`[MusicSyncService] System unsubscribed: ${e}`))}notifySubscribers(e,t,i){if(!this.isInitialized){console.warn("[MusicSyncService] Not initialized, cannot notify subscribers.");return}this.latestProcessedData=e;for(let[a,r]of this.subscribers)try{r.initialized&&typeof r.updateFromMusicAnalysis=="function"&&r.updateFromMusicAnalysis(e,t,i)}catch(n){console.error(`[MusicSyncService] Error notifying subscriber ${a}:`,n),this.metrics.errors++}}async fetchAudioData(e={}){let{retryDelay:t=Y.performance.retryDelay,maxRetries:i=Y.performance.maxRetries}=e,a=Spicetify.Player.data?.item?.uri;if(!a)return this.config.enableDebug&&console.warn("[MusicSyncService] No current track URI to fetch audio data."),null;let r=this.generateCacheKey(a,"audioData"),n=this.getFromCache(r);if(n?.audioData){if(this.isValidAudioData(n.audioData))return this.metrics.cacheHits++,this.config.enableDebug&&console.log(`[MusicSyncService] Cache hit for audioData: ${r}`),n.audioData;this.unifiedCache.delete(r)}this.metrics.cacheMisses++;for(let s=0;s<i;s++){try{let o=await mt.getAudioData();if(this.isValidAudioData(o))return this.setInCache(r,{audioData:o}),o;this.config.enableDebug&&console.log(`[MusicSyncService] Audio analysis unavailable (attempt ${s+1}/${i}). Retrying\u2026`)}catch(o){if(s===i-1){this.config.enableDebug&&console.warn("[MusicSyncService] Audio data fetch error on final attempt:",o),this.metrics.errors++;let l={tempo:120,energy:.5,valence:.5,loudness:-10,key:0,time_signature:4,danceability:.5,acousticness:.5,instrumentalness:0,speechiness:.05,liveness:.2,mode:1};return this.config.enableDebug&&console.warn("[MusicSyncService] All audio-data attempts failed \u2013 using fallback defaults"),l}}await new Promise(o=>setTimeout(o,t))}return null}async getAudioFeatures(){try{let e=Spicetify.Player.data?.item;if(!e?.uri)return null;let t=e.uri.split(":")[2]||"fallback",i=this.generateCacheKey(t,"features"),a=this.getFromCache(i);if(a?.audioFeatures)return this.metrics.cacheHits++,this.config.enableDebug&&console.log(`[MusicSyncService] Cache hit for audioFeatures: ${i}`),a.audioFeatures;this.metrics.cacheMisses++;let r=await Spicetify.CosmosAsync.get(`https://api.spotify.com/v1/audio-features/${t}`),n={danceability:r.danceability,energy:r.energy,valence:r.valence,acousticness:r.acousticness,instrumentalness:r.instrumentalness,tempo:r.tempo};return this.setInCache(i,{audioFeatures:n}),n}catch(e){return this.config.enableDebug&&console.warn("[MusicSyncService] Could not fetch audio features:",e),null}}generateCacheKey(e,t="default"){return`${this.CACHE_KEY_VERSION_PREFIX}-${e}-${t}`}getFromCache(e){let t=this.unifiedCache.get(e);return t&&Date.now()-t.timestamp<this.cacheTTL?t.data:(t&&this.unifiedCache.delete(e),null)}setInCache(e,t){this.unifiedCache.set(e,{data:t,timestamp:Date.now()})}async calculateEnhancedBPM(e,t={}){let i=performance.now();try{if(!e?.tempo)return this.config.enableDebug&&console.warn("[MusicSyncService] No BPM data available for track"),this.getFallbackBPM();let a=e.tempo,r={...Y.bpmCalculation,...t},n=await this.getAudioFeatures();if(!n)return this.config.enableDebug&&console.log("[MusicSyncService] Using basic BPM calculation"),this.validateBPM(a);let{danceability:s,energy:o,valence:l=.5}=n;this.config.enableDebug&&console.log(`[MusicSyncService] Audio features - Danceability: ${s}, Energy: ${o}, Valence: ${l}`);let m=this.genreProfileManager.getProfileForTrack(n||void 0),d=this.genreProfileManager.detectGenre(n||void 0),h=this.computeAdvancedBPM({trackBPM:a,danceability:s,energy:o,valence:l,config:r,profile:m}),f=(Spicetify.Player.data?.item||Spicetify.Player.data)?.uri?.split(":")??[],S=f.length>2&&f[2]?f[2]:"fallback",C=this.generateCacheKey(S,"bpm");return this.setInCache(C,{bpm:h,audioFeatures:n}),this.metrics.bpmCalculations++,this.config.enableDebug&&console.log(`[MusicSyncService] Enhanced BPM: ${h} (original: ${a})`),h}catch(a){return console.error("[MusicSyncService] BPM calculation failed:",a),this.metrics.errors++,this.getFallbackBPM()}}computeAdvancedBPM(e){let{trackBPM:t,danceability:i,energy:a,valence:r,config:n,profile:s}=e,{danceabilityWeight:o,energyWeight:l,bpmWeight:m,energyThreshold:d,danceabilityThreshold:h,bpmThreshold:g,maxBPM:f,minBPM:S}=n,C=Math.min(t/120,2),T=o,w=l,R=m;i<h&&(T*=i),a<d&&(w*=a),C<g&&(R=.9);let O=1;r>.6?O=1.05:r<.4&&a<.5&&(O=.95);let F=T+w+R,W=(i*T+a*w+C*R)/F*120*O;return s.beatEmphasis&&(W*=s.beatEmphasis),W=Math.max(S,Math.min(f,W)),Math.round(W*100)/100}validateBPM(e){let{minBPM:t,maxBPM:i}=Y.bpmCalculation;return Math.max(t,Math.min(i*2,Math.round(e*100)/100))}getFallbackBPM(){return 75}estimateDanceabilityFromTempo(e){let t=Y.musicVisualSync.enhancedBPM.danceabilityEstimation;return e>=t.highDance.min&&e<=t.highDance.max?t.highDance.value:e>=t.mediumDance.min&&e<=t.mediumDance.max?t.mediumDance.value:e>=t.lowMediumDance.min&&e<=t.lowMediumDance.max?t.lowMediumDance.value:t.lowDance.value}estimateEnergyFromTempoLoudness(e,t){let i=Y.musicVisualSync.enhancedBPM.energyEstimation,a=Math.max(0,Math.min(1,(e-i.tempoRange.min)/(i.tempoRange.max-i.tempoRange.min))),r=Math.max(0,Math.min(1,(t-i.loudnessRange.min)/(i.loudnessRange.max-i.loudnessRange.min)));return a*i.tempoWeight+r*i.loudnessWeight}estimateValenceFromKey(e){return[0,2,4,5,7,9,11].includes(e)?.6:.4}getFallbackProcessedData(e){let t=Y.musicVisualSync.enhancedBPM.fallbacks,i=6e4/t.tempo;return{trackUri:e,timestamp:Date.now(),tempo:t.tempo,loudness:t.loudness,key:t.key,timeSignature:t.timeSignature,estimatedDanceability:this.estimateDanceabilityFromTempo(t.tempo),estimatedEnergy:this.estimateEnergyFromTempoLoudness(t.tempo,t.loudness),estimatedValence:.5,energy:.5,valence:.5,processedEnergy:.5,visualIntensity:.5,moodIdentifier:"neutral",baseBPM:t.tempo,enhancedBPM:t.tempo,beatInterval:i,bmpCalculationMethod:"fallback",dataSource:"fallback"}}async createOKLABEnhancedFallbackColors(e){let t={VIBRANT:"#f2cdcd",DARK_VIBRANT:"#cba6f7",LIGHT_VIBRANT:"#f5c2e7",PROMINENT:"#cba6f7",VIBRANT_NON_ALARMING:"#f2cdcd",DESATURATED:"#9399b2"};if(!e||typeof e.energy!="number"||typeof e.valence!="number"){let s=M.getPreset("STANDARD"),o={};for(let[l,m]of Object.entries(t))try{let d=this.oklabProcessor.processColor(m,s);o[l]=d.enhancedHex}catch(d){this.config.enableDebug&&console.warn(`\u{1F3A8} [MusicSyncService] OKLAB processing failed for ${l}:`,d),o[l]=m}return o}let i={energy:e.energy,valence:e.valence,danceability:e.danceability,tempo:e.tempo,mode:e.mode,genre:this.genreProfileManager.detectGenre(e)},a=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(i),r;a.intensity>=1?r=M.getPreset("COSMIC"):a.intensity>=.7?r=M.getPreset("VIBRANT"):a.intensity>=.5?r=M.getPreset("STANDARD"):r=M.getPreset("SUBTLE");let n={};for(let[s,o]of Object.entries(t))try{let l=this.oklabProcessor.processColor(o,r);n[s]=l.enhancedHex}catch(l){this.config.enableDebug&&console.warn(`\u{1F3A8} [MusicSyncService] OKLAB processing failed for ${s}:`,l),n[s]=o}return n["--sn-emotional-primary"]=a.perceptualColorHex||a.primaryEmotion,n["--sn-emotional-intensity"]=a.intensity.toString(),n["--sn-emotional-preset"]=r.name,this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Created OKLAB-enhanced fallback colors:",{emotion:a.primaryEmotion,intensity:a.intensity,preset:r.name,oklabCoordination:n,musicContext:{energy:e.energy,valence:e.valence}}),n}async enhanceExtractedColorsWithOKLAB(e,t){let i={},a=M.getPreset("STANDARD");if(t&&typeof t.energy=="number"&&typeof t.valence=="number"){let r={energy:t.energy,valence:t.valence,danceability:t.danceability,tempo:t.tempo,mode:t.mode,genre:this.genreProfileManager.detectGenre(t)},n=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(r);n.intensity>=1?a=M.getPreset("COSMIC"):n.intensity>=.7?a=M.getPreset("VIBRANT"):n.intensity>=.5?a=M.getPreset("STANDARD"):a=M.getPreset("SUBTLE"),i["--sn-emotional-primary"]=n.perceptualColorHex||`oklabColorProcessor-${n.primaryEmotion}`,i["--sn-emotional-intensity"]=n.intensity.toString(),i["--sn-emotional-temperature"]=n.temperature.toString(),this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Applying OKLAB enhancement with emotional context:",{emotion:n.primaryEmotion,intensity:n.intensity,preset:a.name,colorCount:Object.keys(e).length})}for(let[r,n]of Object.entries(e)){if(!n||typeof n!="string"||!n.startsWith("#")){i[r]=n;continue}try{let s=this.oklabProcessor.processColor(n,a);i[r]=s.enhancedHex,i[`${r}-oklab-l`]=s.oklabEnhanced.L.toFixed(3),i[`${r}-oklab-a`]=s.oklabEnhanced.a.toFixed(3),i[`${r}-oklab-b`]=s.oklabEnhanced.b.toFixed(3),i[`${r}-oklch-c`]=s.oklchEnhanced.C.toFixed(3),i[`${r}-oklch-h`]=s.oklchEnhanced.H.toFixed(1)}catch(s){this.config.enableDebug&&console.warn(`\u{1F3A8} [MusicSyncService] OKLAB processing failed for ${r} (${n}):`,s),i[r]=n}}return i["--sn-oklab-preset"]=a.name,i["--sn-oklab-enhanced"]="true",this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] OKLAB color enhancement completed:",{originalCount:Object.keys(e).length,enhancedCount:Object.keys(i).length,preset:a.name,sampleEnhanced:{original:e.VIBRANT||e[Object.keys(e)[0]||""],enhanced:i.VIBRANT||i[Object.keys(i)[0]||""]}}),i}async processAudioFeatures(e,t,i){if(!this.isInitialized){console.warn("[MusicSyncService] Not initialized, skipping processing.");return}this.stopBeatScheduler(),this.currentTrackUri=t;let a=this.generateCacheKey(t,"processed"),r=this.getFromCache(a);if(r?.processedData){this.notifySubscribers(r.processedData,null,t);return}try{let n=e;if(n||(n=await this.fetchAudioData()),!n)throw new Error("Failed to fetch or receive audio data.");n.beats&&n.beats.length>0&&(this.currentSongBeats=n.beats,this.songStartTimestamp=Date.now(),this.nextBeatIndex=0,this.scheduleNextBeatEvent());let s=await this.calculateEnhancedBPM(n),o=s>0?6e4/s:0,l=n,{tempo:m=Y.musicVisualSync.enhancedBPM.fallbacks.tempo,loudness:d=Y.musicVisualSync.enhancedBPM.fallbacks.loudness,key:h=Y.musicVisualSync.enhancedBPM.fallbacks.key,time_signature:g=Y.musicVisualSync.enhancedBPM.fallbacks.timeSignature}=l,f=await this.getAudioFeatures(),S=f?.danceability??this.estimateDanceabilityFromTempo(m),C=f?.energy??this.estimateEnergyFromTempoLoudness(m,d),T=f?.valence??this.estimateValenceFromKey(h),w=this.config.getCurrentMultipliers?.()||{musicEnergyBoost:1,visualIntensityBase:1},R=Math.max(.1,Math.min(1,C*(w.musicEnergyBoost||1))),F=(C*.6+S*.4)*(w.visualIntensityBase||1),B="neutral";T>.6&&C>.6?B="energetic-happy":T>.6&&C<=.6?B="calm-happy":T<=.4&&C>.6?B="intense-moody":T<=.4&&C<=.4&&(B="calm-melancholy");let W=Math.max(.5,.8+F*.4),z=this.genreProfileManager.detectGenre(f||void 0),I={trackUri:t,timestamp:Date.now(),tempo:m,loudness:d,key:h,timeSignature:g,duration:i,estimatedDanceability:S,estimatedEnergy:C,estimatedValence:T,energy:C,valence:T,processedEnergy:R,visualIntensity:F,moodIdentifier:B,baseBPM:m,enhancedBPM:s,beatInterval:o,bmpCalculationMethod:"unified-service",dataSource:"unified-music-sync-service",beatOccurred:!1,animationSpeedFactor:W,genre:z};this.setInCache(a,{processedData:I}),this.latestProcessedData=I,this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] Processed music data:",{baseTempo:m,enhancedBPM:s,mood:B,energy:C.toFixed(2),visualIntensity:F.toFixed(2)}),this.notifySubscribers(I,e,t),p.emitSync("music:beat",{bpm:I.enhancedBPM,intensity:I.visualIntensity,timestamp:performance.now(),confidence:.8}),p.emitSync("music:energy",{energy:I.energy||.5,valence:I.valence||.5,tempo:I.enhancedBPM,timestamp:performance.now()}),p.emitSync("performance:frame",{deltaTime:16,fps:60,memoryUsage:performance.memory?.usedJSHeapSize||0,timestamp:performance.now()}),this.config.enableDebug&&console.log("[MusicSyncService] Successfully processed audio features.",{baseTempo:m,enhancedBPM:s,mood:B,energy:C.toFixed(2),visualIntensity:F.toFixed(2)})}catch(n){console.error("[MusicSyncService] Processing failed:",n),this.metrics.errors++;let s=this.getFallbackProcessedData(t);this.latestProcessedData=s,this.notifySubscribers(s,null,t)}}async processSongUpdate(e=!1){let t=Spicetify.Player?.data?.item?.uri;if(t&&!(!e&&t===this.currentTrackUri)){if(this.songChangeDebounceTimer&&clearTimeout(this.songChangeDebounceTimer),e){await this._processSongUpdateInternal(t);return}this.songChangeDebounceTimer=setTimeout(async()=>{this.songChangeDebounceTimer=null,await this._processSongUpdateInternal(t)},Y.synchronization.debounceRapidChanges)}}async _processSongUpdateInternal(e){if(this.eventProcessingState.isProcessingEvent){this.config.enableDebug&&console.warn("\u{1F504} [MusicSyncService] Already processing song update - skipping to prevent recursion");return}if(this.eventProcessingState.isProcessingEvent=!0,this.eventProcessingState.lastEventTime=Date.now(),this.eventProcessingState.consecutiveEvents++,this.eventProcessingState.eventChain.push("_processSongUpdateInternal"),this.eventProcessingState.consecutiveEvents>this.MAX_CONSECUTIVE_EVENTS){console.error("\u{1F504} [MusicSyncService] CRITICAL: Too many consecutive events - circuit breaker activated",{consecutiveEvents:this.eventProcessingState.consecutiveEvents,eventChain:this.eventProcessingState.eventChain}),this._resetEventProcessingState();return}let t=setTimeout(()=>{this.config.enableDebug&&console.warn("\u{1F504} [MusicSyncService] Event processing timeout - resetting state"),this._resetEventProcessingState()},this.EVENT_RESET_TIMEOUT);try{this.invalidateTrackCaches(e);let i=Spicetify.Player.data?.item?.duration?.milliseconds||0,a=await Promise.allSettled([this.getAudioFeatures(),this.robustColorExtraction(e)]),r=a[0].status==="fulfilled"?a[0].value:null,n=a[1].status==="fulfilled"?a[1].value:null;if(a[0].status==="rejected"&&this.config.enableDebug&&console.warn("[MusicSyncService] Audio features retrieval failed, continuing without music analysis:",a[0].reason),a[1].status==="rejected"&&this.config.enableDebug&&console.warn("[MusicSyncService] Color extraction failed, continuing without color processing:",a[1].reason),this.config.enableDebug){let h=(r?1:0)+(n?1:0);h===1?console.log(`[MusicSyncService] Graceful degradation: Continuing with ${r?"audio features only":"color extraction only"}`):h===2?console.log("[MusicSyncService] Full feature extraction successful"):console.warn("[MusicSyncService] Both strategies failed, will use fallback data")}console.log("\u{1F3A8} [MusicSyncService] Raw colors BEFORE sanitization:",{rawColors:n,rawColorType:typeof n,rawColorKeys:n?Object.keys(n):[],rawColorEntries:n?Object.entries(n):[]});let s=this.utils.sanitizeColorMap(n||{});console.log("\u{1F3A8} [MusicSyncService] Colors AFTER sanitization:",{sanitizedColors:s,sanitizedColorType:typeof s,sanitizedColorKeys:Object.keys(s),sanitizedColorEntries:Object.entries(s),colorCount:Object.keys(s).length,droppedCount:n?Object.keys(n).length-Object.keys(s).length:0}),this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Color extraction debug:",{trackUri:e,rawColorsReceived:n,sanitizedColors:s,colorCount:Object.keys(s).length,colorExtractorFailed:a[1].status==="rejected"});let o=s,l=!1;if(Object.keys(s).length>0)try{o=await this.enhanceExtractedColorsWithOKLAB(s,r),this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Successfully enhanced extracted colors with OKLAB processing")}catch(h){this.config.enableDebug&&console.warn("\u{1F3A8} [MusicSyncService] OKLAB enhancement failed, using original extracted colors:",h),o=s}if(Object.keys(s).length===0)try{o=await this.createOKLABEnhancedFallbackColors(r),l=!0,this.config.enableDebug&&console.warn("\u{1F3A8} [MusicSyncService] Color extraction failed, using OKLAB-enhanced Catppuccin fallback colors with emotional context")}catch(h){this.config.enableDebug&&console.warn("\u{1F3A8} [MusicSyncService] OKLAB fallback processing failed, using static fallback colors:",h),o={VIBRANT:"#f2cdcd",DARK_VIBRANT:"#cba6f7",LIGHT_VIBRANT:"#f5c2e7",PROMINENT:"#cba6f7",VIBRANT_NON_ALARMING:"#f2cdcd",DESATURATED:"#9399b2"},l=!0}let m={rawColors:o,trackUri:e,timestamp:Date.now(),colorHarmonyMode:this.config.currentColorHarmonyMode||"catppuccin",harmonicMode:this.config.currentColorHarmonyMode||"catppuccin",musicData:r?{energy:r.energy,valence:r.valence,tempo:r.tempo,genre:this.genreProfileManager.detectGenre(r)}:void 0,performanceHints:{preferLightweight:!1,enableAdvancedBlending:!0,maxProcessingTime:100}};console.log("\u{1F3A8} [MusicSyncService] FINAL colors before event emission:",{finalColors:o,finalColorKeys:Object.keys(o),finalColorEntries:Object.entries(o),usingFallback:l,extractionFailed:Object.keys(s).length===0});let d={rawColors:m.rawColors,trackUri:m.trackUri,timestamp:Date.now()};if(m.musicData&&(d.musicData=m.musicData),console.log("\u{1F3A8} [MusicSyncService] Emitting colors:extracted event with data:",{eventData:d,rawColorKeys:d.rawColors?Object.keys(d.rawColors):[],rawColorEntries:d.rawColors?Object.entries(d.rawColors):[]}),p.emitSync("colors:extracted",d),this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] Emitted colors:extracted event for strategy processing",{trackUri:e,colorCount:Object.keys(o).length,usingFallback:l,extractionFailed:Object.keys(s).length===0}),r){let h=this.convertFeaturesToAudioData(r);await this.processAudioFeatures(h,e,i)}(async()=>{let h=await this.fetchAudioData();this.isValidAudioData(h)&&await this.processAudioFeatures(h,e,i)})()}catch(i){console.error(`[MusicSyncService] Error processing song update for ${e}:`,i),this.metrics.errors++}finally{clearTimeout(t),this._resetEventProcessingState();let i=this.eventProcessingState.eventChain.indexOf("_processSongUpdateInternal");i>-1&&this.eventProcessingState.eventChain.splice(i,1)}}_resetEventProcessingState(){this.eventProcessingState.isProcessingEvent=!1,this.eventProcessingState.eventChain=[];let t=Date.now()-this.eventProcessingState.lastEventTime;if(t>this.EVENT_RESET_TIMEOUT)this.eventProcessingState.consecutiveEvents=0;else{let i=Math.min(1,t/this.EVENT_RESET_TIMEOUT);this.eventProcessingState.consecutiveEvents=Math.floor(this.eventProcessingState.consecutiveEvents*(1-i))}this.config.enableDebug&&this.eventProcessingState.consecutiveEvents>0&&console.log("\u{1F504} [MusicSyncService] Event processing state reset",{consecutiveEvents:this.eventProcessingState.consecutiveEvents,timeSinceLastEvent:t})}setupCacheManagement(){this.cacheCleanupInterval=setInterval(()=>{let e=Date.now();for(let[t,i]of this.unifiedCache.entries())e-i.timestamp>this.cacheTTL&&this.unifiedCache.delete(t)},this.cacheTTL)}setupPerformanceMonitoring(){this.performanceInterval=setInterval(()=>{if(this.metrics.performance.length>0){let e=this.metrics.performance.reduce((t,i)=>t+i,0)/this.metrics.performance.length;this.metrics.avgProcessingTime=e,this.metrics.performance=[]}},6e4)}loadUserPreferences(){try{return{enableMusicSync:!0,audioAnalysisQuality:A.get("sn-webgl-quality")||"medium",gradientIntensity:A.get("sn-gradient-intensity")||"balanced",artisticMode:A.get("sn-artistic-mode")||"artist-vision"}}catch{return{enableMusicSync:!0,audioAnalysisQuality:"medium",gradientIntensity:"balanced",artisticMode:"artist-vision"}}}saveUserPreferences(){try{this.config.enableDebug&&console.log("[MusicSyncService] User preferences updated via settings system")}catch(e){this.config.enableDebug&&console.warn("[MusicSyncService] Could not save user preferences:",e)}}updateConfiguration(e){let t={...Y};Object.assign(Y,e),this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] Configuration updated",{from:t,to:Y}),this.cacheTTL=Y.performance.cacheTTL,t.performance.enableMetrics!==Y.performance.enableMetrics&&(Y.performance.enableMetrics?this.setupPerformanceMonitoring():this.performanceInterval&&(clearInterval(this.performanceInterval),this.performanceInterval=null))}destroy(){this.songChangeDebounceTimer&&(clearTimeout(this.songChangeDebounceTimer),this.songChangeDebounceTimer=null),this.stopBeatScheduler(),this.performanceInterval&&clearInterval(this.performanceInterval),this.cacheCleanupInterval&&clearInterval(this.cacheCleanupInterval),this.subscribers.clear(),this.unifiedCache.clear(),this.isInitialized=!1,this.latestProcessedData=null,this.metrics={bpmCalculations:0,beatSyncs:0,cacheHits:0,cacheMisses:0,avgProcessingTime:0,performance:[],errors:0,updates:0},this.cacheCleanupInterval=null}setColorHarmonyEngine(e){this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] setColorHarmonyEngine called - now using event-driven pattern instead of direct dependency.")}getLatestProcessedData(){return this.latestProcessedData}getCurrentBeatVector(){return{...this.currentBeatVector}}stopBeatScheduler(){this.beatSchedulerTimer&&(clearTimeout(this.beatSchedulerTimer),this.beatSchedulerTimer=null)}triggerBeatEvent(){let t=this.nextBeatIndex*.61803398875%1*Math.PI*2;if(this.currentBeatVector={x:Math.cos(t),y:Math.sin(t)},this.latestProcessedData){let i={...this.latestProcessedData,beatOccurred:!0,beatVector:this.currentBeatVector};this.notifySubscribers(i,null,this.currentTrackUri)}this.nextBeatIndex++,this.scheduleNextBeatEvent()}scheduleNextBeatEvent(){if(this.nextBeatIndex>=this.currentSongBeats.length)return;let e=this.currentSongBeats[this.nextBeatIndex];if(!e)return;let t=Date.now()-this.songStartTimestamp,i=e.start*1e3-t;i>=0?this.beatSchedulerTimer=setTimeout(()=>this.triggerBeatEvent(),i):(this.nextBeatIndex++,this.scheduleNextBeatEvent())}isValidAudioData(e){return!!e&&typeof e.tempo=="number"&&e.tempo>0}invalidateTrackCaches(e){if(e)for(let t of this.unifiedCache.keys())t.includes(e)&&this.unifiedCache.delete(t)}convertFeaturesToAudioData(e){let t=Y.musicVisualSync.enhancedBPM.fallbacks;return{tempo:e.tempo,energy:e.energy,valence:e.valence,loudness:t.loudness,key:t.key,time_signature:t.timeSignature,danceability:e.danceability,acousticness:e.acousticness,instrumentalness:e.instrumentalness,speechiness:0,liveness:0,mode:0}}async robustColorExtraction(e,t=3){console.log("\u{1F3A8} [MusicSyncService] Starting robust color extraction:",{trackUri:e,maxRetries:t,timestamp:Date.now()});for(let i=1;i<=t;i++)try{if(!e)return console.warn("\u{1F3A8} [MusicSyncService] Empty trackUri provided to color extraction"),null;console.log(`\u{1F3A8} [MusicSyncService] Calling Spicetify.colorExtractor (attempt ${i})...`);let a=await Spicetify.colorExtractor(e);if(console.log(`\u{1F3A8} [MusicSyncService] Raw color extraction result (attempt ${i}):`,{trackUri:e,success:!!a,colorsType:typeof a,colorsIsNull:a===null,colorsIsUndefined:a===void 0,colorCount:a?Object.keys(a).length:0,rawColors:a,colorKeys:a?Object.keys(a):[],colorValues:a?Object.values(a):[]}),a&&typeof a=="object"&&Object.keys(a).length>0)return Object.entries(a).forEach(([r,n])=>{console.log(`\u{1F3A8} [MusicSyncService] Extracted color: ${r} = ${n}`)}),a;console.warn(`\u{1F3A8} [MusicSyncService] Color extraction returned empty/invalid data on attempt ${i}`)}catch(a){if(console.error(`\u{1F3A8} [MusicSyncService] Color extraction attempt ${i} failed with error:`,a,{errorMessage:a instanceof Error?a.message:String(a),errorStack:a instanceof Error?a.stack:void 0}),i<t){let r=100*i;console.log(`\u{1F3A8} [MusicSyncService] Waiting ${r}ms before retry...`),await new Promise(n=>setTimeout(n,r))}}return console.error(`\u{1F3A8} [MusicSyncService] CRITICAL: All color extraction attempts failed for ${e}`),null}updateMetrics(e){this.latestProcessedData=e}getCurrentMusicState(){return!this.latestProcessedData||!this.audioData?null:{emotion:this.latestProcessedData.emotion||null,beat:{tempo:this.latestProcessedData.bpm||this.audioData.tempo||120,energy:this.latestProcessedData.energy||this.audioData.energy||.5,timestamp:Date.now()},intensity:this.latestProcessedData.intensity||this.audioData.energy||.5}}async healthCheck(){try{let e=mt.isAvailable(),t=this.subscribers.size>0,i=this.latestProcessedData!==null,a=this.metrics.bpmCalculations+this.metrics.beatSyncs+this.metrics.cacheHits+this.metrics.cacheMisses,r=a>0?this.metrics.errors/a:0;return this.isInitialized?e?r>.5?{status:"degraded",message:`High error rate detected: ${(r*100).toFixed(1)}%`,details:{initialized:this.isInitialized,spicetifyAvailable:e,subscribers:t,recentData:i,errorRate:r,errors:this.metrics.errors,totalOperations:a}}:{status:"healthy",message:"Music sync service operational",details:{initialized:this.isInitialized,spicetifyAvailable:e,subscribers:t,subscriberCount:this.subscribers.size,recentData:i,errorRate:r,bpmCalculations:this.metrics.bpmCalculations,beatSyncs:this.metrics.beatSyncs,cacheHits:this.metrics.cacheHits,cacheMisses:this.metrics.cacheMisses,avgProcessingTime:this.metrics.avgProcessingTime,errors:this.metrics.errors,updates:this.metrics.updates}}:{status:"degraded",message:"Spicetify audio data API not available - running in limited mode",details:{initialized:this.isInitialized,spicetifyAvailable:e,subscribers:t,recentData:i,errorRate:r}}:{status:"critical",message:"System not initialized",details:{initialized:this.isInitialized,spicetifyAvailable:e}}}catch(e){return{status:"critical",message:`Health check failed: ${e instanceof Error?e.message:"Unknown error"}`,details:{error:e instanceof Error?e.message:"Unknown error"}}}}}});var fi,Gn=y(()=>{"use strict";fi=c=>({version:"1.0.0",userId:c,createdAt:Date.now(),lastModified:Date.now(),colorMemories:new Map,rhythmicPreferences:new Map,emotionalResonanceProfile:{},evolutionaryTrajectory:{adaptability:.5,explorationFactor:.5,lastUpdate:Date.now()}})});function dc(){return Hn||(Hn=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function hc(){return _n||(_n=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}function gc(c){let e=new Promise((t,i)=>{let a=()=>{c.removeEventListener("success",r),c.removeEventListener("error",n)},r=()=>{t(Je(c.result)),a()},n=()=>{i(c.error),a()};c.addEventListener("success",r),c.addEventListener("error",n)});return yi.set(e,c),e}function pc(c){if(qa.has(c))return;let e=new Promise((t,i)=>{let a=()=>{c.removeEventListener("complete",r),c.removeEventListener("error",n),c.removeEventListener("abort",n)},r=()=>{t(),a()},n=()=>{i(c.error||new DOMException("AbortError","AbortError")),a()};c.addEventListener("complete",r),c.addEventListener("error",n),c.addEventListener("abort",n)});qa.set(c,e)}function Nn(c){Ya=c(Ya)}function fc(c){return hc().includes(c)?function(...e){return c.apply(Ka(this),e),Je(this.request)}:function(...e){return Je(c.apply(Ka(this),e))}}function yc(c){return typeof c=="function"?fc(c):(c instanceof IDBTransaction&&pc(c),Wa(c,dc())?new Proxy(c,Ya):c)}function Je(c){if(c instanceof IDBRequest)return gc(c);if(Na.has(c))return Na.get(c);let e=yc(c);return e!==c&&(Na.set(c,e),yi.set(e,c)),e}function $n(c,e,{blocked:t,upgrade:i,blocking:a,terminated:r}={}){let n=indexedDB.open(c,e),s=Je(n);return i&&n.addEventListener("upgradeneeded",o=>{i(Je(n.result),o.oldVersion,o.newVersion,Je(n.transaction),o)}),t&&n.addEventListener("blocked",o=>t(o.oldVersion,o.newVersion,o)),s.then(o=>{r&&o.addEventListener("close",()=>r()),a&&o.addEventListener("versionchange",l=>a(l.oldVersion,l.newVersion,l))}).catch(()=>{}),s}function zn(c,e){if(!(c instanceof IDBDatabase&&!(e in c)&&typeof e=="string"))return;if($a.get(e))return $a.get(e);let t=e.replace(/FromIndex$/,""),i=e!==t,a=vc.includes(t);if(!(t in(i?IDBIndex:IDBObjectStore).prototype)||!(a||bc.includes(t)))return;let r=async function(n,...s){let o=this.transaction(n,a?"readwrite":"readonly"),l=o.store;return i&&(l=l.index(s.shift())),(await Promise.all([l[t](...s),a&&o.done]))[0]};return $a.set(e,r),r}async function*Mc(...c){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...c)),!e)return;e=e;let t=new Proxy(e,Cc);for(Wn.set(t,e),yi.set(t,Ka(e));e;)yield t,e=await(ja.get(t)||e.continue()),ja.delete(t)}function On(c,e){return e===Symbol.asyncIterator&&Wa(c,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&Wa(c,[IDBIndex,IDBObjectStore])}var Wa,Hn,_n,qa,Na,yi,Ya,Ka,bc,vc,$a,Sc,Un,ja,Wn,Cc,qn=y(()=>{Wa=(c,e)=>e.some(t=>c instanceof t);qa=new WeakMap,Na=new WeakMap,yi=new WeakMap;Ya={get(c,e,t){if(c instanceof IDBTransaction){if(e==="done")return qa.get(c);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return Je(c[e])},set(c,e,t){return c[e]=t,!0},has(c,e){return c instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in c}};Ka=c=>yi.get(c);bc=["get","getKey","getAll","getAllKeys","count"],vc=["put","add","delete","clear"],$a=new Map;Nn(c=>({...c,get:(e,t,i)=>zn(e,t)||c.get(e,t,i),has:(e,t)=>!!zn(e,t)||c.has(e,t)}));Sc=["continue","continuePrimaryKey","advance"],Un={},ja=new WeakMap,Wn=new WeakMap,Cc={get(c,e){if(!Sc.includes(e))return c[e];let t=Un[e];return t||(t=Un[e]=function(...i){ja.set(this,Wn.get(this)[e](...i))}),t}};Nn(c=>({...c,get(e,t,i){return On(e,t)?Mc:c.get(e,t,i)},has(e,t){return On(e,t)||c.has(e,t)}}))});var Ec,wc,bi,Yn,Qa,At,Kn=y(()=>{"use strict";Gn();qn();Ec="Year3000-TemporalMemory",wc=1,bi="aestheticSignatures",Yn="currentUser",Qa=class{constructor(){this.dbPromise=$n(Ec,wc,{upgrade(e){e.objectStoreNames.contains(bi)||e.createObjectStore(bi)}})}async getSignature(e="defaultUser"){try{let i=await(await this.dbPromise).get(bi,Yn);if(i)return i;{let a=fi(e);return await this.saveSignature(a),a}}catch(t){return console.error("[TemporalMemoryService] Failed to get signature from IndexedDB. Returning default.",t),fi(e)}}async saveSignature(e){try{let t=await this.dbPromise;e.lastModified=Date.now(),await t.put(bi,e,Yn)}catch(t){console.error("[TemporalMemoryService] Failed to save signature to IndexedDB.",t)}}async resetSignature(e="defaultUser"){let t=fi(e);return await this.saveSignature(t),console.log("[TemporalMemoryService] Aesthetic signature has been reset."),t}async getSignatureTrends(e){if(!e)return null;let t={dominantColor:null,dominantRhythm:null,avgEnergy:0,avgValence:0},i=null;e.colorMemories.forEach((s,o)=>{(!i||s.count>i.count)&&(i={hex:o,count:s.count}),t.avgValence+=s.emotionalValence*s.count});let a=0;e.colorMemories.forEach(s=>a+=s.count),a>0&&(t.avgValence/=a),t.dominantColor=i;let r=null;e.rhythmicPreferences.forEach((s,o)=>{(!r||s.count>r.count)&&(r={id:o,count:s.count}),t.avgEnergy+=s.associatedEnergy*s.count});let n=0;return e.rhythmicPreferences.forEach(s=>n+=s.count),n>0&&(t.avgEnergy/=n),t.dominantRhythm=r,t}},At=new Qa});var Te,_e,Xa=y(()=>{"use strict";L();Kn();Te=class Te{constructor(e,t,i){this.performanceCoordinator=null;this.cssAnimationManager=null;this.animations=new Map;this.frameCallbacks=new Map;this.callbackCounter=0;this.animationFrameId=null;this.isRunning=!1;this.isPaused=!1;this.lastTimestamp=0;this.frameCount=0;this.startTime=0;this.frameTimeBudget=16;this.metrics={totalFrames:0,droppedFrames:0,averageFrameTime:0,maxFrameTime:0,performanceMode:"quality",activeAnimations:0,activeCallbacks:0,frameRate:60,lastOptimization:0};this.frameContext={timestamp:0,deltaMs:0,performanceMode:"quality",frameBudget:16,beatIntensity:0,scrollRatio:0,tiltXY:{x:0,y:0}};this.performanceHistory=[];this.MAX_HISTORY_SIZE=60;this.signature=null;this.saveInterval=null;this.currentBpm=120;this.currentIntensity=.5;this.emergentEventSubscriptions=[];this.animate=()=>{if(!this.isRunning)return;let e=performance.now(),t=e-this.lastTimestamp;if(this.isPaused){this.animationFrameId=requestAnimationFrame(this.animate);return}this.frameContext.timestamp=e,this.frameContext.deltaMs=t;let i=performance.now(),a=this.frameTimeBudget,r=performance.now();this.executeFrameCallbacks(t,e);let n=performance.now()-r,s=a-n;s>2?this.executeAnimationSystemsWithBudget(t,e,s):(this.metrics.droppedFrames++,this.config.enableDebug&&Math.random()<.1&&console.warn(`[EnhancedMasterAnimationCoordinator] Skipped animation systems - budget exceeded: ${n.toFixed(2)}ms`)),performance.now()-i<a*.8&&this.processEmergentTick(t);let l=performance.now()-i;this.updatePerformanceMetrics(l),this.performanceCoordinator&&this.performanceCoordinator.trackSubsystem("MasterAnimationCoordinator",{frameTime:l,fps:this.metrics.frameRate,memoryUsage:performance.memory?.usedJSHeapSize||0,cpuUsage:l>this.frameTimeBudget?l/this.frameTimeBudget*10:0}),this.lastTimestamp=e,this.frameCount++,l>a*1.5?setTimeout(()=>{this.animationFrameId=requestAnimationFrame(this.animate)},4):this.animationFrameId=requestAnimationFrame(this.animate)};this.config=e,this.eventBus=p,this.performanceCoordinator=t||null,this.cssAnimationManager=i||null,this.startTime=performance.now(),this.lastTimestamp=this.startTime,this.currentMultipliers=this.config.cosmicMultipliers,this.subscribeToEvents(),this.initializeEmergentChoreography(),this.updateFrameBudget(),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Initialized with unified animation coordination and adaptive choreography")}coordinateVisualEffectsPulsing(e){if(!this.cssAnimationManager)return;let t=e.energy||e.intensity||.5,i=e.bpm||this.currentBpm||120;if(Math.abs(t-this.currentIntensity)<.1&&Math.abs(i-this.currentBpm)<5)return;let r=document.querySelectorAll(".Root__main-view::before, .Root__main-view, [data-visual-effects-pulsing]");r.length>0&&(this.cssAnimationManager.triggerConsciousnessBreathing(r,t,i),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Visual effects pulsing coordinated - Energy: ${t.toFixed(2)}, Tempo: ${i} BPM`)),this.currentIntensity=t,this.currentBpm=i}static getInstance(e,t,i){if(!Te.instance){if(!e)throw new Error("EnhancedMasterAnimationCoordinator requires config for first initialization");Te.instance=new Te(e,t,i)}return Te.instance}registerCSSAnimationManager(e){this.cssAnimationManager=e,this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] CSSAnimationManager registered for pulsing coordination")}registerAnimationSystem(e,t,i="normal",a=60){if(this.animations.has(e))return this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] Animation system ${e} already registered`),!1;let r={name:e,system:t,priority:i,targetFPS:a,type:"animation",enabled:!0,frameInterval:1e3/a,lastUpdate:0,frameCount:0,totalTime:0,averageFrameTime:0,maxFrameTime:0,skippedFrames:0};return this.animations.set(e,r),this.isRunning||this.startMasterAnimationLoop(),this.updateMetrics(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Registered animation system: ${e} (priority: ${i}, fps: ${a})`),!0}registerVisualSystem(e,t="normal"){if(this.animations.has(e.systemName))return this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] Visual system ${e.systemName} already registered`),!1;let i={name:e.systemName,system:e,priority:t,targetFPS:60,type:"visual",enabled:!0,frameInterval:16.67,lastUpdate:0,frameCount:0,totalTime:0,averageFrameTime:0,maxFrameTime:0,skippedFrames:0};return this.animations.set(e.systemName,i),this.isRunning||this.startMasterAnimationLoop(),this.updateMetrics(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Registered visual system: ${e.systemName} (priority: ${t})`),!0}registerFrameCallback(e,t="normal",i){let a=`callback_${++this.callbackCounter}`,r={id:a,callback:e,priority:t,system:i||void 0,enabled:!0,frameCount:0,totalTime:0,lastExecution:0};return this.frameCallbacks.set(a,r),this.isRunning||this.startMasterAnimationLoop(),this.updateMetrics(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Registered frame callback: ${a} (priority: ${t})`),a}unregisterAnimationSystem(e){let t=this.animations.delete(e);return t&&(this.updateMetrics(),this.animations.size===0&&this.frameCallbacks.size===0&&this.stopMasterAnimationLoop(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Unregistered animation system: ${e}`)),t}unregisterFrameCallback(e){let t=this.frameCallbacks.delete(e);return t&&(this.updateMetrics(),this.animations.size===0&&this.frameCallbacks.size===0&&this.stopMasterAnimationLoop(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Unregistered frame callback: ${e}`)),t}startMasterAnimationLoop(){this.isRunning||(this.isRunning=!0,this.isPaused=!1,this.lastTimestamp=performance.now(),this.frameCount=0,this.animate(),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Master animation loop started"))}stopMasterAnimationLoop(){this.isRunning&&(this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Master animation loop stopped"))}pauseAnimationLoop(){this.isPaused=!0,this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Animation loop paused")}resumeAnimationLoop(){this.isPaused&&(this.isPaused=!1,this.lastTimestamp=performance.now(),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Animation loop resumed"))}setPerformanceMode(e){this.metrics.performanceMode=e,this.frameContext.performanceMode=e,this.frameTimeBudget=e==="performance"?8:16,this.frameContext.frameBudget=this.frameTimeBudget;for(let t of this.animations.values())t.system.onPerformanceModeChange&&t.system.onPerformanceModeChange(e);this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Performance mode set to: ${e}`)}getPerformanceMetrics(){return{...this.metrics}}getRegisteredSystems(){return{animations:new Map(this.animations),callbacks:new Map(this.frameCallbacks)}}setSystemEnabled(e,t){let i=this.animations.get(e);return i?(i.enabled=t,this.updateMetrics(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] System ${e} ${t?"enabled":"disabled"}`),!0):!1}getCurrentMultipliers(){return this.currentMultipliers}async updateEvolutionaryTrajectory(){await this._updateEvolutionaryTrajectory()}destroy(){this.stopMasterAnimationLoop(),this.destroyEmergentChoreography();for(let e of this.animations.values())if(e.type==="visual"&&"destroy"in e.system)try{e.system.destroy()}catch(t){console.error(`[EnhancedMasterAnimationCoordinator] Error destroying system ${e.name}:`,t)}this.animations.clear(),this.frameCallbacks.clear(),Te.instance===this&&(Te.instance=null),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Destroyed")}executeFrameCallbacks(e,t){let i=Array.from(this.frameCallbacks.values()).filter(a=>a.enabled).sort((a,r)=>{let n={critical:0,normal:1,background:2};return n[a.priority]-n[r.priority]});for(let a of i){let r=performance.now();try{a.callback(e,t);let n=performance.now()-r;a.totalTime+=n,a.frameCount++,a.lastExecution=t,n>this.frameTimeBudget*.5&&this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] Callback ${a.id} exceeded budget: ${n.toFixed(2)}ms`)}catch(n){console.error(`[EnhancedMasterAnimationCoordinator] Error in callback ${a.id}:`,n)}}}executeAnimationSystems(e,t){let i=Array.from(this.animations.values()).filter(a=>a.enabled).sort((a,r)=>{let n={critical:0,normal:1,background:2};return n[a.priority]-n[r.priority]});for(let a of i){if(t-a.lastUpdate<a.frameInterval){a.skippedFrames++;continue}let r=performance.now();try{if(a.type==="visual")a.system.onAnimate(e,this.frameContext);else{let s=a.system;s.onAnimate&&s.onAnimate(e),s.updateAnimation&&s.updateAnimation(t,e)}let n=performance.now()-r;a.totalTime+=n,a.frameCount++,a.lastUpdate=t,a.averageFrameTime=a.totalTime/a.frameCount,a.maxFrameTime=Math.max(a.maxFrameTime,n),n>this.frameTimeBudget*.8&&this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] System ${a.name} exceeded budget: ${n.toFixed(2)}ms`)}catch(n){console.error(`[EnhancedMasterAnimationCoordinator] Error in system ${a.name}:`,n)}}}executeAnimationSystemsWithBudget(e,t,i){let a=performance.now(),r=Array.from(this.animations.values()).filter(l=>l.enabled).sort((l,m)=>{let d={critical:0,normal:1,background:2};return d[l.priority]-d[m.priority]}),n=0,s=0;for(let l of r){if(performance.now()-a>=i*.9){s=r.length-n,this.config.enableDebug&&s>0&&console.warn(`[EnhancedMasterAnimationCoordinator] Budget exhausted: skipped ${s} systems`);break}if(t-l.lastUpdate<l.frameInterval){l.skippedFrames++;continue}let d=performance.now();try{if(l.type==="visual")l.system.onAnimate(e,this.frameContext);else{let g=l.system;g.onAnimate&&g.onAnimate(e),g.updateAnimation&&g.updateAnimation(t,e)}let h=performance.now()-d;l.totalTime+=h,l.frameCount++,l.lastUpdate=t,l.averageFrameTime=l.totalTime/l.frameCount,l.maxFrameTime=Math.max(l.maxFrameTime,h),n++,h>i*.3&&this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] System ${l.name} consuming excessive budget: ${h.toFixed(2)}ms`)}catch(h){console.error(`[EnhancedMasterAnimationCoordinator] Error in system ${l.name}:`,h),n++}}let o=performance.now()-a;s>0&&(this.metrics.droppedFrames+=s),this.config.enableDebug&&Math.random()<.02&&console.log(`[EnhancedMasterAnimationCoordinator] Budget usage: ${o.toFixed(2)}ms/${i.toFixed(2)}ms, processed: ${n}/${r.length}`)}updatePerformanceMetrics(e){this.metrics.totalFrames++,this.metrics.maxFrameTime=Math.max(this.metrics.maxFrameTime,e),this.performanceHistory.push(e),this.performanceHistory.length>this.MAX_HISTORY_SIZE&&this.performanceHistory.shift(),this.metrics.averageFrameTime=this.performanceHistory.reduce((t,i)=>t+i,0)/this.performanceHistory.length,this.metrics.frameRate=this.performanceHistory.length>0?1e3/this.metrics.averageFrameTime:60,e>this.frameTimeBudget*1.5&&this.metrics.droppedFrames++,this.metrics.averageFrameTime>this.frameTimeBudget*1.2&&this.metrics.performanceMode==="quality"?(this.setPerformanceMode("performance"),this.metrics.lastOptimization=Date.now()):this.metrics.averageFrameTime<this.frameTimeBudget*.8&&this.metrics.performanceMode==="performance"&&Date.now()-this.metrics.lastOptimization>5e3&&this.setPerformanceMode("quality")}updateFrameBudget(){this.frameTimeBudget=this.metrics.performanceMode==="performance"?8:16,this.frameContext.frameBudget=this.frameTimeBudget}updateMetrics(){this.metrics.activeAnimations=Array.from(this.animations.values()).filter(e=>e.enabled).length,this.metrics.activeCallbacks=Array.from(this.frameCallbacks.values()).filter(e=>e.enabled).length}subscribeToEvents(){this.eventBus.subscribe("music:beat",e=>{this.frameContext.beatIntensity=e.intensity||0,this.coordinateVisualEffectsPulsing(e)},"EnhancedMasterAnimationCoordinator"),this.eventBus.subscribe("performance:frame",e=>{if(e.fps<45){for(let t of this.animations.values())t.frameInterval=Math.min(t.frameInterval*1.5,33.33);this.setPerformanceMode("performance")}else e.fps>55&&this.setPerformanceMode("quality")},"EnhancedMasterAnimationCoordinator")}async initializeEmergentChoreography(){try{this.signature=await At.getSignature(),this.registerEmergentEventListeners(),this.saveInterval=setInterval(()=>{this.signature&&At.saveSignature(this.signature)},3e4),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Emergent choreography initialized")}catch(e){console.error("[EnhancedMasterAnimationCoordinator] Failed to initialize adaptive choreography:",e)}}registerEmergentEventListeners(){let e=this.eventBus.subscribe("music:beat",r=>this.handleBeatFrame(r),"EnhancedMasterAnimationCoordinator"),t=this.eventBus.subscribe("colors:harmonized",r=>this.handleHarmonyFrame(r),"EnhancedMasterAnimationCoordinator"),i=this.eventBus.subscribe("music:energy",r=>{this.currentBpm=r.tempo},"EnhancedMasterAnimationCoordinator"),a=this.eventBus.subscribe("music:beat",r=>{this.currentIntensity=r.intensity},"EnhancedMasterAnimationCoordinator");this.emergentEventSubscriptions.push(e,t,i,a)}handleBeatFrame(e){this.signature&&(this.signature.lastModified=Date.now(),this.coordinateVisualEffectsPulsing({intensity:e.intensity||this.currentIntensity,energy:e.energy||this.currentIntensity,bpm:this.currentBpm}))}handleHarmonyFrame(e){if(!this.signature)return;let{kineticState:t}=e;this.signature.lastModified=Date.now()}async _updateEvolutionaryTrajectory(){if(!this.signature)return;let e=await At.getSignatureTrends(this.signature);if(!e)return;let{avgEnergy:t,avgValence:i}=e,a=.5+(t-.5)*.2;this.signature.evolutionaryTrajectory.explorationFactor=Math.max(.1,Math.min(.9,a));let r=.5+(Math.abs(i)-.2)*.3;this.signature.evolutionaryTrajectory.adaptability=Math.max(.1,Math.min(.9,r)),this.signature.evolutionaryTrajectory.lastUpdate=Date.now()}_calculateVisualPulse(e){let t=6e4/this.currentBpm,i=performance.now()%t/t,a=Math.sin(i*2*Math.PI+Math.PI/2)*15*this.currentIntensity;return{timestamp:performance.now(),bpm:this.currentBpm,intensity:this.currentIntensity,phase:i,hueShift:a}}_calculateAdaptiveCoefficients(){if(!this.signature)return;let{adaptability:e,explorationFactor:t}=this.signature.evolutionaryTrajectory,i=.5+e*.5,a=.8+t*.4;this.currentMultipliers={...this.config.cosmicMultipliers,kineticIntensity:i,visualIntensityBase:a}}processEmergentTick(e){if(!this.signature)return;this._calculateAdaptiveCoefficients(),this.signature&&Date.now()-this.signature.evolutionaryTrajectory.lastUpdate>6e4&&this._updateEvolutionaryTrajectory();let t=this._calculateVisualPulse(e),i={timestamp:performance.now(),deltaMs:e}}destroyEmergentChoreography(){this.signature&&At.saveSignature(this.signature),this.saveInterval&&(clearInterval(this.saveInterval),this.saveInterval=null),this.emergentEventSubscriptions.forEach(e=>this.eventBus.unsubscribe(e)),this.emergentEventSubscriptions=[],this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Emergent choreography destroyed")}};Te.instance=null;_e=Te});var vi,jn=y(()=>{"use strict";vi=class{constructor(e={}){this._timerRegistry=new Map;this._timerMasterInterval=null;this.config={timerIntervalMs:e.timerIntervalMs||50,maxTimerBudget:e.maxTimerBudget||10,enableDebug:e.enableDebug||!1,...e},this._timerPerformanceMetrics={totalExecutions:0,totalTime:0,maxExecutionTime:0,averageExecutionTime:0,skippedTimers:0,timerCallbacks:new Map},this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Initialized")}initialize(){this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Timer consolidation initialized")}registerConsolidatedTimer(e,t,i,a="normal"){if(this._timerRegistry.has(e)){console.warn(`[TimerConsolidationSystem] Timer ${e} already registered`);return}let r={callback:t,intervalMs:i,priority:a,lastExecution:0,enabled:!0,executionCount:0,totalExecutionTime:0,maxExecutionTime:0,skippedExecutions:0};this._timerRegistry.set(e,r),this._timerPerformanceMetrics.timerCallbacks.set(e,{calls:0,totalTime:0,maxTime:0}),this.config.enableDebug&&console.log(`\u23F1\uFE0F [TimerConsolidationSystem] Registered timer: ${e} (${i}ms, ${a} priority)`),this._timerRegistry.size===1&&!this._timerMasterInterval&&this._startMasterTimer()}unregisterConsolidatedTimer(e){this._timerRegistry.has(e)&&(this._timerRegistry.delete(e),this._timerPerformanceMetrics.timerCallbacks.delete(e),this.config.enableDebug&&console.log(`\u23F1\uFE0F [TimerConsolidationSystem] Unregistered timer: ${e}`),this._timerRegistry.size===0&&this._stopMasterTimer())}_startMasterTimer(){this._timerMasterInterval||(this._timerMasterInterval=setInterval(()=>{this._executeMasterTimerFrame()},this.config.timerIntervalMs),this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Master timer started"))}_stopMasterTimer(){this._timerMasterInterval&&(clearInterval(this._timerMasterInterval),this._timerMasterInterval=null),this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Master timer stopped")}_executeMasterTimerFrame(){let e=performance.now(),t=this.config.maxTimerBudget,i=Array.from(this._timerRegistry.entries()).sort(([,r],[,n])=>{let s={critical:0,normal:1,background:2};return s[r.priority]-s[n.priority]});for(let[r,n]of i){if(!n.enabled||t<=0&&n.priority==="background"){t<=0&&n.skippedExecutions++;continue}if(e-n.lastExecution<n.intervalMs)continue;let o=performance.now();try{n.callback();let l=performance.now()-o;n.executionCount++,n.totalExecutionTime+=l,n.maxExecutionTime=Math.max(n.maxExecutionTime,l),n.lastExecution=e;let m=this._timerPerformanceMetrics.timerCallbacks.get(r);m&&(m.calls++,m.totalTime+=l,m.maxTime=Math.max(m.maxTime,l)),t-=l}catch(l){console.error(`[TimerConsolidationSystem] Error in timer ${r}:`,l),n.enabled=!1}}let a=performance.now()-e;this._updateTimerPerformanceMetrics(a)}_updateTimerPerformanceMetrics(e){let t=this._timerPerformanceMetrics;t.totalExecutions++,t.totalTime+=e,t.maxExecutionTime=Math.max(t.maxExecutionTime,e),t.averageExecutionTime=t.totalTime/t.totalExecutions,e>this.config.maxTimerBudget&&t.skippedTimers++}destroy(){this._stopMasterTimer(),this._timerRegistry.clear(),this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Destroyed")}}});var Si,Qn=y(()=>{"use strict";U();L();x();Si=class{constructor(){this.initialized=!1;this.performanceOrchestrator=null;this.performanceThresholds={excellent:{minFPS:58,maxFrameTime:17,maxCPU:.15},good:{minFPS:50,maxFrameTime:20,maxCPU:.25},degraded:{minFPS:40,maxFrameTime:25,maxCPU:.35},critical:{minFPS:30,maxFrameTime:33,maxCPU:.5}};this.qualityTierConfigs=new Map([["minimal",{halfLife:.2,performanceMultiplier:.3,complexityReduction:.8,updateFrequency:.5,enableBeatPhase:!1,enableEnergyModulation:!1,enableTemperatureMapping:!1,useSimplifiedCalculations:!0,skipNonCriticalUpdates:!0,batchUpdates:!0}],["low",{halfLife:.15,performanceMultiplier:.5,complexityReduction:.6,updateFrequency:.7,enableBeatPhase:!1,enableEnergyModulation:!0,enableTemperatureMapping:!1,useSimplifiedCalculations:!0,skipNonCriticalUpdates:!0,batchUpdates:!0}],["medium",{halfLife:.1,performanceMultiplier:.8,complexityReduction:.4,updateFrequency:.8,enableBeatPhase:!0,enableEnergyModulation:!0,enableTemperatureMapping:!0,useSimplifiedCalculations:!1,skipNonCriticalUpdates:!1,batchUpdates:!1}],["high",{halfLife:.08,performanceMultiplier:1,complexityReduction:.2,updateFrequency:.9,enableBeatPhase:!0,enableEnergyModulation:!0,enableTemperatureMapping:!0,useSimplifiedCalculations:!1,skipNonCriticalUpdates:!1,batchUpdates:!1}],["ultra",{halfLife:.05,performanceMultiplier:1.2,complexityReduction:0,updateFrequency:1,enableBeatPhase:!0,enableEnergyModulation:!0,enableTemperatureMapping:!0,useSimplifiedCalculations:!1,skipNonCriticalUpdates:!1,batchUpdates:!1}]]);this.lastPerformanceCheck=0;this.performanceCheckInterval=1e3;this.lastQualityAdjustment=0;this.qualityAdjustmentCooldown=3e3;this.eventBus=p,this.currentPerformanceContext=this.createDefaultPerformanceContext(),this.currentLerpParams=this.qualityTierConfigs.get("medium"),this.performanceMetrics=this.createDefaultMetrics(),E.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Performance-aware LERP coordinator initialized")}async initialize(){if(!this.initialized)try{this.subscribeToPerformanceEvents(),this.startPerformanceMonitoring(),this.initialized=!0,E.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Performance-aware LERP coordination fully initialized")}catch(e){throw u?.debug?.error("PerformanceAwareLerpCoordinator","Initialization failed:",e),e}}updateAnimation(e){this.updatePerformanceMetrics(e),this.shouldAdaptPerformance()&&this.adaptLerpPerformance()}async healthCheck(){let e=this.performanceMetrics,t=e.frameTimeImpact,i=e.averageCalculationTime,a=t<1&&i<.1&&e.musicalAccuracy>.7;return{system:"PerformanceAwareLerpCoordinator",healthy:a,ok:a,details:a?"Performance-aware LERP coordination operating efficiently":`Performance issues: impact=${t.toFixed(2)}ms, calc=${i.toFixed(3)}ms`,metrics:{frameTimeImpact:t,averageCalculationTime:i,musicalAccuracy:e.musicalAccuracy,qualityLevel:this.currentPerformanceContext.qualityLevel,thermalState:this.currentPerformanceContext.thermalState,calculationsPerSecond:e.calculationsPerSecond}}}destroy(){this.stopPerformanceMonitoring(),this.unsubscribeFromPerformanceEvents(),this.initialized=!1,E.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Performance-aware LERP coordinator destroyed")}calculatePerformanceAwareMusicalLerp(e,t,i,a,r="flow",n){let s=performance.now(),o=this.getCurrentLerpParams(),l=this.calculateEffectiveHalfLife(a,r,n,o),m;o.useSimplifiedCalculations||!a?m=this.calculateSimplifiedLerp(e,t,i,l):m=this.calculateFullMusicalLerp(e,t,i,a,r,l,o);let d=performance.now()-s;return this.updateCalculationMetrics(d),m}getCurrentPerformanceContext(){return{...this.currentPerformanceContext}}getCurrentLerpParams(){return{...this.currentLerpParams}}getPerformanceMetrics(){return{...this.performanceMetrics}}setSimplePerformanceCoordinator(e){this.performanceOrchestrator=e,E.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Integrated with consolidated SimplePerformanceCoordinator")}syncWithOrchestrator(){if(this.performanceOrchestrator)try{let e=this.performanceOrchestrator.getCurrentPerformanceState?.();if(e){let t={currentFPS:e.currentFPS||this.currentPerformanceContext.currentFPS,frameTimeMs:e.frameTimeMs||this.currentPerformanceContext.frameTimeMs,qualityLevel:e.qualityLevel||this.currentPerformanceContext.qualityLevel,thermalState:e.thermalState||this.currentPerformanceContext.thermalState,memoryPressure:e.memoryPressure||this.currentPerformanceContext.memoryPressure,cpuUtilization:e.cpuUtilization||this.currentPerformanceContext.cpuUtilization};this.updatePerformanceState(t)}}catch(e){E.enableDebug&&u?.debug?.warn("PerformanceAwareLerpCoordinator","Failed to sync with orchestrator:",e)}}updatePerformanceState(e){this.currentPerformanceContext={...this.currentPerformanceContext,...e},this.adaptLerpParameters(),E.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Performance state updated",{qualityLevel:this.currentPerformanceContext.qualityLevel,currentFPS:this.currentPerformanceContext.currentFPS,thermalState:this.currentPerformanceContext.thermalState})}createDefaultPerformanceContext(){return{currentFPS:60,targetFPS:60,frameTimeMs:16.67,frameBudgetMs:16.67,qualityLevel:"medium",qualityScore:.5,deviceTier:"medium",thermalState:"nominal",powerLevel:"balanced",memoryPressure:"low",cpuUtilization:.2,memoryUtilization:.3,gpuUtilization:.2}}createDefaultMetrics(){return{averageCalculationTime:0,calculationsPerSecond:0,frameTimeImpact:0,cpuImpact:0,memoryImpact:0,musicalAccuracy:1,smoothnessQuality:1,responsiveness:1,qualityReductions:0,performanceRecoveries:0}}subscribeToPerformanceEvents(){}unsubscribeFromPerformanceEvents(){}startPerformanceMonitoring(){}stopPerformanceMonitoring(){}shouldAdaptPerformance(){let e=performance.now();if(e-this.lastPerformanceCheck<this.performanceCheckInterval)return!1;this.lastPerformanceCheck=e;let t=this.currentPerformanceContext,i=t.currentFPS<t.targetFPS*.9||t.frameTimeMs>t.frameBudgetMs*1.2||t.thermalState!=="nominal"||t.memoryPressure==="high",a=t.currentFPS>t.targetFPS*1.1&&t.frameTimeMs<t.frameBudgetMs*.8&&t.thermalState==="nominal"&&e-this.lastQualityAdjustment>this.qualityAdjustmentCooldown;return i||a}adaptLerpPerformance(){let e=this.currentPerformanceContext,t=e.currentFPS<e.targetFPS*.8||e.frameTimeMs>e.frameBudgetMs*1.3||e.thermalState==="hot"||e.thermalState==="critical"||e.memoryPressure==="high",i=e.currentFPS>e.targetFPS*1.1&&e.frameTimeMs<e.frameBudgetMs*.7&&e.thermalState==="nominal"&&e.memoryPressure==="low";t?this.reducePerformanceQuality():i&&this.increasePerformanceQuality()}reducePerformanceQuality(){let e=this.currentLerpParams;e.performanceMultiplier=Math.min(2,e.performanceMultiplier*1.2),e.complexityReduction=Math.min(.9,e.complexityReduction+.1),e.updateFrequency=Math.max(.3,e.updateFrequency*.9),e.enableTemperatureMapping?e.enableTemperatureMapping=!1:e.enableEnergyModulation?e.enableEnergyModulation=!1:e.enableBeatPhase&&(e.enableBeatPhase=!1),e.useSimplifiedCalculations=!0,e.skipNonCriticalUpdates=!0,e.batchUpdates=!0,this.performanceMetrics.qualityReductions++,this.lastQualityAdjustment=performance.now(),E.enableDebug&&u?.debug?.warn("PerformanceAwareLerpCoordinator","Reduced LERP quality for performance",{performanceMultiplier:e.performanceMultiplier,complexityReduction:e.complexityReduction})}increasePerformanceQuality(){let e=this.currentLerpParams;e.performanceMultiplier=Math.max(.5,e.performanceMultiplier*.9),e.complexityReduction=Math.max(0,e.complexityReduction-.1),e.updateFrequency=Math.min(1,e.updateFrequency*1.1),!e.enableBeatPhase&&e.complexityReduction<.3?e.enableBeatPhase=!0:!e.enableEnergyModulation&&e.complexityReduction<.2?e.enableEnergyModulation=!0:!e.enableTemperatureMapping&&e.complexityReduction<.1&&(e.enableTemperatureMapping=!0),this.performanceMetrics.performanceRecoveries++,this.lastQualityAdjustment=performance.now(),E.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Increased LERP quality",{performanceMultiplier:e.performanceMultiplier,complexityReduction:e.complexityReduction})}adaptLerpParameters(){let e=this.currentPerformanceContext,t=this.qualityTierConfigs.get(e.qualityLevel);t&&(this.currentLerpParams={...t},e.thermalState==="warm"?this.currentLerpParams.performanceMultiplier*=1.2:e.thermalState==="hot"?(this.currentLerpParams.performanceMultiplier*=1.5,this.currentLerpParams.enableTemperatureMapping=!1):e.thermalState==="critical"&&(this.currentLerpParams.performanceMultiplier*=2,this.currentLerpParams.enableTemperatureMapping=!1,this.currentLerpParams.enableEnergyModulation=!1,this.currentLerpParams.useSimplifiedCalculations=!0),e.powerLevel==="battery-saver"&&(this.currentLerpParams.performanceMultiplier*=1.5,this.currentLerpParams.enableTemperatureMapping=!1,this.currentLerpParams.updateFrequency*=.7),e.memoryPressure==="high"&&(this.currentLerpParams.batchUpdates=!0,this.currentLerpParams.skipNonCriticalUpdates=!0,this.currentLerpParams.updateFrequency*=.8))}calculateEffectiveHalfLife(e,t,i,a){let r=i||a.halfLife;if(r*=a.performanceMultiplier,e&&a.enableEnergyModulation){let n=Math.max(.5,Math.min(2,e.tempo/120));if(r/=n,a.enableEnergyModulation){let s=.7+e.energy*.6;r/=s}}return Math.max(.01,Math.min(1,r))}calculateSimplifiedLerp(e,t,i,a){let r=Math.pow(2,-(i/1e3)/a);return e+(t-e)*(1-r)}calculateFullMusicalLerp(e,t,i,a,r,n,s){let o=this.calculateSimplifiedLerp(e,t,i,n);if(s.enableBeatPhase&&a.beatPhase){let l=this.calculateBeatPhaseModifier(a.beatPhase,a.timeSinceLastBeat,a.beatInterval,r),m=s.complexityReduction>.5?.1:.2;o+=(t-e)*l*m}if(s.enableEnergyModulation&&a.danceability>0){let l=.9+a.danceability*.2;o=e+(o-e)*l}return o}calculateBeatPhaseModifier(e,t,i,a){switch(e){case"attack":return a==="pulse"?.3:.1;case"sustain":return a==="flow"?.1:.05;case"decay":return a==="pulse"?-.1:-.05;case"rest":return 0;default:return 0}}updatePerformanceMetrics(e){let t=this.performanceMetrics.frameTimeImpact;this.performanceMetrics.frameTimeImpact=t*.9+0*.1;let i=1;this.performanceMetrics.calculationsPerSecond=this.performanceMetrics.calculationsPerSecond*.95+i/(e/1e3)*.05}updateCalculationMetrics(e){let t=this.performanceMetrics.averageCalculationTime;this.performanceMetrics.averageCalculationTime=t*.9+e*.1;let i=this.performanceMetrics.frameTimeImpact;this.performanceMetrics.frameTimeImpact=i*.9+e*.1;let a=this.currentLerpParams,r=1;a.enableBeatPhase||(r-=.2),a.enableEnergyModulation||(r-=.15),a.enableTemperatureMapping||(r-=.1),a.useSimplifiedCalculations&&(r-=.1),this.performanceMetrics.musicalAccuracy=Math.max(.3,r),this.performanceMetrics.smoothnessQuality=Math.max(.5,1-(a.performanceMultiplier-1)*.3),this.performanceMetrics.responsiveness=a.updateFrequency}handleQualityChange(e){let{newLevel:t}=e;t&&t.level&&(this.currentPerformanceContext.qualityLevel=t.level,this.adaptLerpParameters())}handleThermalWarning(e){this.currentPerformanceContext.thermalState="hot",this.adaptLerpParameters(),E.enableDebug&&u?.debug?.warn("PerformanceAwareLerpCoordinator","Thermal warning - adapting LERP performance")}handleQualityLevelChange(e){let{newLevel:t}=e;t&&typeof t.level=="string"&&(this.currentPerformanceContext.qualityLevel=t.level,this.adaptLerpParameters())}}});var me,Ci=y(()=>{"use strict";x();me=class{static detectTier(){let e=this._analyzeDeviceCapabilities(),t=[],i="medium",a=.8;this._isHighTierDevice(e,t)?(i="high",a=.9):this._isLowTierDevice(e,t)?(i="low",a=.85):(t.push("Standard modern device - full experience enabled"),t.push(`${e.memory}GB RAM, ${e.cores} cores, WebGL2: ${e.webgl2}`));let r={tier:i,confidence:a,reasoning:t,capabilities:e};return u?.debug?.log("EnhancedDeviceTierDetector","Tier detection complete",r),r}static _analyzeDeviceCapabilities(){let e=navigator.deviceMemory||this._estimateMemory(),t=navigator.hardwareConcurrency||this._estimateCores(),i=this._checkWebGLSupport(),a=this._checkWebGL2Support(),r=navigator.userAgent,n=navigator.platform||"unknown";return{memory:e,cores:t,webgl:i,webgl2:a,userAgent:r,platform:n,hardwareInfo:{isHighEnd:this._detectHighEndHardware(e,t,r),isMobile:this._isMobileDevice(r,n),isOldDevice:this._isOldDevice(r),hasPerformanceIndicators:this._hasPerformanceIndicators(r)}}}static _isHighTierDevice(e,t){let{memory:i,cores:a,webgl2:r,hardwareInfo:n}=e;if(!(i>=8&&a>=6&&r))return!1;let o=[];return i>=16&&o.push("16+GB RAM"),a>=8&&o.push("8+ CPU cores"),n.hasPerformanceIndicators&&o.push("Performance GPU detected"),n.isHighEnd&&o.push("High-end hardware signatures"),o.length>=2?(t.push("High-end device detected"),t.push(`Specs: ${i}GB RAM, ${a} cores, WebGL2: ${r}`),t.push(`Indicators: ${o.join(", ")}`),!0):this._isGamingOrWorkstation(e)?(t.push("Gaming/workstation device detected"),t.push("High-performance device indicators found"),!0):!1}static _isLowTierDevice(e,t){let{memory:i,cores:a,webgl2:r,hardwareInfo:n}=e,s=[];return i<4&&s.push(`Low memory: ${i}GB`),a<4&&s.push(`Few CPU cores: ${a}`),r||s.push("No WebGL2 support"),n.isOldDevice&&s.push("Legacy device detected"),n.isMobile&&i<=4&&a<=4&&s.push("Resource-constrained mobile device"),s.length>=2?(t.push("Budget/legacy device detected - enabling performance optimizations"),t.push(...s),!0):!1}static _estimateMemory(){let e=navigator.userAgent.toLowerCase();return e.includes("mobile")||e.includes("android")?4:e.includes("ipad")||e.includes("tablet")?6:8}static _estimateCores(){return navigator.userAgent.toLowerCase().includes("mobile"),4}static _checkWebGLSupport(){try{let e=document.createElement("canvas"),i=(e.getContext("webgl")||e.getContext("experimental-webgl"))!==null;return e.remove(),i}catch{return!1}}static _checkWebGL2Support(){try{let e=document.createElement("canvas"),i=e.getContext("webgl2")!==null;return e.remove(),i}catch{return!1}}static _detectHighEndHardware(e,t,i){let a=i.toLowerCase();return[a.includes("gaming"),a.includes("nvidia"),a.includes("amd"),a.includes("geforce"),a.includes("radeon"),e>=16,t>=8].filter(Boolean).length>=2}static _isMobileDevice(e,t){let i=e.toLowerCase(),a=t.toLowerCase();return i.includes("mobile")||i.includes("android")||i.includes("iphone")||i.includes("ipad")||a.includes("arm")||"ontouchstart"in window}static _isOldDevice(e){let t=e.toLowerCase();return[/chrome\/[1-6]\d\./,/firefox\/[1-5]\d\./,/safari\/[1-9]\./,/msie|trident/].some(a=>a.test(t))}static _hasPerformanceIndicators(e){let t=e.toLowerCase();return["nvidia","amd","geforce","radeon","quadro","gaming","performance"].some(a=>t.includes(a))}static _isGamingOrWorkstation(e){let{userAgent:t,memory:i,cores:a}=e,r=t.toLowerCase();return[r.includes("gaming"),r.includes("rog"),r.includes("msi"),r.includes("alienware"),r.includes("predator"),i>=16&&a>=8].some(Boolean)}static getDeviceDescription(e){let{memory:t,cores:i,webgl2:a,hardwareInfo:r}=e,n=`${t}GB RAM, ${i} CPU cores`;return a&&(n+=", WebGL2"),r.isHighEnd&&(n+=", High-end hardware"),r.isMobile&&(n+=", Mobile device"),r.hasPerformanceIndicators&&(n+=", Performance GPU"),n}}});var dt,Za=y(()=>{"use strict";Ci();L();x();dt=class{constructor(e){this.initialized=!1;this.webglIntegration=null;this.deviceTier="medium";this.tierDetectionResult=null;this.energyBoostActive=!1;this.energyBoostTimeout=null;this.tierSettings={low:{webglQuality:"low",animationDensity:.6,updateFrequency:45,particleMultiplier:.4,corridorEffects:!1,advancedFeatures:!1,experimentalFeatures:!1},medium:{webglQuality:"high",animationDensity:.9,updateFrequency:60,particleMultiplier:1,corridorEffects:!0,advancedFeatures:!0,experimentalFeatures:!1},high:{webglQuality:"high",animationDensity:1,updateFrequency:60,particleMultiplier:1.2,corridorEffects:!0,advancedFeatures:!0,experimentalFeatures:!0}};this.energyBoostSettings={animationBoost:1.3,particleBoost:1.5,duration:1e4};this.enhancedDeviceTierDetector=e,this.currentSettings=this.tierSettings.medium,u?.debug?.log("SimpleTierBasedPerformanceSystem","Initialized with tier-based performance management")}async initialize(){this.initialized||(this.tierDetectionResult=me.detectTier(),this.deviceTier=this.tierDetectionResult.tier,this.currentSettings=this.tierSettings[this.deviceTier],this._setupMusicAnalysisListener(),this._applyTierSettings(),this.initialized=!0,u?.debug?.log("SimpleTierBasedPerformanceSystem","Initialization complete",{deviceTier:this.deviceTier,confidence:this.tierDetectionResult.confidence,reasoning:this.tierDetectionResult.reasoning,deviceDescription:me.getDeviceDescription(this.tierDetectionResult.capabilities),settings:this.currentSettings}))}async healthCheck(){return this.initialized?{healthy:!0,details:`Performance tier: ${this.deviceTier}, Energy boost: ${this.energyBoostActive?"active":"inactive"}`,system:"SimpleTierBasedPerformanceSystem"}:{healthy:!1,details:"Not initialized",system:"SimpleTierBasedPerformanceSystem"}}destroy(){this.energyBoostTimeout&&(clearTimeout(this.energyBoostTimeout),this.energyBoostTimeout=null),p.unsubscribe("colors:extracted"),p.unsubscribe("music:track-changed"),this.initialized=!1,u?.debug?.log("SimpleTierBasedPerformanceSystem","Destroyed")}updateAnimation(e){}registerWebGLIntegration(e){this.webglIntegration=e,this.initialized&&this._applyWebGLSettings(),u?.debug?.log("SimpleTierBasedPerformanceSystem","WebGL integration registered")}getDeviceTier(){return this.deviceTier}getTierDetectionResult(){return this.tierDetectionResult}getDeviceDescription(){return this.tierDetectionResult?me.getDeviceDescription(this.tierDetectionResult.capabilities):"Unknown device"}getCurrentSettings(){return{...this.currentSettings}}hasEnergyBoost(){return this.energyBoostActive}getEffectiveSettings(){let e={...this.currentSettings};return this.energyBoostActive?{...e,animationDensity:Math.min(1,e.animationDensity*this.energyBoostSettings.animationBoost),particleMultiplier:e.particleMultiplier*this.energyBoostSettings.particleBoost,energyBoosted:!0}:{...e,energyBoosted:!1}}setTier(e){this.deviceTier=e,this.currentSettings=this.tierSettings[e],this._applyTierSettings(),u?.debug?.log("SimpleTierBasedPerformanceSystem",`Tier manually set to ${e}`)}_setupMusicAnalysisListener(){p.subscribe("colors:extracted",e=>{e.musicData&&this._handleMusicAnalysis({energy:e.musicData.energy||.5,valence:e.musicData.valence||.5,bpm:e.musicData.tempo||120,genre:e.musicData.genre||"unknown"})}),p.subscribe("music:track-changed",e=>{this._handleSongChange(e)})}_handleSongChange(e){e.analysis&&this._checkEnergyBoost(e.analysis)}_handleMusicAnalysis(e){this._checkEnergyBoost(e)}_checkEnergyBoost(e){let t=e.energy>.7&&e.bpm>130&&(e.danceability||0)>.6,i=t&&!this.energyBoostActive,a=!t&&this.energyBoostActive;i?this._activateEnergyBoost(e):a&&this._deactivateEnergyBoost()}_activateEnergyBoost(e){this.energyBoostActive=!0,this.energyBoostTimeout&&clearTimeout(this.energyBoostTimeout),this._applyTierSettings(),this.energyBoostTimeout=window.setTimeout(()=>{this._deactivateEnergyBoost()},this.energyBoostSettings.duration),p.emit("performance:tier-changed",{tier:this.deviceTier,previousTier:this.deviceTier,timestamp:Date.now()}),u?.debug?.log("SimpleTierBasedPerformanceSystem","Energy boost activated",{bpm:e.bpm,energy:e.energy,danceability:e.danceability})}_deactivateEnergyBoost(){this.energyBoostActive&&(this.energyBoostActive=!1,this.energyBoostTimeout&&(clearTimeout(this.energyBoostTimeout),this.energyBoostTimeout=null),this._applyTierSettings(),p.emit("performance:tier-changed",{tier:this.deviceTier,previousTier:this.deviceTier,timestamp:Date.now()}),u?.debug?.log("SimpleTierBasedPerformanceSystem","Energy boost deactivated"))}_applyTierSettings(){this._applyWebGLSettings(),this._applySystemSettings();let e=this.getEffectiveSettings();p.emit("performance:tier-changed",{tier:this.deviceTier,previousTier:this.deviceTier,timestamp:Date.now()})}_applyWebGLSettings(){if(!this.webglIntegration)return;let e=this.getEffectiveSettings();this.webglIntegration.setQuality(e.webglQuality),u?.debug?.log("SimpleTierBasedPerformanceSystem","WebGL settings applied",{tier:this.deviceTier,quality:e.webglQuality,energyBoosted:e.energyBoosted})}_applySystemSettings(){let e=this.getEffectiveSettings();p.emit("performance:frame",{deltaTime:16,fps:e.updateFrequency,memoryUsage:.5,timestamp:Date.now()})}}});var he,Ja=y(()=>{"use strict";Za();x();he=class{constructor(e,t){this.initialized=!1;this.enhancedDeviceTierDetector=e,this.webglIntegration=t,this.performanceSystem=new dt(e),u?.debug?.log("SimplePerformanceCoordinator","Created simple performance coordination")}async initialize(){if(this.initialized)return;await this.performanceSystem.initialize(),this.performanceSystem.registerWebGLIntegration(this.webglIntegration),this.initialized=!0;let e=this.performanceSystem.getTierDetectionResult();u?.debug?.log("SimplePerformanceCoordinator","Coordination established",{deviceTier:this.performanceSystem.getDeviceTier(),deviceDescription:this.performanceSystem.getDeviceDescription(),confidence:e?.confidence,webglState:this.webglIntegration?.getWebGLState()||"disabled"})}async healthCheck(){if(!this.initialized)return{healthy:!1,details:"Not initialized",system:"SimplePerformanceCoordinator"};let e=await this.performanceSystem.healthCheck(),t=this.webglIntegration?await this.webglIntegration.healthCheck():{healthy:!1,details:"WebGL integration not available"},i=[];return e.healthy||i.push(`Performance: ${e.details}`),t.healthy||i.push(`WebGL: ${t.details}`),{healthy:i.length===0,details:i.length>0?`Issues: ${i.join(", ")}`:`Coordinating ${this.performanceSystem.getDeviceTier()} tier performance with ${this.webglIntegration?.getWebGLState()||"disabled"} WebGL`,issues:i,system:"SimplePerformanceCoordinator"}}destroy(){this.performanceSystem.destroy(),this.initialized=!1,u?.debug?.log("SimplePerformanceCoordinator","Coordination destroyed")}updateAnimation(e){this.performanceSystem.updateAnimation(e)}getPerformanceSystem(){return this.performanceSystem}getDeviceTier(){return this.performanceSystem.getDeviceTier()}getDeviceDescription(){return this.performanceSystem.getDeviceDescription()}hasEnergyBoost(){return this.performanceSystem.hasEnergyBoost()}getCurrentSettings(){return this.performanceSystem.getEffectiveSettings()}getWebGLStatus(){return this.webglIntegration?{state:this.webglIntegration.getWebGLState(),quality:this.webglIntegration.getQuality(),enabled:this.webglIntegration.isWebGLActive()}:{state:"disabled",quality:"low",enabled:!1}}getPerformanceSummary(){let e=this.performanceSystem.getTierDetectionResult();return{deviceTier:this.getDeviceTier(),deviceDescription:this.getDeviceDescription(),confidence:e?.confidence||0,reasoning:e?.reasoning||[],webglStatus:this.getWebGLStatus(),energyBoost:this.hasEnergyBoost(),settings:this.getCurrentSettings()}}startMonitoring(){u?.debug?.log("SimplePerformanceCoordinator","Monitoring started (tier-based system)")}emitTrace(e,t){u?.debug?.log("SimplePerformanceCoordinator",`${e}`,t)}recordMetric(e,t){u?.debug?.log("SimplePerformanceCoordinator",`Metric ${e}: ${t}`)}getMedianFPS(){switch(this.getDeviceTier()){case"high":return 60;case"medium":return 50;case"low":return 30;default:return 30}}calculateHealthScore(){switch(this.getDeviceTier()){case"high":return .95;case"medium":return .75;case"low":return .5;default:return .5}}shouldReduceQuality(){return this.getDeviceTier()==="low"}timeOperation(e,t){let i=performance.now(),a=t(),r=performance.now()-i;return u?.debug?.log("SimplePerformanceCoordinator",`Operation ${e}: ${r.toFixed(2)}ms`),a}async timeOperationAsync(e,t){let i=performance.now(),a=await t(),r=performance.now()-i;return u?.debug?.log("SimplePerformanceCoordinator",`Async operation ${e}: ${r.toFixed(2)}ms`),a}getAverageTime(e){switch(this.getDeviceTier()){case"high":return 5;case"medium":return 15;case"low":return 30;default:return 15}}updateBudget(e,t){u?.debug?.log("SimplePerformanceCoordinator",`Budget update ignored: ${e}=${t} (tier-based system)`)}startTiming(e){let t=`${e}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return u?.debug?.log("SimplePerformanceCoordinator",`Timing started: ${e} (${t})`),t}endTiming(e,t){u?.debug?.log("SimplePerformanceCoordinator",`Timing ended: ${e}`,t)}}});var Mi,Xn=y(()=>{"use strict";x();L();Mi=class{constructor(e){this.initialized=!1;this.currentState="disabled";this.webglSystems=new Map;this.lastStateChange=0;this.stateChangeHistory=[];this.userExplicitlyDisabled=!1;this.userExplicitQuality=null;this.deviceCapabilities=e,this.config={enabled:!0,quality:"medium",forceEnabled:!1,allowPerformanceAdjustment:!0},u?.debug?.log("UnifiedWebGLController","Initialized with unified WebGL management")}async initialize(){this.initialized||(this.deviceCapabilities.isInitialized||await this.deviceCapabilities.initialize(),await this._loadSettings(),await this._determineInitialState(),this._setupEventListeners(),this._applyStateToAllSystems(),this.initialized=!0,u?.debug?.log("UnifiedWebGLController","Initialization complete",{state:this.currentState,quality:this.config.quality,systemCount:this.webglSystems.size}))}async healthCheck(){if(!this.initialized)return{healthy:!1,details:"Not initialized",system:"UnifiedWebGLController"};let e=[];for(let[i,a]of this.webglSystems)if(a.system.healthCheck)try{let r=await a.system.healthCheck();r.healthy||e.push(`${i}: ${r.details||"unhealthy"}`)}catch{e.push(`${i}: health check failed`)}let t=this.stateChangeHistory.filter(i=>Date.now()-i.timestamp<3e4).length;return e.length>0||t>3?{healthy:!0,details:`Issues detected: ${e.join(", ")}`,issues:e,system:"UnifiedWebGLController"}:{healthy:!0,details:"All WebGL systems operating normally",system:"UnifiedWebGLController"}}destroy(){this._setState("disabled"),this.webglSystems.clear(),p.unsubscribe("settings:changed"),p.unsubscribe("system:state-changed"),this.initialized=!1,u?.debug?.log("UnifiedWebGLController","Destroyed - all WebGL systems disabled")}updateAnimation(e){if(this.currentState==="webgl-active"){for(let[t,i]of this.webglSystems)if(i.system.updateAnimation)try{i.system.updateAnimation(e)}catch(a){u?.debug?.warn("UnifiedWebGLController",`Animation update failed for ${t}:`,a)}}}enable(){this.userExplicitlyDisabled=!1,this.config.enabled=!0,this._determineAndApplyState(),this._saveSettings(),u?.debug?.log("UnifiedWebGLController","WebGL enabled by user")}disable(){this.userExplicitlyDisabled=!0,this.config.enabled=!1,this._setState("css-fallback"),this._saveSettings(),u?.debug?.log("UnifiedWebGLController","WebGL disabled by user")}setQuality(e){this.userExplicitQuality=e,this.config.quality=e,this._applyQualityToAllSystems(),this._saveSettings(),u?.debug?.log("UnifiedWebGLController",`Quality set to ${e} by user`)}isEnabled(){return this.currentState==="webgl-active"}isAvailable(){return this.deviceCapabilities.getSpicetifyProfile()?.webglCapabilities?.available||!1}getState(){return this.currentState}getQuality(){return this.config.quality}forceEnable(e=!0){this.config.forceEnabled=e,this._determineAndApplyState(),this._saveSettings(),u?.debug?.log("UnifiedWebGLController",`Force enable set to ${e}`)}registerSystem(e,t,i=0){this.webglSystems.set(e,{system:t,name:e,priority:i}),this.initialized&&this._applyStateToSystem(e,t),u?.debug?.log("UnifiedWebGLController",`System registered: ${e} (priority: ${i})`)}unregisterSystem(e){let t=this.webglSystems.get(e);t&&(t.system.setEnabled&&t.system.setEnabled(!1),this.webglSystems.delete(e),u?.debug?.log("UnifiedWebGLController",`System unregistered: ${e}`))}suggestQualityAdjustment(e,t){if(!this.config.allowPerformanceAdjustment){u?.debug?.log("UnifiedWebGLController",`Performance adjustment ignored (not allowed): ${t}`);return}if(this.userExplicitQuality!==null){u?.debug?.log("UnifiedWebGLController",`Performance adjustment ignored (user set explicit quality): ${t}`);return}if(this.config.quality!==e){let i=this.config.quality;this.config.quality=e,this._applyQualityToAllSystems(),u?.debug?.log("UnifiedWebGLController",`Quality adjusted by performance system: ${i} \u2192 ${e} (${t})`)}}performanceDisable(e){!this.config.allowPerformanceAdjustment||this.userExplicitlyDisabled===!1||this.currentState==="webgl-active"&&(this._setState("css-fallback"),u?.debug?.log("UnifiedWebGLController",`WebGL disabled by performance system: ${e}`))}performanceEnable(e){!this.config.allowPerformanceAdjustment||this.userExplicitlyDisabled||this.currentState==="css-fallback"&&this.config.enabled&&(this._determineAndApplyState(),u?.debug?.log("UnifiedWebGLController",`WebGL re-enabled by performance system: ${e}`))}async _loadSettings(){try{let e=localStorage.getItem("sn-webgl-enabled"),t=localStorage.getItem("sn-webgl-quality"),i=localStorage.getItem("sn-webgl-force-enabled");e!==null&&(this.config.enabled=e==="true",e==="false"&&(this.userExplicitlyDisabled=!0)),t&&["low","medium","high"].includes(t)&&(this.config.quality=t,this.userExplicitQuality=t),i!==null&&(this.config.forceEnabled=i==="true"),u?.debug?.log("UnifiedWebGLController","Settings loaded",this.config)}catch(e){u?.debug?.warn("UnifiedWebGLController","Failed to load settings:",e)}}_saveSettings(){try{localStorage.setItem("sn-webgl-enabled",this.config.enabled.toString()),localStorage.setItem("sn-webgl-quality",this.config.quality),localStorage.setItem("sn-webgl-force-enabled",this.config.forceEnabled.toString())}catch(e){u?.debug?.warn("UnifiedWebGLController","Failed to save settings:",e)}}async _determineInitialState(){if(!this.config.enabled||this.userExplicitlyDisabled){this._setState("css-fallback");return}this.config.forceEnabled||this.isAvailable()?this._setState("webgl-active"):this._setState("css-fallback")}_determineAndApplyState(){!this.config.enabled||this.userExplicitlyDisabled?this._setState("css-fallback"):this.config.forceEnabled||this.isAvailable()?this._setState("webgl-active"):this._setState("css-fallback")}_setState(e){if(this.currentState===e)return;let t=this.currentState;this.currentState=e,this.lastStateChange=Date.now(),this.stateChangeHistory.push({state:e,quality:this.config.quality,timestamp:this.lastStateChange}),this.stateChangeHistory.length>20&&(this.stateChangeHistory=this.stateChangeHistory.slice(-20)),this._applyStateToAllSystems(),p.emit("performance:tier-changed",{tier:e,previousTier:t,timestamp:this.lastStateChange}),u?.debug?.log("UnifiedWebGLController",`State changed: ${t} \u2192 ${e}`)}_applyStateToAllSystems(){let e=Array.from(this.webglSystems.entries()).sort(([,t],[,i])=>i.priority-t.priority);for(let[t,i]of e)this._applyStateToSystem(t,i.system)}_applyStateToSystem(e,t){try{let i=this.currentState==="webgl-active";if(t.setEnabled&&t.setEnabled(i),i&&t.setQuality&&t.setQuality(this.config.quality),e==="corridor-effects"&&t.setEnabled){let a=i&&(this.config.quality==="medium"||this.config.quality==="high");t.setEnabled(a)}}catch(i){u?.debug?.warn("UnifiedWebGLController",`Failed to apply state to ${e}:`,i)}}_applyQualityToAllSystems(){if(this.currentState==="webgl-active"){for(let[e,t]of this.webglSystems)try{if(t.system.setQuality&&t.system.setQuality(this.config.quality),e==="corridor-effects"){let i=this.config.quality==="medium"||this.config.quality==="high";t.system.setEnabled&&t.system.setEnabled(i)}}catch(i){u?.debug?.warn("UnifiedWebGLController",`Failed to apply quality to ${e}:`,i)}p.emit("performance:tier-changed",{tier:this.config.quality,previousTier:this.config.quality,timestamp:Date.now()})}}_setupEventListeners(){p.subscribe("settings:changed",e=>{e.settingKey==="sn-webgl-enabled"?(this.config.enabled=e.newValue==="true",this.userExplicitlyDisabled=e.newValue==="false",this._determineAndApplyState()):e.settingKey==="sn-webgl-quality"?this.setQuality(e.newValue):e.settingKey==="sn-webgl-force-enabled"&&(this.config.forceEnabled=e.newValue==="true",this._determineAndApplyState())}),p.subscribe("performance:tier-changed",e=>{let t=e.tier==="excellent"?"high":e.tier==="good"?"medium":"low";t!==this.config.quality&&this.setQuality(t)})}}});var Ei,Zn=y(()=>{"use strict";Ei=class{static getAnimationDensity(e){switch(e){case"low":return .3;case"medium":return .7;case"high":return 1}}static getUpdateFrequency(e){switch(e){case"low":return 30;case"medium":return 45;case"high":return 60}}static getShaderComplexity(e){switch(e){case"low":return .4;case"medium":return .7;case"high":return 1}}static getParticleMultiplier(e){switch(e){case"low":return .3;case"medium":return .6;case"high":return 1}}static shouldEnableCorridorEffects(e){return e==="medium"||e==="high"}static shouldEnableAdvancedFeatures(e){return e==="high"}static getBlendMode(e){switch(e){case"low":return"normal";case"medium":return"screen";case"high":return"screen"}}static getFrameThrottling(e){switch(e){case"low":return 33;case"medium":return 22;case"high":return 16}}}});var wi,Jn=y(()=>{"use strict";Zn();x();wi=class{constructor(e){this.enabled=!1;this.quality="medium";this.system=e,u?.debug?.log("WebGLGradientAdapter","Created adapter for WebGL gradient system")}setEnabled(e){this.enabled!==e&&(this.enabled=e,e?this._enableSystem():this._disableSystem(),u?.debug?.log("WebGLGradientAdapter",`WebGL gradient ${e?"enabled":"disabled"}`))}setQuality(e){this.quality!==e&&(this.quality=e,this.enabled&&this._applyQualitySettings(),u?.debug?.log("WebGLGradientAdapter",`Quality set to ${e}`))}isEnabled(){return this.enabled}isCapable(){return this._checkWebGLCapability()}getQuality(){return this.quality}getSystemName(){return"WebGL Gradient Background"}_enableSystem(){try{let e=this._mapQualityToIntensity(this.quality);this.system.settingsManager&&(this.system.settingsManager.set("sn-gradient-intensity",e),this.system.settingsManager.set("sn-webgl-enabled","true")),this.system.initialized||this.system.initialize(),this._applyQualitySettings()}catch(e){u?.debug?.warn("WebGLGradientAdapter","Failed to enable system:",e)}}_disableSystem(){try{this.system.settingsManager&&this.system.settingsManager.set("sn-gradient-intensity","disabled"),typeof this.system.disable=="function"?this.system.disable():typeof this.system.destroy=="function"&&this.system.destroy()}catch(e){u?.debug?.warn("WebGLGradientAdapter","Failed to disable system:",e)}}_applyQualitySettings(){try{let e=this.system.settings;if(!e)return;e.flowStrength=this._getFlowStrength(this.quality),e.noiseScale=this._getNoiseScale(this.quality),e.corridorIntensity=this._getColorIntensity(this.quality);let t=Ei.getUpdateFrequency(this.quality);this.system.updateFrequency!==void 0&&(this.system.updateFrequency=t),typeof this.system.forceRepaint=="function"&&this.system.forceRepaint(`quality-change-${this.quality}`)}catch(e){u?.debug?.warn("WebGLGradientAdapter","Failed to apply quality settings:",e)}}_mapQualityToIntensity(e){switch(e){case"low":return"minimal";case"medium":return"balanced";case"high":return"intense";default:return"balanced"}}_getFlowStrength(e){switch(e){case"low":return .3;case"medium":return .7;case"high":return 1;default:return .7}}_getAnimationSpeed(e){switch(e){case"low":return .5;case"medium":return .8;case"high":return 1.2;default:return .8}}_getNoiseScale(e){switch(e){case"low":return 1.5;case"medium":return 2;case"high":return 2.8;default:return 2}}_getColorIntensity(e){switch(e){case"low":return .6;case"medium":return .8;case"high":return 1;default:return .8}}_checkWebGLCapability(){try{let e=document.createElement("canvas"),t=e.getContext("webgl2")||e.getContext("webgl");return e.remove(),t!==null}catch{return!1}}}});var et,er=y(()=>{"use strict";Xn();Jn();x();et=class{constructor(e){this.initialized=!1;this.webglGradientSystem=null;this.webglGradientAdapter=null;this.controller=new Mi(e),u?.debug?.log("WebGLSystemsIntegration","Created WebGL systems integration")}async initialize(){this.initialized||(await this.controller.initialize(),await this._registerWebGLSystems(),this.initialized=!0,u?.debug?.log("WebGLSystemsIntegration","Integration initialized",{controllerState:this.controller.getState(),quality:this.controller.getQuality(),registeredSystems:this._getRegisteredSystemNames()}))}async healthCheck(){if(!this.initialized)return{healthy:!1,details:"Not initialized",system:"WebGLSystemsIntegration"};let e=await this.controller.healthCheck();if(!e.healthy)return{healthy:!1,details:`Controller unhealthy: ${e.details}`,system:"WebGLSystemsIntegration"};let t=[];if(this.webglGradientSystem)try{let i=await this.webglGradientSystem.healthCheck();i.ok||t.push(`WebGL Gradient: ${i.details}`)}catch{t.push("WebGL Gradient: health check failed")}return{healthy:!0,details:t.length>0?`Some system issues: ${t.join(", ")}`:"All WebGL systems healthy",issues:t,system:"WebGLSystemsIntegration"}}destroy(){this.webglGradientSystem&&this.webglGradientSystem.destroy(),this.controller.destroy(),this.initialized=!1,u?.debug?.log("WebGLSystemsIntegration","Integration destroyed")}updateAnimation(e){this.initialized&&this.controller.updateAnimation(e)}getController(){return this.controller}enableWebGL(){this.controller.enable()}disableWebGL(){this.controller.disable()}setQuality(e){this.controller.setQuality(e)}isWebGLActive(){return this.controller.isEnabled()}getWebGLState(){return this.controller.getState()}getQuality(){return this.controller.getQuality()}handlePerformanceQualityAdjustment(e,t){this.controller.suggestQualityAdjustment(e,t)}handlePerformanceDisable(e){this.controller.performanceDisable(e)}handlePerformanceEnable(e){this.controller.performanceEnable(e)}setQualityFromTier(e){this.controller.setQuality(e),u?.debug?.log("WebGLSystemsIntegration",`Quality set from device tier: ${e}`)}async _registerWebGLSystems(){try{await this._registerWebGLGradientSystem(),u?.debug?.log("WebGLSystemsIntegration","All WebGL systems registered successfully")}catch(e){u?.debug?.warn("WebGLSystemsIntegration","Failed to register some WebGL systems:",e)}}async _registerWebGLGradientSystem(){try{let e=globalThis.year3000System;if(!e){u?.debug?.warn("WebGLSystemsIntegration","Year3000System not available");return}let t=["webglGradientBackgroundSystem","flowingLiquidConsciousnessSystem","webglBackgroundSystem"],i=null;for(let a of t)if(e[a]){i=e[a];break}if(!i){u?.debug?.warn("WebGLSystemsIntegration","WebGL gradient system not found in Year3000System");return}this.webglGradientSystem=i,this.webglGradientAdapter=new wi(this.webglGradientSystem),this.controller.registerSystem("webgl-gradient-background",this.webglGradientAdapter,100),u?.debug?.log("WebGLSystemsIntegration","WebGL gradient system registered")}catch(e){u?.debug?.warn("WebGLSystemsIntegration","Failed to register WebGL gradient system:",e)}}_getRegisteredSystemNames(){let e=[];return this.webglGradientAdapter&&e.push("WebGL Gradient Background"),e}}});var Pe,tt,tr=y(()=>{"use strict";L();Pe=class Pe{constructor(e,t){this.subsystemMetrics=new Map;this.optimizationStrategies=new Map;this.adaptiveOptimizationEnabled=!1;this.optimizationInterval=null;this.activeIssues=new Map;this.issueHistory=[];this.lastHealthCheck=0;this.healthCheckInterval=null;this.HEALTH_CHECK_INTERVAL=5e3;this.batteryState=null;this.frameTimeHistory=[];this.memoryUsageHistory=[];this.lastOptimizationTime=0;this.optimizationCooldown=5e3;this.PERFORMANCE_THRESHOLDS={frameTime:{warning:16.67,critical:33.33},memoryUsage:{warning:50*1024*1024,critical:100*1024*1024},cpuUsage:{warning:15,critical:30},fps:{warning:50,critical:30}};this.PERFORMANCE_MODES={battery:{name:"battery",qualityLevel:.4,animationQuality:.3,effectQuality:.2,blurQuality:.3,shadowQuality:.2,frameRate:30,optimizationLevel:3},balanced:{name:"balanced",qualityLevel:.8,animationQuality:.8,effectQuality:.7,blurQuality:.8,shadowQuality:.7,frameRate:60,optimizationLevel:1},performance:{name:"performance",qualityLevel:1,animationQuality:1,effectQuality:1,blurQuality:1,shadowQuality:1,frameRate:60,optimizationLevel:0},auto:{name:"auto",qualityLevel:.8,animationQuality:.8,effectQuality:.8,blurQuality:.8,shadowQuality:.8,frameRate:60,optimizationLevel:1}};this.config=e,this.performanceAnalyzer=t,this.eventBus=p,this.initializeDeviceCapabilities(),this.initializeThermalMonitoring(),this.initializeBatteryMonitoring(),this.currentPerformanceMode=this.PERFORMANCE_MODES.auto,this.initializeDefaultStrategies(),this.startHealthMonitoring(),this.subscribeToEvents(),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Initialized with enhanced device capabilities, thermal monitoring, and battery optimization")}static getInstance(e,t){if(!Pe.instance){if(!e||!t)throw new Error("UnifiedPerformanceCoordinator requires config and performanceAnalyzer for first initialization");Pe.instance=new Pe(e,t)}return Pe.instance}trackSubsystem(e,t){let i=performance.now(),r={...this.subsystemMetrics.get(e)||{name:e,frameTime:0,memoryUsage:0,cpuUsage:0,fps:60,lastUpdate:i,status:"healthy",issues:[]},...t,lastUpdate:i};r.status=this.calculateHealthStatus(r),this.updateSubsystemIssues(r),this.subsystemMetrics.set(e,r),this.performanceAnalyzer&&(this.performanceAnalyzer.recordMetric(`subsystem_${e}_frame_time`,r.frameTime),this.performanceAnalyzer.recordMetric(`subsystem_${e}_memory`,r.memoryUsage),this.performanceAnalyzer.recordMetric(`subsystem_${e}_fps`,r.fps)),this.adaptiveOptimizationEnabled&&r.status!=="healthy"&&this.checkAndTriggerOptimization(r),this.config.enableDebug&&r.status!=="healthy"&&console.warn(`[UnifiedPerformanceCoordinator] Subsystem ${e} status: ${r.status}`,r)}getSystemHealth(){let e=performance.now(),t=new Map(this.subsystemMetrics),i=0,a=0,r=0;for(let d of t.values())switch(d.status){case"healthy":i++;break;case"warning":a++;break;case"critical":r++;break}let n=t.size,s="healthy";r>0?s="critical":a>0&&(s="warning");let o=this.calculatePerformanceScore(t),l=this.generateRecommendations(t),m={overall:s,totalSubsystems:n,healthySubsystems:i,warningSubsystems:a,criticalSubsystems:r,subsystems:t,recommendations:l,performanceScore:o,lastUpdate:e};return this.lastHealthCheck=e,m}startMonitoring(){this.enableAdaptiveOptimization(),this.healthCheckInterval||this.startHealthMonitoring(),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Monitoring started")}enableAdaptiveOptimization(){this.adaptiveOptimizationEnabled||(this.adaptiveOptimizationEnabled=!0,this.optimizationInterval=setInterval(()=>{this.performOptimizationCheck()},2e3),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Adaptive optimization enabled"))}disableAdaptiveOptimization(){this.adaptiveOptimizationEnabled&&(this.adaptiveOptimizationEnabled=!1,this.optimizationInterval&&(clearInterval(this.optimizationInterval),this.optimizationInterval=null),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Adaptive optimization disabled"))}registerOptimizationStrategy(e){this.optimizationStrategies.set(e.name,e),this.config.enableDebug&&console.log(`[UnifiedPerformanceCoordinator] Registered optimization strategy: ${e.name}`)}triggerOptimization(e){this.activeIssues.set(`${e.subsystem}:${e.type}`,e),this.issueHistory.push(e),this.issueHistory.length>100&&this.issueHistory.shift();let t=Array.from(this.optimizationStrategies.values()).filter(i=>i.subsystem===e.subsystem||i.subsystem==="*").sort((i,a)=>a.priority-i.priority);for(let i of t){let a=this.subsystemMetrics.get(e.subsystem);if(a&&i.condition(a))try{i.action(a),this.config.enableDebug&&console.log(`[UnifiedPerformanceCoordinator] Applied optimization strategy: ${i.name} for ${e.subsystem}`);break}catch(r){console.error(`[UnifiedPerformanceCoordinator] Error applying optimization strategy ${i.name}:`,r)}}}getMetrics(){return{subsystems:new Map(this.subsystemMetrics),issues:new Map(this.activeIssues),strategies:new Map(this.optimizationStrategies),adaptiveOptimizationEnabled:this.adaptiveOptimizationEnabled}}destroy(){this.disableAdaptiveOptimization(),this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.subsystemMetrics.clear(),this.optimizationStrategies.clear(),this.activeIssues.clear(),this.issueHistory=[],Pe.instance===this&&(Pe.instance=null),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Destroyed")}initializeDefaultStrategies(){this.registerOptimizationStrategy({name:"memory-cleanup",type:"memory_cleanup",priority:100,subsystem:"*",description:"Trigger garbage collection and memory cleanup",condition:e=>e.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.warning,action:e=>{}}),this.registerOptimizationStrategy({name:"fps-optimization",type:"reduce_quality",priority:80,subsystem:"*",description:"Reduce quality settings to improve FPS",condition:e=>e.fps<this.PERFORMANCE_THRESHOLDS.fps.warning,action:e=>{}}),this.registerOptimizationStrategy({name:"cpu-throttling",type:"throttle_updates",priority:70,subsystem:"*",description:"Throttle update frequency to reduce CPU usage",condition:e=>e.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.warning,action:e=>{}})}calculateHealthStatus(e){let t=[];return e.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.critical?t.push("critical-frame-time"):e.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.warning&&t.push("warning-frame-time"),e.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.critical?t.push("critical-memory"):e.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.warning&&t.push("warning-memory"),e.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.critical?t.push("critical-cpu"):e.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.warning&&t.push("warning-cpu"),e.fps<this.PERFORMANCE_THRESHOLDS.fps.critical?t.push("critical-fps"):e.fps<this.PERFORMANCE_THRESHOLDS.fps.warning&&t.push("warning-fps"),e.issues=t,t.some(i=>i.startsWith("critical"))?"critical":t.some(i=>i.startsWith("warning"))?"warning":"healthy"}updateSubsystemIssues(e){let t=`${e.name}:performance`;if(e.status==="healthy"){if(this.activeIssues.has(t)){let i=this.activeIssues.get(t);i.resolved=!0,this.activeIssues.delete(t)}}else{let i={type:"render",severity:e.status==="critical"?"critical":"medium",subsystem:e.name,message:`Performance degradation detected: ${e.issues.join(", ")}`,timestamp:Date.now(),resolved:!1};this.activeIssues.set(t,i)}}checkAndTriggerOptimization(e){let t=`${e.name}:performance`,i=this.activeIssues.get(t);i&&!i.resolved&&this.triggerOptimization(i)}performOptimizationCheck(){let e=performance.now();for(let[t,i]of this.subsystemMetrics)e-i.lastUpdate>1e4||i.status!=="healthy"&&this.checkAndTriggerOptimization(i)}calculatePerformanceScore(e){if(e.size===0)return 100;let t=0;for(let i of e.values()){let a=100;i.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.warning&&(a-=20),i.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.critical&&(a-=30),i.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.warning&&(a-=15),i.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.critical&&(a-=25),i.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.warning&&(a-=10),i.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.critical&&(a-=20),i.fps<this.PERFORMANCE_THRESHOLDS.fps.warning&&(a-=15),i.fps<this.PERFORMANCE_THRESHOLDS.fps.critical&&(a-=25),t+=Math.max(0,a)}return Math.round(t/e.size)}generateRecommendations(e){let t=[],i=Array.from(e.values()).flatMap(r=>r.issues),a=new Map;for(let r of i)a.set(r,(a.get(r)||0)+1);for(let[r,n]of a)if(n>=2)switch(r){case"critical-frame-time":case"warning-frame-time":t.push("Consider reducing animation quality or frequency");break;case"critical-memory":case"warning-memory":t.push("Memory cleanup needed - consider reducing cache sizes");break;case"critical-cpu":case"warning-cpu":t.push("High CPU usage detected - consider throttling updates");break;case"critical-fps":case"warning-fps":t.push("Low FPS detected - consider disabling non-essential effects");break}return t.length===0&&t.push("System performance is optimal"),t}startHealthMonitoring(){this.healthCheckInterval=setInterval(()=>{this.getSystemHealth()},this.HEALTH_CHECK_INTERVAL)}subscribeToEvents(){}initializeDeviceCapabilities(){let e=navigator,t=performance.memory,i=document.createElement("canvas"),a=i.getContext("webgl2")||i.getContext("webgl"),r=2048;a&&(r=a.getParameter(a.MAX_TEXTURE_SIZE)||2048);let n=t?Math.round(t.jsHeapSizeLimit/(1024*1024*1024)):4,s="medium";n>=8&&e.hardwareConcurrency>=8&&r>=4096?s="premium":n>=4&&e.hardwareConcurrency>=4?s="high":n>=2&&e.hardwareConcurrency>=2?s="medium":s="low",this.deviceCapabilities={performanceTier:s,memoryGB:n,cpuCores:e.hardwareConcurrency||4,gpuAcceleration:!!a,isMobile:/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e.userAgent),supportsWebGL:!!a,supportsBackdropFilter:CSS.supports("backdrop-filter","blur(10px)"),maxTextureSize:r,devicePixelRatio:window.devicePixelRatio||1},this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Device capabilities detected:",this.deviceCapabilities)}initializeThermalMonitoring(){this.thermalState={temperature:"normal",throttleLevel:0,cpuUsage:0,gpuUsage:0,memoryUsage:0},setInterval(()=>{this.updateThermalState()},1e4)}async initializeBatteryMonitoring(){try{let e=navigator;if("getBattery"in e){let t=await e.getBattery();this.batteryState={level:t.level,charging:t.charging,chargingTime:t.chargingTime,dischargingTime:t.dischargingTime},t.addEventListener("levelchange",()=>{this.batteryState&&(this.batteryState.level=t.level,this.adjustPerformanceModeForBattery())}),t.addEventListener("chargingchange",()=>{this.batteryState&&(this.batteryState.charging=t.charging,this.adjustPerformanceModeForBattery())}),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Battery monitoring initialized")}}catch{this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Battery API not available")}}updateThermalState(){let e=this.performanceAnalyzer.getMedianFPS()||60,t=performance.memory,i=t?t.usedJSHeapSize/t.jsHeapSizeLimit:0,a="normal",r=0;e<30||i>.9?(a="critical",r=.8):e<45||i>.7?(a="hot",r=.4):(e<55||i>.5)&&(a="warm",r=.2),this.thermalState={temperature:a,throttleLevel:r,cpuUsage:Math.min(1-e/60,1),gpuUsage:0,memoryUsage:i},a==="critical"&&this.currentPerformanceMode.name!=="battery"?this.setPerformanceMode("battery"):a==="normal"&&this.currentPerformanceMode.name==="battery"&&this.setPerformanceMode("auto")}adjustPerformanceModeForBattery(){this.batteryState&&(!this.batteryState.charging&&this.batteryState.level<.2?this.setPerformanceMode("battery"):this.batteryState.charging&&this.currentPerformanceMode.name==="battery"&&this.setPerformanceMode("auto"))}setPerformanceMode(e){let t=this.PERFORMANCE_MODES[e];t&&(this.currentPerformanceMode=t,this.config.enableDebug&&console.log(`[UnifiedPerformanceCoordinator] Performance mode changed to: ${e}`))}getDeviceCapabilities(){return{...this.deviceCapabilities}}getThermalState(){return{...this.thermalState}}getBatteryState(){return this.batteryState?{...this.batteryState}:null}getCurrentPerformanceMode(){return{...this.currentPerformanceMode}}};Pe.instance=null;tt=Pe});var ze,Ae,Ti=y(()=>{"use strict";ze=class ze{constructor(e={},t){this.cssVariableManager=null;this.optimizationLevel="none";this.disabledFeatures=new Set;this.config={budgets:{animationFrame:16.67,cssVariableUpdate:2,domObservation:5,audioAnalysis:10,visualEffects:8,userInteraction:100},autoOptimize:{enabled:!0,violationThreshold:5,recoveryThreshold:80},enableDebug:!1,...e},this.performanceAnalyzer=t,this.setupBudgetMonitoring()}static getInstance(e,t){return!ze.instance&&t&&(ze.instance=new ze(e,t)),ze.instance}registerUnifiedCSSVariableManager(e){this.cssVariableManager=e}setupBudgetMonitoring(){this.config.autoOptimize.enabled&&setInterval(()=>{this.checkBudgets()},5e3)}checkBudgets(){this.performanceAnalyzer.calculateHealthScore()>=this.config.autoOptimize.recoveryThreshold&&this.recoverOptimizations()}optimizeOperation(e){if(!this.disabledFeatures.has(e)){switch(e){case"cssVariableUpdate":this.optimizeCSSVariableUpdates();break;case"domObservation":this.optimizeDOMObservation();break;case"visualEffects":this.optimizeVisualEffects();break;case"audioAnalysis":this.optimizeAudioAnalysis();break}this.disabledFeatures.add(e),this.config.enableDebug&&console.log(`\u{1F3AF} [PerformanceBudgetManager] Optimized ${e} due to budget violations`)}}optimizeCSSVariableUpdates(){this.cssVariableManager&&this.cssVariableManager.updateConfig({batchIntervalMs:32,maxBatchSize:25})}optimizeDOMObservation(){document.dispatchEvent(new CustomEvent("year3000:optimize-dom-observation",{detail:{level:this.optimizationLevel}}))}optimizeVisualEffects(){document.dispatchEvent(new CustomEvent("year3000:optimize-visual-effects",{detail:{level:this.optimizationLevel}}))}optimizeAudioAnalysis(){document.dispatchEvent(new CustomEvent("year3000:optimize-audio-analysis",{detail:{level:this.optimizationLevel}}))}escalateOptimization(){this.optimizationLevel==="none"?this.optimizationLevel="conservative":this.optimizationLevel==="conservative"&&(this.optimizationLevel="aggressive"),this.config.enableDebug&&console.log(`\u{1F3AF} [PerformanceBudgetManager] Escalated to ${this.optimizationLevel} optimization`)}recoverOptimizations(){this.optimizationLevel!=="none"&&(this.disabledFeatures.clear(),this.cssVariableManager&&this.cssVariableManager.updateConfig({batchIntervalMs:16,maxBatchSize:50}),document.dispatchEvent(new CustomEvent("year3000:recover-optimizations",{detail:{previousLevel:this.optimizationLevel}})),this.optimizationLevel="none",this.config.enableDebug&&console.log("\u{1F3AF} [PerformanceBudgetManager] Recovered from optimizations"))}getOptimizationStatus(){return{level:this.optimizationLevel,disabledFeatures:Array.from(this.disabledFeatures),budgetViolations:[],healthScore:this.performanceAnalyzer.calculateHealthScore()}}manualOptimize(e){this.optimizeOperation(e)}manualRecover(){this.recoverOptimizations()}updateBudgets(e){this.config.budgets={...this.config.budgets,...e};for(let[t,i]of Object.entries(e))this.performanceAnalyzer.updateBudget(t,i)}destroy(){this.disabledFeatures.clear(),this.cssVariableManager=null,ze.instance=null}};ze.instance=null;Ae=ze});var Pi,es=y(()=>{"use strict";$();x();Me();Pi=class{constructor(e,t=null,i=null){this.musicSyncService=null;this.settingsManager=null;this.currentEmotionalProfile=null;this.emotionalHistory=[];this.maxHistorySize=50;this.isActive=!1;this.boundSpectralHandler=null;this.boundSettingsHandler=null;this.currentEmotionalTemperature=null;this.moodProfiles={euphoric:{hueShift:15,saturationMultiplier:1.4,brightnessMultiplier:1.3,contrastMultiplier:1.2,animationSpeed:1.5,pulseIntensity:.8,layerHarmony:.9,discordLevel:.1,transitionSpeed:.8},content:{hueShift:5,saturationMultiplier:1.1,brightnessMultiplier:1.1,contrastMultiplier:1,animationSpeed:.8,pulseIntensity:.4,layerHarmony:.95,discordLevel:.05,transitionSpeed:1.5},melancholic:{hueShift:-30,saturationMultiplier:.7,brightnessMultiplier:.8,contrastMultiplier:.9,animationSpeed:.6,pulseIntensity:.3,layerHarmony:.8,discordLevel:.2,transitionSpeed:2},aggressive:{hueShift:-15,saturationMultiplier:1.6,brightnessMultiplier:1.2,contrastMultiplier:1.5,animationSpeed:2,pulseIntensity:1,layerHarmony:.6,discordLevel:.4,transitionSpeed:.5},mysterious:{hueShift:-45,saturationMultiplier:.9,brightnessMultiplier:.7,contrastMultiplier:1.3,animationSpeed:.7,pulseIntensity:.6,layerHarmony:.7,discordLevel:.3,transitionSpeed:1.8},peaceful:{hueShift:25,saturationMultiplier:.8,brightnessMultiplier:1,contrastMultiplier:.9,animationSpeed:.5,pulseIntensity:.2,layerHarmony:1,discordLevel:0,transitionSpeed:3},dramatic:{hueShift:0,saturationMultiplier:1.3,brightnessMultiplier:1.1,contrastMultiplier:1.4,animationSpeed:1.2,pulseIntensity:.9,layerHarmony:.6,discordLevel:.4,transitionSpeed:.7},ambient:{hueShift:10,saturationMultiplier:.6,brightnessMultiplier:.9,contrastMultiplier:.8,animationSpeed:.3,pulseIntensity:.1,layerHarmony:.9,discordLevel:.1,transitionSpeed:4},chaotic:{hueShift:0,saturationMultiplier:1.5,brightnessMultiplier:1.2,contrastMultiplier:1.6,animationSpeed:2.5,pulseIntensity:.9,layerHarmony:.3,discordLevel:.7,transitionSpeed:.3},nostalgic:{hueShift:-10,saturationMultiplier:.8,brightnessMultiplier:.95,contrastMultiplier:.9,animationSpeed:.7,pulseIntensity:.4,layerHarmony:.85,discordLevel:.15,transitionSpeed:2.2},heroic:{hueShift:20,saturationMultiplier:1.2,brightnessMultiplier:1.25,contrastMultiplier:1.3,animationSpeed:1.3,pulseIntensity:.7,layerHarmony:.8,discordLevel:.2,transitionSpeed:1},contemplative:{hueShift:-5,saturationMultiplier:.9,brightnessMultiplier:1,contrastMultiplier:1.1,animationSpeed:.6,pulseIntensity:.3,layerHarmony:.8,discordLevel:.2,transitionSpeed:2.5},neutral:{hueShift:0,saturationMultiplier:1,brightnessMultiplier:1,contrastMultiplier:1,animationSpeed:1,pulseIntensity:.5,layerHarmony:.75,discordLevel:.25,transitionSpeed:1.5}};this.cssController=e||P(),this.musicSyncService=t,this.settingsManager=i,this.currentGradientState=this.createNeutralGradientState(),this.emotionalTemperatureMapper=new Z(!0),this.moodToEmotionMap={euphoric:"energetic",content:"happy",melancholic:"melancholy",aggressive:"aggressive",mysterious:"mysterious",peaceful:"calm",dramatic:"epic",ambient:"ambient",chaotic:"aggressive",nostalgic:"melancholy",heroic:"epic",contemplative:"calm",neutral:"ambient"},this.boundSpectralHandler=this.handleSpectralData.bind(this),this.boundSettingsHandler=this.handleSettingsChange.bind(this)}async initialize(){this.boundSpectralHandler&&document.addEventListener("music-sync:data-updated",this.boundSpectralHandler),this.boundSettingsHandler&&document.addEventListener("year3000SystemSettingsChanged",this.boundSettingsHandler),this.isActive=!0,u?.debug?.log("EmotionalGradientMapper","Emotional mapping system initialized")}createNeutralGradientState(){return{hueShift:0,saturationMultiplier:1,brightnessMultiplier:1,contrastMultiplier:1,animationSpeed:1,pulseIntensity:.5,flowDirection:0,layerHarmony:.75,discordLevel:.25,depthPerception:.5,transitionSpeed:1.5,smoothing:.7,responsiveness:.8}}handleSpectralData(e){if(!this.isActive)return;let i=e.detail;if(!i)return;let a=this.analyzeEmotionalContent(i);try{let n={energy:a.energy,valence:a.valence,danceability:a.arousal,tempo:120,loudness:a.dynamics,acousticness:1-a.complexity,instrumentalness:.5,speechiness:.1,mode:a.mode==="major"?1:0,key:0,genre:this.inferGenreFromProfile(a)};this.currentEmotionalTemperature=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(n),this.applyEmotionalTemperatureToDocument(this.currentEmotionalTemperature),u?.debug?.log("EmotionalGradientMapper","\u{1F321}\uFE0F Applied emotional temperature:",{mood:a.mood,emotionalState:this.currentEmotionalTemperature.primaryEmotion,temperature:this.currentEmotionalTemperature.temperature,intensity:this.currentEmotionalTemperature.intensity})}catch(n){u?.debug?.warn("EmotionalGradientMapper","\u{1F321}\uFE0F Failed to apply emotional temperature:",n)}this.storeEmotionalHistory(a);let r=this.mapEmotionToGradient(a);this.currentGradientState=this.smoothGradientTransition(this.currentGradientState,r,a.stability),this.updateGradientVariables(),this.currentEmotionalProfile=a}analyzeEmotionalContent(e){let t=e.valence||.5,i=e.energy||.5,a=e.danceability||.5,r=this.calculateTension(e),n=this.detectMode(e),s=this.calculateDynamics(e),o=this.calculateComplexity(e),l=this.calculateStability(),m=this.calculatePredictability(),d=this.classifyMood(t,i,a,r,n),h=this.calculateMoodConfidence(t,i,a,r);return{valence:t,energy:i,arousal:a,tension:r,mode:n,dynamics:s,complexity:o,stability:l,predictability:m,mood:d,confidence:h}}calculateTension(e){let t=Math.abs((e.loudness||0)/-60),i=e.tempo?Math.min(1,(e.tempo-60)/140):.5,a=1-(e.acousticness||.5),r=e.speechiness||0;return Math.max(0,Math.min(1,t*.4+i*.3+a*.2+r*.1))}calculateDynamics(e){let t=Math.abs((e.loudness||0)/-60),i=e.energy||.5;return Math.max(0,Math.min(1,(t+i)/2))}calculateComplexity(e){let t=e.instrumentalness||.5,i=e.speechiness||0,a=1-(e.acousticness||.5);return Math.max(0,Math.min(1,(t+i+a)/3))}detectMode(e){if(typeof e.mode=="number")return e.mode===1?"major":"minor";let t=e.valence||.5,i=e.acousticness||.5;return t>.6&&i>.5?"major":t<.4||i<.3?"minor":"neutral"}calculateStability(){if(this.emotionalHistory.length<2)return .5;let e=Math.min(10,this.emotionalHistory.length),t=0;for(let i=1;i<e;i++){let a=this.emotionalHistory[this.emotionalHistory.length-i],r=this.emotionalHistory[this.emotionalHistory.length-i-1];a&&r&&(t+=Math.abs(a.valence-r.valence),t+=Math.abs(a.energy-r.energy),t+=Math.abs(a.arousal-r.arousal))}return Math.max(0,Math.min(1,1-t/(e*3)))}calculatePredictability(){if(this.emotionalHistory.length<5)return .5;let e=this.emotionalHistory.slice(-5),t=0;for(let i=1;i<e.length;i++){let a=e[i],r=e[i-1];if(a&&r){let n=a.valence-r.valence,s=a.energy-r.energy;Math.abs(n)<.1&&Math.abs(s)<.1&&t++}}return t/(e.length-1)}classifyMood(e,t,i,a,r){return e>.7&&t>.7?"euphoric":e>.7&&t<.3?"content":e<.3&&t<.3?"melancholic":e<.3&&t>.7?"aggressive":e<.4&&a>.6?"mysterious":e>.6&&a<.3?"peaceful":a>.7&&i>.6?"dramatic":t<.4&&i<.4?"ambient":a>.6&&t>.6?"chaotic":r==="minor"&&e>.3&&e<.7?"nostalgic":r==="major"&&t>.6&&e>.5?"heroic":i<.5&&e>.4&&e<.6?"contemplative":"neutral"}calculateMoodConfidence(e,t,i,a){let r=[e,t,i,a].map(n=>Math.abs(n-.5)*2);return r.reduce((n,s)=>n+s,0)/r.length}mapEmotionToGradient(e){let t=this.moodProfiles[e.mood],i={...this.createNeutralGradientState(),...t};return{...i,hueShift:i.hueShift+(e.valence-.5)*20,saturationMultiplier:i.saturationMultiplier*(.5+e.arousal*.5),brightnessMultiplier:i.brightnessMultiplier*(.7+e.energy*.6),contrastMultiplier:i.contrastMultiplier*(.6+e.tension*.8),animationSpeed:i.animationSpeed*(.3+e.energy*1.4),pulseIntensity:i.pulseIntensity*e.arousal,flowDirection:e.valence*360,layerHarmony:i.layerHarmony*(.3+e.stability*.7),discordLevel:i.discordLevel*(.1+e.tension*.9),depthPerception:.3+e.complexity*.7,transitionSpeed:i.transitionSpeed/(.5+e.predictability*1.5),smoothing:.4+e.stability*.6,responsiveness:.4+e.confidence*.6}}smoothGradientTransition(e,t,i){let a=.1+i*.4;return{hueShift:this.lerp(e.hueShift,t.hueShift,a),saturationMultiplier:this.lerp(e.saturationMultiplier,t.saturationMultiplier,a),brightnessMultiplier:this.lerp(e.brightnessMultiplier,t.brightnessMultiplier,a),contrastMultiplier:this.lerp(e.contrastMultiplier,t.contrastMultiplier,a),animationSpeed:this.lerp(e.animationSpeed,t.animationSpeed,a),pulseIntensity:this.lerp(e.pulseIntensity,t.pulseIntensity,a),flowDirection:this.lerp(e.flowDirection,t.flowDirection,a),layerHarmony:this.lerp(e.layerHarmony,t.layerHarmony,a),discordLevel:this.lerp(e.discordLevel,t.discordLevel,a),depthPerception:this.lerp(e.depthPerception,t.depthPerception,a),transitionSpeed:this.lerp(e.transitionSpeed,t.transitionSpeed,a*.5),smoothing:this.lerp(e.smoothing,t.smoothing,.1),responsiveness:this.lerp(e.responsiveness,t.responsiveness,.1)}}lerp(e,t,i){return e+(t-e)*Math.max(0,Math.min(1,i))}updateGradientVariables(){let e=this.currentGradientState,t={"--sn-emotional-hue-shift":`${e.hueShift}deg`,"--sn-emotional-saturation-multiplier":e.saturationMultiplier.toString(),"--sn-emotional-brightness-multiplier":e.brightnessMultiplier.toString(),"--sn-emotional-contrast-multiplier":e.contrastMultiplier.toString(),"--sn-emotional-animation-speed":e.animationSpeed.toString(),"--sn-emotional-pulse-intensity":e.pulseIntensity.toString(),"--sn-emotional-flow-direction":`${e.flowDirection}deg`,"--sn-emotional-layer-harmony":e.layerHarmony.toString(),"--sn-emotional-discord-level":e.discordLevel.toString(),"--sn-emotional-depth-perception":e.depthPerception.toString(),"--sn-emotional-transition-speed":e.transitionSpeed.toString()};if(this.cssController.batchSetVariables("EmotionalGradientMapper",t,"normal","emotional-gradient-mapping"),this.currentEmotionalTemperature){let i={...this.currentEmotionalTemperature.cssVariables,"--sn-emotional-temperature":this.currentEmotionalTemperature.temperature.toString(),"--sn-emotional-temperature-intensity":this.currentEmotionalTemperature.intensity.toString(),"--sn-emotional-temperature-class":this.currentEmotionalTemperature.cssClass,"--sn-emotional-temperature-blend":this.currentEmotionalTemperature.intensity.toString()};this.cssController.batchSetVariables("EmotionalGradientMapper",i,"high","emotional-temperature-mapping"),u?.debug?.log("EmotionalGradientMapper","\u{1F321}\uFE0F Applied temperature CSS variables:",{temperature:this.currentEmotionalTemperature.temperature,intensity:this.currentEmotionalTemperature.intensity,cssClass:this.currentEmotionalTemperature.cssClass,variableCount:Object.keys(this.currentEmotionalTemperature.cssVariables).length})}if(this.updateEmotionalGradientCoordination(e),this.currentEmotionalProfile){let i={"--sn-current-mood":this.currentEmotionalProfile.mood,"--sn-mood-confidence":this.currentEmotionalProfile.confidence.toString(),"--sn-emotional-valence":this.currentEmotionalProfile.valence.toString(),"--sn-emotional-energy":this.currentEmotionalProfile.energy.toString()};this.cssController.batchSetVariables("EmotionalGradientMapper",i,"normal","mood-state-tracking")}}updateEmotionalGradientCoordination(e){let t=getComputedStyle(document.documentElement),i=t.getPropertyValue("--sn-bg-gradient-primary").trim(),a=t.getPropertyValue("--sn-bg-gradient-secondary").trim(),r=t.getPropertyValue("--sn-bg-gradient-accent").trim();if(i||a||r){let n={"--sn-bg-gradient-flow-x":(e.flowDirection*.01).toString(),"--sn-bg-gradient-flow-y":(Math.sin(e.flowDirection*Math.PI/180)*.5).toString(),"--sn-bg-gradient-opacity":(.8*e.layerHarmony).toString(),"--sn-bg-gradient-blur":`${120*(1+e.depthPerception*.5)}px`,"--sn-bg-gradient-saturation":e.saturationMultiplier.toString(),"--sn-bg-gradient-brightness":e.brightnessMultiplier.toString(),"--sn-bg-gradient-contrast":e.contrastMultiplier.toString()};this.cssController.batchSetVariables("EmotionalGradientMapper",n,"normal","bg-gradient-coordination"),u?.debug?.log("EmotionalGradientMapper",`Coordinated emotional modifications with gradient system: flow=${e.flowDirection}\xB0, opacity=${.8*e.layerHarmony}`)}}storeEmotionalHistory(e){this.emotionalHistory.push(e),this.emotionalHistory.length>this.maxHistorySize&&this.emotionalHistory.shift()}handleSettingsChange(e){let t=e,{key:i,value:a}=t.detail;(i.startsWith("sn-emotional-")||i.startsWith("sn-gradient-"))&&u?.debug?.log("EmotionalGradientMapper","Settings changed, updating emotional sensitivity")}getCurrentEmotionalProfile(){return this.currentEmotionalProfile}getCurrentGradientState(){return{...this.currentGradientState}}getEmotionalHistory(){return[...this.emotionalHistory]}setMoodOverride(e,t=5e3){let i=this.moodProfiles[e];i&&(this.currentGradientState={...this.currentGradientState,...i},this.updateGradientVariables(),setTimeout(()=>{u?.debug?.log("EmotionalGradientMapper","Mood override expired, returning to automatic detection")},t))}applyEmotionalTemperatureToDocument(e){let t=Array.from(document.body.classList).filter(i=>i.startsWith("smooth-emotion-"));document.body.classList.remove(...t),document.body.classList.add(e.cssClass),e.secondaryEmotion&&document.body.classList.add(`smooth-emotion-blend-${e.secondaryEmotion}`),this.cssController.batchSetVariables("EmotionalGradientMapper",e.cssVariables,"high","emotional-temperature-document"),u?.debug?.log("EmotionalGradientMapper","\u{1F321}\uFE0F Applied emotional temperature to document:",{primaryClass:e.cssClass,secondaryEmotion:e.secondaryEmotion,cssVariableCount:Object.keys(e.cssVariables).length})}inferGenreFromProfile(e){let{mood:t,energy:i,valence:a,tension:r,arousal:n,mode:s}=e;return t==="aggressive"||i>.8&&a<.4?r>.7?"metal":"hard-rock":t==="euphoric"||i>.7&&a>.7?n>.8?"edm":"pop":t==="melancholic"||i<.4&&a<.4?s==="minor"?"blues":"folk":t==="peaceful"||i<.3&&a>.6?"ambient":t==="dramatic"||r>.6&&i>.5?"classical":t==="mysterious"||a<.5&&r>.5?"jazz":t==="heroic"||s==="major"&&i>.6?"soundtrack":"indie-pop"}getCurrentEmotionalTemperature(){return this.currentEmotionalTemperature}setEmotionalTemperatureOverride(e,t=1,i=5e3){try{let a={energy:t,valence:t>.5?.7:.3,genre:"override"},r=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(a);r.primaryEmotion=e,r.intensity=t,r.cssClass=`smooth-emotion-${e}`,this.currentEmotionalTemperature=r,this.applyEmotionalTemperatureToDocument(r),u?.debug?.log("EmotionalGradientMapper","\u{1F321}\uFE0F Applied emotional temperature override:",{emotion:e,intensity:t,duration:i}),setTimeout(()=>{u?.debug?.log("EmotionalGradientMapper","\u{1F321}\uFE0F Emotional temperature override expired")},i)}catch(a){u?.debug?.warn("EmotionalGradientMapper","\u{1F321}\uFE0F Failed to apply emotional temperature override:",a)}}destroy(){if(this.isActive=!1,this.boundSpectralHandler&&document.removeEventListener("music-sync:data-updated",this.boundSpectralHandler),this.boundSettingsHandler&&document.removeEventListener("year3000SystemSettingsChanged",this.boundSettingsHandler),this.currentEmotionalTemperature){let e=Array.from(document.body.classList).filter(t=>t.startsWith("smooth-emotion-"));document.body.classList.remove(...e)}this.emotionalHistory=[],this.currentEmotionalProfile=null,this.currentEmotionalTemperature=null,u?.debug?.log("EmotionalGradientMapper","Emotional mapping system destroyed")}}});var ge,pe,xe,Ai,ts=y(()=>{"use strict";es();L();x();ge={VISUAL_EFFECTS:"--sn-visual-effects-",VISUAL_STATE:"--sn-visual-state-",VISUAL_COORDINATION:"--sn-visual-coordination-",VISUAL_PERFORMANCE:"--sn-visual-performance-"},pe={ENERGY_LEVEL:ge.VISUAL_STATE+"energy-level",FLOW_DIRECTION_X:ge.VISUAL_STATE+"flow-direction-x",FLOW_DIRECTION_Y:ge.VISUAL_STATE+"flow-direction-y",COLOR_TEMPERATURE:ge.VISUAL_STATE+"color-temperature",ADAPTIVE_QUALITY:ge.VISUAL_PERFORMANCE+"adaptive-quality",PARTICIPANT_COUNT:ge.VISUAL_COORDINATION+"participant-count",UPDATE_RATE:ge.VISUAL_PERFORMANCE+"update-rate",PULSE_RATE:ge.VISUAL_EFFECTS+"pulse-rate",TRANSITION_FLUIDITY:ge.VISUAL_EFFECTS+"transition-fluidity",SYSTEM_HARMONY:ge.VISUAL_EFFECTS+"system-harmony"},xe=class xe{constructor(e,t,i,a,r){this.initialized=!1;this.cssController=null;this.performanceCoordinator=null;this.musicSyncService=null;this.colorHarmonyEngine=null;this.emotionalGradientMapper=null;this.currentVisualState=null;this.previousVisualState=null;this.fieldUpdateTimer=null;this.lastFieldUpdate=0;this.registeredParticipants=new Map;this.participantContributions=new Map;this.transitionConfig={enabled:!0,transitionDuration:1e3,easingFunction:"smooth",intensityFactor:1,coherenceThreshold:.3};this.isActive=!1;this.updateInterval=16;this.performanceMetrics={stateUpdates:0,coordinationEvents:0,animationTransitions:0,lastUpdate:0,averageUpdateTime:0};this.config=e,this.eventBus=p,this.cssController=t||null,this.performanceCoordinator=i||null,this.musicSyncService=a||null,this.colorHarmonyEngine=r||null,this.cssController&&this.musicSyncService&&(this.emotionalGradientMapper=new Pi(this.cssController,this.musicSyncService)),this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator","Visual effects coordinator created")}static getInstance(e,t,i,a,r){if(!xe.instance){if(!e)throw new Error("VisualEffectsCoordinator requires configuration for first initialization");xe.instance=new xe(e,t,i,a,r)}return xe.instance}async initialize(){if(!this.initialized)try{this.emotionalGradientMapper&&await this.emotionalGradientMapper.initialize(),this.currentVisualState=this.createInitialVisualState(),this.startVisualEffectsUpdates(),this.subscribeToEvents(),this.initialized=!0,this.isActive=!0,this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator","Visual effects coordinator initialized")}catch(e){throw u?.debug?.error("VisualEffectsCoordinator","Failed to initialize:",e),e}}updateAnimation(e){this.performanceMetrics.lastUpdate=performance.now()}async healthCheck(){let e=this.registeredParticipants.size,t=this.currentVisualState?performance.now()-this.currentVisualState.timestamp:0,i=this.isActive&&t<1e3&&e>0;return{system:"VisualEffectsCoordinator",healthy:i,ok:i,details:i?"Visual effects coordination active":"Visual effects state inactive or stale",metrics:{isActive:this.isActive,participantCount:e,fieldAge:t,stateUpdates:this.performanceMetrics.stateUpdates,coordinationEvents:this.performanceMetrics.coordinationEvents,animationTransitions:this.performanceMetrics.animationTransitions,averageUpdateTime:this.performanceMetrics.averageUpdateTime}}}destroy(){this.fieldUpdateTimer&&(clearTimeout(this.fieldUpdateTimer),this.fieldUpdateTimer=null),this.unsubscribeFromEvents(),this.emotionalGradientMapper&&(this.emotionalGradientMapper.destroy(),this.emotionalGradientMapper=null),this.registeredParticipants.clear(),this.participantContributions.clear(),this.currentVisualState=null,this.previousVisualState=null,this.isActive=!1,this.initialized=!1,xe.instance===this&&(xe.instance=null),this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator","Visual effects coordinator destroyed")}createInitialVisualState(){let e=this.performanceCoordinator?.getDeviceCapabilities()||{performanceTier:"medium",memoryGB:4,cpuCores:2,gpuAcceleration:!1,isMobile:!1,supportsWebGL:!1,supportsBackdropFilter:!1,maxTextureSize:2048,devicePixelRatio:1},t=this.performanceCoordinator?.getCurrentPerformanceMode()||{name:"balanced",qualityLevel:.7,animationQuality:.7,effectQuality:.7,blurQuality:.7,shadowQuality:.7,frameRate:60,optimizationLevel:1};return{musicIntensity:.5,flowDirection:{x:0,y:0},energyLevel:.5,colorTemperature:6500,tempoModulation:1,harmonicComplexity:.5,fluidIntensity:1,depthPerception:.7,luminosity:e.gpuAcceleration?1.2:.8,colorHarmony:.6,visualCoherence:.8,pulseRate:2,transitionFluidity:.5,scalingFactor:1,effectDepth:.6,systemHarmony:.7,deviceCapabilities:e,performanceMode:t,adaptiveQuality:t.qualityLevel,thermalState:0,batteryConservation:0,timestamp:performance.now(),evolutionPhase:0,continuityIndex:1}}updateVisualEffectsState(){let e=performance.now();if(!this.currentVisualState){this.currentVisualState=this.createInitialVisualState();return}this.previousVisualState={...this.currentVisualState};let t=this.evolveVisualState(this.currentVisualState);this.transitionConfig.enabled?this.currentVisualState=this.applyDynamicTransition(this.currentVisualState,t):this.currentVisualState=t,this.applyStandardizedVisualVariables().catch(r=>{u?.debug?.error("VisualEffectsCoordinator","Failed to apply CSS variables:",r)});let i=this.choreographVisualEffectsUpdate();!i.success&&this.config.enableDebug&&u?.debug?.warn("VisualEffectsCoordinator",`Visual effects update had ${i.errorCount} errors, notified ${i.participantsNotified} participants`);let a=performance.now()-e;this.performanceMetrics.stateUpdates++,this.performanceMetrics.averageUpdateTime=(this.performanceMetrics.averageUpdateTime+a)/2,this.config.enableDebug&&this.performanceMetrics.stateUpdates%60===0&&u?.debug?.log("VisualEffectsCoordinator",`Visual effects state evolved - Update #${this.performanceMetrics.stateUpdates}, avg time: ${this.performanceMetrics.averageUpdateTime.toFixed(2)}ms`)}evolveVisualState(e){let t={...e};return t.timestamp=performance.now(),t.evolutionPhase=Math.min(1,t.evolutionPhase+.001),this.updateFromMusicAnalysis(t),this.integrateParticipantContributions(t),this.applyAnimationTransitions(t),this.updatePerformanceAwareness(t),this.previousVisualState&&(t.continuityIndex=this.calculateContinuityIndex(this.previousVisualState,t)),t}updateFromMusicAnalysis(e){if(this.emotionalGradientMapper){let t=this.emotionalGradientMapper.getCurrentEmotionalProfile();if(t){e.pulseRate=t.energy,e.energyLevel=t.arousal,e.colorTemperature=3e3+t.valence*1e4,e.harmonicComplexity=t.complexity;let i={euphoric:{x:1,y:1},aggressive:{x:-1,y:1},peaceful:{x:0,y:-.5},melancholic:{x:-.5,y:-1},mysterious:{x:.7,y:0},contemplative:{x:0,y:.3}};e.flowDirection=i[t.mood]||{x:0,y:0},e.tempoModulation=.5+t.energy*1.5}}this.musicSyncService}integrateParticipantContributions(e){if(this.participantContributions.size===0)return;let t=0,i=[];for(let[a,r]of this.participantContributions)i.push(r),t+=1;if(t>0)for(let a of i)a.fluidIntensity!==void 0&&(e.fluidIntensity=this.dynamicBlend(e.fluidIntensity,a.fluidIntensity,.1)),a.depthPerception!==void 0&&(e.depthPerception=this.dynamicBlend(e.depthPerception,a.depthPerception,.1)),a.luminosity!==void 0&&(e.luminosity=this.dynamicBlend(e.luminosity,a.luminosity,.1))}applyAnimationTransitions(e){let i=performance.now()/1e3%e.pulseRate/e.pulseRate,a=Math.sin(i*Math.PI*2)*.1;e.scalingFactor+=a,e.transitionFluidity=Math.max(0,Math.min(1,e.transitionFluidity+a*.5)),e.effectDepth=Math.max(0,Math.min(1,e.effectDepth+e.evolutionPhase*.001)),e.systemHarmony=Math.max(0,Math.min(1,(e.visualCoherence+e.continuityIndex)/2))}updatePerformanceAwareness(e){if(this.performanceCoordinator){e.deviceCapabilities=this.performanceCoordinator.getDeviceCapabilities(),e.performanceMode=this.performanceCoordinator.getCurrentPerformanceMode(),e.adaptiveQuality=e.performanceMode.qualityLevel;let t=this.performanceCoordinator.getThermalState(),i=this.performanceCoordinator.getBatteryState();e.thermalState=t.throttleLevel||0,e.batteryConservation=i&&!i.charging?(1-i.level)*.5:0}}calculateContinuityIndex(e,t){let i=[Math.abs(e.pulseRate-t.pulseRate),Math.abs(e.energyLevel-t.energyLevel),Math.abs(e.fluidIntensity-t.fluidIntensity),Math.abs(e.depthPerception-t.depthPerception),Math.abs(e.luminosity-t.luminosity)],a=i.reduce((r,n)=>r+n,0)/i.length;return Math.max(0,Math.min(1,1-a))}applyDynamicTransition(e,t){let i=this.calculateDynamicTransitionSpeed(e,t),a=this.applyDynamicEasing(i);return this.blendVisualStates(e,t,a)}applySmoothTransition(e,t){return this.applyDynamicTransition(e,t)}calculateDynamicTransitionSpeed(e,t){let i=.016666666666666666,a=1+Math.sin(performance.now()/1e3/e.pulseRate*Math.PI*2)*.2,r=.5+e.energyLevel*1.5;return i*a*r*this.transitionConfig.intensityFactor}calculateSmoothTransitionSpeed(e,t){return this.calculateDynamicTransitionSpeed(e,t)}applyDynamicEasing(e){switch(this.transitionConfig.easingFunction){case"smooth":return e*e*(3-2*e);case"harmonic":return(Math.sin((e-.5)*Math.PI)+1)/2;case"exponential":return e*e;case"cubic":return e*e*e;default:return e}}applySmoothEasing(e){return this.applyDynamicEasing(e)}blendVisualStates(e,t,i){let a={...e};return a.pulseRate=this.dynamicBlend(e.pulseRate,t.pulseRate,i),a.energyLevel=this.dynamicBlend(e.energyLevel,t.energyLevel,i),a.colorTemperature=this.dynamicBlend(e.colorTemperature,t.colorTemperature,i),a.fluidIntensity=this.dynamicBlend(e.fluidIntensity,t.fluidIntensity,i),a.depthPerception=this.dynamicBlend(e.depthPerception,t.depthPerception,i),a.luminosity=this.dynamicBlend(e.luminosity,t.luminosity,i),a.colorHarmony=this.dynamicBlend(e.colorHarmony,t.colorHarmony,i),a.visualCoherence=this.dynamicBlend(e.visualCoherence,t.visualCoherence,i),a.transitionFluidity=this.dynamicBlend(e.transitionFluidity,t.transitionFluidity,i),a.scalingFactor=this.dynamicBlend(e.scalingFactor,t.scalingFactor,i),a.effectDepth=this.dynamicBlend(e.effectDepth,t.effectDepth,i),a.systemHarmony=this.dynamicBlend(e.systemHarmony,t.systemHarmony,i),a.tempoModulation=this.dynamicBlend(e.tempoModulation,t.tempoModulation,i),a.harmonicComplexity=this.dynamicBlend(e.harmonicComplexity,t.harmonicComplexity,i),a.adaptiveQuality=this.dynamicBlend(e.adaptiveQuality,t.adaptiveQuality,i),a.flowDirection={x:this.dynamicBlend(e.flowDirection.x,t.flowDirection.x,i),y:this.dynamicBlend(e.flowDirection.y,t.flowDirection.y,i)},a.timestamp=performance.now(),a.continuityIndex=e.continuityIndex,a}dynamicBlend(e,t,i){return e+(t-e)*i}smoothBlend(e,t,i){return this.dynamicBlend(e,t,i)}registerVisualEffectsParticipant(e){try{if(this.registeredParticipants.has(e.systemName))return{success:!1,participantName:e.systemName,contributionReceived:!1,errorMessage:`Participant '${e.systemName}' is already registered`};this.registeredParticipants.set(e.systemName,e);let t=!1;try{let i=e.getVisualContribution();this.participantContributions.set(e.systemName,i),t=!0}catch(i){u?.debug?.warn("VisualEffectsCoordinator",`Failed to get initial contribution from ${e.systemName}:`,i)}return this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Registered participant: ${e.systemName}`),{success:!0,participantName:e.systemName,contributionReceived:t}}catch(t){let i=t instanceof Error?t.message:"Unknown registration error";return u?.debug?.error("VisualEffectsCoordinator",`Failed to register participant ${e.systemName}:`,t),{success:!1,participantName:e.systemName,contributionReceived:!1,errorMessage:i}}}unregisterVisualEffectsParticipant(e){this.registeredParticipants.delete(e),this.participantContributions.delete(e),this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Unregistered participant: ${e}`)}updateParticipantContribution(e,t){this.registeredParticipants.has(e)&&this.participantContributions.set(e,t)}choreographVisualEffectsUpdate(){let e=performance.now(),t=0,i=0;if(!this.currentVisualState)return{success:!1,participantsNotified:0,updateDuration:0,continuityIndex:0,errorCount:1};try{this.eventBus.emit("visual-effects:field-updated",{rhythmicPulse:this.currentVisualState.pulseRate,musicalFlow:this.currentVisualState.flowDirection,energyResonance:this.currentVisualState.energyLevel,depthPerception:this.currentVisualState.depthPerception,pulsingCycle:this.currentVisualState.pulseRate})}catch(r){u?.debug?.error("VisualEffectsCoordinator","Error broadcasting visual effects state update:",r),i++}for(let r of this.registeredParticipants.values())try{r.onVisualStateUpdate(this.currentVisualState),t++}catch(n){u?.debug?.error("VisualEffectsCoordinator",`Error updating participant ${r.systemName}:`,n),i++}this.performanceMetrics.coordinationEvents++;let a=performance.now()-e;return{success:i===0,participantsNotified:t,updateDuration:a,continuityIndex:this.currentVisualState.continuityIndex,errorCount:i}}choreographEvent(e,t){if(e&&typeof e=="string")try{let i=this.mapChoreographyEventToUnified(e);i&&this.eventBus.emit(i.eventName,i.payload)}catch{this.eventBus.emit(`visual-effects:${e}`,t)}for(let i of this.registeredParticipants.values())try{e.startsWith("visual:")?i.onVisualEffectEvent(e,t):i.onVisualEffectEvent("visual:coordination",{...t,originalEventType:e})}catch(a){u?.debug?.error("VisualEffectsCoordinator",`Error sending choreography event to ${i.systemName}:`,a)}this.performanceMetrics.coordinationEvents++,this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Choreographed event: ${e}`,t)}startVisualEffectsUpdates(){if(this.fieldUpdateTimer)return;let e=()=>{this.isActive&&(this.updateVisualEffectsState(),this.fieldUpdateTimer=setTimeout(e,this.updateInterval))};e(),this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Started visual effects state updates (${this.updateInterval}ms interval)`)}subscribeToEvents(){this.musicSyncService&&(this.eventBus.subscribe("music:track-changed",e=>{this.choreographEvent("rhythm-shift",{newTrack:e,transitionType:"smooth"})},"VisualEffectsCoordinator"),this.eventBus.subscribe("music:emotion-analyzed",e=>{this.choreographEvent("intensity-peak",{intensity:e?.energy||.5,affectedSystems:["all"],surgeType:"full-spectrum",duration:1e3,falloffCurve:"smooth"})},"VisualEffectsCoordinator")),this.performanceCoordinator&&this.eventBus.subscribe("performance:tier-changed",e=>{this.choreographEvent("genre-transition",{newMode:e||{name:"auto",qualityLevel:.8,frameRate:60,optimizationLevel:.5},adaptationType:"smooth",reason:"automatic",affectedSystems:["all"]})},"VisualEffectsCoordinator"),this.eventBus.subscribe("settings:visual-guide-changed",e=>{(e?.key?.includes("visual-effects")||e?.key?.includes("choreography"))&&this.updateDynamicTransitionConfig(e)},"VisualEffectsCoordinator")}unsubscribeFromEvents(){}mapChoreographyEventToUnified(e){switch(e){case"rhythm-shift":return{eventName:"visual-effects:coordination",payload:{source:"choreographer",type:"rhythm-shift"}};case"intensity-peak":return{eventName:"visual-effects:intensity-changed",payload:{intensity:.8,userEngagement:.6,timestamp:Date.now()}};case"genre-transition":return{eventName:"visual-effects:coordination",payload:{source:"choreographer",type:"genre-transition"}};case"emotional-shift":return{eventName:"visual-effects:coordination",payload:{source:"choreographer",type:"emotional-shift"}};default:return{eventName:"visual-effects:coordination",payload:{source:"choreographer",type:e}}}}updateDynamicTransitionConfig(e){let{key:t,value:i}=e;if(t.includes("transition-intensity"))this.transitionConfig.intensityFactor=Math.max(0,Math.min(2,parseFloat(i)||1));else if(t.includes("transition-duration"))this.transitionConfig.transitionDuration=Math.max(100,Math.min(5e3,parseInt(i)||1e3));else if(t.includes("animation-cycle")){let a=Math.max(.5,Math.min(4,parseFloat(i)||2));this.currentVisualState&&(this.currentVisualState.pulseRate=a)}this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Updated dynamic transition config: ${t} = ${i}`)}updateSmoothTransitionConfig(e){return this.updateDynamicTransitionConfig(e)}async applyStandardizedVisualVariables(e){if(!this.currentVisualState)return;let t=e||document.documentElement,i=this.currentVisualState,a={[pe.ENERGY_LEVEL]:i.energyLevel.toFixed(3),[pe.FLOW_DIRECTION_X]:i.flowDirection.x.toFixed(3),[pe.FLOW_DIRECTION_Y]:i.flowDirection.y.toFixed(3),[pe.COLOR_TEMPERATURE]:i.colorTemperature.toString(),[pe.ADAPTIVE_QUALITY]:i.adaptiveQuality.toFixed(3),[pe.PARTICIPANT_COUNT]:this.registeredParticipants.size.toString(),[pe.UPDATE_RATE]:(1e3/this.updateInterval).toString(),[pe.PULSE_RATE]:i.pulseRate.toFixed(3),[pe.TRANSITION_FLUIDITY]:i.transitionFluidity.toFixed(3),[pe.SYSTEM_HARMONY]:i.systemHarmony.toFixed(3)};if(this.cssController)for(let[r,n]of Object.entries(a))await this.cssController.setVariable("VisualEffectsCoordinator",r,n,"normal","standardized-vars");else for(let[r,n]of Object.entries(a))t.style.setProperty(r,n);this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Applied ${Object.keys(a).length} standardized visual effect CSS variables`)}getCurrentVisualEffectsState(){return this.currentVisualState?{...this.currentVisualState}:null}getRegisteredParticipants(){return Array.from(this.registeredParticipants.keys())}updateDynamicTransitionConfiguration(e){this.transitionConfig={...this.transitionConfig,...e},this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator","Updated dynamic transition configuration:",e)}updateSmoothTransitionConfiguration(e){return this.updateDynamicTransitionConfiguration(e)}forceVisualEffectsStateUpdate(){this.updateVisualEffectsState()}getPerformanceMetrics(){return{...this.performanceMetrics}}registerConsciousnessParticipant(e){return this.registerVisualEffectsParticipant(e)}unregisterConsciousnessParticipant(e){this.unregisterVisualEffectsParticipant(e)}getCurrentConsciousnessField(){return this.getCurrentVisualEffectsState()}forceConsciousnessFieldUpdate(){this.forceVisualEffectsStateUpdate()}registerBackgroundSystemParticipant(e){return this.registerVisualEffectsParticipant(e)}unregisterBackgroundSystemParticipant(e){this.unregisterVisualEffectsParticipant(e)}getCurrentBackgroundState(){return this.getCurrentVisualEffectsState()}choreographBackgroundEvent(e,t){return this.choreographEvent(e,t)}};xe.instance=null;Ai=xe});var xi,is=y(()=>{"use strict";gi();U();x();Me();ae();xi=class{constructor(e=E.enableDebug){this.coordinationCache=new Map;this.cacheMaxSize=20;this.cacheTimeoutMs=3e5;this.enableDebug=e,this.oklabProcessor=new M(e),this.emotionalMapper=new Z(e),this.genreManager=new He({ADVANCED_SYSTEM_CONFIG:E}),this.enableDebug&&u?.debug?.log("MusicalOKLABCoordinator","Unified music-to-OKLAB coordinator initialized")}async processMusicalColors(e,t={}){let i=performance.now(),a=this.generateCacheKey(e),r=this.coordinationCache.get(a);if(r)return this.enableDebug&&u?.debug?.log("MusicalOKLABCoordinator","Using cached processing result",{cacheKey:a}),r;try{let n=this.determineProcessingStrategy(e,t),s=await this.getOptimalOKLABPreset(e,n,t),o=await this.processColorsWithMusicalContext(e.rawColors,e.musicData,s),l=this.emotionalMapper.mapMusicToEmotionalTemperature(e.musicData),m=this.genreManager.detectGenre(e.musicData),d=this.genreManager.getColorCharacteristicsForGenre(m),h=this.calculateMusicInfluenceStrength(e.musicData,l),g=this.generateUnifiedCSSVariables(o,l,d,s),{accentHex:f,accentRgb:S}=this.selectOptimalAccentColor(o),C=performance.now()-i,T={enhancedColors:Object.fromEntries(Object.entries(o).map(([w,R])=>[w,R.enhancedHex])),accentHex:f,accentRgb:S,oklabPreset:s,oklabResults:o,detectedGenre:m,emotionalResult:l,genreCharacteristics:d,processingTime:C,musicInfluenceStrength:h,processingStrategy:n,cssVariables:g};return this.cacheResult(a,T),this.enableDebug&&u?.debug?.log("MusicalOKLABCoordinator","Musical OKLAB processing completed",{genre:m,emotion:l.primaryEmotion,strategy:n,preset:s.name,processingTime:C,colorCount:Object.keys(o).length}),T}catch(n){return this.enableDebug&&u?.debug?.error("MusicalOKLABCoordinator","Musical processing failed:",n),this.createFallbackResult(e,performance.now()-i)}}determineProcessingStrategy(e,t){let{musicData:i}=e;if(!i||typeof i.energy!="number"||typeof i.valence!="number")return"fallback";if(t.preferGenreOverEmotion===!0)return"genre-primary";if(t.preferGenreOverEmotion===!1)return"emotion-primary";let a=Math.abs(i.energy-.5)*2,r=Math.abs(i.valence-.5)*2;return(a+r)/2>.6?"emotion-primary":this.genreManager.detectGenre(i)!=="default"?"genre-primary":"balanced"}async getOptimalOKLABPreset(e,t,i){let{musicData:a}=e;try{let r;switch(t){case"genre-primary":r=this.genreManager.getOKLABPresetForTrack(a);break;case"emotion-primary":r=this.emotionalMapper.mapMusicToEmotionalTemperature(a).oklabPreset;break;case"balanced":let s=this.genreManager.getOKLABPresetForTrack(a),o=this.emotionalMapper.mapMusicToEmotionalTemperature(a);r=this.processBlendedPresets(s,o.oklabPreset,i.intensityMultiplier||1);break;default:r=M.getPreset("STANDARD")}return r}catch(r){return this.enableDebug&&u?.debug?.warn("MusicalOKLABCoordinator","Failed to get optimal preset, using STANDARD:",r),M.getPreset("STANDARD")}}processBlendedPresets(e,t,i){let a=(e.chromaBoost+t.chromaBoost)/2*i,r=(e.lightnessBoost+t.lightnessBoost)/2,n=(e.shadowReduction+t.shadowReduction)/2,s=(e.vibrantThreshold+t.vibrantThreshold)/2;return M.createCustomPreset("blended-genre-emotion",`Blended ${e.name} + ${t.name}`,r,a,n,s)}async processColorsWithMusicalContext(e,t,i){let a={};for(let[r,n]of Object.entries(e))if(!(!n||typeof n!="string"||!n.startsWith("#")))try{let s=this.oklabProcessor.processColor(n,i);a[r]=s}catch(s){this.enableDebug&&u?.debug?.warn("MusicalOKLABCoordinator",`Failed to process color ${r}:`,s)}return a}calculateMusicInfluenceStrength(e,t){let i=e.energy||.5,a=Math.abs((e.valence||.5)-.5)*2,r=t.intensity,n=(i+a+r)/3,s=1;return e.tempo&&e.tempo>0&&(s+=.1),e.danceability&&e.danceability>.7&&(s+=.1),e.genre&&e.genre!=="default"&&(s+=.1),Math.min(1,n*s)}generateUnifiedCSSVariables(e,t,i,a){let r={};return Object.entries(e).forEach(([n,s])=>{r[`--sn-${n.toLowerCase()}-enhanced`]=s.enhancedHex,r[`--sn-${n.toLowerCase()}-oklab-l`]=s.oklabEnhanced.L.toFixed(3),r[`--sn-${n.toLowerCase()}-oklab-a`]=s.oklabEnhanced.a.toFixed(3),r[`--sn-${n.toLowerCase()}-oklab-b`]=s.oklabEnhanced.b.toFixed(3),r[`--sn-${n.toLowerCase()}-oklch-c`]=s.oklchEnhanced.C.toFixed(3),r[`--sn-${n.toLowerCase()}-oklch-h`]=s.oklchEnhanced.H.toFixed(1),r[`--sn-${n.toLowerCase()}-shadow`]=s.shadowHex}),Object.entries(t.cssVariables).forEach(([n,s])=>{r[n]=s}),r["--sn-detected-genre"]=i?i.vibrancyLevel:"standard",r["--sn-color-temperature"]=i?i.colorTemperature:"neutral",r["--sn-emotional-range"]=i?i.emotionalRange:"moderate",r["--sn-oklab-preset-name"]=a.name,r["--sn-oklab-chroma-boost"]=a.chromaBoost.toString(),r["--sn-oklab-lightness-boost"]=a.lightnessBoost.toString(),r["--sn-musical-oklab-processing"]="enabled",r["--sn-color-processing-mode"]="unified-musical-oklab",r}selectOptimalAccentColor(e){let t=["VIBRANT","PROMINENT","DARK_VIBRANT","LIGHT_VIBRANT"];for(let a of t)if(e[a]){let r=e[a];return{accentHex:r.enhancedHex,accentRgb:`${r.enhancedRgb.r},${r.enhancedRgb.g},${r.enhancedRgb.b}`}}let i=Object.values(e)[0];return i?{accentHex:i.enhancedHex,accentRgb:`${i.enhancedRgb.r},${i.enhancedRgb.g},${i.enhancedRgb.b}`}:{accentHex:"#cba6f7",accentRgb:"203,166,247"}}createFallbackResult(e,t){let i=M.getPreset("STANDARD");return{enhancedColors:e.rawColors,accentHex:"#cba6f7",accentRgb:"203,166,247",oklabPreset:i,oklabResults:{},detectedGenre:"default",emotionalResult:{primaryEmotion:"calm",intensity:.5,temperature:3500,blendRatio:1,cssClass:"smooth-emotion-calm",cssVariables:{},oklabPreset:i},genreCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"},processingTime:t,musicInfluenceStrength:.5,processingStrategy:"fallback",cssVariables:{"--sn-musical-oklab-processing":"fallback","--sn-oklab-preset-name":"STANDARD"}}}generateCacheKey(e){return`${e.trackUri}-${e.timestamp}-${JSON.stringify(e.musicData)}`}cacheResult(e,t){if(this.coordinationCache.size>=this.cacheMaxSize){let i=this.coordinationCache.keys().next().value;i&&this.coordinationCache.delete(i)}this.coordinationCache.set(e,t),setTimeout(()=>{this.coordinationCache.delete(e)},this.cacheTimeoutMs)}convertToColorResult(e,t){return{processedColors:{...e.enhancedColors,...e.cssVariables},accentHex:e.accentHex,accentRgb:e.accentRgb,metadata:{strategy:"musical-oklab-processor",processingTime:e.processingTime,detectedGenre:e.detectedGenre,emotionalState:e.emotionalResult.primaryEmotion,oklabPreset:e.oklabPreset.name,processingStrategy:e.processingStrategy,musicInfluenceStrength:e.musicInfluenceStrength},context:{rawColors:t.rawColors,trackUri:t.trackUri,timestamp:t.timestamp,harmonicMode:t.harmonicMode||"musical-oklab-processing",musicData:t.musicData}}}clearProcessingCache(){this.coordinationCache.clear(),this.enableDebug&&u?.debug?.log("MusicalOKLABCoordinator","Processing cache cleared")}getProcessingMetrics(){return{cacheSize:this.coordinationCache.size,maxCacheSize:this.cacheMaxSize,cacheTimeoutMs:this.cacheTimeoutMs,enableDebug:this.enableDebug}}}});var Ii,as=y(()=>{"use strict";x();Ii=class{constructor(){this.strategiesMap=new Map;this.metrics={totalStrategies:0,healthyStrategies:0,averageResponseTime:0,totalUsageCount:0,cacheHitRate:0,memoryUsage:0};this.healthCheckInterval=null;this.HEALTH_CHECK_INTERVAL_MS=3e4;this.startHealthMonitoring(),u?.debug?.log("BackgroundStrategyRegistry","Strategy registry initialized")}register(e){let t=e.getStrategyName();this.strategiesMap.has(t)&&u?.debug?.warn("BackgroundStrategyRegistry",`Strategy ${t} is already registered, replacing...`);try{let i={strategy:e,registrationTime:Date.now(),lastUsed:0,usageCount:0,errorCount:0,averageProcessingTime:0,isHealthy:!0,metadata:this.inferStrategyMetadata(e)};this.strategiesMap.set(t,i),this.updateMetrics(),u?.debug?.log("BackgroundStrategyRegistry",`Registered strategy: ${t}`,{category:i.metadata.category,priority:i.metadata.priority,memoryImpact:i.metadata.memoryImpact})}catch(i){u?.debug?.error("BackgroundStrategyRegistry",`Failed to register strategy ${t}:`,i)}}selectStrategy(e){let t=Array.from(this.strategiesMap.values()).filter(a=>a.isHealthy).sort((a,r)=>this.scoreStrategy(r,e)-this.scoreStrategy(a,e));if(t.length===0)return u?.debug?.warn("BackgroundStrategyRegistry","No healthy strategies available"),null;let i=t[0];return i?(this.recordStrategyUsage(i.strategy.getStrategyName()),u?.debug?.log("BackgroundStrategyRegistry",`Selected strategy: ${i.strategy.getStrategyName()}`,{score:this.scoreStrategy(i,e),totalAvailable:t.length}),i.strategy):(u?.debug?.warn("BackgroundStrategyRegistry","No strategies available after filtering"),null)}getStrategies(){return Array.from(this.strategiesMap.values()).filter(e=>e.isHealthy).map(e=>e.strategy)}getStrategy(e){let t=this.strategiesMap.get(e);return t&&t.isHealthy?t.strategy:null}selectMultipleStrategies(e,t=4){let i=Array.from(this.strategiesMap.values()).filter(r=>r.isHealthy).map(r=>({registration:r,score:this.scoreStrategy(r,e)})).sort((r,n)=>n.score-r.score).slice(0,t);i.forEach(r=>{this.recordStrategyUsage(r.registration.strategy.getStrategyName())});let a=i.map(r=>r.registration.strategy);return u?.debug?.log("BackgroundStrategyRegistry",`Selected ${a.length} strategies`,{strategies:a.map(r=>r.getStrategyName()),scores:i.map(r=>r.score)}),a}scoreStrategy(e,t){let i=0;switch(i+=e.metadata.priority*10,t.performance){case"high":e.metadata.memoryImpact==="low"&&(i+=20),e.averageProcessingTime<10&&(i+=15);break;case"medium":e.metadata.memoryImpact!=="high"&&(i+=10),e.averageProcessingTime<20&&(i+=10);break;case"low":break}switch(t.quality){case"premium":e.metadata.category==="enhancement"&&(i+=15),e.metadata.tags.includes("webgl")&&(i+=10);break;case"enhanced":e.metadata.category!=="effects"&&(i+=10);break;case"basic":e.metadata.category==="foundation"&&(i+=15);break}if(t.deviceCapabilities&&(t.deviceCapabilities.hasWebGL&&e.metadata.tags.includes("webgl")&&(i+=15),t.deviceCapabilities.isMobile&&e.metadata.memoryImpact==="low"&&(i+=10),t.deviceCapabilities.memoryMB&&t.deviceCapabilities.memoryMB<4e3&&e.metadata.memoryImpact==="high"&&(i-=20)),t.userPreferences&&(t.userPreferences.enableAdvancedBlending&&e.metadata.tags.includes("advanced-blending")&&(i+=12),t.userPreferences.harmonicMode)){let n=t.userPreferences.harmonicMode;e.metadata.tags.includes(n)&&(i+=8)}let a=e.usageCount>0?e.errorCount/e.usageCount:0;return i-=a*30,Date.now()-e.lastUsed<3e5&&(i+=5),Math.max(0,i)}inferStrategyMetadata(e){let t=e.getStrategyName(),i=[],a="enhancement",r=5,n="medium",s=[];switch(t){case"dynamic-catppuccin":a="accent",r=10,n="low",i.push("catppuccin","dynamic","accent","spicetify");break;case"living-gradient":a="foundation",r=8,n="low",i.push("gradient","pulsing","foundation","css");break;case"webgl-gradient":a="enhancement",r=6,n="high",s.push("webgl"),i.push("webgl","gradient","performance","advanced-blending");break;case"depth-layered":a="effects",r=7,n="medium",i.push("depth","layers","parallax","visual-effects","cosmic","cinematic");break;default:break}return{category:a,priority:r,memoryImpact:n,deviceRequirements:s,tags:i}}recordStrategyUsage(e){let t=this.strategiesMap.get(e);t&&(t.usageCount++,t.lastUsed=Date.now())}recordStrategyError(e,t){let i=this.strategiesMap.get(e);if(i){i.errorCount++;let a=i.errorCount/Math.max(1,i.usageCount);a>.5&&i.usageCount>5&&(i.isHealthy=!1,u?.debug?.warn("BackgroundStrategyRegistry",`Strategy ${e} marked as unhealthy`,{errorRate:a,errorCount:i.errorCount,usageCount:i.usageCount}))}}recordStrategyProcessingTime(e,t){let i=this.strategiesMap.get(e);if(i){let a=i.averageProcessingTime*(i.usageCount-1)+t;i.averageProcessingTime=a/i.usageCount}}startHealthMonitoring(){this.healthCheckInterval=window.setInterval(()=>{this.performHealthChecks()},this.HEALTH_CHECK_INTERVAL_MS)}async performHealthChecks(){try{for(let[e,t]of this.strategiesMap.entries())try{if("healthCheck"in t.strategy&&typeof t.strategy.healthCheck=="function"){let i=await t.strategy.healthCheck();t.isHealthy=i?.healthy??!0,t.isHealthy||u?.debug?.warn("BackgroundStrategyRegistry",`Strategy ${e} failed health check:`,i)}}catch(i){t.isHealthy=!1,u?.debug?.error("BackgroundStrategyRegistry",`Health check failed for strategy ${e}:`,i)}this.updateMetrics()}catch(e){u?.debug?.error("BackgroundStrategyRegistry","Health check monitoring failed:",e)}}updateMetrics(){let e=Array.from(this.strategiesMap.values());this.metrics.totalStrategies=e.length,this.metrics.healthyStrategies=e.filter(i=>i.isHealthy).length,this.metrics.totalUsageCount=e.reduce((i,a)=>i+a.usageCount,0);let t=e.filter(i=>i.averageProcessingTime>0).map(i=>i.averageProcessingTime);t.length>0&&(this.metrics.averageResponseTime=t.reduce((i,a)=>i+a,0)/t.length),this.metrics.memoryUsage=e.reduce((i,a)=>{let r=a.metadata.memoryImpact==="high"?3:a.metadata.memoryImpact==="medium"?2:1;return i+r},0)}getRegistryMetrics(){return{...this.metrics}}getStrategyInfo(e){let t=this.strategiesMap.get(e);return t?{...t}:null}getAllStrategyInfo(){return Array.from(this.strategiesMap.entries()).map(([e,t])=>({name:e,registration:{...t}}))}unregister(e){let t=this.strategiesMap.delete(e);return t&&(this.updateMetrics(),u?.debug?.log("BackgroundStrategyRegistry",`Unregistered strategy: ${e}`)),t}clear(){this.strategiesMap.clear(),this.updateMetrics(),u?.debug?.log("BackgroundStrategyRegistry","All strategies cleared from registry")}destroy(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null);for(let[e,t]of this.strategiesMap.entries())if("destroy"in t.strategy&&typeof t.strategy.destroy=="function")try{t.strategy.destroy()}catch(i){u?.debug?.warn("BackgroundStrategyRegistry",`Error destroying strategy ${e}:`,i)}this.clear(),u?.debug?.log("BackgroundStrategyRegistry","Strategy registry destroyed")}}});var xt,Tc,Pc,Ac,Yh,rs=y(()=>{"use strict";L();ue();x();Fe();is();ae();as();Ba();xt=class{constructor(e,t){this.initialized=!1;this.processingState={isProcessing:!1,currentTrackUri:null,lastExtractedColors:null,lastProcessedResult:null,lastProcessingTime:0,processingQueue:[],queueSize:0};this.metrics={totalExtractions:0,totalProcessed:0,totalApplied:0,averageProcessingTime:0,successRate:0,errorCount:0,lastProcessingTime:0,oklabCoordinations:0,strategySelections:0,cacheHits:0};this.processingTimeout=null;this.PROCESSING_TIMEOUT_MS=1e4;this.MAX_QUEUE_SIZE=10;this.processingCache=new Map;this.CACHE_TTL_MS=3e4;this.settingsManager=e||new ee,this.performanceAnalyzer=t||null,this.deviceCapabilityDetector=new N,this.strategyRegistry=new Ii,this.strategySelector=new ct,this.oklabProcessor=new M,this.musicalOKLABCoordinator=new xi(!0)}async initialize(){if(!this.initialized)try{await this.deviceCapabilityDetector.initialize(),this.setupEventSubscriptions(),this.registerDefaultStrategies(),this.initialized=!0,u?.debug?.log("UnifiedColorProcessingEngine","\u{1F3A8} Unified color processing engine initialized")}catch(e){throw u?.debug?.error("UnifiedColorProcessingEngine","Failed to initialize:",e),e}}async healthCheck(){let e=[];return this.initialized||e.push("Engine not initialized"),this.processingState.isProcessing&&Date.now()-this.processingState.lastProcessingTime>this.PROCESSING_TIMEOUT_MS&&e.push("Processing appears stuck"),this.metrics.errorCount>0&&this.metrics.successRate<.8&&e.push(`Low success rate: ${(this.metrics.successRate*100).toFixed(1)}%`),this.processingState.queueSize>this.MAX_QUEUE_SIZE&&e.push(`Queue overflow: ${this.processingState.queueSize} items`),{healthy:e.length===0,ok:e.length===0,details:`Unified color processing - ${this.metrics.totalProcessed} processed, ${this.metrics.successRate.toFixed(2)} success rate`,issues:e,system:"UnifiedColorProcessingEngine"}}updateAnimation(e){this.processingCache.size>50&&this.cleanupCache()}destroy(){this.processingTimeout&&(clearTimeout(this.processingTimeout),this.processingTimeout=null),this.processingState.processingQueue=[],this.processingCache.clear(),p.unsubscribeAll("UnifiedColorProcessingEngine"),this.initialized=!1}setupEventSubscriptions(){p.subscribe("colors:extracted",e=>{this.handleColorExtraction(e)},"UnifiedColorProcessingEngine"),p.subscribe("settings:changed",e=>{this.handleSettingsChange(e)},"UnifiedColorProcessingEngine")}async processColors(e){let t=performance.now();try{let i=this.generateCacheKey(e),a=this.getCachedResult(i);if(a)return this.metrics.cacheHits++,a;let r=await this.selectOptimalStrategy(e);this.metrics.strategySelections++;let n=await this.processWithOKLAB(e,r),s=performance.now()-t;this.updateMetrics(s,!0);let o={...n,processingTime:s,strategy:r,success:!0,timestamp:Date.now(),coordinationMetrics:{detectedGenre:e.musicData?.genre||"unknown",emotionalState:e.musicData?.energy?this.classifyEmotionalState(e.musicData.energy):"neutral",oklabPreset:this.determineOKLABPreset(e),coordinationStrategy:r.getStrategyName(),musicInfluenceStrength:e.musicData?.energy||.5}};return this.cacheResult(i,o),p.emit("colors:harmonized",{processedColors:n.processedColors,accentHex:n.accentHex||"#cba6f7",accentRgb:n.accentRgb||"203,166,247",strategies:[r.getStrategyName()],coordinationMetrics:o.coordinationMetrics,oklabData:o.oklabData,processingTime:s,timestamp:Date.now()}),o}catch(i){let a=performance.now()-t;return this.updateMetrics(a,!1),u?.debug?.error("UnifiedColorProcessingEngine","Processing failed:",i),this.createFallbackResult(e,i)}}async handleColorExtraction(e){return"rawColors"in e&&"trackUri"in e?this.processColorContext(e):this.handleColorExtractionEvent(e)}async processColorContext(e){this.metrics.totalExtractions++;try{if(this.processingState.isProcessing){this.addToQueue(e);return}await this.processWithTimeout(e)}catch(t){this.metrics.errorCount++,u?.debug?.error("UnifiedColorProcessingEngine","Color context processing failed:",t)}}async handleColorExtractionEvent(e){this.metrics.totalExtractions++;try{let t={rawColors:e.rawColors,trackUri:e.trackUri,musicData:e.musicData,timestamp:e.timestamp||Date.now()};if(this.processingState.isProcessing){this.addToQueue(t);return}await this.processWithTimeout(t)}catch(t){this.metrics.errorCount++,u?.debug?.error("UnifiedColorProcessingEngine","Color extraction handling failed:",t)}}async processWithOKLAB(e,t){let i={rawColors:e.rawColors,musicData:e.musicData,trackUri:e.trackUri,timestamp:e.timestamp},a=await this.musicalOKLABCoordinator.processMusicalColors(i);this.metrics.oklabCoordinations++;let r=await t.processColors(e),n=await this.enhanceWithOKLAB(r.processedColors,a);return{...r,processedColors:n,metadata:{...r.metadata,oklabPreset:this.determineOKLABPreset(e),oklabCoordination:a}}}async selectOptimalStrategy(e){try{let i=this.deviceCapabilityDetector.getCapabilities(),a={performance:"medium",quality:"enhanced",deviceCapabilities:{hasWebGL:i?.gpu?.supportsWebGL||!0,memoryMB:i?.memory?.total||4096,isMobile:!1},userPreferences:{harmonicMode:"cosmic",intensity:.8,enableAdvancedBlending:!0},settingsContext:{dynamicAccentEnabled:!0,gradientIntensity:"medium",webglEnabled:i?.gpu?.supportsWebGL||!0,webglForceEnabled:!1,visualGuideMode:"enhanced",depthLayersEnabled:!0,visualEffectsLevel:.8,pulsingAnimationEnabled:!0},deviceContext:{supportsWebGL:i?.gpu?.supportsWebGL||!0,performanceLevel:"medium",memoryCapacity:i?.memory?.total||4096,isMobile:!1}},r=this.strategySelector.selectStrategies(e,a);if(r&&r.length>0&&r[0])return r[0]}catch(i){u?.debug?.warn("UnifiedColorProcessingEngine","Strategy selection failed, using fallback:",i)}return{getStrategyName:()=>"fallback",canProcess:i=>!0,getEstimatedProcessingTime:i=>50,processColors:async i=>({processedColors:i.rawColors,accentHex:"#cba6f7",accentRgb:"203,166,247",context:i,metadata:{strategy:"fallback",timestamp:Date.now(),processingTime:0}})}}addToQueue(e){this.processingState.queueSize>=this.MAX_QUEUE_SIZE&&this.processingState.processingQueue.shift(),this.processingState.processingQueue.push(e),this.processingState.queueSize=this.processingState.processingQueue.length}async processQueue(){for(;this.processingState.processingQueue.length>0&&!this.processingState.isProcessing;){let e=this.processingState.processingQueue.shift();this.processingState.queueSize=this.processingState.processingQueue.length,await this.processWithTimeout(e)}}async processWithTimeout(e){this.processingState.isProcessing=!0,this.processingState.lastProcessingTime=Date.now(),this.processingTimeout=window.setTimeout(()=>{u?.debug?.warn("UnifiedColorProcessingEngine","Processing timeout - forcing reset"),this.processingState.isProcessing=!1,this.metrics.errorCount++},this.PROCESSING_TIMEOUT_MS);try{await this.processColors(e),this.metrics.totalProcessed++}finally{this.processingTimeout&&(clearTimeout(this.processingTimeout),this.processingTimeout=null),this.processingState.isProcessing=!1,this.processingState.processingQueue.length>0&&setTimeout(()=>this.processQueue(),0)}}generateCacheKey(e){let t={colors:Object.keys(e.rawColors).sort().join(","),music:e.musicData?.energy||0};return JSON.stringify(t)}getCachedResult(e){let t=this.processingCache.get(e);return t&&Date.now()-t.timestamp<this.CACHE_TTL_MS?t:null}cacheResult(e,t){this.processingCache.set(e,{...t,timestamp:Date.now()})}cleanupCache(){let e=Date.now();for(let[t,i]of this.processingCache.entries())e-i.timestamp>this.CACHE_TTL_MS&&this.processingCache.delete(t)}updateMetrics(e,t){this.metrics.averageProcessingTime=(this.metrics.averageProcessingTime*this.metrics.totalProcessed+e)/(this.metrics.totalProcessed+1),t?this.metrics.successRate=(this.metrics.successRate*this.metrics.totalProcessed+1)/(this.metrics.totalProcessed+1):this.metrics.successRate=this.metrics.successRate*this.metrics.totalProcessed/(this.metrics.totalProcessed+1),this.metrics.lastProcessingTime=Date.now()}async enhanceWithOKLAB(e,t){let i={...e};return t.enhancedColors&&Object.entries(t.enhancedColors).forEach(([a,r])=>{i[`oklab-${a}`]=r}),i}classifyEmotionalState(e){return e>.8?"energetic":e>.6?"upbeat":e>.4?"moderate":e>.2?"calm":"peaceful"}determineOKLABPreset(e){let t=e.musicData?.energy||.5;return t>.8?"high-energy":t>.6?"dynamic":t>.4?"balanced":"ambient"}createFallbackResult(e,t){return{processedColors:{fallback:"#cba6f7"},accentHex:"#cba6f7",accentRgb:"203,166,247",context:e,metadata:{strategy:"fallback",error:t.message,timestamp:Date.now(),processingTime:0}}}registerDefaultStrategies(){}async handleSettingsChange(e){["catppuccin-flavor","catppuccin-accentColor","sn-dynamic-color-intensity"].includes(e.settingKey)&&(this.processingCache.clear(),u?.debug?.log("UnifiedColorProcessingEngine","Cache cleared due to settings change:",e.settingKey))}async handlePerformanceWarning(e){e.memoryUsage>50&&(this.processingCache.clear(),u?.debug?.log("UnifiedColorProcessingEngine","Cache cleared due to memory pressure"))}getMetrics(){return{...this.metrics}}async forceReprocessColors(){if(this.processingCache.clear(),this.processingState.lastExtractedColors){let e={rawColors:this.processingState.lastExtractedColors,trackUri:this.processingState.currentTrackUri||"",timestamp:Date.now()};await this.processColors(e)}}getProcessingState(){return{...this.processingState}}getStatus(){return{isProcessing:this.processingState.isProcessing,queueSize:this.processingState.queueSize}}setSelectionCriteria(e){u?.debug?.log("UnifiedColorProcessingEngine","Strategy selection criteria updated:",e)}},Tc=()=>{let c=globalThis.year3000System;return{settingsManager:c?.settingsManager,performanceAnalyzer:c?.performanceAnalyzer||c?.facadeCoordinator?.getCachedNonVisualSystem?.("PerformanceAnalyzer")}},{settingsManager:Pc,performanceAnalyzer:Ac}=Tc(),Yh=new xt(Pc,Ac)});var Di,ns=y(()=>{"use strict";Me();ae();L();Di=class c{constructor(e,t,i){this.initialized=!1;this.cardQuerySelector=".main-card-card, .main-gridContainer-gridContainer.main-gridContainer-fixedWidth";this.cardEventHandlers=new WeakMap;this.musicSyncService=null;this.currentQualityLevel=null;this.qualityCapabilities=[];this.effectCoordinationCallbacks=new Set;this.config={perspective:1e3,maxRotation:5,scale:1.02,transitionSpeed:"200ms",glowOpacity:.8,selector:".main-card-card, .main-grid-grid > *, .main-shelf-shelf > * > *",depthMultiplier:1.5,musicResponseStrength:.8,beatSyncIntensity:.6,effectIntensityMultiplier:1.2},this.performanceMonitor=e,this.settingsManager=t,this.utils=i,this.cards=document.querySelectorAll(this.config.selector),this.musicTemperatureMapper=new Z(!0),this.oklabProcessor=new M(!0),this.effectPreset=M.getPreset("VIBRANT"),this.effectState={currentMusicMood:"neutral",musicIntensity:.5,beatPhase:0,lastBeatTime:0,effectIntensityLevel:0,dynamicAccentHex:"#cba6f7",dynamicAccentRgb:"203,166,247",overallIntensityLevel:.5},this.boundHandleSettingsChange=this.handleSettingsChange.bind(this)}static getInstance(e,t,i){return c.instance||(c.instance=new c(e,t,i)),c.instance}async initialize(){if(this.initialized)return;let e=this.performanceMonitor.shouldReduceQuality();this.cards=document.querySelectorAll(this.config.selector),await this.applyEventListeners(),await this.initializeMusicIntegration(),this.initializeCrossSystemCoordination(),document.addEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange),this.initialized=!0}async healthCheck(){let e=document.querySelectorAll(this.cardQuerySelector);return e.length>0?{healthy:!0,ok:!0,details:`Found ${e.length} cards to manage.`,issues:[],system:"Card3DManager"}:{healthy:!1,ok:!1,details:"No card elements found with the configured selector.",issues:["No card elements found with the configured selector."],system:"Card3DManager"}}updateAnimation(e){}apply3DMode(e){console.log(`[Card3DManager] Applying 3D mode: ${e}`),e==="disabled"?this.destroy():this.initialize()}get shouldEnable3DEffects(){let e=this.performanceMonitor.shouldReduceQuality(),t=this.settingsManager.get("sn-enable3dCards");return!e&&t!=="disabled"}async applyEventListeners(){this.cards.forEach(e=>{if(this.cardEventHandlers.has(e))return;let t=a=>this.handleMouseMove(e,a),i=()=>this.handleMouseLeave(e);this.cardEventHandlers.set(e,{move:t,leave:i}),e.addEventListener("mousemove",t),e.addEventListener("mouseleave",i)})}handleMouseMove(e,t){if(!this.shouldEnable3DEffects)return;let{clientX:i,clientY:a}=t,{top:r,left:n,width:s,height:o}=e.getBoundingClientRect(),l=i-n,m=a-r,d=this.config.maxRotation*(m-o/2)/(o/2),h=-this.config.maxRotation*(l-s/2)/(s/2);e.style.transform=`perspective(${this.config.perspective}px) rotateX(${d}deg) rotateY(${h}deg) scale3d(${this.config.scale}, ${this.config.scale}, ${this.config.scale})`,e.style.transition=`transform ${this.config.transitionSpeed} ease-out`,this.applyGlow(e,l,m,s,o)}handleMouseLeave(e){e.style.transform="perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)",e.style.transition="transform 600ms ease-in-out",this.removeGlow(e)}applyGlow(e,t,i,a,r){let n=e.querySelector(".card-glow");n||(n=document.createElement("div"),n.className="card-glow",e.appendChild(n));let{dynamicAccentRgb:s,musicIntensity:o,beatPhase:l,effectIntensityLevel:m}=this.effectState,d=this.config.glowOpacity,h=1+(o-.5)*this.config.musicResponseStrength,g=1+Math.sin(l)*this.config.beatSyncIntensity*.3,f=1+m*this.config.effectIntensityMultiplier*.4,S=d*h*g*f,C=Math.max(.1,Math.min(1,S)),w=40+Math.sin(l*.5)*8*this.config.beatSyncIntensity;n.style.background=`radial-gradient(circle at ${t}px ${i}px, 
      rgba(${s}, ${C}) 0%, 
      rgba(${s}, ${C*.6}) 20%, 
      transparent ${w}%)`}removeGlow(e){let t=e.querySelector(".card-glow");t&&(t.style.background="transparent")}destroy(){this.cards.forEach(e=>{let t=this.cardEventHandlers.get(e);t&&(e.removeEventListener("mousemove",t.move),e.removeEventListener("mouseleave",t.leave),this.cardEventHandlers.delete(e)),this.removeGlow(e),e.style.transform="",e.style.transition=""}),this.initialized=!1,document.removeEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange)}handleSettingsChange(e){let{key:t,value:i}=e.detail||{}}async initializeMusicIntegration(){try{p.subscribe("colors:extracted",e=>{this.onColorsExtracted(e)},"Card3DManager"),p.subscribe("colors:harmonized",e=>{this.onColorsHarmonized(e)},"Card3DManager"),p.subscribe("music:beat",e=>{this.onMusicBeat(e)},"Card3DManager"),p.subscribe("music:dramatic-peak-detected",e=>{this.onIntensityEvent(e)},"Card3DManager"),this.updateDynamicAccentColor(),console.log("[Card3DManager] \u2705 Year 3000 music integration initialized")}catch(e){console.error("[Card3DManager] Failed to initialize music integration:",e)}}onColorsExtracted(e){let{rawColors:t,musicData:i}=e;if(i){let a=this.musicTemperatureMapper.mapMusicToEmotionalTemperature(i);this.updateMusicState(a)}}onColorsHarmonized(e){let{processedColors:t,coordinationMetrics:i}=e;if(t.VIBRANT){let a=this.oklabProcessor.processColor(t.VIBRANT,this.effectPreset);this.effectState.dynamicAccentHex=a.enhancedHex,this.effectState.dynamicAccentRgb=`${a.enhancedRgb.r},${a.enhancedRgb.g},${a.enhancedRgb.b}`}i?.overallIntensityLevel!==void 0&&(this.effectState.overallIntensityLevel=i.overallIntensityLevel)}onMusicBeat(e){let{beat:t,intensity:i,timestamp:a}=e;this.effectState.beatPhase+=Math.PI*2*this.config.beatSyncIntensity,this.effectState.lastBeatTime=a||Date.now(),i>.7&&this.applyBeatSyncDepthPulse(i)}onIntensityEvent(e){let{intensity:t,type:i}=e;this.effectState.effectIntensityLevel=t,t>.8&&this.applyEnhancedDepthDistortion(t)}updateMusicState(e){switch(this.effectState.currentMusicMood=e.primaryEmotion,this.effectState.musicIntensity=e.intensity,e.primaryEmotion){case"energetic":case"aggressive":this.effectPreset=M.getPreset("COSMIC");break;case"calm":case"ambient":this.effectPreset=M.getPreset("SUBTLE");break;default:this.effectPreset=M.getPreset("VIBRANT")}}applyBeatSyncDepthPulse(e){let t=1+e*.15*this.config.beatSyncIntensity;this.cards.forEach(i=>{if(i instanceof HTMLElement){let r=(i.style.transform||"").replace(/scale3d\([^)]*\)/,`scale3d(${t}, ${t}, ${t})`);i.style.transform=r||`scale3d(${t}, ${t}, ${t})`,i.style.transition="transform 100ms ease-out",setTimeout(()=>{i.style.transform.includes(`scale3d(${t}`)&&(i.style.transform=i.style.transform.replace(/scale3d\([^)]*\)/,"scale3d(1, 1, 1)"))},200)}})}applyEnhancedDepthDistortion(e){let t=this.config.perspective*(1+e*this.config.effectIntensityMultiplier),i=this.config.maxRotation*(1+e*.8);this.cards.forEach(a=>{if(a instanceof HTMLElement){let r=`perspective(${t}px) rotateX(${i*.3}deg) rotateY(${i*.2}deg)`;a.style.transform=r,a.style.transition="transform 800ms ease-out",setTimeout(()=>{a.style.transform="perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)",a.style.transition="transform 1200ms ease-in-out"},1500)}})}updateDynamicAccentColor(){let e=document.documentElement,t=getComputedStyle(e),i=t.getPropertyValue("--sn-dynamic-accent-hex").trim()||t.getPropertyValue("--sn-color-accent-hex").trim()||t.getPropertyValue("--spice-accent").trim(),a=t.getPropertyValue("--sn-dynamic-accent-rgb").trim()||t.getPropertyValue("--sn-color-accent-rgb").trim()||t.getPropertyValue("--spice-rgb-accent").trim();i&&i!==""&&(this.effectState.dynamicAccentHex=i),a&&a!==""&&(this.effectState.dynamicAccentRgb=a)}setMusicSyncService(e){this.musicSyncService=e}getEffectState(){return{...this.effectState}}setQualityLevel(e){switch(this.currentQualityLevel=e,e){case"low":this.config.perspective=900,this.config.maxRotation=3,this.config.depthMultiplier=1.2,this.config.musicResponseStrength=.5,this.config.beatSyncIntensity=.4,this.config.effectIntensityMultiplier=.8;break;case"medium":this.config.perspective=1e3,this.config.maxRotation=5,this.config.depthMultiplier=1.5,this.config.musicResponseStrength=.8,this.config.beatSyncIntensity=.6,this.config.effectIntensityMultiplier=1.2;break;case"high":this.config.perspective=1200,this.config.maxRotation=7,this.config.depthMultiplier=1.8,this.config.musicResponseStrength=1,this.config.beatSyncIntensity=.8,this.config.effectIntensityMultiplier=1.5;break;default:this.config.perspective=1e3,this.config.maxRotation=5,this.config.depthMultiplier=1.5,this.config.musicResponseStrength=.8,this.config.beatSyncIntensity=.6,this.config.effectIntensityMultiplier=1.2;break}console.log(`[Card3DManager] Quality level set to: ${e}`)}adjustQuality(e){this.setQualityLevel(e)}getPerformanceImpact(){let e=this.cards.length,t=e*.1,i=this.config.depthMultiplier*.2,a=this.config.musicResponseStrength*.15,r=this.config.effectIntensityMultiplier*.1;return{fps:60,frameTime:t+i+a+r,memoryUsage:e*.05,cpuUsage:(t+i)*100}}reduceQuality(e){this.currentQualityLevel&&(this.config.depthMultiplier=Math.max(.5,this.config.depthMultiplier-e),this.config.musicResponseStrength=Math.max(.1,this.config.musicResponseStrength-e),this.config.beatSyncIntensity=Math.max(.1,this.config.beatSyncIntensity-e),this.config.effectIntensityMultiplier=Math.max(.5,this.config.effectIntensityMultiplier-e),console.log(`[Card3DManager] Quality reduced by ${e}`))}increaseQuality(e){this.currentQualityLevel&&(this.config.depthMultiplier=Math.min(2,this.config.depthMultiplier+e),this.config.musicResponseStrength=Math.min(1.5,this.config.musicResponseStrength+e),this.config.beatSyncIntensity=Math.min(1,this.config.beatSyncIntensity+e),this.config.effectIntensityMultiplier=Math.min(2,this.config.effectIntensityMultiplier+e),console.log(`[Card3DManager] Quality increased by ${e}`))}getQualityCapabilities(){return this.qualityCapabilities.length===0&&(this.qualityCapabilities=[{name:"3D Perspective",enabled:!0,qualityLevel:"medium"},{name:"Music-Reactive Glow",enabled:!0,qualityLevel:"low"},{name:"Beat Sync Effects",enabled:!0,qualityLevel:"low"},{name:"Intensity Distortion",enabled:!0,qualityLevel:"medium"},{name:"Music Modulation",enabled:!0,qualityLevel:"low"}]),this.qualityCapabilities}async refreshColorState(e){try{if(this.updateDynamicAccentColor(),this.effectState.dynamicAccentHex){let t=this.oklabProcessor.processColor(this.effectState.dynamicAccentHex,this.effectPreset);this.effectState.dynamicAccentHex=t.enhancedHex,this.effectState.dynamicAccentRgb=`${t.enhancedRgb.r},${t.enhancedRgb.g},${t.enhancedRgb.b}`}console.log(`[Card3DManager] Color state refreshed for trigger: ${e}`)}catch(t){console.error("[Card3DManager] Error refreshing color state:",t)}}onEffectCoordination(e){return this.effectCoordinationCallbacks.add(e),()=>{this.effectCoordinationCallbacks.delete(e)}}synchronizeEffectState(e){e.currentMusicMood&&(this.effectState.currentMusicMood=e.currentMusicMood),e.musicIntensity!==void 0&&(this.effectState.musicIntensity=e.musicIntensity),e.beatPhase!==void 0&&(this.effectState.beatPhase=e.beatPhase),e.effectIntensityLevel!==void 0&&(this.effectState.effectIntensityLevel=e.effectIntensityLevel),e.overallIntensityLevel!==void 0&&(this.effectState.overallIntensityLevel=e.overallIntensityLevel),e.dynamicAccentHex&&(this.effectState.dynamicAccentHex=e.dynamicAccentHex),e.dynamicAccentRgb&&(this.effectState.dynamicAccentRgb=e.dynamicAccentRgb),this.broadcastEffectState()}broadcastEffectState(){this.effectCoordinationCallbacks.forEach(e=>{try{e(this.effectState)}catch(t){console.error("[Card3DManager] Error in effect coordination callback:",t)}})}updateMusicStateWithCoordination(e){this.updateMusicState(e),this.broadcastEffectState(),p.emit("visual-effects:coordination",{source:"Card3DManager",state:this.convertToVisualEffectsState(this.effectState),timestamp:Date.now()})}onMusicBeatWithCoordination(e){this.onMusicBeat(e),this.broadcastEffectState(),p.emit("music:beat-sync",{source:"Card3DManager",beatPhase:this.effectState.beatPhase,lastBeatTime:this.effectState.lastBeatTime,timestamp:Date.now()})}onIntensityEventWithCoordination(e){this.onIntensityEvent(e),this.broadcastEffectState(),p.emit("music:dramatic-sync",{source:"Card3DManager",dramaticLevel:this.effectState.effectIntensityLevel,type:e.type,timestamp:Date.now()})}initializeCrossSystemCoordination(){try{p.subscribe("visual-effects:coordination",e=>{e.source!=="Card3DManager"&&this.synchronizeEffectState(this.convertFromVisualEffectsState(e.state))},"Card3DManager"),p.subscribe("music:beat-sync",e=>{e.source!=="Card3DManager"&&(this.effectState.beatPhase=e.beatPhase,this.effectState.lastBeatTime=e.lastBeatTime)},"Card3DManager"),p.subscribe("music:dramatic-sync",e=>{e.source!=="Card3DManager"&&(this.effectState.effectIntensityLevel=e.dramaticLevel)},"Card3DManager"),console.log("[Card3DManager] \u2705 Cross-system effect coordination initialized")}catch(e){console.error("[Card3DManager] Failed to initialize cross-system coordination:",e)}}convertToVisualEffectsState(e){return{intensity:e.effectIntensityLevel,colorTemperature:6500,animationScale:e.musicIntensity,dominantEmotion:e.currentMusicMood,resonance:e.musicIntensity,symbioticResonance:e.musicIntensity,surfaceFluidityIndex:e.musicIntensity,animationScaleRate:e.effectIntensityLevel,emotionalTemperature:6500,pulsingCycle:e.beatPhase,cinematicIntensity:e.effectIntensityLevel}}convertFromVisualEffectsState(e){return{currentMusicMood:e.dominantEmotion,musicIntensity:e.intensity,effectIntensityLevel:e.intensity,overallIntensityLevel:e.intensity}}}});var ir,ar,ss=y(()=>{"use strict";ir=class c{constructor(){this.observers=new Map;this.trackedElements=new Map;this.isSupported=typeof IntersectionObserver<"u",this.isSupported||console.warn("[ViewportAwarenessManager] IntersectionObserver not supported, falling back to always-visible behavior")}static getInstance(){return c.instance||(c.instance=new c),c.instance}trackElement(e,t,i={}){if(!this.isSupported){let o={isVisible:!0,intersectionRatio:1,lastVisibilityChange:Date.now(),element:e};return t(o),()=>{}}let a={visibilityThreshold:.1,rootMargin:"50px",trackRootElement:!1,...i},r=this.getObserverKey(a),n=this.observers.get(r);n||(n=new IntersectionObserver(o=>this.handleIntersectionChanges(o),{threshold:a.visibilityThreshold,rootMargin:a.rootMargin,root:a.rootSelector?document.querySelector(a.rootSelector):null}),this.observers.set(r,n));let s={isVisible:!1,intersectionRatio:0,lastVisibilityChange:Date.now(),element:e};return this.trackedElements.set(e,{callback:t,options:a,state:s}),n.observe(e),()=>this.untrackElement(e)}isElementVisible(e){return this.trackedElements.get(e)?.state.isVisible??!0}getVisibilityState(e){return this.trackedElements.get(e)?.state??null}untrackElement(e){let t=this.trackedElements.get(e);if(!t)return;let i=this.getObserverKey(t.options),a=this.observers.get(i);a&&a.unobserve(e),this.trackedElements.delete(e)}trackSpotifyContainer(e){let t=[".Root__main-view",'[data-testid="topbar"]',".main-view-container","#main"],i=null;for(let a of t)if(i=document.querySelector(a),i)break;return i||(console.warn("[ViewportAwarenessManager] Could not find Spotify main container, using document.body"),i=document.body),this.trackElement(i,e,{visibilityThreshold:.1,rootMargin:"0px",trackRootElement:!0})}checkBulkVisibility(e){let t=new Map;for(let i of e)t.set(i,this.isElementVisible(i));return t}destroy(){for(let e of this.observers.values())e.disconnect();this.observers.clear(),this.trackedElements.clear()}handleIntersectionChanges(e){for(let t of e){let i=this.trackedElements.get(t.target);if(!i)continue;let a=i.state.isVisible,r=t.isIntersecting;if(i.state={isVisible:r,intersectionRatio:t.intersectionRatio,lastVisibilityChange:a!==r?Date.now():i.state.lastVisibilityChange,element:t.target},a!==r)try{i.callback(i.state)}catch(n){console.error("[ViewportAwarenessManager] Error in visibility callback:",n)}}}getObserverKey(e){return`${e.visibilityThreshold}-${e.rootMargin}-${e.rootSelector||"viewport"}`}},ar=ir.getInstance()});var ki,os=y(()=>{"use strict";ss();L();ki=class{constructor(e={}){this.initialized=!1;this.isVisible=!0;this.visibilityState=null;this.animationsPaused=!1;this.settingsUpdatesPaused=!1;this.viewportOptions={visibilityThreshold:.1,rootMargin:"50px",pauseAnimationsWhenHidden:!0,pauseSettingsUpdatesWhenHidden:!0,resumeDelay:100,...e}}async initialize(){await this.initializeViewportTracking(),await this.initializeEventSubscriptions(),await this.initializeSystem(),this.initialized=!0}async healthCheck(){let e=await this.performHealthCheck();return{...e,details:`${e.details} | Viewport: ${this.isVisible?"visible":"hidden"}`}}updateAnimation(e){this.shouldSkipAnimationUpdate()||this.performAnimationUpdate(e)}destroy(){this.cleanupViewportTracking(),this.cleanupEventSubscriptions(),this.performDestroy()}handleSettingsChange(e){this.shouldSkipSettingsUpdate()||this.performSettingsUpdate(e)}forceRepaint(e){this.performForceRepaint?.(e)}onVisibilityChanged(e){}onBecomingVisible(){}onBecomingHidden(){}async initializeViewportTracking(){let e=null;this.viewportOptions.trackingSelector&&(e=document.querySelector(this.viewportOptions.trackingSelector)),e?this.untrackViewport=ar.trackElement(e,t=>this.handleVisibilityChange(t),this.viewportOptions):this.untrackViewport=ar.trackSpotifyContainer(t=>this.handleVisibilityChange(t))}async initializeEventSubscriptions(){this.settingsSubscriptionId=p.subscribe("settings:changed",e=>this.handleUnifiedSettingsChange(e),`ViewportAwareSystem-${this.constructor.name}`)}cleanupEventSubscriptions(){this.settingsSubscriptionId&&(p.unsubscribe(this.settingsSubscriptionId),delete this.settingsSubscriptionId)}handleUnifiedSettingsChange(e){if(this.shouldSkipSettingsUpdate())return;let t=new CustomEvent("year3000SystemSettingsChanged",{detail:{key:e.settingKey,value:e.newValue}});this.performSettingsUpdate(t)}handleVisibilityChange(e){let t=this.isVisible;this.isVisible=e.isVisible,this.visibilityState=e,!t&&this.isVisible?this.handleBecomingVisible():t&&!this.isVisible&&this.handleBecomingHidden(),this.onVisibilityChanged(e)}handleBecomingVisible(){this.resumeTimeoutId&&clearTimeout(this.resumeTimeoutId),this.resumeTimeoutId=window.setTimeout(()=>{this.animationsPaused=!1,this.settingsUpdatesPaused=!1,this.onBecomingVisible()},this.viewportOptions.resumeDelay||100)}handleBecomingHidden(){this.viewportOptions.pauseAnimationsWhenHidden&&(this.animationsPaused=!0),this.viewportOptions.pauseSettingsUpdatesWhenHidden&&(this.settingsUpdatesPaused=!0),this.onBecomingHidden()}shouldSkipAnimationUpdate(){return this.animationsPaused||!this.isVisible&&(this.viewportOptions.pauseAnimationsWhenHidden??!0)}shouldSkipSettingsUpdate(){return this.settingsUpdatesPaused||!this.isVisible&&(this.viewportOptions.pauseSettingsUpdatesWhenHidden??!0)}cleanupViewportTracking(){this.untrackViewport&&(this.untrackViewport(),delete this.untrackViewport),this.resumeTimeoutId&&(clearTimeout(this.resumeTimeoutId),delete this.resumeTimeoutId)}getVisibilityInfo(){return{isVisible:this.isVisible,animationsPaused:this.animationsPaused,settingsUpdatesPaused:this.settingsUpdatesPaused,...this.visibilityState?.intersectionRatio!==void 0&&{intersectionRatio:this.visibilityState.intersectionRatio}}}}});var Li,cs=y(()=>{"use strict";U();ei();$();os();X();Me();ae();L();Li=class c extends ki{constructor(t=E,i=D,a=null,r=null,n,s={}){super({visibilityThreshold:.2,pauseAnimationsWhenHidden:!1,pauseSettingsUpdatesWhenHidden:!0,resumeDelay:50,...s});this.cssBatcher=null;this.performanceAnalyzer=null;this.observers=[];this.musicSyncService=null;this.currentQualityLevel=null;this.qualityCapabilities=[];this.effectCoordinationCallbacks=new Set;this.config=t,this.utils=i,this.cssBatcher=a,this.performanceAnalyzer=r,this.settingsManager=n,this.isSupported=this.detectBackdropFilterSupport(),this.currentIntensity="balanced",this.musicTemperatureMapper=new Z(!0),this.oklabProcessor=new M(!0),this.effectPreset=M.getPreset("STANDARD"),this.effectState={currentMusicMood:"neutral",musicIntensity:.5,beatPhase:0,lastBeatTime:0,effectIntensityLevel:0,dynamicAccentHex:"#cba6f7",dynamicAccentRgb:"203,166,247",overallIntensityLevel:.5,genreStyle:"standard",animationRate:1}}static getInstance(){if(!c.instance)throw new Error("GlassmorphismManager instance not initialized");return c.instance}async initializeSystem(){let t=globalThis.year3000System;this.cssController=t?.cssConsciousnessController||P();let i=this.settingsManager.get("sn-glassmorphism-level");this.applyGlassmorphismSettings(i),await this.initializeMusicIntegration()}async performHealthCheck(){return{healthy:!0,ok:!0,details:"GlassmorphismManager is operational.",issues:[],system:"GlassmorphismManager"}}performAnimationUpdate(t){}performDestroy(){this.observers.forEach(t=>t.disconnect()),this.observers=[]}performSettingsUpdate(t){let i=t,{key:a,value:r}=i.detail||{};a===Zr&&(this.applyGlassmorphismSettings(r),this.updateGlassVariables(this.currentIntensity))}onBecomingVisible(){if(this.currentIntensity!=="disabled"){let t=document.documentElement,a=getComputedStyle(t).getPropertyValue("--spice-rgb-accent").trim();a&&a!==""&&this.updateGlassColors(`rgb(${a})`,`rgb(${a})`)}}onBecomingHidden(){}detectBackdropFilterSupport(){try{return CSS.supports("backdrop-filter","blur(1px)")||CSS.supports("-webkit-backdrop-filter","blur(1px)")}catch(t){return console.warn("StarryNight: CSS.supports not available, assuming no backdrop-filter support",t),!1}}applyGlassmorphismSettings(t){let i=document.body;i.classList.remove("sn-glass-disabled","sn-glass-minimal","sn-glass-balanced","sn-glass-intense"),i.classList.add(`sn-glass-${t}`),this.currentIntensity=t,this.updateGlassVariables(t)}updateGlassVariables(t){let i=document.documentElement,a=this.performanceAnalyzer?.shouldReduceQuality()||!1,r,n,s;switch(t){case"disabled":i.style.removeProperty("--glass-blur"),i.style.removeProperty("--glass-opacity"),i.style.removeProperty("--glass-saturation");return;case"minimal":r=a?"2px":"3px",n="0.05",s="1.05";break;case"moderate":r=a?"3px":"5px",n="0.08",s="1.15";break;case"intense":r=a?"6px":"8px",n="0.15",s="1.4";break;case"balanced":default:r=a?"4px":"6px",n="0.1",s="1.2";break}let o=this.calculateMusicModulations(),l=this.modulateBlurValue(r,o),m=this.modulateOpacityValue(n,o),d=this.modulateSaturationValue(s,o),h={"--glass-blur":l,"--glass-opacity":m,"--glass-saturation":d,"--glass-animation-rate":`${this.effectState.animationRate}s`,"--glass-visual-effects-level":this.effectState.overallIntensityLevel.toString()};this.cssController.batchSetVariables("GlassmorphismManager",h,"high","glass-properties-update")}updateGlassColors(t,i){if(this.currentIntensity==="disabled")return;let a=this.convertToGlassColor(t,.1),r=this.convertToGlassColor(i,.08),n={"--glass-background":a,"--glass-border":r};this.cssController.batchSetVariables("GlassmorphismManager",n,"high","glass-color-update")}convertToGlassColor(t,i){try{if(typeof t!="string")return this.getThemeAwareFallback(i);if(t.startsWith("rgb")){let a=t.match(/\d+/g);if(a&&a.length>=3)return`rgba(${a[0]}, ${a[1]}, ${a[2]}, ${i})`}if(t.startsWith("#")){let a=t.slice(1),r=parseInt(a.substring(0,2),16),n=parseInt(a.substring(2,4),16),s=parseInt(a.substring(4,6),16);if(!isNaN(r)&&!isNaN(n)&&!isNaN(s))return`rgba(${r}, ${n}, ${s}, ${i})`}return this.getThemeAwareFallback(i)}catch{return this.getThemeAwareFallback(i)}}getThemeAwareFallback(t){let i=document.documentElement,a=getComputedStyle(i);if(this.effectState.dynamicAccentRgb&&this.effectState.dynamicAccentRgb!=="203,166,247")return`rgba(${this.effectState.dynamicAccentRgb}, ${t})`;let r=a.getPropertyValue("--sn-dynamic-accent-rgb").trim()||a.getPropertyValue("--sn-color-accent-rgb").trim()||a.getPropertyValue("--spice-rgb-accent").trim();if(r&&r!==""&&!r.includes("undefined"))return`rgba(${r}, ${t})`;let n=a.getPropertyValue("--spice-rgb-text").trim();return n&&n!==""&&!n.includes("undefined")?`rgba(${n}, ${t})`:`rgba(203, 166, 247, ${t})`}async initializeMusicIntegration(){try{p.subscribe("colors:extracted",t=>{this.onColorsExtracted(t)},"GlassmorphismManager"),p.subscribe("colors:harmonized",t=>{this.onColorsHarmonized(t)},"GlassmorphismManager"),p.subscribe("music:beat",t=>{this.onMusicBeat(t)},"GlassmorphismManager"),p.subscribe("music:dramatic-peak-detected",t=>{this.onCinematicDramaEvent(t)},"GlassmorphismManager"),this.updateDynamicAccentColor(),this.initializeCrossSystemCoordination(),console.log("[GlassmorphismManager] \u2705 Year 3000 visual-effects integration initialized")}catch(t){console.error("[GlassmorphismManager] Failed to initialize visual-effects integration:",t)}}calculateMusicModulations(){let{musicIntensity:t,beatPhase:i,effectIntensityLevel:a,overallIntensityLevel:r}=this.effectState,n=1+(t-.5)*.4,s=1+Math.sin(i)*r*.15,o=1+a*.3,l=1+Math.sin(Date.now()*this.effectState.animationRate*.001)*.08;return{musicModulation:n,beatModulation:s,cinematicModulation:o,animationModulation:l}}modulateBlurValue(t,i){let a=parseFloat(t.replace("px","")),{musicModulation:r,beatModulation:n,animationModulation:s}=i,o=a*r*n*s;return`${Math.max(1,Math.round(o))}px`}modulateOpacityValue(t,i){let a=parseFloat(t),{musicModulation:r,cinematicModulation:n,animationModulation:s}=i,o=a*(1+(r-1)*.5)*n*s;return Math.max(.01,Math.min(1,o)).toFixed(3)}modulateSaturationValue(t,i){let a=parseFloat(t),{musicModulation:r,beatModulation:n,cinematicModulation:s}=i,o=a*r*n*s;return Math.max(1,Math.min(3,o)).toFixed(2)}onColorsExtracted(t){let{rawColors:i,musicData:a}=t;if(a){let r=this.musicTemperatureMapper.mapMusicToEmotionalTemperature(a);this.updateMusicState(r)}}onColorsHarmonized(t){let{processedColors:i,coordinationMetrics:a}=t;if(i.VIBRANT){let r=this.oklabProcessor.processColor(i.VIBRANT,this.effectPreset);this.effectState.dynamicAccentHex=r.enhancedHex,this.effectState.dynamicAccentRgb=`${r.enhancedRgb.r},${r.enhancedRgb.g},${r.enhancedRgb.b}`,this.updateGlassColors(r.enhancedHex,r.enhancedHex)}a?.overallIntensityLevel!==void 0&&(this.effectState.overallIntensityLevel=a.overallIntensityLevel)}onMusicBeat(t){let{beat:i,intensity:a,timestamp:r}=t;this.effectState.beatPhase+=Math.PI*2*.5,this.effectState.lastBeatTime=r||Date.now(),a>.8&&this.currentIntensity!=="disabled"&&this.applyBeatSyncGlassPulse(a)}onCinematicDramaEvent(t){let{intensity:i,type:a}=t;this.effectState.effectIntensityLevel=i,i>.7&&this.currentIntensity!=="disabled"&&this.applyDramaticGlassDistortion(i)}updateMusicState(t){switch(this.effectState.currentMusicMood=t.primaryEmotion,this.effectState.musicIntensity=t.intensity,t.primaryEmotion){case"energetic":case"aggressive":this.effectState.animationRate=1.5,this.effectPreset=M.getPreset("COSMIC");break;case"calm":case"ambient":this.effectState.animationRate=.7,this.effectPreset=M.getPreset("SUBTLE");break;default:this.effectState.animationRate=1,this.effectPreset=M.getPreset("STANDARD")}}applyBeatSyncGlassPulse(t){if(!this.cssBatcher||!!1)return;let a=this.getIntensityValue(this.currentIntensity),r=t*2*(a.opacity*10),n=t*.05*a.opacity;this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-blur",`${r}px`),this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-opacity",n.toString()),setTimeout(()=>{this.cssBatcher&&(this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-blur","0px"),this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-opacity","0"))},150)}applyDramaticGlassDistortion(t){if(!this.cssBatcher)return;let i=t*4,a=1+t*.5;this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-blur",`${i}px`),this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-saturation",a.toString()),setTimeout(()=>{this.cssBatcher&&(this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-blur","0px"),this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-saturation","1"))},1200)}updateDynamicAccentColor(){let t=document.documentElement,i=getComputedStyle(t),a=i.getPropertyValue("--sn-dynamic-accent-hex").trim()||i.getPropertyValue("--sn-color-accent-hex").trim()||i.getPropertyValue("--spice-accent").trim(),r=i.getPropertyValue("--sn-dynamic-accent-rgb").trim()||i.getPropertyValue("--sn-color-accent-rgb").trim()||i.getPropertyValue("--spice-rgb-accent").trim();a&&a!==""&&(this.effectState.dynamicAccentHex=a),r&&r!==""&&(this.effectState.dynamicAccentRgb=r)}getConsciousnessState(){return{...this.effectState}}setQualityLevel(t){this.adjustQuality(t)}adjustQuality(t){this.currentQualityLevel=t;let i;switch(t){case"low":i="minimal";break;case"medium":i="balanced";break;case"high":i="intense";break;default:i="balanced";break}this.applyGlassmorphismSettings(i),console.log(`[GlassmorphismManager] Quality level set to: ${t} (intensity: ${i})`)}getPerformanceImpact(){let t=this.currentIntensity==="disabled"?0:this.currentIntensity==="minimal"?.1:this.currentIntensity==="balanced"?.3:this.currentIntensity==="intense"?.5:.2,i=this.effectState.overallIntensityLevel*.1,a=this.effectState.animationRate>1?.05:0;return{fps:60,frameTime:t+i+a,memoryUsage:t*2,cpuUsage:(t+i)*50}}reduceQuality(t){if(this.currentQualityLevel){if(this.effectState.overallIntensityLevel=Math.max(.1,this.effectState.overallIntensityLevel-t),this.effectState.animationRate=Math.max(.5,this.effectState.animationRate-t*.5),t>.5)switch(this.currentIntensity){case"intense":this.applyGlassmorphismSettings("balanced");break;case"balanced":this.applyGlassmorphismSettings("minimal");break;case"minimal":this.applyGlassmorphismSettings("disabled");break}console.log(`[GlassmorphismManager] Quality reduced by ${t}`)}}increaseQuality(t){if(this.currentQualityLevel){if(this.effectState.overallIntensityLevel=Math.min(1,this.effectState.overallIntensityLevel+t),this.effectState.animationRate=Math.min(2,this.effectState.animationRate+t*.5),t>.5)switch(this.currentIntensity){case"disabled":this.applyGlassmorphismSettings("minimal");break;case"minimal":this.applyGlassmorphismSettings("balanced");break;case"balanced":this.applyGlassmorphismSettings("intense");break}console.log(`[GlassmorphismManager] Quality increased by ${t}`)}}getQualityCapabilities(){return this.qualityCapabilities.length===0&&(this.qualityCapabilities=[{name:"Backdrop Filter Blur",enabled:this.isSupported&&this.currentIntensity!=="disabled",qualityLevel:"high"},{name:"Glass Saturation",enabled:this.currentIntensity!=="disabled",qualityLevel:"low"},{name:"Consciousness Breathing",enabled:!0,qualityLevel:"low"},{name:"Beat Sync Pulse",enabled:!0,qualityLevel:"low"},{name:"Dramatic Distortion",enabled:!0,qualityLevel:"medium"}]),this.qualityCapabilities}async refreshColorState(t){try{if(this.updateDynamicAccentColor(),this.effectState.dynamicAccentHex){let i=this.oklabProcessor.processColor(this.effectState.dynamicAccentHex,this.effectPreset);this.effectState.dynamicAccentHex=i.enhancedHex,this.effectState.dynamicAccentRgb=`${i.enhancedRgb.r},${i.enhancedRgb.g},${i.enhancedRgb.b}`,this.updateGlassColors(i.enhancedHex,i.enhancedHex)}console.log(`[GlassmorphismManager] Color state refreshed for trigger: ${t}`)}catch(i){console.error("[GlassmorphismManager] Error refreshing color state:",i)}}onConsciousnessCoordination(t){return this.effectCoordinationCallbacks.add(t),()=>{this.effectCoordinationCallbacks.delete(t)}}synchronizeConsciousnessState(t){t.currentMusicMood&&(this.effectState.currentMusicMood=t.currentMusicMood),t.musicIntensity!==void 0&&(this.effectState.musicIntensity=t.musicIntensity),t.beatPhase!==void 0&&(this.effectState.beatPhase=t.beatPhase),t.effectIntensityLevel!==void 0&&(this.effectState.effectIntensityLevel=t.effectIntensityLevel),t.overallIntensityLevel!==void 0&&(this.effectState.overallIntensityLevel=t.overallIntensityLevel),t.dynamicAccentHex&&(this.effectState.dynamicAccentHex=t.dynamicAccentHex),t.dynamicAccentRgb&&(this.effectState.dynamicAccentRgb=t.dynamicAccentRgb),t.genreStyle&&(this.effectState.genreStyle=t.genreStyle),t.animationRate!==void 0&&(this.effectState.animationRate=t.animationRate),this.updateGlassVariables(this.currentIntensity),this.broadcastConsciousnessState()}broadcastConsciousnessState(){this.effectCoordinationCallbacks.forEach(t=>{try{t(this.effectState)}catch(i){console.error("[GlassmorphismManager] Error in visual-effects coordination callback:",i)}})}updateMusicStateWithCoordination(t){this.updateMusicState(t),this.broadcastConsciousnessState(),p.emit("visual-effects:coordination",{source:"GlassmorphismManager",state:this.convertToVisualEffectsState(this.effectState),timestamp:Date.now()})}onMusicBeatWithCoordination(t){this.onMusicBeat(t),this.broadcastConsciousnessState(),p.subscribe("music:beat-sync",i=>{i.source!=="GlassmorphismManager"&&(this.effectState.beatPhase=i.beatPhase,this.effectState.lastBeatTime=i.lastBeatTime)},"GlassmorphismManager")}onCinematicDramaEventWithCoordination(t){this.onCinematicDramaEvent(t),this.broadcastConsciousnessState(),p.subscribe("music:dramatic-sync",i=>{i.source!=="GlassmorphismManager"&&(this.effectState.effectIntensityLevel=i.dramaticLevel,i.dramaticLevel>.7&&this.applyDramaticGlassDistortion(i.dramaticLevel))},"GlassmorphismManager")}initializeCrossSystemCoordination(){try{p.subscribe("visual-effects:coordination",t=>{t.source!=="GlassmorphismManager"&&this.synchronizeConsciousnessState(this.convertFromVisualEffectsState(t.state))},"GlassmorphismManager"),p.subscribe("music:beat-sync",t=>{t.source!=="GlassmorphismManager"&&(this.effectState.beatPhase=t.beatPhase,this.effectState.lastBeatTime=t.lastBeatTime,this.applyCoordinatedBeatPulse(t.beatPhase))},"GlassmorphismManager"),p.subscribe("music:dramatic-sync",t=>{t.source!=="GlassmorphismManager"&&(this.effectState.effectIntensityLevel=t.dramaticLevel,this.applyCoordinatedDramaticEffects(t.dramaticLevel,t.type||"unknown"))},"GlassmorphismManager"),console.log("[GlassmorphismManager] \u2705 Cross-system visual-effects coordination initialized")}catch(t){console.error("[GlassmorphismManager] Failed to initialize cross-system coordination:",t)}}checkPerformanceAndAdjust(){this.performanceAnalyzer?.shouldReduceQuality()&&(this.currentIntensity==="intense"?this.applyGlassmorphismSettings("balanced"):(this.currentIntensity==="balanced"||this.currentIntensity==="moderate")&&this.applyGlassmorphismSettings("minimal"))}applyGlassmorphism(t){let i=this.config.glassmorphism[t];this.cssBatcher&&(this.cssBatcher.queueCSSVariableUpdate("--sn-glass-display",t==="disabled"?"none":"block"),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-blur",`${i.blur}px`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-saturation",`${i.saturation}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-brightness",`${i.brightness}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-noise-opacity",`${i.noiseOpacity}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-border-opacity",`${i.borderOpacity}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-shadow-opacity",`${i.shadowOpacity}`),this.cssBatcher.flushCSSVariableBatch(),this.config.enableDebug&&console.log(`\u{1F48E} [GlassmorphismManager] Applied level: ${t}`))}applyUpdatedSettings(t,i){t==="sn-glassmorphism-level"&&(this.applyGlassmorphismSettings(i),this.updateGlassVariables(this.currentIntensity))}applyCoordinatedBeatPulse(t){let i=this.calculateMusicModulations(),a=this.getIntensityValue(this.currentIntensity),r=1+Math.sin(t)*.15*i.beatModulation,n=a.opacity*r;this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-opacity",n.toString()),this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-accent-opacity",(n*.8).toString()),this.cssBatcher?.flushCSSVariableBatch()}applyCoordinatedDramaticEffects(t,i){let a=this.calculateMusicModulations(),r=this.getIntensityValue(this.currentIntensity),n=1+t*.4,s=Math.min(1,r.opacity*n),o=Math.min(20,r.blur*(1+t*.3));this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-opacity",s.toString()),this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-blur",`${o}px`),this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-accent-opacity",(s*.9).toString()),this.cssBatcher?.flushCSSVariableBatch(),setTimeout(()=>{this.updateGlassVariables(this.currentIntensity)},1500)}getIntensityValue(t){switch(t){case"disabled":return{opacity:0,blur:0,saturation:1};case"minimal":return{opacity:.05,blur:3,saturation:1.05};case"balanced":return{opacity:.1,blur:6,saturation:1.2};case"intense":return{opacity:.15,blur:8,saturation:1.4};case"moderate":return{opacity:.08,blur:5,saturation:1.15};default:return{opacity:.1,blur:6,saturation:1.2}}}convertToVisualEffectsState(t){return{intensity:t.effectIntensityLevel,colorTemperature:6500,animationScale:t.musicIntensity,dominantEmotion:t.currentMusicMood,resonance:t.musicIntensity,symbioticResonance:t.musicIntensity,surfaceFluidityIndex:t.musicIntensity,animationScaleRate:t.effectIntensityLevel,emotionalTemperature:6500,pulsingCycle:t.beatPhase,cinematicIntensity:t.effectIntensityLevel}}convertFromVisualEffectsState(t){return{currentMusicMood:t.dominantEmotion,musicIntensity:t.intensity,effectIntensityLevel:t.intensity,overallIntensityLevel:t.intensity}}}});var Ue,Ri=y(()=>{"use strict";$();L();Xa();tr();U();Ue=class{constructor(e=E){this.initialized=!1;this.destroyed=!1;this.eventUnsubscribers=[];this.initializationStartTime=null;this.frameStartTime=0;this.frameCount=0;this.lastFPSCalculation=0;this.currentFPS=60;this.config=e,this.systemName=this.constructor.name,this.config.enableDebug&&console.log(`[${this.systemName}] UnifiedSystemBase constructor`)}async _baseInitialize(){if(this.initialized){this.config.enableDebug&&console.warn(`[${this.systemName}] Already initialized`);return}try{this.initializationStartTime=performance.now(),this.config.enableDebug&&console.log(`[${this.systemName}] Starting unified initialization`);let e=globalThis.year3000System;if(e?(this.performanceAnalyzer=e.performanceAnalyzer||e.facadeCoordinator?.getCachedNonVisualSystem?.("SimplePerformanceCoordinator")||e.facadeCoordinator?.getCachedNonVisualSystem?.("PerformanceAnalyzer"),this.cssConsciousnessController=e.cssConsciousnessController||P(),this.eventBus=p,this.performanceCoordinator=e.performanceCoordinator||(this.performanceAnalyzer?tt.getInstance(this.config,this.performanceAnalyzer):null),this.animationCoordinator=e.enhancedMasterAnimationCoordinator||(this.performanceCoordinator?_e.getInstance(this.config,this.performanceCoordinator):null),this.unifiedCSSManager=e.unifiedCSSManager||P()):(this.cssConsciousnessController=P(),this.eventBus=p,this.performanceCoordinator=tt.getInstance(this.config,this.performanceAnalyzer),this.animationCoordinator=_e.getInstance(this.config,this.performanceCoordinator),this.unifiedCSSManager=P()),this.unifiedCSSManager&&this.performanceAnalyzer&&this.cssConsciousnessController,this.performanceAnalyzer&&typeof this.performanceAnalyzer.recordMetric=="function"&&this.performanceAnalyzer.recordMetric(`${this.systemName}_registered`,1),await this.trackPerformanceAsync("initialize",async()=>{await this._performSystemSpecificInitialization()}),this.initialized=!0,this.publishEvent("system:initialized",{systemName:this.systemName,timestamp:Date.now(),metadata:{initializationTime:this.initializationStartTime?performance.now()-this.initializationStartTime:0}}),this.config.enableDebug){let t=this.initializationStartTime?performance.now()-this.initializationStartTime:0;console.log(`[${this.systemName}] Unified initialization complete (${t.toFixed(2)}ms)`)}}catch(e){throw console.error(`[${this.systemName}] Initialization failed:`,e),this.publishEvent("system:initialization-failed",{systemName:this.systemName,error:e instanceof Error?e.message:String(e),timestamp:Date.now()}),e}}_baseDestroy(){if(this.destroyed){this.config.enableDebug&&console.warn(`[${this.systemName}] Already destroyed`);return}try{this.config.enableDebug&&console.log(`[${this.systemName}] Starting unified destruction`),this.eventUnsubscribers.forEach(e=>{try{e()}catch(t){console.warn(`[${this.systemName}] Error during event unsubscription:`,t)}}),this.eventUnsubscribers=[],this.performanceAnalyzer&&typeof this.performanceAnalyzer.recordMetric=="function"&&this.performanceAnalyzer.recordMetric(`${this.systemName}_unregistered`,1),this.destroy(),this.destroyed=!0,this.publishEvent("system:destroyed",{systemName:this.systemName,timestamp:Date.now()}),this.config.enableDebug&&console.log(`[${this.systemName}] Unified destruction complete`)}catch(e){console.error(`[${this.systemName}] Destruction failed:`,e)}}updateCSSVariable(e,t,i="normal"){this.unifiedCSSManager?this.unifiedCSSManager.queueUpdate(e,t,i,this.systemName):this.cssConsciousnessController?this.cssConsciousnessController.queueCSSVariableUpdate(e,t):console.warn(`[${this.systemName}] CSS variable management not initialized`)}updateCSSVariables(e,t="normal"){this.unifiedCSSManager?this.unifiedCSSManager.queueTransaction(e,t,this.systemName):this.cssConsciousnessController?Object.entries(e).forEach(([i,a])=>{this.cssConsciousnessController.queueCSSVariableUpdate(i,a)}):console.warn(`[${this.systemName}] CSS variable management not initialized`)}subscribeToEvent(e,t){if(!this.eventBus){console.warn(`[${this.systemName}] Event bus not initialized - attempting to initialize`);try{if(this.eventBus=p,!this.eventBus)return console.error(`[${this.systemName}] Failed to get unified event bus - event subscription deferred`),()=>{}}catch(i){return console.error(`[${this.systemName}] Error accessing unified event bus:`,i),()=>{}}}try{let i=this.eventBus.subscribe(e,t,this.systemName),a=()=>{this.eventBus.unsubscribe(i)};return this.eventUnsubscribers.push(a),a}catch(i){return console.error(`[${this.systemName}] Failed to subscribe to event ${e}:`,i),()=>{}}}publishEvent(e,t){if(!this.eventBus){console.warn(`[${this.systemName}] Event bus not initialized - attempting to initialize`);try{if(this.eventBus=p,!this.eventBus){console.error(`[${this.systemName}] Failed to get unified event bus - event publication skipped`);return}}catch(i){console.error(`[${this.systemName}] Error accessing unified event bus:`,i);return}}try{this.eventBus.emitSync(e,t)}catch(i){console.error(`[${this.systemName}] Failed to publish event ${e}:`,i)}}trackPerformance(e,t){let i=performance.now();try{t()}finally{let r=performance.now()-i;this.trackSystemPerformance(r),this.performanceAnalyzer&&typeof this.performanceAnalyzer.timeOperation=="function"&&this.performanceAnalyzer.recordMetric(`${this.systemName}_${e}`,r)}}async trackPerformanceAsync(e,t){if(!this.performanceAnalyzer||typeof this.performanceAnalyzer.timeOperationAsync!="function"){await t();return}await this.performanceAnalyzer.timeOperationAsync(`${this.systemName}_${e}`,t)}trackSystemPerformance(e){if(!this.performanceCoordinator)return;this.frameCount++;let t=performance.now();t-this.lastFPSCalculation>=1e3&&(this.currentFPS=this.frameCount,this.frameCount=0,this.lastFPSCalculation=t);let i=performance.memory?.usedJSHeapSize||0;this.performanceCoordinator.trackSubsystem(this.systemName,{frameTime:e,memoryUsage:i,fps:this.currentFPS,cpuUsage:e>16.67?Math.min(100,e/16.67*5):0})}registerAnimation(e=60){if(!this.animationCoordinator){console.warn(`[${this.systemName}] Animation coordinator not initialized, attempting lazy initialization`);try{this.animationCoordinator=_e.getInstance(this.config,this.performanceCoordinator)}catch(t){console.error(`[${this.systemName}] Failed to initialize animation coordinator:`,t);return}}try{this.animationCoordinator.registerAnimationSystem(this.systemName,this,"normal",e),this.config.enableDebug&&console.log(`[${this.systemName}] Successfully registered with animation coordinator`)}catch(t){console.error(`[${this.systemName}] Failed to register with animation coordinator:`,t)}}forceRepaint(e){this.config.enableDebug&&console.log(`[${this.systemName}] Force repaint: ${e||"unknown"}`),this.unifiedCSSManager&&this.unifiedCSSManager.forceFlush(),document.documentElement.style.transform="translateZ(0)",requestAnimationFrame(()=>{document.documentElement.style.transform=""})}get isInitialized(){return this.initialized}get isDestroyed(){return this.destroyed}get name(){return this.systemName}get systemConfig(){return this.config}registerCSSVariableGroup(e,t="normal"){this.unifiedCSSManager&&this.unifiedCSSManager.registerVariableGroup(`${this.systemName}-${e}`,t)}updateCSSVariableGroup(e,t){this.unifiedCSSManager?this.unifiedCSSManager.updateVariableGroup(`${this.systemName}-${e}`,t,this.systemName):this.updateCSSVariables(t)}updateAnimation(e){this.onAnimate(e)}async _performSystemSpecificInitialization(){}_performSystemSpecificCleanup(){this.destroy()}}});function Oe(c,e={}){if(!xc)return Array.from(document.querySelectorAll(c));let t=rr.get(c),i=t?.ref?.deref();return(e.force||!i)&&(i=Array.from(document.querySelectorAll(c)),t={ref:new WeakRef(i),lastUpdate:Date.now()},rr.set(c,t),Dc?.register(i,c)),i}var rr,xc,Ic,Dc,ls=y(()=>{"use strict";rr=new Map,xc=typeof WeakRef<"u",Ic=typeof FinalizationRegistry<"u",Dc=Ic?new FinalizationRegistry(c=>{rr.delete(c)}):null});function Dt(c){return Oe(c).length>0}function Lc(c,e,t){let i=Oe(c,t);return i.length===0&&e&&(i=Oe(e,t),i.length>0&&console.warn(`\u{1F30C} [SpotifyDOMSelectors] Using legacy selector: ${e}. Consider updating to: ${c}`)),i}function Rc(){console.group("\u{1F30C} [SpotifyDOMSelectors] DOM Validation");let c={found:0,missing:0,details:{}};return Object.entries(k).forEach(([e,t])=>{let i=Dt(t);c.details[e]={selector:t,exists:i,element:i&&Oe(t)[0]||null},i?(c.found++,console.log(`\u2705 ${e}: ${t}`)):(c.missing++,console.warn(`\u274C ${e}: ${t}`))}),console.log(`\u{1F4CA} Summary: ${c.found} found, ${c.missing} missing`),console.groupEnd(),c}function Bc(){console.group("\u{1F30C} [Phase 1] Testing Gravity System Selectors"),console.log("\u{1F3AF} Primary gravity well targets:"),It.primary&&It.primary.forEach(c=>{let e=Oe(c)[0]||null;console.log(`${e?"\u2705":"\u274C"} ${c}`,e)}),console.log("\u{1F3AF} Secondary gravity well targets:"),It.secondary&&It.secondary.forEach(c=>{let e=Oe(c)[0]||null;console.log(`${e?"\u2705":"\u274C"} ${c}`,e)}),console.log("\u{1F6F8} Orbital elements:"),Object.entries(Ne).forEach(([c,e])=>{let t=Oe(e);console.log(`${t.length>0?"\u2705":"\u274C"} ${c} (${e}): ${t.length} found`)}),console.groupEnd()}function us(){console.group("\u{1F52E} [SpotifyDOMSelectors] Phase 2 - Prediction Target Validation");let c=[{name:"Track Rows",selector:Ne.trackRows},{name:"Progress Bar",selector:k.progressBar},{name:"Play Button",selector:k.playButton},{name:"Heart Button",selector:k.heartButton},{name:"Album Cover",selector:k.albumCover},{name:"Now Playing Widget",selector:k.nowPlayingWidget},{name:"Now Playing Left",selector:k.nowPlayingLeft},{name:"Left Sidebar",selector:k.leftSidebar},{name:"Library Items",selector:Ne.libraryItems}],e={found:0,missing:0,details:{}};return c.forEach(({name:t,selector:i})=>{if(!i)return;let r=Lc(i).length;e.details[t]={selector:i,count:r,exists:r>0},r>0?(e.found++,console.log(`\u2705 ${t}: ${r} elements found (${i})`)):(e.missing++,console.warn(`\u274C ${t}: No elements found (${i})`))}),console.log(`\u{1F4CA} Prediction Targets Summary: ${e.found} types found, ${e.missing} missing`),console.groupEnd(),e}function Vc(){console.group("\u{1F30C} [SpotifyDOMSelectors] Phase 2 - System Integration Test");let c={behavioralPrediction:us(),dimensionalNexus:{sidebarElement:k.leftSidebar?Dt(k.leftSidebar):!1},dataGlyph:{navLinks:k.navBarLink?Dt(k.navBarLink):!1,trackRows:Ne.trackRows?Dt(Ne.trackRows):!1,cards:Ne.cards?Dt(Ne.cards):!1}},e=0;return Object.values(c).forEach(t=>{typeof t=="object"&&t.missing&&(e+=t.missing)}),console.log(`\u{1F3AF} Phase 2 Integration Health: ${e===0?"\u2705 All systems operational":`\u26A0\uFE0F ${e} issues detected`}`),console.groupEnd(),c}var k,Cg,Ne,It,kc,nr=y(()=>{"use strict";ls();k={nowPlayingBar:".Root__now-playing-bar",leftSidebar:".Root__nav-bar",mainView:".Root__main-view",rightSidebar:".Root__right-sidebar",nowPlayingWidget:"[data-testid='now-playing-widget']",nowPlayingLeft:".main-nowPlayingBar-left",nowPlayingCenter:".main-nowPlayingBar-center",nowPlayingRight:".main-nowPlayingBar-right",coverArt:".main-coverSlotCollapsed-container",trackInfo:".main-trackInfo-container",navMain:"nav[aria-label='Main']",yourLibrary:".main-yourLibraryX-libraryContainer",libraryItems:".main-yourLibraryX-listItem",libraryHeader:".main-yourLibraryX-header",playlistList:".main-rootlist-wrapper",trackListContainer:"[role='grid'][aria-label*='tracks']",trackRow:".main-trackList-trackListRow",trackListHeader:".main-trackList-trackListHeaderRow",trackNumber:".main-trackList-rowSectionIndex",trackTitle:".main-trackList-rowTitle",trackArtist:".main-trackList-rowSubTitle",entityHeader:".main-entityHeader-container",entityTitle:".main-entityHeader-title",entityMetadata:".main-entityHeader-metaData",entityImage:".main-entityHeader-imageContainer",actionBar:".main-actionBar-ActionBarRow",actionBarInner:".main-actionBar-ActionBar",playButton:"[data-testid='play-button']",pauseButton:"[data-testid='pause-button']",shuffleButton:"[data-testid='shuffle-button']",likeButton:".control-button-heart",queue:".main-queue-trackList",queueContainer:"[aria-label='Next in queue']",aboutArtist:"[aria-label='About the artist']",credits:"[aria-label='Credits']",searchInput:"[data-testid='search-input']",searchPage:"[data-testid='search-container']",filterPills:".main-genre-chip",sortButton:"[data-testid='sort-button']",card:".main-card-card",cardImage:".main-cardImage-image",albumArt:".main-trackList-albumArt",modal:".main-modal-container",overlay:".main-overlay-container"},Cg=Object.entries({".main-nowPlayingWidget-nowPlaying":k.nowPlayingBar,".main-navBar-navBar":k.leftSidebar,".main-search-searchBar":k.searchInput,".main-topBar-topBar":k.actionBar,".main-queue-queue":k.queue,".main-trackList-trackList":k.trackListContainer}).reduce((c,[e,t])=>(typeof t=="string"&&(c[e]=t),c),{}),Ne={trackRows:k.trackRow??"",libraryItems:k.libraryItems??"",cards:k.card??"",navLinks:".main-navBar-navBarLink"},It={primary:[k.nowPlayingBar,k.leftSidebar,k.entityHeader].filter(c=>!!c),secondary:[k.actionBar,k.queue,k.searchInput].filter(c=>!!c),tertiary:[k.playButton,k.trackListHeader].filter(c=>!!c)},kc={searchAreas:[k.searchInput,k.searchPage].filter(c=>!!c),notifications:["[data-testid='notification-bar']",".main-topBar-notifications"],dropdowns:[".main-dropdown-menu","[role='menu']","[role='listbox']"]};typeof window<"u"&&(window.SpotifyDOMSelectors={validate:Rc,testGravity:Bc,validatePredictionTargets:us,testPhase2Systems:Vc,selectors:k,targets:It,orbital:Ne,antiGravity:kc},console.log("\u{1F3AF} [SpotifyDOMSelectors] Debug functions available:"),console.log("  window.SpotifyDOMSelectors.validate() - Test all selectors"),console.log("  window.SpotifyDOMSelectors.testGravity() - Test gravity selectors"))});var ms={};ie(ms,{SidebarPerformanceCoordinator:()=>ht,getSidebarPerformanceCoordinator:()=>Fc});function Fc(c){return ht.getInstance(c)}var Ie,ht,sr=y(()=>{"use strict";L();$();Ti();nr();Ie=class Ie{constructor(e={}){this.pendingUpdates=new Map;this.isFlushScheduled=!1;this.rafId=null;this.performanceAnalyzer=null;this.harmonicVariableMap=new Map([["--sn-rs-beat-intensity","--sn-beat-pulse-intensity"],["--sn-rs-glow-alpha","--sn-rhythm-phase"],["--sn-rs-hue-shift","--sn-spectrum-phase"]]);this.flushCount=0;this.totalFlushTime=0;this.lastFlushTimestamp=0;this.budgetManager=null;this.domObserver=null;this.sidebarElement=null;this.visibilityObserver=null;this.observationThrottleTimer=null;this.lastObservationTime=0;this.OBSERVATION_THROTTLE_MS=200;this.isFirstOpen=!0;this.lastScrollUpdate=0;this.activeTimeouts=new Set;this.domObservationRetryTimeout=null;this.musicChangeUnsubscribe=null;this.config={enableDebug:e.enableDebug??!1,maxBatchSize:e.maxBatchSize??50,...e},this.performanceAnalyzer=e.performanceAnalyzer||null;let t=globalThis.year3000System;this.cssController=t.getGlobalOptimizedCSSController(),this.performanceAnalyzer&&(this.budgetManager=Ae.getInstance(void 0,this.performanceAnalyzer)),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] Initialized with RAF-based batching")}static getInstance(e){return Ie.instance||(Ie.instance=new Ie(e)),Ie.instance}queueUpdate(e,t){if(["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift"].includes(e)){this.applyCriticalUpdate(e,t);return}try{P().queueCSSVariableUpdate(e,t,this.getSidebarElement())}catch{this.pendingUpdates.set(e,{property:e,value:t,timestamp:performance.now()}),this.config.enableDebug&&this.pendingUpdates.size===1&&console.log(`\u{1F30C} [SidebarPerformanceCoordinator] Queuing first update (fallback): ${e}`),this.scheduleFlush()}}applyCriticalUpdate(e,t){try{this.cssController.queueCSSVariableUpdate(e,t,null,"critical","sidebar-critical-update")}catch(i){console.error(`\u{1F30C} [SidebarPerformanceCoordinator] Failed to apply critical ${e}:`,i)}}getSidebarElement(){return this.sidebarElement||(this.sidebarElement=document.querySelector(k.rightSidebar)),this.sidebarElement||document.documentElement}scheduleFlush(){this.isFlushScheduled||(this.isFlushScheduled=!0,this.rafId=requestAnimationFrame(()=>{this.flushUpdates()}))}flushUpdates(){if(this.pendingUpdates.size===0){this.isFlushScheduled=!1;return}let e=performance.now(),t=this.getSidebarElement(),i=this.pendingUpdates.size;this.config.enableDebug&&console.log(`\u{1F30C} [SidebarPerformanceCoordinator] Flushing ${i} updates atomically`),i>(this.config.maxBatchSize||50)&&console.warn(`\u{1F30C} [SidebarPerformanceCoordinator] Large batch detected (${i} updates), may impact performance`);try{let s={},o={};for(let l of this.pendingUpdates.values()){s[l.property]=l.value;let m=this.harmonicVariableMap.get(l.property);m&&(o[m]=l.value,this.config.enableDebug&&console.log(`\u{1F30C} [SidebarPerformanceCoordinator] Mapped ${l.property} \u2192 ${m} = ${l.value}`))}if(Object.keys(s).length>0){let l=t;for(let[m,d]of Object.entries(s))l.style.setProperty(m,d)}Object.keys(o).length>0&&this.cssController.batchSetVariables("SidebarPerformanceCoordinator",o,"high","harmonic-variable-mapping")}catch(s){console.error("\u{1F30C} [SidebarPerformanceCoordinator] Failed to apply batched updates:",s)}if(this.pendingUpdates.clear(),this.isFlushScheduled=!1,this.rafId=null,this.config.onFlushComplete)try{this.config.onFlushComplete()}catch(s){console.error("\u{1F30C} [SidebarPerformanceCoordinator] Error in flush completion callback:",s)}let a=performance.now(),r=a-e;this.flushCount++,this.totalFlushTime+=r,this.lastFlushTimestamp=a,this.performanceAnalyzer&&this.performanceAnalyzer.emitTrace?.(`[SidebarPerformanceCoordinator] Flushed ${i} updates in ${r.toFixed(2)}ms`);let n=this.flushCount>0?this.totalFlushTime/this.flushCount:0;n>3&&console.warn(`\u{1F30C} [SidebarPerformanceCoordinator] Performance threshold exceeded: average ${n.toFixed(2)}ms per flush (target: <3ms)`),this.config.enableDebug&&r>4&&console.warn(`\u{1F30C} [SidebarPerformanceCoordinator] Slow flush detected: ${r.toFixed(2)}ms for ${i} updates`)}setupMusicChangeCoordination(){this.musicChangeUnsubscribe||(this.musicChangeUnsubscribe=()=>{p.unsubscribeAll("SidebarPerformanceCoordinator")},p.subscribe("music:track-changed",e=>{this.handleMusicChange({timestamp:e.timestamp,source:"track-changed",reason:"music:track-changed event"})},"SidebarPerformanceCoordinator"),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] Event-driven music coordination active"))}handleMusicChange(e){this.sidebarElement&&(this.handleVisibilityChange(),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] Music change coordinated via event",{source:e.source,reason:e.reason,timestamp:e.timestamp}))}setupDOMObservation(){if(!this.domObserver){if(this.setupMusicChangeCoordination(),this.sidebarElement=document.querySelector(k.rightSidebar),!this.sidebarElement){this.config.enableDebug&&console.warn("\u{1F30C} [SidebarPerformanceCoordinator] Sidebar not found, deferring DOM observation"),this.domObservationRetryTimeout&&(clearTimeout(this.domObservationRetryTimeout),this.activeTimeouts.delete(this.domObservationRetryTimeout)),this.domObservationRetryTimeout=setTimeout(()=>{this.setupDOMObservation(),this.domObservationRetryTimeout=null},1e3),this.activeTimeouts.add(this.domObservationRetryTimeout);return}this.domObserver=new MutationObserver(e=>{let t=e.filter(i=>this.isRelevantMutation(i));t.length!==0&&this.throttleObservationUpdate(()=>{for(let i of t)i.type==="attributes"&&(i.attributeName==="aria-hidden"||i.attributeName==="style")&&this.handleVisibilityChange();this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] Relevant DOM change detected - visibility/structure only",{mutationCount:t.length,types:t.map(i=>i.type)})})}),this.domObserver.observe(this.sidebarElement,{childList:!0,subtree:!1,attributes:!0,attributeFilter:["aria-hidden","style","class"],attributeOldValue:!1,characterData:!1}),this.setupVisibilityObserver(),this.setupScrollObservation(),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] DOM observation active on sidebar")}}setupVisibilityObserver(){!this.sidebarElement||this.visibilityObserver||(this.visibilityObserver=new IntersectionObserver(e=>{let t=e[0];t&&t.isIntersecting&&this.isFirstOpen&&(window.requestIdleCallback?window.requestIdleCallback(()=>{this.triggerTemporalEcho(),this.isFirstOpen=!1}):setTimeout(()=>{this.triggerTemporalEcho(),this.isFirstOpen=!1},0))},{threshold:.1}),this.visibilityObserver.observe(this.sidebarElement))}setupScrollObservation(){if(!this.sidebarElement)return;let e=this.sidebarElement.querySelector(".main-nowPlayingView-queue");e&&e.addEventListener("scroll",this.throttledScrollHandler.bind(this),{passive:!0})}throttledScrollHandler(){let e=performance.now();e-this.lastScrollUpdate<33||(this.lastScrollUpdate=e,window.requestIdleCallback?window.requestIdleCallback(()=>{this.queueUpdate("--sn-rs-scroll-ratio",Math.random().toString())},{timeout:100}):this.queueUpdate("--sn-rs-scroll-ratio",Math.random().toString()))}isRelevantMutation(e){if(e.type==="attributes"){let t=e.attributeName;return t==="aria-hidden"||t==="style"||t==="class"?!0:(t?.startsWith("--")||t==="data-style",!1)}return e.type==="childList"?e.addedNodes&&Array.from(e.addedNodes).some(i=>i.nodeType===Node.ELEMENT_NODE)||e.removedNodes&&Array.from(e.removedNodes).some(i=>i.nodeType===Node.ELEMENT_NODE):!1}throttleObservationUpdate(e){let t=performance.now();t-this.lastObservationTime<this.OBSERVATION_THROTTLE_MS?(this.observationThrottleTimer&&clearTimeout(this.observationThrottleTimer),this.observationThrottleTimer=window.setTimeout(()=>{e(),this.lastObservationTime=performance.now(),this.observationThrottleTimer=null},this.OBSERVATION_THROTTLE_MS)):(e(),this.lastObservationTime=t)}handleVisibilityChange(){if(!this.sidebarElement)return;let e=!this.sidebarElement.hasAttribute("aria-hidden")&&!this.sidebarElement.style.display?.includes("none");e&&this.isFirstOpen&&(this.triggerTemporalEcho(),this.isFirstOpen=!1),this.config.enableDebug&&console.log(`\u{1F30C} [SidebarPerformanceCoordinator] Visibility changed: ${e?"visible":"hidden"}`)}triggerTemporalEcho(){if(!this.sidebarElement)return;this.sidebarElement.classList.add("sn-future-preview"),this.queueUpdate("--sn-kinetic-intensity","1"),this.queueUpdate("--sn-echo-hue-shift","15deg"),this.queueUpdate("--sn-echo-radius-multiplier","1.2"),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] Triggering temporal echo effect");let e=setTimeout(()=>{this.sidebarElement?.classList.remove("sn-future-preview"),this.queueUpdate("--sn-kinetic-intensity","0"),this.activeTimeouts.delete(e)},2e3);this.activeTimeouts.add(e)}getPerformanceMetrics(){return{flushCount:this.flushCount,averageFlushTime:this.flushCount>0?this.totalFlushTime/this.flushCount:0,lastFlushTimestamp:this.lastFlushTimestamp,pendingUpdates:this.pendingUpdates.size}}forceFlush(){this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.flushUpdates()}destroy(){if(this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.activeTimeouts.forEach(e=>{clearTimeout(e)}),this.activeTimeouts.clear(),this.domObservationRetryTimeout&&(clearTimeout(this.domObservationRetryTimeout),this.domObservationRetryTimeout=null),this.observationThrottleTimer&&(clearTimeout(this.observationThrottleTimer),this.observationThrottleTimer=null),this.domObserver&&(this.domObserver.disconnect(),this.domObserver=null),this.visibilityObserver&&(this.visibilityObserver.disconnect(),this.visibilityObserver=null),this.musicChangeUnsubscribe&&(this.musicChangeUnsubscribe(),this.musicChangeUnsubscribe=null),this.pendingUpdates.clear(),this.isFlushScheduled=!1,this.sidebarElement=null,Ie.instance===this&&(Ie.instance=null),this.config.enableDebug){let e=this.flushCount>0?this.totalFlushTime/this.flushCount:0;console.log(`\u{1F30C} [SidebarPerformanceCoordinator] Destroyed. Performance: ${this.flushCount} flushes, ${e.toFixed(2)}ms avg`)}}};Ie.instance=null;ht=Ie});var kt,ds=y(()=>{"use strict";Ri();sr();U();kt=class extends Ue{constructor(t=E){super(t);this.sidebarSystems=new Map;this.integrationEnabled=!1;this.lastFrameTime=0;this.sharedCoordinator=ht.getInstance({enableDebug:t.enableDebug,performanceAnalyzer:this.performanceAnalyzer,onFlushComplete:()=>this.handlePerformanceFlush()}),this.performanceMetrics={totalSystems:4,activeSystems:0,bilateralSyncEnabled:!1,averageFrameTime:0,totalMemoryUsage:0,healthStatus:"healthy"},t.enableDebug&&console.log(`[${this.systemName}] Initialized sidebar systems integration`)}async initialize(){this.config.enableDebug&&console.log(`[${this.systemName}] Initializing sidebar systems integration`);try{this.registerSidebarSystems(),await this.registerWithUnifiedRegistry(),await this.initializeSystemsInOrder(),this.setupBilateralCoordination(),this.connectToEventBus(),this.integrateWithPerformanceSystems(),this.registerAnimation(70),this.integrationEnabled=!0,this.updatePerformanceMetrics(),this.publishEvent("sidebar:integration-ready",{systemName:this.systemName,totalSystems:this.sidebarSystems.size,activeSystems:this.performanceMetrics.activeSystems,bilateralSync:this.performanceMetrics.bilateralSyncEnabled,timestamp:Date.now()})}catch(t){throw console.error(`[${this.systemName}] Integration initialization failed:`,t),t}}registerSidebarSystems(){this.consolidatedSidebarSystem&&this.sidebarSystems.set("consolidatedSidebarSystem",{name:"consolidatedSidebarSystem",system:this.consolidatedSidebarSystem,priority:"critical",enabled:!0,dependencies:[]})}async initializeSystemsInOrder(){let t=this.calculateInitializationOrder();for(let i of t){let a=this.sidebarSystems.get(i);if(a&&a.enabled)try{await a.system._baseInitialize(),this.performanceMetrics.activeSystems++,this.config.enableDebug&&console.log(`[${this.systemName}] Initialized ${i}`)}catch(r){console.error(`[${this.systemName}] Failed to initialize ${i}:`,r)}}}calculateInitializationOrder(){let t=new Set,i=new Set,a=[],r=n=>{if(i.has(n))throw new Error(`Circular dependency detected: ${n}`);if(t.has(n))return;i.add(n);let s=this.sidebarSystems.get(n);if(s&&s.dependencies)for(let o of s.dependencies)r(o);i.delete(n),t.add(n),a.push(n)};for(let n of this.sidebarSystems.keys())r(n);return a}setupBilateralCoordination(){this.performanceMetrics.bilateralSyncEnabled=!0,this.subscribeToEvent("sidebar:bilateral-sync",t=>{this.handleBilateralSync(t)}),this.subscribeToEvent("sidebar:visual-level-changed",t=>{this.handleVisualLevelChange(t)})}handleBilateralSync(t){t.source==="orchestrator"&&this.updatePerformanceMetrics()}handleVisualLevelChange(t){let a={dormant:.5,aware:.7,focused:.9,advanced:1}[t.newLevel]||.7;this.adjustPerformanceBudgets(a)}adjustPerformanceBudgets(t){let a=Math.floor(16*t);this.config.enableDebug&&console.log(`[${this.systemName}] Adjusted performance budget to ${a} based on visual intensity level`)}handlePerformanceFlush(){let t=performance.now();if(this.lastFrameTime>0){let i=t-this.lastFrameTime;this.performanceMetrics.averageFrameTime=(this.performanceMetrics.averageFrameTime+i)/2}this.lastFrameTime=t,this.updateHealthStatus()}updatePerformanceMetrics(){this.performanceMetrics.totalSystems=this.sidebarSystems.size;let t=0;for(let[,i]of this.sidebarSystems)i.enabled&&i.system.isInitialized&&t++;this.performanceMetrics.activeSystems=t}updateHealthStatus(){this.performanceMetrics.averageFrameTime>20?this.performanceMetrics.healthStatus="critical":this.performanceMetrics.averageFrameTime>16.67?this.performanceMetrics.healthStatus="degraded":this.performanceMetrics.healthStatus="healthy"}onAnimate(t){if(!this.integrationEnabled)return;this.updatePerformanceMetrics(),this.updateHealthStatus(),performance.now()-this.lastFrameTime>1e3&&this.publishEvent("sidebar:integration-metrics",{metrics:this.performanceMetrics,timestamp:Date.now()})}registerWithAnimationCoordinator(t){if(!t){console.warn(`[${this.systemName}] Animation coordinator not available`);return}for(let[i,a]of this.sidebarSystems)if(a.enabled&&a.system.isInitialized)try{t.registerAnimationSystem(i,a.system,a.priority,60),this.config.enableDebug&&console.log(`[${this.systemName}] Registered ${i} with animation coordinator`)}catch(r){console.error(`[${this.systemName}] Failed to register ${i}:`,r)}}getSidebarSystems(){return new Map(this.sidebarSystems)}getPerformanceMetrics(){return{...this.performanceMetrics}}setSidebarSystemEnabled(t,i){let a=this.sidebarSystems.get(t);a&&(a.enabled=i,!i&&a.system.isInitialized?(a.system._baseDestroy(),this.performanceMetrics.activeSystems--):i&&!a.system.isInitialized&&a.system._baseInitialize().catch(r=>{console.error(`[${this.systemName}] Failed to re-enable ${t}:`,r)}),this.publishEvent("sidebar:system-toggled",{systemName:t,enabled:i,timestamp:Date.now()}))}async healthCheck(){let t={};for(let[r,n]of this.sidebarSystems)if(n.enabled&&n.system.isInitialized)try{t[r]=await n.system.healthCheck()}catch(s){t[r]={healthy:!1,ok:!1,details:`Health check failed: ${s.message}`,issues:[`Health check failed: ${s.message}`],system:r}}let i=Object.values(t).filter(r=>!r.ok),a=i.length===0;return{healthy:a,ok:a,details:`Sidebar integration ${a?"healthy":"degraded"} - ${this.performanceMetrics.activeSystems}/${this.performanceMetrics.totalSystems} systems active, bilateral sync: ${this.performanceMetrics.bilateralSyncEnabled}`,issues:i.map(r=>r.details||"Unknown issue"),system:"SidebarSystemsIntegration"}}async registerWithUnifiedRegistry(){this.config.enableDebug&&console.log(`[${this.systemName}] Sidebar systems are now managed by VisualSystemFacade`)}connectToEventBus(){this.subscribeToEvent("music:beat",t=>{this.handleMusicBeat(t)}),this.subscribeToEvent("music:energy",t=>{this.handleMusicEnergy(t)}),this.subscribeToEvent("performance:threshold-exceeded",t=>{this.handlePerformanceThreshold(t)}),this.subscribeToEvent("user:navigation",t=>{this.handleUserNavigation(t)}),this.config.enableDebug&&console.log(`[${this.systemName}] Connected to EventBus for system-wide communication`)}integrateWithPerformanceSystems(){let t=globalThis.year3000System;if(!t){this.config.enableDebug&&console.log(`[${this.systemName}] Year3000System not available, skipping performance integration`);return}try{let i=t.timerConsolidationSystem;i&&(i.registerTimer("sidebar-performance-monitor",1e3,()=>{this.updatePerformanceMetrics()}),this.config.enableDebug&&console.log(`[${this.systemName}] Integrated with TimerConsolidationSystem`));let a=t.enhancedMasterAnimationCoordinator;a&&(a.registerFrameCallback((r,n)=>{this.bilateralVisualEffectsFrameUpdate(r,n)},"critical","sidebar-bilateral-visual-effects"),this.config.enableDebug&&console.log(`[${this.systemName}] Integrated with EnhancedMasterAnimationCoordinator`))}catch(i){console.error(`[${this.systemName}] Failed to integrate with performance systems:`,i)}}handleMusicBeat(t){if(!this.integrationEnabled)return;let i={intensity:t.intensity||.5,timestamp:t.timestamp||Date.now(),bpm:t.bpm||120};this.config.enableDebug&&console.log(`[${this.systemName}] Processed music beat:`,i)}handleMusicEnergy(t){if(!this.integrationEnabled)return;let i=t.energy||.5;this.adjustPerformanceBudgets(.5+i*.5),this.consolidatedSidebarSystem?.initialized&&this.config.enableDebug&&console.log(`[${this.systemName}] Adapted visual effects to energy level: ${i}`)}handlePerformanceThreshold(t){this.integrationEnabled&&(t.severity==="critical"?(this.performanceMetrics.healthStatus="critical",this.config.enableDebug&&console.warn(`[${this.systemName}] Activated emergency performance mode`)):t.severity==="warning"&&this.performanceMetrics.healthStatus==="critical"&&(this.performanceMetrics.healthStatus="degraded"))}handleUserNavigation(t){if(!this.integrationEnabled)return;let i={action:t.action||"navigate",target:t.target||"unknown",timestamp:t.timestamp||Date.now()};this.config.enableDebug&&console.log(`[${this.systemName}] Processing navigation context:`,i)}bilateralVisualEffectsFrameUpdate(t,i){if(!this.integrationEnabled)return;let a={frameTime:t,timestamp:i};t>16.67&&this.publishEvent("sidebar:frame-time-warning",{frameTime:t,timestamp:i})}destroy(){this.config.enableDebug&&console.log(`[${this.systemName}] Destroying sidebar systems integration`),this.integrationEnabled=!1;let t=globalThis.year3000System;t?.timerConsolidationSystem&&t.timerConsolidationSystem.unregisterTimer("sidebar-performance-monitor");let i=this.calculateInitializationOrder().reverse();for(let a of i){let r=this.sidebarSystems.get(a);if(r&&r.system.isInitialized)try{r.system._baseDestroy(),this.config.enableDebug&&console.log(`[${this.systemName}] Destroyed ${a}`)}catch(n){console.error(`[${this.systemName}] Failed to destroy ${a}:`,n)}}this.sidebarSystems.clear(),this.performanceMetrics={totalSystems:0,activeSystems:0,bilateralSyncEnabled:!1,averageFrameTime:0,totalMemoryUsage:0,healthStatus:"healthy"},this.publishEvent("sidebar:integration-destroyed",{timestamp:Date.now()})}}});var or,Lt,Bi,cr=y(()=>{"use strict";or=class extends Error{constructor(t,i,a,r,n){super(t);this.systemKey=i;this.strategy=a;this.context=r;this.cause=n;this.name="SystemCreationError"}},Lt=class extends or{constructor(t,i,a,r){super(`Missing required dependencies for ${t}: ${a.join(", ")}`,t,i,r);this.missingDependencies=a;this.name="DependencyValidationError"}},Bi=class extends Error{constructor(t,i,a=`No suitable creation strategy found for system: ${t}`){super(a);this.systemKey=t;this.criteria=i;this.name="StrategySelectionError"}}});var Rt,Vi,lr,ur,mr,hs,gs=y(()=>{"use strict";L();x();cr();Rt=class{constructor(){this.systemConfigs=new Map}validateDependencies(e){let t=this.getRequiredDependencies(e.systemKey),i=this.getOptionalDependencies(e.systemKey),a=[],r=[];for(let n of t)(!(n in e.dependencies)||!e.dependencies[n])&&a.push(n);for(let n of i)(!(n in e.dependencies)||!e.dependencies[n])&&r.push(`Optional dependency missing: ${n}`);return{valid:a.length===0,missing:a,warnings:r}}getRequiredDependencies(e){return this.systemConfigs.get(e)?.requiredDependencies||[]}getOptionalDependencies(e){return this.systemConfigs.get(e)?.optionalDependencies||[]}registerSystemConfig(e){this.systemConfigs.set(e.systemKey,e)}createBaseResult(e,t,i,a){let n=performance.now()-i;return{system:e,success:!a&&e!==null,creationTime:n,strategy:this.getStrategyName(),injectedDependencies:Object.keys(t.dependencies),warnings:[],error:a||void 0,metadata:{requiresInitialization:!0,pendingDependencies:[],context:t}}}},Vi=class extends Rt{constructor(){super(),this.registerKnownSystems()}getStrategyName(){return"StandardConstructor"}canCreate(e){let t=this.systemConfigs.get(e.systemKey);return t!==void 0&&!t.creationPreferences.eventDriven}getEstimatedCreationTime(e){return 10}async createSystem(e,t){let i=performance.now();try{let a=this.validateDependencies(t);if(!a.valid&&t.preferences.validateDependencies!==!1)throw new Lt(t.systemKey,this.getStrategyName(),a.missing,t);let r=this.getConstructorParameters(t),n=new e(...r),s=this.createBaseResult(n,t,i);return s.warnings=a.warnings,u?.debug?.log("StandardConstructorStrategy",`Created ${t.systemKey}`,{creationTime:s.creationTime,parametersUsed:r.length}),s}catch(a){let r=this.createBaseResult(null,t,i,a);return u?.debug?.error("StandardConstructorStrategy",`Failed to create ${t.systemKey}:`,a),r}}getConstructorParameters(e){let t=this.systemConfigs.get(e.systemKey);if(!t?.constructorMapping)return this.getStandardParameters(e);let i=[],{parameterNames:a,dependencyMapping:r}=t.constructorMapping;for(let n of a)switch(r[n]||n){case"config":i.push(e.config);break;case"utils":i.push(e.utils);break;case"performanceAnalyzer":case"simplePerformanceCoordinator":i.push(e.dependencies.simplePerformanceCoordinator||e.dependencies.performanceAnalyzer);break;case"settingsManager":i.push(e.dependencies.settingsManager);break;case"musicSyncService":i.push(e.dependencies.musicSyncService);break;case"year3000System":i.push(e.dependencies.year3000System);break;case"cssConsciousnessController":i.push(e.dependencies.cssConsciousnessController);break;case"performanceCoordinator":i.push(e.dependencies.performanceCoordinator);break;case"enhancedDeviceTierDetector":i.push(e.dependencies.enhancedDeviceTierDetector);break;case"webglSystemsIntegration":i.push(e.dependencies.webglSystemsIntegration);break;case"deviceCapabilityDetector":i.push(e.dependencies.deviceCapabilityDetector);break;default:i.push(void 0)}return i}getStandardParameters(e){return[e.config,e.utils,e.dependencies.simplePerformanceCoordinator||e.dependencies.performanceAnalyzer,e.dependencies.musicSyncService,e.dependencies.settingsManager,e.dependencies.year3000System]}registerKnownSystems(){this.registerSystemConfig({systemKey:"ColorHarmonyEngine",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerSystemConfig({systemKey:"EnhancedMasterAnimationCoordinator",requiredDependencies:["config","performanceCoordinator"],optionalDependencies:[],constructorMapping:{parameterNames:["config","performanceCoordinator"],dependencyMapping:{config:"config",performanceCoordinator:"performanceCoordinator"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"UnifiedPerformanceCoordinator",requiredDependencies:["config"],optionalDependencies:["simplePerformanceCoordinator"],constructorMapping:{parameterNames:["config","simplePerformanceCoordinator"],dependencyMapping:{config:"config",simplePerformanceCoordinator:"simplePerformanceCoordinator"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}});let e=["DeviceCapabilityDetector","SettingsManager"];for(let t of e)this.registerSystemConfig({systemKey:t,requiredDependencies:[],optionalDependencies:[],constructorMapping:{parameterNames:[],dependencyMapping:{}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}});this.registerSystemConfig({systemKey:"TimerConsolidationSystem",requiredDependencies:[],optionalDependencies:[],constructorMapping:{parameterNames:[],dependencyMapping:{}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"GlassmorphismManager",requiredDependencies:["config","utils","cssConsciousnessController","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","cssConsciousnessController","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",cssConsciousnessController:"cssConsciousnessController",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"Card3DManager",requiredDependencies:["simplePerformanceCoordinator","settingsManager","utils"],optionalDependencies:[],constructorMapping:{parameterNames:["simplePerformanceCoordinator","settingsManager","utils"],dependencyMapping:{simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager",utils:"utils"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"UnifiedCSSVariableManager",requiredDependencies:["config","performanceCoordinator"],optionalDependencies:[],constructorMapping:{parameterNames:["config","performanceCoordinator"],dependencyMapping:{config:"config",performanceCoordinator:"performanceCoordinator"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"SidebarSystemsIntegration",requiredDependencies:["cssConsciousnessController"],optionalDependencies:[],constructorMapping:{parameterNames:["cssConsciousnessController"],dependencyMapping:{cssConsciousnessController:"cssConsciousnessController"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"UnifiedSystemIntegration",requiredDependencies:["year3000System"],optionalDependencies:[],constructorMapping:{parameterNames:["year3000System"],dependencyMapping:{year3000System:"year3000System"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"GenreGradientEvolution",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerSystemConfig({systemKey:"MusicEmotionAnalyzer",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerNewSimplifiedSystems()}registerNewSimplifiedSystems(){this.registerSystemConfig({systemKey:"SimplePerformanceCoordinator",requiredDependencies:["enhancedDeviceTierDetector","webglSystemsIntegration"],optionalDependencies:[],constructorMapping:{parameterNames:["enhancedDeviceTierDetector","webglSystemsIntegration"],dependencyMapping:{enhancedDeviceTierDetector:"enhancedDeviceTierDetector",webglSystemsIntegration:"webglSystemsIntegration"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"SimpleTierBasedPerformanceSystem",requiredDependencies:["enhancedDeviceTierDetector"],optionalDependencies:[],constructorMapping:{parameterNames:["enhancedDeviceTierDetector"],dependencyMapping:{enhancedDeviceTierDetector:"enhancedDeviceTierDetector"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"EnhancedDeviceTierDetector",requiredDependencies:[],optionalDependencies:[],constructorMapping:{parameterNames:[],dependencyMapping:{}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"WebGLSystemsIntegration",requiredDependencies:["deviceCapabilityDetector"],optionalDependencies:[],constructorMapping:{parameterNames:["deviceCapabilityDetector"],dependencyMapping:{deviceCapabilityDetector:"deviceCapabilityDetector"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}})}},lr=class extends Rt{constructor(){super(),this.registerEventDrivenSystems()}getStrategyName(){return"EventDriven"}canCreate(e){return this.systemConfigs.get(e.systemKey)?.creationPreferences.eventDriven===!0}getEstimatedCreationTime(e){return 50}async createSystem(e,t){let i=performance.now();try{let r=await new Vi().createSystem(e,t);if(!r.success)return r;this.setupEventSubscriptions(r.system,t);let n=this.createBaseResult(r.system,t,i);return n.warnings=r.warnings,u?.debug?.log("EventDrivenCreationStrategy",`Created ${t.systemKey} with event subscriptions`),n}catch(a){let r=this.createBaseResult(null,t,i,a);return u?.debug?.error("EventDrivenCreationStrategy",`Failed to create ${t.systemKey}:`,a),r}}setupEventSubscriptions(e,t){let i=this.getEventSubscriptions(t.systemKey);for(let a of i){let r=this.mapEventType(a);typeof e.handleEvent=="function"?p.subscribe(r,n=>{e.handleEvent(n)},`SystemCreation-${t.systemKey}`):typeof e.handleColorExtraction=="function"&&(a==="colors/extracted"||r==="colors:extracted")&&p.subscribe(r,e.handleColorExtraction.bind(e),`SystemCreation-${t.systemKey}`)}u?.debug?.log("EventDrivenCreationStrategy",`Setup event subscriptions for ${t.systemKey}:`,i)}mapEventType(e){return{"colors/extracted":"colors:extracted","colors/harmonized":"colors:harmonized","music/beat":"music:beat","music/energy":"music:energy","music/track-changed":"music:track-changed","performance/mode-changed":"performance:tier-changed","performance/thermal-warning":"performance:frame","settings/changed":"settings:changed"}[e]||e}getEventSubscriptions(e){return{ColorHarmonyEngine:["colors:extracted","music:track-changed"],GenreGradientEvolution:["music:beat","music:energy","music:track-changed"],MusicEmotionAnalyzer:["music:beat","music:energy","music:track-changed"]}[e]||[]}registerEventDrivenSystems(){this.registerSystemConfig({systemKey:"ColorHarmonyEngine",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerSystemConfig({systemKey:"GenreGradientEvolution",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerSystemConfig({systemKey:"MusicEmotionAnalyzer",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}})}},ur=class extends Rt{constructor(){super(),this.registerObjectDependencySystems()}getStrategyName(){return"ObjectDependencies"}canCreate(e){return e.systemKey==="MusicSyncService"}getEstimatedCreationTime(e){return 30}async createSystem(e,t){let i=performance.now();try{let a=this.validateDependencies(t);if(!a.valid&&t.preferences.validateDependencies!==!1)throw new Lt(t.systemKey,this.getStrategyName(),a.missing,t);let r={ADVANCED_SYSTEM_CONFIG:t.config,ThemeUtilities:t.utils,settingsManager:t.dependencies.settingsManager,year3000System:t.dependencies.year3000System},n=new e(r),s=this.createBaseResult(n,t,i);return s.warnings=a.warnings,s.metadata.pendingDependencies=[],u?.debug?.log("ObjectDependenciesStrategy",`Created ${t.systemKey} with event-driven dependencies`),s}catch(a){let r=this.createBaseResult(null,t,i,a);return u?.debug?.error("ObjectDependenciesStrategy",`Failed to create ${t.systemKey}:`,a),r}}registerObjectDependencySystems(){this.registerSystemConfig({systemKey:"MusicSyncService",requiredDependencies:["config","utils"],optionalDependencies:["settingsManager","year3000System"],creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}})}},mr=class{constructor(){this.strategies=new Map;this.registerDefaultStrategies()}register(e){this.strategies.set(e.getStrategyName(),e),u?.debug?.log("SystemCreationStrategyRegistry",`Registered strategy: ${e.getStrategyName()}`)}selectStrategy(e,t){let i=this.getStrategiesForSystem(e);if(i.length===0)return null;let a=i[0];if(!a)return null;let r=this.scoreStrategy(a,e,t);for(let n=1;n<i.length;n++){let s=i[n];if(!s)continue;let o=this.scoreStrategy(s,e,t);o>r&&(a=s,r=o)}return a}getStrategies(){return Array.from(this.strategies.values())}getStrategy(e){return this.strategies.get(e)||null}getStrategiesForSystem(e){let t={systemKey:e,config:{},utils:{},dependencies:{},preferences:{},metadata:{timestamp:Date.now(),reason:"startup",priority:"medium"}};return this.getStrategies().filter(i=>i.canCreate(t))}scoreStrategy(e,t,i){let a=0;return a+=10,i.dependencyRequirements==="event-driven"?(e.getStrategyName()==="EventDriven"&&(a+=20),e.getStrategyName()==="ObjectDependencies"&&(a+=15)):i.dependencyRequirements==="basic"&&e.getStrategyName()==="StandardConstructor"&&(a+=20),i.performance==="lightweight"?e.getStrategyName()==="StandardConstructor"&&(a+=15):i.performance==="optimized"&&e.getStrategyName()==="EventDriven"&&(a+=10),i.creationContext==="startup"&&e.getStrategyName()==="StandardConstructor"&&(a+=5),a}registerDefaultStrategies(){this.register(new Vi),this.register(new lr),this.register(new ur)}getStatus(){return{strategyCount:this.strategies.size,strategies:Array.from(this.strategies.keys())}}},hs=new mr});var dr,ps,fs=y(()=>{"use strict";x();cr();gs();dr=class{constructor(e){this.systemConfigs=new Map;this.creationMetrics={totalCreations:0,successfulCreations:0,averageCreationTime:0,strategyUsage:{}};this.strategyRegistry=e||hs,u?.debug?.log("StrategyBasedFactory","Factory initialized with strategy registry")}async createSystem(e,t,i){let a=performance.now();try{this.creationMetrics.totalCreations++;let r=this.getSystemConfig(e),n=this.buildSelectionCriteria(e,r,i),s=this.strategyRegistry.selectStrategy(e,n);if(!s)throw new Bi(e,n);let o=s.getStrategyName();this.creationMetrics.strategyUsage[o]=(this.creationMetrics.strategyUsage[o]||0)+1;let l=await s.createSystem(t,i);l.success&&this.creationMetrics.successfulCreations++;let d=performance.now()-a;return this.updateAverageCreationTime(d),u?.debug?.log("StrategyBasedFactory",`Created ${e} using ${o}`,{success:l.success,creationTime:l.creationTime,totalTime:d}),l}catch(r){let s=performance.now()-a;return u?.debug?.error("StrategyBasedFactory",`Failed to create ${e}:`,r),{system:null,success:!1,creationTime:s,strategy:"unknown",injectedDependencies:[],warnings:[],error:r,metadata:{requiresInitialization:!1,pendingDependencies:[],context:i}}}}registerSystemConfig(e){this.systemConfigs.set(e.systemKey,e),u?.debug?.log("StrategyBasedFactory",`Registered config for ${e.systemKey}`)}getSystemConfig(e){return this.systemConfigs.get(e)||null}setStrategyRegistry(e){this.strategyRegistry=e,u?.debug?.log("StrategyBasedFactory","Strategy registry updated")}getMetrics(){return{...this.creationMetrics}}resetMetrics(){this.creationMetrics={totalCreations:0,successfulCreations:0,averageCreationTime:0,strategyUsage:{}}}buildSelectionCriteria(e,t,i){let a="medium",r=["DeviceCapabilityDetector","PerformanceAnalyzer","UnifiedCSSVariableManager","SettingsManager","TimerConsolidationSystem"],n=["GlassmorphismManager","Card3DManager","UnifiedCSSVariableManager","EnhancedMasterAnimationCoordinator"];r.includes(e)?a="simple":n.includes(e)&&(a="complex");let s="basic";e==="MusicSyncService"||e==="ColorHarmonyEngine"?s="event-driven":r.includes(e)&&(s="none");let o="standard";return i.metadata.priority==="critical"||i.preferences.monitorCreation?o="optimized":a==="simple"&&(o="lightweight"),{complexity:a,dependencyRequirements:s,performance:o,resourceConstraints:{memoryLimited:i.metadata.resourceConstraints?.maxMemoryMB!==void 0,timeLimited:i.metadata.resourceConstraints?.maxInitTimeMs!==void 0,cpuLimited:i.metadata.priority==="low"},creationContext:i.metadata.reason}}updateAverageCreationTime(e){let t=this.creationMetrics.totalCreations,i=this.creationMetrics.averageCreationTime;this.creationMetrics.averageCreationTime=(i*(t-1)+e)/t}registerDefaultSystemConfigs(){}},ps=new dr});var hr,ys,bs=y(()=>{"use strict";fs();x();hr=class{constructor(e){this.adapted=!1;this.originalFacade=null;this.migrationProgress=0;this.systemsUsingStrategy=new Set;this.systemsUsingLegacy=new Set;this.strategyBasedFactory=e||ps,u?.debug?.log("NonVisualSystemFacadeAdapter","Facade adapter initialized")}adaptToStrategyPattern(e){this.strategyBasedFactory=e,this.adapted=!0,this.migrationProgress=1,u?.debug?.log("NonVisualSystemFacadeAdapter","Facade adapted to strategy pattern")}getMigrationStatus(){return{adapted:this.adapted,systemsUsingStrategyPattern:Array.from(this.systemsUsingStrategy),systemsUsingLegacyPattern:Array.from(this.systemsUsingLegacy),migrationProgress:this.migrationProgress}}async completeMigration(){this.adapted||this.adaptToStrategyPattern(this.strategyBasedFactory),this.migrationProgress=1,this.systemsUsingLegacy.clear(),u?.debug?.log("NonVisualSystemFacadeAdapter","Migration to strategy pattern completed")}async createSystemWithStrategy(e,t,i){let a={systemKey:e,config:i.config,utils:i.utils,dependencies:i.dependencies,preferences:{lazyInit:!1,validateDependencies:!0,creationTimeout:5e3,monitorCreation:!0},metadata:{timestamp:Date.now(),reason:"startup",priority:"medium",resourceConstraints:{maxMemoryMB:50,maxInitTimeMs:1e3}}};try{let r=await this.strategyBasedFactory.createSystem(e,t,a);return r.success?(this.systemsUsingStrategy.add(e),this.systemsUsingLegacy.delete(e)):this.systemsUsingLegacy.add(e),this.updateMigrationProgress(),u?.debug?.log("NonVisualSystemFacadeAdapter",`Created ${e} via strategy pattern`,{strategy:r.strategy,success:r.success,creationTime:r.creationTime}),r}catch(r){return this.systemsUsingLegacy.add(e),this.updateMigrationProgress(),u?.debug?.error("NonVisualSystemFacadeAdapter",`Failed to create ${e} via strategy pattern:`,r),{system:null,success:!1,creationTime:0,strategy:"adapter-fallback",injectedDependencies:[],warnings:[`Strategy creation failed: ${r}`],error:r,metadata:{requiresInitialization:!1,pendingDependencies:[],context:a}}}}createSystemLegacy(e,t,i){switch(this.systemsUsingLegacy.add(e),this.updateMigrationProgress(),u?.debug?.warn("NonVisualSystemFacadeAdapter",`Using legacy creation for ${e} - should migrate to strategy pattern`),e){case"DeviceCapabilityDetector":case"PerformanceAnalyzer":case"SettingsManager":case"TimerConsolidationSystem":return new t;case"SidebarSystemsIntegration":return new t(i.dependencies.cssConsciousnessController);case"OptimizedCSSVariableManager":return new t(i.config,i.dependencies.performanceCoordinator);case"ColorHarmonyEngine":return new t(i.config,i.utils,i.dependencies.performanceAnalyzer,i.dependencies.settingsManager);case"EnhancedMasterAnimationCoordinator":return new t(i.config,i.dependencies.performanceCoordinator);case"UnifiedPerformanceCoordinator":return new t(i.config,i.dependencies.performanceAnalyzer);case"GlassmorphismManager":return new t(i.config,i.utils,i.dependencies.cssConsciousnessController,i.dependencies.performanceAnalyzer,i.dependencies.settingsManager);case"Card3DManager":return new t(i.dependencies.performanceAnalyzer,i.dependencies.settingsManager,i.utils);case"MusicSyncService":return new t({ADVANCED_SYSTEM_CONFIG:i.config,ThemeUtilities:i.utils,settingsManager:i.dependencies.settingsManager,year3000System:i.year3000System});case"EnhancedDeviceTierDetector":return t;case"WebGLSystemsIntegration":let a=i.dependencies.deviceCapabilityDetector;if(!a)throw new Error("WebGLSystemsIntegration requires DeviceCapabilityDetector");return new t(a);case"SimplePerformanceCoordinator":let r=i.dependencies.enhancedDeviceTierDetector,n=i.dependencies.webglSystemsIntegration;if(!r||!n)throw new Error("SimplePerformanceCoordinator requires EnhancedDeviceTierDetector and WebGLSystemsIntegration");return new t(r,n);case"SimpleTierBasedPerformanceSystem":let s=i.dependencies.enhancedDeviceTierDetector;if(!s)throw new Error("SimpleTierBasedPerformanceSystem requires EnhancedDeviceTierDetector");return new t(s);default:try{return new t}catch{return new t(i.config,i.utils,i.dependencies.performanceAnalyzer,i.dependencies.settingsManager)}}}updateMigrationProgress(){let e=this.systemsUsingStrategy.size+this.systemsUsingLegacy.size;e===0?this.migrationProgress=0:this.migrationProgress=this.systemsUsingStrategy.size/e}getAdapterMetrics(){let e=this.systemsUsingStrategy.size+this.systemsUsingLegacy.size;return{totalSystemsAdapted:this.systemsUsingStrategy.size,strategySuccessRate:e>0?this.systemsUsingStrategy.size/e:0,migrationProgress:this.migrationProgress,systemBreakdown:{strategy:Array.from(this.systemsUsingStrategy),legacy:Array.from(this.systemsUsingLegacy)}}}async migrateSystemToStrategy(e){try{return this.systemsUsingLegacy.delete(e),u?.debug?.log("NonVisualSystemFacadeAdapter",`Migrated ${e} to strategy pattern`),!0}catch(t){return u?.debug?.error("NonVisualSystemFacadeAdapter",`Failed to migrate ${e} to strategy pattern:`,t),!1}}getRecommendedMigrationOrder(){return["PerformanceAnalyzer","OptimizedCSSVariableManager","DeviceCapabilityDetector","SettingsManager","ColorHarmonyEngine","MusicSyncService","UnifiedPerformanceCoordinator","EnhancedMasterAnimationCoordinator","UnifiedSystemIntegration","GlassmorphismManager","Card3DManager"].filter(t=>this.systemsUsingLegacy.has(t))}},ys=new hr});var Bt,vs=y(()=>{"use strict";x();Xa();$();jn();Qn();Ja();Za();Ci();er();ue();tr();Ti();Oa();pi();x();Fe();ya();ts();Ua();rs();hi();ns();cs();ds();bs();Bt=class{constructor(e,t,i){this.cssVariableManager=null;this.musicSyncService=null;this.settingsManager=null;this.simplePerformanceCoordinator=null;this.webglSystemsIntegration=null;this.enhancedDeviceTierDetector=null;this.performanceAnalyzer=null;this.performanceCoordinator=null;this.performanceOrchestrator=null;this.isInitialized=!1;this.lastHealthCheck=null;this.healthCheckInterval=null;this.metricsUpdateInterval=null;this.onSystemCreated=null;this.onSystemFailed=null;this.onHealthChange=null;this.facadeAdapter=ys;this.config=e,this.utils=t,this.year3000System=i,i&&typeof i=="object"&&"performanceAnalyzer"in i&&(this.performanceAnalyzer=i.performanceAnalyzer||null,this.cssVariableManager=i.unifiedCSSConsciousnessController||null,this.performanceCoordinator=i.unifiedPerformanceCoordinator||null,this.performanceOrchestrator=i.performanceOrchestrator||null,this.musicSyncService=i.musicSyncService||null,this.settingsManager=i.settingsManager||null,u?.debug?.log("NonVisualSystemFacade","Shared dependencies injected from SystemCoordinator",{performanceAnalyzer:!!this.performanceAnalyzer,cssVariableManager:!!this.cssVariableManager,performanceOrchestrator:!!this.performanceOrchestrator,musicSyncService:!!this.musicSyncService,settingsManager:!!this.settingsManager})),this.systemRegistry=new Map,this.systemCache=new Map,this.systemDependencies=new Map,this.facadeConfig={mode:"progressive",enablePerformanceMonitoring:!0,enableDependencyInjection:!0,enableSystemHealthMonitoring:!0,performanceThresholds:{maxInitTime:5e3,maxMemoryMB:100,maxCPUPercent:15},systemPreferences:{lazyInitialization:!0,aggressiveCaching:!0,performanceOptimization:!0}},this.currentMetrics=this.createInitialMetrics(),this.registerNonVisualSystems(),u?.debug?.log("NonVisualSystemFacade","Non-visual systems facade initialized")}registerNonVisualSystems(){this.systemRegistry.set("EnhancedMasterAnimationCoordinator",_e),this.systemDependencies.set("EnhancedMasterAnimationCoordinator",["performanceAnalyzer","cssVariableManager"]),this.systemRegistry.set("TimerConsolidationSystem",vi),this.systemDependencies.set("TimerConsolidationSystem",["performanceAnalyzer"]),this.systemRegistry.set("OptimizedCSSVariableManager",Ee),this.systemDependencies.set("OptimizedCSSVariableManager",["performanceCoordinator"]),this.systemRegistry.set("UnifiedCSSVariableManager",Ee),this.systemDependencies.set("UnifiedCSSVariableManager",["performanceCoordinator"]),this.systemRegistry.set("UnifiedPerformanceCoordinator",tt),this.systemDependencies.set("UnifiedPerformanceCoordinator",[]),this.systemRegistry.set("DeviceCapabilityDetector",N),this.systemDependencies.set("DeviceCapabilityDetector",[]),this.systemRegistry.set("PerformanceAnalyzer",he),this.systemDependencies.set("PerformanceAnalyzer",[]),this.systemRegistry.set("CSSVariableBatcher",Ee),this.systemDependencies.set("CSSVariableBatcher",[]),this.systemRegistry.set("SystemHealthMonitor",he),this.systemDependencies.set("SystemHealthMonitor",[]),this.systemRegistry.set("UnifiedSystemIntegration",kt),this.systemDependencies.set("UnifiedSystemIntegration",[]),this.systemRegistry.set("PerformanceBudgetManager",Ae),this.systemDependencies.set("PerformanceBudgetManager",["performanceAnalyzer"]),this.systemRegistry.set("SimplePerformanceCoordinator",he),this.systemDependencies.set("SimplePerformanceCoordinator",["performanceAnalyzer","performanceCoordinator","deviceCapabilityDetector","performanceBudgetManager"]),this.systemRegistry.set("PerformanceAwareLerpCoordinator",Si),this.systemDependencies.set("PerformanceAwareLerpCoordinator",["performanceOrchestrator"]),this.systemRegistry.set("SimplePerformanceCoordinator",he),this.systemDependencies.set("SimplePerformanceCoordinator",["enhancedDeviceTierDetector","webglSystemsIntegration"]),this.systemRegistry.set("SimpleTierBasedPerformanceSystem",dt),this.systemDependencies.set("SimpleTierBasedPerformanceSystem",["enhancedDeviceTierDetector"]),this.systemRegistry.set("EnhancedDeviceTierDetector",me),this.systemDependencies.set("EnhancedDeviceTierDetector",[]),this.systemRegistry.set("WebGLSystemsIntegration",et),this.systemDependencies.set("WebGLSystemsIntegration",["deviceCapabilityDetector"]),this.systemDependencies.set("UnifiedDebugManager",[]),this.systemRegistry.set("SettingsManager",ee),this.systemDependencies.set("SettingsManager",[]),this.systemRegistry.set("ColorHarmonyEngine",Xe),this.systemDependencies.set("ColorHarmonyEngine",["musicSyncService"]),this.systemRegistry.set("MusicSyncService",we),this.systemDependencies.set("MusicSyncService",[]),this.systemDependencies.set("ColorOrchestrator",[]),this.systemRegistry.set("UnifiedColorProcessingEngine",xt),this.systemDependencies.set("UnifiedColorProcessingEngine",["settingsManager","performanceAnalyzer"]),this.systemRegistry.set("GenreGradientEvolution",st),this.systemDependencies.set("GenreGradientEvolution",["cssVariableManager","musicSyncService","settingsManager"]),this.systemRegistry.set("MusicEmotionAnalyzer",ut),this.systemDependencies.set("MusicEmotionAnalyzer",["musicSyncService","settingsManager"]),this.systemRegistry.set("VisualEffectsCoordinator",Ai),this.systemDependencies.set("VisualEffectsCoordinator",["settingsManager"]),this.systemRegistry.set("GlassmorphismManager",Li),this.systemDependencies.set("GlassmorphismManager",["cssVariableManager","performanceAnalyzer","settingsManager"]),this.systemRegistry.set("Card3DManager",Di),this.systemDependencies.set("Card3DManager",["performanceAnalyzer","settingsManager"]),this.systemRegistry.set("SidebarSystemsIntegration",kt),this.systemDependencies.set("SidebarSystemsIntegration",["cssVariableManager"])}async initialize(e){if(this.isInitialized){u?.debug?.warn("NonVisualSystemFacade","Already initialized");return}try{let t=performance.now();this.facadeConfig={...this.facadeConfig,...e},await this.initializeSharedDependencies(),await this.applyConfiguration(),this.startMonitoring(),await this.performHealthCheck();let i=performance.now();this.currentMetrics.systemInitializationTime=i-t,this.isInitialized=!0,u?.debug?.log("NonVisualSystemFacade","Non-visual systems facade fully initialized",{mode:this.facadeConfig.mode,systemsRegistered:this.systemRegistry.size,initTime:this.currentMetrics.systemInitializationTime})}catch(t){throw u?.debug?.error("NonVisualSystemFacade","Initialization failed:",t),await this.cleanup(),t}}async initializeSharedDependencies(){let e=["DeviceCapabilityDetector","EnhancedDeviceTierDetector","WebGLSystemsIntegration","SimplePerformanceCoordinator","PerformanceAnalyzer","UnifiedPerformanceCoordinator","SimplePerformanceCoordinator","OptimizedCSSVariableManager","SettingsManager","UnifiedDebugManager","MusicSyncService"];for(let t of e)try{let i=await this.getSystem(t);switch(i&&typeof i.initialize=="function"&&await i.initialize(),t){case"DeviceCapabilityDetector":this.year3000System&&(this.year3000System.deviceCapabilityDetector=i);break;case"EnhancedDeviceTierDetector":this.enhancedDeviceTierDetector=i;break;case"WebGLSystemsIntegration":this.webglSystemsIntegration=i;break;case"SimplePerformanceCoordinator":this.simplePerformanceCoordinator=i,this.performanceOrchestrator=i;break;case"PerformanceAnalyzer":this.performanceAnalyzer=i;break;case"UnifiedPerformanceCoordinator":this.performanceCoordinator=i;break;case"OptimizedCSSVariableManager":this.cssVariableManager=i;break;case"SettingsManager":this.settingsManager=i;break;case"UnifiedDebugManager":break;case"MusicSyncService":this.musicSyncService=i;break}}catch(i){u?.debug?.error("NonVisualSystemFacade",`Failed to initialize ${t}:`,i)}}getCachedSystem(e){let t=this.systemCache.get(e);if(t)return t;if(e==="DeviceCapabilityDetector"&&this.year3000System?.deviceCapabilityDetector){let i=this.year3000System.deviceCapabilityDetector;return this.systemCache.set(e,i),i}return e==="EnhancedDeviceTierDetector"&&this.enhancedDeviceTierDetector?(this.systemCache.set(e,this.enhancedDeviceTierDetector),this.enhancedDeviceTierDetector):e==="WebGLSystemsIntegration"&&this.webglSystemsIntegration?(this.systemCache.set(e,this.webglSystemsIntegration),this.webglSystemsIntegration):e==="SimplePerformanceCoordinator"&&this.simplePerformanceCoordinator?(this.systemCache.set(e,this.simplePerformanceCoordinator),this.simplePerformanceCoordinator):e==="PerformanceAnalyzer"&&this.performanceAnalyzer?(this.systemCache.set(e,this.performanceAnalyzer),this.performanceAnalyzer):e==="SimplePerformanceCoordinator"&&this.performanceOrchestrator?(this.systemCache.set(e,this.performanceOrchestrator),this.performanceOrchestrator):(e==="OptimizedCSSVariableManager"||e==="UnifiedCSSVariableManager")&&this.cssVariableManager?(this.systemCache.set(e,this.cssVariableManager),this.cssVariableManager):e==="MusicSyncService"&&this.musicSyncService?(this.systemCache.set(e,this.musicSyncService),this.musicSyncService):e==="SettingsManager"&&this.settingsManager?(this.systemCache.set(e,this.settingsManager),this.settingsManager):null}async getSystem(e){if(this.systemCache.has(e))return this.systemCache.get(e);if(e==="DeviceCapabilityDetector"&&this.year3000System?.deviceCapabilityDetector){let i=this.year3000System.deviceCapabilityDetector;return this.systemCache.set(e,i),u?.debug?.log("NonVisualSystemFacade","Using shared DeviceCapabilityDetector instance from SystemCoordinator"),i}if(e==="EnhancedDeviceTierDetector"&&this.enhancedDeviceTierDetector)return this.systemCache.set(e,this.enhancedDeviceTierDetector),u?.debug?.log("NonVisualSystemFacade","Using shared EnhancedDeviceTierDetector instance from SystemCoordinator"),this.enhancedDeviceTierDetector;if(e==="WebGLSystemsIntegration"&&this.webglSystemsIntegration)return this.systemCache.set(e,this.webglSystemsIntegration),u?.debug?.log("NonVisualSystemFacade","Using shared WebGLSystemsIntegration instance from SystemCoordinator"),this.webglSystemsIntegration;if(e==="SimplePerformanceCoordinator"&&this.simplePerformanceCoordinator)return this.systemCache.set(e,this.simplePerformanceCoordinator),u?.debug?.log("NonVisualSystemFacade","Using shared SimplePerformanceCoordinator instance from SystemCoordinator"),this.simplePerformanceCoordinator;if(e==="PerformanceAnalyzer"&&this.performanceAnalyzer)return this.systemCache.set(e,this.performanceAnalyzer),u?.debug?.log("NonVisualSystemFacade","Using shared PerformanceAnalyzer instance from SystemCoordinator"),this.performanceAnalyzer;if((e==="OptimizedCSSVariableManager"||e==="UnifiedCSSVariableManager")&&this.cssVariableManager)return this.systemCache.set(e,this.cssVariableManager),u?.debug?.log("NonVisualSystemFacade",`Using shared OptimizedCSSVariableManager instance from SystemCoordinator (requested as ${e})`),this.cssVariableManager;if(e==="SimplePerformanceCoordinator"&&this.performanceOrchestrator)return this.systemCache.set(e,this.performanceOrchestrator),u?.debug?.log("NonVisualSystemFacade","Using shared SimplePerformanceCoordinator instance from SystemCoordinator"),this.performanceOrchestrator;if(e==="MusicSyncService"&&this.musicSyncService)return this.systemCache.set(e,this.musicSyncService),u?.debug?.log("NonVisualSystemFacade","Using shared MusicSyncService instance from SystemCoordinator"),this.musicSyncService;if(e==="SettingsManager"&&this.settingsManager)return this.systemCache.set(e,this.settingsManager),u?.debug?.log("NonVisualSystemFacade","Using shared SettingsManager instance from SystemCoordinator"),this.settingsManager;let t=await this.createSystem(e);return this.systemCache.set(e,t),this.currentMetrics.activeSystems.push(e),this.currentMetrics.initializedSystems++,this.onSystemCreated&&this.onSystemCreated(e,t),t}async createSystem(e){let t=performance.now();try{if(e==="UnifiedDebugManager"){let o=tn.getInstance();this.injectDependencies(o,e),this.integratePerformanceMonitoring(o,e);let l=performance.now();return this.currentMetrics.dependencyResolutionTime+=l-t,o}if(e==="ColorOrchestrator"){let o=lt;this.injectDependencies(o,e),this.integratePerformanceMonitoring(o,e);let l=performance.now();return this.currentMetrics.dependencyResolutionTime+=l-t,o}let i=this.systemRegistry.get(e);if(!i)throw new Error(`Non-visual system '${e}' not found in registry`);let a={systemKey:e,config:this.config,utils:this.utils,dependencies:{config:this.config,utils:this.utils,performanceAnalyzer:this.performanceAnalyzer,settingsManager:this.settingsManager,musicSyncService:this.musicSyncService,year3000System:this.year3000System,cssVariableManager:this.cssVariableManager,performanceCoordinator:this.performanceCoordinator,performanceOrchestrator:this.performanceOrchestrator,enhancedDeviceTierDetector:this.enhancedDeviceTierDetector,webglSystemsIntegration:this.webglSystemsIntegration,simplePerformanceCoordinator:this.simplePerformanceCoordinator,deviceCapabilityDetector:this.year3000System?.deviceCapabilityDetector||null},preferences:{lazyInit:!1,validateDependencies:!0,creationTimeout:5e3,monitorCreation:!0},metadata:{timestamp:Date.now(),reason:"startup",priority:"medium",resourceConstraints:{maxMemoryMB:50,maxInitTimeMs:1e3}},year3000System:this.year3000System},r=await this.facadeAdapter.createSystemWithStrategy(e,i,a);if(!r.success){u?.debug?.warn("NonVisualSystemFacade",`Strategy creation failed for ${e}, falling back to legacy pattern`);let o=this.facadeAdapter.createSystemLegacy(e,i,a);this.injectDependencies(o,e),this.integratePerformanceMonitoring(o,e);let l=performance.now();return this.currentMetrics.dependencyResolutionTime+=l-t,o}let n=r.system;this.injectDependencies(n,e),this.integratePerformanceMonitoring(n,e);let s=performance.now();return this.currentMetrics.dependencyResolutionTime+=s-t,u?.debug?.log("NonVisualSystemFacade",`Created ${e} using strategy: ${r.strategy}`,{creationTime:r.creationTime,totalTime:s-t,injectedDependencies:r.injectedDependencies}),n}catch(i){throw this.currentMetrics.failedSystems++,this.currentMetrics.failedSystemsList.push(e),this.currentMetrics.systemErrors++,this.onSystemFailed&&this.onSystemFailed(e,i),u?.debug?.error("NonVisualSystemFacade",`Failed to create system ${e}:`,i),i}}injectDependencies(e,t){if(!this.facadeConfig.enableDependencyInjection)return;let i=this.systemDependencies.get(t)||[];i.includes("performanceAnalyzer")&&this.performanceAnalyzer&&e.setPerformanceAnalyzer&&e.setPerformanceAnalyzer(this.performanceAnalyzer),i.includes("cssVariableManager")&&this.cssVariableManager&&e.setCSSVariableManager&&e.setCSSVariableManager(this.cssVariableManager),i.includes("cssConsciousnessController")&&this.cssVariableManager&&e.setCSSConsciousnessController&&e.setCSSConsciousnessController(this.cssVariableManager),i.includes("musicSyncService")&&this.musicSyncService&&e.setMusicSyncService&&e.setMusicSyncService(this.musicSyncService),i.includes("settingsManager")&&this.settingsManager&&e.setSettingsManager&&e.setSettingsManager(this.settingsManager),i.includes("year3000System")&&e.setYear3000System&&e.setYear3000System(this.year3000System),i.includes("performanceOrchestrator")&&this.performanceOrchestrator&&e.setSimplePerformanceCoordinator&&e.setSimplePerformanceCoordinator(this.performanceOrchestrator)}integratePerformanceMonitoring(e,t){if(!this.facadeConfig.enablePerformanceMonitoring||!this.performanceAnalyzer)return;let i=e.initialize;typeof i=="function"&&(e.initialize=async(...r)=>{let n=performance.now(),s=await i.call(e,...r),o=performance.now();return this.performanceAnalyzer?.recordMetric(`NonVisual_${t}_Initialize`,o-n),s});let a=e.updateAnimation;typeof a=="function"&&(e.updateAnimation=r=>{let n=performance.now();a.call(e,r);let s=performance.now();this.performanceAnalyzer?.recordMetric(`NonVisual_${t}_Animation`,s-n)})}async initializeAllSystems(){let e=Array.from(this.systemCache.entries()).map(async([a,r])=>{try{return r&&typeof r.initialize=="function"&&await r.initialize(),u?.debug?.log("NonVisualSystemFacade",`Initialized system: ${a}`),{key:a,success:!0}}catch(n){return u?.debug?.error("NonVisualSystemFacade",`Failed to initialize ${a}:`,n),{key:a,success:!1,error:n}}}),t=await Promise.allSettled(e),i=t.filter(a=>a.status==="fulfilled"&&a.value.success).length;u?.debug?.log("NonVisualSystemFacade",`Non-visual systems initialized: ${i}/${t.length}`)}async performHealthCheck(){let e={overall:"good",systems:new Map,recommendations:[],timestamp:performance.now(),metrics:{...this.currentMetrics}},t=0,i=0;for(let[r,n]of this.systemCache){i++;try{let s=n.healthCheck?await n.healthCheck():{status:"unknown",message:"No health check available"},o=s.status==="healthy"||s.status==="good";o&&t++,e.systems.set(r,{ok:o,details:s.message||s.details||"System operational"})}catch(s){e.systems.set(r,{ok:!1,details:`Health check failed: ${s}`})}}let a=i>0?t/i:1;return a>=.9?e.overall="excellent":a>=.7?e.overall="good":a>=.5?(e.overall="degraded",e.recommendations.push("Some non-visual systems are experiencing issues")):(e.overall="critical",e.recommendations.push("Multiple non-visual system failures detected")),this.currentMetrics.systemInitializationTime>3e3&&e.recommendations.push("High initialization time - consider optimizing system startup"),this.currentMetrics.memoryUsageMB>80&&e.recommendations.push("High memory usage - consider optimizing system memory usage"),this.lastHealthCheck=e,this.currentMetrics.lastHealthCheckTime=performance.now(),this.onHealthChange&&this.onHealthChange(e),e}createInitialMetrics(){return{systemCount:this.systemRegistry.size,initializedSystems:0,failedSystems:0,totalInitTime:0,averageInitTime:0,memoryUsageMB:0,systemHealth:"good",activeSystems:[],failedSystemsList:[],dependencyInjection:this.facadeConfig.enableDependencyInjection,performanceMonitoring:this.facadeConfig.enablePerformanceMonitoring,healthMonitoring:this.facadeConfig.enableSystemHealthMonitoring,systemInitializationTime:0,dependencyResolutionTime:0,lastHealthCheckTime:0,systemErrors:0}}async applyConfiguration(){switch(this.facadeConfig.mode){case"performance-first":this.facadeConfig.systemPreferences.lazyInitialization=!0,this.facadeConfig.systemPreferences.aggressiveCaching=!0;break;case"quality-first":this.facadeConfig.systemPreferences.lazyInitialization=!1,this.facadeConfig.systemPreferences.performanceOptimization=!0;break;case"battery-optimized":this.facadeConfig.performanceThresholds.maxCPUPercent=5,this.facadeConfig.systemPreferences.lazyInitialization=!0;break}}startMonitoring(){this.facadeConfig.enableSystemHealthMonitoring&&(this.healthCheckInterval=window.setInterval(async()=>{await this.performHealthCheck()},3e4),this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},5e3))}updateMetrics(){this.currentMetrics.systemCount=this.systemRegistry.size,this.currentMetrics.initializedSystems=this.systemCache.size,this.currentMetrics.averageInitTime=this.currentMetrics.totalInitTime/Math.max(1,this.currentMetrics.initializedSystems);let e=performance.memory;e&&(this.currentMetrics.memoryUsageMB=e.usedJSHeapSize/(1024*1024));let t=this.currentMetrics.failedSystems/Math.max(1,this.currentMetrics.systemCount);t===0?this.currentMetrics.systemHealth="excellent":t<.1?this.currentMetrics.systemHealth="good":t<.3?this.currentMetrics.systemHealth="degraded":this.currentMetrics.systemHealth="critical"}async cleanup(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this.cssVariableManager=null,this.performanceAnalyzer=null,this.performanceOrchestrator=null,this.musicSyncService=null,this.settingsManager=null}getMetrics(){return{...this.currentMetrics}}getLastHealthCheck(){return this.lastHealthCheck}getConfiguration(){return{...this.facadeConfig}}async setConfiguration(e){this.facadeConfig={...this.facadeConfig,...e},await this.applyConfiguration()}setOnSystemCreated(e){this.onSystemCreated=e}setOnSystemFailed(e){this.onSystemFailed=e}setOnHealthChange(e){this.onHealthChange=e}getSystemStatus(){return{initialized:this.isInitialized,systemsActive:this.systemCache.size,healthy:this.currentMetrics.systemHealth==="excellent"||this.currentMetrics.systemHealth==="good"}}async destroy(){await this.cleanup(),this.isInitialized=!1,this.systemCache.clear(),u?.debug?.log("NonVisualSystemFacade","Non-visual systems facade destroyed")}}});var Fi,Ss=y(()=>{"use strict";L();Fi=class{constructor(e,t,i){this.systemName="CSSAnimationManager";this.animationStates=new Map;this.activeAnimations=new Map;this.animationObservers=new Map;this.frameCount=0;this.lastFrameTime=0;this.avgFrameTime=0;this.performanceMode="quality";this.beatSyncState={intensity:0,tempo:120,phase:0,lastBeatTime:0,avgBeatInterval:500};this.animationState={currentType:"gentle",activeElements:new Set,currentAnimation:null,lastEnergyLevel:.5,lastTempoChange:0,targetEnergyLevel:.5,smoothedEnergyLevel:.5,targetTempo:120,smoothedTempo:120,lastFrameTime:0,energyHalfLife:.3,tempoHalfLife:.8};this.ANIMATION_CONFIGS={visualEffectsGentleBreathing:{name:"visualEffects-gentle-animation",duration:4e3,easing:"ease-in-out",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},visualEffectsEnergeticBreathing:{name:"visualEffects-energetic-animation",duration:2500,easing:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},visualEffectsMeditativeBreathing:{name:"visualEffects-meditative-animation",duration:6e3,easing:"cubic-bezier(0.4, 0, 0.6, 1)",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},visualEffectsCosmicBreathing:{name:"visualEffects-cosmic-animation",duration:3e3,easing:"cubic-bezier(0.25, 0.1, 0.25, 1)",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},bloom:{name:"advanced-bloom",duration:1500,easing:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",iterations:1,fillMode:"forwards",playState:"running",delay:0,direction:"normal"},ripple:{name:"advanced-ripple",duration:1200,easing:"ease-out",iterations:1,fillMode:"forwards",playState:"running",delay:0,direction:"normal"},oscillate:{name:"advanced-oscillate",duration:4e3,easing:"ease-in-out",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},harmonize:{name:"advanced-harmonize-flow",duration:8e3,easing:"linear",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},refract:{name:"advanced-refract",duration:800,easing:"ease-in-out",iterations:1,fillMode:"forwards",playState:"running",delay:0,direction:"normal"},timeBasedEcho:{name:"advanced-echo-core",duration:800,easing:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",iterations:1,fillMode:"forwards",playState:"running",delay:0,direction:"normal"},gravity:{name:"advanced-gravity-pull",duration:1e3,easing:"ease-in-out",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"}};this.config=e,this.cssVariableManager=t,this.animationCoordinator=i,this.eventBus=p,this.initializeDefaultState(),this.subscribeToEvents(),this.animationCoordinator.registerVisualSystem(this,"normal"),this.animationState.lastFrameTime=performance.now(),this.config.enableDebug&&console.log("[CSSAnimationManager] Initialized with CSS animation coordination and LERP-smoothed animation transitions")}onAnimate(e,t){this.frameCount++,this.lastFrameTime=e,this.avgFrameTime=this.avgFrameTime*.9+e*.1,this.updatePerformanceMode(t.performanceMode),t.beatIntensity!==void 0&&this.updateBeatSyncState(t.beatIntensity,t.timestamp);let i=e/1e3;this.updateBreathingLerpValues(i),this.updateAnimationVariables(t),this.updateActiveAnimations(t),this.frameCount%60===0&&this.reportPerformanceMetrics()}onPerformanceModeChange(e){this.performanceMode=e,this.updateAnimationQuality(e),this.config.enableDebug&&console.log(`[CSSAnimationManager] Performance mode changed to: ${e}`)}triggerKineticAnimation(e,t,i){let a={...this.ANIMATION_CONFIGS[t],...i};Array.from(e).forEach((r,n)=>{let s=(a.delay||0)+n*50,o={duration:a.duration||1e3,easing:a.easing||"ease-in-out",iterations:a.iterations==="infinite"?1/0:a.iterations||1,fill:a.fillMode||"forwards",delay:s,direction:a.direction||"normal"},l=r.animate([],o),m=`${t}_${Date.now()}_${n}`;this.activeAnimations.set(m,l),l.addEventListener("finish",()=>{this.activeAnimations.delete(m),r.classList.remove(`sn-${t}-active`)}),r.classList.add(`sn-${t}-active`)}),this.config.enableDebug&&console.log(`[CSSAnimationManager] Triggered ${t} animation on ${e.length} elements`)}enableBeatSync(e=!0){for(let[t,i]of this.animationStates)i.beatSyncEnabled=e,this.animationStates.set(t,i);this.cssVariableManager.updateMusicVariables({"beat.pulse.intensity":e?this.beatSyncState.intensity:0}),this.config.enableDebug&&console.log(`[CSSAnimationManager] Beat sync ${e?"enabled":"disabled"}`)}setAnimationIntensity(e){let t=Math.max(0,Math.min(1,e));for(let[i,a]of this.animationStates)a.intensityLevel=t,this.animationStates.set(i,a);this.cssVariableManager.updateAnimationVariables({"motion.scale":t}),this.cssVariableManager.updateMusicVariables({"beat.pulse.intensity":t}),this.config.enableDebug&&console.log(`[CSSAnimationManager] Animation intensity set to: ${t}`)}pauseAllAnimations(){for(let e of this.activeAnimations.values())e.pause();this.cssVariableManager.updateAnimationVariables({"motion.scale":0}),this.config.enableDebug&&console.log("[CSSAnimationManager] All animations paused")}resumeAllAnimations(){for(let e of this.activeAnimations.values())e.play();this.cssVariableManager.updateAnimationVariables({"motion.scale":1}),this.config.enableDebug&&console.log("[CSSAnimationManager] All animations resumed")}lerpSmooth(e,t,i,a){return a<=1e-5||i<=0?t:t+(e-t)*Math.pow(2,-i/a)}updateBreathingLerpValues(e){this.animationState.smoothedEnergyLevel=this.lerpSmooth(this.animationState.smoothedEnergyLevel,this.animationState.targetEnergyLevel,e,this.animationState.energyHalfLife),this.animationState.smoothedTempo=this.lerpSmooth(this.animationState.smoothedTempo,this.animationState.targetTempo,e,this.animationState.tempoHalfLife)}triggerVisualEffectsAnimation(e,t=.5,i=120){this.animationState.targetEnergyLevel=t,this.animationState.targetTempo=i;let a=this.animationState.smoothedEnergyLevel,r=this.animationState.smoothedTempo,n=this.selectBreathingType(a,r);this.animationState.currentAnimation&&this.animationState.currentAnimation.cancel(),this.animationState.activeElements.forEach(s=>{s.classList.remove("visualEffects-gentle-animation","visualEffects-energetic-animation","visualEffects-meditative-animation","visualEffects-cosmic-animation")}),this.animationState.currentType=n,this.animationState.lastEnergyLevel=a,this.animationState.lastTempoChange=Date.now(),this.animationState.activeElements.clear(),Array.from(e).forEach(s=>{this.animationState.activeElements.add(s),s.classList.add(`visualEffects-${n}-animation`)}),this.updateBreathingVariables(n,a,r),this.config.enableDebug&&console.log(`[CSSAnimationManager] LERP-smoothed visual effects: ${n} (raw: ${t.toFixed(2)}\u2192${a.toFixed(2)}, tempo: ${i}\u2192${r.toFixed(1)})`)}selectBreathingType(e,t){return this.performanceMode==="performance"&&e>.7?e>.8?"gentle":"meditative":e<.3?"meditative":e>.7&&t>140?"cosmic":e>.6?"energetic":"gentle"}updateBreathingVariables(e,t,i){let a=this.calculateBreathingDuration(e,i),r=Math.max(.05,Math.min(1,t));this.cssVariableManager.updateVisualEffectsVariables({"animation.type":e,"animation.duration":`${a}ms`,"animation.intensity":r,"animation.energy":t}),this.cssVariableManager.updateMusicVariables({"tempo.bpm":i,"energy.level":t,"animation.sync":1})}calculateBreathingDuration(e,t){let a={gentle:4e3,energetic:2500,meditative:6e3,cosmic:3e3}[e]||4e3,r=Math.max(.5,Math.min(2,120/t));return Math.round(a*r)}stopVisualEffectsAnimation(){this.animationState.currentAnimation&&(this.animationState.currentAnimation.cancel(),this.animationState.currentAnimation=null),this.animationState.activeElements.forEach(e=>{e.classList.remove("visualEffects-gentle-animation","visualEffects-energetic-animation","visualEffects-meditative-animation","visualEffects-cosmic-animation")}),this.animationState.activeElements.clear(),this.cssVariableManager.updateVisualEffectsVariables({"animation.sync":0}),this.config.enableDebug&&console.log("[CSSAnimationManager] Visual effects animation stopped")}getPerformanceMetrics(){return{frameCount:this.frameCount,avgFrameTime:this.avgFrameTime,activeAnimations:this.activeAnimations.size,performanceMode:this.performanceMode}}destroy(){for(let e of this.activeAnimations.values())e.cancel();this.activeAnimations.clear(),this.animationStates.clear(),this.animationObservers.clear(),this.config.enableDebug&&console.log("[CSSAnimationManager] Destroyed")}initializeDefaultState(){let e={rippleActive:!1,bloomActive:!1,refractActive:!1,oscillateActive:!1,harmonizeActive:!1,timeBasedEchoActive:!1,gravityActive:!1,beatSyncEnabled:!0,intensityLevel:1,tempoMultiplier:1};this.animationStates.set("default",e)}subscribeToEvents(){this.eventBus.subscribe("music:beat",e=>{this.handleBeatEvent(e)},"CSSAnimationManager"),this.eventBus.subscribe("music:energy",e=>{this.handleTempoChange({bpm:e.tempo})},"CSSAnimationManager"),this.eventBus.subscribe("settings:changed",e=>{e.settingKey==="sn-animation-quality"&&this.handleAnimationQualityChange(e.newValue)},"CSSAnimationManager"),this.eventBus.subscribe("performance:frame",e=>{let t=e.fps<45?"performance":"quality";this.onPerformanceModeChange(t)},"CSSAnimationManager")}handleBeatEvent(e){let t=performance.now(),i=t-this.beatSyncState.lastBeatTime;if(this.beatSyncState.intensity=e.intensity||0,this.beatSyncState.phase=e.phase||0,this.beatSyncState.lastBeatTime=t,i>0&&i<2e3&&(this.beatSyncState.avgBeatInterval=this.beatSyncState.avgBeatInterval*.9+i*.1),this.cssVariableManager.updateMusicVariables({"beat.pulse.intensity":this.beatSyncState.intensity,"beat.phase":this.beatSyncState.phase}),e.energy!==void 0){let a=e.energy,r=this.beatSyncState.tempo,n=Math.abs(a-this.animationState.lastEnergyLevel),s=t-this.animationState.lastTempoChange;if(n>.15||s>5e3){let o=document.querySelectorAll(".Root__main-view::before, .Root__main-view, [data-visualEffects-animation]");o.length>0&&this.triggerVisualEffectsAnimation(o,a,r)}}}handleTempoChange(e){let t=e.bpm||120;this.beatSyncState.tempo=t;let i=t/120;this.cssVariableManager.updateMusicVariables({"tempo.bpm":t}),this.cssVariableManager.updateAnimationVariables({"motion.scale":i});for(let[a,r]of this.animationStates)r.tempoMultiplier=i,this.animationStates.set(a,r)}updateBeatSyncState(e,t){this.beatSyncState.intensity=e,this.beatSyncState.lastBeatTime=t,this.cssVariableManager.updateMusicVariables({"beat.pulse.intensity":e})}updateAnimationVariables(e){this.cssVariableManager.updateAnimationVariables({"frame.fps":Math.round(1e3/e.deltaMs),"frame.budget":`${e.frameBudget}ms`}),e.tiltXY&&this.cssVariableManager.updateVisualEffectsVariables({"hover.pull":`${Math.abs(e.tiltXY.x)+Math.abs(e.tiltXY.y)}px`})}updateActiveAnimations(e){if(e.timestamp-this.lastFrameTime<16)return;let t=this.performanceMode==="performance"?.7:1;for(let i of this.activeAnimations.values())i.playbackRate!==t&&(i.playbackRate=t)}handleAnimationQualityChange(e){let t;switch(e){case"low":t=.4;break;case"high":t=1;break;case"auto":default:t=this.performanceMode==="performance"?.6:1;break}this.applyQualityLevel(t),this.config.enableDebug&&console.log(`[CSSAnimationManager] Animation quality set to: ${e} (level: ${t})`)}updateAnimationQuality(e){let t=e==="performance"?.6:1;this.applyQualityLevel(t)}applyQualityLevel(e){let t=e<.5?"performance":"quality";this.cssVariableManager.updatePerformanceVariables({"quality.level":e,mode:t}),this.cssVariableManager.updateAnimationVariables({"motion.scale":e}),e<.5?this.cssVariableManager.updateUtilityVariables({"feature.animations.enabled":!1}):this.cssVariableManager.updateUtilityVariables({"feature.animations.enabled":!0})}updatePerformanceMode(e){this.performanceMode!==e&&(this.performanceMode=e,this.updateAnimationQuality(e))}reportPerformanceMetrics(){let e=this.getPerformanceMetrics();this.eventBus.emit("performance:frame",{deltaTime:e.avgFrameTime,fps:Math.round(1e3/e.avgFrameTime),memoryUsage:0,timestamp:Date.now()}),this.config.enableDebug&&console.log(`[CSSAnimationManager] Performance - FPS: ${Math.round(1e3/e.avgFrameTime)}, Active: ${e.activeAnimations}`)}triggerConsciousnessBreathing(e,t=.5,i=120){return this.triggerVisualEffectsAnimation(e,t,i)}stopConsciousnessBreathing(){return this.stopVisualEffectsAnimation()}}});var Gi,gr,Cs=y(()=>{"use strict";Gi=class{constructor(){this.pulsingEngine={},this.symbioticCore=new gr}getConsciousnessState(){return{intensity:.5,colorTemperature:6e3,animationScale:1,dominantEmotion:"neutral",resonance:.5,symbioticResonance:.5,surfaceFluidityIndex:.5,animationScaleRate:1,emotionalTemperature:6e3,pulsingCycle:2,cinematicIntensity:.5}}},gr=class{processAudioData(e){}getEmotionalState(){return{intensity:.5,valence:.5,arousal:.5,energy:.5}}initialize(){}updateSymbioticResonance(e){}calculateResonance(e){return .5}updateSymbioticEffects(e){}}});var Gc,Ms,Es,ws,Ts,$e,Q,pr,fr,yr,Ps=y(()=>{"use strict";Gc=`#version 300 es
in vec2 a_position;
void main() {
  gl_Position = vec4(a_position, 0.0, 1.0);
}`,Ms=`
// Shared simplex noise implementation for visual effects
vec3 mod289(vec3 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec2 mod289(vec2 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec3 permute(vec3 x) {
  return mod289(((x*34.0)+1.0)*x);
}

float snoise(vec2 v) {
  const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);
  vec2 i = floor(v + dot(v, C.yy));
  vec2 x0 = v - i + dot(i, C.xx);
  vec2 i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
  vec4 x12 = x0.xyxy + C.xxzz;
  x12.xy -= i1;
  i = mod289(i);
  vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));
  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
  m = m*m;
  m = m*m;
  vec3 x = 2.0 * fract(p * C.www) - 1.0;
  vec3 h = abs(x) - 0.5;
  vec3 ox = floor(x + 0.5);
  vec3 a0 = x - ox;
  m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);
  vec3 g;
  g.x = a0.x * x0.x + h.x * x0.y;
  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
  return 130.0 * dot(m, g);
}`,Es=`
// Enhanced visualEffects-aware animation effect with multi-phase patterns
float visualEffectsPulsing(float time, float phase, float intensity) {
  return sin(time * 0.05 + phase) * intensity;
}

// Deep visualEffects animation with emotional resonance
float deepVisualEffectsPulsing(float time, float phase, float emotionalIntensity) {
  float primaryBreath = sin(time * 0.04 + phase) * 0.6;
  float secondaryBreath = sin(time * 0.07 + phase * 1.3) * 0.3;
  float emotionalBreath = sin(time * 0.02 + phase * 0.7) * 0.2;
  return (primaryBreath + secondaryBreath + emotionalBreath) * emotionalIntensity;
}

// Rhythmic pulse modulation from visualEffects field
float rhythmicPulseModulation(float baseValue, float rhythmicPulse, float intensity) {
  return baseValue * (1.0 + rhythmicPulse * intensity);
}

// Musical flow direction calculation
vec2 calculateMusicalFlow(vec2 baseDirection, vec2 musicFlow, float sensitivity) {
  return baseDirection + musicFlow * sensitivity;
}

// Energy resonance modulation
float energyResonanceModulation(float baseValue, float energyResonance, float minMult, float maxMult) {
  return baseValue * (minMult + energyResonance * (maxMult - minMult));
}

// Surface fluidity effect
float surfaceFluidityEffect(float value, float fluidityIndex) {
  return mix(value, value * 1.2, fluidityIndex);
}

// === ADVANCED VISUAL_EFFECTS FIELD PATTERNS ===

// Multi-dimensional visualEffects field intensity calculation
float visualEffectsFieldIntensity(vec2 position, float time, float musicEnergy) {
  // Primary visualEffects wave
  float primaryField = snoise(position * 2.0 + time * 0.1) * 0.6;
  
  // Secondary awareness resonance
  float secondaryField = snoise(position * 4.0 + time * 0.05) * 0.3;
  
  // Musical visualEffects enhancement
  float musicalField = snoise(position * 6.0 + time * 0.15) * 0.2;
  
  // Combine visualEffects layers
  float combinedField = primaryField + secondaryField + (musicalField * musicEnergy);
  return clamp(combinedField * 0.5 + 0.5, 0.0, 1.0);
}

// Multi-dimensional awareness patterns for color modulation
vec3 awarenessResonance(vec3 baseColor, float visualEffectsLevel, float musicIntensity) {
  // VisualEffects-aware color temperature shift
  float temperatureShift = visualEffectsLevel * 0.3;
  vec3 warmShift = vec3(1.0 + temperatureShift, 1.0 + temperatureShift * 0.5, 1.0);
  vec3 coolShift = vec3(1.0, 1.0 + temperatureShift * 0.3, 1.0 + temperatureShift);
  
  // Musical intensity affects color saturation
  float saturationBoost = 1.0 + musicIntensity * 0.4;
  
  // Apply visualEffects-aware color modulation
  vec3 temperatureColor = mix(coolShift, warmShift, visualEffectsLevel);
  return baseColor * temperatureColor * saturationBoost;
}

// Temporal flow patterns for Year 3000 streaming effects
vec2 temporalFlowDirection(vec2 position, float time, vec2 musicFlow) {
  // Primary temporal stream
  vec2 primaryFlow = vec2(
    sin(time * 0.08 + position.x * 3.0),
    cos(time * 0.06 + position.y * 2.5)
  ) * 0.02;
  
  // Secondary visualEffects flow
  vec2 visualEffectsFlow = vec2(
    sin(time * 0.05 + position.y * 4.0),
    cos(time * 0.04 + position.x * 3.5)
  ) * 0.015;
  
  // Musical synchronization flow
  vec2 musicalSync = musicFlow * 0.01;
  
  return primaryFlow + visualEffectsFlow + musicalSync;
}

// Surface visualEffects dynamics for smooth boundaries
float surfaceVisualEffectsFlow(vec2 position, float fluidityIndex, float awarenessLevel) {
  // Base surface oscillation
  float surfaceBase = sin(position.x * 8.0 + position.y * 6.0) * 0.1;
  
  // VisualEffects-driven surface flexibility
  float visualEffectsFlex = awarenessLevel * fluidityIndex * 0.2;
  
  // Smooth surface animation
  float surfaceBreath = sin(position.x * 3.0 + position.y * 4.0) * 0.05;
  
  return surfaceBase + visualEffectsFlex + surfaceBreath;
}

// Advanced visualEffects animation patterns
float visualEffectsMemoryPulsing(float time, float phase, float memoryIntensity) {
  // Primary visualEffects rhythm
  float primaryRhythm = sin(time * 0.03 + phase) * 0.5;
  
  // Memory echo patterns
  float memoryEcho = sin(time * 0.08 + phase * 1.7) * 0.3 * memoryIntensity;
  
  // Deep awareness pulse
  float awarenessePulse = sin(time * 0.015 + phase * 0.5) * 0.2;
  
  return primaryRhythm + memoryEcho + awarenessePulse;
}`,ws=`
// Convert screen coordinates to polar coordinates for radial flow
vec2 toPolar(vec2 uv) {
  vec2 centered = uv - 0.5;
  float angle = atan(centered.y, centered.x);
  float radius = length(centered);
  return vec2(angle, radius);
}

// Convert polar coordinates back to cartesian
vec2 fromPolar(vec2 polar) {
  float angle = polar.x;
  float radius = polar.y;
  return vec2(cos(angle) * radius, sin(angle) * radius) + 0.5;
}

// Signed distance field for a circle
float circleSDF(vec2 uv, vec2 center, float radius) {
  return length(uv - center) - radius;
}

// Smooth minimum for blending SDFs
float smin(float a, float b, float k) {
  float h = clamp(0.5 + 0.5 * (b - a) / k, 0.0, 1.0);
  return mix(b, a, h) - k * h * (1.0 - h);
}

// Enhanced multiple bubble corridors with smooth visualEffects-aware animations
float bubbleCorridors(vec2 uv, float time, float intensity) {
  // ===== ENHANCED PRIMARY BUBBLE APERTURES =====
  // Create 6 main circular apertures arranged in a ring with dynamic bubble count
  float baseBubbleCount = 6.0;
  float dynamicBubbleCount = baseBubbleCount + floor(intensity * 2.0); // 6-8 bubbles based on intensity
  float ringRadius = 0.28 + sin(time * 0.15) * 0.08; // Pulsing ring radius (0.20-0.36)
  
  float minBubbleDistance = 2.0; // Track closest bubble distance
  
  // Calculate distance to each bubble position with enhanced smooth movement
  for(float i = 0.0; i < dynamicBubbleCount; i += 1.0) {
    // Enhanced smooth rotation with animation rhythm
    float bubbleAngle = (i / dynamicBubbleCount) * 2.0 * 3.14159 + time * 0.08;
    
    // Add smooth spiral motion for visualEffects effect
    float spiralOffset = sin(time * 0.25 + i * 0.6) * 0.15;
    float dynamicRingRadius = ringRadius + spiralOffset;
    
    // Bubble center position with enhanced smooth movement
    vec2 bubbleCenter = vec2(0.5) + vec2(
      cos(bubbleAngle) * dynamicRingRadius,
      sin(bubbleAngle) * dynamicRingRadius
    );
    
    // Enhanced animation/pulsing animation with multi-frequency modulation
    float animationPhase = sin(time * 0.6 + i * 0.8) * 0.04;
    float smoothPhase = sin(time * 0.35 + i * 1.2) * 0.03;
    float visualEffectsPhase = sin(time * 0.18 + i * 0.5) * 0.025;
    
    vec2 smoothMovement = vec2(
      sin(time * 0.3 + i * 0.7) * (animationPhase + smoothPhase),
      cos(time * 0.4 + i * 0.9) * (animationPhase + visualEffectsPhase)
    );
    
    vec2 animatedCenter = bubbleCenter + smoothMovement;
    
    // Calculate distance from current pixel to this bubble center
    float distanceToBubble = length(uv - animatedCenter);
    minBubbleDistance = min(minBubbleDistance, distanceToBubble);
  }
  
  // ===== ENHANCED BUBBLE APERTURE SIZING =====
  // Enhanced bubble size with multi-wave expansion patterns
  float baseBubbleSize = 0.08 * intensity;
  float primaryPulse = sin(time * 1.5) * 0.35;
  float smoothPulse = sin(time * 0.8) * 0.25;
  float visualEffectsPulse = sin(time * 2.2) * 0.15;
  
  float expandedBubbleSize = baseBubbleSize * (1.0 + primaryPulse + smoothPulse + visualEffectsPulse);
  
  // Create clean circular apertures with enhanced soft edges
  float primaryBubbleMask = 1.0 - smoothstep(expandedBubbleSize * 0.6, expandedBubbleSize * 1.1, minBubbleDistance);
  
  // ===== ENHANCED SECONDARY BUBBLE LAYER =====
  // Add smaller secondary bubbles with smooth movement
  float secondaryBubbleCount = 4.0 + floor(intensity * 1.0); // 4-5 secondary bubbles
  float baseSecondaryRadius = 0.15;
  float secondaryRingRadius = baseSecondaryRadius * (1.0 + sin(time * 0.12) * 0.3);
  float minSecondaryDistance = 2.0;
  
  for(float i = 0.0; i < secondaryBubbleCount; i += 1.0) {
    // Counter-rotating secondary bubbles with smooth offset
    float secondaryAngle = (i / secondaryBubbleCount) * 2.0 * 3.14159 - time * 0.15 + 1.57;
    
    // Add smooth wobble to secondary bubble positions
    float wobbleX = sin(time * 0.45 + i * 1.1) * 0.02;
    float wobbleY = cos(time * 0.55 + i * 0.8) * 0.02;
    
    vec2 secondaryCenter = vec2(0.5) + vec2(
      cos(secondaryAngle) * secondaryRingRadius + wobbleX,
      sin(secondaryAngle) * secondaryRingRadius + wobbleY
    );
    
    float distanceToSecondary = length(uv - secondaryCenter);
    minSecondaryDistance = min(minSecondaryDistance, distanceToSecondary);
  }
  
  float secondaryBubbleSize = baseBubbleSize * 0.5 * (1.0 + sin(time * 1.8) * 0.3);
  float secondaryBubbleMask = 1.0 - smoothstep(secondaryBubbleSize * 0.6, secondaryBubbleSize * 1.0, minSecondaryDistance);
  secondaryBubbleMask *= 0.75; // Make secondary bubbles dimmer for depth
  
  // ===== ENHANCED CENTER SPOTLIGHT BUBBLE =====
  // Enhanced central bubble with complex pulsing patterns
  float centerDistance = length(uv - vec2(0.5));
  float centerPrimaryPulse = sin(time * 2.0) * 0.4;
  float centerSecondaryPulse = sin(time * 3.5) * 0.2;
  float centerPulsingPulse = sin(time * 0.6) * 0.3;
  
  float centerBubbleSize = 0.06 * intensity * (1.0 + centerPrimaryPulse + centerSecondaryPulse + centerPulsingPulse);
  float centerBubbleMask = 1.0 - smoothstep(centerBubbleSize * 0.4, centerBubbleSize * 0.9, centerDistance);
  
  // ===== ENHANCED COMBINATION AND BLENDING =====
  // Use smooth maximum for smooth blending instead of hard max
  float corridorMask = primaryBubbleMask;
  corridorMask = max(corridorMask, secondaryBubbleMask * 0.9);
  corridorMask = max(corridorMask, centerBubbleMask * 1.1); // Center bubble slightly stronger
  
  // Enhanced radial falloff with smooth variation
  vec2 center = uv - vec2(0.5);
  float radialDistance = length(center);
  float smoothVariation = sin(time * 0.3 + radialDistance * 8.0) * 0.05;
  float radialFalloff = 1.0 - smoothstep(0.0, 0.65 + smoothVariation, radialDistance);
  corridorMask *= radialFalloff;
  
  // Enhanced smooth animation pattern with visualEffects harmonics
  float primaryPulsing = sin(time * 0.4) * 0.15;
  float secondaryPulsing = sin(time * 0.25) * 0.08;
  float visualEffectsPulsing = sin(time * 0.6) * 0.05;
  float animationCycle = 0.85 + primaryPulsing + secondaryPulsing + visualEffectsPulsing;
  corridorMask *= animationCycle;
  
  // Add subtle noise variation for smooth visualEffects texture
  float noisePattern = sin(radialDistance * 12.0 + time * 0.5) * cos(radialDistance * 8.0 - time * 0.3) * 0.03;
  corridorMask += noisePattern * intensity * 0.5;
  
  return clamp(corridorMask, 0.0, 1.0);
}

// Perspective depth calculation for inward flow
float calculatePerspectiveDepth(vec2 uv, float time, float flowStrength) {
  vec2 polar = toPolar(uv);
  float radius = polar.y;
  
  // Create perspective tunnel effect
  float depth = 1.0 - radius;
  depth = pow(depth, 2.2); // Gamma correction for natural falloff
  
  // Add inward flow animation
  float flowPhase = time * flowStrength + radius * 8.0;
  depth += sin(flowPhase) * 0.05 * (1.0 - radius);
  
  return clamp(depth, 0.0, 1.0);
}

// Dynamic aperture sizing based on music response
float musicResponsiveAperture(float baseMask, float beatIntensity, float bassResponse) {
  // Beat response expands apertures
  float beatExpansion = 1.0 + beatIntensity * 0.3;
  
  // Bass response adds pulsing
  float bassPulse = sin(bassResponse * 10.0) * 0.1;
  
  // Apply modulations
  float responsiveMask = baseMask * beatExpansion + bassPulse;
  
  return clamp(responsiveMask, 0.0, 1.0);
}

// ===================================================================
// DUNGEON CORRIDOR TUNNEL FUNCTIONS
// ===================================================================

// Signed distance field for rounded rectangle (corridor tunnel shape)
float roundedRectangleSDF(vec2 uv, vec2 center, vec2 size, float radius) {
  vec2 d = abs(uv - center) - size;
  return length(max(d, 0.0)) + min(max(d.x, d.y), 0.0) - radius;
}

// Apply perspective transformation for 3D tunnel illusion
vec2 perspectiveTunnelTransform(vec2 uv, float depth, float focalLength) {
  // Transform to centered coordinates
  vec2 centered = uv - 0.5;
  
  // Apply perspective projection with vanishing point at center
  float perspectiveFactor = focalLength / (focalLength + depth);
  vec2 perspective = centered * perspectiveFactor;
  
  // Return to UV space
  return perspective + 0.5;
}

// Calculate surface normal from SDF for lighting
vec2 tunnelNormalFromSDF(vec2 uv, vec2 center, vec2 size, float radius) {
  const float epsilon = 0.001;
  
  float centerSDF = roundedRectangleSDF(uv, center, size, radius);
  float rightSDF = roundedRectangleSDF(uv + vec2(epsilon, 0.0), center, size, radius);
  float upSDF = roundedRectangleSDF(uv + vec2(0.0, epsilon), center, size, radius);
  
  return normalize(vec2(rightSDF - centerSDF, upSDF - centerSDF));
}

// Advanced lighting system for dungeon corridors
vec3 calculateTunnelLighting(vec2 uv, float tunnelMask, vec2 normal, float depth, float time, float intensity) {
  // ===== AMBIENT SHADOW LAYER =====
  // Create dark base for corridor walls
  float ambientShadow = 0.15; // Base darkness level
  vec3 shadowColor = vec3(0.05, 0.08, 0.12); // Cool blue-gray shadows
  
  // ===== EDGE HIGHLIGHT LAYER =====
  // Bright rim lighting along corridor edges using surface normals
  float edgeIntensity = 1.0 - smoothstep(0.0, 0.3, tunnelMask);
  float edgeHighlight = pow(edgeIntensity, 2.0) * 0.8;
  
  // Edge lighting color shifts with music (warmer for high energy)
  vec3 edgeLightColor = mix(
    vec3(0.4, 0.5, 0.8), // Cool blue edge light
    vec3(0.8, 0.6, 0.3), // Warm orange edge light
    intensity * 0.7
  );
  
  // ===== END LIGHT SOURCE =====
  // Dynamic light at tunnel end that pulses with music
  float distanceFromCenter = length(uv - vec2(0.5));
  float endLightFalloff = 1.0 / (1.0 + distanceFromCenter * 4.0); // Inverse square falloff
  
  // Music-responsive light intensity with animation effect
  float lightPulse = sin(time * 2.0) * 0.3 + 0.7;
  float endLightIntensity = intensity * lightPulse * endLightFalloff;
  
  // End light color temperature (cooler when distant, warmer when close)
  vec3 endLightColor = mix(
    vec3(0.3, 0.4, 0.9), // Cool distant light
    vec3(0.9, 0.7, 0.4), // Warm close light  
    endLightIntensity
  );
  
  // ===== FRESNEL EFFECT =====
  // Edge lighting intensity based on viewing angle
  vec2 viewDirection = normalize(uv - vec2(0.5));
  float fresnel = pow(1.0 - abs(dot(normal, viewDirection)), 2.0);
  
  // ===== COMBINE LIGHTING LAYERS =====
  vec3 ambientLayer = shadowColor * ambientShadow;
  vec3 edgeLayer = edgeLightColor * edgeHighlight * fresnel;
  vec3 endLayer = endLightColor * endLightIntensity * tunnelMask;
  
  // Apply depth-based attenuation
  float depthAttenuation = 1.0 - smoothstep(0.0, 1.0, depth);
  
  return (ambientLayer + edgeLayer + endLayer) * depthAttenuation;
}

// Create multiple dungeon corridor tunnels with realistic lighting
float dungeonCorridorTunnels(vec2 uv, float time, float intensity) {
  // ===== MAIN CORRIDOR TUNNELS =====
  float corridorCount = 4.0;
  float minCorridorDistance = 2.0;
  
  for(float i = 0.0; i < corridorCount; i += 1.0) {
    float corridorAngle = (i / corridorCount) * 2.0 * 3.14159 + time * 0.05;
    
    // Corridor center position with slight offset for smooth feel
    vec2 corridorOffset = vec2(
      cos(corridorAngle) * 0.25,
      sin(corridorAngle) * 0.25
    );
    vec2 corridorCenter = vec2(0.5) + corridorOffset;
    
    // Apply perspective transformation for depth illusion
    float depth = 0.3 + sin(time * 0.3 + i) * 0.1;
    vec2 perspectiveUV = perspectiveTunnelTransform(uv, depth, 2.0);
    
    // Create elongated corridor tunnel shape
    vec2 corridorSize = vec2(0.15, 0.04) * (1.0 + intensity * 0.3); // Width varies with music
    float cornerRadius = 0.01;
    
    // Calculate distance to this corridor tunnel
    float corridorDistance = roundedRectangleSDF(perspectiveUV, corridorCenter, corridorSize, cornerRadius);
    minCorridorDistance = min(minCorridorDistance, corridorDistance);
  }
  
  // ===== SECONDARY TUNNEL LAYER =====
  // Add smaller secondary tunnels for depth complexity
  float secondaryCount = 2.0;
  float minSecondaryDistance = 2.0;
  
  for(float i = 0.0; i < secondaryCount; i += 1.0) {
    float secondaryAngle = (i / secondaryCount) * 2.0 * 3.14159 + time * 0.08 + 1.57;
    
    vec2 secondaryOffset = vec2(
      cos(secondaryAngle) * 0.15,
      sin(secondaryAngle) * 0.15  
    );
    vec2 secondaryCenter = vec2(0.5) + secondaryOffset;
    
    // Deeper perspective for secondary tunnels
    float secondaryDepth = 0.5 + sin(time * 0.2 + i) * 0.1;
    vec2 secondaryPerspectiveUV = perspectiveTunnelTransform(uv, secondaryDepth, 2.5);
    
    vec2 secondarySize = vec2(0.08, 0.025) * (1.0 + intensity * 0.2);
    float secondaryDistance = roundedRectangleSDF(secondaryPerspectiveUV, secondaryCenter, secondarySize, 0.005);
    minSecondaryDistance = min(minSecondaryDistance, secondaryDistance);
  }
  
  // ===== COMBINE TUNNEL LAYERS =====
  float primaryMask = 1.0 - smoothstep(0.0, 0.02, minCorridorDistance);
  float secondaryMask = 1.0 - smoothstep(0.0, 0.015, minSecondaryDistance);
  secondaryMask *= 0.7; // Dimmer secondary tunnels
  
  float combinedMask = max(primaryMask, secondaryMask);
  
  // ===== RADIAL FALLOFF FOR FOCUS =====
  vec2 center = uv - vec2(0.5);
  float radialDistance = length(center);
  float radialFalloff = 1.0 - smoothstep(0.2, 0.8, radialDistance);
  
  // ===== ORGANIC BREATHING PATTERN =====
  float animationCycle = 0.9 + sin(time * 0.4) * 0.1;
  
  return clamp(combinedMask * radialFalloff * animationCycle, 0.0, 1.0);
}

// Enhanced corridor gradient reveal with advanced dual-layer blending
vec4 corridorGradientReveal(vec2 uv, sampler2D gradientTex, float corridorMask, float time, float intensity) {
  // ===== ENHANCED BASE LAYER: Musical flow with visualEffects awareness =====
  vec2 baseFlowUV = uv;
  vec2 flowDirection = normalize(vec2(1.0, 0.0));
  
  // Enhanced musical flow with multi-frequency modulation
  #ifdef HAS_FLOW_UNIFORMS
    flowDirection = normalize(u_musicalFlow.xy + vec2(0.001, 0.0));
  #endif
  
  // Multi-layered flow animation with visualEffects patterns
  float primaryFlow = sin(time * 0.1) * 0.02;
  float smoothFlow = sin(time * 0.07) * 0.015;
  float visualEffectsFlow = sin(time * 0.13) * 0.008;
  
  baseFlowUV += flowDirection * (primaryFlow + smoothFlow + visualEffectsFlow);
  vec4 baseGradient = texture(gradientTex, vec2(baseFlowUV.x, 0.5));
  
  // Enhanced base layer with depth awareness
  vec2 polar = toPolar(uv);
  float baseDepthModulation = 1.0 + polar.y * 0.2; // Subtle depth variation
  baseGradient.rgb *= baseDepthModulation;
  
  // ===== ENHANCED CORRIDOR LAYER: Multi-dimensional inward flow =====
  float angle = polar.x;
  float radius = polar.y;
  
  // Advanced inward flow with multi-phase animation
  float primaryInwardPhase = time * 0.15 + radius * 6.0;
  float secondaryInwardPhase = time * 0.08 + radius * 4.5;
  float visualEffectsInwardPhase = time * 0.22 + radius * 8.0;
  
  // Multi-layered inward flow combining multiple patterns
  float primaryInwardFlow = radius - (sin(primaryInwardPhase) * 0.1);
  float secondaryInwardFlow = radius - (cos(secondaryInwardPhase) * 0.06);
  float visualEffectsInwardFlow = radius - (sin(visualEffectsInwardPhase) * 0.04);
  
  float combinedInwardFlow = mix(
    mix(primaryInwardFlow, secondaryInwardFlow, 0.3),
    visualEffectsInwardFlow, 0.2
  );
  
  // Enhanced gradient sampling with dual-layer coordination
  vec2 corridorFlowUV = vec2(
    fract(angle / (2.0 * 3.14159) + time * 0.02), // Slow rotation for smooth feel
    clamp(combinedInwardFlow, 0.0, 1.0)
  );
  vec4 corridorGradient = texture(gradientTex, corridorFlowUV);
  
  // ===== ADVANCED DEPTH AND PERSPECTIVE =====
  float depth = calculatePerspectiveDepth(uv, time, intensity);
  
  // Enhanced tunnel brightness with smooth variation
  float smoothBrightnessVariation = sin(angle * 3.0 + time * 0.3) * 0.1;
  float tunnelBrightness = 1.0 + depth * 0.9 + smoothBrightnessVariation;
  corridorGradient.rgb *= tunnelBrightness;
  
  // Advanced color shift with visualEffects-aware color temperature
  vec3 warmShift = vec3(1.15, 1.05, 0.85); // Warm center
  vec3 coolShift = vec3(0.9, 1.0, 1.1);    // Cool edges
  vec3 colorTemperature = mix(coolShift, warmShift, depth);
  corridorGradient.rgb = mix(corridorGradient.rgb, corridorGradient.rgb * colorTemperature, depth * 0.4);
  
  // ===== ENHANCED DUAL-LAYER BLENDING =====
  // Multi-stage aperture masking for smooth blending
  float softApertureMask = smoothstep(0.2, 0.8, corridorMask);
  float sharpApertureMask = smoothstep(0.4, 0.6, corridorMask);
  float smoothApertureMask = mix(softApertureMask, sharpApertureMask, 0.6);
  
  // Enhanced blending with visualEffects-aware mixing
  float visualEffectsBlendFactor = 0.7 + sin(time * 0.4 + radius * 4.0) * 0.2;
  float dynamicIntensity = intensity * visualEffectsBlendFactor;
  
  // Primary blend: base and corridor layers
  vec4 primaryBlend = mix(baseGradient, corridorGradient, smoothApertureMask * dynamicIntensity);
  
  // ===== ADVANCED APERTURE EFFECTS =====
  // Enhanced rim lighting with smooth variation 
  float rimLightBase = corridorMask * (1.0 - smoothApertureMask);
  float rimLightVariation = sin(angle * 4.0 + time * 0.5) * 0.3 + 0.7;
  float enhancedRimLight = rimLightBase * rimLightVariation * 0.6;
  
  // Aperture glow effect for depth illusion
  float apertureGlow = softApertureMask * (1.0 - sharpApertureMask) * 0.4;
  vec3 glowColor = corridorGradient.rgb * 1.2;
  
  // ===== VISUAL_EFFECTS-AWARE COLOR HARMONIZATION =====
  // Harmonize colors between layers for smooth visualEffects effect
  vec3 harmonizedColor = mix(
    primaryBlend.rgb,
    (primaryBlend.rgb + corridorGradient.rgb) * 0.5,
    smoothApertureMask * 0.3
  );
  
  // Final composition with enhanced rim and glow effects
  vec4 finalColor = vec4(harmonizedColor, primaryBlend.a);
  finalColor.rgb += vec3(enhancedRimLight) * dynamicIntensity;
  finalColor.rgb += glowColor * apertureGlow * dynamicIntensity;
  
  // Smooth animation effect for visualEffects integration
  float animationCycle = 0.95 + sin(time * 0.3) * 0.05;
  finalColor.rgb *= animationCycle;
  
  return finalColor;
}

// Advanced dungeon corridor gradient reveal with realistic lighting
vec4 dungeonCorridorGradientReveal(vec2 uv, sampler2D gradientTex, float corridorMask, float time, float intensity) {
  // ===== BASE LAYER: Dark stone/metal corridor walls =====
  vec4 baseWallColor = vec4(0.1, 0.12, 0.15, 1.0); // Dark stone base
  
  // ===== CORRIDOR TUNNEL CALCULATION =====
  // Use dungeon corridor tunnels instead of simple bubbles
  float tunnelMask = dungeonCorridorTunnels(uv, time, intensity);
  
  // ===== LIGHTING CALCULATION =====
  // Calculate lighting for tunnel areas
  vec2 tunnelCenter = vec2(0.5); // Simplified center for normal calculation
  vec2 tunnelSize = vec2(0.15, 0.04);
  vec2 surfaceNormal = tunnelNormalFromSDF(uv, tunnelCenter, tunnelSize, 0.01);
  
  float depth = length(uv - vec2(0.5)) * 0.5; // Distance-based depth
  vec3 tunnelLighting = calculateTunnelLighting(uv, tunnelMask, surfaceNormal, depth, time, intensity);
  
  // ===== CORRIDOR LAYER: Inward flowing magical light =====
  // Convert to polar coordinates for inward flow calculation
  vec2 polar = toPolar(uv);
  float angle = polar.x;
  float radius = polar.y;
  
  // Create magical inward flow animation - light streams toward center
  float magicalFlowPhase = time * 0.2 + radius * 8.0; // Faster flow for magical effect
  float inwardFlow = radius - (sin(magicalFlowPhase) * 0.15); // More dramatic flow
  
  // Sample gradient using inward flow for magical light colors
  vec2 corridorFlowUV = vec2(
    angle / (2.0 * 3.14159), // Normalize angle for gradient sampling
    clamp(inwardFlow, 0.0, 1.0) // Use inward flow for magical color variation
  );
  vec4 magicalLightGradient = texture(gradientTex, corridorFlowUV);
  
  // ===== ENHANCE MAGICAL LIGHT WITH MUSIC RESPONSIVENESS =====
  // Enhance magical light colors based on music intensity
  magicalLightGradient.rgb *= 1.5 + intensity * 0.8; // Brighter with music
  
  // Add magical shimmer effect
  float shimmerPhase = time * 4.0 + uv.x * 10.0 + uv.y * 8.0;
  float shimmer = sin(shimmerPhase) * 0.1 + 0.9;
  magicalLightGradient.rgb *= shimmer;
  
  // ===== DEPTH AND PERSPECTIVE EFFECTS =====
  float perspectiveDepth = calculatePerspectiveDepth(uv, time, intensity * 1.2);
  
  // Enhance magical light with depth - brighter toward tunnel end
  float tunnelEndBrightness = 1.0 + perspectiveDepth * 1.5;
  magicalLightGradient.rgb *= tunnelEndBrightness;
  
  // ===== CORRIDOR WALL TEXTURING =====
  // Add stone/metal texture to walls using noise-like patterns
  float wallTexturePhase = uv.x * 20.0 + uv.y * 15.0;
  float wallTexture = sin(wallTexturePhase) * 0.1 + 0.9;
  baseWallColor.rgb *= wallTexture;
  
  // ===== ADVANCED APERTURE BLENDING =====
  // Smooth tunnel aperture with realistic falloff
  float apertureMask = smoothstep(0.1, 0.8, tunnelMask);
  
  // ===== LIGHTING INTEGRATION =====
  // Apply calculated lighting to both wall and magical light
  vec4 litWallColor = baseWallColor;
  litWallColor.rgb += tunnelLighting; // Add ambient shadows, edge highlights, end illumination
  
  // Blend wall color with magical light streaming through tunnels
  vec4 finalColor = mix(litWallColor, magicalLightGradient, apertureMask * intensity);
  
  // ===== RIM LIGHTING FOR DEPTH ILLUSION =====
  // Enhanced rim lighting around tunnel apertures
  float rimIntensity = tunnelMask * (1.0 - apertureMask) * 0.8;
  vec3 rimColor = mix(
    vec3(0.3, 0.4, 0.8), // Cool rim light
    vec3(0.8, 0.5, 0.2), // Warm rim light
    intensity
  );
  finalColor.rgb += rimColor * rimIntensity;
  
  // ===== ATMOSPHERIC PERSPECTIVE =====
  // Add slight fog/haze effect for distance illusion
  float atmosphericHaze = depth * 0.2;
  vec3 hazeColor = vec3(0.15, 0.18, 0.25);
  finalColor.rgb = mix(finalColor.rgb, hazeColor, atmosphericHaze);
  
  return finalColor;
}`,Ts=`
// Time and resolution (universal)
uniform float u_time;
uniform vec2 u_resolution;

// Enhanced visualEffects field uniforms
uniform float u_rhythmicPulse;
uniform vec2 u_musicalFlow;
uniform float u_energyResonance;
uniform float u_animationCycle;
uniform float u_surfaceFluidityIndex;

// Advanced visualEffects control uniforms
uniform float u_visualEffectsLevel;        // 0-1 current visualEffects intensity
uniform float u_awarenessLevel;           // 0-1 current awareness depth
uniform float u_emotionalIntensity;       // 0-1 emotional resonance strength
uniform float u_memoryIntensity;          // 0-1 visualEffects memory patterns
uniform vec2 u_temporalFlowDirection;     // Year 3000 temporal stream direction
uniform float u_visualEffectsTemperature; // Color temperature shift from visualEffects

// Enhanced music sync uniforms
uniform float u_musicEnergy;
uniform float u_musicValence;
uniform float u_beatIntensity;
uniform float u_bassResponse;
uniform float u_musicalVisualEffectsSync; // Music-visualEffects synchronization level
uniform float u_genreVisualEffectsShift;  // Genre-specific visualEffects adjustments

// Corridor-specific uniforms
uniform float u_corridorIntensity;
uniform float u_corridorFlowStrength;
uniform float u_corridorDepthEffect;
uniform float u_corridorBubbleScale;

// Dungeon corridor uniforms
uniform float u_dungeonEnabled;
uniform float u_tunnelWidth;
uniform float u_lightingIntensity;
uniform float u_atmosphericHaze;
uniform vec3 u_wallColor;`,$e=class{static buildFragmentShader(e){let{precision:t="precision mediump float;",additionalUniforms:i="",additionalFunctions:a="",mainShaderLogic:r,includeNoiseFunctions:n=!0,includeVisualEffectsFunctions:s=!0,includeCorridorFunctions:o=!1}=e,l=`#version 300 es
${t}

`;return l+=Ts+`

`,i&&(l+=i+`

`),l+=`out vec4 fragColor;

`,n&&(l+=Ms+`

`),s&&(l+=Es+`

`),o&&(l+=ws+`

`),a&&(l+=a+`

`),l+=`void main() {
`,l+=`  vec2 uv = gl_FragCoord.xy / u_resolution.xy;

`,l+=r,l+=`
}`,l}static getStandardUniformNames(){return["u_time","u_resolution","u_rhythmicPulse","u_musicalFlow","u_energyResonance","u_animationCycle","u_surfaceFluidityIndex","u_visualEffectsLevel","u_awarenessLevel","u_emotionalIntensity","u_memoryIntensity","u_temporalFlowDirection","u_visualEffectsTemperature","u_musicEnergy","u_musicValence","u_beatIntensity","u_bassResponse","u_musicalVisualEffectsSync","u_genreVisualEffectsShift"]}static getWebGLUniformNames(){return[...this.getStandardUniformNames(),"u_gradientTex","u_flowStrength","u_noiseScale","u_colorIntensity","u_patternScale","u_animationSpeed"]}static getLiquidUniformNames(){return[...this.getStandardUniformNames(),"u_gradientTex","u_flowStrength","u_noiseScale","u_liquidPhase","u_animationIntensity","u_auroraFlow","u_flowDirection","u_liquidTurbulence","u_visualEffectsDepth","u_waveY","u_waveHeight","u_waveOffset","u_blurExp","u_blurMax"]}static getCorridorUniformNames(){return["u_time","u_resolution","u_gradientTex","u_rhythmicPulse","u_musicalFlow","u_energyResonance","u_animationCycle","u_surfaceFluidityIndex","u_musicEnergy","u_musicValence","u_beatIntensity","u_bassResponse","u_corridorIntensity","u_corridorFlowStrength","u_corridorDepthEffect","u_corridorBubbleScale"]}static getDungeonCorridorUniformNames(){return[...this.getCorridorUniformNames(),"u_dungeonEnabled","u_tunnelWidth","u_lightingIntensity","u_atmosphericHaze","u_wallColor"]}},Q=class{static musicFlowLogic(){return`
  // Calculate enhanced music-driven flow
  vec2 flowDirection = calculateMusicalFlow(vec2(1.0, 0.5), u_musicalFlow, 0.5);
  float flowStrength = rhythmicPulseModulation(0.5, u_rhythmicPulse, 0.3);
  
  // Add temporal flow patterns for Year 3000 effects
  vec2 temporalFlow = temporalFlowDirection(uv, u_time, u_temporalFlowDirection);
  flowDirection += temporalFlow;
  
  // Apply enhanced animation modulation with emotional resonance
  float animationMod = deepVisualEffectsPulsing(u_time, 0.0, u_emotionalIntensity);
  flowStrength *= (1.0 + animationMod);
  
  // Apply visualEffects field intensity
  float fieldIntensity = visualEffectsFieldIntensity(uv, u_time, u_musicEnergy);
  flowStrength *= (0.5 + fieldIntensity * 0.5);`}static audioNoiseSampling(){return`
  // Generate enhanced audio-modulated noise
  vec2 noiseUV = uv + flowDirection * u_time * 0.03;
  
  // Multi-layered visualEffects noise patterns
  float noise1 = snoise(noiseUV * 2.0);
  float noise2 = snoise(noiseUV * 4.0) * 0.5;
  float memoryNoise = snoise(noiseUV * 1.5 + u_time * 0.01) * u_memoryIntensity * 0.3;
  
  // Apply visualEffects field modulation
  float visualEffectsModulation = visualEffectsFieldIntensity(noiseUV, u_time, u_musicEnergy);
  
  // Combine noise with enhanced visualEffects influence
  float t = (noise1 + noise2 + memoryNoise) * energyResonanceModulation(1.0, u_energyResonance, 0.5, 1.5);
  t *= visualEffectsModulation;
  t = clamp(t * 0.5 + 0.5, 0.0, 1.0);`}static visualEffectsVignette(){return`
  // Apply enhanced visualEffects-aware vignette
  vec2 center = uv - 0.5;
  float animation = deepVisualEffectsPulsing(u_time, u_animationCycle, u_emotionalIntensity);
  
  // Add surface visualEffects flow for smooth boundaries
  float surfaceFlow = surfaceVisualEffectsFlow(uv, u_surfaceFluidityIndex, u_awarenessLevel);
  
  // Calculate visualEffects-aware vignette with surface dynamics
  float vignette = (0.9 + animation + surfaceFlow) - dot(center, center) * 0.3;
  
  // Apply awareness resonance to color
  color.rgb = awarenessResonance(color.rgb, u_visualEffectsLevel, u_musicEnergy);
  color.rgb *= vignette;`}static musicResponsiveAlpha(){return`
  // Music-responsive alpha modulation
  float musicAlpha = 0.8 + u_beatIntensity * 0.2 + u_bassResponse * 0.1;
  color.a *= musicAlpha;`}static auroraShimmerEffect(){return`
  // Aurora shimmer overlay
  float shimmerPhase = u_time * 3.0 + uv.x * 15.0 + uv.y * 10.0;
  float shimmer = sin(shimmerPhase) * 0.03 + 0.97;
  color.rgb *= shimmer;`}},pr=class{static webglGradientFragment(){return`
  ${Q.musicFlowLogic()}
  
  // WebGL-specific gradient sampling
  ${Q.audioNoiseSampling()}
  
  // Sample gradient texture
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  
  // Apply visualEffects effects
  ${Q.visualEffectsVignette()}
  ${Q.musicResponsiveAlpha()}
  
  fragColor = color;`}static liquidEffectsFragment(){return`
  ${Q.musicFlowLogic()}
  
  // Liquid-specific turbulence and phase
  float liquidPhase = u_liquidPhase + u_rhythmicPulse * 0.5;
  vec2 turbulenceUV = uv * u_liquidTurbulence;
  float turbulence = snoise(turbulenceUV + u_time * 0.01);
  
  // Liquid visualEffects noise
  vec2 liquidUV = uv + flowDirection * u_time * 0.03;
  liquidUV += vec2(sin(u_time * 0.04 + liquidPhase), cos(u_time * 0.03 + liquidPhase)) * 0.02;
  float liquidNoise = snoise(liquidUV * 2.0 + turbulence * 0.1);
  
  float t = clamp(liquidNoise * 0.5 + 0.5, 0.0, 1.0);
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  
  ${Q.visualEffectsVignette()}
  ${Q.auroraShimmerEffect()}
  ${Q.musicResponsiveAlpha()}
  
  fragColor = color;`}static corridorBubbleFragment(){return`
  ${Q.musicFlowLogic()}
  
  // Calculate corridor bubble mask
  float corridorMask = bubbleCorridors(uv, u_time, u_corridorIntensity * u_corridorBubbleScale);
  
  // Apply music-responsive aperture modulation
  corridorMask = musicResponsiveAperture(corridorMask, u_beatIntensity, u_bassResponse);
  
  // Generate corridor gradient reveal effect
  vec4 color = corridorGradientReveal(uv, u_gradientTex, corridorMask, u_time, u_corridorIntensity);
  
  // Apply visualEffects effects
  ${Q.visualEffectsVignette()}
  
  // Enhanced music responsiveness for corridor effects
  float corridorMusicAlpha = 0.85 + u_beatIntensity * 0.15 + u_bassResponse * 0.05;
  color.a *= corridorMusicAlpha;
  
  // Apply corridor depth effect for enhanced dimensionality
  float depth = calculatePerspectiveDepth(uv, u_time, u_corridorFlowStrength);
  color.rgb = mix(color.rgb, color.rgb * (1.0 + depth * 0.3), u_corridorDepthEffect);
  
  fragColor = color;`}static dungeonCorridorFragment(){return`
  ${Q.musicFlowLogic()}
  
  // Calculate dungeon corridor tunnel mask
  float corridorMask = dungeonCorridorTunnels(uv, u_time, u_corridorIntensity * u_corridorBubbleScale);
  
  // Apply music-responsive corridor modulation  
  corridorMask = musicResponsiveAperture(corridorMask, u_beatIntensity, u_bassResponse);
  
  // Generate advanced dungeon corridor gradient reveal effect with realistic lighting
  vec4 color = dungeonCorridorGradientReveal(uv, u_gradientTex, corridorMask, u_time, u_corridorIntensity);
  
  // Apply visualEffects effects for smooth integration
  ${Q.visualEffectsVignette()}
  
  // Enhanced music responsiveness for dungeon atmosphere
  float dungeonMusicAlpha = 0.9 + u_beatIntensity * 0.1 + u_bassResponse * 0.05;
  color.a *= dungeonMusicAlpha;
  
  // Apply corridor depth effect for enhanced dimensionality
  float depth = calculatePerspectiveDepth(uv, u_time, u_corridorFlowStrength);
  color.rgb = mix(color.rgb, color.rgb * (1.0 + depth * 0.4), u_corridorDepthEffect);
  
  // Add subtle magical shimmer for mystical atmosphere
  float magicalShimmer = sin(u_time * 5.0 + uv.x * 12.0 + uv.y * 8.0) * 0.05 + 0.95;
  color.rgb *= magicalShimmer;
  
  fragColor = color;`}static advancedVisualEffectsFieldFragment(){return`
  ${Q.musicFlowLogic()}
  
  // Calculate multi-dimensional visualEffects field
  float visualEffectsField = visualEffectsFieldIntensity(uv, u_time, u_musicEnergy);
  
  // Apply temporal flow effects for Year 3000 streaming
  vec2 temporalUV = uv + temporalFlowDirection(uv, u_time, u_temporalFlowDirection);
  
  // Enhanced visualEffects noise sampling with memory patterns
  ${Q.audioNoiseSampling()}
  
  // Sample gradient with visualEffects field modulation
  vec4 color = texture(u_gradientTex, vec2(t * visualEffectsField, 0.5));
  
  // Apply awareness resonance for visualEffects-aware color
  color.rgb = awarenessResonance(color.rgb, u_visualEffectsLevel, u_musicEnergy);
  
  // Enhanced surface visualEffects effects
  float surfaceEffect = surfaceVisualEffectsFlow(temporalUV, u_surfaceFluidityIndex, u_awarenessLevel);
  color.rgb *= (1.0 + surfaceEffect * 0.3);
  
  // Apply visualEffects memory animation
  float memoryPulsing = visualEffectsMemoryPulsing(u_time, u_animationCycle, u_memoryIntensity);
  color.a *= (0.8 + memoryPulsing * 0.2 + u_beatIntensity * 0.1);
  
  // Enhanced visualEffects vignette
  ${Q.visualEffectsVignette()}
  
  fragColor = color;`}static surfaceVisualEffectsDynamicsFragment(){return`
  ${Q.musicFlowLogic()}
  
  // Calculate surface visualEffects position with flow
  vec2 surfaceUV = uv;
  surfaceUV += temporalFlowDirection(uv, u_time, u_temporalFlowDirection);
  
  // Apply surface visualEffects flow for smooth boundaries
  float surfaceFlow = surfaceVisualEffectsFlow(surfaceUV, u_surfaceFluidityIndex, u_awarenessLevel);
  surfaceUV += vec2(surfaceFlow * 0.02);
  
  // Enhanced noise sampling with surface distortion
  vec2 noiseUV = surfaceUV + flowDirection * u_time * 0.03;
  float surfaceNoise = snoise(noiseUV * 3.0 + surfaceFlow);
  float visualEffectsNoise = snoise(noiseUV * 1.5) * u_visualEffectsLevel;
  
  // Combine surface and visualEffects noise
  float t = (surfaceNoise * 0.6 + visualEffectsNoise * 0.4) * 0.5 + 0.5;
  t = clamp(t, 0.0, 1.0);
  
  // Sample gradient with surface visualEffects modulation
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  
  // Apply visualEffects field influence to surface
  float fieldInfluence = visualEffectsFieldIntensity(surfaceUV, u_time, u_musicEnergy);
  color.rgb = awarenessResonance(color.rgb, fieldInfluence, u_musicEnergy);
  
  // Enhanced surface animation with emotional resonance
  float surfacePulsing = deepVisualEffectsPulsing(u_time, u_animationCycle, u_emotionalIntensity);
  color.rgb *= (0.9 + surfacePulsing * 0.2 + surfaceFlow * 0.1);
  
  // Musical visualEffects synchronization
  color.a *= (0.85 + u_musicalVisualEffectsSync * 0.15 + u_beatIntensity * 0.1);
  
  // Apply enhanced vignette with surface dynamics
  ${Q.visualEffectsVignette()}
  
  fragColor = color;`}},fr=class{static generateOptimizedShader(e,t){switch(t){case"high":return e;case"medium":return e.replace(/snoise\(.*?\)/g,"snoise($1)").replace(/\* 0\.0[1-9]/g,"* 0.02");case"low":return e.replace(/snoise\(.*?\) \* 0\.[0-9]+/g,"0.5").replace(/sin\(.*?\) \* 0\.[0-9]+/g,"0.0");default:return e}}static calculateShaderComplexity(e){let t=0;return t+=(e.match(/snoise/g)||[]).length*10,t+=(e.match(/sin|cos|tan/g)||[]).length*2,t+=(e.match(/texture/g)||[]).length*3,t+=(e.match(/mix|smoothstep/g)||[]).length*1,t}static generateFallbackShader(){return $e.buildFragmentShader({includeNoiseFunctions:!1,includeVisualEffectsFunctions:!1,additionalUniforms:"uniform sampler2D u_gradientTex;",mainShaderLogic:`
  // Minimal fallback visualEffects shader
  float t = uv.x + sin(u_time * 0.5 + u_rhythmicPulse) * 0.1;
  t = clamp(t, 0.0, 1.0);
  
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  color.a *= 0.8 + u_beatIntensity * 0.2;
  
  fragColor = color;`})}},yr={Template:$e,VERTEX_SHADER:Gc,NOISE_FUNCTIONS:Ms,VISUAL_EFFECTS_FUNCTIONS:Es,CORRIDOR_FUNCTIONS:ws,STANDARD_UNIFORMS:Ts,LogicPatterns:Q,Fragments:pr,Optimization:fr,AdvancedEffects:{VISUAL_EFFECTS_FIELD_PATTERNS:["visualEffectsFieldIntensity","awarenessResonance","temporalFlowDirection","surfaceVisualEffectsFlow","visualEffectsMemoryPulsing"],YEAR_3000_PATTERNS:["temporalFlowDirection","visualEffectsMemoryPulsing","deepVisualEffectsPulsing"],MEMBRANE_DYNAMICS:["surfaceVisualEffectsFlow","surfaceFluidityEffect"]}}});var Hc,_c,Vt,As=y(()=>{"use strict";U();$();L();ue();x();Tt();de();Ps();Hc=$e.buildFragmentShader({additionalUniforms:`
// WebGL-specific uniforms
uniform sampler2D u_gradientTex;
uniform float u_flowStrength;
uniform float u_noiseScale;
uniform float u_colorIntensity;
uniform float u_patternScale;
uniform float u_animationSpeed;

// Wave stack uniforms
uniform float u_waveY[2];
uniform float u_waveHeight[2];
uniform float u_waveOffset[2];
uniform float u_blurExp;
uniform float u_blurMax;`,additionalFunctions:`
// Octave noise for richer detail
float octaveNoise(vec2 uv, float octaves, float persistence, float scale) {
  float value = 0.0;
  float amplitude = 1.0;
  float frequency = scale;
  float maxValue = 0.0;

  for(float i = 0.0; i < octaves; i++) {
    value += snoise(uv * frequency) * amplitude;
    maxValue += amplitude;
    amplitude *= persistence;
    frequency *= 2.0;
  }

  return value / maxValue;
}

// Wave alpha calculation
float waveAlpha(vec2 uv, int waveIndex) {
  float y = uv.y;
  float waveCenter = u_waveY[waveIndex];
  float waveHeight = u_waveHeight[waveIndex];

  float distance = abs(y - waveCenter);
  return 1.0 - smoothstep(0.0, waveHeight * 0.5, distance);
}

// Dynamic blur calculation
float calculateBlur(vec2 uv) {
  vec2 center = vec2(0.5, 0.5);
  float distance = length(uv - center);
  float blur = pow(distance, u_blurExp);
  return clamp(blur, 0.0, u_blurMax);
}`,mainShaderLogic:yr.Fragments.webglGradientFragment()}),_c=$e.buildFragmentShader({additionalUniforms:`
// WebGL-specific uniforms
uniform sampler2D u_gradientTex;
uniform float u_flowStrength;
uniform float u_noiseScale;`,includeCorridorFunctions:!0,mainShaderLogic:yr.Fragments.corridorBubbleFragment()}),Vt=class extends j{constructor(t=E,i,a,r=null,n=null,s=null){super(t,i,a,r,n);this.canvas=null;this.wrapper=null;this.gl=null;this.shaderProgram=null;this.corridorShaderProgram=null;this.uniforms={};this.corridorUniforms={};this.gradientTexture=null;this.vertexBuffer=null;this.vao=null;this.settings={enabled:!0,intensity:"balanced",webglPersistenceMode:"adaptive",flowStrength:.7,noiseScale:1.2,waveY:[.25,.75],waveHeight:[.4,.3],waveOffset:[2.5,-1.8],blurExp:1.2,blurMax:.6,corridorEnabled:!1,corridorIntensity:.8,corridorFlowStrength:1.2,corridorDepthEffect:.6,corridorBubbleScale:1};this.isWebGLAvailable=!1;this.animationId=null;this.startTime=0;this.lastFrameTime=0;this.frameThrottleInterval=1e3/45;this.colorHarmonyEngine=null;this.cssVisualEffectsController=null;this.eventSubscriptionIds=[];this.prefersReducedMotion=!1;this.visualEffectsChoreographer=null;this.currentVisualEffectsField=null;this.webglReady=!1;this.textureUpdatePending=!1;this.lastTextureUpdate=0;this.textureUpdateDebounceTimer=null;this.textureUpdateThrottleMs=50;this.textureUpdateDebounceMs=300;this.textureCreationInProgress=!1;this.contextLost=!1;this.pendingContextRestore=!1;this.contextLossCount=0;this.maxContextLossRetries=10;this.lastSuccessfulRender=0;this.contextRecoveryTimeouts=[100,200,400,800,1600,3200,5e3,5e3,5e3,5e3];this.currentRecoveryAttempt=0;this.currentQualityLevel=null;this.qualityCapabilities=[{name:"webgl-rendering",enabled:!0,qualityLevel:"high"},{name:"shader-complexity",enabled:!0,qualityLevel:"high"},{name:"noise-octaves",enabled:!0,qualityLevel:"medium"},{name:"wave-layers",enabled:!0,qualityLevel:"medium"},{name:"blur-effects",enabled:!0,qualityLevel:"low"},{name:"flow-strength",enabled:!0,qualityLevel:"low"},{name:"corridor-effects",enabled:!0,qualityLevel:"high"},{name:"corridor-sdf-complexity",enabled:!0,qualityLevel:"medium"},{name:"corridor-bubble-layers",enabled:!0,qualityLevel:"medium"},{name:"corridor-depth-effects",enabled:!0,qualityLevel:"low"}];this.qualityAdjustments={};this.systemName="WebGLGradientBackgroundSystem";this.lastColorHarmonizedData=null;this.lastColorHarmonizedTime=0;this.animate=()=>{if(!this.isActive||!this.gl||!this.canvas)return;let t=performance.now();if(t-this.lastFrameTime<this.frameThrottleInterval){this.animationId=requestAnimationFrame(this.animate);return}this.lastFrameTime=t,this.render(t),this.animationId=requestAnimationFrame(this.animate)};this.resize=()=>{if(!this.canvas)return;let t=window.devicePixelRatio||1,i=window.innerWidth,a=window.innerHeight;this.canvas.width=i*t,this.canvas.height=a*t,this.canvas.style.width=i+"px",this.canvas.style.height=a+"px"};this.colorHarmonyEngine=s?.colorHarmonyEngine||null,this.visualEffectsChoreographer=s?.backgroundVisualEffectsChoreographer||null,this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches}get systemPriority(){return"high"}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();let t=globalThis.year3000System;if(this.cssController=t?.cssVisualEffectsController||P(),this.isWebGLAvailable=this.checkWebGL2Support(),!this.isWebGLAvailable)if(this.shouldAttemptWebGLRecovery()){if(u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL2 not available but persistence mode enabled - attempting WebGL1 compatibility mode"),this.isWebGLAvailable=this.checkWebGL1Support(),!this.isWebGLAvailable){u?.debug?.error("WebGLGradientBackgroundSystem","Neither WebGL2 nor WebGL1 available despite persistence mode"),this.fallbackToCSSGradient();return}}else{this.fallbackToCSSGradient();return}let i=new N;await i.initialize();let a=i.recommendPerformanceQuality(),r=i.getCapabilities();if(a==="low"?(u?.debug?.log("WebGLGradientBackgroundSystem","Low performance device detected - trying minimal WebGL quality",{performanceQuality:a,deviceCapabilities:r?.overall,memoryLevel:r?.memory.level,gpuLevel:r?.gpu.level}),this.frameThrottleInterval=1e3/20,this.textureUpdateThrottleMs=1e3,this.settings.corridorEnabled=!1,this.settings.intensity="minimal",this.settings.flowStrength=.3):u?.debug?.log("WebGLGradientBackgroundSystem","Device capabilities acceptable for WebGL",{performanceQuality:a,deviceCapabilities:r?.overall}),this.loadSettings(),!this.settings.enabled){this.fallbackToCSSGradient();return}try{await this.initializeWebGL(),this.subscribeToEvents(),this.registerWithVisualEffectsChoreographer(),this.startAnimation();let n={"--sn.bg.webgl.ready":"1","--sn.bg.webgl.enabled":"1","--sn.bg.active-backend":"hybrid","--sn-gradient-crossfade-opacity":"0.5"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",n,"high","webgl-initialization"),u?.debug?.log("WebGLGradientBackgroundSystem","WebGL gradient system initialized successfully")}catch(n){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to initialize WebGL gradient:",n),this.fallbackToCSSGradient()}}checkWebGL2Support(){try{let i=document.createElement("canvas").getContext("webgl2");if(!i)return u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL2 context creation failed"),!1;let a=["EXT_color_buffer_float"],r=[];for(let o of a)i.getExtension(o)||r.push(o);r.length>0&&u?.debug?.warn("WebGLGradientBackgroundSystem","Missing WebGL2 extensions:",r);let n=i.getParameter(i.MAX_TEXTURE_SIZE),s=i.getParameter(i.MAX_RENDERBUFFER_SIZE);return u?.debug?.log("WebGLGradientBackgroundSystem","WebGL2 capability check:",{maxTextureSize:n,maxRenderbufferSize:s,missingExtensions:r.length>0?r:"none"}),!0}catch(t){return u?.debug?.error("WebGLGradientBackgroundSystem","WebGL2 support check failed:",t),!1}}checkWebGL1Support(){try{let t=document.createElement("canvas"),i=t.getContext("webgl")||t.getContext("experimental-webgl");if(!i)return u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL1 context creation failed"),!1;let a=i.getParameter(i.MAX_TEXTURE_SIZE),r=i.getParameter(i.MAX_RENDERBUFFER_SIZE);return u?.debug?.log("WebGLGradientBackgroundSystem","WebGL1 fallback capability check:",{maxTextureSize:a,maxRenderbufferSize:r}),!0}catch(t){return u?.debug?.error("WebGLGradientBackgroundSystem","WebGL1 support check failed:",t),!1}}findSpotifyContainer(){let t=[".Root__main-view",".main-view-container",".main-gridContainer-gridContainer",".Root__top-container","body"];for(let i of t){let a=document.querySelector(i);if(a)return u?.debug?.log("WebGLGradientBackgroundSystem",`Found container: ${i}`),a}return u?.debug?.warn("WebGLGradientBackgroundSystem","No Spotify container found, falling back to body"),document.body}loadSettings(){if(this.settingsManager)try{let t=this.settingsManager.get("sn-webgl-enabled"),i=this.settingsManager.get("sn-webgl-force-enabled"),a=this.settingsManager.get("sn-webgl-persistence-mode"),r=this.settingsManager.get("sn-gradient-intensity");if(t==="false"&&i!=="true"){this.settings.enabled=!1,u?.debug?.log("WebGLGradientBackgroundSystem","WebGL disabled by user setting");return}if(this.settings.webglPersistenceMode=a||"adaptive",r==="disabled"){this.settings.enabled=!1;return}switch(this.settings.intensity=r||"balanced",this.settings.intensity){case"minimal":this.settings.flowStrength=.4,this.settings.noiseScale=.8,this.settings.waveHeight=[.3,.2],this.settings.waveOffset=[1.5,-1],this.settings.blurExp=1,this.settings.blurMax=.4;break;case"balanced":this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.waveOffset=[2.5,-1.8],this.settings.blurExp=1.2,this.settings.blurMax=.6;break;case"intense":this.settings.flowStrength=1,this.settings.noiseScale=1.6,this.settings.waveHeight=[.5,.4],this.settings.waveOffset=[3.5,-2.5],this.settings.blurExp=1.4,this.settings.blurMax=.8;break}u?.debug?.log("WebGLGradientBackgroundSystem","Settings loaded:",{webglEnabled:t,webglForceEnabled:i,persistenceMode:this.settings.webglPersistenceMode,intensity:this.settings.intensity,enabled:this.settings.enabled})}catch(t){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to load settings, using defaults:",t)}}applyUpdatedSettings(t,i){if(this.settingsManager){u?.debug?.log("WebGLGradientBackgroundSystem",`Runtime setting changed: ${t} = ${i}`);try{switch(t){case"sn-webgl-enabled":i==="false"?(this.settings.enabled=!1,this.destroy()):i==="true"&&!this.settings.enabled&&(this.settings.enabled=!0,!this.gl&&this.canvas&&this.initialize());break;case"sn-webgl-force-enabled":this.settingsManager.get("sn-webgl-enabled")==="false"&&i!=="true"&&(this.settings.enabled=!1,this.destroy());break;case"sn-webgl-persistence-mode":this.settings.webglPersistenceMode=i||"adaptive",u?.debug?.log("WebGLGradientBackgroundSystem",`Persistence mode changed to: ${this.settings.webglPersistenceMode}`);break;case"sn-gradient-intensity":if(i==="disabled")this.settings.enabled=!1;else switch(this.settings.enabled=!0,this.settings.intensity=i||"balanced",this.settings.intensity){case"minimal":this.settings.flowStrength=.4,this.settings.noiseScale=.8,this.settings.waveHeight=[.3,.2],this.settings.waveOffset=[1.5,-1],this.settings.blurExp=1,this.settings.blurMax=.4;break;case"balanced":this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.waveOffset=[2.5,-1.8],this.settings.blurExp=1.2,this.settings.blurMax=.6;break;case"intense":this.settings.flowStrength=1,this.settings.noiseScale=1.6,this.settings.waveHeight=[.5,.4],this.settings.waveOffset=[3.5,-2.5],this.settings.blurExp=1.4,this.settings.blurMax=.8;break}break;default:return}this.forceRepaint?.(`setting-change:${t}`)}catch(a){u?.debug?.error("WebGLGradientBackgroundSystem",`Failed to apply runtime setting ${t}:`,a)}}}async initializeWebGL(){this.wrapper=document.createElement("div"),this.wrapper.className="sn-gradient-effects-wrapper",this.wrapper.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -11;
      pointer-events: none;
      overflow: hidden;
    `,this.canvas=document.createElement("canvas"),this.canvas.id="sn-webgl-gradient",this.canvas.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    `,this.wrapper.appendChild(this.canvas);try{if(this.gl=this.canvas.getContext("webgl2",{alpha:!0,antialias:!1,depth:!1,stencil:!1,powerPreference:"default"}),!this.gl)throw new Error("WebGL2 context creation returned null - likely unsupported");this.setupContextLossHandlers();let i=this.gl.getParameter(this.gl.VERSION);if(!i)throw new Error("WebGL2 context appears non-functional - getParameter failed");u?.debug?.log("WebGLGradientBackgroundSystem","WebGL2 context created successfully:",{version:i,renderer:this.gl.getParameter(this.gl.RENDERER),vendor:this.gl.getParameter(this.gl.VENDOR)})}catch(i){throw u?.debug?.error("WebGLGradientBackgroundSystem","WebGL2 context creation failed:",i),new Error(`Failed to create WebGL2 context: ${i instanceof Error?i.message:"Unknown error"}`)}await this.compileShaders(),this.createGeometry(),await this.updateGradientTexture(),this.setupUniforms(),this.resize(),this.findSpotifyContainer().appendChild(this.wrapper),window.addEventListener("resize",this.resize.bind(this))}async compileShaders(){if(!this.gl)throw new Error("WebGL context not available");let t=null,i=null,a="full";if(t=te.loadVertex(this.gl,wt),!t)throw new Error("Failed to compile vertex shader - even basic vertex shader failed");let r=[{name:"full",shader:Hc,description:"Full visualEffects shader with all features"},{name:"simplified",shader:this.getSimplifiedFragmentShader(),description:"Simplified shader without complex noise functions"},{name:"basic",shader:this.getBasicFragmentShader(),description:"Basic gradient shader with minimal features"},{name:"emergency",shader:this.getEmergencyFragmentShader(),description:"Emergency shader for maximum hardware compatibility"}];for(let s of r)try{if(i=te.loadFragment(this.gl,s.shader),i){a=s.name,u?.debug?.log("WebGLGradientBackgroundSystem",`Successfully compiled shader variant: ${s.name}`,{description:s.description});break}}catch(o){u?.debug?.warn("WebGLGradientBackgroundSystem",`Failed to compile ${s.name} shader variant:`,o);continue}if(!i)throw new Error("Failed to compile any fragment shader variant");if(this.shaderProgram=te.createProgram(this.gl,t,i),!this.shaderProgram)throw new Error("Failed to create shader program");let n=te.loadFragment(this.gl,_c);if(!n){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to compile corridor shader - corridor effects disabled"),this.settings.corridorEnabled=!1;return}this.corridorShaderProgram=te.createProgram(this.gl,t,n),this.corridorShaderProgram||(u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to create corridor shader program - corridor effects disabled"),this.settings.corridorEnabled=!1)}createGeometry(){if(!this.gl||!this.shaderProgram)return;let t=new Float32Array([-1,-1,3,-1,-1,3]);this.vertexBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW),this.vao=this.gl.createVertexArray(),this.gl.bindVertexArray(this.vao);let i=this.gl.getAttribLocation(this.shaderProgram,"a_position");this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,0,0),this.gl.bindVertexArray(null)}setupUniforms(){!this.gl||!this.shaderProgram||(this.uniforms.u_time=this.gl.getUniformLocation(this.shaderProgram,"u_time"),this.uniforms.u_gradientTex=this.gl.getUniformLocation(this.shaderProgram,"u_gradientTex"),this.uniforms.u_resolution=this.gl.getUniformLocation(this.shaderProgram,"u_resolution"),this.uniforms.u_flowStrength=this.gl.getUniformLocation(this.shaderProgram,"u_flowStrength"),this.uniforms.u_noiseScale=this.gl.getUniformLocation(this.shaderProgram,"u_noiseScale"),this.uniforms.u_waveY=this.gl.getUniformLocation(this.shaderProgram,"u_waveY"),this.uniforms.u_waveHeight=this.gl.getUniformLocation(this.shaderProgram,"u_waveHeight"),this.uniforms.u_waveOffset=this.gl.getUniformLocation(this.shaderProgram,"u_waveOffset"),this.uniforms.u_blurExp=this.gl.getUniformLocation(this.shaderProgram,"u_blurExp"),this.uniforms.u_blurMax=this.gl.getUniformLocation(this.shaderProgram,"u_blurMax"),this.corridorShaderProgram&&this.setupCorridorUniforms())}setupCorridorUniforms(){if(!this.gl||!this.corridorShaderProgram)return;let t=$e.getCorridorUniformNames();for(let i of t)this.corridorUniforms[i]=this.gl.getUniformLocation(this.corridorShaderProgram,i)}updateVisualEffectsUniforms(t,i){if(!this.gl)return;let a=this.currentVisualEffectsField,r=a?.pulseRate??.5;t.u_rhythmicPulse&&this.gl.uniform1f(t.u_rhythmicPulse,r);let n=a?.flowDirection??{x:0,y:0};t.u_musicalFlow&&n&&this.gl.uniform2f(t.u_musicalFlow,n.x??0,n.y??0);let s=a?.energyLevel??.5;t.u_energyResonance&&this.gl.uniform1f(t.u_energyResonance,s);let o=Math.sin(i*.05)*.5+.5;t.u_pulsingCycle&&this.gl.uniform1f(t.u_pulsingCycle,o);let l=a?.fluidIntensity??.3;if(t.u_surfaceFluidityIndex&&this.gl.uniform1f(t.u_surfaceFluidityIndex,l),this.musicSyncService){let m=this.musicSyncService.getCurrentMusicState();if(m){let d=m.beat?.energy??.5,h=m.emotion?.valence??.5,g=m.intensity??0,f=m.beat?.energy??0;t.u_musicEnergy&&this.gl.uniform1f(t.u_musicEnergy,d),t.u_musicValence&&this.gl.uniform1f(t.u_musicValence,h),t.u_beatIntensity&&this.gl.uniform1f(t.u_beatIntensity,g),t.u_bassResponse&&this.gl.uniform1f(t.u_bassResponse,f)}}}async updateGradientTexture(){if(!this.gl){u?.debug?.warn("WebGLGradientBackgroundSystem","No WebGL context available");return}if(!this.isContextValid()){u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL context invalid, attempting recovery"),this.contextLost&&!this.pendingContextRestore&&(u?.debug?.log("WebGLGradientBackgroundSystem","Attempting WebGL context recovery"),this.fallbackToCSSGradient());return}let t=this.gl.getError();if(t!==this.gl.NO_ERROR)for(u?.debug?.warn("WebGLGradientBackgroundSystem",`WebGL error detected before texture update: ${t}`);this.gl.getError()!==this.gl.NO_ERROR;);if(this.textureCreationInProgress){u?.debug?.log("WebGLGradientBackgroundSystem","Texture creation already in progress, skipping update");return}this.textureCreationInProgress=!0;try{let i=this.getDefaultGradientStops(),a="default";if(this.colorHarmonyEngine)try{let o=this.colorHarmonyEngine.getCurrentGradient(5);if(o&&o.length>0)i=o.map((l,m)=>({r:l.r/255,g:l.g/255,b:l.b/255,a:1,position:m/(o.length-1)})),a="ColorHarmonyEngine",u?.debug?.log("WebGLGradientBackgroundSystem",`Updated gradient texture with ${i.length} stops from ColorHarmonyEngine`);else{let l=this.getCSSGradientStops();l&&l.length>0&&(i=l,a="CSS variables",u?.debug?.log("WebGLGradientBackgroundSystem",`ColorHarmonyEngine returned empty, using CSS gradient fallback with ${i.length} stops`))}}catch(o){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to get gradient from ColorHarmonyEngine, trying CSS fallback:",o);let l=this.getCSSGradientStops();l&&l.length>0&&(i=l,a="CSS variables (engine failed)",u?.debug?.log("WebGLGradientBackgroundSystem",`Using CSS gradient fallback after ColorHarmonyEngine error with ${i.length} stops`))}else{let o=this.getCSSGradientStops();o&&o.length>0&&(i=o,a="CSS variables (no engine)",u?.debug?.log("WebGLGradientBackgroundSystem",`No ColorHarmonyEngine available, using CSS gradient fallback with ${i.length} stops`))}if(u?.debug?.log("WebGLGradientBackgroundSystem",`Final color source: ${a}, stops: ${i.length}`),this.gl.isContextLost())throw new Error("WebGL context was lost during gradient preparation");if(this.gradientTexture){try{this.gl.deleteTexture(this.gradientTexture)}catch(o){u?.debug?.warn("WebGLGradientBackgroundSystem","Error deleting old texture:",o)}this.gradientTexture=null}(!i||i.length===0)&&(u?.debug?.warn("WebGLGradientBackgroundSystem","No valid color stops, using defaults"),i=this.getDefaultGradientStops());let r=null,n=0,s=3;for(;!r&&n<s;){n++;try{if(this.gl.isContextLost())throw new Error("WebGL context lost during texture creation attempt");if(r=oe(this.gl,i),r){u?.debug?.log("WebGLGradientBackgroundSystem",`Gradient texture created successfully on attempt ${n}`);break}}catch(o){u?.debug?.warn("WebGLGradientBackgroundSystem",`Texture creation attempt ${n} failed:`,o),n<s&&await new Promise(l=>setTimeout(l,n*10))}}if(r)this.gradientTexture=r;else{u?.debug?.error("WebGLGradientBackgroundSystem","Failed to create gradient texture after all attempts - trying default colors");try{let o=this.getDefaultGradientStops(),l=oe(this.gl,o);if(!l)throw new Error("Failed to create gradient texture even with default colors");this.gradientTexture=l,i=o,u?.debug?.log("WebGLGradientBackgroundSystem","Using default gradient fallback after all attempts failed")}catch(o){u?.debug?.error("WebGLGradientBackgroundSystem","Default gradient fallback failed, attempting emergency solid color:",o);try{let l=[{r:.196,g:.165,b:.282,a:1,position:0},{r:.196,g:.165,b:.282,a:1,position:1}],m=oe(this.gl,l);if(m)this.gradientTexture=m,i=l,u?.debug?.warn("WebGLGradientBackgroundSystem","Using emergency solid color texture as final fallback");else throw new Error("Emergency solid color texture creation failed")}catch(l){throw u?.debug?.error("WebGLGradientBackgroundSystem","Emergency solid color texture failed:",l),new Error(`All gradient texture creation methods failed: ${l}`)}}}this.lastTextureUpdate=performance.now(),u?.debug?.log("WebGLGradientBackgroundSystem",`Gradient texture updated successfully using ${a}`,{colorStops:i.length,source:a,firstColor:i[0]?`rgb(${Math.round(i[0].r*255)},${Math.round(i[0].g*255)},${Math.round(i[0].b*255)})`:"none"})}catch(i){if(u?.debug?.error("WebGLGradientBackgroundSystem","Critical error in updateGradientTexture:",i),i instanceof Error&&i.message.includes("context"))u?.debug?.log("WebGLGradientBackgroundSystem","WebGL context-related error detected, switching to CSS fallback"),this.fallbackToCSSGradient();else{u?.debug?.log("WebGLGradientBackgroundSystem","Attempting simple texture recovery with default colors");try{this.gradientTexture=null;let a=this.getDefaultGradientStops();if(this.gl&&!this.gl.isContextLost())if(this.gradientTexture=oe(this.gl,a),this.gradientTexture)u?.debug?.log("WebGLGradientBackgroundSystem","Successfully recovered with default gradient");else throw new Error("Recovery attempt failed");else throw new Error("WebGL context unavailable for recovery")}catch(a){u?.debug?.error("WebGLGradientBackgroundSystem","Recovery attempt failed, falling back to CSS:",a),this.fallbackToCSSGradient()}}}finally{this.textureCreationInProgress=!1}}async updateGradientTextureThrottled(){let t=performance.now();if(t-this.lastTextureUpdate<this.textureUpdateThrottleMs){if(!this.textureUpdatePending){this.textureUpdatePending=!0;let i=this.textureUpdateThrottleMs-(t-this.lastTextureUpdate);setTimeout(()=>{this.textureUpdatePending=!1,this.updateGradientTexture().catch(a=>{u?.debug?.error("WebGLGradientBackgroundSystem","Throttled texture update failed:",a)})},i)}return}await this.updateGradientTexture()}debouncedUpdateGradientTexture(){this.textureUpdateDebounceTimer&&clearTimeout(this.textureUpdateDebounceTimer),this.textureUpdateDebounceTimer=window.setTimeout(()=>{this.textureUpdateDebounceTimer=null,this.updateGradientTextureThrottled().catch(t=>{u?.debug?.error("WebGLGradientBackgroundSystem","Debounced texture update failed:",t)})},this.textureUpdateDebounceMs)}setupContextLossHandlers(){if(!this.canvas)return;this.canvas.addEventListener("webglcontextlost",async i=>{if(this.contextLossCount++,u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL context lost - Enhanced Recovery",{lossCount:this.contextLossCount,maxRetries:this.maxContextLossRetries}),i.preventDefault(),this.contextLost=!0,this.textureCreationInProgress=!1,this.contextLossCount<=this.maxContextLossRetries){let a=Math.min(this.contextLossCount-1,this.contextRecoveryTimeouts.length-1),r=this.contextRecoveryTimeouts[a]||5e3;if(u?.debug?.log("WebGLGradientBackgroundSystem",`Preparing for context recovery attempt ${this.contextLossCount}/${this.maxContextLossRetries} with ${r}ms backoff`,{shouldPersist:this.shouldPersistWebGL()}),this.gl)try{let{ShaderLoader:n}=await Promise.resolve().then(()=>(Tt(),Ra));n.clearContextCache(this.gl)}catch{}this.textureUpdateDebounceTimer&&(clearTimeout(this.textureUpdateDebounceTimer),this.textureUpdateDebounceTimer=null),this.textureUpdatePending=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}else this.shouldPersistWebGL()?(u?.debug?.warn("WebGLGradientBackgroundSystem",`Context lost ${this.contextLossCount} times but persistence mode enabled - resetting retry count and continuing`),this.contextLossCount=Math.max(1,this.maxContextLossRetries-3),this.currentRecoveryAttempt=0):(u?.debug?.error("WebGLGradientBackgroundSystem",`Context lost ${this.contextLossCount} times - falling back to CSS gradient`),this.fallbackToCSSGradient())},!1);let t=async()=>{if(!this.contextLost||this.pendingContextRestore)return;let i=Math.min(this.currentRecoveryAttempt,this.contextRecoveryTimeouts.length-1),a=this.contextRecoveryTimeouts[i]||5e3;u?.debug?.log("WebGLGradientBackgroundSystem",`Attempting context recovery in ${a}ms (attempt ${this.currentRecoveryAttempt+1})`),setTimeout(async()=>{if(this.contextLost){this.currentRecoveryAttempt++;try{this.gl&&this.gl.isContextLost()&&this.gl.getError()}catch(r){u?.debug?.warn("WebGLGradientBackgroundSystem","Error during context recovery attempt:",r)}this.contextLost&&this.currentRecoveryAttempt<this.maxContextLossRetries&&t()}},a)};this.canvas.addEventListener("webglcontextlost",()=>{this.currentRecoveryAttempt=0,t()}),this.canvas.addEventListener("webglcontextrestored",async()=>{u?.debug?.log("WebGLGradientBackgroundSystem","WebGL context restored - Enhanced Recovery",{lossCount:this.contextLossCount,maxRetries:this.maxContextLossRetries}),this.contextLost=!1,this.pendingContextRestore=!0;try{if(!this.gl||this.gl.isContextLost())throw new Error("Context is still lost after restore event");await this.reinitializeWebGLResources(),this.contextLossCount>=2?(u?.debug?.log("WebGLGradientBackgroundSystem","Reducing quality after multiple context losses"),this.adjustQualityForTier("low")):this.contextLossCount>=1&&(u?.debug?.log("WebGLGradientBackgroundSystem","Reducing quality after context loss"),this.adjustQualityForTier("medium")),this.startAnimation(),this.pendingContextRestore=!1,u?.debug?.log("WebGLGradientBackgroundSystem","WebGL context restore completed successfully",{lossCount:this.contextLossCount,qualityReduced:this.contextLossCount>0})}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to restore WebGL context:",i),this.pendingContextRestore=!1,this.contextLossCount++,this.contextLossCount>this.maxContextLossRetries&&(u?.debug?.error("WebGLGradientBackgroundSystem","Context restoration failed too many times - falling back to CSS"),this.fallbackToCSSGradient())}},!1)}async reinitializeWebGLResources(){if(!this.gl)throw new Error("WebGL context not available");this.shaderProgram=null,this.vertexBuffer=null,this.vao=null,this.gradientTexture=null;let{ShaderLoader:t}=await Promise.resolve().then(()=>(Tt(),Ra));t.clearContextCache(this.gl),await this.compileShaders(),this.createGeometry(),await this.updateGradientTexture(),this.setupUniforms(),u?.debug?.log("WebGLGradientBackgroundSystem","WebGL resources reinitialized after context restore")}isContextValid(){return!this.gl||this.contextLost?!1:this.gl.isContextLost()?(this.contextLost=!0,!1):!0}getDefaultGradientStops(){return[{r:.196,g:.165,b:.282,a:1,position:0},{r:.549,g:.408,b:.878,a:1,position:.3},{r:.788,g:.557,b:.902,a:1,position:.6},{r:.957,g:.761,b:.494,a:1,position:1}]}getCSSGradientStops(){try{let t=document.documentElement,i=getComputedStyle(t),a=["--sn-bg-gradient-primary-rgb","--sn-bg-gradient-secondary-rgb","--sn-bg-gradient-tertiary-rgb"],r=[];for(let o=0;o<a.length;o++){let l=a[o]||"--sn-bg-gradient-primary-rgb",m=i.getPropertyValue(l).trim();if(!m){u?.debug?.log("WebGLGradientBackgroundSystem",`CSS variable ${l} not set, trying without CSS fallback`);continue}let d=m.split(",").map(h=>parseInt(h.trim(),10));if(d.length!==3||d.some(h=>isNaN(h)||h<0||h>255)){u?.debug?.warn("WebGLGradientBackgroundSystem",`Invalid RGB values in ${l}: ${m}, skipping this color`);continue}r.push({r:(d[0]??0)/255,g:(d[1]??0)/255,b:(d[2]??0)/255,a:1,position:o/(a.length-1)})}if(r.length<2)return u?.debug?.log("WebGLGradientBackgroundSystem",`Only ${r.length} valid CSS colors found, need at least 2 for gradient`),null;let n=i.getPropertyValue("--sn-bg-gradient-opacity").trim(),s=n?parseFloat(n):1;return s!==1&&s>0&&s<=1&&r.forEach(o=>{o.a=s}),u?.debug?.log("WebGLGradientBackgroundSystem",`Successfully parsed ${r.length} CSS background gradient stops from OKLAB inheritance`,{colors:r.map(o=>`rgba(${Math.round(o.r*255)},${Math.round(o.g*255)},${Math.round(o.b*255)},${o.a})`),opacity:s!==1?s:"default"}),r}catch(t){return u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to parse CSS background gradient variables:",t),null}}subscribeToEvents(){let t=p.subscribe("colors:harmonized",this.handleColorHarmonized.bind(this),"WebGLGradientBackgroundSystem");this.eventSubscriptionIds.push(t);let i=p.subscribe("colors:applied",this.handleColorApplied.bind(this),"WebGLGradientBackgroundSystem");this.eventSubscriptionIds.push(i);let a=p.subscribe("performance:tier-changed",this.handlePerformanceTierChanged.bind(this),"WebGLGradientBackgroundSystem");this.eventSubscriptionIds.push(a),u?.debug?.log("WebGLGradientBackgroundSystem","Subscribed to unified events",{subscriptionCount:this.eventSubscriptionIds.length,events:["colors:harmonized","colors:applied","performance:tier-changed"]})}handleColorHarmonized(t){let i=performance.now(),a=`${t.accentHex}-${t.processingTime}-${t.strategies.join(",")}`;if(this.lastColorHarmonizedData===a&&i-this.lastColorHarmonizedTime<100){u?.debug?.log("WebGLGradientBackgroundSystem","Duplicate color harmonization event detected, skipping");return}this.lastColorHarmonizedData=a,this.lastColorHarmonizedTime=i,this.debouncedUpdateGradientTexture(),u?.debug?.log("WebGLGradientBackgroundSystem","Color harmonization processed",{strategies:t.strategies,processingTime:t.processingTime,accentHex:t.accentHex,deduplicationHash:a.substring(0,16)+"..."})}handleColorApplied(t){u?.debug?.log("WebGLGradientBackgroundSystem","Color application coordinated",{accentHex:t.accentHex,appliedAt:t.appliedAt})}handlePerformanceTierChanged(t){if(!(!this.isActive||!this.gl))switch(u?.debug?.log("WebGLGradientBackgroundSystem","Performance tier changed",{previousTier:t.previousTier,newTier:t.tier,timestamp:t.timestamp}),t.tier){case"excellent":this.adjustQualityForTier("high");break;case"good":this.adjustQualityForTier("medium");break;case"degraded":this.adjustQualityForTier("low"),u?.debug?.warn("WebGLGradientBackgroundSystem","Performance degraded - reducing WebGL quality instead of fallback");break;case"critical":t.previousTier==="degraded"?this.shouldPersistWebGL()?(u?.debug?.warn("WebGLGradientBackgroundSystem","Critical performance but persistence mode enabled - reducing to absolute minimum WebGL quality"),this.adjustQualityForTier("emergency")):(u?.debug?.warn("WebGLGradientBackgroundSystem","Critical performance detected - falling back to CSS gradient"),this.fallbackToCSSGradient()):(this.adjustQualityForTier("minimal"),u?.debug?.warn("WebGLGradientBackgroundSystem","Critical performance - using minimal WebGL quality"));break}}adjustQualityForTier(t){if(!this.gl||!this.canvas)return;switch(t){case"high":this.frameThrottleInterval=1e3/60;break;case"medium":this.frameThrottleInterval=1e3/45;break;case"low":this.frameThrottleInterval=1e3/30;break;case"minimal":this.frameThrottleInterval=1e3/15;break;case"emergency":this.frameThrottleInterval=1e3/10;break}switch(t){case"high":this.textureUpdateThrottleMs=100;break;case"medium":this.textureUpdateThrottleMs=200;break;case"low":this.textureUpdateThrottleMs=500;break;case"minimal":this.textureUpdateThrottleMs=1e3;break;case"emergency":this.textureUpdateThrottleMs=2e3;break}let i=this.findSpotifyContainer();if(i){let r=i.getBoundingClientRect(),n=1;switch(t){case"high":n=1;break;case"medium":n=.8;break;case"low":n=.6;break;case"minimal":n=.4;break;case"emergency":n=.1;break}let s=Math.floor(r.width*n),o=Math.floor(r.height*n);this.canvas.width=s,this.canvas.height=o,this.gl&&this.gl.viewport(0,0,s,o)}let a=this.settings.corridorEnabled;switch(t){case"high":this.settings.intensity="intense",this.settings.flowStrength=Math.max(this.settings.flowStrength,.7);break;case"medium":this.settings.intensity="balanced",this.settings.flowStrength=Math.min(this.settings.flowStrength,.6);break;case"low":this.settings.corridorEnabled=!1,this.settings.intensity="minimal",this.settings.flowStrength=Math.min(this.settings.flowStrength,.4);break;case"minimal":this.settings.corridorEnabled=!1,this.settings.intensity="minimal",this.settings.flowStrength=.2;break}a!==this.settings.corridorEnabled&&u?.debug?.log("WebGLGradientBackgroundSystem",`Corridor shader ${this.settings.corridorEnabled?"enabled":"disabled"} for ${t} quality`),u?.debug?.log("WebGLGradientBackgroundSystem",`Quality adjusted for ${t} performance tier`,{frameFPS:Math.round(1e3/this.frameThrottleInterval),textureFPS:Math.round(1e3/this.textureUpdateThrottleMs),canvasResolution:`${this.canvas.width}x${this.canvas.height}`,corridorEnabled:this.settings.corridorEnabled})}startAnimation(){this.startTime=performance.now(),this.lastFrameTime=this.startTime,this.animate()}render(t){if(!this.gl||!this.vao)return;if(!this.gradientTexture){u?.debug?.warn("WebGLGradientBackgroundSystem","No gradient texture during render - creating emergency texture");try{let s=[()=>{let o=this.getCSSGradientStops();return o?oe(this.gl,o):null},()=>{let o=this.getDefaultGradientStops();return oe(this.gl,o)},()=>{let o=[{r:.196,g:.165,b:.282,a:1,position:0},{r:.196,g:.165,b:.282,a:1,position:1}];return oe(this.gl,o)}];for(let o=0;o<s.length;o++)try{if(this.gradientTexture=s[o](),this.gradientTexture){u?.debug?.log("WebGLGradientBackgroundSystem",`Emergency texture created using method ${o+1}`);break}}catch(l){u?.debug?.warn("WebGLGradientBackgroundSystem",`Emergency texture method ${o+1} failed:`,l)}if(!this.gradientTexture){u?.debug?.error("WebGLGradientBackgroundSystem","All emergency texture creation methods failed - skipping render");return}}catch(s){u?.debug?.error("WebGLGradientBackgroundSystem","Emergency texture creation failed completely:",s);return}}if(this.lastSuccessfulRender=t,this.contextLossCount>0&&t-this.lastSuccessfulRender>3e4){let s=this.contextLossCount;this.contextLossCount=Math.max(0,this.contextLossCount-1),s!==this.contextLossCount&&u?.debug?.log("WebGLGradientBackgroundSystem","Context loss count reduced due to successful renders",{oldCount:s,newCount:this.contextLossCount})}let i=this.settings.corridorEnabled&&this.corridorShaderProgram&&this.currentQualityLevel!=="low",a=i?this.corridorShaderProgram:this.shaderProgram,r=i?this.corridorUniforms:this.uniforms;if(!a)return;if(this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.useProgram(a),this.gl.bindVertexArray(this.vao),!this.webglReady){this.webglReady=!0;let s={"--sn.bg.webgl.ready":"1","--sn.bg.webgl.enabled":"1","--sn.bg.active-backend":"hybrid","--sn-gradient-crossfade-opacity":"0.5"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",s,"critical","webgl-first-draw")}let n=this.prefersReducedMotion?0:(t-this.startTime)/1e3;if(r.u_time&&this.gl.uniform1f(r.u_time,n),r.u_resolution&&this.gl.uniform2f(r.u_resolution,this.canvas.width,this.canvas.height),r.u_flowStrength){let s=this.settings.flowStrength;try{let l=getComputedStyle(document.documentElement).getPropertyValue("--sn-flow-strength").trim();l&&(s=parseFloat(l))}catch{u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to read flow strength CSS variable, using settings value")}this.gl.uniform1f(r.u_flowStrength,s)}r.u_noiseScale&&this.gl.uniform1f(r.u_noiseScale,this.settings.noiseScale),i||(r.u_waveY&&this.gl.uniform1fv(r.u_waveY,this.settings.waveY),r.u_waveHeight&&this.gl.uniform1fv(r.u_waveHeight,this.settings.waveHeight),r.u_waveOffset&&this.gl.uniform1fv(r.u_waveOffset,this.settings.waveOffset),r.u_blurExp&&this.gl.uniform1f(r.u_blurExp,this.settings.blurExp),r.u_blurMax&&this.gl.uniform1f(r.u_blurMax,this.settings.blurMax)),i&&(r.u_corridorIntensity&&this.gl.uniform1f(r.u_corridorIntensity,this.settings.corridorIntensity),r.u_corridorFlowStrength&&this.gl.uniform1f(r.u_corridorFlowStrength,this.settings.corridorFlowStrength),r.u_corridorDepthEffect&&this.gl.uniform1f(r.u_corridorDepthEffect,this.settings.corridorDepthEffect),r.u_corridorBubbleScale&&this.gl.uniform1f(r.u_corridorBubbleScale,this.settings.corridorBubbleScale),this.updateVisualEffectsUniforms(r,n)),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.gradientTexture),r.u_gradientTex&&this.gl.uniform1i(r.u_gradientTex,0),this.gl.drawArrays(this.gl.TRIANGLES,0,3),this.gl.bindVertexArray(null)}fallbackToCSSGradient(){let t={"--sn.bg.webgl.ready":"0","--sn.bg.webgl.enabled":"0","--sn.bg.active-backend":"css","--sn-gradient-crossfade-opacity":"0"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",t,"critical","webgl-css-fallback"),this.cssVisualEffectsController&&this.startCSSFallbackAnimation(),u?.debug?.log("WebGLGradientBackgroundSystem","Using CSS gradient fallback")}startCSSFallbackAnimation(){if(!this.cssVisualEffectsController)return;let t=()=>{if(!this.isActive)return;let i=performance.now()/1e3,a=Math.sin(i*.04)*20+Math.sin(i*.07)*8,r=Math.cos(i*.05)*20+Math.cos(i*.09)*6,n=1.15+Math.sin(i*.03)*.2,s={"--sn-gradient-flow-x":`${a}%`,"--sn-gradient-flow-y":`${r}%`,"--sn-gradient-flow-scale":n.toString()};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",s,"normal","css-fallback-animation"),setTimeout(t,this.frameThrottleInterval)};t()}handleSettingsChange(t){super.handleSettingsChange(t);let i=t,{key:a,value:r}=i.detail;if(a==="sn-gradient-intensity"){let n=this.settings.enabled;this.settings.intensity=r,this.loadSettings(),r==="disabled"&&n?(this.settings.enabled=!1,this.destroy(),this.fallbackToCSSGradient()):this.settings.enabled&&!n&&this.isWebGLAvailable&&this.initialize()}}_performSystemSpecificCleanup(){if(super._performSystemSpecificCleanup(),this.visualEffectsChoreographer)try{this.visualEffectsChoreographer.unregisterVisualEffectsParticipant("WebGLGradientBackgroundSystem"),u?.debug?.log("WebGLGradientBackgroundSystem","Unregistered from visualEffects choreographer")}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Error unregistering from visualEffects choreographer:",i)}this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.textureUpdateDebounceTimer&&(clearTimeout(this.textureUpdateDebounceTimer),this.textureUpdateDebounceTimer=null),this.textureUpdatePending=!1,this.textureCreationInProgress=!1,this.lastColorHarmonizedData=null,this.gl&&(this.gradientTexture&&(this.gl.deleteTexture(this.gradientTexture),this.gradientTexture=null),this.vertexBuffer&&(this.gl.deleteBuffer(this.vertexBuffer),this.vertexBuffer=null),this.vao&&(this.gl.deleteVertexArray(this.vao),this.vao=null),this.shaderProgram&&(this.gl.deleteProgram(this.shaderProgram),this.shaderProgram=null),te.clearCache(this.gl)),this.wrapper&&this.wrapper.parentNode&&(this.wrapper.parentNode.removeChild(this.wrapper),this.wrapper=null),this.canvas=null,this.eventSubscriptionIds.forEach(i=>{p.unsubscribe(i)}),this.eventSubscriptionIds=[],u?.debug?.log("WebGLGradientBackgroundSystem","Unified event subscriptions cleaned up"),window.removeEventListener("resize",this.resize),this.gl=null;let t={"--sn.bg.webgl.ready":"0","--sn.bg.webgl.enabled":"0","--sn.bg.active-backend":"css","--sn-gradient-crossfade-opacity":"0"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",t,"critical","webgl-system-cleanup")}forceRepaint(t="settings-change"){this.isActive&&this.gradientTexture&&this.updateGradientTexture().catch(i=>{u?.debug?.error("WebGLGradientBackgroundSystem","Failed to repaint gradient:",i)})}setWaveY(t){this.settings.waveY=t}setWaveHeight(t){this.settings.waveHeight=t}setWaveOffset(t){this.settings.waveOffset=t}setBlurSettings(t,i){this.settings.blurExp=t,this.settings.blurMax=i}getMetrics(){return{fps:this.performanceMonitor?.getMedianFPS?.()||0,compileErrors:0,isActive:this.isActive,settings:{...this.settings}}}stopAnimation(){this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)}updateAnimation(t){if(!this.isActive||!this.gl||!this.isWebGLAvailable)return;let i=performance.now();this.shouldSkipFrame(i)||(this.shouldUpdateTexture()&&this.currentQualityLevel!=="low"&&this.updateGradientTextureThrottled(),this.webglReady?this.render(i):this.ensureBasicResources())}shouldSkipFrame(t){if(!this.frameThrottleInterval)return!1;let a=t-(this.lastFrameTime||0)<this.frameThrottleInterval;return a||(this.lastFrameTime=t),a}shouldUpdateTexture(){return performance.now()-this.lastTextureUpdate>=this.textureUpdateThrottleMs}ensureBasicResources(){if(!(!this.gl||this.contextLost)&&!this.gradientTexture)try{let t=this.getDefaultGradientStops();this.gradientTexture=oe(this.gl,t),this.gradientTexture&&u?.debug?.log("WebGLGradientBackgroundSystem","Emergency gradient texture created during animation update")}catch(t){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to create emergency gradient texture:",t)}}async healthCheck(){let t=this.webglReady&&this.initialized&&this.isActive;return{system:"WebGLGradientBackgroundSystem",healthy:t,metrics:{webglReady:this.webglReady,initialized:this.initialized,active:this.isActive,contextLost:this.contextLost,canvasExists:!!this.canvas},issues:t?[]:[...this.webglReady?[]:["WebGL not ready"],...this.initialized?[]:["System not initialized"],...this.isActive?[]:["System not active"],...this.contextLost?["WebGL context lost"]:[]]}}resizeTo(t,i){this.canvas&&(this.canvas.width=t,this.canvas.height=i,this.resize?.())}registerWithVisualEffectsChoreographer(){if(!this.visualEffectsChoreographer){u?.debug?.log("WebGLGradientBackgroundSystem","VisualEffects choreographer not available, skipping registration");return}try{this.visualEffectsChoreographer.registerVisualEffectsParticipant(this),u?.debug?.log("WebGLGradientBackgroundSystem","Successfully registered with visualEffects choreographer")}catch(t){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to register with visualEffects choreographer:",t)}}getVisualEffectsContribution(){return{webglLuminosity:this.settings.flowStrength||.5,shaderComplexity:this.isWebGLAvailable?.8:0,gpuUtilization:this.isWebGLAvailable?.6:0,renderingPipeline:"forward",textureResolution:1}}onVisualEffectsFieldUpdate(t){if(!(!this.isWebGLAvailable||!this.webglReady))try{this.currentVisualEffectsField=t,this.updateShaderFromVisualEffects(t),u?.debug?.log("WebGLGradientBackgroundSystem","Updated from visualEffects field:",{rhythmicPulse:t.pulseRate,webglLuminosity:t.luminosity,emotionalTemperature:t.colorTemperature})}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Error updating from visualEffects field:",i)}}onChoreographyEvent(t,i){if(!(!this.isWebGLAvailable||!this.webglReady))try{switch(t){case"choreography:rhythm-shift":this.frameThrottleInterval=1e3/Math.max(30,Math.min(60,i.newRhythm?.bpm/2||45));break;case"choreography:energy-surge":let a=i.intensity||1;this.cssController.setVariable("WebGLGradientBackgroundSystem","--sn-webgl-energy-surge",a.toString(),"high","choreography-energy-surge");break;case"visualEffects:pulsing-cycle":let r=i.phase||0;this.cssController.setVariable("WebGLGradientBackgroundSystem","--sn-webgl-pulsing-sync",r.toString(),"normal","visualEffects-pulsing-cycle");break}u?.debug?.log("WebGLGradientBackgroundSystem",`Handled choreography event: ${t}`,i)}catch(a){u?.debug?.error("WebGLGradientBackgroundSystem",`Error handling choreography event ${t}:`,a)}}updateShaderFromVisualEffects(t){if(!this.gl||!this.shaderProgram)return;let i=this.settings.flowStrength*(.5+t.pulseRate*.5),a=this.gl.getUniformLocation(this.shaderProgram,"u_flowStrength");a&&this.gl.uniform1f(a,i);let r=this.settings.noiseScale*(.8+t.flowDirection.x*.4),n=this.gl.getUniformLocation(this.shaderProgram,"u_noiseScale");n&&this.gl.uniform1f(n,r);let s=Math.sin(Date.now()*.001*t.pulseRate)*.1,o=this.gl.getUniformLocation(this.shaderProgram,"u_waveY");if(o){let m=[this.settings.waveY[0]+s,this.settings.waveY[1]-s];this.gl.uniform1fv(o,m)}let l={"--sn-webgl-visualEffects-flow":i.toString(),"--sn-webgl-visualEffects-noise":r.toString(),"--sn-webgl-pulsing-phase":s.toString()};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",l,"normal","visualEffects-shader-update")}adjustQuality(t){this.setQualityLevel(t)}setQualityLevel(t){switch(this.currentQualityLevel=t,t){case"low":this.settings.flowStrength=.5,this.settings.noiseScale=1,this.settings.waveHeight=[.3,.2],this.settings.blurExp=1,this.settings.blurMax=.4,this.frameThrottleInterval=1e3/30;break;case"medium":this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.blurExp=1.2,this.settings.blurMax=.6,this.frameThrottleInterval=1e3/45;break;case"high":this.settings.flowStrength=.9,this.settings.noiseScale=1.4,this.settings.waveHeight=[.5,.4],this.settings.blurExp=1.3,this.settings.blurMax=.7,this.frameThrottleInterval=1e3/60;break;default:this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.blurExp=1.2,this.settings.blurMax=.6,this.frameThrottleInterval=1e3/45;break}this.updateQualityCapabilities(t),u?.debug?.log("WebGLGradientBackgroundSystem",`Quality level set to: ${t}`,{flowStrength:this.settings.flowStrength,frameRate:1e3/this.frameThrottleInterval})}getPerformanceImpact(){let t=this.lastFrameTime>0?1e3/this.lastFrameTime:60,i=this.estimateMemoryUsage();return{fps:t,frameTime:this.lastFrameTime,memoryUsage:i,cpuUsage:this.estimateCPUUsage()}}reduceQuality(t){this.qualityAdjustments["flow-reduction"]=(this.qualityAdjustments["flow-reduction"]||0)+t,this.qualityAdjustments["noise-reduction"]=(this.qualityAdjustments["noise-reduction"]||0)+t*.8,this.qualityAdjustments["wave-reduction"]=(this.qualityAdjustments["wave-reduction"]||0)+t*.6,this.settings.flowStrength=Math.max(.1,this.settings.flowStrength*(1-t)),this.settings.noiseScale=Math.max(.5,this.settings.noiseScale*(1-t*.8)),this.settings.waveHeight=[Math.max(.1,this.settings.waveHeight[0]*(1-t*.6)),Math.max(.1,this.settings.waveHeight[1]*(1-t*.6))],t>.5&&(this.frameThrottleInterval=Math.min(1e3/15,this.frameThrottleInterval*(1+t))),u?.debug?.log("WebGLGradientBackgroundSystem",`Quality reduced by ${t}`,this.settings)}increaseQuality(t){if(Object.keys(this.qualityAdjustments).forEach(i=>{this.qualityAdjustments[i]=Math.max(0,(this.qualityAdjustments[i]||0)-t)}),this.currentQualityLevel){let i=this.getBaseSettingsForLevel(this.currentQualityLevel)||this.settings;this.settings.flowStrength=Math.min(i.flowStrength,this.settings.flowStrength*(1+t*.5)),this.settings.noiseScale=Math.min(i.noiseScale,this.settings.noiseScale*(1+t*.3));let a=this.currentQualityLevel==="high"?60:this.currentQualityLevel==="medium"?45:30;this.frameThrottleInterval=Math.max(1e3/a,this.frameThrottleInterval*(1-t*.3))}u?.debug?.log("WebGLGradientBackgroundSystem",`Quality increased by ${t}`,this.settings)}getQualityCapabilities(){return[...this.qualityCapabilities]}updateQualityCapabilities(t){this.qualityCapabilities.forEach(i=>{switch(i.name){case"webgl-rendering":i.enabled=!0;break;case"shader-complexity":i.enabled=t==="high"||t==="medium";break;case"blur-effects":i.enabled=t!=="low";break;case"corridor-effects":i.enabled=t!=="low",t==="low"&&this.settings.corridorEnabled&&(this.settings.corridorEnabled=!1);break;case"corridor-sdf-complexity":let a=t==="high"?1:t==="medium"?.8:.6;this.settings.corridorBubbleScale=Math.max(.5,1*a),i.enabled=t!=="low";break;case"corridor-bubble-layers":let r=t==="high"?1:t==="medium"?.8:.6;this.settings.corridorIntensity=Math.max(.3,.8*r),i.enabled=t==="high"||t==="medium";break;case"corridor-depth-effects":let n=t==="high"?1:t==="medium"?.7:.4;this.settings.corridorDepthEffect=Math.max(.1,.6*n),i.enabled=t!=="low";break;default:i.enabled=t!=="low"}})}getBaseSettingsForLevel(t){let i={...this.settings};switch(t){case"minimal":return{...i,flowStrength:.3,noiseScale:.8,corridorEnabled:!1,corridorIntensity:.3,corridorFlowStrength:.5,corridorDepthEffect:.2,corridorBubbleScale:.5};case"low":return{...i,flowStrength:.5,noiseScale:1,corridorEnabled:!1,corridorIntensity:.4,corridorFlowStrength:.8,corridorDepthEffect:.3,corridorBubbleScale:.6};case"medium":return{...i,flowStrength:.7,noiseScale:1.2,corridorEnabled:!0,corridorIntensity:.6,corridorFlowStrength:1,corridorDepthEffect:.5,corridorBubbleScale:.8};case"high":return{...i,flowStrength:.9,noiseScale:1.4,corridorEnabled:!0,corridorIntensity:.8,corridorFlowStrength:1.2,corridorDepthEffect:.6,corridorBubbleScale:1};case"ultra":return{...i,flowStrength:1,noiseScale:1.6,corridorEnabled:!0,corridorIntensity:1,corridorFlowStrength:1.4,corridorDepthEffect:.8,corridorBubbleScale:1.2};default:return i}}setCorridorEffectsEnabled(t){this.settings.corridorEnabled=t&&this.corridorShaderProgram!==null,this.cssController.setVariable("WebGLGradientBackgroundSystem","--sn-corridor-enabled",t?"1":"0","normal","corridor-settings-update"),u?.debug?.log("WebGLGradientBackgroundSystem",`Corridor effects ${t?"enabled":"disabled"}`)}updateCorridorSettings(t){t.corridorIntensity!==void 0&&(this.settings.corridorIntensity=Math.max(0,Math.min(1,t.corridorIntensity))),t.corridorFlowStrength!==void 0&&(this.settings.corridorFlowStrength=Math.max(0,Math.min(2,t.corridorFlowStrength))),t.corridorDepthEffect!==void 0&&(this.settings.corridorDepthEffect=Math.max(0,Math.min(1,t.corridorDepthEffect))),t.corridorBubbleScale!==void 0&&(this.settings.corridorBubbleScale=Math.max(.1,Math.min(2,t.corridorBubbleScale))),u?.debug?.log("WebGLGradientBackgroundSystem","Corridor settings updated",t)}estimateMemoryUsage(){let t=5;if(this.canvas&&this.gl){let i=this.canvas.width*this.canvas.height;t+=i*4/(1024*1024),this.gradientTexture&&(t+=1),this.vertexBuffer&&(t+=.1)}return t}estimateCPUUsage(){let t=this.isWebGLAvailable?5:15,i=this.settings.flowStrength+this.settings.noiseScale/2;return Math.min(50,t*i)}getSimplifiedFragmentShader(){return`#version 300 es
      precision highp float;

      in vec2 vTextureCoords;
      out vec4 fragColor;

      uniform sampler2D u_gradientTexture;
      uniform float u_time;
      uniform float u_intensity;
      uniform float u_flowStrength;
      uniform vec2 u_resolution;

      // Simplified noise function - uses basic sin/cos instead of complex noise
      float simpleNoise(vec2 st) {
        return sin(st.x * 12.9898 + st.y * 78.233) * 43758.5453;
      }

      void main() {
        vec2 uv = vTextureCoords;
        
        // Simple flow effect without complex noise
        vec2 flow = vec2(
          sin(u_time * 0.5 + uv.y * 3.0) * 0.1,
          cos(u_time * 0.3 + uv.x * 2.0) * 0.1
        ) * u_flowStrength;
        
        // Apply flow offset
        vec2 flowUV = uv + flow;
        
        // Simple gradient lookup with basic distortion
        vec4 gradientColor = texture(u_gradientTexture, flowUV);
        
        // Simple intensity modulation
        float intensity = u_intensity * (0.8 + 0.2 * sin(u_time + uv.x + uv.y));
        
        fragColor = vec4(gradientColor.rgb * intensity, gradientColor.a);
      }`}getBasicFragmentShader(){return`#version 300 es
      precision mediump float;

      in vec2 vTextureCoords;
      out vec4 fragColor;

      uniform sampler2D u_gradientTexture;
      uniform float u_intensity;

      void main() {
        vec2 uv = vTextureCoords;
        
        // Basic gradient lookup without any effects
        vec4 gradientColor = texture(u_gradientTexture, uv);
        
        // Simple intensity scaling
        fragColor = vec4(gradientColor.rgb * u_intensity, gradientColor.a);
      }`}getEmergencyFragmentShader(){return`#version 300 es
      precision lowp float;

      in vec2 vTextureCoords;
      out vec4 fragColor;

      uniform sampler2D u_gradientTexture;

      void main() {
        // Ultra-simple gradient lookup with minimal processing
        // Use lowp precision for maximum compatibility
        vec2 uv = vTextureCoords;
        
        // Simple gradient sample - no effects, no animations
        vec4 color = texture(u_gradientTexture, uv);
        
        // Emergency mode: ensure we always output something visible
        // Fallback to magenta if texture fails (indicates shader compilation success)
        if (color.a < 0.01) {
          fragColor = vec4(0.2, 0.1, 0.3, 1.0); // Dark purple fallback
        } else {
          fragColor = color;
        }
      }`}shouldPersistWebGL(){return this.settings.webglPersistenceMode==="persistent"?!0:this.settings.webglPersistenceMode==="fallback"?!1:this.settings.webglPersistenceMode==="adaptive"&&this.settings.enabled&&this.isWebGLAvailable}shouldAttemptWebGLRecovery(){return this.shouldPersistWebGL()}applyContinuousQuality(t){try{let i=t;u?.debug?.log("WebGLGradientBackgroundSystem",`Applying simplified quality level: ${i}`),this.setQualityLevel(i),this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",{"--sn-webgl-quality-level":i,"--sn-webgl-corridor-enabled":this.settings.corridorEnabled?"1":"0"},"high","continuous-quality-update"),this.initialized&&this.gl&&this.forceRepaint("quality-level-changed")}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to apply continuous quality:",i)}}getCurrentQualityImpact(){let t=this.gl!==null&&this.isWebGLAvailable,i=this.settings.corridorEnabled&&this.corridorShaderProgram!==null,a=t?.15:.05,r=t?.1:.03,n=t?.2:0,s=i?.1:0,o=i?.05:0,l=i?.15:0,m=Math.max(.5,this.settings.flowStrength/2),d=60;return i&&(d-=10),this.settings.intensity==="intense"&&(d-=5),d=Math.max(30,d),{cpu:Math.min(1,(a+s)*m),memory:Math.min(1,(r+o)*m),gpu:Math.min(1,(n+l)*m),estimatedFPS:d}}onVisualStateUpdate(t){this.onVisualEffectsFieldUpdate(t)}onVisualEffectEvent(t,i){switch(t){case"visual:rhythm-shift":i.intensity&&(this.settings.flowStrength=Math.min(5,i.intensity*3));break;case"visual:color-shift":this.forceRepaint("color-shift");break;case"visual:energy-surge":i.intensity>.7&&this.forceRepaint("energy-surge");break}}getVisualContribution(){return{luminosity:this.settings.intensity==="intense"?.8:.5,fluidIntensity:this.settings.flowStrength/5,effectDepth:this.getCurrentQualityImpact().cpu}}}});var Hi,xs=y(()=>{"use strict";U();x();de();Hi=class extends j{constructor(t=E,i,a,r=null,n=null){super(t,i,a,r,n);this.systemName="CSSBlobFallbackSystem";this.blobContainer=null;this.blobElements=[];this.isActive=!1;this.settings={enabled:!0,blobCount:6,musicResponsive:!0,performanceMode:!1,debugMode:!1,smoothFlow:!0,surfaceElasticity:.7,musicSync:!0,colorTemperature:.5,animationScale:!0,smoothPulsing:!0,fluidDynamics:!0};this.handleBeatEvent=t=>{if(!this.isActive||!this.settings.musicResponsive)return;let i=t,{intensity:a=.5}=i.detail||{};this.blobElements.forEach(n=>{n.classList.add("sn-beat-active")}),setTimeout(()=>{this.blobElements.forEach(n=>{n.classList.remove("sn-beat-active")})},500);let r=1+a*.15;document.documentElement.style.setProperty("--css-blob-beat-scale",r.toString())};this.handleEnergyChange=t=>{if(!this.isActive||!this.settings.musicResponsive)return;let i=t,{energy:a=.5}=i.detail||{};document.documentElement.style.setProperty("--css-blob-music-response",a.toString()),document.documentElement.style.setProperty("--css-blob-energy-opacity",(.4+a*.4).toString());let r=.8+a*.4,n=Math.round(8e3/r),s=Math.round(4e3/r);document.documentElement.style.setProperty("--css-blob-movement-speed",`${n}ms`),document.documentElement.style.setProperty("--css-blob-pulsing-speed",`${s}ms`)};this.handleGenreChange=t=>{if(!this.isActive||!this.settings.musicResponsive)return;let i=t,{genre:a="unknown"}=i.detail||{};this.blobElements.forEach((r,n)=>{r.classList.remove("genre-electronic","genre-ambient","genre-classical");let s="genre-electronic";a.includes("ambient")||a.includes("chill")?s="genre-ambient":a.includes("classical")||a.includes("orchestral")?s="genre-classical":(a.includes("electronic")||a.includes("techno")||a.includes("house"))&&(s="genre-electronic");let o=["genre-electronic","genre-ambient","genre-classical"],l=(n+o.indexOf(s))%o.length,m=o[l];m&&r.classList.add(m)}),u?.debug?.log("CSSBlobFallbackSystem",`Updated blob genres for: ${a}`)}}async _performSystemSpecificInitialization(){if(await super._performSystemSpecificInitialization(),this.loadSettings(),this.checkWebGLAvailability()&&!this.settings.debugMode){u?.debug?.log("CSSBlobFallbackSystem","WebGL available - CSS blob fallback not needed");return}if(!this.settings.enabled){u?.debug?.log("CSSBlobFallbackSystem","CSS blob fallback disabled in settings");return}(this.performanceMonitor?.shouldReduceQuality?.()||!1)&&(this.settings.performanceMode=!0,this.settings.blobCount=Math.min(this.settings.blobCount,3));try{this.createBlobContainer(),this.createBlobElements(),this.settings.musicResponsive&&this.subscribeToEvents(),this.updateCSSVariables(),this.isActive=!0,u?.debug?.log("CSSBlobFallbackSystem",`CSS blob fallback activated with ${this.settings.blobCount} blobs`,{performanceMode:this.settings.performanceMode,musicResponsive:this.settings.musicResponsive})}catch(a){u?.debug?.error("CSSBlobFallbackSystem","Failed to initialize:",a)}}loadSettings(){if(this.settingsManager)try{let t=this.settingsManager?.get("sn-gradient-intensity"),i=this.settingsManager?.get("sn-performance-mode");switch(t){case"disabled":this.settings.enabled=!1;break;case"minimal":this.settings.blobCount=3,this.settings.musicResponsive=!1;break;case"balanced":this.settings.blobCount=6,this.settings.musicResponsive=!0;break;case"intense":this.settings.blobCount=8,this.settings.musicResponsive=!0;break}i==="enabled"&&(this.settings.performanceMode=!0,this.settings.blobCount=Math.min(this.settings.blobCount,4))}catch(t){u?.debug?.warn("CSSBlobFallbackSystem","Failed to load settings:",t)}}checkWebGLAvailability(){try{let t=document.createElement("canvas");return!!(t.getContext("webgl")||t.getContext("experimental-webgl"))}catch{return!1}}createBlobContainer(){let t=this.findTargetContainer();this.blobContainer=document.createElement("div"),this.blobContainer.className="sn-css-blob-container",this.settings.debugMode&&this.blobContainer.classList.add("css-blob-debug"),this.settings.performanceMode&&this.blobContainer.classList.add("css-blob-performance"),t.appendChild(this.blobContainer),u?.debug?.log("CSSBlobFallbackSystem","Blob container created and inserted")}createBlobElements(){if(this.blobContainer){this.blobElements.forEach(t=>t.remove()),this.blobElements=[];for(let t=0;t<this.settings.blobCount;t++){let i=document.createElement("div");i.className="sn-css-blob",i.setAttribute("data-blob-index",t.toString());let a=["genre-electronic","genre-ambient","genre-classical"],r=a[t%a.length];r&&i.classList.add(r),this.blobContainer.appendChild(i),this.blobElements.push(i)}u?.debug?.log("CSSBlobFallbackSystem",`Created ${this.settings.blobCount} blob elements`)}}findTargetContainer(){let t=[".Root__main-view",".main-view-container",".Root__top-container","body"];for(let i of t){let a=document.querySelector(i);if(a)return a}return document.body}updateCSSVariables(){document.documentElement.style.setProperty("--css-blob-enabled","1"),document.documentElement.style.setProperty("--css-blob-count",this.settings.blobCount.toString()),this.settings.performanceMode&&(document.documentElement.style.setProperty("--css-blob-quality","0"),document.documentElement.style.setProperty("--css-blob-filter-quality","0")),document.documentElement.style.setProperty("--sn-visual-smooth-mode",this.settings.smoothFlow?"1":"0"),document.documentElement.style.setProperty("--sn-visual-surface-elasticity",this.settings.surfaceElasticity.toString()),document.documentElement.style.setProperty("--sn-visual-color-temperature",this.settings.colorTemperature.toString()),document.documentElement.style.setProperty("--sn-visual-animation-scale",this.settings.animationScale?"1":"0"),document.documentElement.style.setProperty("--sn-visual-pulsing-intensity",this.settings.smoothPulsing?"1":"0"),document.documentElement.style.setProperty("--sn-visual-viscosity",this.settings.fluidDynamics?"0.4":"0"),document.documentElement.style.setProperty("--sn-visual-css-fallback","1.0"),document.documentElement.style.setProperty("--sn-visual-webgl-coordination","0")}subscribeToEvents(){this.settings.musicResponsive&&(document.addEventListener("music-sync:beat-detected",this.handleBeatEvent),document.addEventListener("music-sync:energy-changed",this.handleEnergyChange),document.addEventListener("music-sync:genre-changed",this.handleGenreChange),document.addEventListener("year3000SystemSettingsChanged",this.handleSettingsChange.bind(this)),u?.debug?.log("CSSBlobFallbackSystem","Subscribed to music and settings events"))}handleSettingsChange(t){let i=t,{key:a}=i.detail||{};(a.startsWith("sn-gradient-")||a.startsWith("sn-performance-"))&&(this.loadSettings(),this.isActive&&this.blobContainer&&(this.createBlobElements(),this.updateCSSVariables()))}updateAnimation(t){}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),this.settings.musicResponsive&&(document.removeEventListener("music-sync:beat-detected",this.handleBeatEvent),document.removeEventListener("music-sync:energy-changed",this.handleEnergyChange),document.removeEventListener("music-sync:genre-changed",this.handleGenreChange),document.removeEventListener("year3000SystemSettingsChanged",this.handleSettingsChange.bind(this))),this.blobElements.forEach(t=>t.remove()),this.blobElements=[],this.blobContainer&&this.blobContainer.parentNode&&this.blobContainer.parentNode.removeChild(this.blobContainer),this.blobContainer=null,document.documentElement.style.removeProperty("--css-blob-enabled"),document.documentElement.style.removeProperty("--css-blob-count"),document.documentElement.style.removeProperty("--css-blob-quality"),this.isActive=!1,u?.debug?.log("CSSBlobFallbackSystem","CSS blob fallback system cleanup completed")}setEnabled(t){this.settings.enabled=t,this.blobContainer&&(this.blobContainer.style.display=t?"":"none"),document.documentElement.style.setProperty("--css-blob-enabled",t?"1":"0")}setPerformanceMode(t){this.settings.performanceMode=t,this.blobContainer&&this.blobContainer.classList.toggle("css-blob-performance",t),document.documentElement.style.setProperty("--css-blob-quality",t?"0":"1"),document.documentElement.style.setProperty("--css-blob-filter-quality",t?"0":"1")}setSmoothFlow(t){this.settings.smoothFlow=t,document.documentElement.style.setProperty("--sn-visual-smooth-mode",t?"1":"0")}setSurfaceElasticity(t){this.settings.surfaceElasticity=Math.max(0,Math.min(1,t)),document.documentElement.style.setProperty("--sn-visual-surface-elasticity",this.settings.surfaceElasticity.toString())}setVisualSync(t){this.settings.musicSync=t}setColorTemperature(t){this.settings.colorTemperature=Math.max(0,Math.min(1,t)),document.documentElement.style.setProperty("--sn-visual-color-temperature",this.settings.colorTemperature.toString())}setAnimationScale(t){this.settings.animationScale=t,document.documentElement.style.setProperty("--sn-visual-animation-scale",t?"1":"0")}setSmoothPulsing(t){this.settings.smoothPulsing=t,document.documentElement.style.setProperty("--sn-visual-pulsing-intensity",t?"1":"0")}setFluidDynamics(t){this.settings.fluidDynamics=t,document.documentElement.style.setProperty("--sn-visual-viscosity",t?"0.4":"0")}getStatus(){return{isActive:this.isActive,settings:{...this.settings},blobCount:this.blobElements.length,hasContainer:!!this.blobContainer}}}});var _i,Is=y(()=>{"use strict";$();L();x();de();_i=class extends j{constructor(t,i,a,r,n){super(t,i,a,r,n);this.systemName="UIVisualEffectsController";this.legacySystemName="UIVisualEffectsController";this.visualEffectsCoordinator=null;this.currentVisualField=null;this.currentConsciousnessField=null;this.shimmerElements=new Map;this.mutationObserver=null;this.intersectionObserver=null;this.animationFrameId=null;this.lastFrameTime=0;this.frameTimeHistory=[];this.eventUnsubscribeFunctions=[];this.customPerformanceMonitor={frameCount:0,totalFrameTime:0,lastPerformanceCheck:0,adaptiveQualityLevel:1};this.diagnosticTimerId=null;this.lastDiagnosticRun=0;this.uiEffectsConfig={enabled:!0,activityThreshold:.3,shimmerEnabled:!0,shimmerIntensity:.6,shimmerType:"mixed",shimmerPerformanceLevel:"balanced",interactionTrackingEnabled:!0,digitalMeditationThreshold:3e4,scrollVelocityTracking:!0,diagnosticEnabled:!0,autoFixWhiteLayer:!0,diagnosticInterval:5e3,audioVisualEnabled:!0,beatSynchronization:!0,nebulaEffectIntensity:this.getNebulaIntensityFromSettings(),scrollEffectsEnabled:!0,prismaticSheenIntensity:.5,maxFrameTime:1,adaptiveQuality:!0,debugMode:t.enableDebug||!1},this.activityState=this.createInitialActivityState(),u?.debug?.log("UIVisualEffectsController","Unified UI effects controller created")}get systemPriority(){return"normal"}getNebulaIntensityFromSettings(){if(!this.settingsManager)return .7;switch(this.settingsManager.get("sn-gradient-intensity")){case"disabled":return 0;case"minimal":return .3;case"balanced":return .7;case"intense":return 1;default:return .7}}createInitialActivityState(){return{activityLevel:"dormant",shimmer:{intensity:0,effectType:"mixed",activeElements:new Set,performanceLevel:this.uiEffectsConfig.shimmerPerformanceLevel},interaction:{isActive:!1,lastInteractionTime:0,digitalMeditationDetected:!1,scrollVelocity:{x:0,y:0,direction:"none"},nexusState:"idle"},diagnostic:{whiteLayerIssues:[],webglContextHealthy:!0,lastDiagnosticTime:0,autoFixEnabled:this.uiEffectsConfig.autoFixWhiteLayer,criticalIssuesDetected:0},audioVisual:{beatIntensity:0,genreChangeDetected:!1,nebulaEffectIntensity:0,lastBeatTime:0,performanceAdaptive:this.uiEffectsConfig.adaptiveQuality},scroll:{sheenIntensity:0,scrollRatio:0,prismaticEffectActive:!1,lastScrollTime:0},performance:{frameTime:0,avgFrameTime:0,maxFrameTime:0,healthStatus:"excellent",adaptiveQualityEnabled:this.uiEffectsConfig.adaptiveQuality}}}async initialize(){try{u?.debug?.log("UIVisualEffectsController","Starting unified UI effects initialization..."),await this.initializeVisualCSS(),await this.initializeVisualCoordination(),this.subscribeToUnifiedEvents(),this.uiEffectsConfig.shimmerEnabled&&await this.initializeShimmerEffects(),this.uiEffectsConfig.interactionTrackingEnabled&&await this.initializeInteractionTracking(),this.uiEffectsConfig.diagnosticEnabled&&await this.initializeDiagnosticSystem(),this.uiEffectsConfig.audioVisualEnabled&&await this.initializeAudioVisualEffects(),this.uiEffectsConfig.scrollEffectsEnabled&&await this.initializeScrollEffects(),this.startUnifiedAnimationLoop(),this.initialized=!0,u?.debug?.log("UIVisualEffectsController","Unified UI effects controller initialized")}catch(t){throw u?.debug?.error("UIVisualEffectsController","Failed to initialize:",t),t}}async initializeVisualCSS(){return this.initializeCSSConsciousness()}async initializeCSSConsciousness(){try{this.cssController=globalThis.unifiedVisualCSSController||globalThis.unifiedCSSConsciousnessController||null,this.cssController=P(),this.cssController?u?.debug?.log("UIVisualEffectsController","Connected to unified CSS visual effects"):u?.debug?.warn("UIVisualEffectsController","CSS visual effects not available, using coordinator fallback")}catch(t){u?.debug?.warn("UIVisualEffectsController","CSS visual effects initialization failed:",t)}}async initializeVisualCoordination(){return this.initializeConsciousnessIntegration()}async initializeConsciousnessIntegration(){try{this.visualEffectsCoordinator=globalThis.backgroundVisualCoordinator||globalThis.backgroundConsciousnessChoreographer||null,this.visualEffectsCoordinator?(this.visualEffectsCoordinator.registerVisualEffectsParticipant?this.visualEffectsCoordinator.registerVisualEffectsParticipant(this):this.visualEffectsCoordinator.registerConsciousnessParticipant&&this.visualEffectsCoordinator.registerConsciousnessParticipant(this),u?.debug?.log("UIVisualEffectsController","Registered with visual effects coordinator")):u?.debug?.log("UIVisualEffectsController","Operating without visual effects coordinator integration")}catch(t){u?.debug?.warn("UIVisualEffectsController","Visual coordination integration failed:",t)}}subscribeToUnifiedEvents(){let t=p.subscribe("music:beat",this.handleMusicBeat.bind(this),"UIVisualEffectsController");this.eventUnsubscribeFunctions.push(()=>p.unsubscribe(t));let i=p.subscribe("music:energy",this.handleMusicEnergy.bind(this),"UIVisualEffectsController");this.eventUnsubscribeFunctions.push(()=>p.unsubscribe(i));let a=p.subscribe("settings:changed",this.handleSettingsChange.bind(this),"UIVisualEffectsController");this.eventUnsubscribeFunctions.push(()=>p.unsubscribe(a)),u?.debug?.log("UIVisualEffectsController",`Subscribed to ${this.eventUnsubscribeFunctions.length} unified events`)}async initializeShimmerEffects(){try{this.setupElementObservers(),await this.discoverShimmerElements(),u?.debug?.log("UIVisualEffectsController",`Shimmer effects initialized with ${this.shimmerElements.size} elements`)}catch(t){u?.debug?.error("UIVisualEffectsController","Shimmer effects initialization failed:",t)}}async initializeInteractionTracking(){try{this.setupInteractionListeners(),u?.debug?.log("UIVisualEffectsController","Interaction tracking initialized")}catch(t){u?.debug?.error("UIVisualEffectsController","Interaction tracking initialization failed:",t)}}async initializeDiagnosticSystem(){try{this.startDiagnosticMonitoring(),u?.debug?.log("UIVisualEffectsController","Diagnostic system initialized")}catch(t){u?.debug?.error("UIVisualEffectsController","Diagnostic system initialization failed:",t)}}async initializeAudioVisualEffects(){try{u?.debug?.log("UIVisualEffectsController","Audio-visual effects initialized")}catch(t){u?.debug?.error("UIVisualEffectsController","Audio-visual effects initialization failed:",t)}}async initializeScrollEffects(){try{u?.debug?.log("UIVisualEffectsController","Scroll effects initialized")}catch(t){u?.debug?.error("UIVisualEffectsController","Scroll effects initialization failed:",t)}}setupElementObservers(){typeof MutationObserver<"u"&&(this.mutationObserver=new MutationObserver(t=>{let i=!1;t.forEach(a=>{a.type==="childList"&&a.addedNodes.forEach(r=>{r.nodeType===Node.ELEMENT_NODE&&(i=!0)})}),i&&this.discoverShimmerElements()}),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0})),typeof IntersectionObserver<"u"&&(this.intersectionObserver=new IntersectionObserver(t=>{t.forEach(i=>{let a=i.target.getAttribute("data-shimmer-id");a&&(i.isIntersecting?this.activityState.shimmer.activeElements.add(a):this.activityState.shimmer.activeElements.delete(a))})},{threshold:[0,.1,.5,1]}))}async discoverShimmerElements(){let t=[".main-card-card",".main-trackList-trackListRow",".main-button-primary",".main-playButton-button",'[data-testid="card-click-handler"]'],i=0;t.forEach(a=>{document.querySelectorAll(a).forEach((n,s)=>{let o=`shimmer-${a.replace(/[^\w]/g,"_")}-${s}`,l=n;l.setAttribute("data-shimmer-id",o),this.shimmerElements.set(o,l),this.intersectionObserver&&this.intersectionObserver.observe(l),i++})}),this.uiEffectsConfig.debugMode&&i>0&&u?.debug?.log("UIVisualEffectsController",`Discovered ${i} shimmer elements`)}setupInteractionListeners(){["click","keydown","mousemove","scroll","touchstart"].forEach(i=>{document.addEventListener(i,()=>{this.activityState.interaction.isActive=!0,this.activityState.interaction.lastInteractionTime=Date.now(),this.activityState.interaction.digitalMeditationDetected=!1,this.updateNexusState()},{passive:!0})})}startDiagnosticMonitoring(){this.diagnosticTimerId=window.setInterval(()=>{this.runDiagnosticCheck()},this.uiEffectsConfig.diagnosticInterval)}startUnifiedAnimationLoop(){let t=i=>{if(!this.initialized)return;let a=i-this.lastFrameTime;this.lastFrameTime=i;let r=performance.now();try{this.updateVisualActivityState(a),this.uiEffectsConfig.shimmerEnabled&&this.updateShimmerEffects(a),this.uiEffectsConfig.interactionTrackingEnabled&&this.updateInteractionTracking(a),this.uiEffectsConfig.audioVisualEnabled&&this.updateAudioVisualEffects(a),this.uiEffectsConfig.scrollEffectsEnabled&&this.updateScrollEffects(a),this.applyCSSUpdates();let n=performance.now()-r;this.updatePerformanceMetrics(n),n>this.uiEffectsConfig.maxFrameTime&&this.handlePerformanceIssue(n)}catch(n){u?.debug?.error("UIVisualEffectsController","Animation loop error:",n)}this.animationFrameId=requestAnimationFrame(t)};this.animationFrameId=requestAnimationFrame(t)}updateVisualActivityState(t){let i=this.activityState,a=i.shimmer.intensity*.2+(i.interaction.isActive?.3:0)+i.audioVisual.beatIntensity*.3+i.scroll.sheenIntensity*.2;a>.8?(i.activityLevel="enhanced",i.transcendentLevel="advanced"):a>.5?i.activityLevel="focused":a>.2?i.activityLevel="aware":i.activityLevel="dormant"}updateShimmerEffects(t){let i=this.activityState.shimmer,a=this.activityState.audioVisual.beatIntensity*.3,r=this.activityState.interaction.isActive?.2:0;i.intensity=Math.min(this.uiEffectsConfig.shimmerIntensity+a+r,1),this.activityState.performance.healthStatus==="degraded"?i.intensity*=.7:this.activityState.performance.healthStatus==="critical"&&(i.intensity*=.3)}updateInteractionTracking(t){let i=this.activityState.interaction,r=Date.now()-i.lastInteractionTime;r>this.uiEffectsConfig.digitalMeditationThreshold&&(i.digitalMeditationDetected||(i.digitalMeditationDetected=!0,u?.debug?.log("UIVisualEffectsController","Digital meditation detected",{inactiveTime:r}))),this.updateNexusState()}updateNexusState(){let t=this.activityState.interaction,a=Date.now()-t.lastInteractionTime;t.digitalMeditationDetected?t.nexusState="meditation":a<1e3?t.nexusState="active":a<1e4?t.nexusState="flow":t.nexusState="idle"}updateAudioVisualEffects(t){let i=this.activityState.audioVisual,a=this.activityState.activityLevel==="enhanced"?.2:0;i.nebulaEffectIntensity=Math.min(this.uiEffectsConfig.nebulaEffectIntensity+i.beatIntensity*.3+a,1)}updateScrollEffects(t){let i=this.activityState.scroll;Date.now()-i.lastScrollTime<1e3?(i.prismaticEffectActive=!0,i.sheenIntensity=Math.min(i.scrollRatio*this.uiEffectsConfig.prismaticSheenIntensity,1)):(i.prismaticEffectActive=!1,i.sheenIntensity*=.95)}applyCSSUpdates(){let t=this.activityState,i={"--sn-ui-activity-level":t.activityLevel,"--sn-shimmer-intensity":t.shimmer.intensity.toFixed(3),"--sn-shimmer-effect-type":t.shimmer.effectType,"--sn-shimmer-performance":t.shimmer.performanceLevel,"--sn-interaction-nexus-state":t.interaction.nexusState,"--sn-interaction-meditation":t.interaction.digitalMeditationDetected?"1":"0","--sn-scroll-velocity-x":t.interaction.scrollVelocity.x.toFixed(2),"--sn-scroll-velocity-y":t.interaction.scrollVelocity.y.toFixed(2),"--sn-beat-intensity":t.audioVisual.beatIntensity.toFixed(3),"--sn-nebula-intensity":t.audioVisual.nebulaEffectIntensity.toFixed(3),"--sn-genre-change":t.audioVisual.genreChangeDetected?"1":"0","--sn-scroll-sheen-intensity":t.scroll.sheenIntensity.toFixed(3),"--sn-scroll-ratio":t.scroll.scrollRatio.toFixed(3),"--sn-prismatic-active":t.scroll.prismaticEffectActive?"1":"0","--sn-white-layer-issues":t.diagnostic.whiteLayerIssues.length.toString(),"--sn-webgl-healthy":t.diagnostic.webglContextHealthy?"1":"0"};try{this.cssController.batchSetVariables("UIVisualEffectsController",i,"normal","ui-activity-update")}catch(a){u?.debug?.warn("UIVisualEffectsController","CSS coordination error:",a)}}updatePerformanceMetrics(t){let i=this.activityState.performance;i.frameTime=t,this.frameTimeHistory.push(t),this.frameTimeHistory.length>60&&this.frameTimeHistory.shift(),i.avgFrameTime=this.frameTimeHistory.reduce((a,r)=>a+r,0)/this.frameTimeHistory.length,i.maxFrameTime=Math.max(...this.frameTimeHistory),i.avgFrameTime>2?i.healthStatus="critical":i.avgFrameTime>1.5?i.healthStatus="degraded":i.avgFrameTime>1?i.healthStatus="good":i.healthStatus="excellent"}handlePerformanceIssue(t){this.uiEffectsConfig.adaptiveQuality&&(this.customPerformanceMonitor.adaptiveQualityLevel*=.9,this.customPerformanceMonitor.adaptiveQualityLevel<.5&&(this.activityState.shimmer.performanceLevel="minimal"),this.uiEffectsConfig.debugMode&&u?.debug?.warn("UIVisualEffectsController",`Performance issue: ${t.toFixed(2)}ms, reduced quality to ${this.customPerformanceMonitor.adaptiveQualityLevel.toFixed(2)}`))}runDiagnosticCheck(){let t=this.activityState.diagnostic,i=Date.now();t.lastDiagnosticTime=i,t.whiteLayerIssues=[];try{let a=document.createElement("canvas"),r=a.getContext("webgl")||a.getContext("experimental-webgl");t.webglContextHealthy=!!r;let n=document.querySelectorAll('[style*="background"], [style*="color"]'),s=0;n.forEach(o=>{let l=window.getComputedStyle(o);(l.backgroundColor==="rgb(255, 255, 255)"||l.color==="rgb(255, 255, 255)")&&s++}),s>10&&(t.whiteLayerIssues.push(`Excessive white layers detected: ${s}`),t.autoFixEnabled&&this.autoFixWhiteLayerIssues()),t.criticalIssuesDetected=t.whiteLayerIssues.length}catch(a){u?.debug?.error("UIVisualEffectsController","Diagnostic check failed:",a)}}autoFixWhiteLayerIssues(){try{this.cssController.batchSetVariables("UIVisualEffectsController",{"--spice-text":"var(--spice-main)","--spice-subtext":"var(--catppuccin-text)"},"critical","white-layer-autofix"),this.uiEffectsConfig.debugMode&&u?.debug?.log("UIVisualEffectsController","Applied white layer auto-fix")}catch(t){u?.debug?.error("UIVisualEffectsController","Auto-fix failed:",t)}}handleMusicBeat(t){let i=this.activityState.audioVisual;if(i.beatIntensity=t.intensity||.5,i.lastBeatTime=Date.now(),this.uiEffectsConfig.shimmerEnabled){let a=i.beatIntensity*.2;this.activityState.shimmer.intensity=Math.min(this.activityState.shimmer.intensity+a,1)}}handleMusicEnergy(t){let i=this.activityState.audioVisual;t.energy!==void 0&&(i.beatIntensity=Math.max(i.beatIntensity,t.energy*.8))}handleGenreChange(t){let i=this.activityState.audioVisual;i.genreChangeDetected=!0,setTimeout(()=>{i.genreChangeDetected=!1},2e3)}handleUserScroll(t){let i=this.activityState.scroll,a=this.activityState.interaction;i.lastScrollTime=Date.now(),i.scrollRatio=t.scrollRatio||0,t.velocity&&(a.scrollVelocity={x:t.velocity.x||0,y:t.velocity.y||0,direction:t.direction||"none"}),this.handleUserInteraction({type:"scroll",timestamp:Date.now()})}handleUserInteraction(t){let i=this.activityState.interaction;i.isActive=!0,i.lastInteractionTime=t.timestamp||Date.now(),i.digitalMeditationDetected=!1,this.updateNexusState()}handleSettingsChange(t){let{key:i,value:a}=t;i.startsWith("sn-ui-effects-")?this.updateConfigFromSettings(i,a):i==="sn-gradient-intensity"&&(this.uiEffectsConfig.nebulaEffectIntensity=this.getNebulaIntensityFromSettings(),u?.debug?.log("UIVisualEffectsController",`Updated nebula intensity to: ${this.uiEffectsConfig.nebulaEffectIntensity} from consolidated gradient setting: ${a}`))}updateConfigFromSettings(t,i){switch(t){case"sn-ui-effects-shimmer-intensity":this.uiEffectsConfig.shimmerIntensity=parseFloat(i)||.6;break;case"sn-ui-effects-diagnostic-enabled":this.uiEffectsConfig.diagnosticEnabled=i==="true"||i===!0;break;case"sn-ui-effects-adaptive-quality":this.uiEffectsConfig.adaptiveQuality=i==="true"||i===!0;break}}getConsciousnessContribution(){return{systemName:this.systemName,activityLevel:this.activityState.activityLevel,shimmerIntensity:this.activityState.shimmer.intensity,interactionState:this.activityState.interaction.nexusState,audioVisualIntensity:this.activityState.audioVisual.nebulaEffectIntensity,scrollActivity:this.activityState.scroll.sheenIntensity,timestamp:Date.now()}}onVisualFieldUpdate(t){return this.onConsciousnessFieldUpdate(t)}onConsciousnessFieldUpdate(t){try{this.currentVisualField=t,this.currentConsciousnessField=t;let i=t.pulseRate*.2;this.activityState.shimmer.intensity=Math.min(this.activityState.shimmer.intensity+i,1),this.activityState.audioVisual.nebulaEffectIntensity=Math.min(this.activityState.audioVisual.nebulaEffectIntensity+i*.3,1)}catch(i){u?.debug?.error("UIVisualEffectsController","Error updating from visual effects state:",i)}}onVisualCoordinationEvent(t,i){return this.onChoreographyEvent(t,i)}onChoreographyEvent(t,i){t==="transition:start"&&(this.activityState.shimmer.intensity=Math.min(this.activityState.shimmer.intensity+.2,1),this.activityState.audioVisual.nebulaEffectIntensity=Math.min(this.activityState.audioVisual.nebulaEffectIntensity+.15,1)),this.uiEffectsConfig.debugMode&&u?.debug?.log("UIVisualEffectsController",`Visual coordination event: ${t}`,i)}async healthCheck(){let t=this.activityState,i=this.initialized&&t.performance.healthStatus!=="critical"&&t.diagnostic.criticalIssuesDetected===0;return{healthy:i,ok:i,details:`UI Effects Activity: ${t.activityLevel}, Shimmer: ${t.shimmer.activeElements.size} elements, Interaction: ${t.interaction.nexusState}, Performance: ${t.performance.healthStatus}, Diagnostics: ${t.diagnostic.criticalIssuesDetected} issues`,system:"UIVisualEffectsController"}}updateConfiguration(t){let i={...this.uiEffectsConfig},a=[],r=[];try{for(let[n,s]of Object.entries(t))n in this.uiEffectsConfig?a.push(n):r.push(`Unknown configuration property: ${n}`),n==="shimmerIntensity"&&typeof s=="number"&&(s<0||s>1)&&r.push("shimmerIntensity must be between 0 and 1"),n==="digitalMeditationThreshold"&&typeof s=="number"&&s<1e3&&r.push("digitalMeditationThreshold must be at least 1000ms");return r.length===0&&(Object.assign(this.uiEffectsConfig,t),t.shimmerEnabled!==void 0&&t.shimmerEnabled&&!this.activityState.shimmer.activeElements.size&&this.discoverShimmerElements(),t.diagnosticEnabled!==void 0&&(t.diagnosticEnabled&&!this.diagnosticTimerId?this.startDiagnosticMonitoring():!t.diagnosticEnabled&&this.diagnosticTimerId&&(clearInterval(this.diagnosticTimerId),this.diagnosticTimerId=null)),u?.debug?.log("UIEffectsController","Configuration updated:",t)),{success:r.length===0,updatedProperties:a,validationErrors:r,previousConfig:i,newConfig:{...this.uiEffectsConfig}}}catch(n){let s=n instanceof Error?n.message:"Unknown error during configuration update";return{success:!1,updatedProperties:a,validationErrors:[...r,s],previousConfig:i,newConfig:i}}}getConfiguration(){return{...this.uiEffectsConfig}}getVisualState(){return this.getConsciousnessState()}getConsciousnessState(){return{...this.activityState}}generateDiagnosticReport(){let t=performance.now(),i=performance.memory,a=100,r={whiteLayerProblems:[...this.activityState.diagnostic.whiteLayerIssues],webglContextIssues:[],performanceWarnings:[],configurationErrors:[]},n=[];this.activityState.performance.avgFrameTime>33&&(a-=20,r.performanceWarnings.push(`High frame time: ${this.activityState.performance.avgFrameTime.toFixed(1)}ms`),n.push("Consider reducing visual effect quality or disabling intensive effects")),this.activityState.diagnostic.webglContextHealthy||(a-=30,r.webglContextIssues.push("WebGL context is unhealthy or lost"),n.push("Restart visual effects or check browser WebGL support")),this.uiEffectsConfig.enabled||(r.configurationErrors.push("UI effects are disabled"),n.push("Enable UI effects in settings for full experience")),this.activityState.diagnostic.whiteLayerIssues.length>0&&(a-=15*this.activityState.diagnostic.whiteLayerIssues.length,n.push("Enable auto-fix for white layer issues or check CSS customizations"));let s;return a>=90?s="excellent":a>=70?s="good":a>=50?s="degraded":s="critical",{timestamp:t,systemHealth:s,activeEffects:{shimmer:this.uiEffectsConfig.shimmerEnabled&&this.activityState.shimmer.intensity>0,interaction:this.uiEffectsConfig.interactionTrackingEnabled&&this.activityState.interaction.isActive,audioVisual:this.uiEffectsConfig.audioVisualEnabled&&this.activityState.audioVisual.beatIntensity>0,scroll:this.uiEffectsConfig.scrollEffectsEnabled&&this.activityState.scroll.prismaticEffectActive},performanceMetrics:{averageFrameTime:this.activityState.performance.avgFrameTime,maxFrameTime:this.activityState.performance.maxFrameTime,memoryUsage:i?.usedJSHeapSize||0,cpuUsage:this.activityState.performance.frameTime/16.67},issues:r,recommendations:n}}getShimmerElements(){return new Map(this.shimmerElements)}getInteractionState(){return this.activityState.interaction}getDiagnosticState(){return this.activityState.diagnostic}async destroy(){u?.debug?.log("UIVisualEffectsController","Destroying unified UI effects controller..."),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.diagnosticTimerId&&(clearInterval(this.diagnosticTimerId),this.diagnosticTimerId=null),this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.intersectionObserver=null);for(let t of this.eventUnsubscribeFunctions)t();this.eventUnsubscribeFunctions=[],this.shimmerElements.clear(),this.visualEffectsCoordinator,this.initialized=!1,u?.debug?.log("UIVisualEffectsController","Unified UI effects controller destroyed")}onVisualStateUpdate(t){t.musicIntensity>.6&&this.triggerIntensityEffects(t.musicIntensity),t.colorTemperature&&this.updateTemperatureEffects(t.colorTemperature)}onVisualEffectEvent(t,i){switch(t){case"visual:rhythm-shift":this.triggerShimmerEffects(i.intensity||.5);break;case"visual:color-shift":this.updateTemperatureEffects(i.temperature||6500);break;case"visual:energy-surge":i.intensity>.7&&this.triggerIntensityEffects(i.intensity);break}}getVisualContribution(){let t=[],i=0,a={};return this.uiEffectsConfig.shimmerEnabled&&this.activityState.shimmer.intensity>0&&(a.visualCoherence=this.activityState.activityLevel==="enhanced"?1:.7,a.systemHarmony=this.activityState.shimmer.intensity,t.push("shimmer"),i+=.3),this.uiEffectsConfig.audioVisualEnabled&&this.activityState.audioVisual.nebulaEffectIntensity>0&&(a.effectDepth=this.activityState.audioVisual.nebulaEffectIntensity,a.energyLevel=this.activityState.audioVisual.beatIntensity,t.push("audioVisual"),i+=.4),this.activityState.interaction.isActive&&Math.sqrt(this.activityState.interaction.scrollVelocity.x**2+this.activityState.interaction.scrollVelocity.y**2)>0&&(a.flowDirection={x:this.activityState.interaction.scrollVelocity.x/100,y:this.activityState.interaction.scrollVelocity.y/100},t.push("interaction"),i+=.2),this.activityState.performance.healthStatus!=="critical"&&(t.push("performance"),i+=.1),{contribution:a,confidence:Math.min(1,i),sources:t,timestamp:performance.now()}}triggerIntensityEffects(t){this.uiEffectsConfig.shimmerEnabled&&(this.activityState.shimmer.intensity=Math.min(this.activityState.shimmer.intensity+t*.3,1)),this.uiEffectsConfig.audioVisualEnabled&&(this.activityState.audioVisual.nebulaEffectIntensity=Math.min(this.activityState.audioVisual.nebulaEffectIntensity+t*.2,1)),this.uiEffectsConfig.scrollEffectsEnabled&&(this.activityState.scroll.sheenIntensity=Math.min(this.activityState.scroll.sheenIntensity+t*.1,1))}updateTemperatureEffects(t){let i=Math.max(1e3,Math.min(1e4,t));this.uiEffectsConfig.shimmerEnabled&&(i<3e3?this.activityState.shimmer.effectType="prism":i>7e3?this.activityState.shimmer.effectType="oil-slick":this.activityState.shimmer.effectType="rainbow");let a=(i-1e3)/9e3;this.uiEffectsConfig.audioVisualEnabled&&(this.activityState.audioVisual.nebulaEffectIntensity=Math.min(this.activityState.audioVisual.nebulaEffectIntensity+a*.1,1))}triggerShimmerEffects(t){if(!this.uiEffectsConfig.shimmerEnabled)return;this.activityState.shimmer.intensity=Math.min(this.activityState.shimmer.intensity+t*.4,1);let i=this.activityState.shimmer.effectType;this.activityState.shimmer.effectType="mixed",setTimeout(()=>{this.activityState.shimmer.effectType=i},2e3)}}});var zi,Ds=y(()=>{"use strict";Ri();$();L();x();zi=class extends Ue{constructor(t){super(t);this.effectsState={energy:.5,valence:.5,tempo:120,harmonyHue:0,intensity:.8,lastUpdateTime:0,animationActive:!0,preferredMotion:!0,frameRate:60,lastFrameTime:0};this.animationFrameId=0;this.updateInterval=0;this.eventDebounceTimers={musicEnergy:0,colorHarmony:0,beatSync:0,cssUpdate:0};this.eventDebounceMs=100;this.frameThrottleMs=16;this.lastCSSUpdateTime=0;this.previousCSSValues={energy:0,valence:0,harmonyHue:0,intensity:0,depth:0};this.cssChangeThreshold=.01}debouncedEventHandler(t,i){let a=performance.now();a-this.eventDebounceTimers[t]>=this.eventDebounceMs&&(i(),this.eventDebounceTimers[t]=a)}hasSignificantCSSChange(){let t=this.effectsState,i=1+t.energy*.5,a={energy:t.energy,valence:t.valence,harmonyHue:t.harmonyHue,intensity:t.intensity,depth:i};for(let[r,n]of Object.entries(a)){let s=this.previousCSSValues[r];if(Math.abs(n-s)>=this.cssChangeThreshold)return!0}return!1}updatePreviousCSSValues(){let t=this.effectsState,i=1+t.energy*.5;this.previousCSSValues.energy=t.energy,this.previousCSSValues.valence=t.valence,this.previousCSSValues.harmonyHue=t.harmonyHue,this.previousCSSValues.intensity=t.intensity,this.previousCSSValues.depth=i}batchApplyCSSUpdates(t,i="normal",a="header-effects"){let r={};for(let[n,s]of t)r[n]=s;this.cssController.batchSetVariables("HeaderVisualEffectsController",r,i,a)}scheduleEffectsUpdate(){this.debouncedEventHandler("cssUpdate",()=>{this.hasSignificantCSSChange()&&(this.updateHeaderEffectsVariables(),this.updatePreviousCSSValues())})}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{let t=globalThis.year3000System;this.cssController=t?.cssVariableController||P(),this.effectsState.preferredMotion=!window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.setupMusicEventListeners(),this.setupColorHarmonyListeners(),this.updateHeaderEffectsVariables(),this.effectsState.preferredMotion&&this.startAnimationLoop(),this.setupPerformanceMonitoring(),u?.debug?.log("HeaderVisualEffectsController","Header visual effects initialization complete")}catch(t){u?.debug?.error("HeaderVisualEffectsController","Initialization failed:",t)}}setupMusicEventListeners(){p.subscribe("music:energy",t=>{this.debouncedEventHandler("musicEnergy",()=>{typeof t.energy=="number"&&(this.effectsState.energy=Math.max(0,Math.min(1,t.energy)),this.scheduleEffectsUpdate()),typeof t.tempo=="number"&&(this.effectsState.tempo=Math.max(60,Math.min(200,t.tempo)),this.updateAnimationSpeed()),typeof t.valence=="number"&&(this.effectsState.valence=Math.max(0,Math.min(1,t.valence)),this.scheduleEffectsUpdate())})},"HeaderVisualEffectsController"),p.subscribe("music:beat",t=>{this.debouncedEventHandler("beatSync",()=>{if(this.effectsState.animationActive){let i=t.intensity||.8;this.onBeatDetected(i)}})},"HeaderVisualEffectsController"),p.subscribe("music:energy-changed",t=>{this.debouncedEventHandler("musicEnergy",()=>{typeof t.energy=="number"&&(this.effectsState.energy=Math.max(0,Math.min(1,t.energy)),this.scheduleEffectsUpdate())})},"HeaderVisualEffectsController")}setupColorHarmonyListeners(){p.subscribe("colors:harmonized",t=>{this.debouncedEventHandler("colorHarmony",()=>{t.coordinationMetrics?.coordinationStrategy&&this.updateHarmonyHue(t.coordinationMetrics.coordinationStrategy)})},"HeaderVisualEffectsController"),p.subscribe("colors:extracted",t=>{this.debouncedEventHandler("colorHarmony",()=>{if(t.musicData&&typeof t.musicData.energy=="number"){let i=t.musicData.energy*360;this.effectsState.harmonyHue=i,this.scheduleEffectsUpdate()}})},"HeaderVisualEffectsController")}updateHarmonyHue(t){let a={monochromatic:0,complementary:180,triadic:120,analogous:30,tetradic:90,"split-complementary":150}[t]||0;this.effectsState.harmonyHue=a,this.scheduleEffectsUpdate()}onBeatDetected(t){let i=Math.min(1,this.effectsState.energy+t*.3);this.batchApplyCSSUpdates([["--header-effects-energy",i.toString()]],"high","beat-sync");let a=performance.now()+150,r=()=>{performance.now()>=a&&this.initialized?this.batchApplyCSSUpdates([["--header-effects-energy",this.effectsState.energy.toString()]],"normal","beat-reset"):this.initialized&&requestAnimationFrame(r)};requestAnimationFrame(r)}updateAnimationSpeed(){let a=8/(this.effectsState.tempo/120);this.batchApplyCSSUpdates([["--header-effects-flow-speed",`${Math.max(2,Math.min(16,a))}s`]],"high","tempo-sync")}updateHeaderEffectsVariables(){if(!this.initialized)return;let t=this.effectsState,i=t.intensity*(.6+t.valence*.4)*(.8+t.energy*.2),a=1+t.energy*.5;this.batchApplyCSSUpdates([["--header-effects-energy",t.energy.toString()],["--header-effects-harmony",`${t.harmonyHue}deg`],["--header-effects-intensity",i.toString()],["--header-effects-depth",a.toString()]],"normal","effects-update"),this.effectsState.lastUpdateTime=Date.now()}startAnimationLoop(){let t=i=>{if(!this.initialized||!this.effectsState.animationActive)return;if(i-this.lastCSSUpdateTime<this.frameThrottleMs){this.animationFrameId=requestAnimationFrame(t);return}let a=i-this.effectsState.lastFrameTime;this.effectsState.frameRate=1e3/a,this.effectsState.lastFrameTime=i,i-this.effectsState.lastUpdateTime>100&&this.hasSignificantCSSChange()&&(this.updateHeaderEffectsVariables(),this.updatePreviousCSSValues()),this.lastCSSUpdateTime=i,this.animationFrameId=requestAnimationFrame(t)};this.animationFrameId=requestAnimationFrame(t)}setupPerformanceMonitoring(){this.updateInterval=window.setInterval(()=>{this.initialized&&(this.effectsState.frameRate<30&&u?.debug?.warn("HeaderVisualEffectsController","Performance degradation detected, reducing update frequency"),this.cssController.setVariable("HeaderVisualEffectsController","--header-effects-performance",this.effectsState.frameRate>50?"1":"0.5","low","performance-monitor"))},2e3)}setEffectsIntensity(t){this.effectsState.intensity=Math.max(0,Math.min(1,t)),this.updateHeaderEffectsVariables()}setAnimationActive(t){this.effectsState.animationActive=t,!t&&this.animationFrameId?(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=0):t&&this.effectsState.preferredMotion&&this.startAnimationLoop()}getEffectsState(){return{...this.effectsState}}async healthCheck(){let t=this.initialized&&this.effectsState.frameRate>20&&Date.now()-this.effectsState.lastUpdateTime<5e3;return{healthy:t,issues:t?[]:[this.effectsState.frameRate<=20?"Low frame rate detected":"",Date.now()-this.effectsState.lastUpdateTime>=5e3?"No recent updates":""].filter(i=>i),metrics:{frameRate:this.effectsState.frameRate,energy:this.effectsState.energy,intensity:this.effectsState.intensity,animationActive:this.effectsState.animationActive,lastUpdate:this.effectsState.lastUpdateTime}}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=0),this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=0),p.unsubscribeAll("HeaderVisualEffectsController"),u?.debug?.log("HeaderVisualEffectsController","Header visual effects system cleaned up")}async initialize(){await this._baseInitialize()}async destroy(){this._performSystemSpecificCleanup()}onAnimate(t){this.effectsState.animationActive&&this.updateHeaderEffectsVariables()}}});function ks(c,e){let t=Math.max(0,Math.min(.9999,c))*63,i=Math.max(0,Math.min(.9999,e))*63,a=Math.floor(t),r=Math.floor(i),n=a+1,s=r+1,o=t-a,l=i-r,m=gt[r*64+a],d=gt[r*64+n%64],h=gt[s%64*64+a],g=gt[s%64*64+n%64],f=(R,O,F)=>R+(O-R)*F,S=f(m.x,d.x,o),C=f(m.y,d.y,o),T=f(h.x,g.x,o),w=f(h.y,g.y,o);return{x:f(S,T,l),y:f(C,w,l)}}var gt,Ls=y(()=>{"use strict";gt=new Array(4096);(function(){for(let e=0;e<gt.length;e++){let t=Math.random()*Math.PI*2;gt[e]={x:Math.cos(t),y:Math.sin(t)}}})()});var Rs={};ie(Rs,{SidebarVisualEffectsSystem:()=>ft});var pt,ft,br=y(()=>{"use strict";U();Ls();de();pt=class pt extends j{constructor(t,i,a,r,n,s=null){super(t,i,a,r,n);this.rootNavBar=null;this.overlayContainer=null;this.resizeObserver=null;this.visualEffectsElement=null;this.harmonicModeIndicator=null;this.visualEffectsAnimationFrame=null;this.echoPool=[];this.currentEchoCount=0;this._elementsWithActiveEcho=new WeakSet;this._navInteractionHandler=null;this.echoTimerCounter=0;this._lastMotionDisabled=!1;this.interactionPatterns=new Map;this.proximityObserver=null;this.interactionElements=new Map;this.activeEffects=[];this.animationPhase=0;this.localFrameCount=0;this.musicBeatIntensity=0;this.musicEnergyLevel=0;this.cursorPosition={x:0,y:0};this.cursorVelocity={x:0,y:0};this.lastCursorUpdate=0;this.MAX_EFFECT_POINTS=50;this.EFFECT_DECAY_RATE=.05;this.PROXIMITY_THRESHOLD=100;this.INTERACTION_COOLDOWN=16;this.ANIMATION_LERP=.08;this.SMOOTHING_LERP=.12;this.INTENSITY_LERP=.15;this.year3000System=s,this.masterAnimationRegistered=!1,this.isUsingMasterAnimation=!1,this.currentHarmonicModeClass="",this.currentEnergyClass="",this.currentHarmonicModeKey="artist-vision",this.nexusVariables={},this.performanceMetrics={animationFrames:0,maxFrameTime:0,averageFrameTime:0,frameTimeHistory:[],cssVariableUpdates:0,elementUpdates:0},this.deviceCapabilities={supportsCSSFilter:this._detectCSSFilterSupport(),supportsTransforms:this._detectTransformSupport(),performanceLevel:this._detectPerformanceLevel(),reducedMotion:this._detectReducedMotion()},this.animationState={lastPulse:0,pulseDirection:1,baseOpacity:.7,currentScale:1,targetScale:1,smoothingFactor:.15},this.visualState={direction:"radial",intensity:.3,velocity:50,smoothing:.7,effectPoints:[]},this.userInteractionState={globalIntensity:0,dominantDirection:0,interactionCount:0,lastInteractionTime:0,proximityElements:[]},this.setupEffectPoints(),this.setupInteractionPatterns(),t.enableDebug&&console.log(`[${this.systemName}] Enhanced with visual interaction system`)}onAnimate(t){}_detectCSSFilterSupport(){let t=document.createElement("div");return t.style.filter="blur(1px)",!!t.style.filter}_detectTransformSupport(){let t=document.createElement("div");return t.style.transform="scale(1.1)",!!t.style.transform}_detectPerformanceLevel(){let t=navigator.deviceMemory||4,i=navigator.hardwareConcurrency||4;return t>=8&&i>=8?"high":t>=4&&i>=4?"medium":"low"}_detectReducedMotion(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}async initialize(){if(await super.initialize(),this.rootNavBar=document.querySelector(".Root__nav-bar"),!this.rootNavBar){this.initialized=!1;return}this._createOverlayContainer(),this._createVisualEffectsElement(),this.createHarmonicModeDisplay(),this.updateColors(),this.rootNavBar&&(this._navInteractionHandler=t=>{let i=t.target;!i||!(i instanceof HTMLElement)||i.matches("a, button, [role='link']")&&this._spawnNavEcho(i)},this.rootNavBar.addEventListener("focusin",this._navInteractionHandler,!0),this.rootNavBar.addEventListener("pointerenter",this._navInteractionHandler,!0)),this._tryRegisterWithMasterAnimation(),this._setupResizeObserver()}_createOverlayContainer(){this.overlayContainer=document.createElement("div"),this.overlayContainer.id="sidebar-visual-effects-overlay",this.overlayContainer.style.position="absolute",this.overlayContainer.style.pointerEvents="none",this.overlayContainer.style.zIndex="1000",document.body.appendChild(this.overlayContainer)}_setupResizeObserver(){!this.rootNavBar||!this.overlayContainer||(this.resizeObserver=new ResizeObserver(t=>{for(let i of t){let{left:a,top:r,width:n,height:s}=i.contentRect;this.overlayContainer&&(this.overlayContainer.style.left=`${a}px`,this.overlayContainer.style.top=`${r}px`,this.overlayContainer.style.width=`${n}px`,this.overlayContainer.style.height=`${s}px`)}}),this.resizeObserver.observe(this.rootNavBar))}_tryRegisterWithMasterAnimation(){if(this.year3000System&&this.year3000System.registerAnimationSystem)try{this.year3000System.registerAnimationSystem("SidebarVisualEffectsSystem",this,"background",this.deviceCapabilities.performanceLevel==="high"?30:15),this.masterAnimationRegistered=!0,this.isUsingMasterAnimation=!0}catch{this._startFallbackVisualEffectsLoop()}else this._startFallbackVisualEffectsLoop()}_startFallbackVisualEffectsLoop(){this.isUsingMasterAnimation=!1,this.startVisualEffectsLoop()}updateAnimation(t){if(this.deviceCapabilities.reducedMotion||!this.visualEffectsElement||!this.rootNavBar)return;let a=performance.now()*.001,r=Math.sin(a*2)*.1+.9;if(this.animationState.targetScale=r,this.animationState.currentScale+=(this.animationState.targetScale-this.animationState.currentScale)*this.animationState.smoothingFactor,this.visualEffectsElement.style.transform=`translateX(-50%) scale(${this.animationState.currentScale.toFixed(3)})`,this.harmonicModeIndicator){let n=(Math.sin(a*1.5)*.1+.85).toFixed(2);this.harmonicModeIndicator.style.opacity=n}}onPerformanceModeChange(t){t==="low"?this.animationState.smoothingFactor=.3:this.animationState.smoothingFactor=.15}handleSettingsChange(t){super.handleSettingsChange(t),t.detail.key==="sn-harmonic-mode"&&this.updateHarmonicModeDisplay(t.detail.value)}_createVisualEffectsElement(){this.overlayContainer&&(this.visualEffectsElement=document.createElement("div"),this.visualEffectsElement.className="sidebar-visual-effects-element",this.overlayContainer.appendChild(this.visualEffectsElement))}createHarmonicModeDisplay(){this.overlayContainer&&(this.harmonicModeIndicator=document.createElement("div"),this.harmonicModeIndicator.className="harmonic-mode-indicator",this.overlayContainer.appendChild(this.harmonicModeIndicator))}updateColors(){if(!this.visualEffectsElement||!this.harmonicModeIndicator||!this.rootNavBar)return;let t=getComputedStyle(this.rootNavBar),i=t.getPropertyValue("--spice-sidebar"),a=t.getPropertyValue("--spice-text");this.visualEffectsElement.style.backgroundColor=i,this.visualEffectsElement.style.borderColor=a,this.visualEffectsElement.style.borderWidth="1px",this.visualEffectsElement.style.borderStyle="solid",this.harmonicModeIndicator&&(this.harmonicModeIndicator.style.backgroundColor=`rgba(${this.utils.hexToRgb(a)?.r}, ${this.utils.hexToRgb(a)?.g}, ${this.utils.hexToRgb(a)?.b}, 0.1)`,this.harmonicModeIndicator.style.color=a)}startVisualEffectsLoop(){this.visualEffectsAnimationFrame&&cancelAnimationFrame(this.visualEffectsAnimationFrame);let t=i=>{this.updateAnimation(16.67),this.visualEffectsAnimationFrame=requestAnimationFrame(t)};this.visualEffectsAnimationFrame=requestAnimationFrame(t)}updateHarmonicModeDisplay(t){if(this.currentHarmonicModeKey=t,this.rootNavBar){let i=this.rootNavBar.classList;i.forEach(r=>{r.startsWith("sn-harmonic-")&&i.remove(r)}),ve[t]&&this.rootNavBar.classList.add(`sn-harmonic-${t}`)}}_updateSidebarVariables(t={}){if(!this.rootNavBar)return;let{visualIntensity:i=.5,moodIdentifier:a="neutral",energyLevel:r="low"}=t;this.rootNavBar.classList.remove("sn-music-low-energy","sn-music-mid-energy","sn-music-high-energy"),this.rootNavBar.classList.add(`sn-music-${r}-energy`),this.rootNavBar.setAttribute("data-mood",a);let n=Math.max(0,Math.min(1,i)),s=Math.min(.5,n*.6),o=(l,m)=>{this.year3000System&&this.year3000System.queueCSSVariableUpdate?this.year3000System.queueCSSVariableUpdate(l,m,this.rootNavBar):this.rootNavBar.style.setProperty(l,m)};o("--sn-nav-item-glow-intensity",`${n}`),o("--sn-nav-text-energy-opacity",`${s}`),o("--sidebar-intensity",`${i}`)}updateFromMusicAnalysis(t,i,a){this.initialized&&(super.updateFromMusicAnalysis(t),this._updateSidebarVariables(t))}updateModeConfiguration(t){super.updateModeConfiguration(t),this.currentHarmonicModeKey=t.activeMode||"artist-vision",this.updateVisualEffectsForMode(),this.updateHarmonicModeDisplay(this.currentHarmonicModeKey)}updateVisualEffectsForMode(){if(this.visualEffectsElement){let t=this.modeConfig?.intensityMultiplier||1;this.visualEffectsElement.style.opacity=`${.1*t}`}}destroy(){if(this.visualEffectsAnimationFrame&&cancelAnimationFrame(this.visualEffectsAnimationFrame),this.year3000System?.timerConsolidationSystem)for(let t=0;t<this.echoTimerCounter;t++)this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer(`SidebarVisualEffectsSystem-echo-${t}`);if(this.rootNavBar&&this._navInteractionHandler&&(this.rootNavBar.removeEventListener("focusin",this._navInteractionHandler,!0),this.rootNavBar.removeEventListener("pointerenter",this._navInteractionHandler,!0),this._navInteractionHandler=null),this.year3000System&&this.year3000System.unregisterAnimationSystem&&this.year3000System.unregisterAnimationSystem("SidebarVisualEffectsSystem"),this.resizeObserver&&this.rootNavBar&&(this.resizeObserver.unobserve(this.rootNavBar),this.resizeObserver.disconnect(),this.resizeObserver=null),this.overlayContainer&&this.overlayContainer.parentNode&&(this.overlayContainer.parentNode.removeChild(this.overlayContainer),this.overlayContainer=null),this.rootNavBar){let t=this.rootNavBar.classList;t.forEach(i=>{i.startsWith("sn-")&&t.remove(i)})}super.destroy()}get echoIntensitySetting(){let i=parseInt("2",10);return isNaN(i)?2:i}get dynamicMaxEchoes(){switch(this.echoIntensitySetting){case 0:return 0;case 1:return Math.ceil(pt.BASE_MAX_ECHOES/2);case 3:return pt.BASE_MAX_ECHOES*2;default:return pt.BASE_MAX_ECHOES}}_acquireEchoElement(){let t=this.echoPool.pop();return t?(t.style.animation="none",t.offsetWidth,t.style.animation=""):(t=document.createElement("div"),t.className="sn-temporal-echo"),t}_releaseEchoElement(t){this.echoPool.length<20&&this.echoPool.push(t)}_spawnNavEcho(t){if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||this.currentEchoCount>=this.dynamicMaxEchoes||this.echoIntensitySetting===0||this._elementsWithActiveEcho.has(t))return;let i=this.musicSyncService?.getLatestProcessedData()??{},a=i.energy??.5,r=i.valence??.5,n=Math.min(1.4,1+a*.4),s=((r-.5)*40).toFixed(1),o=t.getBoundingClientRect(),l=o.left/window.innerWidth,m=o.top/window.innerHeight,d=ks(l,m),h=this.musicSyncService?.getCurrentBeatVector?.()??{x:0,y:0},g=6+a*6,f=(d.x+h.x)*g,S=(d.y+h.y)*g,C=d.x*6,T=(Math.random()*360).toFixed(1),w=this._acquireEchoElement();w.style.setProperty("--sn-echo-radius-multiplier",n.toFixed(2)),w.style.setProperty("--sn-echo-hue-shift",`${s}deg`),w.style.setProperty("--sn-echo-offset-x",`${f.toFixed(1)}px`),w.style.setProperty("--sn-echo-offset-y",`${S.toFixed(1)}px`),w.style.setProperty("--sn-echo-skew",`${C.toFixed(2)}deg`),w.style.setProperty("--sn-echo-rotate",`${T}deg`),t.appendChild(w),this.currentEchoCount++,this._elementsWithActiveEcho.add(t);let R=`SidebarVisualEffectsSystem-echo-${this.echoTimerCounter++}`,O=()=>{w.parentElement&&w.parentElement.removeChild(w),this.currentEchoCount--,this._releaseEchoElement(w),this._elementsWithActiveEcho.delete(t)};this.year3000System?.timerConsolidationSystem?this.year3000System.timerConsolidationSystem.registerConsolidatedTimer(R,O,1100,"background"):setTimeout(O,1100)}applyPerformanceSettings(t){super.applyPerformanceSettings(t);let a=!t.enableGPUAcceleration||t.animationThrottle>=24||t.reducedMotion;this.rootNavBar&&a!==this._lastMotionDisabled&&(this.rootNavBar.classList.toggle("sn-motion-disabled",a),this._lastMotionDisabled=a)}setupEffectPoints(){this.visualState.effectPoints=[];let t=8,i=20;for(let a=0;a<t;a++)for(let r=0;r<t;r++){let n={x:a*i,y:r*i,magnitude:.5+Math.random()*.5,direction:Math.random()*Math.PI*2,influence:.3+Math.random()*.4};this.visualState.effectPoints.push(n)}}setupInteractionPatterns(){this.interactionPatterns.set("hover",{id:"hover",type:"hover",response:{intensityChange:.2,velocityChange:.1,smoothingChange:-.1,visualEffects:[{center:{x:0,y:0},radius:30,strength:.3,decay:.05,type:"wave"}],rippleEffect:!1,glowEffect:!0},duration:300,easing:"smooth",priority:3}),this.interactionPatterns.set("click",{id:"click",type:"click",response:{intensityChange:.5,velocityChange:.3,smoothingChange:-.2,visualEffects:[{center:{x:0,y:0},radius:50,strength:.7,decay:.08,type:"pulse"}],rippleEffect:!1,glowEffect:!0},duration:500,easing:"smooth",priority:8}),this.interactionPatterns.set("focus",{id:"focus",type:"focus",response:{intensityChange:.3,velocityChange:.05,smoothingChange:.1,visualEffects:[{center:{x:0,y:0},radius:40,strength:.4,decay:.02,type:"spiral"}],rippleEffect:!1,glowEffect:!0},duration:1e3,easing:"smooth",priority:6})}setupProximityDetection(){typeof IntersectionObserver<"u"&&(this.proximityObserver=new IntersectionObserver(t=>{t.forEach(i=>{let a=i.target,r=a.id||a.className;i.isIntersecting?(this.interactionElements.set(r,a),this.handleProximityEnter(a)):(this.interactionElements.delete(r),this.handleProximityExit(a))})},{threshold:[0,.1,.5,1],rootMargin:`${this.PROXIMITY_THRESHOLD}px`}))}handleProximityEnter(t){let i=t.getBoundingClientRect(),a={x:i.left+i.width/2,y:i.top+i.height/2},r=Math.sqrt(Math.pow(a.x-this.cursorPosition.x,2)+Math.pow(a.y-this.cursorPosition.y,2));this.userInteractionState.proximityElements.push({element:t,distance:r,influence:Math.max(0,1-r/this.PROXIMITY_THRESHOLD)})}handleProximityExit(t){this.userInteractionState.proximityElements=this.userInteractionState.proximityElements.filter(i=>i.element!==t)}updateVisualEffects(){this.activeEffects=this.activeEffects.filter(t=>(t.strength*=1-t.decay,t.strength>.01)),this.activeEffects.forEach(t=>{this.visualState.effectPoints.forEach(i=>{let a=Math.sqrt(Math.pow(i.x-t.center.x,2)+Math.pow(i.y-t.center.y,2));if(a<t.radius){let r=t.strength*(1-a/t.radius);switch(t.type){case"wave":i.magnitude+=r*.3;break;case"spiral":i.direction+=r*.5;break;case"pulse":i.magnitude+=r*.5,i.direction+=r*.2;break;case"vortex":let n=Math.atan2(i.y-t.center.y,i.x-t.center.x);i.direction=n+r*Math.PI*.5;break}}})})}updateMusicVisualEffects(){let t=this.musicBeatIntensity*.3;this.visualState.intensity=Math.max(this.visualState.intensity,t);let i=this.musicEnergyLevel*30;this.visualState.velocity=Math.min(200,this.visualState.velocity+i);let a=(1-this.musicEnergyLevel)*.2;this.visualState.smoothing=Math.max(.1,this.visualState.smoothing-a)}getVisualState(){return{...this.visualState}}getUserInteractionState(){return{...this.userInteractionState}}getActiveEffects(){return[...this.activeEffects]}};pt.BASE_MAX_ECHOES=4;ft=pt});var vr,Ft,Bs=y(()=>{"use strict";L();vr=class{static selectOptimalBackend(e){let t=e.filter(i=>i.backend.isReady&&i.backend.capabilities).sort((i,a)=>a.priority-i.priority);for(let i of t){let a=i.capabilities;if(a.webgl2&&a.maxTextureSize>=2048||a.webgl&&a.maxTextureSize>=1024||i.backend.backendId==="css")return i.backend}return null}},Ft=class{constructor(e,t,i,a,r,n={}){this.initialized=!1;this.registeredBackends=new Map;this.activeBackend=null;this.rootElement=null;this.currentPalette=[];this.currentMusicMetrics=null;this.lastFrameTime=0;this.frameCount=0;this.performanceCheckInterval=null;this.eventBus=e||p,this.cssController=t,this.colorHarmonyEngine=i,this.musicSyncService=a,this.performanceAnalyzer=r,this.config={enabledBackends:["webgl","css"],defaultQuality:"high",transitionDuration:500,performanceMonitoring:!0,autoQualityScaling:!0,...n},this.currentConstraints={targetFPS:60,maxMemoryMB:50,cpuBudgetPercent:10,gpuBudgetPercent:25,qualityLevel:this.config.defaultQuality}}async initialize(){try{this.setupEventListeners(),this.setupCSSVariableUpdates(),this.config.performanceMonitoring&&this.startPerformanceMonitoring(),this.updateGlobalStatus(),this.initialized=!0,console.log("[GradientConductor] Initialized successfully",{enabledBackends:this.config.enabledBackends,registeredBackends:Array.from(this.registeredBackends.keys())})}catch(e){throw console.error("[GradientConductor] Initialization failed:",e),e}}registerBackend(e,t=0){let i={backend:e,priority:t,capabilities:e.capabilities,lastHealthCheck:new Date,isActive:!1};this.registeredBackends.set(e.backendId,i),console.log(`[GradientConductor] Registered backend: ${e.backendId}`,{priority:t,capabilities:e.capabilities}),this.evaluateActiveBackend()}unregisterBackend(e){let t=this.registeredBackends.get(e);t&&(t.backend.setEnabled(!1),this.registeredBackends.delete(e),this.activeBackend?.backendId===e&&(this.activeBackend=null,this.evaluateActiveBackend()),console.log(`[GradientConductor] Unregistered backend: ${e}`))}async initializeBackends(e){this.rootElement=e;let t=Array.from(this.registeredBackends.values()).map(async i=>{try{await i.backend.init(e,this.currentConstraints),console.log(`[GradientConductor] Backend ${i.backend.backendId} initialized`)}catch(a){console.error(`[GradientConductor] Failed to initialize backend ${i.backend.backendId}:`,a)}});await Promise.allSettled(t),this.evaluateActiveBackend(),this.activeBackend&&(this.currentPalette.length>0&&this.activeBackend.setPalette(this.currentPalette),this.currentMusicMetrics&&this.activeBackend.setMusicMetrics(this.currentMusicMetrics))}setPalette(e,t=this.config.transitionDuration){this.currentPalette=[...e],this.updateCSSGradientVariables(e),this.activeBackend&&this.activeBackend.setPalette(e,t),this.updateGlobalStatus(),console.log("[GradientConductor] Palette updated",{stops:e.length,activeBackend:this.activeBackend?.backendId,transition:t})}setMusicMetrics(e){this.currentMusicMetrics=e,this.updateCSSMusicVariables(e),this.activeBackend&&this.activeBackend.setMusicMetrics(e),this.eventBus.emit("music:energy",{energy:e.energy,valence:e.valence,tempo:e.bpm,timestamp:Date.now()})}setPerformanceConstraints(e){this.currentConstraints={...e};for(let t of this.registeredBackends.values())t.backend.setPerformanceConstraints(e);e.qualityLevel!==this.currentConstraints.qualityLevel&&this.evaluateActiveBackend(),console.log("[GradientConductor] Performance constraints updated",e)}getActiveBackend(){return this.activeBackend}async triggerMusicEmotionAnalysis(e,t){try{if(this.colorHarmonyEngine&&typeof this.colorHarmonyEngine.analyzeMusicEmotion=="function"){let i=await this.colorHarmonyEngine.analyzeMusicEmotion(e,t);i&&this.config.performanceMonitoring&&console.log(`[GradientConductor] Music emotion analysis triggered: ${i.primary} (${i.intensity.toFixed(2)} intensity)`)}else console.warn("[GradientConductor] ColorHarmonyEngine not available for music emotion analysis")}catch(i){console.error("[GradientConductor] Error triggering music emotion analysis:",i)}}getRegisteredBackends(){return Array.from(this.registeredBackends.values())}setActiveBackend(e){let t=this.registeredBackends.get(e);if(!t||!t.backend.isReady)return!1;if(this.activeBackend){this.activeBackend.setEnabled(!1);let i=this.registeredBackends.get(this.activeBackend.backendId);i&&(i.isActive=!1)}return this.activeBackend=t.backend,t.isActive=!0,t.backend.setEnabled(!0,this.config.transitionDuration),this.updateGlobalStatus(),console.log(`[GradientConductor] Forced backend switch to: ${e}`),!0}async healthCheck(){let e=[];for(let[t,i]of this.registeredBackends)try{let a=await i.backend.healthCheck();i.lastHealthCheck=new Date,a.ok||e.push(`Backend ${t}: ${a.details||"Health check failed"}`)}catch(a){e.push(`Backend ${t}: Health check error - ${a}`)}return{healthy:e.length===0,ok:e.length===0,details:e.length>0?`${e.length} backend issues detected`:"All backends healthy",issues:e,system:"GradientConductor"}}updateAnimation(e){this.frameCount++,this.lastFrameTime=e,this.activeBackend&&this.activeBackend.updateAnimation(e)}destroy(){this.performanceCheckInterval&&(clearInterval(this.performanceCheckInterval),this.performanceCheckInterval=null);for(let e of this.registeredBackends.values())e.backend.destroy();this.registeredBackends.clear(),this.activeBackend=null,this.initialized=!1,console.log("[GradientConductor] Destroyed")}setupEventListeners(){this.eventBus.subscribe("colors:harmonized",e=>{if(e&&e.processedColors){let t=Object.entries(e.processedColors).map(([i,a],r,n)=>{let s=a,o=128,l=128,m=128;if(s.startsWith("#")){let d=s.slice(1);o=parseInt(d.slice(0,2),16),l=parseInt(d.slice(2,4),16),m=parseInt(d.slice(4,6),16)}return{r:o,g:l,b:m,position:r/(n.length-1)}});this.setPalette(t)}},"GradientConductor"),this.eventBus.subscribe("music:energy",e=>{let t={energy:e.energy,valence:e.valence,bpm:e.tempo,beatIntensity:e.energy,rhythmPhase:0,pulsingScale:1+e.energy*.2};this.setMusicMetrics(t)},"GradientConductor"),this.eventBus.subscribe("music:beat",e=>{let t={energy:e.intensity,valence:.5,bpm:e.bpm,beatIntensity:e.intensity,rhythmPhase:Date.now()/16.67%360,pulsingScale:1+e.intensity*.1};this.setMusicMetrics(t)},"GradientConductor"),this.eventBus.subscribe("performance:tier-changed",e=>{let t={targetFPS:60,maxMemoryMB:50,cpuBudgetPercent:10,gpuBudgetPercent:25,qualityLevel:e.tier==="excellent"?"ultra":e.tier==="good"?"high":e.tier==="degraded"?"medium":"low"};this.setPerformanceConstraints(t)},"GradientConductor"),this.eventBus.subscribe("settings:changed",e=>{if(e.settingKey.includes("accessibility")||e.settingKey.includes("motion")){let t={reducedMotion:e.settingKey.includes("motion")&&e.newValue==="reduce",highContrast:e.settingKey.includes("contrast")&&e.newValue==="high",prefersTransparency:e.settingKey.includes("transparency")&&e.newValue==="reduce"};for(let i of this.registeredBackends.values())i.backend.applyAccessibilityPreferences?.(t)}},"GradientConductor"),this.eventBus.subscribe("music:emotion-analyzed",e=>{this.handleEmotionUpdate(e)},"GradientConductor"),this.eventBus.subscribe("music:emotional-context-updated",e=>{this.handleEmotionalColorContext(e)},"GradientConductor")}setupCSSVariableUpdates(){["--sn.music.beat.pulse.intensity","--sn.music.rhythm.phase","--sn.music.pulsing.scale","--sn.bg.webgl.ready","--sn.bg.active-backend","--sn-emotion-primary","--sn-emotion-intensity","--sn-color-temperature","--sn-visual-effects-level","--sn-smooth-flow","--sn-cinematic-depth"].forEach(t=>{this.cssController.addCriticalVariable(t)})}handleEmotionUpdate(e){try{let{emotion:t,colorTemperature:i,visualLevel:a,smoothFlow:r,cinematicDepth:n}=e;this.cssController.setProperty("--sn-emotion-primary",t.primary||"neutral"),this.cssController.setProperty("--sn-emotion-intensity",(t.intensity||.5).toString()),this.cssController.setProperty("--sn-emotion-confidence",(t.confidence||.5).toString()),this.cssController.setProperty("--sn-color-temperature",(i||6500).toString()),this.cssController.setProperty("--sn-visual-effects-level",(a||.5).toString()),this.cssController.setProperty("--sn-smooth-flow",(r||.5).toString()),this.cssController.setProperty("--sn-cinematic-depth",(n||.5).toString());for(let s of this.registeredBackends.values())s.backend.setEmotionalState&&s.backend.setEmotionalState(t);console.log(`[GradientConductor] Emotion updated: ${t.primary} (intensity: ${t.intensity?.toFixed(2)||"N/A"})`)}catch(t){console.error("[GradientConductor] Error handling emotion update:",t)}}handleEmotionalColorContext(e){try{let{primaryEmotion:t,emotionIntensity:i,colorTemperature:a,valence:r,arousal:n,dominance:s,smoothFlow:o,cinematicDepth:l,visualResonance:m}=e;this.cssController.setProperty("--sn-emotion-valence",(r||.5).toString()),this.cssController.setProperty("--sn-emotion-arousal",(n||.5).toString()),this.cssController.setProperty("--sn-emotion-dominance",(s||.5).toString()),this.cssController.setProperty("--sn-visual-resonance",(m||.5).toString());for(let d of this.registeredBackends.values())d.backend.setEmotionalContext&&d.backend.setEmotionalContext(e);console.log(`[GradientConductor] Emotional context updated: ${t} (temp: ${a}K)`)}catch(t){console.error("[GradientConductor] Error handling emotional color context:",t)}}updateCSSGradientVariables(e){if(e.length===0)return;let t=e[0],i=e[Math.floor(e.length/2)],a=e[e.length-1];this.cssController.setProperty("--sn.bg.gradient.primary.rgb",`${t.r}, ${t.g}, ${t.b}`),this.cssController.setProperty("--sn.bg.gradient.secondary.rgb",`${i.r}, ${i.g}, ${i.b}`),this.cssController.setProperty("--sn.bg.gradient.accent.rgb",`${a.r}, ${a.g}, ${a.b}`),this.cssController.setProperty("--sn.color.accent.rgb",`${a.r}, ${a.g}, ${a.b}`),this.cssController.setProperty("--sn.color.accent.hex",`#${Math.round(a.r).toString(16).padStart(2,"0")}${Math.round(a.g).toString(16).padStart(2,"0")}${Math.round(a.b).toString(16).padStart(2,"0")}`)}updateCSSMusicVariables(e){e.beatIntensity!==void 0&&this.cssController.setProperty("--sn.music.beat.pulse.intensity",e.beatIntensity.toString()),e.rhythmPhase!==void 0&&this.cssController.setProperty("--sn.music.rhythm.phase",`${e.rhythmPhase}deg`),e.pulsingScale!==void 0&&this.cssController.setProperty("--sn.music.pulsing.scale",e.pulsingScale.toString()),this.cssController.setProperty("--sn.music.energy.level",e.energy.toString()),this.cssController.setProperty("--sn.music.valence",e.valence.toString()),this.cssController.setProperty("--sn.music.tempo.bpm",e.bpm.toString())}updateGlobalStatus(){this.cssController.setProperty("--sn.bg.webgl.ready",this.registeredBackends.has("webgl")?"1":"0"),this.cssController.setProperty("--sn.bg.active-backend",this.activeBackend?.backendId||"none"),typeof window<"u"&&(window.snActiveBackend=this.activeBackend?.backendId||"none")}evaluateActiveBackend(){let e=vr.selectOptimalBackend(Array.from(this.registeredBackends.values()));if(e&&e!==this.activeBackend){if(this.activeBackend){this.activeBackend.setEnabled(!1,this.config.transitionDuration);let i=this.registeredBackends.get(this.activeBackend.backendId);i&&(i.isActive=!1)}this.activeBackend=e;let t=this.registeredBackends.get(e.backendId);t&&(t.isActive=!0,e.setEnabled(!0,this.config.transitionDuration)),this.updateGlobalStatus(),console.log(`[GradientConductor] Switched to backend: ${e.backendId}`),this.eventBus.emit("system:initialized",{systemName:`GradientConductor-${e.backendId}`,timestamp:Date.now(),metadata:{previousBackend:this.activeBackend?.backendId||"none",newBackend:e.backendId,capabilities:e.capabilities.webgl?"webgl":"css"}})}}startPerformanceMonitoring(){this.performanceCheckInterval=window.setInterval(()=>{if(this.activeBackend)try{let e=this.activeBackend.getPerformanceMetrics();this.config.autoQualityScaling&&this.evaluateQualityScaling(e),this.performanceAnalyzer.recordMetric("gradientConductor.fps",e.fps),this.performanceAnalyzer.recordMetric("gradientConductor.memory",e.memoryUsageMB)}catch(e){console.warn("[GradientConductor] Performance monitoring error:",e)}},2e3)}evaluateQualityScaling(e){let t=this.currentConstraints;if(e.fps<t.targetFPS*.8||e.memoryUsageMB>t.maxMemoryMB*1.2){let i=t.qualityLevel;switch(t.qualityLevel){case"ultra":i="high";break;case"high":i="medium";break;case"medium":i="low";break;case"low":this.evaluateActiveBackend();return}console.log(`[GradientConductor] Auto-scaling quality: ${t.qualityLevel} \u2192 ${i}`),this.setPerformanceConstraints({...t,qualityLevel:i})}}}});var Ui,Vs=y(()=>{"use strict";Ri();X();Sa();Ui=class extends Ue{constructor(t){super(t);this.musicIntensity=0;this.scaleMultiplier=1;this.animationPhase=0;this.colorTemperature=4e3;this.transitionFluidityLevel=.5;this.targetMusicIntensity=0;this.targetScaleMultiplier=1;this.targetColorTemperature=4e3;this.targetTransitionFluidityLevel=.5;this.lerpHalfLifeValues={intensityAttack:.05,intensityDecay:.15,scaleMultiplier:.08,colorTemperature:.3,transitionFluidity:.12};this.lastBeatTime=0;this.currentBPM=120;this.animationCycleDuration=2e3;this.musicSyncService=null;this.currentMusicalContext=null;this.lastBeatPhaseUpdate=0;this.performanceMetrics={syncUpdates:0,scaleEvents:0,animationCycles:0,emotionalShifts:0,averageFrameTime:0,memoryUsage:0};this.syncConfig={responseSensitivity:.7,animationIntensity:.8,colorTemperatureRange:{min:1e3,max:2e4},transitionFluidityEnabled:!0,visualParticlesEnabled:!0,cinematicEffectsEnabled:!0};this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F3B5} Music beat synchronizer initializing...")}setMusicSyncService(t){this.musicSyncService=t,this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F3B5} Music synchronization service activated")}onBeatDetected(t){let{intensity:i,bpm:a,energy:r,timestamp:n}=t;this.lastBeatTime=n||Date.now(),this.currentBPM=a||this.currentBPM,this.targetMusicIntensity=Math.min(1,i*this.syncConfig.responseSensitivity),this.targetScaleMultiplier=1+(r||.5)*.3,this.performanceMetrics.scaleEvents++,this.config.enableDebug&&console.log(`[MusicBeatSynchronizer] \u{1F3B5} Beat detected: intensity=${i}, energy=${r}, bpm=${a}`)}onEnergyChanged(t){let{energy:i,valence:a}=t;this.targetScaleMultiplier=1+i*.3,this.targetTransitionFluidityLevel=.3+a*.4,this.config.enableDebug&&console.log(`[MusicBeatSynchronizer] \u26A1 Energy change: energy=${i}, valence=${a}`)}onEmotionDetected(t){let{valence:i,energy:a}=t,r=4e3,n=(a-.5)*8e3,s=(i-.5)*6e3;this.targetColorTemperature=Math.max(1e3,Math.min(2e4,r+n+s)),this.performanceMetrics.emotionalShifts++,this.config.enableDebug&&console.log(`[MusicBeatSynchronizer] \u{1F308} Emotion detected: ${this.colorTemperature}K temperature`)}onTempoChanged(t){let{bpm:i,tempo:a,enhancedBPM:r}=t;this.currentBPM=r||i||a||120;let n=Math.max(.3,Math.min(3,this.currentBPM/120));this.animationCycleDuration=2e3/n,this.config.enableDebug&&console.log(`[MusicBeatSynchronizer] \u{1F3B6} Tempo changed: ${this.currentBPM} BPM, ${this.animationCycleDuration.toFixed(0)}ms cycle`)}async initialize(){this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F3B5} Initializing music synchronization system..."),this.registerCSSVariableGroup("music-sync-core","critical"),this.registerCSSVariableGroup("visual-scaling","high"),this.registerCSSVariableGroup("color-temperature","normal"),this.registerCSSVariableGroup("transition-fluidity","normal"),this.musicIntensity=0,this.scaleMultiplier=1,this.animationPhase=0,this.colorTemperature=4e3,this.transitionFluidityLevel=.5,this.subscribeToEvent("music:beat",t=>this.onBeatDetected(t)),this.subscribeToEvent("music:energy",t=>this.onEnergyChanged(t)),this.subscribeToEvent("music:emotion",t=>this.onEmotionDetected(t)),this.subscribeToEvent("music:bpm-change",t=>this.onTempoChanged(t)),this.registerAnimation(60),this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F31F} Music synchronization system ready")}destroy(){this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F343} Shutting down music synchronizer..."),this.musicIntensity=0,this.scaleMultiplier=1,this.animationPhase=0,this.colorTemperature=4e3,this.transitionFluidityLevel=.5,this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F30C} Music synchronizer cleanly shut down")}onAnimate(t){let i=performance.now();this.updateMusicalContext(),this.updateMusicSyncState(t),this.processVisualScaling(t),this.updateColorTemperature(t),this.animateTransitionFluidity(t),this.applyMusicSyncCSSVariables();let a=performance.now()-i;this.performanceMetrics.averageFrameTime=this.performanceMetrics.averageFrameTime*.9+a*.1,this.performanceMetrics.syncUpdates++,a>2&&this.config.enableDebug&&console.warn(`[MusicBeatSynchronizer] \u{1F40C} Music sync frame took ${a.toFixed(2)}ms (target: <2ms)`)}async healthCheck(){let t=[];return this.eventBus||t.push("EventBus not connected for music coordination"),this.performanceMetrics.averageFrameTime>2&&t.push(`Average frame time ${this.performanceMetrics.averageFrameTime.toFixed(2)}ms exceeds 2ms target`),this.musicIntensity===0&&Date.now()-this.lastBeatTime>1e4&&t.push("No music synchronization activity detected in last 10 seconds"),(this.colorTemperature<1e3||this.colorTemperature>2e4)&&t.push(`Color temperature ${this.colorTemperature}K outside 1000K-20000K range`),{healthy:t.length===0,ok:t.length===0,details:`Music synchronization health: ${t.length===0?"optimal":"needs attention"}`,issues:t,system:"MusicBeatSynchronizer"}}updateMusicSyncState(t){this.animationPhase+=t/this.animationCycleDuration*2*Math.PI,this.animationPhase>2*Math.PI&&(this.animationPhase-=2*Math.PI);let i=t/1e3,a=this.targetMusicIntensity>this.musicIntensity?this.lerpHalfLifeValues.intensityAttack:this.lerpHalfLifeValues.intensityDecay;this.musicIntensity=H(this.musicIntensity,this.targetMusicIntensity,i,a),Date.now()-this.lastBeatTime>2e3&&(this.targetMusicIntensity=H(this.targetMusicIntensity,0,i,this.lerpHalfLifeValues.intensityDecay))}processVisualScaling(t){let i=t/1e3;this.scaleMultiplier=H(this.scaleMultiplier,this.targetScaleMultiplier,i,this.lerpHalfLifeValues.scaleMultiplier),this.targetScaleMultiplier=H(this.targetScaleMultiplier,1,i,this.lerpHalfLifeValues.scaleMultiplier*2)}updateColorTemperature(t){let i=t/1e3;this.colorTemperature=H(this.colorTemperature,this.targetColorTemperature,i,this.lerpHalfLifeValues.colorTemperature);let a=4e3;this.targetColorTemperature=H(this.targetColorTemperature,a,i,this.lerpHalfLifeValues.colorTemperature*3)}animateTransitionFluidity(t){if(!this.syncConfig.transitionFluidityEnabled)return;let i=t/1e3;this.transitionFluidityLevel=H(this.transitionFluidityLevel,this.targetTransitionFluidityLevel,i,this.lerpHalfLifeValues.transitionFluidity)}applyMusicSyncCSSVariables(){this.updateCSSVariableGroup("music-sync-core",{"--sn-music-intensity":this.musicIntensity.toFixed(3),"--sn-music-bpm":this.currentBPM.toString(),"--sn-music-animation-phase":this.animationPhase.toFixed(4)}),this.updateCSSVariableGroup("visual-scaling",{"--sn-visual-scale":this.scaleMultiplier.toFixed(3),"--sn-visual-response-sensitivity":this.syncConfig.responseSensitivity.toFixed(2)}),this.updateCSSVariableGroup("color-temperature",{"--sn-color-temperature":`${this.colorTemperature.toFixed(0)}K`,"--sn-color-temperature-normalized":((this.colorTemperature-1e3)/19e3).toFixed(3)}),this.updateCSSVariableGroup("transition-fluidity",{"--sn-transition-fluidity":this.transitionFluidityLevel.toFixed(3),"--sn-transition-fluidity-enabled":this.syncConfig.transitionFluidityEnabled?"1":"0"})}getMusicSyncMetrics(){return{...this.performanceMetrics}}updateSyncConfig(t){this.syncConfig={...this.syncConfig,...t},this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F527} Sync configuration updated:",this.syncConfig)}getMusicSyncState(){return{musicIntensity:this.musicIntensity,scaleMultiplier:this.scaleMultiplier,animationPhase:this.animationPhase,colorTemperature:this.colorTemperature,transitionFluidityLevel:this.transitionFluidityLevel,lastBeatTime:this.lastBeatTime,currentBPM:this.currentBPM}}forceRepaint(t){super.forceRepaint(t),this.musicIntensity=0,this.scaleMultiplier=1,this.animationPhase=0,this.applyMusicSyncCSSVariables(),this.config.enableDebug&&console.log(`[MusicBeatSynchronizer] \u{1F504} Music synchronization repaint: ${t}`)}updateMusicalContext(){if(!this.musicSyncService){this.currentMusicalContext=null;return}let t=Date.now();if(!(t-this.lastBeatPhaseUpdate<16)&&(this.lastBeatPhaseUpdate=t,this.currentMusicalContext=va.createMusicalContext(this.musicSyncService,this.lastBeatTime),this.config.enableDebug&&this.currentMusicalContext)){let i=this.currentMusicalContext;console.log(`[MusicBeatSynchronizer] \u{1F3B5} Musical context: tempo=${i.tempo}, energy=${i.energy.toFixed(2)}, phase=${i.beatPhase}`)}}}});var Oi,Fs=y(()=>{"use strict";pi();L();x();Fe();$();gi();Me();ae();Oi=class{constructor(e,t,i){this.holographicElements=new Map;this.interfaceContainer=null;this.isInitialized=!1;this.isEnabled=!0;this.performanceMetrics={elementsProcessed:0,effectsApplied:0,averageProcessingTime:0,memoryUsage:0,lastUpdate:0};this.animationState={lastFrameTime:0,flickerPhase:0,scanlinePhase:0,chromaticPhase:0,dataStreamPhase:0,interferencePhase:0,dynamicPhase:0,isAnimating:!1};this.holographicPresets={"star-wars":{flickerIntensity:.4,transparency:.8,chromatic:.3,scanlineIntensity:.6,dataStreamFlow:.5,interferenceLevel:.2,energyStability:.7,projectionDistance:.8},"blade-runner":{flickerIntensity:.6,transparency:.7,chromatic:.5,scanlineIntensity:.8,dataStreamFlow:.8,interferenceLevel:.4,energyStability:.6,projectionDistance:.6},"dynamic-visualEffects":{flickerIntensity:.3,transparency:.9,chromatic:.2,scanlineIntensity:.4,dataStreamFlow:.6,interferenceLevel:.3,energyStability:.8,projectionDistance:.9}};this.lastMusicalContext=null;this.eventSubscriptionIds=[];this.lastScrollPosition=0;this.lastMouseMovement=0;this.lastUIClick=0;this.initialized=!1;this.currentQualityLevel=null;this.qualityCapabilities=[{name:"holographic-effects",enabled:!0,qualityLevel:"medium"},{name:"scanline-overlay",enabled:!0,qualityLevel:"low"},{name:"chromatic-aberration",enabled:!0,qualityLevel:"low"},{name:"data-streams",enabled:!0,qualityLevel:"medium"},{name:"interference-patterns",enabled:!0,qualityLevel:"low"},{name:"dynamic-integration",enabled:!0,qualityLevel:"high"}];this.qualityAdjustments={};this.manager=e,this.settingsManager=t||new ee,this.musicSyncService=i||new we,this.oklabProcessor=new M(!0),this.emotionalMapper=new Z(!0),this.genreManager=new He,this.holographicPreset=M.getPreset("COSMIC"),this.holographicState={flickerIntensity:.4,transparency:.8,chromatic:.3,scanlineIntensity:.6,dataStreamFlow:.5,interferenceLevel:.2,energyStability:.7,projectionDistance:.8},this.scanlineEffect={frequency:4,opacity:.1,animation:!0,speed:.5,dynamic:!1},this.chromaticAberration={offsetX:2,offsetY:1,redChannel:.5,greenChannel:0,blueChannel:-.5,intensity:.3},this.dataStream={characters:["0","1","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],speed:.5,density:.3,dynamic:!1,musicSync:!0,musicalSync:!0},this.interferencePattern={frequency:.1,amplitude:.05,phase:0,dynamic:!1,type:"wave"}}async initialize(){if(!this.initialized)try{let e=globalThis.year3000System;this.cssController=e?.cssConsciousnessController||P(),await this.createInterfaceContainer(),await this.initializeHolographicElements(),this.setupOKLABEventSubscriptions(),this.setupUserInteractionTracking(),this.startHolographicAnimation(),this.initialized=!0,this.isInitialized=!0,u?.debug?.log("HolographicUISystem","Initialized holographic interface system with OKLAB integration")}catch(e){throw u?.debug?.error("HolographicUISystem","Failed to initialize:",e),e}}async updateFromMusic(e,t,i){if(!this.isInitialized||!this.isEnabled)return;let a=performance.now();try{this.updateHolographicState(e,t),this.updateHolographicEffects(e,t,i),await this.updateElementAppearances();let r=performance.now()-a;this.updatePerformanceMetrics(r)}catch(r){console.error("[HolographicUISystem] Error updating from music:",r)}}updateHolographicState(e,t){let i=.2+e.intensity*.5+t.strength*.3;this.holographicState.flickerIntensity=this.smoothTransition(this.holographicState.flickerIntensity,i,.1);let a=.6+e.valence*.4;this.holographicState.transparency=this.smoothTransition(this.holographicState.transparency,a,.05);let r=.1+(e.arousal||.5)*.4;this.holographicState.chromatic=this.smoothTransition(this.holographicState.chromatic,r,.08);let n=.3+e.intensity*.5;this.holographicState.scanlineIntensity=this.smoothTransition(this.holographicState.scanlineIntensity,n,.06);let s=this.manager.getConsciousnessState(),o=.3+s.symbioticResonance*.7;this.holographicState.dataStreamFlow=this.smoothTransition(this.holographicState.dataStreamFlow,o,.04);let l=.1+s.surfaceFluidityIndex*.3;this.holographicState.interferenceLevel=this.smoothTransition(this.holographicState.interferenceLevel,l,.03);let m=1-e.intensity*.4;this.holographicState.energyStability=this.smoothTransition(this.holographicState.energyStability,m,.02)}updateHolographicEffects(e,t,i){this.scanlineEffect.frequency=2+this.holographicState.scanlineIntensity*6,this.scanlineEffect.opacity=this.holographicState.scanlineIntensity*.15,this.scanlineEffect.speed=.3+this.holographicState.dataStreamFlow*.7,this.scanlineEffect.dynamic=this.holographicState.energyStability>.7,this.chromaticAberration.intensity=this.holographicState.chromatic,this.chromaticAberration.offsetX=this.holographicState.chromatic*3,this.chromaticAberration.offsetY=this.holographicState.chromatic*2,this.dataStream.speed=.2+this.holographicState.dataStreamFlow*.8,this.dataStream.density=.2+this.holographicState.dataStreamFlow*.6,this.dataStream.dynamic=this.holographicState.energyStability>.6,this.interferencePattern.frequency=.05+this.holographicState.interferenceLevel*.15,this.interferencePattern.amplitude=this.holographicState.interferenceLevel*.1,this.interferencePattern.dynamic=this.holographicState.energyStability>.5,e.type==="ambient"?this.interferencePattern.type="dynamic":e.intensity>.7?this.interferencePattern.type="noise":this.interferencePattern.type="wave"}async updateElementAppearances(){let e=[];for(let[t,i]of this.holographicElements)i.isActive&&e.push(this.updateElementAppearance(i));await Promise.allSettled(e)}async updateElementAppearance(e){let{element:t,holographicType:i,intensity:a,visualEffectsLevel:r,smoothIntegration:n}=e;try{switch(this.applyHolographicBase(t,a),i){case"translucent_panel":this.applyTranslucentPanel(t,a);break;case"data_stream":this.applyDataStream(t,a);break;case"energy_barrier":this.applyEnergyBarrier(t,a);break;case"visual_effects_interface":this.applyVisualEffectsInterface(t,a,r);break;case"dynamic_hologram":this.applyDynamicHologram(t,a,n);break;case"musical_visualization":this.applyMusicalVisualization(t,a);break;case"scanline_overlay":this.applyScanlineOverlay(t,a);break;case"chromatic_ghost":this.applyChromaticGhost(t,a);break}r>.5&&this.applyVisualEffectsModifiers(t,r),n&&this.applyDynamicModifiers(t,a),e.lastUpdate=performance.now()}catch(s){console.warn(`[HolographicUISystem] Failed to update element ${e.id}:`,s)}}applyHolographicBase(e,t){let i=this.holographicState.transparency*t,a=this.holographicState.flickerIntensity*t,r=this.holographicState.chromatic*t;if(e.style.opacity=i.toString(),a>.3){let s=Math.sin(this.animationState.flickerPhase*10)*a*.3;e.style.opacity=Math.max(.1,i+s).toString()}if(r>.2){let s=r*2;e.style.filter=`
        drop-shadow(${s}px 0 0 rgba(255, 0, 0, 0.5))
        drop-shadow(-${s}px 0 0 rgba(0, 255, 255, 0.5))
      `}let n=t*.3;e.style.boxShadow=`
      0 0 ${n*20}px rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${n}),
      inset 0 0 ${n*10}px rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${n*.5})
    `}applyTranslucentPanel(e,t){let i=this.holographicState.transparency*t;e.style.background=`
      rgba(var(--spice-rgb-holographic-primary, var(--sn-holographic-rgb, 100, 255, 200)), ${i*.1}),
      linear-gradient(45deg,
        transparent 0%,
        rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${i*.05}) 50%,
        transparent 100%)
    `,e.style.backdropFilter=`blur(${Math.min(t*2,3)}px)`,e.style.border=`1px solid rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${i*.6})`}applyDataStream(e,t){let i=this.dataStream.speed*t,a=this.dataStream.density*t,r=this.generateDataStreamGradient(i,a);if(e.style.background=r,e.style.backgroundSize="100% 20px",e.style.animation=`dataStream ${2/i}s linear infinite`,!document.getElementById("dataStreamAnimation")){let n=document.createElement("style");n.id="dataStreamAnimation",n.textContent=`
        @keyframes dataStream {
          0% { background-position: 0 0; }
          100% { background-position: 0 20px; }
        }
      `,document.head.appendChild(n)}}applyEnergyBarrier(e,t){let i=this.holographicState.energyStability,a=this.holographicState.interferenceLevel*t,r=(1-i)*t;if(e.style.background=`
      linear-gradient(90deg,
        rgba(var(--sn-neon-glow-rgb, 0, 255, 255), ${r*.3}) 0%,
        rgba(var(--sn-neon-glow-rgb, 0, 255, 255), ${r*.1}) 50%,
        rgba(var(--sn-neon-glow-rgb, 0, 255, 255), ${r*.3}) 100%)
    `,e.style.backgroundSize="200% 100%",e.style.animation=`energyBarrier ${1/r}s ease-in-out infinite`,!document.getElementById("energyBarrierAnimation")){let n=document.createElement("style");n.id="energyBarrierAnimation",n.textContent=`
        @keyframes energyBarrier {
          0% { background-position: 0% 0%; }
          50% { background-position: 100% 0%; }
          100% { background-position: 0% 0%; }
        }
      `,document.head.appendChild(n)}}applyVisualEffectsInterface(e,t,i){let r=this.manager.getConsciousnessState().symbioticResonance*i,n=r*t*.5;e.style.boxShadow=`
      0 0 ${n*30}px rgba(var(--sn-accent-rgb, 203, 166, 247), ${n}),
      inset 0 0 ${n*15}px rgba(var(--sn-accent-rgb, 203, 166, 247), ${n*.3})
    `;let s=.7+r*.3;if(e.style.opacity=s.toString(),r>.6){let o=this.animationState.dynamicPhase*2,l=1+Math.sin(o)*r*.2;e.style.transform=`scale(${l})`}}applyDynamicHologram(e,t,i){if(!i)return;let a=this.animationState.dynamicPhase,r=this.holographicState.energyStability*t,n=Math.sin(a*1.5)*r*2,s=Math.cos(a*2)*r*1.5;e.style.transform=`translate(${n}px, ${s}px)`;let o=a*.5,l=Math.sin(o)*r*30;e.style.filter=`hue-rotate(${l}deg)`;let m=a*.8,d=1+Math.sin(m)*r*.05;e.style.transform+=` scale(${d})`}applyMusicalVisualization(e,t){let a=this.manager.getConsciousnessState().symbioticResonance*t,r=this.animationState.dataStreamPhase*3,n=a*.8,s=Math.sin(r)*n*20;e.style.background=`
      linear-gradient(0deg,
        rgba(var(--sn-primary-rgb, 205, 214, 244), ${n*.8}) 0%,
        rgba(var(--sn-primary-rgb, 205, 214, 244), ${n*.4}) ${50+s}%,
        transparent ${50+s}%)
    `;let o=1+Math.sin(r*2)*a*.1;e.style.transform=`scaleY(${o})`}applyScanlineOverlay(e,t){let i=this.holographicState.scanlineIntensity*t,a=this.scanlineEffect.frequency;if(e.style.background=`
      repeating-linear-gradient(
        0deg,
        transparent 0px,
        transparent ${a-1}px,
        rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${i*.1}) ${a}px,
        rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${i*.1}) ${a}px
      )
    `,this.scanlineEffect.animation&&(e.style.animation=`scanlines ${1/this.scanlineEffect.speed}s linear infinite`),!document.getElementById("scanlineAnimation")){let r=document.createElement("style");r.id="scanlineAnimation",r.textContent=`
        @keyframes scanlines {
          0% { background-position: 0 0; }
          100% { background-position: 0 ${a}px; }
        }
      `,document.head.appendChild(r)}}applyChromaticGhost(e,t){let i=this.holographicState.chromatic*t,a=i*3,r=i*1.5,n=i*2;e.style.filter=`
      drop-shadow(${a}px 0 0 rgba(255, 0, 0, 0.4))
      drop-shadow(-${r}px 0 0 rgba(0, 255, 0, 0.4))
      drop-shadow(0 ${n}px 0 rgba(0, 0, 255, 0.4))
    `;let s=this.animationState.chromaticPhase,o=Math.sin(s*5)*i;e.style.transform=`translate(${o}px, 0)`}applyVisualEffectsModifiers(e,t){let a=this.manager.getConsciousnessState().symbioticResonance*t,r=1+a*.3;e.style.filter=(e.style.filter||"")+` brightness(${r})`;let n=1+a*.5;e.style.filter=(e.style.filter||"")+` saturate(${n})`}applyDynamicModifiers(e,t){let i=this.animationState.dynamicPhase,a=this.holographicState.energyStability*t,r=i*1.2,n=Math.sin(r)*a*2,s=e.style.filter||"";!s.includes("blur(")&&n>0&&(e.style.filter=s+` blur(${Math.max(0,n)}px)`);let l=i*.7,m=1+Math.sin(l)*a*.2,d=parseFloat(e.style.opacity)||1;e.style.opacity=Math.max(.1,Math.min(1,d*m)).toString()}generateDataStreamGradient(e,t){let i=this.dataStream.characters,a=Math.floor(t*20),r="linear-gradient(90deg, ";for(let n=0;n<a;n++){let s=n/a*100,o=i[Math.floor(Math.random()*i.length)],l=.1+Math.random()*.3,m=this.getOKLABEnhancedDataStreamColor(l,this.lastMusicalContext);r+=`${m} ${s}%, `}return r=r.slice(0,-2)+")",r}async createInterfaceContainer(){this.interfaceContainer=document.createElement("div"),this.interfaceContainer.id="holographic-interface-container",this.interfaceContainer.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
      mix-blend-mode: normal;
    `,document.body.appendChild(this.interfaceContainer)}async initializeHolographicElements(){let e=[{selector:".main-view-container",type:"translucent_panel"},{selector:".Root__nav-bar",type:"data_stream"},{selector:".Root__now-playing-bar",type:"visualEffects_interface"},{selector:".main-view-container__scroll-node",type:"dynamic_hologram"},{selector:".root-now-playing-view",type:"energy_barrier"},{selector:".main-view-container__scroll-node-child",type:"scanline_overlay"}];for(let t of e){let i=document.querySelectorAll(t.selector);for(let a of i){let r={id:`holographic-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,element:a,originalStyles:getComputedStyle(a),holographicType:t.type,intensity:.7,isActive:!0,lastUpdate:0,animation:null,visualEffectsLevel:.8,smoothIntegration:!0};this.holographicElements.set(r.id,r)}}}updateHolographicAnimation(e){if(!this.isInitialized||!this.isEnabled)return;let t=e/1e3;this.animationState.flickerPhase+=t*2,this.animationState.scanlinePhase+=t*this.scanlineEffect.speed,this.animationState.chromaticPhase+=t*1.5,this.animationState.dataStreamPhase+=t*this.dataStream.speed,this.animationState.interferencePhase+=t*this.interferencePattern.frequency,this.animationState.dynamicPhase+=t*.5,this.performanceMetrics.lastUpdate=performance.now()}startHolographicAnimation(){this.animationState.isAnimating=!0,this.animationState.lastFrameTime=performance.now();let e=t=>{if(!this.animationState.isAnimating)return;let i=t-this.animationState.lastFrameTime;this.animationState.lastFrameTime=t,this.updateHolographicAnimation(i),requestAnimationFrame(e)};requestAnimationFrame(e)}smoothTransition(e,t,i){return e+(t-e)*i}updatePerformanceMetrics(e){this.performanceMetrics.averageProcessingTime=this.performanceMetrics.averageProcessingTime*.9+e*.1,this.performanceMetrics.elementsProcessed=this.holographicElements.size,this.performanceMetrics.memoryUsage=this.holographicElements.size*256}getHolographicState(){return{...this.holographicState}}getPerformanceMetrics(){return{...this.performanceMetrics}}getElementCount(){return this.holographicElements.size}setEnabled(e){if(this.isEnabled=e,!e)for(let[t,i]of this.holographicElements)i.element.style.opacity="1",i.element.style.filter="",i.element.style.background="",i.element.style.boxShadow="",i.element.style.transform=""}setHolographicPreset(e){let t=this.holographicPresets[e];t&&(this.holographicState={...t})}setFlickerIntensity(e){this.holographicState.flickerIntensity=Math.max(0,Math.min(1,e))}enableVolumetricDepth(e=.8){let t=800+e*1200;this.interfaceContainer&&(this.interfaceContainer.style.perspective=`${t}px`,this.interfaceContainer.style.transformStyle="preserve-3d");for(let[i,a]of this.holographicElements)this.applyVolumetricLayers(a.element,e,a.intensity);console.log(`[HolographicUISystem] \u{1F30A} Volumetric depth enabled: ${t}px perspective`)}updateVolumetricLayers(e,t){let i=e*.8,a=(t-4e3)/4e3;for(let[r,n]of this.holographicElements)this.applyVolumetricLayers(n.element,i,n.intensity,a)}applyVolumetricLayers(e,t,i,a=.5){let r=t*100,n=a*50,s=r+n,o=e.style.transform||"",l=`translateZ(${s}px)`;o.includes("translateZ")?e.style.transform=o.replace(/translateZ\([^)]*\)/,l):e.style.transform=`${o} ${l}`.trim();let m=Math.abs(s)/100*i,d=m*30,h=s>0?m*5:-m*3,g=e.style.boxShadow||"",f=`0 ${h}px ${d}px rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${m*.3})`;g?e.style.boxShadow=`${g}, ${f}`:e.style.boxShadow=f,this.applyVolumetricAtmosphere(e,t,i)}applyVolumetricAtmosphere(e,t,i){let a=t*i,r=Math.max(0,(t-.5)*4),n=1+(t-.5)*.3,s=e.style.filter||"",o=s.includes("blur("),l=[r>0&&!o?`blur(${r}px)`:"",`brightness(${n})`,`saturate(${1+a*.2})`].filter(f=>f).join(" "),m=s.includes("brightness"),d=s.includes("saturate");s&&!m&&!d?e.style.filter=`${s} ${l}`:s||(e.style.filter=l);let h=parseFloat(e.style.opacity||"1"),g=Math.max(.3,h-(1-t)*.3);e.style.opacity=g.toString()}updateConsciousnessScanlines(e,t,i){let a=Math.max(.2,e*1.5),r=this.mapTemperatureToFrequency(t),n=Math.sin(performance.now()*.005*i)*.3+.7,s={"--visualEffects-scanline-density":a.toString(),"--visualEffects-scanline-frequency":`${r}px`,"--visualEffects-scanline-opacity":(e*.15).toString(),"--musical-scanline-pulse":n.toString(),"--temperature-scanline-color-shift":`${(t-5e3)/3e3*30}deg`};this.cssController.batchSetVariables("HolographicUISystem",s,"high","visualEffects-scanline-update")}updateAberrationEffects(e,t,i,a=!1){let r=document.documentElement,n=Math.min(1,e*1.2),s=Math.min(1,i*1.5),o=2+s*3,m=(Math.max(3e3,Math.min(8e3,t))-5500)/2500,d=1.5+m*2,h=-1.5-m*2,g=m*.5,f=Math.sin(performance.now()*.003*i)*.4+.6,S=a?1.5:1,C=1e3+e*2e3+i*1e3,T={"--aberration-intensity":(n*S).toString(),"--aberration-color-separation":`${o}px`,"--aberration-musical-sync":s.toString(),"--aberration-emotional-temperature":`${t}K`,"--aberration-visualEffects-level":e.toString(),"--aberration-red-shift":`${d}px`,"--aberration-green-shift":`${g}px`,"--aberration-blue-shift":`${h}px`,"--aberration-wave-frequency":`${C}ms`,"--aberration-pulse-intensity":(f*S).toString()};this.cssController.batchSetVariables("HolographicUISystem",T,"high","aberration-effects-update");let w=parseFloat(r.style.getPropertyValue("--reading-mode-active")||"0"),R=Math.min(.8,w*.6);this.cssController.setVariable("HolographicUISystem","--aberration-reading-mode-reduction",R.toString(),"critical","aberration-reading-mode-update")}mapTemperatureToFrequency(e){return 2+(Math.max(3e3,Math.min(8e3,e))-3e3)/5e3*10}updateScanlineCSSVariables(e,t,i){let a={"--visualEffects-scanline-density":e.toString(),"--visualEffects-scanline-frequency":`${this.scanlineEffect.frequency}px`,"--visualEffects-scanline-opacity":this.scanlineEffect.opacity.toString(),"--visualEffects-scanline-speed":`${this.scanlineEffect.speed}s`,"--temperature-scanline-color-shift":`${(t-5e3)/2e3*30}deg`,"--musical-scanline-pulse":i.toString()};this.cssController.batchSetVariables("HolographicUISystem",a,"high","scanline-visualEffects-update");let r={"--visualEffects-scanline-interference":e>.7?"visible":"none","--visualEffects-scanline-complexity":e>.7?Math.min(1,(e-.7)*3.33).toString():"0"};this.cssController.batchSetVariables("HolographicUISystem",r,"high","scanline-complexity-update")}detectReadingMode(){let e=document.documentElement,t=(window.getSelection()?.toString()||"").length>0,i=this.isUserCurrentlyScrolling(),a=this.isHoveringTextContent(),r=0;t&&(r+=.6),i&&(r+=.3),a&&(r+=.4),r=Math.min(1,r),this.cssController.setVariable("HolographicUISystem","--reading-mode-active",r.toString(),"critical","reading-mode-detection-update")}trackUserInteraction(){let e=document.documentElement,t=this.isMouseCurrentlyMoving(),i=this.wasRecentUIClick(),a=this.isFocusedOnInputElement(),r=0;t&&(r+=.4),i&&(r+=.5),a&&(r+=.6),r=Math.min(1,r),this.cssController.setVariable("HolographicUISystem","--user-interaction-detected",r.toString(),"high","user-interaction-update")}isUserCurrentlyScrolling(){let e=document.querySelector(".main-view-container__scroll-node");if(!e)return!1;let t=e.scrollTop,i=this.lastScrollPosition||0;return this.lastScrollPosition=t,Math.abs(t-i)>5}isHoveringTextContent(){let e=document.querySelector(":hover");return e?(e.textContent?.trim()||"").length>20:!1}isMouseCurrentlyMoving(){let e=performance.now(),t=this.lastMouseMovement||0;return e-t<2e3}wasRecentUIClick(){let e=performance.now(),t=this.lastUIClick||0;return e-t<1e3}isFocusedOnInputElement(){let e=document.activeElement;return e?["input","textarea","select"].includes(e.tagName.toLowerCase())||e.getAttribute("contenteditable")==="true":!1}setTransparency(e){this.holographicState.transparency=Math.max(0,Math.min(1,e))}setChromaticAberration(e){this.holographicState.chromatic=Math.max(0,Math.min(1,e))}destroy(){console.log("[HolographicUISystem] Destroying holographic UI system..."),this.animationState.isAnimating=!1;for(let[t,i]of this.holographicElements)i.element.style.opacity="1",i.element.style.filter="",i.element.style.background="",i.element.style.boxShadow="",i.element.style.transform="",i.animation&&i.animation.cancel();this.holographicElements.clear(),this.interfaceContainer&&this.interfaceContainer.parentNode&&this.interfaceContainer.parentNode.removeChild(this.interfaceContainer),["dataStreamAnimation","energyBarrierAnimation","scanlineAnimation"].forEach(t=>{let i=document.getElementById(t);i&&i.remove()}),this.isInitialized=!1,this.initialized=!1,this.eventSubscriptionIds.forEach(t=>{p.unsubscribe(t)}),this.eventSubscriptionIds=[]}setQualityLevel(e){switch(this.currentQualityLevel=e,e){case"low":this.holographicState.flickerIntensity=.1,this.holographicState.transparency=.9,this.holographicState.chromatic=.1,this.holographicState.scanlineIntensity=.2,this.holographicState.dataStreamFlow=.2,this.holographicState.interferenceLevel=0,this.scanlineEffect.animation=!1;break;case"low":this.holographicState.flickerIntensity=.2,this.holographicState.transparency=.85,this.holographicState.chromatic=.2,this.holographicState.scanlineIntensity=.3,this.holographicState.dataStreamFlow=.3,this.holographicState.interferenceLevel=.1,this.scanlineEffect.animation=!0,this.scanlineEffect.speed=.3;break;case"medium":this.holographicState.flickerIntensity=.4,this.holographicState.transparency=.8,this.holographicState.chromatic=.3,this.holographicState.scanlineIntensity=.6,this.holographicState.dataStreamFlow=.5,this.holographicState.interferenceLevel=.2,this.scanlineEffect.animation=!0,this.scanlineEffect.speed=.5;break;case"high":this.holographicState.flickerIntensity=.6,this.holographicState.transparency=.7,this.holographicState.chromatic=.5,this.holographicState.scanlineIntensity=.8,this.holographicState.dataStreamFlow=.8,this.holographicState.interferenceLevel=.4,this.scanlineEffect.animation=!0,this.scanlineEffect.speed=.8;break;case"high":this.holographicState.flickerIntensity=.8,this.holographicState.transparency=.6,this.holographicState.chromatic=.7,this.holographicState.scanlineIntensity=1,this.holographicState.dataStreamFlow=1,this.holographicState.interferenceLevel=.6,this.scanlineEffect.animation=!0,this.scanlineEffect.speed=1;break}this.updateQualityCapabilities(e)}getPerformanceImpact(){let e=this.holographicElements.size;return{fps:60,frameTime:this.calculateProcessingTime(),memoryUsage:this.estimateMemoryUsage(),cpuUsage:this.estimateCPUUsage(e)}}reduceQuality(e){this.qualityAdjustments["flicker-reduction"]=(this.qualityAdjustments["flicker-reduction"]||0)+e,this.qualityAdjustments["effect-reduction"]=(this.qualityAdjustments["effect-reduction"]||0)+e*.8,this.holographicState.flickerIntensity=Math.max(.1,this.holographicState.flickerIntensity*(1-e*.8)),this.holographicState.chromatic=Math.max(0,this.holographicState.chromatic*(1-e)),this.holographicState.scanlineIntensity=Math.max(.1,this.holographicState.scanlineIntensity*(1-e*.6)),this.holographicState.dataStreamFlow=Math.max(.1,this.holographicState.dataStreamFlow*(1-e*.4)),this.holographicState.interferenceLevel=Math.max(0,this.holographicState.interferenceLevel*(1-e)),e>.5&&(this.scanlineEffect.animation=!1)}increaseQuality(e){if(Object.keys(this.qualityAdjustments).forEach(t=>{this.qualityAdjustments[t]=Math.max(0,(this.qualityAdjustments[t]||0)-e)}),this.currentQualityLevel){let t=this.getPresetForLevel(this.currentQualityLevel);this.holographicState.flickerIntensity=Math.min(t.flickerIntensity,this.holographicState.flickerIntensity*(1+e*.3)),this.holographicState.chromatic=Math.min(t.chromatic,this.holographicState.chromatic*(1+e*.4)),this.holographicState.scanlineIntensity=Math.min(t.scanlineIntensity,this.holographicState.scanlineIntensity*(1+e*.2)),this.holographicState.dataStreamFlow=Math.min(t.dataStreamFlow,this.holographicState.dataStreamFlow*(1+e*.2)),e>.3&&(this.scanlineEffect.animation=!0)}}getQualityCapabilities(){return[...this.qualityCapabilities]}updateQualityCapabilities(e){this.qualityCapabilities.forEach(t=>{switch(t.name){case"holographic-effects":t.enabled=this.holographicState.flickerIntensity>.2;break;case"scanline-overlay":t.enabled=this.holographicState.scanlineIntensity>.3;break;case"chromatic-aberration":t.enabled=this.holographicState.chromatic>.2;break;case"data-streams":t.enabled=this.holographicState.dataStreamFlow>.3;break;case"interference-patterns":t.enabled=this.holographicState.interferenceLevel>.1;break;case"dynamic-integration":t.enabled=e!=="low";break}})}getPresetForLevel(e){switch(e){case"low":return this.holographicPresets["dynamic-visualEffects"];case"medium":return this.holographicPresets["star-wars"];case"high":return this.holographicPresets["blade-runner"];default:return this.holographicPresets["star-wars"]}}calculateProcessingTime(){let e=this.holographicElements.size,t=(this.holographicState.flickerIntensity+this.holographicState.chromatic+this.holographicState.scanlineIntensity)/3;return Math.max(2,e*t*.5)}estimateMemoryUsage(){return .3*this.holographicElements.size+0}estimateCPUUsage(e){let i=(this.holographicState.flickerIntensity+this.holographicState.chromatic+this.holographicState.scanlineIntensity)/3,a=this.scanlineEffect.animation?1.5:1;return Math.min(30,2*e*i*a)}hexToRgb(e){try{let t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t&&t[1]&&t[2]&&t[3]?`${parseInt(t[1],16)}, ${parseInt(t[2],16)}, ${parseInt(t[3],16)}`:"100, 255, 200"}catch(t){return u?.debug?.warn("HolographicUISystem","Failed to convert hex to RGB:",t),"100, 255, 200"}}setupOKLABEventSubscriptions(){try{let e=p.subscribe("colors:oklab-enhanced",this.handleOKLABColorEvent.bind(this),"HolographicUISystem");this.eventSubscriptionIds.push(e);let t=p.subscribe("colors:musical-oklab-coordinated",this.handleMusicalOKLABEvent.bind(this),"HolographicUISystem");this.eventSubscriptionIds.push(t);let i=p.subscribe("colors:emotional-temperature-mapped",this.handleEmotionalTemperatureEvent.bind(this),"HolographicUISystem");this.eventSubscriptionIds.push(i);let a=p.subscribe("audio:genre-detected",this.handleGenreDetectionEvent.bind(this),"HolographicUISystem");this.eventSubscriptionIds.push(a),u?.debug?.log("HolographicUISystem","OKLAB event subscriptions established",{subscriptionCount:this.eventSubscriptionIds.length})}catch(e){u?.debug?.error("HolographicUISystem","Failed to setup OKLAB event subscriptions:",e)}}setupUserInteractionTracking(){try{document.addEventListener("mousemove",()=>{this.lastMouseMovement=performance.now()},{passive:!0}),document.addEventListener("click",()=>{this.lastUIClick=performance.now()},{passive:!0}),setInterval(()=>{this.detectReadingMode(),this.trackUserInteraction()},500),u?.debug?.log("HolographicUISystem","User interaction tracking initialized")}catch(e){u?.debug?.error("HolographicUISystem","Failed to setup user interaction tracking:",e)}}async handleOKLABColorEvent(e){try{let{enhancedColors:t,oklabPreset:i,rawColors:a,trackUri:r}=e;i&&(this.holographicPreset=i),t&&await this.updateHolographicColorsFromOKLAB(t),u?.debug?.log("HolographicUISystem","Updated holographic colors from OKLAB event",{preset:i?.name,trackUri:r,colorCount:Object.keys(t||{}).length})}catch(t){u?.debug?.error("HolographicUISystem","Failed to handle OKLAB color event:",t)}}async handleMusicalOKLABEvent(e){try{let{coordinatedColors:t,detectedGenre:i,emotionalResult:a,oklabPreset:r,musicInfluenceStrength:n,coordinationStrategy:s}=e;if(this.lastMusicalContext={genre:i,emotion:a?.primaryEmotion,preset:r,influence:n,strategy:s,timestamp:Date.now()},r&&(this.holographicPreset=r),t&&await this.updateHolographicColorsFromMusicalOKLAB(t,this.lastMusicalContext),a&&n!==void 0){let o=this.holographicState.flickerIntensity||.5,l=a.emotionalTemperature||6e3,m=n,d=a.beatDetected||!1;this.updateAberrationEffects(o,l,m,d)}u?.debug?.log("HolographicUISystem","Updated holographic effects from musical OKLAB coordination",{genre:i,emotion:a?.primaryEmotion,preset:r?.name,influence:n})}catch(t){u?.debug?.error("HolographicUISystem","Failed to handle musical OKLAB event:",t)}}async handleEmotionalTemperatureEvent(e){try{let{emotionalTemperature:t,primaryEmotion:i,perceptualColorHex:a,oklabPreset:r,cssVariables:n}=e;await this.updateHolographicEmotionalTemperature(t,i),a&&await this.updateHolographicColorFromEmotionalOKLAB(a,t);let s=this.holographicState.flickerIntensity||.5,o=this.lastMusicalContext?.influence||.5;this.updateAberrationEffects(s,t,o,!1),u?.debug?.log("HolographicUISystem","Updated holographic emotional temperature",{temperature:t,emotion:i,color:a})}catch(t){u?.debug?.error("HolographicUISystem","Failed to handle emotional temperature event:",t)}}async handleGenreDetectionEvent(e){try{let{detectedGenre:t,confidence:i,audioFeatures:a}=e,r=this.genreManager.getOKLABPresetForGenre(t);r&&(this.holographicPreset=r,await this.adjustHolographicEffectsForGenre(t,a)),u?.debug?.log("HolographicUISystem","Adjusted holographic effects for detected genre",{genre:t,confidence:i,preset:r?.name})}catch(t){u?.debug?.error("HolographicUISystem","Failed to handle genre detection event:",t)}}async updateHolographicColorsFromOKLAB(e){try{let t={};if(Object.entries(e).forEach(([i,a])=>{if(a&&typeof a=="string"){let r=this.oklabProcessor.processColor(a,this.holographicPreset);if(r.enhancedHex&&(t[`--holographic-${i.toLowerCase()}`]=r.enhancedHex,t[`--holographic-${i.toLowerCase()}-rgb`]=this.hexToRgb(r.enhancedHex),r.oklabEnhanced)){let{L:n,a:s,b:o}=r.oklabEnhanced;t[`--holographic-${i.toLowerCase()}-oklab`]=`${n.toFixed(3)} ${s.toFixed(3)} ${o.toFixed(3)}`}}}),e.VIBRANT||e.PRIMARY){let i=e.VIBRANT||e.PRIMARY;if(i){let a=this.oklabProcessor.processColor(i,this.holographicPreset);a.enhancedHex&&(t["--sn-holographic-rgb"]=this.hexToRgb(a.enhancedHex),t["--sn-holographic-primary"]=a.enhancedHex)}}Object.keys(t).length>0&&this.cssController.batchSetVariables("HolographicUISystem",t,"critical","oklab-holographic-colors-update")}catch(t){u?.debug?.error("HolographicUISystem","Failed to update holographic colors from OKLAB:",t)}}async updateHolographicColorsFromMusicalOKLAB(e,t){try{await this.updateHolographicColorsFromOKLAB(e),t.influence&&this.adjustHolographicIntensityFromMusicalInfluence(t.influence),t.genre&&await this.applyGenreSpecificHolographicEffects(t.genre,t.emotion)}catch(i){u?.debug?.error("HolographicUISystem","Failed to update holographic colors from musical OKLAB:",i)}}async updateHolographicColorFromEmotionalOKLAB(e,t){try{let i=document.documentElement,a=this.oklabProcessor.processColor(e,this.holographicPreset);if(a.enhancedHex){let r={"--holographic-emotional-primary":a.enhancedHex,"--holographic-emotional-rgb":this.hexToRgb(a.enhancedHex),"--holographic-emotional-temperature":`${t}K`};this.cssController.batchSetVariables("HolographicUISystem",r,"critical","emotional-oklab-holographic-update"),await this.updateHolographicEmotionalTemperature(t,null)}}catch(i){u?.debug?.error("HolographicUISystem","Failed to update holographic color from emotional OKLAB:",i)}}async updateHolographicEmotionalTemperature(e,t){try{let a=(Math.max(3e3,Math.min(8e3,e))-3e3)/5e3;this.holographicState.flickerIntensity=.2+a*.4,this.holographicState.chromatic=.1+a*.3,this.holographicState.energyStability=1-a*.3,a<.4?(this.holographicState.transparency=.9+a*.1,this.holographicState.dataStreamFlow=.3+a*.2):(this.holographicState.transparency=.8-(a-.4)*.2,this.holographicState.interferenceLevel=.1+(a-.4)*.3),u?.debug?.log("HolographicUISystem","Updated holographic effects from emotional temperature",{temperature:e,tempRatio:a,flicker:this.holographicState.flickerIntensity,chromatic:this.holographicState.chromatic})}catch(i){u?.debug?.error("HolographicUISystem","Failed to update holographic emotional temperature:",i)}}async adjustHolographicEffectsForGenre(e,t){try{switch(e.toLowerCase()){case"electronic":case"techno":case"edm":this.holographicState.dataStreamFlow=.8,this.holographicState.scanlineIntensity=.7,this.holographicState.interferenceLevel=.4,this.scanlineEffect.speed=.8;break;case"classical":case"orchestral":this.holographicState.transparency=.9,this.holographicState.energyStability=.8,this.holographicState.flickerIntensity=.2,this.scanlineEffect.dynamic=!0;break;case"rock":case"metal":this.holographicState.flickerIntensity=.6,this.holographicState.chromatic=.5,this.holographicState.interferenceLevel=.5,this.scanlineEffect.animation=!0;break;case"ambient":case"atmospheric":this.holographicState.transparency=.95,this.holographicState.dataStreamFlow=.3,this.holographicState.energyStability=.9,this.scanlineEffect.dynamic=!0,this.scanlineEffect.speed=.2;break;case"jazz":case"blues":this.holographicState.flickerIntensity=.4,this.holographicState.energyStability=.6,this.interferencePattern.type="dynamic",this.scanlineEffect.dynamic=!0;break;default:this.holographicState.flickerIntensity=.4,this.holographicState.transparency=.8,this.holographicState.chromatic=.3;break}u?.debug?.log("HolographicUISystem","Adjusted holographic effects for genre",{genre:e,flicker:this.holographicState.flickerIntensity,transparency:this.holographicState.transparency,dataFlow:this.holographicState.dataStreamFlow})}catch(i){u?.debug?.error("HolographicUISystem","Failed to adjust holographic effects for genre:",i)}}adjustHolographicIntensityFromMusicalInfluence(e){try{let t=.5+e*.5;this.holographicState.flickerIntensity*=t,this.holographicState.chromatic*=t,this.holographicState.scanlineIntensity*=t,this.holographicState.dataStreamFlow*=t,this.holographicState.interferenceLevel*=t,u?.debug?.log("HolographicUISystem","Adjusted holographic intensity from musical influence",{influence:e,multiplier:t})}catch(t){u?.debug?.error("HolographicUISystem","Failed to adjust holographic intensity from musical influence:",t)}}async applyGenreSpecificHolographicEffects(e,t){try{let i=`${e.toLowerCase()}-${t||"neutral"}`;e==="electronic"&&t==="energetic"?(this.setHolographicPreset("blade-runner"),this.holographicState.dataStreamFlow=1,this.holographicState.interferenceLevel=.6):e==="classical"&&t==="calm"?(this.setHolographicPreset("dynamic-visualEffects"),this.holographicState.transparency=.95,this.holographicState.energyStability=.9):e==="rock"&&t==="aggressive"&&(this.setHolographicPreset("star-wars"),this.holographicState.flickerIntensity=.8,this.holographicState.chromatic=.6),u?.debug?.log("HolographicUISystem","Applied genre-specific holographic effects",{genre:e,emotion:t,effectKey:i})}catch(i){u?.debug?.error("HolographicUISystem","Failed to apply genre-specific holographic effects:",i)}}updateAnimation(e){this.updateHolographicAnimation(e)}async healthCheck(){try{let e=this.estimateMemoryUsage(),t=this.estimateCPUUsage(this.holographicElements.size),i=this.holographicElements.size,a=this.initialized&&e<10&&t<25&&i<100;return{healthy:a,message:a?"Holographic UI system operating normally":"Holographic UI system performance degraded",details:{initialized:this.initialized,activeElements:i,memoryUsageMB:e,cpuUsagePercent:t,oklabIntegration:this.eventSubscriptionIds.length>0,lastUpdate:this.performanceMetrics.lastUpdate}}}catch(e){return{healthy:!1,message:`Holographic UI system health check failed: ${e}`,details:{error:e instanceof Error?e.message:String(e)}}}}getOKLABEnhancedGlowColor(e){try{let t=getComputedStyle(document.documentElement).getPropertyValue("--sn-holographic-primary")?.trim()||"#64ffcc",i=this.oklabProcessor.processColor(t,this.holographicPreset);return i.enhancedHex?`rgba(${this.hexToRgb(i.enhancedHex)}, ${e})`:`rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${e})`}catch(t){return u?.debug?.warn("HolographicUISystem","Failed to get OKLAB enhanced glow color:",t),`rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${e})`}}getOKLABEnhancedPanelColor(e){try{let t=getComputedStyle(document.documentElement).getPropertyValue("--sn-holographic-primary")?.trim()||"#64ffcc",i=this.oklabProcessor.processColor(t,this.holographicPreset);if(i.enhancedHex){let a=this.hexToRgb(i.enhancedHex);return{background:`rgba(${a}, ${e*.1})`,gradient:`rgba(${a}, ${e*.05})`,border:`rgba(${a}, ${e*.6})`}}return{background:`rgba(var(--spice-rgb-holographic-primary, var(--sn-holographic-rgb, 100, 255, 200)), ${e*.1})`,gradient:`rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${e*.05})`,border:`rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${e*.6})`}}catch(t){return u?.debug?.warn("HolographicUISystem","Failed to get OKLAB enhanced panel color:",t),{background:`rgba(var(--spice-rgb-holographic-primary, var(--sn-holographic-rgb, 100, 255, 200)), ${e*.1})`,gradient:`rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${e*.05})`,border:`rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${e*.6})`}}}getOKLABConsciousnessGlow(e,t){try{let i=getComputedStyle(document.documentElement).getPropertyValue("--sn-accent-hex")?.trim()||"#cba6f7",a={...this.holographicPreset,chromaBoost:this.holographicPreset.chromaBoost*(1+t*.5),lightnessBoost:this.holographicPreset.lightnessBoost*(1+t*.3)},r=this.oklabProcessor.processColor(i,a);if(r.enhancedHex){let n=this.hexToRgb(r.enhancedHex);return{outer:`rgba(${n}, ${e})`,inner:`rgba(${n}, ${e*.3})`}}return{outer:`rgba(var(--sn-accent-rgb, 203, 166, 247), ${e})`,inner:`rgba(var(--sn-accent-rgb, 203, 166, 247), ${e*.3})`}}catch(i){return u?.debug?.warn("HolographicUISystem","Failed to get OKLAB visualEffects glow:",i),{outer:`rgba(var(--sn-accent-rgb, 203, 166, 247), ${e})`,inner:`rgba(var(--sn-accent-rgb, 203, 166, 247), ${e*.3})`}}}getOKLABEnhancedDataStreamColor(e,t){try{let i="#64ffcc";if(t?.emotion){let r=this.emotionalMapper.mapMusicToEmotionalTemperature({energy:.5,valence:.5,tempo:120,genre:t.genre||"default"});r.perceptualColorHex&&(i=r.perceptualColorHex)}let a=this.oklabProcessor.processColor(i,this.holographicPreset);return a.enhancedHex?`rgba(${this.hexToRgb(a.enhancedHex)}, ${e})`:`rgba(var(--spice-rgb-holographic-primary, var(--sn-holographic-rgb, 100, 255, 200)), ${e})`}catch(i){return u?.debug?.warn("HolographicUISystem","Failed to get OKLAB enhanced data stream color:",i),`rgba(var(--spice-rgb-holographic-primary, var(--sn-holographic-rgb, 100, 255, 200)), ${e})`}}adjustQuality(e){switch(e){case"low":this.holographicState.energyStability=.3,this.holographicState.scanlineIntensity=.2,this.holographicState.interferenceLevel=.1;break;case"medium":this.holographicState.energyStability=.6,this.holographicState.scanlineIntensity=.5,this.holographicState.interferenceLevel=.3;break;case"high":default:this.holographicState.energyStability=1,this.holographicState.scanlineIntensity=.8,this.holographicState.interferenceLevel=.6;break}}}});var Ni,Gs=y(()=>{"use strict";L();de();$();Ni=class extends j{constructor(t,i,a,r,n,s=null){super(t,i,a,r,n);this._scrollContainerElements=[];this._interactionHandler=null;this.year3000System=s,this.nexusState={currentNavigationScale:1,targetNavigationScale:1,userInfluence:0,lastEnergy:.5,lastValence:.5,lastVisualIntensity:.5,lastMoodIdentifier:"neutral"},this.biometricState={isMeditating:!1,lastUserInteractionTime:Date.now(),meditationGracePeriod:5e3,interactionCooldown:1e3,lastMeditationUpdateTime:null,desaturation:0,slowdown:1,targetDesaturation:0,targetSlowdown:1},this.lastHeavyUpdateTime=0,this.heavyUpdateInterval=1e3/10,this.lastBiometricCheckTime=0,this.biometricCheckInterval=1e3,this.lastInteractionRecordTime=0,this.interactionRecordInterval=200,this._animationRegistered=!1,this._performanceMode="auto",this._frameSkipCounter=0,this._maxFrameSkip=2,this.systemIntegrationMetrics={lastSystemsCheck:Date.now(),integrationHealth:"healthy",crossSystemErrors:0,meditationTransitions:0,navigationScaleUpdates:0};let o=this.utils.getHealthMonitor();o&&o.registerSystem("InteractionTrackingSystem",this),this.rootElement=this.utils.getRootStyle(),this.modalObserver=null,this._lastScrollTime=null,this._lastScrollTop=null}onAnimate(t){this.initialized&&this.updateAnimation(t)}async initialize(){await super.initialize();let t=globalThis.year3000System;this.cssController=t?.cssConsciousnessController||P(),this.initializeOptimizedQuantumSpace(),this.setupModalObserver(),this.setupOptimizedInteractionListener(),this._registerWithAnimationCoordinator()}_registerWithAnimationCoordinator(){this.year3000System&&this.year3000System.registerAnimationSystem?(this.year3000System.registerAnimationSystem("InteractionTrackingSystem",this,"normal",30),this._animationRegistered=!0):this._startFallbackAnimationLoops()}initializeOptimizedQuantumSpace(){if(!this.utils.getRootStyle())return;let i={"--sn-nav-item-transform-scale":"1.0","--sn-sidebar-meditation-desaturation":"0","--sn-sidebar-meditation-slowdown":"1"};this.cssController.batchSetVariables("InteractionTrackingSystem",i,"high","quantum-space-initialization")}recordUserInteraction(t){if(t.type==="scroll"){let r=t.target;if(r){let n=r.scrollTop,s=performance.now(),o=this._lastScrollTime?(n-(this._lastScrollTop??0))/(s-this._lastScrollTime):0,l=o<0?"up":"down";p.emit("user:scroll",{velocity:{x:0,y:o*1e3},direction:l,element:r.tagName||"unknown",timestamp:s}),this._lastScrollTop=n,this._lastScrollTime=s}}let a=performance.now();a-this.lastInteractionRecordTime<this.interactionRecordInterval||(this.lastInteractionRecordTime=a,this.nexusState.userInfluence+=.005,this.nexusState.userInfluence=Math.min(.5,this.nexusState.userInfluence),this.biometricState.lastUserInteractionTime=Date.now(),this.biometricState.isMeditating=!1)}setupModalObserver(){let t=document.querySelector(".main-modal-container");if(!t)return;let i=(a,r)=>{for(let n of a)if(n.type==="childList"){let s=t.children.length>0;this.nexusState.targetNavigationScale=s?.95:1}};this.modalObserver=new MutationObserver(i),this.modalObserver.observe(t,{childList:!0})}setupOptimizedInteractionListener(){this._interactionHandler=this.utils.throttle(n=>this.recordUserInteraction(n),100),["click","mousemove","keydown"].forEach(n=>{document.addEventListener(n,this._interactionHandler,{passive:!0})});let i=[".main-view-container__scroll-node",".main-view-container__scroll-node-child","section[data-testid='playlist-page']"],a=[];i.forEach(n=>{document.querySelectorAll(n).forEach(s=>{a.push(s)})}),(a.length?a:[document]).forEach(n=>{n.addEventListener("scroll",this._interactionHandler,{passive:!0})}),this._scrollContainerElements=a}updateFromMusicAnalysis(t,i,a){if(!this.initialized||!this.validateMusicData(t)){this.applySafeDefaults();return}this.updateNexusTargets(t)}updateNexusTargets(t){let{energy:i,valence:a,visualIntensity:r,moodIdentifier:n}=t;this.nexusState.lastEnergy=i,this.nexusState.lastValence=a,this.nexusState.lastVisualIntensity=r,this.nexusState.lastMoodIdentifier=n,this.nexusState.targetNavigationScale=this.calculateOptimizedNavigationScale(r,n)}updateDigitalMeditationState(t){let i=Date.now();if(i-this.lastBiometricCheckTime<this.biometricCheckInterval)return;this.lastBiometricCheckTime=i,i-this.biometricState.lastUserInteractionTime>this.biometricState.meditationGracePeriod&&t.energy<.3&&t.valence>.6?(this.biometricState.isMeditating=!0,this.biometricState.targetDesaturation=.6,this.biometricState.targetSlowdown=.5):(this.biometricState.isMeditating=!1,this.biometricState.targetDesaturation=0,this.biometricState.targetSlowdown=1)}updateAnimation(t){if(!this.initialized)return;let i=performance.now();if(this._frameSkipCounter++,!(this._frameSkipCounter<this._maxFrameSkip)&&(this._frameSkipCounter=0,this.animateOptimizedNexusFrame(t),i-this.lastHeavyUpdateTime>this.heavyUpdateInterval)){let a=this.musicSyncService?.getLatestProcessedData();a&&this.updateDigitalMeditationState(a),this.updateIntegrationMetrics(),this.lastHeavyUpdateTime=i}}onPerformanceModeChange(t){this._performanceMode=t,t==="performance"?(this.heavyUpdateInterval=1e3/5,this._maxFrameSkip=3,this.interactionRecordInterval=500):(this.heavyUpdateInterval=1e3/10,this._maxFrameSkip=2,this.interactionRecordInterval=200)}_startFallbackAnimationLoops(){let t=()=>{this.updateAnimation(16.67),requestAnimationFrame(t)};requestAnimationFrame(t)}animateOptimizedNexusFrame(t){let i=Math.min((t??16.67)/1e3*5,1);this.nexusState.currentNavigationScale=this.utils.lerp(this.nexusState.currentNavigationScale,this.nexusState.targetNavigationScale,i),this.biometricState.desaturation=this.utils.lerp(this.biometricState.desaturation,this.biometricState.targetDesaturation,i),this.biometricState.slowdown=this.utils.lerp(this.biometricState.slowdown,this.biometricState.targetSlowdown,i),this.applyOptimizedStateToCSS()}applyOptimizedStateToCSS(){let t={"--sn-nav-item-transform-scale":this.nexusState.currentNavigationScale.toFixed(3),"--sn-sidebar-meditation-desaturation":this.biometricState.desaturation.toFixed(3),"--sn-sidebar-meditation-slowdown":this.biometricState.slowdown.toFixed(3)};this.cssController.batchSetVariables("InteractionTrackingSystem",t,"high","interaction-state-update")}validateMusicData(t){return t&&typeof t.energy=="number"&&typeof t.valence=="number"&&typeof t.visualIntensity=="number"}applySafeDefaults(){let t={"--sn-nav-item-transform-scale":"1.0","--sn-sidebar-meditation-desaturation":"0","--sn-sidebar-meditation-slowdown":"1"};this.cssController.batchSetVariables("InteractionTrackingSystem",t,"critical","safe-defaults-fallback")}updateIntegrationMetrics(){}calculateIntegrationComplexity(){let t=0;return t+=this.nexusState.userInfluence*10,t+=this.nexusState.lastVisualIntensity*5,this.biometricState.isMeditating&&(t+=5),t}performCleanup(){this.nexusState.userInfluence>0&&(this.nexusState.userInfluence=Math.max(0,this.nexusState.userInfluence-.01))}calculateOptimizedNavigationScale(t=.5,i="neutral"){let a=1;return t>.7&&(a=1.02),i==="energetic"&&(a*=1.01),a}getNavigationScalingReport(){return{target:this.nexusState.targetNavigationScale,current:this.nexusState.currentNavigationScale,intensity:this.nexusState.lastVisualIntensity,mood:this.nexusState.lastMoodIdentifier}}getMeditationReport(){return{isMeditating:this.biometricState.isMeditating,timeSinceInteraction:(Date.now()-this.biometricState.lastUserInteractionTime)/1e3,desaturation:this.biometricState.desaturation,slowdown:this.biometricState.slowdown}}destroy(){this._interactionHandler&&(["click","mousemove","keydown"].forEach(t=>{document.removeEventListener(t,this._interactionHandler)}),this._scrollContainerElements.forEach(t=>{t.removeEventListener("scroll",this._interactionHandler)}),this._interactionHandler=null),super.destroy()}}});var $i,Hs=y(()=>{"use strict";L();$i=class{constructor(e){this.year3000System=e;this.systemName="SpotifyUIApplicationSystem";this.initialized=!1;this.effectLayers=[];this.observerRegistry=new Map;this.lastDiscoveryLogTime=0;this.lastRefreshLogTime=0;this.debounceRefresh=this.debounce(()=>{this.refreshUITargets()},2e3);this.targets=this.initializeEmptyTargets()}updateAnimation(e){}async healthCheck(){try{let e=this.getTargetStats(),t=Object.values(e).reduce((r,n)=>r+n,0),i=this.initialized&&t>0,a=[];return t===0&&a.push("No UI elements discovered"),{healthy:i,ok:i,details:`UI Application System ${this.initialized?"active":"inactive"}, ${t} elements enhanced`,issues:a,system:"SpotifyUIApplicationSystem"}}catch(e){return{healthy:!1,ok:!1,details:"Health check failed",issues:[e instanceof Error?e.message:"Unknown error"],system:"SpotifyUIApplicationSystem"}}}forceRepaint(e){console.log(`\u{1F3A8} Force repaint requested: ${e||"manual trigger"}`),this.forceEffectCascade()}initializeEmptyTargets(){return{nowPlaying:[],sidebar:[],mainContent:[],buttons:[],cards:[],headers:[],textElements:[],iconElements:[],playbackControls:[],trackRows:[]}}async initialize(){if(!this.initialized)try{await this.discoverUITargets(),this.setupEffectLayers(),this.applyUnifiedState(),this.setupDOMObservers(),this.registerSystemCallbacks(),this.initialized=!0,console.log("\u2728 SpotifyUIApplicationSystem initialized successfully")}catch(e){throw console.error("Failed to initialize SpotifyUIApplicationSystem",e),e}}async discoverUITargets(){let e={nowPlaying:['[data-testid="now-playing-widget"]',".main-nowPlayingWidget-nowPlaying",".Root__now-playing-bar"],sidebar:['[data-testid="nav-bar"]',".main-navBar-navBar",".Root__nav-bar"],mainContent:['[data-testid="main"]',".main-view-container",".Root__main-view"],buttons:['button[class*="Button"]','[role="button"]',".main-playButton-PlayButton"],cards:['[data-testid*="card"]',".main-card-card",".main-entityCard-container"],headers:["h1, h2, h3, h4, h5, h6",'[data-testid*="header"]',".main-entityHeader-titleText"],textElements:['[data-testid="track-name"]','[data-testid="artist-name"]',".main-trackList-trackName",".main-trackList-artistName"],iconElements:['svg[class*="Icon"]','[data-testid*="icon"]',".Svg-sc-ytk21e-0"],playbackControls:['[data-testid="control-button"]',".main-playPauseButton-button",".player-controls__buttons"],trackRows:['[data-testid="tracklist-row"]',".main-trackList-trackListRow",".main-rootlist-rootlistItem"]},t={};for(let[a,r]of Object.entries(e))t[a]=r.join(", ");let i=new Map;for(let[a,r]of Object.entries(t))try{let n=document.querySelectorAll(r);for(let s of n)i.has(s)||i.set(s,[]),i.get(s).push(a)}catch{continue}this.targets=this.initializeEmptyTargets();for(let[a,r]of i)for(let n of r)this.targets[n].push(a);performance.now()-this.lastDiscoveryLogTime>=5e3&&(console.log("\u{1F3AF} UI targets discovered",{nowPlaying:this.targets.nowPlaying.length,sidebar:this.targets.sidebar.length,mainContent:this.targets.mainContent.length,buttons:this.targets.buttons.length,cards:this.targets.cards.length,headers:this.targets.headers.length,textElements:this.targets.textElements.length,iconElements:this.targets.iconElements.length,playbackControls:this.targets.playbackControls.length,trackRows:this.targets.trackRows.length}),this.lastDiscoveryLogTime=performance.now())}setupEffectLayers(){this.effectLayers=[{name:"background-containers",elements:[...this.targets.mainContent,...this.targets.sidebar],priority:10,cssVariables:{"--sn-bg-primary":"var(--sn-accent-primary)","--sn-bg-secondary":"var(--sn-accent-secondary)","--sn-gradient-start":"var(--sn-gradient-primary-rgb)","--sn-gradient-end":"var(--sn-gradient-secondary-rgb)"}},{name:"ui-cards",elements:this.targets.cards,priority:20,cssVariables:{"--sn-card-bg":"var(--sn-accent-primary)","--sn-card-border":"var(--sn-accent-secondary)","--sn-card-glow":"var(--sn-accent-tertiary)","--sn-glassmorphism-intensity":"var(--sn-effect-intensity)"},interactionEffects:!0},{name:"interactive-elements",elements:[...this.targets.buttons,...this.targets.playbackControls],priority:30,cssVariables:{"--sn-button-bg":"var(--sn-accent-primary)","--sn-button-hover":"var(--sn-accent-secondary)","--sn-button-active":"var(--sn-accent-tertiary)","--sn-beat-sync-intensity":"var(--sn-music-intensity)"},interactionEffects:!0},{name:"text-icon-effects",elements:[...this.targets.textElements,...this.targets.iconElements,...this.targets.headers],priority:40,cssVariables:{"--sn-text-primary":"var(--sn-accent-primary)","--sn-text-secondary":"var(--sn-accent-secondary)","--sn-text-glow":"var(--sn-accent-tertiary)","--sn-icon-color":"var(--sn-accent-primary)","--sn-icon-glow":"var(--sn-accent-secondary)"}},{name:"now-playing-effects",elements:this.targets.nowPlaying,priority:50,cssVariables:{"--sn-now-playing-bg":"var(--sn-accent-primary)","--sn-now-playing-glow":"var(--sn-accent-secondary)","--sn-beat-pulse":"var(--sn-music-intensity)","--sn-track-progress":"var(--sn-accent-tertiary)"},interactionEffects:!0}]}applyUnifiedState(){this.effectLayers.forEach(e=>{e.elements.forEach(t=>{this.applyEffectToElement(t,e)})})}safeQueueCSSVariableUpdate(e,t,i){this.year3000System?.queueCSSVariableUpdate?this.year3000System.queueCSSVariableUpdate(e,t,i||null):(i||document.documentElement).style.setProperty(e,t)}applyEffectToElement(e,t){e instanceof HTMLElement&&(Object.entries(t.cssVariables).forEach(([i,a])=>{this.safeQueueCSSVariableUpdate(i,a,e)}),e.classList.add(`sn-${t.name}`),e.classList.add("sn-ui-enhanced"),t.interactionEffects&&this.addInteractionEffects(e,t),e.setAttribute("data-sn-layer",t.name),e.setAttribute("data-sn-priority",t.priority.toString()))}addInteractionEffects(e,t){(t.name==="interactive-elements"||t.name==="now-playing-effects")&&(this.safeQueueCSSVariableUpdate("--sn-beat-response","var(--sn-music-intensity)",e),e.classList.add("sn-beat-responsive")),e.addEventListener("mouseenter",()=>{this.safeQueueCSSVariableUpdate("--sn-hover-intensity","1",e),e.classList.add("sn-hover-active")}),e.addEventListener("mouseleave",()=>{this.safeQueueCSSVariableUpdate("--sn-hover-intensity","0",e),e.classList.remove("sn-hover-active")}),e.addEventListener("click",()=>{this.safeQueueCSSVariableUpdate("--sn-click-intensity","1",e),e.classList.add("sn-click-active"),setTimeout(()=>{this.safeQueueCSSVariableUpdate("--sn-click-intensity","0",e),e.classList.remove("sn-click-active")},300)})}setupDOMObservers(){let e={childList:!0,subtree:!1,attributes:!1},t=new MutationObserver(a=>{let r=!1;a.forEach(n=>{n.type==="childList"&&n.addedNodes.length>0&&Array.from(n.addedNodes).some(o=>{if(o.nodeType===Node.ELEMENT_NODE){let l=o;return l.matches('[data-testid*="card"], [data-testid*="track"], [data-testid*="header"], [role="button"]')||l.querySelector('[data-testid*="card"], [data-testid*="track"], [data-testid*="header"], [role="button"]')}return!1})&&(r=!0)}),r&&this.debounceRefresh()}),i=document.querySelector('[data-testid="main"]')||document.body;t.observe(i,e),this.observerRegistry.set("main",t)}debounce(e,t){let i;return function(...r){let n=()=>{clearTimeout(i),e(...r)};clearTimeout(i),i=setTimeout(n,t)}}async refreshUITargets(){try{let e=this.calculateTargetHash();await this.discoverUITargets();let t=this.calculateTargetHash();e!==t&&(this.applyUnifiedState(),performance.now()-this.lastRefreshLogTime>=1e4&&(console.log("\u{1F504} UI targets refreshed"),this.lastRefreshLogTime=performance.now()))}catch(e){console.error("Failed to refresh UI targets",e)}}calculateTargetHash(){return Object.values(this.targets).map(t=>t.length).join("-")}registerSystemCallbacks(){try{p.subscribe("colors:harmonized",e=>{this.handleColorHarmonizedEvent({type:"colors/harmonized",payload:{processedColors:e.processedColors,accentHex:e.accentHex||"#cba6f7",accentRgb:e.accentRgb||"203,166,247",context:{rawColors:e.processedColors,trackUri:"",timestamp:Date.now()},cssVariables:{},metadata:{strategy:e.strategies[0]||"unknown",accentHex:e.accentHex,processingTime:e.processingTime}}})},"SpotifyUIApplicationSystem"),console.log("\u{1F3A8} [SpotifyUIApplicationSystem] Subscribed to colors:harmonized events")}catch(e){if(console.error("[SpotifyUIApplicationSystem] Failed to subscribe to colors:harmonized events:",e),this.year3000System.colorHarmonyEngine){let t=this.year3000System.applyColorsToTheme.bind(this.year3000System);this.year3000System.applyColorsToTheme=(i={})=>{t(i),this.updateColorVariables(i)},console.warn("[SpotifyUIApplicationSystem] Using legacy color application hook as fallback")}}if(this.year3000System.musicSyncService){let e=this.year3000System.updateFromMusicAnalysis.bind(this.year3000System);this.year3000System.updateFromMusicAnalysis=(t,i,a)=>{e(t,i,a),this.updateMusicIntensity(t)}}this.year3000System.beatSyncVisualSystem&&(this.year3000System.timerConsolidationSystem?this.year3000System.timerConsolidationSystem.registerConsolidatedTimer("SpotifyUIApplicationSystem-beatEffects",()=>{let e=this.getCurrentMusicIntensity();e>.5&&this.triggerBeatEffects({intensity:e})},200,"normal"):setInterval(()=>{let e=this.getCurrentMusicIntensity();e>.5&&this.triggerBeatEffects({intensity:e})},200))}getCurrentMusicIntensity(){let e=document.documentElement,t=getComputedStyle(e).getPropertyValue("--sn-kinetic-energy").trim();return parseFloat(t)||0}handleColorHarmonizedEvent(e){if(e.type!=="colors/harmonized")return;let{processedColors:t,cssVariables:i,metadata:a}=e.payload;console.log("\u{1F3A8} [SpotifyUIApplicationSystem] Received harmonized colors via event-driven pattern",{strategy:a.strategy,colorsCount:Object.keys(t).length,cssVariablesCount:Object.keys(i).length});try{this.updateColorVariables(t),i&&Object.keys(i).length>0&&this.applyCSSVariablesToSpotifyUI(i)}catch(r){console.error("[SpotifyUIApplicationSystem] Failed to apply harmonized colors from event:",r),this.updateColorVariables(t)}}applyCSSVariablesToSpotifyUI(e){try{let t=document.documentElement,i=document.querySelectorAll(".sn-ui-enhanced");for(let[a,r]of Object.entries(e))a&&r&&t.style.setProperty(a,r);i.forEach(a=>{if(a instanceof HTMLElement)for(let[r,n]of Object.entries(e))r&&n&&a.style.setProperty(r,n)}),console.log("\u{1F3A8} [SpotifyUIApplicationSystem] Applied CSS variables to Spotify UI",{variablesCount:Object.keys(e).length,enhancedElementsCount:i.length})}catch(t){console.error("[SpotifyUIApplicationSystem] Failed to apply CSS variables to Spotify UI:",t)}}updateColorVariables(e){document.querySelectorAll(".sn-ui-enhanced").forEach(i=>{i instanceof HTMLElement&&(this.safeQueueCSSVariableUpdate("--sn-accent-primary",e.primary||"var(--spice-accent)",i),this.safeQueueCSSVariableUpdate("--sn-accent-secondary",e.secondary||"var(--spice-accent)",i),this.safeQueueCSSVariableUpdate("--sn-accent-tertiary",e.tertiary||"var(--spice-accent)",i))})}updateMusicIntensity(e){let t=e?.processedEnergy||0;document.querySelectorAll(".sn-beat-responsive").forEach(a=>{a instanceof HTMLElement&&this.safeQueueCSSVariableUpdate("--sn-music-intensity",t.toString(),a)})}triggerBeatEffects(e){document.querySelectorAll(".sn-beat-responsive").forEach(i=>{i instanceof HTMLElement&&(this.safeQueueCSSVariableUpdate("--sn-beat-pulse","1",i),i.classList.add("sn-beat-active"),setTimeout(()=>{this.safeQueueCSSVariableUpdate("--sn-beat-pulse","0",i),i.classList.remove("sn-beat-active")},200))})}forceEffectCascade(){this.effectLayers.sort((e,t)=>e.priority-t.priority).forEach(e=>{e.elements.forEach(t=>{this.applyEffectToElement(t,e)})})}async destroy(){this.year3000System?.timerConsolidationSystem&&this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer("SpotifyUIApplicationSystem-beatEffects"),this.observerRegistry.forEach(t=>{t.disconnect()}),this.observerRegistry.clear(),document.querySelectorAll(".sn-ui-enhanced").forEach(t=>{t.classList.remove("sn-ui-enhanced"),t.removeAttribute("data-sn-layer"),t.removeAttribute("data-sn-priority")}),this.initialized=!1}getTargetStats(){return Object.fromEntries(Object.entries(this.targets).map(([e,t])=>[e,t.length]))}}});var Wi,_s=y(()=>{"use strict";L();Me();ae();Wi=class{constructor(e,t,i){this.initialized=!1;this.cinematicElements=new Map;this.dramaticElements=this.cinematicElements;this.performanceMetrics={energyBurstCount:0,averageProcessingTime:0,lastUpdateTime:0,cpuUsage:0};this.animationState={energyPhase:0,dramaticPhase:0,interferencePhase:0,lastFrameTime:0,isAnimating:!1};this.cinematicPalettes={"blade-runner":{primaryRed:{r:255,g:50,b:50},amberGlow:{r:255,g:140,b:0},deepBlue:{r:0,g:100,b:200},neonCyan:{r:0,g:255,b:255}},cyberpunk:{primaryRed:{r:255,g:0,b:100},amberGlow:{r:255,g:180,b:0},deepBlue:{r:50,g:50,b:255},neonCyan:{r:100,g:255,b:255}},"dramatic-noir":{primaryRed:{r:200,g:0,b:0},amberGlow:{r:255,g:120,b:0},deepBlue:{r:0,g:50,b:150},neonCyan:{r:0,g:200,b:255}}};this.layeredSystem=e,this.holographicSystem=e,this.cssController=t,this.musicSyncService=i,this.oklabProcessor=new M(!0),this.emotionalMapper=new Z(!0),this.cinematicPreset=M.getPreset("COSMIC"),this.energyBurstState={burstIntensity:0,burstFrequency:.5,colorTemperature:2500,interferenceLevel:0,scanlineVelocity:1,layeredDepth:0,holographicDepth:0,musicTension:0,energyStability:1},this.cinematicConfig={energyActivationThreshold:.7,maxLayeredIntensity:.9,maxHolographicIntensity:.9,crtFilteringStrength:.8,bladeRunnerMode:!0,energyBurstDuration:1500,baseScanlineFrequency:120}}async initialize(){if(!this.initialized)try{console.log("[RedEnergyBurstSystem] Initializing red energy burst system..."),this.subscribeToColorVisualEffects(),this.subscribeToOKLABColorEvents(),await this.initializeCinematicElements(),this.setupCinematicCSSVariables(),this.startCinematicAnimation(),this.initialized=!0,console.log("[RedEnergyBurstSystem] \u2705 Ready for dramatic visual effects moments")}catch(e){throw console.error("[RedEnergyBurstSystem] Failed to initialize:",e),e}}updateAnimation(e){if(!this.initialized)return;let t=e/1e3;this.animationState.energyPhase+=t*this.energyBurstState.burstFrequency*2,this.animationState.dramaticPhase+=t*.8,this.animationState.interferencePhase+=t*3,this.updateEnergyBurstFromMusic(),this.updateLayeredMapping(),this.updateCinematicElements(),this.updatePerformanceMetrics(e)}async healthCheck(){let e=this.initialized&&this.energyBurstState.burstIntensity>=0&&this.performanceMetrics.averageProcessingTime<5;return{system:"RedEnergyBurstSystem",healthy:e,metrics:{energyBurstCount:this.performanceMetrics.energyBurstCount,processingTime:this.performanceMetrics.averageProcessingTime,cinematicElementCount:this.cinematicElements.size,cpuUsage:this.performanceMetrics.cpuUsage},issues:e?[]:["Performance degradation detected"]}}subscribeToColorVisualEffects(){p.subscribe("music:emotional-context-updated",e=>{this.onColorVisualEffectsUpdate(e)},"RedEnergyBurstSystem"),p.subscribe("music:emotion-analyzed",e=>{this.onMusicIntensitySpike(e)},"RedEnergyBurstSystem"),p.subscribe("music:emotion-analyzed",e=>{this.onDramaticMoment(e)},"RedEnergyBurstSystem")}subscribeToOKLABColorEvents(){p.subscribe("colors:harmonized",e=>{this.onOKLABColorsHarmonized(e)},"RedEnergyBurstSystem"),p.subscribe("colors:extracted",e=>{this.onColorsExtracted(e)},"RedEnergyBurstSystem")}onColorVisualEffectsUpdate(e){let{palette:t,visualEffectsLevel:i,emotionalTemperature:a}=e;this.energyBurstState.musicTension=i*.8,a<3e3?this.energyBurstState.colorTemperature=2200:a>6e3?this.energyBurstState.colorTemperature=2800:this.energyBurstState.colorTemperature=2500;let r=this.extractDominantRedColor(t);this.updateHolographicColors(r)}onMusicIntensitySpike(e){let{intensity:t,beat:i}=e;t>this.cinematicConfig.energyActivationThreshold&&this.triggerEnergyBurst(t,i)}onDramaticMoment(e){let{type:t,intensity:i}=e;this.energyBurstState.musicTension=Math.min(1,i*1.2),this.energyBurstState.interferenceLevel=i*.6,this.energyBurstState.energyStability=Math.max(.3,1-i*.7)}onOKLABColorsHarmonized(e){let{processedColors:t,coordinationMetrics:i}=e,a=this.extractCinematicOKLABColors(t);this.updateCinematicPaletteWithOKLAB(a),(i?.detectedGenre||i?.emotionalState)&&this.adjustCinematicPresetForContext(i)}onColorsExtracted(e){let{rawColors:t,musicData:i}=e;if(i){let a=this.emotionalMapper.mapMusicToEmotionalTemperature(i);this.adjustCinematicEffectsForEmotion(a),a.intensity>.7?this.cinematicPreset=M.getPreset("COSMIC"):a.intensity>.4?this.cinematicPreset=M.getPreset("VIBRANT"):this.cinematicPreset=M.getPreset("STANDARD")}}triggerEnergyBurst(e,t){let i=performance.now();this.energyBurstState.burstIntensity=Math.min(1,e*1.1),this.energyBurstState.burstFrequency=1+e*2,this.energyBurstState.layeredDepth=e*.8,this.energyBurstState.holographicDepth=e*.8,this.energyBurstState.scanlineVelocity=1+t.strength*2,setTimeout(()=>{this.decayEnergyBurst()},this.cinematicConfig.energyBurstDuration),this.performanceMetrics.energyBurstCount++,this.performanceMetrics.lastUpdateTime=performance.now()-i,console.log(`[RedEnergyBurstSystem] \u{1F525} Red energy burst triggered! Intensity: ${e.toFixed(2)}`)}decayEnergyBurst(){let t=()=>{this.energyBurstState.burstIntensity*=.95,this.energyBurstState.layeredDepth*=.96,this.energyBurstState.holographicDepth=this.energyBurstState.layeredDepth,this.energyBurstState.interferenceLevel*=.97,this.energyBurstState.burstIntensity>.05?requestAnimationFrame(t):(this.energyBurstState.burstIntensity=0,this.energyBurstState.layeredDepth=0,this.energyBurstState.holographicDepth=0,this.energyBurstState.interferenceLevel=0)};requestAnimationFrame(t)}updateEnergyBurstFromMusic(){let e=this.musicSyncService.getCurrentMusicState();if(!e)return;let{emotion:t,beat:i,intensity:a}=e;if(i&&i.tempo){let r=Math.max(.5,Math.min(2,i.tempo/120));this.energyBurstState.burstFrequency=this.energyBurstState.burstFrequency*r}t&&t.arousal>.7&&(this.energyBurstState.interferenceLevel=Math.max(this.energyBurstState.interferenceLevel,t.arousal*.5))}updateLayeredMapping(){let e=this.cinematicPalettes["blade-runner"],t={primaryColor:this.blendRedColors(e.primaryRed,e.amberGlow,this.energyBurstState.colorTemperature/3e3),glowIntensity:this.energyBurstState.burstIntensity*this.cinematicConfig.maxLayeredIntensity,flickerRate:this.energyBurstState.burstFrequency*2,scanlineColor:e.amberGlow,atmosphericDepth:this.energyBurstState.layeredDepth,interferencePattern:this.getInterferencePattern()};this.updateCinematicCSSVariables(t)}updateHolographicMapping(){this.updateLayeredMapping()}blendRedColors(e,t,i){let a=Math.max(0,Math.min(1,i));try{let r=`#${e.r.toString(16).padStart(2,"0")}${e.g.toString(16).padStart(2,"0")}${e.b.toString(16).padStart(2,"0")}`,n=`#${t.r.toString(16).padStart(2,"0")}${t.g.toString(16).padStart(2,"0")}${t.b.toString(16).padStart(2,"0")}`;return this.oklabProcessor.interpolateOKLAB(r,n,a,this.cinematicPreset).enhancedRgb}catch{return{r:Math.round(e.r*(1-a)+t.r*a),g:Math.round(e.g*(1-a)+t.g*a),b:Math.round(e.b*(1-a)+t.b*a)}}}getInterferencePattern(){return this.energyBurstState.energyStability<.4?"chaotic":this.energyBurstState.musicTension>.7?"intense":this.energyBurstState.interferenceLevel>.5?"noise":"wave"}extractDominantRedColor(e){let t={r:255,g:50,b:50};if(e&&e.length>0){let i=e.filter(a=>a.r>a.g&&a.r>a.b);i.length>0&&(t=i[0])}return t}extractCinematicOKLABColors(e){let i={...this.cinematicPalettes["blade-runner"]};if(e.VIBRANT){let a=this.oklabProcessor.processColor(e.VIBRANT,this.cinematicPreset);i.primaryRed=a.enhancedRgb}if(e.PROMINENT){let a=this.oklabProcessor.processColor(e.PROMINENT,this.cinematicPreset);i.amberGlow=a.enhancedRgb}if(e.DARK_VIBRANT){let a=this.oklabProcessor.processColor(e.DARK_VIBRANT,this.cinematicPreset);i.deepBlue=a.enhancedRgb}return i}updateCinematicPaletteWithOKLAB(e){this.cinematicPalettes["blade-runner"]=e,this.cssController.queueCSSVariableUpdate("--cinematic-red-r",e.primaryRed.r.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-red-g",e.primaryRed.g.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-red-b",e.primaryRed.b.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-amber-r",e.amberGlow.r.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-amber-g",e.amberGlow.g.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-amber-b",e.amberGlow.b.toString())}adjustCinematicPresetForContext(e){let{detectedGenre:t,emotionalState:i,oklabPreset:a}=e;if(t)switch(t){case"electronic":case"dance":case"techno":this.cinematicPreset=M.getPreset("COSMIC"),this.cinematicConfig.bladeRunnerMode=!0;break;case"rock":case"metal":this.cinematicPreset=M.getPreset("VIBRANT"),this.cinematicConfig.energyActivationThreshold=.6;break;case"ambient":case"classical":this.cinematicPreset=M.getPreset("SUBTLE"),this.cinematicConfig.energyActivationThreshold=.8;break;default:this.cinematicPreset=M.getPreset("STANDARD")}if(i)switch(i){case"aggressive":case"energetic":this.energyBurstState.burstFrequency*=1.5,this.energyBurstState.interferenceLevel=Math.min(1,this.energyBurstState.interferenceLevel+.3);break;case"calm":case"ambient":this.energyBurstState.burstFrequency*=.7,this.energyBurstState.energyStability=Math.min(1,this.energyBurstState.energyStability+.2);break;case"mysterious":this.cinematicConfig.bladeRunnerMode=!0,this.energyBurstState.interferenceLevel=Math.min(1,this.energyBurstState.interferenceLevel+.2);break}}adjustCinematicEffectsForEmotion(e){let{primaryEmotion:t,intensity:i,temperature:a}=e;switch(this.energyBurstState.musicTension=i*.9,a<3e3?this.energyBurstState.colorTemperature=2200:a>6e3?this.energyBurstState.colorTemperature=2800:this.energyBurstState.colorTemperature=2500,t){case"aggressive":this.energyBurstState.interferenceLevel=Math.min(1,i*.8),this.energyBurstState.energyStability=Math.max(.2,1-i);break;case"calm":this.energyBurstState.energyStability=Math.min(1,.8+i*.2),this.energyBurstState.interferenceLevel*=.5;break;case"mysterious":this.energyBurstState.interferenceLevel=i*.6,this.cinematicConfig.bladeRunnerMode=!0;break;case"energetic":this.energyBurstState.burstFrequency=Math.min(3,1+i*2);break}}updateHolographicColors(e){this.cssController.queueCSSVariableUpdate("--cinematic-red-r",e.r.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-red-g",e.g.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-red-b",e.b.toString())}async initializeCinematicElements(){return this.initializeDramaticElements()}async initializeDramaticElements(){let e=[{selector:".Root__now-playing-bar",type:"energy_barrier"},{selector:".main-view-container",type:"cinematic_overlay"},{selector:".Root__nav-bar",type:"data_stream_red"},{selector:".player-controls",type:"dramatic_interface"}];for(let t of e){let i=document.querySelectorAll(t.selector);for(let a of i){let r={id:`dramatic-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,element:a,originalStyles:getComputedStyle(a),holographicType:t.type,intensity:.8,isActive:!0,lastUpdate:0,animation:null,visualEffectsLevel:.9,smoothIntegration:!0};this.cinematicElements.set(r.id,r)}}}setupCinematicCSSVariables(){let e={"--cinematic-red-r":"255","--cinematic-red-g":"50","--cinematic-red-b":"50","--cinematic-amber-r":"255","--cinematic-amber-g":"140","--cinematic-amber-b":"0","--cinematic-glow-intensity":"0","--cinematic-flicker-rate":"0.5","--cinematic-scanline-speed":"1.0","--cinematic-interference":"0","--cinematic-depth":"0"};for(let[t,i]of Object.entries(e))this.cssController.queueCSSVariableUpdate(t,i)}updateCinematicCSSVariables(e){this.cssController.queueCSSVariableUpdate("--cinematic-glow-intensity",e.glowIntensity.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-flicker-rate",e.flickerRate.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-scanline-speed",this.energyBurstState.scanlineVelocity.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-interference",this.energyBurstState.interferenceLevel.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-depth",e.atmosphericDepth.toString())}updateCinematicElements(){for(let[e,t]of this.cinematicElements)t.isActive&&this.updateCinematicElement(t)}updateDramaticElements(){for(let[e,t]of this.cinematicElements)t.isActive&&this.updateDramaticElement(t)}updateCinematicElement(e){let{element:t,intensity:i}=e;this.energyBurstState.burstIntensity>.1&&this.applyRedEnergyBurst(t,i),this.energyBurstState.interferenceLevel>.1&&this.applyCRTInterference(t,i),this.applyCinematicScanlines(t,i)}updateDramaticElement(e){let{element:t,intensity:i}=e;this.energyBurstState.burstIntensity>.1&&this.applyRedEnergyBurst(t,i),this.energyBurstState.interferenceLevel>.1&&this.applyCRTInterference(t,i),this.applyCinematicScanlines(t,i)}applyRedEnergyBurst(e,t){let i=this.energyBurstState.burstIntensity*t,a=Math.sin(this.animationState.energyPhase*3)*.5+.5,r=i*a*.8;e.style.boxShadow=`
      0 0 ${r*40}px rgba(var(--cinematic-red-r), var(--cinematic-red-g), var(--cinematic-red-b), ${r}),
      inset 0 0 ${r*20}px rgba(var(--cinematic-amber-r), var(--cinematic-amber-g), var(--cinematic-amber-b), ${r*.5})
    `,i>.3&&(e.style.border=`1px solid rgba(var(--cinematic-red-r), var(--cinematic-red-g), var(--cinematic-red-b), ${i})`)}applyCRTInterference(e,t){let i=this.energyBurstState.interferenceLevel*t,a=this.animationState.interferencePhase,r=i*3,n=Math.sin(a*2)*r,s=Math.cos(a*2.5)*r;if(e.style.filter=`
      drop-shadow(${n}px 0 0 rgba(var(--spice-rgb-cinematic-red, 255, 0, 0), ${i*.6}))
      drop-shadow(${s}px 0 0 rgba(var(--spice-rgb-cinematic-cyan, 0, 255, 255), ${i*.4}))
    `,i>.5){let o=Math.sin(a*10)*i*2;e.style.transform=`translateX(${o}px)`}}applyCinematicScanlines(e,t){let i=this.energyBurstState.burstIntensity*t*.6;if(i>.1){let a=this.cinematicConfig.baseScanlineFrequency/30;e.style.background=`
        ${e.style.background||""},
        repeating-linear-gradient(
          0deg,
          transparent 0px,
          transparent ${a-1}px,
          rgba(var(--cinematic-amber-r), var(--cinematic-amber-g), var(--cinematic-amber-b), ${i*.15}) ${a}px
        )
      `}}applyDramaticScanlines(e,t){let i=this.energyBurstState.burstIntensity*t*.6;if(i>.1){let a=this.cinematicConfig.baseScanlineFrequency/30;e.style.background=`
        ${e.style.background||""},
        repeating-linear-gradient(
          0deg,
          transparent 0px,
          transparent ${a-1}px,
          rgba(var(--cinematic-amber-r), var(--cinematic-amber-g), var(--cinematic-amber-b), ${i*.15}) ${a}px
        )
      `}}startCinematicAnimation(){this.animationState.isAnimating=!0,this.animationState.lastFrameTime=performance.now();let e=t=>{if(!this.animationState.isAnimating)return;let i=t-this.animationState.lastFrameTime;this.animationState.lastFrameTime=t,this.updateAnimation(i),requestAnimationFrame(e)};requestAnimationFrame(e)}updatePerformanceMetrics(e){this.performanceMetrics.averageProcessingTime=this.performanceMetrics.averageProcessingTime*.9+e*.1,this.performanceMetrics.cpuUsage=Math.min(100,e/16.67*100)}forceRepaint(e){console.log(`[RedEnergyBurstSystem] Force repaint triggered: ${e||"Unknown"}`),this.updateCinematicElements(),this.cssController.flushCSSVariableBatch()}destroy(){console.log("[RedEnergyBurstSystem] Destroying cinematic drama engine..."),this.animationState.isAnimating=!1,this.cinematicElements.clear(),this.energyBurstState={burstIntensity:0,burstFrequency:.5,colorTemperature:2500,interferenceLevel:0,scanlineVelocity:1,layeredDepth:0,holographicDepth:0,musicTension:0,energyStability:1},this.initialized=!1}getEnergyBurstState(){return{...this.energyBurstState}}getCinematicConfig(){return{...this.cinematicConfig}}getPerformanceMetrics(){return{...this.performanceMetrics}}setRedEnergyThreshold(e){this.cinematicConfig.energyActivationThreshold=Math.max(0,Math.min(1,e))}setBladeRunnerMode(e){this.cinematicConfig.bladeRunnerMode=e,e&&console.log("[RedEnergyBurstSystem] \u{1F3AC} Blade Runner mode activated")}}});var Gt,zs=y(()=>{"use strict";L();X();Gt=class{constructor(e,t,i){this.initialized=!1;this.subtleElements=new Map;this.performanceMetrics={responsiveMomentCount:0,averageProcessingTime:0,lastUpdateTime:0,smoothTransitionCount:0,get emotionalMomentCount(){return this.responsiveMomentCount},set emotionalMomentCount(e){this.responsiveMomentCount=e},get gentleTransitionCount(){return this.smoothTransitionCount},set gentleTransitionCount(e){this.smoothTransitionCount=e}};this.animationState={ambientPhase:0,smoothPhase:0,flowingPhase:0,get mysticalPhase(){return this.ambientPhase},set mysticalPhase(e){this.ambientPhase=e},get dreamyPhase(){return this.smoothPhase},set dreamyPhase(e){this.smoothPhase=e},responsivePulsePhase:0,get emotionalPulsePhase(){return this.responsivePulsePhase},set emotionalPulsePhase(e){this.responsivePulsePhase=e},lastFrameTime:0,isAnimating:!1};this.lerpHalfLifeValues={glowIntensity:.25,effectLevel:.35,shimmerEffect:.2};this.subtlePalettes={"smooth-pastels":{primaryGlow:{r:203,g:166,b:247},shimmerColor:{r:148,g:226,b:213},mistBackground:{r:245,g:224,b:220},coreColor:{r:249,g:226,b:175},accentColor:{r:180,g:190,b:254}},"ambient-moonlight":{primaryGlow:{r:137,g:180,b:250},shimmerColor:{r:166,g:227,b:161},mistBackground:{r:205,g:214,b:244},coreColor:{r:243,g:139,b:168},accentColor:{r:137,g:220,b:235}},"smooth-aurora":{primaryGlow:{r:166,g:227,b:161},shimmerColor:{r:137,g:220,b:235},mistBackground:{r:186,g:194,b:222},coreColor:{r:250,g:179,b:135},accentColor:{r:203,g:166,b:247}}};this.holographicSystem=e,this.cssVisualEffectsController=t,this.musicSyncService=i,this.glowState={glowIntensity:0,effectLevel:0,softness:.8,shimmerEffect:0,transparency:.9,gradientPhase:0,musicResponse:0,smoothnessFactor:1,targetGlowIntensity:0,targetEffectLevel:0,targetShimmerEffect:0},this.glowConfig={musicThreshold:.6,maxGlowIntensity:.8,transitionDuration:2e3,particleCount:15,blurRadius:8,gradientSpeed:.3}}get etherealElements(){return this.subtleElements}get etherealPalettes(){return this.subtlePalettes}async initialize(){if(!this.initialized)try{console.log("[SoftGlowEffectsManager] Initializing subtle visual effects..."),this.subscribeToEmotionalVisualEffects(),await this.initializeGlowElements(),this.setupGlowCSSVariables(),this.startEtherealAnimation(),this.initialized=!0,console.log("[SoftGlowEffectsManager] \u2728 Ready for ambient responsive moments")}catch(e){throw console.error("[SoftGlowEffectsManager] Failed to initialize:",e),e}}updateAnimation(e){if(!this.initialized)return;let t=e/1e3;this.animationState.ambientPhase+=t*.5,this.animationState.smoothPhase+=t*.3,this.animationState.flowingPhase+=t*this.glowConfig.gradientSpeed,this.animationState.responsivePulsePhase+=t*.8,this.updateSubtleFromMusic(),this.updateSubtleStateWithLERP(t),this.updateAmbientEffects(),this.updateGlowElements(),this.updatePerformanceMetrics(e)}async healthCheck(){let e=this.initialized&&this.glowState.effectLevel>=0&&this.performanceMetrics.averageProcessingTime<8;return{system:"SoftGlowEffectsManager",healthy:e,metrics:{emotionalMomentCount:this.performanceMetrics.emotionalMomentCount,processingTime:this.performanceMetrics.averageProcessingTime,etherealElementCount:this.etherealElements.size,gentleTransitionCount:this.performanceMetrics.gentleTransitionCount},issues:e?[]:["Performance degradation detected"]}}subscribeToEmotionalVisualEffects(){p.subscribe("music:emotional-context-updated",e=>{this.onColorVisualEffectsUpdate(e)}),p.subscribe("music:emotion-analyzed",e=>{this.onEmotionalMoment(e)}),p.subscribe("settings:visual-guide-changed",e=>{this.onGentleTransition(e)})}onColorVisualEffectsUpdate(e){let{palette:t,visualEffectsLevel:i,emotionalTemperature:a}=e;this.glowState.musicResponse=i*.9,a>5e3?this.glowState.effectLevel=Math.min(.8,i*1.2):this.glowState.shimmerEffect=i*.7;let r=this.generateGlowColors(t,a);this.updateGlowColors(r)}onEmotionalMoment(e){let{type:t,intensity:i,valence:a}=e;a>this.glowConfig.musicThreshold&&this.triggerSubtleEffect(i,a)}onGentleTransition(e){let{fromState:t,toState:i,duration:a}=e;this.createGentleTransition(t,i,a),this.performanceMetrics.gentleTransitionCount++}triggerSubtleEffect(e,t){let i=performance.now();this.glowState.transparency=.8+t*.2,this.glowState.targetGlowIntensity=Math.max(this.glowState.targetGlowIntensity,e*.8),this.glowState.targetEffectLevel=Math.max(this.glowState.targetEffectLevel,t*.9),this.glowState.targetShimmerEffect=Math.max(this.glowState.targetShimmerEffect,t*.6),this.performanceMetrics.emotionalMomentCount++,this.performanceMetrics.lastUpdateTime=performance.now()-i,console.log(`[SoftGlowEffectsManager] \u2728 Ethereal beauty awakened! Intensity: ${e.toFixed(2)}, Valence: ${t.toFixed(2)}`)}updateSubtleStateWithLERP(e){this.glowState.glowIntensity=H(this.glowState.glowIntensity,this.glowState.targetGlowIntensity,e,this.lerpHalfLifeValues.glowIntensity),this.glowState.effectLevel=H(this.glowState.effectLevel,this.glowState.targetEffectLevel,e,this.lerpHalfLifeValues.effectLevel),this.glowState.shimmerEffect=H(this.glowState.shimmerEffect,this.glowState.targetShimmerEffect,e,this.lerpHalfLifeValues.shimmerEffect);let t=1.5;this.glowState.targetGlowIntensity=H(this.glowState.targetGlowIntensity,0,e,t),this.glowState.targetEffectLevel=H(this.glowState.targetEffectLevel,0,e,t*1.2),this.glowState.targetShimmerEffect=H(this.glowState.targetShimmerEffect,0,e,t*.8)}updateSubtleFromMusic(){let e=this.musicSyncService.getCurrentMusicState();if(!e)return;let{emotion:t,beat:i,intensity:a}=e;if(t&&t.valence>.5&&(this.glowState.shimmerEffect=Math.max(this.glowState.shimmerEffect,t.valence*a*.5),i&&i.tempo)){let r=Math.min(1.5,i.tempo/100);this.glowConfig.gradientSpeed=.3*r}}updateAmbientEffects(){let e=this.etherealPalettes["smooth-pastels"],t={primaryGlow:this.blendSoftColors(e.primaryGlow,e.shimmerColor,this.glowState.shimmerEffect),shimmerColor:e.shimmerColor,mistBackground:e.mistBackground,coreColor:e.coreColor,accentColor:e.accentColor,transparency:this.glowState.transparency};this.updateGlowCSSVariables(t)}blendSoftColors(e,t,i){let a=Math.max(0,Math.min(1,i));return{r:Math.round(e.r*(1-a)+t.r*a),g:Math.round(e.g*(1-a)+t.g*a),b:Math.round(e.b*(1-a)+t.b*a)}}generateGlowColors(e,t){let i=this.etherealPalettes["smooth-pastels"];return t<4e3?i=this.etherealPalettes["ambient-moonlight"]:t>7e3&&(i=this.etherealPalettes["smooth-aurora"]),{primaryGlow:i.primaryGlow,shimmerColor:i.shimmerColor,mistBackground:i.mistBackground,coreColor:i.coreColor,accentColor:i.accentColor,transparency:this.glowState.transparency}}updateGlowColors(e){this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-soft-r",e.primaryGlow.r.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-soft-g",e.primaryGlow.g.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-soft-b",e.primaryGlow.b.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-ambient-r",e.shimmerColor.r.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-ambient-g",e.shimmerColor.g.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-ambient-b",e.shimmerColor.b.toString())}async initializeGlowElements(){let e=[".main-view-container",".Root__now-playing-bar",".main-trackInfo-container",".cover-art",".player-controls"];for(let t of e){let i=document.querySelectorAll(t);for(let a of i){let r=`ethereal-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;this.etherealElements.set(r,a)}}}setupGlowCSSVariables(){let e={"--subtle-soft-r":"203","--subtle-soft-g":"166","--subtle-soft-b":"247","--subtle-ambient-r":"148","--subtle-ambient-g":"226","--subtle-ambient-b":"213","--subtle-smooth-r":"245","--subtle-smooth-g":"224","--subtle-smooth-b":"220","--subtle-effect-level":"0","--subtle-ambient-shimmer":"0","--subtle-smooth-transparency":"0.9","--subtle-flowing-phase":"0","--subtle-responsive-pulse":"0"};for(let[t,i]of Object.entries(e))this.cssVisualEffectsController.queueCSSVariableUpdate(t,i)}updateGlowCSSVariables(e){this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-effect-level",this.glowState.effectLevel.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-ambient-shimmer",this.glowState.shimmerEffect.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-smooth-transparency",e.transparency.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-flowing-phase",this.animationState.flowingPhase.toString()),this.cssVisualEffectsController.queueCSSVariableUpdate("--subtle-responsive-pulse",Math.sin(this.animationState.responsivePulsePhase).toString())}updateGlowElements(){for(let[e,t]of this.etherealElements)this.updateEtherealElement(t)}updateEtherealElement(e){this.glowState.effectLevel>.1&&this.applySubtleEffect(e),this.glowState.shimmerEffect>.1&&this.applyAmbientShimmer(e),this.applyFlowingGradients(e)}applySubtleEffect(e){let t=this.glowState.effectLevel,i=Math.sin(this.animationState.responsivePulsePhase)*.5+.5,a=t*i*.6;e.style.boxShadow=`
      0 0 ${a*30}px rgba(var(--subtle-soft-r), var(--subtle-soft-g), var(--subtle-soft-b), ${a*.6}),
      inset 0 0 ${a*20}px rgba(var(--subtle-ambient-r), var(--subtle-ambient-g), var(--subtle-ambient-b), ${a*.3})
    `;let r=.9+t*.1;e.style.opacity=r.toString()}applyAmbientShimmer(e){let t=this.glowState.shimmerEffect,i=this.animationState.ambientPhase,a=Math.sin(i*2)*t*2,r=1+Math.cos(i*1.5)*t*.05;e.style.transform=`translate(${a}px, 0) scale(${r})`;let n=Math.sin(i*.8)*t*15;e.style.filter=`hue-rotate(${n}deg) saturate(${1+t*.3})`}applyFlowingGradients(e){let t=this.animationState.flowingPhase,i=this.glowState.effectLevel*.8;if(i>.1){let a=(Math.sin(t)+1)*50;e.style.background=`
        ${e.style.background||""},
        linear-gradient(
          ${a}deg,
          rgba(var(--subtle-soft-r), var(--subtle-soft-g), var(--subtle-soft-b), ${i*.1}) 0%,
          rgba(var(--subtle-ambient-r), var(--subtle-ambient-g), var(--subtle-ambient-b), ${i*.15}) 50%,
          rgba(var(--subtle-smooth-r), var(--subtle-smooth-g), var(--subtle-smooth-b), ${i*.05}) 100%
        )
      `}}createGentleTransition(e,t,i){let a=performance.now(),r=n=>{let s=n-a,o=Math.min(1,s/i),l=1-Math.pow(1-o,3);this.glowState.effectLevel=e.beauty+(t.beauty-e.beauty)*l,this.glowState.shimmerEffect=e.shimmer+(t.shimmer-e.shimmer)*l,o<1&&requestAnimationFrame(r)};requestAnimationFrame(r)}startEtherealAnimation(){this.animationState.isAnimating=!0,this.animationState.lastFrameTime=performance.now();let e=t=>{if(!this.animationState.isAnimating)return;let i=t-this.animationState.lastFrameTime;this.animationState.lastFrameTime=t,this.updateAnimation(i),requestAnimationFrame(e)};requestAnimationFrame(e)}updatePerformanceMetrics(e){this.performanceMetrics.averageProcessingTime=this.performanceMetrics.averageProcessingTime*.9+e*.1}forceRepaint(e){console.log(`[SoftGlowEffectsManager] Force repaint triggered: ${e||"Unknown"}`),this.updateGlowElements(),this.cssVisualEffectsController.flushCSSVariableBatch()}destroy(){console.log("[SoftGlowEffectsManager] Dissolving ethereal beauty..."),this.animationState.isAnimating=!1,this.etherealElements.clear(),this.glowState={glowIntensity:0,effectLevel:0,softness:.8,shimmerEffect:0,transparency:.9,gradientPhase:0,musicResponse:0,smoothnessFactor:1,targetGlowIntensity:0,targetEffectLevel:0,targetShimmerEffect:0},this.initialized=!1}getGlowState(){return{...this.glowState}}getGlowConfig(){return{...this.glowConfig}}getPerformanceMetrics(){return{...this.performanceMetrics,etherealElementCount:this.etherealElements.size}}setEmotionalThreshold(e){this.glowConfig.musicThreshold=Math.max(0,Math.min(1,e))}setMaxBeautyIntensity(e){this.glowConfig.maxGlowIntensity=Math.max(0,Math.min(1,e))}setGentleness(e){this.glowState.softness=Math.max(0,Math.min(1,e))}}});var qi,Us=y(()=>{"use strict";L();qi=class{constructor(e,t,i){this.initialized=!1;this.naturalElements=new Map;this.performanceMetrics={peacefulMomentCount:0,averageProcessingTime:0,lastUpdateTime:0,animationCycleCount:0};this.animationPhases={animationPhase:0,seasonalPhase:0,variationPhase:0,harmonyPhase:0,lastFrameTime:0,isAnimating:!1};this.naturalPalettes={"spring-awakening":{earthyWarm:{r:166,g:227,b:161},forestGreen:{r:64,g:160,b:43},skyBlue:{r:137,g:220,b:235},sunsetGlow:{r:250,g:179,b:135},stoneGray:{r:108,g:112,b:134}},"summer-warmth":{earthyWarm:{r:249,g:226,b:175},forestGreen:{r:166,g:227,b:161},skyBlue:{r:116,g:199,b:236},sunsetGlow:{r:250,g:179,b:135},stoneGray:{r:147,g:153,b:178}},"autumn-grounding":{earthyWarm:{r:250,g:179,b:135},forestGreen:{r:148,g:226,b:213},skyBlue:{r:137,g:180,b:250},sunsetGlow:{r:235,g:160,b:172},stoneGray:{r:127,g:132,b:156}},"winter-peace":{earthyWarm:{r:186,g:194,b:222},forestGreen:{r:148,g:226,b:213},skyBlue:{r:137,g:220,b:235},sunsetGlow:{r:203,g:166,b:247},stoneGray:{r:88,g:91,b:112}}};this.holographicSystem=e,this.cssController=t,this.musicSyncService=i,this.effectState={animationIntensity:0,animationFrequency:.4,animationDepth:.8,grounding:0,warmth:.7,ambientLevel:0,colorShift:0,harmonyLevel:0},this.harmonyConfig={calmThreshold:.3,maxBreathingDepth:.9,frequencyRange:[.2,.8],colorStrength:.6,transitionDuration:3e3,cycleSpeed:.1}}injectServices(e){this.services=e}getRequiredServices(){return[]}getOptionalServices(){return["cssVariables","events","performance"]}async initialize(){if(!this.initialized)try{console.log("[AnimationEffectsController] Initializing animation effects..."),this.subscribeToColorEvents(),await this.initializeBreathingElements(),this.setupBreathingCSSVariables(),this.startBreathingAnimation(),this.initialized=!0,console.log("[AnimationEffectsController] \u{1F33F} Breathing effects system ready")}catch(e){throw console.error("[AnimationEffectsController] Failed to initialize:",e),e}}updateAnimation(e){if(!this.initialized)return;let t=e/1e3;this.animationPhases.animationPhase+=t*this.effectState.animationFrequency*2*Math.PI,this.animationPhases.seasonalPhase+=t*this.harmonyConfig.cycleSpeed,this.animationPhases.variationPhase+=t*.4,this.animationPhases.harmonyPhase+=t*.6,this.updateNaturalFromMusic(),this.updateBreathingVisuals(),this.updateBreathingElements(),this.updatePerformanceMetrics(e)}async healthCheck(){let e=this.initialized&&this.effectState.animationIntensity>=0&&this.performanceMetrics.averageProcessingTime<10;return{system:"NaturalHarmonyEngine",healthy:e,metrics:{peacefulMomentCount:this.performanceMetrics.peacefulMomentCount,processingTime:this.performanceMetrics.averageProcessingTime,naturalElementCount:this.naturalElements.size,animationCycleCount:this.performanceMetrics.animationCycleCount},issues:e?[]:["Performance degradation detected"]}}subscribeToColorEvents(){this.services?.events?(this.services.events.subscribe("AnimationEffectsController","music:emotional-context-updated",this.onColorUpdate.bind(this)),this.services.events.subscribe("AnimationEffectsController","music:emotion-analyzed",this.onPeacefulMoment.bind(this)),this.services.events.subscribe("AnimationEffectsController","settings:visual-guide-changed",this.onVisualTransition.bind(this))):(p.subscribe("music:emotional-context-updated",e=>{this.onColorUpdate(e)}),p.subscribe("music:emotion-analyzed",e=>{this.onPeacefulMoment(e)}),p.subscribe("settings:visual-guide-changed",e=>{this.onVisualTransition(e)}))}onColorUpdate(e){let{palette:t,effectsLevel:i,emotionalTemperature:a}=e;this.effectState.harmonyLevel=i*.8,a<5e3?(this.effectState.grounding=i*.6,this.effectState.ambientLevel=i*.4):(this.effectState.warmth=i*.8,this.effectState.colorShift=i*.5);let r=this.generateBreathingColors(t,a);this.updateNaturalColors(r)}onPeacefulMoment(e){let{type:t,intensity:i,serenity:a}=e;this.triggerNaturalBreathing(i,a)}onVisualTransition(e){let{fromSeason:t,toSeason:i,duration:a}=e;this.createSeasonalTransition(t,i,a),this.performanceMetrics.animationCycleCount++}triggerNaturalBreathing(e,t){(this.services?.performance?(a,r)=>this.services.performance.trackOperation("AnimationEffectsController",a,r):(a,r)=>r())("triggerNaturalBreathing",()=>{this.effectState.animationIntensity=t,this.effectState.grounding=t*.7,this.effectState.ambientLevel=t*.6,this.effectState.warmth=.6+t*.3;let a=this.harmonyConfig.frequencyRange;this.effectState.animationFrequency=a[0]+t*(a[1]-a[0]),setTimeout(()=>{this.gentleDecayNaturalBreathing()},this.harmonyConfig.transitionDuration),this.performanceMetrics.peacefulMomentCount++,console.log(`[AnimationEffectsController] \u{1F33F} Breathing effects activated! Serenity: ${t.toFixed(2)}, Frequency: ${this.effectState.animationFrequency.toFixed(2)}Hz`)})}gentleDecayNaturalBreathing(){let t=()=>{this.effectState.animationIntensity*=.985,this.effectState.grounding*=.988,this.effectState.ambientLevel*=.991,this.effectState.animationIntensity>.05?requestAnimationFrame(t):(this.effectState.animationIntensity=0,this.effectState.grounding=0,this.effectState.ambientLevel=0)};requestAnimationFrame(t)}updateNaturalFromMusic(){let e=this.musicSyncService.getCurrentMusicState();if(!e)return;let{emotion:t,beat:i,intensity:a}=e;if(t&&a<this.harmonyConfig.calmThreshold&&(this.effectState.ambientLevel=Math.max(this.effectState.ambientLevel,(1-a)*.6),i&&i.tempo)){let r=Math.max(.5,Math.min(1.2,60/i.tempo));this.effectState.animationFrequency=.4*r}}updateBreathingVisuals(){let e=this.getCurrentSeason(),t=this.naturalPalettes[e],i={warmTone:this.blendBreathingColors(t.earthyWarm,t.sunsetGlow,this.effectState.warmth),coolTone:t.forestGreen,accentBlue:t.skyBlue,highlightGlow:t.sunsetGlow,neutralGray:t.stoneGray,transparency:.85+this.effectState.animationIntensity*.15};this.updateNaturalCSSVariables(i)}getCurrentSeason(){let t=this.animationPhases.seasonalPhase%(2*Math.PI)/(2*Math.PI);return t<.25?"spring-awakening":t<.5?"summer-warmth":t<.75?"autumn-grounding":"winter-peace"}blendBreathingColors(e,t,i){let a=Math.max(0,Math.min(1,i));return{r:Math.round(e.r*(1-a)+t.r*a),g:Math.round(e.g*(1-a)+t.g*a),b:Math.round(e.b*(1-a)+t.b*a)}}generateBreathingColors(e,t){let i=this.naturalPalettes["spring-awakening"];return t<4e3?i=this.naturalPalettes["winter-peace"]:t>7e3?i=this.naturalPalettes["summer-warmth"]:t>5500&&(i=this.naturalPalettes["autumn-grounding"]),{warmTone:i.earthyWarm,coolTone:i.forestGreen,accentBlue:i.skyBlue,highlightGlow:i.sunsetGlow,neutralGray:i.stoneGray,transparency:this.effectState.harmonyLevel}}updateNaturalColors(e){this.services?.cssVariables?this.services.cssVariables.queueBatchUpdate({"--sn-animation-warm-r":e.warmTone.r.toString(),"--sn-animation-warm-g":e.warmTone.g.toString(),"--sn-animation-warm-b":e.warmTone.b.toString(),"--sn-animation-cool-r":e.coolTone.r.toString(),"--sn-animation-cool-g":e.coolTone.g.toString(),"--sn-animation-cool-b":e.coolTone.b.toString()}):(this.cssController.queueCSSVariableUpdate("--sn-animation-warm-r",e.warmTone.r.toString()),this.cssController.queueCSSVariableUpdate("--sn-animation-warm-g",e.warmTone.g.toString()),this.cssController.queueCSSVariableUpdate("--sn-animation-warm-b",e.warmTone.b.toString()),this.cssController.queueCSSVariableUpdate("--sn-animation-cool-r",e.coolTone.r.toString()),this.cssController.queueCSSVariableUpdate("--sn-animation-cool-g",e.coolTone.g.toString()),this.cssController.queueCSSVariableUpdate("--sn-animation-cool-b",e.coolTone.b.toString()))}async initializeBreathingElements(){let e=[".main-view-container",".Root__now-playing-bar",".main-trackInfo-container",".progress-bar",".Root__nav-bar"];for(let t of e){let i=document.querySelectorAll(t);for(let a of i){let r=`natural-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;this.naturalElements.set(r,a)}}}setupBreathingCSSVariables(){let e={"--sn-animation-earthy-r":"166","--sn-animation-earthy-g":"227","--sn-animation-earthy-b":"161","--sn-animation-forest-r":"64","--sn-animation-forest-g":"160","--sn-animation-forest-b":"43","--sn-animation-sky-r":"137","--sn-animation-sky-g":"220","--sn-animation-sky-b":"235","--sn-animation-serenity-level":"0","--sn-animation-animation-frequency":"0.4","--sn-animation-earth-connection":"0","--sn-animation-animation-depth":"0.8","--sn-animation-seasonal-shift":"0"};if(this.services?.cssVariables)this.services.cssVariables.queueBatchUpdate(e);else for(let[t,i]of Object.entries(e))this.cssController.queueCSSVariableUpdate(t,i)}updateNaturalCSSVariables(e){let t=Math.sin(this.animationPhases.animationPhase)*this.effectState.animationDepth,i={"--sn-animation-animation-intensity":this.effectState.animationIntensity.toString(),"--sn-animation-animation-frequency":this.effectState.animationFrequency.toString(),"--sn-animation-grounding":this.effectState.grounding.toString(),"--sn-animation-animation-depth":this.effectState.animationDepth.toString(),"--sn-animation-color-shift":this.effectState.colorShift.toString(),"--sn-animation-animation-phase":t.toString()};this.services?.cssVariables?this.services.cssVariables.queueBatchUpdate(i):Object.entries(i).forEach(([a,r])=>{this.cssController.queueCSSVariableUpdate(a,r)})}updateBreathingElements(){for(let[e,t]of this.naturalElements)this.updateNaturalElement(t)}updateNaturalElement(e){this.effectState.animationIntensity>.1&&this.applyNaturalBreathing(e),this.effectState.grounding>.1&&this.applyEarthConnection(e),this.effectState.ambientLevel>.1&&this.applyForestAtmosphere(e)}applyNaturalBreathing(e){let t=this.effectState.animationIntensity,i=Math.sin(this.animationPhases.animationPhase),a=1+i*t*.02,r=.9+i*t*.1;e.style.transform=`scale(${a})`,e.style.opacity=r.toString();let n=t*(i*.5+.5)*.3;e.style.boxShadow=`
      0 0 ${n*20}px rgba(var(--sn-animation-earthy-r), var(--sn-animation-earthy-g), var(--sn-animation-earthy-b), ${n*.5}),
      inset 0 0 ${n*10}px rgba(var(--sn-animation-forest-r), var(--sn-animation-forest-g), var(--sn-animation-forest-b), ${n*.3})
    `}applyEarthConnection(e){let t=this.effectState.grounding;e.style.border=`1px solid rgba(var(--sn-animation-earthy-r), var(--sn-animation-earthy-g), var(--sn-animation-earthy-b), ${t*.4})`,e.style.background=`
      ${e.style.background||""},
      linear-gradient(180deg,
        rgba(var(--sn-animation-earthy-r), var(--sn-animation-earthy-g), var(--sn-animation-earthy-b), ${t*.05}) 0%,
        rgba(var(--sn-animation-forest-r), var(--sn-animation-forest-g), var(--sn-animation-forest-b), ${t*.08}) 100%
      )
    `}applyForestAtmosphere(e){let t=this.effectState.ambientLevel,i=this.animationPhases.variationPhase,a=Math.sin(i*.8)*t*1;e.style.transform+=` translateY(${a}px)`;let r=Math.sin(i*.5)*t*5;e.style.filter=`hue-rotate(${r}deg) saturate(${1+t*.2})`}createSeasonalTransition(e,t,i){let a=performance.now(),r=n=>{let s=n-a,o=Math.min(1,s/i),l=.5*(1-Math.cos(o*Math.PI));this.effectState.colorShift=l,o<1&&requestAnimationFrame(r)};requestAnimationFrame(r)}startBreathingAnimation(){this.animationPhases.isAnimating=!0,this.animationPhases.lastFrameTime=performance.now();let e=t=>{if(!this.animationPhases.isAnimating)return;let i=t-this.animationPhases.lastFrameTime;this.animationPhases.lastFrameTime=t,this.updateAnimation(i),requestAnimationFrame(e)};requestAnimationFrame(e)}updatePerformanceMetrics(e){this.performanceMetrics.averageProcessingTime=this.performanceMetrics.averageProcessingTime*.9+e*.1}forceRepaint(e){console.log(`[AnimationEffectsController] Force repaint triggered: ${e||"Unknown"}`),this.updateBreathingElements(),this.services?.cssVariables?this.services.cssVariables.flushUpdates():this.cssController.flushCSSVariableBatch()}destroy(){console.log("[AnimationEffectsController] Shutting down animation effects system..."),this.services?.events&&this.services.events.cleanupSystem("AnimationEffectsController"),this.animationPhases.isAnimating=!1,this.naturalElements.clear(),this.effectState={animationIntensity:0,animationFrequency:.4,animationDepth:.8,grounding:0,warmth:.7,ambientLevel:0,colorShift:0,harmonyLevel:0},this.initialized=!1}getBreathingState(){return{...this.effectState}}getAnimationConfig(){return{...this.harmonyConfig}}getPerformanceMetrics(){return{...this.performanceMetrics,naturalElementCount:this.naturalElements.size}}setCalmThreshold(e){this.harmonyConfig.calmThreshold=Math.max(0,Math.min(1,e))}setBreathingDepth(e){this.effectState.animationDepth=Math.max(0,Math.min(1,e))}setColorStrength(e){this.harmonyConfig.colorStrength=Math.max(0,Math.min(1,e))}}});var Ht,Os=y(()=>{"use strict";Ss();ue();x();Cs();As();xs();Is();Ds();br();Bs();Vs();Fs();Gs();Hs();_s();zs();Us();Ht=class{constructor(e,t,i,a,r,n,s,o,l,m){this.systemName="VisualSystemCoordinator";this.initialized=!1;this.colorHarmonyEngine=null;this.eventBus=null;this.animationCoordinator=null;this.isInitialized=!1;this.lastHealthCheck=null;this.boundAdaptationHandler=null;this.boundSettingsHandler=null;this.healthCheckInterval=null;this.metricsUpdateInterval=null;this.fpsHistory=[];this.onSystemAdaptation=null;this.onHealthChange=null;this.onSystemCreated=null;this.config=e,this.utils=t,this.year3000System=i,this.cssVariableController=a,this.performanceAnalyzer=r,this.musicSyncService=n,this.settingsManager=s,this.colorHarmonyEngine=o||null,this.eventBus=l||null,this.animationCoordinator=m||null,this.deviceDetector=new N,this.systemRegistry=new Map,this.systemCache=new Map,this.systemDependencies=new Map,this.bridgeConfig={mode:"progressive",enablePerformanceMonitoring:!0,enableAdaptiveQuality:!0,enableEventCoordination:!0,performanceThresholds:{minFPS:45,maxMemoryMB:50,thermalLimit:70},qualityPreferences:{preferHighQuality:!0,allowDynamicScaling:!0,batteryConservation:!1}},this.currentMetrics=this.createInitialMetrics(),this.boundAdaptationHandler=this.handleAdaptationEvent.bind(this),this.boundSettingsHandler=this.handleSettingsChange.bind(this),this.registerVisualSystems(),u?.debug?.log("VisualSystemFacade","Factory facade initialized with visual systems")}registerVisualSystems(){this.systemRegistry.set("SidebarVisualEffects",ft),this.systemDependencies.set("SidebarVisualEffects",["eventBus","musicSyncService"]),this.systemRegistry.set("UIVisualEffects",_i),this.systemDependencies.set("UIVisualEffects",["eventBus","musicSyncService","cssVariableController"]),this.systemRegistry.set("HeaderVisualEffects",zi),this.systemDependencies.set("HeaderVisualEffects",["eventBus","musicSyncService","colorHarmonyEngine"]),this.systemRegistry.set("WebGLBackground",Vt),this.systemDependencies.set("WebGLBackground",["performanceAnalyzer","eventBus"]),this.systemRegistry.set("CSSBlobFallback",Hi),this.systemDependencies.set("CSSBlobFallback",["performanceAnalyzer","musicSyncService","settingsManager"]),this.systemRegistry.set("MusicBeatSync",Ui),this.systemDependencies.set("MusicBeatSync",["performanceAnalyzer","cssVariableController","eventBus","musicSyncService","colorHarmonyEngine"]),this.systemRegistry.set("InteractionTracking",Ni),this.systemDependencies.set("InteractionTracking",["performanceAnalyzer","cssVariableController"]),this.systemRegistry.set("SpotifyUIApplication",$i),this.systemDependencies.set("SpotifyUIApplication",["year3000System"]),this.systemRegistry.set("CinematicDrama",Wi),this.systemDependencies.set("CinematicDrama",["performanceAnalyzer","cssVariableController","musicSyncService","colorHarmonyEngine","eventBus"]),this.systemRegistry.set("EtherealBeauty",Gt),this.systemDependencies.set("EtherealBeauty",["performanceAnalyzer","cssVariableController","musicSyncService","colorHarmonyEngine","eventBus"]),this.systemRegistry.set("NaturalHarmony",qi),this.systemDependencies.set("NaturalHarmony",["performanceAnalyzer","cssVariableController","musicSyncService","colorHarmonyEngine","eventBus"]),this.systemRegistry.set("GradientConductor",Ft),this.systemDependencies.set("GradientConductor",["cssVariableController","colorHarmonyEngine","musicSyncService","performanceAnalyzer","eventBus"]),this.systemRegistry.set("CSSAnimationManager",Fi),this.systemDependencies.set("CSSAnimationManager",["cssVariableController","animationCoordinator"]),this.systemRegistry.set("GlowEffects",Gt),this.systemDependencies.set("GlowEffects",["performanceAnalyzer","cssVariableController","musicSyncService","colorHarmonyEngine","eventBus"]),this.systemRegistry.set("UnifiedParticle",ft),this.systemDependencies.set("UnifiedParticle",["eventBus","musicSyncService"]),this.systemRegistry.set("DepthLayeredGradient",Ft),this.systemDependencies.set("DepthLayeredGradient",["cssVariableController","colorHarmonyEngine","musicSyncService","performanceAnalyzer","eventBus"]),this.systemRegistry.set("FluidGradientBackground",Vt),this.systemDependencies.set("FluidGradientBackground",["performanceAnalyzer","eventBus"])}async initialize(e){if(this.isInitialized){u?.debug?.warn("VisualSystemFacade","Already initialized");return}try{this.bridgeConfig={...this.bridgeConfig,...e},await this.deviceDetector.initialize(),await this.applyConfiguration(),this.subscribeToEvents(),this.startMonitoring(),await this.performVisualHealthCheck(),this.isInitialized=!0,this.initialized=!0,this.cssVariableController.queueCSSVariableUpdate("--sn-visual-bridge-active","1"),this.cssVariableController.queueCSSVariableUpdate("--sn-visual-bridge-mode",this.bridgeConfig.mode),u?.debug?.log("VisualSystemFacade","Facade fully initialized",{mode:this.bridgeConfig.mode,systemsRegistered:this.systemRegistry.size,performanceMonitoring:this.bridgeConfig.enablePerformanceMonitoring})}catch(t){throw u?.debug?.error("VisualSystemFacade","Initialization failed:",t),await this.cleanup(),t}}getVisualSystem(e){if(this.systemCache.has(e))return this.systemCache.get(e);let t=this.createVisualSystem(e);return this.systemCache.set(e,t),this.currentMetrics.activeVisualSystems.push(e),this.onSystemCreated&&this.onSystemCreated(e,t),t}createVisualSystem(e){let t=this.systemRegistry.get(e);if(!t)throw new Error(`Visual system '${e}' not found in registry`);let i=new t(this.config);if(typeof i._baseInitialize=="function"){let r=i;return this.injectUnifiedSystemDependencies(r,e),r}if(e==="SpotifyUIApplication"){let r=new t(this.year3000System);return this.injectDependencies(r,e),r}if(e==="GradientConductor"){let r=new t(this.eventBus,this.cssVariableController,this.colorHarmonyEngine,this.musicSyncService,this.performanceAnalyzer,{});return this.injectDependencies(r,e),r}if(e==="CSSAnimationManager"){let r=new t(this.config,this.cssVariableController,this.animationCoordinator);return this.injectDependencies(r,e),r}if(e==="CinematicDrama"||e==="EtherealBeauty"||e==="NaturalHarmony"){let r=new Gi,n=new Oi(r,this.settingsManager,this.musicSyncService),s=new t(n,this.cssVariableController,this.musicSyncService);return this.injectDependencies(s,e),s}let a=new t(this.config,this.utils,this.performanceAnalyzer,this.musicSyncService,this.settingsManager,this.year3000System);return this.injectDependencies(a,e),a}injectDependencies(e,t){let i=this.systemDependencies.get(t)||[];i.includes("performanceAnalyzer")&&e.setPerformanceAnalyzer&&e.setPerformanceAnalyzer(this.performanceAnalyzer),i.includes("cssVariableController")&&e.setOptimizedCSSVariableManager&&e.setOptimizedCSSVariableManager(this.cssVariableController),i.includes("eventBus")&&this.eventBus&&e.setEventBus&&e.setEventBus(this.eventBus),this.colorHarmonyEngine&&e.setColorHarmonyEngine&&e.setColorHarmonyEngine(this.colorHarmonyEngine),i.includes("musicSyncService")&&e.setMusicSyncService&&e.setMusicSyncService(this.musicSyncService),i.includes("animationCoordinator")&&this.animationCoordinator&&e.setAnimationCoordinator&&e.setAnimationCoordinator(this.animationCoordinator),this.integratePerformanceMonitoring(e,t)}injectUnifiedSystemDependencies(e,t){this.cssVariableController&&(e.cssVariableController=this.cssVariableController),this.performanceAnalyzer&&(e.performanceAnalyzer=this.performanceAnalyzer),this.year3000System&&(globalThis.year3000System=this.year3000System),this.integratePerformanceMonitoring(e,t)}integratePerformanceMonitoring(e,t){if(!this.bridgeConfig.enablePerformanceMonitoring)return;let i=e.updateAnimation;typeof i=="function"&&(e.updateAnimation=r=>{let n=performance.now();i.call(e,r);let s=performance.now();this.performanceAnalyzer.recordMetric(`Visual_${t}`,s-n)});let a=e.onAnimate;typeof a=="function"&&(e.onAnimate=r=>{let n=performance.now();a.call(e,r);let s=performance.now();this.performanceAnalyzer.recordMetric(`Visual_${t}_Animate`,s-n)})}adaptiveQualityControl(e,t){this.eventBus&&(this.eventBus.subscribe("performance:degradation",i=>{e.reduceQuality&&e.reduceQuality(i.reductionLevel)}),this.eventBus.subscribe("performance:improvement",i=>{e.increaseQuality&&e.increaseQuality(i.improvementLevel)}))}handleAdaptationEvent(e){u?.debug?.log("VisualSystemFacade",`Adaptation event: ${e.type}`,e.reason),this.currentMetrics.currentQuality=e.newSettings,this.systemCache.forEach((t,i)=>{t.handleAdaptationEvent&&t.handleAdaptationEvent(e)}),this.onSystemAdaptation&&this.onSystemAdaptation(this.currentMetrics),this.cssVariableController.queueCSSVariableUpdate("--sn-adaptive-quality",(e.newSettings.gradientComplexity||0).toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-adaptive-fps",(e.newSettings.animationFPS||60).toString())}propagateVisualEvent(e){this.bridgeConfig.enableEventCoordination&&(this.systemCache.forEach((t,i)=>{if(t.handleVisualEvent)try{t.handleVisualEvent(e)}catch(a){u?.debug?.warn("VisualSystemFacade",`Error propagating event to ${i}:`,a)}}),this.currentMetrics.eventCount++,this.currentMetrics.lastEventTime=performance.now())}async initializeVisualSystems(){let e=Array.from(this.systemCache.entries()).map(async([a,r])=>{try{return typeof r._baseInitialize=="function"?await r._baseInitialize():await r.initialize(),u?.debug?.log("VisualSystemFacade",`Initialized visual system: ${a}`),{key:a,success:!0}}catch(n){return u?.debug?.error("VisualSystemFacade",`Failed to initialize ${a}:`,n),{key:a,success:!1,error:n}}}),t=await Promise.allSettled(e),i=t.filter(a=>a.status==="fulfilled"&&a.value.success).length;u?.debug?.log("VisualSystemFacade",`Visual systems initialized: ${i}/${t.length}`),await this.registerQualityScalingSystems()}async registerQualityScalingSystems(){try{let e=this.year3000System?.getCachedNonVisualSystem?.("SimplePerformanceCoordinator"),t=this.year3000System?.getCachedNonVisualSystem?.("QualityScalingManager");if(!e){u?.debug?.warn("VisualSystemFacade","SimplePerformanceCoordinator not available for quality scaling registration");return}if(!t){u?.debug?.warn("VisualSystemFacade","QualityScalingManager not available for quality scaling registration");return}for(let[i,a]of this.systemCache.entries())try{let r=a;typeof r.setQualityLevel=="function"&&typeof r.getPerformanceImpact=="function"&&typeof r.getQualityCapabilities=="function"&&(e.registerSystem(i,r),t.registerSystem(i,r),u?.debug?.log("VisualSystemFacade",`Registered ${i} for quality scaling and performance coordination`))}catch(r){u?.debug?.error("VisualSystemFacade",`Failed to register ${i} for quality scaling:`,r)}await this.initializeConsciousnessAwareAdaptation(t)}catch(e){u?.debug?.error("VisualSystemFacade","Failed to register quality scaling systems:",e)}}async initializeConsciousnessAwareAdaptation(e){try{let t=this.year3000System?.getCachedNonVisualSystem?.("MusicSyncService");if(!t){u?.debug?.warn("VisualSystemFacade","MusicSyncService not available for music-aware adaptation");return}let i=setInterval(()=>{try{let a=t.getOverallIntensity?.()||.5,r=t.getBeatStrength?.()||.5;e.adaptToMusicIntensity(a,r)}catch(a){u?.debug?.error("VisualSystemFacade","Error in music-aware adaptation:",a)}},2e3);this._musicAdaptationInterval=i,u?.debug?.log("VisualSystemFacade","Consciousness-aware quality adaptation initialized")}catch(t){u?.debug?.error("VisualSystemFacade","Failed to initialize music-aware adaptation:",t)}}async performVisualHealthCheck(){let e={overall:"good",systems:new Map,recommendations:[],timestamp:performance.now()},t=0,i=0;for(let[r,n]of this.systemCache){i++;try{let s=n.healthCheck?await n.healthCheck():{status:"unknown",message:"No health check available"},o=s.status==="healthy"||s.status==="good";o&&t++,e.systems.set(r,{ok:o,details:s.message||s.details||"System operational"})}catch(s){e.systems.set(r,{ok:!1,details:`Health check failed: ${s}`})}}let a=i>0?t/i:1;return a>=.9?e.overall="excellent":a>=.7?e.overall="good":a>=.5?(e.overall="degraded",e.recommendations.push("Some visual systems are experiencing issues")):(e.overall="critical",e.recommendations.push("Multiple visual system failures detected")),this.currentMetrics.currentFPS<30&&e.recommendations.push("Low FPS detected - consider reducing visual quality"),this.currentMetrics.memoryUsageMB>40&&e.recommendations.push("High memory usage - consider optimizing visual systems"),this.lastHealthCheck=e,this.cssVariableController.queueCSSVariableUpdate("--sn-visual-health",e.overall),e}async applyConfiguration(){}subscribeToEvents(){this.settingsManager&&this.boundSettingsHandler&&document.addEventListener("year3000SystemSettingsChanged",this.boundSettingsHandler)}startMonitoring(){this.bridgeConfig.enablePerformanceMonitoring&&(this.healthCheckInterval=window.setInterval(async()=>{await this.performVisualHealthCheck()},1e4),this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},1e3))}createInitialMetrics(){return{currentFPS:60,averageFPS:60,frameTime:16.67,memoryUsageMB:0,systemHealth:"excellent",activeVisualSystems:[],currentQuality:{level:"medium",gradientComplexity:.7,particleDensity:100,animationFPS:60,postProcessing:!0,bloomEnabled:!0,antiAliasing:"fxaa",shadowQuality:"medium",shaderPrecision:"medium"},adaptiveScaling:!0,performanceMonitoring:!0,eventCoordination:!0,lastEventTime:0,eventCount:0}}updateMetrics(){let e=performance.now(),t=this.performanceAnalyzer.getMedianFPS()||0;this.currentMetrics.currentFPS=t,this.fpsHistory||(this.fpsHistory=[]),this.fpsHistory.push(t),this.fpsHistory.length>10&&this.fpsHistory.shift(),this.currentMetrics.averageFPS=this.fpsHistory.reduce((r,n)=>r+n,0)/this.fpsHistory.length,this.currentMetrics.frameTime=this.currentMetrics.currentFPS>0?1e3/this.currentMetrics.currentFPS:1e3;let i=performance.memory;i&&(this.currentMetrics.memoryUsageMB=i.usedJSHeapSize/(1024*1024)),this.currentMetrics.activeVisualSystems=Array.from(this.systemCache.keys()).filter(r=>{let n=this.systemCache.get(r);return n&&n.initialized}),this.currentMetrics.systemHealth=this.calculateSystemHealth(),this.bridgeConfig.enableAdaptiveQuality&&this.checkAdaptiveQualityTriggers();let a=performance.now()-e;a>5&&u?.debug?.warn("VisualSystemCoordinator",`Metrics update took ${a.toFixed(2)}ms - performance concern`),this.onSystemAdaptation&&this.onSystemAdaptation(this.currentMetrics)}calculateSystemHealth(){let{currentFPS:e,averageFPS:t,memoryUsageMB:i}=this.currentMetrics,a=100;return e<20?a-=40:e<30?a-=25:e<45&&(a-=10),Math.abs(e-t)>10&&(a-=15),i>this.bridgeConfig.performanceThresholds.maxMemoryMB?a-=20:i>this.bridgeConfig.performanceThresholds.maxMemoryMB*.8&&(a-=10),this.currentMetrics.activeVisualSystems.length>8&&(a-=10),a>=90?"excellent":a>=70?"good":a>=50?"degraded":"critical"}checkAdaptiveQualityTriggers(){let{systemHealth:e,currentFPS:t,memoryUsageMB:i}=this.currentMetrics;e==="critical"||t<this.bridgeConfig.performanceThresholds.minFPS?this.triggerQualityReduction():e==="excellent"&&t>58&&i<this.bridgeConfig.performanceThresholds.maxMemoryMB*.5&&this.triggerQualityImprovement()}triggerQualityReduction(){if(this.currentMetrics.currentQuality.level==="minimal")return;let e=this.currentMetrics.currentQuality.level==="high"?"medium":"minimal";this.updateQualitySettings(e),u?.debug?.log("VisualSystemCoordinator",`Adaptive quality reduced to ${e} due to performance constraints`)}triggerQualityImprovement(){if(this.currentMetrics.currentQuality.level==="high")return;let e=this.currentMetrics.currentQuality.level==="minimal"?"medium":"high";this.updateQualitySettings(e),u?.debug?.log("VisualSystemCoordinator",`Adaptive quality improved to ${e} due to excellent performance`)}updateQualitySettings(e){let t={minimal:{gradientComplexity:.3,particleDensity:25,animationFPS:30,postProcessing:!1,bloomEnabled:!1,antiAliasing:"none",shadowQuality:"off"},low:{gradientComplexity:.4,particleDensity:40,animationFPS:45,postProcessing:!1,bloomEnabled:!1,antiAliasing:"fxaa",shadowQuality:"medium"},medium:{gradientComplexity:.6,particleDensity:60,animationFPS:60,postProcessing:!0,bloomEnabled:!0,antiAliasing:"fxaa",shadowQuality:"medium"},high:{gradientComplexity:1,particleDensity:100,animationFPS:60,postProcessing:!0,bloomEnabled:!0,antiAliasing:"msaa4x",shadowQuality:"high"},ultra:{gradientComplexity:1.2,particleDensity:150,animationFPS:60,postProcessing:!0,bloomEnabled:!0,antiAliasing:"msaa4x",shadowQuality:"high"}};e&&t[e]&&(this.currentMetrics.currentQuality={level:e,...t[e]});for(let[i,a]of this.systemCache.entries())if(a&&a.initialized&&typeof a.updateQuality=="function")try{a.updateQuality(this.currentMetrics.currentQuality)}catch(r){u?.debug?.error("VisualSystemCoordinator",`Failed to update quality for ${i}:`,r)}}handleSettingsChange(e){let t=e,{key:i,value:a}=t.detail;i.startsWith("sn-visual-")&&this.updateConfigurationFromSettings(i,a)}updateConfigurationFromSettings(e,t){switch(e){case"sn-visual-quality":this.bridgeConfig.qualityPreferences.preferHighQuality=t==="high";break;case"sn-visual-performance":this.bridgeConfig.enableAdaptiveQuality=t==="adaptive";break}}async cleanup(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this._musicAdaptationInterval&&(clearInterval(this._musicAdaptationInterval),this._musicAdaptationInterval=null),this.boundSettingsHandler&&document.removeEventListener("year3000SystemSettingsChanged",this.boundSettingsHandler),this.cssVariableController.queueCSSVariableUpdate("--sn-visual-bridge-active","0")}getMetrics(){return{...this.currentMetrics}}getLastHealthCheck(){return this.lastHealthCheck}getConfiguration(){return{...this.bridgeConfig}}async setConfiguration(e){this.bridgeConfig={...this.bridgeConfig,...e},await this.applyConfiguration()}setOnSystemAdaptation(e){this.onSystemAdaptation=e}setOnHealthChange(e){this.onHealthChange=e}setOnSystemCreated(e){this.onSystemCreated=e}getSystemStatus(){return{initialized:this.isInitialized,systemsActive:this.systemCache.size,healthy:this.currentMetrics.systemHealth==="excellent"||this.currentMetrics.systemHealth==="good"}}updateAnimation(e){this.initialized&&this.systemCache.forEach((t,i)=>{try{typeof t.updateAnimation=="function"?t.updateAnimation(e):typeof t.onAnimate=="function"&&t.onAnimate(e)}catch(a){u?.debug?.error("VisualSystemCoordinator",`Error updating ${i}:`,a)}})}async healthCheck(){try{let e=await this.performVisualHealthCheck(),t;switch(e.overall){case"excellent":case"good":t="healthy";break;case"degraded":t="degraded";break;case"critical":t="critical";break;default:t="healthy"}return{healthy:t==="healthy",ok:t!=="critical",details:`Visual system coordinator health: ${e.overall} (${e.systems.size} systems)`,system:"VisualSystemCoordinator",issues:e.recommendations,metrics:{overall:e.overall,systemCount:e.systems.size,recommendations:e.recommendations,currentMetrics:this.currentMetrics,status:t}}}catch(e){return{healthy:!1,ok:!1,details:`Health check failed: ${e}`,system:"VisualSystemCoordinator",issues:["Health check exception"],metrics:{error:String(e)}}}}forceRepaint(e){u?.debug?.log("VisualSystemCoordinator",`Force repaint requested${e?`: ${e}`:""}`),this.systemCache.forEach((t,i)=>{try{typeof t.forceRepaint=="function"?t.forceRepaint(e):typeof t.refresh=="function"&&t.refresh()}catch(a){u?.debug?.warn("VisualSystemCoordinator",`Error force repainting ${i}:`,a)}}),this.cssVariableController&&"flushPendingUpdates"in this.cssVariableController&&this.cssVariableController.flushPendingUpdates()}async destroy(){await this.cleanup(),this.isInitialized=!1,this.initialized=!1,this.systemCache.clear(),u?.debug?.log("VisualSystemCoordinator","Facade destroyed")}}});var _t,Ns=y(()=>{"use strict";Oa();pi();$();vs();Ja();Ci();er();ue();Ti();x();Fe();ka();Os();_t=class{constructor(e,t,i){this.visualBridge=null;this.nonVisualFacade=null;this.sharedUnifiedCSSVariableManager=null;this.sharedSimplePerformanceCoordinator=null;this.sharedWebGLSystemsIntegration=null;this.sharedEnhancedDeviceTierDetector=null;this.sharedDeviceCapabilityDetector=null;this.sharedPerformanceBudgetManager=null;this.sharedMusicSyncService=null;this.sharedSettingsManager=null;this.sharedColorHarmonyEngine=null;this.sharedSemanticColorManager=null;this.isInitialized=!1;this.lastHealthCheck=null;this.colorDependentSystems=new Set;this.colorSystemRefreshCallbacks=new Map;this.currentPhase="core";this.systemStates=new Map;this.phaseCompletionPromises=new Map;this.systemDependencies=new Map;this.initializationOrder=new Map;this.eventBus=null;this.crossFacadeEventListeners=new Map;this.healthCheckInterval=null;this.metricsUpdateInterval=null;this.onSystemCreated=null;this.onHealthChange=null;this.onPerformanceChange=null;this.config=e,this.utils=t,this.year3000System=i,this.coordinationConfig={mode:"unified",enableSharedDependencies:!0,enableCrossFacadeCommunication:!0,enableUnifiedPerformanceMonitoring:!0,enableResourceOptimization:!0,coordination:{enforceSequentialInitialization:!0,dependencyValidation:!0,enableInitializationGates:!0,systemReadinessTimeout:5e3,phaseTransitionTimeout:1e4},performanceThresholds:{maxTotalMemoryMB:150,maxTotalInitTime:8e3,maxCrossCommLatency:10},coordinationPreferences:{preferSharedResources:!0,enableEventPropagation:!0,enableHealthCoordination:!0}},this.setupCoordinationPhases(),this.currentMetrics=this.createInitialMetrics(),u?.debug?.log("SystemCoordinator","System coordinator initialized")}async initialize(e){if(this.isInitialized){u?.debug?.warn("SystemCoordinator","Already initialized");return}try{let t=performance.now();this.coordinationConfig={...this.coordinationConfig,...e},this.coordinationConfig.coordination.enforceSequentialInitialization?(u?.debug?.log("SystemCoordinator","Starting coordinated initialization"),await this.executeCoordinatedInitialization()):(u?.debug?.log("SystemCoordinator","Starting legacy initialization"),await this.executeLegacyInitialization());let i=performance.now();this.currentMetrics.totalInitTime=i-t,this.isInitialized=!0,u?.debug?.log("SystemCoordinator","System coordination fully initialized",{mode:this.coordinationConfig.mode,coordinationEnabled:this.coordinationConfig.coordination.enforceSequentialInitialization,currentPhase:this.currentPhase,visualSystems:this.currentMetrics.visualSystems,nonVisualSystems:this.currentMetrics.nonVisualSystems,initTime:this.currentMetrics.totalInitTime})}catch(t){throw u?.debug?.error("SystemCoordinator","Initialization failed:",t),await this.cleanup(),t}}async initializeSharedDependencies(){if(this.coordinationConfig.enableSharedDependencies){u?.debug?.log("SystemCoordinator","Initializing simplified shared dependencies");try{this.sharedDeviceCapabilityDetector=new N({enableDebug:!0,spicetifyContext:!0}),await this.sharedDeviceCapabilityDetector.initialize(),this.sharedEnhancedDeviceTierDetector=new me,this.sharedWebGLSystemsIntegration=new et(this.sharedDeviceCapabilityDetector),await this.sharedWebGLSystemsIntegration.initialize(),this.sharedDeviceCapabilityDetector=new N({enableDebug:this.config.enableDebug||!1,runStressTests:!1}),await this.sharedDeviceCapabilityDetector.initialize(),this.sharedPerformanceBudgetManager=new Ae({budgets:{animationFrame:16,cssVariableUpdate:2,domObservation:1,audioAnalysis:5,visualEffects:8,userInteraction:100},autoOptimize:{enabled:!0,violationThreshold:3,recoveryThreshold:.8},enableDebug:this.config.enableDebug||!1},this.sharedSimplePerformanceCoordinator),this.sharedSimplePerformanceCoordinator=new he(this.sharedEnhancedDeviceTierDetector,this.sharedWebGLSystemsIntegration),await this.sharedSimplePerformanceCoordinator.initialize();try{let e=this.sharedSimplePerformanceCoordinator;this.sharedUnifiedCSSVariableManager=new Ee(this.config,e,{enableAdaptiveThrottling:!0,batchIntervalMs:16,maxBatchSize:50,priorityMappings:{critical:["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift","--sn-enhanced-base-hex","--sn-enhanced-accent-hex"],high:["--sn-gradient-primary","--sn-gradient-secondary","--sn-gradient-accent","--sn-color-base-hex","--sn-color-accent-hex"],normal:["--sn-gradient-","--sn-rs-","--sn-color-"],low:["--sn-debug-","--sn-dev-","--sn-meta-"]},thresholds:{excellentFPS:55,goodFPS:45,poorFPS:30}}),Da(this.sharedUnifiedCSSVariableManager),await this.sharedUnifiedCSSVariableManager.initialize()}catch(e){u?.debug?.warn("SystemCoordinator","Failed to initialize OptimizedCSSVariableManager:",e),this.sharedUnifiedCSSVariableManager=null}this.sharedSettingsManager=new ee,await this.sharedSettingsManager.initialize(),this.sharedMusicSyncService=new we,await this.sharedMusicSyncService.initialize(),this.sharedColorHarmonyEngine=new Xe(this.config,this.utils,this.sharedSimplePerformanceCoordinator,this.sharedSettingsManager),await this.sharedColorHarmonyEngine.initialize(),u?.debug?.log("SystemCoordinator","Shared dependencies initialized successfully")}catch(e){throw u?.debug?.error("SystemCoordinator","Failed to initialize shared dependencies:",e),e}}}async initializeFacades(){u?.debug?.log("SystemCoordinator","Initializing facades");try{let e=this.nonVisualFacade?.getCachedSystem("EnhancedMasterAnimationCoordinator")||null;this.visualBridge=new Ht(this.config,this.utils,this.year3000System,this.sharedUnifiedCSSVariableManager,this.sharedSimplePerformanceCoordinator,this.sharedMusicSyncService,this.sharedSettingsManager,this.sharedColorHarmonyEngine,this.eventBus,e),await this.visualBridge.initialize({mode:this.coordinationConfig.mode==="performance-optimized"?"performance-first":"progressive",enablePerformanceMonitoring:this.coordinationConfig.enableUnifiedPerformanceMonitoring,enableEventCoordination:this.coordinationConfig.enableCrossFacadeCommunication}),this.visualBridge.setOnSystemCreated((t,i)=>{this.handleSystemCreated("visual",t,i)}),this.nonVisualFacade=new Bt(this.config,this.utils,this.year3000System),await this.nonVisualFacade.initialize({mode:this.coordinationConfig.mode==="performance-optimized"?"performance-first":"progressive",enablePerformanceMonitoring:this.coordinationConfig.enableUnifiedPerformanceMonitoring,enableDependencyInjection:this.coordinationConfig.enableSharedDependencies}),this.nonVisualFacade.setOnSystemCreated((t,i)=>{this.handleSystemCreated("non-visual",t,i)}),this.injectSharedDependencies(),u?.debug?.log("SystemCoordinator","Facades initialized successfully")}catch(e){throw u?.debug?.error("SystemCoordinator","Failed to initialize facades:",e),e}}injectSharedDependencies(){!this.coordinationConfig.enableSharedDependencies||!this.nonVisualFacade||(this.sharedSimplePerformanceCoordinator&&(this.nonVisualFacade.simplePerformanceCoordinator=this.sharedSimplePerformanceCoordinator),this.sharedWebGLSystemsIntegration&&(this.nonVisualFacade.webglSystemsIntegration=this.sharedWebGLSystemsIntegration),this.sharedEnhancedDeviceTierDetector&&(this.nonVisualFacade.enhancedDeviceTierDetector=this.sharedEnhancedDeviceTierDetector),this.sharedSimplePerformanceCoordinator&&(this.nonVisualFacade.performanceAnalyzer=this.sharedSimplePerformanceCoordinator),this.sharedUnifiedCSSVariableManager&&(this.nonVisualFacade.cssVariableController=this.sharedUnifiedCSSVariableManager),this.sharedMusicSyncService&&(this.nonVisualFacade.musicSyncService=this.sharedMusicSyncService),this.sharedSettingsManager&&(this.nonVisualFacade.settingsManager=this.sharedSettingsManager),this.sharedColorHarmonyEngine&&(this.nonVisualFacade.colorHarmonyEngine=this.sharedColorHarmonyEngine),this.sharedSemanticColorManager&&(this.nonVisualFacade.semanticColorManager=this.sharedSemanticColorManager))}setupCrossFacadeCommunication(){this.coordinationConfig.enableCrossFacadeCommunication&&(u?.debug?.log("SystemCoordinator","Setting up cross-facade communication"),this.addEventListener("visual-event",e=>{this.visualBridge&&this.visualBridge.propagateVisualEvent(e)}),this.addEventListener("performance-event",e=>{this.visualBridge&&this.visualBridge.handleAdaptationEvent(e)}),this.coordinationConfig.coordinationPreferences.enableHealthCoordination&&this.addEventListener("health-degradation",e=>{this.handleHealthDegradation(e)}))}handleSystemCreated(e,t,i){e==="visual"?this.currentMetrics.visualSystems++:this.currentMetrics.nonVisualSystems++,this.currentMetrics.activeSystems++,this.onSystemCreated&&this.onSystemCreated(e,t,i),u?.debug?.log("SystemCoordinator",`System created: ${e}/${t}`)}handleHealthDegradation(e){u?.debug?.warn("SystemCoordinator","Health degradation detected:",e),this.coordinationConfig.mode==="performance-optimized"&&this.optimizeForPerformance()}optimizeForPerformance(){this.visualBridge&&this.visualBridge.setConfiguration({mode:"performance-first",enableAdaptiveQuality:!0,qualityPreferences:{preferHighQuality:!1,allowDynamicScaling:!0,batteryConservation:!0}}),this.nonVisualFacade&&this.nonVisualFacade.setConfiguration({mode:"performance-first",systemPreferences:{lazyInitialization:!0,aggressiveCaching:!0,performanceOptimization:!0}})}getVisualSystem(e){return this.visualBridge?this.visualBridge.getVisualSystem(e):null}getCachedNonVisualSystem(e){return this.nonVisualFacade?this.nonVisualFacade.getCachedSystem(e):null}async getNonVisualSystem(e){return this.nonVisualFacade?await this.nonVisualFacade.getSystem(e):null}async getSystem(e){if(this.visualBridge)try{return this.visualBridge.getVisualSystem(e)}catch{}if(this.nonVisualFacade)try{return await this.nonVisualFacade.getSystem(e)}catch{}return null}addEventListener(e,t){this.crossFacadeEventListeners.has(e)||this.crossFacadeEventListeners.set(e,[]),this.crossFacadeEventListeners.get(e).push(t)}removeEventListener(e,t){let i=this.crossFacadeEventListeners.get(e);if(i){let a=i.indexOf(t);a!==-1&&i.splice(a,1)}}emitEvent(e,t){let i=this.crossFacadeEventListeners.get(e);i&&i.forEach(a=>{try{a(t)}catch(r){u?.debug?.error("SystemCoordinator",`Error in event listener for ${e}:`,r)}}),this.currentMetrics.crossFacadeEvents++}async performHealthCheck(){let e={overall:"good",facades:{visual:{ok:!0,details:"Visual systems operational",systemCount:0},nonVisual:{ok:!0,details:"Non-visual systems operational",systemCount:0}},sharedResources:{simplePerformanceCoordinator:{ok:!0,details:"Simple performance coordinator operational"},cssVariableController:{ok:!0,details:"CSS variable batcher operational"},musicSyncService:{ok:!0,details:"Music sync service operational"},performanceAnalyzer:{ok:!0,details:"Legacy performance analyzer operational"}},recommendations:[],timestamp:performance.now()};if(this.visualBridge)try{let a=await this.visualBridge.performVisualHealthCheck();e.facades.visual.ok=a.overall==="excellent"||a.overall==="good",e.facades.visual.details=`Visual systems: ${a.overall}`,e.facades.visual.systemCount=a.systems.size}catch(a){e.facades.visual.ok=!1,e.facades.visual.details=`Visual facade error: ${a}`}if(this.nonVisualFacade)try{let a=await this.nonVisualFacade.performHealthCheck();e.facades.nonVisual.ok=a.overall==="excellent"||a.overall==="good",e.facades.nonVisual.details=`Non-visual systems: ${a.overall}`,e.facades.nonVisual.systemCount=a.systems.size}catch(a){e.facades.nonVisual.ok=!1,e.facades.nonVisual.details=`Non-visual facade error: ${a}`}if(this.sharedSimplePerformanceCoordinator)try{let a=await this.sharedSimplePerformanceCoordinator.healthCheck();e.sharedResources.simplePerformanceCoordinator.ok=a.healthy,e.sharedResources.simplePerformanceCoordinator.details=a.details||"Simple performance coordinator operational"}catch(a){e.sharedResources.simplePerformanceCoordinator.ok=!1,e.sharedResources.simplePerformanceCoordinator.details=`Simple performance coordinator error: ${a}`}if(this.sharedSimplePerformanceCoordinator)try{let a=await this.sharedSimplePerformanceCoordinator.healthCheck();e.sharedResources.performanceAnalyzer={ok:a.healthy,details:a.details||"Simple performance coordinator operational"}}catch(a){e.sharedResources.performanceAnalyzer={ok:!1,details:`Simple performance coordinator error: ${a}`}}if(this.sharedUnifiedCSSVariableManager)try{let a=await this.sharedUnifiedCSSVariableManager.healthCheck();e.sharedResources.cssVariableController.ok=a.healthy||a.ok||!1,e.sharedResources.cssVariableController.details=a.details||"CSS variable controller operational"}catch(a){e.sharedResources.cssVariableController.ok=!1,e.sharedResources.cssVariableController.details=`CSS variable controller error: ${a}`}if(this.sharedMusicSyncService)try{let a=await this.sharedMusicSyncService.healthCheck();e.sharedResources.musicSyncService.ok=a.status==="healthy",e.sharedResources.musicSyncService.details=a.message||"Music sync service operational"}catch(a){e.sharedResources.musicSyncService.ok=!1,e.sharedResources.musicSyncService.details=`Music sync service error: ${a}`}if(this.sharedSemanticColorManager)try{let a=await this.sharedSemanticColorManager.healthCheck(),r=a.healthy;e.sharedResources.semanticColorManager={ok:r,details:a.details||"Semantic color manager operational"}}catch(a){e.sharedResources.semanticColorManager={ok:!1,details:`Semantic color manager error: ${a}`}}let t=e.facades.visual.ok&&e.facades.nonVisual.ok,i=e.sharedResources.simplePerformanceCoordinator.ok&&e.sharedResources.cssVariableController.ok&&e.sharedResources.musicSyncService.ok&&e.sharedResources.semanticColorManager?.ok!==!1&&e.sharedResources.performanceAnalyzer?.ok!==!1;return t&&i?e.overall="excellent":t||i?e.overall="good":(e.overall="critical",e.recommendations.push("Multiple system failures detected - consider system restart")),this.currentMetrics.totalMemoryMB>120&&e.recommendations.push("High memory usage - consider optimizing system memory"),this.currentMetrics.totalInitTime>6e3&&e.recommendations.push("High initialization time - consider optimizing system startup"),this.lastHealthCheck=e,this.onHealthChange&&this.onHealthChange(e),e}createInitialMetrics(){return{totalSystems:0,visualSystems:0,nonVisualSystems:0,activeSystems:0,failedSystems:0,totalMemoryMB:0,totalInitTime:0,averageSystemInitTime:0,crossFacadeLatency:0,overallHealth:"good",visualHealth:"good",nonVisualHealth:"good",sharedDependencies:6,crossFacadeEvents:0,resourceOptimization:0}}startMonitoring(){this.coordinationConfig.enableUnifiedPerformanceMonitoring&&(this.healthCheckInterval=window.setInterval(async()=>{await this.performHealthCheck()},2e4),this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},2e3))}updateMetrics(){if(this.visualBridge){let t=this.visualBridge.getMetrics();this.currentMetrics.visualHealth=t.systemHealth}if(this.nonVisualFacade){let t=this.nonVisualFacade.getMetrics();this.currentMetrics.nonVisualHealth=t.systemHealth}let e=performance.memory;e&&(this.currentMetrics.totalMemoryMB=e.usedJSHeapSize/(1024*1024)),this.currentMetrics.visualHealth==="excellent"&&this.currentMetrics.nonVisualHealth==="excellent"?this.currentMetrics.overallHealth="excellent":this.currentMetrics.visualHealth==="critical"||this.currentMetrics.nonVisualHealth==="critical"?this.currentMetrics.overallHealth="critical":this.currentMetrics.visualHealth==="degraded"||this.currentMetrics.nonVisualHealth==="degraded"?this.currentMetrics.overallHealth="degraded":this.currentMetrics.overallHealth="good",this.onPerformanceChange&&this.onPerformanceChange(this.currentMetrics)}setupCoordinationPhases(){this.systemDependencies.set("MusicSyncService",[]),this.systemDependencies.set("ColorHarmonyEngine",["MusicSyncService","SemanticColorManager"]),this.systemDependencies.set("PerformanceAnalyzer",[]),this.systemDependencies.set("UnifiedCSSVariableManager",["PerformanceAnalyzer"]),this.systemDependencies.set("SettingsManager",[]),this.systemDependencies.set("SemanticColorManager",["UnifiedCSSVariableManager"]),this.initializationOrder.set("core",["PerformanceAnalyzer","UnifiedCSSVariableManager"]),this.initializationOrder.set("services",["SettingsManager","MusicSyncService","SemanticColorManager"]),this.initializationOrder.set("visual-systems",["ColorHarmonyEngine"]),this.initializationOrder.set("integration",["VisualSystemCoordinator","NonVisualSystemFacade"]);for(let[e,t]of this.initializationOrder.entries())for(let i of t)this.systemStates.set(i,"uninitialized");u?.debug?.log("SystemCoordinator","Coordination phases configured",{phases:Array.from(this.initializationOrder.keys()),totalSystems:this.systemStates.size,dependencies:Object.fromEntries(this.systemDependencies)})}async executeCoordinatedInitialization(){let e=["core","services","visual-systems","integration"];for(let t of e){u?.debug?.log("SystemCoordinator",`Starting phase: ${t}`),this.currentPhase=t;try{await this.executePhase(t),u?.debug?.log("SystemCoordinator",`Phase ${t} completed successfully`)}catch(i){throw u?.debug?.error("SystemCoordinator",`Phase ${t} failed:`,i),new Error(`Orchestration failed at phase ${t}: ${i}`)}}this.currentPhase="completed",this.setupCrossFacadeCommunication(),await this.setupGradientSystemCoordination(),this.setupDefaultColorDependentSystems(),this.startMonitoring(),await this.performHealthCheck()}async executePhase(e){let t=this.initializationOrder.get(e);if(!t)throw new Error(`Unknown phase: ${e}`);let i=[];for(let a of t)i.push(this.initializeSystemWithDependencies(a));await Promise.all(i);for(let a of t){let r=this.systemStates.get(a);if(r!=="ready")throw new Error(`System ${a} not ready after phase ${e} (state: ${r})`)}}async initializeSystemWithDependencies(e){if(this.systemStates.get(e)!=="ready"){this.systemStates.set(e,"initializing");try{let t=this.systemDependencies.get(e)||[];for(let i of t)await this.waitForSystemReady(i);switch(e){case"PerformanceAnalyzer":await this.initializePerformanceAnalyzer();break;case"UnifiedCSSVariableManager":await this.initializeUnifiedCSSController();break;case"SettingsManager":await this.initializeSettingsManager();break;case"MusicSyncService":await this.initializeMusicSyncService();break;case"ColorHarmonyEngine":await this.initializeColorHarmonyEngine();break;case"SemanticColorManager":await this.initializeSemanticColorManager();break;case"VisualSystemCoordinator":await this.initializeVisualFacade();break;case"NonVisualSystemFacade":await this.initializeNonVisualFacade();break;default:throw new Error(`Unknown system: ${e}`)}this.systemStates.set(e,"ready"),u?.debug?.log("SystemCoordinator",`System ${e} initialized successfully`)}catch(t){throw this.systemStates.set(e,"failed"),u?.debug?.error("SystemCoordinator",`System ${e} initialization failed:`,t),t}}}async waitForSystemReady(e){let t=this.coordinationConfig.coordination.systemReadinessTimeout,i=Date.now();for(;Date.now()-i<t;){let a=this.systemStates.get(e);if(a==="ready")return;if(a==="failed")throw new Error(`Dependency ${e} failed to initialize`);await new Promise(r=>setTimeout(r,50))}throw new Error(`Timeout waiting for dependency ${e} to be ready`)}async initializePerformanceAnalyzer(){this.sharedDeviceCapabilityDetector||(this.sharedDeviceCapabilityDetector=new N({enableDebug:!0,spicetifyContext:!0}),await this.sharedDeviceCapabilityDetector.initialize()),this.sharedEnhancedDeviceTierDetector=new me,this.sharedWebGLSystemsIntegration=new et(this.sharedDeviceCapabilityDetector),await this.sharedWebGLSystemsIntegration.initialize(),this.sharedSimplePerformanceCoordinator=new he(this.sharedEnhancedDeviceTierDetector,this.sharedWebGLSystemsIntegration),await this.sharedSimplePerformanceCoordinator.initialize()}async initializeUnifiedCSSController(){if(!this.sharedSimplePerformanceCoordinator)throw new Error("SimplePerformanceCoordinator dependency not available");try{this.sharedDeviceCapabilityDetector=new N({enableDebug:this.config.enableDebug||!1,runStressTests:!1}),await this.sharedDeviceCapabilityDetector.initialize(),this.sharedPerformanceBudgetManager=new Ae({budgets:{animationFrame:16,cssVariableUpdate:2,domObservation:1,audioAnalysis:5,visualEffects:8,userInteraction:100},autoOptimize:{enabled:!0,violationThreshold:3,recoveryThreshold:.8},enableDebug:this.config.enableDebug||!1},this.sharedSimplePerformanceCoordinator);let e=this.sharedDeviceCapabilityDetector.getCapabilities(),t={getCurrentPerformanceMode:()=>({name:"balanced",qualityLevel:.8,animationQuality:.8,effectQuality:.8,blurQuality:.8,shadowQuality:.8,frameRate:60,optimizationLevel:1}),getDeviceCapabilities:()=>e||{performanceTier:"mid",memoryGB:8,isMobile:!1,gpuAcceleration:!0},getBatteryState:()=>({level:1,charging:!1}),getThermalState:()=>({temperature:"normal"})};this.sharedUnifiedCSSVariableManager=new Ee(this.config,t,{enableAdaptiveThrottling:!0,batchIntervalMs:16,maxBatchSize:50,priorityMappings:{critical:["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift","--sn-enhanced-base-hex","--sn-enhanced-accent-hex"],high:["--sn-gradient-primary","--sn-gradient-secondary","--sn-gradient-accent","--sn-color-base-hex","--sn-color-accent-hex"],normal:["--sn-gradient-","--sn-rs-","--sn-color-"],low:["--sn-debug-","--sn-dev-","--sn-meta-"]},thresholds:{excellentFPS:55,goodFPS:45,poorFPS:30}}),Da(this.sharedUnifiedCSSVariableManager),await this.sharedUnifiedCSSVariableManager.initialize()}catch(e){u?.debug?.warn("SystemCoordinator","Failed to initialize OptimizedCSSVariableManager:",e),this.sharedUnifiedCSSVariableManager=null}}async initializeSettingsManager(){this.sharedSettingsManager=new ee,await this.sharedSettingsManager.initialize()}async initializeMusicSyncService(){this.sharedMusicSyncService=new we({ADVANCED_SYSTEM_CONFIG:this.config,ThemeUtilities:this.utils,performanceMonitor:this.sharedSimplePerformanceCoordinator,settingsManager:this.sharedSettingsManager||void 0,year3000System:this.year3000System}),await this.sharedMusicSyncService.initialize()}async initializeSemanticColorManager(){if(!this.sharedUnifiedCSSVariableManager)throw new Error("OptimizedCSSVariableManager dependency not available");this.sharedSemanticColorManager=new ot({enableDebug:this.config.enableDebug||!1,fallbackToSpiceColors:!0,cacheDuration:5e3}),await this.sharedSemanticColorManager.initialize(this.sharedUnifiedCSSVariableManager),u?.debug?.log("SystemCoordinator","SemanticColorManager initialized successfully",{systemMetrics:this.sharedSemanticColorManager.getSystemMetrics()})}async initializeColorHarmonyEngine(){if(!this.sharedMusicSyncService)throw new Error("MusicSyncService dependency not available");if(!this.sharedSemanticColorManager)throw new Error("SemanticColorManager dependency not available");this.sharedColorHarmonyEngine=new Xe(this.config,this.utils,this.sharedSimplePerformanceCoordinator||void 0,this.sharedSettingsManager||void 0),await this.sharedColorHarmonyEngine.initialize()}async initializeVisualFacade(){this.visualBridge=new Ht(this.config,this.utils,this,this.sharedUnifiedCSSVariableManager,this.sharedSimplePerformanceCoordinator,this.sharedMusicSyncService,this.sharedSettingsManager,this.sharedColorHarmonyEngine||void 0,this.eventBus),await this.visualBridge.initialize()}async initializeNonVisualFacade(){this.nonVisualFacade=new Bt(this.config,this.utils,{performanceAnalyzer:this.sharedSimplePerformanceCoordinator,unifiedCSSConsciousnessController:this.sharedUnifiedCSSVariableManager,musicSyncService:this.sharedMusicSyncService,settingsManager:this.sharedSettingsManager,colorHarmonyEngine:this.sharedColorHarmonyEngine,performanceOrchestrator:this.sharedSimplePerformanceCoordinator,semanticColorManager:this.sharedSemanticColorManager}),await this.nonVisualFacade.initialize()}async executeLegacyInitialization(){await this.initializeSharedDependencies(),await this.initializeFacades(),this.setupCrossFacadeCommunication(),await this.setupGradientSystemCoordination(),this.setupDefaultColorDependentSystems(),this.startMonitoring(),await this.performHealthCheck()}getCurrentPhase(){return this.currentPhase}getSystemState(e){return this.systemStates.get(e)}getAllSystemStates(){return new Map(this.systemStates)}isOrchestrationEnabled(){return this.coordinationConfig.coordination.enforceSequentialInitialization}async cleanup(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this.visualBridge&&(await this.visualBridge.destroy(),this.visualBridge=null),this.nonVisualFacade&&(await this.nonVisualFacade.destroy(),this.nonVisualFacade=null),this.sharedSimplePerformanceCoordinator&&(this.sharedSimplePerformanceCoordinator.destroy(),this.sharedSimplePerformanceCoordinator=null),this.sharedWebGLSystemsIntegration&&(this.sharedWebGLSystemsIntegration.destroy(),this.sharedWebGLSystemsIntegration=null),this.sharedEnhancedDeviceTierDetector&&(this.sharedEnhancedDeviceTierDetector=null),this.sharedSemanticColorManager&&(this.sharedSemanticColorManager.destroy(),this.sharedSemanticColorManager=null),this.sharedColorHarmonyEngine&&(this.sharedColorHarmonyEngine.destroy(),this.sharedColorHarmonyEngine=null),this.sharedMusicSyncService&&(this.sharedMusicSyncService.destroy(),this.sharedMusicSyncService=null),this.sharedSettingsManager&&(this.sharedSettingsManager.destroy(),this.sharedSettingsManager=null),this.sharedUnifiedCSSVariableManager&&(this.sharedUnifiedCSSVariableManager.destroy(),this.sharedUnifiedCSSVariableManager=null),this.sharedSimplePerformanceCoordinator&&(this.sharedSimplePerformanceCoordinator.destroy(),this.sharedSimplePerformanceCoordinator=null),this.sharedPerformanceBudgetManager&&(this.sharedPerformanceBudgetManager.destroy(),this.sharedPerformanceBudgetManager=null),this.sharedDeviceCapabilityDetector&&(this.sharedDeviceCapabilityDetector.destroy(),this.sharedDeviceCapabilityDetector=null),this.crossFacadeEventListeners.clear()}getMetrics(){return{...this.currentMetrics}}getLastHealthCheck(){return this.lastHealthCheck}getConfiguration(){return{...this.coordinationConfig}}async setConfiguration(e){this.coordinationConfig={...this.coordinationConfig,...e}}setOnSystemCreated(e){this.onSystemCreated=e}setOnHealthChange(e){this.onHealthChange=e}setOnPerformanceChange(e){this.onPerformanceChange=e}getSystemStatus(){return{initialized:this.isInitialized,visualSystems:this.visualBridge?.getSystemStatus()?.systemsActive||0,nonVisualSystems:this.nonVisualFacade?.getSystemStatus()?.systemsActive||0,healthy:this.currentMetrics.overallHealth==="excellent"||this.currentMetrics.overallHealth==="good"}}async setupGradientSystemCoordination(){if(!this.visualBridge){u?.debug?.warn("SystemCoordinator","VisualSystemCoordinator not available - skipping gradient system coordination");return}u?.debug?.log("SystemCoordinator","Setting up gradient system coordination");let e=performance.now(),t=0;try{await this.coordinateGradientConductor(),t++,await this.coordinateWebGLGradientSystem(),t++,this.setupGradientSystemRefreshCallbacks(),this.setupGradientSystemCommunication();let i=performance.now()-e;u?.debug?.log("SystemCoordinator","Gradient system coordination completed",{coordinatedSystems:t,duration:`${i.toFixed(2)}ms`,systems:["GradientConductor","WebGLGradientBackgroundSystem","GradientTransitionOrchestrator"]})}catch(i){throw u?.debug?.error("SystemCoordinator","Failed to setup gradient system coordination:",i),i}}async coordinateGradientConductor(){try{let e=this.visualBridge.getVisualSystem("GradientConductor");if(!e){u?.debug?.warn("SystemCoordinator","GradientConductor not available via VisualSystemCoordinator");return}this.addEventListener("gradient-conductor-event",t=>{e&&typeof e.handleSystemEvent=="function"&&e.handleSystemEvent(t)}),this.registerColorDependentSystem("GradientConductor",async t=>{if(e&&typeof e.refreshColorState=="function")await e.refreshColorState(t);else if(e&&typeof e.setPalette=="function"){let i=this.sharedColorHarmonyEngine;if(i)try{let a=await i.getCurrentGradient();a&&e.setPalette(a)}catch(a){u?.debug?.warn("SystemCoordinator","Failed to refresh GradientConductor colors:",a)}}}),u?.debug?.log("SystemCoordinator","GradientConductor coordination established")}catch(e){u?.debug?.error("SystemCoordinator","Failed to coordinate GradientConductor:",e)}}async coordinateWebGLGradientSystem(){try{let e=this.visualBridge.getVisualSystem("WebGLBackground");if(!e){u?.debug?.warn("SystemCoordinator","WebGLGradientBackgroundSystem not available via VisualSystemCoordinator");return}this.addEventListener("webgl-gradient-event",t=>{e&&typeof e.handleSystemEvent=="function"&&e.handleSystemEvent(t)}),this.registerColorDependentSystem("WebGLGradientBackgroundSystem",async t=>{e&&typeof e.refreshColorState=="function"?await e.refreshColorState(t):e&&typeof e.updateGradientTexture=="function"&&await e.updateGradientTexture()}),u?.debug?.log("SystemCoordinator","WebGLGradientBackgroundSystem coordination established")}catch(e){u?.debug?.error("SystemCoordinator","Failed to coordinate WebGLGradientBackgroundSystem:",e)}}setupGradientSystemRefreshCallbacks(){try{this.registerColorDependentSystem("GradientTransitionOrchestrator"),u?.debug?.log("SystemCoordinator","GradientTransitionOrchestrator registered for color updates")}catch(e){u?.debug?.warn("SystemCoordinator","Failed to register GradientTransitionOrchestrator:",e)}}setupGradientSystemCommunication(){this.addEventListener("color-harmony-updated",async e=>{try{await this.refreshColorDependentSystems("color-harmony-update"),this.emitEvent("gradient-systems-updated",{trigger:"color-harmony-update",timestamp:Date.now(),systems:["GradientConductor","WebGLGradientBackgroundSystem","GradientTransitionOrchestrator"]})}catch(t){u?.debug?.error("SystemCoordinator","Failed to propagate color harmony update to gradient systems:",t)}}),this.addEventListener("performance-event",e=>{try{this.emitEvent("gradient-performance-event",{...e,timestamp:Date.now()})}catch(t){u?.debug?.error("SystemCoordinator","Failed to propagate performance event to gradient systems:",t)}}),u?.debug?.log("SystemCoordinator","Gradient system communication established")}getGradientSystemStatus(){let e=["GradientConductor","WebGLGradientBackgroundSystem","GradientTransitionOrchestrator"],t=e.filter(i=>this.colorDependentSystems.has(i));return{coordinatedSystems:e,colorDependentGradientSystems:t,communicationActive:this.crossFacadeEventListeners.size>0}}registerColorDependentSystem(e,t){this.colorDependentSystems.add(e),t&&this.colorSystemRefreshCallbacks.set(e,t),u?.debug?.log("SystemCoordinator",`Registered color-dependent system: ${e}`)}unregisterColorDependentSystem(e){this.colorDependentSystems.delete(e),this.colorSystemRefreshCallbacks.delete(e),u?.debug?.log("SystemCoordinator",`Unregistered color-dependent system: ${e}`)}getColorDependentSystems(){return Array.from(this.colorDependentSystems)}async refreshColorDependentSystems(e){if(this.colorDependentSystems.size===0){u?.debug?.log("SystemCoordinator","No color-dependent systems to refresh");return}let t=performance.now(),i=[],a=0,r=0;u?.debug?.log("SystemCoordinator",`Refreshing ${this.colorDependentSystems.size} color-dependent systems for trigger: ${e}`);for(let o of this.colorDependentSystems){let l=this.colorSystemRefreshCallbacks.get(o);l?i.push(l(e).then(()=>{a++,u?.debug?.log("SystemCoordinator",`Successfully refreshed color system: ${o}`)}).catch(m=>{r++,u?.debug?.warn("SystemCoordinator",`Failed to refresh color system ${o}:`,m)})):i.push(this.getSystemAndRefresh(o,e).then(()=>{a++}).catch(m=>{r++,u?.debug?.warn("SystemCoordinator",`Failed to refresh color system ${o}:`,m)}))}await Promise.all(i);let s=performance.now()-t;u?.debug?.log("SystemCoordinator","Color system refresh completed",{trigger:e,duration:`${s.toFixed(2)}ms`,success:a,failures:r,totalSystems:this.colorDependentSystems.size}),this.emitEvent("color-systems-refreshed",{trigger:e,duration:s,successCount:a,failureCount:r,totalSystems:this.colorDependentSystems.size,timestamp:Date.now()})}async getSystemAndRefresh(e,t){if(this.visualBridge)try{let i=this.visualBridge.getVisualSystem(e);if(i&&typeof i.refreshColorState=="function"){await i.refreshColorState(t);return}}catch{}if(this.nonVisualFacade)try{let i=await this.nonVisualFacade.getSystem(e);if(i&&typeof i.refreshColorState=="function"){await i.refreshColorState(t);return}}catch{}u?.debug?.warn("SystemCoordinator",`System ${e} not found or doesn't support color refresh`)}setupDefaultColorDependentSystems(){let e=["CinematicDrama","EtherealBeauty","NaturalHarmony","FluidGradientBackgroundSystem","WebGLGradientBackgroundSystem","IridescentShimmerEffectsSystem","ColorHarmonyEngine","GradientTransitionOrchestrator","GradientConductor","SemanticColorManager","Card3DManager","GlassmorphismManager"];for(let t of e)this.registerColorDependentSystem(t);u?.debug?.log("SystemCoordinator",`Auto-registered ${e.length} default color-dependent systems`)}async destroy(){await this.cleanup(),this.isInitialized=!1,u?.debug?.log("SystemCoordinator","System coordinator destroyed")}getSharedMusicSyncService(){return this.sharedMusicSyncService||void 0}getSharedColorHarmonyEngine(){return this.sharedColorHarmonyEngine||void 0}getSharedSettingsManager(){return this.sharedSettingsManager||void 0}getSharedSemanticColorManager(){return this.sharedSemanticColorManager||void 0}getSharedSimplePerformanceCoordinator(){return this.sharedSimplePerformanceCoordinator||void 0}getSharedWebGLSystemsIntegration(){return this.sharedWebGLSystemsIntegration||void 0}getSharedEnhancedDeviceTierDetector(){return this.sharedEnhancedDeviceTierDetector||void 0}getSharedPerformanceAnalyzer(){return this.sharedSimplePerformanceCoordinator||void 0}getSharedPerformanceOrchestrator(){return this.sharedSimplePerformanceCoordinator||void 0}}});var Sr,$s,Ws=y(()=>{"use strict";L();$();Ct();Sr=class{constructor(e){this.initialized=!1;this.settingsManager=null;this.currentState=null;this.isUpdating=!1;this.updateCount=0;this.lastUpdateTime=0;this.settingsManager=e||null}async initialize(){if(this.initialized)return;let e=globalThis.year3000System;this.cssController=e?.cssConsciousnessController||P(),p.subscribe("settings:changed",this.handleSettingsChange.bind(this),"ColorStateManager"),p.subscribe("colors:harmonized",this.handleProcessedColors.bind(this),"ColorStateManager"),p.subscribe("colors:extracted",this.handleExtractedColors.bind(this),"ColorStateManager"),p.subscribe("visual-effects:state-updated",this.handleVisualEffectsUpdate.bind(this),"ColorStateManager"),p.subscribe("music:energy",this.handleMusicEnergyUpdate.bind(this),"ColorStateManager"),p.subscribe("system:css-variables",this.handleSystemCSSVariables.bind(this),"ColorStateManager"),this.settingsManager||(this.settingsManager=globalThis.__SN_settingsManager||globalThis.Y3K?.system?.settingsManager),this.settingsManager&&await this.applyInitialColorState(),this.initialized=!0,console.log("\u{1F3A8} [ColorStateManager] Initialized successfully")}async healthCheck(){let e=[];this.settingsManager||e.push("SettingsManager not available"),this.currentState||e.push("No current color state"),this.updateCount===0&&e.push("No color updates performed yet");let t=Date.now()-this.lastUpdateTime;return t>3e5&&e.push(`Last update was ${Math.round(t/1e3)}s ago`),{healthy:e.length===0,ok:e.length===0,details:`Color state manager - ${this.updateCount} updates performed`,issues:e,system:"ColorStateManager"}}updateAnimation(e){}destroy(){p.unsubscribeAll("ColorStateManager"),this.currentState=null,this.initialized=!1}getCurrentConfig(){return this.settingsManager?{paletteSystemFlavor:this.settingsManager.get("catppuccin-flavor")||K.getCurrentDefaultFlavor(),brightnessMode:this.settingsManager.get("sn-brightness-mode"),accentColor:this.settingsManager.get("catppuccin-accentColor"),preserveAlbumArt:!0,enableTransitions:!0}:{paletteSystemFlavor:K.getCurrentDefaultFlavor(),brightnessMode:"dark",accentColor:"mauve",preserveAlbumArt:!0,enableTransitions:!0}}calculateColorState(e){let{paletteSystemFlavor:t,brightnessMode:i,accentColor:a,dynamicAlbumColors:r}=e,n=vn(t,i),s=Sn(t,i),o;a==="dynamic"&&r?o=r.accent:a==="dynamic"?o=Cn(t):o=Mn(a,t);let m=K.getCurrentPalette()[t];if(!m)throw new Error(`Flavor '${t}' not found in current palette system`);let d=m.text;return{baseColor:n,surfaceColor:s,accentColor:o,textColor:d,effectiveConfig:e,timestamp:Date.now()}}async applyColorStateToCSSVariables(e){let t=performance.now(),i={"--sn-cosmic-base-hex":e.baseColor.hex,"--sn-cosmic-accent-hex":e.accentColor.hex,"--spice-accent":e.accentColor.hex,"--spice-base":e.baseColor.hex,"--sn-color-base-hex":e.baseColor.hex,"--sn-color-base-rgb":e.baseColor.rgb,"--sn-color-surface-hex":e.surfaceColor.hex,"--sn-color-surface-rgb":e.surfaceColor.rgb,"--sn-color-accent-hex":e.accentColor.hex,"--sn-color-accent-rgb":e.accentColor.rgb,"--sn-dynamic-accent-hex":e.accentColor.hex,"--sn-dynamic-accent-rgb":e.accentColor.rgb,"--sn-cosmic-base-rgb":e.baseColor.rgb,"--sn-cosmic-surface-hex":e.surfaceColor.hex,"--sn-cosmic-surface-rgb":e.surfaceColor.rgb,"--sn-cosmic-accent-rgb":e.accentColor.rgb,"--sn-color-text-hex":e.textColor.hex,"--sn-color-text-rgb":e.textColor.rgb,"--sn-cosmic-text-hex":e.textColor.hex,"--sn-cosmic-text-rgb":e.textColor.rgb,"--spice-surface1":e.surfaceColor.hex,"--spice-text":e.textColor.hex,"--spice-rgb-base":e.baseColor.rgb,"--spice-rgb-surface1":e.surfaceColor.rgb,"--spice-rgb-accent":e.accentColor.rgb,"--spice-rgb-text":e.textColor.rgb,"--sn-bg-gradient-primary-rgb":e.accentColor.rgb,"--sn-bg-gradient-secondary-rgb":e.surfaceColor.rgb,"--sn-bg-gradient-accent-rgb":e.accentColor.rgb,"--sn-color-state-flavor":`"${e.effectiveConfig.paletteSystemFlavor}"`,"--sn-color-state-brightness":`"${e.effectiveConfig.brightnessMode}"`,"--sn-color-state-accent":`"${e.effectiveConfig.accentColor}"`,"--sn-color-state-palette-system":`"${K.getCurrentPaletteSystem()}"`,"--sn-color-state-timestamp":e.timestamp.toString()};await this.applyColorVariablesWithPriorities(i);let r=performance.now()-t;console.log(`\u{1F3A8} [ColorStateManager] Applied ${Object.keys(i).length} CSS variables in ${r.toFixed(2)}ms (via OptimizedCSSVariableManager)`)}async applyColorVariablesWithPriorities(e){let t=["--sn-cosmic-base-hex","--sn-cosmic-accent-hex","--spice-accent","--spice-base"],i=["--sn-color-","--sn-dynamic-accent-"],a={},r={},n={},s={};Object.entries(e).forEach(([o,l])=>{t.some(m=>o.includes(m))?a[o]=l:i.some(m=>o.includes(m))?r[o]=l:o.includes("state-")||o.includes("timestamp")?s[o]=l:n[o]=l}),Object.keys(a).length>0&&this.cssController.batchSetVariables("ColorStateManager",a,"critical","color-state-critical"),Object.keys(r).length>0&&this.cssController.batchSetVariables("ColorStateManager",r,"high","color-state-high"),Object.keys(n).length>0&&this.cssController.batchSetVariables("ColorStateManager",n,"normal","color-state-normal"),Object.keys(s).length>0&&this.cssController.batchSetVariables("ColorStateManager",s,"low","color-state-meta")}queueCSSVariableUpdate(e,t,i="normal"){let a=i==="critical"?"critical":i==="high"?"high":i==="low"?"low":"normal";this.cssController.setVariable("ColorStateManager",e,t,a,"color-state-queue")}async verifyCSSVariablesApplied(e){let t=["--sn-cosmic-base-hex","--sn-cosmic-accent-hex","--spice-base"];for(let i of t)if(e[i]){let a=getComputedStyle(document.documentElement).getPropertyValue(i).trim(),r=e[i];if(a!==r)return console.warn(`\u{1F3A8} [ColorStateManager] Variable verification failed: ${i} = "${a}" (expected "${r}")`),!1}return!0}async updateColorState(e="settings"){if(!this.isUpdating){this.isUpdating=!0;try{let t=this.getCurrentConfig(),i=this.calculateColorState(t);if(!this.currentState||this.currentState.baseColor.hex!==i.baseColor.hex||this.currentState.surfaceColor.hex!==i.surfaceColor.hex||this.currentState.accentColor.hex!==i.accentColor.hex||this.currentState.effectiveConfig.paletteSystemFlavor!==i.effectiveConfig.paletteSystemFlavor||this.currentState.effectiveConfig.brightnessMode!==i.effectiveConfig.brightnessMode){let r=this.currentState;await this.applyColorStateToCSSVariables(i),this.currentState=i,this.updateCount++,this.lastUpdateTime=Date.now(),p.emit("colors:applied",{oldState:r,newState:i,trigger:e,cssVariables:{"--sn-cosmic-base-hex":i.baseColor.hex,"--sn-cosmic-accent-hex":i.accentColor.hex},accentHex:i.accentColor.hex,accentRgb:i.accentColor.rgb,appliedAt:Date.now()}),console.log(`\u{1F3A8} [ColorStateManager] Color state updated (${e}):`,{flavor:i.effectiveConfig.paletteSystemFlavor,brightness:i.effectiveConfig.brightnessMode,accent:i.effectiveConfig.accentColor,paletteSystem:K.getCurrentPaletteSystem(),base:i.baseColor.hex,surface:i.surfaceColor.hex,accentHex:i.accentColor.hex})}}finally{this.isUpdating=!1}}}async applyInitialColorState(){await this.updateColorState("initialization")}async handleSettingsChange(e){let{settingKey:t,newValue:i,oldValue:a}=e;if(["catppuccin-flavor","sn-brightness-mode","catppuccin-accentColor"].includes(t)){let r="settings";t==="catppuccin-flavor"?r="flavor":t==="sn-brightness-mode"?r="brightness":t==="catppuccin-accentColor"&&(r="accent"),p.emit(`colorState:${r}Changed`,{settingKey:t,newValue:i,oldValue:a,timestamp:Date.now()}),await this.updateColorState(r)}}async handleProcessedColors(e){let{processedColors:t,accentHex:i,accentRgb:a,strategies:r,coordinationMetrics:n}=e,s={};Object.entries(t).forEach(([o,l])=>{if(l){let m=o.startsWith("--")?o:`--sn-${o.toLowerCase().replace(/_/g,"-")}`;s[m]=l}}),i&&(s["--sn-accent-hex"]=i,s["--sn-processed-accent-hex"]=i),a&&(s["--sn-accent-rgb"]=a,s["--sn-processed-accent-rgb"]=a),n&&(n.emotionalState&&(s["--sn-emotional-state"]=`"${n.emotionalState}"`),n.musicInfluenceStrength!==void 0&&(s["--sn-music-influence"]=n.musicInfluenceStrength.toFixed(3))),Object.entries(s).forEach(([o,l])=>{let m="normal";o.includes("accent-hex")||o.includes("accent-rgb")?m="high":(o.includes("debug")||o.includes("state")||o.includes("influence"))&&(m="low"),this.queueCSSVariableUpdate(o,l,m)}),console.log(`\u{1F3A8} [ColorStateManager] Applied ${Object.keys(s).length} processed color variables`)}async handleExtractedColors(e){let{rawColors:t,trackUri:i,musicData:a}=e,r={};Object.entries(t).forEach(([n,s])=>{s&&(r[`--sn-extracted-${n.toLowerCase()}`]=s)}),i&&(r["--sn-current-track-id"]=`"${i}"`),Object.entries(r).forEach(([n,s])=>{this.queueCSSVariableUpdate(n,s,"low")})}async handleVisualEffectsUpdate(e){let{payload:t}=e;if(!t)return;let i={"--sn-visual-effects-level":(t.visualEffectsLevel||0).toFixed(3),"--sn-emotional-temperature":(t.emotionalTemperature||6500).toString(),"--sn-transcendence-level":(t.transcendenceLevel||0).toFixed(3),"--sn-volumetric-depth":(t.volumetricDepth||0).toFixed(3),"--sn-data-stream-intensity":(t.dataStreamIntensity||0).toFixed(3),"--sn-cosmic-resonance":(t.cosmicResonance||0).toFixed(3)};Object.entries(i).forEach(([a,r])=>{this.queueCSSVariableUpdate(a,r,"normal")})}async handleMusicEnergyUpdate(e){let{energy:t,valence:i,tempo:a}=e,r={};t!==void 0&&(r["--sn-music-energy"]=t.toFixed(3)),i!==void 0&&(r["--sn-music-valence"]=i.toFixed(3)),a!==void 0&&(r["--sn-music-tempo"]=a.toString()),Object.entries(r).forEach(([n,s])=>{this.queueCSSVariableUpdate(n,s,"high")})}async handleSystemCSSVariables(e){let{source:t,variables:i,timestamp:a}=e;!i||typeof i!="object"||(Object.entries(i).forEach(([r,n])=>{let s="normal";r.includes("harmony")||r.includes("glow")||r.includes("pulse")?s="high":(r.includes("debug")||r.includes("animation"))&&(s="low"),this.queueCSSVariableUpdate(r,n,s)}),console.log(`\u{1F3A8} [ColorStateManager] Applied ${Object.keys(i).length} CSS variables from ${t}`))}getCurrentState(){return this.currentState?{...this.currentState}:null}async refresh(){await this.updateColorState("settings")}},$s=new Sr});function qs(c,e=!1){let t=document.querySelector(k.nowPlayingBar);if(!t)return e&&console.warn("\u{1F3B5} [NowPlayingDomWatcher] nowPlayingBar element not found \u2013 watcher inactive"),()=>{};let i=new MutationObserver(()=>{c(),e&&console.log("\u{1F3B5} [NowPlayingDomWatcher] DOM mutation detected \u2192 onChange dispatched")});return i.observe(t,{childList:!0,subtree:!0}),e&&console.log("\u{1F3B5} [NowPlayingDomWatcher] watcher active"),()=>{i.disconnect(),e&&console.log("\u{1F3B5} [NowPlayingDomWatcher] watcher disposed")}}var Ys=y(()=>{"use strict";nr()});function zc(){let c=document.querySelector(".sn-stars-container");if(c)return c;let e=document.createElement("div");e.className="sn-stars-container";for(let t=1;t<=5;t++){let i=document.createElement("div");i.className="star",Math.random()>.7&&i.classList.add("twinkle"),e.appendChild(i)}return document.body.appendChild(e),e}function zt(c,e){E.enableDebug&&console.log("[StarryNightEffects] Applying consolidated effect settings:",{effectIntensity:c});let t=document.body,i=["sn-gradient-disabled","sn-gradient-minimal","sn-gradient-balanced","sn-gradient-intense"],a=["sn-stars-disabled","sn-stars-minimal","sn-stars-balanced","sn-stars-intense"];t.classList.remove(...i,...a),c!=="balanced"&&(t.classList.add(`sn-gradient-${c}`),t.classList.add(`sn-stars-${c}`));let r=document.querySelector(".sn-stars-container");c==="disabled"?r?.remove():r||zc()}var Cr=y(()=>{"use strict";Fe();U()});var Ut,Mr,Ks,Er=y(()=>{"use strict";Ns();Ws();hi();L();U();X();Ys();Cr();Ut=class{constructor(e=E){this.healthCheckInterval=null;this.facadeCoordinator=null;this.colorStateManager=null;this._initializationResults=null;this._dynamicCatppuccinBridge=null;this.processingState={isProcessingSongChange:!1,lastProcessedTrackUri:null,lastProcessingTime:0,processingChain:[],eventLoopDetected:!1};this.colorEventState={processedEvents:new Map,isProcessingColorEvent:!1,eventTimeout:null};this.PROCESSING_TIMEOUT=5e3;this.MAX_CHAIN_LENGTH=10;this.COLOR_EVENT_CACHE_TTL=2e3;this.availableAPIs=null;this._songChangeHandler=null;this._lastInitializationTime=null;this._initializationRetryHistory=[];this._systemStartTime=null;this._disposeNowPlayingWatcher=null;this.allowHarmonicEvolution=!0;this.performanceGuardActive=!1;this.ADVANCED_SYSTEM_CONFIG=this._deepCloneConfig(e),typeof this.ADVANCED_SYSTEM_CONFIG.init=="function"&&this.ADVANCED_SYSTEM_CONFIG.init(),this.utils=D,this.initialized=!1,this._systemStartTime=Date.now(),this._initializationResults=null,this.ADVANCED_SYSTEM_CONFIG?.enableDebug&&console.log("\u{1F31F} [Year3000System] Constructor: Instance created with Enhanced Master Animation Coordinator"),this._boundExternalSettingsHandler=this._handleExternalSettingsChange.bind(this),document.addEventListener("year3000SystemSettingsChanged",this._boundExternalSettingsHandler),this._boundArtisticModeHandler=this._onArtisticModeChanged.bind(this),document.addEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),this._boundVisibilityChangeHandler=this._handleVisibilityChange.bind(this),document.addEventListener("visibilitychange",this._boundVisibilityChangeHandler),this._disposeNowPlayingWatcher=qs(()=>{let t=Date.now().toString();this.queueCSSVariableUpdate("--sn-force-refresh",t),p.emit("music:track-changed",{timestamp:parseInt(t),trackUri:"unknown",artist:"unknown",title:"unknown"})},this.ADVANCED_SYSTEM_CONFIG.enableDebug),this.allowHarmonicEvolution=this.ADVANCED_SYSTEM_CONFIG.colorHarmonyEvolution??!0,setTimeout(()=>{this._applyPerformanceProfile()},0)}get enhancedMasterAnimationCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("EnhancedMasterAnimationCoordinator")||null}get timerConsolidationSystem(){return this.facadeCoordinator?.getCachedNonVisualSystem("TimerConsolidationSystem")||null}get cssVariableController(){return this.facadeCoordinator?.getCachedNonVisualSystem("OptimizedCSSVariableManager")||null}get simplePerformanceCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimplePerformanceCoordinator")||null}get simpleTierBasedPerformanceSystem(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimpleTierBasedPerformanceSystem")||null}get enhancedDeviceTierDetector(){return this.facadeCoordinator?.getCachedNonVisualSystem("EnhancedDeviceTierDetector")||null}get webglSystemsIntegration(){return this.facadeCoordinator?.getCachedNonVisualSystem("WebGLSystemsIntegration")||null}get unifiedCSSManager(){return this.cssVariableController||null}get performanceCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedPerformanceCoordinator")||null}get deviceCapabilityDetector(){return this.facadeCoordinator?.getCachedNonVisualSystem("DeviceCapabilityDetector")||null}get performanceAnalyzer(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimplePerformanceCoordinator")||null}get unifiedPerformanceCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedPerformanceCoordinator")||null}get performanceCSSIntegration(){return this.cssVariableController||null}get performanceOrchestrator(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimplePerformanceCoordinator")||null}get performanceBudgetManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("PerformanceBudgetManager")||null}get systemHealthMonitor(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedDebugManager")||null}get settingsManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("SettingsManager")||null}get colorHarmonyEngine(){return this.facadeCoordinator?.getCachedNonVisualSystem("ColorHarmonyEngine")||null}get unifiedColorProcessingEngine(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedColorProcessingEngine")||null}get musicColorIntegrationBridge(){return null}get colorEventOrchestrator(){let e=this.unifiedColorProcessingEngine;return e||null}get colorOrchestrator(){let e=this.unifiedColorProcessingEngine;return e||null}get enhancedColorOrchestrator(){let e=this.unifiedColorProcessingEngine;return e||null}get colorEffectsState(){return this.visualEffectsCoordinator||null}get musicSyncService(){return this.facadeCoordinator?.getCachedNonVisualSystem("MusicSyncService")||null}get glassmorphismManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("GlassmorphismManager")||null}get card3DManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("Card3DManager")||null}get genreGradientEvolution(){return this.facadeCoordinator?.getCachedNonVisualSystem("GenreGradientEvolution")||null}get musicEmotionAnalyzer(){return this.facadeCoordinator?.getCachedNonVisualSystem("MusicEmotionAnalyzer")||null}get visualEffectsCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("VisualEffectsCoordinator")||null}get colorEffectsManager(){return this.visualEffectsCoordinator||null}get dynamicCatppuccinBridge(){return this._dynamicCatppuccinBridge||this.visualEffectsCoordinator||null}set dynamicCatppuccinBridge(e){this._dynamicCatppuccinBridge=e}get particleVisualEffectsModule(){return this.facadeCoordinator?.getVisualSystem("Particle")||null}get sidebarVisualEffectsController(){return this.facadeCoordinator?.getVisualSystem("SidebarVisualEffects")||null}get uiVisualEffectsController(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get headerVisualEffectsController(){return this.facadeCoordinator?.getVisualSystem("HeaderVisualEffects")||null}get lightweightParticleSystem(){return this.facadeCoordinator?.getVisualSystem("Particle")||null}get iridescentShimmerEffectsSystem(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get interactionTrackingSystem(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get whiteLayerDiagnosticSystem(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get audioVisualController(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get prismaticScrollSheenSystem(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get beatSyncVisualSystem(){return this.facadeCoordinator?.getVisualSystem("MusicBeatSync")||null}get webGLGradientBackgroundSystem(){return this.facadeCoordinator?.getVisualSystem("WebGLBackground")||null}get particleFieldSystem(){return this.facadeCoordinator?.getVisualSystem("Particle")||null}get animationCoordinator(){return this.enhancedMasterAnimationCoordinator||null}get emergentChoreographyEngine(){return this.animationCoordinator}get spotifyUIApplicationSystem(){return this.facadeCoordinator?.getVisualSystem("SpotifyUIApplication")||null}get musicBeatSyncVisualEffects(){return this.facadeCoordinator?.getVisualSystem("MusicBeatSync")||this.beatSyncVisualSystem}get sidebarSystemsIntegration(){return this.facadeCoordinator?.getCachedNonVisualSystem("SidebarSystemsIntegration")||null}_deepCloneConfig(e){return e}updateConfiguration(e,t){if(!this.ADVANCED_SYSTEM_CONFIG){console.warn("[Year3000System] Cannot update configuration - config not initialized");return}let i=e.split(".").filter(Boolean);if(!i.length)return;let a=this.ADVANCED_SYSTEM_CONFIG,r=i.pop();if(!r)return;for(let s of i)(typeof a[s]!="object"||a[s]===null)&&(a[s]={}),a=a[s];let n=a[r];a[r]=t,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`[Year3000System] Configuration updated: ${e} = ${t} (was: ${n})`),this._notifyConfigurationChange(e,t,n)}_notifyConfigurationChange(e,t,i){}async initializeAllSystems(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] initializeAllSystems(): Starting full system initialization..."),this._systemStartTime=Date.now();let e=performance.now(),t={success:[],failed:[],skipped:[]};this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing Facade Coordination System...");try{this.facadeCoordinator=new _t(this.ADVANCED_SYSTEM_CONFIG,this.utils,this),await this.facadeCoordinator.initialize({mode:"unified",enableSharedDependencies:!0,enableCrossFacadeCommunication:!0,enableUnifiedPerformanceMonitoring:!0,enableResourceOptimization:!0,coordination:{enforceSequentialInitialization:!0,dependencyValidation:!0,enableInitializationGates:!0,systemReadinessTimeout:5e3,phaseTransitionTimeout:1e4},performanceThresholds:{maxTotalMemoryMB:100,maxTotalInitTime:5e3,maxCrossCommLatency:50},coordinationPreferences:{preferSharedResources:!0,enableEventPropagation:!0,enableHealthCoordination:!0}}),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Facade Coordination System initialized successfully"),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing ColorStateManager...");try{this.colorStateManager=$s,this.colorStateManager.initialized||await this.colorStateManager.initialize(),t.success.push("ColorStateManager"),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] ColorStateManager initialized successfully")}catch(a){console.error("\u{1F30C} [Year3000System] Failed to initialize ColorStateManager:",a),t.failed.push("ColorStateManager")}await this._initializeFacadeSystems()}catch(a){throw console.error("\u{1F30C} [Year3000System] Failed to initialize Facade Coordination System:",a),a}t.success.push("FacadeCoordinationSystem"),this.performanceAnalyzer&&(this.performanceAnalyzer.startMonitoring(),this.performanceGuardActive=!0),this.enhancedMasterAnimationCoordinator?(await this._registerEnhancedAnimationSystems(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3AC} [Year3000System] Enhanced animation system registration phase complete")):console.warn("[Year3000System] EnhancedMasterAnimationCoordinator not available for enhanced registration phase"),this._initializationResults=t,this.initialized=!0;let i=performance.now();this._lastInitializationTime=i-e,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&(console.log(`[Year3000System] System initialization complete in ${this._lastInitializationTime.toFixed(2)}ms.`),console.log(`[Year3000System] Results: ${t.success.length} success, ${t.failed.length} failed.`),t.failed.length>0&&console.warn(`[Year3000System] Failed systems: ${t.failed.join(", ")}`),t.skipped&&t.skipped.length>0&&console.info(`[Year3000System] Skipped systems: ${t.skipped.join(", ")}`),t.success.length>0&&console.info(`[Year3000System] Successful systems: ${t.success.join(", ")}`),this.systemHealthMonitor&&this.systemHealthMonitor.logHealthReport())}async _initializeEssentialFacadeSystems(){if(!this.facadeCoordinator)throw new Error("Facade coordinator not available for essential system initialization");this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing essential systems for degraded mode...");try{let e=["SimplePerformanceCoordinator","UnifiedCSSVariableManager","UnifiedDebugManager","DeviceCapabilityDetector","TimerConsolidationSystem"];for(let t of e)try{let i=await this.facadeCoordinator.getNonVisualSystem(t);i&&typeof i.initialize=="function"&&(await i.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] Essential: Initialized ${t} via facade`))}catch(i){console.error(`\u{1F30C} [Year3000System] Failed to initialize essential ${t}:`,i)}this.performanceAnalyzer&&(this.performanceAnalyzer.startMonitoring(),this.performanceGuardActive=!0,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Essential: Performance monitoring started"))}catch(e){throw console.error("\u{1F30C} [Year3000System] Essential facade system initialization failed:",e),e}}async _initializeFacadeSystems(){if(!this.facadeCoordinator)throw new Error("Facade coordinator not available for system initialization");this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing essential systems through facades...");try{let e=["SimplePerformanceCoordinator","UnifiedDebugManager","SettingsManager","DeviceCapabilityDetector","TimerConsolidationSystem"],t=["UnifiedCSSVariableManager","UnifiedPerformanceCoordinator"],i=["MusicSyncService","ColorHarmonyEngine","GenreGradientEvolution","MusicEmotionAnalyzer"],a=["GlassmorphismManager","Card3DManager"];this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing foundation systems in parallel...");let r=e.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(r),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing dependent systems in parallel...");let n=t.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(n),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing event-driven systems in parallel...");let s=i.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(s),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing UI systems in parallel...");let o=a.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(o);try{await lt.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] ColorOrchestrator initialized for strategy pattern coordination")}catch(d){console.error("\u{1F3A8} [Year3000System] Failed to initialize ColorOrchestrator:",d)}this.performanceAnalyzer&&(this.performanceAnalyzer.startMonitoring(),this.performanceGuardActive=!0,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Performance monitoring started"));let l=["Particle","WebGLBackground","SpotifyUIApplication","OrganicBeatSync","HeaderVisualEffects","InteractionTracking"];this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing visual systems in parallel...");let m=l.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=this.facadeCoordinator.getVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 Visual ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize visual ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(m),await this._linkSystemDependencies(),await this._validateFacadeIntegration(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Facade system initialization complete")}catch(e){throw console.error("\u{1F30C} [Year3000System] Facade system initialization failed:",e),e}}async _validateFacadeIntegration(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F50D} [Year3000System] Performing facade integration validation...");let e={cssControllerAlias:!1,strategyPatternSystems:!1,parallelInitialization:!1,facadeHealthCheck:!1,errors:[]};try{if(this.facadeCoordinator){try{let s=await this.facadeCoordinator.getNonVisualSystem("UnifiedCSSVariableManager"),o=await this.facadeCoordinator.getNonVisualSystem("OptimizedCSSVariableManager");s&&o?(e.cssControllerAlias=!0,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u2713 [Validation] CSS Controller alias registration working")):e.errors.push("CSS Controller alias registration failed")}catch(s){e.errors.push(`CSS Controller validation error: ${s}`)}let a=["ColorHarmonyEngine","GenreGradientEvolution","MusicEmotionAnalyzer"],r=0;for(let s of a)try{await this.facadeCoordinator.getNonVisualSystem(s)&&r++}catch(o){e.errors.push(`Strategy system ${s} not found: ${o}`)}e.strategyPatternSystems=r===a.length,e.strategyPatternSystems&&this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u2713 [Validation] Strategy pattern systems registration working");let n=performance.now();try{let s=await this.facadeCoordinator.getNonVisualSystem("PerformanceAnalyzer"),l=performance.now()-n;e.parallelInitialization=l<100,e.parallelInitialization&&this.ADVANCED_SYSTEM_CONFIG.enableDebug?console.log(`\u2713 [Validation] Parallel initialization optimization working (${l.toFixed(2)}ms)`):this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.warn(`\u26A0 [Validation] Initialization may be slow (${l.toFixed(2)}ms)`)}catch(s){e.errors.push(`Parallel initialization test failed: ${s}`)}try{let s=await this.facadeCoordinator.performHealthCheck();e.facadeHealthCheck=s.overall==="excellent"||s.overall==="good",e.facadeHealthCheck&&this.ADVANCED_SYSTEM_CONFIG.enableDebug?console.log(`\u2713 [Validation] Facade health check passed (${s.overall})`):(e.errors.push(`Facade health check failed: ${s.overall}`),s.recommendations?.length>0&&console.warn("\u{1F527} [Validation] Health recommendations:",s.recommendations))}catch(s){e.errors.push(`Facade health check error: ${s}`)}}else e.errors.push("Facade coordinator not available for validation");let t=4,i=[e.cssControllerAlias,e.strategyPatternSystems,e.parallelInitialization,e.facadeHealthCheck].filter(Boolean).length;this.ADVANCED_SYSTEM_CONFIG.enableDebug&&(console.log(`\u{1F50D} [Year3000System] Facade validation complete: ${i}/${t} tests passed`),e.errors.length>0&&console.warn("\u26A0 [Year3000System] Validation errors:",e.errors),i===t&&console.log("\u{1F389} [Year3000System] All facade integration fixes validated successfully!")),window.Y3K_FACADE_VALIDATION=e}catch(t){console.error("\u{1F50D} [Year3000System] Facade validation failed:",t),e.errors.push(`Validation process error: ${t}`)}}async _linkSystemDependencies(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Linking system dependencies...");try{if(this.musicSyncService&&this.colorHarmonyEngine&&(this.musicSyncService.setColorHarmonyEngine(this.colorHarmonyEngine),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] ColorHarmonyEngine linked to MusicSyncService")),this.colorHarmonyEngine&&this.enhancedMasterAnimationCoordinator&&(this.colorHarmonyEngine.setEmergentEngine(this.enhancedMasterAnimationCoordinator),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] EnhancedMasterAnimationCoordinator (with adaptive functionality) linked to ColorHarmonyEngine")),this.systemHealthMonitor){let e=[{name:"MusicSyncService",system:this.musicSyncService},{name:"ColorHarmonyEngine",system:this.colorHarmonyEngine},{name:"SettingsManager",system:this.settingsManager}];for(let{name:t,system:i}of e)i&&this.systemHealthMonitor.registerSystem(t,i);this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Systems registered with health monitor")}}catch(e){console.error("\u{1F30C} [Year3000System] Failed to link system dependencies:",e)}}_shouldSkipPredictionSystem(e){return!1}async _initializeVisualSystems(e){if(!this.performanceAnalyzer||!this.musicSyncService||!this.settingsManager){console.error("[Year3000System] Cannot initialize visual systems due to missing core dependencies (SimplePerformanceCoordinator, MusicSyncService, or SettingsManager)."),["InteractionTrackingSystem","BeatSyncVisualSystem","SidebarSystemsIntegration"].forEach(i=>e.skipped.push(i));return}this.colorHarmonyEngine&&this.enhancedMasterAnimationCoordinator&&(this.colorHarmonyEngine.setEmergentEngine(this.enhancedMasterAnimationCoordinator),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F517} [Year3000System] EnhancedMasterAnimationCoordinator (adaptive functionality) linked to ColorHarmonyEngine."))}async destroyAllSystems(){this.facadeCoordinator&&(await this.facadeCoordinator.destroy(),this.facadeCoordinator=null),this._initializationResults=null,Spicetify.Player&&this._songChangeHandler&&Spicetify.Player.removeEventListener("songchange",this._songChangeHandler),this.initialized=!1,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F525} [Year3000System] All systems have been destroyed."),document.removeEventListener("year3000SystemSettingsChanged",this._boundExternalSettingsHandler),document.removeEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),document.removeEventListener("visibilitychange",this._boundVisibilityChangeHandler),this._disposeNowPlayingWatcher&&(this._disposeNowPlayingWatcher(),this._disposeNowPlayingWatcher=null)}async applyInitialSettings(e){if(!this.settingsManager){console.warn("[Year3000System] SettingsManager not ready, cannot apply initial settings.");return}this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F3A8} [Year3000System] Inside applyInitialSettings. Trigger: ${e||"full"}, SettingsManager valid:`,!!this.settingsManager);try{if(e==="flavor"||e==="brightness"||e==="accent"){console.log(`\u{1F3A8} [Year3000System] Selective update for trigger: ${e}`),await this.updateColorStateOnly(e),await this.refreshColorDependentSystems(e);return}if(console.log("\u{1F3A8} [Year3000System] applyInitialSettings: Getting initial settings..."),this.colorStateManager&&!this.colorStateManager.initialized&&(console.log("\u{1F3A8} [Year3000System] Initializing ColorStateManager..."),await this.colorStateManager.initialize()),this.colorStateManager?.initialized)console.log("\u{1F3A8} [Year3000System] Applying initial color state via ColorStateManager..."),await this.colorStateManager.applyInitialColorState();else{console.warn("\u{1F3A8} [Year3000System] ColorStateManager not available, using legacy color application");let l=this.settingsManager.get("catppuccin-accentColor");l!=="dynamic"&&await this._applyCatppuccinAccent(l)}let t=this.settingsManager.get("sn-gradient-intensity"),i=t,a=this.settingsManager.get("sn-harmonic-intensity"),r=this.settingsManager.get("sn-harmonic-evolution"),n=this.settingsManager.get("sn-current-harmonic-mode");n&&(this.ADVANCED_SYSTEM_CONFIG.currentColorHarmonyMode=String(n)),console.log(`\u{1F3A8} [Year3000System] applyInitialSettings: Gradient=${t}, Stars=${i}, ColorState=${!!this.colorStateManager?.initialized}`),await this._applyStarryNightSettings(t,i);let s=parseFloat(a);Number.isNaN(s)||(this.colorHarmonyEngine&&this.colorHarmonyEngine.setIntensity?.(s),this.ADVANCED_SYSTEM_CONFIG.colorHarmonyIntensity=s);let o=r==="true";this.allowHarmonicEvolution=o,this.ADVANCED_SYSTEM_CONFIG.colorHarmonyEvolution=o,console.log("\u{1F3A8} [Year3000System] applyInitialSettings: Successfully applied initial settings.")}catch(t){console.error("[Year3000System] Error applying initial settings:",t)}}async updateColorStateOnly(e){if(!this.colorStateManager?.initialized){console.warn(`\u{1F3A8} [Year3000System] ColorStateManager not available for ${e} update`);return}console.log(`\u{1F3A8} [Year3000System] Updating color state for trigger: ${e}`),await this.colorStateManager.updateColorState(e)}async refreshColorDependentSystems(e){if(!this.facadeCoordinator){console.warn(`\u{1F3A8} [Year3000System] No facade coordinator available for ${e} refresh`);return}console.log(`\u{1F3A8} [Year3000System] Refreshing color-dependent systems for trigger: ${e}`),await this.facadeCoordinator.refreshColorDependentSystems(e)}async _applyCatppuccinAccent(e){if(e==="dynamic"){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] _applyCatppuccinAccent: 'dynamic' accent selected \u2013 skipping static accent overrides.");return}console.log(`\u{1F3A8} [Year3000System] _applyCatppuccinAccent: Applying accent color '${e}'`);let t=e==="none"?"text":e,i=Spicetify.Config.color_scheme||"mocha",a=document.querySelector("body > script.marketplaceScript")?`url('https://github.com/catppuccin/spicetify/blob/main/catppuccin/assets/${i}/equalizer-animated-${t}.gif?raw=true')`:`url('${i}/equalizer-animated-${t}.gif')`;this.cssVariableController?.queueCSSVariableUpdate("--spice-text",`var(--spice-${t})`),this.cssVariableController?.queueCSSVariableUpdate("--spice-button-active",`var(--spice-${t})`),this.cssVariableController?.queueCSSVariableUpdate("--spice-equalizer",a),this.cssVariableController?.flushCSSVariableBatch(),console.log("\u{1F3A8} [Year3000System] _applyCatppuccinAccent: Flushed CSS variables for accent color.")}async _applyStarryNightSettings(e,t){try{zt(e,t)}catch{console.error("[Year3000System] Failed to apply starry night settings")}}applyColorsToTheme(e={}){let t=e;if(this.colorHarmonyEngine)try{t=this.colorHarmonyEngine.blendWithCatppuccin(e)}catch(r){console.error("[Year3000System] ColorHarmonyEngine blend failed:",r)}let i=t.accentHex||t.VIBRANT||t.PROMINENT||Object.values(t)[0]||"#37416b",a=t.accentRgb||(()=>{let r=this.utils.hexToRgb(i);return r?`${r.r},${r.g},${r.b}`:"166,173,200"})();this._applyColorsViaFacadeSystem(t,i,a)}handleColorHarmonizedEvent(e){if(this.colorEventState.isProcessingColorEvent){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.warn("\u{1F504} [Year3000System] Already processing color event - skipping to prevent recursion");return}let t=JSON.stringify(e).substring(0,100),i=this._generateEventHash(t),a=Date.now();if(this.colorEventState.processedEvents.has(i)){let r=this.colorEventState.processedEvents.get(i);if(a-r<this.COLOR_EVENT_CACHE_TTL){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.warn("\u{1F504} [Year3000System] Event recently processed - skipping duplicate");return}}this.colorEventState.isProcessingColorEvent=!0,this.colorEventState.processedEvents.set(i,a),this.colorEventState.eventTimeout=window.setTimeout(()=>{this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.warn("\u{1F504} [Year3000System] Color event processing timeout - resetting state"),this._resetColorEventState()},this.PROCESSING_TIMEOUT);try{if(this.processingState.processingChain.push("handleColorHarmonizedEvent"),this.processingState.processingChain.length>this.MAX_CHAIN_LENGTH){this.processingState.eventLoopDetected=!0,console.error("\u{1F504} [Year3000System] CRITICAL: Event loop detected - chain length exceeded",this.processingState.processingChain),this._resetProcessingState();return}let r,n,s,o,l;if(e.processedColors&&e.accentHex&&e.accentRgb)r=e.processedColors,n=e.accentHex,s=e.accentRgb,o=e.strategies||["ColorHarmonyEngine"],l=e.processingTime||0;else if(e.payload&&e.payload.processedColors)r=e.payload.processedColors,n=e.payload.accentHex||Object.values(r)[0]||"#a6adc8",s=this.utils.hexToRgb(n)?.r+","+this.utils.hexToRgb(n)?.g+","+this.utils.hexToRgb(n)?.b||"166,173,200",o=[e.payload.metadata?.strategy||"Unknown"],l=e.payload.metadata?.processingTime||0;else{if(e.type==="colors/harmonized")return;this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.warn("\u{1F3A8} [Year3000System] Unrecognized colors:harmonized event format:",e);return}this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Processing colors:harmonized event:",{strategies:o,processingTime:l,colorsCount:Object.keys(r).length,accentHex:n,accentRgb:s,chainLength:this.processingState.processingChain.length}),this._applyColorsViaFacadeSystem(r,n,s)}catch(r){console.error("[Year3000System] Failed to handle colors:harmonized event:",r)}finally{this._resetColorEventState();let r=this.processingState.processingChain.indexOf("handleColorHarmonizedEvent");r>-1&&this.processingState.processingChain.splice(r,1)}}_generateEventHash(e){let t=0;for(let i=0;i<e.length;i++){let a=e.charCodeAt(i);t=(t<<5)-t+a,t=t&t}return t.toString()}_resetColorEventState(){this.colorEventState.isProcessingColorEvent=!1,this.colorEventState.eventTimeout&&(clearTimeout(this.colorEventState.eventTimeout),this.colorEventState.eventTimeout=null);let e=Date.now();for(let[t,i]of this.colorEventState.processedEvents.entries())e-i>this.COLOR_EVENT_CACHE_TTL&&this.colorEventState.processedEvents.delete(t)}_resetProcessingState(){this.processingState.isProcessingSongChange=!1,this.processingState.processingChain=[],this.processingState.eventLoopDetected=!1,this.processingState.lastProcessingTime=Date.now(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F504} [Year3000System] Processing state reset")}_applyColorsViaFacadeSystem(e,t,i){try{let a={};Object.entries(e).forEach(([n,s])=>{if(this.utils.isValidHexColor(s)){let o=this.utils.hexToRgb(s);o&&(a[`--sn-processed-${n.toLowerCase()}-hex`]=s,a[`--sn-processed-${n.toLowerCase()}-rgb`]=`${o.r},${o.g},${o.b}`)}else this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.debug(`[Year3000System] Skipping non-hex processedColor: ${n}=${s}`)});let r={"--sn-musical-harmony-primary-rgb":e.VIBRANT||e.PRIMARY||i,"--sn-musical-harmony-secondary-rgb":e.DARK_VIBRANT||e.SECONDARY||i,"--sn-musical-harmony-tertiary-rgb":e.VIBRANT_NON_ALARMING||e.LIGHT_VIBRANT||i,"--sn-musical-harmony-quaternary-rgb":e.DESATURATED||e.EMOTIONAL_BLEND||i,"--sn-musical-harmony-primary-hex":e.VIBRANT||e.PRIMARY||t,"--sn-musical-harmony-secondary-hex":e.DARK_VIBRANT||e.SECONDARY||t,"--sn-musical-harmony-tertiary-hex":e.VIBRANT_NON_ALARMING||e.LIGHT_VIBRANT||t,"--sn-musical-harmony-quaternary-hex":e.DESATURATED||e.EMOTIONAL_BLEND||t,"--sn-musical-oklab-primary-rgb":e.VIBRANT||e.PRIMARY||e.PROMINENT||i,"--sn-musical-oklab-accent-rgb":e.DARK_VIBRANT||e.DESATURATED||i,"--sn-musical-oklab-highlight-rgb":e.VIBRANT_NON_ALARMING||e.LIGHT_VIBRANT||i,"--sn-musical-oklab-shadow-rgb":e.DARK_VIBRANT||e.DESATURATED||i,"--sn-musical-oklab-complementary-rgb":e.SECONDARY||e.EMOTIONAL_BLEND||i,"--sn-musical-oklab-triadic-rgb":e.LIGHT_VIBRANT||e.VIBRANT_NON_ALARMING||i};Object.entries(r).forEach(([n,s])=>{if(!(!s||typeof s!="string")){if(n.includes("-hex"))a[n]=s;else if(n.includes("-rgb"))if(this.utils.isValidHexColor(s)){let o=this.utils.hexToRgb(s);o&&(a[n]=`${o.r},${o.g},${o.b}`)}else s.includes(",")&&(a[n]=s)}}),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Musical Harmony Color Processing:",{colorHarmonyKeys:Object.keys(e),colorHarmonyValues:e,musicalHarmonyVariables:r,expectedCSSChain:["--sn-musical-oklab-primary-rgb","--sn-musical-harmony-primary-rgb","--sn-gradient-primary-rgb"],totalVariablesSet:Object.keys(a).length,cssAuthorityDelegation:"ColorStateManager + DynamicCatppuccinBridge"}),this.cssVariableController&&typeof this.cssVariableController.batchSetVariables=="function"?this.cssVariableController.batchSetVariables("Year3000System-ColorHarmonized",a,"high","color-harmony-event-application"):this._applyCSSVariables(a),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F527} [Year3000System] Applied musical harmony variables via CSS coordination:",{totalVariables:Object.keys(a).length,accentColor:t,cssControllerUsed:!!this.cssVariableController,spicetifyDelegation:"ColorStateManager + DynamicCatppuccinBridge handle --spice-* variables"})}catch(a){console.error("[Year3000System] Failed to apply musical harmony variables:",a);let r={"--sn-musical-harmony-primary-hex":t,"--sn-musical-harmony-primary-rgb":i};this._applyCSSVariables(r)}}_applyCSSVariables(e){try{let t=document.documentElement;for(let[i,a]of Object.entries(e))i&&a&&t.style.setProperty(i,a);this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Applied CSS variables directly",{variablesCount:Object.keys(e).length,variables:Object.keys(e)})}catch(t){console.error("[Year3000System] Failed to apply CSS variables:",t)}}queueCSSVariableUpdate(e,t,i=null){this.unifiedCSSManager?this.unifiedCSSManager.queueUpdate(e,t,"normal","Year3000System"):this.cssVariableController?this.cssVariableController.queueCSSVariableUpdate(e,t,i||void 0):(i||document.documentElement).style.setProperty(e,t)}setGradientParameters(){this.colorHarmonyEngine}async updateColorsFromCurrentTrack(){this.musicSyncService&&await this.musicSyncService.processSongUpdate()}evolveHarmonicSignature(e,t){if(this.colorHarmonyEngine){let i=this.utils.hexToRgb(t);if(i){let a=this.colorHarmonyEngine.generateHarmonicVariations(i);return{derivedDarkVibrantHex:a.darkVibrantHex,derivedLightVibrantHex:a.lightVibrantHex}}}return null}async waitForTrackData(e=10,t=100){for(let i=0;i<e;i++){if(Spicetify.Player.data?.track?.uri)return Spicetify.Player.data;await this.utils.sleep(t)}return null}updateHarmonicBaseColor(e){if(this.colorHarmonyEngine&&this.cssVariableController){let t=this.utils.hexToRgb(e);if(t){let i=this.colorHarmonyEngine.generateHarmonicVariations(t);this.cssVariableController.queueCSSVariableUpdate("--sn-harmonic-base-dark-vibrant",i.darkVibrantHex),this.cssVariableController.queueCSSVariableUpdate("--sn-harmonic-base-light-vibrant",i.lightVibrantHex),this.cssVariableController.flushCSSVariableBatch()}}}async processColorsViaFacade(e){try{let t=await this.facadeCoordinator?.getNonVisualSystem("ColorOrchestrator");t&&typeof t.handleColorExtraction=="function"?(await t.handleColorExtraction(e),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Color processing routed through facade pattern - ColorOrchestrator",{context:e?.trackUri||"unknown",rawColorsCount:e?.rawColors?Object.keys(e.rawColors).length:0})):this.colorHarmonyEngine&&typeof this.colorHarmonyEngine.processColors=="function"?(await this.colorHarmonyEngine.processColors(e),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Color processing fallback to direct ColorHarmonyEngine")):console.warn("[Year3000System] No color processing system available via facade pattern")}catch(t){console.error("[Year3000System] Failed to process colors via facade pattern:",t),e?.rawColors&&this.applyColorsToTheme(e.rawColors)}}setupMusicAnalysisAndColorExtraction(){if(console.log("\u{1F3B5} [Year3000System] setupMusicAnalysisAndColorExtraction called"),!this.musicSyncService){console.error("[Year3000System] MusicSyncService is not available to set up song change handler.");return}if(console.log("\u{1F3B5} [Year3000System] MusicSyncService available, checking Spicetify Player..."),!window.Spicetify?.Player){console.warn("[Year3000System] Spicetify.Player not available - music analysis disabled");return}try{p.subscribe("colors:harmonized",t=>{this.handleColorHarmonizedEvent(t)},"Year3000System"),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Subscribed to colors:harmonized events for event-driven color application")}catch(t){console.error("[Year3000System] Failed to subscribe to colors:harmonized events:",t)}let e=async()=>{console.log("\u{1F3B5} [Year3000System] processSongUpdate triggered - checking MusicSyncService..."),this.musicSyncService?(console.log("\u{1F3B5} [Year3000System] Calling musicSyncService.processSongUpdate()"),await this.musicSyncService.processSongUpdate(),console.log("\u2705 [Year3000System] musicSyncService.processSongUpdate() completed")):console.error("\u274C [Year3000System] MusicSyncService not available in processSongUpdate")};this._songChangeHandler=e;try{console.log("\u{1F3B5} [Year3000System] Adding songchange event listener..."),window.Spicetify.Player.addEventListener("songchange",this._songChangeHandler),console.log("\u2705 [Year3000System] Music analysis and color extraction set up successfully - song change listener active"),console.log("\u{1F3B5} [Year3000System] Triggering initial song processing..."),setTimeout(e,1e3)}catch(t){console.error("[Year3000System] Failed to set up music analysis:",t),this._songChangeHandler=null}}updateFromMusicAnalysis(e,t,i){e&&this._updateGlobalKinetics(e)}_updateGlobalKinetics(e){let t=this.utils.getRootStyle();if(!t)return;let i=(l,m=0)=>Number.isFinite(l)?l:m,a=i(e.processedEnergy),r=i(e.valence),n=i(e.enhancedBPM),s=i(e.beatInterval),o=i(e.animationSpeedFactor,1);t.style.setProperty("--sn-kinetic-energy",a.toFixed(3)),t.style.setProperty("--sn-kinetic-valence",r.toFixed(3)),t.style.setProperty("--sn-kinetic-bpm",n.toFixed(2)),t.style.setProperty("--sn-kinetic-beat-interval",`${s.toFixed(0)}ms`),t.style.setProperty("--sn-kinetic-animation-speed",o.toFixed(3))}registerAnimationSystem(e,t,i="normal",a=60){return this.enhancedMasterAnimationCoordinator?(this.enhancedMasterAnimationCoordinator.registerAnimationSystem(e,t,i,a),!0):(console.warn(`[Year3000System] Cannot register ${e} - EnhancedMasterAnimationCoordinator not ready`),!1)}unregisterAnimationSystem(e){return this.enhancedMasterAnimationCoordinator?(this.enhancedMasterAnimationCoordinator.unregisterAnimationSystem(e),!0):!1}getSystem(e){if(!e)return null;if(this.facadeCoordinator){let i=this.facadeCoordinator.getVisualSystem(e);if(i)return i;let a=this.facadeCoordinator.getCachedNonVisualSystem(e);if(a)return a}let t=e.charAt(0).toLowerCase()+e.slice(1);if(this[t])return this[t];for(let i of Object.keys(this)){let a=this[i];if(a&&a.constructor?.name===e)return a}return null}async getFacadeSystemHealthStatus(){return this.facadeCoordinator?await this.facadeCoordinator.performHealthCheck():null}async _registerAnimationSystems(){if(!this.enhancedMasterAnimationCoordinator){console.warn("[Year3000System] EnhancedMasterAnimationCoordinator not available for visual system registration");return}let e=[{name:"BeatSyncVisualSystem",system:this.beatSyncVisualSystem,priority:"critical"},{name:"SidebarSystemsIntegration",system:this.sidebarSystemsIntegration,priority:"normal"},{name:"ParticleConsciousnessModule",system:this.particleVisualEffectsModule,priority:"background"},{name:"InteractionTrackingSystem",system:this.interactionTrackingSystem,priority:"background"},{name:"SpotifyUIApplicationSystem",system:this.spotifyUIApplicationSystem,priority:"normal"}];for(let{name:t,system:i,priority:a}of e)if(i&&(typeof i.onAnimate=="function"||typeof i.updateAnimation=="function")){let r=a,n=60,s=i.currentPerformanceProfile;if(s?.frameRate)n=s.frameRate;else if(s?.quality){let o=s.quality;n=o==="high"?60:o==="low"?30:45}t.includes("BeatSync")?r="critical":(t.includes("Particle")||t.includes("DataGlyph"))&&(r="background",n=Math.min(n,30)),this.enhancedMasterAnimationCoordinator.registerAnimationSystem(t,i,r,n),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F3AC} [Year3000System] Registered ${t} with Enhanced Master Animation Coordinator (${r} priority, ${n}fps) - using ${typeof i.onAnimate=="function"?"onAnimate":"updateAnimation"} hook`)}}async _registerEnhancedAnimationSystems(){if(!this.enhancedMasterAnimationCoordinator){console.warn("[Year3000System] EnhancedMasterAnimationCoordinator not available for enhanced visual system registration");return}let e=[{name:"BeatSyncVisualSystem",system:this.beatSyncVisualSystem,priority:"critical",type:"animation"},{name:"SidebarSystemsIntegration",system:this.sidebarSystemsIntegration,priority:"normal",type:"animation"},{name:"ParticleConsciousnessModule",system:this.particleVisualEffectsModule,priority:"background",type:"animation"},{name:"InteractionTrackingSystem",system:this.interactionTrackingSystem,priority:"background",type:"animation"},{name:"SpotifyUIApplicationSystem",system:this.spotifyUIApplicationSystem,priority:"normal",type:"animation"}];for(let{name:t,system:i,priority:a,type:r}of e)if(i)try{let n=!1;r==="animation"&&(typeof i.onAnimate=="function"||typeof i.updateAnimation=="function")&&(n=this.enhancedMasterAnimationCoordinator.registerAnimationSystem(t,i,a,60)),n&&this.ADVANCED_SYSTEM_CONFIG.enableDebug?console.log(`\u{1F3AC} [Year3000System] Enhanced registration: ${t} (${a} priority, ${r} type)`):n||console.warn(`[Year3000System] Failed to register ${t} with EnhancedMasterAnimationCoordinator`)}catch(n){console.error(`[Year3000System] Error registering ${t} with EnhancedMasterAnimationCoordinator:`,n)}}async initializeWithAvailableAPIs(e){this.availableAPIs=e,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&(console.log(`\u{1F31F} [Year3000System] Progressive initialization mode: ${e.degradedMode?"DEGRADED":"FULL"}`),console.log("\u{1F31F} [Year3000System] Available APIs:",{player:!!e.player,platform:!!e.platform,config:!!e.config})),e.degradedMode?(console.log("\u{1F31F} [Year3000System] Initializing in degraded mode (visual-only systems)"),await this.initializeVisualOnlySystems()):(console.log("\u{1F31F} [Year3000System] Initializing in full mode (all systems)"),await this.initializeAllSystems()),e.degradedMode&&this.setupProgressiveEnhancement()}async initializeVisualOnlySystems(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Starting visual-only system initialization...");let e=performance.now(),t={success:[],failed:[],skipped:[]};try{this.facadeCoordinator=new _t(this.ADVANCED_SYSTEM_CONFIG,this.utils,this),await this.facadeCoordinator.initialize({mode:"performance-optimized",enableSharedDependencies:!0,enableCrossFacadeCommunication:!1,enableUnifiedPerformanceMonitoring:!0,enableResourceOptimization:!0,performanceThresholds:{maxTotalMemoryMB:50,maxTotalInitTime:3e3,maxCrossCommLatency:100},coordinationPreferences:{preferSharedResources:!0,enableEventPropagation:!1,enableHealthCoordination:!0}}),await this._initializeEssentialFacadeSystems(),t.success.push("FacadeCoordinationSystem")}catch(n){console.error("\u{1F30C} [Year3000System] Failed to initialize degraded facade system:",n),t.failed.push("FacadeCoordinationSystem")}let i=["SettingsManager","MusicSyncService","ColorHarmonyEngine","GlassmorphismManager","Card3DManager","All Visual Systems"];t.skipped.push(...i),this._initializationResults=t,this.initialized=!0;let r=performance.now()-e;this.ADVANCED_SYSTEM_CONFIG.enableDebug&&(console.log(`\u{1F31F} [Year3000System] Visual-only initialization complete in ${r.toFixed(2)}ms`),console.log(`\u{1F31F} [Year3000System] Results: ${t.success.length} success, ${t.failed.length} failed, ${t.skipped.length} skipped`))}setupProgressiveEnhancement(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Setting up progressive enhancement monitoring...");let e=0,t=30,i=setInterval(()=>{e++;let a=!!window.Spicetify?.Player,r=!!window.Spicetify?.Platform;a&&r&&this.availableAPIs?.degradedMode&&(this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] APIs now available! Triggering upgrade to full mode..."),clearInterval(i),this.upgradeToFullMode().catch(n=>{console.error("[Year3000System] Upgrade to full mode failed:",n)})),e>=t&&(this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Progressive enhancement monitoring stopped (timeout)"),clearInterval(i))},2e3)}async upgradeToFullMode(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Upgrading from degraded mode to full mode..."),this.availableAPIs={player:window.Spicetify?.Player,platform:window.Spicetify?.Platform,config:window.Spicetify?.Config,degradedMode:!1};try{let e={success:[],failed:[],skipped:[]};try{this.systemHealthMonitor&&this.systemHealthMonitor.registerSystem("SettingsManager",this.settingsManager),e.success.push("SettingsManager")}catch(t){e.failed.push("SettingsManager"),console.error("[Year3000System] Failed to upgrade SettingsManager:",t)}if(this.settingsManager)try{}catch{}if(this.performanceAnalyzer&&this.settingsManager){try{}catch{}this.enhancedMasterAnimationCoordinator&&await this._registerAnimationSystems()}this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("[Year3000System] Checking music analysis setup conditions:",{musicSyncService:!!this.musicSyncService,playerAPI:!!this.availableAPIs.player,musicSyncInitialized:this.musicSyncService?.initialized}),this.musicSyncService&&this.availableAPIs.player?(console.log("\u{1F3B5} [Year3000System] Setting up music analysis and color extraction..."),this.setupMusicAnalysisAndColorExtraction()):console.warn("\u26A0\uFE0F [Year3000System] Music analysis setup skipped - missing dependencies:",{musicSyncService:!!this.musicSyncService,playerAPI:!!this.availableAPIs.player}),this.settingsManager&&await this.applyInitialSettings(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&(console.log(`\u{1F31F} [Year3000System] Upgrade complete: ${e.success.length} success, ${e.failed.length} failed`),e.failed.length>0&&console.warn(`\u{1F31F} [Year3000System] Upgrade failed systems: ${e.failed.join(", ")}`),e.skipped&&e.skipped.length>0&&console.info(`\u{1F31F} [Year3000System] Upgrade skipped systems: ${e.skipped.join(", ")}`),e.success.length>0&&console.info(`\u{1F31F} [Year3000System] Upgrade successful systems: ${e.success.join(", ")}`))}catch(e){console.error("[Year3000System] Error during upgrade to full mode:",e)}}_handleExternalSettingsChange(e){let{key:t,value:i}=e.detail||{};if(t){switch(t){case"artisticMode":{try{typeof this.ADVANCED_SYSTEM_CONFIG.safeSetArtisticMode=="function"&&this.ADVANCED_SYSTEM_CONFIG.safeSetArtisticMode(i)}catch(a){console.warn("[Year3000System] Failed to apply artistic mode",a)}break}case"harmonicIntensity":{let a=parseFloat(i);Number.isNaN(a)||(this.ADVANCED_SYSTEM_CONFIG.colorHarmonyIntensity=a,this.colorHarmonyEngine&&(this.colorHarmonyEngine.setIntensity?.(a),this.updateColorsFromCurrentTrack?.()));break}case"harmonicEvolution":{let a=i==="true"||i===!0;this.allowHarmonicEvolution=a,this.ADVANCED_SYSTEM_CONFIG.colorHarmonyEvolution=a;break}case"manualBaseColor":{typeof i=="string"&&i.trim()!==""&&i.startsWith("#")?(this.updateHarmonicBaseColor(i),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Manual base color applied:",i)):this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Manual base color cleared - using album art colors");break}case"harmonicMode":{i!=null&&(this.ADVANCED_SYSTEM_CONFIG.currentColorHarmonyMode=String(i),this.updateColorsFromCurrentTrack?.());break}default:break}this._broadcastSettingChange(t,i),this._refreshConditionalSystems()}}_broadcastSettingChange(e,t){[this.colorHarmonyEngine,this.glassmorphismManager,this.card3DManager,this.lightweightParticleSystem,this.interactionTrackingSystem,this.beatSyncVisualSystem,this.sidebarSystemsIntegration,this.particleFieldSystem].forEach(a=>{if(a&&typeof a.applyUpdatedSettings=="function")try{a.applyUpdatedSettings(e,t)}catch(r){console.warn(`[Year3000System] ${a.systemName||a.constructor?.name||"UnknownSystem"} failed to applyUpdatedSettings`,r)}})}_applyPerformanceProfile(){}_refreshConditionalSystems(){}_onArtisticModeChanged(){try{this.updateColorsFromCurrentTrack?.()}catch(e){console.warn("[Year3000System] _onArtisticModeChanged stub error",e)}}_handleVisibilityChange(){if(document.visibilityState==="hidden")try{this.cssVariableController?.flushCSSVariableBatch?.();try{}catch{}this.ADVANCED_SYSTEM_CONFIG?.enableDebug&&console.log("\u{1F31F} [Year3000System] Visibility hidden \u2192 forced flush of pending style updates")}catch(e){this.ADVANCED_SYSTEM_CONFIG?.enableDebug&&console.warn("[Year3000System] VisibilityChange flush error",e)}}async destroy(){try{await this.destroyAllSystems(),document.removeEventListener("visibilitychange",this._handleVisibilityChange.bind(this)),this.initialized=!1,console.log("\u{1F31F} [AdvancedThemeSystem] System destroyed successfully")}catch(e){console.error("\u274C [AdvancedThemeSystem] Error during destroy:",e)}}},Mr=new Ut;typeof window<"u"&&(window.advancedThemeSystem=Mr,window.year3000System=Mr);Ks=Mr});var eo={};ie(eo,{enableDragCartography:()=>$c,getDragMap:()=>Wc});function $c(){let c=globalThis;c.__SN_dragCartographer||(c.__SN_dragCartographer=new Xi,console.info("\u{1F6F0}\uFE0F  DragCartographer enabled \u2013 logging dragstart events"))}function Wc(){return Xi.getDragMap()}var We,Xi,to=y(()=>{"use strict";We=class We{constructor(){this.seen=new WeakSet;this.handleDragStart=e=>{let t=e.target;if(!t||this.seen.has(t))return;this.seen.add(t);let i=We.buildSelectorPath(t),a={time:new Date().toLocaleTimeString(),selector:i};try{let s=e.dataTransfer;if(s){let o=s.getData("text/spotify")||s.getData("text/uri-list");o&&(a.uris=o.split(/\n|,/).filter(Boolean));let l=s.getData("text/plain");l&&(a.label=l)}}catch{}let r=We.aggregate,n=r.get(i);n?(n.count+=1,n.samples.length<3&&n.samples.push(a)):r.set(i,{selector:i,count:1,samples:[a]}),console.groupCollapsed(`%c[DragCartographer] dragstart \u2192 ${i}`,"color:#7dd3fc;font-weight:600"),console.table(a),console.log("Event:",e),console.log("Target element snapshot:",t),console.groupEnd()};document.addEventListener("dragstart",this.handleDragStart,!0)}static buildSelectorPath(e){let t=[],i=e,a=0;for(;i&&a<We.MAX_PATH_DEPTH;){let r=i.tagName.toLowerCase(),n=i.id?`#${i.id}`:"",s=i.className&&typeof i.className=="string"?"."+i.className.split(/\s+/).slice(0,2).join("."):"";t.push(`${r}${n}${s}`),i=i.parentElement,a+=1}return t.join(" > ")}static getDragMap(){return Array.from(We.aggregate.values()).sort((e,t)=>t.count-e.count)}};We.MAX_PATH_DEPTH=4,We.aggregate=new Map;Xi=We});function ao(c,e,t={}){let i=`${c}|${e}|${t.size}|${t.dpr}`,a=io.get(i);if(a)return a;let r=t.size??72,n=t.dpr??(window.devicePixelRatio||1),s=t.borderRadius??8,o=document.createElement("canvas");o.width=r*n,o.height=r*n,o.style.width=`${r}px`,o.style.height=`${r}px`;let l=o.getContext("2d");l.scale(n,n),l.fillStyle="rgba(32,32,35,0.9)",l.roundRect(0,0,r,r,s),l.fill(),t.shadow!==!1&&(l.shadowColor="rgba(0,0,0,0.4)",l.shadowBlur=6);let m=r-16;if(e){let h=new Image;h.src=e;let g=()=>{l.save(),l.beginPath(),l.roundRect(8,8,m,m,s-2),l.clip(),l.drawImage(h,8,8,m,m),l.restore(),d()};h.complete?g():(h.onload=g,h.onerror=d)}else d();function d(){l.fillStyle="#fff",l.font="500 12px Inter, sans-serif",l.textAlign="center",l.textBaseline="middle";let h=r-10,g=c;for(;l.measureText(g).width>h&&g.length>4;)g=g.slice(0,-2);g!==c&&(g=g.slice(0,-1)+"\u2026"),l.fillText(g,r/2,r-10)}return io.set(i,o),o}var io,ro=y(()=>{"use strict";io=new Map});var so={};ie(so,{enableEnhancedDragPreview:()=>Xc});function Yc(c,e){try{return ao(c,e)}catch{let t=document.createElement("div");return t.textContent=c,t.style.padding="4px 6px",t.style.fontSize="12px",t.style.background="rgba(32,32,35,0.9)",t.style.color="#fff",t}}function no(c){let e=c.querySelector("img[src]");if(e?.src)return e.src;let t=getComputedStyle(c).backgroundImage,i=t&&/url\("?([^\"]+)"?\)/.exec(t);return i?i[1]:void 0}function Kc(c){let e=c.getAttribute("aria-label")||c.getAttribute("title");return e||(document.createTreeWalker(c,NodeFilter.SHOW_TEXT,{acceptNode(a){return a.textContent?.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}}).nextNode()?.textContent?.trim()||"").slice(0,60)}function jc(c){if(Pr.has(c))return Pr.get(c);let e=Kc(c);if(!e)return null;let t=no(c),i=t?{label:e,img:t}:{label:e};return Pr.set(c,i),i}function Qc(c){try{if(!c.dataTransfer||typeof c.dataTransfer.setDragImage!="function")return;let e=c.target;if(!e)return;let t=c.dataTransfer.getData("text/plain"),i;if(t)i=no(e);else{let s=jc(e);if(!s)return;t=s.label,i=s.img}let a=Yc(t,i);document.body.appendChild(a);let r=a.offsetWidth/2;c.dataTransfer.setDragImage(a,r,r);let n=()=>{a.remove(),window.removeEventListener("dragend",n,!0)};window.addEventListener("dragend",n,!0)}catch(e){console.debug("[StarryNight] DragPreviewManager failed:",e)}}function Xc(c={}){let e=globalThis;e.__SN_enhancedDragPreview||(e.__SN_enhancedDragPreview=!0,Object.assign(qc,c),document.addEventListener("dragstart",Qc,!0),console.info("\u{1F320} Enhanced drag preview enabled"))}var qc,Pr,oo=y(()=>{"use strict";ro();qc={size:72,borderRadius:8,fontSize:12},Pr=new WeakMap});function Zi(c){let e=c.stiffness??260,t=c.damping??24,i=c.mass??1,a={},r={},n={},s=null;function o(){let l=!0,m=1/60;for(let d in n){let h=a[d]??0,g=r[d]??0,f=n[d]??0,S=-e*(h-f),C=-t*g,T=(S+C)/i,w=g+T*m,R=h+w*m;r[d]=w,a[d]=R,(Math.abs(w)>.1||Math.abs(R-f)>.1)&&(l=!1)}c.onUpdate(a),l||(s=requestAnimationFrame(o))}return{to(l){n=l,s||(s=requestAnimationFrame(o))}}}var Ar=y(()=>{"use strict";window.snFlipSpringLoaded=!0});function xr(){let c=document.querySelector(Zc);if(!c)return null;let e=c.getBoundingClientRect();return{node:c,rect:e}}function Ir(){let c=!!xr(),e=typeof Element.prototype.cloneNode=="function",t=!!window.snFlipSpringLoaded;return c&&e&&t}var Zc,Dr=y(()=>{"use strict";Zc='[data-testid="rootlist-container"]'});var uo={};ie(uo,{destroySidebarClone:()=>Ji,launchSidebarClone:()=>Jc});function Jc(c){Ye&&(Ye.abort(),Ye=null),qe&&Ji(),Ye=new AbortController;let{signal:e}=Ye;if(qe)return;let t=xr();if(!t)return;let i=t.node.cloneNode(!0);i.id="",i.setAttribute("aria-hidden","true"),i.classList.add("sn-clone-overlay"),i.style.position="fixed",i.style.top=`${t.rect.top}px`,i.style.left=`${t.rect.left}px`,i.style.width=`${t.rect.width}px`,i.style.height=`${t.rect.height}px`,i.style.zIndex="9999",i.style.willChange="transform, opacity",i.style.contain="paint",function(f){let S=document.createTreeWalker(f,NodeFilter.SHOW_ELEMENT);for(;S.nextNode();){let C=S.currentNode;C.hasAttribute("aria-label")&&C.removeAttribute("aria-label"),C.tabIndex>=0&&(C.tabIndex=-1)}}(i),document.body.appendChild(i),qe=i;let a=0,r=0,n=1,s=c.cursorX-t.rect.left-t.rect.width*.2,o=c.cursorY-t.rect.top-t.rect.height*.2,l=.6;if(window.matchMedia("(prefers-reduced-motion: reduce)").matches){i.style.transform=`translate(${s}px, ${o}px) scale(${l})`,lo(i,c);return}let d=Zi({stiffness:220,damping:20,onUpdate:g=>{e.aborted||(i.style.transform=`translate(${g.x}px, ${g.y}px) scale(${g.s})`)}});i.style.transformOrigin="top left",i.style.transform=`translate(${a}px, ${r}px) scale(${n})`,requestAnimationFrame(()=>d.to({x:s,y:o,s:l}));let h=setTimeout(()=>{!e.aborted&&qe&&lo(qe,c)},400);e.addEventListener("abort",()=>clearTimeout(h)),e.addEventListener("abort",()=>Ji())}function Ji(){kr.forEach(c=>c()),kr.length=0,qe&&(qe.remove(),qe=null),Ye&&(Ye.abort(),Ye=null)}function el(c,e){try{let t=window.Spicetify?.CosmosAsync;if(!t)return;let i=`/v1/playlists/${c.split(":").pop()}/tracks`;t.post(i,{uris:e})}catch{}}function lo(c,e){let t=Array.from(c.querySelectorAll('[data-uri^="spotify:playlist:"]'));if(!t.length)return;let i=t.slice(0,5);t.slice(5).forEach(r=>{r.classList.add("sn-prune-out"),setTimeout(()=>r.remove(),180)}),i.forEach((r,n)=>{r.setAttribute("data-index",String(n+1)),r.setAttribute("role","button"),r.tabIndex=0,r.style.setProperty("--sn-glow-level","0"),r.style.backgroundImage="paint(sn-aura)",r.addEventListener("mouseenter",()=>r.style.setProperty("--sn-glow-level","1")),r.addEventListener("mouseleave",()=>r.style.setProperty("--sn-glow-level","0"));let s=r.getAttribute("data-uri");if(!s)return;let o=e.uris,l=m=>{m.preventDefault(),m.stopPropagation();let d=r.querySelector("img");tl(s,d?.src||"",r.textContent?.trim()||"Playlist"),el(s,o),il("Track added to "+(r.textContent?.trim()||"playlist")),Ji()};r.addEventListener("click",l),r.addEventListener("keydown",m=>{(m.key==="Enter"||m.key===" ")&&l(m)})});let a=r=>{let n=parseInt(r.key,10);n>=1&&n<=i.length&&i[n-1]?.click()};window.addEventListener("keydown",a,{capture:!0}),kr.push(()=>window.removeEventListener("keydown",a,{capture:!0}))}function tl(c,e,t){try{let i=localStorage.getItem(co),a=i?JSON.parse(i):[],r=a.findIndex(n=>n.uri===c);r!==-1&&a.splice(r,1),a.unshift({uri:c,image:e,name:t}),localStorage.setItem(co,JSON.stringify(a.slice(0,10)))}catch{}}function il(c){let e=document.getElementById("sn-live");e&&(e.textContent=c)}var qe,kr,Ye,co,mo=y(()=>{"use strict";Ar();Dr();qe=null,kr=[],Ye=null,co="sn-recent-playlists"});var go={};ie(go,{enableQuickAddRadialMenu:()=>fl});function nl(){let c=document.getElementById(Vr);return c||(c=document.createElement("div"),c.id=Vr,c.setAttribute("aria-live","polite"),c.style.position="absolute",c.style.width="1px",c.style.height="1px",c.style.overflow="hidden",c.style.clipPath="inset(100%)",c.style.clip="rect(1px,1px,1px,1px)",c.style.whiteSpace="nowrap",document.body.appendChild(c)),c}function sl(c,e,t,i){let a=c-t,r=e-i;return Math.sqrt(a*a+r*r)}function ho(){try{let c=localStorage.getItem("sn-recent-playlists");if(!c)return[];let e=JSON.parse(c);return Array.isArray(e)?e.slice(0,ea):[]}catch{return[]}}function ol(c,e){try{let t=`/v1/playlists/${c.split(":").pop()}/tracks`;window.Spicetify?.CosmosAsync.post(t,{uris:e})}catch(t){console.warn("[StarryNight] QuickAddRadial failed to add tracks:",t)}}function cl(c){try{let e=ho(),t=e.findIndex(a=>a.uri===c.uri);t!==-1&&e.splice(t,1),e.unshift(c);let i=e.slice(0,10);localStorage.setItem("sn-recent-playlists",JSON.stringify(i))}catch{}}function ll(c,e,t){if(!t.length)return;Fr(),ce=document.createElement("div"),ce.className="sn-quick-add-overlay",ce.style.position="fixed",ce.style.inset="0",ce.style.pointerEvents="none",ce.style.zIndex="9999";let i=document.createElement("div");i.className="sn-quick-add-center",i.style.position="absolute",i.style.left=`${c}px`,i.style.top=`${e}px`,i.style.width="0",i.style.height="0",ce.appendChild(i),document.body.appendChild(ce);let a=90,r=Math.PI*2/t.length;t.forEach((s,o)=>{let l=r*o-Math.PI/2,m=document.createElement("button");m.className="sn-quick-add-btn",m.style.position="absolute",m.style.width="64px",m.style.height="64px",m.style.borderRadius="50%",m.style.border="2px solid rgba(255,255,255,0.4)",m.style.background=`url('${s.image}') center/cover no-repeat`,m.style.cursor="pointer",m.style.pointerEvents="auto";let d=a*Math.cos(l),h=a*Math.sin(l);m.style.transform=`translate(${d-32}px, ${h-32}px)`,m.style.transformOrigin="center center";let g=0,f=0;m.style.transform=`translate(${g}px, ${f}px) scale(0.1)`,requestAnimationFrame(()=>{Zi({stiffness:220,damping:20,onUpdate:C=>{m.style.transform=`translate(${C.x}px, ${C.y}px) scale(${C.s})`}}).to({x:d-32,y:h-32,s:1})}),m.title=`Add to ${s.name}`,m.addEventListener("click",S=>{S.preventDefault(),S.stopPropagation(),Yt&&ol(s.uri,Yt),cl(s),Fr()}),i.appendChild(m)});let n=nl();n.textContent="Quick-add menu open. Press number keys 1 to 5 to pick a playlist or continue dragging."}function Fr(){ce?.remove(),ce=null;let c=document.getElementById(Vr);c&&(c.textContent="")}function Gr(){qt&&(clearTimeout(qt),qt=null)}function ul(c){Lr=c.clientX,Rr=c.clientY,Yt=(c.dataTransfer?.getData("text/spotify")||"").split(/[\n,]/).filter(Boolean);let e=Ir();Gr(),qt=window.setTimeout(async()=>{if(e)(await Promise.resolve().then(()=>(mo(),uo))).launchSidebarClone({cursorX:Br.x,cursorY:Br.y,uris:Yt??[]});else{let t=await pl();ll(Lr,Rr,t)}},al)}function ml(){Gr(),Fr(),Yt=null}function dl(c){Br={x:c.clientX,y:c.clientY},qt&&sl(Lr,Rr,c.clientX,c.clientY)>rl&&Gr()}async function hl(){try{let c=window.Spicetify?.CosmosAsync;if(!c)return[];let e=await c.get("https://api.spotify.com/v1/me/playlists?limit=10");return e?.items?e.items.slice(0,ea).map(t=>({uri:t.uri,name:t.name,image:t.images?.[0]?.url||""})):[]}catch{return[]}}function gl(){try{let c=Array.from(document.querySelectorAll('[data-testid="rootlist-card"]')),e=[];for(let t of c){let i=t.getAttribute("data-uri")||t.querySelector("a")?.getAttribute("href")?.replace("/playlist/","spotify:playlist:");if(!i)continue;let a=t.querySelector("img"),r=a?.src||"",n=a?.alt||t.textContent?.trim()||"Playlist";if(e.push({uri:i,image:r,name:n}),e.length>=ea)break}return e}catch{return[]}}async function pl(){let c=ho();if(c.length)return c;let e=gl();return e.length?e:await hl()}function fl(){let c=globalThis;c.__SN_quickAddRadial||(c.__SN_quickAddRadial=!0,window.addEventListener("dragstart",ul,!0),window.addEventListener("dragend",ml,!0),window.addEventListener("pointermove",dl,!0),console.info("\u{1F30C} Quick-Add radial menu enabled"),console.info(`[StarryNight] Sidebar clone capability: ${Ir()}`))}var al,rl,ea,qt,Lr,Rr,ce,Yt,Br,Vr,po=y(()=>{"use strict";Ar();Dr();al=250,rl=8,ea=5,qt=null,Lr=0,Rr=0,ce=null,Yt=null,Br={x:0,y:0},Vr="sn-live";document.addEventListener("keydown",c=>{if(!ce)return;let e=parseInt(c.key,10);e>=1&&e<=ea&&ce.querySelectorAll(".sn-quick-add-btn")[e-1]?.click()})});var yo={};ie(yo,{PrismaticScrollSheenSystem:()=>ta,initializePrismaticScrollSheen:()=>fo});function fo(){try{let c=new ta;Ks?.registerVisualSystem?.(c,"background")}catch(c){console.error("[PrismaticScrollSheen] Failed to init:",c)}}var yl,ta,bo=y(()=>{"use strict";Er();$();yl=6e3,ta=class{constructor(e=yl){this.cyclePx=e;this.systemName="PrismaticScrollSheen";this._lastRatio=-1;let t=globalThis.year3000System;this.cssController=t?.cssConsciousnessController||P(),this.cssController.setVariable("PrismaticScrollSheenSystem","--sn-scroll-cycle-px",String(e),"normal","scroll-cycle-init")}onAnimate(e,t){let i=t.scrollRatio??0;if(Math.abs(i-this._lastRatio)<.001)return;this._lastRatio=i;let a={"--sn-cdf-scroll-ratio":i.toFixed(4),"--sn-scroll-ratio":i.toFixed(4)};this.cssController.batchSetVariables("PrismaticScrollSheenSystem",a,"high","scroll-ratio-update")}onPerformanceModeChange(){}destroy(){}};window.Y3K?.system?.registerVisualSystem&&fo()});var q,vo,ia,So=y(()=>{"use strict";q=Yr(Wr("react")),vo=Yr(Wr("react-dom")),ia=class{constructor(e,t,i={}){this.name=e;this.settingsId=t;this.initialSettingsFields=i;this.settingsFields=this.initialSettingsFields;this.setRerender=null;this.pushSettings=async()=>{for(Object.entries(this.settingsFields).forEach(([e,t])=>{t.type!=="button"&&this.getFieldValue(e)===void 0&&this.setFieldValue(e,t.defaultValue)});!window.Spicetify?.Platform?.History?.listen;)await new Promise(e=>setTimeout(e,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=window.Spicetify.Platform.History.listen(e=>{e.pathname==="/preferences"&&this.render()}),window.Spicetify.Platform.History.location.pathname==="/preferences"&&await this.render()};this.rerender=()=>{this.setRerender?.(Math.random())};this.addDropDown=(e,t,i,a,r,n)=>{this.settingsFields[e]={type:"dropdown",description:t,defaultValue:i[a],options:i,events:n}};this.addToggle=(e,t,i,a)=>{this.settingsFields[e]={type:"toggle",description:t,defaultValue:i,events:a}};this.addInput=(e,t,i,a="text",r)=>{this.settingsFields[e]={type:"input",description:t,defaultValue:i,inputType:a,events:r}};this.getFieldValue=e=>{let t=window.Spicetify?.LocalStorage.get(e);if(t==null){let i=`${this.settingsId}.${e}`,a=window.Spicetify?.LocalStorage.get(i);if(a)try{let n=JSON.parse(a)?.value??a;return window.Spicetify?.LocalStorage.set(e,n),window.Spicetify?.LocalStorage.remove(i),n}catch{return a}return}return t};this.FieldsContainer=()=>{let[e,t]=(0,q.useState)(0);return this.setRerender=t,q.default.createElement("div",{className:"x-settings-section",key:e},q.default.createElement("h2",{className:"TypeElement-cello-textBase-type"},this.name),Object.entries(this.settingsFields).map(([i,a])=>q.default.createElement(this.Field,{key:i,nameId:i,field:a})))};this.Field=({nameId:e,field:t})=>{let i=`${this.settingsId}.${e}`,a=t.type==="button"?t.value:this.getFieldValue(e)??t.defaultValue,[r,n]=(0,q.useState)(a),s=m=>{n(m),this.setFieldValue(e,m);try{let d=new CustomEvent("year3000SystemSettingsChanged",{detail:{key:e,value:m}});document.dispatchEvent(d)}catch(d){console.warn(`[SettingsSection] Failed to emit settings change event for ${e}:`,d)}};if(t.type==="hidden")return q.default.createElement(q.default.Fragment,null);let o=q.default.createElement("label",{className:"TypeElement-viola-textSubdued-type",htmlFor:i},t.description||""),l=null;switch(t.type){case"dropdown":l=q.default.createElement("select",{className:"main-dropDown-dropDown",id:i,...t.events,onChange:m=>{let d=m.currentTarget.selectedIndex,h=t.options[d];s(h),t.events?.onChange?.(m)}},t.options.map((m,d)=>q.default.createElement("option",{key:m,value:m,selected:m===r},m)));break;case"toggle":l=q.default.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},q.default.createElement("input",{id:i,className:"x-toggle-input",type:"checkbox",checked:!!r,...t.events,onClick:m=>{let d=m.currentTarget.checked;s(d),t.events?.onClick?.(m)}}),q.default.createElement("span",{className:"x-toggle-indicatorWrapper"},q.default.createElement("span",{className:"x-toggle-indicator"})));break;case"input":l=q.default.createElement("input",{className:"x-settings-input",id:i,dir:"ltr",value:r,type:t.inputType||"text",...t.events,onChange:m=>{s(m.currentTarget.value),t.events?.onChange?.(m)}});break;case"button":l=q.default.createElement("button",{id:i,className:"Button-sc-y0gtbx-0 Button-small-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button",...t.events,onClick:m=>{t.events?.onClick?.(m)},type:"button"},r);break;default:l=null}return q.default.createElement("div",{className:"x-settings-row"},q.default.createElement("div",{className:"x-settings-firstColumn"},o),q.default.createElement("div",{className:"x-settings-secondColumn"},l))}}async render(){for(;!document.getElementById("desktop.settings.selectLanguage");){if(window.Spicetify.Platform.History.location.pathname!=="/preferences")return;await new Promise(i=>setTimeout(i,100))}let e=document.querySelector(".main-view-container__scroll-node-child main div");if(!e)return console.error("[StarryNight] settings container not found");let t=Array.from(e.children).find(i=>i.id===this.settingsId);t||(t=document.createElement("div"),t.id=this.settingsId,e.appendChild(t)),vo.default.render(q.default.createElement(this.FieldsContainer,null),t)}setFieldValue(e,t){window.Spicetify?.LocalStorage.set(e,t)}}});var Hr={};ie(Hr,{initializeStarryNightSettings:()=>bl});function Co(){return globalThis.year3000System?.cssConsciousnessController||P()}async function bl(){let c=new ia("StarryNight Theme","starrynight-settings"),e=["dynamic","rosewater","flamingo","pink","mauve","red","maroon","peach","yellow","green","teal","sky","sapphire","blue","lavender"];function t(){let V=window.Y3K?.system?.settingsManager;if(V)return V;let G=globalThis.__SN_settingsManager;if(G)return G;let _=new ee;return globalThis.__SN_settingsManager=_,_}let i=t(),a=i.get("catppuccin-accentColor");c.addDropDown("catppuccin-accentColor","Accent colour (primary theme color)",e,Math.max(0,e.indexOf(a)),void 0,{onChange:V=>{try{let G=V?.currentTarget?.selectedIndex??0,_=e[G]??"mauve";i.set("catppuccin-accentColor",_);let jt=i.get("sn-gradient-intensity");zt(jt,jt);try{globalThis.Y3K?.system?.applyInitialSettings?.("accent")}catch(aa){console.warn("[StarryNight] Unable to trigger Year3000System colour refresh",aa)}}catch(G){console.error("[StarryNight] Failed to update accent colour",G)}}});let r=["disabled","minimal","balanced","intense"],n=i.get("sn-gradient-intensity");c.addDropDown("sn-gradient-intensity","Background effects intensity (stars, nebula, flow gradients)",r,Math.max(0,r.indexOf(n)),void 0,{onChange:V=>{let G=V?.currentTarget?.selectedIndex??0,_=r[G]??"balanced";i.set("sn-gradient-intensity",_),zt(_,_)}});let s=["bright","balanced","dark"],o=i.get("sn-brightness-mode")||"dark";c.addDropDown("sn-brightness-mode","Brightness mode",s,Math.max(0,s.indexOf(o)),void 0,{onChange:V=>{let G=V?.currentTarget?.selectedIndex??0,_=s[G]??"bright";i.set("sn-brightness-mode",_);let jt=Co(),aa={"--sn-brightness-mode":`"${_}"`,"--sn-brightness-data-attr":_};jt.batchSetVariables("StarryNightSettings",aa,"high","brightness-mode-change"),document.documentElement.setAttribute("data-sn-brightness",_);try{globalThis.Y3K?.system?.applyInitialSettings?.("brightness"),console.log(`[StarryNight] Brightness mode changed to: ${_}`)}catch(xo){console.warn("[StarryNight] Unable to trigger Year3000System brightness refresh",xo)}}});let l=["latte","frappe","macchiato","mocha"],m=i.get("catppuccin-flavor");c.addDropDown("catppuccin-flavor","Catppuccin flavour (light/dark theme base)",l,Math.max(0,l.indexOf(m)),void 0,{onChange:V=>{let G=V?.currentTarget?.selectedIndex??0;i.set("catppuccin-flavor",l[G]);try{globalThis.Y3K?.system?.applyInitialSettings?.("flavor")}catch(_){console.warn("[StarryNight] Unable to trigger flavor refresh",_)}}});let d=["catppuccin","year3000"],h=["Catppuccin Classic","Year 3000 Cinematic"],g=i.get("sn-palette-system");c.addDropDown("sn-palette-system","Palette system (color foundation vs enhancement)",h,Math.max(0,d.indexOf(g)),void 0,{onChange:V=>{let G=V?.currentTarget?.selectedIndex??0;i.set("sn-palette-system",d[G]);try{globalThis.Y3K?.system?.applyInitialSettings?.("palette")}catch(_){console.warn("[StarryNight] Unable to trigger palette system refresh",_)}}});let f=["disabled","minimal","moderate","intense"],S=i.get("sn-glassmorphism-level");c.addDropDown("sn-glassmorphism-level","Glassmorphism",f,Math.max(0,f.indexOf(S)),void 0,{onChange:V=>{let G=V?.currentTarget?.selectedIndex??0;i.set("sn-glassmorphism-level",f[G])}});let C=["corporate-safe","artist-vision","cosmic-maximum"],T=i.get("sn-artistic-mode");c.addDropDown("sn-artistic-mode","Artistic mode",C,Math.max(0,C.indexOf(T)),void 0,{onChange:V=>{let G=V?.currentTarget?.selectedIndex??0,_=C[G];i.set("sn-artistic-mode",_),globalThis.year3000System?.ADVANCED_SYSTEM_CONFIG?.safeSetArtisticMode?.(_)}});let w=Object.keys(ve),R=i.get("sn-current-harmonic-mode");w.length&&c.addDropDown("sn-current-harmonic-mode","Harmonic colour mode",w,Math.max(0,w.indexOf(R)),void 0,{onChange:V=>{let G=V?.currentTarget?.selectedIndex??0,_=w[G];i.set("sn-current-harmonic-mode",_),globalThis.Y3K?.system?.evolveHarmonicSignature?.(_)}});let O=i.get("sn-harmonic-intensity")||"0.7";c.addInput("sn-harmonic-intensity","Harmonic intensity (music-color sync strength 0-1)",O,"number",{onChange:V=>{let G=V.currentTarget.value;i.set("sn-harmonic-intensity",G)}});let F=i.get("sn-harmonic-evolution")==="true";c.addToggle("sn-harmonic-evolution","Allow harmonic evolution",F,{onClick:V=>{let G=V.currentTarget.checked;i.set("sn-harmonic-evolution",G?"true":"false")}});let B=i.get("sn-webgl-enabled")==="true";c.addToggle("sn-webgl-enabled","WebGL effects (master toggle for all WebGL backgrounds)",B,{onClick:V=>{let G=V.currentTarget.checked;i.set("sn-webgl-enabled",G?"true":"false")}});let W=["low","medium","high"],z=i.get("sn-webgl-quality")||"medium";c.addDropDown("sn-webgl-quality","WebGL quality (performance vs visual quality)",W,Math.max(0,W.indexOf(z)),void 0,{onChange:V=>{let G=V?.currentTarget?.selectedIndex??1,_=W[G]??"medium";i.set("sn-webgl-quality",_)}});let I=["auto","low","high"],re=i.get("sn-animation-quality")||"auto";c.addDropDown("sn-animation-quality","Animation quality (auto/low/high performance)",I,Math.max(0,I.indexOf(re)),void 0,{onChange:V=>{let G=V?.currentTarget?.selectedIndex??0,_=I[G]??"auto";i.set("sn-animation-quality",_)}}),await c.pushSettings(),console.log("\u2728 [StarryNight] spcr-settings panel initialised");let De=i.get("sn-brightness-mode")||"dark",fe=Co(),it={"--sn-brightness-mode":`"${De}"`,"--sn-brightness-data-attr":De};fe.batchSetVariables("StarryNightSettings",it,"high","brightness-mode-init"),document.documentElement.setAttribute("data-sn-brightness",De),console.log(`[StarryNight] Initial brightness mode set to: ${De}`);let Nr=()=>c.rerender(),$r=globalThis.Spicetify?.Platform?.History;try{$r?.listen&&$r.listen(({location:V})=>{V?.pathname==="/settings"&&setTimeout(Nr,100)})}catch(V){console.warn("[StarryNight] Could not hook navigation for settings",V)}window.location.pathname==="/settings"&&setTimeout(Nr,300)}var _r=y(()=>{"use strict";U();$();So();Fe();Cr()});var Mo={};ie(Mo,{DepthVisualEffectsController:()=>zr});var zr,Eo=y(()=>{"use strict";U();$();x();X();de();zr=class extends j{constructor(t=E,i=D,a=null,r=null,n=null){super(t,i,a,r,n);this.contentAreas=new Map;this.chromeAreas=new Set;this.userState={isScrolling:!1,isHovering:!1,lastInteractionTime:0,readingModeActive:!1,interactionTarget:null,currentMode:"browsing",focusDepth:.3,scrollVelocity:0,dwellTime:0,interactionPattern:"casual",contentEngagement:.5};this.musicalState={energy:.5,valence:.5,instrumental:!1,tempo:120,emotionalTemperature:.5,musicSyncStrength:.7,genreVisualEffectsProfile:{ambientLevel:.5,energyResponse:.6,visualComplexity:.5},musicalMemoryPatterns:.4};this.readingModeTimer=0;this.interactionTimer=0;this.visualEffectsUpdateInterval=0;this.lastUpdate=0;this.updateThreshold=100;this.visualEffectsIntensity=.7;this.adaptiveProtectionMap=new Map;this.scrollVelocityHistory=[];this.dwellTimeTracker=new Map}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{let t=globalThis.year3000System;this.cssController=t?.cssVisualEffectsController||P(),this.detectContentAndChromeAreas(),this.setupInteractionListeners(),this.initializeVisualEffectsVariables(),this.startVisualEffectsUpdate(),u?.debug?.log("DepthVisualEffectsController","VisualEffects system awakened")}catch(t){u?.debug?.error("DepthVisualEffectsController","Failed to initialize visualEffects:",t)}}detectContentAndChromeAreas(){let t={text:[".main-view-container__scroll-node",".main-trackList-trackListRow",'[data-testid*="tracklist"]','[data-testid*="playlist"]',".main-entityHeader-titleText",".main-entityHeader-subtitle",".main-trackList-rowTitle",".main-trackList-rowSubTitle","h1, h2, h3, h4, h5, h6","p",".lyrics-lyricsContainer-container",".main-cardSubHeader-root",".main-trackList-indexNumber",".main-trackInfo-name",".main-trackInfo-artists"],interactive:["button","a[role='button']","[tabindex='0']",".main-playButton-button",".main-addButton-button",".main-moreButton-button",".main-trackList-rowPlayPause",".control-button","input","select"],visual:[".main-image-container",".main-entityHeader-image",".cover-art",".main-coverSlot-container",".main-image-image"],media:["video","audio",".main-nowPlayingWidget-trackInfo",".main-coverSlot-container",".main-nowPlayingView-coverArt"],navigation:[".main-navBar-navBarLink",".main-rootlist-rootlistItem",".main-collectionLinkText-text"]},i=[".Root__nav-bar",".Root__top-bar",".Root__now-playing-bar",".main-topBar-container",".main-navBar-navBar",".main-entityHeader-container",".main-actionBar-container",".main-view-container",".Root__main-view",".main-rootlist-wrapper"];Object.entries(t).forEach(([r,n])=>{n.forEach(s=>{document.querySelectorAll(s).forEach(o=>{let l={element:o,type:r,protectionLevel:this.calculateAdvancedProtectionLevel(o,r),lastInteraction:0,visualEffectsLevel:this.calculateVisualEffectsLevel(o),readingIntensity:0,contextualImportance:this.calculateContextualImportance(o),adaptiveProtection:this.calculateProtectionLevel(o)};this.contentAreas.set(o,l),o.classList.add("content-sanctuary"),o.classList.add(`content-${r}`),o.setAttribute("data-visualEffects-protected","true"),o.setAttribute("data-content-type",l.type),o.setAttribute("data-visualEffects-level",l.visualEffectsLevel.toString()),o.setAttribute("data-contextual-importance",l.contextualImportance.toString()),this.adaptiveProtectionMap.set(o,l.adaptiveProtection),this.dwellTimeTracker.set(o,0)})})}),i.forEach(r=>{document.querySelectorAll(r).forEach(n=>{this.chromeAreas.add(n),n.classList.add("ui-chrome-area"),n.setAttribute("data-visualEffects-enhanced","true")})});let a=this.analyzeContentDistribution();u?.debug?.log("DepthVisualEffectsController",`Enhanced detection: ${this.contentAreas.size} content areas, ${this.chromeAreas.size} chrome areas`,a)}determineContentType(t){return t.matches("h1, h2, h3, h4, h5, h6, .main-entityHeader-titleText")?"text":t.matches('button, a, [role="button"], [tabindex], input, select')?"interactive":t.matches(".main-image-container, .main-entityHeader-image, .cover-art")?"visual":t.matches(".Root__nav-bar, .Root__top-bar, .main-topBar-container")?"chrome":"text"}calculateProtectionLevel(t){switch(this.determineContentType(t)){case"text":return .95;case"interactive":return .9;case"visual":return .6;case"chrome":return .3;case"media":return .5;case"navigation":return .7;default:return .85}}calculateAdvancedProtectionLevel(t,i){let a=this.calculateProtectionLevel(t),r=0;i==="text"&&t.textContent&&t.textContent.length>50&&(r+=.05);let n=t.getBoundingClientRect();return n.top>=0&&n.left>=0&&n.bottom<=window.innerHeight&&n.right<=window.innerWidth&&(r+=.02),t.matches('h1, h2, .main-entityHeader-titleText, [data-testid*="title"]')&&(r+=.03),Math.min(a+r,.98)}calculateVisualEffectsLevel(t){let i=t.getBoundingClientRect(),a=i.width*i.height,r=window.innerWidth*window.innerHeight,n=a/r,s=Math.min(n*2,.8);return t.matches(".Root__main-view, .main-view-container")&&(s+=.3),t.matches(".main-nowPlayingBar-container")&&(s+=.4),Math.min(s,1)}calculateContextualImportance(t){let i=.5;return t.matches('button, a, [role="button"], [tabindex="0"]')&&(i+=.2),t.matches(".main-view-container, .main-entityHeader, .main-trackList")&&(i+=.3),t.matches(".main-nowPlayingWidget, .main-nowPlayingBar")&&(i+=.4),t.matches(":focus, :focus-within, :hover")&&(i+=.2),Math.min(i,1)}analyzeContentDistribution(){let t={totalAreas:this.contentAreas.size,textAreas:0,interactiveAreas:0,visualAreas:0,mediaAreas:0,navigationAreas:0,chromeAreas:this.chromeAreas.size,averageProtection:0,highProtectionAreas:0},i=0;return this.contentAreas.forEach(a=>{switch(a.type){case"text":t.textAreas++;break;case"interactive":t.interactiveAreas++;break;case"visual":t.visualAreas++;break;case"media":t.mediaAreas++;break;case"navigation":t.navigationAreas++;break}i+=a.protectionLevel,a.protectionLevel>.8&&t.highProtectionAreas++}),t.averageProtection=i/this.contentAreas.size||0,t}analyzeScrollingBehavior(){if(this.scrollVelocityHistory.length<3)return;let t=this.scrollVelocityHistory.reduce((a,r)=>a+r,0)/this.scrollVelocityHistory.length,i=this.scrollVelocityHistory.reduce((a,r)=>a+Math.pow(r-t,2),0)/this.scrollVelocityHistory.length;i<100&&t<300?(this.userState.contentEngagement=Math.min(this.userState.contentEngagement+.05,1),this.userState.interactionPattern="contemplative"):t>1500&&i>500?(this.userState.contentEngagement=Math.max(this.userState.contentEngagement-.1,.1),this.userState.interactionPattern="rapid"):this.userState.interactionPattern="casual",this.userState.contentEngagement>.7?this.visualEffectsIntensity=Math.min(this.visualEffectsIntensity+.05,.9):this.userState.contentEngagement<.3&&(this.visualEffectsIntensity=Math.max(this.visualEffectsIntensity-.1,.3))}calculateInteractionModifier(){let t=0;if(this.userState.readingModeActive&&(t-=.6),this.userState.isHovering){let i=this.contentAreas.get(this.userState.interactionTarget);if(i){let a=i.type==="text"?.4:i.type==="interactive"?.3:i.type==="chrome"?.1:.2;t-=a}}return this.userState.scrollVelocity>1e3&&(t-=.2),this.userState.focusDepth>.7&&!this.userState.readingModeActive&&(t+=.2),t}calculateContextualModifier(){let t=0;return this.userState.interactionTarget?.matches(".main-nowPlayingBar, .main-nowPlayingWidget")&&(t+=.3),this.userState.interactionTarget?.matches(".main-trackList, .main-entityHeader-subtitle")&&(t-=this.userState.currentMode==="exploring"?.1:.3),this.userState.currentMode==="ambient"&&(t+=.4),this.userState.currentMode==="navigating"&&(t-=.2),t}getModeNumericValue(t){return{reading:0,browsing:1,exploring:2,navigating:3,ambient:4}[t]/4}getPatternNumericValue(t){return{contemplative:0,casual:1,deliberate:2,rapid:3}[t]/3}calculateSurfaceFluidityIndex(){let t=.5;return t+=this.musicalState.energy*.3,t+=this.userState.contentEngagement*.2,t+=this.musicalState.emotionalTemperature*.2,this.userState.interactionPattern==="contemplative"?t-=.2:this.userState.interactionPattern==="rapid"&&(t+=.3),Math.max(.1,Math.min(1,t))}calculateGenreVisualEffectsShift(){if(!this.musicalState.genre)return .5;let i={ambient:.8,electronic:.7,classical:.6,jazz:.5,rock:.4,pop:.3,"hip-hop":.2}[this.musicalState.genre.toLowerCase()]||.5,a=0;return this.musicalState.valence>.7&&(a+=.1),this.musicalState.energy>.8&&(a+=.1),Math.max(.1,Math.min(1,i+a))}setupInteractionListeners(){let t,i=window.scrollY,a=Date.now();document.addEventListener("scroll",()=>{let s=Date.now(),o=window.scrollY,l=s-a,m=Math.abs(o-i);this.userState.scrollVelocity=l>0?m/l*1e3:0,this.scrollVelocityHistory.push(this.userState.scrollVelocity),this.scrollVelocityHistory.length>10&&this.scrollVelocityHistory.shift();let d=this.scrollVelocityHistory.reduce((h,g)=>h+g,0)/this.scrollVelocityHistory.length;d>2e3?(this.userState.interactionPattern="rapid",this.userState.currentMode="browsing"):d>500?(this.userState.interactionPattern="deliberate",this.userState.currentMode="exploring"):this.userState.interactionPattern="contemplative",this.userState.isScrolling=!0,this.userState.lastInteractionTime=s,i=o,a=s,clearTimeout(t),t=window.setTimeout(()=>{this.userState.isScrolling=!1,this.analyzeScrollingBehavior()},150),this.updateUserInteractionState()},{passive:!0}),this.contentAreas.forEach((s,o)=>{let l=0;o.addEventListener("mouseenter",()=>{l=Date.now(),this.userState.isHovering=!0,this.userState.interactionTarget=o,this.userState.lastInteractionTime=l,s.lastInteraction=l,this.dwellTimeTracker.set(o,l),this.userState.focusDepth=Math.min(this.userState.focusDepth+.1,1),s.type==="text"&&(this.userState.focusDepth=Math.min(this.userState.focusDepth+.2,1)),this.updateUserInteractionState()}),o.addEventListener("mouseleave",()=>{let d=Date.now()-l;if(this.userState.dwellTime=d,s.readingIntensity=Math.min(d/5e3,1),s.type==="text"&&d>1e3&&(this.userState.contentEngagement=Math.min(this.userState.contentEngagement+.1,1),s.contextualImportance=Math.min(s.contextualImportance+.05,1)),d>3e3){let h=this.adaptiveProtectionMap.get(o)||s.protectionLevel;this.adaptiveProtectionMap.set(o,Math.min(h+.05,.98))}this.userState.isHovering=!1,this.userState.interactionTarget=null,this.userState.focusDepth=Math.max(this.userState.focusDepth-.05,.1),this.updateUserInteractionState()})}),document.addEventListener("mousemove",()=>{clearTimeout(this.readingModeTimer),this.userState.readingModeActive=!1,this.userState.focusDepth>.7?this.userState.currentMode="reading":this.userState.scrollVelocity>1e3?this.userState.currentMode="browsing":this.userState.currentMode="exploring";let s=this.userState.currentMode==="reading"?1500:2e3;this.readingModeTimer=window.setTimeout(()=>{if(this.userState.interactionTarget&&this.contentAreas.has(this.userState.interactionTarget)){this.userState.readingModeActive=!0,this.userState.currentMode="reading",this.userState.focusDepth=Math.min(this.userState.focusDepth+.3,1);let o=this.contentAreas.get(this.userState.interactionTarget);if(o&&o.type==="text"){let l=this.adaptiveProtectionMap.get(this.userState.interactionTarget)||o.protectionLevel;this.adaptiveProtectionMap.set(this.userState.interactionTarget,Math.min(l+.1,.98))}this.updateUserInteractionState()}},s)});let r,n=()=>{clearTimeout(r),r=window.setTimeout(()=>{this.userState.currentMode="ambient",this.userState.focusDepth=Math.max(this.userState.focusDepth-.5,.1),this.updateUserInteractionState()},3e4)};["mousedown","mousemove","keydown","scroll","touchstart"].forEach(s=>{document.addEventListener(s,n,{passive:!0})}),n(),document.addEventListener("music-state-change",s=>{let o=s;o.detail&&this.syncWithMusic(o.detail)}),document.addEventListener("beat-detected",()=>{this.handleBeatPulse()})}initializeVisualEffectsVariables(){let t={"--sn-visual-effects-system-active":"1","--sn-visual-effects-content-protection-level":"0.95","--sn-visual-effects-chrome-enhancement-level":"2.0","--sn-visual-effects-field-animation-rate":"4s","--sn-music-energy-level":"0.5","--sn-feature-reading-mode-active":"0","--sn-visual-effects-user-interaction-detected":"0"};this.cssController.batchSetVariables("DepthVisualEffectsController",t,"normal","visualEffects-initialization")}startVisualEffectsUpdate(){let t=()=>{if(!this.isActive)return;let i=performance.now();i-this.lastUpdate>=this.updateThreshold&&(this.updateVisualEffectsState(),this.lastUpdate=i),requestAnimationFrame(t)};t()}updateVisualEffectsState(){let t=document.documentElement,i=this.visualEffectsIntensity,a=this.musicalState.energy*this.musicalState.musicSyncStrength*.3,r=this.calculateInteractionModifier(),n=this.calculateContextualModifier(),s=this.musicalState.emotionalTemperature*.2,l={"--sn-visual-effects-field-intensity":Math.max(.05,Math.min(1,i+a+r+n+s)).toString(),"--sn-visual-effects-level":this.visualEffectsIntensity.toString(),"--sn-visual-effects-awareness-level":this.userState.focusDepth.toString(),"--sn-music-energy-level":this.musicalState.energy.toString(),"--sn-visual-effects-music-sync-strength":this.musicalState.musicSyncStrength.toString(),"--sn-color-shift-temperature":this.musicalState.emotionalTemperature.toString(),"--sn-feature-reading-mode-active":this.userState.readingModeActive?"1":"0","--sn-visual-effects-user-interaction-detected":this.userState.isScrolling||this.userState.isHovering?"1":"0","--sn-visual-effects-interaction-mode":this.getModeNumericValue(this.userState.currentMode).toString(),"--sn-visual-effects-focus-depth":this.userState.focusDepth.toString(),"--sn-visual-effects-content-engagement":this.userState.contentEngagement.toString(),"--sn-visual-effects-scroll-velocity":Math.min(this.userState.scrollVelocity/2e3,1).toString(),"--sn-visual-effects-dwell-time-factor":Math.min(this.userState.dwellTime/5e3,1).toString(),"--sn-visual-effects-interaction-pattern":this.getPatternNumericValue(this.userState.interactionPattern).toString(),"--sn-visual-effects-temporal-flow-direction-x":(Math.sin(Date.now()*1e-4)*.5+.5).toString(),"--sn-visual-effects-temporal-flow-direction-y":(Math.cos(Date.now()*1e-4)*.5+.5).toString(),"--sn-visual-effects-memory-intensity":this.musicalState.musicalMemoryPatterns.toString(),"--sn-visual-effects-fluidity-index":this.calculateSurfaceFluidityIndex().toString(),"--sn-visual-effects-genre-shift":this.calculateGenreVisualEffectsShift().toString()};this.cssController.batchSetVariables("DepthVisualEffectsController",l,"normal","visualEffects-state-update"),t.classList.remove("music-energy-high","music-energy-calm"),this.musicalState.energy>.7?t.classList.add("music-energy-high"):this.musicalState.energy<.3&&t.classList.add("music-energy-calm"),t.setAttribute("data-user-interacting",(this.userState.isScrolling||this.userState.isHovering).toString()),t.setAttribute("data-reading-mode",this.userState.readingModeActive.toString())}updateUserInteractionState(){this.updateVisualEffectsState()}syncWithMusic(t){if(Object.assign(this.musicalState,t),t.tempo){let i=Math.max(2,Math.min(8,60/(t.tempo/60)*4));this.cssController.setVariable("DepthVisualEffectsController","--sn-visual-effects-field-animation-rate",`${i}s`,"high","musical-tempo-sync")}this.updateVisualEffectsState(),u?.debug?.log("DepthVisualEffectsController",`Musical visualEffects sync: energy=${t.energy}, tempo=${t.tempo}`)}handleBeatPulse(){if(this.userState.readingModeActive)return;let t=document.documentElement,i=parseFloat(t.style.getPropertyValue("--sn-visual-effects-field-intensity")||"0.5"),a=Math.min(1,i+.1);this.cssController.setVariable("DepthVisualEffectsController","--sn-visual-effects-field-intensity",a.toString(),"high","beat-pulse"),setTimeout(()=>{this.isActive&&this.updateVisualEffectsState()},100)}protectNewContent(t){if(this.contentAreas.has(t))return;let i={element:t,type:this.determineContentType(t),protectionLevel:this.calculateProtectionLevel(t),lastInteraction:0,visualEffectsLevel:.5,readingIntensity:0,contextualImportance:this.calculateProtectionLevel(t),adaptiveProtection:.5};this.contentAreas.set(t,i),t.classList.add("content-sanctuary"),t.setAttribute("data-visualEffects-protected","true"),t.setAttribute("data-content-type",i.type),u?.debug?.log("DepthVisualEffectsController",`Protected new content element: ${t.tagName}.${t.className}`)}enhanceNewChrome(t){this.chromeAreas.has(t)||(this.chromeAreas.add(t),t.classList.add("ui-chrome-area"),t.setAttribute("data-visualEffects-enhanced","true"),u?.debug?.log("DepthVisualEffectsController",`Enhanced new chrome element: ${t.tagName}.${t.className}`))}forceReadingMode(t){this.userState.readingModeActive=t,this.updateUserInteractionState(),u?.debug?.log("DepthVisualEffectsController",`Reading mode ${t?"activated":"deactivated"}`)}getVisualEffectsMetrics(){return{contentAreas:this.contentAreas.size,chromeAreas:this.chromeAreas.size,visualEffectsIntensity:parseFloat(document.documentElement.style.getPropertyValue("--sn-visual-effects-field-intensity")||"0.5"),readingModeActive:this.userState.readingModeActive,userInteracting:this.userState.isScrolling||this.userState.isHovering,musicalEnergy:this.musicalState.energy}}async healthCheck(){let t=this.getVisualEffectsMetrics(),i=t.contentAreas>0&&t.chromeAreas>0;return{healthy:i,issues:i?[]:["VisualEffects system not properly initialized"],metrics:{visualEffectsLevel:t.contentAreas>0?1:0,protectedAreas:t.contentAreas,enhancedAreas:t.chromeAreas,musicalEnergy:t.musicalEnergy}}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),clearTimeout(this.readingModeTimer),clearTimeout(this.interactionTimer),this.contentAreas.forEach((a,r)=>{r.classList.remove("content-sanctuary"),r.removeAttribute("data-visualEffects-protected"),r.removeAttribute("data-content-type")}),this.chromeAreas.forEach(a=>{a.classList.remove("ui-chrome-area"),a.removeAttribute("data-visualEffects-enhanced")});let t={"--sn-visual-effects-system-active":"","--sn-visual-effects-field-intensity":"","--sn-feature-reading-mode-active":"","--sn-visual-effects-user-interaction-detected":"","--sn-visual-effects-field-animation-rate":"","--sn-music-energy-level":"","--sn-visual-effects-content-protection-level":"","--sn-visual-effects-chrome-enhancement-level":""};this.cssController.batchSetVariables("DepthVisualEffectsController",t,"critical","system-cleanup");let i=document.documentElement;i.classList.remove("music-energy-high","music-energy-calm"),i.removeAttribute("data-user-interacting"),i.removeAttribute("data-reading-mode"),u?.debug?.log("DepthVisualEffectsController","VisualEffects system deactivated")}}});var wo={};ie(wo,{DynamicCatppuccinBridge:()=>Ur});var Ur,To=y(()=>{"use strict";U();L();$();x();X();de();Ur=class extends j{constructor(t=E,i=D,a=null,r=null,n=null){super(t,i,a,r,n);this.colorHarmonyEngine=null;this.depthVisualController=null;this.dynamicColorState={currentAccentHex:"#675c8f",currentAccentRgb:"203,166,247",baseBackgroundHex:"#0d1117",baseBackgroundRgb:"13,17,23",lastUpdateTime:0,musicEnergy:.5,transitionInProgress:!1};this.integrationConfig={accentUpdateEnabled:!0,baseTransformationEnabled:!0,visualIntegrationEnabled:!0,smoothTransitionDuration:800,energyResponseMultiplier:1.2};this.transitionTimer=0;this.lastTransitionStartTime=0;this.transitionFromAccent="";this.transitionToAccent=""}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{let t=globalThis.year3000System;this.cssController=t?.cssController||P(),this.setupColorExtractionListeners(),this.setupSettingsListeners(),this.initializeCurrentState();let i=this.checkDynamicAccentEnabled();this.integrationConfig.accentUpdateEnabled=i,i?u?.debug?.log("DynamicCatppuccinBridge","Dynamic accent enabled - bridge active"):u?.debug?.log("DynamicCatppuccinBridge","Dynamic accent disabled - bridge standby (will activate when enabled)"),u?.debug?.log("DynamicCatppuccinBridge","Color Extension Facade initialized successfully")}catch(t){u?.debug?.error("DynamicCatppuccinBridge","Failed to initialize facade:",t)}}checkDynamicAccentEnabled(){try{if(!this.settingsManager)return!1;let t=this.settingsManager.get("catppuccin-accentColor"),i=String(t)==="dynamic";return this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinBridge",`Accent setting: ${t}, Dynamic: ${i}`),i}catch(t){return u?.debug?.error("DynamicCatppuccinBridge","Error checking dynamic accent setting:",t),!1}}setupColorExtractionListeners(){p.subscribe("colors:extracted",t=>{t.rawColors&&this.handleExtractedColors(t.rawColors)},"DynamicCatppuccinBridge"),p.subscribe("colors:harmonized",t=>{t.processedColors&&this.handleHarmonizedColors(t.processedColors)},"DynamicCatppuccinBridge"),p.subscribe("colors:applied",t=>{t.cssVariables&&this.integrationConfig.accentUpdateEnabled&&this.handleCSSVariablesApplied(t.cssVariables,t.accentHex,t.accentRgb)},"DynamicCatppuccinBridge"),document.addEventListener("colors-extracted",t=>{let i=t;i.detail&&i.detail.extractedColors&&this.handleExtractedColors(i.detail.extractedColors)}),document.addEventListener("colors-harmonized",t=>{let i=t;i.detail&&i.detail.harmonizedColors&&this.handleHarmonizedColors(i.detail.harmonizedColors)}),document.addEventListener("music-state-change",t=>{let i=t;i.detail&&this.handleMusicStateChange(i.detail)}),document.addEventListener("spice-colors/update-request",t=>{let i=t;i.detail&&this.integrationConfig.accentUpdateEnabled&&this.handleSpiceColorUpdateRequest(i.detail)}),u?.debug?.log("DynamicCatppuccinBridge","Enhanced color extraction and coordination listeners setup complete (UnifiedEventBus + DOM)")}handleSpiceColorUpdateRequest(t){let{accentHex:i,primaryHex:a,secondaryHex:r,source:n}=t;this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinBridge",`Received spice color update request from ${n}:`,{accent:i,primary:a,secondary:r}),i&&i!==this.dynamicColorState.currentAccentHex&&this.scheduleSmoothAccentTransition(i),a&&this.updateLivingBaseBackground(a),document.dispatchEvent(new CustomEvent("spice-colors/updated",{detail:{source:"DynamicCatppuccinBridge",applied:{accent:i,primary:a,secondary:r},timestamp:Date.now()}}))}setupSettingsListeners(){document.addEventListener("year3000SystemSettingsChanged",t=>{let i=t,{key:a,value:r}=i.detail||{};if(a==="catppuccin-accentColor"){let n=String(r)==="dynamic";this.integrationConfig.accentUpdateEnabled=n,n&&!this.isActive?this.initialize():!n&&this.isActive&&this.destroy(),u?.debug?.log("DynamicCatppuccinBridge",`Accent setting changed to: ${r}, Bridge active: ${this.isActive}`)}})}initializeCurrentState(){let t=document.documentElement,i=getComputedStyle(t),a=i.getPropertyValue("--sn-accent-hex").trim()||i.getPropertyValue("--sn-musical-harmony-primary-hex").trim()||i.getPropertyValue("--sn-dynamic-accent-hex").trim()||i.getPropertyValue("--sn-cosmic-accent-hex").trim()||i.getPropertyValue("--spice-accent").trim();if(a){this.dynamicColorState.currentAccentHex=a;let s=this.utils.hexToRgb(a);s&&(this.dynamicColorState.currentAccentRgb=`${s.r},${s.g},${s.b}`)}let r=i.getPropertyValue("--sn-cosmic-base-hex").trim()||i.getPropertyValue("--spice-base").trim()||"#0d1117";this.dynamicColorState.baseBackgroundHex=r;let n=this.utils.hexToRgb(r);n&&(this.dynamicColorState.baseBackgroundRgb=`${n.r},${n.g},${n.b}`),this.dynamicColorState.lastUpdateTime=Date.now(),u?.debug?.log("DynamicCatppuccinBridge","Current state initialized:",{accent:this.dynamicColorState.currentAccentHex,base:this.dynamicColorState.baseBackgroundHex})}handleExtractedColors(t){if(this.integrationConfig.accentUpdateEnabled)try{let i=this.selectBestAccentColor(t);i&&i!==this.dynamicColorState.currentAccentHex&&this.scheduleSmoothAccentTransition(i),u?.debug?.log("DynamicCatppuccinBridge","Processed extracted colors:",{input:Object.keys(t),selectedAccent:i})}catch(i){u?.debug?.error("DynamicCatppuccinBridge","Error handling extracted colors:",i)}}handleHarmonizedColors(t){if(this.integrationConfig.accentUpdateEnabled)try{let i=t.VIBRANT||t.PROMINENT||t.VIBRANT_NON_ALARMING||t.LIGHT_VIBRANT||t.PRIMARY||Object.values(t)[0];i&&i!==this.dynamicColorState.currentAccentHex&&(this.config.enableDebug&&console.log("\u{1F3A8} [DynamicCatppuccinBridge] Applying harmonized accent color:",{from:this.dynamicColorState.currentAccentHex,to:i,source:"ColorHarmonyEngine harmonized colors"}),this.scheduleSmoothAccentTransition(i)),this.applyHarmonizedColorsToDynamicSystem(t)}catch(i){console.error("\u{1F3A8} [DynamicCatppuccinBridge] Error handling harmonized colors:",i)}}handleCSSVariablesApplied(t,i,a){if(this.integrationConfig.accentUpdateEnabled)try{i&&i!==this.dynamicColorState.currentAccentHex&&(this.dynamicColorState.currentAccentHex=i,this.dynamicColorState.currentAccentRgb=a,this.dynamicColorState.lastUpdateTime=Date.now());let r={},n=t["--sn-accent-hex"]||t["--spice-accent"]||i,s=t["--sn-accent-rgb"]||t["--spice-rgb-accent"]||a;n&&s&&(r["--sn-dynamic-accent-hex"]=n,r["--sn-dynamic-accent-rgb"]=s,r["--sn-dynamic-primary-hex"]=n,r["--sn-dynamic-primary-rgb"]=s,Object.keys(r).length>0&&this.cssController.batchSetVariables("DynamicCatppuccinBridge",r,"critical","css-variables-applied-enhancement")),u?.debug?.log("DynamicCatppuccinBridge","Processed colors:applied event:",{accentHex:n,accentRgb:s,variablesProcessed:Object.keys(t).length,enhancedVariables:Object.keys(r).length})}catch(r){u?.debug?.error("DynamicCatppuccinBridge","Error handling CSS variables applied:",r)}}handleMusicStateChange(t){t.energy!==void 0&&(this.dynamicColorState.musicEnergy=t.energy,this.integrationConfig.visualIntegrationEnabled&&this.updateVisualWithMusicEnergy(t.energy))}selectBestAccentColor(t){let i=["VIBRANT_NON_ALARMING","VIBRANT","LIGHT_VIBRANT","PROMINENT","PRIMARY","DARK_VIBRANT"];for(let a of i){let r=t[a];if(r&&this.utils.hexToRgb(r))return r}return null}scheduleSmoothAccentTransition(t){if(this.dynamicColorState.transitionInProgress){this.transitionToAccent=t;return}this.transitionFromAccent=this.dynamicColorState.currentAccentHex,this.transitionToAccent=t,this.dynamicColorState.transitionInProgress=!0,this.lastTransitionStartTime=Date.now(),this.animateAccentTransition(),u?.debug?.log("DynamicCatppuccinBridge",`Accent transition scheduled: ${this.transitionFromAccent} \u2192 ${t}`)}animateAccentTransition(){let t=()=>{if(!this.dynamicColorState.transitionInProgress)return;let i=Date.now()-this.lastTransitionStartTime,a=Math.min(i/this.integrationConfig.smoothTransitionDuration,1),r=1-Math.pow(1-a,3),n=this.interpolateColors(this.transitionFromAccent,this.transitionToAccent,r);if(n&&this.applyDynamicAccent(n),a>=1){this.dynamicColorState.transitionInProgress=!1,this.dynamicColorState.currentAccentHex=this.transitionToAccent,this.dynamicColorState.lastUpdateTime=Date.now();let s=this.utils.hexToRgb(this.transitionToAccent);s&&(this.dynamicColorState.currentAccentRgb=`${s.r},${s.g},${s.b}`),u?.debug?.log("DynamicCatppuccinBridge",`Accent transition complete: ${this.transitionToAccent}`)}else requestAnimationFrame(t)};requestAnimationFrame(t)}interpolateColors(t,i,a){let r=this.utils.hexToRgb(t),n=this.utils.hexToRgb(i);if(!r||!n)return null;let s=Math.round(r.r+(n.r-r.r)*a),o=Math.round(r.g+(n.g-r.g)*a),l=Math.round(r.b+(n.b-r.b)*a);return this.utils.rgbToHex(s,o,l)}applyDynamicAccent(t){console.log("\u{1F3A8} [DynamicCatppuccinBridge] Applying dynamic accent color:",{accentHex:t,previousAccent:this.dynamicColorState.currentAccentHex,timestamp:Date.now()});let i=document.documentElement,a=this.utils.hexToRgb(t);if(!a){console.error("\u{1F3A8} [DynamicCatppuccinBridge] Failed to convert accent hex to RGB:",t);return}let r=`${a.r},${a.g},${a.b}`,n={"--sn-dynamic-accent-hex":t,"--sn-dynamic-accent-rgb":r,"--sn-dynamic-primary-hex":t,"--sn-dynamic-primary-rgb":r,"--spice-accent":t,"--spice-button":t,"--spice-button-active":t,"--spice-rgb-accent":r,"--spice-rgb-button":r,"--sn-color-extracted-primary-rgb":r,"--sn-color-extracted-vibrant-rgb":r,"--sn-color-extracted-dominant-rgb":r};console.log("\u{1F3A8} [DynamicCatppuccinBridge] Setting CSS variables:",n),this.cssController.batchSetVariables("DynamicCatppuccinBridge",n,"critical","dynamic-accent-application"),this.integrationConfig.visualIntegrationEnabled&&this.updateVisualWithAccent(t,r),this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinBridge",`Applied gradient colors: --sn-bg-gradient-primary=${t}, --sn-bg-gradient-primary-rgb=${r}`)}applyHarmonizedColorsToDynamicSystem(t){let i=t.VIBRANT||t.PRIMARY;i&&this.integrationConfig.baseTransformationEnabled&&this.updateLivingBaseBackground(i)}updateVisualWithAccent(t,i){let a=document.documentElement,r={"--sn-holographic-rgb":i,"--holographic-scanline-rgb":i,"--visual-intensity":`calc(0.5 + var(--musical-sync-intensity) * ${this.integrationConfig.energyResponseMultiplier}),`};this.cssController.batchSetVariables("DynamicCatppuccinBridge",r,"high","visual-accent-update"),this.depthVisualController&&u?.debug?.log("DynamicCatppuccinBridge","Notifying depth visual controller of accent change")}updateVisualWithMusicEnergy(t){let i=document.documentElement,a=t*this.integrationConfig.energyResponseMultiplier,r={"--musical-sync-intensity":a.toString(),"--holographic-music-flicker-intensity":a.toString()};this.cssController.batchSetVariables("DynamicCatppuccinBridge",r,"high","musical-energy-update");let s=Math.max(.1,Math.min(1,.5+a*.3));this.cssController.setVariable("DynamicCatppuccinBridge","--visual-intensity",s.toString(),"high","visual-intensity-update")}updateLivingBaseBackground(t){let i=document.documentElement,a=this.utils.hexToRgb(t);if(!a)return;let r=`${a.r},${a.g},${a.b}`,n={"--sn-dynamic-secondary-hex":t,"--sn-dynamic-secondary-rgb":r,"--sn-color-extracted-secondary-rgb":r,"--sn-color-harmony-complementary-rgb":r};this.cssController.batchSetVariables("DynamicCatppuccinBridge",n,"high","secondary-color-update");let s=`
      linear-gradient(135deg,
        var(--spice-base) 0%,
        rgba(${r}, 0.08) 30%,
        var(--spice-base) 70%
      ),
      var(--spice-base)
    `,o={"--living-base-gradient":s,"--visual-base-gradient":s};this.cssController.batchSetVariables("DynamicCatppuccinBridge",o,"normal","living-gradient-update"),this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinBridge",`Living base updated: --sn-bg-gradient-secondary=${t}, --sn-bg-gradient-secondary-rgb=${r}`)}linkWithColorHarmonyEngine(t){this.colorHarmonyEngine=t,u?.debug?.log("DynamicCatppuccinBridge","Linked with ColorHarmonyEngine")}linkWithDepthVisual(t){this.depthVisualController=t,u?.debug?.log("DynamicCatppuccinBridge","Linked with DepthLayerController")}getDynamicColorState(){return{...this.dynamicColorState}}getFacadeVariableStatus(){let t=document.documentElement,i=getComputedStyle(t);return{spicetifyVars:{accent:i.getPropertyValue("--spice-accent").trim(),button:i.getPropertyValue("--spice-button").trim(),rgbAccent:i.getPropertyValue("--spice-rgb-accent").trim(),base:i.getPropertyValue("--spice-base").trim()},visualVars:{gradientPrimary:i.getPropertyValue("--sn-bg-gradient-primary-rgb").trim(),accentHex:i.getPropertyValue("--sn-color-accent-hex").trim(),accentRgb:i.getPropertyValue("--sn-color-accent-rgb").trim(),extractedPrimary:i.getPropertyValue("--sn-color-extracted-primary-rgb").trim(),livingBaseGradient:i.getPropertyValue("--living-base-gradient").trim()},config:{dynamicAccentEnabled:this.checkDynamicAccentEnabled(),accentUpdateEnabled:this.integrationConfig.accentUpdateEnabled,visualEnabled:this.integrationConfig.visualIntegrationEnabled,isActive:this.isActive}}}updateConfig(t){this.integrationConfig={...this.integrationConfig,...t},u?.debug?.log("DynamicCatppuccinBridge","Configuration updated:",t)}async healthCheck(){let t=this.checkDynamicAccentEnabled(),i=Date.now()-this.dynamicColorState.lastUpdateTime<3e4;return{healthy:this.isActive&&t,issues:this.isActive&&!t?["Dynamic accent not enabled in settings"]:[],metrics:{dynamicAccentEnabled:t,currentAccent:this.dynamicColorState.currentAccentHex,lastUpdateAge:Date.now()-this.dynamicColorState.lastUpdateTime,hasRecentUpdate:i,transitionInProgress:this.dynamicColorState.transitionInProgress,musicEnergy:this.dynamicColorState.musicEnergy}}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=0),this.dynamicColorState.transitionInProgress=!1,p.unsubscribeAll("DynamicCatppuccinBridge"),u?.debug?.log("DynamicCatppuccinBridge","Dynamic Catppuccin bridge cleaned up (including UnifiedEventBus subscriptions)")}}});var Po={};ie(Po,{CDFVariableBridge:()=>Or});var Or,Ao=y(()=>{"use strict";L();Or=class{constructor(e){this.batcher=e;this.reduceMotionMQ=null;this._mqHandler=null;let t=p.subscribe("performance:frame",i=>{let a={deltaMs:i.deltaTime||16.67,timestamp:i.timestamp||Date.now(),performanceMode:"performance",frameBudget:16.67};this._handleFrame(a)},"CDFVariableBridge");if(this.unsubscribe=()=>p.unsubscribe(t),typeof window<"u"&&window.matchMedia){this.reduceMotionMQ=window.matchMedia("(prefers-reduced-motion: reduce)"),this._syncReducedMotion(this.reduceMotionMQ.matches),this._mqHandler=i=>{this._syncReducedMotion(i.matches)};try{this.reduceMotionMQ.addEventListener("change",this._mqHandler)}catch{this.reduceMotionMQ.addListener(this._mqHandler)}}}destroy(){if(this.unsubscribe?.(),this.reduceMotionMQ&&this._mqHandler)try{this.reduceMotionMQ.removeEventListener("change",this._mqHandler)}catch{this.reduceMotionMQ.removeListener(this._mqHandler)}}_handleFrame(e){if(typeof e.scrollRatio=="number"&&(this.batcher.queueCSSVariableUpdate("--sn-cdf-scroll-ratio",e.scrollRatio.toFixed(3)),this.batcher.queueCSSVariableUpdate("--sn-scroll-ratio",e.scrollRatio.toFixed(3))),typeof e.beatIntensity=="number"){let t=e.beatIntensity.toFixed(3);this.batcher.queueCSSVariableUpdate("--sn-cdf-energy",t),this.batcher.queueCSSVariableUpdate("--sn-beat-intensity",t)}}_syncReducedMotion(e){this.batcher.queueCSSVariableUpdate("--sn-cdf-enabled",e?"0":"1")}}});U();Er();x();X();async function js(c=1e4,e=100){let t=Date.now();for(;Date.now()-t<c;){let i=window.Spicetify;if(i?.showNotification&&i?.Platform)return!0;await new Promise(a=>setTimeout(a,e))}return!1}$();var Yi=class{constructor(e,t=null){this.parent=e;this.y3k=t;this.gl=null;this.program=null;this.tex=null;this.strength=.4;this.rafId=null;this.frameStart=0;this._defaultSize=256;this._boundContextLost=e=>this._handleContextLost(e);this._boundContextRestored=()=>this._handleContextRestored();this.canvas=document.createElement("canvas"),this.canvas.width=this._defaultSize,this.canvas.height=this._defaultSize,this.canvas.style.width="100%",this.canvas.style.height="100%",Object.assign(this.canvas.style,{position:"absolute",inset:"0",pointerEvents:"none",mixBlendMode:"overlay",zIndex:"-1",opacity:"0.6"}),this.parent.appendChild(this.canvas),this.perf=t?.performanceAnalyzer??null,this.canvas.addEventListener("webglcontextlost",this._boundContextLost,!1),this.canvas.addEventListener("webglcontextrestored",this._boundContextRestored,!1),this._initGL()}_initGL(){let e=this.canvas.getContext("webgl",{premultipliedAlpha:!1,alpha:!0,antialias:!1});if(!e){console.warn("[AberrationCanvas] WebGL not available \u2013 effect disabled");return}this.gl=e;let t="attribute vec2 aPos; varying vec2 vUv; void main(){ vUv = (aPos+1.0)*0.5; gl_Position = vec4(aPos,0.0,1.0); }",i="precision mediump float; uniform sampler2D uTex; uniform float uStrength; uniform float uTime; varying vec2 vUv; void main(){ float freq = 8.0; vec2 offset = vec2(sin(vUv.y*freq+uTime)*uStrength, 0.0); vec4 c; c.r = texture2D(uTex, vUv + offset).r; c.g = texture2D(uTex, vUv).g; c.b = texture2D(uTex, vUv - offset).b; c.a = clamp(uStrength * 1.5, 0.0, 0.6); gl_FragColor = c; }",a=(h,g)=>{let f=e.createShader(h);return e.shaderSource(f,g),e.compileShader(f),f},r=a(e.VERTEX_SHADER,t),n=a(e.FRAGMENT_SHADER,i),s=e.createProgram();if(e.attachShader(s,r),e.attachShader(s,n),e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS)){console.error("[AberrationCanvas] Shader link failed");return}this.program=s,e.useProgram(s);let o=new Float32Array([-1,-1,1,-1,-1,1,1,1]),l=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,o,e.STATIC_DRAW);let m=e.getAttribLocation(s,"aPos");e.enableVertexAttribArray(m),e.vertexAttribPointer(m,2,e.FLOAT,!1,0,0);let d=e.createTexture();e.bindTexture(e.TEXTURE_2D,d),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([0,0,0,0])),this.tex=d}setStrength(e){this.strength=e}updateSourceBitmap(e){if(!this.gl||!this.tex)return;let t=this.gl;t.bindTexture(t.TEXTURE_2D,this.tex),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e)}render(e){if(!this.gl||!this.program)return;let t=this.gl;this.perf&&(this.frameStart=performance.now()),t.viewport(0,0,this.canvas.width,this.canvas.height),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT),t.useProgram(this.program);let i=t.getUniformLocation(this.program,"uTex"),a=t.getUniformLocation(this.program,"uStrength"),r=t.getUniformLocation(this.program,"uTime");if(t.uniform1i(i,0),t.uniform1f(a,this.strength),t.uniform1f(r,e*.001),t.drawArrays(t.TRIANGLE_STRIP,0,4),this.perf){let n=performance.now()-this.frameStart;n>.5&&console.warn(`[AberrationCanvas] Frame ${n.toFixed(2)} ms exceeds 0.5 ms budget`)}}destroy(){this.rafId&&cancelAnimationFrame(this.rafId),this.gl&&this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.canvas.removeEventListener("webglcontextlost",this._boundContextLost),this.canvas.removeEventListener("webglcontextrestored",this._boundContextRestored),this.canvas.remove()}setPixelSize(e){e!==this.canvas.width&&(this.canvas.width=e,this.canvas.height=e)}_handleContextLost(e){e.preventDefault(),console.warn("[AberrationCanvas] WebGL context lost \u2013 waiting for restore"),this.gl=null,this.program=null}_handleContextRestored(){console.info("[AberrationCanvas] WebGL context restored \u2013 re-initializing GL"),this._initGL()}};var Ki=class{constructor(e,t){this.systemName="AberrationCanvas";this._elapsed=0;this._canvas=e,this._perf=t}onAnimate(e,t){this._elapsed+=e;let i=0;this._perf&&(i=this._perf.startTiming("AberrationVisualSystem")),this._canvas.render(this._elapsed),this._perf&&i&&this._perf.endTiming("AberrationVisualSystem",i)}onPerformanceModeChange(e){e==="performance"?(this._canvas.setPixelSize(128),this._canvas.setStrength(.25)):(this._canvas.setPixelSize(256),this._canvas.setStrength(.4))}destroy(){this._canvas.destroy()}};var Uc=[".main-view-container__scroll-node",".main-viewContainer-scrollNode",".main-viewContainer__scrollNode"].join(", ");function Qs(){return document.querySelector(Uc)}var J=null,ji=null;function wr(c){return(c||globalThis.year3000System)?.cssConsciousnessController||P()}function Oc(){return!1}function Ot(c){if(!Oc()){Nt(!1,c),$t(!1,c);return}let e=Qs();e&&(J&&J.parent===e||(J?.destroy(),J=new Yi(e,c),window.__SN_DEBUG_ABERRATION&&console.log("[AberrationManager] canvas attached",e),Nt(!0,c),$t(!0,c),c&&J&&(ji=new Ki(J,c.performanceAnalyzer||void 0),c?.registerVisualSystem?.(ji,"critical"),console.log("[AberrationManager] AberrationCanvas attached"))))}function Nt(c,e){wr(e).setVariable("AberrationManager","--sn-nebula-noise-opacity",c?"0.03":"0","normal","nebula-noise-toggle")}function $t(c,e){let t={"--aberration-webgl-active":c?"1":"0","--aberration-css-enabled":c?"1":"0","--aberration-hybrid-mode":c?"1":"0"};wr(e).batchSetVariables("AberrationManager",t,"normal","css-aberration-toggle")}function Xs(c=null){Ot(c),J||(Nt(!1,c),$t(!1,c));let e=window.Spicetify?.Platform?.History;e?.listen&&e.listen(()=>setTimeout(()=>Ot(c),0)),document.addEventListener("spicetify:appchange",()=>Ot(c));let t=new MutationObserver(()=>{J?t.disconnect():(Ot(c),J||(Nt(!1,c),$t(!1,c)))});t.observe(document.documentElement,{childList:!0,subtree:!0}),document.addEventListener("year3000SystemSettingsChanged",i=>{let{key:a,value:r}=i.detail||{};if(a==="sn-enable-aberration"){let n=r==="true";n&&!J?Ot(c):!n&&J&&(J.destroy(),J=null,c?.unregisterAnimationSystem("AberrationCanvas"),ji?.destroy(),ji=null,console.log("[AberrationManager] AberrationCanvas detached")),Nt(n&&!!J,c),$t(n&&!!J,c)}if(a==="sn-nebula-aberration-strength"){let n=parseFloat(r);!Number.isNaN(n)&&J&&J.setStrength(n),wr(c).setVariable("AberrationManager","--sn-nebula-aberration-strength",String(r),"normal","aberration-strength-update")}})}$();L();var Zs="sn_seen_genres_v1",Qi=class{constructor(){let e=typeof localStorage<"u"?localStorage.getItem(Zs):null;this.seen=new Set(e?JSON.parse(e):[])}hasSeen(e){return this.seen.has(e.toLowerCase())}markSeen(e){let t=e.toLowerCase();this.seen.has(t)||(this.seen.add(t),this._persist())}_persist(){try{typeof localStorage<"u"&&localStorage.setItem(Zs,JSON.stringify([...this.seen]))}catch{}}};function Nc(c){if(!c.length)return 0;let e=[...c].sort((r,n)=>r-n),t=Math.floor(e.length/2);if(e.length%2!==0)return e[t]??0;let i=e[t-1]??0,a=e[t]??0;return(i+a)/2}var Wt=class Wt{constructor(e=null,t,i){this.perf=null;this.unsubscribers=[];this.frameDurations=[];this.enabled=!0;this.intensitySetting="balanced";this.intensityFactor=1;this.genreHistory=new Qi;this.activeGlowTimeout=null;this.interactionOffHandler=null;this.year3000System=e,this.cssController=t??e?.cssVariableController??P(),this.perf=i||(e?.performanceAnalyzer??null);let a=window.matchMedia("(prefers-reduced-motion: reduce)").matches,r=e?.deviceCapabilityDetector?.deviceCapabilities?.overall,n=e?.settingsManager;switch(n&&(this.intensitySetting=n.get("sn-gradient-intensity")??"balanced"),this.intensitySetting){case"disabled":this.enabled=!1;break;case"minimal":this.intensityFactor=.6;break;case"balanced":this.intensityFactor=1;break;case"intense":this.intensityFactor=1.4;break}(a||r==="low")&&(this.enabled=!1),this.enabled?this._subscribe():this.cssController.setVariable("AudioVisualController","--sn-nebula-beat-intensity","0","low","disabled-initialization")}_subscribe(){let e=[p.subscribe("music:beat",t=>{this._handleBeat({energy:t.intensity,bpm:t.bpm})},"AudioVisualController"),p.subscribe("music:track-changed",t=>{this._handleGenreChange({genre:"unknown"})},"AudioVisualController"),p.subscribe("user:scroll",t=>{this._handleScroll({velocity:t.velocity?.x||t.velocity?.y||0,direction:t.direction==="up"?"up":"down"})},"AudioVisualController")];this.unsubscribers=e.map(t=>()=>p.unsubscribe(t))}_handleBeat(e){let t=performance.now(),i=typeof e.energy=="number"?e.energy:.5,a=(.8+Math.min(Math.max(i,0),1)*.6)*this.intensityFactor;this._queueVar("--sn-nebula-beat-intensity",a.toFixed(3),"high","beat-sync");let r=(i*.6).toFixed(3);this._queueVar("--sn-nebula-aberration-strength",r,"normal","beat-aberration"),this._recordDuration(t)}_handleGenreChange(e){let t=performance.now();if(this.genreHistory.hasSeen(e.genre))return;this.genreHistory.markSeen(e.genre);let i=.18*this.intensityFactor;this._queueVar("--sn-nebula-layer-0-opacity",i.toFixed(3),"high","genre-discovery");let a=()=>{this.year3000System?.timerConsolidationSystem?this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer("AudioVisualController-glowTimeout"):this.activeGlowTimeout&&(clearTimeout(this.activeGlowTimeout),this.activeGlowTimeout=null),this._queueVar("--sn-nebula-layer-0-opacity","0.05","normal","genre-clear"),this.interactionOffHandler&&(document.removeEventListener("pointerdown",this.interactionOffHandler),document.removeEventListener("keydown",this.interactionOffHandler),this.interactionOffHandler=null)};this.year3000System?.timerConsolidationSystem?(this.year3000System.timerConsolidationSystem.registerConsolidatedTimer("AudioVisualController-glowTimeout",a,4e3,"normal"),this.activeGlowTimeout=null):this.activeGlowTimeout=setTimeout(a,4e3),this.interactionOffHandler=()=>a(),document.addEventListener("pointerdown",this.interactionOffHandler,{once:!0}),document.addEventListener("keydown",this.interactionOffHandler,{once:!0}),this._queueVar("--sn-nebula-ease-t","1","normal","ease-trigger"),this._recordDuration(t)}_handleScroll(e){let t=performance.now(),i=typeof e.velocity=="number"?e.velocity:0,r=Math.min(Math.abs(i),50)/50*2*this.intensityFactor;this._queueVar("--sn-nebula-layer-3-blur",`calc(var(--sn-depth-layer-3-blur) + ${r.toFixed(2)}px)`,"normal","scroll-blur");let n=150,o=Math.max(Math.min(e.velocity??0,50),-50)/50*50,l=Math.max(140,Math.min(200,n+o));this._queueVar("--sn-nebula-noise-scale-y",`${l.toFixed(1)}%`,"normal","scroll-noise"),this._recordDuration(t)}_queueVar(e,t,i="normal",a="audio-visual"){this.enabled&&this.cssController.setVariable("AudioVisualController",e,t,i,a)}_recordDuration(e){let t=performance.now()-e;if(this.frameDurations.push(t),this.frameDurations.length>Wt.FRAME_HISTORY&&this.frameDurations.shift(),this.frameDurations.length===Wt.FRAME_HISTORY){let i=Nc(this.frameDurations);i>2&&(console.warn(`[AudioVisualController] Median scripting cost ${i.toFixed(2)} ms exceeds 2 ms budget.`),this._queueVar("--sn-nebula-blend-mode","screen","critical","performance-fallback"))}}destroy(){this.year3000System?.timerConsolidationSystem&&this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer("AudioVisualController-glowTimeout"),this.activeGlowTimeout&&(clearTimeout(this.activeGlowTimeout),this.activeGlowTimeout=null),this.interactionOffHandler&&(document.removeEventListener("pointerdown",this.interactionOffHandler),document.removeEventListener("keydown",this.interactionOffHandler),this.interactionOffHandler=null),this.unsubscribers.forEach(e=>e()),this.unsubscribers=[]}};Wt.FRAME_HISTORY=120;var Tr=Wt;function Js(c=null){let e=globalThis;if(e.__SN_audioVisualController)return e.__SN_audioVisualController;let t=new Tr(c);return e.__SN_audioVisualController=t,t}async function Kt(c,e=5e3){let t=Date.now(),i=null,a=0;for(;Date.now()-t<e;){a++;try{let s=c.split(".").reduce((o,l)=>o?.[l],window);if(s)return console.log(`\u2705 [StarryNight] API ${c} available after ${a} attempts (${Date.now()-t}ms)`),s}catch(s){i=s}await new Promise(s=>setTimeout(s,100))}console.warn(`\u274C [StarryNight] API ${c} timeout after ${e}ms (${a} attempts)`),i&&console.warn(`\u274C [StarryNight] Last error for ${c}:`,i.message);let r=c.split("."),n=window;for(let s=0;s<r.length;s++){let o=r[s];if(!o||!n||typeof n!="object"||n[o]===void 0){console.warn(`\u274C [StarryNight] API path ${c} breaks at '${o}' (step ${s+1}/${r.length})`);break}n=n[o]}return null}async function vl(c,e=5e3){let t=Date.now(),i=0;for(;Date.now()-t<e;){i++;try{let a=document.querySelector(c);if(a)return console.log(`\u2705 [StarryNight] DOM element '${c}' found after ${i} attempts (${Date.now()-t}ms)`),a}catch(a){console.warn(`\u274C [StarryNight] DOM query error for '${c}':`,a)}await new Promise(a=>setTimeout(a,200))}return console.warn(`\u274C [StarryNight] DOM element '${c}' not found after ${e}ms (${i} attempts)`),null}async function Sl(c=5e3){let e=Date.now();for(;Date.now()-e<c;){try{let t=getComputedStyle(document.documentElement),i=t.getPropertyValue("--spice-base").trim(),a=t.getPropertyValue("--spice-accent").trim(),r=t.getPropertyValue("--spice-text").trim(),n=s=>{let o=s.toLowerCase();return s&&!o.includes("#ffffff")&&!o.includes("#fff")&&!o.includes("white")&&o.match(/^#[0-9a-f]{6}$/i)};if(n(i)&&n(a)&&n(r))return console.log(`\u{1F3A8} [StarryNight] Catppuccin theme loaded: base=${i}, accent=${a}, text=${r}`),!0;console.log(`\u{1F3A8} [StarryNight] Waiting for Catppuccin theme... (base=${i}, accent=${a})`)}catch{}await new Promise(t=>setTimeout(t,200))}return console.warn(`\u{1F3A8} [StarryNight] Catppuccin theme not fully loaded after ${c}ms - proceeding with fallbacks`),!1}function Cl(){let c=globalThis;if(c.__STARLIGHT_REACT_SHIM__)return;let e=t=>{if(t==="react")return c.Spicetify?.React;if(t==="react-dom")return c.Spicetify?.ReactDOM;throw new Error(`[StarryNight shim] Module '${t}' not available`)};if(typeof c.require=="function"){let t=c.require.bind(c);c.require=i=>i==="react"||i==="react-dom"?e(i):t(i)}else c.require=e;c.__STARLIGHT_REACT_SHIM__=!0}Cl();(async function(){let e=Date.now();if(console.log("\u{1F31F} [Catppuccin StarryNight] Theme entry point starting..."),await js(1e4)?console.log("\u2705 [StarryNight] Spicetify platform fully ready"):(console.error("\u274C [StarryNight] CRITICAL: Spicetify not fully ready after 10s \u2013 proceeding with degraded visual-only mode."),console.error("\u274C [StarryNight] Available Spicetify objects:",{Spicetify:!!window.Spicetify,showNotification:!!window.Spicetify?.showNotification,Platform:!!window.Spicetify?.Platform})),await Sl(8e3))console.log("\u2705 [StarryNight] Catppuccin theme fully loaded");else{console.error("\u274C [StarryNight] CRITICAL: Catppuccin theme not fully loaded after 8s \u2013 may experience color issues");let h=getComputedStyle(document.documentElement);console.error("\u274C [StarryNight] Current CSS variables:",{base:h.getPropertyValue("--spice-base").trim(),accent:h.getPropertyValue("--spice-accent").trim(),text:h.getPropertyValue("--spice-text").trim()})}let a={player:await Kt("Spicetify.Player",3e3),platform:await Kt("Spicetify.Platform",3e3),menu:await Kt("Spicetify.Menu",2e3),react:await Kt("Spicetify.React",2e3),reactDOM:await Kt("Spicetify.ReactDOM",2e3)},r=[".main-viewContainer-scrollNode",".main-view-container__scroll-node-child",".main-view-container",".main-container","#main","[data-testid='main-container']"],n=null;for(let h of r)if(n=await vl(h,1e3),n){console.log(`\u2705 [StarryNight] Found main container using selector: ${h}`);break}n?console.log("\u2705 [StarryNight] Enhanced UI features initialized with DOM container"):(console.warn("\u26A0\uFE0F [StarryNight] No suitable main container found - enhanced UI features disabled"),console.warn("\u26A0\uFE0F [StarryNight] Tried selectors:",r.join(", ")),console.warn("\u26A0\uFE0F [StarryNight] Core functionality (music sync, color extraction) will still work"));let o=!(a.player&&a.platform);o?(console.error("\u274C [StarryNight] DEGRADED MODE: Initializing with limited functionality due to missing APIs"),console.error("\u274C [StarryNight] API availability status:",{player:!!a.player,platform:!!a.platform,menu:!!a.menu,react:!!a.react,reactDOM:!!a.reactDOM,mainContainer:!!n+" (optional)"}),console.error("\u274C [StarryNight] DEGRADED MODE limitations:"),console.error("  - Music synchronization disabled"),console.error("  - Advanced visual effects may not function"),console.error("  - UI integration features disabled"),console.error("  - Color extraction from album art disabled")):console.log("\u2705 [StarryNight] FULL MODE: All required APIs available - initializing complete functionality"),!0&&(E.enableDebug=!0,Promise.resolve().then(()=>(to(),eo)).then(h=>{h.enableDragCartography?.(),window.getDragMap=h.getDragMap}));let m=new Ut(E);try{if(o)await m.initializeWithAvailableAPIs({player:a.player,platform:a.platform,config:window.Spicetify?.Config,degradedMode:!0}),console.log("\u{1F31F} [StarryNight] Initialized in degraded mode - visual systems only"),Ml(m,a);else{await m.initializeAllSystems(),m.setupMusicAnalysisAndColorExtraction(),console.log("\u{1F31F} [StarryNight] Full initialization complete");try{Js(m),Xs(m),Promise.resolve().then(()=>(oo(),so)).then(h=>h.enableEnhancedDragPreview?.()),Promise.resolve().then(()=>(po(),go)).then(h=>h.enableQuickAddRadialMenu?.()),n&&Promise.resolve().then(()=>(bo(),yo)).then(h=>h.initializePrismaticScrollSheen?.()),console.log("\u{1F31F} [StarryNight] UI controllers initialized successfully")}catch(h){console.error("[StarryNight] UI controller initialization failed:",h)}}}catch(h){console.error("[StarryNight] System initialization failed:",h)}try{a.react&&a.reactDOM?(await(await Promise.resolve().then(()=>(_r(),Hr))).initializeStarryNightSettings?.(),console.log("\u{1F31F} [StarryNight] Spicetify native settings with Year3000System integration initialized")):console.warn("\u{1F31F} [StarryNight] React APIs not available - continuing with CSS-only theme")}catch(h){console.error("[StarryNight] Failed to initialize native settings:",h),console.warn("\u{1F31F} [StarryNight] Continuing with CSS-only theme (no settings UI)")}E.enableDebug&&(window.Y3K={system:m,music:m.musicSyncService,settings:m.settingsManager,debug:u.debug,health:m.systemHealthMonitor,mode:o?"degraded":"full",availableAPIs:a});try{let{SidebarVisualEffectsSystem:h}=await Promise.resolve().then(()=>(br(),Rs)),{SidebarPerformanceCoordinator:g}=await Promise.resolve().then(()=>(sr(),ms));if(m.performanceAnalyzer){let f=g.getInstance({enableDebug:E.enableDebug,performanceAnalyzer:m.performanceAnalyzer,onFlushComplete:()=>{m.performanceAnalyzer?.emitTrace?.("[SidebarPerformanceCoordinator] Flush completed")}}),S=new h(E,D,m.performanceAnalyzer,m.musicSyncService,m.settingsManager,m);await S.initialize(),m.sidebarVisualEffectsSystem=S,m.sidebarCoordinator=f}}catch(h){console.error("[StarryNight] Failed to initialize Consolidated Sidebar System",h)}try{let{DepthVisualEffectsController:h}=await Promise.resolve().then(()=>(Eo(),Mo)),g=new h(E,D,m.performanceAnalyzer,m.musicSyncService,m.settingsManager);await g.initialize(),m.depthConsciousnessController=g,console.log("\u{1F30A} [StarryNight] Depth Consciousness Controller awakened")}catch(h){console.error("[StarryNight] Failed to initialize DepthVisualEffectsController",h)}try{let{DynamicCatppuccinBridge:h}=await Promise.resolve().then(()=>(To(),wo)),g=new h(E,D,m.performanceAnalyzer,m.musicSyncService,m.settingsManager);await g.initialize(),m.colorHarmonyEngine&&g.linkWithColorHarmonyEngine(m.colorHarmonyEngine),m.depthConsciousnessController&&g.linkWithDepthVisual(m.depthConsciousnessController),m.dynamicCatppuccinBridge=g,console.log("\u{1F3A8} [StarryNight] Dynamic Catppuccin Bridge connected")}catch(h){console.error("[StarryNight] Failed to initialize DynamicCatppuccinBridge",h)}try{let{LivingGradientStrategy:h}=await Promise.resolve().then(()=>(La(),Bn)),g=new h(E,D,m.performanceAnalyzer,m.musicSyncService,m.settingsManager);await g.initialize(),m.dynamicCatppuccinBridge&&console.log("\u{1F30A} [StarryNight] Consolidated Living Gradient System linked with Dynamic Catppuccin Bridge"),m.depthConsciousnessController&&console.log("\u{1F30A} [StarryNight] Consolidated Living Gradient System linked with Depth Consciousness"),m.livingGradientSystem=g,m.livingGradientStrategy=g,console.log("\u{1F30A} [StarryNight] Consolidated Living Gradient Strategy System awakened - unified color processing and visual system lifecycle with performance optimizations")}catch(h){console.error("[StarryNight] Failed to initialize Consolidated Living Gradient Strategy System",h)}try{let{CDFVariableBridge:h}=await Promise.resolve().then(()=>(Ao(),Po));m.cssVariableController&&new h(m.cssVariableController)}catch(h){console.error("[StarryNight] Failed to initialize CDFVariableBridge",h)}let d=Date.now()-e;console.log(`\u{1F30C} Catppuccin StarryNight Theme initialized in ${d}ms (${o?"degraded":"full"} mode). Welcome to the future of sound!`)})();function Ml(c,e){console.log("\u{1F504} [StarryNight] Setting up progressive enhancement monitoring...");let t=0,i=30,a=1e4,r=()=>{t++;let o={player:window.Spicetify?.Player,platform:window.Spicetify?.Platform,menu:window.Spicetify?.Menu,react:window.Spicetify?.React,reactDOM:window.Spicetify?.ReactDOM};if(o.player&&o.platform){console.log("\u2705 [StarryNight] Required APIs now available - upgrading to full mode!"),clearInterval(n),El(c,o).then(()=>{console.log("\u{1F31F} [StarryNight] Successfully upgraded from degraded mode to full mode!"),window.Y3K&&(window.Y3K.mode="full",window.Y3K.availableAPIs=o)}).catch(m=>{console.error("\u274C [StarryNight] Failed to upgrade to full mode:",m)});return}if(t>=i){console.log(`\u23F0 [StarryNight] Progressive enhancement monitoring ended after ${t} attempts (${t*a/1e3}s)`),clearInterval(n);return}t%5===0&&(console.log(`\u{1F504} [StarryNight] Still monitoring for API availability... (attempt ${t}/${i})`),console.log("\u{1F504} [StarryNight] Current API status:",{player:!!o.player,platform:!!o.platform,menu:!!o.menu,react:!!o.react,reactDOM:!!o.reactDOM}))},n=setInterval(r,a),s=()=>{console.log("\u{1F3B5} [StarryNight] Spicetify ready event detected - checking for upgrade..."),r()};window.Spicetify&&window.Spicetify.Player&&window.Spicetify.Player.addEventListener?.("songchange",s),setTimeout(()=>{window.Spicetify?.Player&&window.Spicetify.Player.removeEventListener?.("songchange",s)},i*a)}async function El(c,e){try{if(console.log("\u{1F680} [StarryNight] Beginning upgrade to full mode..."),!c)throw new Error("Year3000System instance not available");if(typeof c.upgradeToFullMode=="function")console.log("\u{1F527} [StarryNight] Using system's built-in upgrade method..."),await c.upgradeToFullMode({player:e.player,platform:e.platform,config:window.Spicetify?.Config,degradedMode:!1});else if(console.log("\u{1F527} [StarryNight] System upgrade method not available - attempting manual initialization..."),c.setupMusicAnalysisAndColorExtraction&&(console.log("\u{1F3B5} [StarryNight] Setting up music analysis and color extraction..."),await c.setupMusicAnalysisAndColorExtraction()),e.react&&e.reactDOM)try{console.log("\u2699\uFE0F [StarryNight] Initializing settings UI..."),await(await Promise.resolve().then(()=>(_r(),Hr))).initializeStarryNightSettings?.(),console.log("\u2705 [StarryNight] Settings UI initialized successfully")}catch(t){console.warn("\u26A0\uFE0F [StarryNight] Failed to initialize settings UI during upgrade:",t)}c.eventBus?.emitSync&&c.eventBus.emitSync("system:upgraded-to-full-mode",{timestamp:Date.now(),availableAPIs:{player:!!e.player,platform:!!e.platform,menu:!!e.menu,react:!!e.react,reactDOM:!!e.reactDOM}}),console.log("\u{1F31F} [StarryNight] Upgrade to full mode completed successfully!")}catch(t){throw console.error("\u274C [StarryNight] Upgrade to full mode failed:",t),t}}})();
