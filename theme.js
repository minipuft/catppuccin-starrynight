"use strict";(()=>{var wo=Object.create;var Yt=Object.defineProperty;var Eo=Object.getOwnPropertyDescriptor;var Po=Object.getOwnPropertyNames;var To=Object.getPrototypeOf,xo=Object.prototype.hasOwnProperty;var Ur=(c=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(c,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):c)(function(c){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+c+'" is not supported')});var b=(c,e)=>()=>(c&&(e=c(c=0)),e);var ie=(c,e)=>{for(var t in e)Yt(c,t,{get:e[t],enumerable:!0})},_r=(c,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Po(e))!xo.call(c,n)&&n!==t&&Yt(c,n,{get:()=>e[n],enumerable:!(i=Eo(e,n))||i.enumerable});return c};var Nr=(c,e,t)=>(t=c!=null?wo(To(c)):{},_r(e||!c||!c.__esModule?Yt(t,"default",{value:c,enumerable:!0}):t,c)),Ao=c=>_r(Yt({},"__esModule",{value:!0}),c);var $r,Wr,Je,Ji=b(()=>{"use strict";$r={latte:{name:"Latte",base:"#eff1f5",text:"#4c4f69",isDark:!1},frappe:{name:"Frapp\xE9",base:"#303446",text:"#c6d0f5",isDark:!0},macchiato:{name:"Macchiato",base:"#24273a",text:"#cad3f5",isDark:!0},mocha:{name:"Mocha",base:"#1e1e2e",text:"#cdd6f4",isDark:!0}},Wr=["rosewater","flamingo","pink","mauve","red","maroon","peach","yellow","green","teal","sky","sapphire","blue","lavender","text","none"],Je={flavor:c=>typeof c=="string"&&c in $r,accentColor:c=>typeof c=="string"&&Wr.includes(c),brightnessMode:c=>typeof c=="string"&&["bright","balanced","dark"].includes(c),paletteSystem:c=>typeof c=="string"&&["catppuccin","year3000"].includes(c),gradientIntensity:c=>typeof c=="string"&&["disabled","minimal","balanced","intense"].includes(c),glassmorphismLevel:c=>typeof c=="string"&&["disabled","minimal","moderate","intense"].includes(c),webglEnabled:c=>typeof c=="boolean"||typeof c=="string"&&["true","false"].includes(c),animationQuality:c=>typeof c=="string"&&["auto","low","high"].includes(c),webglQuality:c=>typeof c=="string"&&["low","medium","high"].includes(c)}});var et,en,tn,Kt=b(()=>{"use strict";et={"analogous-flow":{rule:"analogous",angle:30,description:"Flowing cinematic gradients with adjacent hues"},"triadic-trinity":{rule:"triadic",angle:120,description:"Dramatic three-color gradient dynamics"},"complementary-yin-yang":{rule:"complementary",angle:180,description:"Electric contrast gradients with opposing forces"},"tetradic-cosmic-cross":{rule:"tetradic",angle:90,description:"Complex four-color gradient matrix"},"split-complementary-aurora":{rule:"split-complementary",angle:150,description:"Aurora-like gradient flows with polar contrasts"},"monochromatic-meditation":{rule:"monochromatic",angle:0,description:"Intense single-hue gradient depth"}},en={energyScaling:{low:.8,medium:1.2,high:1.8},valenceScaling:{sad:1,neutral:1.2,happy:1.6},danceabilityEffects:{enable:!0,animationSpeedMultiplier:1.5,blurVariation:.3}},tn={enable:!0,useSmartCalculation:!0,useRealisticData:!0,danceabilityEstimation:{highDance:{min:120,max:140,value:.8},mediumDance:{min:100,max:160,value:.6},lowMediumDance:{min:80,max:180,value:.4},lowDance:{value:.2}},energyEstimation:{tempoWeight:.6,loudnessWeight:.4,tempoRange:{min:60,max:180},loudnessRange:{min:-60,max:0}},danceabilityThresholds:{high:.7,low:.3},energyMultiplierRange:{min:.8,max:1.4},tempoMultipliers:{highDance:1,mediumDance:.75,lowDance:.5},fallbacks:{tempo:120,loudness:-10,danceability:.5,energy:.5,key:0,timeSignature:4}}});var tt,jt=b(()=>{"use strict";tt={"corporate-safe":{displayName:"Corporate Safe",description:"Subtle gradient elegance with professional restraint and refined color transitions",philosophy:"Gentle gradient flows that maintain workspace harmony while providing sophisticated visual depth",multipliers:{opacity:.2,saturation:1.15,brightness:1.08,contrast:1.05,musicEnergyBoost:.4,kineticIntensity:.3,temporalPlayFactor:.2,aestheticGravityStrength:.2,emergentChoreography:!1,visualIntensityBase:.9},features:{rippleEffects:!1,temporalEcho:!1,particleStreams:!1,predictiveHighlights:!0,glassEffects:!0,beatSync:!1,colorHarmony:!1,aestheticGravity:!1},performance:{maxParticles:0,animationThrottle:32,enableGPUAcceleration:!1,reducedMotion:!0}},"artist-vision":{displayName:"Artist Vision",description:"Cinematic gradient expression with vibrant, flowing color transitions",philosophy:"Dramatic gradient harmonies that create depth and emotional resonance through bold color interactions",multipliers:{opacity:.35,saturation:1.45,brightness:1.25,contrast:1.3,musicEnergyBoost:1.2,kineticIntensity:.8,temporalPlayFactor:.7,aestheticGravityStrength:.6,emergentChoreography:!0,visualIntensityBase:1.2},features:{rippleEffects:!0,temporalEcho:!0,particleStreams:!0,predictiveHighlights:!0,glassEffects:!0,beatSync:!0,colorHarmony:!0,aestheticGravity:!0},performance:{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1}},"cosmic-maximum":{displayName:"Cosmic Maximum",description:"Ultra-intense cinematic gradients with maximum color saturation and fluid dynamics",philosophy:"Maximum gradient intensity through electric color combinations that create immersive visual landscapes",multipliers:{opacity:.55,saturation:1.65,brightness:1.35,contrast:1.5,musicEnergyBoost:2.5,kineticIntensity:2,temporalPlayFactor:3,aestheticGravityStrength:2,emergentChoreography:!0,visualIntensityBase:1.8},features:{rippleEffects:!0,temporalEcho:!0,particleStreams:!0,predictiveHighlights:!0,glassEffects:!0,beatSync:!0,colorHarmony:!0,aestheticGravity:!0},performance:{maxParticles:50,animationThrottle:30,enableGPUAcceleration:!0,reducedMotion:!1}}}});var Qt,nn,rn=b(()=>{"use strict";Qt={low:{maxParticles:15,animationThrottle:32,enableGPUAcceleration:!1,enableAdvancedShaders:!1,textureResolution:.5},balanced:{maxParticles:40,animationThrottle:16,enableGPUAcceleration:!0,enableAdvancedShaders:!1,textureResolution:1},high:{maxParticles:75,animationThrottle:16,enableGPUAcceleration:!0,enableAdvancedShaders:!0,textureResolution:1},ultra:{maxParticles:150,animationThrottle:8,enableGPUAcceleration:!0,enableAdvancedShaders:!0,textureResolution:2}},nn={level:"info",performance:{enableFrameBudgetWarnings:!0,throttleWarnings:!0,throttleInterval:5e3,enableAdaptiveDegradation:!0}}});var qr,Yr,Kr,Xt=b(()=>{"use strict";qr="sn-harmonic-intensity",Yr="sn-harmonic-evolution",Kr="sn-glassmorphism-level"});function Zt(c,e){return pe[c].validator(e)}function Jt(c,e){let t=pe[c];return t.parser?t.parser(e):t.validator(e)?e:null}function an(c,e){let t=pe[c];return t.serializer?t.serializer(e):String(e)}function ei(c){return pe[c].defaultValue}function gt(){return Object.keys(pe)}function ti(c){return c in pe}var pe,sn=b(()=>{"use strict";Kt();jt();Ji();pe={"catppuccin-flavor":{defaultValue:"mocha",validator:Je.flavor,description:"Catppuccin color theme variant",category:"core"},"catppuccin-accentColor":{defaultValue:"mauve",validator:Je.accentColor,description:"Primary accent color for UI elements",category:"core"},"sn-brightness-mode":{defaultValue:"bright",validator:Je.brightnessMode,description:"Overall theme brightness level",category:"core"},"sn-palette-system":{defaultValue:"catppuccin",validator:Je.paletteSystem,description:"Color palette system (Catppuccin or Year 3000)",category:"advanced"},"sn-artistic-mode":{defaultValue:"artist-vision",validator:c=>typeof c=="string"&&c in tt,description:"Visual intensity and behavior preset",category:"advanced"},"sn-current-harmonic-mode":{defaultValue:"analogous-flow",validator:c=>typeof c=="string"&&c in et,description:"Color harmony rule for music synchronization",category:"advanced"},"sn-harmonic-intensity":{defaultValue:.7,validator:c=>typeof c=="number"&&c>=0&&c<=1,parser:c=>{let e=parseFloat(c);return!isNaN(e)&&e>=0&&e<=1?e:null},serializer:c=>c.toString(),description:"Intensity of color harmony effects (0-1)",category:"advanced"},"sn-harmonic-evolution":{defaultValue:!0,validator:c=>typeof c=="boolean",parser:c=>c==="true"?!0:c==="false"?!1:null,serializer:c=>c.toString(),description:"Enable dynamic color harmony evolution",category:"advanced"},"sn-gradient-intensity":{defaultValue:"balanced",validator:c=>typeof c=="string"&&["disabled","minimal","balanced","intense"].includes(c),description:"Master control for all gradient background effects",category:"visual"},"sn-glassmorphism-level":{defaultValue:"balanced",validator:c=>typeof c=="string"&&["disabled","minimal","balanced","intense"].includes(c),description:"Glass-like transparency effects intensity",category:"visual"},"sn-webgl-enabled":{defaultValue:!0,validator:c=>typeof c=="boolean",parser:c=>c==="true"?!0:c==="false"?!1:null,serializer:c=>c.toString(),description:"Enable WebGL-accelerated visual effects",category:"performance"},"sn-animation-quality":{defaultValue:"auto",validator:c=>typeof c=="string"&&["auto","low","high"].includes(c),description:"Animation performance vs quality balance",category:"performance"},"sn-webgl-quality":{defaultValue:"medium",validator:c=>typeof c=="string"&&["low","medium","high"].includes(c),description:"WebGL rendering quality level",category:"performance"}}});var pt,on=b(()=>{"use strict";sn();pt=class{constructor(e){this.changeListeners=new Set;this.cache=new Map;this.storage=e}get(e){if(this.cache.has(e))return this.cache.get(e);let t=pe[e],i=this.storage.get(e);if(i==null){let r=t.defaultValue;return this.cache.set(e,r),r}let n=Jt(e,i);if(n===null){console.warn(`[TypedSettingsManager] Invalid stored value for ${e}: "${i}", using default`);let r=t.defaultValue;return this.cache.set(e,r),r}return this.cache.set(e,n),n}set(e,t){if(!Zt(e,t))return console.error(`[TypedSettingsManager] Invalid value for ${e}:`,t),!1;let i=this.cache.get(e)??this.get(e),n=an(e,t),r=this.storage.set(e,n);if(r){this.cache.set(e,t);let a={settingKey:e,oldValue:i,newValue:t,timestamp:Date.now()};this.notifyChangeListeners(a)}return r}getMultiple(e){let t={};for(let i of e)t[i]=this.get(i);return t}setMultiple(e){let t={};for(let[i,n]of Object.entries(e))ti(i)&&(t[i]=this.set(i,n));return t}getAllSettings(){let e={};for(let t of gt())e[t]=this.get(t);return e}reset(e){let t=ei(e);return this.set(e,t)}resetAll(){let e={};for(let t of gt())e[t]=this.reset(t);return e}exists(e){return this.storage.get(e)!==null}remove(e){let t=this.storage.remove(e);return t&&this.cache.delete(e),t}clearCache(){this.cache.clear()}onChange(e){this.changeListeners.add(e)}offChange(e){this.changeListeners.delete(e)}notifyChangeListeners(e){for(let t of this.changeListeners)try{t(e)}catch(i){console.error("[TypedSettingsManager] Error in change listener:",i)}}validateAllSettings(){let e={valid:0,invalid:[],missing:[]};for(let t of gt()){let i=this.storage.get(t);if(i===null){e.missing.push({key:t,usingDefault:ei(t)});continue}Jt(t,i)===null?e.invalid.push({key:t,value:i,error:"Failed to parse or validate value"}):e.valid++}return e}export(){return this.getAllSettings()}import(e){let t={imported:0,failed:[]};for(let[i,n]of Object.entries(e)){if(!ti(i)){t.failed.push({key:i,error:"Unknown setting key"});continue}if(!Zt(i,n)){t.failed.push({key:i,error:"Invalid value for setting"});continue}this.set(i,n)?t.imported++:t.failed.push({key:i,error:"Failed to store setting"})}return t}}});function cn(){return new $e}var $e,ln=b(()=>{"use strict";$e=class{constructor(){this._available=null}isAvailable(){if(this._available!==null)return this._available;try{return this._available=typeof Spicetify<"u"&&typeof Spicetify.LocalStorage?.get=="function"&&typeof Spicetify.LocalStorage?.set=="function",this._available&&Spicetify.LocalStorage.get("__test__"),this._available}catch(e){return console.warn("[SpicetifyStorageAdapter] Spicetify.LocalStorage not available:",e),this._available=!1,!1}}get(e){if(!this.isAvailable())return console.warn(`[SpicetifyStorageAdapter] Cannot get ${e}: Spicetify not available`),null;try{return Spicetify.LocalStorage.get(e)}catch(t){return console.error(`[SpicetifyStorageAdapter] Error reading key ${e}:`,t),null}}set(e,t){if(!this.isAvailable())return console.warn(`[SpicetifyStorageAdapter] Cannot set ${e}: Spicetify not available`),!1;try{return Spicetify.LocalStorage.set(e,t),!0}catch(i){return console.error(`[SpicetifyStorageAdapter] Error setting key ${e}:`,i),!1}}remove(e){if(!this.isAvailable())return console.warn(`[SpicetifyStorageAdapter] Cannot remove ${e}: Spicetify not available`),!1;try{return typeof Spicetify.LocalStorage.remove=="function"?Spicetify.LocalStorage.remove(e):Spicetify.LocalStorage.set(e,null),!0}catch(t){return console.error(`[SpicetifyStorageAdapter] Error removing key ${e}:`,t),!1}}healthCheck(){let e={available:!1,readable:!1,writable:!1,issues:[]};if(e.available=this.isAvailable(),!e.available)return e.issues.push("Spicetify.LocalStorage not available"),e;try{this.get("__health_check_read__"),e.readable=!0}catch(t){e.issues.push(`Read test failed: ${t}`)}try{let t="__health_check_write__",i="test_"+Date.now();this.set(t,i)?this.get(t)===i?(e.writable=!0,this.remove(t)):e.issues.push("Write-read consistency test failed"):e.issues.push("Write operation failed")}catch(t){e.issues.push(`Write test failed: ${t}`)}return e}getDiagnostics(){let e=[];return typeof Spicetify<"u"&&Spicetify.LocalStorage&&e.push(...Object.getOwnPropertyNames(Spicetify.LocalStorage)),{spicetifyVersion:typeof Spicetify<"u"?Spicetify.version:void 0,apiMethods:e,testResults:this.healthCheck()}}}});function un(c){return new it(c)}var it,mn=b(()=>{"use strict";it=class{constructor(e="sn-"){this.prefix=e}getPrefixedKey(e){return e.startsWith(this.prefix)?e:`${this.prefix}${e}`}isAvailable(){try{return typeof localStorage<"u"&&localStorage!==null}catch{return!1}}get(e){if(!this.isAvailable())return console.warn(`[BrowserStorageAdapter] localStorage not available for key: ${e}`),null;try{return localStorage.getItem(this.getPrefixedKey(e))}catch(t){return console.error(`[BrowserStorageAdapter] Error reading key ${e}:`,t),null}}set(e,t){if(!this.isAvailable())return console.warn(`[BrowserStorageAdapter] localStorage not available for key: ${e}`),!1;try{return localStorage.setItem(this.getPrefixedKey(e),t),!0}catch(i){return console.error(`[BrowserStorageAdapter] Error setting key ${e}:`,i),!1}}remove(e){if(!this.isAvailable())return console.warn(`[BrowserStorageAdapter] localStorage not available for key: ${e}`),!1;try{return localStorage.removeItem(this.getPrefixedKey(e)),!0}catch(t){return console.error(`[BrowserStorageAdapter] Error removing key ${e}:`,t),!1}}getAllKeys(){if(!this.isAvailable())return[];let e=[];try{for(let t=0;t<localStorage.length;t++){let i=localStorage.key(t);i&&i.startsWith(this.prefix)&&e.push(i.substring(this.prefix.length))}}catch(t){console.error("[BrowserStorageAdapter] Error enumerating keys:",t)}return e}clear(){if(!this.isAvailable())return!1;try{let e=this.getAllKeys();for(let t of e)localStorage.removeItem(this.getPrefixedKey(t));return!0}catch(e){return console.error("[BrowserStorageAdapter] Error clearing storage:",e),!1}}getUsageStats(){let e={totalKeys:0,totalSize:0,avgKeySize:0};if(!this.isAvailable())return e;try{let t=this.getAllKeys();e.totalKeys=t.length;for(let i of t){let n=this.get(i);n!==null&&(e.totalSize+=i.length+n.length)}e.avgKeySize=e.totalKeys>0?e.totalSize/e.totalKeys:0,typeof navigator<"u"&&"storage"in navigator&&"estimate"in navigator.storage&&navigator.storage.estimate().then(i=>{i.quota!==void 0&&(e.availableQuota=i.quota)}).catch(()=>{})}catch(t){console.error("[BrowserStorageAdapter] Error calculating usage stats:",t)}return e}}});function jr(){return dn||(dn=new ii),dn}function We(){return jr().getSettings()}var ii,dn,x,Qr=b(()=>{"use strict";on();ln();mn();ii=class{constructor(e){this.storageAdapter=e||this.detectBestStorage(),this.settingsManager=new pt(this.storageAdapter)}detectBestStorage(){let e=cn(),t=e.healthCheck();if(t.available&&t.readable&&t.writable)return console.log("[SettingsProvider] Using Spicetify storage adapter"),e;let i=un();return console.log("[SettingsProvider] Using browser storage adapter (localStorage)"),i}getSettings(){return this.settingsManager}getStorage(){return this.storageAdapter}getDiagnostics(){let e=this.storageAdapter instanceof $e?"spicetify":this.storageAdapter instanceof it?"browser":"unknown",t=null;return this.storageAdapter instanceof $e&&(t=this.storageAdapter.healthCheck()),{storageType:e,storageHealth:t,settingsValidation:this.settingsManager.validateAllSettings(),totalSettings:Object.keys(this.settingsManager.getAllSettings()).length}}async migrateFromLegacyStorage(e){console.log("[SettingsProvider] Starting legacy settings migration...");let t=this.settingsManager.import(e);return t.imported>0&&console.log(`[SettingsProvider] Successfully migrated ${t.imported} settings`),t.failed.length>0&&console.warn(`[SettingsProvider] Failed to migrate ${t.failed.length} settings:`,t.failed),{migrated:t.imported,failed:t.failed}}healthCheck(){let e=this.getDiagnostics(),t=e.settingsValidation,i={overall:"healthy",storage:{type:e.storageType,available:!0,issues:[]},settings:{valid:t.valid,invalid:t.invalid.length,missing:t.missing.length},recommendations:[]};return e.storageHealth&&(i.storage.available=e.storageHealth.available,e.storageHealth.issues&&(i.storage.issues=e.storageHealth.issues)),!i.storage.available||i.storage.issues.length>0?(i.overall="unhealthy",i.recommendations.push("Storage system needs attention")):i.settings.invalid>0?(i.overall="degraded",i.recommendations.push("Some settings have invalid values")):i.settings.missing>5&&(i.overall="degraded",i.recommendations.push("Many settings are using defaults")),i.settings.invalid>0&&i.recommendations.push("Run settings validation and repair"),e.storageType==="browser"&&i.recommendations.push("Consider using in Spicetify environment for better integration"),i}},dn=null;x={get:c=>We().get(c),set:(c,e)=>We().set(c,e),reset:c=>We().reset(c),onChange:c=>We().onChange(c),export:()=>We().export(),import:c=>We().import(c)}});var fe=b(()=>{"use strict";Ji();Kt();jt();rn();Xt();on();sn();Qr();ln();mn();fe()});var be,qe,w,U=b(()=>{"use strict";fe();Kt();jt();rn();be=et,qe=tt,w={enableDebug:!0,enableContextualIntelligence:!0,paletteSystem:"catppuccin",performanceProfiles:Qt,logging:nn,healthCheckInterval:1e4,visual:{lightweightParticleSystem:{mode:"artist-vision"},dimensionalNexusSystem:{mode:"artist-vision"},dataGlyphSystem:{mode:"artist-vision"},beatSyncVisualSystem:{mode:"artist-vision"},behavioralPredictionEngine:{mode:"artist-vision"},predictiveMaterializationSystem:{mode:"artist-vision"},sidebarConsciousnessSystem:{mode:"artist-vision"}},enableColorExtraction:!0,enableMusicAnalysis:!0,enableCosmicSync:!0,musicModulationIntensity:.4,artisticMode:"artist-vision",boundGetCurrentMultipliers:null,boundGetCurrentFeatures:null,boundGetCurrentPerformanceSettings:null,_pendingArtisticMode:null,init(){return this.boundGetCurrentMultipliers=this.getCurrentMultipliers.bind(this),this.boundGetCurrentFeatures=this.getCurrentFeatures.bind(this),this.boundGetCurrentPerformanceSettings=this.getCurrentPerformanceSettings.bind(this),!this.artisticMode||!this.paletteSystem?(this.enableDebug&&console.log(`\u{1F3A8} [YEAR3000_CONFIG] Loading preferences (current: artistic=${this.artisticMode}, palette=${this.paletteSystem})`),this.loadArtisticPreference()):this.enableDebug&&console.log(`\u{1F3A8} [YEAR3000_CONFIG] Skipping preference load (current: artistic=${this.artisticMode}, palette=${this.paletteSystem})`),this._pendingArtisticMode&&this.isFullyInitialized()&&(this.enableDebug&&console.log(`\u{1F3A8} [YEAR3000_CONFIG] Applying pending artistic mode: ${this._pendingArtisticMode}`),this.setArtisticMode(this._pendingArtisticMode),this._pendingArtisticMode=null),this.enableDebug&&console.log("\u{1F527} [YEAR3000_CONFIG] Initialized with context-bound methods"),this},currentHarmonicMode:"analogous-flow",harmonicBaseColor:null,harmonicIntensity:.85,harmonicEvolution:!0,musicVisualSync:{...en,enhancedBPM:tn},getCurrentModeProfile(){let c=this.artisticMode||"artist-vision";return qe[c]||qe["artist-vision"]},getCurrentMultipliers(){try{if(typeof this.getCurrentModeProfile!="function")return console.warn("[YEAR3000_CONFIG] getCurrentModeProfile method not available, using fallback multipliers"),this.artisticMultipliers;let c=this.getCurrentModeProfile();return!c||!c.multipliers?(console.warn("[YEAR3000_CONFIG] Invalid profile or missing multipliers, using fallback"),this.artisticMultipliers):c.multipliers}catch(c){return console.error("[YEAR3000_CONFIG] Error in getCurrentMultipliers:",c),this.artisticMultipliers}},getCurrentFeatures(){try{if(typeof this.getCurrentModeProfile!="function")return console.warn("[YEAR3000_CONFIG] getCurrentModeProfile method not available, using fallback features"),{enableAdvancedEffects:!0,enableHarmony:!0,beatSync:!0,colorHarmony:!0};let c=this.getCurrentModeProfile();return!c||!c.features?(console.warn("[YEAR3000_CONFIG] Invalid profile or missing features, using fallback"),{enableAdvancedEffects:!0,enableHarmony:!0,beatSync:!0,colorHarmony:!0}):c.features}catch(c){return console.error("[YEAR3000_CONFIG] Error in getCurrentFeatures:",c),{enableAdvancedEffects:!0,enableHarmony:!0,beatSync:!0,colorHarmony:!0}}},getCurrentPerformanceSettings(){try{if(typeof this.getCurrentModeProfile!="function")return console.warn("[YEAR3000_CONFIG] getCurrentModeProfile method not available, using fallback performance settings"),{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1};let c=this.getCurrentModeProfile();return!c||!c.performance?(console.warn("[YEAR3000_CONFIG] Invalid profile or missing performance settings, using fallback"),{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1}):c.performance}catch(c){return console.error("[YEAR3000_CONFIG] Error in getCurrentPerformanceSettings:",c),{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1}}},isFullyInitialized(){return["setArtisticMode","getCurrentModeProfile","getCurrentMultipliers","getCurrentFeatures","getCurrentPerformanceSettings"].every(e=>typeof this[e]=="function")},safeSetArtisticMode(c){return this.isFullyInitialized()?this.setArtisticMode(c):(console.warn("[YEAR3000_CONFIG] Not fully initialized, deferring artistic mode change"),this._pendingArtisticMode=c,!1)},setArtisticMode(c){let e=Object.keys(qe);if(e.includes(c)){let t=this.artisticMode;return this.artisticMode=c,this.enableDebug&&(console.log(`\u{1F3A8} [YEAR3000_CONFIG] Artistic mode changed: ${t} \u2192 ${c}`),console.log("\u{1F3A8} [YEAR3000_CONFIG] New profile:",this.getCurrentModeProfile())),typeof document<"u"&&document.dispatchEvent(new CustomEvent("year3000ArtisticModeChanged",{detail:{previousMode:t,newMode:c,profile:this.getCurrentModeProfile()}})),typeof globalThis.year3000System<"u"&&globalThis.year3000System.setGradientParameters&&globalThis.year3000System.setGradientParameters(document.documentElement),!0}return console.warn(`[YEAR3000_CONFIG] Invalid artistic mode: ${c}. Valid modes:`,e),!1},setLoggingLevel(c){let e=["off","error","warn","info","debug","verbose"];return e.includes(c)?(this.logging.level=c,c!=="off"&&console.log(`\u{1F527} [YEAR3000_CONFIG] Logging level set to: ${c}`),!0):(console.warn(`[YEAR3000_CONFIG] Invalid logging level: ${c}. Valid levels:`,e),!1)},disablePerformanceWarnings(){this.logging.performance.enableFrameBudgetWarnings=!1,console.log("\u{1F527} [YEAR3000_CONFIG] Performance warnings disabled")},enablePerformanceWarnings(){this.logging.performance.enableFrameBudgetWarnings=!0,console.log("\u{1F527} [YEAR3000_CONFIG] Performance warnings enabled")},setPerformanceWarningThrottle(c){return typeof c=="number"&&c>=0?(this.logging.performance.throttleInterval=c,this.logging.performance.throttleWarnings=c>0,console.log(`\u{1F527} [YEAR3000_CONFIG] Performance warning throttle set to: ${c}ms`),!0):(console.warn("[YEAR3000_CONFIG] Invalid throttle interval. Must be a non-negative number."),!1)},setupForProduction(){this.setLoggingLevel("warn"),this.disablePerformanceWarnings(),this.logging.performance.enableAdaptiveDegradation=!0,console.log("\u{1F527} [YEAR3000_CONFIG] Configured for production environment")},setupForDevelopment(){this.setLoggingLevel("debug"),this.enablePerformanceWarnings(),this.setPerformanceWarningThrottle(2e3),this.logging.performance.enableAdaptiveDegradation=!0,console.log("\u{1F527} [YEAR3000_CONFIG] Configured for development environment")},setupForDebugging(){this.setLoggingLevel("verbose"),this.enablePerformanceWarnings(),this.setPerformanceWarningThrottle(500),this.logging.performance.enableAdaptiveDegradation=!1,console.log("\u{1F527} [YEAR3000_CONFIG] Configured for debugging environment")},validateConfigHealth(){let c={overallStatus:"healthy",issues:[],dynamicChecks:{}},t=Object.keys(this).filter(n=>typeof n=="string").filter(n=>typeof this[n]=="function");for(let n of t)this.hasOwnProperty(n)||c.issues.push({key:String(n),severity:"warning",message:`Method ${n} is not an own property, may indicate prototype chain issues.`});let i=n=>{if(!qe[n]){c.issues.push({key:`artisticMode:${n}`,severity:"critical",message:`Artistic mode profile for '${n}' is missing.`});return}c.dynamicChecks[`${n}Profile`]="ok"};return i(this.artisticMode),i("artist-vision"),i("corporate-safe"),c.issues.length>0&&(c.overallStatus=c.issues.some(n=>n.severity==="critical")?"critical":"unhealthy"),this.enableDebug&&console.log("[YEAR3000_CONFIG] Health Check Report:",c),c},loadArtisticPreference(){try{let c=x.get("sn-artistic-mode"),e=Object.keys(qe);c&&e.includes(String(c))&&this.artisticMode!==c?(this.artisticMode=String(c),this.enableDebug&&console.log(`\u{1F3A8} [YEAR3000_CONFIG] Updated artistic mode from storage: ${c}`)):!c&&this.artisticMode!=="artist-vision"&&(this.artisticMode="artist-vision",this.enableDebug&&console.log("\u{1F3A8} [YEAR3000_CONFIG] Reset artistic mode to default: artist-vision"));let t=x.get("sn-palette-system");t&&["catppuccin","year3000"].includes(String(t))&&this.paletteSystem!==t?(this.paletteSystem=String(t),this.enableDebug&&console.log(`\u{1F3A8} [YEAR3000_CONFIG] Updated palette system from storage: ${t}`)):!t&&this.paletteSystem!=="catppuccin"&&(this.paletteSystem="catppuccin",this.enableDebug&&console.log("\u{1F3A8} [YEAR3000_CONFIG] Reset palette system to default: catppuccin")),this.enableDebug&&(console.log(`\u{1F3A8} [YEAR3000_CONFIG] Current artistic preference: ${this.artisticMode}`),console.log(`\u{1F3A8} [YEAR3000_CONFIG] Current palette system: ${this.paletteSystem}`))}catch(c){this.enableDebug&&console.warn("\u{1F3A8} [YEAR3000_CONFIG] Failed to load preferences:",c),this.artisticMode="artist-vision",this.paletteSystem="catppuccin"}}};typeof w.init=="function"&&w.init()});var le,u,Xr,R=b(()=>{"use strict";U();le=class c{constructor(e={}){this.registeredSystems=new Map;this.reportHistory=[];this.monitoring=!1;this.monitoringInterval=null;this.performanceMetrics=new Map;this.config={enableConsoleReporting:w.enableDebug,reportingInterval:3e4,enablePerformanceTracking:!0,enableSystemHealthMonitoring:!0,maxHistoryEntries:50,verboseLogging:w.enableDebug,...e},this.config.enableConsoleReporting&&console.log("\u{1F527} [UnifiedDebugManager] Debug system initialized")}static getInstance(e){return c.instance||(c.instance=new c(e)),c.instance}registerSystem(e,t,i="unified"){let n={name:e,type:i,initialized:t.initialized||!1,healthy:!0,lastUpdate:Date.now(),issues:[],metrics:{}};this.registeredSystems.set(e,n),this.config.verboseLogging&&console.log(`\u{1F527} [UnifiedDebugManager] Registered system: ${e} (${i})`),this.registeredSystems.size===1&&!this.monitoring&&this.startMonitoring()}unregisterSystem(e){this.registeredSystems.delete(e),this.performanceMetrics.delete(e),this.config.verboseLogging&&console.log(`\u{1F527} [UnifiedDebugManager] Unregistered system: ${e}`),this.registeredSystems.size===0&&this.stopMonitoring()}updateSystem(e,t){let i=this.registeredSystems.get(e);i&&(Object.assign(i,t,{lastUpdate:Date.now()}),this.registeredSystems.set(e,i))}recordMetric(e,t,i){if(!this.config.enablePerformanceTracking)return;let n=this.registeredSystems.get(e);n&&(n.metrics[t]=i,n.lastUpdate=Date.now());let r=`${e}_${t}`,a=this.performanceMetrics.get(r)||[];a.push(i),a.length>100&&a.splice(0,a.length-100),this.performanceMetrics.set(r,a)}recordIssue(e,t){let i=this.registeredSystems.get(e);i&&(i.issues.push(t),i.healthy=!1,i.lastUpdate=Date.now(),this.config.verboseLogging&&console.warn(`\u26A0\uFE0F [${e}] ${t}`))}async performHealthCheck(){let e=Date.now(),t=[],i=0,n=0,r=0,a=0,s=0;for(let[h,g]of this.registeredSystems)try{let f=null,v=g.initialized,C=globalThis.year3000System;if(C){if(C.facadeCoordinator){try{f=C.facadeCoordinator.getCachedNonVisualSystem?.(h)||await C.facadeCoordinator.getNonVisualSystem?.(h)}catch{}if(!f)try{f=C.facadeCoordinator.getVisualSystem?.(h)}catch{}}if(!f){let E=h.charAt(0).toLowerCase()+h.slice(1);f=C[E]||C[h]}}if(f||(f=globalThis[h]),f){if(typeof f.initialized=="boolean")v=f.initialized;else if(typeof f.isInitialized=="function")try{v=await f.isInitialized()}catch{}else if(typeof f.getInitializationStatus=="function")try{let E=await f.getInitializationStatus();v=E?.initialized??E?.ready??!1}catch{}}let P=g.initialized;if(g.initialized=v,g.lastUpdate=e,this.config.verboseLogging&&P!==v&&console.log(`\u{1F527} [UnifiedDebugManager] ${h} initialization status updated: ${P} \u2192 ${v}`),f&&typeof f.healthCheck=="function"){let E=await f.healthCheck();g.healthy=E.healthy??E.ok,E.ok?g.issues=[]:g.issues=[E.details||"Health check failed"]}else g.healthy=v,v?g.issues=[]:g.issues=["System not initialized"];g.frameTime&&(r+=g.frameTime,s++),g.memoryUsage&&(a+=g.memoryUsage),g.healthy?i++:n+=g.issues.length,t.push({...g})}catch(f){g.healthy=!1,g.issues=[`Health check error: ${f}`],n++,this.config.verboseLogging&&console.error(`\u274C [${h}] Health check failed:`,f)}let o=this.registeredSystems.size>0?i/this.registeredSystems.size:1,l;if(o>=.9?l="excellent":o>=.7?l="good":o>=.5?l="degraded":l="critical",this.config.verboseLogging){console.log("\u{1F527} [UnifiedDebugManager] System initialization status for recommendations:");for(let h of t)console.log(`   ${h.name}: ${h.initialized?"\u2705":"\u274C"} initialized`)}let m=this.generateRecommendations(t,l),d={timestamp:e,overallHealth:l,systemCount:this.registeredSystems.size,healthySystems:i,totalIssues:n,systemDetails:t,performance:{avgFrameTime:s>0?r/s:0,totalMemoryMB:a,cpuUsageEstimate:this.estimateCPUUsage()},recommendations:m};return this.reportHistory.push(d),this.reportHistory.length>this.config.maxHistoryEntries&&this.reportHistory.splice(0,this.reportHistory.length-this.config.maxHistoryEntries),d}generateRecommendations(e,t){let i=[];t==="critical"&&i.push("\u{1F6A8} Critical: Multiple systems failing - check console for errors");let n=e.filter(s=>!s.initialized);n.length>0&&i.push(`\u26A0\uFE0F ${n.length} systems not initialized: ${n.map(s=>s.name).join(", ")}`);let r=e.filter(s=>s.frameTime&&s.frameTime>16.67);r.length>0&&i.push(`\u{1F40C} Performance: ${r.length} systems exceeding 16.67ms frame time`);let a=e.filter(s=>s.memoryUsage&&s.memoryUsage>50);return a.length>0&&i.push(`\u{1F4BE} Memory: ${a.length} systems using >50MB`),i.length===0&&i.push("\u2705 All systems operating within normal parameters"),i}estimateCPUUsage(){let e=0,t=0;for(let n of this.registeredSystems.values())n.frameTime&&(e+=n.frameTime,t++);if(t===0)return 0;let i=e/t;return Math.min(100,i/16.67*5)}startMonitoring(){this.monitoring||(this.monitoring=!0,this.monitoringInterval=window.setInterval(()=>{this.performHealthCheck().then(e=>{this.config.enableConsoleReporting&&this.logHealthReport(e)})},this.config.reportingInterval),this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] Monitoring started"))}stopMonitoring(){this.monitoring&&(this.monitoring=!1,this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] Monitoring stopped"))}logHealthReport(e){if(!e){this.performHealthCheck().then(i=>this.logHealthReport(i));return}let t={excellent:"\u{1F31F}",good:"\u2705",degraded:"\u26A0\uFE0F",critical:"\u{1F6A8}"}[e.overallHealth];console.group(`${t} Year 3000 System Health Report - ${new Date().toLocaleTimeString()}`),console.log(`\u{1F4CA} Overall: ${e.overallHealth.toUpperCase()} (${e.healthySystems}/${e.systemCount} healthy)`),e.totalIssues>0&&console.log(`\u{1F6A8} Issues: ${e.totalIssues} total`),console.log(`\u26A1 Performance: ${e.performance.avgFrameTime.toFixed(2)}ms avg frame, ${e.performance.totalMemoryMB.toFixed(1)}MB memory, ~${e.performance.cpuUsageEstimate.toFixed(1)}% CPU`),e.systemDetails.length>0&&(console.group("\u{1F527} System Details"),e.systemDetails.forEach(i=>{let n=i.healthy?"\u2705":"\u274C",r=i.frameTime?` (${i.frameTime.toFixed(2)}ms)`:"";console.log(`${n} ${i.name} [${i.type}]${r}`),i.issues.length>0&&i.issues.forEach(a=>{console.log(`    \u26A0\uFE0F ${a}`)})}),console.groupEnd()),e.recommendations.length>0&&(console.group("\u{1F4A1} Recommendations"),e.recommendations.forEach(i=>console.log(`  ${i}`)),console.groupEnd()),console.groupEnd()}getLatestReport(){return this.reportHistory[this.reportHistory.length-1]||null}getReportHistory(){return[...this.reportHistory]}getSystemInfo(e){return this.registeredSystems.get(e)||null}getAllSystems(){return Array.from(this.registeredSystems.values())}async checkHealth(){let e=await this.performHealthCheck();this.logHealthReport(e)}updateConfig(e){this.config={...this.config,...e},this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] Configuration updated:",e)}reset(){this.stopMonitoring(),this.registeredSystems.clear(),this.reportHistory=[],this.performanceMetrics.clear(),this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] System reset")}destroy(){this.reset(),c.instance=null}},u={debug:{log:(c,e,...t)=>{w?.enableDebug&&console.log(`[${c}] ${e}`,...t)},error:(c,e,t)=>{console.error(`[${c}] ${e}`,t),le.getInstance().recordIssue(c,`${e}${t?`: ${t}`:""}`)},warn:(c,e,...t)=>{console.warn(`[${c}] ${e}`,...t),le.getInstance().recordIssue(c,e)},metric:(c,e,t)=>{le.getInstance().recordMetric(c,e,t)},register:(c,e,t)=>{le.getInstance().registerSystem(c,e,t)},unregister:c=>{le.getInstance().unregisterSystem(c)},checkHealth:()=>le.getInstance().checkHealth(),getReport:()=>le.getInstance().getLatestReport()}};typeof window<"u"&&(window.UnifiedDebugManager=le,window.Y3K=u,console.log("\u{1F527} [UnifiedDebugManager] Global debug interface available:"),console.log("  Y3K.debug.checkHealth() - Check system health"),console.log("  Y3K.debug.getReport() - Get latest debug report"),console.log("  UnifiedDebugManager.getInstance() - Get debug manager"));Xr=le});var nt,hn=b(()=>{"use strict";R();nt=class{constructor(e,t=null,i=null,n=null){this.musicSyncService=null;this.emotionalGradientMapper=null;this.settingsManager=null;this.currentGenre="unknown";this.genreConfidence=0;this.genreHistory=[];this.maxHistorySize=30;this.genreAnalysisBuffer=[];this.bufferSize=10;this.isActive=!1;this.boundSpectralHandler=null;this.boundEmotionalHandler=null;this.genreProfiles={electronic:{bassEmphasis:.8,midFrequencyPattern:.6,trebleSharpness:.9,dynamicRange:.7,rhythmComplexity:.6,syncopation:.4,grooveWeight:.7,tempoVariability:.3,harmonicComplexity:.5,dissonanceTolerance:.6,modalInfluence:.4,microtonal:.2,compression:.8,saturation:.6,stereoWidth:.8,artificialProcessing:.9,organicness:.2,accessibility:.6,experimentalFactor:.7,emotionalRange:.6},rock:{bassEmphasis:.7,midFrequencyPattern:.8,trebleSharpness:.7,dynamicRange:.8,rhythmComplexity:.6,syncopation:.3,grooveWeight:.8,tempoVariability:.4,harmonicComplexity:.6,dissonanceTolerance:.5,modalInfluence:.3,microtonal:.1,compression:.6,saturation:.7,stereoWidth:.7,artificialProcessing:.4,organicness:.6,accessibility:.8,experimentalFactor:.4,emotionalRange:.8},classical:{bassEmphasis:.5,midFrequencyPattern:.7,trebleSharpness:.6,dynamicRange:.9,rhythmComplexity:.8,syncopation:.2,grooveWeight:.4,tempoVariability:.7,harmonicComplexity:.9,dissonanceTolerance:.4,modalInfluence:.6,microtonal:.3,compression:.3,saturation:.2,stereoWidth:.8,artificialProcessing:.1,organicness:.9,accessibility:.4,experimentalFactor:.6,emotionalRange:.9},jazz:{bassEmphasis:.6,midFrequencyPattern:.8,trebleSharpness:.5,dynamicRange:.8,rhythmComplexity:.9,syncopation:.8,grooveWeight:.9,tempoVariability:.6,harmonicComplexity:.9,dissonanceTolerance:.7,modalInfluence:.8,microtonal:.4,compression:.4,saturation:.3,stereoWidth:.7,artificialProcessing:.2,organicness:.8,accessibility:.5,experimentalFactor:.8,emotionalRange:.8},"hip-hop":{bassEmphasis:.9,midFrequencyPattern:.7,trebleSharpness:.8,dynamicRange:.6,rhythmComplexity:.7,syncopation:.6,grooveWeight:.9,tempoVariability:.3,harmonicComplexity:.4,dissonanceTolerance:.5,modalInfluence:.3,microtonal:.1,compression:.8,saturation:.6,stereoWidth:.6,artificialProcessing:.7,organicness:.4,accessibility:.8,experimentalFactor:.5,emotionalRange:.7},ambient:{bassEmphasis:.4,midFrequencyPattern:.5,trebleSharpness:.3,dynamicRange:.9,rhythmComplexity:.2,syncopation:.1,grooveWeight:.2,tempoVariability:.8,harmonicComplexity:.6,dissonanceTolerance:.6,modalInfluence:.7,microtonal:.5,compression:.5,saturation:.4,stereoWidth:.9,artificialProcessing:.6,organicness:.7,accessibility:.3,experimentalFactor:.8,emotionalRange:.6},pop:{bassEmphasis:.6,midFrequencyPattern:.8,trebleSharpness:.7,dynamicRange:.6,rhythmComplexity:.4,syncopation:.3,grooveWeight:.7,tempoVariability:.2,harmonicComplexity:.5,dissonanceTolerance:.3,modalInfluence:.2,microtonal:.1,compression:.8,saturation:.5,stereoWidth:.6,artificialProcessing:.5,organicness:.5,accessibility:.9,experimentalFactor:.2,emotionalRange:.7},metal:{bassEmphasis:.8,midFrequencyPattern:.7,trebleSharpness:.9,dynamicRange:.7,rhythmComplexity:.7,syncopation:.4,grooveWeight:.8,tempoVariability:.3,harmonicComplexity:.6,dissonanceTolerance:.8,modalInfluence:.5,microtonal:.2,compression:.7,saturation:.9,stereoWidth:.7,artificialProcessing:.6,organicness:.4,accessibility:.6,experimentalFactor:.5,emotionalRange:.8},folk:{bassEmphasis:.4,midFrequencyPattern:.7,trebleSharpness:.5,dynamicRange:.7,rhythmComplexity:.4,syncopation:.2,grooveWeight:.6,tempoVariability:.5,harmonicComplexity:.5,dissonanceTolerance:.3,modalInfluence:.6,microtonal:.2,compression:.3,saturation:.2,stereoWidth:.5,artificialProcessing:.1,organicness:.9,accessibility:.7,experimentalFactor:.3,emotionalRange:.7},funk:{bassEmphasis:.9,midFrequencyPattern:.8,trebleSharpness:.6,dynamicRange:.7,rhythmComplexity:.8,syncopation:.9,grooveWeight:1,tempoVariability:.4,harmonicComplexity:.6,dissonanceTolerance:.5,modalInfluence:.4,microtonal:.2,compression:.6,saturation:.5,stereoWidth:.6,artificialProcessing:.3,organicness:.7,accessibility:.7,experimentalFactor:.4,emotionalRange:.6},indie:{bassEmphasis:.5,midFrequencyPattern:.7,trebleSharpness:.6,dynamicRange:.7,rhythmComplexity:.6,syncopation:.4,grooveWeight:.6,tempoVariability:.5,harmonicComplexity:.6,dissonanceTolerance:.5,modalInfluence:.5,microtonal:.3,compression:.5,saturation:.4,stereoWidth:.7,artificialProcessing:.3,organicness:.7,accessibility:.6,experimentalFactor:.6,emotionalRange:.7},reggae:{bassEmphasis:.8,midFrequencyPattern:.6,trebleSharpness:.5,dynamicRange:.6,rhythmComplexity:.5,syncopation:.7,grooveWeight:.8,tempoVariability:.3,harmonicComplexity:.4,dissonanceTolerance:.3,modalInfluence:.4,microtonal:.2,compression:.6,saturation:.4,stereoWidth:.6,artificialProcessing:.3,organicness:.6,accessibility:.7,experimentalFactor:.3,emotionalRange:.6},blues:{bassEmphasis:.6,midFrequencyPattern:.8,trebleSharpness:.6,dynamicRange:.8,rhythmComplexity:.5,syncopation:.4,grooveWeight:.8,tempoVariability:.6,harmonicComplexity:.6,dissonanceTolerance:.4,modalInfluence:.7,microtonal:.3,compression:.4,saturation:.5,stereoWidth:.5,artificialProcessing:.2,organicness:.8,accessibility:.7,experimentalFactor:.4,emotionalRange:.8},country:{bassEmphasis:.5,midFrequencyPattern:.7,trebleSharpness:.6,dynamicRange:.7,rhythmComplexity:.4,syncopation:.3,grooveWeight:.6,tempoVariability:.4,harmonicComplexity:.4,dissonanceTolerance:.2,modalInfluence:.3,microtonal:.1,compression:.5,saturation:.3,stereoWidth:.6,artificialProcessing:.2,organicness:.8,accessibility:.8,experimentalFactor:.2,emotionalRange:.7},techno:{bassEmphasis:.9,midFrequencyPattern:.5,trebleSharpness:.8,dynamicRange:.5,rhythmComplexity:.6,syncopation:.3,grooveWeight:.8,tempoVariability:.2,harmonicComplexity:.4,dissonanceTolerance:.6,modalInfluence:.3,microtonal:.3,compression:.9,saturation:.7,stereoWidth:.8,artificialProcessing:1,organicness:.1,accessibility:.5,experimentalFactor:.6,emotionalRange:.5},house:{bassEmphasis:.8,midFrequencyPattern:.6,trebleSharpness:.7,dynamicRange:.6,rhythmComplexity:.5,syncopation:.4,grooveWeight:.9,tempoVariability:.2,harmonicComplexity:.5,dissonanceTolerance:.4,modalInfluence:.3,microtonal:.2,compression:.8,saturation:.6,stereoWidth:.7,artificialProcessing:.8,organicness:.3,accessibility:.8,experimentalFactor:.4,emotionalRange:.6},trance:{bassEmphasis:.7,midFrequencyPattern:.7,trebleSharpness:.8,dynamicRange:.8,rhythmComplexity:.5,syncopation:.2,grooveWeight:.7,tempoVariability:.3,harmonicComplexity:.6,dissonanceTolerance:.5,modalInfluence:.4,microtonal:.3,compression:.7,saturation:.5,stereoWidth:.9,artificialProcessing:.8,organicness:.2,accessibility:.6,experimentalFactor:.5,emotionalRange:.8},dubstep:{bassEmphasis:1,midFrequencyPattern:.5,trebleSharpness:.9,dynamicRange:.9,rhythmComplexity:.7,syncopation:.6,grooveWeight:.8,tempoVariability:.4,harmonicComplexity:.4,dissonanceTolerance:.8,modalInfluence:.3,microtonal:.4,compression:.8,saturation:.8,stereoWidth:.8,artificialProcessing:.9,organicness:.1,accessibility:.4,experimentalFactor:.7,emotionalRange:.6},unknown:{bassEmphasis:.5,midFrequencyPattern:.5,trebleSharpness:.5,dynamicRange:.5,rhythmComplexity:.5,syncopation:.5,grooveWeight:.5,tempoVariability:.5,harmonicComplexity:.5,dissonanceTolerance:.5,modalInfluence:.5,microtonal:.5,compression:.5,saturation:.5,stereoWidth:.5,artificialProcessing:.5,organicness:.5,accessibility:.5,experimentalFactor:.5,emotionalRange:.5}};this.genreVisualStyles={electronic:{primaryHueRange:[180,270],saturationProfile:[.8,.3],brightnessProfile:[1.1,.4],contrastLevel:.8,gradientComplexity:.8,shapeGeometry:"geometric",edgeSharpness:.9,symmetryLevel:.7,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"linear",transitionCharacter:"mechanical",layerBlending:"contrasting",depthIllusion:.6,particleInfluence:.8,nebulaCharacter:"structured",memoryInfluence:.3,adaptationSpeed:.8,stabilityPreference:.6,emergencePattern:"sudden"},rock:{primaryHueRange:[330,30],saturationProfile:[1.2,.5],brightnessProfile:[1.2,.3],contrastLevel:.9,gradientComplexity:.7,shapeGeometry:"hybrid",edgeSharpness:.7,symmetryLevel:.5,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"sharp",layerBlending:"harmonious",depthIllusion:.7,particleInfluence:.6,nebulaCharacter:"dense",memoryInfluence:.4,adaptationSpeed:.7,stabilityPreference:.7,emergencePattern:"gradual"},classical:{primaryHueRange:[45,135],saturationProfile:[.6,.4],brightnessProfile:[1,.5],contrastLevel:.6,gradientComplexity:.9,shapeGeometry:"organic",edgeSharpness:.3,symmetryLevel:.8,animationStyle:"smooth",pulseBehavior:"subtle",flowDirection:"spiral",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.9,particleInfluence:.4,nebulaCharacter:"ethereal",memoryInfluence:.8,adaptationSpeed:.3,stabilityPreference:.9,emergencePattern:"progressive"},jazz:{primaryHueRange:[30,90],saturationProfile:[.7,.6],brightnessProfile:[.9,.6],contrastLevel:.7,gradientComplexity:.8,shapeGeometry:"abstract",edgeSharpness:.5,symmetryLevel:.3,animationStyle:"chaotic",pulseBehavior:"syncopated",flowDirection:"random",transitionCharacter:"organic",layerBlending:"complementary",depthIllusion:.8,particleInfluence:.7,nebulaCharacter:"wispy",memoryInfluence:.6,adaptationSpeed:.6,stabilityPreference:.4,emergencePattern:"cyclical"},"hip-hop":{primaryHueRange:[270,330],saturationProfile:[1,.4],brightnessProfile:[1.1,.3],contrastLevel:.8,gradientComplexity:.6,shapeGeometry:"geometric",edgeSharpness:.8,symmetryLevel:.6,animationStyle:"rhythmic",pulseBehavior:"syncopated",flowDirection:"linear",transitionCharacter:"sharp",layerBlending:"contrasting",depthIllusion:.5,particleInfluence:.9,nebulaCharacter:"structured",memoryInfluence:.2,adaptationSpeed:.9,stabilityPreference:.5,emergencePattern:"sudden"},ambient:{primaryHueRange:[180,240],saturationProfile:[.4,.3],brightnessProfile:[.8,.4],contrastLevel:.3,gradientComplexity:.9,shapeGeometry:"organic",edgeSharpness:.2,symmetryLevel:.4,animationStyle:"minimal",pulseBehavior:"subtle",flowDirection:"spiral",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.9,particleInfluence:.3,nebulaCharacter:"ethereal",memoryInfluence:.9,adaptationSpeed:.1,stabilityPreference:.9,emergencePattern:"gradual"},pop:{primaryHueRange:[300,60],saturationProfile:[1.1,.3],brightnessProfile:[1.2,.2],contrastLevel:.7,gradientComplexity:.6,shapeGeometry:"hybrid",edgeSharpness:.6,symmetryLevel:.7,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.6,particleInfluence:.5,nebulaCharacter:"dense",memoryInfluence:.5,adaptationSpeed:.7,stabilityPreference:.8,emergencePattern:"gradual"},metal:{primaryHueRange:[0,30],saturationProfile:[.9,.4],brightnessProfile:[.7,.4],contrastLevel:1,gradientComplexity:.7,shapeGeometry:"geometric",edgeSharpness:.9,symmetryLevel:.6,animationStyle:"chaotic",pulseBehavior:"irregular",flowDirection:"radial",transitionCharacter:"sharp",layerBlending:"clashing",depthIllusion:.8,particleInfluence:.7,nebulaCharacter:"dense",memoryInfluence:.3,adaptationSpeed:.8,stabilityPreference:.3,emergencePattern:"sudden"},folk:{primaryHueRange:[60,120],saturationProfile:[.6,.3],brightnessProfile:[.9,.3],contrastLevel:.5,gradientComplexity:.5,shapeGeometry:"organic",edgeSharpness:.3,symmetryLevel:.5,animationStyle:"smooth",pulseBehavior:"subtle",flowDirection:"spiral",transitionCharacter:"organic",layerBlending:"harmonious",depthIllusion:.6,particleInfluence:.3,nebulaCharacter:"wispy",memoryInfluence:.7,adaptationSpeed:.4,stabilityPreference:.8,emergencePattern:"progressive"},funk:{primaryHueRange:[30,90],saturationProfile:[1,.5],brightnessProfile:[1,.4],contrastLevel:.8,gradientComplexity:.7,shapeGeometry:"abstract",edgeSharpness:.6,symmetryLevel:.4,animationStyle:"rhythmic",pulseBehavior:"syncopated",flowDirection:"random",transitionCharacter:"organic",layerBlending:"complementary",depthIllusion:.7,particleInfluence:.8,nebulaCharacter:"wispy",memoryInfluence:.4,adaptationSpeed:.8,stabilityPreference:.5,emergencePattern:"cyclical"},indie:{primaryHueRange:[120,240],saturationProfile:[.7,.4],brightnessProfile:[.9,.4],contrastLevel:.6,gradientComplexity:.7,shapeGeometry:"hybrid",edgeSharpness:.4,symmetryLevel:.5,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"spiral",transitionCharacter:"fluid",layerBlending:"complementary",depthIllusion:.7,particleInfluence:.5,nebulaCharacter:"wispy",memoryInfluence:.6,adaptationSpeed:.5,stabilityPreference:.7,emergencePattern:"progressive"},reggae:{primaryHueRange:[90,150],saturationProfile:[.8,.3],brightnessProfile:[1,.3],contrastLevel:.6,gradientComplexity:.5,shapeGeometry:"organic",edgeSharpness:.4,symmetryLevel:.6,animationStyle:"rhythmic",pulseBehavior:"syncopated",flowDirection:"linear",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.5,particleInfluence:.4,nebulaCharacter:"wispy",memoryInfluence:.6,adaptationSpeed:.5,stabilityPreference:.7,emergencePattern:"cyclical"},blues:{primaryHueRange:[200,260],saturationProfile:[.6,.4],brightnessProfile:[.8,.4],contrastLevel:.6,gradientComplexity:.6,shapeGeometry:"organic",edgeSharpness:.4,symmetryLevel:.4,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.7,particleInfluence:.4,nebulaCharacter:"ethereal",memoryInfluence:.7,adaptationSpeed:.4,stabilityPreference:.8,emergencePattern:"progressive"},country:{primaryHueRange:[30,90],saturationProfile:[.7,.3],brightnessProfile:[1,.3],contrastLevel:.5,gradientComplexity:.5,shapeGeometry:"organic",edgeSharpness:.3,symmetryLevel:.6,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"organic",layerBlending:"harmonious",depthIllusion:.5,particleInfluence:.3,nebulaCharacter:"wispy",memoryInfluence:.7,adaptationSpeed:.4,stabilityPreference:.8,emergencePattern:"gradual"},techno:{primaryHueRange:[240,300],saturationProfile:[1,.4],brightnessProfile:[1.1,.3],contrastLevel:.9,gradientComplexity:.6,shapeGeometry:"geometric",edgeSharpness:1,symmetryLevel:.8,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"linear",transitionCharacter:"mechanical",layerBlending:"contrasting",depthIllusion:.5,particleInfluence:.9,nebulaCharacter:"structured",memoryInfluence:.2,adaptationSpeed:.9,stabilityPreference:.4,emergencePattern:"sudden"},house:{primaryHueRange:[300,360],saturationProfile:[.9,.3],brightnessProfile:[1.1,.3],contrastLevel:.7,gradientComplexity:.6,shapeGeometry:"hybrid",edgeSharpness:.7,symmetryLevel:.7,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.6,particleInfluence:.7,nebulaCharacter:"dense",memoryInfluence:.4,adaptationSpeed:.7,stabilityPreference:.6,emergencePattern:"gradual"},trance:{primaryHueRange:[180,270],saturationProfile:[.8,.5],brightnessProfile:[1,.5],contrastLevel:.7,gradientComplexity:.8,shapeGeometry:"abstract",edgeSharpness:.5,symmetryLevel:.6,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"spiral",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.8,particleInfluence:.6,nebulaCharacter:"ethereal",memoryInfluence:.6,adaptationSpeed:.5,stabilityPreference:.7,emergencePattern:"progressive"},dubstep:{primaryHueRange:[120,180],saturationProfile:[1.2,.6],brightnessProfile:[1.1,.6],contrastLevel:1,gradientComplexity:.8,shapeGeometry:"geometric",edgeSharpness:.9,symmetryLevel:.5,animationStyle:"chaotic",pulseBehavior:"irregular",flowDirection:"random",transitionCharacter:"sharp",layerBlending:"clashing",depthIllusion:.7,particleInfluence:1,nebulaCharacter:"structured",memoryInfluence:.2,adaptationSpeed:1,stabilityPreference:.2,emergencePattern:"sudden"},unknown:{primaryHueRange:[0,360],saturationProfile:[.7,.3],brightnessProfile:[1,.3],contrastLevel:.6,gradientComplexity:.6,shapeGeometry:"hybrid",edgeSharpness:.5,symmetryLevel:.5,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.6,particleInfluence:.5,nebulaCharacter:"wispy",memoryInfluence:.5,adaptationSpeed:.5,stabilityPreference:.6,emergencePattern:"gradual"}};this.cssConsciousnessController=e,this.musicSyncService=t,this.emotionalGradientMapper=i,this.settingsManager=n,this.boundSpectralHandler=this.handleSpectralData.bind(this),this.boundEmotionalHandler=this.handleEmotionalData.bind(this)}async initialize(){this.boundSpectralHandler&&document.addEventListener("music-sync:spectral-data",this.boundSpectralHandler),this.boundEmotionalHandler&&document.addEventListener("emotional-gradient:profile-updated",this.boundEmotionalHandler),this.isActive=!0,u?.debug?.log("GenreGradientEvolution","Genre-responsive gradient evolution system initialized")}handleSpectralData(e){if(!this.isActive)return;let i=e.detail;i&&(this.genreAnalysisBuffer.push(i),this.genreAnalysisBuffer.length>this.bufferSize&&this.genreAnalysisBuffer.shift(),this.genreAnalysisBuffer.length>=this.bufferSize&&this.analyzeGenre())}handleEmotionalData(e){this.isActive&&this.updateVisualEvolution()}analyzeGenre(){if(this.genreAnalysisBuffer.length===0)return;let e=this.calculateAverageMusicData(),t={};for(let r of Object.keys(this.genreProfiles))t[r]=this.calculateGenreSimilarity(e,this.genreProfiles[r]);let n=Object.entries(t).sort(([,r],[,a])=>a-r)[0];if(n){let[r,a]=n;this.updateGenreDetection(r,a)}}calculateAverageMusicData(){let e=this.genreAnalysisBuffer.reduce((i,n)=>({energy:(i.energy||0)+(n.energy||0),valence:(i.valence||0)+(n.valence||0),danceability:(i.danceability||0)+(n.danceability||0),tempo:(i.tempo||0)+(n.tempo||0),loudness:(i.loudness||0)+(n.loudness||0),acousticness:(i.acousticness||0)+(n.acousticness||0),instrumentalness:(i.instrumentalness||0)+(n.instrumentalness||0),speechiness:(i.speechiness||0)+(n.speechiness||0),mode:n.mode!==void 0?n.mode:i.mode||0,key:(i.key||0)+(n.key||0),genre:n.genre||i.genre||"unknown"}),{energy:0,valence:0,danceability:0,tempo:0,loudness:0,acousticness:0,instrumentalness:0,speechiness:0,mode:0,key:0,genre:"unknown"}),t=this.genreAnalysisBuffer.length;return{energy:(e.energy||0)/t,valence:(e.valence||0)/t,danceability:(e.danceability||0)/t,tempo:(e.tempo||0)/t,loudness:(e.loudness||0)/t,acousticness:(e.acousticness||0)/t,instrumentalness:(e.instrumentalness||0)/t,speechiness:(e.speechiness||0)/t,mode:e.mode||0,key:(e.key||0)/t,genre:e.genre||"unknown"}}calculateGenreSimilarity(e,t){let i={energy:.25,valence:.2,danceability:.2,acousticness:.15,tempo:.1,speechiness:.05,instrumentalness:.05},n=1-Math.abs((e.energy||.5)-(t.dynamicRange*.5+t.rhythmComplexity*.5)),r=1-Math.abs((e.valence||.5)-(t.accessibility*.6+t.emotionalRange*.4)),a=1-Math.abs((e.danceability||.5)-(t.grooveWeight*.7+(1-t.syncopation)*.3)),s=1-Math.abs((e.acousticness||.5)-(t.organicness*.8+(1-t.artificialProcessing)*.2)),o=60+t.rhythmComplexity*80+t.grooveWeight*60,l=1-Math.min(1,Math.abs((e.tempo||120)-o)/100),m=1-Math.abs((e.speechiness||.1)-(t.artificialProcessing*.3+t.accessibility*.1)),d=1-Math.abs((e.instrumentalness||.5)-(t.experimentalFactor*.6+t.harmonicComplexity*.4));return n*i.energy+r*i.valence+a*i.danceability+s*i.acousticness+l*i.tempo+m*i.speechiness+d*i.instrumentalness}updateGenreDetection(e,t){let i=performance.now();this.genreHistory.push({genre:e,confidence:t,timestamp:i}),this.genreHistory.length>this.maxHistorySize&&this.genreHistory.shift();let n=this.genreHistory.slice(-10),r=this.calculateGenreConsensus(n);r.confidence>.6&&(r.genre!==this.currentGenre||r.confidence>this.genreConfidence)&&(this.currentGenre=r.genre,this.genreConfidence=r.confidence,u?.debug?.log("GenreGradientEvolution",`Genre detected: ${this.currentGenre} (confidence: ${this.genreConfidence.toFixed(2)})`),this.updateVisualEvolution(),document.dispatchEvent(new CustomEvent("genre-gradient:genre-detected",{detail:{genre:this.currentGenre,confidence:this.genreConfidence}})))}calculateGenreConsensus(e){let t={};e.forEach((r,a)=>{let s=(a+1)/e.length,o=r.confidence*s;t[r.genre]=(t[r.genre]||0)+o});let i="unknown",n=0;for(let[r,a]of Object.entries(t))a!==void 0&&a>n&&(n=a,i=r);return{genre:i,confidence:n/e.length}}updateVisualEvolution(){if(this.currentGenre==="unknown")return;let e=this.genreVisualStyles[this.currentGenre],t=this.emotionalGradientMapper?.getCurrentEmotionalProfile()||null;this.applyGenreVisualStyle(e,t)}applyGenreVisualStyle(e,t){let i=e.primaryHueRange[1]-e.primaryHueRange[0],n=e.primaryHueRange[0]+i*.5,r=t?(t.valence-.5)*i*.3:0;this.cssConsciousnessController.setProperty("--sn-genre-base-hue",`${n+r}deg`),this.cssConsciousnessController.setProperty("--sn-genre-hue-range",`${i}deg`);let a=t?t.arousal*.3:0,s=t?t.energy*.2:0;this.cssConsciousnessController.setProperty("--sn-genre-saturation-base",(e.saturationProfile[0]+a).toString()),this.cssConsciousnessController.setProperty("--sn-genre-saturation-variation",e.saturationProfile[1].toString()),this.cssConsciousnessController.setProperty("--sn-genre-brightness-base",(e.brightnessProfile[0]+s).toString()),this.cssConsciousnessController.setProperty("--sn-genre-brightness-variation",e.brightnessProfile[1].toString()),this.cssConsciousnessController.setProperty("--sn-genre-contrast-level",e.contrastLevel.toString()),this.cssConsciousnessController.setProperty("--sn-genre-edge-sharpness",e.edgeSharpness.toString()),this.cssConsciousnessController.setProperty("--sn-genre-gradient-complexity",e.gradientComplexity.toString());let o=t?.5+t.energy:1;this.cssConsciousnessController.setProperty("--sn-genre-animation-speed",o.toString()),this.cssConsciousnessController.setProperty("--sn-genre-pulse-intensity",e.depthIllusion.toString());let l=this.mapLayerBlending(e.layerBlending);this.cssConsciousnessController.setProperty("--sn-genre-layer-harmony",l.toString()),this.cssConsciousnessController.setProperty("--sn-genre-depth-illusion",e.depthIllusion.toString()),this.cssConsciousnessController.setProperty("--sn-genre-particle-influence",e.particleInfluence.toString()),this.cssConsciousnessController.setProperty("--sn-genre-memory-influence",e.memoryInfluence.toString()),this.cssConsciousnessController.setProperty("--sn-genre-adaptation-speed",e.adaptationSpeed.toString()),this.cssConsciousnessController.setProperty("--sn-genre-stability-preference",e.stabilityPreference.toString()),this.cssConsciousnessController.setProperty("--sn-current-genre",this.currentGenre),this.cssConsciousnessController.setProperty("--sn-genre-confidence",this.genreConfidence.toString()),this.updateGenreGradientCoordination(e,t)}updateGenreGradientCoordination(e,t){let i=getComputedStyle(document.documentElement),n=i.getPropertyValue("--sn-bg-gradient-primary").trim(),r=i.getPropertyValue("--sn-bg-gradient-secondary").trim(),a=i.getPropertyValue("--sn-bg-gradient-accent").trim();if(n||r||a){let s=t?.5+t.energy:1,o=this.calculateGenreAngle(e);this.cssConsciousnessController.setProperty("--sn-bg-gradient-angle",`${o}deg`);let l=this.calculateGenreOpacity(e,t);this.cssConsciousnessController.setProperty("--sn-bg-gradient-opacity",l.toString());let m=Math.max(60,120*(1-e.edgeSharpness));this.cssConsciousnessController.setProperty("--sn-bg-gradient-blur",`${m}px`);let d=t?t.arousal*.3:0,h=t?t.energy*.2:0;this.cssConsciousnessController.setProperty("--sn-bg-gradient-saturation",(e.saturationProfile[0]+d).toString()),this.cssConsciousnessController.setProperty("--sn-bg-gradient-brightness",(e.brightnessProfile[0]+h).toString()),this.cssConsciousnessController.setProperty("--sn-bg-gradient-contrast",e.contrastLevel.toString()),u?.debug?.log("GenreGradientEvolution",`Coordinated genre "${this.currentGenre}" modifications with gradient system: angle=${o}\xB0, opacity=${l}`)}}calculateGenreAngle(e){return{electronic:135,rock:45,classical:90,jazz:120,"hip-hop":0,ambient:180,pop:315,metal:225,folk:60,funk:30,indie:150,reggae:210,blues:270,country:45,techno:135,house:315,trance:90,dubstep:180,unknown:45}[this.currentGenre]||45}calculateGenreOpacity(e,t){let i=.8;switch(this.currentGenre){case"ambient":case"classical":i=.6;break;case"metal":case"rock":case"dubstep":i=.9;break;case"jazz":case"blues":i=.75;break;default:i=.8}return t&&(i*=.7+t.energy*.3),Math.max(.3,Math.min(1,i))}mapLayerBlending(e){switch(e){case"harmonious":return .9;case"complementary":return .7;case"contrasting":return .5;case"clashing":return .3;default:return .7}}getCurrentGenre(){return this.currentGenre}getGenreConfidence(){return this.genreConfidence}getGenreHistory(){return[...this.genreHistory]}setGenreOverride(e,t=1e4){this.currentGenre=e,this.genreConfidence=1,this.updateVisualEvolution(),u?.debug?.log("GenreGradientEvolution",`Genre override: ${e} for ${t}ms`),setTimeout(()=>{this.genreConfidence=0,u?.debug?.log("GenreGradientEvolution","Genre override expired, returning to automatic detection")},t)}getGenreCharacteristics(e){return this.genreProfiles[e||this.currentGenre]}getGenreVisualStyle(e){return this.genreVisualStyles[e||this.currentGenre]}destroy(){this.isActive=!1,this.boundSpectralHandler&&document.removeEventListener("music-sync:data-updated",this.boundSpectralHandler),this.boundEmotionalHandler&&document.removeEventListener("emotional-gradient:profile-updated",this.boundEmotionalHandler),this.genreAnalysisBuffer=[],this.genreHistory=[],u?.debug?.log("GenreGradientEvolution","Genre evolution system destroyed")}}});var xe,gn,p,D=b(()=>{"use strict";R();xe=class xe{constructor(){this.subscriptions=new Map;this.eventMetrics={totalEvents:0,totalSubscriptions:0,activeSubscriptions:0,eventsPerSecond:0,topEvents:[],memoryUsage:0};this.eventQueue=[];this.processingQueue=!1;this.maxQueueSize=1e3;this.subscriptionCleanupInterval=null;this.metricsUpdateInterval=null;this.startMetricsMonitoring(),this.startSubscriptionCleanup(),u?.debug?.log("UnifiedEventBus","Unified event bus initialized")}static getInstance(){return xe.instance||(xe.instance=new xe),xe.instance}subscribe(e,t,i="anonymous",n={}){let r=this.generateSubscriptionId();this.subscriptions.has(e)||this.subscriptions.set(e,new Map);let a={id:r,eventName:e,handler:t,subscriberName:i,once:n.once||!1,createdAt:Date.now(),triggerCount:0};return this.subscriptions.get(e).set(r,a),this.eventMetrics.totalSubscriptions++,this.eventMetrics.activeSubscriptions++,u?.debug?.log("UnifiedEventBus",`Subscription added: ${i} -> ${e}`,{subscriptionId:r,totalSubscriptions:this.eventMetrics.activeSubscriptions}),r}once(e,t,i="anonymous"){return this.subscribe(e,t,i,{once:!0})}unsubscribe(e){for(let[t,i]of this.subscriptions.entries())if(i.has(e)){let n=i.get(e);return i.delete(e),i.size===0&&this.subscriptions.delete(t),this.eventMetrics.activeSubscriptions--,u?.debug?.log("UnifiedEventBus",`Subscription removed: ${n.subscriberName} -> ${t}`,{subscriptionId:e,remainingSubscriptions:this.eventMetrics.activeSubscriptions}),!0}return!1}unsubscribeAll(e){let t=0;for(let[i,n]of this.subscriptions.entries()){let r=Array.from(n.values()).filter(a=>a.subscriberName===e);for(let a of r)n.delete(a.id),t++,this.eventMetrics.activeSubscriptions--;n.size===0&&this.subscriptions.delete(i)}return t>0&&u?.debug?.log("UnifiedEventBus",`Removed ${t} subscriptions for: ${e}`),t}async emit(e,t){let i=Date.now();if(this.processingQueue||this.eventQueue.length>0){if(this.eventQueue.length>=this.maxQueueSize){u?.debug?.warn("UnifiedEventBus",`Event queue full, dropping event: ${e}`);return}this.eventQueue.push({eventName:e,data:t,timestamp:i}),this.processEventQueue();return}await this.processEvent(e,t,i)}emitSync(e,t){let i=Date.now();this.processEventSync(e,t,i)}async processEvent(e,t,i){let n=this.subscriptions.get(e);if(!n||n.size===0)return;this.eventMetrics.totalEvents++;let r=[],a=[];for(let[o,l]of n.entries())r.push({subscription:l,handler:l.handler}),l.once&&a.push(o),l.lastTriggered=i,l.triggerCount++;let s=r.map(async({subscription:o,handler:l})=>{try{await l(t)}catch(m){u?.debug?.error("UnifiedEventBus",`Handler error in ${o.subscriberName} for ${e}:`,m),this.emitSync("system:error",{systemName:o.subscriberName,error:m instanceof Error?m.message:"Unknown error",severity:"error",timestamp:Date.now()})}});await Promise.all(s);for(let o of a)n.delete(o),this.eventMetrics.activeSubscriptions--;n.size===0&&this.subscriptions.delete(e),u?.debug?.log("UnifiedEventBus",`Event processed: ${e}`,{handlerCount:r.length,processingTime:Date.now()-i})}processEventSync(e,t,i){let n=this.subscriptions.get(e);if(!n||n.size===0)return;this.eventMetrics.totalEvents++;let r=[];for(let[a,s]of n.entries())try{s.handler(t),s.lastTriggered=i,s.triggerCount++,s.once&&r.push(a)}catch(o){u?.debug?.error("UnifiedEventBus",`Sync handler error in ${s.subscriberName} for ${e}:`,o)}for(let a of r)n.delete(a),this.eventMetrics.activeSubscriptions--;n.size===0&&this.subscriptions.delete(e)}async processEventQueue(){if(!this.processingQueue){for(this.processingQueue=!0;this.eventQueue.length>0;){let e=this.eventQueue.shift();await this.processEvent(e.eventName,e.data,e.timestamp)}this.processingQueue=!1}}getMetrics(){return{...this.eventMetrics}}getActiveSubscriptions(){let e=[];for(let[t,i]of this.subscriptions.entries())for(let[n,r]of i.entries())e.push({eventName:t,subscriberName:r.subscriberName,subscriptionId:n,createdAt:r.createdAt,triggerCount:r.triggerCount});return e.sort((t,i)=>i.createdAt-t.createdAt)}startMetricsMonitoring(){this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},5e3)}startSubscriptionCleanup(){this.subscriptionCleanupInterval=window.setInterval(()=>{this.cleanupAbandonedSubscriptions()},6e4)}updateMetrics(){let e=Date.now(),t=this.eventMetrics.totalEvents,i=new Map;for(let[n,r]of this.subscriptions.entries()){let a=0;for(let s of r.values())a+=s.triggerCount;i.set(n,a)}this.eventMetrics.topEvents=Array.from(i.entries()).sort((n,r)=>r[1]-n[1]).slice(0,10).map(([n,r])=>({eventName:n,count:r})),this.eventMetrics.memoryUsage=this.eventMetrics.activeSubscriptions*256}cleanupAbandonedSubscriptions(){let e=Date.now()-3e5,t=0;for(let[i,n]of this.subscriptions.entries()){let r=Array.from(n.values()).filter(a=>!a.lastTriggered&&a.createdAt<e);for(let a of r)n.delete(a.id),t++,this.eventMetrics.activeSubscriptions--;n.size===0&&this.subscriptions.delete(i)}t>0&&u?.debug?.log("UnifiedEventBus",`Cleaned up ${t} abandoned subscriptions`)}generateSubscriptionId(){return`sub_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}destroy(){this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this.subscriptionCleanupInterval&&(clearInterval(this.subscriptionCleanupInterval),this.subscriptionCleanupInterval=null),this.subscriptions.clear(),this.eventQueue=[],this.eventMetrics={totalEvents:0,totalSubscriptions:0,activeSubscriptions:0,eventsPerSecond:0,topEvents:[],memoryUsage:0},u?.debug?.log("UnifiedEventBus","Unified event bus destroyed"),xe.instance=null}};xe.instance=null;gn=xe,p=gn.getInstance()});var Zr={};ie(Zr,{MusicalLerpOrchestrator:()=>ni,musicalLerpOrchestrator:()=>pn});var ni,pn,fn=b(()=>{"use strict";ni=class{constructor(e=!1){this.baseHalfLifeValues={pulse:.08,flow:.15,emotional:.25,organic:.12,crystalline:.06};this.beatPhaseConfig={attack:{start:0,end:.15,baseMultiplier:.3},sustain:{start:.15,end:.5,baseMultiplier:1},decay:{start:.5,end:.85,baseMultiplier:1.4},rest:{start:.85,end:1,baseMultiplier:.8}};this.modulationConfig={tempo:{reference:120,minFactor:.6,maxFactor:1.8,curve:.3},energy:{attackRange:.7,decayRange:.5,baseline:1},danceability:{fluidityMin:.5,fluidityMax:1,organicThreshold:.6},temperature:{neutral:4e3,range:16e3,warmthInfluence:.3,coolPrecision:.4}};this.debugMode=!1;this.debugMode=e}calculateMusicalLerp(e,t="flow",i){return this.calculateMusicalLerpWithPerformance(e,t,i,null)}calculateMusicalLerpWithPerformance(e,t="flow",i,n,r){let a=performance.now(),s=i||this.baseHalfLifeValues[t],o=r&&n,l=!1,m=1,d=1,h=1,g=1,f=1;o&&r?(l=!0,r.useSimplifiedCalculations?(m=Math.max(.7,Math.min(1.5,e.tempo/120)),r.enableEnergyModulation&&(d=1+e.energy*.2),h=.8+e.danceability*.4):(m=this.calculateTempoFactor(e.tempo),r.enableEnergyModulation&&(d=this.calculateEnergyFactor(e.energy)),h=this.calculateDanceabilityFactor(e.danceability),r.enableTemperatureMapping&&(g=this.calculateTemperatureFactor(e.emotionalTemperature)),r.enableBeatPhase&&(f=this.calculateBeatPhaseFactor(e.beatPhase,e.timeSinceLastBeat,e.beatInterval)))):(m=this.calculateTempoFactor(e.tempo),d=this.calculateEnergyFactor(e.energy),h=this.calculateDanceabilityFactor(e.danceability),g=this.calculateTemperatureFactor(e.emotionalTemperature),f=this.calculateBeatPhaseFactor(e.beatPhase,e.timeSinceLastBeat,e.beatInterval));let v=m*d*h*g*f;if(r?.performanceMultiplier&&(v*=r.performanceMultiplier),r?.complexityReduction&&r.complexityReduction>0){let W=1-r.complexityReduction;v=1+(v-1)*W}let C=s*v,P,E;o&&r?.useSimplifiedCalculations?(P=e.energy<.5?1.2:.8,E=e.valence>.5?1.3:1):(P=this.calculateAttackMultiplier(e.energy,e.beatPhase),E=this.calculateDecayMultiplier(e.energy,e.valence));let L=this.calculateFluidityFactor(e.danceability,e.emotionalTemperature),_=this.calculateConsciousnessLevel(e),G={halfLife:Math.max(.01,Math.min(2,C)),attackMultiplier:P,decayMultiplier:E,fluidityFactor:L,consciousnessLevel:_,performanceOptimized:l};if(this.debugMode){G.debugInfo={tempoFactor:m,energyFactor:d,danceabilityFactor:h,temperatureFactor:g,beatPhaseFactor:f},r?.performanceMultiplier!==void 0&&(G.debugInfo.performanceMultiplier=r.performanceMultiplier),r?.complexityReduction!==void 0&&(G.debugInfo.complexityReduction=r.complexityReduction);let B=performance.now()-a;B>.5&&console.log(`\u{1F3B5} [MusicalLerpOrchestrator] Calculation time: ${B.toFixed(3)}ms (performance-optimized: ${l})`)}return G}calculateTempoFactor(e){let{reference:t,minFactor:i,maxFactor:n,curve:r}=this.modulationConfig.tempo,a=e/t,s=Math.pow(a,r);return Math.max(i,Math.min(n,s))}calculateEnergyFactor(e){let{baseline:t}=this.modulationConfig.energy;return t+e*.3}calculateDanceabilityFactor(e){let{fluidityMin:t,fluidityMax:i}=this.modulationConfig.danceability;return t+e*(i-t)}calculateTemperatureFactor(e){let{neutral:t,range:i,warmthInfluence:n}=this.modulationConfig.temperature;return 1+(e-t)/i*n}calculateBeatPhaseFactor(e,t,i){let n=this.beatPhaseConfig[e],r=Math.min(1,t/i),a=n.baseMultiplier;if(e==="attack"&&r>.1){let s=(.15-r)/.05;a=n.baseMultiplier+(1-n.baseMultiplier)*(1-s)}return a}calculateAttackMultiplier(e,t){let{attackRange:i,baseline:n}=this.modulationConfig.energy,r=n-e*i;return t==="attack"&&(r*=.5),Math.max(.1,r)}calculateDecayMultiplier(e,t){let{decayRange:i,baseline:n}=this.modulationConfig.energy,r=n+e*i;return r+=t*.3,Math.max(.8,Math.min(2,r))}calculateFluidityFactor(e,t){let{fluidityMin:i,fluidityMax:n,organicThreshold:r}=this.modulationConfig.danceability,{neutral:a,range:s}=this.modulationConfig.temperature,o=i+e*(n-i),l=(t-a)/s;return o+=l*.2,Math.max(.3,Math.min(1.2,o))}calculateConsciousnessLevel(e){let{energy:t,valence:i,danceability:n,beatConfidence:r}=e,a=t*.3,s=i*.2,o=n*.25,l=r*.25;return Math.max(.1,Math.min(1,a+s+o+l))}getCurrentBeatPhase(e,t){let i=Math.min(1,e/t);return i<=.15?"attack":i<=.5?"sustain":i<=.85?"decay":"rest"}createMusicalContext(e,t=0){let i=e.getCurrentMusicState();if(!i)return null;let{emotion:n,beat:r,intensity:a}=i,o=Date.now()-t,l=r?.tempo?6e4/r.tempo:500;return{tempo:r?.tempo||120,energy:r?.energy||a||.5,valence:n?.valence||.5,danceability:n?.danceability||.5,emotionalTemperature:n?.temperature||4e3,beatPhase:this.getCurrentBeatPhase(o,l),beatConfidence:r?.confidence||.5,beatInterval:l,timeSinceLastBeat:o}}setDebugMode(e){this.debugMode=e}getConfiguration(){return{baseHalfLifeValues:{...this.baseHalfLifeValues},beatPhaseConfig:{...this.beatPhaseConfig},modulationConfig:{...this.modulationConfig}}}},pn=new ni(!1)});var A={};ie(A,{adjustColor:()=>Zo,bpmToAnimationFrameRate:()=>Go,bpmToInterval:()=>ft,calculateBreathingScale:()=>_o,calculateContrastRatio:()=>Do,calculateNavigationScale:()=>No,calculateOklabDerivedProperties:()=>$o,calculateRhythmPhase:()=>Uo,colorDifference:()=>Yo,debounce:()=>Ro,easeBeatAnimation:()=>Oo,findRequiredLuminance:()=>Qo,generateHarmonicOklabColors:()=>Wo,getBeatPhase:()=>Ho,getCanonicalAccent:()=>Jo,getHealthMonitor:()=>jo,getNextBeatTime:()=>zo,getRootStyle:()=>Jr,hexToRgb:()=>ae,hslToRgb:()=>ta,intervalToBpm:()=>Fo,isOnBeat:()=>Vo,isValidHexColor:()=>ea,lerp:()=>qo,lerpSmooth:()=>H,lerpSmoothMusical:()=>ia,lerpSmoothMusicalPerformance:()=>Lo,lerpSmoothSimpleMusical:()=>Bo,oklabToRgb:()=>vn,processOklabColor:()=>Cn,rgbToHex:()=>ye,rgbToHsl:()=>Sn,rgbToOklab:()=>bn,sanitizeColorMap:()=>ko,sleep:()=>Xo,throttle:()=>Io});function Jr(){return document.documentElement}function Io(c,e){let t;return function(...n){t||(c(...n),t=!0,setTimeout(()=>t=!1,e))}}function Ro(c,e){let t;return function(...n){clearTimeout(t),t=window.setTimeout(()=>c(...n),e)}}function ea(c){if(typeof c!="string")return!1;let e=c.trim(),t=e.startsWith("#")?e:`#${e}`;return/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/.test(t)}function ae(c){if(typeof c!="string")return{r:0,g:0,b:0};if(!ea(c))return{r:0,g:0,b:0};let e=c.trim(),t=e.startsWith("#")?e:`#${e}`;t=t.replace(/##+/g,"#"),t.length===4&&(t=`#${t[1]}${t[1]}${t[2]}${t[2]}${t[3]}${t[3]}`);let i=/^#([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(i)try{return{r:parseInt(i[1]||"0",16),g:parseInt(i[2]||"0",16),b:parseInt(i[3]||"0",16)}}catch{return{r:0,g:0,b:0}}else return{r:0,g:0,b:0}}function ko(c){console.log("\u{1F3A8} [Year3000Utilities] sanitizeColorMap input:",{input:c,inputKeys:c?Object.keys(c):[],inputEntries:c?Object.entries(c):[]});let e=/^#?[0-9a-fA-F]{3}(?:[0-9a-fA-F]{3})?$/,t={};if(!c||typeof c!="object")return console.warn("\u{1F3A8} [Year3000Utilities] sanitizeColorMap: Invalid input type"),t;let i=[];return Object.entries(c).forEach(([n,r])=>{if(typeof r!="string"){i.push([n,r]),console.warn(`\u{1F3A8} [Year3000Utilities] Dropped non-string color: ${n} = ${r} (type: ${typeof r})`);return}let a=r.trim();if(!a||a==="undefined"){i.push([n,r]),console.warn(`\u{1F3A8} [Year3000Utilities] Dropped empty/undefined color: ${n} = "${r}"`);return}if(!e.test(a)){i.push([n,r]),console.warn(`\u{1F3A8} [Year3000Utilities] Dropped invalid hex color: ${n} = "${r}"`);return}let s=a.startsWith("#")?a:`#${a}`;t[n]=s}),console.log("\u{1F3A8} [Year3000Utilities] sanitizeColorMap output:",{sanitized:t,sanitizedKeys:Object.keys(t),sanitizedEntries:Object.entries(t),droppedCount:i.length,droppedEntries:i}),w?.enableDebug&&Object.keys(c).length!==Object.keys(t).length&&console.warn(`[StarryNight sanitizeColorMap] Dropped ${Object.keys(c).length-Object.keys(t).length} invalid colour entries.`),t}function Sn(c,e,t){c/=255,e/=255,t/=255;let i=Math.max(c,e,t),n=Math.min(c,e,t),r=0,a=0,s=(i+n)/2;if(i!==n){let o=i-n;switch(a=s>.5?o/(2-i-n):o/(i+n),i){case c:r=(e-t)/o+(e<t?6:0);break;case e:r=(t-c)/o+2;break;case t:r=(c-e)/o+4;break}r/=6}return{h:r*360,s:a*100,l:s*100}}function ta(c,e,t){c/=360,e/=100,t/=100;let i=(s,o,l)=>(l<0&&(l+=1),l>1&&(l-=1),l<1/6?s+(o-s)*6*l:l<1/2?o:l<2/3?s+(o-s)*(2/3-l)*6:s),n,r,a;if(e===0)n=r=a=t;else{let s=t<.5?t*(1+e):t+e-t*e,o=2*t-s;n=i(o,s,c+1/3),r=i(o,s,c),a=i(o,s,c-1/3)}return{r:Math.round(n*255),g:Math.round(r*255),b:Math.round(a*255)}}function ye(c,e,t){let i=s=>{if(!Number.isFinite(s))return 0;let o=s<=1?s*255:s;return Math.min(255,Math.max(0,Math.round(o)))},[n,r,a]=[i(c),i(e),i(t)];return"#"+[n,r,a].map(s=>s.toString(16).padStart(2,"0")).join("")}function Do(c,e){let t=l=>{let[m=0,d=0,h=0]=[l.r,l.g,l.b].map(g=>(g=g/255,g<=.03928?g/12.92:Math.pow((g+.055)/1.055,2.4)));return .2126*m+.7152*d+.0722*h},i=ae(c),n=ae(e);if(!i||!n)return 1;let r=t(i),a=t(n),s=Math.max(r,a),o=Math.min(r,a);return(s+.05)/(o+.05)}function H(c,e,t,i){return i<=1e-5||t<=0?(w?.enableDebug&&i<=1e-5,e):e+(c-e)*Math.pow(2,-t/i)}function ia(c,e,t,i,n="flow",r){let{musicalLerpOrchestrator:a}=(fn(),Ao(Zr)),s=a.calculateMusicalLerp(i,n,r);return H(c,e,t,s.halfLife)}function Lo(c,e,t,i,n,r="flow",a){return n?.calculatePerformanceAwareMusicalLerp?n.calculatePerformanceAwareMusicalLerp(c,e,t,i,r,a):ia(c,e,t,i,r,a)}function Bo(c,e,t,i=120,n=.5,r=.15){let a=Math.pow(i/120,.3),s=1+n*.3,o=r/a*s;return H(c,e,t,o)}function ft(c){return!c||c<=0?500:6e4/c}function Fo(c){return!c||c<=0?120:6e4/c}function Go(c,e=4){return ft(c)/e}function Vo(c,e,t,i=50){let n=ft(t),a=(c-e)%n;return a<=i||a>=n-i}function Ho(c,e,t){let i=ft(t);return(c-e)%i/i}function zo(c,e,t){let i=ft(t),n=c-e,r=Math.floor(n/i);return e+(r+1)*i}function Oo(c,e="ease-out"){switch(e){case"ease-in":return c*c;case"linear":return c;case"ease-out":default:return c*(2-c)}}function Uo(c,e=1){let t=.001*e;return c*t%(2*Math.PI)}function _o(c,e=.5){let i=.02*e;return 1+Math.sin(c)*i}function No(c=.5,e="neutral"){let i=e==="energetic"?1.2:e==="calm"?.8:1;return 1+.05*c*i}function bn(c,e,t){let i=c/255,n=e/255,r=t/255,a=.4122214708*i+.5363325363*n+.0514459929*r,s=.2119034982*i+.6806995451*n+.1073969566*r,o=.0883024619*i+.2817188376*n+.6299787005*r,l=Math.cbrt(a),m=Math.cbrt(s),d=Math.cbrt(o);return{L:.2104542553*l+.793617785*m-.0040720468*d,a:1.9779984951*l-2.428592205*m+.4505937099*d,b:.0259040371*l+.7827717662*m-.808675766*d}}function vn(c,e,t){let i=c+.3963377774*e+.2158037573*t,n=c-.1055613458*e-.0638541728*t,r=c-.0894841775*e-1.291485548*t,a=i*i*i,s=n*n*n,o=r*r*r,l=4.0767416621*a-3.3077115913*s+.2309699292*o,m=-1.2684380046*a+2.6097574011*s-.3413193965*o,d=-.0041960863*a-.7034186147*s+1.707614701*o;return l=Math.round(Math.max(0,Math.min(1,l))*255),m=Math.round(Math.max(0,Math.min(1,m))*255),d=Math.round(Math.max(0,Math.min(1,d))*255),{r:l,g:m,b:d}}function Cn(c,e={}){let{L:t,a:i,b:n}=c,r=Math.sqrt(i*i+n*n),a=Math.atan2(n,i);a<0&&(a+=2*Math.PI);let s=a*(180/Math.PI),{energy:o=.5,valence:l=.5,artisticMode:m="artist-vision"}=e,d=w.getCurrentMultipliers(),h=t*(1+(l-.5)*.1),g=r*(1+(o-.5)*.2)*(d?.saturation||1);return h=Math.max(0,Math.min(1,h*(d?.brightness||1))),{L:h,C:g,h:r>.001?s:null}}function $o(c){let{L:e,C:t,h:i}=Cn(c),n=i!==null?i>=0&&i<90||i>=270&&i<=360:!1,r=i!==null?i>=90&&i<270:!1,a="neutral";return e>.7&&t>.1?a="bright":e<.4?a="dark":n&&t>.1?a="warm":r&&t>.1&&(a="cool"),{lightness:e,chroma:t,hue:i,isWarm:n,isCool:r,mood:a}}function Wo(c,e="analogous",t=30){let i=Cn(c);if(i.h===null)return[c];let n=(l,m,d)=>{let h=d*(Math.PI/180),g=m*Math.cos(h),f=m*Math.sin(h);return{L:l,a:g,b:f}},r=[c],{L:a,C:s,h:o}=i;switch(e){case"complementary":r.push(n(a,s,(o+180)%360));break;case"analogous":r.push(n(a,s,(o+t)%360)),r.push(n(a,s,(o-t+360)%360));break;case"triadic":r.push(n(a,s,(o+120)%360)),r.push(n(a,s,(o+240)%360));break;case"tetradic":r.push(n(a,s,(o+90)%360)),r.push(n(a,s,(o+180)%360)),r.push(n(a,s,(o+270)%360));break;case"split-complementary":r.push(n(a,s,(o+180-t)%360)),r.push(n(a,s,(o+180+t)%360));break;case"monochromatic":r.push({L:Math.max(0,a-.2),a:c.a,b:c.b}),r.push({L:Math.min(1,a+.2),a:c.a,b:c.b});break}return r}function qo(c,e,t){return(1-t)*c+t*e}function Yo(c,e){let t=bn(c.r,c.g,c.b),i=bn(e.r,e.g,e.b),n=t.L-i.L,r=t.a-i.a,a=t.b-i.b;return Math.sqrt(n*n+r*r+a*a)}function jo(){return Ko}function Qo(c,e,t){let i=l=>{let[m=0,d=0,h=0]=[l.r,l.g,l.b].map(g=>(g=g/255,g<=.03928?g/12.92:Math.pow((g+.055)/1.055,2.4)));return .2126*m+.7152*d+.0722*h},n=i(e),r;r=t*(n+.05)-.05;let a=Sn(c.r,c.g,c.b),s=i(c),o=r/s;return a.l}function Xo(c){return new Promise(e=>setTimeout(e,c))}function Zo(c,{brightness:e=1,saturation:t=1,hue:i=0}){let n=Sn(c.r,c.g,c.b);return n.h=(n.h+i)%360,n.s=Math.max(0,Math.min(100,n.s*t)),n.l=Math.max(0,Math.min(100,n.l*e)),ta(n.h,n.s,n.l)}function Jo(){let c=Jr(),e=getComputedStyle(c),t=e.getPropertyValue("--sn-accent-hex").trim(),i=e.getPropertyValue("--sn-accent-rgb").trim();if(!t&&i){let[n="0",r="0",a="0"]=i.split(/\s*,\s*/),s=parseInt(n,10)||0,o=parseInt(r,10)||0,l=parseInt(a,10)||0;t=ye(s,o,l)}if(!i&&t){let n=ae(t);n&&(i=`${n.r},${n.g},${n.b}`)}return{hex:t,rgb:i}}var yn,Ko,K=b(()=>{"use strict";U();yn=class{registerSystem(e,t){}updateSystemMetrics(e,t){}},Ko=new yn});var Se,M,ne=b(()=>{"use strict";R();K();Se=class Se{constructor(e=!1){this.utils=A;this.debugEnabled=e}processColor(e,t=Se.PRESETS.STANDARD){let i=performance.now(),n=null;try{if(n=this.utils.hexToRgb(e),!n)throw new Error(`Invalid hex color: ${e}`);let r=this.utils.rgbToOklab(n.r,n.g,n.b),a=this.enhanceOKLABColor(r,t),s=this.generateShadowColor(r,t),o=this.utils.oklabToRgb(a.L,a.a,a.b),l=this.utils.oklabToRgb(s.L,s.a,s.b),m=this.utils.rgbToHex(o.r,o.g,o.b),d=this.utils.rgbToHex(l.r,l.g,l.b),h=this.convertOklabToOklch(a),g=performance.now()-i,f={originalHex:e,originalRgb:n,enhancedHex:m,enhancedRgb:o,shadowHex:d,shadowRgb:l,oklabOriginal:r,oklabEnhanced:a,oklabShadow:s,oklchEnhanced:h,processingTime:g};return this.debugEnabled&&u?.debug?.log("OKLABColorProcessor","Color processed:",{input:e,enhanced:m,shadow:d,preset:t.name,processingTime:`${g.toFixed(2)}ms`}),f}catch(r){this.debugEnabled&&u?.debug?.error("OKLABColorProcessor","Color processing failed:",r);let a=n||{r:124,g:58,b:237};return this.createFallbackResult(e,a)}}processColorPalette(e,t=Se.PRESETS.STANDARD){let i={};return Object.entries(e).forEach(([n,r])=>{r&&this.utils.hexToRgb(r)&&(i[n]=this.processColor(r,t))}),i}generateCSSVariables(e,t="sn-oklab"){let i={};return i[`--${t}-enhanced-hex`]=e.enhancedHex,i[`--${t}-enhanced-rgb`]=`${e.enhancedRgb.r},${e.enhancedRgb.g},${e.enhancedRgb.b}`,i[`--${t}-enhanced-r`]=Math.round(e.enhancedRgb.r).toString(),i[`--${t}-enhanced-g`]=Math.round(e.enhancedRgb.g).toString(),i[`--${t}-enhanced-b`]=Math.round(e.enhancedRgb.b).toString(),i[`--${t}-shadow-hex`]=e.shadowHex,i[`--${t}-shadow-rgb`]=`${e.shadowRgb.r},${e.shadowRgb.g},${e.shadowRgb.b}`,i[`--${t}-lightness`]=e.oklabEnhanced.L.toFixed(3),i[`--${t}-chroma-a`]=e.oklabEnhanced.a.toFixed(3),i[`--${t}-chroma-b`]=e.oklabEnhanced.b.toFixed(3),i[`--${t}-oklch-l`]=e.oklchEnhanced.L.toFixed(3),i[`--${t}-oklch-c`]=e.oklchEnhanced.C.toFixed(3),i[`--${t}-oklch-h`]=e.oklchEnhanced.H.toFixed(1),i}interpolateOKLAB(e,t,i,n=Se.PRESETS.STANDARD){let r=this.utils.hexToRgb(e),a=this.utils.hexToRgb(t);if(!r||!a)throw new Error("Invalid hex colors for interpolation");let s=this.utils.rgbToOklab(r.r,r.g,r.b),o=this.utils.rgbToOklab(a.r,a.g,a.b),l={L:s.L+(o.L-s.L)*i,a:s.a+(o.a-s.a)*i,b:s.b+(o.b-s.b)*i},m=this.utils.oklabToRgb(l.L,l.a,l.b),d=this.utils.rgbToHex(m.r,m.g,m.b);return this.processColor(d,n)}generateOKLABGradient(e,t,i=5,n=Se.PRESETS.STANDARD){let r=[];for(let a=0;a<i;a++){let s=a/(i-1),o=this.interpolateOKLAB(e,t,s,n);r.push(o)}return r}enhanceOKLABColor(e,t){let i=Math.sqrt(e.a*e.a+e.b*e.b),n=Math.min(1,Math.max(0,e.L*t.lightnessBoost)),r=i>t.vibrantThreshold?t.chromaBoost:1,a=e.a*r,s=e.b*r;return{L:n,a,b:s}}generateShadowColor(e,t){return{L:Math.max(.02,e.L*t.shadowReduction),a:e.a*.8,b:e.b*.8}}convertOklabToOklch(e){let t=e.L,i=Math.sqrt(e.a*e.a+e.b*e.b),n=Math.atan2(e.b,e.a)*(180/Math.PI);return n<0&&(n+=360),{L:t,C:i,H:n}}createFallbackResult(e,t){let i=this.utils.rgbToOklab(t.r,t.g,t.b);return{originalHex:e,originalRgb:t,enhancedHex:e,enhancedRgb:t,shadowHex:"#000000",shadowRgb:{r:0,g:0,b:0},oklabOriginal:i,oklabEnhanced:i,oklabShadow:{L:.05,a:0,b:0},oklchEnhanced:this.convertOklabToOklch(i),processingTime:0}}static getPreset(e){return Se.PRESETS[e.toUpperCase()]||Se.PRESETS.STANDARD}static createCustomPreset(e,t,i,n,r=.3,a=.1){return{name:e,description:t,lightnessBoost:Math.max(.5,Math.min(1.5,i)),chromaBoost:Math.max(.5,Math.min(2,n)),shadowReduction:Math.max(.1,Math.min(.5,r)),vibrantThreshold:Math.max(.05,Math.min(.2,a))}}};Se.PRESETS={SUBTLE:{name:"Subtle Enhancement",description:"Minimal color enhancement for conservative aesthetics",lightnessBoost:1.05,chromaBoost:1.1,shadowReduction:.4,vibrantThreshold:.08},STANDARD:{name:"Standard Enhancement",description:"Balanced color enhancement for general use",lightnessBoost:1.1,chromaBoost:1.15,shadowReduction:.3,vibrantThreshold:.1},VIBRANT:{name:"Vibrant Enhancement",description:"Enhanced vibrancy for dynamic color experiences",lightnessBoost:1.15,chromaBoost:1.25,shadowReduction:.25,vibrantThreshold:.12},COSMIC:{name:"Cosmic Enhancement",description:"Maximum enhancement for Year 3000 consciousness experiences",lightnessBoost:1.2,chromaBoost:1.35,shadowReduction:.2,vibrantThreshold:.15}};M=Se});var ri,J,Ae=b(()=>{"use strict";ne();ri={calm:{temperatureRange:[2700,4e3],baseTemperature:3200,characteristics:{energy:[0,.3],valence:[.4,.8],intensity:.6},cssClass:"organic-emotion-calm",description:"Warm, soothing, meditative states",oklabBaseColor:"#89b4fa",oklabPreset:"SUBTLE",perceptualCharacteristics:{lightness:[.6,.8],chromaBoost:.9,hueShift:15}},melancholy:{temperatureRange:[2200,3500],baseTemperature:2800,characteristics:{energy:[0,.4],valence:[0,.4],intensity:.8},cssClass:"organic-emotion-melancholy",description:"Deep, introspective, amber-golden tones",oklabBaseColor:"#f9e2af",oklabPreset:"STANDARD",perceptualCharacteristics:{lightness:[.4,.6],chromaBoost:1.1,hueShift:-10}},energetic:{temperatureRange:[5500,7500],baseTemperature:6500,characteristics:{energy:[.6,1],valence:[.5,1],intensity:1},cssClass:"organic-emotion-energetic",description:"Bright, vibrant, high-energy states",oklabBaseColor:"#a6e3a1",oklabPreset:"VIBRANT",perceptualCharacteristics:{lightness:[.7,.9],chromaBoost:1.3,hueShift:5}},aggressive:{temperatureRange:[8e3,12e3],baseTemperature:1e4,characteristics:{energy:[.7,1],valence:[0,.6],intensity:1.2},cssClass:"organic-emotion-aggressive",description:"Cool, intense, high-energy negative valence",oklabBaseColor:"#f38ba8",oklabPreset:"COSMIC",perceptualCharacteristics:{lightness:[.5,.7],chromaBoost:1.4,hueShift:-5}},happy:{temperatureRange:[4500,6500],baseTemperature:5500,characteristics:{energy:[.4,.8],valence:[.6,1],intensity:.9},cssClass:"organic-emotion-happy",description:"Balanced, joyful, warm-white tones",oklabBaseColor:"#fab387",oklabPreset:"STANDARD",perceptualCharacteristics:{lightness:[.75,.85],chromaBoost:1.15,hueShift:8}},romantic:{temperatureRange:[2500,3500],baseTemperature:3e3,characteristics:{energy:[.2,.6],valence:[.5,.9],intensity:.7},cssClass:"organic-emotion-romantic",description:"Soft, intimate, warm tones with pink accent",oklabBaseColor:"#f5c2e7",oklabPreset:"SUBTLE",perceptualCharacteristics:{lightness:[.65,.8],chromaBoost:1,hueShift:12}},mysterious:{temperatureRange:[1800,2800],baseTemperature:2300,characteristics:{energy:[.1,.5],valence:[.1,.5],intensity:.9},cssClass:"organic-emotion-mysterious",description:"Deep, enigmatic, low temperature with purple accent",oklabBaseColor:"#cba6f7",oklabPreset:"VIBRANT",perceptualCharacteristics:{lightness:[.3,.5],chromaBoost:1.2,hueShift:-15}},epic:{temperatureRange:[7e3,15e3],baseTemperature:11e3,characteristics:{energy:[.6,1],valence:[.3,.8],intensity:1.3},cssClass:"organic-emotion-epic",description:"Grand, cinematic, high contrast blue-gold",oklabBaseColor:"#74c7ec",oklabPreset:"COSMIC",perceptualCharacteristics:{lightness:[.6,.9],chromaBoost:1.35,hueShift:20}},ambient:{temperatureRange:[3e3,5e3],baseTemperature:4e3,characteristics:{energy:[.1,.4],valence:[.3,.7],intensity:.5},cssClass:"organic-emotion-ambient",description:"Atmospheric, floating, neutral temperature",oklabBaseColor:"#94e2d5",oklabPreset:"SUBTLE",perceptualCharacteristics:{lightness:[.5,.7],chromaBoost:.8,hueShift:0}}},J=class{constructor(e=!1){this.enableDebug=e,this.oklabProcessor=new M(e)}mapMusicToEmotionalTemperature(e){let{energy:t=.5,valence:i=.5,danceability:n=.5,tempo:r=120,mode:a=1}=e,s,o,l=1;if(t>=.6&&i>=.6?(s=n>.7?"energetic":"happy",t>.8&&i>.8&&(o="epic",l=.7)):t>=.6&&i<.5?(s=t>.8?"aggressive":"epic",i<.3&&(o="mysterious",l=.8)):t<.4&&i>=.5?(s=i>.7?"calm":"romantic",t<.2&&(o="ambient",l=.6)):(s=i<.3?"melancholy":"mysterious",t<.2&&i<.2&&(o="ambient",l=.8)),e.genre){let I=this.getGenreEmotionalAdjustment(e.genre,s);I&&(I.override&&(s=I.override),I.secondary&&(o=I.secondary,l=I.blendRatio||.7))}let m=ri[s].characteristics.intensity,d=t*.3,h=Math.abs(i-.5)*.2,g=r>140?.1:r<80?-.1:0,f=Math.max(.1,Math.min(1.5,m+d+h+g)),v=ri[s],[C,P]=v.temperatureRange,E=t*.6+i*.4,L=C+(P-C)*E,_=M.getPreset(v.oklabPreset),G,B;try{let I=this.createContextualOKLABPreset(v,f,t,i);G=this.oklabProcessor.processColor(v.oklabBaseColor,I),B=G.enhancedHex,this.enableDebug&&console.log("\u{1F321}\uFE0F [EmotionalTemperatureMapper] OKLAB processing:",{emotion:s,baseColor:v.oklabBaseColor,preset:I.name,enhanced:B,oklabCoords:G.oklabEnhanced})}catch(I){this.enableDebug&&console.warn("\u{1F321}\uFE0F [EmotionalTemperatureMapper] OKLAB processing failed:",I),B=v.oklabBaseColor}let W=this.generateEmotionalCSSVariables(s,o,f,L,l,G,B),O={primaryEmotion:s,...o&&{secondaryEmotion:o},intensity:f,temperature:Math.round(L),blendRatio:l,cssClass:v.cssClass,cssVariables:W,oklabPreset:_,...G&&{oklabResult:G},...B&&{perceptualColorHex:B}};return this.enableDebug&&console.log("\u{1F321}\uFE0F [EmotionalTemperatureMapper] Music analysis result:",{input:{energy:t,valence:i,genre:e.genre},output:O,reasoning:{energyValenceQuadrant:this.getEnergyValenceQuadrant(t,i),genreInfluence:e.genre,intensityFactors:{baseIntensity:m,energyBoost:d,valenceInfluence:h,tempoInfluence:g}}}),O}createContextualOKLABPreset(e,t,i,n){let r=M.getPreset(e.oklabPreset),a=e.perceptualCharacteristics,s=i*.5+n*.3+.2,o=a.lightness[0]+(a.lightness[1]-a.lightness[0])*s,l=a.chromaBoost*t*(.8+i*.4);return M.createCustomPreset(`${e.cssClass}-contextual`,`Contextual ${r.description} for ${e.description}`,o/.5,l,r.shadowReduction,r.vibrantThreshold)}getGenreEmotionalAdjustment(e,t){let i={edm:{secondary:"energetic",blendRatio:.8},house:{secondary:"energetic",blendRatio:.7},ambient:{override:"ambient"},downtempo:{override:"calm",secondary:"ambient",blendRatio:.6},metal:{override:"aggressive"},"hard-rock":{secondary:"aggressive",blendRatio:.8},alternative:{secondary:"epic",blendRatio:.7},classical:{override:"epic",secondary:"calm",blendRatio:.6},soundtrack:{override:"epic"},orchestral:{override:"epic"},jazz:{override:"mysterious",secondary:"romantic",blendRatio:.7},blues:{override:"melancholy"},soul:{secondary:"romantic",blendRatio:.6},folk:{override:"calm",secondary:"melancholy",blendRatio:.6},acoustic:{override:"romantic",secondary:"calm",blendRatio:.7},"hip-hop":{secondary:"aggressive",blendRatio:.8},trap:{secondary:"aggressive",blendRatio:.9},pop:{secondary:"happy",blendRatio:.7},"indie-pop":{secondary:"happy",blendRatio:.6}},n=e.toLowerCase().replace(/[\s-_]/g,"-");return i[n]||null}getEnergyValenceQuadrant(e,t){return e>=.5&&t>=.5?"High Energy + Positive":e>=.5&&t<.5?"High Energy + Negative":e<.5&&t>=.5?"Low Energy + Positive":"Low Energy + Negative"}generateEmotionalCSSVariables(e,t,i,n,r,a,s){let o={};o["--organic-current-emotion"]=e,o["--organic-emotional-intensity"]=i.toString(),o["--organic-current-temperature"]=n.toString(),o["--organic-emotion-primary"]=e,t&&(o["--organic-emotion-secondary"]=t,o["--organic-emotion-blend-ratio"]=r.toString()),o["--organic-emotional-saturation"]=Math.max(.5,i).toString(),o["--organic-cinematic-contrast"]=Math.max(.8,i*1.2).toString(),o["--organic-warmth"]=this.calculateWarmth(n).toString();let l=this.calculateBreathingSpeed(e,i);o["--organic-breathing-cycle"]=`${l}s`;let m=this.calculateTemperatureFilters(n,i);return Object.assign(o,m),a&&s&&(o["--organic-emotion-oklab-hex"]=s,o["--organic-emotion-oklab-rgb"]=`${a.enhancedRgb.r},${a.enhancedRgb.g},${a.enhancedRgb.b}`,o["--organic-emotion-oklab-l"]=a.oklabEnhanced.L.toFixed(3),o["--organic-emotion-oklab-a"]=a.oklabEnhanced.a.toFixed(3),o["--organic-emotion-oklab-b"]=a.oklabEnhanced.b.toFixed(3),o["--organic-emotion-oklch-l"]=a.oklchEnhanced.L.toFixed(3),o["--organic-emotion-oklch-c"]=a.oklchEnhanced.C.toFixed(3),o["--organic-emotion-oklch-h"]=a.oklchEnhanced.H.toFixed(1),o["--organic-emotion-oklab-shadow-hex"]=a.shadowHex,o["--organic-emotion-oklab-shadow-rgb"]=`${a.shadowRgb.r},${a.shadowRgb.g},${a.shadowRgb.b}`,o["--organic-perceptual-emotion-color"]=s,o["--organic-perceptual-emotion-rgb"]=`${a.enhancedRgb.r},${a.enhancedRgb.g},${a.enhancedRgb.b}`,this.enableDebug&&console.log("\u{1F3A8} [EmotionalTemperatureMapper] Generated OKLAB CSS variables:",{emotion:e,perceptualColor:s,oklabCoords:a.oklabEnhanced,oklchCoords:a.oklchEnhanced})),o}calculateWarmth(e){return e<=4e3?.7+(4e3-e)/2200*.3:e>=7e3?Math.max(.2,.7-(e-7e3)/8e3*.5):.5+(7e3-e)/3e3*.2}calculateBreathingSpeed(e,t){let n={calm:6,melancholy:8,energetic:2,aggressive:1.5,happy:3,romantic:5,mysterious:7,epic:2.5,ambient:10}[e],r=Math.max(.5,Math.min(2,2-t));return n*r}calculateTemperatureFilters(e,t){let i={},n=this.mapTemperatureToHue(e);i["--organic-temperature-hue-shift"]=`${n}deg`;let r=Math.max(.8,Math.min(1.5,1+(t-.5)*.4));i["--organic-temperature-saturation"]=r.toString();let a=this.mapTemperatureToBrightness(e);return i["--organic-temperature-brightness"]=a.toString(),i}mapTemperatureToHue(e){return e<=4e3?-15+(4e3-e)/2e3*-15:e>=8e3?10+(e-8e3)/7e3*20:-5+(e-4e3)/4e3*15}mapTemperatureToBrightness(e){return .9+(e-2e3)/13e3*.3}applyEmotionalTemperature(e,t){let i=Array.from(e.classList).filter(n=>n.startsWith("organic-emotion-"));e.classList.remove(...i),e.classList.add(t.cssClass),t.secondaryEmotion&&e.classList.add(`organic-emotion-blend-${t.secondaryEmotion}`),Object.entries(t.cssVariables).forEach(([n,r])=>{e.style.setProperty(n,r)}),this.enableDebug&&console.log("\u{1F3A8} [EmotionalTemperatureMapper] Applied emotional temperature:",{element:e.tagName,emotion:t.primaryEmotion,secondary:t.secondaryEmotion,intensity:t.intensity,temperature:t.temperature})}static getAvailableEmotions(){return Object.keys(ri)}static getEmotionCharacteristics(e){return ri[e]}}});function y(c,e,t,i){let n=parseInt(c.slice(1,3),16),r=parseInt(c.slice(3,5),16),a=parseInt(c.slice(5,7),16),s=(.299*n+.587*r+.114*a)/255;return{hex:c,rgb:`${n}, ${r}, ${a}`,hsl:[e,t,i],brightness:s}}function na(c,e){let t=Ie[c],i=ec[e];switch(e){case"bright":return c==="latte"?t.surface1:t.surface0;case"balanced":return c==="latte"?t.base:t.surface0;case"dark":return c==="latte"?t.mantle:t.base;default:return t.base}}function ra(c,e){let t=Ie[c];switch(e){case"bright":return c==="latte"?t.surface2:t.surface1;case"balanced":return c==="latte"?t.surface0:t.surface1;case"dark":return t.surface0;default:return t.surface1}}function aa(c,e){return Ie[c][e]}function sa(c){let e=Ie[c];return c==="latte"?e.blue:e.mauve}var Ie,ec,Mn=b(()=>{"use strict";Ie={mocha:{rosewater:y("#f5e0dc",10,56,91),flamingo:y("#f2cdcd",0,59,88),pink:y("#f5c2e7",316,72,86),mauve:y("#cba6f7",267,84,81),red:y("#f38ba8",343,81,75),maroon:y("#eba0ac",350,65,77),peach:y("#fab387",23,92,75),yellow:y("#f9e2af",41,86,83),green:y("#a6e3a1",115,54,76),teal:y("#94e2d5",174,57,73),sky:y("#89dceb",189,71,73),sapphire:y("#74c7ec",199,76,69),blue:y("#89b4fa",217,92,76),lavender:y("#b4befe",232,97,85),text:y("#cdd6f4",226,64,88),subtext1:y("#bac2de",227,35,80),subtext0:y("#a6adc8",228,24,72),overlay2:y("#9399b2",228,17,64),overlay1:y("#7f849c",230,13,55),overlay0:y("#6c7086",231,11,47),surface2:y("#585b70",233,12,39),surface1:y("#45475a",234,13,31),surface0:y("#313244",237,16,23),base:y("#1e1e2e",240,21,15),mantle:y("#181825",240,18,13),crust:y("#11111b",240,23,9)},latte:{rosewater:y("#dc8a78",11,59,67),flamingo:y("#dd7878",0,60,67),pink:y("#ea76cb",316,73,69),mauve:y("#8839ef",266,85,58),red:y("#d20f39",347,87,44),maroon:y("#e64553",355,76,59),peach:y("#fe640b",22,99,52),yellow:y("#df8e1d",35,77,49),green:y("#40a02b",109,58,40),teal:y("#179299",183,74,35),sky:y("#04a5e5",197,97,46),sapphire:y("#209fb5",189,70,42),blue:y("#1e66f5",220,91,54),lavender:y("#7287fd",231,97,72),text:y("#4c4f69",234,16,35),subtext1:y("#5c5f77",233,13,41),subtext0:y("#6c6f85",233,10,47),overlay2:y("#7c7f93",232,10,53),overlay1:y("#8c8fa1",231,10,59),overlay0:y("#9ca0b0",228,11,65),surface2:y("#acb0be",227,12,71),surface1:y("#bcc0cc",226,14,77),surface0:y("#ccd0da",225,16,83),base:y("#eff1f5",220,23,95),mantle:y("#e6e9ef",220,22,92),crust:y("#dce0e8",220,21,89)},frappe:{rosewater:y("#f2d5cf",10,57,88),flamingo:y("#eebebe",0,58,84),pink:y("#f4b8e4",316,73,84),mauve:y("#ca9ee6",277,59,76),red:y("#e78284",359,68,71),maroon:y("#ea999c",358,56,76),peach:y("#ef9f76",20,79,70),yellow:y("#e5c890",40,62,73),green:y("#a6d189",96,44,68),teal:y("#81c8be",172,39,65),sky:y("#99d1db",189,48,73),sapphire:y("#85c1dc",199,55,69),blue:y("#8caaee",222,74,74),lavender:y("#babbf1",239,66,84),text:y("#c6d0f5",227,70,87),subtext1:y("#b5bfe2",229,44,80),subtext0:y("#a5adce",230,34,72),overlay2:y("#949cbb",231,19,64),overlay1:y("#838ba7",232,16,56),overlay0:y("#737994",232,13,49),surface2:y("#626880",233,16,42),surface1:y("#51576d",234,16,35),surface0:y("#414559",235,16,30),base:y("#303446",229,19,23),mantle:y("#292c3c",231,19,20),crust:y("#232634",229,20,17)},macchiato:{rosewater:y("#f4dbd6",10,58,90),flamingo:y("#f0c6c6",0,58,86),pink:y("#f5bde6",316,74,85),mauve:y("#c6a0f6",267,83,79),red:y("#ed8796",351,74,73),maroon:y("#ee99a0",357,70,77),peach:y("#f5a97f",21,86,73),yellow:y("#eed49f",42,79,78),green:y("#a6da95",105,48,72),teal:y("#8bd5ca",172,47,69),sky:y("#91d7e3",189,59,73),sapphire:y("#7dc4e4",199,66,69),blue:y("#8aadf4",220,83,75),lavender:y("#b7bdf8",238,82,84),text:y("#cad3f5",227,68,88),subtext1:y("#b8c0e0",228,39,81),subtext0:y("#a5adcb",227,27,72),overlay2:y("#939ab7",228,20,64),overlay1:y("#8087a2",230,15,56),overlay0:y("#6e738d",230,12,48),surface2:y("#5b6078",233,16,40),surface1:y("#494d64",234,15,33),surface0:y("#363a4f",235,16,26),base:y("#24273a",232,23,19),mantle:y("#1e2030",233,23,16),crust:y("#181926",236,23,13)}},ec={bright:{baseColorTarget:.25,surfaceColorTarget:.35,textContrastMin:4.5},balanced:{baseColorTarget:.15,surfaceColorTarget:.25,textContrastMin:4.5},dark:{baseColorTarget:.08,surfaceColorTarget:.15,textContrastMin:3}}});function S(c,e,t,i){let n=parseInt(c.slice(1,3),16),r=parseInt(c.slice(3,5),16),a=parseInt(c.slice(5,7),16),s=(.299*n+.587*r+.114*a)/255;return{hex:c,rgb:`${n}, ${r}, ${a}`,hsl:[e,t,i],brightness:s}}function oa(c,e){let t=Re[c],i=ic[e];switch(e){case"bright":return t.surface1;case"balanced":return t.surface0;case"dark":return t.base;default:return t.base}}function ca(c,e){let t=Re[c];switch(e){case"bright":return t.surface2;case"balanced":return t.surface1;case"dark":return t.surface0;default:return t.surface1}}function la(c,e){return Re[c][e]}function ua(c){return Re[c].mauve}function ma(c,e="medium"){let t=Re[c];switch(e){case"low":return[t.mauve,t.blue];case"medium":return[t.pink,t.peach];case"high":return[t.red,t.teal];default:return[t.mauve,t.pink]}}function da(c){let e=Re[c];return{primary:e.mauve,secondary:e.pink,tertiary:e.sky,atmosphere:e.base}}var Re,ic,wn=b(()=>{"use strict";Re={subtle:{rosewater:S("#e8d5d1",15,45,85),flamingo:S("#e5c3c3",0,45,82),pink:S("#d8a8cc",316,40,75),mauve:S("#9d7bc7",267,45,65),red:S("#c85a7a",343,45,60),maroon:S("#c27882",350,35,65),peach:S("#d18a5f",23,50,60),yellow:S("#d4c285",41,45,70),green:S("#8cc98a",115,35,65),teal:S("#7bc5b8",174,35,65),sky:S("#7ab5c7",189,40,65),sapphire:S("#6baac7",199,45,60),blue:S("#7d9dd4",217,50,65),lavender:S("#a8aed9",232,45,75),text:S("#c2c8d4",226,25,80),subtext1:S("#b2b8c8",227,20,72),subtext0:S("#9ca4b8",228,15,65),overlay2:S("#868ea8",228,12,58),overlay1:S("#757d95",230,10,52),overlay0:S("#656c82",231,8,45),surface2:S("#555c70",233,8,38),surface1:S("#454c5a",234,8,32),surface0:S("#353a46",237,10,25),base:S("#252832",240,12,17),mantle:S("#1f222a",240,10,15),crust:S("#181b22",240,15,12)},balanced:{rosewater:S("#f2d8d3",15,60,88),flamingo:S("#eec6c6",0,60,85),pink:S("#e8b3d8",316,55,80),mauve:S("#b388d6",267,55,70),red:S("#d16b8a",343,55,65),maroon:S("#d08692",350,45,70),peach:S("#e59a6f",23,65,65),yellow:S("#e0d295",41,55,75),green:S("#9cd49a",115,40,70),teal:S("#8bd0c3",174,40,70),sky:S("#8ac0d2",189,50,70),sapphire:S("#7bb5d2",199,55,65),blue:S("#8da8e0",217,60,70),lavender:S("#b8bee5",232,55,80),text:S("#ced4e0",226,35,85),subtext1:S("#bec4d3",227,25,77),subtext0:S("#a8b0c3",228,20,70),overlay2:S("#929ab3",228,15,63),overlay1:S("#8289a0",230,12,57),overlay0:S("#72798f",231,10,50),surface2:S("#62697d",233,10,43),surface1:S("#525968",234,10,37),surface0:S("#424954",237,12,30),base:S("#2f323e",240,15,22),mantle:S("#282b36",240,12,19),crust:S("#21242e",240,18,16)},cinematic:{rosewater:S("#fce0db",15,85,92),flamingo:S("#f5c9c9",0,85,88),pink:S("#ff6b9d",316,100,70),mauve:S("#6c5ce7",267,85,65),red:S("#ff4757",343,100,65),maroon:S("#e84393",350,80,70),peach:S("#fd7f28",23,95,58),yellow:S("#f39c12",41,88,52),green:S("#a6e3a1",115,54,76),teal:S("#00cec9",174,100,40),sky:S("#74b9ff",189,100,72),sapphire:S("#0984e3",199,100,46),blue:S("#a29bfe",217,95,80),lavender:S("#c77dff",232,100,75),text:S("#e8f0ff",226,100,95),subtext1:S("#d0d8f0",227,65,88),subtext0:S("#b8c0d8",228,45,80),overlay2:S("#a0a8c0",228,30,70),overlay1:S("#8890a8",230,20,60),overlay0:S("#707890",231,15,50),surface2:S("#586078",233,15,42),surface1:S("#485060",234,15,35),surface0:S("#384048",237,18,28),base:S("#202030",240,25,16),mantle:S("#181828",240,22,13),crust:S("#101020",240,30,9)},maximum:{rosewater:S("#ffe5e0",15,100,95),flamingo:S("#ffcccc",0,100,90),pink:S("#ff3d7f",316,100,62),mauve:S("#5a4fcf",267,100,55),red:S("#ff2942",343,100,58),maroon:S("#e6337a",350,90,65),peach:S("#ff6500",23,100,50),yellow:S("#f1c40f",48,89,50),green:S("#00ff88",150,100,50),teal:S("#00ffff",180,100,50),sky:S("#4da6ff",189,100,65),sapphire:S("#0066ff",199,100,50),blue:S("#8a7fff",217,100,75),lavender:S("#b347ff",232,100,65),text:S("#ffffff",0,0,100),subtext1:S("#e8e8ff",240,100,95),subtext0:S("#d0d0ff",240,100,90),overlay2:S("#b8b8ff",240,100,85),overlay1:S("#a0a0ff",240,100,80),overlay0:S("#8888ff",240,100,75),surface2:S("#4040aa",240,60,45),surface1:S("#303088",240,65,35),surface0:S("#202066",240,70,25),base:S("#0f0f33",240,70,13),mantle:S("#0a0a22",240,75,10),crust:S("#050511",240,80,5)}},ic={bright:{baseColorTarget:.25,surfaceColorTarget:.35,textContrastMin:4.5},balanced:{baseColorTarget:.15,surfaceColorTarget:.25,textContrastMin:4.5},dark:{baseColorTarget:.08,surfaceColorTarget:.15,textContrastMin:3}}});function ha(c,e="balanced"){return j.getBrightnessAdjustedBaseColor(c,e)}function ga(c,e="balanced"){return j.getBrightnessAdjustedSurfaceColor(c,e)}function pa(c){return j.getDefaultAccentColor(c)}function fa(c,e){return j.getAccentColor(c,e)}var En,j,bt=b(()=>{"use strict";U();Mn();wn();Mn();wn();En=class c{constructor(){}static getInstance(){return c.instance||(c.instance=new c),c.instance}getCurrentPaletteSystem(){return w.paletteSystem||"catppuccin"}getCurrentPalette(){return this.getCurrentPaletteSystem()==="year3000"?Re:Ie}getCurrentDefaultFlavor(){return this.getCurrentPaletteSystem()==="year3000"?"balanced":"mocha"}getBrightnessAdjustedBaseColor(e,t="balanced"){let i=this.getCurrentPaletteSystem(),n=e||this.getCurrentDefaultFlavor();return i==="year3000"?oa(n,t):na(n,t)}getBrightnessAdjustedSurfaceColor(e,t="balanced"){let i=this.getCurrentPaletteSystem(),n=e||this.getCurrentDefaultFlavor();return i==="year3000"?ca(n,t):ra(n,t)}getDefaultAccentColor(e){let t=this.getCurrentPaletteSystem(),i=e||this.getCurrentDefaultFlavor();return t==="year3000"?ua(i):sa(i)}getAccentColor(e,t){let i=this.getCurrentPaletteSystem(),n=t||this.getCurrentDefaultFlavor();return i==="year3000"?la(n,e):aa(n,e)}getCinematicGradientPair(e,t="medium"){let i=this.getCurrentPaletteSystem(),n=e||this.getCurrentDefaultFlavor();if(i==="year3000")return ma(n,t);{let r=Ie[n];switch(t){case"low":return[r.mauve,r.blue];case"medium":return[r.pink,r.peach];case"high":return[r.red,r.teal];default:return[r.mauve,r.pink]}}}getAnimatedFlowColors(e){let t=this.getCurrentPaletteSystem(),i=e||this.getCurrentDefaultFlavor();if(t==="year3000")return da(i);{let n=Ie[i];return{primary:n.mauve,secondary:n.pink,tertiary:n.blue,atmosphere:n.base}}}supportsCinematicFeatures(){return this.getCurrentPaletteSystem()==="year3000"}getPaletteSystemDisplayName(){return this.getCurrentPaletteSystem()==="year3000"?"Year 3000 Cinematic":"Catppuccin Classic"}},j=En.getInstance()});var ai,si,ba=b(()=>{"use strict";ai={jazz:{temperatureShift:15,saturationBoost:1.1,warmth:.8},electronic:{temperatureShift:-10,saturationBoost:1.2,warmth:.2},classical:{temperatureShift:5,saturationBoost:.9,warmth:.6},rock:{temperatureShift:0,saturationBoost:1.15,warmth:.5},ambient:{temperatureShift:-5,saturationBoost:.8,warmth:.3},hiphop:{temperatureShift:8,saturationBoost:1.25,warmth:.7},pop:{temperatureShift:0,saturationBoost:1,warmth:.5},metal:{temperatureShift:-15,saturationBoost:1.3,warmth:.1},indie:{temperatureShift:10,saturationBoost:.95,warmth:.6},default:{temperatureShift:0,saturationBoost:1,warmth:.5}},si=class{constructor(e,t){this.paletteCache={};this.cacheTTL=3e5;this.maxCacheSize=50;this.config=e,this.utils=t}async loadCustomPalette(e,t){let i=this.paletteCache[e];if(i&&Date.now()-i.timestamp<this.cacheTTL&&i.isValid)return this.config.enableDebug&&console.log(`[PaletteExtensionManager] Cache hit for palette: ${e}`),i.palette;try{let n=this.generateFallbackPalette(e);if(this.validatePalette(n))return this.cachePalette(e,n,!0),n}catch(n){this.config.enableDebug&&console.warn(`[PaletteExtensionManager] Failed to load palette ${e}:`,n)}return null}generateFallbackPalette(e){let t=this.utils.getRootStyle(),i=getComputedStyle(t),n=i.getPropertyValue("--spice-main").trim()||i.getPropertyValue("--spice-base").trim()||"#1e1e2e",r=i.getPropertyValue("--sn-gradient-accent").trim()||i.getPropertyValue("--spice-button").trim()||i.getPropertyValue("--sn-dynamic-accent").trim()||i.getPropertyValue("--spice-accent").trim()||"#8caaee",a=this.utils.hexToRgb(n.startsWith("#")?n:`#${n}`),s=this.utils.hexToRgb(r.startsWith("#")?r:`#${r}`);if(!a||!s){let m=i.getPropertyValue("--sn-dynamic-accent").trim(),d=i.getPropertyValue("--spice-base").trim();return{name:e,version:"1.0.0",accents:{mauve:m||"#ca9ee6",pink:"#f4b8e4",blue:m||"#8caaee",sapphire:"#85c1dc",sky:"#99d1db",teal:"#81c8be",green:"#a6d189",yellow:"#e5c890",peach:"#ef9f76",red:"#e78284",lavender:"#babbf1"},neutrals:{base:d||"#1e1e2e",surface0:"#313244",surface1:"#45475a",surface2:"#585b70",overlay0:"#6c7086",overlay1:"#7f849c",overlay2:"#9399b2",text:"#cdd6f4"},metadata:{author:"PaletteExtensionManager",description:`Generated fallback for ${e}`,temperature:"neutral"}}}let o=this.utils.rgbToHsl(a.r,a.g,a.b),l=this.utils.rgbToHsl(s.r,s.g,s.b);return{name:e,version:"1.0.0",accents:this.generateAccentVariations(l),neutrals:this.generateNeutralVariations(o),metadata:{author:"PaletteExtensionManager",description:`Generated palette for ${e}`,temperature:this.detectTemperature(o,l)}}}applyGenreAwareModifications(e,t){let i=ai[t]||ai.default;this.config.enableDebug&&console.log(`[PaletteExtensionManager] Applying ${t} hints to palette:`,i);let n={...e,accents:{},neutrals:{},metadata:{...e.metadata,genre:[...e.metadata?.genre||[],t]}};for(let[r,a]of Object.entries(e.accents))n.accents[r]=this.applyGenreColorModification(a,i.temperatureShift,i.saturationBoost);for(let[r,a]of Object.entries(e.neutrals))n.neutrals[r]=this.applyGenreColorModification(a,i.temperatureShift*.3,i.saturationBoost*.7);return n}validatePalette(e){if(!e||typeof e!="object"||!e.name||typeof e.name!="string"||!e.version||typeof e.version!="string"||!e.accents||typeof e.accents!="object"||!e.neutrals||typeof e.neutrals!="object")return!1;let t=[...Object.values(e.accents),...Object.values(e.neutrals)];for(let i of t)if(typeof i!="string"||!this.isValidHexColor(i))return!1;return!0}cachePalette(e,t,i){if(Object.keys(this.paletteCache).length>=this.maxCacheSize){let r=Object.entries(this.paletteCache).sort(([,a],[,s])=>a.timestamp-s.timestamp)[0]?.[0];r&&this.paletteCache[r]&&delete this.paletteCache[r]}this.paletteCache[e]={palette:t,timestamp:Date.now(),isValid:i}}generateAccentVariations(e){let t={},i=[0,30,60,120,180,210,240,300,330,45,90],n=["primary","secondary","tertiary","complement","opposite","warm1","cool1","accent1","accent2","highlight","emphasis"];return i.forEach((r,a)=>{let s=n[a]||`variant${a}`,o=(e.h+r)%360,l=this.utils.hslToRgb(o,e.s,e.l);l&&(t[s]=this.utils.rgbToHex(l.r,l.g,l.b))}),t}generateNeutralVariations(e){let t={};return[{name:"base",l:e.l},{name:"surface0",l:Math.min(95,e.l+10)},{name:"surface1",l:Math.min(90,e.l+20)},{name:"surface2",l:Math.min(85,e.l+30)},{name:"overlay0",l:Math.min(80,e.l+40)},{name:"overlay1",l:Math.min(75,e.l+50)},{name:"text",l:Math.min(95,e.l+60)}].forEach(n=>{let r=this.utils.hslToRgb(e.h,Math.max(0,e.s-20),n.l);r&&(t[n.name]=this.utils.rgbToHex(r.r,r.g,r.b))}),t}detectTemperature(e,t){let i=(e.h+t.h)/2;return i>=0&&i<=60||i>=300&&i<=360?"warm":i>=120&&i<=240?"cool":"neutral"}applyGenreColorModification(e,t,i){let n=this.utils.hexToRgb(e);if(!n)return e;let r=this.utils.rgbToHsl(n.r,n.g,n.b),a=(r.h+t+360)%360,s=Math.max(0,Math.min(100,r.s*i)),o=this.utils.hslToRgb(a,s,r.l);return o?this.utils.rgbToHex(o.r,o.g,o.b):e}isValidHexColor(e){return/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(e)}getGenreHints(e){return ai[e]||ai.default}clearCache(){this.paletteCache={},this.config.enableDebug&&console.log("[PaletteExtensionManager] Palette cache cleared")}}});var yt,se,oi,ya=b(()=>{"use strict";D();yt=new Set(["--sn-beat-pulse-intensity","--sn-breathing-scale","--sn-accent-hex","--sn-accent-rgb","--sn.music.beat.pulse.intensity","--sn.music.breathing.scale","--sn.music.rhythm.phase","--sn.music.spectrum.phase","--sn.color.accent.hex","--sn.color.accent.rgb","--sn.bg.webgl.ready","--sn.bg.active-backend"]),se=class se{constructor(e,t){this.initialized=!1;this.cssVariableQueue=new Map;this.batchUpdateTimer=null;this.rafHandle=null;this.microtaskScheduled=!1;this.pendingTransactions=new Map;this.transactionCounter=0;this.updateQueue=new Map;this.flushTimer=null;this.currentDeviceCapabilities=null;this.currentPerformanceMode=null;this.lastCSSUpdate=0;this.cssUpdateThrottle=100;this.appliedClasses=new Set;this.consciousnessState=null;this.consciousnessUpdateTimer=null;this.lastConsciousnessUpdate=0;this.performanceMetrics={totalBatches:0,totalUpdates:0,totalBatchTime:0,maxBatchTime:0,averageBatchSize:0,overBudgetBatches:0,conflictResolutions:0,transactionCount:0,consciousnessUpdates:0};this.PRIORITY_WEIGHTS={low:1,normal:2,high:3,critical:4};this.config=e,this.performanceCoordinator=t,this.eventBus=p,this.cssConfig={batchIntervalMs:0,maxBatchSize:50,enableDebug:e.enableDebug,useCssTextFastPath:!1,autoHijack:!0,enableAdaptiveOptimization:!0,enableThermalThrottling:!0,enableBatteryOptimization:!0,enableDeviceTierOptimization:!0,debugPerformanceClasses:e.enableDebug,enableConsciousnessIntegration:!0,consciousnessUpdateInterval:16,enableMusicConsciousness:!0,enableAestheticConsciousness:!0},this.currentDeviceCapabilities=this.performanceCoordinator.getDeviceCapabilities(),this.currentPerformanceMode=this.performanceCoordinator.getCurrentPerformanceMode(),this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Created with consciousness-driven CSS management")}async initialize(){this.initialized||(this.subscribeToEvents(),this.applyInitialOptimizations(),this.cssConfig.enableConsciousnessIntegration&&this.startConsciousnessIntegration(),this.cssConfig.autoHijack&&this.enableGlobalHijack(),this.initialized=!0,this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Initialized with device tier:",this.currentDeviceCapabilities?.performanceTier))}updateAnimation(e){}async healthCheck(){let e=this.cssVariableQueue.size+this.updateQueue.size,t=this.pendingTransactions.size,i=e<=1e3&&t<=100;return{system:"UnifiedCSSVariableManager",healthy:i,ok:i,details:i?"CSS consciousness controller operating normally":"High queue size or pending transactions",metrics:{queueSize:e,pendingTransactions:t,performanceMetrics:this.performanceMetrics,consciousnessActive:this.consciousnessState!==null,deviceTier:this.currentDeviceCapabilities?.performanceTier,performanceMode:this.currentPerformanceMode?.name}}}destroy(){this.consciousnessUpdateTimer&&(clearTimeout(this.consciousnessUpdateTimer),this.consciousnessUpdateTimer=null),this.flushTimer&&(clearTimeout(this.flushTimer),this.flushTimer=null),this.rafHandle!==null&&(cancelAnimationFrame(this.rafHandle),this.rafHandle=null),this.flushCSSVariableBatch();for(let e of this.appliedClasses)document.body.classList.remove(e);this.appliedClasses.clear(),this.cssVariableQueue.clear(),this.updateQueue.clear(),this.pendingTransactions.clear(),this.initialized=!1,this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Destroyed")}forceRepaint(e){this.flushCSSVariableBatch(),this.config.enableDebug&&e&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Force repaint: ${e}`)}queueCSSVariableUpdate(e,t,i=null,n="normal",r="unknown"){if(yt.has(e)){let d=(i||document.documentElement).style;se.nativeSetProperty?se.nativeSetProperty.call(d,e,t):d.setProperty(e,t);return}let a=i||document.documentElement,o=`${i?`element_${i.id||i.className||"unnamed"}`:"root"}:${e}`,l={element:a,property:e,value:t,timestamp:performance.now(),priority:n,source:r},m=this.cssVariableQueue.get(o);m?this.shouldReplaceUpdate(m,l)&&(this.cssVariableQueue.set(o,l),this.performanceMetrics.conflictResolutions++):this.cssVariableQueue.set(o,l),this.performanceMetrics.totalUpdates++,this.scheduleFlush(n),(n==="critical"||this.cssVariableQueue.size>=this.cssConfig.maxBatchSize)&&this.flushCSSVariableBatch()}updateVariables(e,t="normal",i="unknown"){let n=`tx_${++this.transactionCounter}`,r=new Map(Object.entries(e)),a={id:n,variables:r,timestamp:performance.now(),priority:t,completed:!1};this.pendingTransactions.set(n,a);for(let[s,o]of r)this.queueCSSVariableUpdate(s,o,null,t,`${i}:${n}`);this.performanceMetrics.transactionCount++,this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Transaction ${n} queued with ${r.size} variables`)}updateConsciousnessVariables(e){if(!this.cssConfig.enableConsciousnessIntegration)return;this.consciousnessState=e,this.performanceMetrics.consciousnessUpdates++;let t={};e.musicState&&this.cssConfig.enableMusicConsciousness&&(t["--sn.music.beat.pulse.intensity"]=e.musicState.intensity.toString(),t["--sn.music.tempo.bpm"]=e.musicState.bpm.toString(),t["--sn.music.rhythm.phase"]=`${e.musicState.rhythmPhase}deg`,t["--sn.music.breathing.scale"]=e.musicState.breathingScale.toString(),t["--sn.music.energy.level"]=e.musicState.energy.toString(),t["--sn.music.valence"]=e.musicState.valence.toString()),e.aestheticState&&this.cssConfig.enableAestheticConsciousness&&(t["--sn.aesthetic.harmony.level"]=e.aestheticState.harmonyLevel.toString(),t["--sn.aesthetic.evolution.factor"]=e.aestheticState.evolutionFactor.toString(),t["--sn.color.temperature"]=e.aestheticState.colorTemperature.toString()),e.performanceState&&(t["--sn.performance.mode"]=e.performanceState.mode,t["--sn.device.tier"]=e.performanceState.deviceTier,t["--sn.performance.optimization.level"]=e.performanceState.optimizationLevel.toString()),this.updateVariables(t,"high","consciousness-system"),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Consciousness state updated with ${Object.keys(t).length} variables`)}applyPerformanceOptimizations(e){if(!this.cssConfig.enableAdaptiveOptimization)return;this.currentPerformanceMode=e;let t={"--sn.performance.mode":e.name,"--sn.performance.quality.level":e.qualityLevel.toString(),"--sn.performance.fps.target":e.frameRate.toString(),"--sn.performance.frame.budget":(1e3/e.frameRate).toString(),"--sn.performance.optimization.level":e.optimizationLevel.toString(),"--sn.performance.blur.quality":e.blurQuality.toString(),"--sn.performance.shadow.quality":e.shadowQuality.toString(),"--sn.performance.animation.quality":e.animationQuality.toString(),"--sn.performance.effect.quality":e.effectQuality.toString()};this.updateVariables(t,"high","performance-coordinator"),this.applyPerformanceModeOptimizations(),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Performance optimizations applied for mode: ${e.name}`)}getVariable(e){return getComputedStyle(document.documentElement).getPropertyValue(e).trim()||null}flushUpdates(){this.flushCSSVariableBatch()}flushCSSVariableBatch(){if(this.cssVariableQueue.size===0)return;let e=performance.now(),t=8,i=Array.from(this.cssVariableQueue.values());this.cssVariableQueue.clear(),this.rafHandle!==null&&(cancelAnimationFrame(this.rafHandle),this.rafHandle=null),this.microtaskScheduled=!1;try{let n=new Map;for(let a of i)n.has(a.element)||n.set(a.element,[]),n.get(a.element).push(a);for(let[a,s]of n.entries()){if(performance.now()-e>t){for(let o of s){let l=`${o.element.id||"root"}:${o.property}`;this.cssVariableQueue.set(l,o)}this.scheduleFlush("high");break}if(s.length>=3)this.applyCSSTextBatch(a,s);else for(let o of s)se.nativeSetProperty?se.nativeSetProperty.call(a.style,o.property,o.value):a.style.setProperty(o.property,o.value)}let r=performance.now()-e;this.updatePerformanceMetrics(r,i.length),r>t&&this.config.enableDebug?console.warn(`\u{1F30C} [UnifiedCSSVariableManager] CSS batch exceeded frame budget: ${r.toFixed(2)}ms (${i.length} updates)`):this.config.enableDebug&&Math.random()<.05&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Efficient CSS batch: ${i.length} updates in ${r.toFixed(2)}ms`)}catch(n){console.error("[UnifiedCSSVariableManager] Error in optimized CSS batch processing:",n),this.applyUpdatesWithFallback(i)}}applyCSSTextBatch(e,t){try{let i=e.style.cssText,n=new Map;if(i){let a=i.split(";");for(let s of a){let o=s.indexOf(":");if(o>0){let l=s.slice(0,o).trim(),m=s.slice(o+1).trim();l&&m&&n.set(l,m)}}}for(let a of t)n.set(a.property,a.value);let r=[];for(let[a,s]of n)r.push(`${a}:${s}`);e.style.cssText=r.join(";")}catch{for(let n of t)try{e.style.setProperty(n.property,n.value)}catch(r){console.warn(`Failed to apply ${n.property}:`,r)}}}applyUpdatesWithFallback(e){for(let t of e)try{se.nativeSetProperty?se.nativeSetProperty.call(t.element.style,t.property,t.value):t.element.style.setProperty(t.property,t.value)}catch(i){console.warn(`[UnifiedCSSVariableManager] Failed to apply CSS property ${t.property}:`,i)}}setMusicMetrics(e){let t={};e.beatIntensity!==void 0&&(t["--sn.music.beat.pulse.intensity"]=e.beatIntensity.toString()),e.rhythmPhase!==void 0&&(t["--sn.music.rhythm.phase"]=`${e.rhythmPhase}deg`),e.breathingScale!==void 0&&(t["--sn.music.breathing.scale"]=e.breathingScale.toString()),e.spectrumPhase!==void 0&&(t["--sn.music.spectrum.phase"]=`${e.spectrumPhase}deg`),e.energy!==void 0&&(t["--sn.music.energy.level"]=e.energy.toString()),e.valence!==void 0&&(t["--sn.music.valence"]=e.valence.toString()),e.bpm!==void 0&&(t["--sn.music.tempo.bpm"]=e.bpm.toString()),this.updateVariables(t,"critical","music-system")}setColorTokens(e){let t={};e.accentHex&&(t["--sn.color.accent.hex"]=e.accentHex),e.accentRgb&&(t["--sn.color.accent.rgb"]=e.accentRgb),e.primaryRgb&&(t["--sn.bg.gradient.primary.rgb"]=e.primaryRgb),e.secondaryRgb&&(t["--sn.bg.gradient.secondary.rgb"]=e.secondaryRgb),e.gradientOpacity!==void 0&&(t["--sn.bg.gradient.opacity"]=e.gradientOpacity.toString()),e.gradientBlur&&(t["--sn.bg.gradient.blur"]=e.gradientBlur),this.updateVariables(t,"high","color-system")}setPerformanceTokens(e){let t={};e.webglReady!==void 0&&(t["--sn.bg.webgl.ready"]=e.webglReady?"1":"0"),e.activeBackend&&(t["--sn.bg.active-backend"]=e.activeBackend),e.qualityLevel&&(t["--sn.perf.quality.level"]=e.qualityLevel),e.reducedMotion!==void 0&&(t["--sn.anim.motion.reduced"]=e.reducedMotion?"1":"0"),e.gpuAcceleration!==void 0&&(t["--sn.perf.gpu.acceleration.enabled"]=e.gpuAcceleration?"1":"0"),this.updateVariables(t,"high","performance-system")}setProperty(e,t,i=null){if(e.startsWith("--spice-")&&this.config.enableSpiceVariableDebug){let n=new Error().stack?.split(`
`)[2]?.trim().replace(/^\s*at\s+/,"")||"unknown";console.log(`\u{1F527} [CSS Debug] Setting ${e} = ${t} (from: ${n})`)}this.queueCSSVariableUpdate(e,t,i)}applyDeviceOptimizations(){if(!this.cssConfig.enableDeviceTierOptimization||!this.currentDeviceCapabilities)return;this.removeClassesByPrefix("device-tier-"),this.removeClassesByPrefix("device-mobile-"),this.removeClassesByPrefix("device-gpu-");let e=`device-tier-${this.currentDeviceCapabilities.performanceTier}`;this.addCSSClass(e),this.currentDeviceCapabilities.isMobile&&this.addCSSClass("device-mobile-optimized"),this.currentDeviceCapabilities.gpuAcceleration?this.addCSSClass("device-gpu-accelerated"):this.addCSSClass("device-gpu-fallback");let t=this.getMemoryTier(this.currentDeviceCapabilities.memoryGB);this.addCSSClass(`device-memory-${t}`)}applyPerformanceModeOptimizations(){if(!this.currentPerformanceMode)return;this.removeClassesByPrefix("performance-mode-");let e=`performance-mode-${this.currentPerformanceMode.name}`;this.addCSSClass(e);let t=`optimization-level-${this.currentPerformanceMode.optimizationLevel}`;this.addCSSClass(t)}getPerformanceReport(){let e=this.performanceMetrics.totalBatches>0?this.performanceMetrics.totalBatchTime/this.performanceMetrics.totalBatches:0;return{enabled:!0,pendingUpdates:this.cssVariableQueue.size+this.updateQueue.size,totalUpdates:this.performanceMetrics.totalUpdates,totalBatches:this.performanceMetrics.totalBatches,averageBatchSize:Math.round(this.performanceMetrics.averageBatchSize*10)/10,averageBatchTime:Math.round(e*100)/100,maxBatchTime:Math.round(this.performanceMetrics.maxBatchTime*100)/100,overBudgetBatches:this.performanceMetrics.overBudgetBatches,conflictResolutions:this.performanceMetrics.conflictResolutions,transactionCount:this.performanceMetrics.transactionCount,consciousnessUpdates:this.performanceMetrics.consciousnessUpdates,consciousnessActive:this.consciousnessState!==null,deviceTier:this.currentDeviceCapabilities?.performanceTier,performanceMode:this.currentPerformanceMode?.name}}subscribeToEvents(){this.eventBus.subscribe("performance:tier-changed",e=>{this.currentPerformanceMode=this.performanceCoordinator.getCurrentPerformanceMode(),this.applyPerformanceModeOptimizations(),this.updateCSSPerformanceVariables()},"UnifiedCSSVariableManager"),this.eventBus.subscribe("performance:frame",e=>{e.temperature&&e.temperature>80&&this.applyThermalOptimizations(e.temperature)},"UnifiedCSSVariableManager")}applyInitialOptimizations(){try{this.applyDeviceOptimizations(),this.applyPerformanceModeOptimizations(),this.updateCSSPerformanceVariables(),this.cssConfig.debugPerformanceClasses&&this.addCSSClass("debug-performance")}catch(e){this.config.enableDebug&&console.warn("[UnifiedCSSVariableManager] Error applying initial optimizations:",e)}}applyCurrentOptimizations(){this.applyDeviceOptimizations(),this.applyPerformanceModeOptimizations();let e=this.performanceCoordinator.getBatteryState(),t=this.performanceCoordinator.getThermalState();e&&this.applyBatteryOptimizations(e.level,e.charging);let i=t.temperature||"normal";this.applyThermalOptimizations(i)}updateCSSPerformanceVariables(){let e=Date.now();if(!(e-this.lastCSSUpdate<this.cssUpdateThrottle)&&(this.lastCSSUpdate=e,!(!this.currentPerformanceMode||!this.currentDeviceCapabilities)))try{let t={"--sn.performance.mode":this.currentPerformanceMode.name||"balanced","--sn.performance.quality.level":(this.currentPerformanceMode.qualityLevel??.8).toString(),"--sn.performance.fps.target":(this.currentPerformanceMode.frameRate??60).toString(),"--sn.performance.frame.budget":(1e3/(this.currentPerformanceMode.frameRate??60)).toString(),"--sn.performance.optimization.level":(this.currentPerformanceMode.optimizationLevel??1).toString(),"--sn.device.tier":this.currentDeviceCapabilities.performanceTier??"mid","--sn.device.memory":(this.currentDeviceCapabilities.memoryGB??8).toString(),"--sn.device.gpu":this.currentDeviceCapabilities.gpuAcceleration??!0?"1":"0","--sn.device.mobile":this.currentDeviceCapabilities.isMobile??!1?"1":"0","--sn.performance.blur.quality":(this.currentPerformanceMode.blurQuality??.8).toString(),"--sn.performance.shadow.quality":(this.currentPerformanceMode.shadowQuality??.8).toString(),"--sn.performance.animation.quality":(this.currentPerformanceMode.animationQuality??.8).toString(),"--sn.performance.effect.quality":(this.currentPerformanceMode.effectQuality??.8).toString()};this.updateVariables(t,"high","performance-coordinator")}catch(t){this.config.enableDebug&&console.warn("[UnifiedCSSVariableManager] Error updating CSS performance variables:",t)}}startConsciousnessIntegration(){if(this.consciousnessUpdateTimer)return;let e=()=>{let t=performance.now();t-this.lastConsciousnessUpdate>=this.cssConfig.consciousnessUpdateInterval&&(this.lastConsciousnessUpdate=t,this.consciousnessState&&this.updateConsciousnessVariables(this.consciousnessState)),this.consciousnessUpdateTimer=setTimeout(e,this.cssConfig.consciousnessUpdateInterval)};e()}shouldReplaceUpdate(e,t){let i=this.PRIORITY_WEIGHTS[e.priority],n=this.PRIORITY_WEIGHTS[t.priority];return n>i?!0:n===i?t.timestamp>e.timestamp:!1}scheduleFlush(e){if(this.rafHandle!==null||this.microtaskScheduled)return;let t=()=>{this.rafHandle=null,this.microtaskScheduled=!1,this.flushCSSVariableBatch()};typeof document<"u"&&document.visibilityState==="hidden"?(this.microtaskScheduled=!0,queueMicrotask(t)):typeof requestAnimationFrame=="function"?this.rafHandle=requestAnimationFrame(t):setTimeout(t,0)}updatePerformanceMetrics(e,t){this.performanceMetrics.totalBatches++,this.performanceMetrics.totalBatchTime+=e,this.performanceMetrics.maxBatchTime=Math.max(this.performanceMetrics.maxBatchTime,e),this.performanceMetrics.averageBatchSize=(this.performanceMetrics.averageBatchSize*(this.performanceMetrics.totalBatches-1)+t)/this.performanceMetrics.totalBatches,e>8&&(this.performanceMetrics.overBudgetBatches++,this.config.enableDebug&&console.warn(`[UnifiedCSSVariableManager] CSS batch took ${e.toFixed(2)}ms for ${t} updates`))}enableGlobalHijack(){if(se.hijackEnabled)return;let e=CSSStyleDeclaration.prototype.setProperty;se.nativeSetProperty=e;let t=this;CSSStyleDeclaration.prototype.setProperty=function(i,n,r){i&&(i.startsWith("--sn-")||i.startsWith("--sn."))&&t?t.queueCSSVariableUpdate(i,String(n??"")):e.call(this,i,n,r)},se.hijackEnabled=!0,this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Global setProperty hijack enabled (--sn- and --sn. namespaces)")}addCSSClass(e){this.appliedClasses.has(e)||(document.body.classList.add(e),this.appliedClasses.add(e))}removeCSSClass(e){this.appliedClasses.has(e)&&(document.body.classList.remove(e),this.appliedClasses.delete(e))}removeClassesByPrefix(e){let t=Array.from(this.appliedClasses).filter(i=>i.startsWith(e));for(let i of t)this.removeCSSClass(i)}getMemoryTier(e){return e>=16?"high":e>=8?"medium":e>=4?"low":"minimal"}applyThermalOptimizations(e){if(!this.cssConfig.enableThermalThrottling)return;this.removeClassesByPrefix("thermal-");let t=`thermal-${e}`;this.addCSSClass(t)}applyBatteryOptimizations(e,t){this.cssConfig.enableBatteryOptimization&&(this.removeClassesByPrefix("battery-"),e<.2?this.addCSSClass("battery-low"):e<.5?this.addCSSClass("battery-medium"):this.addCSSClass("battery-high"),t&&this.addCSSClass("battery-charging"))}updateMusicVariables(e){let t={};for(let[i,n]of Object.entries(e))if(n!==void 0){let r=`--sn-music-${i.replace(/\./g,"-")}`;t[r]=String(n)}this.updateVariables(t,"critical","music-system")}updateColorVariables(e){let t={};for(let[i,n]of Object.entries(e))if(n!==void 0){let r=`--sn-color-${i.replace(/\./g,"-")}`;t[r]=String(n)}this.updateVariables(t,"high","color-system")}updateAnimationVariables(e){let t={};for(let[i,n]of Object.entries(e))if(n!==void 0){let r=`--sn-anim-${i.replace(/\./g,"-")}`;t[r]=typeof n=="boolean"?n?"1":"0":String(n)}this.updateVariables(t,"normal","animation-system")}updatePerformanceVariables(e){let t={};for(let[i,n]of Object.entries(e))if(n!==void 0){let r=`--sn-performance-${i.replace(/\./g,"-")}`;t[r]=typeof n=="boolean"?n?"1":"0":String(n)}this.updateVariables(t,"high","performance-system")}updateUtilityVariables(e){let t={};for(let[i,n]of Object.entries(e))if(n!==void 0){let r=`--sn-${i.replace(/\./g,"-")}`;t[r]=typeof n=="boolean"?n?"1":"0":String(n)}this.updateVariables(t,"low","utility-system")}queueUpdate(e,t,i="normal",n="unknown"){this.queueCSSVariableUpdate(e,t,null,i,n)}queueTransaction(e,t="normal",i="unknown"){let n=`tx_${++this.transactionCounter}`,r=new Map(Object.entries(e)),a={id:n,variables:r,timestamp:performance.now(),priority:t,completed:!1};this.pendingTransactions.set(n,a);for(let[s,o]of r)this.queueUpdate(s,o,t,`${i}:${n}`);return this.performanceMetrics.transactionCount++,this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Transaction ${n} queued with ${r.size} variables`),n}forceFlush(){this.flushCSSVariableBatch()}registerVariableGroup(e,t="normal",i=50,n=16){this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Variable group registration: ${e} (handled internally)`)}updateVariableGroup(e,t,i="unknown"){this.updateVariables(t,"normal",`group:${e}:${i}`)}updateConfig(e){this.cssConfig={...this.cssConfig,...e},this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Configuration updated:",e)}flushNow(){this.flushCSSVariableBatch()}setBatchingEnabled(e){this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Batching ${e?"enabled":"disabled"}`)}addCriticalVariable(e){yt.add(e),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Added critical variable: ${e}`)}removeCriticalVariable(e){yt.delete(e),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Removed critical variable: ${e}`)}isCriticalVariable(e){return yt.has(e)}getCriticalVariables(){return Array.from(yt)}updateConsciousnessIntensity(e,t,i){let n=Math.max(0,Math.min(1,e));this.queueCSSVariableUpdate("--consciousness-intensity",n.toString(),null,"high",`consciousness-${t}`),this.eventBus&&this.eventBus.emitSync("consciousness:intensity-changed",{intensity:n,userEngagement:.5,timestamp:Date.now(),sourceStrategy:t,musicEnergy:i??0}),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Consciousness intensity updated by ${t}: ${n}`)}updateCrossfadeOpacity(e,t,i){let n=Math.max(0,Math.min(1,e));i||(n=0),this.queueCSSVariableUpdate("--sn-gradient-crossfade-opacity",n.toString(),null,"high",`crossfade-${t}`),this.eventBus&&this.eventBus.emitSync("gradient:crossfade-changed",{opacity:n,sourceStrategy:t,webglEnabled:i,timestamp:Date.now()}),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Crossfade opacity updated by ${t}: ${n} (WebGL: ${i})`)}subscribeToConsciousnessChanges(e){if(!this.eventBus)return console.warn("[UnifiedCSSVariableManager] No UnifiedEventBus available for consciousness subscriptions"),()=>{};let t=this.eventBus.subscribe("consciousness:intensity-changed",e,"UnifiedCSSVariableManager");return()=>this.eventBus?.unsubscribe(t)}subscribeToCrossfadeChanges(e){if(!this.eventBus)return console.warn("[UnifiedCSSVariableManager] No UnifiedEventBus available for crossfade subscriptions"),()=>{};let t=this.eventBus.subscribe("gradient:crossfade-changed",e,"UnifiedCSSVariableManager");return()=>this.eventBus?.unsubscribe(t)}};se.hijackEnabled=!1;oi=se});function Tn(c){Pn=c}function T(){if(!Pn)throw console.warn("[OptimizedCSSVariableManager] Global instance not initialized yet. This may indicate an initialization order issue."),new Error("Global OptimizedCSSVariableManager not initialized. Call setGlobalOptimizedCSSController() first.");return Pn}var ve,Pn,$=b(()=>{"use strict";ya();ve=class extends oi{constructor(t,i,n={}){super(t,i);this.lastFPSCheck=0;this.currentPerformanceLevel="good";this.adaptiveThrottleLevel=1;this.priorityQueues=new Map;this.optimizedConfig={batchIntervalMs:16,maxBatchSize:50,enableDebug:t.enableDebug,enableAdaptiveThrottling:!0,priorityMappings:{critical:["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift"],high:["--sn-gradient-primary","--sn-gradient-secondary","--sn-gradient-accent"],normal:["--sn-gradient-","--sn-rs-"],low:["--sn-debug-","--sn-dev-"]},thresholds:{excellentFPS:55,goodFPS:45,poorFPS:30},...n},n.performanceAnalyzer&&(this.performanceAnalyzer=n.performanceAnalyzer),n.budgetManager&&(this.budgetManager=n.budgetManager),this.initializePriorityQueues(),this.optimizedConfig.enableAdaptiveThrottling&&this.startAdaptiveMonitoring()}initializePriorityQueues(){this.priorityQueues.set("critical",new Map),this.priorityQueues.set("high",new Map),this.priorityQueues.set("normal",new Map),this.priorityQueues.set("low",new Map)}startAdaptiveMonitoring(){setInterval(()=>{this.updatePerformanceLevel(),this.adjustBatchingStrategy()},1e3)}updatePerformanceLevel(){if(!this.performanceAnalyzer)return;let t=this.performanceAnalyzer.getMedianFPS(),{excellentFPS:i,goodFPS:n,poorFPS:r}=this.optimizedConfig.thresholds,a=this.currentPerformanceLevel;t>=i?this.currentPerformanceLevel="excellent":t>=n?this.currentPerformanceLevel="good":t<r&&(this.currentPerformanceLevel="poor"),a!==this.currentPerformanceLevel&&this.optimizedConfig.enableDebug&&console.log(`\u{1F3A8} [OptimizedCSSVariableManager] Performance level changed: ${a} \u2192 ${this.currentPerformanceLevel} (${t} FPS)`)}adjustBatchingStrategy(){let t,i;switch(this.currentPerformanceLevel){case"excellent":t=Math.max(8,this.optimizedConfig.batchIntervalMs/2),i=Math.min(100,this.optimizedConfig.maxBatchSize*2),this.adaptiveThrottleLevel=.5;break;case"good":t=this.optimizedConfig.batchIntervalMs,i=this.optimizedConfig.maxBatchSize,this.adaptiveThrottleLevel=1;break;case"poor":t=this.optimizedConfig.batchIntervalMs*2,i=Math.max(10,this.optimizedConfig.maxBatchSize/2),this.adaptiveThrottleLevel=2;break}this.updateConfig({batchIntervalMs:t,maxBatchSize:i})}queueCSSVariableUpdate(t,i,n=null,r="normal",a="unknown"){let s=n||document.documentElement,o=r||this.determineVariablePriority(t);if(o==="critical"){this.applyCriticalUpdate(t,i,s);return}let l=this.priorityQueues.get(o);if(l){let m=`${t}:${s.tagName||"ROOT"}`;l.set(m,{property:t,value:i,timestamp:performance.now()})}this.scheduleOptimizedFlush(o)}determineVariablePriority(t){let{priorityMappings:i}=this.optimizedConfig;for(let[n,r]of Object.entries(i))if(r.includes(t))return n;for(let[n,r]of Object.entries(i))for(let a of r)if(t.startsWith(a))return n;return"normal"}applyCriticalUpdate(t,i,n){try{n.style.setProperty(t,i)}catch(r){console.error(`\u{1F3A8} [OptimizedCSSVariableManager] Critical update failed for ${t}:`,r)}}scheduleOptimizedFlush(t){let i=this.getFlushDelay(t);setTimeout(()=>{this.flushPriorityQueue(t)},i)}getFlushDelay(t){let i=this.optimizedConfig.batchIntervalMs,n=this.adaptiveThrottleLevel;switch(t){case"critical":return 0;case"high":return Math.max(4,i*.5*n);case"normal":return i*n;case"low":return i*2*n;default:return i*n}}flushPriorityQueue(t){let i=this.priorityQueues.get(t);if(!i||i.size===0)return;let n=Array.from(i.values());i.clear();for(let r of n)super.queueCSSVariableUpdate(r.property,r.value,null,"normal",r.timestamp.toString())}getOptimizationMetrics(){let t={};for(let[n,r]of this.priorityQueues)t[n]=r.size;let i={performanceLevel:this.currentPerformanceLevel,adaptiveThrottleLevel:this.adaptiveThrottleLevel,queueSizes:t};return i.budgetViolations=[],i}flushAllQueues(){for(let t of["critical","high","normal","low"])this.flushPriorityQueue(t);this.flushUpdates()}updatePriorityMappings(t){this.optimizedConfig.priorityMappings={...this.optimizedConfig.priorityMappings,...t}}async batchSetVariables(t,i,n="normal",r="unknown"){this.updateVariables(i,n,`${t}:${r}`)}async setVariable(t,i,n,r="normal",a="unknown"){this.updateVariables({[i]:n},r,`${t}:${a}`)}applyDirect(t){let i=document.documentElement;for(let[n,r]of Object.entries(t))i.style.setProperty(n,r)}static getGlobalInstance(){return T()}destroy(){for(let t of this.priorityQueues.values())t.clear();this.priorityQueues.clear(),super.destroy()}},Pn=null});var ke,rt,xn=b(()=>{"use strict";$();D();K();ke=class ke{constructor(e={}){this.colorCache=new Map;this.lastCacheUpdate=0;this.initialized=!1;this.eventSubscriptionIds=[];this.lastColorUpdate=0;this.colorUpdateCount=0;this.config={enableDebug:!1,fallbackToSpiceColors:!0,cacheDuration:5e3,...e}}async initialize(e){if(this.initialized){console.warn("[SemanticColorManager] Already initialized, skipping");return}try{this.cssController=e||T(),this.setupEventSubscriptions(),this.initialized=!0,this.lastColorUpdate=Date.now(),this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Initialized as IManagedSystem with",{mappings:ke.SEMANTIC_MAPPINGS.length,batcherAvailable:!!this.cssController,spicetifyAvailable:this.isSpicetifyAvailable(),eventSubscriptions:this.eventSubscriptionIds.length}),p.emitSync("system:initialized",{systemName:"SemanticColorManager",timestamp:Date.now(),metadata:{mappings:ke.SEMANTIC_MAPPINGS.length,spicetifyAvailable:this.isSpicetifyAvailable()}})}catch(t){throw console.error("[SemanticColorManager] Initialization failed:",t),p.emitSync("system:error",{systemName:"SemanticColorManager",error:t instanceof Error?t.message:"Initialization failed",severity:"critical",timestamp:Date.now()}),t}}async updateSemanticColors(){if(!this.initialized){console.warn("[SemanticColorManager] Not initialized, cannot update colors");return}let e=Date.now();if(!(e-this.lastCacheUpdate<(this.config.cacheDuration||5e3))){console.log("\u{1F3A8} [SemanticColorManager] Starting semantic color update...");try{let t={},i={},n={};for(let r of ke.SEMANTIC_MAPPINGS){let a=await this.getSemanticColor(r.semanticColor);t[r.cssVariable]={semanticColor:r.semanticColor,retrievedColor:a,fallbackColor:r.fallbackColor,description:r.description},i[r.cssVariable]=a;let s=ae(a);if(s){let o=r.cssVariable.replace("--spice-","--spice-rgb-");n[o]=`${s.r},${s.g},${s.b}`,t[o]=`${s.r},${s.g},${s.b}`}}this.cssController.batchSetVariables("SemanticColorManager",i,"high","semantic-color-update"),this.cssController.batchSetVariables("SemanticColorManager",n,"high","semantic-rgb-update"),console.log("\u{1F3A8} [SemanticColorManager] Color update complete:",t),this.lastCacheUpdate=e,this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Updated all semantic colors")}catch(t){console.error("[SemanticColorManager] Failed to update semantic colors:",t)}}}async getSemanticColor(e){let t=this.colorCache.get(e);if(t&&Date.now()-this.lastCacheUpdate<(this.config.cacheDuration||5e3))return t;let i;try{this.isSpicetifyAvailable()&&Spicetify.Platform?.getSemanticColors?(i=(await Spicetify.Platform.getSemanticColors())[e],console.log(`\u{1F3A8} [SemanticColorManager] Spicetify returned for ${e}:`,{rawValue:i,type:typeof i,isWhite:i==="#ffffff"||i==="#fff"||i==="white",isInvalid:!i||i==="undefined"||i==="null"})):(console.warn(`\u{1F3A8} [SemanticColorManager] Spicetify not available, using fallback for ${e}`),i=this.getFallbackColor(e))}catch(n){this.config.enableDebug&&console.warn(`[SemanticColorManager] Failed to get semantic color ${e}:`,n),i=this.getFallbackColor(e)}return i=this.validateColor(i,e),this.colorCache.set(e,i),i}validateColor(e,t){let i=e?.toLowerCase().trim();if(!i||["#ffffff","#fff","white","#000000","#000","black","","undefined","null","transparent"].includes(i)){let r=this.getFallbackColor(t);return this.config.enableDebug&&console.warn(`\u{1F527} [SemanticColorManager] Invalid color "${e}" for ${t}, using fallback: ${r}`),r}if(!i.match(/^#[0-9a-f]{6}$/i)&&!i.match(/^#[0-9a-f]{3}$/i)){let r=this.getFallbackColor(t);return this.config.enableDebug&&console.warn(`\u{1F527} [SemanticColorManager] Malformed color "${e}" for ${t}, using fallback: ${r}`),r}return e}getFallbackColor(e){let t=ke.SEMANTIC_MAPPINGS.find(i=>i.semanticColor===e);return t?t.fallbackColor:e.startsWith("text")?"#cad3f5":e.startsWith("background")?"#24273a":e.startsWith("essential")?"#c6a0f6":e.startsWith("decorative")?"#939ab7":"#cad3f5"}applyColorToCSS(e,t,i="normal",n="semantic-color-manager"){this.cssController.setVariable("SemanticColorManager",e,t,i,n)}isSpicetifyAvailable(){return typeof Spicetify<"u"&&Spicetify.Platform&&typeof Spicetify.Platform.getSemanticColors=="function"}flushUpdates(){this.cssController&&this.cssController.flushUpdates()}clearCache(){this.colorCache.clear(),this.lastCacheUpdate=0}updateWithAlbumColors(e){if(!this.initialized){console.warn("[SemanticColorManager] Not initialized, cannot update with album colors");return}try{let t=e.OKLAB_PRIMARY||e.VIBRANT||e.PRIMARY,i=e.OKLAB_ACCENT||e.LIGHT_VIBRANT||e.SECONDARY,n=e.OKLAB_SHADOW||e.DARK_VIBRANT||e.DARK,r=e.OKLAB_HIGHLIGHT||e.VIBRANT_NON_ALARMING||e.LIGHT;if(!t){console.warn("[SemanticColorManager] No primary color found in OKLAB result, skipping update");return}let a=this.generateIntelligentColorDistribution(t,i,n,r),s=this.convertColorsToRgb(a),o={"--spice-accent":a.primary,"--spice-rgb-accent":s.primary,"--spice-surface1":a.surface1,"--spice-rgb-surface1":s.surface1,"--spice-button-active":a.primary,"--spice-rgb-button-active":s.primary,"--spice-highlight":a.highlight,"--spice-rgb-highlight":s.highlight,"--spice-press":a.shadow,"--spice-rgb-press":s.shadow},l={"--spice-surface0":a.surface0,"--spice-rgb-surface0":s.surface0,"--spice-surface2":a.surface2,"--spice-rgb-surface2":s.surface2,"--spice-base":a.base,"--spice-rgb-base":s.base},m={"--spice-main":a.base,"--spice-rgb-main":s.base,"--spice-main-elevated":a.surface0,"--spice-rgb-main-elevated":s.surface0,"--spice-sidebar":a.surface1,"--spice-rgb-sidebar":s.surface1,"--spice-text":this.generateTextColor(a.base),"--spice-rgb-text":this.hexToRgb(this.generateTextColor(a.base)),"--spice-subtext":this.generateSubtextColor(a.base),"--spice-rgb-subtext":this.hexToRgb(this.generateSubtextColor(a.base)),"--spice-highlight-elevated":a.surface2,"--spice-rgb-highlight-elevated":s.surface2,"--spice-overlay0":this.generateOverlayColor(a.base,.04),"--spice-rgb-overlay0":this.hexToRgb(this.generateOverlayColor(a.base,.04)),"--spice-overlay1":this.generateOverlayColor(a.base,.08),"--spice-rgb-overlay1":this.hexToRgb(this.generateOverlayColor(a.base,.08)),"--spice-overlay2":this.generateOverlayColor(a.base,.12),"--spice-rgb-overlay2":this.hexToRgb(this.generateOverlayColor(a.base,.12)),"--spice-crust":this.generateCrustColor(a.base),"--spice-rgb-crust":this.hexToRgb(this.generateCrustColor(a.base)),"--spice-mantle":this.generateMantleColor(a.base),"--spice-rgb-mantle":this.hexToRgb(this.generateMantleColor(a.base))},d={"--spice-blue":a.neuralPrimary,"--spice-rgb-blue":s.neuralPrimary,"--spice-mauve":a.neuralSecondary,"--spice-rgb-mauve":s.neuralSecondary,"--spice-teal":a.neuralTertiary,"--spice-rgb-teal":s.neuralTertiary,"--spice-flamingo":this.generateZoneColor(a.primary,"flamingo"),"--spice-rgb-flamingo":this.hexToRgb(this.generateZoneColor(a.primary,"flamingo")),"--spice-lavender":this.generateZoneColor(a.highlight,"lavender"),"--spice-rgb-lavender":this.hexToRgb(this.generateZoneColor(a.highlight,"lavender")),"--spice-peach":this.generateZoneColor(a.surface2,"peach"),"--spice-rgb-peach":this.hexToRgb(this.generateZoneColor(a.surface2,"peach")),"--spice-rosewater":this.generateZoneColor(a.surface1,"rosewater"),"--spice-rgb-rosewater":this.hexToRgb(this.generateZoneColor(a.surface1,"rosewater")),"--spice-sapphire":this.generateZoneColor(a.neuralPrimary,"sapphire"),"--spice-rgb-sapphire":this.hexToRgb(this.generateZoneColor(a.neuralPrimary,"sapphire"))},h={"--spice-pink":this.generatePaletteColor(a.primary,"pink"),"--spice-rgb-pink":this.hexToRgb(this.generatePaletteColor(a.primary,"pink")),"--spice-sky":this.generatePaletteColor(a.neuralPrimary,"sky"),"--spice-rgb-sky":this.hexToRgb(this.generatePaletteColor(a.neuralPrimary,"sky")),"--spice-red":this.generatePaletteColor(a.highlight,"red"),"--spice-rgb-red":this.hexToRgb(this.generatePaletteColor(a.highlight,"red")),"--spice-maroon":this.generatePaletteColor(a.shadow,"maroon"),"--spice-rgb-maroon":this.hexToRgb(this.generatePaletteColor(a.shadow,"maroon")),"--spice-yellow":this.generatePaletteColor(a.surface2,"yellow"),"--spice-rgb-yellow":this.hexToRgb(this.generatePaletteColor(a.surface2,"yellow")),"--spice-green":this.generatePaletteColor(a.neuralTertiary,"green"),"--spice-rgb-green":this.hexToRgb(this.generatePaletteColor(a.neuralTertiary,"green")),"--spice-misc":a.surface1,"--spice-rgb-misc":s.surface1},g={"--spice-shimmer-primary":a.neuralPrimary,"--spice-rgb-shimmer-primary":s.neuralPrimary,"--spice-shimmer-secondary":a.neuralSecondary,"--spice-rgb-shimmer-secondary":s.neuralSecondary,"--spice-shimmer-tertiary":a.neuralTertiary,"--spice-rgb-shimmer-tertiary":s.neuralTertiary,"--spice-shimmer-quaternary":a.primary,"--spice-rgb-shimmer-quaternary":s.primary,"--spice-particle-glow":a.highlight,"--spice-rgb-particle-glow":s.highlight,"--spice-particle-core":a.primary,"--spice-rgb-particle-core":s.primary,"--spice-particle-trail":a.shadow,"--spice-rgb-particle-trail":s.shadow,"--spice-cinematic-red":this.generateCinematicRed(a.primary),"--spice-rgb-cinematic-red":this.hexToRgb(this.generateCinematicRed(a.primary)),"--spice-cinematic-cyan":this.generateCinematicCyan(a.primary),"--spice-rgb-cinematic-cyan":this.hexToRgb(this.generateCinematicCyan(a.primary)),"--spice-cinematic-yellow":this.generateCinematicYellow(a.highlight),"--spice-rgb-cinematic-yellow":this.hexToRgb(this.generateCinematicYellow(a.highlight)),"--spice-holographic-primary":this.generateHolographicPrimary(a.primary),"--spice-rgb-holographic-primary":this.hexToRgb(this.generateHolographicPrimary(a.primary)),"--spice-holographic-accent":this.generateHolographicAccent(a.neuralPrimary),"--spice-rgb-holographic-accent":this.hexToRgb(this.generateHolographicAccent(a.neuralPrimary)),"--spice-holographic-glow":this.generateHolographicGlow(a.highlight),"--spice-rgb-holographic-glow":this.hexToRgb(this.generateHolographicGlow(a.highlight))},f={...o,...l,...m,...d,...h,...g};this.cssController.batchSetVariables("SemanticColorManager",f,"critical","album-spicetify-update");let v={"--sn-bg-gradient-accent":a.primary,"--sn-bg-gradient-accent-rgb":s.primary,"--sn-bg-gradient-primary":a.primary,"--sn-bg-gradient-primary-rgb":s.primary,"--sn-bg-gradient-secondary":a.surface1,"--sn-bg-gradient-secondary-rgb":s.surface1};this.cssController.batchSetVariables("SemanticColorManager",v,"critical","album-starrynight-update");let C={"--sn-color-accent-hex":a.primary,"--sn-color-accent-rgb":s.primary,"--sn-accent-hex":a.primary,"--sn-accent-rgb":s.primary,"--sn-color-extracted-primary-rgb":s.primary,"--sn-color-extracted-secondary-rgb":s.surface1,"--sn-color-harmony-complementary-rgb":s.shadow,"--sn-color-harmony-analogous-rgb":s.highlight,"--sn-color-harmony-triadic-rgb":s.neuralPrimary};this.cssController.batchSetVariables("SemanticColorManager",C,"critical","album-y3k-integration-update"),this.clearCache(),this.lastColorUpdate=Date.now(),this.colorUpdateCount++;let P=Object.keys(f).length+Object.keys(v).length+Object.keys(C).length;p.emitSync("colors:applied",{cssVariables:{...f,...v,...C},accentHex:a.primary,accentRgb:s.primary,appliedAt:this.lastColorUpdate}),this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Comprehensive Spicetify variable update with OKLAB album colors:",{primaryColor:a.primary,accentColor:a.surface1,shadowColor:a.shadow,highlightColor:a.highlight,surfaceProgression:[a.base,a.surface0,a.surface1,a.surface2],neuralColors:[a.neuralPrimary,a.neuralSecondary,a.neuralTertiary],effectColors:{shimmerColors:4,particleColors:3,cinematicColors:3,holographicColors:3},totalSpicetifyVariablesUpdated:Object.keys(f).length,coreLayoutVariablesUpdated:Object.keys(m).length,starryNightVariablesUpdated:Object.keys(v).length,snColorVariablesUpdated:Object.keys(C).length,effectVariablesAdded:Object.keys(g).length,eventEmitted:!0,totalVariablesUpdated:P})}catch(t){console.error("[SemanticColorManager] Failed to update with album colors:",t)}}generateIntelligentColorDistribution(e,t,i,n){let r=e,a=t||e,s=i||this.generateDarkerVariant(e,.3),o=n||this.generateLighterVariant(e,.2),l=this.generateDarkerVariant(e,.6),m=this.generateDarkerVariant(e,.4),d=a,h=this.generateLighterVariant(a,.15),g=this.generateHueRotatedColor(e,120),f=this.generateHueRotatedColor(e,-60),v=this.generateHueRotatedColor(e,180);return{primary:r,surface0:m,surface1:d,surface2:h,base:l,shadow:s,highlight:o,neuralPrimary:g,neuralSecondary:f,neuralTertiary:v}}convertColorsToRgb(e){let t={};return Object.entries(e).forEach(([i,n])=>{t[i]=this.hexToRgb(n)}),t}generateDarkerVariant(e,t){try{let i=this.hexToRgbObject(e);if(!i)return e;let n=Math.max(0,Math.round(i.r*(1-t))),r=Math.max(0,Math.round(i.g*(1-t))),a=Math.max(0,Math.round(i.b*(1-t)));return this.rgbToHex(n,r,a)}catch(i){return console.warn("[SemanticColorManager] Failed to generate darker variant:",i),e}}generateLighterVariant(e,t){try{let i=this.hexToRgbObject(e);if(!i)return e;let n=Math.min(255,Math.round(i.r+(255-i.r)*t)),r=Math.min(255,Math.round(i.g+(255-i.g)*t)),a=Math.min(255,Math.round(i.b+(255-i.b)*t));return this.rgbToHex(n,r,a)}catch(i){return console.warn("[SemanticColorManager] Failed to generate lighter variant:",i),e}}generateHueRotatedColor(e,t){try{let i=this.hexToRgbObject(e);if(!i)return e;let n=this.rgbToHsl(i.r,i.g,i.b);n.h=(n.h+t)%360,n.h<0&&(n.h+=360);let r=this.hslToRgb(n.h,n.s,n.l);return this.rgbToHex(r.r,r.g,r.b)}catch(i){return console.warn("[SemanticColorManager] Failed to generate hue-rotated color:",i),e}}hexToRgbObject(e){let t=e.replace("#","");if(t.length!==6)return null;let i=parseInt(t.substring(0,2),16),n=parseInt(t.substring(2,4),16),r=parseInt(t.substring(4,6),16);return{r:i,g:n,b:r}}rgbToHex(e,t,i){let n=r=>{let a=Math.round(Math.max(0,Math.min(255,r))).toString(16);return a.length===1?"0"+a:a};return`#${n(e)}${n(t)}${n(i)}`}rgbToHsl(e,t,i){e/=255,t/=255,i/=255;let n=Math.max(e,t,i),r=Math.min(e,t,i),a=0,s=0,o=(n+r)/2;if(n===r)a=s=0;else{let l=n-r;switch(s=o>.5?l/(2-n-r):l/(n+r),n){case e:a=(t-i)/l+(t<i?6:0);break;case t:a=(i-e)/l+2;break;case i:a=(e-t)/l+4;break}a/=6}return{h:a*360,s:s*100,l:o*100}}hslToRgb(e,t,i){e/=360,t/=100,i/=100;let n=(o,l,m)=>(m<0&&(m+=1),m>1&&(m-=1),m<1/6?o+(l-o)*6*m:m<1/2?l:m<2/3?o+(l-o)*(2/3-m)*6:o),r,a,s;if(t===0)r=a=s=i;else{let o=i<.5?i*(1+t):i+t-i*t,l=2*i-o;r=n(l,o,e+1/3),a=n(l,o,e),s=n(l,o,e-1/3)}return{r:Math.round(r*255),g:Math.round(a*255),b:Math.round(s*255)}}hexToRgb(e){let t=e.replace("#",""),i=parseInt(t.substring(0,2),16),n=parseInt(t.substring(2,4),16),r=parseInt(t.substring(4,6),16);return`${i}, ${n}, ${r}`}getColorMappings(){return ke.SEMANTIC_MAPPINGS}generateCinematicRed(e){try{let t=this.hexToRgbObject(e);if(!t)return"#FF0000";let i=Math.min(255,t.r+100),n=Math.max(0,Math.min(t.g*.3,100)),r=Math.max(0,Math.min(t.b*.2,80));return this.rgbToHex(i,n,r)}catch(t){return console.warn("[SemanticColorManager] Failed to generate cinematic red:",t),"#FF0000"}}generateCinematicCyan(e){try{let t=this.hexToRgbObject(e);if(!t)return"#00FFFF";let i=Math.min(255,t.g+120),n=Math.min(255,t.b+140),r=Math.max(0,Math.min(t.r*.2,60));return this.rgbToHex(r,i,n)}catch(t){return console.warn("[SemanticColorManager] Failed to generate cinematic cyan:",t),"#00FFFF"}}generateCinematicYellow(e){try{let t=this.hexToRgbObject(e);if(!t)return"#FFFF00";let i=Math.min(255,t.r+80),n=Math.min(255,t.g+100),r=Math.max(0,Math.min(t.b*.3,120));return this.rgbToHex(i,n,r)}catch(t){return console.warn("[SemanticColorManager] Failed to generate cinematic yellow:",t),"#FFFF00"}}generateHolographicPrimary(e){try{let t=this.hexToRgbObject(e);if(!t)return"#8A2BE2";let i=this.rgbToHsl(t.r,t.g,t.b),n=Math.min(1,i.s+.3),r=Math.min(.8,Math.max(.4,i.l+.1)),a=this.hslToRgb(i.h,n,r);return this.rgbToHex(a.r,a.g,a.b)}catch(t){return console.warn("[SemanticColorManager] Failed to generate holographic primary:",t),"#8A2BE2"}}generateHolographicAccent(e){try{return this.generateHueRotatedColor(e,45)}catch(t){return console.warn("[SemanticColorManager] Failed to generate holographic accent:",t),"#FF00FF"}}generateHolographicGlow(e){try{let t=this.hexToRgbObject(e);if(!t)return"#E0E0FF";let i=.7,n=Math.min(255,t.r+(255-t.r)*i),r=Math.min(255,t.g+(255-t.g)*i),a=Math.min(255,t.b+(255-t.b)*i);return this.rgbToHex(n,r,a)}catch(t){return console.warn("[SemanticColorManager] Failed to generate holographic glow:",t),"#E0E0FF"}}generateTextColor(e){try{let t=this.hexToRgbObject(e);return t&&(.299*t.r+.587*t.g+.114*t.b)/255>.5?"#24273A":"#CAD3F5"}catch(t){return console.warn("[SemanticColorManager] Failed to generate text color:",t),"#CAD3F5"}}generateSubtextColor(e){try{let t=this.hexToRgbObject(e);return t&&(.299*t.r+.587*t.g+.114*t.b)/255>.5?"#5B6078":"#A5ADCB"}catch(t){return console.warn("[SemanticColorManager] Failed to generate subtext color:",t),"#A5ADCB"}}generateOverlayColor(e,t){try{let i=this.hexToRgbObject(e);if(!i)return`rgba(88,91,112,${t})`;if((.299*i.r+.587*i.g+.114*i.b)/255>.5){let r=1-t*2,a=Math.max(0,Math.round(i.r*r)),s=Math.max(0,Math.round(i.g*r)),o=Math.max(0,Math.round(i.b*r));return this.rgbToHex(a,s,o)}else{let r=t*255,a=Math.min(255,Math.round(i.r+r)),s=Math.min(255,Math.round(i.g+r)),o=Math.min(255,Math.round(i.b+r));return this.rgbToHex(a,s,o)}}catch(i){return console.warn("[SemanticColorManager] Failed to generate overlay color:",i),`rgba(88,91,112,${t})`}}generateCrustColor(e){try{let t=this.hexToRgbObject(e);if(!t)return"#232634";if((.299*t.r+.587*t.g+.114*t.b)/255>.5){let n=Math.max(0,Math.round(t.r*.8)),r=Math.max(0,Math.round(t.g*.8)),a=Math.max(0,Math.round(t.b*.8));return this.rgbToHex(n,r,a)}else{let n=Math.min(255,Math.round(t.r+20)),r=Math.min(255,Math.round(t.g+20)),a=Math.min(255,Math.round(t.b+20));return this.rgbToHex(n,r,a)}}catch(t){return console.warn("[SemanticColorManager] Failed to generate crust color:",t),"#232634"}}generateMantleColor(e){try{let t=this.hexToRgbObject(e);if(!t)return"#1e2030";if((.299*t.r+.587*t.g+.114*t.b)/255>.5){let n=Math.max(0,Math.round(t.r*.95)),r=Math.max(0,Math.round(t.g*.95)),a=Math.max(0,Math.round(t.b*.95));return this.rgbToHex(n,r,a)}else{let n=Math.min(255,Math.round(t.r+10)),r=Math.min(255,Math.round(t.g+10)),a=Math.min(255,Math.round(t.b+10));return this.rgbToHex(n,r,a)}}catch(t){return console.warn("[SemanticColorManager] Failed to generate mantle color:",t),"#1e2030"}}generateZoneColor(e,t){try{let i=ae(e);if(!i)return console.warn(`\u{1F527} [SemanticColorManager] Failed to parse RGB from ${e}`),e;let r={flamingo:{rAdjust:20,gAdjust:-10,bAdjust:-5},lavender:{rAdjust:10,gAdjust:-5,bAdjust:15},peach:{rAdjust:25,gAdjust:10,bAdjust:-15},rosewater:{rAdjust:15,gAdjust:-8,bAdjust:0},sapphire:{rAdjust:-20,gAdjust:-10,bAdjust:25}}[t],a=Math.max(0,Math.min(255,i.r+r.rAdjust)),s=Math.max(0,Math.min(255,i.g+r.gAdjust)),o=Math.max(0,Math.min(255,i.b+r.bAdjust)),l=ye(a,s,o);return this.config.enableDebug&&console.log(`\u{1F3A8} [SemanticColorManager] Generated ${t} color: ${e} \u2192 ${l} (RGB: ${i.r},${i.g},${i.b} \u2192 ${a},${s},${o})`),l}catch(i){return console.warn(`\u{1F527} [SemanticColorManager] Failed to generate ${t} color for "${e}":`,i),e}}generatePaletteColor(e,t){try{let i=ae(e);if(!i)return console.warn(`\u{1F527} [SemanticColorManager] Failed to parse RGB from ${e}`),e;let r={pink:{rAdjust:30,gAdjust:-20,bAdjust:-10},sky:{rAdjust:-30,gAdjust:10,bAdjust:30},red:{rAdjust:35,gAdjust:-25,bAdjust:-15},maroon:{rAdjust:25,gAdjust:-15,bAdjust:-10},yellow:{rAdjust:30,gAdjust:25,bAdjust:-30},green:{rAdjust:-25,gAdjust:30,bAdjust:-20}}[t],a=Math.max(0,Math.min(255,i.r+r.rAdjust)),s=Math.max(0,Math.min(255,i.g+r.gAdjust)),o=Math.max(0,Math.min(255,i.b+r.bAdjust)),l=ye(a,s,o);return this.config.enableDebug&&console.log(`\u{1F3A8} [SemanticColorManager] Generated ${t} color: ${e} \u2192 ${l} (RGB: ${i.r},${i.g},${i.b} \u2192 ${a},${s},${o})`),l}catch(i){return console.warn(`\u{1F527} [SemanticColorManager] Failed to generate ${t} color for "${e}":`,i),e}}destroy(){try{this.cleanupEventSubscriptions(),this.clearCache(),this.cssController=null,this.initialized=!1,this.lastColorUpdate=0,this.colorUpdateCount=0,p.emitSync("system:destroyed",{systemName:"SemanticColorManager",timestamp:Date.now(),reason:"Manual destruction"}),this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] System destroyed and cleaned up")}catch(e){console.error("[SemanticColorManager] Error during destruction:",e)}}updateAnimation(e){}async healthCheck(){let e={system:"SemanticColorManager",healthy:!0,details:"SemanticColorManager operational",issues:[],metrics:{initialized:this.initialized,spicetifyAvailable:this.isSpicetifyAvailable(),cssConsciousnessAvailable:!!this.cssController,lastColorUpdate:this.lastColorUpdate,colorUpdateCount:this.colorUpdateCount,eventSubscriptions:this.eventSubscriptionIds.length,cacheSize:this.colorCache.size,lastCacheUpdate:this.lastCacheUpdate}};return this.initialized||(e.healthy=!1,e.issues.push("System not initialized")),this.isSpicetifyAvailable()||(e.healthy=!1,e.issues.push("Spicetify API not available")),this.colorUpdateCount===0&&this.initialized&&e.issues.push("No color updates performed since initialization"),this.eventSubscriptionIds.length===0&&this.initialized&&e.issues.push("No event subscriptions active"),e.issues.length>0&&(e.details=`Issues detected: ${e.issues.join(", ")}`,e.issues.length>=2&&(e.healthy=!1)),e}setupEventSubscriptions(){let e=p.subscribe("music:track-changed",async i=>{this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Track changed, preparing for color refresh:",i.trackUri),this.clearCache()},"SemanticColorManager"),t=p.subscribe("settings:changed",async i=>{(i.settingKey.includes("color")||i.settingKey.includes("theme"))&&(this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Color-related setting changed:",i.settingKey),this.clearCache())},"SemanticColorManager");this.eventSubscriptionIds=[e,t],this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Event subscriptions established:",this.eventSubscriptionIds.length)}cleanupEventSubscriptions(){for(let e of this.eventSubscriptionIds)p.unsubscribe(e);this.eventSubscriptionIds=[],this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Event subscriptions cleaned up")}getSystemMetrics(){return{initialized:this.initialized,lastColorUpdate:this.lastColorUpdate,colorUpdateCount:this.colorUpdateCount,eventSubscriptions:this.eventSubscriptionIds.length,cacheSize:this.colorCache.size,spicetifyAvailable:this.isSpicetifyAvailable()}}};ke.SEMANTIC_MAPPINGS=[{semanticColor:"textBase",cssVariable:"--spice-text",fallbackColor:"#cad3f5",description:"Primary text color"},{semanticColor:"textSubdued",cssVariable:"--spice-subtext",fallbackColor:"#a5adcb",description:"Secondary text color"},{semanticColor:"textBrightAccent",cssVariable:"--spice-accent",fallbackColor:"#c6a0f6",description:"Accent text color"},{semanticColor:"textNegative",cssVariable:"--spice-red",fallbackColor:"#ed8796",description:"Error text color"},{semanticColor:"textWarning",cssVariable:"--spice-yellow",fallbackColor:"#eed49f",description:"Warning text color"},{semanticColor:"textPositive",cssVariable:"--spice-green",fallbackColor:"#a6da95",description:"Success text color"},{semanticColor:"textAnnouncement",cssVariable:"--spice-blue",fallbackColor:"#8aadf4",description:"Info text color"},{semanticColor:"essentialBase",cssVariable:"--spice-button",fallbackColor:"#cad3f5",description:"Primary button color"},{semanticColor:"essentialSubdued",cssVariable:"--spice-button-disabled",fallbackColor:"#6e738d",description:"Disabled button color"},{semanticColor:"essentialBrightAccent",cssVariable:"--spice-button-active",fallbackColor:"#c6a0f6",description:"Active button color"},{semanticColor:"essentialNegative",cssVariable:"--spice-notification-error",fallbackColor:"#ed8796",description:"Error button color"},{semanticColor:"essentialWarning",cssVariable:"--spice-notification-warning",fallbackColor:"#eed49f",description:"Warning button color"},{semanticColor:"essentialPositive",cssVariable:"--spice-notification-success",fallbackColor:"#a6da95",description:"Success button color"},{semanticColor:"backgroundBase",cssVariable:"--spice-main",fallbackColor:"#24273a",description:"Main background color"},{semanticColor:"backgroundHighlight",cssVariable:"--spice-highlight",fallbackColor:"#363a4f",description:"Highlight background color"},{semanticColor:"backgroundPress",cssVariable:"--spice-press",fallbackColor:"#494d64",description:"Press state background color"},{semanticColor:"backgroundElevatedBase",cssVariable:"--spice-card",fallbackColor:"#1e2030",description:"Card background color"},{semanticColor:"backgroundElevatedHighlight",cssVariable:"--spice-card-highlight",fallbackColor:"#363a4f",description:"Card highlight background"},{semanticColor:"backgroundTintedBase",cssVariable:"--spice-sidebar",fallbackColor:"#363a4f",description:"Sidebar background color"},{semanticColor:"backgroundTintedHighlight",cssVariable:"--spice-sidebar-highlight",fallbackColor:"#494d64",description:"Sidebar highlight background"},{semanticColor:"decorativeBase",cssVariable:"--spice-decorative",fallbackColor:"#cad3f5",description:"Decorative element color"},{semanticColor:"decorativeSubdued",cssVariable:"--spice-decorative-subdued",fallbackColor:"#939ab7",description:"Subdued decorative color"}];rt=ke});function va(){try{let e=document.createElement("canvas").getContext("webgl2");if(!e)return!1;let t=e.getExtension("EXT_color_buffer_float")!==null;return!0}catch{return!1}}function rc(c,e){try{let t={alpha:e.alpha??!0,antialias:e.antialias??!0,preserveDrawingBuffer:e.preserveDrawingBuffer??!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1},i=c.getContext("webgl2",t);if(!i)return null;let n=i.getParameter(i.MAX_TEXTURE_SIZE);return{canvas:c,ctx:i,type:"webgl2",capabilities:{supportsGPUAcceleration:!0,supports3D:!0,maxTextureSize:n}}}catch(t){return console.warn("[VisualCanvasFactory] WebGL2 context creation failed:",t),null}}function Sa(c,e){let t={alpha:e.alpha??!0,desynchronized:!0},i=c.getContext("2d",t);return{canvas:c,ctx:i,type:"2d",capabilities:{supportsGPUAcceleration:!1,supports3D:!1}}}async function Ca(c){let e=document.createElement("canvas");e.id=c.id,e.width=c.width??window.innerWidth,e.height=c.height??window.innerHeight;let t=c.fallbackChain??["webgl2","2d"];if(c.preferredType){let i=[c.preferredType,...t.filter(n=>n!==c.preferredType)];t.splice(0,t.length,...i)}for(let i of t){let n=null;switch(i){case"webgl2":va()&&(n=rc(e,c));break;case"2d":n=Sa(e,c);break}if(n)return n}return Sa(e,c)}function Ma(){let c=va(),e="2d";return c&&(e="webgl2"),{webgl2:c,recommendedType:e}}var wa=b(()=>{"use strict"});function Ea(c,e,t={}){let{trace:i}=t;if(!e||typeof e!="object")return i?.("[visualPerformance] No performanceProfiles provided \u2013 skipping selection"),null;let n=e[c];if(n||(i?.(`[visualPerformance] Profile '${c}' not found, falling back to 'balanced'`),n=e.balanced),!n){let r=Object.keys(e)[0];n=e[r],i?.(`[visualPerformance] Using first available profile '${r}' as fallback`)}return n}var Pa=b(()=>{"use strict"});var Q,de=b(()=>{"use strict";U();wa();K();Pa();Q=class{constructor(e=w,t=A,i,n,r){this.canvasCapabilities=null;this.activeCanvasResults=new Map;this.config=e,this.utils=t,this.performanceMonitor=i,this.musicSyncService=n,this.settingsManager=r,this.systemName=this.constructor.name,this.initialized=!1,this.isActive=!1,this.currentPerformanceProfile={},this.metrics={initializationTime:0,updates:0,errors:0},this._resizeHandler=null,this.boundHandleSettingsChange=this.handleSettingsChange.bind(this),this.config.enableDebug&&console.log(`[${this.systemName}] Constructor`)}async initialize(){let e=this.config.enableDebug?performance.now():0;if(this.config.enableDebug&&console.log(`[${this.systemName}] Initializing...`),this.settingsManager){document.addEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange);try{let t=globalThis.year3000System?.deviceCapabilityDetector,i="balanced";t?.isInitialized&&(i=t.recommendPerformanceQuality()),this.config.enableDebug&&console.log(`[${this.systemName}] Auto-selected performance quality '${i}' based on device capability.`),this._applyPerformanceProfile(i)}catch(t){this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Device capability detection failed; defaulting to 'balanced'.`,t),this._applyPerformanceProfile("balanced")}}if(await this._performSystemSpecificInitialization(),this.initialized=!0,this.isActive=!0,this.musicSyncService&&(this._validateDependenciesForSubscription()?(this.musicSyncService.subscribe(this,this.systemName),this.config.enableDebug&&console.log(`[${this.systemName}] Subscribed to MusicSyncService.`)):console.warn(`[${this.systemName}] Dependency validation failed; subscription skipped.`)),this.config.enableDebug){let t=performance.now()-e;console.log(`[${this.systemName}] Initialization complete in ${t.toFixed(2)}ms`)}}async _performSystemSpecificInitialization(){this.canvasCapabilities=Ma(),this.canvasCapabilities&&this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Canvas capabilities detected: WebGL2=${this.canvasCapabilities.webgl2}, Recommended=${this.canvasCapabilities.recommendedType}`)}_validateDependenciesForSubscription(){return typeof this.updateFromMusicAnalysis!="function"?(console.error(`[${this.systemName}] Missing updateFromMusicAnalysis method.`),!1):this.initialized?this._performAdditionalDependencyValidation():(console.warn(`[${this.systemName}] System not initialized.`),!1)}_performAdditionalDependencyValidation(){return!0}destroy(){this.config.enableDebug&&console.log(`[${this.systemName}] Destroying...`);try{this.initialized=!1,this.isActive=!1,this.musicSyncService&&this.musicSyncService.unsubscribe(this.systemName),this.settingsManager&&this.boundHandleSettingsChange&&document.removeEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange),this._resizeHandler&&(window.removeEventListener("resize",this._resizeHandler),this._resizeHandler=null),this._performSystemSpecificCleanup()}catch(e){console.error(`[${this.systemName}] Error during destruction:`,e),this.metrics.errors++}}_performSystemSpecificCleanup(){for(let[e,t]of this.activeCanvasResults){let i=t.canvas;i.parentNode&&i.parentNode.removeChild(i),this.config.enableDebug&&console.log(`[${this.systemName}] Cleaned up canvas: ${e} (type: ${t.type})`)}this.activeCanvasResults.clear()}updateFromMusicAnalysis(e,...t){}onAnimate(e){}updateAnimation(e){this.onAnimate(e)}async healthCheck(){let e=this.initialized&&this.isActive&&this.metrics.errors===0;return{system:this.systemName,healthy:e,metrics:{initialized:this.initialized,active:this.isActive,errors:this.metrics.errors,updates:this.metrics.updates,initializationTime:this.metrics.initializationTime},issues:e?[]:[...this.initialized?[]:["System not initialized"],...this.isActive?[]:["System not active"],...this.metrics.errors===0?[]:[`${this.metrics.errors} errors detected`]]}}updateModeConfiguration(e){}handleSettingsChange(e){}_applyPerformanceProfile(e){if(!this.config?.performanceProfiles){this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Performance profiles not found in config.`);return}let t=Ea(e,this.config.performanceProfiles,{trace:i=>this.performanceMonitor?.emitTrace(i)});t?(this.currentPerformanceProfile=t,this.performanceMonitor?.emitTrace?.(`[BaseVisualSystem (${this.systemName})] Applied performance profile '${e}'`,t)):this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Performance profile '${e}' not found.`)}getCosmicState(){if(typeof document>"u")return{};let e=document.documentElement,t=getComputedStyle(e);return{energy:parseFloat(t.getPropertyValue("--sn-kinetic-energy"))||.5,valence:parseFloat(t.getPropertyValue("--sn-kinetic-valence"))||.5,bpm:parseFloat(t.getPropertyValue("--sn-kinetic-bpm"))||120,tempoMultiplier:parseFloat(t.getPropertyValue("--sn-kinetic-tempo-multiplier"))||1,beatPhase:parseFloat(t.getPropertyValue("--sn-kinetic-beat-phase"))||0,beatPulse:parseFloat(t.getPropertyValue("--sn-kinetic-beat-pulse"))||0}}async _createOptimizedKineticCanvas(e,t=5,i="screen",n="pulse"){let r=document.getElementById(e);r&&r.remove();let a="2d";this.canvasCapabilities&&this.currentPerformanceProfile&&(this.currentPerformanceProfile.quality||"balanced")!=="low"&&this.canvasCapabilities.webgl2&&(a="webgl2");let s=await Ca({id:e,width:window.innerWidth,height:window.innerHeight,alpha:!0,antialias:!0,preferredType:a}),o=s.canvas;o.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: ${t};
      pointer-events: none;
      mix-blend-mode: ${i};
    `,o.classList.add("year3000-kinetic-canvas"),o.dataset.kineticMode=n,o.dataset.systemName=this.systemName,o.dataset.canvasType=s.type;let l=this._getKineticStyles(n);return Object.assign(o.style,l),document.body.appendChild(o),this.activeCanvasResults.set(e,s),this._resizeHandler=()=>{o.width=window.innerWidth,o.height=window.innerHeight,typeof this.handleResize=="function"&&this.handleResize()},window.addEventListener("resize",this._resizeHandler),this._resizeHandler(),this.config.enableDebug&&console.log(`[BaseVisualSystem (${this.systemName})] Created optimized kinetic canvas: ${s.type} (mode: ${n})`),s}getCanvasCapabilities(){return this.canvasCapabilities}hasGPUAcceleration(){return this.canvasCapabilities?.webgl2||!1}_createKineticCanvas(e,t=5,i="screen",n="pulse"){let r=this._createCanvasElement(e,t,i);r.classList.add("year3000-kinetic-canvas"),r.dataset.kineticMode=n,r.dataset.systemName=this.systemName;let a=this._getKineticStyles(n);return Object.assign(r.style,a),this.config.enableDebug&&console.log(`[BaseVisualSystem (${this.systemName})] Created kinetic canvas with mode: ${n}`),r}_getKineticStyles(e){let t={transition:"all 150ms cubic-bezier(0.25, 0.46, 0.45, 0.94)"};switch(e){case"pulse":return{...t,animation:"year3000-pulse calc(var(--sn-kinetic-tempo-multiplier, 1) * 1s) ease-in-out infinite"};case"breathe":return{...t,animation:"year3000-breathe calc(var(--sn-kinetic-tempo-multiplier, 1) * 4s) ease-in-out infinite"};case"flow":return{...t,animation:"year3000-flow calc(var(--sn-kinetic-tempo-multiplier, 1) * 8s) linear infinite"};default:return t}}_createCanvasElement(e,t,i){let n=document.getElementById(e);n&&n.remove();let r=document.createElement("canvas");return r.id=e,r.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: ${t};
      pointer-events: none;
      mix-blend-mode: ${i};
    `,document.body.appendChild(r),this._resizeHandler=()=>{r.width=window.innerWidth,r.height=window.innerHeight,typeof this.handleResize=="function"&&this.handleResize()},window.addEventListener("resize",this._resizeHandler),this._resizeHandler(),r}applyPerformanceSettings(e){this.currentPerformanceProfile=e,e.quality&&typeof this._applyPerformanceProfile=="function"&&this._applyPerformanceProfile?.(e.quality),this.config.enableDebug&&this.performanceMonitor?.emitTrace?.(`[BaseVisualSystem (${this.systemName})] Performance settings applied`,e)}applyUpdatedSettings(e,t){let i=new CustomEvent("year3000SystemSettingsChanged",{detail:{key:e,value:t}});try{this.handleSettingsChange(i)}catch(n){this.config.enableDebug&&console.warn(`[BaseVisualSystem] ${this.systemName} applyUpdatedSettings error`,n)}}forceRepaint(e){this.config.enableDebug&&console.log(`[${this.systemName}] Force repaint requested: ${e||"Unknown reason"}`)}}});var N,ue=b(()=>{"use strict";N=class{constructor(e={}){this.deviceCapabilities=null;this.isInitialized=!1;this.benchmarkCache=new Map;this.detectionStartTime=0;this.config={enableDebug:e.enableDebug||!1,runStressTests:e.runStressTests!==!1,spicetifyContext:e.spicetifyContext||this._detectSpicetifyContext(),...e},this.config.enableDebug&&console.log("\u{1F50D} [DeviceCapabilityDetector] Initialized",this.config.spicetifyContext?"(Spicetify-optimized)":"(Standard)")}_detectSpicetifyContext(){return!!window.Spicetify}async initialize(){if(this.isInitialized)return this.deviceCapabilities;this.detectionStartTime=performance.now(),this.config.enableDebug&&console.log("\u{1F50D} [DeviceCapabilityDetector] Starting enhanced capability detection...",this.config.spicetifyContext?"(Spicetify mode)":"(Standard mode)");let e=await this._analyzeMemoryCapabilities(),t=await this._analyzeCPUCapabilities(),i=await this._analyzeGPUCapabilities();this.deviceCapabilities={memory:e,cpu:t,gpu:i,browser:{supportsOffscreenCanvas:this._detectOffscreenCanvasSupport(),supportsWorkers:this._detectWorkerSupport(),supportsSharedArrayBuffer:this._detectSharedArrayBufferSupport(),supportsWASM:this._detectWASMSupport(),supportsCSSHoudini:this._detectCSSHoudiniSupport()},display:{pixelRatio:window.devicePixelRatio||1,refreshRate:await this._detectRefreshRate(),colorGamut:this._detectColorGamut(),contrastRatio:this._detectContrastCapability(),reducedMotion:this._detectReducedMotion()},network:{effectiveType:navigator.connection?.effectiveType||"unknown",downlink:navigator.connection?.downlink||0,rtt:navigator.connection?.rtt||0,saveData:navigator.connection?.saveData||!1},overall:"detecting",spicetifyProfile:await this._createSpicetifyProfile(e,t,i)},this.config.runStressTests&&(await this._runCapabilityTests(),this.deviceCapabilities.spicetifyProfile=await this._createSpicetifyProfile(this.deviceCapabilities.memory,this.deviceCapabilities.cpu,this.deviceCapabilities.gpu)),this.deviceCapabilities.overall=this._calculateOverallPerformanceLevel(),this.isInitialized=!0;let n=performance.now()-this.detectionStartTime;return this.config.enableDebug&&console.log("\u{1F4CA} [DeviceCapabilityDetector] Enhanced detection completed in",`${n.toFixed(1)}ms`,`
Spicetify Profile:`,this.deviceCapabilities.spicetifyProfile),this.config.enableDebug&&console.log("\u{1F4CA} [DeviceCapabilityDetector] Capabilities detected:",this.deviceCapabilities),this.deviceCapabilities}getSpicetifyProfile(){return this.deviceCapabilities?.spicetifyProfile||null}getRecommendedQualityLevel(){return this.deviceCapabilities?.spicetifyProfile?.recommendedQualityLevel||50}async _analyzeMemoryCapabilities(){let e=navigator.deviceMemory,t=typeof e=="number",i=e||this._estimateMemoryFromOtherSources(),n=performance.memory?.jsHeapSizeLimit||0,r=this._estimateAvailableMemory(),a=this.config.spicetifyContext?this._estimateSpicetifyOverhead():0,s=this._calculateMemoryScore(i,n,r);return{total:i,score:s,level:s>=7?"high":s>=4?"medium":"low",jsHeapSizeLimit:n,estimatedAvailable:r,spicetifyOverhead:a,confidenceLevel:t?.9:.6}}_detectMemoryLevel(){let e=navigator.deviceMemory||6;return e>=8?"high":e>=4?"medium":"low"}_estimateAvailableMemory(){return performance.memory?performance.memory.jsHeapSizeLimit-performance.memory.usedJSHeapSize:(navigator.deviceMemory||4)*1024*1024*1024*.7}async _analyzeCPUCapabilities(){let e=navigator.hardwareConcurrency||4,t=await this._benchmarkSingleThreadPerformance(),i=this._estimateThermalThrottlingRisk(e),n=this._calculateCPUScore(e,t);return{cores:e,score:n,level:n>=7?"high":n>=4?"medium":"low",singleThreadPerformance:t,thermalThrottlingRisk:i,confidenceLevel:e>1?.8:.5}}_detectCPULevel(){let e=navigator.hardwareConcurrency||4;return e>=8?"high":e>=4?"medium":"low"}_detectWebGLSupport(){try{let e=document.createElement("canvas");return!!(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch{return!1}}_detectWebGL2Support(){try{return!!document.createElement("canvas").getContext("webgl2")}catch{return!1}}_getMaxTextureSize(){try{let e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");return t?t.getParameter(t.MAX_TEXTURE_SIZE):0}catch{return 0}}_getGPUVendor(){try{let e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return"unknown";let i=t.getExtension("WEBGL_debug_renderer_info");return i?t.getParameter(i.UNMASKED_VENDOR_WEBGL):"unknown"}catch{return"unknown"}}_getGPURenderer(){try{let e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return"unknown";let i=t.getExtension("WEBGL_debug_renderer_info");return i?t.getParameter(i.UNMASKED_RENDERER_WEBGL):"unknown"}catch{return"unknown"}}async _analyzeGPUCapabilities(){let e=this._detectWebGLSupport(),t=this._detectWebGL2Support(),i=this._getMaxTextureSize(),n=this._getGPUVendor(),r=this._getGPURenderer(),a=await this._benchmarkWebGLCapabilities(),s=this._calculateGPUScore(r,a,t,i);return{supportsWebGL:e,supportsWebGL2:t,maxTextureSize:i,score:s,level:s>=7?"high":s>=4?"medium":"low",vendor:n,renderer:r,webglCapabilityScore:a,confidenceLevel:e?.8:.3}}_detectGPULevel(){let e=this._getGPURenderer().toLowerCase();return/rtx|radeon rx|gtx 16|gtx 20|apple m[1-9]|iris xe/.test(e)?"high":/gtx|radeon|intel iris|intel uhd|vega|ryzen/.test(e)?"medium":"low"}_detectOffscreenCanvasSupport(){return typeof OffscreenCanvas<"u"}_detectWorkerSupport(){return typeof Worker<"u"}_detectSharedArrayBufferSupport(){return typeof SharedArrayBuffer<"u"}_detectWASMSupport(){return typeof WebAssembly<"u"}_detectCSSHoudiniSupport(){return typeof CSS<"u"&&CSS.paintWorklet!==void 0}async _detectRefreshRate(){return new Promise(e=>{let t=performance.now(),i=0,n=[],r=()=>{let a=performance.now(),s=a-t;if(n.push(1e3/s),t=a,i++,i<10)requestAnimationFrame(r);else{let o=n.reduce((l,m)=>l+m,0)/n.length;e(Math.round(o))}};requestAnimationFrame(r)})}_detectColorGamut(){return window.matchMedia("(color-gamut: p3)").matches?"p3":window.matchMedia("(color-gamut: srgb)").matches?"srgb":"limited"}_detectContrastCapability(){return window.matchMedia("(dynamic-range: high)").matches||window.matchMedia("(contrast: high)").matches?"high":"standard"}_detectReducedMotion(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}async _runCapabilityTests(){this.deviceCapabilities&&(this.deviceCapabilities.gpu.stressTestScore=await this._runGPUStressTest(),this.deviceCapabilities.memory.stressTestScore=await this._runMemoryStressTest()),this.config.enableDebug&&console.log("\u26A1 [DeviceCapabilityDetector] Capability tests completed")}async _runGPUStressTest(){return 0}async _runMemoryStressTest(){return 0}_estimateMemoryFromOtherSources(){let e=navigator.hardwareConcurrency||4,t=window.screen,i=4;return e>=8?i=16:e>=6?i=12:e>=4?i=8:e>=2&&(i=6),t.width*t.height>2073600&&(i*=1.5),Math.round(i)}_estimateSpicetifyOverhead(){return this.config.spicetifyContext?.15:0}_calculateMemoryScore(e,t,i){let n=Math.min(e/2,10);if(t>0){let r=t/1073741824;n=Math.max(n,Math.min(r,10))}return this.config.spicetifyContext&&(n*=.85),Math.min(Math.max(n,1),10)}async _benchmarkSingleThreadPerformance(){let e="singleThreadPerf";return this.benchmarkCache.has(e)?this.benchmarkCache.get(e):new Promise(t=>{let i=performance.now(),n=0;for(let s=0;s<5e5;s++)n+=Math.sin(s)*Math.cos(s);let r=performance.now()-i,a=Math.max(1,Math.min(10,50/r));this.benchmarkCache.set(e,a),t(a)})}_estimateThermalThrottlingRisk(e){let t=/Mobi|Android/i.test(navigator.userAgent),i=.1;return e>=8&&(i+=.2),t&&(i+=.3),Math.min(i,1)}_calculateCPUScore(e,t){let i=Math.min(e/2,10),n=.7;return Math.min(i*(1-n)+t*n,10)}async _benchmarkWebGLCapabilities(){let e="webglCapability";if(this.benchmarkCache.has(e))return this.benchmarkCache.get(e);if(!this._detectWebGLSupport())return this.benchmarkCache.set(e,0),0;let t=document.createElement("canvas"),i=t.getContext("webgl2")||t.getContext("webgl");if(!i)return this.benchmarkCache.set(e,0),0;let n=2;i.getExtension("OES_texture_float")&&(n+=1),i.getExtension("WEBGL_depth_texture")&&(n+=1),i.getExtension("OES_element_index_uint")&&(n+=1);let r=i.getParameter(i.MAX_TEXTURE_SIZE);return r>=4096?n+=2:r>=2048&&(n+=1),i.getParameter(i.MAX_VERTEX_ATTRIBS)>=16&&(n+=1),i instanceof WebGL2RenderingContext&&(n+=2),this.benchmarkCache.set(e,Math.min(n,10)),Math.min(n,10)}_calculateGPUScore(e,t,i,n){let r=t,a=e.toLowerCase();return/rtx|radeon rx|apple m[1-9]|arc a/.test(a)?r+=2:/gtx|radeon|vega|iris xe|ryzen/.test(a)?r+=1:/intel|qualcomm|mali|adreno/.test(a)&&(r+=.5),Math.min(Math.max(r,1),10)}async _createSpicetifyProfile(e,t,i){let n=e.score,r=t.score,a=i.score,s=Math.round((n*.3+r*.4+a*.3)*10),o=Math.min(s,100);this.config.spicetifyContext&&(o*=1-e.spicetifyOverhead),o=Math.max(o,20);let l=(e.confidenceLevel+t.confidenceLevel+i.confidenceLevel)/3;return{memoryScore:n,cpuScore:r,gpuScore:a,compositeScore:s,spicetifyOverhead:e.spicetifyOverhead,userQualityPreference:"auto",confidenceLevel:l,recommendedQualityLevel:Math.round(o)}}_calculateOverallPerformanceLevel(){if(!this.deviceCapabilities)return"low";let e=this.deviceCapabilities.spicetifyProfile.compositeScore,t=this.deviceCapabilities.spicetifyProfile.confidenceLevel,i=e*(.7+t*.3);return i>=70?"high":i>=40?"medium":"low"}getCapabilities(){return this.isInitialized?this.deviceCapabilities:(console.warn("[DeviceCapabilityDetector] Not initialized - call initialize() first"),null)}hasWebGLSupport(){return this.isInitialized&&this.deviceCapabilities?this.deviceCapabilities.gpu.supportsWebGL:this._detectWebGLSupport()}hasWebGL2Support(){return this.isInitialized&&this.deviceCapabilities?this.deviceCapabilities.gpu.supportsWebGL2:this._detectWebGL2Support()}destroy(){this.deviceCapabilities=null,this.isInitialized=!1,this.config.enableDebug&&console.log("\u{1F50D} [DeviceCapabilityDetector] Destroyed")}recommendPerformanceQuality(){if(!this.isInitialized||!this.deviceCapabilities)return"balanced";switch(this.deviceCapabilities.overall){case"high":return"high";case"medium":return"balanced";case"low":default:return"low"}}}});var ee,De=b(()=>{"use strict";U();K();fe();ee=class{constructor(e=w,t=be,i=A){this.initialized=!1;this.initialized=!0,e?.enableDebug&&console.log("[SettingsManager] Initialized with new type-safe backend")}forceRepaint(e){typeof document<"u"&&(document.documentElement.style.display="none",document.documentElement.offsetHeight,document.documentElement.style.display="")}async initialize(){this.initialized=!0}async healthCheck(){return{healthy:this.initialized,system:"SettingsManager",details:this.initialized?"Settings manager operational":"Settings manager not initialized"}}updateAnimation(){}destroy(){this.initialized=!1}get(e){try{switch(e){case"artisticMode":return x.get("sn-artistic-mode");case"paletteSystem":return x.get("sn-palette-system");case"gradientIntensity":return x.get("sn-gradient-intensity");case"webglEnabled":return x.get("sn-webgl-enabled");case"animationQuality":return x.get("sn-animation-quality");default:return typeof e=="string"&&e.startsWith("sn-")?x.get(e):void 0}}catch(t){console.warn(`[SettingsManager] Failed to get setting ${String(e)}:`,t);return}}getAllowedValues(e){switch(e){case"artisticMode":return Object.keys(qe);case"paletteSystem":return["catppuccin","year3000"];case"gradientIntensity":return["disabled","minimal","balanced","intense"];case"webglEnabled":return[!0,!1];case"animationQuality":return["auto","low","high"];default:return}}set(e,t){try{switch(e){case"artisticMode":return x.set("sn-artistic-mode",t);case"paletteSystem":return x.set("sn-palette-system",t);case"gradientIntensity":return x.set("sn-gradient-intensity",t);case"webglEnabled":return x.set("sn-webgl-enabled",!!t);case"animationQuality":return x.set("sn-animation-quality",t);default:return typeof e=="string"&&e.startsWith("sn-")?x.set(e,t):(console.warn(`[SettingsManager] Unknown setting key: ${String(e)}`),!1)}}catch(i){return console.warn(`[SettingsManager] Failed to set setting ${String(e)}:`,i),!1}}getAllSettings(){return{artisticMode:this.get("artisticMode")||"artist-vision",paletteSystem:this.get("paletteSystem")||"catppuccin",gradientIntensity:this.get("gradientIntensity")||"balanced",webglEnabled:this.get("webglEnabled")??!0,animationQuality:this.get("animationQuality")||"auto"}}validateAndRepair(){console.log("[SettingsManager] Settings validation handled by typed system")}resetAllToDefaults(){try{x.set("sn-artistic-mode","artist-vision"),x.set("sn-palette-system","catppuccin"),x.set("sn-gradient-intensity","balanced"),x.set("sn-webgl-enabled",!0),x.set("sn-animation-quality","auto"),console.log("[SettingsManager] Reset all settings to defaults")}catch(e){console.warn("[SettingsManager] Failed to reset settings:",e)}}getCurrentHarmonicMode(){let e=x.get("sn-artistic-mode")||"artist-vision",i={"artist-vision":"analogous-flow","cosmic-maximum":"triadic-balance","corporate-safe":"monochromatic-smooth"}[String(e)]||"analogous-flow";return be[i]||be["analogous-flow"]}getHarmonicMode(e){return be[e]}}});var ci,Ta=b(()=>{"use strict";U();$();ue();R();fe();K();ci=class{constructor(){this.utils=A;this.config=w;this.cssController=null;this.depthState={containerElement:null,backgroundContainer:null,depthLayers:new Map,animationFrameId:null,lastAnimationTime:0,scrollY:0,scrollX:0,lastUpdateTime:0,isInitialized:!1,stylesInjected:!1};this.depthSettings={enabled:!0,layerCount:6,maxDepth:1e3,parallaxStrength:.5,depthFogIntensity:.7,infiniteScrolling:!0,qualityLevel:"medium",performanceMode:!1,musicResponsiveness:1};this.performanceMetrics={totalLayers:0,visibleLayers:0,averageDepth:0,parallaxRange:0,renderTime:0,memoryUsage:0};this.layerTemplates={cosmic:{animation:"cosmic-drift",duration:"120s",baseGradient:"radial-gradient(ellipse at center, {primary} 0%, {secondary} 50%, {base} 100%)"},nebula:{animation:"nebula-flow",duration:"180s",baseGradient:"conic-gradient(from 45deg, {primary} 0%, {secondary} 25%, {tertiary} 50%, {quaternary} 75%, {primary} 100%)"},stellar:{animation:"stellar-motion",duration:"240s",baseGradient:"linear-gradient(45deg, {primary} 0%, {secondary} 25%, {tertiary} 50%, {quaternary} 75%, {primary} 100%)"},quantum:{animation:"quantum-field",duration:"300s",baseGradient:"radial-gradient(circle at 30% 70%, {primary} 0%, transparent 50%), radial-gradient(circle at 70% 30%, {secondary} 0%, transparent 50%)"},dimensional:{animation:"dimensional-shift",duration:"360s",baseGradient:"linear-gradient(135deg, {primary} 0%, {secondary} 20%, {tertiary} 40%, {quaternary} 60%, {primary} 80%, {secondary} 100%)"},void:{animation:"void-expansion",duration:"480s",baseGradient:"radial-gradient(ellipse at center, {base} 0%, {secondary} 30%, {primary} 60%, transparent 100%)"}};this.boundScrollHandler=null;this.boundResizeHandler=null;this.deviceDetector=new N,this.cssController=T(),this.loadDepthSettings(),this.adaptToDeviceCapabilities(),this.boundScrollHandler=this.handleScroll.bind(this),this.boundResizeHandler=this.handleResize.bind(this),u?.debug?.log("DepthLayeredStrategy","Depth layered strategy initialized",{layerCount:this.depthSettings.layerCount,qualityLevel:this.depthSettings.qualityLevel,deviceCapability:this.deviceDetector.recommendPerformanceQuality()})}getStrategyName(){return"depth-layered"}canProcess(e){return this.depthSettings.enabled}getEstimatedProcessingTime(e){let i=this.depthSettings.layerCount/6,n=this.depthSettings.qualityLevel==="high"?1.3:this.depthSettings.qualityLevel==="low"?.7:1;return Math.round(15*i*n)}async processColors(e){let t=performance.now();try{this.depthState.isInitialized||await this.initializeDepthSystem();let i=this.extractDepthColors(e.rawColors);await this.updateDepthLayers(i),this.depthState.animationFrameId||this.startDepthAnimation(),e.musicData?.energy!==void 0&&this.updateDepthWithMusicEnergy(e.musicData.energy),this.depthState.lastUpdateTime=Date.now(),this.updatePerformanceMetrics();let n=performance.now()-t,r={processedColors:{depthLayers:this.depthState.depthLayers.size.toString(),depthEnabled:this.depthSettings.enabled.toString(),qualityLevel:this.depthSettings.qualityLevel,...e.rawColors},accentHex:this.selectPrimaryColor(e.rawColors)||"#cba6f7",accentRgb:this.convertToRgbString(this.selectPrimaryColor(e.rawColors)||"#cba6f7"),metadata:{strategy:this.getStrategyName(),processingTime:n,cacheKey:`depth-layered-${e.trackUri}`,harmonicIntensity:this.depthSettings.parallaxStrength,layerCount:this.depthState.depthLayers.size},context:e};return u?.debug?.log("DepthLayeredStrategy","Depth layered processing completed",{layerCount:this.depthState.depthLayers.size,processingTime:n,trackUri:e.trackUri}),r}catch(i){let n=performance.now()-t;return u?.debug?.error("DepthLayeredStrategy","Depth layered processing failed:",i),{processedColors:e.rawColors,accentHex:this.selectPrimaryColor(e.rawColors)||"#cba6f7",accentRgb:this.convertToRgbString(this.selectPrimaryColor(e.rawColors)||"#cba6f7"),metadata:{strategy:this.getStrategyName(),processingTime:n,error:i instanceof Error?i.message:"Unknown error"},context:e}}}loadDepthSettings(){try{let e=x.get("sn-gradient-intensity");if(e){let i=e==="intense"?"high":e==="balanced"?"medium":e==="minimal"?"low":"medium";this.depthSettings.qualityLevel=i,this.adjustQualitySettings()}let t=e!=="disabled";t!==void 0&&(this.depthSettings.enabled=t)}catch(e){u?.debug?.warn("DepthLayeredStrategy","Failed to load settings:",e)}}adaptToDeviceCapabilities(){switch(this.deviceDetector.recommendPerformanceQuality()){case"low":this.depthSettings.qualityLevel="low",this.depthSettings.layerCount=3,this.depthSettings.performanceMode=!0,this.depthSettings.parallaxStrength=.3,this.depthSettings.depthFogIntensity=.5;break;case"balanced":this.depthSettings.qualityLevel="medium",this.depthSettings.layerCount=6,this.depthSettings.performanceMode=!1,this.depthSettings.parallaxStrength=.5,this.depthSettings.depthFogIntensity=.7;break;case"high":this.depthSettings.qualityLevel="high",this.depthSettings.layerCount=9,this.depthSettings.performanceMode=!1,this.depthSettings.parallaxStrength=.8,this.depthSettings.depthFogIntensity=.9;break}}adjustQualitySettings(){switch(this.depthSettings.qualityLevel){case"low":this.depthSettings.layerCount=3,this.depthSettings.parallaxStrength=.3,this.depthSettings.depthFogIntensity=.5;break;case"medium":this.depthSettings.layerCount=6,this.depthSettings.parallaxStrength=.5,this.depthSettings.depthFogIntensity=.7;break;case"high":this.depthSettings.layerCount=9,this.depthSettings.parallaxStrength=.8,this.depthSettings.depthFogIntensity=.9;break}}async initializeDepthSystem(){this.createContainerElements(),this.injectDepthAnimations(),this.setupEventListeners(),this.depthState.isInitialized=!0,u?.debug?.log("DepthLayeredStrategy","Depth system initialized successfully")}createContainerElements(){this.depthState.containerElement=document.querySelector(".Root__main-view")||document.querySelector(".main-view-container")||document.body,this.depthState.backgroundContainer=document.createElement("div"),this.depthState.backgroundContainer.className="sn-depth-background-container",this.depthState.backgroundContainer.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -20;
      pointer-events: none;
      overflow: hidden;
      perspective: 1000px;
      transform-style: preserve-3d;
    `,this.depthState.containerElement.insertBefore(this.depthState.backgroundContainer,this.depthState.containerElement.firstChild)}injectDepthAnimations(){if(this.depthState.stylesInjected)return;let e=document.createElement("style");e.textContent=`
      .sn-depth-layer {
        position: absolute;
        width: 120%;
        height: 120%;
        top: -10%;
        left: -10%;
        pointer-events: none;
        transform-style: preserve-3d;
        will-change: transform, opacity;
      }

      @keyframes cosmic-drift {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        25% { transform: translate3d(-2%, 1%, 0) rotate(0.5deg) scale(1.02); }
        50% { transform: translate3d(0, -1%, 0) rotate(0deg) scale(0.98); }
        75% { transform: translate3d(2%, 0.5%, 0) rotate(-0.5deg) scale(1.01); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes nebula-flow {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        33% { transform: translate3d(1%, -1%, 0) rotate(1deg) scale(1.03); }
        66% { transform: translate3d(-1%, 1%, 0) rotate(-1deg) scale(0.97); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes stellar-motion {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        20% { transform: translate3d(-1%, 0.5%, 0) rotate(0.3deg) scale(1.01); }
        40% { transform: translate3d(0.5%, -0.5%, 0) rotate(-0.3deg) scale(0.99); }
        60% { transform: translate3d(1%, 0.5%, 0) rotate(0.2deg) scale(1.02); }
        80% { transform: translate3d(-0.5%, 1%, 0) rotate(-0.2deg) scale(0.98); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes quantum-field {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); filter: blur(0px); }
        25% { transform: translate3d(0.5%, -0.5%, 0) rotate(0.1deg) scale(1.01); filter: blur(0.5px); }
        50% { transform: translate3d(-0.5%, 0.5%, 0) rotate(-0.1deg) scale(0.99); filter: blur(1px); }
        75% { transform: translate3d(0.3%, 0.3%, 0) rotate(0.05deg) scale(1.005); filter: blur(0.3px); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); filter: blur(0px); }
      }

      @keyframes dimensional-shift {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        16% { transform: translate3d(0.2%, -0.2%, 0) rotate(0.1deg) scale(1.005); }
        32% { transform: translate3d(-0.2%, 0.2%, 0) rotate(-0.1deg) scale(0.995); }
        48% { transform: translate3d(0.1%, 0.1%, 0) rotate(0.05deg) scale(1.002); }
        64% { transform: translate3d(-0.1%, -0.1%, 0) rotate(-0.05deg) scale(0.998); }
        80% { transform: translate3d(0.15%, 0%, 0) rotate(0.02deg) scale(1.001); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes void-expansion {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.9; }
        50% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1.1); opacity: 0.6; }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.9; }
      }

      @media (prefers-reduced-motion: reduce) {
        .sn-depth-layer {
          animation: none !important;
        }
      }
    `,document.head.appendChild(e),this.depthState.stylesInjected=!0}setupEventListeners(){this.boundScrollHandler&&window.addEventListener("scroll",this.boundScrollHandler,{passive:!0}),this.boundResizeHandler&&window.addEventListener("resize",this.boundResizeHandler,{passive:!0})}extractDepthColors(e){let t=["PRIMARY","VIBRANT","LIGHT_VIBRANT","DARK_VIBRANT","VIBRANT_NON_ALARMING","PROMINENT","SECONDARY","DESATURATED"],i=[],n=new Set;for(let r of t){let a=e[r];if(a&&!n.has(a)&&this.utils.hexToRgb(a)&&(i.push(a),n.add(a),i.length>=this.depthSettings.layerCount))break}for(;i.length<this.depthSettings.layerCount;){let r=i[0]||"#cba6f7",a=this.createColorVariation(r,i.length);i.push(a)}return i}createColorVariation(e,t){let i=this.utils.hexToRgb(e);if(!i)return e;let n=.8-t*.1,r=Math.round(i.r*n),a=Math.round(i.g*n),s=Math.round(i.b*n);return this.utils.rgbToHex(r,a,s)}async updateDepthLayers(e){if(!this.depthState.backgroundContainer)return;this.depthState.depthLayers.forEach(i=>{i.element.parentNode&&i.element.parentNode.removeChild(i.element)}),this.depthState.depthLayers.clear();let t=Object.keys(this.layerTemplates);for(let i=0;i<this.depthSettings.layerCount;i++){let n=(i+1)*(this.depthSettings.maxDepth/this.depthSettings.layerCount),r=t[i%t.length],a=this.layerTemplates[r],s=document.createElement("div");s.className="sn-depth-layer",s.id=`sn-depth-layer-${i}`;let o=n/this.depthSettings.maxDepth,l=1-o*this.depthSettings.parallaxStrength,m=1-o*this.depthSettings.depthFogIntensity,d=1+o*.2,h=o*3,g=this.createDepthGradient(a.baseGradient,e,i);s.style.cssText=`
        background: ${g};
        transform: translate3d(0, 0, ${-n}px) scale(${d});
        opacity: ${m};
        filter: blur(${h}px);
        animation: ${a.animation} ${a.duration} ease-in-out infinite;
        animation-delay: ${i*.5}s;
      `;let f={id:`depth-layer-${i}`,element:s,depth:n,parallaxFactor:l,opacityRange:[m*.5,m],scaleRange:[d*.95,d*1.05],rotationSpeed:.01+i*.001,colorShift:i*30,blurAmount:h,animationPhase:i*Math.PI/4,enabled:!0,gradientColors:e.slice(i,i+4)};this.depthState.depthLayers.set(f.id,f),this.depthState.backgroundContainer.appendChild(s)}u?.debug?.log("DepthLayeredStrategy",`Updated ${this.depthState.depthLayers.size} depth layers with new colors`)}createDepthGradient(e,t,i){let n=t.length,r=i%n,a=(i+1)%n,s=(i+2)%n,o=(i+3)%n,m=.8-i/this.depthSettings.layerCount*.6,d=this.convertToRgba(t[r]||"#cba6f7",m),h=this.convertToRgba(t[a]||"#f5c2e7",m*.7),g=this.convertToRgba(t[s]||"#fab387",m*.5),f=this.convertToRgba(t[o]||"#a6e3a1",m*.3),v=this.convertToRgba("#1e1e2e",m*.9);return e.replace(/\{primary\}/g,d).replace(/\{secondary\}/g,h).replace(/\{tertiary\}/g,g).replace(/\{quaternary\}/g,f).replace(/\{base\}/g,v)}convertToRgba(e,t){let i=this.utils.hexToRgb(e);return i?`rgba(${i.r}, ${i.g}, ${i.b}, ${t})`:`rgba(203, 166, 247, ${t})`}startDepthAnimation(){this.depthState.lastAnimationTime=performance.now();let e=()=>{if(!this.depthState.isInitialized)return;let t=performance.now(),i=t-this.depthState.lastAnimationTime;if(i<33){this.depthState.animationFrameId=requestAnimationFrame(e);return}this.depthState.lastAnimationTime=t,this.updateDepthAnimations(i),this.updatePerformanceMetrics(),this.depthState.animationFrameId=requestAnimationFrame(e)};this.depthState.animationFrameId=requestAnimationFrame(e)}updateDepthAnimations(e){this.depthState.depthLayers.forEach(t=>{t.animationPhase+=t.rotationSpeed*e*.001;let i=Math.sin(t.animationPhase)*.05,r=parseFloat(t.element.style.opacity)+i;t.element.style.opacity=Math.max(0,Math.min(1,r)).toString()})}updateDepthWithMusicEnergy(e){let t=e*this.depthSettings.musicResponsiveness*.3;this.depthState.depthLayers.forEach(i=>{let n=i.opacityRange[0],r=i.opacityRange[1],a=n+t*(r-n);i.element.style.opacity=Math.max(0,Math.min(1,a)).toString()})}handleScroll(e){this.depthSettings.infiniteScrolling&&(this.depthState.scrollY=window.scrollY,this.depthState.scrollX=window.scrollX,this.updateParallaxEffects())}handleResize(e){this.updateLayerDimensions()}updateParallaxEffects(){this.depthState.depthLayers.forEach(e=>{let t=this.depthState.scrollY*e.parallaxFactor,i=this.depthState.scrollX*e.parallaxFactor*.5,r=e.element.style.transform.replace(/translate3d\([^)]*\)/,`translate3d(${i}px, ${t}px, ${-e.depth}px)`);e.element.style.transform=r})}updateLayerDimensions(){this.depthState.depthLayers.forEach(e=>{let i=1+e.depth/this.depthSettings.maxDepth*.2,r=e.element.style.transform.replace(/scale\([^)]*\)/,`scale(${i})`);e.element.style.transform=r})}updatePerformanceMetrics(){this.performanceMetrics.totalLayers=this.depthState.depthLayers.size,this.performanceMetrics.visibleLayers=Array.from(this.depthState.depthLayers.values()).filter(e=>parseFloat(e.element.style.opacity)>.01).length,this.performanceMetrics.averageDepth=Array.from(this.depthState.depthLayers.values()).reduce((e,t)=>e+t.depth,0)/this.depthState.depthLayers.size,this.performanceMetrics.parallaxRange=this.depthSettings.parallaxStrength,this.performanceMetrics.renderTime=performance.now()-this.depthState.lastAnimationTime,this.cssController&&(this.cssController.queueCSSVariableUpdate("--sn-depth-layers-total",this.performanceMetrics.totalLayers.toString()),this.cssController.queueCSSVariableUpdate("--sn-depth-layers-visible",this.performanceMetrics.visibleLayers.toString()))}selectPrimaryColor(e){let t=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let i of t){let n=e[i];if(n&&this.utils.hexToRgb(n))return n}return null}convertToRgbString(e){let t=this.utils.hexToRgb(e);return t?`${t.r},${t.g},${t.b}`:"203,166,247"}updateConfig(e){this.depthSettings={...this.depthSettings,...e},e.qualityLevel&&this.adjustQualitySettings(),u?.debug?.log("DepthLayeredStrategy","Configuration updated:",e)}async healthCheck(){let e=Date.now()-this.depthState.lastUpdateTime<3e4;return{healthy:this.depthState.isInitialized&&this.depthSettings.enabled,canProcess:this.canProcess({}),issues:this.depthState.isInitialized?this.depthSettings.enabled?[]:["Depth layers disabled in settings"]:["Depth system not initialized"],metrics:{isInitialized:this.depthState.isInitialized,depthEnabled:this.depthSettings.enabled,layerCount:this.depthState.depthLayers.size,qualityLevel:this.depthSettings.qualityLevel,parallaxStrength:this.depthSettings.parallaxStrength,hasRecentUpdate:e,animationActive:this.depthState.animationFrameId!==null,performanceMetrics:this.performanceMetrics}}}destroy(){this.depthState.animationFrameId&&(cancelAnimationFrame(this.depthState.animationFrameId),this.depthState.animationFrameId=null),this.boundScrollHandler&&(window.removeEventListener("scroll",this.boundScrollHandler),this.boundScrollHandler=null),this.boundResizeHandler&&(window.removeEventListener("resize",this.boundResizeHandler),this.boundResizeHandler=null),this.depthState.depthLayers.forEach(e=>{e.element.parentNode&&e.element.parentNode.removeChild(e.element)}),this.depthState.depthLayers.clear(),this.depthState.backgroundContainer&&this.depthState.backgroundContainer.parentNode&&(this.depthState.backgroundContainer.parentNode.removeChild(this.depthState.backgroundContainer),this.depthState.backgroundContainer=null),this.depthState.isInitialized=!1,this.depthState.containerElement=null,u?.debug?.log("DepthLayeredStrategy","Depth layered strategy destroyed")}}});var li,xa=b(()=>{"use strict";U();$();R();fe();ne();bt();K();li=class{constructor(e){this.utils=A;this.config=w;this.dynamicColorState=this.getInitialColorState();this.integrationConfig={accentUpdateEnabled:!0,baseTransformationEnabled:!0,consciousnessIntegrationEnabled:!0,oklabEnhancementEnabled:!0,smoothTransitionDuration:800,energyResponseMultiplier:1.2,oklabPreset:"VIBRANT"};this.transitionTimer=0;this.lastTransitionStartTime=0;this.transitionFromAccent="";this.transitionToAccent="";this.cssController=e||T(),this.oklabProcessor=new M(this.config.enableDebug),this.initializeCurrentState(),u?.debug?.log("DynamicCatppuccinStrategy","Color strategy initialized with CSS coordinator and OKLAB processing")}getInitialColorState(){try{let e=j.getDefaultAccentColor(),t=j.getBrightnessAdjustedBaseColor();return{currentAccentHex:e.hex,currentAccentRgb:e.rgb,baseBackgroundHex:t.hex,baseBackgroundRgb:t.rgb,lastUpdateTime:0,musicEnergy:.5,transitionInProgress:!1}}catch(e){return console.warn("[DynamicCatppuccinStrategy] Failed to get initial colors, using fallback:",e),{currentAccentHex:"#7c3aed",currentAccentRgb:"124,58,237",baseBackgroundHex:"#0d1117",baseBackgroundRgb:"13,17,23",lastUpdateTime:0,musicEnergy:.5,transitionInProgress:!1}}}getStrategyName(){return"dynamic-catppuccin"}canProcess(e){return this.checkDynamicAccentEnabled()}getEstimatedProcessingTime(e){return 5}async processColors(e){let t=performance.now();try{let i=this.selectBestAccentColor(e.rawColors);if(!i)throw new Error("No suitable accent color found in extracted colors");let n=i,r=this.utils.hexToRgb(i),a=null;if(this.integrationConfig.oklabEnhancementEnabled){let l=M.getPreset(this.integrationConfig.oklabPreset);a=this.oklabProcessor.processColor(i,l),n=a.enhancedHex,r=a.enhancedRgb,u?.debug?.log("DynamicCatppuccinStrategy","OKLAB color enhancement applied:",{original:i,enhanced:n,preset:l.name,processingTime:`${a.processingTime.toFixed(2)}ms`})}await this.applyColorFacade(n,e.rawColors,a),this.dynamicColorState.currentAccentHex=n,r&&(this.dynamicColorState.currentAccentRgb=`${r.r},${r.g},${r.b}`),this.dynamicColorState.lastUpdateTime=Date.now(),e.musicData?.energy!==void 0&&(this.dynamicColorState.musicEnergy=e.musicData.energy,await this.updateConsciousnessWithMusicEnergy(e.musicData.energy));let s=performance.now()-t,o={processedColors:{accent:n,primary:n,originalAccent:i,...e.rawColors},accentHex:n,accentRgb:this.dynamicColorState.currentAccentRgb,metadata:{strategy:this.getStrategyName(),processingTime:s,cacheKey:`dynamic-catppuccin-${e.trackUri}`,harmonicIntensity:this.integrationConfig.energyResponseMultiplier,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,oklabPreset:this.integrationConfig.oklabPreset,...a&&{oklabMetadata:{originalHex:a.originalHex,enhancedHex:a.enhancedHex,shadowHex:a.shadowHex,oklabProcessingTime:a.processingTime}}},context:e};return u?.debug?.log("DynamicCatppuccinStrategy","Color processing completed",{originalAccent:i,processedAccent:n,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,processingTime:s,trackUri:e.trackUri}),o}catch(i){let n=performance.now()-t;return u?.debug?.error("DynamicCatppuccinStrategy","Color processing failed:",i),{processedColors:e.rawColors,accentHex:this.dynamicColorState.currentAccentHex,accentRgb:this.dynamicColorState.currentAccentRgb,metadata:{strategy:this.getStrategyName(),processingTime:n,error:i instanceof Error?i.message:"Unknown error"},context:e}}}checkDynamicAccentEnabled(){try{let e=x.get("catppuccin-accentColor"),t=String(e)==="dynamic";return this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinStrategy",`Accent setting: ${e}, Dynamic: ${t}`),t}catch(e){return u?.debug?.error("DynamicCatppuccinStrategy","Error checking dynamic accent setting:",e),!1}}initializeCurrentState(){let e=document.documentElement,t=getComputedStyle(e),i=t.getPropertyValue("--spice-accent").trim()||t.getPropertyValue("--sn-color-accent-hex").trim();if(i){this.dynamicColorState.currentAccentHex=i;let a=this.utils.hexToRgb(i);a&&(this.dynamicColorState.currentAccentRgb=`${a.r},${a.g},${a.b}`)}let n=t.getPropertyValue("--spice-base").trim()||"#1e1e2e";this.dynamicColorState.baseBackgroundHex=n;let r=this.utils.hexToRgb(n);r&&(this.dynamicColorState.baseBackgroundRgb=`${r.r},${r.g},${r.b}`),this.dynamicColorState.lastUpdateTime=Date.now(),u?.debug?.log("DynamicCatppuccinStrategy","Current state initialized:",{accent:this.dynamicColorState.currentAccentHex,base:this.dynamicColorState.baseBackgroundHex})}selectBestAccentColor(e){let t=["VIBRANT_NON_ALARMING","VIBRANT","LIGHT_VIBRANT","PROMINENT","PRIMARY","DARK_VIBRANT"];for(let i of t){let n=e[i];if(n&&this.utils.hexToRgb(n))return n}return null}async applyColorFacade(e,t,i){let n=this.utils.hexToRgb(e);if(!n)return;let r=`${n.r},${n.g},${n.b}`,a={"--sn-dynamic-accent-hex":e,"--sn-dynamic-accent-rgb":r,"--sn-dynamic-primary-hex":e,"--sn-dynamic-primary-rgb":r,"--spice-accent":e,"--spice-button":e,"--spice-button-active":e,"--spice-rgb-accent":r,"--spice-rgb-button":r,"--sn-color-extracted-primary-rgb":r,"--sn-color-extracted-vibrant-rgb":r,"--sn-color-extracted-dominant-rgb":r};if(i&&this.integrationConfig.oklabEnhancementEnabled){let o=this.oklabProcessor.generateCSSVariables(i,"sn-oklab-accent");Object.assign(a,{...o,"--sn-dynamic-shadow-hex":i.shadowHex,"--sn-dynamic-shadow-rgb":`${i.shadowRgb.r},${i.shadowRgb.g},${i.shadowRgb.b}`,"--sn-accent-oklch-l":i.oklchEnhanced.L.toFixed(3),"--sn-accent-oklch-c":i.oklchEnhanced.C.toFixed(3),"--sn-accent-oklch-h":i.oklchEnhanced.H.toFixed(1)}),u?.debug?.log("DynamicCatppuccinStrategy","Added OKLAB-enhanced CSS variables:",{oklabVarsCount:Object.keys(o).length,enhancedHex:i.enhancedHex,shadowHex:i.shadowHex})}this.cssController&&this.cssController.updateVariables(a,"high","core-spicetify-facade");let s=t.PRIMARY||t.VIBRANT;s&&await this.updateLivingBaseBackground(s),this.integrationConfig.consciousnessIntegrationEnabled&&await this.updateConsciousnessWithAccent(e,r),u?.debug?.log("DynamicCatppuccinStrategy",`Applied coordinated color facade - Spicetify: ${e}, Consciousness extensions updated`,{oklabProcessing:!!i,variableCount:Object.keys(a).length})}async updateLivingBaseBackground(e){let t=this.utils.hexToRgb(e);if(!t)return;let i=`${t.r},${t.g},${t.b}`,n=`
      linear-gradient(135deg,
        var(--spice-base) 0%,
        rgba(${i}, 0.08) 30%,
        var(--spice-base) 70%
      ),
      var(--spice-base)
    `,r={"--sn-dynamic-secondary-hex":e,"--sn-dynamic-secondary-rgb":i,"--sn-color-extracted-secondary-rgb":i,"--sn-color-harmony-complementary-rgb":i,"--living-base-gradient":n,"--consciousness-base-gradient":n};this.cssController&&this.cssController.updateVariables(r,"normal","living-base-background"),u?.debug?.log("DynamicCatppuccinStrategy",`Coordinated living base facade updated - Primary: ${e}, preserving --spice-base`)}async updateConsciousnessWithAccent(e,t){let i={"--sn-holographic-rgb":t,"--holographic-scanline-rgb":t,"--consciousness-intensity":`calc(0.5 + var(--musical-sync-intensity) * ${this.integrationConfig.energyResponseMultiplier})`};this.cssController&&this.cssController.updateVariables(i,"normal","consciousness-accent-integration")}async updateConsciousnessWithMusicEnergy(e){let t=e*this.integrationConfig.energyResponseMultiplier,n=Math.max(.1,Math.min(1,.5+t*.3)),r={"--musical-sync-intensity":t.toString(),"--holographic-music-flicker-intensity":t.toString(),"--consciousness-intensity":n.toString()};this.cssController&&(this.cssController.updateVariables(r,"high","consciousness-music-energy"),this.cssController.updateConsciousnessIntensity(parseFloat(n.toString()),"DynamicCatppuccinStrategy",t))}getDynamicColorState(){return{...this.dynamicColorState}}updateConfig(e){this.integrationConfig={...this.integrationConfig,...e},("oklabEnhancementEnabled"in e||"oklabPreset"in e)&&(this.oklabProcessor=new M(this.config.enableDebug)),u?.debug?.log("DynamicCatppuccinStrategy","Configuration updated:",{...e,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,oklabPreset:this.integrationConfig.oklabPreset})}async healthCheck(){let e=this.checkDynamicAccentEnabled(),t=Date.now()-this.dynamicColorState.lastUpdateTime<3e4;return{healthy:e,canProcess:e,issues:e?[]:["Dynamic accent not enabled in settings"],metrics:{dynamicAccentEnabled:e,currentAccent:this.dynamicColorState.currentAccentHex,lastUpdateAge:Date.now()-this.dynamicColorState.lastUpdateTime,hasRecentUpdate:t,transitionInProgress:this.dynamicColorState.transitionInProgress,musicEnergy:this.dynamicColorState.musicEnergy,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,oklabPreset:this.integrationConfig.oklabPreset,consciousnessIntegration:this.integrationConfig.consciousnessIntegrationEnabled}}}destroy(){this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=0),this.dynamicColorState.transitionInProgress=!1,u?.debug?.log("DynamicCatppuccinStrategy","Dynamic Catppuccin strategy destroyed")}}});var Aa={};ie(Aa,{LivingGradientStrategy:()=>St});var St,An=b(()=>{"use strict";U();$();D();ue();R();ne();K();de();St=class extends Q{constructor(t=w,i=A,n=null,r=null,a,s){super(t,i,n,r,null);this.utils=A;this.config=w;this.livingBaseState={currentBaseHex:"#1e1e2e",currentBaseRgb:"30,30,46",currentPrimaryHex:"#cba6f7",currentPrimaryRgb:"203,166,247",consciousnessIntensity:.5,musicEnergy:.5,lastUpdateTime:0,webglIntegrationActive:!1,oklabGradientStops:[]};this.gradientConfig={baseTransformationEnabled:!0,webglIntegrationEnabled:!0,breathingAnimationEnabled:!0,consciousnessLayerOpacity:.08,organicFlowIntensity:1.2,musicResponsiveness:1,oklabInterpolationEnabled:!0,oklabPreset:"STANDARD",gradientSmoothness:.8,animationThrottleFps:30,enablePerformanceBudget:!0,maxFrameTimeMs:16};this.cssAnimationManager=null;this.oklabCache=new Map;this.gradientCache=new Map;this.cacheValidityMs=5e3;this.lastCacheCleanup=0;this.musicEventDebounceTimers={musicState:0,harmonizedColors:0,webglState:0,consciousnessIntensity:0};this.eventDebounceMs=100;this.cssController=a||T(),this.oklabProcessor=new M(this.config.enableDebug),this.deviceDetector=new N,this.cssAnimationManager=s,this.initializeBaseState(),this.applyDeviceAwareSettings().catch(o=>{u?.debug?.warn("LivingGradientStrategy","Failed to apply device-aware settings:",o)}),u?.debug?.log("LivingGradientStrategy","Living gradient strategy initialized with OKLAB interpolation and device-aware performance")}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{this.setupConsciousnessListeners(),this.setupWebGLIntegrationListeners(),this.initializeBaseState(),this.initializeConsciousnessBreathing(),await this.applyLivingConsciousnessBase(),u?.debug?.log("LivingGradientStrategy","Living gradient system awakened with visual system lifecycle")}catch(t){u?.debug?.error("LivingGradientStrategy","Failed to initialize living gradient system:",t)}}setupConsciousnessListeners(){typeof p<"u"&&p.subscribe("colors:harmonized",t=>{t&&t.processedColors&&this.handleHarmonizedColorUpdate(t.processedColors)},"LivingGradientStrategy"),document.addEventListener("music-state-change",t=>{let i=t;i.detail&&this.handleMusicStateChange(i.detail)}),document.addEventListener("consciousness-intensity-change",t=>{let i=t;i.detail&&typeof i.detail.intensity=="number"&&this.updateConsciousnessIntensity(i.detail.intensity)}),u?.debug?.log("LivingGradientStrategy","Consciousness listeners established")}setupWebGLIntegrationListeners(){document.addEventListener("webgl-state-change",t=>{let i=t;i.detail&&this.handleWebGLStateChange(i.detail)}),document.addEventListener("webgl-gradient-update",t=>{let i=t;i.detail&&this.coordinateWithWebGLGradient(i.detail)}),u?.debug?.log("LivingGradientStrategy","WebGL integration listeners established")}handleHarmonizedColorUpdate(t){this.debouncedEventHandler("harmonizedColors",()=>{let i=t.VIBRANT||t.PRIMARY||t.PROMINENT;if(i&&i!==this.livingBaseState.currentPrimaryHex){this.livingBaseState.currentPrimaryHex=i;let n=this.utils.hexToRgb(i);n&&(this.livingBaseState.currentPrimaryRgb=`${n.r},${n.g},${n.b}`),this.updateLivingConsciousnessBase(),this.triggerConsciousnessBreathing(),u?.debug?.log("LivingGradientStrategy","Living base updated with harmonized colors:",i)}})}handleMusicStateChange(t){this.debouncedEventHandler("musicState",()=>{if(t.energy!==void 0){this.livingBaseState.musicEnergy=t.energy;let i=.5,n=t.energy*this.gradientConfig.musicResponsiveness;this.livingBaseState.consciousnessIntensity=Math.max(.1,Math.min(1,i+n*.3)),this.updateMusicResponsiveVariables()}})}handleWebGLStateChange(t){this.debouncedEventHandler("webglState",()=>{t.enabled!==void 0&&(this.livingBaseState.webglIntegrationActive=t.enabled,this.coordinateWithWebGLSystem(t.enabled),u?.debug?.log("LivingGradientStrategy",`WebGL integration ${t.enabled?"activated":"deactivated"}`))})}updateConsciousnessIntensity(t){this.debouncedEventHandler("consciousnessIntensity",()=>{this.livingBaseState.consciousnessIntensity=Math.max(0,Math.min(1,t)),this.updateConsciousnessVariables()})}debouncedEventHandler(t,i){let n=performance.now();n-this.musicEventDebounceTimers[t]>=this.eventDebounceMs&&(i(),this.musicEventDebounceTimers[t]=n)}initializeConsciousnessBreathing(){if(this.gradientConfig.breathingAnimationEnabled){if(!this.cssAnimationManager){u?.debug?.warn("LivingGradientStrategy","CSSAnimationManager not available, falling back to basic consciousness");return}this.triggerConsciousnessBreathing(),u?.debug?.log("LivingGradientStrategy","CSS-first consciousness breathing initialized")}}triggerConsciousnessBreathing(){if(!this.cssAnimationManager||!this.gradientConfig.breathingAnimationEnabled)return;let t=document.querySelectorAll(".Root__main-view::before, .Root__main-view, [data-consciousness-breathing]");if(t.length===0){let i=document.querySelector(".Root__main-view")||document.body;i&&(i.setAttribute("data-consciousness-breathing","true"),this.cssAnimationManager.triggerConsciousnessBreathing([i],this.livingBaseState.musicEnergy,120))}else this.cssAnimationManager.triggerConsciousnessBreathing(t,this.livingBaseState.musicEnergy,120);u?.debug?.log("LivingGradientStrategy",`CSS-first consciousness breathing triggered for ${t.length} elements`)}async applyDeviceAwareSettings(){if(!this.deviceDetector.isInitialized)try{await this.deviceDetector.initialize()}catch(n){u?.debug?.warn("LivingGradientStrategy","Device detection failed, using default settings:",n);return}let t=this.deviceDetector.getCapabilities();if(!t){u?.debug?.warn("LivingGradientStrategy","No device capabilities available, using default settings");return}let i=t.overall;switch(i){case"high":this.gradientConfig.animationThrottleFps=30,this.gradientConfig.maxFrameTimeMs=16,this.gradientConfig.enablePerformanceBudget=!0;break;case"medium":this.gradientConfig.animationThrottleFps=20,this.gradientConfig.maxFrameTimeMs=20,this.gradientConfig.enablePerformanceBudget=!0;break;case"low":this.gradientConfig.animationThrottleFps=15,this.gradientConfig.maxFrameTimeMs=33,this.gradientConfig.enablePerformanceBudget=!0,this.gradientConfig.consciousnessLayerOpacity*=.7,this.gradientConfig.organicFlowIntensity*=.8,this.gradientConfig.oklabInterpolationEnabled=!1;break;default:this.gradientConfig.animationThrottleFps=20,this.gradientConfig.maxFrameTimeMs=20;break}t.gpu.supportsWebGL||(this.gradientConfig.webglIntegrationEnabled=!1),t.memory.level==="low"&&(this.cacheValidityMs=2e3),t.cpu.cores<=2&&(this.gradientConfig.animationThrottleFps=Math.min(this.gradientConfig.animationThrottleFps,15)),t.display.reducedMotion&&(this.gradientConfig.breathingAnimationEnabled=!1,u?.debug?.log("LivingGradientStrategy","Breathing animation disabled due to reduced motion preference")),u?.debug?.log("LivingGradientStrategy",`Device-aware settings applied for ${i}: ${this.gradientConfig.animationThrottleFps}fps, CSS-first breathing coordination`)}getStrategyName(){return"living-gradient"}canProcess(t){return this.gradientConfig.baseTransformationEnabled}getEstimatedProcessingTime(t){return 8}async processColors(t){let i=performance.now();try{let n=this.selectPrimaryColor(t.rawColors),r=this.selectSecondaryColor(t.rawColors);if(!n)throw new Error("No suitable primary color found for living gradient");let a=n,s=r,o=[];if(this.gradientConfig.oklabInterpolationEnabled&&n){let d=M.getPreset(this.gradientConfig.oklabPreset);if(a=this.oklabProcessor.processColor(n,d).enhancedHex,r){s=this.oklabProcessor.processColor(r,d).enhancedHex;let f=Math.ceil(5*this.gradientConfig.gradientSmoothness)+3;o=this.oklabProcessor.generateOKLABGradient(a,s,f,d)}else{let g=this.livingBaseState.currentBaseHex;o=this.oklabProcessor.generateOKLABGradient(a,g,5,d),s=o[o.length-1]?.enhancedHex||a}u?.debug?.log("LivingGradientStrategy","OKLAB gradient processing applied:",{originalPrimary:n,processedPrimary:a,originalSecondary:r,processedSecondary:s,gradientStops:o.length,preset:d.name})}await this.updateLivingBaseState(a,s,t,o),await this.applyLivingConsciousnessBase(),this.triggerConsciousnessBreathing(),await this.updateWebGLIntegration();let l=performance.now()-i,m={processedColors:{primary:a,secondary:s||a,originalPrimary:n,...r&&{originalSecondary:r},livingBase:this.livingBaseState.currentBaseHex,...t.rawColors},accentHex:a,accentRgb:this.livingBaseState.currentPrimaryRgb,metadata:{strategy:this.getStrategyName(),processingTime:l,cacheKey:`living-gradient-${t.trackUri}`,harmonicIntensity:this.gradientConfig.organicFlowIntensity,oklabInterpolation:this.gradientConfig.oklabInterpolationEnabled,oklabPreset:this.gradientConfig.oklabPreset,gradientStopCount:o.length,gradientSmoothness:this.gradientConfig.gradientSmoothness},context:t};return u?.debug?.log("LivingGradientStrategy","Living gradient processing completed",{originalPrimary:n,processedPrimary:a,originalSecondary:r,processedSecondary:s,oklabProcessing:this.gradientConfig.oklabInterpolationEnabled,gradientStops:o.length,processingTime:l,trackUri:t.trackUri}),m}catch(n){let r=performance.now()-i;return u?.debug?.error("LivingGradientStrategy","Living gradient processing failed:",n),{processedColors:t.rawColors,accentHex:this.livingBaseState.currentPrimaryHex,accentRgb:this.livingBaseState.currentPrimaryRgb,metadata:{strategy:this.getStrategyName(),processingTime:r,error:n instanceof Error?n.message:"Unknown error"},context:t}}}initializeBaseState(){let t=document.documentElement,i=getComputedStyle(t),n=i.getPropertyValue("--spice-base").trim()||"#1e1e2e";this.livingBaseState.currentBaseHex=n;let r=this.utils.hexToRgb(n);r&&(this.livingBaseState.currentBaseRgb=`${r.r},${r.g},${r.b}`);let a=i.getPropertyValue("--sn-bg-gradient-primary-rgb").trim();if(a){let s=a.split(",").map(o=>parseInt(o.trim()));s.length===3&&(this.livingBaseState.currentPrimaryRgb=a,this.livingBaseState.currentPrimaryHex=this.utils.rgbToHex(s[0],s[1],s[2]))}this.livingBaseState.lastUpdateTime=Date.now(),u?.debug?.log("LivingGradientStrategy","Base state initialized:",{base:this.livingBaseState.currentBaseHex,primary:this.livingBaseState.currentPrimaryHex})}selectPrimaryColor(t){let i=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let n of i){let r=t[n];if(r&&this.utils.hexToRgb(r))return r}return null}selectSecondaryColor(t){let i=["SECONDARY","DARK_VIBRANT","DESATURATED","LIGHT_VIBRANT"];for(let n of i){let r=t[n];if(r&&this.utils.hexToRgb(r))return r}return null}async updateLivingBaseState(t,i,n,r=[]){let a=this.utils.hexToRgb(t);if(a){if(this.livingBaseState.currentPrimaryHex=t,this.livingBaseState.currentPrimaryRgb=`${a.r},${a.g},${a.b}`,this.livingBaseState.oklabGradientStops=r,n.musicData?.energy!==void 0){this.livingBaseState.musicEnergy=n.musicData.energy;let s=this.gradientConfig.consciousnessLayerOpacity,o=1+n.musicData.energy*this.gradientConfig.musicResponsiveness;this.livingBaseState.consciousnessIntensity=Math.max(.05,Math.min(1,s*o))}this.livingBaseState.lastUpdateTime=Date.now()}}async applyLivingConsciousnessBase(){let t=this.createLivingGradient(this.livingBaseState.oklabGradientStops),n=performance.now()/4e3*Math.PI*2,r=1+Math.sin(n)*.2,a=this.livingBaseState.consciousnessIntensity*r,s=Math.sin(n*.7)*this.gradientConfig.organicFlowIntensity,o=Math.cos(n*.5)*this.gradientConfig.organicFlowIntensity,l=4e3,m=.5+this.livingBaseState.musicEnergy*1.5,d=l/m,h={"--living-base-gradient":t,"--consciousness-base-gradient":t,"--consciousness-layer-opacity":a.toString(),"--consciousness-flow-x":`${s}%`,"--consciousness-flow-y":`${o}%`,"--consciousness-breathing-duration":`${d}ms`};await this.cssController.batchSetVariables("LivingGradientStrategy",h,"high","living-consciousness-base"),u?.debug?.log("LivingGradientStrategy","Applied coordinated living consciousness base gradient")}createGradientCacheKey(t,i,n,r){let a=n.map((s,o)=>`${s.enhancedHex}-${o}`).join("|");return`${t}-${i}-${a}-${Math.floor(r*10)}`}cleanupCache(){let t=Date.now();t-this.lastCacheCleanup<1e4||(this.lastCacheCleanup=t,this.gradientCache.clear(),this.config.enableDebug&&u?.debug?.log("LivingGradientStrategy","Cache cleanup completed"))}createLivingGradient(t=[]){let i=this.livingBaseState.currentPrimaryRgb,n=this.livingBaseState.currentBaseRgb,a=performance.now()/4e3*Math.PI*2,s=this.createGradientCacheKey(i,n,t,a),o=this.gradientCache.get(s);if(o)return this.cleanupCache(),o;let l=this.generateLivingGradient(i,n,t);return this.gradientCache.set(s,l),l}generateLivingGradient(t,i,n){return this.gradientConfig.oklabInterpolationEnabled&&n.length>0?`
        radial-gradient(
          ellipse at calc(50% + var(--consciousness-flow-x)) calc(50% + var(--consciousness-flow-y)),
          ${n.map((a,s)=>{let o=s/(n.length-1)*100,l=`${a.enhancedRgb.r},${a.enhancedRgb.g},${a.enhancedRgb.b}`,m=.6*(1-s/n.length)+.1;return`rgba(${l}, calc(var(--consciousness-layer-opacity) * ${m})) ${o}%`}).join(", ")}
        ),
        linear-gradient(
          135deg,
          rgba(${n[0]?.enhancedRgb.r||t.split(",")[0]},${n[0]?.enhancedRgb.g||t.split(",")[1]},${n[0]?.enhancedRgb.b||t.split(",")[2]}, calc(var(--consciousness-layer-opacity) * 0.4)) 0%,
          var(--spice-base) 50%,
          rgba(${n[n.length-1]?.enhancedRgb.r||t.split(",")[0]},${n[n.length-1]?.enhancedRgb.g||t.split(",")[1]},${n[n.length-1]?.enhancedRgb.b||t.split(",")[2]}, calc(var(--consciousness-layer-opacity) * 0.2)) 100%
        ),
        var(--spice-base)
      `:`
      radial-gradient(
        ellipse at calc(50% + var(--consciousness-flow-x)) calc(50% + var(--consciousness-flow-y)),
        rgba(${t}, calc(var(--consciousness-layer-opacity) * 0.6)) 0%,
        rgba(${t}, calc(var(--consciousness-layer-opacity) * 0.3)) 30%,
        rgba(${i}, calc(var(--consciousness-layer-opacity) * 0.1)) 60%,
        var(--spice-base) 100%
      ),
      linear-gradient(
        135deg,
        rgba(${t}, calc(var(--consciousness-layer-opacity) * 0.4)) 0%,
        var(--spice-base) 50%,
        rgba(${t}, calc(var(--consciousness-layer-opacity) * 0.2)) 100%
      ),
      var(--spice-base)
    `}updateBreathingAnimation(){this.triggerConsciousnessBreathing()}startBreathingAnimation(){this.triggerConsciousnessBreathing(),u?.debug?.log("LivingGradientStrategy","CSS-first consciousness breathing started - 90%+ JavaScript overhead eliminated")}scheduleDebouncedCssUpdate(){u?.debug?.log("LivingGradientStrategy","Debounced CSS updates eliminated - using CSS-first breathing")}async updateWebGLIntegration(){if(!this.gradientConfig.webglIntegrationEnabled)return;let t={"--sn-bg-gradient-primary-rgb":this.livingBaseState.currentPrimaryRgb,"--sn-webgl-living-gradient-sync":"1","--sn-gradient-consciousness-level":this.livingBaseState.consciousnessIntensity.toString()};await this.cssController.batchSetVariables("LivingGradientStrategy",t,"high","webgl-living-gradient-integration"),this.livingBaseState.webglIntegrationActive=!0,u?.debug?.log("LivingGradientStrategy","WebGL integration updated")}getLivingBaseState(){return{...this.livingBaseState}}updateLivingConsciousnessBase(){this.applyLivingConsciousnessBase().catch(i=>{u?.debug?.error("LivingGradientStrategy","Failed to update living consciousness base:",i)});let t=new CustomEvent("living-base-update",{detail:{baseHex:this.livingBaseState.currentBaseHex,primaryHex:this.livingBaseState.currentPrimaryHex,consciousnessIntensity:this.livingBaseState.consciousnessIntensity,timestamp:Date.now()}});document.dispatchEvent(t)}updateMusicResponsiveVariables(){let t={"--consciousness-music-energy":this.livingBaseState.musicEnergy.toString(),"--consciousness-music-intensity":this.livingBaseState.consciousnessIntensity.toString()};this.cssController.batchSetVariables("LivingGradientStrategy",t,3,"music-responsive").catch(i=>{u?.debug?.error("LivingGradientStrategy","Failed to update music responsive variables:",i)})}updateConsciousnessVariables(){let t={"--consciousness-intensity-global":this.livingBaseState.consciousnessIntensity.toString(),"--consciousness-layer-opacity":(this.gradientConfig.consciousnessLayerOpacity*this.livingBaseState.consciousnessIntensity).toString()};this.cssController.batchSetVariables("LivingGradientStrategy",t,3,"consciousness-vars").catch(i=>{u?.debug?.error("LivingGradientStrategy","Failed to update consciousness variables:",i)})}coordinateWithWebGLSystem(t){let i=t?{"--consciousness-webgl-coordination":"0.7","--consciousness-css-fallback":"0.3"}:{"--consciousness-webgl-coordination":"0","--consciousness-css-fallback":"1.0"};this.cssController.batchSetVariables("LivingGradientStrategy",i,"high","webgl-coordination").catch(n=>{u?.debug?.error("LivingGradientStrategy","Failed to coordinate with WebGL system:",n)}),u?.debug?.log("LivingGradientStrategy",`WebGL coordination ${t?"enabled":"disabled"}`)}coordinateWithWebGLGradient(t){this.gradientConfig.webglIntegrationEnabled&&(t.flowState&&this.updateFlowStateFromWebGL(t.flowState),t.colorState&&this.updateColorStateFromWebGL(t.colorState))}updateFlowStateFromWebGL(t){let i={};t.flowX!==void 0&&(i["--consciousness-webgl-flow-x"]=`${t.flowX}%`),t.flowY!==void 0&&(i["--consciousness-webgl-flow-y"]=`${t.flowY}%`),t.flowScale!==void 0&&(i["--consciousness-webgl-scale"]=t.flowScale.toString()),Object.keys(i).length>0&&this.cssController.batchSetVariables("LivingGradientStrategy",i,3,"webgl-flow").catch(n=>{u?.debug?.error("LivingGradientStrategy","Failed to update WebGL flow state:",n)})}updateColorStateFromWebGL(t){t.primaryColor&&(this.livingBaseState.currentPrimaryRgb=t.primaryColor,this.updateLivingConsciousnessBase())}async healthCheck(){let t=await this.getStrategyHealthCheck();return{healthy:t.healthy&&this.isActive,canProcess:t.canProcess,issues:t.issues||[],metrics:{...t.metrics,systemType:"consolidated-living-gradient",isVisualSystem:!0,isColorProcessor:!0,isActive:this.isActive,initialized:this.initialized}}}async getStrategyHealthCheck(){let t=Date.now()-this.livingBaseState.lastUpdateTime<3e4;return{healthy:this.gradientConfig.baseTransformationEnabled,canProcess:this.gradientConfig.baseTransformationEnabled,issues:this.gradientConfig.baseTransformationEnabled?[]:["Base transformation disabled in configuration"],metrics:{baseTransformationEnabled:this.gradientConfig.baseTransformationEnabled,breathingAnimationEnabled:this.gradientConfig.breathingAnimationEnabled,webglIntegrationActive:this.livingBaseState.webglIntegrationActive,consciousnessIntensity:this.livingBaseState.consciousnessIntensity,musicEnergy:this.livingBaseState.musicEnergy,hasRecentUpdate:t,cssFirstBreathing:!0,oklabInterpolation:this.gradientConfig.oklabInterpolationEnabled,oklabPreset:this.gradientConfig.oklabPreset,gradientSmoothness:this.gradientConfig.gradientSmoothness,oklabGradientStops:this.livingBaseState.oklabGradientStops.length}}}destroy(){this.cssAnimationManager&&this.cssAnimationManager.stopConsciousnessBreathing(),this.oklabCache.clear(),this.gradientCache.clear(),super.destroy(),u?.debug?.log("LivingGradientStrategy","Consolidated living gradient system destroyed with complete cleanup")}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),u?.debug?.log("LivingGradientStrategy","Living gradient system cleaned up")}updateConfig(t){this.gradientConfig={...this.gradientConfig,...t},("oklabInterpolationEnabled"in t||"oklabPreset"in t)&&(this.oklabProcessor=new M(this.config.enableDebug)),u?.debug?.log("LivingGradientStrategy","Configuration updated:",{...t,oklabInterpolation:this.gradientConfig.oklabInterpolationEnabled,oklabPreset:this.gradientConfig.oklabPreset,gradientSmoothness:this.gradientConfig.gradientSmoothness})}stopBreathingAnimation(){this.cssAnimationManager&&this.cssAnimationManager.stopConsciousnessBreathing(),u?.debug?.log("LivingGradientStrategy","CSS-first consciousness breathing stopped")}}});var In={};ie(In,{DEFAULT_VERTEX_SHADER:()=>vt,ShaderLoader:()=>te,createGradientTexture:()=>oe});function oe(c,e,t=256){try{if(!c)return u?.debug?.error("ShaderLoader","WebGL context is null or undefined"),null;if(!e||e.length===0)return u?.debug?.error("ShaderLoader","Invalid or empty color stops array"),null;if(t<=0||t>8192)return u?.debug?.error("ShaderLoader",`Invalid texture width: ${t}`),null;let i=c.getError();if(i!==c.NO_ERROR&&u?.debug?.warn("ShaderLoader",`WebGL context has pending error: ${i}`),c.isContextLost())return u?.debug?.error("ShaderLoader","WebGL context is lost"),null;let n=document.createElement("canvas");if(!n)return u?.debug?.error("ShaderLoader","Failed to create canvas element"),null;n.width=t,n.height=1;let r=n.getContext("2d",{willReadFrequently:!1});if(!r)return u?.debug?.error("ShaderLoader","Failed to get 2D canvas context"),null;let a=e.filter(l=>typeof l.r!="number"||typeof l.g!="number"||typeof l.b!="number"||typeof l.a!="number"||typeof l.position!="number"?(u?.debug?.warn("ShaderLoader","Invalid color stop found, skipping"),!1):((l.position<0||l.position>1)&&(u?.debug?.warn("ShaderLoader",`Invalid color stop position: ${l.position}, clamping`),l.position=Math.max(0,Math.min(1,l.position))),!0));if(a.length===0)return u?.debug?.error("ShaderLoader","No valid color stops after validation"),null;a.sort((l,m)=>l.position-m.position);let s=r.createLinearGradient(0,0,t,0);if(!s)return u?.debug?.error("ShaderLoader","Failed to create linear gradient"),null;try{a.forEach((l,m)=>{let d=Math.max(0,Math.min(255,Math.round(l.r*255))),h=Math.max(0,Math.min(255,Math.round(l.g*255))),g=Math.max(0,Math.min(255,Math.round(l.b*255))),f=Math.max(0,Math.min(1,l.a)),v=`rgba(${d}, ${h}, ${g}, ${f})`;s.addColorStop(l.position,v)})}catch(l){return u?.debug?.error("ShaderLoader","Failed to add color stops to gradient:",l),null}try{r.fillStyle=s,r.fillRect(0,0,t,1)}catch(l){return u?.debug?.error("ShaderLoader","Failed to fill canvas with gradient:",l),null}let o=c.createTexture();if(!o)return u?.debug?.error("ShaderLoader","Failed to create WebGL texture - gl.createTexture() returned null"),null;try{c.bindTexture(c.TEXTURE_2D,o);let l=c.getError();if(l!==c.NO_ERROR)return u?.debug?.error("ShaderLoader",`WebGL error after texture binding: ${l}`),c.deleteTexture(o),null;c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,n);let m=c.getError();if(m!==c.NO_ERROR)return u?.debug?.error("ShaderLoader",`WebGL error after texture upload: ${m}`),c.deleteTexture(o),null;c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);let d=c.getError();return d!==c.NO_ERROR?(u?.debug?.error("ShaderLoader",`WebGL error after setting texture parameters: ${d}`),c.deleteTexture(o),null):(c.bindTexture(c.TEXTURE_2D,null),u?.debug?.log("ShaderLoader",`Gradient texture created successfully: ${t}x1, ${a.length} stops`),o)}catch(l){return u?.debug?.error("ShaderLoader","Exception during WebGL texture operations:",l),o&&c.deleteTexture(o),null}}catch(i){return u?.debug?.error("ShaderLoader",`Gradient texture creation failed: ${i instanceof Error?i.message:"Unknown error"}`),null}}var te,vt,Ct=b(()=>{"use strict";R();te=class{static loadFragment(e,t,i){let n=i||this.hashSource(t),r=this.getContextCache(e);if(r[n])return r[n];try{let a=this.compileShader(e,e.FRAGMENT_SHADER,t);return a&&(r[n]=a,u?.debug?.log("ShaderLoader",`Fragment shader compiled: ${n.substring(0,8)}...`)),a}catch(a){return u?.debug?.error("ShaderLoader",`Fragment shader compilation failed: ${a}`),null}}static loadVertex(e,t,i){let n=i||this.hashSource(t),r=this.getContextCache(e);if(r[n])return r[n];try{let a=this.compileShader(e,e.VERTEX_SHADER,t);return a&&(r[n]=a,u?.debug?.log("ShaderLoader",`Vertex shader compiled: ${n.substring(0,8)}...`)),a}catch(a){return u?.debug?.error("ShaderLoader",`Vertex shader compilation failed: ${a}`),null}}static createProgram(e,t,i){try{let n=e.createProgram();if(!n)return null;if(e.attachShader(n,t),e.attachShader(n,i),e.linkProgram(n),!e.getProgramParameter(n,e.LINK_STATUS)){let r=e.getProgramInfoLog(n);throw e.deleteProgram(n),new Error(`Program linking failed: ${r}`)}return n}catch(n){return u?.debug?.error("ShaderLoader",`Program creation failed: ${n}`),null}}static clearCache(e){let t=this.cache.get(e);t&&(Object.values(t).forEach(i=>{e.deleteShader(i)}),this.cache.delete(e))}static clearAllCaches(){this.cache.clear()}static compileShader(e,t,i){let n=e.createShader(t);if(!n)return null;if(e.shaderSource(n,i),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS)){let r=e.getShaderInfoLog(n);throw e.deleteShader(n),new Error(`Shader compilation failed: ${r}`)}return n}static clearContextCache(e){if(this.cache.has(e)){let t=this.cache.get(e);Object.values(t).forEach(i=>{if(i&&e&&!e.isContextLost())try{e.deleteShader(i)}catch{}}),this.cache.set(e,{}),u?.debug?.log("ShaderLoader","Context cache cleared due to WebGL context loss/restore")}}static getContextCache(e){return this.cache.has(e)||this.cache.set(e,{}),this.cache.get(e)}static hashSource(e){let t=0;for(let i=0;i<e.length;i++){let n=e.charCodeAt(i);t=(t<<5)-t+n,t=t&t}return t.toString(16)}};te.cache=new Map;vt=`#version 300 es
precision mediump float;

in vec2 a_position;
out vec2 v_uv;

void main() {
  v_uv = a_position * 0.5 + 0.5;
  gl_Position = vec4(a_position, 0.0, 1.0);
}`});var ac,Mt,Ia=b(()=>{"use strict";U();$();ue();R();fe();ne();bt();K();Ct();ac=`#version 300 es
precision mediump float;

uniform float u_time;
uniform sampler2D u_gradientTex;
uniform vec2 u_resolution;
uniform float u_flowStrength;
uniform float u_noiseScale;

// Wave stack uniforms
uniform float u_waveY[2];
uniform float u_waveHeight[2];
uniform float u_waveOffset[2];
uniform float u_blurExp;
uniform float u_blurMax;

out vec4 fragColor;

// Simplex noise implementation
vec3 mod289(vec3 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec2 mod289(vec2 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec3 permute(vec3 x) {
  return mod289(((x*34.0)+1.0)*x);
}

float snoise(vec2 v) {
  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0
                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)
                     -0.577350269189626,  // -1.0 + 2.0 * C.x
                      0.024390243902439); // 1.0 / 41.0
  vec2 i  = floor(v + dot(v, C.yy) );
  vec2 x0 = v -   i + dot(i, C.xx);

  vec2 i1;
  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
  vec4 x12 = x0.xyxy + C.xxzz;
  x12.xy -= i1;

  i = mod289(i);
  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))
    + i.x + vec3(0.0, i1.x, 1.0 ));

  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
  m = m*m ;
  m = m*m ;

  vec3 x = 2.0 * fract(p * C.www) - 1.0;
  vec3 h = abs(x) - 0.5;
  vec3 ox = floor(x + 0.5);
  vec3 a0 = x - ox;

  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );

  vec3 g;
  g.x  = a0.x  * x0.x  + h.x  * x0.y;
  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
  return 130.0 * dot(m, g);
}

// Octave noise for richer detail
float octaveNoise(vec2 uv, float octaves, float persistence, float scale) {
  float value = 0.0;
  float amplitude = 1.0;
  float frequency = scale;
  float maxValue = 0.0;

  for(float i = 0.0; i < octaves; i++) {
    value += snoise(uv * frequency) * amplitude;
    maxValue += amplitude;
    amplitude *= persistence;
    frequency *= 2.0;
  }

  return value / maxValue;
}

// Wave alpha calculation with smooth transitions
float wave_alpha(vec2 uv, int waveIndex) {
  float y = uv.y;
  float waveCenter = u_waveY[waveIndex];
  float waveHeight = u_waveHeight[waveIndex];

  float distance = abs(y - waveCenter);
  float alpha = 1.0 - smoothstep(0.0, waveHeight * 0.5, distance);

  return alpha;
}

// Dynamic blur calculation using power function
float calc_blur(vec2 uv) {
  vec2 center = vec2(0.5, 0.5);
  float distance = length(uv - center);

  float blur = pow(distance, u_blurExp);
  blur = clamp(blur, 0.0, u_blurMax);

  return blur;
}

// Background noise generator with time offset
float background_noise(vec2 uv, float timeOffset) {
  vec2 flowUV = uv;
  float adjustedTime = u_time + timeOffset;

  flowUV.x += adjustedTime * 0.02 * u_flowStrength;
  flowUV.y += sin(adjustedTime * 0.03 + uv.x * 3.14159) * 0.01 * u_flowStrength;

  float noise1 = octaveNoise(flowUV * u_noiseScale, 4.0, 0.5, 1.0);
  float noise2 = octaveNoise(flowUV * u_noiseScale * 2.0 + vec2(100.0), 3.0, 0.4, 1.0);

  return (noise1 + noise2 * 0.3) * 0.5 + 0.5;
}

void main() {
  vec2 uv = gl_FragCoord.xy / u_resolution.xy;

  // Generate three distinct background noise fields with time offsets
  float noise1 = background_noise(uv, u_waveOffset[0]);
  float noise2 = background_noise(uv, u_waveOffset[1]);
  float noise3 = background_noise(uv, 0.0); // Base noise without offset

  // Calculate wave alphas for blending
  float alpha1 = wave_alpha(uv, 0);
  float alpha2 = wave_alpha(uv, 1);
  float alpha3 = 1.0 - alpha1 - alpha2; // Remaining area
  alpha3 = max(alpha3, 0.0); // Ensure non-negative

  // Normalize alphas to ensure they sum to 1.0
  float totalAlpha = alpha1 + alpha2 + alpha3;
  if (totalAlpha > 0.0) {
    alpha1 /= totalAlpha;
    alpha2 /= totalAlpha;
    alpha3 /= totalAlpha;
  }

  // Blend the three noise fields based on wave alphas
  float t = noise1 * alpha1 + noise2 * alpha2 + noise3 * alpha3;
  t = clamp(t, 0.0, 1.0);

  // Sample gradient texture
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));

  // Apply dynamic blur based on position
  float blurAmount = calc_blur(uv);

  // Apply subtle vignette with blur modulation
  vec2 center = uv - 0.5;
  float vignette = 1.0 - dot(center, center) * (0.3 + blurAmount * 0.2);
  color.rgb *= vignette;

  // Apply blur effect to alpha channel for depth
  color.a *= (1.0 - blurAmount * 0.3);

  fragColor = color;
}`,Mt=class{constructor(e){this.utils=A;this.config=w;this.webglState={canvas:null,wrapper:null,gl:null,shaderProgram:null,gradientTexture:null,vertexBuffer:null,vao:null,isWebGLAvailable:!1,webglReady:!1,animationId:null,startTime:0,lastFrameTime:0,lastUpdateTime:0,currentFlowStrength:.3,targetFlowStrength:.3,currentNoiseScale:1,targetNoiseScale:1,currentBlurExp:1.2,targetBlurExp:1.2,currentBlurMax:.5,targetBlurMax:.5,currentWaveY:[.3,.7],targetWaveY:[.3,.7],currentWaveHeight:[.4,.3],targetWaveHeight:[.4,.3],currentWaveOffset:[.1,.6],targetWaveOffset:[.1,.6]};this.uniforms={u_time:null,u_gradientTex:null,u_resolution:null,u_flowStrength:null,u_noiseScale:null,u_waveY:null,u_waveHeight:null,u_waveOffset:null,u_blurExp:null,u_blurMax:null};this.flowSettings={enabled:!0,intensity:"balanced",flowStrength:.7,noiseScale:1.2,waveY:[.25,.75],waveHeight:[.4,.3],waveOffset:[2.5,-1.8],blurExp:1.2,blurMax:.6,frameThrottleInterval:1e3/45,oklabProcessingEnabled:!0,oklabPreset:"VIBRANT",gradientTextureSize:512};this.prefersReducedMotion=!1;this.animateWebGL=()=>{if(!this.webglState.webglReady||!this.webglState.gl||!this.webglState.canvas)return;let e=performance.now();if(e-this.webglState.lastFrameTime<this.flowSettings.frameThrottleInterval){this.webglState.animationId=requestAnimationFrame(this.animateWebGL);return}this.webglState.lastFrameTime=e,this.renderWebGLFrame(e),this.webglState.animationId=requestAnimationFrame(this.animateWebGL)};this.lerpHalfLifeValues={flowStrength:.25,noiseScale:.3,blur:.2,wave:.35};this.resizeWebGLCanvas=()=>{if(!this.webglState.canvas)return;let e=window.devicePixelRatio||1,t=window.innerWidth,i=window.innerHeight;this.webglState.canvas.width=t*e,this.webglState.canvas.height=i*e,this.webglState.canvas.style.width=t+"px",this.webglState.canvas.style.height=i+"px"};this.deviceDetector=new N,this.cssController=e||T(),this.oklabProcessor=new M(this.config.enableDebug),this.cssController=T(),this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.webglState.isWebGLAvailable=this.checkWebGL2Support(),this.loadFlowSettings(),u?.debug?.log("WebGLGradientStrategy","\u{1F30A} WebGL gradient strategy initialized - Flow Gradient Recovery Debug",{webglAvailable:this.webglState.isWebGLAvailable,deviceCapability:this.deviceDetector.recommendPerformanceQuality(),oklabProcessing:this.flowSettings.oklabProcessingEnabled,flowSettings:{enabled:this.flowSettings.enabled,intensity:this.flowSettings.intensity,flowStrength:this.flowSettings.flowStrength,noiseScale:this.flowSettings.noiseScale},prefersReducedMotion:this.prefersReducedMotion,webgl2ContextTest:this.checkWebGL2Support()})}getStrategyName(){return"webgl-gradient"}canProcess(e){return u?.debug?.log("WebGLGradientStrategy","\u{1F50D} canProcess() - WebGL Gradient Capability Check",{isWebGLAvailable:this.webglState.isWebGLAvailable,flowSettingsEnabled:this.flowSettings.enabled,webglReady:this.webglState.webglReady,contextTrackUri:e.trackUri,contextColorCount:Object.keys(e.rawColors).length}),this.webglState.isWebGLAvailable?this.flowSettings.enabled?x.get("sn-webgl-enabled")?(u?.debug?.log("WebGLGradientStrategy","canProcess: WebGL force enabled - bypassing device restrictions"),!0):(this.deviceDetector.recommendPerformanceQuality()==="low"&&u?.debug?.log("WebGLGradientStrategy","canProcess: Low performance device detected, allowing based on strategy selection (not force mode)"),!0):(u?.debug?.warn("WebGLGradientStrategy","\u274C canProcess: WebGL strategy disabled in settings"),!1):(u?.debug?.warn("WebGLGradientStrategy","\u274C canProcess: WebGL not available - failed WebGL2 context check"),!1)}getEstimatedProcessingTime(e){let i=this.flowSettings.intensity==="intense"?1.3:1;return Math.round(12*i)}async processColors(e){let t=performance.now(),i={};try{this.webglState.webglReady||await this.initializeWebGLGradient();let n=e.rawColors;if(this.flowSettings.oklabProcessingEnabled){let l=M.getPreset(this.flowSettings.oklabPreset);i=this.oklabProcessor.processColorPalette(e.rawColors,l),n=Object.fromEntries(Object.entries(i).map(([m,d])=>[m,d.enhancedHex])),u?.debug?.log("WebGLGradientStrategy","OKLAB color enhancement applied:",{originalColors:Object.keys(e.rawColors).length,processedColors:Object.keys(n).length,preset:l.name})}let r=this.createGradientStops(n,i);await this.updateGradientTexture(r),await this.enableHybridCoordination(),this.webglState.animationId||this.startWebGLAnimation(),e.musicData?.energy!==void 0&&await this.updateFlowWithMusicEnergy(e.musicData.energy),this.webglState.lastUpdateTime=Date.now();let a=performance.now()-t,s=this.selectPrimaryColor(n)||j.getDefaultAccentColor().hex,o={processedColors:{webgl:"active",gradientStops:r.length.toString(),...n,...Object.keys(e.rawColors).length>0&&{originalColors:JSON.stringify(e.rawColors)}},accentHex:s,accentRgb:this.convertToRgbString(s),metadata:{strategy:this.getStrategyName(),processingTime:a,cacheKey:`webgl-gradient-${e.trackUri}`,harmonicIntensity:this.flowSettings.flowStrength,webglReady:this.webglState.webglReady,oklabProcessing:this.flowSettings.oklabProcessingEnabled,oklabPreset:this.flowSettings.oklabPreset,gradientTextureSize:this.flowSettings.gradientTextureSize,oklabResultsCount:Object.keys(i).length},context:e};return u?.debug?.log("WebGLGradientStrategy","WebGL gradient processing completed",{gradientStops:r.length,processingTime:a,trackUri:e.trackUri}),o}catch(n){let r=performance.now()-t;u?.debug?.error("WebGLGradientStrategy","WebGL gradient processing failed:",n);let a=await this.executeProgressiveFallback(e,n);return{...a,metadata:{...a.metadata,strategy:this.getStrategyName(),processingTime:r,error:n instanceof Error?n.message:"Unknown error"},context:e}}}checkWebGL2Support(){return document.createElement("canvas").getContext("webgl2")!==null}loadFlowSettings(){try{let e=x.get("sn-gradient-intensity");if(e==="disabled"){this.flowSettings.enabled=!1;return}switch(this.flowSettings.intensity=e||"balanced",this.flowSettings.intensity){case"minimal":this.flowSettings.flowStrength=.4,this.flowSettings.noiseScale=.8,this.flowSettings.waveHeight=[.3,.2],this.flowSettings.waveOffset=[1.5,-1],this.flowSettings.blurExp=1,this.flowSettings.blurMax=.4;break;case"balanced":this.flowSettings.flowStrength=.7,this.flowSettings.noiseScale=1.2,this.flowSettings.waveHeight=[.4,.3],this.flowSettings.waveOffset=[2.5,-1.8],this.flowSettings.blurExp=1.2,this.flowSettings.blurMax=.6;break;case"intense":this.flowSettings.flowStrength=1,this.flowSettings.noiseScale=1.6,this.flowSettings.waveHeight=[.5,.4],this.flowSettings.waveOffset=[3.5,-2.5],this.flowSettings.blurExp=1.4,this.flowSettings.blurMax=.8;break}}catch(e){u?.debug?.warn("WebGLGradientStrategy","Failed to load settings, using defaults:",e)}}async initializeWebGLGradient(){if(!this.webglState.isWebGLAvailable)throw new Error("WebGL2 not available");await this.createWebGLCanvas(),await this.initializeWebGLContext(),await this.compileWebGLShaders(),this.createWebGLGeometry(),this.setupWebGLUniforms(),this.resizeWebGLCanvas(),this.attachWebGLToDom(),window.addEventListener("resize",this.resizeWebGLCanvas.bind(this)),this.webglState.webglReady=!0;try{let e=T();e.setPerformanceTokens({webglReady:!0,activeBackend:"webgl-strategy",qualityLevel:"high",gpuAcceleration:!0}),u?.debug?.log("WebGLGradientStrategy","\u{1F3A8} WebGL readiness announced to CSS consciousness system - CSS Variables Set",{webglReady:!0,activeBackend:"webgl-strategy",qualityLevel:"high",gpuAcceleration:!0,cssControllerReady:!!e})}catch(e){u?.debug?.warn("WebGLGradientStrategy","\u274C Failed to announce WebGL readiness - CSS Variables NOT Set:",e)}u?.debug?.log("WebGLGradientStrategy","WebGL gradient system initialized successfully")}async createWebGLCanvas(){u?.debug?.log("WebGLGradientStrategy","\u{1F3A8} Creating WebGL canvas and wrapper elements"),this.webglState.wrapper=document.createElement("div"),this.webglState.wrapper.className="sn-webgl-gradient-wrapper",this.webglState.wrapper.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -11;
      pointer-events: none;
      overflow: hidden;
    `,this.webglState.canvas=document.createElement("canvas"),this.webglState.canvas.id="sn-webgl-gradient-strategy",this.webglState.canvas.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    `,this.webglState.wrapper.appendChild(this.webglState.canvas),u?.debug?.log("WebGLGradientStrategy","\u2705 WebGL canvas and wrapper created successfully",{wrapperId:this.webglState.wrapper.className,canvasId:this.webglState.canvas.id,wrapperStyle:this.webglState.wrapper.style.cssText.replace(/\s+/g," ").trim()})}async initializeWebGLContext(){if(!this.webglState.canvas)throw new Error("Canvas not created");if(this.webglState.gl=this.webglState.canvas.getContext("webgl2",{alpha:!0,antialias:!1,depth:!1,stencil:!1,powerPreference:"default"}),!this.webglState.gl)throw new Error("Failed to get WebGL2 context")}async compileWebGLShaders(){if(!this.webglState.gl)throw new Error("WebGL context not available");let e=te.loadVertex(this.webglState.gl,vt),t=te.loadFragment(this.webglState.gl,ac);if(!e||!t)throw new Error("Failed to compile shaders");if(this.webglState.shaderProgram=te.createProgram(this.webglState.gl,e,t),!this.webglState.shaderProgram)throw new Error("Failed to create shader program")}createWebGLGeometry(){if(!this.webglState.gl||!this.webglState.shaderProgram)return;let e=new Float32Array([-1,-1,3,-1,-1,3]);this.webglState.vertexBuffer=this.webglState.gl.createBuffer(),this.webglState.gl.bindBuffer(this.webglState.gl.ARRAY_BUFFER,this.webglState.vertexBuffer),this.webglState.gl.bufferData(this.webglState.gl.ARRAY_BUFFER,e,this.webglState.gl.STATIC_DRAW),this.webglState.vao=this.webglState.gl.createVertexArray(),this.webglState.gl.bindVertexArray(this.webglState.vao);let t=this.webglState.gl.getAttribLocation(this.webglState.shaderProgram,"a_position");this.webglState.gl.enableVertexAttribArray(t),this.webglState.gl.vertexAttribPointer(t,2,this.webglState.gl.FLOAT,!1,0,0),this.webglState.gl.bindVertexArray(null)}setupWebGLUniforms(){!this.webglState.gl||!this.webglState.shaderProgram||(this.uniforms.u_time=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_time"),this.uniforms.u_gradientTex=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_gradientTex"),this.uniforms.u_resolution=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_resolution"),this.uniforms.u_flowStrength=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_flowStrength"),this.uniforms.u_noiseScale=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_noiseScale"),this.uniforms.u_waveY=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_waveY"),this.uniforms.u_waveHeight=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_waveHeight"),this.uniforms.u_waveOffset=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_waveOffset"),this.uniforms.u_blurExp=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_blurExp"),this.uniforms.u_blurMax=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_blurMax"))}createGradientStops(e,t={}){let i=["PRIMARY","VIBRANT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT","DARK_VIBRANT","PROMINENT"],n=[],r=new Set,a=0;for(let s of i){let o=e[s];if(o&&!r.has(o)){let l=t[s],m=l?l.enhancedHex:o,d=this.utils.hexToRgb(m);if(d&&(n.push({r:d.r/255,g:d.g/255,b:d.b/255,a:1,position:a/(Math.min(i.length,4)-1),...l&&{oklabOriginal:l.originalHex,oklabEnhanced:l.enhancedHex}}),r.add(o),a++,n.length>=4))break}}return n.length===0?this.getDefaultGradientStops():n}getDefaultGradientStops(){return[{r:.196,g:.165,b:.282,a:1,position:0},{r:.549,g:.408,b:.878,a:1,position:.3},{r:.788,g:.557,b:.902,a:1,position:.6},{r:.957,g:.761,b:.494,a:1,position:1}]}async updateGradientTexture(e){if(this.webglState.gl){if(this.webglState.gradientTexture&&this.webglState.gl.deleteTexture(this.webglState.gradientTexture),this.webglState.gradientTexture=oe(this.webglState.gl,e),!this.webglState.gradientTexture)throw new Error("Failed to create gradient texture");await this.updateCSSFallbackVariables(e)}}async updateCSSFallbackVariables(e){let t=Math.min(8,e.length),i={"--sn-grad-stop-count":String(t)};for(let n=0;n<t;n++){let r=e[n];r&&(i[`--sn-grad-stop-${n}-rgb`]=`${Math.round(r.r*255)},${Math.round(r.g*255)},${Math.round(r.b*255)}`)}await this.cssController.batchSetVariables("WebGLGradientStrategy",i,"normal","gradient-stops-configuration")}async enableHybridCoordination(){let e={"--sn-webgl-ready":"1","--sn-webgl-enabled":"1","--sn-current-backend":"hybrid","--sn-gradient-crossfade-opacity":"0.5"};u?.debug?.log("WebGLGradientStrategy","\u{1F517} Setting hybrid coordination CSS variables - WebGL Gradient Activation",{variables:e,cssControllerReady:!!this.cssController}),await this.cssController.batchSetVariables("WebGLGradientStrategy",e,"high","hybrid-coordination-enable"),u?.debug?.log("WebGLGradientStrategy","\u2705 Hybrid coordination CSS variables set successfully")}startWebGLAnimation(){this.webglState.startTime=performance.now(),this.webglState.lastFrameTime=this.webglState.startTime,this.animateWebGL()}updateUniformsWithLERP(e){this.webglState.targetFlowStrength=this.flowSettings.flowStrength,this.webglState.targetNoiseScale=this.flowSettings.noiseScale,this.webglState.targetBlurExp=this.flowSettings.blurExp,this.webglState.targetBlurMax=this.flowSettings.blurMax,this.webglState.targetWaveY=[this.flowSettings.waveY[0],this.flowSettings.waveY[1]],this.webglState.targetWaveHeight=[this.flowSettings.waveHeight[0],this.flowSettings.waveHeight[1]],this.webglState.targetWaveOffset=[this.flowSettings.waveOffset[0],this.flowSettings.waveOffset[1]],this.webglState.currentFlowStrength=H(this.webglState.currentFlowStrength,this.webglState.targetFlowStrength,e,this.lerpHalfLifeValues.flowStrength),this.webglState.currentNoiseScale=H(this.webglState.currentNoiseScale,this.webglState.targetNoiseScale,e,this.lerpHalfLifeValues.noiseScale),this.webglState.currentBlurExp=H(this.webglState.currentBlurExp,this.webglState.targetBlurExp,e,this.lerpHalfLifeValues.blur),this.webglState.currentBlurMax=H(this.webglState.currentBlurMax,this.webglState.targetBlurMax,e,this.lerpHalfLifeValues.blur);let t=0,i=1;this.webglState.currentWaveY[t]=H(this.webglState.currentWaveY[t],this.webglState.targetWaveY[t],e,this.lerpHalfLifeValues.wave),this.webglState.currentWaveY[i]=H(this.webglState.currentWaveY[i],this.webglState.targetWaveY[i],e,this.lerpHalfLifeValues.wave),this.webglState.currentWaveHeight[t]=H(this.webglState.currentWaveHeight[t],this.webglState.targetWaveHeight[t],e,this.lerpHalfLifeValues.wave),this.webglState.currentWaveHeight[i]=H(this.webglState.currentWaveHeight[i],this.webglState.targetWaveHeight[i],e,this.lerpHalfLifeValues.wave),this.webglState.currentWaveOffset[t]=H(this.webglState.currentWaveOffset[t],this.webglState.targetWaveOffset[t],e,this.lerpHalfLifeValues.wave),this.webglState.currentWaveOffset[i]=H(this.webglState.currentWaveOffset[i],this.webglState.targetWaveOffset[i],e,this.lerpHalfLifeValues.wave)}renderWebGLFrame(e){if(!this.webglState.gl||!this.webglState.shaderProgram||!this.webglState.vao||!this.webglState.gradientTexture)return;let t=(e-this.webglState.lastFrameTime)/1e3;this.updateUniformsWithLERP(t),this.webglState.gl.viewport(0,0,this.webglState.canvas.width,this.webglState.canvas.height),this.webglState.gl.clearColor(0,0,0,0),this.webglState.gl.clear(this.webglState.gl.COLOR_BUFFER_BIT),this.webglState.gl.useProgram(this.webglState.shaderProgram),this.webglState.gl.bindVertexArray(this.webglState.vao);let i=this.prefersReducedMotion?0:(e-this.webglState.startTime)/1e3;this.uniforms.u_time&&this.webglState.gl.uniform1f(this.uniforms.u_time,i),this.uniforms.u_resolution&&this.webglState.gl.uniform2f(this.uniforms.u_resolution,this.webglState.canvas.width,this.webglState.canvas.height),this.uniforms.u_flowStrength&&this.webglState.gl.uniform1f(this.uniforms.u_flowStrength,this.webglState.currentFlowStrength),this.uniforms.u_noiseScale&&this.webglState.gl.uniform1f(this.uniforms.u_noiseScale,this.webglState.currentNoiseScale),this.uniforms.u_waveY&&this.webglState.gl.uniform1fv(this.uniforms.u_waveY,this.webglState.currentWaveY),this.uniforms.u_waveHeight&&this.webglState.gl.uniform1fv(this.uniforms.u_waveHeight,this.webglState.currentWaveHeight),this.uniforms.u_waveOffset&&this.webglState.gl.uniform1fv(this.uniforms.u_waveOffset,this.webglState.currentWaveOffset),this.uniforms.u_blurExp&&this.webglState.gl.uniform1f(this.uniforms.u_blurExp,this.webglState.currentBlurExp),this.uniforms.u_blurMax&&this.webglState.gl.uniform1f(this.uniforms.u_blurMax,this.webglState.currentBlurMax),this.webglState.gl.activeTexture(this.webglState.gl.TEXTURE0),this.webglState.gl.bindTexture(this.webglState.gl.TEXTURE_2D,this.webglState.gradientTexture),this.uniforms.u_gradientTex&&this.webglState.gl.uniform1i(this.uniforms.u_gradientTex,0),this.webglState.gl.drawArrays(this.webglState.gl.TRIANGLES,0,3),this.webglState.gl.bindVertexArray(null)}async updateFlowWithMusicEnergy(e){let t=this.flowSettings.flowStrength,i=1+e*.5,n=t*i;await this.cssController.setVariable("WebGLGradientStrategy","--sn-flow-strength",n.toString(),"high","music-energy-flow-strength")}attachWebGLToDom(){if(!this.webglState.wrapper){u?.debug?.error("WebGLGradientStrategy","\u274C Cannot attach to DOM - wrapper element not created");return}u?.debug?.log("WebGLGradientStrategy","\u{1F517} Attaching WebGL canvas to DOM - Searching for container");let e=[".Root__main-view",".main-view-container",".main-gridContainer-gridContainer",".Root__top-container","body"],t=null,i=[];for(let n of e)if(t=document.querySelector(n),i.push({selector:n,found:!!t}),t)break;t||(t=document.body),t.appendChild(this.webglState.wrapper),u?.debug?.log("WebGLGradientStrategy","\u2705 WebGL canvas attached to DOM successfully",{containerSearch:i,selectedContainer:t?.tagName||"unknown",containerClass:t?.className||"none",wrapperId:this.webglState.wrapper.className,canvasId:this.webglState.canvas?.id||"not-created"})}async executeProgressiveFallback(e,t){let i=this.selectPrimaryColor(e.rawColors)||j.getDefaultAccentColor().hex;try{return u?.debug?.warn("WebGLGradientStrategy","Attempting CSS gradient fallback"),await this.fallbackToCSSGradient(),{processedColors:{...e.rawColors,fallbackMethod:"css-gradient"},accentHex:i,accentRgb:this.convertToRgbString(i),metadata:{strategy:this.getStrategyName(),processingTime:0,fallbackMode:"css-gradient",fallbackReason:"webgl-failed",gradientStops:Object.keys(e.rawColors).length},context:e}}catch(n){return u?.debug?.error("WebGLGradientStrategy","CSS gradient fallback failed, using solid color:",n),await this.fallbackToSolidColor(e,i,t,n)}}async fallbackToSolidColor(e,t,i,n){try{return await this.cssController?.queueUpdate("--sn-accent-color",t,"critical","solid-color-fallback"),{processedColors:{accentColor:t,fallbackMethod:"solid-color",originalColors:JSON.stringify(e.rawColors)},accentHex:t,accentRgb:this.convertToRgbString(t),metadata:{strategy:this.getStrategyName(),processingTime:0,fallbackMode:"solid-color",fallbackReason:"all-gradients-failed",webglError:i instanceof Error?i.message:"Unknown WebGL error",cssError:n instanceof Error?n.message:"Unknown CSS error",emergencyMode:!0},context:e}}catch(r){return u?.debug?.error("WebGLGradientStrategy","All fallback methods failed, using emergency mode:",r),{processedColors:{emergencyMode:"true"},accentHex:"#ff6b9d",accentRgb:"rgb(255, 107, 157)",metadata:{strategy:this.getStrategyName(),processingTime:0,fallbackMode:"emergency",fallbackReason:"complete-system-failure",criticalError:!0},context:e}}}async fallbackToCSSGradient(){let e={"--sn-webgl-ready":"0","--sn-webgl-enabled":"0","--sn-current-backend":"css","--sn-gradient-crossfade-opacity":"0"};await this.cssController.batchSetVariables("WebGLGradientStrategy",e,"critical","css-gradient-fallback"),this.cssController&&this.startCSSFallbackAnimation(),u?.debug?.log("WebGLGradientStrategy","Using CSS gradient fallback")}startCSSFallbackAnimation(){if(!this.cssController)return;let e=()=>{if(!this.webglState.webglReady)return;let t=performance.now()/1e3,i=Math.sin(t*.04)*20+Math.sin(t*.07)*8,n=Math.cos(t*.05)*20+Math.cos(t*.09)*6,r=1.15+Math.sin(t*.03)*.2;this.cssController.queueCSSVariableUpdate("--sn-gradient-flow-x",`${i}%`),this.cssController.queueCSSVariableUpdate("--sn-gradient-flow-y",`${n}%`),this.cssController.queueCSSVariableUpdate("--sn-gradient-flow-scale",r.toString()),setTimeout(e,this.flowSettings.frameThrottleInterval)};e()}selectPrimaryColor(e){let t=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let i of t){let n=e[i];if(n&&this.utils.hexToRgb(n))return n}return null}convertToRgbString(e){let t=this.utils.hexToRgb(e);return t?`${t.r},${t.g},${t.b}`:"203,166,247"}updateConfig(e){this.flowSettings={...this.flowSettings,...e},("oklabProcessingEnabled"in e||"oklabPreset"in e)&&(this.oklabProcessor=new M(this.config.enableDebug)),u?.debug?.log("WebGLGradientStrategy","Configuration updated:",{...e,oklabProcessing:this.flowSettings.oklabProcessingEnabled,oklabPreset:this.flowSettings.oklabPreset,gradientTextureSize:this.flowSettings.gradientTextureSize})}async healthCheck(){let e=Date.now()-this.webglState.lastUpdateTime<3e4;return{healthy:this.webglState.webglReady&&this.flowSettings.enabled,canProcess:this.canProcess({}),issues:this.webglState.webglReady?this.flowSettings.enabled?[]:["WebGL gradient disabled in settings"]:["WebGL system not ready"],metrics:{webglAvailable:this.webglState.isWebGLAvailable,webglReady:this.webglState.webglReady,flowEnabled:this.flowSettings.enabled,intensity:this.flowSettings.intensity,deviceCapability:this.deviceDetector.recommendPerformanceQuality(),hasRecentUpdate:e,animationActive:this.webglState.animationId!==null,oklabProcessing:this.flowSettings.oklabProcessingEnabled,oklabPreset:this.flowSettings.oklabPreset,gradientTextureSize:this.flowSettings.gradientTextureSize,canvasSize:this.webglState.canvas?{width:this.webglState.canvas.width,height:this.webglState.canvas.height}:null}}}destroy(){this.webglState.animationId&&(cancelAnimationFrame(this.webglState.animationId),this.webglState.animationId=null),this.webglState.gl&&(this.webglState.gradientTexture&&(this.webglState.gl.deleteTexture(this.webglState.gradientTexture),this.webglState.gradientTexture=null),this.webglState.vertexBuffer&&(this.webglState.gl.deleteBuffer(this.webglState.vertexBuffer),this.webglState.vertexBuffer=null),this.webglState.vao&&(this.webglState.gl.deleteVertexArray(this.webglState.vao),this.webglState.vao=null),this.webglState.shaderProgram&&(this.webglState.gl.deleteProgram(this.webglState.shaderProgram),this.webglState.shaderProgram=null),te.clearCache(this.webglState.gl)),this.webglState.wrapper&&this.webglState.wrapper.parentNode&&(this.webglState.wrapper.parentNode.removeChild(this.webglState.wrapper),this.webglState.wrapper=null),this.webglState.canvas=null,this.webglState.gl=null,this.webglState.webglReady=!1,window.removeEventListener("resize",this.resizeWebGLCanvas);let e={"--sn-webgl-ready":"0","--sn-webgl-enabled":"0","--sn-current-backend":"css","--sn-gradient-crossfade-opacity":"0"};this.cssController.batchSetVariables("WebGLGradientStrategy",e,"critical","strategy-destroy-cleanup").catch(t=>{u?.debug?.error("WebGLGradientStrategy","Error during destroy cleanup:",t)}),u?.debug?.log("WebGLGradientStrategy","WebGL gradient strategy destroyed")}}});var at,Rn=b(()=>{"use strict";ue();R();fe();Ta();xa();An();Ia();at=class{constructor(){this.strategyInstances=new Map;this.strategyMetadata=new Map;this.deviceDetector=new N,this.initializeStrategyMetadata(),u?.debug?.log("BackgroundStrategySelector","Strategy selector initialized")}initializeStrategyMetadata(){this.strategyMetadata.set("dynamic-catppuccin",{name:"dynamic-catppuccin",priority:10,estimatedProcessingTime:5,memoryImpact:2,qualityScore:9,compatibilityScore:10}),this.strategyMetadata.set("living-gradient",{name:"living-gradient",priority:8,estimatedProcessingTime:8,memoryImpact:3,qualityScore:8,compatibilityScore:9}),this.strategyMetadata.set("webgl-gradient",{name:"webgl-gradient",priority:6,estimatedProcessingTime:12,memoryImpact:7,qualityScore:10,compatibilityScore:6}),this.strategyMetadata.set("webgl-gradient-degraded",{name:"webgl-gradient-degraded",priority:5,estimatedProcessingTime:8,memoryImpact:4,qualityScore:6,compatibilityScore:8}),this.strategyMetadata.set("depth-layered",{name:"depth-layered",priority:7,estimatedProcessingTime:15,memoryImpact:5,qualityScore:9,compatibilityScore:7})}selectStrategies(e,t){let i=performance.now(),n=[];try{let r=t.deviceContext||this.buildDeviceContext(),a=t.settingsContext||this.buildSettingsContext();u?.debug?.log("BackgroundStrategySelector","\u{1F3AF} Strategy Selection Debug - WebGL Gradient Analysis",{trackUri:e.trackUri,colorCount:Object.keys(e.rawColors).length,deviceContext:{supportsWebGL:r.supportsWebGL,performanceLevel:r.performanceLevel,memoryCapacity:r.memoryCapacity,isMobile:r.isMobile},settingsContext:{webglEnabled:a.webglEnabled,webglForceEnabled:a.webglForceEnabled,gradientIntensity:a.gradientIntensity,consciousnessLevel:a.consciousnessLevel}});let s=this.analyzeStrategyCompatibility(e,{...t,deviceContext:r,settingsContext:a});for(let l of s)if(u?.debug?.log("BackgroundStrategySelector",`Strategy decision: ${l.strategyName}`,{shouldInclude:l.shouldInclude,reason:l.reason,score:l.score}),l.shouldInclude){let m=this.getOrCreateStrategy(l.strategyName);if(m){let d=m.canProcess(e);u?.debug?.log("BackgroundStrategySelector",`Strategy ${l.strategyName} canProcess check`,{canProcess:d,strategyName:l.strategyName,contextColors:Object.keys(e.rawColors).length}),d?(n.push(m),u?.debug?.log("BackgroundStrategySelector",`\u2705 Selected strategy: ${l.strategyName}`)):u?.debug?.warn("BackgroundStrategySelector",`\u274C Strategy rejected by canProcess(): ${l.strategyName}`)}else u?.debug?.error("BackgroundStrategySelector",`Failed to create strategy: ${l.strategyName}`)}if(n.length===0){let l=this.getOrCreateStrategy("living-gradient");l?.canProcess(e)&&n.push(l)}let o=performance.now()-i;return u?.debug?.log("BackgroundStrategySelector","\u{1F3AF} Strategy selection completed",{selectedCount:n.length,strategies:n.map(l=>l.getStrategyName()),processingTime:o,deviceLevel:r.performanceLevel,visualGuideMode:a.visualGuideMode,webglEnabled:a.webglEnabled,webglForceEnabled:a.webglForceEnabled,supportsWebGL:r.supportsWebGL,totalDecisions:s.length,includedDecisions:s.filter(l=>l.shouldInclude).length}),n}catch(r){u?.debug?.error("BackgroundStrategySelector","Strategy selection failed:",r);let a=this.getOrCreateStrategy("living-gradient");return a?[a]:[]}}analyzeStrategyCompatibility(e,t){let i=[],n=this.scoreDynamicCatppuccinStrategy(t);i.push({strategyName:"dynamic-catppuccin",shouldInclude:t.settingsContext.dynamicAccentEnabled&&n>.5,reason:t.settingsContext.dynamicAccentEnabled?`Dynamic accent enabled (score: ${n.toFixed(2)})`:"Dynamic accent disabled in settings",score:n});let r=this.scoreLivingGradientStrategy(t);i.push({strategyName:"living-gradient",shouldInclude:r>.3,reason:`Living gradient foundation (score: ${r.toFixed(2)})`,score:r});let a=this.scoreWebGLGradientStrategy(t),s=this.scoreWebGLDegradedStrategy(t),o=t.settingsContext.webglEnabled&&t.deviceContext.supportsWebGL&&(t.deviceContext.performanceLevel!=="low"||t.settingsContext.webglForceEnabled)&&a>.6;i.push({strategyName:"webgl-gradient",shouldInclude:o,reason:`WebGL full quality (score: ${a.toFixed(2)}, device: ${t.deviceContext.performanceLevel}${t.settingsContext.webglForceEnabled?", FORCED":""})`,score:a}),i.push({strategyName:"webgl-gradient-degraded",shouldInclude:t.settingsContext.webglEnabled&&t.deviceContext.supportsWebGL&&t.deviceContext.performanceLevel==="low"&&!t.settingsContext.webglForceEnabled&&s>.4,reason:`WebGL degraded mode (score: ${s.toFixed(2)}, device: low${t.settingsContext.webglForceEnabled?", skipped due to force":""})`,score:s});let l=this.scoreDepthLayeredStrategy(t);return i.push({strategyName:"depth-layered",shouldInclude:t.settingsContext.depthLayersEnabled&&t.settingsContext.consciousnessLevel>.4&&t.deviceContext.performanceLevel!=="low"&&l>.5,reason:`Depth consciousness (score: ${l.toFixed(2)}, consciousness: ${t.settingsContext.consciousnessLevel})`,score:l}),i}scoreDynamicCatppuccinStrategy(e){let t=.8;return e.settingsContext.dynamicAccentEnabled&&(t+=.2),e.musicContext?.energy&&e.musicContext.energy>.7&&(t+=.1),["cosmic","cinematic","ethereal","natural"].includes(e.settingsContext.visualGuideMode)&&(t+=.1),t+=.1,Math.min(1,t)}scoreLivingGradientStrategy(e){let t=.9;return e.settingsContext.breathingAnimationEnabled&&(t+=.1),t+=e.settingsContext.consciousnessLevel*.2,e.musicContext?.valence!==void 0&&(t+=.05),e.deviceContext.performanceLevel==="high"&&(t+=.05),Math.min(1,t)}scoreWebGLGradientStrategy(e){let t=0;if(!e.deviceContext.supportsWebGL||!e.settingsContext.webglEnabled)return 0;switch(t=.6,e.settingsContext.webglForceEnabled&&(t+=.4,u?.debug?.log("BackgroundStrategySelector","WebGL force enabled - boosting score by 0.4")),e.deviceContext.performanceLevel){case"high":t+=.3;break;case"medium":t+=.2;break;case"low":if(!e.settingsContext.webglForceEnabled)return 0;t+=.1;break}return e.deviceContext.memoryCapacity>4e3&&(t+=.1),e.deviceContext.memoryCapacity>8e3&&(t+=.1),e.settingsContext.consciousnessLevel>.7&&(t+=.1),e.musicContext?.energy&&e.musicContext.energy>.8&&(t+=.1),e.deviceContext.isMobile&&(t-=.2),Math.min(1,Math.max(0,t))}scoreWebGLDegradedStrategy(e){let t=0;return!e.deviceContext.supportsWebGL||!e.settingsContext.webglEnabled||e.deviceContext.performanceLevel!=="low"?0:(t=.5,t+=.3,e.settingsContext.consciousnessLevel>.5&&(t+=.1),e.musicContext?.energy&&e.musicContext.energy>.6&&(t+=.05),e.deviceContext.isMobile&&(t-=.1),e.deviceContext.memoryCapacity>2e3&&(t+=.05),Math.min(1,Math.max(0,t)))}scoreDepthLayeredStrategy(e){let t=0;if(!e.settingsContext.depthLayersEnabled)return 0;switch(t=.5,t+=e.settingsContext.consciousnessLevel*.4,e.deviceContext.performanceLevel){case"high":t+=.2;break;case"medium":t+=.1;break;case"low":return t=0,0}return["cosmic","cinematic"].includes(e.settingsContext.visualGuideMode)&&(t+=.2),e.musicContext?.tempo&&e.musicContext.tempo<100&&(t+=.1),e.deviceContext.memoryCapacity>6e3&&(t+=.1),e.deviceContext.isMobile&&(t-=.15),Math.min(1,Math.max(0,t))}buildDeviceContext(){let e=window.navigator.deviceMemory?window.navigator.deviceMemory*1024:4096,t=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);return{supportsWebGL:this.deviceDetector.hasWebGLSupport(),performanceLevel:this.deviceDetector.recommendPerformanceQuality(),memoryCapacity:e,isMobile:t}}buildSettingsContext(){try{return{dynamicAccentEnabled:!0,gradientIntensity:x.get("sn-gradient-intensity"),webglEnabled:x.get("sn-webgl-enabled"),webglForceEnabled:x.get("sn-webgl-enabled"),visualGuideMode:x.get("sn-artistic-mode"),depthLayersEnabled:x.get("sn-gradient-intensity")!=="disabled",consciousnessLevel:.8,breathingAnimationEnabled:!0}}catch(e){return u?.debug?.warn("BackgroundStrategySelector","Failed to load settings, using defaults:",e),{dynamicAccentEnabled:!0,gradientIntensity:"balanced",webglEnabled:!0,webglForceEnabled:!1,visualGuideMode:"cosmic",depthLayersEnabled:!0,consciousnessLevel:.8,breathingAnimationEnabled:!0}}}getOrCreateStrategy(e){if(this.strategyInstances.has(e))return this.strategyInstances.get(e);let t=null;try{switch(e){case"dynamic-catppuccin":t=new li;break;case"living-gradient":t=new St;break;case"webgl-gradient":t=new Mt;break;case"webgl-gradient-degraded":t=new Mt;break;case"depth-layered":t=new ci;break;default:return u?.debug?.warn("BackgroundStrategySelector",`Unknown strategy: ${e}`),null}t&&(this.strategyInstances.set(e,t),u?.debug?.log("BackgroundStrategySelector",`Created strategy instance: ${e}`))}catch(i){return u?.debug?.error("BackgroundStrategySelector",`Failed to create strategy ${e}:`,i),null}return t}getEstimatedProcessingTime(e,t){return e.reduce((i,n)=>i+n.getEstimatedProcessingTime(t),0)}getStrategyMetadata(e){return this.strategyMetadata.get(e)||null}getAvailableStrategyNames(){return Array.from(this.strategyMetadata.keys())}updateSelectionCriteria(e){u?.debug?.log("BackgroundStrategySelector","Strategy selection criteria updated:",e)}destroy(){this.strategyInstances.forEach((e,t)=>{if("destroy"in e&&typeof e.destroy=="function")try{e.destroy()}catch(i){u?.debug?.warn("BackgroundStrategySelector",`Error destroying strategy ${t}:`,i)}}),this.strategyInstances.clear(),this.strategyMetadata.clear(),u?.debug?.log("BackgroundStrategySelector","Strategy selector destroyed")}}});var kn,Dn,st,ui=b(()=>{"use strict";U();D();ue();R();De();ne();K();Rn();kn=class{constructor(){this.strategies=new Map;this.defaultStrategy=null}register(e){let t=e.getStrategyName();this.strategies.set(t,e),this.defaultStrategy||(this.defaultStrategy=e),u?.debug?.log("ColorStrategyRegistry",`Registered strategy: ${t}`)}selectStrategy(e){if(e.performance==="high"&&e.quality==="basic")for(let t of this.strategies.values()){let i=t.getStrategyName().toLowerCase();if(i.includes("lightweight")||i.includes("fast"))return t}if(e.quality==="premium"&&e.performance==="low")for(let t of this.strategies.values()){let i=t.getStrategyName().toLowerCase();if(i.includes("harmony")||i.includes("advanced"))return t}if(e.deviceCapabilities?.isMobile)for(let t of this.strategies.values()){let i=t.getStrategyName().toLowerCase();if(i.includes("mobile")||i.includes("optimized"))return t}return this.defaultStrategy}getStrategies(){return Array.from(this.strategies.values())}getStrategy(e){return this.strategies.get(e)||null}setDefaultStrategy(e){this.defaultStrategy=e}getStatus(){return{strategyCount:this.strategies.size,strategies:Array.from(this.strategies.keys()),defaultStrategy:this.defaultStrategy?.getStrategyName()||null}}},Dn=class{constructor(){this.systemName="ColorCoordinator";this.initialized=!1;this.isInitialized=!1;this.processingQueue=[];this.isProcessing=!1;this.currentStrategy=null;this.oklabCoordinationEnabled=!0;this.processedContexts=new Map;this.CONTEXT_CACHE_TTL=2e3;this.MAX_QUEUE_SIZE=10;this.resultCache=new Map;this.cacheMaxSize=50;this.cacheTimeoutMs=3e5;this.orchestrationMetrics={totalProcessingTime:0,strategiesProcessed:0,strategiesSucceeded:0,strategiesFailed:0,cacheHits:0,averageStrategyTime:0,memoryUsage:0,oklabCoordinations:0,oklabProcessingTime:0};this.processedCount=0;this.totalProcessingTime=0;this.lastProcessingTime=0;this.registry=new kn,this.settingsManager=new ee;let e=globalThis.year3000System;this.performanceAnalyzer=e?.performanceAnalyzer||e?.facadeCoordinator?.getCachedNonVisualSystem?.("SimplePerformanceCoordinator")||null,this.deviceDetector=new N,this.strategySelector=new at,this.oklabProcessor=new M(w.enableDebug),this.selectionCriteria={performance:"medium",quality:"enhanced",deviceCapabilities:{hasWebGL:!!window.WebGLRenderingContext,memoryMB:this.estimateMemoryMB(),isMobile:this.detectMobile()},userPreferences:{harmonicMode:"cosmic",intensity:.8,enableAdvancedBlending:!0}},this.updateDeviceCapabilities(),u?.debug?.log("ColorOrchestrator","Enhanced color orchestrator created with multi-strategy coordination")}async initialize(){if(this.isInitialized){u?.debug?.warn("ColorOrchestrator","Already initialized");return}try{p.subscribe("colors:extracted",this.handleColorExtractionEvent.bind(this),"ColorOrchestrator"),this.updateDeviceCapabilities(),this.loadUserPreferences(),await this.registerDefaultStrategies(),this.isInitialized=!0,this.initialized=!0,u?.debug?.log("ColorOrchestrator","Enhanced color orchestrator initialized",{strategies:this.registry.getStatus().strategyCount,criteria:this.selectionCriteria,oklabEnabled:this.oklabCoordinationEnabled,deviceLevel:this.deviceDetector.recommendPerformanceQuality()})}catch(e){throw u?.debug?.error("ColorOrchestrator","Enhanced initialization failed:",e),e}}async handleColorExtractionEvent(e){let t=e;await this.handleColorExtraction(t)}async handleColorExtraction(e){let t=Date.now(),i=e.trackUri||"unknown";u?.debug?.log("ColorOrchestrator","\u{1F3B5} Color Extraction Event Received - WebGL Gradient Entry Point",{trackUri:i,rawColors:e.rawColors,colorCount:Object.keys(e.rawColors).length,isProcessing:this.isProcessing,queueLength:this.processingQueue.length,entryPoint:"handleColorExtraction"});let n=this.processedContexts.get(i);if(n&&t-n<this.CONTEXT_CACHE_TTL){u?.debug?.warn("ColorOrchestrator",`Skipping recent context to prevent recursion: ${i}`,{lastProcessed:new Date(n).toISOString(),timeDiff:t-n});return}let r=this.generateCacheKey(e),a=this.getCachedResult(r);if(a){this.orchestrationMetrics.cacheHits++,await this.applyColorResult(a),u?.debug?.log("ColorOrchestrator","Using cached color result",{cacheKey:r});return}this.processingQueue.length>=this.MAX_QUEUE_SIZE&&(u?.debug?.warn("ColorOrchestrator",`Queue overflow protection: dropping context ${i}`,{queueSize:this.processingQueue.length,maxSize:this.MAX_QUEUE_SIZE}),this.processingQueue.shift()),this.cleanupProcessedContexts(t),this.processingQueue.push(e),this.isProcessing||await this.processQueue()}async processQueue(){if(!(this.isProcessing||this.processingQueue.length===0)){this.isProcessing=!0;try{for(;this.processingQueue.length>0;){let e=this.processingQueue.shift();await this.processColorContext(e)}}catch(e){u?.debug?.error("ColorOrchestrator","Queue processing failed:",e)}finally{this.isProcessing=!1,this.currentStrategy=null}}}cleanupProcessedContexts(e){for(let[t,i]of this.processedContexts.entries())e-i>this.CONTEXT_CACHE_TTL&&this.processedContexts.delete(t)}async processColorContext(e){let t=performance.now(),i=e.trackUri||"unknown";u?.debug?.log("ColorOrchestrator","\u{1F3A8} Processing Color Context - WebGL Gradient Recovery Debug",{trackUri:i,rawColors:e.rawColors,colorCount:Object.keys(e.rawColors).length,musicData:e.musicData,timestamp:new Date().toISOString()});try{let n=this.strategySelector.selectStrategies(e,this.buildStrategySelectionCriteria(e));if(n.length===0){let l=this.selectStrategy(e);if(l)n.push(l);else throw new Error("No suitable strategies selected for color processing")}let r=await this.processWithStrategies(e,n);this.oklabCoordinationEnabled&&r.filter(l=>l.success).length>1&&await this.coordinateOKLABProcessing(r,e);let a=this.mergeStrategyResults(r,e),s=this.generateCacheKey(e);this.cacheResult(s,a),await this.applyColorResult(a),this.processedContexts.set(i,Date.now());let o=performance.now()-t;this.updateOrchestrationMetrics(r,o),this.lastProcessingTime=o,this.totalProcessingTime+=o,this.processedCount++,u?.debug?.log("ColorOrchestrator","Enhanced color processing completed",{strategies:n.map(l=>l.getStrategyName()),processingTime:o,trackUri:e.trackUri,oklabCoordination:this.oklabCoordinationEnabled,successfulStrategies:r.filter(l=>l.success).length})}catch(n){let r=performance.now();this.lastProcessingTime=r-t,u?.debug?.error("ColorOrchestrator","Enhanced color processing failed:",{error:n,strategy:this.currentStrategy,trackUri:e.trackUri}),await this.applyFallbackColors(e)}}selectStrategy(e){let t={...this.selectionCriteria};return e.performanceHints&&(e.performanceHints.preferLightweight&&(t.performance="high",t.quality="basic"),e.performanceHints.enableAdvancedBlending&&(t.quality="premium")),e.musicData&&e.musicData.energy&&e.musicData.energy>.8&&(t.quality="premium"),this.registry.selectStrategy(t)}async registerDefaultStrategies(){u?.debug?.log("ColorOrchestrator","Default strategies registration completed")}async processWithStrategies(e,t){let i=[],n=t.map(async a=>{let s=performance.now();this.currentStrategy=a.getStrategyName();try{let o=await a.processColors(e),l=performance.now()-s;return{strategy:a,result:o,processingTime:l,success:!0}}catch(o){let l=performance.now()-s;return u?.debug?.error("ColorOrchestrator",`Strategy ${a.getStrategyName()} failed:`,o),{strategy:a,result:this.createErrorResult(e,a,o),processingTime:l,success:!1,error:o instanceof Error?o.message:"Unknown error"}}});return await Promise.all(n)}mergeStrategyResults(e,t){let i=e.filter(r=>r.success);if(i.length===0)return this.createFallbackResult(t);if(i.length===1)return i[0].result;let n={priorityWeighting:!0,conflictResolution:"merge",preserveMetadata:!0,consciousnessBlending:!0,oklabCoordination:this.oklabCoordinationEnabled};return this.performResultMerge(i,t,n)}performResultMerge(e,t,i){let n=e.sort((s,o)=>{let l=this.strategySelector.getStrategyMetadata(s.strategy.getStrategyName())?.priority||0;return(this.strategySelector.getStrategyMetadata(o.strategy.getStrategyName())?.priority||0)-l}),r=n[0].result,a={processedColors:{...r.processedColors},accentHex:r.accentHex,accentRgb:r.accentRgb,metadata:{...r.metadata,strategy:"enhanced-orchestrator",mergedStrategies:n.map(s=>s.strategy.getStrategyName()),totalProcessingTime:n.reduce((s,o)=>s+o.processingTime,0)},context:t};for(let s=1;s<n.length;s++){let o=n[s].result;if(Object.entries(o.processedColors).forEach(([l,m])=>{if(i.conflictResolution==="override")s===1&&(a.processedColors[l]=m);else if(i.conflictResolution==="merge"){let d=o.metadata.strategy;a.processedColors[`${d}-${l}`]=m}}),i.preserveMetadata){let l=o.metadata.strategy;a.metadata[`${l}-metadata`]=o.metadata}}return i.consciousnessBlending&&this.applyConsciousnessBlending(a,n),i.oklabCoordination&&this.applyOKLABCoordination(a,n),a}applyConsciousnessBlending(e,t){let i=0,n=0,r=0,a=0;if(t.forEach(s=>{let l=(this.strategySelector.getStrategyMetadata(s.strategy.getStrategyName())?.qualityScore||5)/10,m=this.hexToRgb(s.result.accentHex);m&&(n+=m.r*l,r+=m.g*l,a+=m.b*l,i+=l)}),i>0){let s=Math.round(n/i),o=Math.round(r/i),l=Math.round(a/i);e.accentHex=this.rgbToHex(s,o,l),e.accentRgb=`${s},${o},${l}`,e.metadata.consciousnessBlending={strategyCount:t.length,totalWeight:i,blendedAccent:e.accentHex}}}async coordinateOKLABProcessing(e,t){let i=performance.now();try{let n=e.filter(l=>l.success),r={};n.forEach(l=>{Object.entries(l.result.processedColors).forEach(([m,d])=>{d&&d.startsWith("#")&&(r[`${l.strategy.getStrategyName()}-${m}`]=d)})});let a=this.getOptimalOKLABPreset(t),s=this.oklabProcessor.processColorPalette(r,a);n.forEach(l=>{let m=l.strategy.getStrategyName();l.oklabData=Object.values(s).filter(d=>d.originalHex in r&&Object.keys(r).find(h=>h.startsWith(m)&&r[h]===d.originalHex))});let o=performance.now()-i;this.orchestrationMetrics.oklabCoordinations++,this.orchestrationMetrics.oklabProcessingTime+=o,u?.debug?.log("ColorOrchestrator","OKLAB coordination completed",{strategiesCoordinated:n.length,colorsProcessed:Object.keys(r).length,preset:a.name,processingTime:o})}catch(n){u?.debug?.error("ColorOrchestrator","OKLAB coordination failed:",n)}}applyOKLABCoordination(e,t){try{let i=[];if(t.forEach(r=>{r.oklabData&&i.push(...r.oklabData)}),i.length===0)return;let n=this.calculatePerceptuallyUniformAccent(i);if(n){e.accentHex=n.enhancedHex,e.accentRgb=`${n.enhancedRgb.r},${n.enhancedRgb.g},${n.enhancedRgb.b}`;let r=this.oklabProcessor.generateCSSVariables(n,"sn-oklab-unified");Object.entries(r).forEach(([a,s])=>{e.processedColors[a]=s}),e.metadata.oklabCoordination={enabled:!0,strategiesCoordinated:t.length,colorsProcessed:i.length,perceptualAccent:n.enhancedHex,lightness:n.oklabEnhanced.L,chroma:n.oklchEnhanced.C,hue:n.oklchEnhanced.H}}}catch(i){u?.debug?.error("ColorOrchestrator","OKLAB coordination application failed:",i)}}calculatePerceptuallyUniformAccent(e){if(e.length===0)return null;if(e.length===1)return e[0]||null;let t=0,i=0,n=0,r=0;if(e.forEach(m=>{let d=Math.sqrt(m.oklabEnhanced.a**2+m.oklabEnhanced.b**2),h=Math.max(.1,d);i+=m.oklabEnhanced.L*h,n+=m.oklabEnhanced.a*h,r+=m.oklabEnhanced.b*h,t+=h}),t===0)return e[0]||null;let a={L:i/t,a:n/t,b:r/t},s=vn(a.L,a.a,a.b),o=ye(s.r,s.g,s.b),l=M.getPreset("STANDARD");return this.oklabProcessor.processColor(o,l)}getStatus(){return{isProcessing:this.isProcessing,...this.currentStrategy?{currentStrategy:this.currentStrategy}:{},queueSize:this.processingQueue.length,processedContextsCount:this.processedContexts.size,maxQueueSize:this.MAX_QUEUE_SIZE,contextCacheTTL:this.CONTEXT_CACHE_TTL,orchestrationMetrics:{...this.orchestrationMetrics},oklabCoordinationEnabled:this.oklabCoordinationEnabled}}setSelectionCriteria(e){this.selectionCriteria={...this.selectionCriteria,...e},u?.debug?.log("ColorOrchestrator","Selection criteria updated",e)}getPerformanceMetrics(){return{processedCount:this.processedCount,averageProcessingTime:this.processedCount>0?this.totalProcessingTime/this.processedCount:0,lastProcessingTime:this.lastProcessingTime,totalProcessingTime:this.totalProcessingTime}}registerStrategy(e){this.registry.register(e)}getRegistry(){return this.registry}estimateMemoryMB(){let e=performance.memory;return e&&e.usedJSHeapSize&&e.jsHeapSizeLimit?(e.jsHeapSizeLimit-e.usedJSHeapSize)/(1024*1024):this.detectMobile()?256:1024}detectMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}buildStrategySelectionCriteria(e){return{...this.selectionCriteria,settingsContext:{dynamicAccentEnabled:this.settingsManager.get("sn-dynamic-accent-enabled")??!0,gradientIntensity:this.settingsManager.get("sn-gradient-intensity")??"balanced",webglEnabled:this.settingsManager.get("sn-webgl-enabled")??!0,visualGuideMode:this.settingsManager.get("sn-visual-guide-mode")??"cosmic",depthLayersEnabled:this.settingsManager.get("sn-depth-enabled")??!0,consciousnessLevel:this.settingsManager.get("sn-consciousness-level")??.8,breathingAnimationEnabled:this.settingsManager.get("sn-breathing-enabled")??!0},musicContext:e.musicData,deviceContext:{supportsWebGL:this.deviceDetector.hasWebGLSupport?this.deviceDetector.hasWebGLSupport():!1,performanceLevel:this.deviceDetector.recommendPerformanceQuality(),memoryCapacity:window.navigator.deviceMemory?window.navigator.deviceMemory*1024:4096,isMobile:/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}}}getOptimalOKLABPreset(e){let t=this.selectionCriteria.userPreferences?.intensity||.8,i=e.musicData?.energy||.5,n=(t+i)/2;return n>=.8?M.getPreset("COSMIC"):n>=.6?M.getPreset("VIBRANT"):n>=.4?M.getPreset("STANDARD"):M.getPreset("SUBTLE")}async applyColorResult(e){try{p.emit("colors:harmonized",{processedColors:e.processedColors,accentHex:e.accentHex||"#cba6f7",accentRgb:e.accentRgb||"203,166,247",strategies:[e.metadata.strategy],processingTime:e.metadata.processingTime,trackUri:e.metadata.trackUri,coordinationMetrics:{detectedGenre:e.metadata.genre||"unknown",emotionalState:e.metadata.emotion||"neutral",oklabPreset:e.metadata.oklabPreset||"default",coordinationStrategy:e.metadata.strategy,musicInfluenceStrength:e.metadata.intensity||.5},processingMode:"orchestrated"});let t=new CustomEvent("colors/harmonized",{detail:{type:"colors/harmonized",payload:{...e,cssVariables:e.processedColors}}});document.dispatchEvent(t)}catch(t){u?.debug?.error("ColorOrchestrator","Failed to apply color result:",t)}}generateCacheKey(e){return`${e.trackUri}-${e.timestamp}-${JSON.stringify(e.musicData||{})}`}getCachedResult(e){return this.resultCache.get(e)||null}cacheResult(e,t){if(this.resultCache.size>=this.cacheMaxSize){let i=this.resultCache.keys().next().value;i&&this.resultCache.delete(i)}this.resultCache.set(e,t),setTimeout(()=>{this.resultCache.delete(e)},this.cacheTimeoutMs)}updateDeviceCapabilities(){this.selectionCriteria.deviceCapabilities={hasWebGL:this.deviceDetector.hasWebGLSupport?this.deviceDetector.hasWebGLSupport():!1,memoryMB:window.navigator.deviceMemory?window.navigator.deviceMemory*1024:4096,isMobile:/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}}loadUserPreferences(){try{this.selectionCriteria.userPreferences={harmonicMode:this.settingsManager.get("sn-visual-guide-mode")??"cosmic",intensity:this.settingsManager.get("sn-consciousness-level")??.8,enableAdvancedBlending:this.settingsManager.get("sn-advanced-blending")??!0}}catch(e){u?.debug?.warn("ColorOrchestrator","Failed to load user preferences:",e)}}createErrorResult(e,t,i){return{processedColors:e.rawColors,accentHex:"#cba6f7",accentRgb:"203,166,247",metadata:{strategy:t.getStrategyName(),processingTime:0,error:i instanceof Error?i.message:"Unknown error"},context:e}}createFallbackResult(e){return{processedColors:e.rawColors,accentHex:"#cba6f7",accentRgb:"203,166,247",metadata:{strategy:"fallback",processingTime:0,error:"All strategies failed"},context:e}}async applyFallbackColors(e){let t=this.createFallbackResult(e);await this.applyColorResult(t)}updateOrchestrationMetrics(e,t){this.orchestrationMetrics.totalProcessingTime+=t,this.orchestrationMetrics.strategiesProcessed+=e.length,this.orchestrationMetrics.strategiesSucceeded+=e.filter(n=>n.success).length,this.orchestrationMetrics.strategiesFailed+=e.filter(n=>!n.success).length;let i=e.filter(n=>n.success).map(n=>n.processingTime);i.length>0&&(this.orchestrationMetrics.averageStrategyTime=i.reduce((n,r)=>n+r,0)/i.length)}hexToRgb(e){let t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}rgbToHex(e,t,i){return"#"+((1<<24)+(e<<16)+(t<<8)+i).toString(16).slice(1)}getOrchestrationMetrics(){return{...this.orchestrationMetrics}}clearCache(){this.resultCache.clear(),u?.debug?.log("ColorOrchestrator","Result cache cleared")}setOKLABCoordinationEnabled(e){this.oklabCoordinationEnabled=e,u?.debug?.log("ColorOrchestrator",`OKLAB coordination ${e?"enabled":"disabled"}`)}isOKLABCoordinationEnabled(){return this.oklabCoordinationEnabled}getOKLABProcessor(){return this.oklabProcessor}updateAnimation(e){if(this.initialized)try{!this.isProcessing&&this.processingQueue.length>0&&this.processQueue().catch(i=>{u?.debug?.error("ColorCoordinator","Queue processing error in animation loop:",i)});let t=performance.memory;t&&(this.orchestrationMetrics.memoryUsage=t.usedJSHeapSize/(1024*1024))}catch(t){u?.debug?.error("ColorCoordinator","Animation update error:",t)}}async healthCheck(){try{let e=this.getOrchestrationMetrics(),t=this.registry.getStatus(),i="healthy",n=[];this.isInitialized||(i="critical",n.push("System not initialized")),t.strategyCount===0&&(i="critical",n.push("No color processing strategies registered")),this.processingQueue.length>=this.MAX_QUEUE_SIZE*.8&&(i=i==="critical"?"critical":"degraded",n.push(`Processing queue near capacity: ${this.processingQueue.length}/${this.MAX_QUEUE_SIZE}`));let r=e.strategiesSucceeded+e.strategiesFailed;if(r>0){let s=e.strategiesFailed/r;s>.5?(i="critical",n.push(`High failure rate: ${(s*100).toFixed(1)}%`)):s>.2&&(i=i==="critical"?"critical":"degraded",n.push(`Moderate failure rate: ${(s*100).toFixed(1)}%`))}e.memoryUsage>100&&(i=i==="critical"?"critical":"degraded",n.push(`High memory usage: ${e.memoryUsage.toFixed(1)}MB`));let a=n.length===0?`Color coordination system healthy (${t.strategyCount} strategies)`:`Color coordination issues: ${n.join(", ")}`;return{healthy:i==="healthy",ok:i!=="critical",details:`${a} - Status: ${i}`,system:"ColorCoordinator",issues:n,metrics:{initialized:this.isInitialized,strategies:t,orchestrationMetrics:e,queueSize:this.processingQueue.length,isProcessing:this.isProcessing,oklabEnabled:this.oklabCoordinationEnabled,status:i}}}catch(e){return{healthy:!1,ok:!1,details:`Health check failed: ${e}`,system:"ColorCoordinator",issues:["Health check exception"],metrics:{error:String(e)}}}}forceRepaint(e){u?.debug?.log("ColorCoordinator",`Force repaint requested${e?`: ${e}`:""}`);try{this.clearCache(),this.processedContexts.clear(),this.loadUserPreferences(),this.updateDeviceCapabilities(),this.processingQueue.length>0&&!this.isProcessing&&this.processQueue().catch(t=>{u?.debug?.error("ColorCoordinator","Force repaint queue processing error:",t)}),u?.debug?.log("ColorCoordinator","Force repaint completed",{cacheCleared:!0,contextsCleared:this.processedContexts.size===0,queueSize:this.processingQueue.length})}catch(t){u?.debug?.error("ColorCoordinator","Force repaint error:",t)}}async destroy(){p.unsubscribeAll("ColorOrchestrator"),this.clearCache(),this.processingQueue=[],this.isProcessing=!1,this.isInitialized=!1,this.initialized=!1,this.processedContexts.clear(),this.strategySelector.destroy(),u?.debug?.log("ColorOrchestrator","Enhanced color orchestrator destroyed")}},st=new Dn});var ot,Ln,Bn,Fn,Gn,Vn=b(()=>{"use strict";ot=class{constructor(e={}){this.initialized=!1;this.emotionHistory=[];this.currentEmotion=null;this.emotionCache=new Map;this.emotionSubscribers=new Set;this.config={emotionSensitivity:.7,confidenceThreshold:.6,smoothingFactor:.3,memoryDecay:.1,consciousnessAwareness:!0,organicFlowDetection:!0,cinematicAnalysis:!0,analysisInterval:500,cacheSize:100,...e},this.valenceEnergyMapper=new Ln,this.audioFeatureAnalyzer=new Bn,this.temperatureCalculator=new Fn,this.consciousnessDetector=new Gn}async initialize(){if(!this.initialized)try{await this.valenceEnergyMapper.initialize(),await this.audioFeatureAnalyzer.initialize(),await this.temperatureCalculator.initialize(),this.config.consciousnessAwareness&&await this.consciousnessDetector.initialize(),this.initialized=!0,console.log("\u{1F3B5} MusicEmotionAnalyzer initialized with consciousness awareness")}catch(e){throw console.error("\u274C Failed to initialize MusicEmotionAnalyzer:",e),e}}updateAnimation(e){}async healthCheck(){let e=[];return this.initialized||e.push("MusicEmotionAnalyzer not initialized"),this.emotionHistory.length===0&&e.push("No emotion analysis history available"),this.currentEmotion&&this.currentEmotion.confidence<this.config.confidenceThreshold&&e.push(`Low emotion confidence: ${this.currentEmotion.confidence.toFixed(2)}`),{healthy:e.length===0,issues:e,metrics:{emotionHistorySize:this.emotionHistory.length,currentConfidence:this.currentEmotion?.confidence??0,subscriberCount:this.emotionSubscribers.size,cacheSize:this.emotionCache.size}}}destroy(){this.emotionSubscribers.clear(),this.emotionHistory=[],this.emotionCache.clear(),this.currentEmotion=null,this.initialized=!1}async analyzeEmotion(e,t){if(!this.initialized)throw new Error("MusicEmotionAnalyzer must be initialized before analysis");try{let i=this.createCacheKey(e);if(this.emotionCache.has(i)){let r=this.emotionCache.get(i);if(r)return this.updateCurrentEmotion(r),r}let n=await this.performEmotionAnalysis(e,t);return this.cacheEmotion(i,n),this.updateCurrentEmotion(n),this.notifyEmotionUpdate(n),n}catch(i){return console.error("\u274C Error analyzing emotion:",i),this.createNeutralEmotion(e)}}getCurrentEmotion(){return this.currentEmotion}getEmotionHistory(e){return e?this.emotionHistory.slice(-e):[...this.emotionHistory]}onEmotionUpdate(e){return this.emotionSubscribers.add(e),()=>{this.emotionSubscribers.delete(e)}}updateConfig(e){this.config={...this.config,...e}}async performEmotionAnalysis(e,t){let i=this.audioFeatureAnalyzer.extractCharacteristics(e),n=this.valenceEnergyMapper.mapToEmotion(e.valence,e.energy,i),r=this.temperatureCalculator.calculateTemperature(n,i),a={};this.config.consciousnessAwareness&&(a=await this.consciousnessDetector.analyze(e,i,t));let s=this.applyTemporalSmoothing(n,i);return{primary:s.primary,secondary:s.secondary,intensity:s.intensity,confidence:s.confidence,valence:e.valence,arousal:e.energy,dominance:this.calculateDominance(e,i),colorTemperature:r,timestamp:Date.now(),duration:this.calculateEmotionDuration(s,i),musicalCharacteristics:{...i,organicFlow:a.organicFlow??i.organicFlow,cinematicDepth:a.cinematicDepth??i.cinematicDepth,consciousnessResonance:a.consciousnessResonance??.5}}}applyTemporalSmoothing(e,t){if(!this.currentEmotion||this.config.smoothingFactor===0)return e;let i=this.config.smoothingFactor,n=e.intensity*(1-i)+this.currentEmotion.intensity*i,r=e.confidence*(1-i)+this.currentEmotion.confidence*i;return{primary:e.confidence>this.config.confidenceThreshold?e.primary:this.currentEmotion.primary,secondary:e.secondary,intensity:n,confidence:r}}calculateDominance(e,t){let i=Math.min(t.tempo/140,1),n=e.energy,r=Math.min((e.loudness+60)/60,1);return i*.3+n*.4+r*.3}calculateEmotionDuration(e,t){let n=6e4/t.tempo,r=e.confidence*2;return Math.min(2e3*n*r,1e4)}createCacheKey(e){return[Math.round(e.valence*100),Math.round(e.energy*100),Math.round(e.danceability*100),Math.round(e.acousticness*100),e.key,e.mode].join("-")}cacheEmotion(e,t){if(this.emotionCache.size>=this.config.cacheSize){let i=this.emotionCache.keys().next().value;i!==void 0&&this.emotionCache.delete(i)}this.emotionCache.set(e,t)}updateCurrentEmotion(e){this.currentEmotion=e,this.emotionHistory.push(e),this.emotionHistory.length>1e3&&(this.emotionHistory=this.emotionHistory.slice(-500))}notifyEmotionUpdate(e){this.emotionSubscribers.forEach(t=>{try{t(e)}catch(i){console.error("\u274C Error in emotion subscriber callback:",i)}})}createNeutralEmotion(e){return{primary:"serenity",secondary:[],intensity:.5,confidence:.3,valence:e.valence??.5,arousal:e.energy??.5,dominance:.5,colorTemperature:6500,timestamp:Date.now(),duration:3e3,musicalCharacteristics:this.audioFeatureAnalyzer.extractCharacteristics(e)}}},Ln=class{async initialize(){}mapToEmotion(e,t,i){let n,r=[],a,s=.8;return e>=.6&&t>=.6?(n=i.danceability>.7?"excitement":"joy",r=["joy","excitement"],a=Math.min(e+t-.2,1)):e>=.6&&t<.4?(n=i.acousticness>.6?"serenity":"love",r=["serenity","love"],a=e*.8):e<.4&&t>=.6?(n=i.mode===0?"anger":"fear",r=["anger","fear"],a=t):e<.4&&t<.4?(n=i.acousticness>.5?"melancholy":"sadness",r=["sadness","melancholy"],a=(1-e)*.8):(i.instrumentalness>.8?(n="transcendence",r=["transcendence","consciousness"]):(n="nostalgia",r=["nostalgia"]),a=Math.abs(e-.5)+Math.abs(t-.5),s=.6),i.organicFlow>.8&&r.push("organic-flow"),i.consciousnessResonance>.7&&r.push("consciousness"),{primary:n,secondary:r,intensity:a,confidence:s}}},Bn=class{async initialize(){}extractCharacteristics(e){return{tempo:e.tempo,key:e.key,mode:e.mode,timeSignature:e.timeSignature,energy:e.energy,danceability:e.danceability,acousticness:e.acousticness,instrumentalness:e.instrumentalness,liveness:e.liveness,speechiness:e.speechiness,organicFlow:this.calculateOrganicFlow(e),cinematicDepth:this.calculateCinematicDepth(e),consciousnessResonance:this.calculateConsciousnessResonance(e)}}calculateOrganicFlow(e){let t=e.acousticness*.4,i=(1-Math.min(e.tempo/140,1))*.3,n=(1-e.energy)*.2,r=e.danceability*.1;return Math.min(t+i+n+r,1)}calculateCinematicDepth(e){let t=e.instrumentalness*.4,i=(1-e.liveness)*.2,n=(1-e.speechiness)*.2,r=Math.abs(e.energy-.5)*.2;return Math.min(t+i+n+r,1)}calculateConsciousnessResonance(e){let t=1-Math.abs(e.valence-.5)*2,i=1-Math.abs(e.energy-.4)*2,n=e.instrumentalness*.3,r=e.acousticness*.2;return Math.max(0,(t+i)*.5+n+r)}},Fn=class{async initialize(){}calculateTemperature(e,t){let i;switch(e.primary){case"joy":case"excitement":i=8e3;break;case"love":case"serenity":i=3e3;break;case"anger":i=15e3;break;case"fear":i=12e3;break;case"sadness":case"melancholy":i=2e3;break;case"nostalgia":i=2500;break;case"transcendence":case"consciousness":i=6500;break;case"organic-flow":i=4e3;break;default:i=6500}let n=(e.intensity-.5)*2e3,r=(t.tempo-120)*10,a=(t.energy-.5)*1e3,s=i+n+r+a;return Math.max(1e3,Math.min(2e4,s))}},Gn=class{async initialize(){}async analyze(e,t,i){let n=t.organicFlow,r=t.cinematicDepth,a=t.consciousnessResonance;if(i?.waveform){let s=this.analyzeWaveformPatterns(i.waveform);n=Math.min(1,n+s.smoothness*.2),r=Math.min(1,r+s.dynamicRange*.3),a=Math.min(1,a+s.harmonicComplexity*.2)}return{organicFlow:n,cinematicDepth:r,consciousnessResonance:a}}analyzeWaveformPatterns(e){let t=0,i=0,n=0;if(e.length>1){let r=0;for(let o=1;o<e.length;o++){let l=e[o],m=e[o-1];l!==void 0&&m!==void 0&&(r+=Math.abs(l-m))}t=1-Math.min(r/e.length,1);let a=Math.max(...e),s=Math.min(...e);i=a-s,n=Math.min(this.estimateHarmonicContent(e),1)}return{smoothness:t,dynamicRange:i,harmonicComplexity:n}}estimateHarmonicContent(e){let t=0;for(let i=1;i<e.length;i++){let n=e[i],r=e[i-1];n!==void 0&&r!==void 0&&n>=0!=r>=0&&t++}return Math.min(t/(e.length*.1),1)}}});var Le,Ye,Hn=b(()=>{"use strict";Xt();hn();D();R();Ae();ne();bt();ba();K();xn();de();ui();Vn();Le=class Le extends Q{constructor(t,i,n,r){super(t,i||A,n,null,r||null);this.emergentEngine=null;this.userIntensity=.7;this.evolutionEnabled=!0;this._evolutionTimer=null;this._pendingPaletteRefresh=null;this._lastGenre=null;if(this.systemName="ColorHarmonyEngine",this.paletteExtensionManager=new si(this.config,this.utils),this.semanticColorManager=new rt({enableDebug:this.config.enableDebug,fallbackToSpiceColors:!0,cacheDuration:5e3}),this.currentTheme=this.detectCurrentTheme(),t&&typeof t.harmonicIntensity=="number"&&Number.isFinite(t.harmonicIntensity)){let a=Math.max(0,Math.min(1,t.harmonicIntensity));this.userIntensity=a}this.harmonyMetrics={totalHarmonyCalculations:0,musicInfluencedAdjustments:0,temporalMemoryEvents:0,performance:[]},this.musicalMemory={recentTracks:[],userColorPreferences:new Map,energyHistory:[],maxMemorySize:50},this.kineticState={currentPulse:0,breathingPhase:0,lastBeatTime:0,visualMomentum:0},this.catppuccinPalettes={frappe:{accents:{rosewater:"#f2d5cf",flamingo:"#eebebe",pink:"#ff6b9d",mauve:"#c77dff",red:"#ff4757",maroon:"#ea999c",peach:"#ff7675",yellow:"#fdcb6e",green:"#6c5ce7",teal:"#00cec9",sky:"#74b9ff",sapphire:"#0984e3",blue:"#a29bfe",lavender:"#fd79a8"},neutrals:{base:"#303446",surface0:"#414559",surface1:"#51576d",surface2:"#626880"}},latte:{accents:{rosewater:"#dc8a78",flamingo:"#dd7878",pink:"#e84393",mauve:"#a55eea",red:"#fd79a8",maroon:"#e64553",peach:"#fd7f28",yellow:"#f39c12",green:"#00b894",teal:"#00cec9",sky:"#0984e3",sapphire:"#6c5ce7",blue:"#74b9ff",lavender:"#a29bfe"},neutrals:{base:"#eff1f5",surface0:"#e6e9ef",surface1:"#dce0e8",surface2:"#c5c9d1"}},macchiato:{accents:{rosewater:"#f4dbd6",flamingo:"#f0c6c6",pink:"#ff6b9d",mauve:"#c77dff",red:"#ff4757",maroon:"#ee99a0",peach:"#ff7675",yellow:"#fdcb6e",green:"#6c5ce7",teal:"#00cec9",sky:"#74b9ff",sapphire:"#0984e3",blue:"#a29bfe",lavender:"#fd79a8"},neutrals:{base:"#24273a",surface0:"#363a4f",surface1:"#494d64",surface2:"#5b6078"}},mocha:{accents:{rosewater:"#f5e0dc",flamingo:"#f2cdcd",pink:"#ff6b9d",mauve:"#c77dff",red:"#ff4757",maroon:"#eba0ac",peach:"#ff7675",yellow:"#fdcb6e",green:"#6c5ce7",teal:"#00cec9",sky:"#74b9ff",sapphire:"#0984e3",blue:"#a29bfe",lavender:"#fd79a8"},neutrals:{base:"#1e1e2e",surface0:"#313244",surface1:"#45475a",surface2:"#585b70"}}},this.vibrancyConfig={defaultBlendRatio:.75,minimumSaturation:.6,maximumDesaturation:.1,contrastBoostIntensity:1.4,harmonyTolerance:.3,artisticSaturationBoost:1.35,cosmicLuminanceBoost:1.25,energyResponsiveness:.8,getBlendRatio(a="artist-vision"){return{"corporate-safe":.6,"artist-vision":.75,"cosmic-maximum":.85}[a]||this.defaultBlendRatio}},this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Initialized with Year 3000 Quantum Empathy"),t&&typeof t.harmonicEvolution=="boolean"&&(this.evolutionEnabled=t.harmonicEvolution),this.emotionalTemperatureMapper=new J(this.config.enableDebug),this.oklabProcessor=new M(this.config.enableDebug),this.musicEmotionAnalyzer=new ot({emotionSensitivity:.7,confidenceThreshold:.6,consciousnessAwareness:!0,organicFlowDetection:!0,cinematicAnalysis:!0,analysisInterval:500}),this.genreGradientEvolution=new nt(void 0,null,null,this.settingsManager),this.oklabState={currentPreset:M.PRESETS.STANDARD,processedPalette:{},perceptualGradientCache:new Map,colorHarmonyCache:new Map,lastProcessingTime:0},this.emotionalState={currentEmotion:null,emotionHistory:[],lastEmotionUpdate:0,emotionInfluenceIntensity:.8},this.genreState={currentGenre:"unknown",genreConfidence:0,genreHistory:[],lastGenreUpdate:0,genreInfluenceIntensity:.7},this._boundSettingsChangeHandler=this._handleSettingsChange.bind(this),this._boundArtisticModeHandler=this._handleArtisticModeChanged.bind(this),document.addEventListener("year3000SystemSettingsChanged",this._boundSettingsChangeHandler),document.addEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),this.evolutionEnabled&&this._startEvolutionLoop()}getCurrentActivePalette(){try{if(j.getCurrentPaletteSystem()==="year3000"){let i=j.getCurrentPalette(),n=j.getCurrentDefaultFlavor(),r=i[n];if(!r)throw new Error(`No palette found for flavor: ${n}`);let a={},s={};return Object.entries(r).forEach(([o,l])=>{["base","surface0","surface1","surface2","mantle","crust"].includes(o)?s[o]=l.hex:a[o]=l.hex}),{accents:a,neutrals:s}}else return this.catppuccinPalettes[this.currentTheme]}catch(t){return console.warn("[ColorHarmonyEngine] Failed to get active palette, using fallback:",t),this.catppuccinPalettes[this.currentTheme]}}updateAnimation(t,i){let n=i??t;this.onAnimate(n)}onAnimate(t){this._updateCSSVariables(t),this._calculateBeatPulse(t),p.emitSync("performance:frame",{deltaTime:t,fps:60,memoryUsage:performance.memory?.usedJSHeapSize||0,timestamp:performance.now()})}_updateCSSVariables(t){let i={"--sn-harmony-energy":this.kineticState.visualMomentum.toFixed(3),"--sn-harmony-pulse":this.kineticState.currentPulse.toFixed(3),"--sn-harmony-breathing-phase":(Math.sin(this.kineticState.breathingPhase)*.5+.5).toFixed(3)};this.kineticState.musicIntensityMultiplier!==void 0&&(i["--sn-harmony-intensity"]=this.kineticState.musicIntensityMultiplier.toFixed(3)),this.kineticState.valenceGravity!==void 0&&(i["--sn-harmony-valence"]=this.kineticState.valenceGravity.toFixed(3)),this.kineticState.beatPhase!==void 0&&(i["--sn-harmony-beat-phase"]=this.kineticState.beatPhase.toFixed(3)),this.kineticState.hueShift!==void 0&&(i["--sn-harmony-hue-shift"]=`${this.kineticState.hueShift.toFixed(1)}deg`);let n=Math.max(0,Math.min(1,this.kineticState.currentPulse*1.2));i["--sn-text-glow-intensity"]=n.toFixed(3),p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:i,timestamp:Date.now()})}_calculateBeatPulse(t){this.kineticState.currentPulse*=Math.pow(.95,t/16.67),this.kineticState.breathingPhase+=t/1e3*.5,this.kineticState.breathingPhase>2*Math.PI&&(this.kineticState.breathingPhase-=2*Math.PI),this._emitGradientBreathingEvents(t)}_emitGradientBreathingEvents(t){let i=this._calculateCurrentEnergyLevel(),n=this._detectBeatFromAudioAnalysis();Math.random()<.1&&p.emit("music:energy",{energy:i.energy,valence:i.valence,tempo:120,timestamp:performance.now()}),n.detected&&p.emit("music:beat",{intensity:n.intensity,confidence:n.confidence,timestamp:performance.now(),bpm:120})}_calculateCurrentEnergyLevel(){let t=.5+Math.sin(this.kineticState.breathingPhase)*.3;return{energy:Math.max(.2,t),valence:.5+this.kineticState.currentPulse*.3,arousal:.4+this.kineticState.currentPulse*.4}}_detectBeatFromAudioAnalysis(){let i=this.kineticState.currentPulse;return i>.3?{detected:!0,intensity:Math.min(1,i*1.5),confidence:Math.min(1,(i-.3)/(1-.3))}:Math.sin(this.kineticState.breathingPhase)>.8?{detected:!0,intensity:.4,confidence:.6}:{detected:!1,intensity:0,confidence:0}}async initialize(){await super.initialize();let t=this.performanceMonitor?this.performanceMonitor.cssConsciousnessController:void 0;this.semanticColorManager.initialize(t),p.subscribe("colors:extracted",this.handleColorExtraction.bind(this),"ColorHarmonyEngine");try{st.registerStrategy(this),this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Registered with ColorOrchestrator as strategy processor.")}catch(i){console.warn("\u{1F3A8} [ColorHarmonyEngine] Failed to register with ColorOrchestrator:",i)}try{await this.musicEmotionAnalyzer.initialize(),this.musicEmotionAnalyzer.onEmotionUpdate(i=>{this.handleEmotionUpdate(i)}),this.config.enableDebug&&console.log("\u{1F3AD} [ColorHarmonyEngine] MusicEmotionAnalyzer initialized with consciousness awareness")}catch(i){console.warn("\u{1F3AD} [ColorHarmonyEngine] Failed to initialize MusicEmotionAnalyzer:",i)}try{await this.genreGradientEvolution.initialize(),this.config.enableDebug&&console.log("\u{1F3B6} [ColorHarmonyEngine] GenreGradientEvolution initialized with aesthetic intelligence")}catch(i){console.warn("\u{1F3B6} [ColorHarmonyEngine] Failed to initialize GenreGradientEvolution:",i)}this.config.enableDebug&&(console.log("\u{1F3A8} [ColorHarmonyEngine] Initialized with Year 3000 Quantum Empathy via BaseVisualSystem and SemanticColorManager."),console.log("\u{1F3A8} [ColorHarmonyEngine] Subscribed to 'colors/extracted' events for strategy pattern processing.")),this.initialized=!0}handleEmotionUpdate(t){if(this.initialized)try{this.emotionalState.currentEmotion=t,this.emotionalState.emotionHistory.push(t),this.emotionalState.lastEmotionUpdate=Date.now(),this.emotionalState.emotionHistory.length>50&&(this.emotionalState.emotionHistory=this.emotionalState.emotionHistory.slice(-25)),p.emit("emotion:analyzed",{emotion:t,colorTemperature:t.colorTemperature,consciousnessLevel:t.musicalCharacteristics.consciousnessResonance,organicFlow:t.musicalCharacteristics.organicFlow,cinematicDepth:t.musicalCharacteristics.cinematicDepth,timestamp:t.timestamp}),this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Emotion updated: ${t.primary} (intensity: ${t.intensity.toFixed(2)}, confidence: ${t.confidence.toFixed(2)})`),this.triggerEmotionalColorUpdate(t)}catch(i){console.error("\u{1F3AD} [ColorHarmonyEngine] Error handling emotion update:",i)}}triggerEmotionalColorUpdate(t){this.emotionalState.emotionInfluenceIntensity>0&&t.confidence>.6&&(this._pendingPaletteRefresh&&clearTimeout(this._pendingPaletteRefresh),this._pendingPaletteRefresh=setTimeout(()=>{this.refreshPaletteWithEmotion(t),this._pendingPaletteRefresh=null},100))}async refreshPaletteWithEmotion(t){try{let i={primaryEmotion:t.primary,emotionIntensity:t.intensity,colorTemperature:t.colorTemperature,valence:t.valence,arousal:t.arousal,dominance:t.dominance,organicFlow:t.musicalCharacteristics.organicFlow,cinematicDepth:t.musicalCharacteristics.cinematicDepth,consciousnessResonance:t.musicalCharacteristics.consciousnessResonance};p.emit("emotionalColorContext:updated",i),this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Refreshing colors with ${t.primary} emotion influence`)}catch(i){console.error("\u{1F3AD} [ColorHarmonyEngine] Error refreshing palette with emotion:",i)}}async healthCheck(){return this.getCurrentActivePalette()?{healthy:!0,ok:!0,details:"Palettes are loaded correctly.",issues:[],system:"ColorHarmonyEngine"}:{healthy:!1,ok:!1,details:`Current theme '${this.currentTheme}' not found in palettes.`,issues:[`Current theme '${this.currentTheme}' not found in palettes.`],system:"ColorHarmonyEngine"}}async processColors(t){let i=performance.now();try{let{rawColors:n,trackUri:r,musicData:a}=t,s=this.determineOptimalOKLABPreset(t);this.oklabState.currentPreset=s;let o=await this.analyzeGenreAesthetics(a,n),l=await this.getAdvancedEmotionalTemperature(a,n),m=await this.blendWithAdvancedOKLAB(n,a,l,o||void 0),d=m.VIBRANT||m.PROMINENT||Object.values(m)[0]||"#a6adc8",h=this.utils.hexToRgb(d),g=h?`${h.r},${h.g},${h.b}`:"166,173,200";try{let P={processedColors:m,accentHex:d,accentRgb:g,originalColors:n,trackUri:r,musicData:a,timestamp:Date.now(),strategies:["ColorHarmonyEngine"],processingTime:performance.now()-i,coordinationMetrics:{detectedGenre:o?.genre||"unknown",genreConfidence:o?.confidence||0,emotionalState:this.emotionalState.currentEmotion?.primary||"neutral",oklabPreset:s?.name||"standard",coordinationStrategy:"genre-emotion-color-unified",musicInfluenceStrength:this.genreState.genreInfluenceIntensity}};p.emitSync("colors:harmonized",P),this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Emitted colors:harmonized via UnifiedEventBus (facade pattern):",{processedColors:Object.keys(m),accentHex:d,noDomEvents:"correct architecture"})}catch(P){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Failed to emit colors:harmonized event:",P)}let f=performance.now()-i;this.harmonyMetrics.totalHarmonyCalculations++,this.harmonyMetrics.performance.push(f);let v={processedColors:m,accentHex:d,accentRgb:g,metadata:{strategy:"CatppuccinHarmony",processingTime:f,cacheKey:`catppuccin-${r}-${this.currentTheme}`,harmonicIntensity:this.userIntensity},context:t},C=this.generateAdvancedOKLABCSSVariables(v);return this.applyCSSVariablesToDOM(C),this.generatePerceptualGradientData(v),this.updateAdvancedHarmonyMetrics(v,f),p.emitSync("colors:harmonized",{processedColors:v.processedColors,accentHex:v.accentHex,accentRgb:v.accentRgb,strategies:v.metadata?.strategy?[v.metadata.strategy]:["ColorHarmonyEngine"],processingTime:f,trackUri:v.context.trackUri}),this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Processed colors via strategy pattern in ${f.toFixed(2)}ms`,{accentHex:d,strategy:"CatppuccinHarmony",cssVariablesCount:Object.keys(C).length}),v}catch(n){return console.error("[ColorHarmonyEngine] Strategy processing failed:",n),{processedColors:{VIBRANT:"#a6adc8"},accentHex:"#a6adc8",accentRgb:"166,173,200",metadata:{strategy:"CatppuccinHarmony",processingTime:performance.now()-i,error:String(n)},context:t}}}getStrategyName(){return"CatppuccinHarmony"}canProcess(t){return t&&t.rawColors&&Object.keys(t.rawColors).length>0}getEstimatedProcessingTime(t){let n=Object.keys(t.rawColors||{}).length;return 5*Math.max(1,n/5)}async handleColorExtraction(t){try{if(!this.initialized){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Received color extraction event but not initialized");return}let i={rawColors:t.rawColors,trackUri:t.trackUri,timestamp:t.timestamp,harmonicMode:this.currentTheme,musicData:t.musicData,performanceHints:{preferLightweight:!1,enableAdvancedBlending:!0,maxProcessingTime:100}};this.canProcess(i)?await this.processColors(i):this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Cannot process color context:",i)}catch(i){console.error("[ColorHarmonyEngine] Error handling color extraction event:",i)}}generateCSSVariables(t){let i={};i["--sn-accent-hex"]=t.accentHex,i["--sn-accent-rgb"]=t.accentRgb,i[Le.CANONICAL_HEX_VAR]=t.accentHex,i[Le.CANONICAL_RGB_VAR]=t.accentRgb;let n=t.processedColors,r=n.VIBRANT||n.PROMINENT||t.accentHex,a=n.DARK_VIBRANT||n.DESATURATED||r,s=n.VIBRANT_NON_ALARMING||n.LIGHT_VIBRANT||r;i["--sn-bg-gradient-primary"]=r,i["--sn-bg-gradient-secondary"]=a,i["--sn-bg-gradient-accent"]=s;let o=this.utils.hexToRgb(r),l=this.utils.hexToRgb(a),m=this.utils.hexToRgb(s);return o&&(i["--sn-bg-gradient-primary-rgb"]=`${o.r},${o.g},${o.b}`),l&&(i["--sn-bg-gradient-secondary-rgb"]=`${l.r},${l.g},${l.b}`),m&&(i["--sn-bg-gradient-accent-rgb"]=`${m.r},${m.g},${m.b}`),this.generateOKLABVariables(i,t),this.config.enableDebug&&console.log("\u{1F527} [ColorHarmonyEngine] Generated background gradient CSS variables:",{primary:`${r} -> ${i["--sn-bg-gradient-primary-rgb"]}`,secondary:`${a} -> ${i["--sn-bg-gradient-secondary-rgb"]}`,accent:`${s} -> ${i["--sn-bg-gradient-accent-rgb"]}`,totalVariables:Object.keys(i).length,note:"CSS mapping automatically updates --sn-gradient-* variables"}),i}generateOKLABVariables(t,i){try{let n=i.accentHex,r=i.processedColors,a=r.DARK_VIBRANT||r.DESATURATED||n,s=this.utils.hexToRgb(n),o=this.utils.hexToRgb(a);if(s){let l=this.utils.rgbToOklab(s.r,s.g,s.b),m={L:Math.min(1,l.L*1.1),a:l.a*1.15,b:l.b*1.15},d=this.utils.oklabToRgb(m.L,m.a,m.b);t["--sn-color-oklab-bright-highlight-rgb"]=`${d.r},${d.g},${d.b}`,t["--sn-color-oklab-primary-r"]=Math.round(d.r).toString(),t["--sn-color-oklab-primary-g"]=Math.round(d.g).toString(),t["--sn-color-oklab-primary-b"]=Math.round(d.b).toString(),t["--sn-color-oklab-accent-r"]=Math.round(d.r).toString(),t["--sn-color-oklab-accent-g"]=Math.round(d.g).toString(),t["--sn-color-oklab-accent-b"]=Math.round(d.b).toString(),t["--sn-color-oklab-accent-luminance"]=m.L.toFixed(3);let h=this.convertOklabToOklch(m);t["--sn-color-oklch-accent-l"]=h.L.toFixed(3),t["--sn-color-oklch-accent-c"]=h.C.toFixed(3),t["--sn-color-oklch-accent-h"]=h.H.toFixed(1),t["--sn-color-oklch-primary-l"]=h.L.toFixed(3),t["--sn-color-oklch-primary-c"]=h.C.toFixed(3),t["--sn-color-oklch-primary-h"]=h.H.toFixed(1)}if(o){let l=this.utils.rgbToOklab(o.r,o.g,o.b),m={L:Math.max(.05,l.L*.3),a:l.a*.8,b:l.b*.8},d=this.utils.oklabToRgb(m.L,m.a,m.b);t["--sn-color-oklab-dynamic-shadow-rgb"]=`${d.r},${d.g},${d.b}`,t["--sn-color-oklab-base-luminance"]=m.L.toFixed(3)}this.config.enableDebug&&console.log("\u{1F52C} [ColorHarmonyEngine] Generated OKLAB-processed variables:",{primaryColor:n,secondaryColor:a,oklabVariablesCount:Object.keys(t).filter(l=>l.includes("oklab")).length,oklchVariablesCount:Object.keys(t).filter(l=>l.includes("oklch")).length})}catch(n){this.config.enableDebug&&console.warn("\u{1F52C} [ColorHarmonyEngine] OKLAB processing failed, using fallbacks:",n);let r=this.utils.hexToRgb(i.accentHex);r&&(t["--sn-color-oklab-bright-highlight-rgb"]=`${r.r},${r.g},${r.b}`,t["--sn-color-oklab-dynamic-shadow-rgb"]=`${Math.round(r.r*.3)},${Math.round(r.g*.3)},${Math.round(r.b*.3)}`)}}convertOklabToOklch(t){let i=t.L,n=Math.sqrt(t.a*t.a+t.b*t.b),r=Math.atan2(t.b,t.a)*(180/Math.PI);return r<0&&(r+=360),{L:i,C:n,H:r}}detectCurrentTheme(){let t=this.utils.getRootStyle();if(!t)return console.warn("[ColorHarmonyEngine detectCurrentTheme] Root element not found. Defaulting to mocha."),"mocha";let n=getComputedStyle(t).getPropertyValue("--spice-main").trim(),r=n.startsWith("#")?n.substring(1).toUpperCase():n.toUpperCase(),s={303446:"frappe",EFF1F5:"latte","24273A":"macchiato","1E1E2E":"mocha"}[r];if(s)return this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Detected Catppuccin theme: ${s}`),s;this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Unknown theme detected (${r}), attempting to generate fallback`);let o=`custom-${r.toLowerCase()}`;try{let l=this.paletteExtensionManager.generateFallbackPalette(o);this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Generated fallback palette for theme: ${o}`,l)}catch(l){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Failed to generate fallback palette:",l)}return this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Falling back to mocha theme for unknown base color: ${r}`),"mocha"}async _getGenreAwarePalette(t){let i=this.getCurrentActivePalette();if(!t||!i)return i;try{let n={name:this.currentTheme,version:"1.0.0",accents:i.accents,neutrals:i.neutrals,metadata:{author:"Catppuccin",description:`${this.currentTheme} flavor`,temperature:"neutral"}},r=this.paletteExtensionManager.applyGenreAwareModifications(n,t);return{accents:r.accents,neutrals:r.neutrals}}catch(n){return this.config.enableDebug&&console.warn(`[ColorHarmonyEngine] Failed to apply genre modifications for ${t}:`,n),i}}getMusicIntensityMultiplier(t=.5,i=.5){let n=this.config.getCurrentMultipliers().musicEnergyBoost,r=t>.7?1.3:t>.4?1:.8,a=i>.6?1.2:i<.4?.9:1;return n*r*a}validateColorHarmony(t,i="general"){let n=performance.now();this.harmonyMetrics.totalHarmonyCalculations++;let r={general:{minContrast:1.8,minHarmony:this.vibrancyConfig.harmonyTolerance},search:{minContrast:2.8,minHarmony:.4},navigation:{minContrast:2.5,minHarmony:.45},text:{minContrast:4.5,minHarmony:.6},accent:{minContrast:1.5,minHarmony:.3}},a=r[i]||r.general,s=this.getCurrentActivePalette();if(!s?.neutrals?.base){let P=`[StarryNight] Catppuccin palette or base neutral not found for theme: ${this.currentTheme}`;return console.error(P),{isValid:!1,error:"Palette configuration error.",contrastRatio:0,harmonyScore:0,meetsContrast:!1,isHarmonious:!1,artisticMode:this.config.artisticMode,adjustedRequirements:a,recommendations:[]}}let o=s.neutrals.base,l=this.utils.rgbToHex(t.r,t.g,t.b),m=this.utils.calculateContrastRatio(l,o),d=this.calculateHarmonyScore(t,s),h=this.config.artisticMode,g={...a};h==="cosmic-maximum"?(g.minContrast*=.7,g.minHarmony*=.6):h==="artist-vision"&&(g.minContrast*=.85,g.minHarmony*=.8);let f=m>=g.minContrast,v=d>=g.minHarmony,C=performance.now();return this.harmonyMetrics.performance.push(C-n),{isValid:f&&v,contrastRatio:m,harmonyScore:d,meetsContrast:f,isHarmonious:v,artisticMode:h,adjustedRequirements:g,recommendations:this.generateRecommendations(t,m,d,g)}}calculateHarmonyScore(t,i){let n=this.utils.rgbToHsl(t.r,t.g,t.b),r=0,a=Object.values(i.accents);for(let s of a){let o=this.utils.hexToRgb(s);if(!o)continue;let l=this.utils.rgbToHsl(o.r,o.g,o.b),m=Math.abs(n.h-l.h),d=Math.min(m,360-m),h=[0,30,60,90,120,150,180,210,240,270,300,330];if(h.some(f=>Math.abs(d-f)<20)){let f=1-Math.min(...h.map(v=>Math.abs(d-v)))/20;r=Math.max(r,f)}}return r}findBestHarmoniousAccent(t,i){let n={name:"mauve",hex:this.utils.getRootStyle()?.style.getPropertyValue("--sn-dynamic-accent")?.trim()||this.utils.getRootStyle()?.style.getPropertyValue("--spice-accent")?.trim()||"#cba6f7",rgb:{r:203,g:166,b:247}},r=["mauve","lavender","blue","sapphire","sky","pink","peach","teal"],a=-1,s=this.utils.rgbToHsl(t.r,t.g,t.b);for(let o of r){let l=i.accents[o];if(l){let m=this.utils.hexToRgb(l);if(!m)continue;let d=this.utils.rgbToHsl(m.r,m.g,m.b),h=Math.abs(s.h-d.h),f=1-Math.min(h,360-h)/180,v=d.s*.3,C=f+v;C>a&&(a=C,n={name:o,hex:l,rgb:m})}}return n}blendColors(t,i,n=this.vibrancyConfig.defaultBlendRatio){let r=Math.max(0,Math.min(1,n)),a=this.utils.rgbToOklab(t.r,t.g,t.b),s=this.utils.rgbToOklab(i.r,i.g,i.b),o=(L,_)=>L*r+_*(1-r),l={L:o(a.L,s.L),a:o(a.a,s.a),b:o(a.b,s.b)},m=this.utils.oklabToRgb(l.L,l.a,l.b),d=this.utils.rgbToHsl(m.r,m.g,m.b),h=this.config?.artisticMode??"artist-vision",g=this.emergentEngine?.getCurrentMultipliers?.()||void 0,f=h==="cosmic-maximum"&&!!g,v=g||{},C=f?(v.visualIntensityBase||1)*1.25:this.vibrancyConfig.artisticSaturationBoost,P=f?(v.aestheticGravityStrength||1)*1.15:this.vibrancyConfig.cosmicLuminanceBoost;d.s=Math.max(d.s,this.vibrancyConfig.minimumSaturation*100),d.s=Math.min(100,d.s*C),h!=="corporate-safe"&&(d.l=Math.min(95,d.l*P));let E=this.utils.hslToRgb(d.h,d.s,d.l);return{r:E.r,g:E.g,b:E.b}}blendWithCatppuccin(t,i=null){this.performanceMonitor?.emitTrace?.("[ColorHarmonyEngine] Starting blendWithCatppuccin");let n=null;if(i)try{let s={energy:i.energy||.5,valence:i.valence||.5,danceability:i.danceability,tempo:i.enhancedBPM||i.tempo,loudness:i.loudness,acousticness:i.acousticness,instrumentalness:i.instrumentalness,speechiness:i.speechiness,mode:i.mode,key:i.key,genre:i.genre};n=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(s),n&&(p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:n.cssVariables,timestamp:Date.now()}),document.body.classList.remove(...Array.from(document.body.classList).filter(o=>o.startsWith("organic-emotion-"))),document.body.classList.add(n.cssClass),n.secondaryEmotion&&document.body.classList.add(`organic-emotion-blend-${n.secondaryEmotion}`)),this.config.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Applied emotional temperature:",n)}catch(s){this.config.enableDebug&&console.warn("\u{1F321}\uFE0F [ColorHarmonyEngine] Failed to apply emotional temperature:",s)}this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] blendWithCatppuccin debug:",{extractedColors:t,musicContext:i,emotionalTemperature:n,currentTheme:this.currentTheme,vibrancyConfig:this.vibrancyConfig,userIntensity:this.userIntensity});let r=this.getCurrentActivePalette();if(!r)return console.error(`[StarryNight] Catppuccin palette not found for theme: ${this.currentTheme}`),t;let a={};for(let[s,o]of Object.entries(t)){if(!o)continue;let l=this.utils.hexToRgb(o);if(!l){this.config.enableDebug&&console.warn(`\u{1F3A8} [ColorHarmonyEngine] Failed to parse color for role ${s}: ${o}`),a[s]=o;continue}let m=this.utils.rgbToHsl(l.r,l.g,l.b),d=m.s>=this.vibrancyConfig.minimumSaturation*100;this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Processing color ${s}:`,{originalColor:o,rgb:l,hsl:m,saturationCheck:d,minimumSaturationRequired:this.vibrancyConfig.minimumSaturation*100,actualSaturation:m.s});let h=this.findBestHarmoniousAccent(l,r);if(!h?.rgb){console.warn(`[StarryNight] Could not find a valid harmonious accent for role: ${s}. Using original color.`),a[s]=o;continue}let g=this.vibrancyConfig.getBlendRatio(this.config.artisticMode);if(n){let C=n.intensity;g*=C*this.userIntensity;let P=this.calculateTemperatureBlendInfluence(n.temperature);g*=P,g=Math.max(0,Math.min(1,g)),this.config.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Emotional temperature blend adjustment:",{originalRatio:this.vibrancyConfig.getBlendRatio(this.config.artisticMode),emotionalIntensity:C,temperatureInfluence:P,finalBlendRatio:g,temperature:n.temperature})}else if(i){let C=this.getMusicIntensityMultiplier(i.energy,i.valence);g*=C*this.userIntensity,g=Math.max(0,Math.min(1,g))}this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Blending ${s}:`,{extractedRgb:l,bestAccent:h.hex,blendRatio:g,artisticMode:this.config.artisticMode});let f=this.blendColors(l,h.rgb,g),v=this.utils.rgbToHex(f.r,f.g,f.b);a[s]=v,this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Final color for ${s}: ${o} \u2192 ${v}`)}return this.harmonyMetrics.musicInfluencedAdjustments++,this.performanceMonitor?.emitTrace?.("[ColorHarmonyEngine] Completed blendWithCatppuccin"),this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Final harmonized result:",{inputColors:t,outputColors:a,colorCount:Object.keys(a).length}),this.updateSemanticColorsWithHarmonizedPalette(a),a}updateSemanticColorsWithHarmonizedPalette(t){if(this.semanticColorManager)try{this.semanticColorManager.updateWithAlbumColors(t);let i=t.VIBRANT||t.PRIMARY,n=t.DARK_VIBRANT||t.SECONDARY,r=t.VIBRANT_NON_ALARMING||t.LIGHT_VIBRANT;i&&this.semanticColorManager.getSemanticColor("essentialBrightAccent").then(a=>{let s=this.blendWithSemanticColor(i,a,.7);this.applyCSSVariable("--spice-accent",s),this.applyCSSVariable("--spice-button-active",s)}),n&&this.semanticColorManager.getSemanticColor("backgroundElevatedHighlight").then(a=>{let s=this.blendWithSemanticColor(n,a,.5);this.applyCSSVariable("--spice-highlight",s)}),r&&this.semanticColorManager.getSemanticColor("textBrightAccent").then(a=>{let s=this.blendWithSemanticColor(r,a,.6);this.applyCSSVariable("--spice-text-accent",s)}),this.semanticColorManager.flushUpdates()}catch(i){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Failed to update semantic colors:",i)}}blendWithSemanticColor(t,i,n){let r=this.utils.hexToRgb(t),a=this.utils.hexToRgb(i);if(!r||!a)return t;let s=this.blendColors(r,a,n);return this.utils.rgbToHex(s.r,s.g,s.b)}applyCSSVariable(t,i){p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:{[t]:i},timestamp:Date.now()})}applyCSSVariablesToDOM(t){let i=globalThis.year3000System,n=i?.cssConsciousnessController||this.performanceMonitor?.cssConsciousnessController||i?.facadeCoordinator?.getCachedNonVisualSystem?.("UnifiedCSSVariableManager"),r=this.enhanceCSSVariablesForUIComponents(t);if(n&&typeof n.batchSetVariables=="function")try{n.batchSetVariables("ColorHarmonyEngine",r,"high","color-harmony-oklab-processing"),this.config.enableDebug&&console.log("\u{1F527} [ColorHarmonyEngine] Applied CSS variables via cssConsciousnessController batcher")}catch(a){this.config.enableDebug&&console.warn("\u{1F527} [ColorHarmonyEngine] cssConsciousnessController.batchSetVariables failed, using direct application:",a),this.applyVariablesDirectly(r)}else this.config.enableDebug&&console.log("\u{1F527} [ColorHarmonyEngine] cssConsciousnessController not available, using direct DOM application"),this.applyVariablesDirectly(r);p.emitSync("colors:applied",{cssVariables:r,accentHex:r["--sn-accent-hex"]||"#a6adc8",accentRgb:r["--sn-accent-rgb"]||"166,173,200",appliedAt:Date.now()}),this.config.enableDebug&&console.log("\u{1F52C} [ColorHarmonyEngine] Applied enhanced CSS variables to DOM:",{totalVariables:Object.keys(r).length,oklabVariables:Object.keys(r).filter(a=>a.includes("oklab")).length,oklchVariables:Object.keys(r).filter(a=>a.includes("oklch")).length,gradientVariables:Object.keys(r).filter(a=>a.includes("gradient")).length,spiceVariables:Object.keys(r).filter(a=>a.includes("spice")).length,sidebarVariables:Object.keys(r).filter(a=>a.includes("sidebar")).length,cssConsciousnessControllerUsed:!!n})}enhanceCSSVariablesForUIComponents(t){let i={...t},n=i["--sn-accent-hex"]||i[Le.CANONICAL_HEX_VAR],r=i["--sn-accent-rgb"]||i[Le.CANONICAL_RGB_VAR],a=i["--sn-bg-gradient-primary"],s=i["--sn-bg-gradient-primary-rgb"],o=i["--sn-bg-gradient-secondary"],l=i["--sn-bg-gradient-secondary-rgb"];n&&r&&(i["--spice-accent"]=n,i["--spice-button"]=n,i["--spice-button-active"]=n,i["--spice-rgb-accent"]=r,i["--spice-rgb-button"]=r,i["--spice-text-accent"]=n,i["--sn-sidebar-entanglement-color-rgb"]=r,i["--sn-sidebar-accent-color"]=n,i["--sn-sidebar-accent-rgb"]=r,i["--sn-sidebar-dynamic-accent"]=n,i["--sn-nowplaying-accent-color"]=n,i["--sn-nowplaying-accent-rgb"]=r,i["--sn-nowplaying-primary-color"]=n,i["--sn-nowplaying-primary-rgb"]=r,i["--sn-main-feed-accent-color"]=n,i["--sn-main-feed-accent-rgb"]=r,i["--sn-content-accent-color"]=n,i["--sn-content-accent-rgb"]=r),a&&s&&(i["--sn-primary-gradient-color"]=a,i["--sn-primary-gradient-rgb"]=s,i["--sn-main-feed-primary-color"]=a,i["--sn-main-feed-primary-rgb"]=s),o&&l&&(i["--sn-secondary-gradient-color"]=o,i["--sn-secondary-gradient-rgb"]=l,i["--sn-main-feed-secondary-color"]=o,i["--sn-main-feed-secondary-rgb"]=l);let m=i["--sn-color-oklab-bright-highlight-rgb"];m&&(i["--sn-consciousness-bright-accent-rgb"]=m,i["--sn-holographic-accent-rgb"]=m,i["--organic-holographic-rgb"]=m);let d=i["--sn-color-oklab-dynamic-shadow-rgb"];return d&&(i["--sn-consciousness-shadow-rgb"]=d,i["--sn-depth-shadow-rgb"]=d),i}applyVariablesDirectly(t){p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:t,timestamp:Date.now()})}generateRecommendations(t,i,n,r){let a=[],s=this.getCurrentActivePalette(),o=this.utils.hexToRgb(s?.neutrals?.base||"#1e1e2e");if(!o)return[];if(i<r.minContrast){let l=this.utils.findRequiredLuminance(t,o,r.minContrast),m=this.utils.rgbToHsl(t.r,t.g,t.b),d=this.utils.hslToRgb(m.h,m.s,l),h={r:d.r,g:d.g,b:d.b};a.push({type:"contrast",suggestion:`Adjust luminance to meet contrast of ${r.minContrast}`,recommendedColor:this.utils.rgbToHex(h.r,h.g,h.b)})}if(n<r.minHarmony){let l=this.findBestHarmoniousAccent(t,s),m=this.blendColors(t,l.rgb,.5);a.push({type:"harmony",suggestion:`Blend with harmonious accent color to improve score to at least ${r.minHarmony}`,recommendedColor:this.utils.rgbToHex(m.r,m.g,m.b)})}return a}getPerformanceReport(){return{system:this.systemName,metrics:this.harmonyMetrics,kineticState:this.kineticState,musicalMemorySize:this.musicalMemory.recentTracks.length,currentTheme:this.currentTheme}}updateFromMusicAnalysis(t,i,n){if(!t)return;let r=t.genre;r&&r!==this._lastGenre&&this._applyGenrePalette(r).then(()=>{this._lastGenre=r,this._forcePaletteRepaint()}),this._updateMusicalMemory(t,n),this._updateKineticState(t),this._applyAestheticGravity(t),this._calculateMusicAwareDynamics(t)}_calculateMusicAwareDynamics(t){let{energy:i=.5,valence:n=.5,enhancedBPM:r=120,beatOccurred:a=!1}=t,s=this._calculateMusicIntensityMultiplier(i,n),o=this._calculateBeatPhase(r),l=(n-.5)*2,m=this._calculateHueShift(a,i,o);this.kineticState={...this.kineticState,musicIntensityMultiplier:s,beatPhase:o,valenceGravity:l,hueShift:m}}_calculateMusicIntensityMultiplier(t,i){let n=t*.7+i*.3,r=Math.abs(i-.5)*.4;return Math.max(.1,Math.min(2,n+r))}_calculateBeatPhase(t){let i=performance.now(),n=6e4/t;return i%n/n}_calculateHueShift(t,i,n){if(window.matchMedia("(prefers-reduced-motion: reduce)").matches)return 0;let r=this.config.artisticMode,a=r==="cosmic-maximum"?8:5,s=Math.sin(n*2*Math.PI)*a;t&&(s+=i*(r==="cosmic-maximum"?12:10));let o=r==="cosmic-maximum"?25:15;return Math.max(-o,Math.min(o,s))}_updateMusicalMemory(t,i){this.musicalMemory.recentTracks.unshift({trackUri:i,...t,timestamp:Date.now()}),this.musicalMemory.recentTracks.length>this.musicalMemory.maxMemorySize&&this.musicalMemory.recentTracks.pop(),this.musicalMemory.energyHistory.unshift(t.energy),this.musicalMemory.energyHistory.length>20&&this.musicalMemory.energyHistory.pop(),this.harmonyMetrics.temporalMemoryEvents++}_updateKineticState(t){let{energy:i,enhancedBPM:n,beatOccurred:r}=t,a=performance.now();r?(this.kineticState.lastBeatTime=a,this.kineticState.currentPulse=1):this.kineticState.currentPulse*=.95;let s=a-this.kineticState.lastBeatTime,o=6e4/(n||120);this.kineticState.breathingPhase=s%o/o*2*Math.PI,this.kineticState.visualMomentum=this.utils.lerp(this.kineticState.visualMomentum,i,.1)}_applyAestheticGravity(t){let{visualIntensity:i,valence:n,energy:r}=t,a=(n-.5)*2,s=(r-.5)*2,o=i;p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:{"--sn-gravity-x":a.toFixed(3),"--sn-gravity-y":s.toFixed(3),"--sn-gravity-strength":o.toFixed(3)},timestamp:Date.now()})}generateHarmonicVariations(t){let i=this.utils.rgbToOklab(t.r,t.g,t.b),n=Math.max(0,Math.min(1,i.L*.75)),r=this.utils.oklabToRgb(n,i.a,i.b),a=Math.max(0,Math.min(1,i.L*1.25)),s=this.utils.oklabToRgb(a,i.a,i.b);return{darkVibrantHex:this.utils.rgbToHex(r.r,r.g,r.b),lightVibrantHex:this.utils.rgbToHex(s.r,s.g,s.b)}}getCurrentGradient(t=5){try{if(!this.getCurrentActivePalette())return null;let n=this.utils.getRootStyle();if(!n)return this.generateFallbackGradient(t);let r=getComputedStyle(n),a=this.getInheritedGradientColors(r);if(!a)return u?.debug?.warn("ColorHarmonyEngine","Failed to inherit processed gradient variables, using fallback"),this.generateFallbackGradient(t);let s=[],o=this.kineticState.musicIntensityMultiplier||1,l=this.kineticState.hueShift||0,m=this.kineticState.valenceGravity||.5,d=this.emotionalState?.currentEmotion?.colorTemperature||.5,{primary:h,secondary:g,accent:f,emotional:v,tertiary:C}=a,P=[h,g,f,v,C];for(let E=0;E<t;E++){let L=E/(t-1),_;if(t===1)_=f;else{let B=L*(P.length-1),W=Math.floor(B),O=Math.min(W+1,P.length-1),I=B-W,re=Math.sin(d*Math.PI)*.3,Te=Math.max(0,Math.min(1,I+re)),ge=P[W],Ze=P[O];ge&&Ze?_={r:ge.r+(Ze.r-ge.r)*Te,g:ge.g+(Ze.g-ge.g)*Te,b:ge.b+(Ze.b-ge.b)*Te}:_=f}let G=this._applyConsciousnessModulation(_,{musicInfluence:o,valenceGravity:m,hueShift:l,emotionalTemperature:d,position:L});s.push({r:Math.round(Math.max(0,Math.min(255,G.r))),g:Math.round(Math.max(0,Math.min(255,G.g))),b:Math.round(Math.max(0,Math.min(255,G.b)))})}return this.config?.enableDebug&&console.log(`[ColorHarmonyEngine] Generated gradient with ${t} stops:`,s),s}catch(i){let n=i instanceof Error?i.message:"Unknown error",r={method:"getCurrentGradient",stopCount:t,currentTheme:this.currentTheme,kineticState:this.kineticState,timestamp:Date.now(),error:n};u?.debug?.error("ColorHarmonyEngine","Failed to generate gradient colors",r),p.emit("system:error",{systemName:"ColorHarmonyEngine",error:`Gradient generation failed: ${n}`,severity:"error",timestamp:Date.now()});try{let a=this.generateFallbackGradient(t);if(a&&a.length>0)return u?.debug?.warn("ColorHarmonyEngine","Using fallback gradient after error",{fallbackColorCount:a.length}),a}catch(a){u?.debug?.error("ColorHarmonyEngine","Fallback gradient generation also failed",a)}return null}}getInheritedGradientColors(t){try{let i=this.parseRGBVariable(t,"--sn-oklab-processed-primary-rgb")||this.parseRGBVariable(t,"--sn-bg-gradient-primary-rgb")||this.parseRGBVariable(t,"--sn-musical-harmony-primary-rgb"),n=this.parseRGBVariable(t,"--sn-oklab-processed-secondary-rgb")||this.parseRGBVariable(t,"--sn-bg-gradient-secondary-rgb")||this.parseRGBVariable(t,"--sn-musical-harmony-secondary-rgb"),r=this.parseRGBVariable(t,"--sn-oklab-processed-accent-rgb")||this.parseRGBVariable(t,"--sn-bg-gradient-accent-rgb")||this.parseRGBVariable(t,"--sn-color-accent-rgb"),a=this.parseRGBVariable(t,"--sn-oklab-emotional-temperature-rgb")||this.parseRGBVariable(t,"--sn-emotional-temperature-warm-rgb")||r,s=this.parseRGBVariable(t,"--sn-oklab-processed-bright-highlight-rgb")||this.parseRGBVariable(t,"--sn-consciousness-flow-rgb")||this.parseRGBVariable(t,"--sn-musical-harmony-tertiary-rgb");return!i||!r?(u?.debug?.warn("ColorHarmonyEngine","Missing essential inherited colors",{hasPrimary:!!i,hasAccent:!!r}),null):{primary:i,secondary:n||i,accent:r,emotional:a||r,tertiary:s||r}}catch(i){return u?.debug?.error("ColorHarmonyEngine","Failed to inherit gradient colors:",i),null}}parseRGBVariable(t,i){try{let n=t.getPropertyValue(i).trim();if(!n)return null;let r=n.match(/(\d+),\s*(\d+),\s*(\d+)/);return r&&r[1]&&r[2]&&r[3]?{r:parseInt(r[1],10),g:parseInt(r[2],10),b:parseInt(r[3],10)}:null}catch{return null}}interpolateOKLABColors(t,i,n){let a=Math.pow(t.r/255,2.2),s=Math.pow(t.g/255,2.2),o=Math.pow(t.b/255,2.2),l=Math.pow(i.r/255,2.2),m=Math.pow(i.g/255,2.2),d=Math.pow(i.b/255,2.2),h=a+(l-a)*n,g=s+(m-s)*n,f=o+(d-o)*n;return{r:Math.round(Math.pow(h,1/2.2)*255),g:Math.round(Math.pow(g,1/2.2)*255),b:Math.round(Math.pow(f,1/2.2)*255)}}_applyConsciousnessModulation(t,i){try{let n=this.utils.rgbToHsl(t.r,t.g,t.b),{h:r,s:a,l:s}=n;a=Math.max(0,Math.min(1,a*(.7+i.musicInfluence*.6))),r=(r+i.hueShift+(i.emotionalTemperature-.5)*60)%360;let o=i.valenceGravity*.2*Math.sin(i.position*Math.PI);s=Math.max(.1,Math.min(.9,s+o));let l=this.utils.hslToRgb(r,a,s);return{r:l.r,g:l.g,b:l.b}}catch{return t}}generateFallbackGradient(t){try{let i=["#1e1e2e","#313244","#45475a","#585b70","#cba6f7","#f5c2e7","#fab387"];(t<2||t>i.length)&&(u?.debug?.warn("ColorHarmonyEngine",`Invalid fallback stopCount: ${t}, using default`),t=Math.min(Math.max(t,2),i.length));let n=[];for(let r=0;r<t;r++){let a=Math.floor(r/(t-1)*(i.length-1)),s=i[a],o=s?this.utils.hexToRgb(s):null;o?n.push(o):n.push({r:203,g:166,b:247})}return n.length<2&&n.push({r:30,g:30,b:46},{r:203,g:166,b:247}),u?.debug?.log("ColorHarmonyEngine",`Generated fallback gradient with ${n.length} colors`,n),n}catch(i){return u?.debug?.error("ColorHarmonyEngine","Critical error in fallback gradient generation",i),null}}async analyzeMusicEmotion(t,i){if(!this.initialized||!this.musicEmotionAnalyzer)return this.config.enableDebug&&console.warn("\u{1F3AD} [ColorHarmonyEngine] Cannot analyze music emotion: not initialized"),null;try{let n=await this.musicEmotionAnalyzer.analyzeEmotion(t,i);return this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Analyzed music emotion: ${n.primary} (${n.intensity.toFixed(2)} intensity, ${n.confidence.toFixed(2)} confidence)`),n}catch(n){return console.error("\u{1F3AD} [ColorHarmonyEngine] Error analyzing music emotion:",n),null}}getCurrentEmotion(){return this.emotionalState?.currentEmotion||null}getEmotionHistory(t=10){return this.emotionalState?.emotionHistory?this.emotionalState.emotionHistory.slice(-t):[]}setEmotionInfluenceIntensity(t){this.emotionalState&&(this.emotionalState.emotionInfluenceIntensity=Math.max(0,Math.min(1,t)),this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Emotion influence intensity set to ${this.emotionalState.emotionInfluenceIntensity}`))}_createVariant(t,i,n,r){let a=this.utils.rgbToOklab(t.r,t.g,t.b),s=Math.max(0,Math.min(1,a.L+i*.2)),o=.8+n*.4,l=a.a*o,m=a.b*o,d=r*.1,h=l*Math.cos(d)-m*Math.sin(d),g=l*Math.sin(d)+m*Math.cos(d);return this.utils.oklabToRgb(s,h,g)}_applyMusicInfluence(t,i,n){let r=1+Math.sin(n*Math.PI)*.2,a=Math.max(.7,Math.min(1.3,i*r));return{r:t.r*a,g:t.g*a,b:t.b*a}}setIntensity(t){let i=Math.max(0,Math.min(1,t));this.userIntensity=i,this.config?.enableDebug&&console.log(`[ColorHarmonyEngine] User harmonic intensity set to ${i}`)}updatePalette(t){t?.length&&(this.config?.enableDebug&&console.log("[ColorHarmonyEngine] updatePalette invoked",{count:t.length}),this.forceRepaint("external-palette"))}_handleSettingsChange(t){let{key:i,value:n}=t.detail||{};switch(i){case qr:{let r=parseFloat(n);Number.isNaN(r)||this.setIntensity(r);break}case Yr:{let r=n==="true"||n===!0;this._setEvolutionEnabled(r);break}}}_handleArtisticModeChanged(){this.currentTheme=this.detectCurrentTheme(),this._pendingPaletteRefresh||(this._pendingPaletteRefresh=setTimeout(()=>{this._pendingPaletteRefresh=null,this.refreshPalette()},80))}_forcePaletteRepaint(){this.kineticState.hueShift=(this.kineticState.hueShift||0)+.01}_startEvolutionLoop(){if(this._evolutionTimer)return;let i=3e4/Math.max(.1,this.userIntensity);this._evolutionTimer=setInterval(()=>{let n=2*this.userIntensity,r=this.kineticState.hueShift??0;this.kineticState.hueShift=(r+n+360)%360-180},i)}_stopEvolutionLoop(){this._evolutionTimer&&(clearInterval(this._evolutionTimer),this._evolutionTimer=null)}_setEvolutionEnabled(t){this.evolutionEnabled!==t&&(this.evolutionEnabled=t,t?this._startEvolutionLoop():this._stopEvolutionLoop())}destroy(){this._stopEvolutionLoop(),document.removeEventListener("year3000SystemSettingsChanged",this._boundSettingsChangeHandler),document.removeEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),this.semanticColorManager&&this.semanticColorManager.destroy(),this.musicEmotionAnalyzer&&this.musicEmotionAnalyzer.destroy(),this.emotionalState&&(this.emotionalState.currentEmotion=null,this.emotionalState.emotionHistory=[]),super.destroy?.()}async refreshPalette(){try{let t=globalThis.year3000System;if(t?.updateColorsFromCurrentTrack){await t.updateColorsFromCurrentTrack();return}let i=this.utils.getRootStyle();if(!i)return;let r=getComputedStyle(i).getPropertyValue("--sn-gradient-primary").trim();if(r){let a=this.utils.hexToRgb(r),s={"--sn-bg-gradient-primary":r};a&&(s["--sn-bg-gradient-primary-rgb"]=`${a.r},${a.g},${a.b}`),p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:s,timestamp:Date.now()})}}catch(t){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] refreshPalette failed",t)}}async _applyGenrePalette(t){try{let i=await this._getGenreAwarePalette(t);if(!i)return;this.catppuccinPalettes[this.currentTheme]=i,await this.refreshPalette(),this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Genre changed to: ${t}`)}catch(i){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] _applyGenrePalette failed",i)}}setEmergentEngine(t){this.emergentEngine=t}calculateTemperatureBlendInfluence(t){let i=Math.max(0,Math.min(1,(t-1e3)/19e3));return t<=4e3?1+(4e3-t)/3e3*.3:t>=8e3?1.1+(t-8e3)/12e3*.2:.9+Math.abs(t-6e3)/2e3*.2}forceRepaint(t="settings-change"){this.refreshPalette?.()}determineOptimalOKLABPreset(t){let i=t.musicData,n=M.PRESETS.STANDARD;if(i){let{energy:r=.5,valence:a=.5}=i;r>.8&&a>.7?n=M.PRESETS.COSMIC:r>.7&&a<.4?n=M.PRESETS.VIBRANT:r<.3&&(n=M.PRESETS.SUBTLE)}return t.performanceHints?.preferLightweight&&(n=M.PRESETS.SUBTLE),this.config?.enableDebug&&console.log("\u{1F52C} [ColorHarmonyEngine] OKLAB preset selection:",{energy:i?.energy,valence:i?.valence,selectedPreset:n.name,reason:this.getPresetSelectionReason(i,t)}),n}async getAdvancedEmotionalTemperature(t,i){if(!this.emotionalTemperatureMapper||!t)return null;try{let n={energy:t.energy||.5,valence:t.valence||.5,danceability:t.danceability,tempo:t.tempo,loudness:t.loudness,acousticness:t.acousticness,instrumentalness:t.instrumentalness,speechiness:t.speechiness,mode:t.mode,key:t.key,genre:t.genre},r=await this.enhanceWithAlbumArtPsychology(n,i),a=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(r);return this.config?.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Advanced emotional temperature with album art enhancement:",{input:n,enhanced:r,albumArtInfluence:i?Object.keys(i).length+" colors":"None",emotion:a.primaryEmotion,secondaryEmotion:a.secondaryEmotion,intensity:a.intensity,temperature:a.temperature,oklabPreset:a.oklabPreset.name,perceptualColor:a.perceptualColorHex}),a}catch(n){return console.warn("[ColorHarmonyEngine] Advanced emotional temperature analysis failed:",n),null}}async enhanceWithAlbumArtPsychology(t,i){if(!i||Object.keys(i).length===0)return t;try{let n=this.analyzeAlbumArtPsychology(i),r={...t},a=r.energy||.5,s=r.valence||.5;if(n.warmth>.6&&(r.energy=Math.min(1,a*(1+n.warmth*.3)),r.valence=Math.min(1,s+n.warmth*.2)),n.coolness>.6&&(r.energy=Math.max(0,a*(1-n.coolness*.2)),n.saturation>.5&&(r.valence=Math.min(1,s+n.coolness*.15))),n.saturation>.7&&(r.energy=Math.min(1,a+n.saturation*.2)),n.saturation<.3&&(r.valence=Math.max(0,s-.15),r.energy=Math.max(0,a-.1)),n.darkness>.7){let o=r.energy||a;o>.6?r.energy=Math.min(1,o+.1):r.valence=Math.max(0,(r.valence||s)-.2)}return n.brightness>.8&&(r.valence=Math.min(1,(r.valence||s)+n.brightness*.2)),n.harmony>.8?r.valence=Math.min(1,(r.valence||s)+.1):n.harmony<.3&&(r.energy=Math.min(1,(r.energy||a)+.15)),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Album art psychology enhancement:",{original:{energy:t.energy||.5,valence:t.valence||.5},enhanced:{energy:r.energy||.5,valence:r.valence||.5},colorPsychology:n,adjustments:{energyChange:(r.energy||.5)-(t.energy||.5),valenceChange:(r.valence||.5)-(t.valence||.5)}}),r}catch(n){return console.warn("[ColorHarmonyEngine] Album art psychology enhancement failed:",n),t}}analyzeAlbumArtPsychology(t){try{let i=Object.values(t);if(i.length===0)return{warmth:.5,coolness:.5,saturation:.5,brightness:.5,darkness:.5,harmony:.5,dominantHue:180,emotionalIntensity:.5,genreIndicators:{electronicLikelihood:.5,organicLikelihood:.5,metalHardcoreLikelihood:.5,popCommercialLikelihood:.5,jazzClassicalLikelihood:.5,folkAcousticLikelihood:.5},artistConsciousness:{visualSophistication:.5,artisticIntention:.5,culturalIndicators:[],emotionalDepth:.5}};let n=0,r=0,a=0,s=0,o=0,l=[];for(let G of i){let B=this.utils.hexToRgb(G);if(!B)continue;let W=this.utils.rgbToHsl(B.r,B.g,B.b),{h:O,s:I,l:re}=W;l.push(O),O>=0&&O<=60||O>=300&&O<=360?n+=I*re:O>=120&&O<=240&&(r+=I*re),a+=I,s+=re,o+=1-re}let m=i.length,d=n/m,h=r/m,g=a/m,f=s/m,v=o/m,C=this.calculateColorHarmony(l),P=this.calculateDominantHue(l),E=Math.min(1,(g+this.calculateContrast(i))/2),L=this._analyzeGenreIndicatorsFromColors({warmth:Math.min(1,d),coolness:Math.min(1,h),saturation:g,brightness:f,darkness:v,harmony:C,dominantHue:P,emotionalIntensity:E}),_=this._analyzeArtistConsciousness(i,{avgSaturation:g,avgBrightness:f,harmony:C,emotionalIntensity:E,colorCount:i.length});return{warmth:Math.min(1,d),coolness:Math.min(1,h),saturation:g,brightness:f,darkness:v,harmony:C,dominantHue:P,emotionalIntensity:E,genreIndicators:L,artistConsciousness:_}}catch(i){return console.warn("[ColorHarmonyEngine] Album art psychology analysis failed:",i),{warmth:.5,coolness:.5,saturation:.5,brightness:.5,darkness:.5,harmony:.5,dominantHue:180,emotionalIntensity:.5,genreIndicators:{electronicLikelihood:.5,organicLikelihood:.5,metalHardcoreLikelihood:.5,popCommercialLikelihood:.5,jazzClassicalLikelihood:.5,folkAcousticLikelihood:.5},artistConsciousness:{visualSophistication:.5,artisticIntention:.5,culturalIndicators:[],emotionalDepth:.5}}}}calculateColorHarmony(t){if(t.length<=1)return 1;let i=0,n=[60,120,30,90];for(let a=0;a<t.length;a++)for(let s=a+1;s<t.length;s++){let o=t[a],l=t[s];if(o===void 0||l===void 0)continue;let m=Math.abs(o-l),d=Math.min(m,360-m);for(let h of n)Math.abs(d-h)<=15&&(i+=1)}let r=t.length*(t.length-1)/2;return Math.min(1,i/r)}calculateDominantHue(t){if(t.length===0)return 180;let i=new Array(12).fill(0);for(let r of t){let a=Math.floor(r/30);i[a]++}return i.indexOf(Math.max(...i))*30+15}calculateContrast(t){if(t.length<=1)return 0;let i=0,n=0;for(let r=0;r<t.length;r++)for(let a=r+1;a<t.length;a++){let s=t[r],o=t[a];if(!s||!o)continue;let l=this.utils.hexToRgb(s),m=this.utils.hexToRgb(o);if(l&&m){let d=(l.r*.299+l.g*.587+l.b*.114)/255,h=(m.r*.299+m.g*.587+m.b*.114)/255;i+=Math.abs(d-h),n++}}return n>0?i/n:0}async blendWithAdvancedOKLAB(t,i,n,r){let a={...t};try{let s=n?.oklabPreset||this.oklabState.currentPreset,o=s;r&&r.confidence>.5&&this.genreState.genreInfluenceIntensity>0&&(o=this.applyGenreColorAesthetics(s,r));let l=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let d of l){let h=t[d];if(h&&this.isValidHex(h))try{let g=r?`-${r.genre}`:"",f=`${h}-${o.name}${g}`;if(this.oklabState.processedPalette[f]){a[d]=this.oklabState.processedPalette[f].enhancedHex;continue}let v=this.oklabProcessor.processColor(h,o);a[d]=v.enhancedHex,this.oklabState.processedPalette[f]=v,this.config?.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] OKLAB enhanced ${d}:`,{original:h,enhanced:v.enhancedHex,preset:s.name,processingTime:v.processingTime})}catch(g){console.warn(`[ColorHarmonyEngine] OKLAB processing failed for ${d}:`,g)}}if(n?.perceptualColorHex&&a.PRIMARY)try{let d=this.oklabProcessor.interpolateOKLAB(a.PRIMARY,n.perceptualColorHex,n.intensity*.3,s);a.EMOTIONAL_BLEND=d.enhancedHex,this.config?.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Emotional color blending:",{primary:a.PRIMARY,emotionalColor:n.perceptualColorHex,blendFactor:n.intensity*.3,result:d.enhancedHex})}catch(d){console.warn("[ColorHarmonyEngine] Emotional color blending failed:",d)}this.oklabState.lastProcessingTime=Date.now();let m=this.getAlbumArtInfluenceSetting();if(m>0&&t&&Object.keys(t).length>0)try{let d=await this._applyDirectAlbumColorBlending(a,t,m,o);Object.assign(a,d),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Applied direct album color blending:",{albumInfluence:(m*100).toFixed(1)+"%",blendedKeys:Object.keys(d),note:"album colors now directly influence final UI colors"})}catch(d){console.warn("[ColorHarmonyEngine] Direct album color blending failed:",d)}if(this.semanticColorManager)try{this.semanticColorManager.updateWithAlbumColors(a),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Applied comprehensive Spicetify variable updates via strategy pattern:",{processedColorCount:Object.keys(a).length,methodUsed:"blendWithAdvancedOKLAB"})}catch(d){console.warn("[ColorHarmonyEngine] Failed to update Spicetify variables via strategy pattern:",d)}}catch(s){console.error("[ColorHarmonyEngine] Advanced OKLAB blending failed:",s)}return a}generateAdvancedOKLABCSSVariables(t){let i={};try{if(Object.entries(t.processedColors).forEach(([n,r])=>{r&&typeof r=="string"&&(i[`--sn-processed-${n.toLowerCase()}`]=r)}),Object.entries(this.oklabState.processedPalette).forEach(([n,r])=>{let[a,s]=n.split("-");if(a&&s){let o=`sn-oklab-${s.toLowerCase()}`,l=this.oklabProcessor.generateCSSVariables(r,o);Object.assign(i,l)}}),this.oklabState.perceptualGradientCache.size>0){let n=Array.from(this.oklabState.perceptualGradientCache.entries()),[r,a]=n[0]||[];if(a&&a.length>0){a.forEach((o,l)=>{let m=l/(a.length-1)*100;i[`--sn-oklab-gradient-stop-${l}`]=o.enhancedHex,i[`--sn-oklab-gradient-stop-${l}-rgb`]=`${o.enhancedRgb.r},${o.enhancedRgb.g},${o.enhancedRgb.b}`,i[`--sn-oklab-gradient-stop-${l}-pos`]=`${m}%`});let s=a.map((o,l)=>{let m=l/(a.length-1)*100;return`${o.enhancedHex} ${m}%`}).join(", ");i["--sn-oklab-perceptual-gradient"]=`linear-gradient(135deg, ${s})`,i["--sn-oklab-gradient-stop-count"]=a.length.toString()}}if(t.processedColors.EMOTIONAL_BLEND){i["--sn-consciousness-emotional-color"]=t.processedColors.EMOTIONAL_BLEND;let n=ae(t.processedColors.EMOTIONAL_BLEND);n&&(i["--sn-consciousness-emotional-rgb"]=`${n.r},${n.g},${n.b}`)}i["--sn-oklab-preset-active"]=this.oklabState.currentPreset.name,i["--sn-oklab-cache-size"]=Object.keys(this.oklabState.processedPalette).length.toString(),i["--sn-oklab-last-processing"]=this.oklabState.lastProcessingTime.toString(),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Generated advanced OKLAB CSS variables:",{totalVariables:Object.keys(i).length,gradientStops:this.oklabState.perceptualGradientCache.size,oklabProcessedColors:Object.keys(this.oklabState.processedPalette).length})}catch(n){console.error("[ColorHarmonyEngine] Advanced OKLAB CSS variable generation failed:",n)}return i}generatePerceptualGradientData(t){try{let i=t.processedColors.PRIMARY,n=t.processedColors.SECONDARY||t.processedColors.EMOTIONAL_BLEND;if(!i||!this.isValidHex(i))return;let r=i,a=n&&this.isValidHex(n)?n:this.generateComplementaryColor(i),s=`${r}-${a}-${this.oklabState.currentPreset.name}`;if(this.oklabState.perceptualGradientCache.has(s))return;let o=7,l=this.oklabProcessor.generateOKLABGradient(r,a,o,this.oklabState.currentPreset);if(this.oklabState.perceptualGradientCache.set(s,l),this.oklabState.perceptualGradientCache.size>10){let m=this.oklabState.perceptualGradientCache.keys().next().value;m&&this.oklabState.perceptualGradientCache.delete(m)}this.config?.enableDebug&&console.log("\u{1F308} [ColorHarmonyEngine] Generated perceptual gradient data:",{startColor:r,endColor:a,stopCount:o,preset:this.oklabState.currentPreset.name,cacheKey:s,cacheSize:this.oklabState.perceptualGradientCache.size})}catch(i){console.error("[ColorHarmonyEngine] Perceptual gradient generation failed:",i)}}updateAdvancedHarmonyMetrics(t,i){try{let n=t.processedColors.PRIMARY,r=t.processedColors.SECONDARY,a=.5;if(n&&this.isValidHex(n)){let o=ae(n);if(o){let l=this.calculateColorVibrancy(o);a=Math.min(1,l*.8+.2)}}let s={processingTime:i,harmonyScore:a,oklabProcessedColors:Object.keys(this.oklabState.processedPalette).length,perceptualGradientsCached:this.oklabState.perceptualGradientCache.size,currentPreset:this.oklabState.currentPreset.name,lastUpdate:Date.now()};t.metadata&&(t.metadata.advancedHarmonyMetrics=s),this.config?.enableDebug&&console.log("\u{1F4CA} [ColorHarmonyEngine] Advanced harmony metrics updated:",s)}catch(n){console.error("[ColorHarmonyEngine] Advanced harmony metrics update failed:",n)}}getPresetSelectionReason(t,i){if(!t)return"No music data available";let{energy:n=.5,valence:r=.5}=t;return i.performanceHints?.preferLightweight?"Performance optimization requested":n>.8&&r>.7?"High energy + positive valence":n>.7&&r<.4?"High energy + negative valence":n<.3?"Low energy music":"Standard balanced processing"}generateComplementaryColor(t){try{let i=ae(t);if(!i)return t;let n=this.rgbToHsl(i.r,i.g,i.b),r=(n.h+180)%360,a=this.hslToRgb(r,n.s,n.l);return ye(a.r,a.g,a.b)}catch(i){return console.warn("[ColorHarmonyEngine] Complementary color generation failed:",i),t}}calculateColorVibrancy(t){let i=Math.max(t.r,t.g,t.b),n=Math.min(t.r,t.g,t.b),r=i-n;if(i===0)return 0;let a=r/i,s=i/255,o=1-Math.abs(s-.5)*2;return a*o}isValidHex(t){return/^#[0-9A-Fa-f]{6}$/.test(t)}rgbToHsl(t,i,n){t/=255,i/=255,n/=255;let r=Math.max(t,i,n),a=Math.min(t,i,n),s=r-a,o=0,l=0,m=(r+a)/2;if(s!==0){switch(l=m>.5?s/(2-r-a):s/(r+a),r){case t:o=(i-n)/s+(i<n?6:0);break;case i:o=(n-t)/s+2;break;case n:o=(t-i)/s+4;break}o/=6}return{h:o*360,s:l,l:m}}hslToRgb(t,i,n){t/=360;let r=(l,m,d)=>(d<0&&(d+=1),d>1&&(d-=1),d<1/6?l+(m-l)*6*d:d<1/2?m:d<2/3?l+(m-l)*(2/3-d)*6:l),a,s,o;if(i===0)a=s=o=n;else{let l=n<.5?n*(1+i):n+i-n*i,m=2*n-l;a=r(m,l,t+1/3),s=r(m,l,t),o=r(m,l,t-1/3)}return{r:Math.round(a*255),g:Math.round(s*255),b:Math.round(o*255)}}async analyzeGenreAesthetics(t,i){try{if(!this.genreGradientEvolution)return null;let n=this.genreGradientEvolution.getCurrentGenre(),r=this.genreGradientEvolution.getGenreConfidence();if(r<.3)return null;let a=this.genreGradientEvolution.getGenreCharacteristics(n),s=this.genreGradientEvolution.getGenreVisualStyle(n),o=1,l=r;if(i&&Object.keys(i).length>0)try{o=this._analyzeAlbumGenreHarmony(i,n,a).harmonyScore,l=r*o,this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Album-Genre harmony analysis:",{genre:n,originalConfidence:(r*100).toFixed(1)+"%",harmonyScore:(o*100).toFixed(1)+"%",validatedConfidence:(l*100).toFixed(1)+"%",albumColorCount:Object.keys(i).length})}catch(m){console.warn("[ColorHarmonyEngine] Album-genre harmony analysis failed:",m)}return this.genreState.currentGenre=n,this.genreState.genreConfidence=l,this.genreState.lastGenreUpdate=Date.now(),this.genreState.genreHistory.unshift({genre:n,confidence:l,timestamp:Date.now()}),this.genreState.genreHistory.length>10&&(this.genreState.genreHistory=this.genreState.genreHistory.slice(0,10)),this.config.enableDebug&&console.log(`\u{1F3B6} [ColorHarmonyEngine] Genre aesthetic analysis: ${n} (${(l*100).toFixed(1)}% album-validated confidence)`),{genre:n,confidence:l,characteristics:a,visualStyle:s}}catch(n){return console.warn("[ColorHarmonyEngine] Error analyzing genre aesthetics:",n),null}}applyGenreColorAesthetics(t,i){let{characteristics:n,visualStyle:r,confidence:a}=i,s={...t,name:`${t.name}-${i.genre}`,description:`${t.description} with ${i.genre} aesthetic characteristics`},o=a*this.genreState.genreInfluenceIntensity;return n.saturation>.7?s.chromaBoost=Math.min(2,t.chromaBoost+.3*o):n.saturation<.3&&(s.chromaBoost=Math.max(.8,t.chromaBoost-.2*o)),n.harmonicComplexity>.7?s.vibrantThreshold=Math.max(.05,t.vibrantThreshold-.05*o):n.harmonicComplexity<.3&&(s.vibrantThreshold=Math.min(.2,t.vibrantThreshold+.03*o)),n.emotionalRange>.7&&n.organicness>.6?s.lightnessBoost=Math.max(.9,t.lightnessBoost-.1*o):n.artificialProcessing>.7&&(s.lightnessBoost=Math.min(1.4,t.lightnessBoost+.2*o)),r.contrastLevel>.7?s.shadowReduction=Math.max(.1,t.shadowReduction-.1*o):n.organicness>.6&&(s.shadowReduction=Math.min(.5,t.shadowReduction+.1*o)),this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Applied ${i.genre} aesthetics to ${t.name} preset:`,{chromaBoost:`${t.chromaBoost} \u2192 ${s.chromaBoost}`,lightnessBoost:`${t.lightnessBoost} \u2192 ${s.lightnessBoost}`,vibrantThreshold:`${t.vibrantThreshold} \u2192 ${s.vibrantThreshold}`,genreInfluence:`${(o*100).toFixed(1)}%`}),s}_analyzeAlbumGenreHarmony(t,i,n){try{let r=1,a=[],s=Object.entries(t).map(([O,I])=>{let re=this.utils.hexToRgb(I);return re?this.utils.rgbToHsl(re.r,re.g,re.b):null}).filter(O=>O!==null);if(s.length===0)return{harmonyScore:1,explanation:"No valid album colors found"};let o=s.reduce((O,I)=>O+I.s,0)/s.length,l=n.saturation||.5,m=Math.abs(o/100-l);m<.2?(r*=1.1,a.push(`album saturation matches genre (\xB1${(m*100).toFixed(1)}%)`)):m>.4&&(r*=.85,a.push(`album saturation differs from genre expectations (${(m*100).toFixed(1)}% diff)`));let d=s.reduce((O,I)=>O+I.h,0)/s.length,h=d>=15&&d<=45||d>=315&&d<=345,g=d>=180&&d<=270,f=n.energyLevel||.5;f>.6&&h?(r*=1.15,a.push("warm album colors match high-energy genre")):f<.4&&g?(r*=1.1,a.push("cool album colors match low-energy genre")):(f>.6&&g||f<.4&&h)&&(r*=.9,a.push("album color temperature differs from genre energy"));let v=s.reduce((O,I)=>O+I.l,0)/s.length,C=v<40,P=v>70;i.includes("metal")||i.includes("goth")||i.includes("dark")?C?(r*=1.2,a.push("dark album aesthetic matches genre")):P&&(r*=.8,a.push("bright album conflicts with dark genre aesthetic")):(i.includes("pop")||i.includes("dance")||i.includes("electronic"))&&P&&(r*=1.15,a.push("bright album aesthetic matches energetic genre"));let E=s.map(O=>O.h),L=Math.max(...E)-Math.min(...E),_=L<30,G=L>120,B=n.harmonicComplexity||.5;B>.7&&G?(r*=1.1,a.push("diverse album colors match complex genre")):B<.3&&_&&(r*=1.1,a.push("unified album colors match simple genre")),r=Math.max(.7,Math.min(1.3,r));let W=a.length>0?a.join("; "):"album colors analyzed for genre harmony";return{harmonyScore:r,explanation:W}}catch(r){return console.warn("[ColorHarmonyEngine] Album-genre harmony analysis error:",r),{harmonyScore:1,explanation:"harmony analysis failed, using default confidence"}}}getAlbumArtInfluenceSetting(){return .5}async _applyDirectAlbumColorBlending(t,i,n,r){let a={};try{let s=this._extractDominantAlbumColors(i);if(s.length===0)return{};let o=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING"];for(let l of o){let m=t[l];if(!(!m||!this.isValidHex(m)))try{let d=this._selectHarmoniousAlbumColor(m,s);if(d){let h=this.oklabProcessor.interpolateOKLAB(m,d,n*.6,r);a[l]=h.enhancedHex,this.config?.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Album-blended ${l}:`,{original:m,albumColor:d,blended:h.enhancedHex,blendFactor:(n*.6).toFixed(2)})}}catch(d){console.warn(`[ColorHarmonyEngine] Album blending failed for ${l}:`,d)}}if(s.length>0&&n>.3)try{let l=this._selectMostVibrantColor(s);if(l){let m=this.oklabProcessor.processColor(l,r);a.ALBUM_ACCENT=m.enhancedHex,this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Created ALBUM_ACCENT:",{source:l,enhanced:m.enhancedHex})}}catch(l){console.warn("[ColorHarmonyEngine] Album accent creation failed:",l)}return a}catch(s){return console.error("[ColorHarmonyEngine] Direct album color blending error:",s),{}}}_extractDominantAlbumColors(t){let i=[],n=["VIBRANT","DOMINANT","PRIMARY","PROMINENT","LIGHT_VIBRANT","DARK_VIBRANT"];for(let r of n){let a=t[r];a&&this.isValidHex(a)&&i.push(a)}return i.length<3&&Object.values(t).forEach(r=>{r&&this.isValidHex(r)&&!i.includes(r)&&i.push(r)}),i.slice(0,5)}_selectHarmoniousAlbumColor(t,i){if(i.length===0)return null;try{let n=this.utils.hexToRgb(t);if(!n)return i[0]||null;let r=this.utils.rgbToHsl(n.r,n.g,n.b),a=i[0]||null,s=0;for(let o of i){let l=this.utils.hexToRgb(o);if(!l)continue;let m=this.utils.rgbToHsl(l.r,l.g,l.b),d=Math.abs(r.h-m.h),h=Math.min(d,360-d),g=0;h<30?g=.9:h>150&&h<210?g=.8:h>90&&h<150?g=.6:g=.4,Math.abs(r.s-m.s)<20&&(g+=.1),g>s&&(s=g,a=o)}return a}catch(n){return console.warn("[ColorHarmonyEngine] Harmonious color selection failed:",n),i[0]||null}}_selectMostVibrantColor(t){if(t.length===0)return null;try{let i=t[0]||null,n=0;for(let r of t){let a=this.utils.hexToRgb(r);if(!a)continue;let s=this.utils.rgbToHsl(a.r,a.g,a.b),o=s.s/100*(1-Math.abs(s.l-50)/50);o>n&&(n=o,i=r)}return i}catch(i){return console.warn("[ColorHarmonyEngine] Most vibrant color selection failed:",i),t[0]||null}}_analyzeGenreIndicatorsFromColors(t){let{warmth:i,coolness:n,saturation:r,brightness:a,darkness:s,harmony:o,dominantHue:l,emotionalIntensity:m}=t,d=Math.min(1,r*.4+n*.3+(a>.7||s<.3?.2:0)+(l>=180&&l<=270?.1:0)),h=Math.min(1,(i>n?i:0)*.3+(r>=.3&&r<=.7?.3:0)+(a>=.4&&a<=.7?.2:0)+o*.2),g=Math.min(1,s*.4+m*.3+(l>=0&&l<=30||l>=330?.2:0)+(r>.6||r<.2?.1:0)),f=Math.min(1,(a>.6?a*.3:0)+r*.3+(i>.5?i*.2:0)+(m>.5?.2:0)),v=Math.min(1,o*.4+(r>=.4&&r<=.8?.3:0)+(a>=.3&&a<=.8?.2:0)+(i+n)/2*.1),C=Math.min(1,i*.4+(r>=.2&&r<=.6?.3:0)+o*.2+(l>=15&&l<=60?.1:0));return{electronicLikelihood:d,organicLikelihood:h,metalHardcoreLikelihood:g,popCommercialLikelihood:f,jazzClassicalLikelihood:v,folkAcousticLikelihood:C}}_analyzeArtistConsciousness(t,i){let{avgSaturation:n,avgBrightness:r,harmony:a,emotionalIntensity:s,colorCount:o}=i,l=Math.min(1,a*.4+(o>2&&o<=5?.3:.1)+(n>=.3&&n<=.8?.2:0)+(r>=.2&&r<=.8?.1:0)),m=Math.min(1,a*.5+s*.3+(o>=2&&o<=4?.2:0)),d=[];n>.8&&s>.7&&d.push("high-energy-culture"),a>.7&&n<.6&&d.push("minimalist-aesthetic"),r<.3&&s>.6&&d.push("dark-artistic"),r>.7&&n>.6&&d.push("commercial-pop");let h=Math.min(1,s*.5+(n>.4?.2:0)+(a>.5?.2:0)+(o>=3?.1:0));return{visualSophistication:l,artisticIntention:m,culturalIndicators:d,emotionalDepth:h}}};Le.CANONICAL_HEX_VAR="--sn-accent-hex",Le.CANONICAL_RGB_VAR="--sn-accent-rgb";Ye=Le});var ct,Ra=b(()=>{"use strict";ct=class{static async getAudioData(){try{return typeof Spicetify<"u"&&Spicetify.getAudioData?await Spicetify.getAudioData():(console.warn("[SpicetifyCompat] Spicetify.getAudioData not available"),null)}catch(e){return console.error("[SpicetifyCompat] Error fetching audio data:",e),null}}static isAvailable(){return typeof Spicetify<"u"&&!!Spicetify.getAudioData}static async getAudioDataWithRetry(e=200,t=10){for(let i=0;i<t;i++)try{let n=await this.getAudioData();if(n)return n}catch(n){i<t-1?(console.log(`[SpicetifyCompat] Retrying audio data fetch (${i+1}/${t})...`),await new Promise(r=>setTimeout(r,e))):console.warn(`[SpicetifyCompat] Audio data fetch failed after ${t} attempts:`,n)}return null}}});var Ke,Be,mi=b(()=>{"use strict";U();ne();Ke={electronic:{energyBoost:1.1,beatEmphasis:1.2,precision:.9,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"dynamic"}},dance:{energyBoost:1.2,beatEmphasis:1.25,precision:.95,oklabPreset:"COSMIC",colorCharacteristics:{vibrancyLevel:"cosmic",emotionalRange:"extreme",colorTemperature:"dynamic"}},house:{energyBoost:1.2,beatEmphasis:1.25,precision:.95,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"warm"}},techno:{energyBoost:1.15,beatEmphasis:1.3,precision:1,oklabPreset:"COSMIC",colorCharacteristics:{vibrancyLevel:"cosmic",emotionalRange:"extreme",colorTemperature:"cool"}},trance:{energyBoost:1.15,beatEmphasis:1.1,precision:.85,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"dynamic"}},rock:{energyBoost:1.05,intensityMultiplier:1.1,dynamicRange:1.1,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"warm"}},metal:{energyBoost:1.15,intensityMultiplier:1.2,dynamicRange:1.2,oklabPreset:"COSMIC",colorCharacteristics:{vibrancyLevel:"cosmic",emotionalRange:"extreme",colorTemperature:"cool"}},punk:{energyBoost:1.2,intensityMultiplier:1.1,precision:.8,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"dynamic"}},hiphop:{beatEmphasis:1.3,grooveFactor:1.2,tempoMultiplier:.95,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"warm"}},rap:{beatEmphasis:1.3,grooveFactor:1.2,tempoMultiplier:.95,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"}},jazz:{adaptiveVariation:!0,complexity:1.2,smoothingFactor:1.3,oklabPreset:"SUBTLE",colorCharacteristics:{vibrancyLevel:"subtle",emotionalRange:"wide",colorTemperature:"warm"}},classical:{gentleMode:!0,dynamicRange:1.4,tempoVariationHandling:"adaptive",oklabPreset:"SUBTLE",colorCharacteristics:{vibrancyLevel:"subtle",emotionalRange:"extreme",colorTemperature:"neutral"}},ambient:{subtleMode:!0,intensityReduction:.7,smoothingFactor:1.5,oklabPreset:"SUBTLE",colorCharacteristics:{vibrancyLevel:"subtle",emotionalRange:"narrow",colorTemperature:"cool"}},pop:{energyBoost:1.05,beatEmphasis:1.1,precision:.85,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"warm"}},rnb:{grooveFactor:1.25,smoothingFactor:1.1,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"warm"}},soul:{grooveFactor:1.3,smoothingFactor:1.15,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"wide",colorTemperature:"warm"}},default:{balanced:!0,energyBoost:1,beatEmphasis:1,precision:1,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"}}},Be=class{constructor(e={}){this.config=e.YEAR3000_CONFIG||w,this.config.enableDebug&&console.log("\u{1F9EC} [GenreProfileManager] Initialized")}_getGenreFromAudioFeatures(e){if(!e)return"default";let{danceability:t=.5,energy:i=.5,acousticness:n=.5,instrumentalness:r=.5,tempo:a=120}=e;return r>.6&&n<.2&&i>.6?a>120?"techno":"electronic":t>.7&&i>.7?"dance":n>.7&&i<.4?"classical":n>.5&&r<.1?"jazz":i>.7&&r<.1&&t>.5?"rock":t>.7&&r<.2&&i>.5&&a<110?"hiphop":"default"}getProfileForTrack(e){let t=this._getGenreFromAudioFeatures(e),i=Ke[t];if(this.config.enableDebug&&console.log(`[GenreProfileManager] Detected genre: '${t}'. Applying profile.`),i)return i;let n=Ke.default;if(n)return n;throw new Error("[GenreProfileManager] Critical: Default genre profile is missing.")}detectGenre(e){return this._getGenreFromAudioFeatures(e)}getOKLABPresetForGenre(e){let t=Ke[e]||Ke.default,i=t.oklabPreset||"STANDARD";try{let n=M.getPreset(i);return this.config.enableDebug&&console.log(`\u{1F9EC} [GenreProfileManager] OKLAB preset for genre '${e}':`,{genre:e,preset:i,colorCharacteristics:t.colorCharacteristics}),n}catch(n){return this.config.enableDebug&&console.warn(`\u{1F9EC} [GenreProfileManager] Failed to get OKLAB preset '${i}' for genre '${e}', using STANDARD:`,n),M.getPreset("STANDARD")}}getOKLABPresetForTrack(e){let t=this.detectGenre(e);return this.getOKLABPresetForGenre(t)}getColorCharacteristicsForGenre(e){let i=(Ke[e]||Ke.default).colorCharacteristics||{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"};return this.config.enableDebug&&console.log(`\u{1F9EC} [GenreProfileManager] Color characteristics for genre '${e}':`,i),i}getColorCharacteristicsForTrack(e){let t=this.detectGenre(e);return this.getColorCharacteristicsForGenre(t)}createContextualOKLABPreset(e,t=1,i="contextual"){let n=this.detectGenre(e),r=this.getOKLABPresetForGenre(n),a=this.getColorCharacteristicsForGenre(n),s=e.energy||.5,o=e.danceability||.5,l=(s+o)/2*t,m=r.chromaBoost*(.8+l*.4),d=r.lightnessBoost*(.9+l*.2),h=M.createCustomPreset(`${n}-${i}`,`Contextual ${r.description} for ${n}`,d,m,r.shadowReduction,r.vibrantThreshold);return this.config.enableDebug&&console.log("\u{1F9EC} [GenreProfileManager] Created contextual OKLAB preset:",{genre:n,basePreset:r.name,contextualPreset:h.name,adjustments:{chromaBoost:`${r.chromaBoost} \u2192 ${m}`,lightnessBoost:`${r.lightnessBoost} \u2192 ${d}`,intensityMultiplier:t,combinedIntensity:l}}),h}getAllGenreOKLABMappings(){let e={};return Object.entries(Ke).forEach(([t,i])=>{e[t]={preset:i.oklabPreset||"STANDARD",characteristics:i.colorCharacteristics}}),this.config.enableDebug&&console.log("\u{1F9EC} [GenreProfileManager] All genre-OKLAB mappings:",e),e}}});var Y,Ce,di=b(()=>{"use strict";U();D();K();Ra();fe();mi();ne();Ae();Y={enableDebug:!0,enableBeatSynchronization:!0,enableGenreAnalysis:!0,enableMoodAdaptation:!0,bpmCalculation:{useEnhancedAlgorithm:!0,danceabilityWeight:.9,energyWeight:.6,bpmWeight:.6,energyThreshold:.5,danceabilityThreshold:.5,bpmThreshold:.8,maxBPM:180,minBPM:60},performance:{cacheSize:100,cacheTTL:3e5,maxRetries:10,retryDelay:200,enableMetrics:!0,processingTimeTarget:50},synchronization:{beatAccuracyTarget:50,maxSyncDelay:1e3,adaptiveQuality:!0,predictiveCaching:!0,debounceRapidChanges:200},genreProfiles:{electronic:{intensityMultiplier:1.2,precisionBoost:1.1},jazz:{smoothingFactor:1.3,adaptiveVariation:!0},classical:{gentleMode:!0,tempoVariationHandling:"adaptive"},rock:{energyBoost:1.15,consistentTiming:!0},ambient:{subtleMode:!0,intensityReduction:.7},hiphop:{beatEmphasis:1.25,rhythmPrecision:"high"},default:{balanced:!0}},musicVisualSync:{enhancedBPM:{fallbacks:{tempo:120,loudness:-5,key:0,timeSignature:4},danceabilityEstimation:{highDance:{min:125,max:145,value:.8},mediumDance:{min:100,max:124,value:.7},lowMediumDance:{min:80,max:99,value:.6},lowDance:{value:.5}},energyEstimation:{tempoRange:{min:80,max:160},loudnessRange:{min:-15,max:0},tempoWeight:.6,loudnessWeight:.4}}}},Ce=class{constructor(e={}){this.isInitialized=!1;this.currentTrack=null;this.audioData=null;this.currentTrackUri=null;this.latestProcessedData=null;this.beatSchedulerTimer=null;this.songChangeDebounceTimer=null;this.nextBeatIndex=0;this.currentSongBeats=[];this.songStartTimestamp=0;this.metrics={bpmCalculations:0,beatSyncs:0,cacheHits:0,cacheMisses:0,avgProcessingTime:0,performance:[],errors:0,updates:0};this.unifiedCache=new Map;this.subscribers=new Map;this.beatSync={lastBeatTime:0,nextBeatTime:0,beatInterval:0,confidence:0,isActive:!1};this.performanceInterval=null;this.cacheCleanupInterval=null;this.CACHE_KEY_VERSION_PREFIX="v3";this.eventProcessingState={isProcessingEvent:!1,eventChain:[],lastEventTime:0,consecutiveEvents:0};this.MAX_CONSECUTIVE_EVENTS=5;this.EVENT_RESET_TIMEOUT=3e3;this.currentBeatVector={x:0,y:0};this.config=e.YEAR3000_CONFIG||w,this.utils=e.Year3000Utilities||A,this.settingsManager=e.settingsManager,this.year3000System=e.year3000System,this.genreProfileManager=e.genreProfileManager||new Be({YEAR3000_CONFIG:this.config}),this.oklabProcessor=new M(this.config.enableDebug),this.emotionalTemperatureMapper=new J(this.config.enableDebug),this.cacheTTL=Y.performance.cacheTTL,this.userPreferences=this.loadUserPreferences(),this.config.enableDebug&&(console.log("\u{1F3B5} MusicSyncService constructor called"),console.log("\u{1F3B5} [MusicSyncService] Initialized with GenreProfileManager support"))}get initialized(){return this.isInitialized}async initialize(){try{this.config.enableDebug&&console.log("\u{1F3B5} Initializing unified MusicSyncService..."),ct.isAvailable()||console.warn("[MusicSyncService] Spicetify audio data API not available at initialization. Some features may be limited."),this.setupCacheManagement(),Y.performance.enableMetrics&&this.setupPerformanceMonitoring(),this.isInitialized=!0,this.config.enableDebug&&console.log("\u{1F31F} MusicSyncService initialized successfully!")}catch(e){console.error("\u274C MusicSyncService initialization failed:",e),this.metrics.errors++}}subscribe(e,t){if(!e||typeof e.updateFromMusicAnalysis!="function"){console.warn(`[MusicSyncService] Invalid system or missing updateFromMusicAnalysis method: ${t}`);return}if(this.subscribers.has(t)){this.config.enableDebug&&console.warn(`[MusicSyncService] System ${t} already subscribed.`);return}if(this.subscribers.set(t,e),this.config.enableDebug&&console.log(`[MusicSyncService] System subscribed: ${t}`),this.latestProcessedData&&e.initialized)try{e.updateFromMusicAnalysis(this.latestProcessedData,null,this.currentTrackUri)}catch(i){console.error(`[MusicSyncService] Error notifying new subscriber ${t}:`,i)}}unsubscribe(e){this.subscribers.has(e)&&(this.subscribers.delete(e),this.config.enableDebug&&console.log(`[MusicSyncService] System unsubscribed: ${e}`))}notifySubscribers(e,t,i){if(!this.isInitialized){console.warn("[MusicSyncService] Not initialized, cannot notify subscribers.");return}this.latestProcessedData=e;for(let[n,r]of this.subscribers)try{r.initialized&&typeof r.updateFromMusicAnalysis=="function"&&r.updateFromMusicAnalysis(e,t,i)}catch(a){console.error(`[MusicSyncService] Error notifying subscriber ${n}:`,a),this.metrics.errors++}}async fetchAudioData(e={}){let{retryDelay:t=Y.performance.retryDelay,maxRetries:i=Y.performance.maxRetries}=e,n=Spicetify.Player.data?.item?.uri;if(!n)return this.config.enableDebug&&console.warn("[MusicSyncService] No current track URI to fetch audio data."),null;let r=this.generateCacheKey(n,"audioData"),a=this.getFromCache(r);if(a?.audioData){if(this.isValidAudioData(a.audioData))return this.metrics.cacheHits++,this.config.enableDebug&&console.log(`[MusicSyncService] Cache hit for audioData: ${r}`),a.audioData;this.unifiedCache.delete(r)}this.metrics.cacheMisses++;for(let s=0;s<i;s++){try{let o=await ct.getAudioData();if(this.isValidAudioData(o))return this.setInCache(r,{audioData:o}),o;this.config.enableDebug&&console.log(`[MusicSyncService] Audio analysis unavailable (attempt ${s+1}/${i}). Retrying\u2026`)}catch(o){if(s===i-1){this.config.enableDebug&&console.warn("[MusicSyncService] Audio data fetch error on final attempt:",o),this.metrics.errors++;let l={tempo:120,energy:.5,valence:.5,loudness:-10,key:0,time_signature:4,danceability:.5,acousticness:.5,instrumentalness:0,speechiness:.05,liveness:.2,mode:1};return this.config.enableDebug&&console.warn("[MusicSyncService] All audio-data attempts failed \u2013 using fallback defaults"),l}}await new Promise(o=>setTimeout(o,t))}return null}async getAudioFeatures(){try{let e=Spicetify.Player.data?.item;if(!e?.uri)return null;let t=e.uri.split(":")[2]||"fallback",i=this.generateCacheKey(t,"features"),n=this.getFromCache(i);if(n?.audioFeatures)return this.metrics.cacheHits++,this.config.enableDebug&&console.log(`[MusicSyncService] Cache hit for audioFeatures: ${i}`),n.audioFeatures;this.metrics.cacheMisses++;let r=await Spicetify.CosmosAsync.get(`https://api.spotify.com/v1/audio-features/${t}`),a={danceability:r.danceability,energy:r.energy,valence:r.valence,acousticness:r.acousticness,instrumentalness:r.instrumentalness,tempo:r.tempo};return this.setInCache(i,{audioFeatures:a}),a}catch(e){return this.config.enableDebug&&console.warn("[MusicSyncService] Could not fetch audio features:",e),null}}generateCacheKey(e,t="default"){return`${this.CACHE_KEY_VERSION_PREFIX}-${e}-${t}`}getFromCache(e){let t=this.unifiedCache.get(e);return t&&Date.now()-t.timestamp<this.cacheTTL?t.data:(t&&this.unifiedCache.delete(e),null)}setInCache(e,t){this.unifiedCache.set(e,{data:t,timestamp:Date.now()})}async calculateEnhancedBPM(e,t={}){let i=performance.now();try{if(!e?.tempo)return this.config.enableDebug&&console.warn("[MusicSyncService] No BPM data available for track"),this.getFallbackBPM();let n=e.tempo,r={...Y.bpmCalculation,...t},a=await this.getAudioFeatures();if(!a)return this.config.enableDebug&&console.log("[MusicSyncService] Using basic BPM calculation"),this.validateBPM(n);let{danceability:s,energy:o,valence:l=.5}=a;this.config.enableDebug&&console.log(`[MusicSyncService] Audio features - Danceability: ${s}, Energy: ${o}, Valence: ${l}`);let m=this.genreProfileManager.getProfileForTrack(a||void 0),d=this.genreProfileManager.detectGenre(a||void 0),h=this.computeAdvancedBPM({trackBPM:n,danceability:s,energy:o,valence:l,config:r,profile:m}),f=(Spicetify.Player.data?.item||Spicetify.Player.data)?.uri?.split(":")??[],v=f.length>2&&f[2]?f[2]:"fallback",C=this.generateCacheKey(v,"bpm");return this.setInCache(C,{bpm:h,audioFeatures:a}),this.metrics.bpmCalculations++,this.config.enableDebug&&console.log(`[MusicSyncService] Enhanced BPM: ${h} (original: ${n})`),h}catch(n){return console.error("[MusicSyncService] BPM calculation failed:",n),this.metrics.errors++,this.getFallbackBPM()}}computeAdvancedBPM(e){let{trackBPM:t,danceability:i,energy:n,valence:r,config:a,profile:s}=e,{danceabilityWeight:o,energyWeight:l,bpmWeight:m,energyThreshold:d,danceabilityThreshold:h,bpmThreshold:g,maxBPM:f,minBPM:v}=a,C=Math.min(t/120,2),P=o,E=l,L=m;i<h&&(P*=i),n<d&&(E*=n),C<g&&(L=.9);let _=1;r>.6?_=1.05:r<.4&&n<.5&&(_=.95);let G=P+E+L,W=(i*P+n*E+C*L)/G*120*_;return s.beatEmphasis&&(W*=s.beatEmphasis),W=Math.max(v,Math.min(f,W)),Math.round(W*100)/100}validateBPM(e){let{minBPM:t,maxBPM:i}=Y.bpmCalculation;return Math.max(t,Math.min(i*2,Math.round(e*100)/100))}getFallbackBPM(){return 75}estimateDanceabilityFromTempo(e){let t=Y.musicVisualSync.enhancedBPM.danceabilityEstimation;return e>=t.highDance.min&&e<=t.highDance.max?t.highDance.value:e>=t.mediumDance.min&&e<=t.mediumDance.max?t.mediumDance.value:e>=t.lowMediumDance.min&&e<=t.lowMediumDance.max?t.lowMediumDance.value:t.lowDance.value}estimateEnergyFromTempoLoudness(e,t){let i=Y.musicVisualSync.enhancedBPM.energyEstimation,n=Math.max(0,Math.min(1,(e-i.tempoRange.min)/(i.tempoRange.max-i.tempoRange.min))),r=Math.max(0,Math.min(1,(t-i.loudnessRange.min)/(i.loudnessRange.max-i.loudnessRange.min)));return n*i.tempoWeight+r*i.loudnessWeight}estimateValenceFromKey(e){return[0,2,4,5,7,9,11].includes(e)?.6:.4}getFallbackProcessedData(e){let t=Y.musicVisualSync.enhancedBPM.fallbacks,i=6e4/t.tempo;return{trackUri:e,timestamp:Date.now(),tempo:t.tempo,loudness:t.loudness,key:t.key,timeSignature:t.timeSignature,estimatedDanceability:this.estimateDanceabilityFromTempo(t.tempo),estimatedEnergy:this.estimateEnergyFromTempoLoudness(t.tempo,t.loudness),estimatedValence:.5,energy:.5,valence:.5,processedEnergy:.5,visualIntensity:.5,moodIdentifier:"neutral",baseBPM:t.tempo,enhancedBPM:t.tempo,beatInterval:i,bmpCalculationMethod:"fallback",dataSource:"fallback"}}async createOKLABEnhancedFallbackColors(e){let t={VIBRANT:"#f2cdcd",DARK_VIBRANT:"#cba6f7",LIGHT_VIBRANT:"#f5c2e7",PROMINENT:"#cba6f7",VIBRANT_NON_ALARMING:"#f2cdcd",DESATURATED:"#9399b2"};if(!e||typeof e.energy!="number"||typeof e.valence!="number"){let s=M.getPreset("STANDARD"),o={};for(let[l,m]of Object.entries(t))try{let d=this.oklabProcessor.processColor(m,s);o[l]=d.enhancedHex}catch(d){this.config.enableDebug&&console.warn(`\u{1F3A8} [MusicSyncService] OKLAB processing failed for ${l}:`,d),o[l]=m}return o}let i={energy:e.energy,valence:e.valence,danceability:e.danceability,tempo:e.tempo,mode:e.mode,genre:this.genreProfileManager.detectGenre(e)},n=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(i),r;n.intensity>=1?r=M.getPreset("COSMIC"):n.intensity>=.7?r=M.getPreset("VIBRANT"):n.intensity>=.5?r=M.getPreset("STANDARD"):r=M.getPreset("SUBTLE");let a={};for(let[s,o]of Object.entries(t))try{let l=this.oklabProcessor.processColor(o,r);a[s]=l.enhancedHex}catch(l){this.config.enableDebug&&console.warn(`\u{1F3A8} [MusicSyncService] OKLAB processing failed for ${s}:`,l),a[s]=o}return a["--sn-emotional-primary"]=n.perceptualColorHex||n.primaryEmotion,a["--sn-emotional-intensity"]=n.intensity.toString(),a["--sn-emotional-preset"]=r.name,this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Created OKLAB-enhanced fallback colors:",{emotion:n.primaryEmotion,intensity:n.intensity,preset:r.name,oklabCoordination:a,musicContext:{energy:e.energy,valence:e.valence}}),a}async enhanceExtractedColorsWithOKLAB(e,t){let i={},n=M.getPreset("STANDARD");if(t&&typeof t.energy=="number"&&typeof t.valence=="number"){let r={energy:t.energy,valence:t.valence,danceability:t.danceability,tempo:t.tempo,mode:t.mode,genre:this.genreProfileManager.detectGenre(t)},a=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(r);a.intensity>=1?n=M.getPreset("COSMIC"):a.intensity>=.7?n=M.getPreset("VIBRANT"):a.intensity>=.5?n=M.getPreset("STANDARD"):n=M.getPreset("SUBTLE"),i["--sn-emotional-primary"]=a.perceptualColorHex||`oklabColorProcessor-${a.primaryEmotion}`,i["--sn-emotional-intensity"]=a.intensity.toString(),i["--sn-emotional-temperature"]=a.temperature.toString(),this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Applying OKLAB enhancement with emotional context:",{emotion:a.primaryEmotion,intensity:a.intensity,preset:n.name,colorCount:Object.keys(e).length})}for(let[r,a]of Object.entries(e)){if(!a||typeof a!="string"||!a.startsWith("#")){i[r]=a;continue}try{let s=this.oklabProcessor.processColor(a,n);i[r]=s.enhancedHex,i[`${r}-oklab-l`]=s.oklabEnhanced.L.toFixed(3),i[`${r}-oklab-a`]=s.oklabEnhanced.a.toFixed(3),i[`${r}-oklab-b`]=s.oklabEnhanced.b.toFixed(3),i[`${r}-oklch-c`]=s.oklchEnhanced.C.toFixed(3),i[`${r}-oklch-h`]=s.oklchEnhanced.H.toFixed(1)}catch(s){this.config.enableDebug&&console.warn(`\u{1F3A8} [MusicSyncService] OKLAB processing failed for ${r} (${a}):`,s),i[r]=a}}return i["--sn-oklab-preset"]=n.name,i["--sn-oklab-enhanced"]="true",this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] OKLAB color enhancement completed:",{originalCount:Object.keys(e).length,enhancedCount:Object.keys(i).length,preset:n.name,sampleEnhanced:{original:e.VIBRANT||e[Object.keys(e)[0]||""],enhanced:i.VIBRANT||i[Object.keys(i)[0]||""]}}),i}async processAudioFeatures(e,t,i){if(!this.isInitialized){console.warn("[MusicSyncService] Not initialized, skipping processing.");return}this.stopBeatScheduler(),this.currentTrackUri=t;let n=this.generateCacheKey(t,"processed"),r=this.getFromCache(n);if(r?.processedData){this.notifySubscribers(r.processedData,null,t);return}try{let a=e;if(a||(a=await this.fetchAudioData()),!a)throw new Error("Failed to fetch or receive audio data.");a.beats&&a.beats.length>0&&(this.currentSongBeats=a.beats,this.songStartTimestamp=Date.now(),this.nextBeatIndex=0,this.scheduleNextBeatEvent());let s=await this.calculateEnhancedBPM(a),o=s>0?6e4/s:0,l=a,{tempo:m=Y.musicVisualSync.enhancedBPM.fallbacks.tempo,loudness:d=Y.musicVisualSync.enhancedBPM.fallbacks.loudness,key:h=Y.musicVisualSync.enhancedBPM.fallbacks.key,time_signature:g=Y.musicVisualSync.enhancedBPM.fallbacks.timeSignature}=l,f=await this.getAudioFeatures(),v=f?.danceability??this.estimateDanceabilityFromTempo(m),C=f?.energy??this.estimateEnergyFromTempoLoudness(m,d),P=f?.valence??this.estimateValenceFromKey(h),E=this.config.getCurrentMultipliers?.()||{musicEnergyBoost:1,visualIntensityBase:1},L=Math.max(.1,Math.min(1,C*(E.musicEnergyBoost||1))),G=(C*.6+v*.4)*(E.visualIntensityBase||1),B="neutral";P>.6&&C>.6?B="energetic-happy":P>.6&&C<=.6?B="calm-happy":P<=.4&&C>.6?B="intense-moody":P<=.4&&C<=.4&&(B="calm-melancholy");let W=Math.max(.5,.8+G*.4),O=this.genreProfileManager.detectGenre(f||void 0),I={trackUri:t,timestamp:Date.now(),tempo:m,loudness:d,key:h,timeSignature:g,duration:i,estimatedDanceability:v,estimatedEnergy:C,estimatedValence:P,energy:C,valence:P,processedEnergy:L,visualIntensity:G,moodIdentifier:B,baseBPM:m,enhancedBPM:s,beatInterval:o,bmpCalculationMethod:"unified-service",dataSource:"unified-music-sync-service",beatOccurred:!1,animationSpeedFactor:W,genre:O};this.setInCache(n,{processedData:I}),this.latestProcessedData=I,this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] Processed music data:",{baseTempo:m,enhancedBPM:s,mood:B,energy:C.toFixed(2),visualIntensity:G.toFixed(2)}),this.notifySubscribers(I,e,t),p.emitSync("music:beat",{bpm:I.enhancedBPM,intensity:I.visualIntensity,timestamp:performance.now(),confidence:.8}),p.emitSync("music:energy",{energy:I.energy||.5,valence:I.valence||.5,tempo:I.enhancedBPM,timestamp:performance.now()}),p.emitSync("performance:frame",{deltaTime:16,fps:60,memoryUsage:performance.memory?.usedJSHeapSize||0,timestamp:performance.now()}),this.config.enableDebug&&console.log("[MusicSyncService] Successfully processed audio features.",{baseTempo:m,enhancedBPM:s,mood:B,energy:C.toFixed(2),visualIntensity:G.toFixed(2)})}catch(a){console.error("[MusicSyncService] Processing failed:",a),this.metrics.errors++;let s=this.getFallbackProcessedData(t);this.latestProcessedData=s,this.notifySubscribers(s,null,t)}}async processSongUpdate(e=!1){let t=Spicetify.Player?.data?.item?.uri;if(t&&!(!e&&t===this.currentTrackUri)){if(this.songChangeDebounceTimer&&clearTimeout(this.songChangeDebounceTimer),e){await this._processSongUpdateInternal(t);return}this.songChangeDebounceTimer=setTimeout(async()=>{this.songChangeDebounceTimer=null,await this._processSongUpdateInternal(t)},Y.synchronization.debounceRapidChanges)}}async _processSongUpdateInternal(e){if(this.eventProcessingState.isProcessingEvent){this.config.enableDebug&&console.warn("\u{1F504} [MusicSyncService] Already processing song update - skipping to prevent recursion");return}if(this.eventProcessingState.isProcessingEvent=!0,this.eventProcessingState.lastEventTime=Date.now(),this.eventProcessingState.consecutiveEvents++,this.eventProcessingState.eventChain.push("_processSongUpdateInternal"),this.eventProcessingState.consecutiveEvents>this.MAX_CONSECUTIVE_EVENTS){console.error("\u{1F504} [MusicSyncService] CRITICAL: Too many consecutive events - circuit breaker activated",{consecutiveEvents:this.eventProcessingState.consecutiveEvents,eventChain:this.eventProcessingState.eventChain}),this._resetEventProcessingState();return}let t=setTimeout(()=>{this.config.enableDebug&&console.warn("\u{1F504} [MusicSyncService] Event processing timeout - resetting state"),this._resetEventProcessingState()},this.EVENT_RESET_TIMEOUT);try{this.invalidateTrackCaches(e);let i=Spicetify.Player.data?.item?.duration?.milliseconds||0,n=await Promise.allSettled([this.getAudioFeatures(),this.robustColorExtraction(e)]),r=n[0].status==="fulfilled"?n[0].value:null,a=n[1].status==="fulfilled"?n[1].value:null;if(n[0].status==="rejected"&&this.config.enableDebug&&console.warn("[MusicSyncService] Audio features retrieval failed, continuing without music analysis:",n[0].reason),n[1].status==="rejected"&&this.config.enableDebug&&console.warn("[MusicSyncService] Color extraction failed, continuing without color processing:",n[1].reason),this.config.enableDebug){let h=(r?1:0)+(a?1:0);h===1?console.log(`[MusicSyncService] Graceful degradation: Continuing with ${r?"audio features only":"color extraction only"}`):h===2?console.log("[MusicSyncService] Full feature extraction successful"):console.warn("[MusicSyncService] Both strategies failed, will use fallback data")}console.log("\u{1F3A8} [MusicSyncService] Raw colors BEFORE sanitization:",{rawColors:a,rawColorType:typeof a,rawColorKeys:a?Object.keys(a):[],rawColorEntries:a?Object.entries(a):[]});let s=this.utils.sanitizeColorMap(a||{});console.log("\u{1F3A8} [MusicSyncService] Colors AFTER sanitization:",{sanitizedColors:s,sanitizedColorType:typeof s,sanitizedColorKeys:Object.keys(s),sanitizedColorEntries:Object.entries(s),colorCount:Object.keys(s).length,droppedCount:a?Object.keys(a).length-Object.keys(s).length:0}),this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Color extraction debug:",{trackUri:e,rawColorsReceived:a,sanitizedColors:s,colorCount:Object.keys(s).length,colorExtractorFailed:n[1].status==="rejected"});let o=s,l=!1;if(Object.keys(s).length>0)try{o=await this.enhanceExtractedColorsWithOKLAB(s,r),this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Successfully enhanced extracted colors with OKLAB processing")}catch(h){this.config.enableDebug&&console.warn("\u{1F3A8} [MusicSyncService] OKLAB enhancement failed, using original extracted colors:",h),o=s}if(Object.keys(s).length===0)try{o=await this.createOKLABEnhancedFallbackColors(r),l=!0,this.config.enableDebug&&console.warn("\u{1F3A8} [MusicSyncService] Color extraction failed, using OKLAB-enhanced Catppuccin fallback colors with emotional context")}catch(h){this.config.enableDebug&&console.warn("\u{1F3A8} [MusicSyncService] OKLAB fallback processing failed, using static fallback colors:",h),o={VIBRANT:"#f2cdcd",DARK_VIBRANT:"#cba6f7",LIGHT_VIBRANT:"#f5c2e7",PROMINENT:"#cba6f7",VIBRANT_NON_ALARMING:"#f2cdcd",DESATURATED:"#9399b2"},l=!0}let m={rawColors:o,trackUri:e,timestamp:Date.now(),harmonicMode:this.config.currentHarmonicMode||"catppuccin",musicData:r?{energy:r.energy,valence:r.valence,tempo:r.tempo,genre:this.genreProfileManager.detectGenre(r)}:void 0,performanceHints:{preferLightweight:!1,enableAdvancedBlending:!0,maxProcessingTime:100}};console.log("\u{1F3A8} [MusicSyncService] FINAL colors before event emission:",{finalColors:o,finalColorKeys:Object.keys(o),finalColorEntries:Object.entries(o),usingFallback:l,extractionFailed:Object.keys(s).length===0});let d={rawColors:m.rawColors,trackUri:m.trackUri,timestamp:Date.now()};if(m.musicData&&(d.musicData=m.musicData),console.log("\u{1F3A8} [MusicSyncService] Emitting colors:extracted event with data:",{eventData:d,rawColorKeys:d.rawColors?Object.keys(d.rawColors):[],rawColorEntries:d.rawColors?Object.entries(d.rawColors):[]}),p.emitSync("colors:extracted",d),this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] Emitted colors:extracted event for strategy processing",{trackUri:e,colorCount:Object.keys(o).length,usingFallback:l,extractionFailed:Object.keys(s).length===0}),r){let h=this.convertFeaturesToAudioData(r);await this.processAudioFeatures(h,e,i)}(async()=>{let h=await this.fetchAudioData();this.isValidAudioData(h)&&await this.processAudioFeatures(h,e,i)})()}catch(i){console.error(`[MusicSyncService] Error processing song update for ${e}:`,i),this.metrics.errors++}finally{clearTimeout(t),this._resetEventProcessingState();let i=this.eventProcessingState.eventChain.indexOf("_processSongUpdateInternal");i>-1&&this.eventProcessingState.eventChain.splice(i,1)}}_resetEventProcessingState(){this.eventProcessingState.isProcessingEvent=!1,this.eventProcessingState.eventChain=[];let t=Date.now()-this.eventProcessingState.lastEventTime;if(t>this.EVENT_RESET_TIMEOUT)this.eventProcessingState.consecutiveEvents=0;else{let i=Math.min(1,t/this.EVENT_RESET_TIMEOUT);this.eventProcessingState.consecutiveEvents=Math.floor(this.eventProcessingState.consecutiveEvents*(1-i))}this.config.enableDebug&&this.eventProcessingState.consecutiveEvents>0&&console.log("\u{1F504} [MusicSyncService] Event processing state reset",{consecutiveEvents:this.eventProcessingState.consecutiveEvents,timeSinceLastEvent:t})}setupCacheManagement(){this.cacheCleanupInterval=setInterval(()=>{let e=Date.now();for(let[t,i]of this.unifiedCache.entries())e-i.timestamp>this.cacheTTL&&this.unifiedCache.delete(t)},this.cacheTTL)}setupPerformanceMonitoring(){this.performanceInterval=setInterval(()=>{if(this.metrics.performance.length>0){let e=this.metrics.performance.reduce((t,i)=>t+i,0)/this.metrics.performance.length;this.metrics.avgProcessingTime=e,this.metrics.performance=[]}},6e4)}loadUserPreferences(){try{return{enableMusicSync:!0,audioAnalysisQuality:x.get("sn-webgl-quality")||"medium",gradientIntensity:x.get("sn-gradient-intensity")||"balanced",artisticMode:x.get("sn-artistic-mode")||"artist-vision"}}catch{return{enableMusicSync:!0,audioAnalysisQuality:"medium",gradientIntensity:"balanced",artisticMode:"artist-vision"}}}saveUserPreferences(){try{this.config.enableDebug&&console.log("[MusicSyncService] User preferences updated via settings system")}catch(e){this.config.enableDebug&&console.warn("[MusicSyncService] Could not save user preferences:",e)}}updateConfiguration(e){let t={...Y};Object.assign(Y,e),this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] Configuration updated",{from:t,to:Y}),this.cacheTTL=Y.performance.cacheTTL,t.performance.enableMetrics!==Y.performance.enableMetrics&&(Y.performance.enableMetrics?this.setupPerformanceMonitoring():this.performanceInterval&&(clearInterval(this.performanceInterval),this.performanceInterval=null))}destroy(){this.songChangeDebounceTimer&&(clearTimeout(this.songChangeDebounceTimer),this.songChangeDebounceTimer=null),this.stopBeatScheduler(),this.performanceInterval&&clearInterval(this.performanceInterval),this.cacheCleanupInterval&&clearInterval(this.cacheCleanupInterval),this.subscribers.clear(),this.unifiedCache.clear(),this.isInitialized=!1,this.latestProcessedData=null,this.metrics={bpmCalculations:0,beatSyncs:0,cacheHits:0,cacheMisses:0,avgProcessingTime:0,performance:[],errors:0,updates:0},this.cacheCleanupInterval=null}setColorHarmonyEngine(e){this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] setColorHarmonyEngine called - now using event-driven pattern instead of direct dependency.")}getLatestProcessedData(){return this.latestProcessedData}getCurrentBeatVector(){return{...this.currentBeatVector}}stopBeatScheduler(){this.beatSchedulerTimer&&(clearTimeout(this.beatSchedulerTimer),this.beatSchedulerTimer=null)}triggerBeatEvent(){let t=this.nextBeatIndex*.61803398875%1*Math.PI*2;if(this.currentBeatVector={x:Math.cos(t),y:Math.sin(t)},this.latestProcessedData){let i={...this.latestProcessedData,beatOccurred:!0,beatVector:this.currentBeatVector};this.notifySubscribers(i,null,this.currentTrackUri)}this.nextBeatIndex++,this.scheduleNextBeatEvent()}scheduleNextBeatEvent(){if(this.nextBeatIndex>=this.currentSongBeats.length)return;let e=this.currentSongBeats[this.nextBeatIndex],t=Date.now()-this.songStartTimestamp,i=e.start*1e3-t;i>=0?this.beatSchedulerTimer=setTimeout(()=>this.triggerBeatEvent(),i):(this.nextBeatIndex++,this.scheduleNextBeatEvent())}isValidAudioData(e){return!!e&&typeof e.tempo=="number"&&e.tempo>0}invalidateTrackCaches(e){if(e)for(let t of this.unifiedCache.keys())t.includes(e)&&this.unifiedCache.delete(t)}convertFeaturesToAudioData(e){let t=Y.musicVisualSync.enhancedBPM.fallbacks;return{tempo:e.tempo,energy:e.energy,valence:e.valence,loudness:t.loudness,key:t.key,time_signature:t.timeSignature,danceability:e.danceability,acousticness:e.acousticness,instrumentalness:e.instrumentalness,speechiness:0,liveness:0,mode:0}}async robustColorExtraction(e,t=3){console.log("\u{1F3A8} [MusicSyncService] Starting robust color extraction:",{trackUri:e,maxRetries:t,timestamp:Date.now()});for(let i=1;i<=t;i++)try{if(!e)return console.warn("\u{1F3A8} [MusicSyncService] Empty trackUri provided to color extraction"),null;console.log(`\u{1F3A8} [MusicSyncService] Calling Spicetify.colorExtractor (attempt ${i})...`);let n=await Spicetify.colorExtractor(e);if(console.log(`\u{1F3A8} [MusicSyncService] Raw color extraction result (attempt ${i}):`,{trackUri:e,success:!!n,colorsType:typeof n,colorsIsNull:n===null,colorsIsUndefined:n===void 0,colorCount:n?Object.keys(n).length:0,rawColors:n,colorKeys:n?Object.keys(n):[],colorValues:n?Object.values(n):[]}),n&&typeof n=="object"&&Object.keys(n).length>0)return Object.entries(n).forEach(([r,a])=>{console.log(`\u{1F3A8} [MusicSyncService] Extracted color: ${r} = ${a}`)}),n;console.warn(`\u{1F3A8} [MusicSyncService] Color extraction returned empty/invalid data on attempt ${i}`)}catch(n){if(console.error(`\u{1F3A8} [MusicSyncService] Color extraction attempt ${i} failed with error:`,n,{errorMessage:n instanceof Error?n.message:String(n),errorStack:n instanceof Error?n.stack:void 0}),i<t){let r=100*i;console.log(`\u{1F3A8} [MusicSyncService] Waiting ${r}ms before retry...`),await new Promise(a=>setTimeout(a,r))}}return console.error(`\u{1F3A8} [MusicSyncService] CRITICAL: All color extraction attempts failed for ${e}`),null}updateMetrics(e){this.latestProcessedData=e}getCurrentMusicState(){return!this.latestProcessedData||!this.audioData?null:{emotion:this.latestProcessedData.emotion||null,beat:{tempo:this.latestProcessedData.bpm||this.audioData.tempo||120,energy:this.latestProcessedData.energy||this.audioData.energy||.5,timestamp:Date.now()},intensity:this.latestProcessedData.intensity||this.audioData.energy||.5}}async healthCheck(){try{let e=ct.isAvailable(),t=this.subscribers.size>0,i=this.latestProcessedData!==null,n=this.metrics.bpmCalculations+this.metrics.beatSyncs+this.metrics.cacheHits+this.metrics.cacheMisses,r=n>0?this.metrics.errors/n:0;return this.isInitialized?e?r>.5?{status:"degraded",message:`High error rate detected: ${(r*100).toFixed(1)}%`,details:{initialized:this.isInitialized,spicetifyAvailable:e,subscribers:t,recentData:i,errorRate:r,errors:this.metrics.errors,totalOperations:n}}:{status:"healthy",message:"Music sync service operational",details:{initialized:this.isInitialized,spicetifyAvailable:e,subscribers:t,subscriberCount:this.subscribers.size,recentData:i,errorRate:r,bpmCalculations:this.metrics.bpmCalculations,beatSyncs:this.metrics.beatSyncs,cacheHits:this.metrics.cacheHits,cacheMisses:this.metrics.cacheMisses,avgProcessingTime:this.metrics.avgProcessingTime,errors:this.metrics.errors,updates:this.metrics.updates}}:{status:"degraded",message:"Spicetify audio data API not available - running in limited mode",details:{initialized:this.isInitialized,spicetifyAvailable:e,subscribers:t,recentData:i,errorRate:r}}:{status:"critical",message:"System not initialized",details:{initialized:this.isInitialized,spicetifyAvailable:e}}}catch(e){return{status:"critical",message:`Health check failed: ${e instanceof Error?e.message:"Unknown error"}`,details:{error:e instanceof Error?e.message:"Unknown error"}}}}}});var hi,ka=b(()=>{"use strict";hi=c=>({version:"1.0.0",userId:c,createdAt:Date.now(),lastModified:Date.now(),colorMemories:new Map,rhythmicPreferences:new Map,emotionalResonanceProfile:{},evolutionaryTrajectory:{adaptability:.5,explorationFactor:.5,lastUpdate:Date.now()}})});function sc(){return Da||(Da=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function oc(){return La||(La=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}function cc(c){let e=new Promise((t,i)=>{let n=()=>{c.removeEventListener("success",r),c.removeEventListener("error",a)},r=()=>{t(je(c.result)),n()},a=()=>{i(c.error),n()};c.addEventListener("success",r),c.addEventListener("error",a)});return gi.set(e,c),e}function lc(c){if(_n.has(c))return;let e=new Promise((t,i)=>{let n=()=>{c.removeEventListener("complete",r),c.removeEventListener("error",a),c.removeEventListener("abort",a)},r=()=>{t(),n()},a=()=>{i(c.error||new DOMException("AbortError","AbortError")),n()};c.addEventListener("complete",r),c.addEventListener("error",a),c.addEventListener("abort",a)});_n.set(c,e)}function Va(c){Nn=c(Nn)}function uc(c){return oc().includes(c)?function(...e){return c.apply($n(this),e),je(this.request)}:function(...e){return je(c.apply($n(this),e))}}function mc(c){return typeof c=="function"?uc(c):(c instanceof IDBTransaction&&lc(c),Un(c,sc())?new Proxy(c,Nn):c)}function je(c){if(c instanceof IDBRequest)return cc(c);if(zn.has(c))return zn.get(c);let e=mc(c);return e!==c&&(zn.set(c,e),gi.set(e,c)),e}function Ha(c,e,{blocked:t,upgrade:i,blocking:n,terminated:r}={}){let a=indexedDB.open(c,e),s=je(a);return i&&a.addEventListener("upgradeneeded",o=>{i(je(a.result),o.oldVersion,o.newVersion,je(a.transaction),o)}),t&&a.addEventListener("blocked",o=>t(o.oldVersion,o.newVersion,o)),s.then(o=>{r&&o.addEventListener("close",()=>r()),n&&o.addEventListener("versionchange",l=>n(l.oldVersion,l.newVersion,l))}).catch(()=>{}),s}function Ba(c,e){if(!(c instanceof IDBDatabase&&!(e in c)&&typeof e=="string"))return;if(On.get(e))return On.get(e);let t=e.replace(/FromIndex$/,""),i=e!==t,n=hc.includes(t);if(!(t in(i?IDBIndex:IDBObjectStore).prototype)||!(n||dc.includes(t)))return;let r=async function(a,...s){let o=this.transaction(a,n?"readwrite":"readonly"),l=o.store;return i&&(l=l.index(s.shift())),(await Promise.all([l[t](...s),n&&o.done]))[0]};return On.set(e,r),r}async function*fc(...c){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...c)),!e)return;e=e;let t=new Proxy(e,pc);for(za.set(t,e),gi.set(t,$n(e));e;)yield t,e=await(Wn.get(t)||e.continue()),Wn.delete(t)}function Ga(c,e){return e===Symbol.asyncIterator&&Un(c,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&Un(c,[IDBIndex,IDBObjectStore])}var Un,Da,La,_n,zn,gi,Nn,$n,dc,hc,On,gc,Fa,Wn,za,pc,Oa=b(()=>{Un=(c,e)=>e.some(t=>c instanceof t);_n=new WeakMap,zn=new WeakMap,gi=new WeakMap;Nn={get(c,e,t){if(c instanceof IDBTransaction){if(e==="done")return _n.get(c);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return je(c[e])},set(c,e,t){return c[e]=t,!0},has(c,e){return c instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in c}};$n=c=>gi.get(c);dc=["get","getKey","getAll","getAllKeys","count"],hc=["put","add","delete","clear"],On=new Map;Va(c=>({...c,get:(e,t,i)=>Ba(e,t)||c.get(e,t,i),has:(e,t)=>!!Ba(e,t)||c.has(e,t)}));gc=["continue","continuePrimaryKey","advance"],Fa={},Wn=new WeakMap,za=new WeakMap,pc={get(c,e){if(!gc.includes(e))return c[e];let t=Fa[e];return t||(t=Fa[e]=function(...i){Wn.set(this,za.get(this)[e](...i))}),t}};Va(c=>({...c,get(e,t,i){return Ga(e,t)?fc:c.get(e,t,i)},has(e,t){return Ga(e,t)||c.has(e,t)}}))});var bc,yc,pi,Ua,qn,wt,_a=b(()=>{"use strict";ka();Oa();bc="Year3000-TemporalMemory",yc=1,pi="aestheticSignatures",Ua="currentUser",qn=class{constructor(){this.dbPromise=Ha(bc,yc,{upgrade(e){e.objectStoreNames.contains(pi)||e.createObjectStore(pi)}})}async getSignature(e="defaultUser"){try{let i=await(await this.dbPromise).get(pi,Ua);if(i)return i;{let n=hi(e);return await this.saveSignature(n),n}}catch(t){return console.error("[TemporalMemoryService] Failed to get signature from IndexedDB. Returning default.",t),hi(e)}}async saveSignature(e){try{let t=await this.dbPromise;e.lastModified=Date.now(),await t.put(pi,e,Ua)}catch(t){console.error("[TemporalMemoryService] Failed to save signature to IndexedDB.",t)}}async resetSignature(e="defaultUser"){let t=hi(e);return await this.saveSignature(t),console.log("[TemporalMemoryService] Aesthetic signature has been reset."),t}async getSignatureTrends(e){if(!e)return null;let t={dominantColor:null,dominantRhythm:null,avgEnergy:0,avgValence:0},i=null;e.colorMemories.forEach((s,o)=>{(!i||s.count>i.count)&&(i={hex:o,count:s.count}),t.avgValence+=s.emotionalValence*s.count});let n=0;e.colorMemories.forEach(s=>n+=s.count),n>0&&(t.avgValence/=n),t.dominantColor=i;let r=null;e.rhythmicPreferences.forEach((s,o)=>{(!r||s.count>r.count)&&(r={id:o,count:s.count}),t.avgEnergy+=s.associatedEnergy*s.count});let a=0;return e.rhythmicPreferences.forEach(s=>a+=s.count),a>0&&(t.avgEnergy/=a),t.dominantRhythm=r,t}},wt=new qn});var Me,Fe,Yn=b(()=>{"use strict";D();_a();Me=class Me{constructor(e,t,i){this.performanceCoordinator=null;this.cssAnimationManager=null;this.animations=new Map;this.frameCallbacks=new Map;this.callbackCounter=0;this.animationFrameId=null;this.isRunning=!1;this.isPaused=!1;this.lastTimestamp=0;this.frameCount=0;this.startTime=0;this.frameTimeBudget=16;this.metrics={totalFrames:0,droppedFrames:0,averageFrameTime:0,maxFrameTime:0,performanceMode:"quality",activeAnimations:0,activeCallbacks:0,frameRate:60,lastOptimization:0};this.frameContext={timestamp:0,deltaMs:0,performanceMode:"quality",frameBudget:16,beatIntensity:0,scrollRatio:0,tiltXY:{x:0,y:0}};this.performanceHistory=[];this.MAX_HISTORY_SIZE=60;this.signature=null;this.saveInterval=null;this.currentBpm=120;this.currentIntensity=.5;this.emergentEventSubscriptions=[];this.animate=()=>{if(!this.isRunning)return;let e=performance.now(),t=e-this.lastTimestamp;if(this.isPaused){this.animationFrameId=requestAnimationFrame(this.animate);return}this.frameContext.timestamp=e,this.frameContext.deltaMs=t;let i=performance.now(),n=this.frameTimeBudget,r=performance.now();this.executeFrameCallbacks(t,e);let a=performance.now()-r,s=n-a;s>2?this.executeAnimationSystemsWithBudget(t,e,s):(this.metrics.droppedFrames++,this.config.enableDebug&&Math.random()<.1&&console.warn(`[EnhancedMasterAnimationCoordinator] Skipped animation systems - budget exceeded: ${a.toFixed(2)}ms`)),performance.now()-i<n*.8&&this.processEmergentTick(t);let l=performance.now()-i;this.updatePerformanceMetrics(l),this.performanceCoordinator&&this.performanceCoordinator.trackSubsystem("MasterAnimationCoordinator",{frameTime:l,fps:this.metrics.frameRate,memoryUsage:performance.memory?.usedJSHeapSize||0,cpuUsage:l>this.frameTimeBudget?l/this.frameTimeBudget*10:0}),this.lastTimestamp=e,this.frameCount++,l>n*1.5?setTimeout(()=>{this.animationFrameId=requestAnimationFrame(this.animate)},4):this.animationFrameId=requestAnimationFrame(this.animate)};this.config=e,this.eventBus=p,this.performanceCoordinator=t||null,this.cssAnimationManager=i||null,this.startTime=performance.now(),this.lastTimestamp=this.startTime,this.currentMultipliers=this.config.cosmicMultipliers,this.subscribeToEvents(),this.initializeEmergentChoreography(),this.updateFrameBudget(),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Initialized with unified animation coordination and emergent choreography")}coordinateConsciousnessBreathing(e){if(!this.cssAnimationManager)return;let t=e.energy||e.intensity||.5,i=e.bpm||this.currentBpm||120;if(Math.abs(t-this.currentIntensity)<.1&&Math.abs(i-this.currentBpm)<5)return;let r=document.querySelectorAll(".Root__main-view::before, .Root__main-view, [data-consciousness-breathing]");r.length>0&&(this.cssAnimationManager.triggerConsciousnessBreathing(r,t,i),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Consciousness breathing coordinated - Energy: ${t.toFixed(2)}, Tempo: ${i} BPM`)),this.currentIntensity=t,this.currentBpm=i}static getInstance(e,t,i){if(!Me.instance){if(!e)throw new Error("EnhancedMasterAnimationCoordinator requires config for first initialization");Me.instance=new Me(e,t,i)}return Me.instance}registerCSSAnimationManager(e){this.cssAnimationManager=e,this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] CSSAnimationManager registered for breathing coordination")}registerAnimationSystem(e,t,i="normal",n=60){if(this.animations.has(e))return this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] Animation system ${e} already registered`),!1;let r={name:e,system:t,priority:i,targetFPS:n,type:"animation",enabled:!0,frameInterval:1e3/n,lastUpdate:0,frameCount:0,totalTime:0,averageFrameTime:0,maxFrameTime:0,skippedFrames:0};return this.animations.set(e,r),this.isRunning||this.startMasterAnimationLoop(),this.updateMetrics(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Registered animation system: ${e} (priority: ${i}, fps: ${n})`),!0}registerVisualSystem(e,t="normal"){if(this.animations.has(e.systemName))return this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] Visual system ${e.systemName} already registered`),!1;let i={name:e.systemName,system:e,priority:t,targetFPS:60,type:"visual",enabled:!0,frameInterval:16.67,lastUpdate:0,frameCount:0,totalTime:0,averageFrameTime:0,maxFrameTime:0,skippedFrames:0};return this.animations.set(e.systemName,i),this.isRunning||this.startMasterAnimationLoop(),this.updateMetrics(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Registered visual system: ${e.systemName} (priority: ${t})`),!0}registerFrameCallback(e,t="normal",i){let n=`callback_${++this.callbackCounter}`,r={id:n,callback:e,priority:t,system:i||void 0,enabled:!0,frameCount:0,totalTime:0,lastExecution:0};return this.frameCallbacks.set(n,r),this.isRunning||this.startMasterAnimationLoop(),this.updateMetrics(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Registered frame callback: ${n} (priority: ${t})`),n}unregisterAnimationSystem(e){let t=this.animations.delete(e);return t&&(this.updateMetrics(),this.animations.size===0&&this.frameCallbacks.size===0&&this.stopMasterAnimationLoop(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Unregistered animation system: ${e}`)),t}unregisterFrameCallback(e){let t=this.frameCallbacks.delete(e);return t&&(this.updateMetrics(),this.animations.size===0&&this.frameCallbacks.size===0&&this.stopMasterAnimationLoop(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Unregistered frame callback: ${e}`)),t}startMasterAnimationLoop(){this.isRunning||(this.isRunning=!0,this.isPaused=!1,this.lastTimestamp=performance.now(),this.frameCount=0,this.animate(),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Master animation loop started"))}stopMasterAnimationLoop(){this.isRunning&&(this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Master animation loop stopped"))}pauseAnimationLoop(){this.isPaused=!0,this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Animation loop paused")}resumeAnimationLoop(){this.isPaused&&(this.isPaused=!1,this.lastTimestamp=performance.now(),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Animation loop resumed"))}setPerformanceMode(e){this.metrics.performanceMode=e,this.frameContext.performanceMode=e,this.frameTimeBudget=e==="performance"?8:16,this.frameContext.frameBudget=this.frameTimeBudget;for(let t of this.animations.values())t.system.onPerformanceModeChange&&t.system.onPerformanceModeChange(e);this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Performance mode set to: ${e}`)}getPerformanceMetrics(){return{...this.metrics}}getRegisteredSystems(){return{animations:new Map(this.animations),callbacks:new Map(this.frameCallbacks)}}setSystemEnabled(e,t){let i=this.animations.get(e);return i?(i.enabled=t,this.updateMetrics(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] System ${e} ${t?"enabled":"disabled"}`),!0):!1}getCurrentMultipliers(){return this.currentMultipliers}async updateEvolutionaryTrajectory(){await this._updateEvolutionaryTrajectory()}destroy(){this.stopMasterAnimationLoop(),this.destroyEmergentChoreography();for(let e of this.animations.values())if(e.type==="visual"&&"destroy"in e.system)try{e.system.destroy()}catch(t){console.error(`[EnhancedMasterAnimationCoordinator] Error destroying system ${e.name}:`,t)}this.animations.clear(),this.frameCallbacks.clear(),Me.instance===this&&(Me.instance=null),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Destroyed")}executeFrameCallbacks(e,t){let i=Array.from(this.frameCallbacks.values()).filter(n=>n.enabled).sort((n,r)=>{let a={critical:0,normal:1,background:2};return a[n.priority]-a[r.priority]});for(let n of i){let r=performance.now();try{n.callback(e,t);let a=performance.now()-r;n.totalTime+=a,n.frameCount++,n.lastExecution=t,a>this.frameTimeBudget*.5&&this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] Callback ${n.id} exceeded budget: ${a.toFixed(2)}ms`)}catch(a){console.error(`[EnhancedMasterAnimationCoordinator] Error in callback ${n.id}:`,a)}}}executeAnimationSystems(e,t){let i=Array.from(this.animations.values()).filter(n=>n.enabled).sort((n,r)=>{let a={critical:0,normal:1,background:2};return a[n.priority]-a[r.priority]});for(let n of i){if(t-n.lastUpdate<n.frameInterval){n.skippedFrames++;continue}let r=performance.now();try{if(n.type==="visual")n.system.onAnimate(e,this.frameContext);else{let s=n.system;s.onAnimate&&s.onAnimate(e),s.updateAnimation&&s.updateAnimation(t,e)}let a=performance.now()-r;n.totalTime+=a,n.frameCount++,n.lastUpdate=t,n.averageFrameTime=n.totalTime/n.frameCount,n.maxFrameTime=Math.max(n.maxFrameTime,a),a>this.frameTimeBudget*.8&&this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] System ${n.name} exceeded budget: ${a.toFixed(2)}ms`)}catch(a){console.error(`[EnhancedMasterAnimationCoordinator] Error in system ${n.name}:`,a)}}}executeAnimationSystemsWithBudget(e,t,i){let n=performance.now(),r=Array.from(this.animations.values()).filter(l=>l.enabled).sort((l,m)=>{let d={critical:0,normal:1,background:2};return d[l.priority]-d[m.priority]}),a=0,s=0;for(let l of r){if(performance.now()-n>=i*.9){s=r.length-a,this.config.enableDebug&&s>0&&console.warn(`[EnhancedMasterAnimationCoordinator] Budget exhausted: skipped ${s} systems`);break}if(t-l.lastUpdate<l.frameInterval){l.skippedFrames++;continue}let d=performance.now();try{if(l.type==="visual")l.system.onAnimate(e,this.frameContext);else{let g=l.system;g.onAnimate&&g.onAnimate(e),g.updateAnimation&&g.updateAnimation(t,e)}let h=performance.now()-d;l.totalTime+=h,l.frameCount++,l.lastUpdate=t,l.averageFrameTime=l.totalTime/l.frameCount,l.maxFrameTime=Math.max(l.maxFrameTime,h),a++,h>i*.3&&this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] System ${l.name} consuming excessive budget: ${h.toFixed(2)}ms`)}catch(h){console.error(`[EnhancedMasterAnimationCoordinator] Error in system ${l.name}:`,h),a++}}let o=performance.now()-n;s>0&&(this.metrics.droppedFrames+=s),this.config.enableDebug&&Math.random()<.02&&console.log(`[EnhancedMasterAnimationCoordinator] Budget usage: ${o.toFixed(2)}ms/${i.toFixed(2)}ms, processed: ${a}/${r.length}`)}updatePerformanceMetrics(e){this.metrics.totalFrames++,this.metrics.maxFrameTime=Math.max(this.metrics.maxFrameTime,e),this.performanceHistory.push(e),this.performanceHistory.length>this.MAX_HISTORY_SIZE&&this.performanceHistory.shift(),this.metrics.averageFrameTime=this.performanceHistory.reduce((t,i)=>t+i,0)/this.performanceHistory.length,this.metrics.frameRate=this.performanceHistory.length>0?1e3/this.metrics.averageFrameTime:60,e>this.frameTimeBudget*1.5&&this.metrics.droppedFrames++,this.metrics.averageFrameTime>this.frameTimeBudget*1.2&&this.metrics.performanceMode==="quality"?(this.setPerformanceMode("performance"),this.metrics.lastOptimization=Date.now()):this.metrics.averageFrameTime<this.frameTimeBudget*.8&&this.metrics.performanceMode==="performance"&&Date.now()-this.metrics.lastOptimization>5e3&&this.setPerformanceMode("quality")}updateFrameBudget(){this.frameTimeBudget=this.metrics.performanceMode==="performance"?8:16,this.frameContext.frameBudget=this.frameTimeBudget}updateMetrics(){this.metrics.activeAnimations=Array.from(this.animations.values()).filter(e=>e.enabled).length,this.metrics.activeCallbacks=Array.from(this.frameCallbacks.values()).filter(e=>e.enabled).length}subscribeToEvents(){this.eventBus.subscribe("music:beat",e=>{this.frameContext.beatIntensity=e.intensity||0,this.coordinateConsciousnessBreathing(e)},"EnhancedMasterAnimationCoordinator"),this.eventBus.subscribe("performance:frame",e=>{if(e.fps<45){for(let t of this.animations.values())t.frameInterval=Math.min(t.frameInterval*1.5,33.33);this.setPerformanceMode("performance")}else e.fps>55&&this.setPerformanceMode("quality")},"EnhancedMasterAnimationCoordinator")}async initializeEmergentChoreography(){try{this.signature=await wt.getSignature(),this.registerEmergentEventListeners(),this.saveInterval=setInterval(()=>{this.signature&&wt.saveSignature(this.signature)},3e4),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Emergent choreography initialized")}catch(e){console.error("[EnhancedMasterAnimationCoordinator] Failed to initialize emergent choreography:",e)}}registerEmergentEventListeners(){let e=this.eventBus.subscribe("music:beat",r=>this.handleBeatFrame(r),"EnhancedMasterAnimationCoordinator"),t=this.eventBus.subscribe("colors:harmonized",r=>this.handleHarmonyFrame(r),"EnhancedMasterAnimationCoordinator"),i=this.eventBus.subscribe("music:energy",r=>{this.currentBpm=r.tempo},"EnhancedMasterAnimationCoordinator"),n=this.eventBus.subscribe("music:beat",r=>{this.currentIntensity=r.intensity},"EnhancedMasterAnimationCoordinator");this.emergentEventSubscriptions.push(e,t,i,n)}handleBeatFrame(e){this.signature&&(this.signature.lastModified=Date.now(),this.coordinateConsciousnessBreathing({intensity:e.intensity||this.currentIntensity,energy:e.energy||this.currentIntensity,bpm:this.currentBpm}))}handleHarmonyFrame(e){if(!this.signature)return;let{kineticState:t}=e;this.signature.lastModified=Date.now()}async _updateEvolutionaryTrajectory(){if(!this.signature)return;let e=await wt.getSignatureTrends(this.signature);if(!e)return;let{avgEnergy:t,avgValence:i}=e,n=.5+(t-.5)*.2;this.signature.evolutionaryTrajectory.explorationFactor=Math.max(.1,Math.min(.9,n));let r=.5+(Math.abs(i)-.2)*.3;this.signature.evolutionaryTrajectory.adaptability=Math.max(.1,Math.min(.9,r)),this.signature.evolutionaryTrajectory.lastUpdate=Date.now()}_calculateVisualPulse(e){let t=6e4/this.currentBpm,i=performance.now()%t/t,n=Math.sin(i*2*Math.PI+Math.PI/2)*15*this.currentIntensity;return{timestamp:performance.now(),bpm:this.currentBpm,intensity:this.currentIntensity,phase:i,hueShift:n}}_calculateAdaptiveCoefficients(){if(!this.signature)return;let{adaptability:e,explorationFactor:t}=this.signature.evolutionaryTrajectory,i=.5+e*.5,n=.8+t*.4;this.currentMultipliers={...this.config.cosmicMultipliers,kineticIntensity:i,visualIntensityBase:n}}processEmergentTick(e){if(!this.signature)return;this._calculateAdaptiveCoefficients(),this.signature&&Date.now()-this.signature.evolutionaryTrajectory.lastUpdate>6e4&&this._updateEvolutionaryTrajectory();let t=this._calculateVisualPulse(e),i={timestamp:performance.now(),deltaMs:e}}destroyEmergentChoreography(){this.signature&&wt.saveSignature(this.signature),this.saveInterval&&(clearInterval(this.saveInterval),this.saveInterval=null),this.emergentEventSubscriptions.forEach(e=>this.eventBus.unsubscribe(e)),this.emergentEventSubscriptions=[],this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Emergent choreography destroyed")}};Me.instance=null;Fe=Me});var fi,Na=b(()=>{"use strict";fi=class{constructor(e={}){this._timerRegistry=new Map;this._timerMasterInterval=null;this.config={timerIntervalMs:e.timerIntervalMs||50,maxTimerBudget:e.maxTimerBudget||10,enableDebug:e.enableDebug||!1,...e},this._timerPerformanceMetrics={totalExecutions:0,totalTime:0,maxExecutionTime:0,averageExecutionTime:0,skippedTimers:0,timerCallbacks:new Map},this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Initialized")}initialize(){this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Timer consolidation initialized")}registerConsolidatedTimer(e,t,i,n="normal"){if(this._timerRegistry.has(e)){console.warn(`[TimerConsolidationSystem] Timer ${e} already registered`);return}let r={callback:t,intervalMs:i,priority:n,lastExecution:0,enabled:!0,executionCount:0,totalExecutionTime:0,maxExecutionTime:0,skippedExecutions:0};this._timerRegistry.set(e,r),this._timerPerformanceMetrics.timerCallbacks.set(e,{calls:0,totalTime:0,maxTime:0}),this.config.enableDebug&&console.log(`\u23F1\uFE0F [TimerConsolidationSystem] Registered timer: ${e} (${i}ms, ${n} priority)`),this._timerRegistry.size===1&&!this._timerMasterInterval&&this._startMasterTimer()}unregisterConsolidatedTimer(e){this._timerRegistry.has(e)&&(this._timerRegistry.delete(e),this._timerPerformanceMetrics.timerCallbacks.delete(e),this.config.enableDebug&&console.log(`\u23F1\uFE0F [TimerConsolidationSystem] Unregistered timer: ${e}`),this._timerRegistry.size===0&&this._stopMasterTimer())}_startMasterTimer(){this._timerMasterInterval||(this._timerMasterInterval=setInterval(()=>{this._executeMasterTimerFrame()},this.config.timerIntervalMs),this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Master timer started"))}_stopMasterTimer(){this._timerMasterInterval&&(clearInterval(this._timerMasterInterval),this._timerMasterInterval=null),this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Master timer stopped")}_executeMasterTimerFrame(){let e=performance.now(),t=this.config.maxTimerBudget,i=Array.from(this._timerRegistry.entries()).sort(([,r],[,a])=>{let s={critical:0,normal:1,background:2};return s[r.priority]-s[a.priority]});for(let[r,a]of i){if(!a.enabled||t<=0&&a.priority==="background"){t<=0&&a.skippedExecutions++;continue}if(e-a.lastExecution<a.intervalMs)continue;let o=performance.now();try{a.callback();let l=performance.now()-o;a.executionCount++,a.totalExecutionTime+=l,a.maxExecutionTime=Math.max(a.maxExecutionTime,l),a.lastExecution=e;let m=this._timerPerformanceMetrics.timerCallbacks.get(r);m&&(m.calls++,m.totalTime+=l,m.maxTime=Math.max(m.maxTime,l)),t-=l}catch(l){console.error(`[TimerConsolidationSystem] Error in timer ${r}:`,l),a.enabled=!1}}let n=performance.now()-e;this._updateTimerPerformanceMetrics(n)}_updateTimerPerformanceMetrics(e){let t=this._timerPerformanceMetrics;t.totalExecutions++,t.totalTime+=e,t.maxExecutionTime=Math.max(t.maxExecutionTime,e),t.averageExecutionTime=t.totalTime/t.totalExecutions,e>this.config.maxTimerBudget&&t.skippedTimers++}destroy(){this._stopMasterTimer(),this._timerRegistry.clear(),this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Destroyed")}}});var bi,$a=b(()=>{"use strict";U();D();R();bi=class{constructor(){this.initialized=!1;this.performanceOrchestrator=null;this.performanceThresholds={excellent:{minFPS:58,maxFrameTime:17,maxCPU:.15},good:{minFPS:50,maxFrameTime:20,maxCPU:.25},degraded:{minFPS:40,maxFrameTime:25,maxCPU:.35},critical:{minFPS:30,maxFrameTime:33,maxCPU:.5}};this.qualityTierConfigs=new Map([["minimal",{halfLife:.2,performanceMultiplier:.3,complexityReduction:.8,updateFrequency:.5,enableBeatPhase:!1,enableEnergyModulation:!1,enableTemperatureMapping:!1,useSimplifiedCalculations:!0,skipNonCriticalUpdates:!0,batchUpdates:!0}],["low",{halfLife:.15,performanceMultiplier:.5,complexityReduction:.6,updateFrequency:.7,enableBeatPhase:!1,enableEnergyModulation:!0,enableTemperatureMapping:!1,useSimplifiedCalculations:!0,skipNonCriticalUpdates:!0,batchUpdates:!0}],["medium",{halfLife:.1,performanceMultiplier:.8,complexityReduction:.4,updateFrequency:.8,enableBeatPhase:!0,enableEnergyModulation:!0,enableTemperatureMapping:!0,useSimplifiedCalculations:!1,skipNonCriticalUpdates:!1,batchUpdates:!1}],["high",{halfLife:.08,performanceMultiplier:1,complexityReduction:.2,updateFrequency:.9,enableBeatPhase:!0,enableEnergyModulation:!0,enableTemperatureMapping:!0,useSimplifiedCalculations:!1,skipNonCriticalUpdates:!1,batchUpdates:!1}],["ultra",{halfLife:.05,performanceMultiplier:1.2,complexityReduction:0,updateFrequency:1,enableBeatPhase:!0,enableEnergyModulation:!0,enableTemperatureMapping:!0,useSimplifiedCalculations:!1,skipNonCriticalUpdates:!1,batchUpdates:!1}]]);this.lastPerformanceCheck=0;this.performanceCheckInterval=1e3;this.lastQualityAdjustment=0;this.qualityAdjustmentCooldown=3e3;this.eventBus=p,this.currentPerformanceContext=this.createDefaultPerformanceContext(),this.currentLerpParams=this.qualityTierConfigs.get("medium"),this.performanceMetrics=this.createDefaultMetrics(),w.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Performance-aware LERP coordinator initialized")}async initialize(){if(!this.initialized)try{this.subscribeToPerformanceEvents(),this.startPerformanceMonitoring(),this.initialized=!0,w.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Performance-aware LERP coordination fully initialized")}catch(e){throw u?.debug?.error("PerformanceAwareLerpCoordinator","Initialization failed:",e),e}}updateAnimation(e){this.updatePerformanceMetrics(e),this.shouldAdaptPerformance()&&this.adaptLerpPerformance()}async healthCheck(){let e=this.performanceMetrics,t=e.frameTimeImpact,i=e.averageCalculationTime,n=t<1&&i<.1&&e.musicalAccuracy>.7;return{system:"PerformanceAwareLerpCoordinator",healthy:n,ok:n,details:n?"Performance-aware LERP coordination operating efficiently":`Performance issues: impact=${t.toFixed(2)}ms, calc=${i.toFixed(3)}ms`,metrics:{frameTimeImpact:t,averageCalculationTime:i,musicalAccuracy:e.musicalAccuracy,qualityLevel:this.currentPerformanceContext.qualityLevel,thermalState:this.currentPerformanceContext.thermalState,calculationsPerSecond:e.calculationsPerSecond}}}destroy(){this.stopPerformanceMonitoring(),this.unsubscribeFromPerformanceEvents(),this.initialized=!1,w.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Performance-aware LERP coordinator destroyed")}calculatePerformanceAwareMusicalLerp(e,t,i,n,r="flow",a){let s=performance.now(),o=this.getCurrentLerpParams(),l=this.calculateEffectiveHalfLife(n,r,a,o),m;o.useSimplifiedCalculations||!n?m=this.calculateSimplifiedLerp(e,t,i,l):m=this.calculateFullMusicalLerp(e,t,i,n,r,l,o);let d=performance.now()-s;return this.updateCalculationMetrics(d),m}getCurrentPerformanceContext(){return{...this.currentPerformanceContext}}getCurrentLerpParams(){return{...this.currentLerpParams}}getPerformanceMetrics(){return{...this.performanceMetrics}}setSimplePerformanceCoordinator(e){this.performanceOrchestrator=e,w.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Integrated with consolidated SimplePerformanceCoordinator")}syncWithOrchestrator(){if(this.performanceOrchestrator)try{let e=this.performanceOrchestrator.getCurrentPerformanceState?.();if(e){let t={currentFPS:e.currentFPS||this.currentPerformanceContext.currentFPS,frameTimeMs:e.frameTimeMs||this.currentPerformanceContext.frameTimeMs,qualityLevel:e.qualityLevel||this.currentPerformanceContext.qualityLevel,thermalState:e.thermalState||this.currentPerformanceContext.thermalState,memoryPressure:e.memoryPressure||this.currentPerformanceContext.memoryPressure,cpuUtilization:e.cpuUtilization||this.currentPerformanceContext.cpuUtilization};this.updatePerformanceState(t)}}catch(e){w.enableDebug&&u?.debug?.warn("PerformanceAwareLerpCoordinator","Failed to sync with orchestrator:",e)}}updatePerformanceState(e){this.currentPerformanceContext={...this.currentPerformanceContext,...e},this.adaptLerpParameters(),w.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Performance state updated",{qualityLevel:this.currentPerformanceContext.qualityLevel,currentFPS:this.currentPerformanceContext.currentFPS,thermalState:this.currentPerformanceContext.thermalState})}createDefaultPerformanceContext(){return{currentFPS:60,targetFPS:60,frameTimeMs:16.67,frameBudgetMs:16.67,qualityLevel:"medium",qualityScore:.5,deviceTier:"medium",thermalState:"nominal",powerLevel:"balanced",memoryPressure:"low",cpuUtilization:.2,memoryUtilization:.3,gpuUtilization:.2}}createDefaultMetrics(){return{averageCalculationTime:0,calculationsPerSecond:0,frameTimeImpact:0,cpuImpact:0,memoryImpact:0,musicalAccuracy:1,smoothnessQuality:1,responsiveness:1,qualityReductions:0,performanceRecoveries:0}}subscribeToPerformanceEvents(){}unsubscribeFromPerformanceEvents(){}startPerformanceMonitoring(){}stopPerformanceMonitoring(){}shouldAdaptPerformance(){let e=performance.now();if(e-this.lastPerformanceCheck<this.performanceCheckInterval)return!1;this.lastPerformanceCheck=e;let t=this.currentPerformanceContext,i=t.currentFPS<t.targetFPS*.9||t.frameTimeMs>t.frameBudgetMs*1.2||t.thermalState!=="nominal"||t.memoryPressure==="high",n=t.currentFPS>t.targetFPS*1.1&&t.frameTimeMs<t.frameBudgetMs*.8&&t.thermalState==="nominal"&&e-this.lastQualityAdjustment>this.qualityAdjustmentCooldown;return i||n}adaptLerpPerformance(){let e=this.currentPerformanceContext,t=e.currentFPS<e.targetFPS*.8||e.frameTimeMs>e.frameBudgetMs*1.3||e.thermalState==="hot"||e.thermalState==="critical"||e.memoryPressure==="high",i=e.currentFPS>e.targetFPS*1.1&&e.frameTimeMs<e.frameBudgetMs*.7&&e.thermalState==="nominal"&&e.memoryPressure==="low";t?this.reducePerformanceQuality():i&&this.increasePerformanceQuality()}reducePerformanceQuality(){let e=this.currentLerpParams;e.performanceMultiplier=Math.min(2,e.performanceMultiplier*1.2),e.complexityReduction=Math.min(.9,e.complexityReduction+.1),e.updateFrequency=Math.max(.3,e.updateFrequency*.9),e.enableTemperatureMapping?e.enableTemperatureMapping=!1:e.enableEnergyModulation?e.enableEnergyModulation=!1:e.enableBeatPhase&&(e.enableBeatPhase=!1),e.useSimplifiedCalculations=!0,e.skipNonCriticalUpdates=!0,e.batchUpdates=!0,this.performanceMetrics.qualityReductions++,this.lastQualityAdjustment=performance.now(),w.enableDebug&&u?.debug?.warn("PerformanceAwareLerpCoordinator","Reduced LERP quality for performance",{performanceMultiplier:e.performanceMultiplier,complexityReduction:e.complexityReduction})}increasePerformanceQuality(){let e=this.currentLerpParams;e.performanceMultiplier=Math.max(.5,e.performanceMultiplier*.9),e.complexityReduction=Math.max(0,e.complexityReduction-.1),e.updateFrequency=Math.min(1,e.updateFrequency*1.1),!e.enableBeatPhase&&e.complexityReduction<.3?e.enableBeatPhase=!0:!e.enableEnergyModulation&&e.complexityReduction<.2?e.enableEnergyModulation=!0:!e.enableTemperatureMapping&&e.complexityReduction<.1&&(e.enableTemperatureMapping=!0),this.performanceMetrics.performanceRecoveries++,this.lastQualityAdjustment=performance.now(),w.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Increased LERP quality",{performanceMultiplier:e.performanceMultiplier,complexityReduction:e.complexityReduction})}adaptLerpParameters(){let e=this.currentPerformanceContext,t=this.qualityTierConfigs.get(e.qualityLevel);t&&(this.currentLerpParams={...t},e.thermalState==="warm"?this.currentLerpParams.performanceMultiplier*=1.2:e.thermalState==="hot"?(this.currentLerpParams.performanceMultiplier*=1.5,this.currentLerpParams.enableTemperatureMapping=!1):e.thermalState==="critical"&&(this.currentLerpParams.performanceMultiplier*=2,this.currentLerpParams.enableTemperatureMapping=!1,this.currentLerpParams.enableEnergyModulation=!1,this.currentLerpParams.useSimplifiedCalculations=!0),e.powerLevel==="battery-saver"&&(this.currentLerpParams.performanceMultiplier*=1.5,this.currentLerpParams.enableTemperatureMapping=!1,this.currentLerpParams.updateFrequency*=.7),e.memoryPressure==="high"&&(this.currentLerpParams.batchUpdates=!0,this.currentLerpParams.skipNonCriticalUpdates=!0,this.currentLerpParams.updateFrequency*=.8))}calculateEffectiveHalfLife(e,t,i,n){let r=i||n.halfLife;if(r*=n.performanceMultiplier,e&&n.enableEnergyModulation){let a=Math.max(.5,Math.min(2,e.tempo/120));if(r/=a,n.enableEnergyModulation){let s=.7+e.energy*.6;r/=s}}return Math.max(.01,Math.min(1,r))}calculateSimplifiedLerp(e,t,i,n){let r=Math.pow(2,-(i/1e3)/n);return e+(t-e)*(1-r)}calculateFullMusicalLerp(e,t,i,n,r,a,s){let o=this.calculateSimplifiedLerp(e,t,i,a);if(s.enableBeatPhase&&n.beatPhase){let l=this.calculateBeatPhaseModifier(n.beatPhase,n.timeSinceLastBeat,n.beatInterval,r),m=s.complexityReduction>.5?.1:.2;o+=(t-e)*l*m}if(s.enableEnergyModulation&&n.danceability>0){let l=.9+n.danceability*.2;o=e+(o-e)*l}return o}calculateBeatPhaseModifier(e,t,i,n){switch(e){case"attack":return n==="pulse"?.3:.1;case"sustain":return n==="flow"?.1:.05;case"decay":return n==="pulse"?-.1:-.05;case"rest":return 0;default:return 0}}updatePerformanceMetrics(e){let t=this.performanceMetrics.frameTimeImpact;this.performanceMetrics.frameTimeImpact=t*.9+0*.1;let i=1;this.performanceMetrics.calculationsPerSecond=this.performanceMetrics.calculationsPerSecond*.95+i/(e/1e3)*.05}updateCalculationMetrics(e){let t=this.performanceMetrics.averageCalculationTime;this.performanceMetrics.averageCalculationTime=t*.9+e*.1;let i=this.performanceMetrics.frameTimeImpact;this.performanceMetrics.frameTimeImpact=i*.9+e*.1;let n=this.currentLerpParams,r=1;n.enableBeatPhase||(r-=.2),n.enableEnergyModulation||(r-=.15),n.enableTemperatureMapping||(r-=.1),n.useSimplifiedCalculations&&(r-=.1),this.performanceMetrics.musicalAccuracy=Math.max(.3,r),this.performanceMetrics.smoothnessQuality=Math.max(.5,1-(n.performanceMultiplier-1)*.3),this.performanceMetrics.responsiveness=n.updateFrequency}handleQualityChange(e){let{newLevel:t}=e;t&&t.level&&(this.currentPerformanceContext.qualityLevel=t.level,this.adaptLerpParameters())}handleThermalWarning(e){this.currentPerformanceContext.thermalState="hot",this.adaptLerpParameters(),w.enableDebug&&u?.debug?.warn("PerformanceAwareLerpCoordinator","Thermal warning - adapting LERP performance")}handleQualityLevelChange(e){let{newLevel:t}=e;t&&typeof t.level=="string"&&(this.currentPerformanceContext.qualityLevel=t.level,this.adaptLerpParameters())}}});var me,yi=b(()=>{"use strict";R();me=class{static detectTier(){let e=this._analyzeDeviceCapabilities(),t=[],i="medium",n=.8;this._isHighTierDevice(e,t)?(i="high",n=.9):this._isLowTierDevice(e,t)?(i="low",n=.85):(t.push("Standard modern device - full experience enabled"),t.push(`${e.memory}GB RAM, ${e.cores} cores, WebGL2: ${e.webgl2}`));let r={tier:i,confidence:n,reasoning:t,capabilities:e};return u?.debug?.log("EnhancedDeviceTierDetector","Tier detection complete",r),r}static _analyzeDeviceCapabilities(){let e=navigator.deviceMemory||this._estimateMemory(),t=navigator.hardwareConcurrency||this._estimateCores(),i=this._checkWebGLSupport(),n=this._checkWebGL2Support(),r=navigator.userAgent,a=navigator.platform||"unknown";return{memory:e,cores:t,webgl:i,webgl2:n,userAgent:r,platform:a,hardwareInfo:{isHighEnd:this._detectHighEndHardware(e,t,r),isMobile:this._isMobileDevice(r,a),isOldDevice:this._isOldDevice(r),hasPerformanceIndicators:this._hasPerformanceIndicators(r)}}}static _isHighTierDevice(e,t){let{memory:i,cores:n,webgl2:r,hardwareInfo:a}=e;if(!(i>=8&&n>=6&&r))return!1;let o=[];return i>=16&&o.push("16+GB RAM"),n>=8&&o.push("8+ CPU cores"),a.hasPerformanceIndicators&&o.push("Performance GPU detected"),a.isHighEnd&&o.push("High-end hardware signatures"),o.length>=2?(t.push("High-end device detected"),t.push(`Specs: ${i}GB RAM, ${n} cores, WebGL2: ${r}`),t.push(`Indicators: ${o.join(", ")}`),!0):this._isGamingOrWorkstation(e)?(t.push("Gaming/workstation device detected"),t.push("High-performance device indicators found"),!0):!1}static _isLowTierDevice(e,t){let{memory:i,cores:n,webgl2:r,hardwareInfo:a}=e,s=[];return i<4&&s.push(`Low memory: ${i}GB`),n<4&&s.push(`Few CPU cores: ${n}`),r||s.push("No WebGL2 support"),a.isOldDevice&&s.push("Legacy device detected"),a.isMobile&&i<=4&&n<=4&&s.push("Resource-constrained mobile device"),s.length>=2?(t.push("Budget/legacy device detected - enabling performance optimizations"),t.push(...s),!0):!1}static _estimateMemory(){let e=navigator.userAgent.toLowerCase();return e.includes("mobile")||e.includes("android")?4:e.includes("ipad")||e.includes("tablet")?6:8}static _estimateCores(){return navigator.userAgent.toLowerCase().includes("mobile"),4}static _checkWebGLSupport(){try{let e=document.createElement("canvas"),i=(e.getContext("webgl")||e.getContext("experimental-webgl"))!==null;return e.remove(),i}catch{return!1}}static _checkWebGL2Support(){try{let e=document.createElement("canvas"),i=e.getContext("webgl2")!==null;return e.remove(),i}catch{return!1}}static _detectHighEndHardware(e,t,i){let n=i.toLowerCase();return[n.includes("gaming"),n.includes("nvidia"),n.includes("amd"),n.includes("geforce"),n.includes("radeon"),e>=16,t>=8].filter(Boolean).length>=2}static _isMobileDevice(e,t){let i=e.toLowerCase(),n=t.toLowerCase();return i.includes("mobile")||i.includes("android")||i.includes("iphone")||i.includes("ipad")||n.includes("arm")||"ontouchstart"in window}static _isOldDevice(e){let t=e.toLowerCase();return[/chrome\/[1-6]\d\./,/firefox\/[1-5]\d\./,/safari\/[1-9]\./,/msie|trident/].some(n=>n.test(t))}static _hasPerformanceIndicators(e){let t=e.toLowerCase();return["nvidia","amd","geforce","radeon","quadro","gaming","performance"].some(n=>t.includes(n))}static _isGamingOrWorkstation(e){let{userAgent:t,memory:i,cores:n}=e,r=t.toLowerCase();return[r.includes("gaming"),r.includes("rog"),r.includes("msi"),r.includes("alienware"),r.includes("predator"),i>=16&&n>=8].some(Boolean)}static getDeviceDescription(e){let{memory:t,cores:i,webgl2:n,hardwareInfo:r}=e,a=`${t}GB RAM, ${i} CPU cores`;return n&&(a+=", WebGL2"),r.isHighEnd&&(a+=", High-end hardware"),r.isMobile&&(a+=", Mobile device"),r.hasPerformanceIndicators&&(a+=", Performance GPU"),a}}});var lt,Kn=b(()=>{"use strict";yi();D();R();lt=class{constructor(e){this.initialized=!1;this.webglIntegration=null;this.deviceTier="medium";this.tierDetectionResult=null;this.energyBoostActive=!1;this.energyBoostTimeout=null;this.tierSettings={low:{webglQuality:"low",animationDensity:.6,updateFrequency:45,particleMultiplier:.4,corridorEffects:!1,advancedFeatures:!1,experimentalFeatures:!1},medium:{webglQuality:"high",animationDensity:.9,updateFrequency:60,particleMultiplier:1,corridorEffects:!0,advancedFeatures:!0,experimentalFeatures:!1},high:{webglQuality:"high",animationDensity:1,updateFrequency:60,particleMultiplier:1.2,corridorEffects:!0,advancedFeatures:!0,experimentalFeatures:!0}};this.energyBoostSettings={animationBoost:1.3,particleBoost:1.5,duration:1e4};this.enhancedDeviceTierDetector=e,this.currentSettings=this.tierSettings.medium,u?.debug?.log("SimpleTierBasedPerformanceSystem","Initialized with tier-based performance management")}async initialize(){this.initialized||(this.tierDetectionResult=me.detectTier(),this.deviceTier=this.tierDetectionResult.tier,this.currentSettings=this.tierSettings[this.deviceTier],this._setupMusicAnalysisListener(),this._applyTierSettings(),this.initialized=!0,u?.debug?.log("SimpleTierBasedPerformanceSystem","Initialization complete",{deviceTier:this.deviceTier,confidence:this.tierDetectionResult.confidence,reasoning:this.tierDetectionResult.reasoning,deviceDescription:me.getDeviceDescription(this.tierDetectionResult.capabilities),settings:this.currentSettings}))}async healthCheck(){return this.initialized?{healthy:!0,details:`Performance tier: ${this.deviceTier}, Energy boost: ${this.energyBoostActive?"active":"inactive"}`,system:"SimpleTierBasedPerformanceSystem"}:{healthy:!1,details:"Not initialized",system:"SimpleTierBasedPerformanceSystem"}}destroy(){this.energyBoostTimeout&&(clearTimeout(this.energyBoostTimeout),this.energyBoostTimeout=null),p.unsubscribe("colors:extracted"),p.unsubscribe("music:track-changed"),this.initialized=!1,u?.debug?.log("SimpleTierBasedPerformanceSystem","Destroyed")}updateAnimation(e){}registerWebGLIntegration(e){this.webglIntegration=e,this.initialized&&this._applyWebGLSettings(),u?.debug?.log("SimpleTierBasedPerformanceSystem","WebGL integration registered")}getDeviceTier(){return this.deviceTier}getTierDetectionResult(){return this.tierDetectionResult}getDeviceDescription(){return this.tierDetectionResult?me.getDeviceDescription(this.tierDetectionResult.capabilities):"Unknown device"}getCurrentSettings(){return{...this.currentSettings}}hasEnergyBoost(){return this.energyBoostActive}getEffectiveSettings(){let e={...this.currentSettings};return this.energyBoostActive?{...e,animationDensity:Math.min(1,e.animationDensity*this.energyBoostSettings.animationBoost),particleMultiplier:e.particleMultiplier*this.energyBoostSettings.particleBoost,energyBoosted:!0}:{...e,energyBoosted:!1}}setTier(e){this.deviceTier=e,this.currentSettings=this.tierSettings[e],this._applyTierSettings(),u?.debug?.log("SimpleTierBasedPerformanceSystem",`Tier manually set to ${e}`)}_setupMusicAnalysisListener(){p.subscribe("colors:extracted",e=>{e.musicData&&this._handleMusicAnalysis({energy:e.musicData.energy||.5,valence:e.musicData.valence||.5,bpm:e.musicData.tempo||120,genre:e.musicData.genre||"unknown"})}),p.subscribe("music:track-changed",e=>{this._handleSongChange(e)})}_handleSongChange(e){e.analysis&&this._checkEnergyBoost(e.analysis)}_handleMusicAnalysis(e){this._checkEnergyBoost(e)}_checkEnergyBoost(e){let t=e.energy>.7&&e.bpm>130&&(e.danceability||0)>.6,i=t&&!this.energyBoostActive,n=!t&&this.energyBoostActive;i?this._activateEnergyBoost(e):n&&this._deactivateEnergyBoost()}_activateEnergyBoost(e){this.energyBoostActive=!0,this.energyBoostTimeout&&clearTimeout(this.energyBoostTimeout),this._applyTierSettings(),this.energyBoostTimeout=window.setTimeout(()=>{this._deactivateEnergyBoost()},this.energyBoostSettings.duration),p.emit("performance:tier-changed",{tier:this.deviceTier,previousTier:this.deviceTier,timestamp:Date.now()}),u?.debug?.log("SimpleTierBasedPerformanceSystem","Energy boost activated",{bpm:e.bpm,energy:e.energy,danceability:e.danceability})}_deactivateEnergyBoost(){this.energyBoostActive&&(this.energyBoostActive=!1,this.energyBoostTimeout&&(clearTimeout(this.energyBoostTimeout),this.energyBoostTimeout=null),this._applyTierSettings(),p.emit("performance:tier-changed",{tier:this.deviceTier,previousTier:this.deviceTier,timestamp:Date.now()}),u?.debug?.log("SimpleTierBasedPerformanceSystem","Energy boost deactivated"))}_applyTierSettings(){this._applyWebGLSettings(),this._applySystemSettings();let e=this.getEffectiveSettings();p.emit("performance:tier-changed",{tier:this.deviceTier,previousTier:this.deviceTier,timestamp:Date.now()})}_applyWebGLSettings(){if(!this.webglIntegration)return;let e=this.getEffectiveSettings();this.webglIntegration.setQuality(e.webglQuality),u?.debug?.log("SimpleTierBasedPerformanceSystem","WebGL settings applied",{tier:this.deviceTier,quality:e.webglQuality,energyBoosted:e.energyBoosted})}_applySystemSettings(){let e=this.getEffectiveSettings();p.emit("performance:frame",{deltaTime:16,fps:e.updateFrequency,memoryUsage:.5,timestamp:Date.now()})}}});var he,jn=b(()=>{"use strict";Kn();R();he=class{constructor(e,t){this.initialized=!1;this.enhancedDeviceTierDetector=e,this.webglIntegration=t,this.performanceSystem=new lt(e),u?.debug?.log("SimplePerformanceCoordinator","Created simple performance coordination")}async initialize(){if(this.initialized)return;await this.performanceSystem.initialize(),this.performanceSystem.registerWebGLIntegration(this.webglIntegration),this.initialized=!0;let e=this.performanceSystem.getTierDetectionResult();u?.debug?.log("SimplePerformanceCoordinator","Coordination established",{deviceTier:this.performanceSystem.getDeviceTier(),deviceDescription:this.performanceSystem.getDeviceDescription(),confidence:e?.confidence,webglState:this.webglIntegration?.getWebGLState()||"disabled"})}async healthCheck(){if(!this.initialized)return{healthy:!1,details:"Not initialized",system:"SimplePerformanceCoordinator"};let e=await this.performanceSystem.healthCheck(),t=this.webglIntegration?await this.webglIntegration.healthCheck():{healthy:!1,details:"WebGL integration not available"},i=[];return e.healthy||i.push(`Performance: ${e.details}`),t.healthy||i.push(`WebGL: ${t.details}`),{healthy:i.length===0,details:i.length>0?`Issues: ${i.join(", ")}`:`Coordinating ${this.performanceSystem.getDeviceTier()} tier performance with ${this.webglIntegration?.getWebGLState()||"disabled"} WebGL`,issues:i,system:"SimplePerformanceCoordinator"}}destroy(){this.performanceSystem.destroy(),this.initialized=!1,u?.debug?.log("SimplePerformanceCoordinator","Coordination destroyed")}updateAnimation(e){this.performanceSystem.updateAnimation(e)}getPerformanceSystem(){return this.performanceSystem}getDeviceTier(){return this.performanceSystem.getDeviceTier()}getDeviceDescription(){return this.performanceSystem.getDeviceDescription()}hasEnergyBoost(){return this.performanceSystem.hasEnergyBoost()}getCurrentSettings(){return this.performanceSystem.getEffectiveSettings()}getWebGLStatus(){return this.webglIntegration?{state:this.webglIntegration.getWebGLState(),quality:this.webglIntegration.getQuality(),enabled:this.webglIntegration.isWebGLActive()}:{state:"disabled",quality:"low",enabled:!1}}getPerformanceSummary(){let e=this.performanceSystem.getTierDetectionResult();return{deviceTier:this.getDeviceTier(),deviceDescription:this.getDeviceDescription(),confidence:e?.confidence||0,reasoning:e?.reasoning||[],webglStatus:this.getWebGLStatus(),energyBoost:this.hasEnergyBoost(),settings:this.getCurrentSettings()}}startMonitoring(){u?.debug?.log("SimplePerformanceCoordinator","Monitoring started (tier-based system)")}emitTrace(e,t){u?.debug?.log("SimplePerformanceCoordinator",`${e}`,t)}recordMetric(e,t){u?.debug?.log("SimplePerformanceCoordinator",`Metric ${e}: ${t}`)}getMedianFPS(){switch(this.getDeviceTier()){case"high":return 60;case"medium":return 50;case"low":return 30;default:return 30}}calculateHealthScore(){switch(this.getDeviceTier()){case"high":return .95;case"medium":return .75;case"low":return .5;default:return .5}}shouldReduceQuality(){return this.getDeviceTier()==="low"}timeOperation(e,t){let i=performance.now(),n=t(),r=performance.now()-i;return u?.debug?.log("SimplePerformanceCoordinator",`Operation ${e}: ${r.toFixed(2)}ms`),n}async timeOperationAsync(e,t){let i=performance.now(),n=await t(),r=performance.now()-i;return u?.debug?.log("SimplePerformanceCoordinator",`Async operation ${e}: ${r.toFixed(2)}ms`),n}getAverageTime(e){switch(this.getDeviceTier()){case"high":return 5;case"medium":return 15;case"low":return 30;default:return 15}}updateBudget(e,t){u?.debug?.log("SimplePerformanceCoordinator",`Budget update ignored: ${e}=${t} (tier-based system)`)}startTiming(e){let t=`${e}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return u?.debug?.log("SimplePerformanceCoordinator",`Timing started: ${e} (${t})`),t}endTiming(e,t){u?.debug?.log("SimplePerformanceCoordinator",`Timing ended: ${e}`,t)}}});var Si,Wa=b(()=>{"use strict";R();D();Si=class{constructor(e){this.initialized=!1;this.currentState="disabled";this.webglSystems=new Map;this.lastStateChange=0;this.stateChangeHistory=[];this.userExplicitlyDisabled=!1;this.userExplicitQuality=null;this.deviceCapabilities=e,this.config={enabled:!0,quality:"medium",forceEnabled:!1,allowPerformanceAdjustment:!0},u?.debug?.log("UnifiedWebGLController","Initialized with unified WebGL management")}async initialize(){this.initialized||(this.deviceCapabilities.isInitialized||await this.deviceCapabilities.initialize(),await this._loadSettings(),await this._determineInitialState(),this._setupEventListeners(),this._applyStateToAllSystems(),this.initialized=!0,u?.debug?.log("UnifiedWebGLController","Initialization complete",{state:this.currentState,quality:this.config.quality,systemCount:this.webglSystems.size}))}async healthCheck(){if(!this.initialized)return{healthy:!1,details:"Not initialized",system:"UnifiedWebGLController"};let e=[];for(let[i,n]of this.webglSystems)if(n.system.healthCheck)try{let r=await n.system.healthCheck();r.healthy||e.push(`${i}: ${r.details||"unhealthy"}`)}catch{e.push(`${i}: health check failed`)}let t=this.stateChangeHistory.filter(i=>Date.now()-i.timestamp<3e4).length;return e.length>0||t>3?{healthy:!0,details:`Issues detected: ${e.join(", ")}`,issues:e,system:"UnifiedWebGLController"}:{healthy:!0,details:"All WebGL systems operating normally",system:"UnifiedWebGLController"}}destroy(){this._setState("disabled"),this.webglSystems.clear(),p.unsubscribe("settings:changed"),p.unsubscribe("system:state-changed"),this.initialized=!1,u?.debug?.log("UnifiedWebGLController","Destroyed - all WebGL systems disabled")}updateAnimation(e){if(this.currentState==="webgl-active"){for(let[t,i]of this.webglSystems)if(i.system.updateAnimation)try{i.system.updateAnimation(e)}catch(n){u?.debug?.warn("UnifiedWebGLController",`Animation update failed for ${t}:`,n)}}}enable(){this.userExplicitlyDisabled=!1,this.config.enabled=!0,this._determineAndApplyState(),this._saveSettings(),u?.debug?.log("UnifiedWebGLController","WebGL enabled by user")}disable(){this.userExplicitlyDisabled=!0,this.config.enabled=!1,this._setState("css-fallback"),this._saveSettings(),u?.debug?.log("UnifiedWebGLController","WebGL disabled by user")}setQuality(e){this.userExplicitQuality=e,this.config.quality=e,this._applyQualityToAllSystems(),this._saveSettings(),u?.debug?.log("UnifiedWebGLController",`Quality set to ${e} by user`)}isEnabled(){return this.currentState==="webgl-active"}isAvailable(){return this.deviceCapabilities.getSpicetifyProfile()?.webglCapabilities?.available||!1}getState(){return this.currentState}getQuality(){return this.config.quality}forceEnable(e=!0){this.config.forceEnabled=e,this._determineAndApplyState(),this._saveSettings(),u?.debug?.log("UnifiedWebGLController",`Force enable set to ${e}`)}registerSystem(e,t,i=0){this.webglSystems.set(e,{system:t,name:e,priority:i}),this.initialized&&this._applyStateToSystem(e,t),u?.debug?.log("UnifiedWebGLController",`System registered: ${e} (priority: ${i})`)}unregisterSystem(e){let t=this.webglSystems.get(e);t&&(t.system.setEnabled&&t.system.setEnabled(!1),this.webglSystems.delete(e),u?.debug?.log("UnifiedWebGLController",`System unregistered: ${e}`))}suggestQualityAdjustment(e,t){if(!this.config.allowPerformanceAdjustment){u?.debug?.log("UnifiedWebGLController",`Performance adjustment ignored (not allowed): ${t}`);return}if(this.userExplicitQuality!==null){u?.debug?.log("UnifiedWebGLController",`Performance adjustment ignored (user set explicit quality): ${t}`);return}if(this.config.quality!==e){let i=this.config.quality;this.config.quality=e,this._applyQualityToAllSystems(),u?.debug?.log("UnifiedWebGLController",`Quality adjusted by performance system: ${i} \u2192 ${e} (${t})`)}}performanceDisable(e){!this.config.allowPerformanceAdjustment||this.userExplicitlyDisabled===!1||this.currentState==="webgl-active"&&(this._setState("css-fallback"),u?.debug?.log("UnifiedWebGLController",`WebGL disabled by performance system: ${e}`))}performanceEnable(e){!this.config.allowPerformanceAdjustment||this.userExplicitlyDisabled||this.currentState==="css-fallback"&&this.config.enabled&&(this._determineAndApplyState(),u?.debug?.log("UnifiedWebGLController",`WebGL re-enabled by performance system: ${e}`))}async _loadSettings(){try{let e=localStorage.getItem("sn-webgl-enabled"),t=localStorage.getItem("sn-webgl-quality"),i=localStorage.getItem("sn-webgl-force-enabled");e!==null&&(this.config.enabled=e==="true",e==="false"&&(this.userExplicitlyDisabled=!0)),t&&["low","medium","high"].includes(t)&&(this.config.quality=t,this.userExplicitQuality=t),i!==null&&(this.config.forceEnabled=i==="true"),u?.debug?.log("UnifiedWebGLController","Settings loaded",this.config)}catch(e){u?.debug?.warn("UnifiedWebGLController","Failed to load settings:",e)}}_saveSettings(){try{localStorage.setItem("sn-webgl-enabled",this.config.enabled.toString()),localStorage.setItem("sn-webgl-quality",this.config.quality),localStorage.setItem("sn-webgl-force-enabled",this.config.forceEnabled.toString())}catch(e){u?.debug?.warn("UnifiedWebGLController","Failed to save settings:",e)}}async _determineInitialState(){if(!this.config.enabled||this.userExplicitlyDisabled){this._setState("css-fallback");return}this.config.forceEnabled||this.isAvailable()?this._setState("webgl-active"):this._setState("css-fallback")}_determineAndApplyState(){!this.config.enabled||this.userExplicitlyDisabled?this._setState("css-fallback"):this.config.forceEnabled||this.isAvailable()?this._setState("webgl-active"):this._setState("css-fallback")}_setState(e){if(this.currentState===e)return;let t=this.currentState;this.currentState=e,this.lastStateChange=Date.now(),this.stateChangeHistory.push({state:e,quality:this.config.quality,timestamp:this.lastStateChange}),this.stateChangeHistory.length>20&&(this.stateChangeHistory=this.stateChangeHistory.slice(-20)),this._applyStateToAllSystems(),p.emit("performance:tier-changed",{tier:e,previousTier:t,timestamp:this.lastStateChange}),u?.debug?.log("UnifiedWebGLController",`State changed: ${t} \u2192 ${e}`)}_applyStateToAllSystems(){let e=Array.from(this.webglSystems.entries()).sort(([,t],[,i])=>i.priority-t.priority);for(let[t,i]of e)this._applyStateToSystem(t,i.system)}_applyStateToSystem(e,t){try{let i=this.currentState==="webgl-active";if(t.setEnabled&&t.setEnabled(i),i&&t.setQuality&&t.setQuality(this.config.quality),e==="corridor-effects"&&t.setEnabled){let n=i&&(this.config.quality==="medium"||this.config.quality==="high");t.setEnabled(n)}}catch(i){u?.debug?.warn("UnifiedWebGLController",`Failed to apply state to ${e}:`,i)}}_applyQualityToAllSystems(){if(this.currentState==="webgl-active"){for(let[e,t]of this.webglSystems)try{if(t.system.setQuality&&t.system.setQuality(this.config.quality),e==="corridor-effects"){let i=this.config.quality==="medium"||this.config.quality==="high";t.system.setEnabled&&t.system.setEnabled(i)}}catch(i){u?.debug?.warn("UnifiedWebGLController",`Failed to apply quality to ${e}:`,i)}p.emit("performance:tier-changed",{tier:this.config.quality,previousTier:this.config.quality,timestamp:Date.now()})}}_setupEventListeners(){p.subscribe("settings:changed",e=>{e.settingKey==="sn-webgl-enabled"?(this.config.enabled=e.newValue==="true",this.userExplicitlyDisabled=e.newValue==="false",this._determineAndApplyState()):e.settingKey==="sn-webgl-quality"?this.setQuality(e.newValue):e.settingKey==="sn-webgl-force-enabled"&&(this.config.forceEnabled=e.newValue==="true",this._determineAndApplyState())}),p.subscribe("performance:tier-changed",e=>{let t=e.tier==="excellent"?"high":e.tier==="good"?"medium":"low";t!==this.config.quality&&this.setQuality(t)})}}});var vi,qa=b(()=>{"use strict";vi=class{static getAnimationDensity(e){switch(e){case"low":return .3;case"medium":return .7;case"high":return 1}}static getUpdateFrequency(e){switch(e){case"low":return 30;case"medium":return 45;case"high":return 60}}static getShaderComplexity(e){switch(e){case"low":return .4;case"medium":return .7;case"high":return 1}}static getParticleMultiplier(e){switch(e){case"low":return .3;case"medium":return .6;case"high":return 1}}static shouldEnableCorridorEffects(e){return e==="medium"||e==="high"}static shouldEnableAdvancedFeatures(e){return e==="high"}static getBlendMode(e){switch(e){case"low":return"normal";case"medium":return"screen";case"high":return"screen"}}static getFrameThrottling(e){switch(e){case"low":return 33;case"medium":return 22;case"high":return 16}}}});var Ci,Ya=b(()=>{"use strict";qa();R();Ci=class{constructor(e){this.enabled=!1;this.quality="medium";this.system=e,u?.debug?.log("WebGLGradientAdapter","Created adapter for WebGL gradient system")}setEnabled(e){this.enabled!==e&&(this.enabled=e,e?this._enableSystem():this._disableSystem(),u?.debug?.log("WebGLGradientAdapter",`WebGL gradient ${e?"enabled":"disabled"}`))}setQuality(e){this.quality!==e&&(this.quality=e,this.enabled&&this._applyQualitySettings(),u?.debug?.log("WebGLGradientAdapter",`Quality set to ${e}`))}isEnabled(){return this.enabled}isCapable(){return this._checkWebGLCapability()}getQuality(){return this.quality}getSystemName(){return"WebGL Gradient Background"}_enableSystem(){try{let e=this._mapQualityToIntensity(this.quality);this.system.settingsManager&&(this.system.settingsManager.set("sn-gradient-intensity",e),this.system.settingsManager.set("sn-webgl-enabled","true")),this.system.initialized||this.system.initialize(),this._applyQualitySettings()}catch(e){u?.debug?.warn("WebGLGradientAdapter","Failed to enable system:",e)}}_disableSystem(){try{this.system.settingsManager&&this.system.settingsManager.set("sn-gradient-intensity","disabled"),typeof this.system.disable=="function"?this.system.disable():typeof this.system.destroy=="function"&&this.system.destroy()}catch(e){u?.debug?.warn("WebGLGradientAdapter","Failed to disable system:",e)}}_applyQualitySettings(){try{let e=this.system.settings;if(!e)return;e.flowStrength=this._getFlowStrength(this.quality),e.noiseScale=this._getNoiseScale(this.quality),e.corridorIntensity=this._getColorIntensity(this.quality);let t=vi.getUpdateFrequency(this.quality);this.system.updateFrequency!==void 0&&(this.system.updateFrequency=t),typeof this.system.forceRepaint=="function"&&this.system.forceRepaint(`quality-change-${this.quality}`)}catch(e){u?.debug?.warn("WebGLGradientAdapter","Failed to apply quality settings:",e)}}_mapQualityToIntensity(e){switch(e){case"low":return"minimal";case"medium":return"balanced";case"high":return"intense";default:return"balanced"}}_getFlowStrength(e){switch(e){case"low":return .3;case"medium":return .7;case"high":return 1;default:return .7}}_getAnimationSpeed(e){switch(e){case"low":return .5;case"medium":return .8;case"high":return 1.2;default:return .8}}_getNoiseScale(e){switch(e){case"low":return 1.5;case"medium":return 2;case"high":return 2.8;default:return 2}}_getColorIntensity(e){switch(e){case"low":return .6;case"medium":return .8;case"high":return 1;default:return .8}}_checkWebGLCapability(){try{let e=document.createElement("canvas"),t=e.getContext("webgl2")||e.getContext("webgl");return e.remove(),t!==null}catch{return!1}}}});var Qe,Qn=b(()=>{"use strict";Wa();Ya();R();Qe=class{constructor(e){this.initialized=!1;this.webglGradientSystem=null;this.webglGradientAdapter=null;this.controller=new Si(e),u?.debug?.log("WebGLSystemsIntegration","Created WebGL systems integration")}async initialize(){this.initialized||(await this.controller.initialize(),await this._registerWebGLSystems(),this.initialized=!0,u?.debug?.log("WebGLSystemsIntegration","Integration initialized",{controllerState:this.controller.getState(),quality:this.controller.getQuality(),registeredSystems:this._getRegisteredSystemNames()}))}async healthCheck(){if(!this.initialized)return{healthy:!1,details:"Not initialized",system:"WebGLSystemsIntegration"};let e=await this.controller.healthCheck();if(!e.healthy)return{healthy:!1,details:`Controller unhealthy: ${e.details}`,system:"WebGLSystemsIntegration"};let t=[];if(this.webglGradientSystem)try{let i=await this.webglGradientSystem.healthCheck();i.ok||t.push(`WebGL Gradient: ${i.details}`)}catch{t.push("WebGL Gradient: health check failed")}return{healthy:!0,details:t.length>0?`Some system issues: ${t.join(", ")}`:"All WebGL systems healthy",issues:t,system:"WebGLSystemsIntegration"}}destroy(){this.webglGradientSystem&&this.webglGradientSystem.destroy(),this.controller.destroy(),this.initialized=!1,u?.debug?.log("WebGLSystemsIntegration","Integration destroyed")}updateAnimation(e){this.initialized&&this.controller.updateAnimation(e)}getController(){return this.controller}enableWebGL(){this.controller.enable()}disableWebGL(){this.controller.disable()}setQuality(e){this.controller.setQuality(e)}isWebGLActive(){return this.controller.isEnabled()}getWebGLState(){return this.controller.getState()}getQuality(){return this.controller.getQuality()}handlePerformanceQualityAdjustment(e,t){this.controller.suggestQualityAdjustment(e,t)}handlePerformanceDisable(e){this.controller.performanceDisable(e)}handlePerformanceEnable(e){this.controller.performanceEnable(e)}setQualityFromTier(e){this.controller.setQuality(e),u?.debug?.log("WebGLSystemsIntegration",`Quality set from device tier: ${e}`)}async _registerWebGLSystems(){try{await this._registerWebGLGradientSystem(),u?.debug?.log("WebGLSystemsIntegration","All WebGL systems registered successfully")}catch(e){u?.debug?.warn("WebGLSystemsIntegration","Failed to register some WebGL systems:",e)}}async _registerWebGLGradientSystem(){try{let e=globalThis.year3000System;if(!e){u?.debug?.warn("WebGLSystemsIntegration","Year3000System not available");return}let t=["webglGradientBackgroundSystem","flowingLiquidConsciousnessSystem","webglBackgroundSystem"],i=null;for(let n of t)if(e[n]){i=e[n];break}if(!i){u?.debug?.warn("WebGLSystemsIntegration","WebGL gradient system not found in Year3000System");return}this.webglGradientSystem=i,this.webglGradientAdapter=new Ci(this.webglGradientSystem),this.controller.registerSystem("webgl-gradient-background",this.webglGradientAdapter,100),u?.debug?.log("WebGLSystemsIntegration","WebGL gradient system registered")}catch(e){u?.debug?.warn("WebGLSystemsIntegration","Failed to register WebGL gradient system:",e)}}_getRegisteredSystemNames(){let e=[];return this.webglGradientAdapter&&e.push("WebGL Gradient Background"),e}}});var we,Xe,Xn=b(()=>{"use strict";D();we=class we{constructor(e,t){this.subsystemMetrics=new Map;this.optimizationStrategies=new Map;this.adaptiveOptimizationEnabled=!1;this.optimizationInterval=null;this.activeIssues=new Map;this.issueHistory=[];this.lastHealthCheck=0;this.healthCheckInterval=null;this.HEALTH_CHECK_INTERVAL=5e3;this.batteryState=null;this.frameTimeHistory=[];this.memoryUsageHistory=[];this.lastOptimizationTime=0;this.optimizationCooldown=5e3;this.PERFORMANCE_THRESHOLDS={frameTime:{warning:16.67,critical:33.33},memoryUsage:{warning:50*1024*1024,critical:100*1024*1024},cpuUsage:{warning:15,critical:30},fps:{warning:50,critical:30}};this.PERFORMANCE_MODES={battery:{name:"battery",qualityLevel:.4,animationQuality:.3,effectQuality:.2,blurQuality:.3,shadowQuality:.2,frameRate:30,optimizationLevel:3},balanced:{name:"balanced",qualityLevel:.8,animationQuality:.8,effectQuality:.7,blurQuality:.8,shadowQuality:.7,frameRate:60,optimizationLevel:1},performance:{name:"performance",qualityLevel:1,animationQuality:1,effectQuality:1,blurQuality:1,shadowQuality:1,frameRate:60,optimizationLevel:0},auto:{name:"auto",qualityLevel:.8,animationQuality:.8,effectQuality:.8,blurQuality:.8,shadowQuality:.8,frameRate:60,optimizationLevel:1}};this.config=e,this.performanceAnalyzer=t,this.eventBus=p,this.initializeDeviceCapabilities(),this.initializeThermalMonitoring(),this.initializeBatteryMonitoring(),this.currentPerformanceMode=this.PERFORMANCE_MODES.auto,this.initializeDefaultStrategies(),this.startHealthMonitoring(),this.subscribeToEvents(),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Initialized with enhanced device capabilities, thermal monitoring, and battery optimization")}static getInstance(e,t){if(!we.instance){if(!e||!t)throw new Error("UnifiedPerformanceCoordinator requires config and performanceAnalyzer for first initialization");we.instance=new we(e,t)}return we.instance}trackSubsystem(e,t){let i=performance.now(),r={...this.subsystemMetrics.get(e)||{name:e,frameTime:0,memoryUsage:0,cpuUsage:0,fps:60,lastUpdate:i,status:"healthy",issues:[]},...t,lastUpdate:i};r.status=this.calculateHealthStatus(r),this.updateSubsystemIssues(r),this.subsystemMetrics.set(e,r),this.performanceAnalyzer&&(this.performanceAnalyzer.recordMetric(`subsystem_${e}_frame_time`,r.frameTime),this.performanceAnalyzer.recordMetric(`subsystem_${e}_memory`,r.memoryUsage),this.performanceAnalyzer.recordMetric(`subsystem_${e}_fps`,r.fps)),this.adaptiveOptimizationEnabled&&r.status!=="healthy"&&this.checkAndTriggerOptimization(r),this.config.enableDebug&&r.status!=="healthy"&&console.warn(`[UnifiedPerformanceCoordinator] Subsystem ${e} status: ${r.status}`,r)}getSystemHealth(){let e=performance.now(),t=new Map(this.subsystemMetrics),i=0,n=0,r=0;for(let d of t.values())switch(d.status){case"healthy":i++;break;case"warning":n++;break;case"critical":r++;break}let a=t.size,s="healthy";r>0?s="critical":n>0&&(s="warning");let o=this.calculatePerformanceScore(t),l=this.generateRecommendations(t),m={overall:s,totalSubsystems:a,healthySubsystems:i,warningSubsystems:n,criticalSubsystems:r,subsystems:t,recommendations:l,performanceScore:o,lastUpdate:e};return this.lastHealthCheck=e,m}startMonitoring(){this.enableAdaptiveOptimization(),this.healthCheckInterval||this.startHealthMonitoring(),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Monitoring started")}enableAdaptiveOptimization(){this.adaptiveOptimizationEnabled||(this.adaptiveOptimizationEnabled=!0,this.optimizationInterval=setInterval(()=>{this.performOptimizationCheck()},2e3),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Adaptive optimization enabled"))}disableAdaptiveOptimization(){this.adaptiveOptimizationEnabled&&(this.adaptiveOptimizationEnabled=!1,this.optimizationInterval&&(clearInterval(this.optimizationInterval),this.optimizationInterval=null),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Adaptive optimization disabled"))}registerOptimizationStrategy(e){this.optimizationStrategies.set(e.name,e),this.config.enableDebug&&console.log(`[UnifiedPerformanceCoordinator] Registered optimization strategy: ${e.name}`)}triggerOptimization(e){this.activeIssues.set(`${e.subsystem}:${e.type}`,e),this.issueHistory.push(e),this.issueHistory.length>100&&this.issueHistory.shift();let t=Array.from(this.optimizationStrategies.values()).filter(i=>i.subsystem===e.subsystem||i.subsystem==="*").sort((i,n)=>n.priority-i.priority);for(let i of t){let n=this.subsystemMetrics.get(e.subsystem);if(n&&i.condition(n))try{i.action(n),this.config.enableDebug&&console.log(`[UnifiedPerformanceCoordinator] Applied optimization strategy: ${i.name} for ${e.subsystem}`);break}catch(r){console.error(`[UnifiedPerformanceCoordinator] Error applying optimization strategy ${i.name}:`,r)}}}getMetrics(){return{subsystems:new Map(this.subsystemMetrics),issues:new Map(this.activeIssues),strategies:new Map(this.optimizationStrategies),adaptiveOptimizationEnabled:this.adaptiveOptimizationEnabled}}destroy(){this.disableAdaptiveOptimization(),this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.subsystemMetrics.clear(),this.optimizationStrategies.clear(),this.activeIssues.clear(),this.issueHistory=[],we.instance===this&&(we.instance=null),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Destroyed")}initializeDefaultStrategies(){this.registerOptimizationStrategy({name:"memory-cleanup",type:"memory_cleanup",priority:100,subsystem:"*",description:"Trigger garbage collection and memory cleanup",condition:e=>e.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.warning,action:e=>{}}),this.registerOptimizationStrategy({name:"fps-optimization",type:"reduce_quality",priority:80,subsystem:"*",description:"Reduce quality settings to improve FPS",condition:e=>e.fps<this.PERFORMANCE_THRESHOLDS.fps.warning,action:e=>{}}),this.registerOptimizationStrategy({name:"cpu-throttling",type:"throttle_updates",priority:70,subsystem:"*",description:"Throttle update frequency to reduce CPU usage",condition:e=>e.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.warning,action:e=>{}})}calculateHealthStatus(e){let t=[];return e.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.critical?t.push("critical-frame-time"):e.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.warning&&t.push("warning-frame-time"),e.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.critical?t.push("critical-memory"):e.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.warning&&t.push("warning-memory"),e.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.critical?t.push("critical-cpu"):e.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.warning&&t.push("warning-cpu"),e.fps<this.PERFORMANCE_THRESHOLDS.fps.critical?t.push("critical-fps"):e.fps<this.PERFORMANCE_THRESHOLDS.fps.warning&&t.push("warning-fps"),e.issues=t,t.some(i=>i.startsWith("critical"))?"critical":t.some(i=>i.startsWith("warning"))?"warning":"healthy"}updateSubsystemIssues(e){let t=`${e.name}:performance`;if(e.status==="healthy"){if(this.activeIssues.has(t)){let i=this.activeIssues.get(t);i.resolved=!0,this.activeIssues.delete(t)}}else{let i={type:"render",severity:e.status==="critical"?"critical":"medium",subsystem:e.name,message:`Performance degradation detected: ${e.issues.join(", ")}`,timestamp:Date.now(),resolved:!1};this.activeIssues.set(t,i)}}checkAndTriggerOptimization(e){let t=`${e.name}:performance`,i=this.activeIssues.get(t);i&&!i.resolved&&this.triggerOptimization(i)}performOptimizationCheck(){let e=performance.now();for(let[t,i]of this.subsystemMetrics)e-i.lastUpdate>1e4||i.status!=="healthy"&&this.checkAndTriggerOptimization(i)}calculatePerformanceScore(e){if(e.size===0)return 100;let t=0;for(let i of e.values()){let n=100;i.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.warning&&(n-=20),i.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.critical&&(n-=30),i.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.warning&&(n-=15),i.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.critical&&(n-=25),i.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.warning&&(n-=10),i.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.critical&&(n-=20),i.fps<this.PERFORMANCE_THRESHOLDS.fps.warning&&(n-=15),i.fps<this.PERFORMANCE_THRESHOLDS.fps.critical&&(n-=25),t+=Math.max(0,n)}return Math.round(t/e.size)}generateRecommendations(e){let t=[],i=Array.from(e.values()).flatMap(r=>r.issues),n=new Map;for(let r of i)n.set(r,(n.get(r)||0)+1);for(let[r,a]of n)if(a>=2)switch(r){case"critical-frame-time":case"warning-frame-time":t.push("Consider reducing animation quality or frequency");break;case"critical-memory":case"warning-memory":t.push("Memory cleanup needed - consider reducing cache sizes");break;case"critical-cpu":case"warning-cpu":t.push("High CPU usage detected - consider throttling updates");break;case"critical-fps":case"warning-fps":t.push("Low FPS detected - consider disabling non-essential effects");break}return t.length===0&&t.push("System performance is optimal"),t}startHealthMonitoring(){this.healthCheckInterval=setInterval(()=>{this.getSystemHealth()},this.HEALTH_CHECK_INTERVAL)}subscribeToEvents(){}initializeDeviceCapabilities(){let e=navigator,t=performance.memory,i=document.createElement("canvas"),n=i.getContext("webgl2")||i.getContext("webgl"),r=2048;n&&(r=n.getParameter(n.MAX_TEXTURE_SIZE)||2048);let a=t?Math.round(t.jsHeapSizeLimit/(1024*1024*1024)):4,s="medium";a>=8&&e.hardwareConcurrency>=8&&r>=4096?s="premium":a>=4&&e.hardwareConcurrency>=4?s="high":a>=2&&e.hardwareConcurrency>=2?s="medium":s="low",this.deviceCapabilities={performanceTier:s,memoryGB:a,cpuCores:e.hardwareConcurrency||4,gpuAcceleration:!!n,isMobile:/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e.userAgent),supportsWebGL:!!n,supportsBackdropFilter:CSS.supports("backdrop-filter","blur(10px)"),maxTextureSize:r,devicePixelRatio:window.devicePixelRatio||1},this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Device capabilities detected:",this.deviceCapabilities)}initializeThermalMonitoring(){this.thermalState={temperature:"normal",throttleLevel:0,cpuUsage:0,gpuUsage:0,memoryUsage:0},setInterval(()=>{this.updateThermalState()},1e4)}async initializeBatteryMonitoring(){try{let e=navigator;if("getBattery"in e){let t=await e.getBattery();this.batteryState={level:t.level,charging:t.charging,chargingTime:t.chargingTime,dischargingTime:t.dischargingTime},t.addEventListener("levelchange",()=>{this.batteryState&&(this.batteryState.level=t.level,this.adjustPerformanceModeForBattery())}),t.addEventListener("chargingchange",()=>{this.batteryState&&(this.batteryState.charging=t.charging,this.adjustPerformanceModeForBattery())}),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Battery monitoring initialized")}}catch{this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Battery API not available")}}updateThermalState(){let e=this.performanceAnalyzer.getMedianFPS()||60,t=performance.memory,i=t?t.usedJSHeapSize/t.jsHeapSizeLimit:0,n="normal",r=0;e<30||i>.9?(n="critical",r=.8):e<45||i>.7?(n="hot",r=.4):(e<55||i>.5)&&(n="warm",r=.2),this.thermalState={temperature:n,throttleLevel:r,cpuUsage:Math.min(1-e/60,1),gpuUsage:0,memoryUsage:i},n==="critical"&&this.currentPerformanceMode.name!=="battery"?this.setPerformanceMode("battery"):n==="normal"&&this.currentPerformanceMode.name==="battery"&&this.setPerformanceMode("auto")}adjustPerformanceModeForBattery(){this.batteryState&&(!this.batteryState.charging&&this.batteryState.level<.2?this.setPerformanceMode("battery"):this.batteryState.charging&&this.currentPerformanceMode.name==="battery"&&this.setPerformanceMode("auto"))}setPerformanceMode(e){let t=this.PERFORMANCE_MODES[e];t&&(this.currentPerformanceMode=t,this.config.enableDebug&&console.log(`[UnifiedPerformanceCoordinator] Performance mode changed to: ${e}`))}getDeviceCapabilities(){return{...this.deviceCapabilities}}getThermalState(){return{...this.thermalState}}getBatteryState(){return this.batteryState?{...this.batteryState}:null}getCurrentPerformanceMode(){return{...this.currentPerformanceMode}}};we.instance=null;Xe=we});var Ge,Ee,Mi=b(()=>{"use strict";Ge=class Ge{constructor(e={},t){this.cssVariableManager=null;this.optimizationLevel="none";this.disabledFeatures=new Set;this.config={budgets:{animationFrame:16.67,cssVariableUpdate:2,domObservation:5,audioAnalysis:10,visualEffects:8,userInteraction:100},autoOptimize:{enabled:!0,violationThreshold:5,recoveryThreshold:80},enableDebug:!1,...e},this.performanceAnalyzer=t,this.setupBudgetMonitoring()}static getInstance(e,t){return!Ge.instance&&t&&(Ge.instance=new Ge(e,t)),Ge.instance}registerUnifiedCSSVariableManager(e){this.cssVariableManager=e}setupBudgetMonitoring(){this.config.autoOptimize.enabled&&setInterval(()=>{this.checkBudgets()},5e3)}checkBudgets(){this.performanceAnalyzer.calculateHealthScore()>=this.config.autoOptimize.recoveryThreshold&&this.recoverOptimizations()}optimizeOperation(e){if(!this.disabledFeatures.has(e)){switch(e){case"cssVariableUpdate":this.optimizeCSSVariableUpdates();break;case"domObservation":this.optimizeDOMObservation();break;case"visualEffects":this.optimizeVisualEffects();break;case"audioAnalysis":this.optimizeAudioAnalysis();break}this.disabledFeatures.add(e),this.config.enableDebug&&console.log(`\u{1F3AF} [PerformanceBudgetManager] Optimized ${e} due to budget violations`)}}optimizeCSSVariableUpdates(){this.cssVariableManager&&this.cssVariableManager.updateConfig({batchIntervalMs:32,maxBatchSize:25})}optimizeDOMObservation(){document.dispatchEvent(new CustomEvent("year3000:optimize-dom-observation",{detail:{level:this.optimizationLevel}}))}optimizeVisualEffects(){document.dispatchEvent(new CustomEvent("year3000:optimize-visual-effects",{detail:{level:this.optimizationLevel}}))}optimizeAudioAnalysis(){document.dispatchEvent(new CustomEvent("year3000:optimize-audio-analysis",{detail:{level:this.optimizationLevel}}))}escalateOptimization(){this.optimizationLevel==="none"?this.optimizationLevel="conservative":this.optimizationLevel==="conservative"&&(this.optimizationLevel="aggressive"),this.config.enableDebug&&console.log(`\u{1F3AF} [PerformanceBudgetManager] Escalated to ${this.optimizationLevel} optimization`)}recoverOptimizations(){this.optimizationLevel!=="none"&&(this.disabledFeatures.clear(),this.cssVariableManager&&this.cssVariableManager.updateConfig({batchIntervalMs:16,maxBatchSize:50}),document.dispatchEvent(new CustomEvent("year3000:recover-optimizations",{detail:{previousLevel:this.optimizationLevel}})),this.optimizationLevel="none",this.config.enableDebug&&console.log("\u{1F3AF} [PerformanceBudgetManager] Recovered from optimizations"))}getOptimizationStatus(){return{level:this.optimizationLevel,disabledFeatures:Array.from(this.disabledFeatures),budgetViolations:[],healthScore:this.performanceAnalyzer.calculateHealthScore()}}manualOptimize(e){this.optimizeOperation(e)}manualRecover(){this.recoverOptimizations()}updateBudgets(e){this.config.budgets={...this.config.budgets,...e};for(let[t,i]of Object.entries(e))this.performanceAnalyzer.updateBudget(t,i)}destroy(){this.disabledFeatures.clear(),this.cssVariableManager=null,Ge.instance=null}};Ge.instance=null;Ee=Ge});var Et,yh,Ka=b(()=>{"use strict";D();R();K();Et=class{constructor(e=A,t=null){this.initialized=!1;this.transitionTimer=0;this.lastTransitionStartTime=0;this.transitionFromAccent="";this.transitionToAccent="";this.settingsManager=null;this.utils=e,this.settingsManager=t,this.consciousnessState={consciousnessResonance:.7,multidimensionalAwareness:.8,transcendenceLevel:.6,dominantEmotionalTemperature:6500,emotionalDepth:.7,emotionalComplexity:.5,totalIntensity:.5,activeLayerCount:3,volumetricDepth:.4,cinematicPerspective:.6,holographicInfluence:.2,dataStreamIntensity:.3,interferencePatterns:.1,projectionStability:.9,temporalMemoryDepth:.5,consciousnessEvolution:0,futureProjection:.2,catppuccinPreservationLevel:.8,currentPalette:[],paletteEvolution:{currentGeneration:0,totalEvolutions:0,evolutionVelocity:.1,adaptationRate:.3,previousGenerations:[],futureProjections:[],temporalPatterns:[],consciousnessGrowth:0,transcendenceProgress:0,cosmicAlignment:.5},atmosphericDensity:.3,cosmicResonance:.5,quantumFluctuation:.2,lastBlendTime:Date.now(),consciousnessFrameRate:60,systemHealthConsciousness:1},this.dynamicColorState={currentAccentHex:"#4b19a1",currentAccentRgb:"75,25,161",baseBackgroundHex:"#0d1117",baseBackgroundRgb:"13,17,23",lastUpdateTime:0,musicEnergy:.5,transitionInProgress:!1},this.integrationConfig={accentUpdateEnabled:!0,baseTransformationEnabled:!0,consciousnessIntegrationEnabled:!0,smoothTransitionDuration:800,energyResponseMultiplier:1.2}}async initialize(){if(!this.initialized)try{this.setupUnifiedEventSubscriptions(),this.setupSettingsListeners(),this.initializeCurrentDynamicState();let e=this.checkDynamicAccentEnabled();this.integrationConfig.accentUpdateEnabled=e,this.initialized=!0,u?.debug?.log("VisualEffectsCoordinator","\u{1F3A8} Unified consciousness coordinator initialized successfully",{consciousnessLevel:this.consciousnessState.consciousnessResonance,dynamicAccentEnabled:e,accentHex:this.dynamicColorState.currentAccentHex})}catch(e){throw u?.debug?.error("VisualEffectsCoordinator","Failed to initialize:",e),e}}async healthCheck(){let e=[];return this.initialized||e.push("Coordinator not initialized"),this.dynamicColorState.transitionInProgress&&Date.now()-this.lastTransitionStartTime>1e4&&e.push("Dynamic color transition appears stuck"),this.consciousnessState.systemHealthConsciousness<.5&&e.push(`Low consciousness health: ${(this.consciousnessState.systemHealthConsciousness*100).toFixed(1)}%`),{healthy:e.length===0,ok:e.length===0,details:`Unified consciousness coordination - consciousness level: ${this.consciousnessState.consciousnessResonance.toFixed(2)}, dynamic accent: ${this.integrationConfig.accentUpdateEnabled}`,issues:e,system:"VisualEffectsCoordinator"}}updateAnimation(e){this.consciousnessState.consciousnessFrameRate=1e3/e,this.consciousnessState.consciousnessEvolution+=e*1e-4,this.consciousnessState.consciousnessEvolution>1&&(this.consciousnessState.consciousnessEvolution=0),this.consciousnessState.quantumFluctuation=.2+Math.sin(Date.now()*.002)*.1}destroy(){this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=0),p.unsubscribeAll("VisualEffectsCoordinator"),this.dynamicColorState.transitionInProgress=!1,this.initialized=!1,u?.debug?.log("VisualEffectsCoordinator","Unified consciousness coordinator destroyed")}setupUnifiedEventSubscriptions(){p.subscribe("colors:harmonized",e=>{this.handleUnifiedColorUpdate(e)},"VisualEffectsCoordinator"),p.subscribe("colors:extracted",e=>{e.rawColors&&this.handleExtractedColors(e.rawColors)},"VisualEffectsCoordinator"),p.subscribe("colors:applied",e=>{e.cssVariables&&this.integrationConfig.accentUpdateEnabled&&this.handleCSSVariablesApplied(e.cssVariables,e.accentHex,e.accentRgb)},"VisualEffectsCoordinator"),p.subscribe("settings:changed",e=>{this.handleSettingsChange(e)},"VisualEffectsCoordinator"),typeof document<"u"&&document.addEventListener("music-state-change",e=>{let t=e;t.detail&&this.handleMusicStateChange(t.detail)}),u?.debug?.log("VisualEffectsCoordinator","Unified event subscriptions setup complete")}handleUnifiedColorUpdate(e){let{processedColors:t,accentHex:i,accentRgb:n,coordinationMetrics:r}=e,a=r?.emotionalState||"neutral",s=r?.musicInfluenceStrength||.5;this.updateConsciousnessFromMusic(a,s),this.updatePaletteFromUnifiedColors(t,i,n),this.integrationConfig.accentUpdateEnabled&&i&&i!==this.dynamicColorState.currentAccentHex&&this.scheduleSmoothAccentTransition(i),this.publishConsciousnessUpdate()}handleExtractedColors(e){if(this.integrationConfig.accentUpdateEnabled)try{let t=this.selectBestAccentColor(e);t&&t!==this.dynamicColorState.currentAccentHex&&this.scheduleSmoothAccentTransition(t),u?.debug?.log("VisualEffectsCoordinator","Processed extracted colors:",{input:Object.keys(e),selectedAccent:t})}catch(t){u?.debug?.error("VisualEffectsCoordinator","Error handling extracted colors:",t)}}handleCSSVariablesApplied(e,t,i){if(this.integrationConfig.accentUpdateEnabled)try{t&&t!==this.dynamicColorState.currentAccentHex&&(this.dynamicColorState.currentAccentHex=t,this.dynamicColorState.currentAccentRgb=i,this.dynamicColorState.lastUpdateTime=Date.now());let n={},r=e["--sn-accent-hex"]||e["--spice-accent"]||t,a=e["--sn-accent-rgb"]||e["--spice-rgb-accent"]||i;if(r&&a&&(n["--sn-dynamic-accent-hex"]=r,n["--sn-dynamic-accent-rgb"]=a,n["--sn-dynamic-primary-hex"]=r,n["--sn-dynamic-primary-rgb"]=a,typeof document<"u")){let s=document.documentElement;Object.entries(n).forEach(([o,l])=>{s.style.setProperty(o,l)})}u?.debug?.log("VisualEffectsCoordinator","Processed colors:applied event:",{accentHex:r,accentRgb:a,variablesProcessed:Object.keys(e).length,enhancedVariables:Object.keys(n).length})}catch(n){u?.debug?.error("VisualEffectsCoordinator","Error handling CSS variables applied:",n)}}handleMusicStateChange(e){e.energy!==void 0&&(this.dynamicColorState.musicEnergy=e.energy,this.integrationConfig.consciousnessIntegrationEnabled&&this.updateConsciousnessWithMusicEnergy(e.energy))}handleSettingsChange(e){if(["catppuccin-flavor","catppuccin-accentColor","sn-dynamic-color-intensity"].includes(e.settingKey)&&(this.consciousnessState.consciousnessEvolution=0,u?.debug?.log("VisualEffectsCoordinator","Consciousness state reset due to settings change:",e.settingKey)),e.settingKey==="catppuccin-accentColor"){let t=String(e.value)==="dynamic";this.integrationConfig.accentUpdateEnabled=t,u?.debug?.log("VisualEffectsCoordinator",`Accent setting changed to: ${e.value}, Dynamic enabled: ${t}`)}}updateConsciousnessFromMusic(e,t){e&&(this.consciousnessState.consciousnessResonance=(e.valence+e.intensity)*.5,this.consciousnessState.dominantEmotionalTemperature=4e3+e.valence*4e3,this.consciousnessState.totalIntensity=e.intensity||.5,this.consciousnessState.multidimensionalAwareness=Math.min(1,(e.valence+e.arousal)*.6),this.consciousnessState.emotionalDepth=Math.abs(e.valence-.5)*2,this.consciousnessState.dataStreamIntensity=e.intensity*.7),t&&(this.consciousnessState.holographicInfluence=Math.min(.8,t.strength*.6),t.strength>.7&&this.updateTemporalMemory(t),this.consciousnessState.volumetricDepth=Math.min(1,t.strength*.8))}updatePaletteFromUnifiedColors(e,t,i){let n=[{hex:t,rgb:this.hexToRgb(t)},{hex:e.primary||t,rgb:this.hexToRgb(e.primary||t)},{hex:e.secondary||t,rgb:this.hexToRgb(e.secondary||t)}].filter(r=>r.hex);this.updatePaletteFromHarmony(n)}updatePaletteFromHarmony(e){this.consciousnessState.currentPalette.length>0&&(this.consciousnessState.paletteEvolution.previousGenerations.push([...this.consciousnessState.currentPalette]),this.consciousnessState.paletteEvolution.previousGenerations.length>5&&this.consciousnessState.paletteEvolution.previousGenerations.shift()),this.consciousnessState.currentPalette=e.map((t,i)=>({rgb:t.rgb||{r:t.r||0,g:t.g||0,b:t.b||0},oklab:t.oklab,hsl:t.hsl,xyz:t.xyz,consciousnessLevel:this.consciousnessState.consciousnessResonance,emotionalResonance:this.consciousnessState.emotionalDepth,transcendenceIndex:this.consciousnessState.transcendenceLevel,temporalStability:Math.max(.1,1-i*.1),evolutionRate:this.consciousnessState.paletteEvolution.evolutionVelocity,memoryImprint:this.consciousnessState.temporalMemoryDepth,volumetricPresence:this.consciousnessState.volumetricDepth*(1-i*.15),holographicReflectance:this.consciousnessState.holographicInfluence,cosmicFrequency:432+i*111,colorSpace:t.oklab?"oklab":"rgb",generationMethod:"harmony",timestamp:Date.now()})),this.consciousnessState.activeLayerCount=e.length,this.consciousnessState.lastBlendTime=Date.now(),this.consciousnessState.paletteEvolution.currentGeneration++,this.consciousnessState.paletteEvolution.totalEvolutions++}updateTemporalMemory(e){let i={patternId:`pattern-${Date.now()}`,frequency:e.tempo||120,strength:e.strength,colorSequence:[...this.consciousnessState.currentPalette],musicalCorrelation:e.strength,consciousnessSignature:this.consciousnessState.consciousnessResonance};this.consciousnessState.paletteEvolution.temporalPatterns.push(i),this.consciousnessState.paletteEvolution.temporalPatterns.length>10&&this.consciousnessState.paletteEvolution.temporalPatterns.shift(),this.consciousnessState.temporalMemoryDepth=Math.min(1,this.consciousnessState.temporalMemoryDepth+.1)}publishConsciousnessUpdate(){p.emit("consciousness:updated",{type:"colorConsciousnessUpdate",payload:{palette:this.consciousnessState.currentPalette,consciousnessLevel:this.consciousnessState.consciousnessResonance,emotionalTemperature:this.consciousnessState.dominantEmotionalTemperature,multidimensionalAwareness:this.consciousnessState.multidimensionalAwareness,transcendenceLevel:this.consciousnessState.transcendenceLevel,volumetricDepth:this.consciousnessState.volumetricDepth,dataStreamIntensity:this.consciousnessState.dataStreamIntensity,temporalMemoryDepth:this.consciousnessState.temporalMemoryDepth,cosmicResonance:this.consciousnessState.cosmicResonance,paletteGeneration:this.consciousnessState.paletteEvolution.currentGeneration,temporalPatternCount:this.consciousnessState.paletteEvolution.temporalPatterns.length,fullConsciousnessState:this.consciousnessState}}),this.consciousnessState.dataStreamIntensity>.5&&p.emit("consciousness:holographic-stream",{type:"holographicStreamUpdate",payload:{intensity:this.consciousnessState.dataStreamIntensity,interferencePatterns:this.consciousnessState.interferencePatterns,projectionStability:this.consciousnessState.projectionStability}}),this.consciousnessState.paletteEvolution.temporalPatterns.length>3&&p.emit("consciousness:temporal-pattern",{type:"temporalPatternDetected",payload:{patterns:this.consciousnessState.paletteEvolution.temporalPatterns,memoryDepth:this.consciousnessState.temporalMemoryDepth}}),this.consciousnessState.transcendenceLevel>.8&&p.emit("consciousness:transcendence-high",{type:"transcendenceLevelHigh",payload:{level:this.consciousnessState.transcendenceLevel,cosmicAlignment:this.consciousnessState.paletteEvolution.cosmicAlignment}})}scheduleSmoothAccentTransition(e){if(this.dynamicColorState.transitionInProgress){this.transitionToAccent=e;return}this.transitionFromAccent=this.dynamicColorState.currentAccentHex,this.transitionToAccent=e,this.dynamicColorState.transitionInProgress=!0,this.lastTransitionStartTime=Date.now(),this.animateAccentTransition(),u?.debug?.log("VisualEffectsCoordinator",`Accent transition scheduled: ${this.transitionFromAccent} \u2192 ${e}`)}animateAccentTransition(){let e=()=>{if(!this.dynamicColorState.transitionInProgress)return;let t=Date.now()-this.lastTransitionStartTime,i=Math.min(t/this.integrationConfig.smoothTransitionDuration,1),n=1-Math.pow(1-i,3),r=this.interpolateColors(this.transitionFromAccent,this.transitionToAccent,n);if(r&&this.applyDynamicAccent(r),i>=1){this.dynamicColorState.transitionInProgress=!1,this.dynamicColorState.currentAccentHex=this.transitionToAccent,this.dynamicColorState.lastUpdateTime=Date.now();let a=this.utils.hexToRgb(this.transitionToAccent);a&&(this.dynamicColorState.currentAccentRgb=`${a.r},${a.g},${a.b}`),u?.debug?.log("VisualEffectsCoordinator",`Accent transition complete: ${this.transitionToAccent}`)}else requestAnimationFrame(e)};requestAnimationFrame(e)}applyDynamicAccent(e){if(typeof document>"u")return;let t=document.documentElement,i=this.utils.hexToRgb(e);if(!i)return;let n=`${i.r},${i.g},${i.b}`;t.style.setProperty("--sn-dynamic-accent-hex",e),t.style.setProperty("--sn-dynamic-accent-rgb",n),t.style.setProperty("--sn-dynamic-primary-hex",e),t.style.setProperty("--sn-dynamic-primary-rgb",n),t.style.setProperty("--spice-accent",e),t.style.setProperty("--spice-button",e),t.style.setProperty("--spice-button-active",e),t.style.setProperty("--spice-rgb-accent",n),t.style.setProperty("--spice-rgb-button",n),t.style.setProperty("--sn-color-extracted-primary-rgb",n),t.style.setProperty("--sn-color-extracted-vibrant-rgb",n),t.style.setProperty("--sn-color-extracted-dominant-rgb",n),this.integrationConfig.consciousnessIntegrationEnabled&&this.updateConsciousnessWithAccent(e,n)}updateConsciousnessWithAccent(e,t){if(typeof document>"u")return;let i=document.documentElement;i.style.setProperty("--organic-holographic-rgb",t),i.style.setProperty("--holographic-scanline-rgb",t),i.style.setProperty("--consciousness-intensity",`calc(0.5 + var(--musical-sync-intensity) * ${this.integrationConfig.energyResponseMultiplier})`)}updateConsciousnessWithMusicEnergy(e){if(typeof document>"u")return;let t=document.documentElement,i=e*this.integrationConfig.energyResponseMultiplier;t.style.setProperty("--musical-sync-intensity",i.toString()),t.style.setProperty("--holographic-music-flicker-intensity",i.toString());let r=Math.max(.1,Math.min(1,.5+i*.3));t.style.setProperty("--consciousness-intensity",r.toString())}hexToRgb(e){e=e.replace("#","");let t=parseInt(e.substring(0,2),16),i=parseInt(e.substring(2,4),16),n=parseInt(e.substring(4,6),16);return{r:t,g:i,b:n}}interpolateColors(e,t,i){let n=this.utils.hexToRgb(e),r=this.utils.hexToRgb(t);if(!n||!r)return null;let a=Math.round(n.r+(r.r-n.r)*i),s=Math.round(n.g+(r.g-n.g)*i),o=Math.round(n.b+(r.b-n.b)*i);return this.utils.rgbToHex(a,s,o)}selectBestAccentColor(e){let t=["VIBRANT_NON_ALARMING","VIBRANT","LIGHT_VIBRANT","PROMINENT","PRIMARY","DARK_VIBRANT"];for(let i of t){let n=e[i];if(n&&this.utils.hexToRgb(n))return n}return null}checkDynamicAccentEnabled(){try{if(!this.settingsManager)return!1;let e=this.settingsManager.get("catppuccin-accentColor");return String(e)==="dynamic"}catch(e){return u?.debug?.error("VisualEffectsCoordinator","Error checking dynamic accent setting:",e),!1}}initializeCurrentDynamicState(){if(typeof document>"u")return;let e=document.documentElement,t=getComputedStyle(e),i=t.getPropertyValue("--sn-dynamic-accent-hex").trim()||t.getPropertyValue("--sn-cosmic-accent-hex").trim()||t.getPropertyValue("--spice-accent").trim();if(i){this.dynamicColorState.currentAccentHex=i;let n=this.utils.hexToRgb(i);n&&(this.dynamicColorState.currentAccentRgb=`${n.r},${n.g},${n.b}`)}this.dynamicColorState.lastUpdateTime=Date.now()}setupSettingsListeners(){typeof document>"u"||document.addEventListener("year3000SystemSettingsChanged",e=>{let t=e,{key:i,value:n}=t.detail||{};if(i==="catppuccin-accentColor"){let r=String(n)==="dynamic";this.integrationConfig.accentUpdateEnabled=r,u?.debug?.log("VisualEffectsCoordinator",`Accent setting changed to: ${n}, Coordinator active: ${this.initialized}`)}})}getConsciousnessState(){return{...this.consciousnessState}}setConsciousness(e,t=6500){this.consciousnessState.consciousnessResonance=Math.max(0,Math.min(1,e)),this.consciousnessState.dominantEmotionalTemperature=Math.max(1e3,Math.min(1e4,t)),this.consciousnessState.transcendenceLevel=Math.min(1,e*1.2),this.consciousnessState.multidimensionalAwareness=e*.9,this.publishConsciousnessUpdate()}getTranscendentPalette(){return[...this.consciousnessState.currentPalette]}getTemporalPatterns(){return[...this.consciousnessState.paletteEvolution.temporalPatterns]}getDynamicColorState(){return{...this.dynamicColorState}}updateConfig(e){this.integrationConfig={...this.integrationConfig,...e},u?.debug?.log("VisualEffectsCoordinator","Configuration updated:",e)}setTranscendence(e){this.consciousnessState.transcendenceLevel=Math.max(0,Math.min(1,e)),this.consciousnessState.cosmicResonance=e*.8,this.consciousnessState.paletteEvolution.transcendenceProgress=e,this.publishConsciousnessUpdate()}setDataStreamIntensity(e){this.consciousnessState.dataStreamIntensity=Math.max(0,Math.min(1,e)),this.publishConsciousnessUpdate()}},yh=new Et});var wi,ja=b(()=>{"use strict";mi();U();R();Ae();ne();wi=class{constructor(e=w.enableDebug){this.coordinationCache=new Map;this.cacheMaxSize=20;this.cacheTimeoutMs=3e5;this.enableDebug=e,this.oklabProcessor=new M(e),this.emotionalMapper=new J(e),this.genreManager=new Be({YEAR3000_CONFIG:w}),this.enableDebug&&u?.debug?.log("MusicalOKLABCoordinator","Unified music-to-OKLAB coordinator initialized")}async coordinateMusicalColors(e,t={}){let i=performance.now(),n=this.generateCacheKey(e),r=this.coordinationCache.get(n);if(r)return this.enableDebug&&u?.debug?.log("MusicalOKLABCoordinator","Using cached coordination result",{cacheKey:n}),r;try{let a=this.determineCoordinationStrategy(e,t),s=await this.getOptimalOKLABPreset(e,a,t),o=await this.processColorsWithMusicalContext(e.rawColors,e.musicData,s),l=this.emotionalMapper.mapMusicToEmotionalTemperature(e.musicData),m=this.genreManager.detectGenre(e.musicData),d=this.genreManager.getColorCharacteristicsForGenre(m),h=this.calculateMusicInfluenceStrength(e.musicData,l),g=this.generateUnifiedCSSVariables(o,l,d,s),{accentHex:f,accentRgb:v}=this.selectOptimalAccentColor(o),C=performance.now()-i,P={enhancedColors:Object.fromEntries(Object.entries(o).map(([E,L])=>[E,L.enhancedHex])),accentHex:f,accentRgb:v,oklabPreset:s,oklabResults:o,detectedGenre:m,emotionalResult:l,genreCharacteristics:d,processingTime:C,musicInfluenceStrength:h,coordinationStrategy:a,cssVariables:g};return this.cacheResult(n,P),this.enableDebug&&u?.debug?.log("MusicalOKLABCoordinator","Musical OKLAB coordination completed",{genre:m,emotion:l.primaryEmotion,strategy:a,preset:s.name,processingTime:C,colorCount:Object.keys(o).length}),P}catch(a){return this.enableDebug&&u?.debug?.error("MusicalOKLABCoordinator","Musical coordination failed:",a),this.createFallbackResult(e,performance.now()-i)}}determineCoordinationStrategy(e,t){let{musicData:i}=e;if(!i||typeof i.energy!="number"||typeof i.valence!="number")return"fallback";if(t.preferGenreOverEmotion===!0)return"genre-primary";if(t.preferGenreOverEmotion===!1)return"emotion-primary";let n=Math.abs(i.energy-.5)*2,r=Math.abs(i.valence-.5)*2;return(n+r)/2>.6?"emotion-primary":this.genreManager.detectGenre(i)!=="default"?"genre-primary":"balanced"}async getOptimalOKLABPreset(e,t,i){let{musicData:n}=e;try{let r;switch(t){case"genre-primary":r=this.genreManager.getOKLABPresetForTrack(n);break;case"emotion-primary":r=this.emotionalMapper.mapMusicToEmotionalTemperature(n).oklabPreset;break;case"balanced":let s=this.genreManager.getOKLABPresetForTrack(n),o=this.emotionalMapper.mapMusicToEmotionalTemperature(n);r=this.blendPresets(s,o.oklabPreset,i.intensityMultiplier||1);break;default:r=M.getPreset("STANDARD")}return r}catch(r){return this.enableDebug&&u?.debug?.warn("MusicalOKLABCoordinator","Failed to get optimal preset, using STANDARD:",r),M.getPreset("STANDARD")}}blendPresets(e,t,i){let n=(e.chromaBoost+t.chromaBoost)/2*i,r=(e.lightnessBoost+t.lightnessBoost)/2,a=(e.shadowReduction+t.shadowReduction)/2,s=(e.vibrantThreshold+t.vibrantThreshold)/2;return M.createCustomPreset("blended-genre-emotion",`Blended ${e.name} + ${t.name}`,r,n,a,s)}async processColorsWithMusicalContext(e,t,i){let n={};for(let[r,a]of Object.entries(e))if(!(!a||typeof a!="string"||!a.startsWith("#")))try{let s=this.oklabProcessor.processColor(a,i);n[r]=s}catch(s){this.enableDebug&&u?.debug?.warn("MusicalOKLABCoordinator",`Failed to process color ${r}:`,s)}return n}calculateMusicInfluenceStrength(e,t){let i=e.energy||.5,n=Math.abs((e.valence||.5)-.5)*2,r=t.intensity,a=(i+n+r)/3,s=1;return e.tempo&&e.tempo>0&&(s+=.1),e.danceability&&e.danceability>.7&&(s+=.1),e.genre&&e.genre!=="default"&&(s+=.1),Math.min(1,a*s)}generateUnifiedCSSVariables(e,t,i,n){let r={};return Object.entries(e).forEach(([a,s])=>{r[`--sn-${a.toLowerCase()}-enhanced`]=s.enhancedHex,r[`--sn-${a.toLowerCase()}-oklab-l`]=s.oklabEnhanced.L.toFixed(3),r[`--sn-${a.toLowerCase()}-oklab-a`]=s.oklabEnhanced.a.toFixed(3),r[`--sn-${a.toLowerCase()}-oklab-b`]=s.oklabEnhanced.b.toFixed(3),r[`--sn-${a.toLowerCase()}-oklch-c`]=s.oklchEnhanced.C.toFixed(3),r[`--sn-${a.toLowerCase()}-oklch-h`]=s.oklchEnhanced.H.toFixed(1),r[`--sn-${a.toLowerCase()}-shadow`]=s.shadowHex}),Object.entries(t.cssVariables).forEach(([a,s])=>{r[a]=s}),r["--sn-detected-genre"]=i?i.vibrancyLevel:"standard",r["--sn-color-temperature"]=i?i.colorTemperature:"neutral",r["--sn-emotional-range"]=i?i.emotionalRange:"moderate",r["--sn-oklab-preset-name"]=n.name,r["--sn-oklab-chroma-boost"]=n.chromaBoost.toString(),r["--sn-oklab-lightness-boost"]=n.lightnessBoost.toString(),r["--sn-musical-oklab-coordination"]="enabled",r["--sn-color-processing-mode"]="unified-musical-oklab",r}selectOptimalAccentColor(e){let t=["VIBRANT","PROMINENT","DARK_VIBRANT","LIGHT_VIBRANT"];for(let n of t)if(e[n]){let r=e[n];return{accentHex:r.enhancedHex,accentRgb:`${r.enhancedRgb.r},${r.enhancedRgb.g},${r.enhancedRgb.b}`}}let i=Object.values(e)[0];return i?{accentHex:i.enhancedHex,accentRgb:`${i.enhancedRgb.r},${i.enhancedRgb.g},${i.enhancedRgb.b}`}:{accentHex:"#cba6f7",accentRgb:"203,166,247"}}createFallbackResult(e,t){let i=M.getPreset("STANDARD");return{enhancedColors:e.rawColors,accentHex:"#cba6f7",accentRgb:"203,166,247",oklabPreset:i,oklabResults:{},detectedGenre:"default",emotionalResult:{primaryEmotion:"calm",intensity:.5,temperature:3500,blendRatio:1,cssClass:"organic-emotion-calm",cssVariables:{},oklabPreset:i},genreCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"},processingTime:t,musicInfluenceStrength:.5,coordinationStrategy:"fallback",cssVariables:{"--sn-musical-oklab-coordination":"fallback","--sn-oklab-preset-name":"STANDARD"}}}generateCacheKey(e){return`${e.trackUri}-${e.timestamp}-${JSON.stringify(e.musicData)}`}cacheResult(e,t){if(this.coordinationCache.size>=this.cacheMaxSize){let i=this.coordinationCache.keys().next().value;i&&this.coordinationCache.delete(i)}this.coordinationCache.set(e,t),setTimeout(()=>{this.coordinationCache.delete(e)},this.cacheTimeoutMs)}convertToColorResult(e,t){return{processedColors:{...e.enhancedColors,...e.cssVariables},accentHex:e.accentHex,accentRgb:e.accentRgb,metadata:{strategy:"musical-oklab-coordinator",processingTime:e.processingTime,detectedGenre:e.detectedGenre,emotionalState:e.emotionalResult.primaryEmotion,oklabPreset:e.oklabPreset.name,coordinationStrategy:e.coordinationStrategy,musicInfluenceStrength:e.musicInfluenceStrength},context:{rawColors:t.rawColors,trackUri:t.trackUri,timestamp:t.timestamp,harmonicMode:t.harmonicMode||"musical-oklab",musicData:t.musicData}}}clearCache(){this.coordinationCache.clear(),this.enableDebug&&u?.debug?.log("MusicalOKLABCoordinator","Coordination cache cleared")}getCoordinationMetrics(){return{cacheSize:this.coordinationCache.size,maxCacheSize:this.cacheMaxSize,cacheTimeoutMs:this.cacheTimeoutMs,enableDebug:this.enableDebug}}}});var Ei,Qa=b(()=>{"use strict";R();Ei=class{constructor(){this.strategiesMap=new Map;this.metrics={totalStrategies:0,healthyStrategies:0,averageResponseTime:0,totalUsageCount:0,cacheHitRate:0,memoryUsage:0};this.healthCheckInterval=null;this.HEALTH_CHECK_INTERVAL_MS=3e4;this.startHealthMonitoring(),u?.debug?.log("BackgroundStrategyRegistry","Strategy registry initialized")}register(e){let t=e.getStrategyName();this.strategiesMap.has(t)&&u?.debug?.warn("BackgroundStrategyRegistry",`Strategy ${t} is already registered, replacing...`);try{let i={strategy:e,registrationTime:Date.now(),lastUsed:0,usageCount:0,errorCount:0,averageProcessingTime:0,isHealthy:!0,metadata:this.inferStrategyMetadata(e)};this.strategiesMap.set(t,i),this.updateMetrics(),u?.debug?.log("BackgroundStrategyRegistry",`Registered strategy: ${t}`,{category:i.metadata.category,priority:i.metadata.priority,memoryImpact:i.metadata.memoryImpact})}catch(i){u?.debug?.error("BackgroundStrategyRegistry",`Failed to register strategy ${t}:`,i)}}selectStrategy(e){let t=Array.from(this.strategiesMap.values()).filter(n=>n.isHealthy).sort((n,r)=>this.scoreStrategy(r,e)-this.scoreStrategy(n,e));if(t.length===0)return u?.debug?.warn("BackgroundStrategyRegistry","No healthy strategies available"),null;let i=t[0];return i?(this.recordStrategyUsage(i.strategy.getStrategyName()),u?.debug?.log("BackgroundStrategyRegistry",`Selected strategy: ${i.strategy.getStrategyName()}`,{score:this.scoreStrategy(i,e),totalAvailable:t.length}),i.strategy):(u?.debug?.warn("BackgroundStrategyRegistry","No strategies available after filtering"),null)}getStrategies(){return Array.from(this.strategiesMap.values()).filter(e=>e.isHealthy).map(e=>e.strategy)}getStrategy(e){let t=this.strategiesMap.get(e);return t&&t.isHealthy?t.strategy:null}selectMultipleStrategies(e,t=4){let i=Array.from(this.strategiesMap.values()).filter(r=>r.isHealthy).map(r=>({registration:r,score:this.scoreStrategy(r,e)})).sort((r,a)=>a.score-r.score).slice(0,t);i.forEach(r=>{this.recordStrategyUsage(r.registration.strategy.getStrategyName())});let n=i.map(r=>r.registration.strategy);return u?.debug?.log("BackgroundStrategyRegistry",`Selected ${n.length} strategies`,{strategies:n.map(r=>r.getStrategyName()),scores:i.map(r=>r.score)}),n}scoreStrategy(e,t){let i=0;switch(i+=e.metadata.priority*10,t.performance){case"high":e.metadata.memoryImpact==="low"&&(i+=20),e.averageProcessingTime<10&&(i+=15);break;case"medium":e.metadata.memoryImpact!=="high"&&(i+=10),e.averageProcessingTime<20&&(i+=10);break;case"low":break}switch(t.quality){case"premium":e.metadata.category==="enhancement"&&(i+=15),e.metadata.tags.includes("webgl")&&(i+=10);break;case"enhanced":e.metadata.category!=="effects"&&(i+=10);break;case"basic":e.metadata.category==="foundation"&&(i+=15);break}if(t.deviceCapabilities&&(t.deviceCapabilities.hasWebGL&&e.metadata.tags.includes("webgl")&&(i+=15),t.deviceCapabilities.isMobile&&e.metadata.memoryImpact==="low"&&(i+=10),t.deviceCapabilities.memoryMB&&t.deviceCapabilities.memoryMB<4e3&&e.metadata.memoryImpact==="high"&&(i-=20)),t.userPreferences&&(t.userPreferences.enableAdvancedBlending&&e.metadata.tags.includes("advanced-blending")&&(i+=12),t.userPreferences.harmonicMode)){let a=t.userPreferences.harmonicMode;e.metadata.tags.includes(a)&&(i+=8)}let n=e.usageCount>0?e.errorCount/e.usageCount:0;return i-=n*30,Date.now()-e.lastUsed<3e5&&(i+=5),Math.max(0,i)}inferStrategyMetadata(e){let t=e.getStrategyName(),i=[],n="enhancement",r=5,a="medium",s=[];switch(t){case"dynamic-catppuccin":n="accent",r=10,a="low",i.push("catppuccin","dynamic","accent","spicetify");break;case"living-gradient":n="foundation",r=8,a="low",i.push("gradient","breathing","foundation","css");break;case"webgl-gradient":n="enhancement",r=6,a="high",s.push("webgl"),i.push("webgl","gradient","performance","advanced-blending");break;case"depth-layered":n="effects",r=7,a="medium",i.push("depth","layers","parallax","consciousness","cosmic","cinematic");break;default:break}return{category:n,priority:r,memoryImpact:a,deviceRequirements:s,tags:i}}recordStrategyUsage(e){let t=this.strategiesMap.get(e);t&&(t.usageCount++,t.lastUsed=Date.now())}recordStrategyError(e,t){let i=this.strategiesMap.get(e);if(i){i.errorCount++;let n=i.errorCount/Math.max(1,i.usageCount);n>.5&&i.usageCount>5&&(i.isHealthy=!1,u?.debug?.warn("BackgroundStrategyRegistry",`Strategy ${e} marked as unhealthy`,{errorRate:n,errorCount:i.errorCount,usageCount:i.usageCount}))}}recordStrategyProcessingTime(e,t){let i=this.strategiesMap.get(e);if(i){let n=i.averageProcessingTime*(i.usageCount-1)+t;i.averageProcessingTime=n/i.usageCount}}startHealthMonitoring(){this.healthCheckInterval=window.setInterval(()=>{this.performHealthChecks()},this.HEALTH_CHECK_INTERVAL_MS)}async performHealthChecks(){try{for(let[e,t]of this.strategiesMap.entries())try{if("healthCheck"in t.strategy&&typeof t.strategy.healthCheck=="function"){let i=await t.strategy.healthCheck();t.isHealthy=i?.healthy??!0,t.isHealthy||u?.debug?.warn("BackgroundStrategyRegistry",`Strategy ${e} failed health check:`,i)}}catch(i){t.isHealthy=!1,u?.debug?.error("BackgroundStrategyRegistry",`Health check failed for strategy ${e}:`,i)}this.updateMetrics()}catch(e){u?.debug?.error("BackgroundStrategyRegistry","Health check monitoring failed:",e)}}updateMetrics(){let e=Array.from(this.strategiesMap.values());this.metrics.totalStrategies=e.length,this.metrics.healthyStrategies=e.filter(i=>i.isHealthy).length,this.metrics.totalUsageCount=e.reduce((i,n)=>i+n.usageCount,0);let t=e.filter(i=>i.averageProcessingTime>0).map(i=>i.averageProcessingTime);t.length>0&&(this.metrics.averageResponseTime=t.reduce((i,n)=>i+n,0)/t.length),this.metrics.memoryUsage=e.reduce((i,n)=>{let r=n.metadata.memoryImpact==="high"?3:n.metadata.memoryImpact==="medium"?2:1;return i+r},0)}getRegistryMetrics(){return{...this.metrics}}getStrategyInfo(e){let t=this.strategiesMap.get(e);return t?{...t}:null}getAllStrategyInfo(){return Array.from(this.strategiesMap.entries()).map(([e,t])=>({name:e,registration:{...t}}))}unregister(e){let t=this.strategiesMap.delete(e);return t&&(this.updateMetrics(),u?.debug?.log("BackgroundStrategyRegistry",`Unregistered strategy: ${e}`)),t}clear(){this.strategiesMap.clear(),this.updateMetrics(),u?.debug?.log("BackgroundStrategyRegistry","All strategies cleared from registry")}destroy(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null);for(let[e,t]of this.strategiesMap.entries())if("destroy"in t.strategy&&typeof t.strategy.destroy=="function")try{t.strategy.destroy()}catch(i){u?.debug?.warn("BackgroundStrategyRegistry",`Error destroying strategy ${e}:`,i)}this.clear(),u?.debug?.log("BackgroundStrategyRegistry","Strategy registry destroyed")}}});var Pt,Sc,vc,Cc,Gh,Xa=b(()=>{"use strict";D();ue();R();De();ja();ne();Qa();Rn();Pt=class{constructor(e,t){this.initialized=!1;this.processingState={isProcessing:!1,currentTrackUri:null,lastExtractedColors:null,lastProcessedResult:null,lastProcessingTime:0,processingQueue:[],queueSize:0};this.metrics={totalExtractions:0,totalProcessed:0,totalApplied:0,averageProcessingTime:0,successRate:0,errorCount:0,lastProcessingTime:0,oklabCoordinations:0,strategySelections:0,cacheHits:0};this.processingTimeout=null;this.PROCESSING_TIMEOUT_MS=1e4;this.MAX_QUEUE_SIZE=10;this.processingCache=new Map;this.CACHE_TTL_MS=3e4;this.settingsManager=e||new ee,this.performanceAnalyzer=t||null,this.deviceCapabilityDetector=new N,this.strategyRegistry=new Ei,this.strategySelector=new at,this.oklabProcessor=new M,this.musicalOKLABCoordinator=new wi(!0)}async initialize(){if(!this.initialized)try{await this.deviceCapabilityDetector.initialize(),this.setupEventSubscriptions(),this.registerDefaultStrategies(),this.initialized=!0,u?.debug?.log("UnifiedColorProcessingEngine","\u{1F3A8} Unified color processing engine initialized")}catch(e){throw u?.debug?.error("UnifiedColorProcessingEngine","Failed to initialize:",e),e}}async healthCheck(){let e=[];return this.initialized||e.push("Engine not initialized"),this.processingState.isProcessing&&Date.now()-this.processingState.lastProcessingTime>this.PROCESSING_TIMEOUT_MS&&e.push("Processing appears stuck"),this.metrics.errorCount>0&&this.metrics.successRate<.8&&e.push(`Low success rate: ${(this.metrics.successRate*100).toFixed(1)}%`),this.processingState.queueSize>this.MAX_QUEUE_SIZE&&e.push(`Queue overflow: ${this.processingState.queueSize} items`),{healthy:e.length===0,ok:e.length===0,details:`Unified color processing - ${this.metrics.totalProcessed} processed, ${this.metrics.successRate.toFixed(2)} success rate`,issues:e,system:"UnifiedColorProcessingEngine"}}updateAnimation(e){this.processingCache.size>50&&this.cleanupCache()}destroy(){this.processingTimeout&&(clearTimeout(this.processingTimeout),this.processingTimeout=null),this.processingState.processingQueue=[],this.processingCache.clear(),p.unsubscribeAll("UnifiedColorProcessingEngine"),this.initialized=!1}setupEventSubscriptions(){p.subscribe("colors:extracted",e=>{this.handleColorExtraction(e)},"UnifiedColorProcessingEngine"),p.subscribe("settings:changed",e=>{this.handleSettingsChange(e)},"UnifiedColorProcessingEngine")}async processColors(e){let t=performance.now();try{let i=this.generateCacheKey(e),n=this.getCachedResult(i);if(n)return this.metrics.cacheHits++,n;let r=await this.selectOptimalStrategy(e);this.metrics.strategySelections++;let a=await this.processWithOKLAB(e,r),s=performance.now()-t;this.updateMetrics(s,!0);let o={...a,processingTime:s,strategy:r,success:!0,timestamp:Date.now(),coordinationMetrics:{detectedGenre:e.musicData?.genre||"unknown",emotionalState:e.musicData?.energy?this.classifyEmotionalState(e.musicData.energy):"neutral",oklabPreset:this.determineOKLABPreset(e),coordinationStrategy:r.getStrategyName(),musicInfluenceStrength:e.musicData?.energy||.5}};return this.cacheResult(i,o),p.emit("colors:harmonized",{processedColors:a.processedColors,accentHex:a.accentHex||"#cba6f7",accentRgb:a.accentRgb||"203,166,247",strategies:[r.getStrategyName()],coordinationMetrics:o.coordinationMetrics,oklabData:o.oklabData,processingTime:s,timestamp:Date.now()}),o}catch(i){let n=performance.now()-t;return this.updateMetrics(n,!1),u?.debug?.error("UnifiedColorProcessingEngine","Processing failed:",i),this.createFallbackResult(e,i)}}async handleColorExtraction(e){return"rawColors"in e&&"trackUri"in e?this.processColorContext(e):this.handleColorExtractionEvent(e)}async processColorContext(e){this.metrics.totalExtractions++;try{if(this.processingState.isProcessing){this.addToQueue(e);return}await this.processWithTimeout(e)}catch(t){this.metrics.errorCount++,u?.debug?.error("UnifiedColorProcessingEngine","Color context processing failed:",t)}}async handleColorExtractionEvent(e){this.metrics.totalExtractions++;try{let t={rawColors:e.rawColors,trackUri:e.trackUri,musicData:e.musicData,timestamp:e.timestamp||Date.now()};if(this.processingState.isProcessing){this.addToQueue(t);return}await this.processWithTimeout(t)}catch(t){this.metrics.errorCount++,u?.debug?.error("UnifiedColorProcessingEngine","Color extraction handling failed:",t)}}async processWithOKLAB(e,t){let i={rawColors:e.rawColors,musicData:e.musicData,trackUri:e.trackUri,timestamp:e.timestamp},n=await this.musicalOKLABCoordinator.coordinateMusicalColors(i);this.metrics.oklabCoordinations++;let r=await t.processColors(e),a=await this.enhanceWithOKLAB(r.processedColors,n);return{...r,processedColors:a,metadata:{...r.metadata,oklabPreset:this.determineOKLABPreset(e),oklabCoordination:n}}}async selectOptimalStrategy(e){try{let i=this.deviceCapabilityDetector.getCapabilities(),n={performance:"medium",quality:"enhanced",deviceCapabilities:{hasWebGL:i?.gpu?.supportsWebGL||!0,memoryMB:i?.memory?.total||4096,isMobile:!1},userPreferences:{harmonicMode:"cosmic",intensity:.8,enableAdvancedBlending:!0},settingsContext:{dynamicAccentEnabled:!0,gradientIntensity:"medium",webglEnabled:i?.gpu?.supportsWebGL||!0,webglForceEnabled:!1,visualGuideMode:"enhanced",depthLayersEnabled:!0,consciousnessLevel:.8,breathingAnimationEnabled:!0},deviceContext:{supportsWebGL:i?.gpu?.supportsWebGL||!0,performanceLevel:"medium",memoryCapacity:i?.memory?.total||4096,isMobile:!1}},r=this.strategySelector.selectStrategies(e,n);if(r&&r.length>0&&r[0])return r[0]}catch(i){u?.debug?.warn("UnifiedColorProcessingEngine","Strategy selection failed, using fallback:",i)}return{getStrategyName:()=>"fallback",canProcess:i=>!0,getEstimatedProcessingTime:i=>50,processColors:async i=>({processedColors:i.rawColors,accentHex:"#cba6f7",accentRgb:"203,166,247",context:i,metadata:{strategy:"fallback",timestamp:Date.now(),processingTime:0}})}}addToQueue(e){this.processingState.queueSize>=this.MAX_QUEUE_SIZE&&this.processingState.processingQueue.shift(),this.processingState.processingQueue.push(e),this.processingState.queueSize=this.processingState.processingQueue.length}async processQueue(){for(;this.processingState.processingQueue.length>0&&!this.processingState.isProcessing;){let e=this.processingState.processingQueue.shift();this.processingState.queueSize=this.processingState.processingQueue.length,await this.processWithTimeout(e)}}async processWithTimeout(e){this.processingState.isProcessing=!0,this.processingState.lastProcessingTime=Date.now(),this.processingTimeout=window.setTimeout(()=>{u?.debug?.warn("UnifiedColorProcessingEngine","Processing timeout - forcing reset"),this.processingState.isProcessing=!1,this.metrics.errorCount++},this.PROCESSING_TIMEOUT_MS);try{await this.processColors(e),this.metrics.totalProcessed++}finally{this.processingTimeout&&(clearTimeout(this.processingTimeout),this.processingTimeout=null),this.processingState.isProcessing=!1,this.processingState.processingQueue.length>0&&setTimeout(()=>this.processQueue(),0)}}generateCacheKey(e){let t={colors:Object.keys(e.rawColors).sort().join(","),music:e.musicData?.energy||0};return JSON.stringify(t)}getCachedResult(e){let t=this.processingCache.get(e);return t&&Date.now()-t.timestamp<this.CACHE_TTL_MS?t:null}cacheResult(e,t){this.processingCache.set(e,{...t,timestamp:Date.now()})}cleanupCache(){let e=Date.now();for(let[t,i]of this.processingCache.entries())e-i.timestamp>this.CACHE_TTL_MS&&this.processingCache.delete(t)}updateMetrics(e,t){this.metrics.averageProcessingTime=(this.metrics.averageProcessingTime*this.metrics.totalProcessed+e)/(this.metrics.totalProcessed+1),t?this.metrics.successRate=(this.metrics.successRate*this.metrics.totalProcessed+1)/(this.metrics.totalProcessed+1):this.metrics.successRate=this.metrics.successRate*this.metrics.totalProcessed/(this.metrics.totalProcessed+1),this.metrics.lastProcessingTime=Date.now()}async enhanceWithOKLAB(e,t){let i={...e};return t.enhancedColors&&Object.entries(t.enhancedColors).forEach(([n,r])=>{i[`oklab-${n}`]=r}),i}classifyEmotionalState(e){return e>.8?"energetic":e>.6?"upbeat":e>.4?"moderate":e>.2?"calm":"peaceful"}determineOKLABPreset(e){let t=e.musicData?.energy||.5;return t>.8?"high-energy":t>.6?"dynamic":t>.4?"balanced":"ambient"}createFallbackResult(e,t){return{processedColors:{fallback:"#cba6f7"},accentHex:"#cba6f7",accentRgb:"203,166,247",context:e,metadata:{strategy:"fallback",error:t.message,timestamp:Date.now(),processingTime:0}}}registerDefaultStrategies(){}async handleSettingsChange(e){["catppuccin-flavor","catppuccin-accentColor","sn-dynamic-color-intensity"].includes(e.settingKey)&&(this.processingCache.clear(),u?.debug?.log("UnifiedColorProcessingEngine","Cache cleared due to settings change:",e.settingKey))}async handlePerformanceWarning(e){e.memoryUsage>50&&(this.processingCache.clear(),u?.debug?.log("UnifiedColorProcessingEngine","Cache cleared due to memory pressure"))}getMetrics(){return{...this.metrics}}async forceReprocessColors(){if(this.processingCache.clear(),this.processingState.lastExtractedColors){let e={rawColors:this.processingState.lastExtractedColors,trackUri:this.processingState.currentTrackUri||"",timestamp:Date.now()};await this.processColors(e)}}getProcessingState(){return{...this.processingState}}getStatus(){return{isProcessing:this.processingState.isProcessing,queueSize:this.processingState.queueSize}}setSelectionCriteria(e){u?.debug?.log("UnifiedColorProcessingEngine","Strategy selection criteria updated:",e)}},Sc=()=>{let c=globalThis.year3000System;return{settingsManager:c?.settingsManager,performanceAnalyzer:c?.performanceAnalyzer||c?.facadeCoordinator?.getCachedNonVisualSystem?.("PerformanceAnalyzer")}},{settingsManager:vc,performanceAnalyzer:Cc}=Sc(),Gh=new Pt(vc,Cc)});var Pi,Za=b(()=>{"use strict";Ae();ne();D();Pi=class c{constructor(e,t,i){this.initialized=!1;this.cardQuerySelector=".main-card-card, .main-gridContainer-gridContainer.main-gridContainer-fixedWidth";this.cardEventHandlers=new WeakMap;this.musicSyncService=null;this.currentQualityLevel=null;this.qualityCapabilities=[];this.effectCoordinationCallbacks=new Set;this.config={perspective:1e3,maxRotation:5,scale:1.02,transitionSpeed:"200ms",glowOpacity:.8,selector:".main-card-card, .main-grid-grid > *, .main-shelf-shelf > * > *",depthMultiplier:1.5,musicResponseStrength:.8,beatSyncIntensity:.6,effectIntensityMultiplier:1.2},this.performanceMonitor=e,this.settingsManager=t,this.utils=i,this.cards=document.querySelectorAll(this.config.selector),this.musicTemperatureMapper=new J(!0),this.oklabProcessor=new M(!0),this.effectPreset=M.getPreset("VIBRANT"),this.effectState={currentMusicMood:"neutral",musicIntensity:.5,beatPhase:0,lastBeatTime:0,effectIntensityLevel:0,dynamicAccentHex:"#cba6f7",dynamicAccentRgb:"203,166,247",overallIntensityLevel:.5},this.boundHandleSettingsChange=this.handleSettingsChange.bind(this)}static getInstance(e,t,i){return c.instance||(c.instance=new c(e,t,i)),c.instance}async initialize(){if(this.initialized)return;let e=this.performanceMonitor.shouldReduceQuality();this.cards=document.querySelectorAll(this.config.selector),await this.applyEventListeners(),await this.initializeMusicIntegration(),this.initializeCrossSystemCoordination(),document.addEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange),this.initialized=!0}async healthCheck(){let e=document.querySelectorAll(this.cardQuerySelector);return e.length>0?{healthy:!0,ok:!0,details:`Found ${e.length} cards to manage.`,issues:[],system:"Card3DManager"}:{healthy:!1,ok:!1,details:"No card elements found with the configured selector.",issues:["No card elements found with the configured selector."],system:"Card3DManager"}}updateAnimation(e){}apply3DMode(e){console.log(`[Card3DManager] Applying 3D mode: ${e}`),e==="disabled"?this.destroy():this.initialize()}get shouldEnable3DEffects(){let e=this.performanceMonitor.shouldReduceQuality(),t=this.settingsManager.get("sn-enable3dCards");return!e&&t!=="disabled"}async applyEventListeners(){this.cards.forEach(e=>{if(this.cardEventHandlers.has(e))return;let t=n=>this.handleMouseMove(e,n),i=()=>this.handleMouseLeave(e);this.cardEventHandlers.set(e,{move:t,leave:i}),e.addEventListener("mousemove",t),e.addEventListener("mouseleave",i)})}handleMouseMove(e,t){if(!this.shouldEnable3DEffects)return;let{clientX:i,clientY:n}=t,{top:r,left:a,width:s,height:o}=e.getBoundingClientRect(),l=i-a,m=n-r,d=this.config.maxRotation*(m-o/2)/(o/2),h=-this.config.maxRotation*(l-s/2)/(s/2);e.style.transform=`perspective(${this.config.perspective}px) rotateX(${d}deg) rotateY(${h}deg) scale3d(${this.config.scale}, ${this.config.scale}, ${this.config.scale})`,e.style.transition=`transform ${this.config.transitionSpeed} ease-out`,this.applyGlow(e,l,m,s,o)}handleMouseLeave(e){e.style.transform="perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)",e.style.transition="transform 600ms ease-in-out",this.removeGlow(e)}applyGlow(e,t,i,n,r){let a=e.querySelector(".card-glow");a||(a=document.createElement("div"),a.className="card-glow",e.appendChild(a));let{dynamicAccentRgb:s,musicIntensity:o,beatPhase:l,effectIntensityLevel:m}=this.effectState,d=this.config.glowOpacity,h=1+(o-.5)*this.config.musicResponseStrength,g=1+Math.sin(l)*this.config.beatSyncIntensity*.3,f=1+m*this.config.effectIntensityMultiplier*.4,v=d*h*g*f,C=Math.max(.1,Math.min(1,v)),E=40+Math.sin(l*.5)*8*this.config.beatSyncIntensity;a.style.background=`radial-gradient(circle at ${t}px ${i}px, 
      rgba(${s}, ${C}) 0%, 
      rgba(${s}, ${C*.6}) 20%, 
      transparent ${E}%)`}removeGlow(e){let t=e.querySelector(".card-glow");t&&(t.style.background="transparent")}destroy(){this.cards.forEach(e=>{let t=this.cardEventHandlers.get(e);t&&(e.removeEventListener("mousemove",t.move),e.removeEventListener("mouseleave",t.leave),this.cardEventHandlers.delete(e)),this.removeGlow(e),e.style.transform="",e.style.transition=""}),this.initialized=!1,document.removeEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange)}handleSettingsChange(e){let{key:t,value:i}=e.detail||{}}async initializeMusicIntegration(){try{p.subscribe("colors:extracted",e=>{this.onColorsExtracted(e)},"Card3DManager"),p.subscribe("colors:harmonized",e=>{this.onColorsHarmonized(e)},"Card3DManager"),p.subscribe("music:beat",e=>{this.onMusicBeat(e)},"Card3DManager"),p.subscribe("consciousness:dramatic-moment",e=>{this.onIntensityEvent(e)},"Card3DManager"),this.updateDynamicAccentColor(),console.log("[Card3DManager] \u2705 Year 3000 music integration initialized")}catch(e){console.error("[Card3DManager] Failed to initialize music integration:",e)}}onColorsExtracted(e){let{rawColors:t,musicData:i}=e;if(i){let n=this.musicTemperatureMapper.mapMusicToEmotionalTemperature(i);this.updateMusicState(n)}}onColorsHarmonized(e){let{processedColors:t,coordinationMetrics:i}=e;if(t.VIBRANT){let n=this.oklabProcessor.processColor(t.VIBRANT,this.effectPreset);this.effectState.dynamicAccentHex=n.enhancedHex,this.effectState.dynamicAccentRgb=`${n.enhancedRgb.r},${n.enhancedRgb.g},${n.enhancedRgb.b}`}i?.overallIntensityLevel!==void 0&&(this.effectState.overallIntensityLevel=i.overallIntensityLevel)}onMusicBeat(e){let{beat:t,intensity:i,timestamp:n}=e;this.effectState.beatPhase+=Math.PI*2*this.config.beatSyncIntensity,this.effectState.lastBeatTime=n||Date.now(),i>.7&&this.applyBeatSyncDepthPulse(i)}onIntensityEvent(e){let{intensity:t,type:i}=e;this.effectState.effectIntensityLevel=t,t>.8&&this.applyEnhancedDepthDistortion(t)}updateMusicState(e){switch(this.effectState.currentMusicMood=e.primaryEmotion,this.effectState.musicIntensity=e.intensity,e.primaryEmotion){case"energetic":case"aggressive":this.effectPreset=M.getPreset("COSMIC");break;case"calm":case"ambient":this.effectPreset=M.getPreset("SUBTLE");break;default:this.effectPreset=M.getPreset("VIBRANT")}}applyBeatSyncDepthPulse(e){let t=1+e*.15*this.config.beatSyncIntensity;this.cards.forEach(i=>{if(i instanceof HTMLElement){let r=(i.style.transform||"").replace(/scale3d\([^)]*\)/,`scale3d(${t}, ${t}, ${t})`);i.style.transform=r||`scale3d(${t}, ${t}, ${t})`,i.style.transition="transform 100ms ease-out",setTimeout(()=>{i.style.transform.includes(`scale3d(${t}`)&&(i.style.transform=i.style.transform.replace(/scale3d\([^)]*\)/,"scale3d(1, 1, 1)"))},200)}})}applyEnhancedDepthDistortion(e){let t=this.config.perspective*(1+e*this.config.effectIntensityMultiplier),i=this.config.maxRotation*(1+e*.8);this.cards.forEach(n=>{if(n instanceof HTMLElement){let r=`perspective(${t}px) rotateX(${i*.3}deg) rotateY(${i*.2}deg)`;n.style.transform=r,n.style.transition="transform 800ms ease-out",setTimeout(()=>{n.style.transform="perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)",n.style.transition="transform 1200ms ease-in-out"},1500)}})}updateDynamicAccentColor(){let e=document.documentElement,t=getComputedStyle(e),i=t.getPropertyValue("--sn-dynamic-accent-hex").trim()||t.getPropertyValue("--sn-color-accent-hex").trim()||t.getPropertyValue("--spice-accent").trim(),n=t.getPropertyValue("--sn-dynamic-accent-rgb").trim()||t.getPropertyValue("--sn-color-accent-rgb").trim()||t.getPropertyValue("--spice-rgb-accent").trim();i&&i!==""&&(this.effectState.dynamicAccentHex=i),n&&n!==""&&(this.effectState.dynamicAccentRgb=n)}setMusicSyncService(e){this.musicSyncService=e}getEffectState(){return{...this.effectState}}setQualityLevel(e){switch(this.currentQualityLevel=e,e){case"low":this.config.perspective=900,this.config.maxRotation=3,this.config.depthMultiplier=1.2,this.config.musicResponseStrength=.5,this.config.beatSyncIntensity=.4,this.config.effectIntensityMultiplier=.8;break;case"medium":this.config.perspective=1e3,this.config.maxRotation=5,this.config.depthMultiplier=1.5,this.config.musicResponseStrength=.8,this.config.beatSyncIntensity=.6,this.config.effectIntensityMultiplier=1.2;break;case"high":this.config.perspective=1200,this.config.maxRotation=7,this.config.depthMultiplier=1.8,this.config.musicResponseStrength=1,this.config.beatSyncIntensity=.8,this.config.effectIntensityMultiplier=1.5;break;default:this.config.perspective=1e3,this.config.maxRotation=5,this.config.depthMultiplier=1.5,this.config.musicResponseStrength=.8,this.config.beatSyncIntensity=.6,this.config.effectIntensityMultiplier=1.2;break}console.log(`[Card3DManager] Quality level set to: ${e}`)}adjustQuality(e){this.setQualityLevel(e)}getPerformanceImpact(){let e=this.cards.length,t=e*.1,i=this.config.depthMultiplier*.2,n=this.config.musicResponseStrength*.15,r=this.config.effectIntensityMultiplier*.1;return{fps:60,frameTime:t+i+n+r,memoryUsage:e*.05,cpuUsage:(t+i)*100}}reduceQuality(e){this.currentQualityLevel&&(this.config.depthMultiplier=Math.max(.5,this.config.depthMultiplier-e),this.config.musicResponseStrength=Math.max(.1,this.config.musicResponseStrength-e),this.config.beatSyncIntensity=Math.max(.1,this.config.beatSyncIntensity-e),this.config.effectIntensityMultiplier=Math.max(.5,this.config.effectIntensityMultiplier-e),console.log(`[Card3DManager] Quality reduced by ${e}`))}increaseQuality(e){this.currentQualityLevel&&(this.config.depthMultiplier=Math.min(2,this.config.depthMultiplier+e),this.config.musicResponseStrength=Math.min(1.5,this.config.musicResponseStrength+e),this.config.beatSyncIntensity=Math.min(1,this.config.beatSyncIntensity+e),this.config.effectIntensityMultiplier=Math.min(2,this.config.effectIntensityMultiplier+e),console.log(`[Card3DManager] Quality increased by ${e}`))}getQualityCapabilities(){return this.qualityCapabilities.length===0&&(this.qualityCapabilities=[{name:"3D Perspective",enabled:!0,qualityLevel:"medium"},{name:"Music-Reactive Glow",enabled:!0,qualityLevel:"low"},{name:"Beat Sync Effects",enabled:!0,qualityLevel:"low"},{name:"Intensity Distortion",enabled:!0,qualityLevel:"medium"},{name:"Music Modulation",enabled:!0,qualityLevel:"low"}]),this.qualityCapabilities}async refreshColorState(e){try{if(this.updateDynamicAccentColor(),this.effectState.dynamicAccentHex){let t=this.oklabProcessor.processColor(this.effectState.dynamicAccentHex,this.effectPreset);this.effectState.dynamicAccentHex=t.enhancedHex,this.effectState.dynamicAccentRgb=`${t.enhancedRgb.r},${t.enhancedRgb.g},${t.enhancedRgb.b}`}console.log(`[Card3DManager] Color state refreshed for trigger: ${e}`)}catch(t){console.error("[Card3DManager] Error refreshing color state:",t)}}onEffectCoordination(e){return this.effectCoordinationCallbacks.add(e),()=>{this.effectCoordinationCallbacks.delete(e)}}synchronizeEffectState(e){e.currentMusicMood&&(this.effectState.currentMusicMood=e.currentMusicMood),e.musicIntensity!==void 0&&(this.effectState.musicIntensity=e.musicIntensity),e.beatPhase!==void 0&&(this.effectState.beatPhase=e.beatPhase),e.effectIntensityLevel!==void 0&&(this.effectState.effectIntensityLevel=e.effectIntensityLevel),e.overallIntensityLevel!==void 0&&(this.effectState.overallIntensityLevel=e.overallIntensityLevel),e.dynamicAccentHex&&(this.effectState.dynamicAccentHex=e.dynamicAccentHex),e.dynamicAccentRgb&&(this.effectState.dynamicAccentRgb=e.dynamicAccentRgb),this.broadcastEffectState()}broadcastEffectState(){this.effectCoordinationCallbacks.forEach(e=>{try{e(this.effectState)}catch(t){console.error("[Card3DManager] Error in effect coordination callback:",t)}})}updateMusicStateWithCoordination(e){this.updateMusicState(e),this.broadcastEffectState(),p.emit("consciousness:coordination",{source:"Card3DManager",state:this.effectState,timestamp:Date.now()})}onMusicBeatWithCoordination(e){this.onMusicBeat(e),this.broadcastEffectState(),p.emit("consciousness:beat-sync",{source:"Card3DManager",beatPhase:this.effectState.beatPhase,lastBeatTime:this.effectState.lastBeatTime,timestamp:Date.now()})}onIntensityEventWithCoordination(e){this.onIntensityEvent(e),this.broadcastEffectState(),p.emit("consciousness:dramatic-sync",{source:"Card3DManager",dramaticLevel:this.effectState.effectIntensityLevel,type:e.type,timestamp:Date.now()})}initializeCrossSystemCoordination(){try{p.subscribe("consciousness:coordination",e=>{e.source!=="Card3DManager"&&this.synchronizeEffectState(e.state)},"Card3DManager"),p.subscribe("consciousness:beat-sync",e=>{e.source!=="Card3DManager"&&(this.effectState.beatPhase=e.beatPhase,this.effectState.lastBeatTime=e.lastBeatTime)},"Card3DManager"),p.subscribe("consciousness:dramatic-sync",e=>{e.source!=="Card3DManager"&&(this.effectState.effectIntensityLevel=e.dramaticLevel)},"Card3DManager"),console.log("[Card3DManager] \u2705 Cross-system effect coordination initialized")}catch(e){console.error("[Card3DManager] Failed to initialize cross-system coordination:",e)}}}});var Zn,Jn,Ja=b(()=>{"use strict";Zn=class c{constructor(){this.observers=new Map;this.trackedElements=new Map;this.isSupported=typeof IntersectionObserver<"u",this.isSupported||console.warn("[ViewportAwarenessManager] IntersectionObserver not supported, falling back to always-visible behavior")}static getInstance(){return c.instance||(c.instance=new c),c.instance}trackElement(e,t,i={}){if(!this.isSupported){let o={isVisible:!0,intersectionRatio:1,lastVisibilityChange:Date.now(),element:e};return t(o),()=>{}}let n={visibilityThreshold:.1,rootMargin:"50px",trackRootElement:!1,...i},r=this.getObserverKey(n),a=this.observers.get(r);a||(a=new IntersectionObserver(o=>this.handleIntersectionChanges(o),{threshold:n.visibilityThreshold,rootMargin:n.rootMargin,root:n.rootSelector?document.querySelector(n.rootSelector):null}),this.observers.set(r,a));let s={isVisible:!1,intersectionRatio:0,lastVisibilityChange:Date.now(),element:e};return this.trackedElements.set(e,{callback:t,options:n,state:s}),a.observe(e),()=>this.untrackElement(e)}isElementVisible(e){return this.trackedElements.get(e)?.state.isVisible??!0}getVisibilityState(e){return this.trackedElements.get(e)?.state??null}untrackElement(e){let t=this.trackedElements.get(e);if(!t)return;let i=this.getObserverKey(t.options),n=this.observers.get(i);n&&n.unobserve(e),this.trackedElements.delete(e)}trackSpotifyContainer(e){let t=[".Root__main-view",'[data-testid="topbar"]',".main-view-container","#main"],i=null;for(let n of t)if(i=document.querySelector(n),i)break;return i||(console.warn("[ViewportAwarenessManager] Could not find Spotify main container, using document.body"),i=document.body),this.trackElement(i,e,{visibilityThreshold:.1,rootMargin:"0px",trackRootElement:!0})}checkBulkVisibility(e){let t=new Map;for(let i of e)t.set(i,this.isElementVisible(i));return t}destroy(){for(let e of this.observers.values())e.disconnect();this.observers.clear(),this.trackedElements.clear()}handleIntersectionChanges(e){for(let t of e){let i=this.trackedElements.get(t.target);if(!i)continue;let n=i.state.isVisible,r=t.isIntersecting;if(i.state={isVisible:r,intersectionRatio:t.intersectionRatio,lastVisibilityChange:n!==r?Date.now():i.state.lastVisibilityChange,element:t.target},n!==r)try{i.callback(i.state)}catch(a){console.error("[ViewportAwarenessManager] Error in visibility callback:",a)}}}getObserverKey(e){return`${e.visibilityThreshold}-${e.rootMargin}-${e.rootSelector||"viewport"}`}},Jn=Zn.getInstance()});var Ti,es=b(()=>{"use strict";Ja();D();Ti=class{constructor(e={}){this.initialized=!1;this.isVisible=!0;this.visibilityState=null;this.animationsPaused=!1;this.settingsUpdatesPaused=!1;this.viewportOptions={visibilityThreshold:.1,rootMargin:"50px",pauseAnimationsWhenHidden:!0,pauseSettingsUpdatesWhenHidden:!0,resumeDelay:100,...e}}async initialize(){await this.initializeViewportTracking(),await this.initializeEventSubscriptions(),await this.initializeSystem(),this.initialized=!0}async healthCheck(){let e=await this.performHealthCheck();return{...e,details:`${e.details} | Viewport: ${this.isVisible?"visible":"hidden"}`}}updateAnimation(e){this.shouldSkipAnimationUpdate()||this.performAnimationUpdate(e)}destroy(){this.cleanupViewportTracking(),this.cleanupEventSubscriptions(),this.performDestroy()}handleSettingsChange(e){this.shouldSkipSettingsUpdate()||this.performSettingsUpdate(e)}forceRepaint(e){this.performForceRepaint?.(e)}onVisibilityChanged(e){}onBecomingVisible(){}onBecomingHidden(){}async initializeViewportTracking(){let e=null;this.viewportOptions.trackingSelector&&(e=document.querySelector(this.viewportOptions.trackingSelector)),e?this.untrackViewport=Jn.trackElement(e,t=>this.handleVisibilityChange(t),this.viewportOptions):this.untrackViewport=Jn.trackSpotifyContainer(t=>this.handleVisibilityChange(t))}async initializeEventSubscriptions(){this.settingsSubscriptionId=p.subscribe("settings:changed",e=>this.handleUnifiedSettingsChange(e),`ViewportAwareSystem-${this.constructor.name}`)}cleanupEventSubscriptions(){this.settingsSubscriptionId&&(p.unsubscribe(this.settingsSubscriptionId),delete this.settingsSubscriptionId)}handleUnifiedSettingsChange(e){if(this.shouldSkipSettingsUpdate())return;let t=new CustomEvent("year3000SystemSettingsChanged",{detail:{key:e.settingKey,value:e.newValue}});this.performSettingsUpdate(t)}handleVisibilityChange(e){let t=this.isVisible;this.isVisible=e.isVisible,this.visibilityState=e,!t&&this.isVisible?this.handleBecomingVisible():t&&!this.isVisible&&this.handleBecomingHidden(),this.onVisibilityChanged(e)}handleBecomingVisible(){this.resumeTimeoutId&&clearTimeout(this.resumeTimeoutId),this.resumeTimeoutId=window.setTimeout(()=>{this.animationsPaused=!1,this.settingsUpdatesPaused=!1,this.onBecomingVisible()},this.viewportOptions.resumeDelay||100)}handleBecomingHidden(){this.viewportOptions.pauseAnimationsWhenHidden&&(this.animationsPaused=!0),this.viewportOptions.pauseSettingsUpdatesWhenHidden&&(this.settingsUpdatesPaused=!0),this.onBecomingHidden()}shouldSkipAnimationUpdate(){return this.animationsPaused||!this.isVisible&&(this.viewportOptions.pauseAnimationsWhenHidden??!0)}shouldSkipSettingsUpdate(){return this.settingsUpdatesPaused||!this.isVisible&&(this.viewportOptions.pauseSettingsUpdatesWhenHidden??!0)}cleanupViewportTracking(){this.untrackViewport&&(this.untrackViewport(),delete this.untrackViewport),this.resumeTimeoutId&&(clearTimeout(this.resumeTimeoutId),delete this.resumeTimeoutId)}getVisibilityInfo(){return{isVisible:this.isVisible,animationsPaused:this.animationsPaused,settingsUpdatesPaused:this.settingsUpdatesPaused,...this.visibilityState?.intersectionRatio!==void 0&&{intersectionRatio:this.visibilityState.intersectionRatio}}}}});var xi,ts=b(()=>{"use strict";U();Xt();$();es();K();Ae();ne();D();xi=class c extends Ti{constructor(t=w,i=A,n=null,r=null,a,s={}){super({visibilityThreshold:.2,pauseAnimationsWhenHidden:!1,pauseSettingsUpdatesWhenHidden:!0,resumeDelay:50,...s});this.cssBatcher=null;this.performanceAnalyzer=null;this.observers=[];this.musicSyncService=null;this.currentQualityLevel=null;this.qualityCapabilities=[];this.effectCoordinationCallbacks=new Set;this.config=t,this.utils=i,this.cssBatcher=n,this.performanceAnalyzer=r,this.settingsManager=a,this.isSupported=this.detectBackdropFilterSupport(),this.currentIntensity="balanced",this.musicTemperatureMapper=new J(!0),this.oklabProcessor=new M(!0),this.effectPreset=M.getPreset("STANDARD"),this.effectState={currentMusicMood:"neutral",musicIntensity:.5,beatPhase:0,lastBeatTime:0,effectIntensityLevel:0,dynamicAccentHex:"#cba6f7",dynamicAccentRgb:"203,166,247",overallIntensityLevel:.5,genreStyle:"standard",animationRate:1}}static getInstance(){if(!c.instance)throw new Error("GlassmorphismManager instance not initialized");return c.instance}async initializeSystem(){let t=globalThis.year3000System;this.cssController=t?.cssConsciousnessController||T();let i=this.settingsManager.get("sn-glassmorphism-level");this.applyGlassmorphismSettings(i),await this.initializeMusicIntegration()}async performHealthCheck(){return{healthy:!0,ok:!0,details:"GlassmorphismManager is operational.",issues:[],system:"GlassmorphismManager"}}performAnimationUpdate(t){}performDestroy(){this.observers.forEach(t=>t.disconnect()),this.observers=[]}performSettingsUpdate(t){let i=t,{key:n,value:r}=i.detail||{};n===Kr&&(this.applyGlassmorphismSettings(r),this.updateGlassVariables(this.currentIntensity))}onBecomingVisible(){if(this.currentIntensity!=="disabled"){let t=document.documentElement,n=getComputedStyle(t).getPropertyValue("--spice-rgb-accent").trim();n&&n!==""&&this.updateGlassColors(`rgb(${n})`,`rgb(${n})`)}}onBecomingHidden(){}detectBackdropFilterSupport(){try{return CSS.supports("backdrop-filter","blur(1px)")||CSS.supports("-webkit-backdrop-filter","blur(1px)")}catch(t){return console.warn("StarryNight: CSS.supports not available, assuming no backdrop-filter support",t),!1}}applyGlassmorphismSettings(t){let i=document.body;i.classList.remove("sn-glass-disabled","sn-glass-minimal","sn-glass-balanced","sn-glass-intense"),i.classList.add(`sn-glass-${t}`),this.currentIntensity=t,this.updateGlassVariables(t)}updateGlassVariables(t){let i=document.documentElement,n=this.performanceAnalyzer?.shouldReduceQuality()||!1,r,a,s;switch(t){case"disabled":i.style.removeProperty("--glass-blur"),i.style.removeProperty("--glass-opacity"),i.style.removeProperty("--glass-saturation");return;case"minimal":r=n?"2px":"3px",a="0.05",s="1.05";break;case"moderate":r=n?"3px":"5px",a="0.08",s="1.15";break;case"intense":r=n?"6px":"8px",a="0.15",s="1.4";break;case"balanced":default:r=n?"4px":"6px",a="0.1",s="1.2";break}let o=this.calculateMusicModulations(),l=this.modulateBlurValue(r,o),m=this.modulateOpacityValue(a,o),d=this.modulateSaturationValue(s,o),h={"--glass-blur":l,"--glass-opacity":m,"--glass-saturation":d,"--glass-breathing-rate":`${this.effectState.animationRate}s`,"--glass-consciousness-level":this.effectState.overallIntensityLevel.toString()};this.cssController.batchSetVariables("GlassmorphismManager",h,"high","glass-properties-update")}updateGlassColors(t,i){if(this.currentIntensity==="disabled")return;let n=this.convertToGlassColor(t,.1),r=this.convertToGlassColor(i,.08),a={"--glass-background":n,"--glass-border":r};this.cssController.batchSetVariables("GlassmorphismManager",a,"high","glass-color-update")}convertToGlassColor(t,i){try{if(typeof t!="string")return this.getThemeAwareFallback(i);if(t.startsWith("rgb")){let n=t.match(/\d+/g);if(n&&n.length>=3)return`rgba(${n[0]}, ${n[1]}, ${n[2]}, ${i})`}if(t.startsWith("#")){let n=t.slice(1),r=parseInt(n.substring(0,2),16),a=parseInt(n.substring(2,4),16),s=parseInt(n.substring(4,6),16);if(!isNaN(r)&&!isNaN(a)&&!isNaN(s))return`rgba(${r}, ${a}, ${s}, ${i})`}return this.getThemeAwareFallback(i)}catch{return this.getThemeAwareFallback(i)}}getThemeAwareFallback(t){let i=document.documentElement,n=getComputedStyle(i);if(this.effectState.dynamicAccentRgb&&this.effectState.dynamicAccentRgb!=="203,166,247")return`rgba(${this.effectState.dynamicAccentRgb}, ${t})`;let r=n.getPropertyValue("--sn-dynamic-accent-rgb").trim()||n.getPropertyValue("--sn-color-accent-rgb").trim()||n.getPropertyValue("--spice-rgb-accent").trim();if(r&&r!==""&&!r.includes("undefined"))return`rgba(${r}, ${t})`;let a=n.getPropertyValue("--spice-rgb-text").trim();return a&&a!==""&&!a.includes("undefined")?`rgba(${a}, ${t})`:`rgba(203, 166, 247, ${t})`}async initializeMusicIntegration(){try{p.subscribe("colors:extracted",t=>{this.onColorsExtracted(t)},"GlassmorphismManager"),p.subscribe("colors:harmonized",t=>{this.onColorsHarmonized(t)},"GlassmorphismManager"),p.subscribe("music:beat",t=>{this.onMusicBeat(t)},"GlassmorphismManager"),p.subscribe("consciousness:dramatic-moment",t=>{this.onCinematicDramaEvent(t)},"GlassmorphismManager"),this.updateDynamicAccentColor(),this.initializeCrossSystemCoordination(),console.log("[GlassmorphismManager] \u2705 Year 3000 consciousness integration initialized")}catch(t){console.error("[GlassmorphismManager] Failed to initialize consciousness integration:",t)}}calculateMusicModulations(){let{musicIntensity:t,beatPhase:i,effectIntensityLevel:n,overallIntensityLevel:r}=this.effectState,a=1+(t-.5)*.4,s=1+Math.sin(i)*r*.15,o=1+n*.3,l=1+Math.sin(Date.now()*this.effectState.animationRate*.001)*.08;return{musicModulation:a,beatModulation:s,cinematicModulation:o,animationModulation:l}}modulateBlurValue(t,i){let n=parseFloat(t.replace("px","")),{musicModulation:r,beatModulation:a,animationModulation:s}=i,o=n*r*a*s;return`${Math.max(1,Math.round(o))}px`}modulateOpacityValue(t,i){let n=parseFloat(t),{musicModulation:r,cinematicModulation:a,animationModulation:s}=i,o=n*(1+(r-1)*.5)*a*s;return Math.max(.01,Math.min(1,o)).toFixed(3)}modulateSaturationValue(t,i){let n=parseFloat(t),{musicModulation:r,beatModulation:a,cinematicModulation:s}=i,o=n*r*a*s;return Math.max(1,Math.min(3,o)).toFixed(2)}onColorsExtracted(t){let{rawColors:i,musicData:n}=t;if(n){let r=this.musicTemperatureMapper.mapMusicToEmotionalTemperature(n);this.updateMusicState(r)}}onColorsHarmonized(t){let{processedColors:i,coordinationMetrics:n}=t;if(i.VIBRANT){let r=this.oklabProcessor.processColor(i.VIBRANT,this.effectPreset);this.effectState.dynamicAccentHex=r.enhancedHex,this.effectState.dynamicAccentRgb=`${r.enhancedRgb.r},${r.enhancedRgb.g},${r.enhancedRgb.b}`,this.updateGlassColors(r.enhancedHex,r.enhancedHex)}n?.overallIntensityLevel!==void 0&&(this.effectState.overallIntensityLevel=n.overallIntensityLevel)}onMusicBeat(t){let{beat:i,intensity:n,timestamp:r}=t;this.effectState.beatPhase+=Math.PI*2*.5,this.effectState.lastBeatTime=r||Date.now(),n>.8&&this.currentIntensity!=="disabled"&&this.applyBeatSyncGlassPulse(n)}onCinematicDramaEvent(t){let{intensity:i,type:n}=t;this.effectState.effectIntensityLevel=i,i>.7&&this.currentIntensity!=="disabled"&&this.applyDramaticGlassDistortion(i)}updateMusicState(t){switch(this.effectState.currentMusicMood=t.primaryEmotion,this.effectState.musicIntensity=t.intensity,t.primaryEmotion){case"energetic":case"aggressive":this.effectState.animationRate=1.5,this.effectPreset=M.getPreset("COSMIC");break;case"calm":case"ambient":this.effectState.animationRate=.7,this.effectPreset=M.getPreset("SUBTLE");break;default:this.effectState.animationRate=1,this.effectPreset=M.getPreset("STANDARD")}}applyBeatSyncGlassPulse(t){if(!this.cssBatcher||!!1)return;let n=this.getIntensityValue(this.currentIntensity),r=t*2*(n.opacity*10),a=t*.05*n.opacity;this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-blur",`${r}px`),this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-opacity",a.toString()),setTimeout(()=>{this.cssBatcher&&(this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-blur","0px"),this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-opacity","0"))},150)}applyDramaticGlassDistortion(t){if(!this.cssBatcher)return;let i=t*4,n=1+t*.5;this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-blur",`${i}px`),this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-saturation",n.toString()),setTimeout(()=>{this.cssBatcher&&(this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-blur","0px"),this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-saturation","1"))},1200)}updateDynamicAccentColor(){let t=document.documentElement,i=getComputedStyle(t),n=i.getPropertyValue("--sn-dynamic-accent-hex").trim()||i.getPropertyValue("--sn-color-accent-hex").trim()||i.getPropertyValue("--spice-accent").trim(),r=i.getPropertyValue("--sn-dynamic-accent-rgb").trim()||i.getPropertyValue("--sn-color-accent-rgb").trim()||i.getPropertyValue("--spice-rgb-accent").trim();n&&n!==""&&(this.effectState.dynamicAccentHex=n),r&&r!==""&&(this.effectState.dynamicAccentRgb=r)}getConsciousnessState(){return{...this.effectState}}setQualityLevel(t){this.adjustQuality(t)}adjustQuality(t){this.currentQualityLevel=t;let i;switch(t){case"low":i="minimal";break;case"medium":i="balanced";break;case"high":i="intense";break;default:i="balanced";break}this.applyGlassmorphismSettings(i),console.log(`[GlassmorphismManager] Quality level set to: ${t} (intensity: ${i})`)}getPerformanceImpact(){let t=this.currentIntensity==="disabled"?0:this.currentIntensity==="minimal"?.1:this.currentIntensity==="balanced"?.3:this.currentIntensity==="intense"?.5:.2,i=this.effectState.overallIntensityLevel*.1,n=this.effectState.animationRate>1?.05:0;return{fps:60,frameTime:t+i+n,memoryUsage:t*2,cpuUsage:(t+i)*50}}reduceQuality(t){if(this.currentQualityLevel){if(this.effectState.overallIntensityLevel=Math.max(.1,this.effectState.overallIntensityLevel-t),this.effectState.animationRate=Math.max(.5,this.effectState.animationRate-t*.5),t>.5)switch(this.currentIntensity){case"intense":this.applyGlassmorphismSettings("balanced");break;case"balanced":this.applyGlassmorphismSettings("minimal");break;case"minimal":this.applyGlassmorphismSettings("disabled");break}console.log(`[GlassmorphismManager] Quality reduced by ${t}`)}}increaseQuality(t){if(this.currentQualityLevel){if(this.effectState.overallIntensityLevel=Math.min(1,this.effectState.overallIntensityLevel+t),this.effectState.animationRate=Math.min(2,this.effectState.animationRate+t*.5),t>.5)switch(this.currentIntensity){case"disabled":this.applyGlassmorphismSettings("minimal");break;case"minimal":this.applyGlassmorphismSettings("balanced");break;case"balanced":this.applyGlassmorphismSettings("intense");break}console.log(`[GlassmorphismManager] Quality increased by ${t}`)}}getQualityCapabilities(){return this.qualityCapabilities.length===0&&(this.qualityCapabilities=[{name:"Backdrop Filter Blur",enabled:this.isSupported&&this.currentIntensity!=="disabled",qualityLevel:"high"},{name:"Glass Saturation",enabled:this.currentIntensity!=="disabled",qualityLevel:"low"},{name:"Consciousness Breathing",enabled:!0,qualityLevel:"low"},{name:"Beat Sync Pulse",enabled:!0,qualityLevel:"low"},{name:"Dramatic Distortion",enabled:!0,qualityLevel:"medium"}]),this.qualityCapabilities}async refreshColorState(t){try{if(this.updateDynamicAccentColor(),this.effectState.dynamicAccentHex){let i=this.oklabProcessor.processColor(this.effectState.dynamicAccentHex,this.effectPreset);this.effectState.dynamicAccentHex=i.enhancedHex,this.effectState.dynamicAccentRgb=`${i.enhancedRgb.r},${i.enhancedRgb.g},${i.enhancedRgb.b}`,this.updateGlassColors(i.enhancedHex,i.enhancedHex)}console.log(`[GlassmorphismManager] Color state refreshed for trigger: ${t}`)}catch(i){console.error("[GlassmorphismManager] Error refreshing color state:",i)}}onConsciousnessCoordination(t){return this.effectCoordinationCallbacks.add(t),()=>{this.effectCoordinationCallbacks.delete(t)}}synchronizeConsciousnessState(t){t.currentMusicMood&&(this.effectState.currentMusicMood=t.currentMusicMood),t.musicIntensity!==void 0&&(this.effectState.musicIntensity=t.musicIntensity),t.beatPhase!==void 0&&(this.effectState.beatPhase=t.beatPhase),t.effectIntensityLevel!==void 0&&(this.effectState.effectIntensityLevel=t.effectIntensityLevel),t.overallIntensityLevel!==void 0&&(this.effectState.overallIntensityLevel=t.overallIntensityLevel),t.dynamicAccentHex&&(this.effectState.dynamicAccentHex=t.dynamicAccentHex),t.dynamicAccentRgb&&(this.effectState.dynamicAccentRgb=t.dynamicAccentRgb),t.genreStyle&&(this.effectState.genreStyle=t.genreStyle),t.animationRate!==void 0&&(this.effectState.animationRate=t.animationRate),this.updateGlassVariables(this.currentIntensity),this.broadcastConsciousnessState()}broadcastConsciousnessState(){this.effectCoordinationCallbacks.forEach(t=>{try{t(this.effectState)}catch(i){console.error("[GlassmorphismManager] Error in consciousness coordination callback:",i)}})}updateMusicStateWithCoordination(t){this.updateMusicState(t),this.broadcastConsciousnessState(),p.emit("consciousness:coordination",{source:"GlassmorphismManager",state:this.effectState,timestamp:Date.now()})}onMusicBeatWithCoordination(t){this.onMusicBeat(t),this.broadcastConsciousnessState(),p.subscribe("consciousness:beat-sync",i=>{i.source!=="GlassmorphismManager"&&(this.effectState.beatPhase=i.beatPhase,this.effectState.lastBeatTime=i.lastBeatTime)},"GlassmorphismManager")}onCinematicDramaEventWithCoordination(t){this.onCinematicDramaEvent(t),this.broadcastConsciousnessState(),p.subscribe("consciousness:dramatic-sync",i=>{i.source!=="GlassmorphismManager"&&(this.effectState.effectIntensityLevel=i.dramaticLevel,i.dramaticLevel>.7&&this.applyDramaticGlassDistortion(i.dramaticLevel))},"GlassmorphismManager")}initializeCrossSystemCoordination(){try{p.subscribe("consciousness:coordination",t=>{t.source!=="GlassmorphismManager"&&this.synchronizeConsciousnessState(t.state)},"GlassmorphismManager"),p.subscribe("consciousness:beat-sync",t=>{t.source!=="GlassmorphismManager"&&(this.effectState.beatPhase=t.beatPhase,this.effectState.lastBeatTime=t.lastBeatTime,this.applyCoordinatedBeatPulse(t.beatPhase))},"GlassmorphismManager"),p.subscribe("consciousness:dramatic-sync",t=>{t.source!=="GlassmorphismManager"&&(this.effectState.effectIntensityLevel=t.dramaticLevel,this.applyCoordinatedDramaticEffects(t.dramaticLevel,t.type||"unknown"))},"GlassmorphismManager"),console.log("[GlassmorphismManager] \u2705 Cross-system consciousness coordination initialized")}catch(t){console.error("[GlassmorphismManager] Failed to initialize cross-system coordination:",t)}}checkPerformanceAndAdjust(){this.performanceAnalyzer?.shouldReduceQuality()&&(this.currentIntensity==="intense"?this.applyGlassmorphismSettings("balanced"):(this.currentIntensity==="balanced"||this.currentIntensity==="moderate")&&this.applyGlassmorphismSettings("minimal"))}applyGlassmorphism(t){let i=this.config.glassmorphism[t];this.cssBatcher&&(this.cssBatcher.queueCSSVariableUpdate("--sn-glass-display",t==="disabled"?"none":"block"),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-blur",`${i.blur}px`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-saturation",`${i.saturation}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-brightness",`${i.brightness}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-noise-opacity",`${i.noiseOpacity}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-border-opacity",`${i.borderOpacity}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-shadow-opacity",`${i.shadowOpacity}`),this.cssBatcher.flushCSSVariableBatch(),this.config.enableDebug&&console.log(`\u{1F48E} [GlassmorphismManager] Applied level: ${t}`))}applyUpdatedSettings(t,i){t==="sn-glassmorphism-level"&&(this.applyGlassmorphismSettings(i),this.updateGlassVariables(this.currentIntensity))}applyCoordinatedBeatPulse(t){let i=this.calculateMusicModulations(),n=this.getIntensityValue(this.currentIntensity),r=1+Math.sin(t)*.15*i.beatModulation,a=n.opacity*r;this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-opacity",a.toString()),this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-accent-opacity",(a*.8).toString()),this.cssBatcher?.flushCSSVariableBatch()}applyCoordinatedDramaticEffects(t,i){let n=this.calculateMusicModulations(),r=this.getIntensityValue(this.currentIntensity),a=1+t*.4,s=Math.min(1,r.opacity*a),o=Math.min(20,r.blur*(1+t*.3));this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-opacity",s.toString()),this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-blur",`${o}px`),this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-accent-opacity",(s*.9).toString()),this.cssBatcher?.flushCSSVariableBatch(),setTimeout(()=>{this.updateGlassVariables(this.currentIntensity)},1500)}getIntensityValue(t){switch(t){case"disabled":return{opacity:0,blur:0,saturation:1};case"minimal":return{opacity:.05,blur:3,saturation:1.05};case"balanced":return{opacity:.1,blur:6,saturation:1.2};case"intense":return{opacity:.15,blur:8,saturation:1.4};case"moderate":return{opacity:.08,blur:5,saturation:1.15};default:return{opacity:.1,blur:6,saturation:1.2}}}}});var Ve,Ai=b(()=>{"use strict";$();D();Yn();Xn();U();Ve=class{constructor(e=w){this.initialized=!1;this.destroyed=!1;this.eventUnsubscribers=[];this.initializationStartTime=null;this.frameStartTime=0;this.frameCount=0;this.lastFPSCalculation=0;this.currentFPS=60;this.config=e,this.systemName=this.constructor.name,this.config.enableDebug&&console.log(`[${this.systemName}] UnifiedSystemBase constructor`)}async _baseInitialize(){if(this.initialized){this.config.enableDebug&&console.warn(`[${this.systemName}] Already initialized`);return}try{this.initializationStartTime=performance.now(),this.config.enableDebug&&console.log(`[${this.systemName}] Starting unified initialization`);let e=globalThis.year3000System;if(e?(this.performanceAnalyzer=e.performanceAnalyzer||e.facadeCoordinator?.getCachedNonVisualSystem?.("SimplePerformanceCoordinator")||e.facadeCoordinator?.getCachedNonVisualSystem?.("PerformanceAnalyzer"),this.cssConsciousnessController=e.cssConsciousnessController||T(),this.eventBus=p,this.performanceCoordinator=e.performanceCoordinator||(this.performanceAnalyzer?Xe.getInstance(this.config,this.performanceAnalyzer):null),this.animationCoordinator=e.enhancedMasterAnimationCoordinator||(this.performanceCoordinator?Fe.getInstance(this.config,this.performanceCoordinator):null),this.unifiedCSSManager=e.unifiedCSSManager||T()):(this.cssConsciousnessController=T(),this.eventBus=p,this.performanceCoordinator=Xe.getInstance(this.config,this.performanceAnalyzer),this.animationCoordinator=Fe.getInstance(this.config,this.performanceCoordinator),this.unifiedCSSManager=T()),this.unifiedCSSManager&&this.performanceAnalyzer&&this.cssConsciousnessController,this.performanceAnalyzer&&typeof this.performanceAnalyzer.recordMetric=="function"&&this.performanceAnalyzer.recordMetric(`${this.systemName}_registered`,1),await this.trackPerformanceAsync("initialize",async()=>{await this._performSystemSpecificInitialization()}),this.initialized=!0,this.publishEvent("system:initialized",{systemName:this.systemName,timestamp:Date.now(),metadata:{initializationTime:this.initializationStartTime?performance.now()-this.initializationStartTime:0}}),this.config.enableDebug){let t=this.initializationStartTime?performance.now()-this.initializationStartTime:0;console.log(`[${this.systemName}] Unified initialization complete (${t.toFixed(2)}ms)`)}}catch(e){throw console.error(`[${this.systemName}] Initialization failed:`,e),this.publishEvent("system:initialization-failed",{systemName:this.systemName,error:e instanceof Error?e.message:String(e),timestamp:Date.now()}),e}}_baseDestroy(){if(this.destroyed){this.config.enableDebug&&console.warn(`[${this.systemName}] Already destroyed`);return}try{this.config.enableDebug&&console.log(`[${this.systemName}] Starting unified destruction`),this.eventUnsubscribers.forEach(e=>{try{e()}catch(t){console.warn(`[${this.systemName}] Error during event unsubscription:`,t)}}),this.eventUnsubscribers=[],this.performanceAnalyzer&&typeof this.performanceAnalyzer.recordMetric=="function"&&this.performanceAnalyzer.recordMetric(`${this.systemName}_unregistered`,1),this.destroy(),this.destroyed=!0,this.publishEvent("system:destroyed",{systemName:this.systemName,timestamp:Date.now()}),this.config.enableDebug&&console.log(`[${this.systemName}] Unified destruction complete`)}catch(e){console.error(`[${this.systemName}] Destruction failed:`,e)}}updateCSSVariable(e,t,i="normal"){this.unifiedCSSManager?this.unifiedCSSManager.queueUpdate(e,t,i,this.systemName):this.cssConsciousnessController?this.cssConsciousnessController.queueCSSVariableUpdate(e,t):console.warn(`[${this.systemName}] CSS variable management not initialized`)}updateCSSVariables(e,t="normal"){this.unifiedCSSManager?this.unifiedCSSManager.queueTransaction(e,t,this.systemName):this.cssConsciousnessController?Object.entries(e).forEach(([i,n])=>{this.cssConsciousnessController.queueCSSVariableUpdate(i,n)}):console.warn(`[${this.systemName}] CSS variable management not initialized`)}subscribeToEvent(e,t){if(!this.eventBus){console.warn(`[${this.systemName}] Event bus not initialized - attempting to initialize`);try{if(this.eventBus=p,!this.eventBus)return console.error(`[${this.systemName}] Failed to get unified event bus - event subscription deferred`),()=>{}}catch(i){return console.error(`[${this.systemName}] Error accessing unified event bus:`,i),()=>{}}}try{let i=this.eventBus.subscribe(e,t,this.systemName),n=()=>{this.eventBus.unsubscribe(i)};return this.eventUnsubscribers.push(n),n}catch(i){return console.error(`[${this.systemName}] Failed to subscribe to event ${e}:`,i),()=>{}}}publishEvent(e,t){if(!this.eventBus){console.warn(`[${this.systemName}] Event bus not initialized - attempting to initialize`);try{if(this.eventBus=p,!this.eventBus){console.error(`[${this.systemName}] Failed to get unified event bus - event publication skipped`);return}}catch(i){console.error(`[${this.systemName}] Error accessing unified event bus:`,i);return}}try{this.eventBus.emitSync(e,t)}catch(i){console.error(`[${this.systemName}] Failed to publish event ${e}:`,i)}}trackPerformance(e,t){let i=performance.now();try{t()}finally{let r=performance.now()-i;this.trackSystemPerformance(r),this.performanceAnalyzer&&typeof this.performanceAnalyzer.timeOperation=="function"&&this.performanceAnalyzer.recordMetric(`${this.systemName}_${e}`,r)}}async trackPerformanceAsync(e,t){if(!this.performanceAnalyzer||typeof this.performanceAnalyzer.timeOperationAsync!="function"){await t();return}await this.performanceAnalyzer.timeOperationAsync(`${this.systemName}_${e}`,t)}trackSystemPerformance(e){if(!this.performanceCoordinator)return;this.frameCount++;let t=performance.now();t-this.lastFPSCalculation>=1e3&&(this.currentFPS=this.frameCount,this.frameCount=0,this.lastFPSCalculation=t);let i=performance.memory?.usedJSHeapSize||0;this.performanceCoordinator.trackSubsystem(this.systemName,{frameTime:e,memoryUsage:i,fps:this.currentFPS,cpuUsage:e>16.67?Math.min(100,e/16.67*5):0})}registerAnimation(e=60){if(!this.animationCoordinator){console.warn(`[${this.systemName}] Animation coordinator not initialized, attempting lazy initialization`);try{this.animationCoordinator=Fe.getInstance(this.config,this.performanceCoordinator)}catch(t){console.error(`[${this.systemName}] Failed to initialize animation coordinator:`,t);return}}try{this.animationCoordinator.registerAnimationSystem(this.systemName,this,"normal",e),this.config.enableDebug&&console.log(`[${this.systemName}] Successfully registered with animation coordinator`)}catch(t){console.error(`[${this.systemName}] Failed to register with animation coordinator:`,t)}}forceRepaint(e){this.config.enableDebug&&console.log(`[${this.systemName}] Force repaint: ${e||"unknown"}`),this.unifiedCSSManager&&this.unifiedCSSManager.forceFlush(),document.documentElement.style.transform="translateZ(0)",requestAnimationFrame(()=>{document.documentElement.style.transform=""})}get isInitialized(){return this.initialized}get isDestroyed(){return this.destroyed}get name(){return this.systemName}get systemConfig(){return this.config}registerCSSVariableGroup(e,t="normal"){this.unifiedCSSManager&&this.unifiedCSSManager.registerVariableGroup(`${this.systemName}-${e}`,t)}updateCSSVariableGroup(e,t){this.unifiedCSSManager?this.unifiedCSSManager.updateVariableGroup(`${this.systemName}-${e}`,t,this.systemName):this.updateCSSVariables(t)}updateAnimation(e){this.onAnimate(e)}async _performSystemSpecificInitialization(){}_performSystemSpecificCleanup(){this.destroy()}}});function He(c,e={}){if(!Mc)return Array.from(document.querySelectorAll(c));let t=er.get(c),i=t?.ref?.deref();return(e.force||!i)&&(i=Array.from(document.querySelectorAll(c)),t={ref:new WeakRef(i),lastUpdate:Date.now()},er.set(c,t),Ec?.register(i,c)),i}var er,Mc,wc,Ec,is=b(()=>{"use strict";er=new Map,Mc=typeof WeakRef<"u",wc=typeof FinalizationRegistry<"u",Ec=wc?new FinalizationRegistry(c=>{er.delete(c)}):null});function xt(c){return He(c).length>0}function Tc(c,e,t){let i=He(c,t);return i.length===0&&e&&(i=He(e,t),i.length>0&&console.warn(`\u{1F30C} [SpotifyDOMSelectors] Using legacy selector: ${e}. Consider updating to: ${c}`)),i}function xc(){console.group("\u{1F30C} [SpotifyDOMSelectors] DOM Validation");let c={found:0,missing:0,details:{}};return Object.entries(k).forEach(([e,t])=>{let i=xt(t);c.details[e]={selector:t,exists:i,element:i&&He(t)[0]||null},i?(c.found++,console.log(`\u2705 ${e}: ${t}`)):(c.missing++,console.warn(`\u274C ${e}: ${t}`))}),console.log(`\u{1F4CA} Summary: ${c.found} found, ${c.missing} missing`),console.groupEnd(),c}function Ac(){console.group("\u{1F30C} [Phase 1] Testing Gravity System Selectors"),console.log("\u{1F3AF} Primary gravity well targets:"),Tt.primary&&Tt.primary.forEach(c=>{let e=He(c)[0]||null;console.log(`${e?"\u2705":"\u274C"} ${c}`,e)}),console.log("\u{1F3AF} Secondary gravity well targets:"),Tt.secondary&&Tt.secondary.forEach(c=>{let e=He(c)[0]||null;console.log(`${e?"\u2705":"\u274C"} ${c}`,e)}),console.log("\u{1F6F8} Orbital elements:"),Object.entries(ze).forEach(([c,e])=>{let t=He(e);console.log(`${t.length>0?"\u2705":"\u274C"} ${c} (${e}): ${t.length} found`)}),console.groupEnd()}function ns(){console.group("\u{1F52E} [SpotifyDOMSelectors] Phase 2 - Prediction Target Validation");let c=[{name:"Track Rows",selector:ze.trackRows},{name:"Progress Bar",selector:k.progressBar},{name:"Play Button",selector:k.playButton},{name:"Heart Button",selector:k.heartButton},{name:"Album Cover",selector:k.albumCover},{name:"Now Playing Widget",selector:k.nowPlayingWidget},{name:"Now Playing Left",selector:k.nowPlayingLeft},{name:"Left Sidebar",selector:k.leftSidebar},{name:"Library Items",selector:ze.libraryItems}],e={found:0,missing:0,details:{}};return c.forEach(({name:t,selector:i})=>{if(!i)return;let r=Tc(i).length;e.details[t]={selector:i,count:r,exists:r>0},r>0?(e.found++,console.log(`\u2705 ${t}: ${r} elements found (${i})`)):(e.missing++,console.warn(`\u274C ${t}: No elements found (${i})`))}),console.log(`\u{1F4CA} Prediction Targets Summary: ${e.found} types found, ${e.missing} missing`),console.groupEnd(),e}function Ic(){console.group("\u{1F30C} [SpotifyDOMSelectors] Phase 2 - System Integration Test");let c={behavioralPrediction:ns(),dimensionalNexus:{sidebarElement:k.leftSidebar?xt(k.leftSidebar):!1},dataGlyph:{navLinks:k.navBarLink?xt(k.navBarLink):!1,trackRows:ze.trackRows?xt(ze.trackRows):!1,cards:ze.cards?xt(ze.cards):!1}},e=0;return Object.values(c).forEach(t=>{typeof t=="object"&&t.missing&&(e+=t.missing)}),console.log(`\u{1F3AF} Phase 2 Integration Health: ${e===0?"\u2705 All systems operational":`\u26A0\uFE0F ${e} issues detected`}`),console.groupEnd(),c}var k,ug,ze,Tt,Pc,tr=b(()=>{"use strict";is();k={nowPlayingBar:".Root__now-playing-bar",leftSidebar:".Root__nav-bar",mainView:".Root__main-view",rightSidebar:".Root__right-sidebar",nowPlayingWidget:"[data-testid='now-playing-widget']",nowPlayingLeft:".main-nowPlayingBar-left",nowPlayingCenter:".main-nowPlayingBar-center",nowPlayingRight:".main-nowPlayingBar-right",coverArt:".main-coverSlotCollapsed-container",trackInfo:".main-trackInfo-container",navMain:"nav[aria-label='Main']",yourLibrary:".main-yourLibraryX-libraryContainer",libraryItems:".main-yourLibraryX-listItem",libraryHeader:".main-yourLibraryX-header",playlistList:".main-rootlist-wrapper",trackListContainer:"[role='grid'][aria-label*='tracks']",trackRow:".main-trackList-trackListRow",trackListHeader:".main-trackList-trackListHeaderRow",trackNumber:".main-trackList-rowSectionIndex",trackTitle:".main-trackList-rowTitle",trackArtist:".main-trackList-rowSubTitle",entityHeader:".main-entityHeader-container",entityTitle:".main-entityHeader-title",entityMetadata:".main-entityHeader-metaData",entityImage:".main-entityHeader-imageContainer",actionBar:".main-actionBar-ActionBarRow",actionBarInner:".main-actionBar-ActionBar",playButton:"[data-testid='play-button']",pauseButton:"[data-testid='pause-button']",shuffleButton:"[data-testid='shuffle-button']",likeButton:".control-button-heart",queue:".main-queue-trackList",queueContainer:"[aria-label='Next in queue']",aboutArtist:"[aria-label='About the artist']",credits:"[aria-label='Credits']",searchInput:"[data-testid='search-input']",searchPage:"[data-testid='search-container']",filterPills:".main-genre-chip",sortButton:"[data-testid='sort-button']",card:".main-card-card",cardImage:".main-cardImage-image",albumArt:".main-trackList-albumArt",modal:".main-modal-container",overlay:".main-overlay-container"},ug=Object.entries({".main-nowPlayingWidget-nowPlaying":k.nowPlayingBar,".main-navBar-navBar":k.leftSidebar,".main-search-searchBar":k.searchInput,".main-topBar-topBar":k.actionBar,".main-queue-queue":k.queue,".main-trackList-trackList":k.trackListContainer}).reduce((c,[e,t])=>(typeof t=="string"&&(c[e]=t),c),{}),ze={trackRows:k.trackRow??"",libraryItems:k.libraryItems??"",cards:k.card??"",navLinks:".main-navBar-navBarLink"},Tt={primary:[k.nowPlayingBar,k.leftSidebar,k.entityHeader].filter(c=>!!c),secondary:[k.actionBar,k.queue,k.searchInput].filter(c=>!!c),tertiary:[k.playButton,k.trackListHeader].filter(c=>!!c)},Pc={searchAreas:[k.searchInput,k.searchPage].filter(c=>!!c),notifications:["[data-testid='notification-bar']",".main-topBar-notifications"],dropdowns:[".main-dropdown-menu","[role='menu']","[role='listbox']"]};typeof window<"u"&&(window.SpotifyDOMSelectors={validate:xc,testGravity:Ac,validatePredictionTargets:ns,testPhase2Systems:Ic,selectors:k,targets:Tt,orbital:ze,antiGravity:Pc},console.log("\u{1F3AF} [SpotifyDOMSelectors] Debug functions available:"),console.log("  window.SpotifyDOMSelectors.validate() - Test all selectors"),console.log("  window.SpotifyDOMSelectors.testGravity() - Test gravity selectors"))});var rs={};ie(rs,{SidebarPerformanceCoordinator:()=>ut,getSidebarPerformanceCoordinator:()=>Rc});function Rc(c){return ut.getInstance(c)}var Pe,ut,ir=b(()=>{"use strict";$();Mi();tr();D();Pe=class Pe{constructor(e={}){this.pendingUpdates=new Map;this.isFlushScheduled=!1;this.rafId=null;this.performanceAnalyzer=null;this.harmonicVariableMap=new Map([["--sn-rs-beat-intensity","--sn-beat-pulse-intensity"],["--sn-rs-glow-alpha","--sn-rhythm-phase"],["--sn-rs-hue-shift","--sn-spectrum-phase"]]);this.flushCount=0;this.totalFlushTime=0;this.lastFlushTimestamp=0;this.budgetManager=null;this.domObserver=null;this.sidebarElement=null;this.visibilityObserver=null;this.observationThrottleTimer=null;this.lastObservationTime=0;this.OBSERVATION_THROTTLE_MS=200;this.isFirstOpen=!0;this.lastScrollUpdate=0;this.activeTimeouts=new Set;this.domObservationRetryTimeout=null;this.musicChangeUnsubscribe=null;this.config={enableDebug:e.enableDebug??!1,maxBatchSize:e.maxBatchSize??50,...e},this.performanceAnalyzer=e.performanceAnalyzer||null;let t=globalThis.year3000System;this.cssController=t?.cssConsciousnessController||T(),this.performanceAnalyzer&&(this.budgetManager=Ee.getInstance(void 0,this.performanceAnalyzer)),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] Initialized with RAF-based batching")}static getInstance(e){return Pe.instance||(Pe.instance=new Pe(e)),Pe.instance}queueUpdate(e,t){if(["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift"].includes(e)){this.applyCriticalUpdate(e,t);return}try{T().queueCSSVariableUpdate(e,t,this.getSidebarElement())}catch{this.pendingUpdates.set(e,{property:e,value:t,timestamp:performance.now()}),this.config.enableDebug&&this.pendingUpdates.size===1&&console.log(`\u{1F30C} [SidebarPerformanceCoordinator] Queuing first update (fallback): ${e}`),this.scheduleFlush()}}applyCriticalUpdate(e,t){try{this.cssController.queueCSSVariableUpdate(e,t,null,"critical","sidebar-critical-update")}catch(i){console.error(`\u{1F30C} [SidebarPerformanceCoordinator] Failed to apply critical ${e}:`,i)}}getSidebarElement(){return this.sidebarElement||(this.sidebarElement=document.querySelector(k.rightSidebar)),this.sidebarElement||document.documentElement}scheduleFlush(){this.isFlushScheduled||(this.isFlushScheduled=!0,this.rafId=requestAnimationFrame(()=>{this.flushUpdates()}))}flushUpdates(){if(this.pendingUpdates.size===0){this.isFlushScheduled=!1;return}let e=performance.now(),t=this.getSidebarElement(),i=this.pendingUpdates.size;this.config.enableDebug&&console.log(`\u{1F30C} [SidebarPerformanceCoordinator] Flushing ${i} updates atomically`),i>(this.config.maxBatchSize||50)&&console.warn(`\u{1F30C} [SidebarPerformanceCoordinator] Large batch detected (${i} updates), may impact performance`);try{let s={},o={};for(let l of this.pendingUpdates.values()){s[l.property]=l.value;let m=this.harmonicVariableMap.get(l.property);m&&(o[m]=l.value,this.config.enableDebug&&console.log(`\u{1F30C} [SidebarPerformanceCoordinator] Mapped ${l.property} \u2192 ${m} = ${l.value}`))}if(Object.keys(s).length>0){let l=t;for(let[m,d]of Object.entries(s))l.style.setProperty(m,d)}Object.keys(o).length>0&&this.cssController.batchSetVariables("SidebarPerformanceCoordinator",o,"high","harmonic-variable-mapping")}catch(s){console.error("\u{1F30C} [SidebarPerformanceCoordinator] Failed to apply batched updates:",s)}if(this.pendingUpdates.clear(),this.isFlushScheduled=!1,this.rafId=null,this.config.onFlushComplete)try{this.config.onFlushComplete()}catch(s){console.error("\u{1F30C} [SidebarPerformanceCoordinator] Error in flush completion callback:",s)}let n=performance.now(),r=n-e;this.flushCount++,this.totalFlushTime+=r,this.lastFlushTimestamp=n,this.performanceAnalyzer&&this.performanceAnalyzer.emitTrace?.(`[SidebarPerformanceCoordinator] Flushed ${i} updates in ${r.toFixed(2)}ms`);let a=this.flushCount>0?this.totalFlushTime/this.flushCount:0;a>3&&console.warn(`\u{1F30C} [SidebarPerformanceCoordinator] Performance threshold exceeded: average ${a.toFixed(2)}ms per flush (target: <3ms)`),this.config.enableDebug&&r>4&&console.warn(`\u{1F30C} [SidebarPerformanceCoordinator] Slow flush detected: ${r.toFixed(2)}ms for ${i} updates`)}setupMusicChangeCoordination(){this.musicChangeUnsubscribe||(this.musicChangeUnsubscribe=()=>{p.unsubscribeAll("SidebarPerformanceCoordinator")},p.subscribe("music:track-changed",e=>{this.handleMusicChange({timestamp:e.timestamp,source:"track-changed",reason:"music:track-changed event"})},"SidebarPerformanceCoordinator"),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] Event-driven music coordination active"))}handleMusicChange(e){this.sidebarElement&&(this.handleVisibilityChange(),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] Music change coordinated via event",{source:e.source,reason:e.reason,timestamp:e.timestamp}))}setupDOMObservation(){if(!this.domObserver){if(this.setupMusicChangeCoordination(),this.sidebarElement=document.querySelector(k.rightSidebar),!this.sidebarElement){this.config.enableDebug&&console.warn("\u{1F30C} [SidebarPerformanceCoordinator] Sidebar not found, deferring DOM observation"),this.domObservationRetryTimeout&&(clearTimeout(this.domObservationRetryTimeout),this.activeTimeouts.delete(this.domObservationRetryTimeout)),this.domObservationRetryTimeout=setTimeout(()=>{this.setupDOMObservation(),this.domObservationRetryTimeout=null},1e3),this.activeTimeouts.add(this.domObservationRetryTimeout);return}this.domObserver=new MutationObserver(e=>{let t=e.filter(i=>this.isRelevantMutation(i));t.length!==0&&this.throttleObservationUpdate(()=>{for(let i of t)i.type==="attributes"&&(i.attributeName==="aria-hidden"||i.attributeName==="style")&&this.handleVisibilityChange();this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] Relevant DOM change detected - visibility/structure only",{mutationCount:t.length,types:t.map(i=>i.type)})})}),this.domObserver.observe(this.sidebarElement,{childList:!0,subtree:!1,attributes:!0,attributeFilter:["aria-hidden","style","class"],attributeOldValue:!1,characterData:!1}),this.setupVisibilityObserver(),this.setupScrollObservation(),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] DOM observation active on sidebar")}}setupVisibilityObserver(){!this.sidebarElement||this.visibilityObserver||(this.visibilityObserver=new IntersectionObserver(e=>{let t=e[0];t&&t.isIntersecting&&this.isFirstOpen&&(window.requestIdleCallback?window.requestIdleCallback(()=>{this.triggerTemporalEcho(),this.isFirstOpen=!1}):setTimeout(()=>{this.triggerTemporalEcho(),this.isFirstOpen=!1},0))},{threshold:.1}),this.visibilityObserver.observe(this.sidebarElement))}setupScrollObservation(){if(!this.sidebarElement)return;let e=this.sidebarElement.querySelector(".main-nowPlayingView-queue");e&&e.addEventListener("scroll",this.throttledScrollHandler.bind(this),{passive:!0})}throttledScrollHandler(){let e=performance.now();e-this.lastScrollUpdate<33||(this.lastScrollUpdate=e,window.requestIdleCallback?window.requestIdleCallback(()=>{this.queueUpdate("--sn-rs-scroll-ratio",Math.random().toString())},{timeout:100}):this.queueUpdate("--sn-rs-scroll-ratio",Math.random().toString()))}isRelevantMutation(e){if(e.type==="attributes"){let t=e.attributeName;return t==="aria-hidden"||t==="style"||t==="class"?!0:(t?.startsWith("--")||t==="data-style",!1)}return e.type==="childList"?e.addedNodes&&Array.from(e.addedNodes).some(i=>i.nodeType===Node.ELEMENT_NODE)||e.removedNodes&&Array.from(e.removedNodes).some(i=>i.nodeType===Node.ELEMENT_NODE):!1}throttleObservationUpdate(e){let t=performance.now();t-this.lastObservationTime<this.OBSERVATION_THROTTLE_MS?(this.observationThrottleTimer&&clearTimeout(this.observationThrottleTimer),this.observationThrottleTimer=window.setTimeout(()=>{e(),this.lastObservationTime=performance.now(),this.observationThrottleTimer=null},this.OBSERVATION_THROTTLE_MS)):(e(),this.lastObservationTime=t)}handleVisibilityChange(){if(!this.sidebarElement)return;let e=!this.sidebarElement.hasAttribute("aria-hidden")&&!this.sidebarElement.style.display?.includes("none");e&&this.isFirstOpen&&(this.triggerTemporalEcho(),this.isFirstOpen=!1),this.config.enableDebug&&console.log(`\u{1F30C} [SidebarPerformanceCoordinator] Visibility changed: ${e?"visible":"hidden"}`)}triggerTemporalEcho(){if(!this.sidebarElement)return;this.sidebarElement.classList.add("sn-future-preview"),this.queueUpdate("--sn-kinetic-intensity","1"),this.queueUpdate("--sn-echo-hue-shift","15deg"),this.queueUpdate("--sn-echo-radius-multiplier","1.2"),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] Triggering temporal echo effect");let e=setTimeout(()=>{this.sidebarElement?.classList.remove("sn-future-preview"),this.queueUpdate("--sn-kinetic-intensity","0"),this.activeTimeouts.delete(e)},2e3);this.activeTimeouts.add(e)}getPerformanceMetrics(){return{flushCount:this.flushCount,averageFlushTime:this.flushCount>0?this.totalFlushTime/this.flushCount:0,lastFlushTimestamp:this.lastFlushTimestamp,pendingUpdates:this.pendingUpdates.size}}forceFlush(){this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.flushUpdates()}destroy(){if(this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.activeTimeouts.forEach(e=>{clearTimeout(e)}),this.activeTimeouts.clear(),this.domObservationRetryTimeout&&(clearTimeout(this.domObservationRetryTimeout),this.domObservationRetryTimeout=null),this.observationThrottleTimer&&(clearTimeout(this.observationThrottleTimer),this.observationThrottleTimer=null),this.domObserver&&(this.domObserver.disconnect(),this.domObserver=null),this.visibilityObserver&&(this.visibilityObserver.disconnect(),this.visibilityObserver=null),this.musicChangeUnsubscribe&&(this.musicChangeUnsubscribe(),this.musicChangeUnsubscribe=null),this.pendingUpdates.clear(),this.isFlushScheduled=!1,this.sidebarElement=null,Pe.instance===this&&(Pe.instance=null),this.config.enableDebug){let e=this.flushCount>0?this.totalFlushTime/this.flushCount:0;console.log(`\u{1F30C} [SidebarPerformanceCoordinator] Destroyed. Performance: ${this.flushCount} flushes, ${e.toFixed(2)}ms avg`)}}};Pe.instance=null;ut=Pe});var At,as=b(()=>{"use strict";Ai();ir();U();At=class extends Ve{constructor(t=w){super(t);this.sidebarSystems=new Map;this.integrationEnabled=!1;this.lastFrameTime=0;this.sharedCoordinator=ut.getInstance({enableDebug:t.enableDebug,performanceAnalyzer:this.performanceAnalyzer,onFlushComplete:()=>this.handlePerformanceFlush()}),this.performanceMetrics={totalSystems:4,activeSystems:0,bilateralSyncEnabled:!1,averageFrameTime:0,totalMemoryUsage:0,healthStatus:"healthy"},t.enableDebug&&console.log(`[${this.systemName}] Initialized sidebar systems integration`)}async initialize(){this.config.enableDebug&&console.log(`[${this.systemName}] Initializing sidebar systems integration`);try{this.registerSidebarSystems(),await this.registerWithUnifiedRegistry(),await this.initializeSystemsInOrder(),this.setupBilateralCoordination(),this.connectToEventBus(),this.integrateWithPerformanceSystems(),this.registerAnimation(70),this.integrationEnabled=!0,this.updatePerformanceMetrics(),this.publishEvent("sidebar:integration-ready",{systemName:this.systemName,totalSystems:this.sidebarSystems.size,activeSystems:this.performanceMetrics.activeSystems,bilateralSync:this.performanceMetrics.bilateralSyncEnabled,timestamp:Date.now()})}catch(t){throw console.error(`[${this.systemName}] Integration initialization failed:`,t),t}}registerSidebarSystems(){this.consolidatedSidebarSystem&&this.sidebarSystems.set("consolidatedSidebarSystem",{name:"consolidatedSidebarSystem",system:this.consolidatedSidebarSystem,priority:"critical",enabled:!0,dependencies:[]})}async initializeSystemsInOrder(){let t=this.calculateInitializationOrder();for(let i of t){let n=this.sidebarSystems.get(i);if(n&&n.enabled)try{await n.system._baseInitialize(),this.performanceMetrics.activeSystems++,this.config.enableDebug&&console.log(`[${this.systemName}] Initialized ${i}`)}catch(r){console.error(`[${this.systemName}] Failed to initialize ${i}:`,r)}}}calculateInitializationOrder(){let t=new Set,i=new Set,n=[],r=a=>{if(i.has(a))throw new Error(`Circular dependency detected: ${a}`);if(t.has(a))return;i.add(a);let s=this.sidebarSystems.get(a);if(s&&s.dependencies)for(let o of s.dependencies)r(o);i.delete(a),t.add(a),n.push(a)};for(let a of this.sidebarSystems.keys())r(a);return n}setupBilateralCoordination(){this.performanceMetrics.bilateralSyncEnabled=!0,this.subscribeToEvent("sidebar:bilateral-sync",t=>{this.handleBilateralSync(t)}),this.subscribeToEvent("sidebar:consciousness-level-changed",t=>{this.handleConsciousnessChange(t)})}handleBilateralSync(t){t.source==="orchestrator"&&this.updatePerformanceMetrics()}handleConsciousnessChange(t){let n={dormant:.5,aware:.7,focused:.9,transcendent:1}[t.newLevel]||.7;this.adjustPerformanceBudgets(n)}adjustPerformanceBudgets(t){let n=Math.floor(16*t);this.config.enableDebug&&console.log(`[${this.systemName}] Adjusted performance budget to ${n} based on consciousness level`)}handlePerformanceFlush(){let t=performance.now();if(this.lastFrameTime>0){let i=t-this.lastFrameTime;this.performanceMetrics.averageFrameTime=(this.performanceMetrics.averageFrameTime+i)/2}this.lastFrameTime=t,this.updateHealthStatus()}updatePerformanceMetrics(){this.performanceMetrics.totalSystems=this.sidebarSystems.size;let t=0;for(let[,i]of this.sidebarSystems)i.enabled&&i.system.isInitialized&&t++;this.performanceMetrics.activeSystems=t}updateHealthStatus(){this.performanceMetrics.averageFrameTime>20?this.performanceMetrics.healthStatus="critical":this.performanceMetrics.averageFrameTime>16.67?this.performanceMetrics.healthStatus="degraded":this.performanceMetrics.healthStatus="healthy"}onAnimate(t){if(!this.integrationEnabled)return;this.updatePerformanceMetrics(),this.updateHealthStatus(),performance.now()-this.lastFrameTime>1e3&&this.publishEvent("sidebar:integration-metrics",{metrics:this.performanceMetrics,timestamp:Date.now()})}registerWithAnimationCoordinator(t){if(!t){console.warn(`[${this.systemName}] Animation coordinator not available`);return}for(let[i,n]of this.sidebarSystems)if(n.enabled&&n.system.isInitialized)try{t.registerAnimationSystem(i,n.system,n.priority,60),this.config.enableDebug&&console.log(`[${this.systemName}] Registered ${i} with animation coordinator`)}catch(r){console.error(`[${this.systemName}] Failed to register ${i}:`,r)}}getSidebarSystems(){return new Map(this.sidebarSystems)}getPerformanceMetrics(){return{...this.performanceMetrics}}setSidebarSystemEnabled(t,i){let n=this.sidebarSystems.get(t);n&&(n.enabled=i,!i&&n.system.isInitialized?(n.system._baseDestroy(),this.performanceMetrics.activeSystems--):i&&!n.system.isInitialized&&n.system._baseInitialize().catch(r=>{console.error(`[${this.systemName}] Failed to re-enable ${t}:`,r)}),this.publishEvent("sidebar:system-toggled",{systemName:t,enabled:i,timestamp:Date.now()}))}async healthCheck(){let t={};for(let[r,a]of this.sidebarSystems)if(a.enabled&&a.system.isInitialized)try{t[r]=await a.system.healthCheck()}catch(s){t[r]={healthy:!1,ok:!1,details:`Health check failed: ${s.message}`,issues:[`Health check failed: ${s.message}`],system:r}}let i=Object.values(t).filter(r=>!r.ok),n=i.length===0;return{healthy:n,ok:n,details:`Sidebar integration ${n?"healthy":"degraded"} - ${this.performanceMetrics.activeSystems}/${this.performanceMetrics.totalSystems} systems active, bilateral sync: ${this.performanceMetrics.bilateralSyncEnabled}`,issues:i.map(r=>r.details||"Unknown issue"),system:"SidebarSystemsIntegration"}}async registerWithUnifiedRegistry(){this.config.enableDebug&&console.log(`[${this.systemName}] Sidebar systems are now managed by VisualSystemFacade`)}connectToEventBus(){this.subscribeToEvent("music:beat",t=>{this.handleMusicBeat(t)}),this.subscribeToEvent("music:energy",t=>{this.handleMusicEnergy(t)}),this.subscribeToEvent("performance:threshold-exceeded",t=>{this.handlePerformanceThreshold(t)}),this.subscribeToEvent("user:navigation",t=>{this.handleUserNavigation(t)}),this.config.enableDebug&&console.log(`[${this.systemName}] Connected to EventBus for system-wide communication`)}integrateWithPerformanceSystems(){let t=globalThis.year3000System;if(!t){this.config.enableDebug&&console.log(`[${this.systemName}] Year3000System not available, skipping performance integration`);return}try{let i=t.timerConsolidationSystem;i&&(i.registerTimer("sidebar-performance-monitor",1e3,()=>{this.updatePerformanceMetrics()}),this.config.enableDebug&&console.log(`[${this.systemName}] Integrated with TimerConsolidationSystem`));let n=t.enhancedMasterAnimationCoordinator;n&&(n.registerFrameCallback((r,a)=>{this.bilateralConsciousnessFrameUpdate(r,a)},"critical","sidebar-bilateral-consciousness"),this.config.enableDebug&&console.log(`[${this.systemName}] Integrated with EnhancedMasterAnimationCoordinator`))}catch(i){console.error(`[${this.systemName}] Failed to integrate with performance systems:`,i)}}handleMusicBeat(t){if(!this.integrationEnabled)return;let i={intensity:t.intensity||.5,timestamp:t.timestamp||Date.now(),bpm:t.bpm||120};this.config.enableDebug&&console.log(`[${this.systemName}] Processed music beat:`,i)}handleMusicEnergy(t){if(!this.integrationEnabled)return;let i=t.energy||.5;this.adjustPerformanceBudgets(.5+i*.5),this.consolidatedSidebarSystem?.initialized&&this.config.enableDebug&&console.log(`[${this.systemName}] Adapted consciousness to energy level: ${i}`)}handlePerformanceThreshold(t){this.integrationEnabled&&(t.severity==="critical"?(this.performanceMetrics.healthStatus="critical",this.config.enableDebug&&console.warn(`[${this.systemName}] Activated emergency performance mode`)):t.severity==="warning"&&this.performanceMetrics.healthStatus==="critical"&&(this.performanceMetrics.healthStatus="degraded"))}handleUserNavigation(t){if(!this.integrationEnabled)return;let i={action:t.action||"navigate",target:t.target||"unknown",timestamp:t.timestamp||Date.now()};this.config.enableDebug&&console.log(`[${this.systemName}] Processing navigation context:`,i)}bilateralConsciousnessFrameUpdate(t,i){if(!this.integrationEnabled)return;let n={frameTime:t,timestamp:i};t>16.67&&this.publishEvent("sidebar:frame-time-warning",{frameTime:t,timestamp:i})}destroy(){this.config.enableDebug&&console.log(`[${this.systemName}] Destroying sidebar systems integration`),this.integrationEnabled=!1;let t=globalThis.year3000System;t?.timerConsolidationSystem&&t.timerConsolidationSystem.unregisterTimer("sidebar-performance-monitor");let i=this.calculateInitializationOrder().reverse();for(let n of i){let r=this.sidebarSystems.get(n);if(r&&r.system.isInitialized)try{r.system._baseDestroy(),this.config.enableDebug&&console.log(`[${this.systemName}] Destroyed ${n}`)}catch(a){console.error(`[${this.systemName}] Failed to destroy ${n}:`,a)}}this.sidebarSystems.clear(),this.performanceMetrics={totalSystems:0,activeSystems:0,bilateralSyncEnabled:!1,averageFrameTime:0,totalMemoryUsage:0,healthStatus:"healthy"},this.publishEvent("sidebar:integration-destroyed",{timestamp:Date.now()})}}});var nr,It,Ii,rr=b(()=>{"use strict";nr=class extends Error{constructor(t,i,n,r,a){super(t);this.systemKey=i;this.strategy=n;this.context=r;this.cause=a;this.name="SystemCreationError"}},It=class extends nr{constructor(t,i,n,r){super(`Missing required dependencies for ${t}: ${n.join(", ")}`,t,i,r);this.missingDependencies=n;this.name="DependencyValidationError"}},Ii=class extends Error{constructor(t,i,n=`No suitable creation strategy found for system: ${t}`){super(n);this.systemKey=t;this.criteria=i;this.name="StrategySelectionError"}}});var Rt,Ri,ar,sr,or,ss,os=b(()=>{"use strict";D();R();rr();Rt=class{constructor(){this.systemConfigs=new Map}validateDependencies(e){let t=this.getRequiredDependencies(e.systemKey),i=this.getOptionalDependencies(e.systemKey),n=[],r=[];for(let a of t)(!(a in e.dependencies)||!e.dependencies[a])&&n.push(a);for(let a of i)(!(a in e.dependencies)||!e.dependencies[a])&&r.push(`Optional dependency missing: ${a}`);return{valid:n.length===0,missing:n,warnings:r}}getRequiredDependencies(e){return this.systemConfigs.get(e)?.requiredDependencies||[]}getOptionalDependencies(e){return this.systemConfigs.get(e)?.optionalDependencies||[]}registerSystemConfig(e){this.systemConfigs.set(e.systemKey,e)}createBaseResult(e,t,i,n){let a=performance.now()-i;return{system:e,success:!n&&e!==null,creationTime:a,strategy:this.getStrategyName(),injectedDependencies:Object.keys(t.dependencies),warnings:[],error:n||void 0,metadata:{requiresInitialization:!0,pendingDependencies:[],context:t}}}},Ri=class extends Rt{constructor(){super(),this.registerKnownSystems()}getStrategyName(){return"StandardConstructor"}canCreate(e){let t=this.systemConfigs.get(e.systemKey);return t!==void 0&&!t.creationPreferences.eventDriven}getEstimatedCreationTime(e){return 10}async createSystem(e,t){let i=performance.now();try{let n=this.validateDependencies(t);if(!n.valid&&t.preferences.validateDependencies!==!1)throw new It(t.systemKey,this.getStrategyName(),n.missing,t);let r=this.getConstructorParameters(t),a=new e(...r),s=this.createBaseResult(a,t,i);return s.warnings=n.warnings,u?.debug?.log("StandardConstructorStrategy",`Created ${t.systemKey}`,{creationTime:s.creationTime,parametersUsed:r.length}),s}catch(n){let r=this.createBaseResult(null,t,i,n);return u?.debug?.error("StandardConstructorStrategy",`Failed to create ${t.systemKey}:`,n),r}}getConstructorParameters(e){let t=this.systemConfigs.get(e.systemKey);if(!t?.constructorMapping)return this.getStandardParameters(e);let i=[],{parameterNames:n,dependencyMapping:r}=t.constructorMapping;for(let a of n)switch(r[a]||a){case"config":i.push(e.config);break;case"utils":i.push(e.utils);break;case"performanceAnalyzer":case"simplePerformanceCoordinator":i.push(e.dependencies.simplePerformanceCoordinator||e.dependencies.performanceAnalyzer);break;case"settingsManager":i.push(e.dependencies.settingsManager);break;case"musicSyncService":i.push(e.dependencies.musicSyncService);break;case"year3000System":i.push(e.dependencies.year3000System);break;case"cssConsciousnessController":i.push(e.dependencies.cssConsciousnessController);break;case"performanceCoordinator":i.push(e.dependencies.performanceCoordinator);break;case"enhancedDeviceTierDetector":i.push(e.dependencies.enhancedDeviceTierDetector);break;case"webglSystemsIntegration":i.push(e.dependencies.webglSystemsIntegration);break;case"deviceCapabilityDetector":i.push(e.dependencies.deviceCapabilityDetector);break;default:i.push(void 0)}return i}getStandardParameters(e){return[e.config,e.utils,e.dependencies.simplePerformanceCoordinator||e.dependencies.performanceAnalyzer,e.dependencies.musicSyncService,e.dependencies.settingsManager,e.dependencies.year3000System]}registerKnownSystems(){this.registerSystemConfig({systemKey:"ColorHarmonyEngine",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerSystemConfig({systemKey:"EnhancedMasterAnimationCoordinator",requiredDependencies:["config","performanceCoordinator"],optionalDependencies:[],constructorMapping:{parameterNames:["config","performanceCoordinator"],dependencyMapping:{config:"config",performanceCoordinator:"performanceCoordinator"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"UnifiedPerformanceCoordinator",requiredDependencies:["config"],optionalDependencies:["simplePerformanceCoordinator"],constructorMapping:{parameterNames:["config","simplePerformanceCoordinator"],dependencyMapping:{config:"config",simplePerformanceCoordinator:"simplePerformanceCoordinator"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}});let e=["DeviceCapabilityDetector","SettingsManager"];for(let t of e)this.registerSystemConfig({systemKey:t,requiredDependencies:[],optionalDependencies:[],constructorMapping:{parameterNames:[],dependencyMapping:{}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}});this.registerSystemConfig({systemKey:"TimerConsolidationSystem",requiredDependencies:[],optionalDependencies:[],constructorMapping:{parameterNames:[],dependencyMapping:{}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"GlassmorphismManager",requiredDependencies:["config","utils","cssConsciousnessController","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","cssConsciousnessController","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",cssConsciousnessController:"cssConsciousnessController",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"Card3DManager",requiredDependencies:["simplePerformanceCoordinator","settingsManager","utils"],optionalDependencies:[],constructorMapping:{parameterNames:["simplePerformanceCoordinator","settingsManager","utils"],dependencyMapping:{simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager",utils:"utils"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"UnifiedCSSVariableManager",requiredDependencies:["config","performanceCoordinator"],optionalDependencies:[],constructorMapping:{parameterNames:["config","performanceCoordinator"],dependencyMapping:{config:"config",performanceCoordinator:"performanceCoordinator"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"SidebarSystemsIntegration",requiredDependencies:["cssConsciousnessController"],optionalDependencies:[],constructorMapping:{parameterNames:["cssConsciousnessController"],dependencyMapping:{cssConsciousnessController:"cssConsciousnessController"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"UnifiedSystemIntegration",requiredDependencies:["year3000System"],optionalDependencies:[],constructorMapping:{parameterNames:["year3000System"],dependencyMapping:{year3000System:"year3000System"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"GenreGradientEvolution",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerSystemConfig({systemKey:"MusicEmotionAnalyzer",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerNewSimplifiedSystems()}registerNewSimplifiedSystems(){this.registerSystemConfig({systemKey:"SimplePerformanceCoordinator",requiredDependencies:["enhancedDeviceTierDetector","webglSystemsIntegration"],optionalDependencies:[],constructorMapping:{parameterNames:["enhancedDeviceTierDetector","webglSystemsIntegration"],dependencyMapping:{enhancedDeviceTierDetector:"enhancedDeviceTierDetector",webglSystemsIntegration:"webglSystemsIntegration"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"SimpleTierBasedPerformanceSystem",requiredDependencies:["enhancedDeviceTierDetector"],optionalDependencies:[],constructorMapping:{parameterNames:["enhancedDeviceTierDetector"],dependencyMapping:{enhancedDeviceTierDetector:"enhancedDeviceTierDetector"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"EnhancedDeviceTierDetector",requiredDependencies:[],optionalDependencies:[],constructorMapping:{parameterNames:[],dependencyMapping:{}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"WebGLSystemsIntegration",requiredDependencies:["deviceCapabilityDetector"],optionalDependencies:[],constructorMapping:{parameterNames:["deviceCapabilityDetector"],dependencyMapping:{deviceCapabilityDetector:"deviceCapabilityDetector"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}})}},ar=class extends Rt{constructor(){super(),this.registerEventDrivenSystems()}getStrategyName(){return"EventDriven"}canCreate(e){return this.systemConfigs.get(e.systemKey)?.creationPreferences.eventDriven===!0}getEstimatedCreationTime(e){return 50}async createSystem(e,t){let i=performance.now();try{let r=await new Ri().createSystem(e,t);if(!r.success)return r;this.setupEventSubscriptions(r.system,t);let a=this.createBaseResult(r.system,t,i);return a.warnings=r.warnings,u?.debug?.log("EventDrivenCreationStrategy",`Created ${t.systemKey} with event subscriptions`),a}catch(n){let r=this.createBaseResult(null,t,i,n);return u?.debug?.error("EventDrivenCreationStrategy",`Failed to create ${t.systemKey}:`,n),r}}setupEventSubscriptions(e,t){let i=this.getEventSubscriptions(t.systemKey);for(let n of i){let r=this.mapEventType(n);typeof e.handleEvent=="function"?p.subscribe(r,a=>{e.handleEvent(a)},`SystemCreation-${t.systemKey}`):typeof e.handleColorExtraction=="function"&&(n==="colors/extracted"||r==="colors:extracted")&&p.subscribe(r,e.handleColorExtraction.bind(e),`SystemCreation-${t.systemKey}`)}u?.debug?.log("EventDrivenCreationStrategy",`Setup event subscriptions for ${t.systemKey}:`,i)}mapEventType(e){return{"colors/extracted":"colors:extracted","colors/harmonized":"colors:harmonized","music/beat":"music:beat","music/energy":"music:energy","music/track-changed":"music:track-changed","performance/mode-changed":"performance:tier-changed","performance/thermal-warning":"performance:frame","settings/changed":"settings:changed"}[e]||e}getEventSubscriptions(e){return{ColorHarmonyEngine:["colors:extracted","music:track-changed"],GenreGradientEvolution:["music:beat","music:energy","music:track-changed"],MusicEmotionAnalyzer:["music:beat","music:energy","music:track-changed"]}[e]||[]}registerEventDrivenSystems(){this.registerSystemConfig({systemKey:"ColorHarmonyEngine",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerSystemConfig({systemKey:"GenreGradientEvolution",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerSystemConfig({systemKey:"MusicEmotionAnalyzer",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}})}},sr=class extends Rt{constructor(){super(),this.registerObjectDependencySystems()}getStrategyName(){return"ObjectDependencies"}canCreate(e){return e.systemKey==="MusicSyncService"}getEstimatedCreationTime(e){return 30}async createSystem(e,t){let i=performance.now();try{let n=this.validateDependencies(t);if(!n.valid&&t.preferences.validateDependencies!==!1)throw new It(t.systemKey,this.getStrategyName(),n.missing,t);let r={YEAR3000_CONFIG:t.config,Year3000Utilities:t.utils,settingsManager:t.dependencies.settingsManager,year3000System:t.dependencies.year3000System},a=new e(r),s=this.createBaseResult(a,t,i);return s.warnings=n.warnings,s.metadata.pendingDependencies=[],u?.debug?.log("ObjectDependenciesStrategy",`Created ${t.systemKey} with event-driven dependencies`),s}catch(n){let r=this.createBaseResult(null,t,i,n);return u?.debug?.error("ObjectDependenciesStrategy",`Failed to create ${t.systemKey}:`,n),r}}registerObjectDependencySystems(){this.registerSystemConfig({systemKey:"MusicSyncService",requiredDependencies:["config","utils"],optionalDependencies:["settingsManager","year3000System"],creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}})}},or=class{constructor(){this.strategies=new Map;this.registerDefaultStrategies()}register(e){this.strategies.set(e.getStrategyName(),e),u?.debug?.log("SystemCreationStrategyRegistry",`Registered strategy: ${e.getStrategyName()}`)}selectStrategy(e,t){let i=this.getStrategiesForSystem(e);if(i.length===0)return null;let n=i[0];if(!n)return null;let r=this.scoreStrategy(n,e,t);for(let a=1;a<i.length;a++){let s=i[a];if(!s)continue;let o=this.scoreStrategy(s,e,t);o>r&&(n=s,r=o)}return n}getStrategies(){return Array.from(this.strategies.values())}getStrategy(e){return this.strategies.get(e)||null}getStrategiesForSystem(e){let t={systemKey:e,config:{},utils:{},dependencies:{},preferences:{},metadata:{timestamp:Date.now(),reason:"startup",priority:"medium"}};return this.getStrategies().filter(i=>i.canCreate(t))}scoreStrategy(e,t,i){let n=0;return n+=10,i.dependencyRequirements==="event-driven"?(e.getStrategyName()==="EventDriven"&&(n+=20),e.getStrategyName()==="ObjectDependencies"&&(n+=15)):i.dependencyRequirements==="basic"&&e.getStrategyName()==="StandardConstructor"&&(n+=20),i.performance==="lightweight"?e.getStrategyName()==="StandardConstructor"&&(n+=15):i.performance==="optimized"&&e.getStrategyName()==="EventDriven"&&(n+=10),i.creationContext==="startup"&&e.getStrategyName()==="StandardConstructor"&&(n+=5),n}registerDefaultStrategies(){this.register(new Ri),this.register(new ar),this.register(new sr)}getStatus(){return{strategyCount:this.strategies.size,strategies:Array.from(this.strategies.keys())}}},ss=new or});var cr,cs,ls=b(()=>{"use strict";R();rr();os();cr=class{constructor(e){this.systemConfigs=new Map;this.creationMetrics={totalCreations:0,successfulCreations:0,averageCreationTime:0,strategyUsage:{}};this.strategyRegistry=e||ss,u?.debug?.log("StrategyBasedFactory","Factory initialized with strategy registry")}async createSystem(e,t,i){let n=performance.now();try{this.creationMetrics.totalCreations++;let r=this.getSystemConfig(e),a=this.buildSelectionCriteria(e,r,i),s=this.strategyRegistry.selectStrategy(e,a);if(!s)throw new Ii(e,a);let o=s.getStrategyName();this.creationMetrics.strategyUsage[o]=(this.creationMetrics.strategyUsage[o]||0)+1;let l=await s.createSystem(t,i);l.success&&this.creationMetrics.successfulCreations++;let d=performance.now()-n;return this.updateAverageCreationTime(d),u?.debug?.log("StrategyBasedFactory",`Created ${e} using ${o}`,{success:l.success,creationTime:l.creationTime,totalTime:d}),l}catch(r){let s=performance.now()-n;return u?.debug?.error("StrategyBasedFactory",`Failed to create ${e}:`,r),{system:null,success:!1,creationTime:s,strategy:"unknown",injectedDependencies:[],warnings:[],error:r,metadata:{requiresInitialization:!1,pendingDependencies:[],context:i}}}}registerSystemConfig(e){this.systemConfigs.set(e.systemKey,e),u?.debug?.log("StrategyBasedFactory",`Registered config for ${e.systemKey}`)}getSystemConfig(e){return this.systemConfigs.get(e)||null}setStrategyRegistry(e){this.strategyRegistry=e,u?.debug?.log("StrategyBasedFactory","Strategy registry updated")}getMetrics(){return{...this.creationMetrics}}resetMetrics(){this.creationMetrics={totalCreations:0,successfulCreations:0,averageCreationTime:0,strategyUsage:{}}}buildSelectionCriteria(e,t,i){let n="medium",r=["DeviceCapabilityDetector","PerformanceAnalyzer","UnifiedCSSVariableManager","SettingsManager","TimerConsolidationSystem"],a=["GlassmorphismManager","Card3DManager","UnifiedCSSVariableManager","EnhancedMasterAnimationCoordinator"];r.includes(e)?n="simple":a.includes(e)&&(n="complex");let s="basic";e==="MusicSyncService"||e==="ColorHarmonyEngine"?s="event-driven":r.includes(e)&&(s="none");let o="standard";return i.metadata.priority==="critical"||i.preferences.monitorCreation?o="optimized":n==="simple"&&(o="lightweight"),{complexity:n,dependencyRequirements:s,performance:o,resourceConstraints:{memoryLimited:i.metadata.resourceConstraints?.maxMemoryMB!==void 0,timeLimited:i.metadata.resourceConstraints?.maxInitTimeMs!==void 0,cpuLimited:i.metadata.priority==="low"},creationContext:i.metadata.reason}}updateAverageCreationTime(e){let t=this.creationMetrics.totalCreations,i=this.creationMetrics.averageCreationTime;this.creationMetrics.averageCreationTime=(i*(t-1)+e)/t}registerDefaultSystemConfigs(){}},cs=new cr});var lr,us,ms=b(()=>{"use strict";ls();R();lr=class{constructor(e){this.adapted=!1;this.originalFacade=null;this.migrationProgress=0;this.systemsUsingStrategy=new Set;this.systemsUsingLegacy=new Set;this.strategyBasedFactory=e||cs,u?.debug?.log("NonVisualSystemFacadeAdapter","Facade adapter initialized")}adaptToStrategyPattern(e){this.strategyBasedFactory=e,this.adapted=!0,this.migrationProgress=1,u?.debug?.log("NonVisualSystemFacadeAdapter","Facade adapted to strategy pattern")}getMigrationStatus(){return{adapted:this.adapted,systemsUsingStrategyPattern:Array.from(this.systemsUsingStrategy),systemsUsingLegacyPattern:Array.from(this.systemsUsingLegacy),migrationProgress:this.migrationProgress}}async completeMigration(){this.adapted||this.adaptToStrategyPattern(this.strategyBasedFactory),this.migrationProgress=1,this.systemsUsingLegacy.clear(),u?.debug?.log("NonVisualSystemFacadeAdapter","Migration to strategy pattern completed")}async createSystemWithStrategy(e,t,i){let n={systemKey:e,config:i.config,utils:i.utils,dependencies:i.dependencies,preferences:{lazyInit:!1,validateDependencies:!0,creationTimeout:5e3,monitorCreation:!0},metadata:{timestamp:Date.now(),reason:"startup",priority:"medium",resourceConstraints:{maxMemoryMB:50,maxInitTimeMs:1e3}}};try{let r=await this.strategyBasedFactory.createSystem(e,t,n);return r.success?(this.systemsUsingStrategy.add(e),this.systemsUsingLegacy.delete(e)):this.systemsUsingLegacy.add(e),this.updateMigrationProgress(),u?.debug?.log("NonVisualSystemFacadeAdapter",`Created ${e} via strategy pattern`,{strategy:r.strategy,success:r.success,creationTime:r.creationTime}),r}catch(r){return this.systemsUsingLegacy.add(e),this.updateMigrationProgress(),u?.debug?.error("NonVisualSystemFacadeAdapter",`Failed to create ${e} via strategy pattern:`,r),{system:null,success:!1,creationTime:0,strategy:"adapter-fallback",injectedDependencies:[],warnings:[`Strategy creation failed: ${r}`],error:r,metadata:{requiresInitialization:!1,pendingDependencies:[],context:n}}}}createSystemLegacy(e,t,i){switch(this.systemsUsingLegacy.add(e),this.updateMigrationProgress(),u?.debug?.warn("NonVisualSystemFacadeAdapter",`Using legacy creation for ${e} - should migrate to strategy pattern`),e){case"DeviceCapabilityDetector":case"PerformanceAnalyzer":case"SettingsManager":case"TimerConsolidationSystem":return new t;case"SidebarSystemsIntegration":return new t(i.dependencies.cssConsciousnessController);case"OptimizedCSSVariableManager":return new t(i.config,i.dependencies.performanceCoordinator);case"ColorHarmonyEngine":return new t(i.config,i.utils,i.dependencies.performanceAnalyzer,i.dependencies.settingsManager);case"EnhancedMasterAnimationCoordinator":return new t(i.config,i.dependencies.performanceCoordinator);case"UnifiedPerformanceCoordinator":return new t(i.config,i.dependencies.performanceAnalyzer);case"GlassmorphismManager":return new t(i.config,i.utils,i.dependencies.cssConsciousnessController,i.dependencies.performanceAnalyzer,i.dependencies.settingsManager);case"Card3DManager":return new t(i.dependencies.performanceAnalyzer,i.dependencies.settingsManager,i.utils);case"MusicSyncService":return new t({YEAR3000_CONFIG:i.config,Year3000Utilities:i.utils,settingsManager:i.dependencies.settingsManager,year3000System:i.year3000System});case"EnhancedDeviceTierDetector":return t;case"WebGLSystemsIntegration":let n=i.dependencies.deviceCapabilityDetector;if(!n)throw new Error("WebGLSystemsIntegration requires DeviceCapabilityDetector");return new t(n);case"SimplePerformanceCoordinator":let r=i.dependencies.enhancedDeviceTierDetector,a=i.dependencies.webglSystemsIntegration;if(!r||!a)throw new Error("SimplePerformanceCoordinator requires EnhancedDeviceTierDetector and WebGLSystemsIntegration");return new t(r,a);case"SimpleTierBasedPerformanceSystem":let s=i.dependencies.enhancedDeviceTierDetector;if(!s)throw new Error("SimpleTierBasedPerformanceSystem requires EnhancedDeviceTierDetector");return new t(s);default:try{return new t}catch{return new t(i.config,i.utils,i.dependencies.performanceAnalyzer,i.dependencies.settingsManager)}}}updateMigrationProgress(){let e=this.systemsUsingStrategy.size+this.systemsUsingLegacy.size;e===0?this.migrationProgress=0:this.migrationProgress=this.systemsUsingStrategy.size/e}getAdapterMetrics(){let e=this.systemsUsingStrategy.size+this.systemsUsingLegacy.size;return{totalSystemsAdapted:this.systemsUsingStrategy.size,strategySuccessRate:e>0?this.systemsUsingStrategy.size/e:0,migrationProgress:this.migrationProgress,systemBreakdown:{strategy:Array.from(this.systemsUsingStrategy),legacy:Array.from(this.systemsUsingLegacy)}}}async migrateSystemToStrategy(e){try{return this.systemsUsingLegacy.delete(e),u?.debug?.log("NonVisualSystemFacadeAdapter",`Migrated ${e} to strategy pattern`),!0}catch(t){return u?.debug?.error("NonVisualSystemFacadeAdapter",`Failed to migrate ${e} to strategy pattern:`,t),!1}}getRecommendedMigrationOrder(){return["PerformanceAnalyzer","OptimizedCSSVariableManager","DeviceCapabilityDetector","SettingsManager","ColorHarmonyEngine","MusicSyncService","UnifiedPerformanceCoordinator","EnhancedMasterAnimationCoordinator","UnifiedSystemIntegration","GlassmorphismManager","Card3DManager"].filter(t=>this.systemsUsingLegacy.has(t))}},us=new lr});var kt,ds=b(()=>{"use strict";R();Yn();$();Na();$a();jn();Kn();yi();Qn();ue();Xn();Mi();Hn();di();R();De();hn();Ka();Vn();Xa();ui();Za();ts();as();ms();kt=class{constructor(e,t,i){this.cssConsciousnessController=null;this.musicSyncService=null;this.settingsManager=null;this.simplePerformanceCoordinator=null;this.webglSystemsIntegration=null;this.enhancedDeviceTierDetector=null;this.performanceAnalyzer=null;this.performanceCoordinator=null;this.performanceOrchestrator=null;this.isInitialized=!1;this.lastHealthCheck=null;this.healthCheckInterval=null;this.metricsUpdateInterval=null;this.onSystemCreated=null;this.onSystemFailed=null;this.onHealthChange=null;this.facadeAdapter=us;this.config=e,this.utils=t,this.year3000System=i,i&&typeof i=="object"&&"performanceAnalyzer"in i&&(this.performanceAnalyzer=i.performanceAnalyzer||null,this.cssConsciousnessController=i.unifiedCSSConsciousnessController||null,this.performanceCoordinator=i.unifiedPerformanceCoordinator||null,this.performanceOrchestrator=i.performanceOrchestrator||null,this.musicSyncService=i.musicSyncService||null,this.settingsManager=i.settingsManager||null,u?.debug?.log("NonVisualSystemFacade","Shared dependencies injected from SystemCoordinator",{performanceAnalyzer:!!this.performanceAnalyzer,cssConsciousnessController:!!this.cssConsciousnessController,performanceOrchestrator:!!this.performanceOrchestrator,musicSyncService:!!this.musicSyncService,settingsManager:!!this.settingsManager})),this.systemRegistry=new Map,this.systemCache=new Map,this.systemDependencies=new Map,this.facadeConfig={mode:"progressive",enablePerformanceMonitoring:!0,enableDependencyInjection:!0,enableSystemHealthMonitoring:!0,performanceThresholds:{maxInitTime:5e3,maxMemoryMB:100,maxCPUPercent:15},systemPreferences:{lazyInitialization:!0,aggressiveCaching:!0,performanceOptimization:!0}},this.currentMetrics=this.createInitialMetrics(),this.registerNonVisualSystems(),u?.debug?.log("NonVisualSystemFacade","Non-visual systems facade initialized")}registerNonVisualSystems(){this.systemRegistry.set("EnhancedMasterAnimationCoordinator",Fe),this.systemDependencies.set("EnhancedMasterAnimationCoordinator",["performanceAnalyzer","cssConsciousnessController"]),this.systemRegistry.set("TimerConsolidationSystem",fi),this.systemDependencies.set("TimerConsolidationSystem",["performanceAnalyzer"]),this.systemRegistry.set("OptimizedCSSVariableManager",ve),this.systemDependencies.set("OptimizedCSSVariableManager",["performanceCoordinator"]),this.systemRegistry.set("UnifiedCSSVariableManager",ve),this.systemDependencies.set("UnifiedCSSVariableManager",["performanceCoordinator"]),this.systemRegistry.set("UnifiedPerformanceCoordinator",Xe),this.systemDependencies.set("UnifiedPerformanceCoordinator",[]),this.systemRegistry.set("DeviceCapabilityDetector",N),this.systemDependencies.set("DeviceCapabilityDetector",[]),this.systemRegistry.set("PerformanceAnalyzer",he),this.systemDependencies.set("PerformanceAnalyzer",[]),this.systemRegistry.set("CSSVariableBatcher",ve),this.systemDependencies.set("CSSVariableBatcher",[]),this.systemRegistry.set("SystemHealthMonitor",he),this.systemDependencies.set("SystemHealthMonitor",[]),this.systemRegistry.set("UnifiedSystemIntegration",At),this.systemDependencies.set("UnifiedSystemIntegration",[]),this.systemRegistry.set("PerformanceBudgetManager",Ee),this.systemDependencies.set("PerformanceBudgetManager",["performanceAnalyzer"]),this.systemRegistry.set("SimplePerformanceCoordinator",he),this.systemDependencies.set("SimplePerformanceCoordinator",["performanceAnalyzer","performanceCoordinator","deviceCapabilityDetector","performanceBudgetManager"]),this.systemRegistry.set("PerformanceAwareLerpCoordinator",bi),this.systemDependencies.set("PerformanceAwareLerpCoordinator",["performanceOrchestrator"]),this.systemRegistry.set("SimplePerformanceCoordinator",he),this.systemDependencies.set("SimplePerformanceCoordinator",["enhancedDeviceTierDetector","webglSystemsIntegration"]),this.systemRegistry.set("SimpleTierBasedPerformanceSystem",lt),this.systemDependencies.set("SimpleTierBasedPerformanceSystem",["enhancedDeviceTierDetector"]),this.systemRegistry.set("EnhancedDeviceTierDetector",me),this.systemDependencies.set("EnhancedDeviceTierDetector",[]),this.systemRegistry.set("WebGLSystemsIntegration",Qe),this.systemDependencies.set("WebGLSystemsIntegration",["deviceCapabilityDetector"]),this.systemDependencies.set("UnifiedDebugManager",[]),this.systemRegistry.set("SettingsManager",ee),this.systemDependencies.set("SettingsManager",[]),this.systemRegistry.set("ColorHarmonyEngine",Ye),this.systemDependencies.set("ColorHarmonyEngine",["musicSyncService"]),this.systemRegistry.set("MusicSyncService",Ce),this.systemDependencies.set("MusicSyncService",[]),this.systemDependencies.set("ColorOrchestrator",[]),this.systemRegistry.set("UnifiedColorProcessingEngine",Pt),this.systemDependencies.set("UnifiedColorProcessingEngine",["settingsManager","performanceAnalyzer"]),this.systemRegistry.set("GenreGradientEvolution",nt),this.systemDependencies.set("GenreGradientEvolution",["cssConsciousnessController","musicSyncService","settingsManager"]),this.systemRegistry.set("MusicEmotionAnalyzer",ot),this.systemDependencies.set("MusicEmotionAnalyzer",["musicSyncService","settingsManager"]),this.systemRegistry.set("VisualEffectsCoordinator",Et),this.systemDependencies.set("VisualEffectsCoordinator",["settingsManager"]),this.systemRegistry.set("GlassmorphismManager",xi),this.systemDependencies.set("GlassmorphismManager",["cssConsciousnessController","performanceAnalyzer","settingsManager"]),this.systemRegistry.set("Card3DManager",Pi),this.systemDependencies.set("Card3DManager",["performanceAnalyzer","settingsManager"]),this.systemRegistry.set("SidebarSystemsIntegration",At),this.systemDependencies.set("SidebarSystemsIntegration",["cssConsciousnessController"])}async initialize(e){if(this.isInitialized){u?.debug?.warn("NonVisualSystemFacade","Already initialized");return}try{let t=performance.now();this.facadeConfig={...this.facadeConfig,...e},await this.initializeSharedDependencies(),await this.applyConfiguration(),this.startMonitoring(),await this.performHealthCheck();let i=performance.now();this.currentMetrics.systemInitializationTime=i-t,this.isInitialized=!0,u?.debug?.log("NonVisualSystemFacade","Non-visual systems facade fully initialized",{mode:this.facadeConfig.mode,systemsRegistered:this.systemRegistry.size,initTime:this.currentMetrics.systemInitializationTime})}catch(t){throw u?.debug?.error("NonVisualSystemFacade","Initialization failed:",t),await this.cleanup(),t}}async initializeSharedDependencies(){let e=["DeviceCapabilityDetector","EnhancedDeviceTierDetector","WebGLSystemsIntegration","SimplePerformanceCoordinator","PerformanceAnalyzer","UnifiedPerformanceCoordinator","SimplePerformanceCoordinator","OptimizedCSSVariableManager","SettingsManager","UnifiedDebugManager","MusicSyncService"];for(let t of e)try{let i=await this.getSystem(t);switch(i&&typeof i.initialize=="function"&&await i.initialize(),t){case"DeviceCapabilityDetector":this.year3000System&&(this.year3000System.deviceCapabilityDetector=i);break;case"EnhancedDeviceTierDetector":this.enhancedDeviceTierDetector=i;break;case"WebGLSystemsIntegration":this.webglSystemsIntegration=i;break;case"SimplePerformanceCoordinator":this.simplePerformanceCoordinator=i,this.performanceOrchestrator=i;break;case"PerformanceAnalyzer":this.performanceAnalyzer=i;break;case"UnifiedPerformanceCoordinator":this.performanceCoordinator=i;break;case"OptimizedCSSVariableManager":this.cssConsciousnessController=i;break;case"SettingsManager":this.settingsManager=i;break;case"UnifiedDebugManager":break;case"MusicSyncService":this.musicSyncService=i;break}}catch(i){u?.debug?.error("NonVisualSystemFacade",`Failed to initialize ${t}:`,i)}}getCachedSystem(e){let t=this.systemCache.get(e);if(t)return t;if(e==="DeviceCapabilityDetector"&&this.year3000System?.deviceCapabilityDetector){let i=this.year3000System.deviceCapabilityDetector;return this.systemCache.set(e,i),i}return e==="EnhancedDeviceTierDetector"&&this.enhancedDeviceTierDetector?(this.systemCache.set(e,this.enhancedDeviceTierDetector),this.enhancedDeviceTierDetector):e==="WebGLSystemsIntegration"&&this.webglSystemsIntegration?(this.systemCache.set(e,this.webglSystemsIntegration),this.webglSystemsIntegration):e==="SimplePerformanceCoordinator"&&this.simplePerformanceCoordinator?(this.systemCache.set(e,this.simplePerformanceCoordinator),this.simplePerformanceCoordinator):e==="PerformanceAnalyzer"&&this.performanceAnalyzer?(this.systemCache.set(e,this.performanceAnalyzer),this.performanceAnalyzer):e==="SimplePerformanceCoordinator"&&this.performanceOrchestrator?(this.systemCache.set(e,this.performanceOrchestrator),this.performanceOrchestrator):(e==="OptimizedCSSVariableManager"||e==="UnifiedCSSVariableManager")&&this.cssConsciousnessController?(this.systemCache.set(e,this.cssConsciousnessController),this.cssConsciousnessController):e==="MusicSyncService"&&this.musicSyncService?(this.systemCache.set(e,this.musicSyncService),this.musicSyncService):e==="SettingsManager"&&this.settingsManager?(this.systemCache.set(e,this.settingsManager),this.settingsManager):null}async getSystem(e){if(this.systemCache.has(e))return this.systemCache.get(e);if(e==="DeviceCapabilityDetector"&&this.year3000System?.deviceCapabilityDetector){let i=this.year3000System.deviceCapabilityDetector;return this.systemCache.set(e,i),u?.debug?.log("NonVisualSystemFacade","Using shared DeviceCapabilityDetector instance from SystemCoordinator"),i}if(e==="EnhancedDeviceTierDetector"&&this.enhancedDeviceTierDetector)return this.systemCache.set(e,this.enhancedDeviceTierDetector),u?.debug?.log("NonVisualSystemFacade","Using shared EnhancedDeviceTierDetector instance from SystemCoordinator"),this.enhancedDeviceTierDetector;if(e==="WebGLSystemsIntegration"&&this.webglSystemsIntegration)return this.systemCache.set(e,this.webglSystemsIntegration),u?.debug?.log("NonVisualSystemFacade","Using shared WebGLSystemsIntegration instance from SystemCoordinator"),this.webglSystemsIntegration;if(e==="SimplePerformanceCoordinator"&&this.simplePerformanceCoordinator)return this.systemCache.set(e,this.simplePerformanceCoordinator),u?.debug?.log("NonVisualSystemFacade","Using shared SimplePerformanceCoordinator instance from SystemCoordinator"),this.simplePerformanceCoordinator;if(e==="PerformanceAnalyzer"&&this.performanceAnalyzer)return this.systemCache.set(e,this.performanceAnalyzer),u?.debug?.log("NonVisualSystemFacade","Using shared PerformanceAnalyzer instance from SystemCoordinator"),this.performanceAnalyzer;if((e==="OptimizedCSSVariableManager"||e==="UnifiedCSSVariableManager")&&this.cssConsciousnessController)return this.systemCache.set(e,this.cssConsciousnessController),u?.debug?.log("NonVisualSystemFacade",`Using shared OptimizedCSSVariableManager instance from SystemCoordinator (requested as ${e})`),this.cssConsciousnessController;if(e==="SimplePerformanceCoordinator"&&this.performanceOrchestrator)return this.systemCache.set(e,this.performanceOrchestrator),u?.debug?.log("NonVisualSystemFacade","Using shared SimplePerformanceCoordinator instance from SystemCoordinator"),this.performanceOrchestrator;if(e==="MusicSyncService"&&this.musicSyncService)return this.systemCache.set(e,this.musicSyncService),u?.debug?.log("NonVisualSystemFacade","Using shared MusicSyncService instance from SystemCoordinator"),this.musicSyncService;if(e==="SettingsManager"&&this.settingsManager)return this.systemCache.set(e,this.settingsManager),u?.debug?.log("NonVisualSystemFacade","Using shared SettingsManager instance from SystemCoordinator"),this.settingsManager;let t=await this.createSystem(e);return this.systemCache.set(e,t),this.currentMetrics.activeSystems.push(e),this.currentMetrics.initializedSystems++,this.onSystemCreated&&this.onSystemCreated(e,t),t}async createSystem(e){let t=performance.now();try{if(e==="UnifiedDebugManager"){let o=Xr.getInstance();this.injectDependencies(o,e),this.integratePerformanceMonitoring(o,e);let l=performance.now();return this.currentMetrics.dependencyResolutionTime+=l-t,o}if(e==="ColorOrchestrator"){let o=st;this.injectDependencies(o,e),this.integratePerformanceMonitoring(o,e);let l=performance.now();return this.currentMetrics.dependencyResolutionTime+=l-t,o}let i=this.systemRegistry.get(e);if(!i)throw new Error(`Non-visual system '${e}' not found in registry`);let n={systemKey:e,config:this.config,utils:this.utils,dependencies:{config:this.config,utils:this.utils,performanceAnalyzer:this.performanceAnalyzer,settingsManager:this.settingsManager,musicSyncService:this.musicSyncService,year3000System:this.year3000System,cssConsciousnessController:this.cssConsciousnessController,performanceCoordinator:this.performanceCoordinator,performanceOrchestrator:this.performanceOrchestrator,enhancedDeviceTierDetector:this.enhancedDeviceTierDetector,webglSystemsIntegration:this.webglSystemsIntegration,simplePerformanceCoordinator:this.simplePerformanceCoordinator,deviceCapabilityDetector:this.year3000System?.deviceCapabilityDetector||null},preferences:{lazyInit:!1,validateDependencies:!0,creationTimeout:5e3,monitorCreation:!0},metadata:{timestamp:Date.now(),reason:"startup",priority:"medium",resourceConstraints:{maxMemoryMB:50,maxInitTimeMs:1e3}},year3000System:this.year3000System},r=await this.facadeAdapter.createSystemWithStrategy(e,i,n);if(!r.success){u?.debug?.warn("NonVisualSystemFacade",`Strategy creation failed for ${e}, falling back to legacy pattern`);let o=this.facadeAdapter.createSystemLegacy(e,i,n);this.injectDependencies(o,e),this.integratePerformanceMonitoring(o,e);let l=performance.now();return this.currentMetrics.dependencyResolutionTime+=l-t,o}let a=r.system;this.injectDependencies(a,e),this.integratePerformanceMonitoring(a,e);let s=performance.now();return this.currentMetrics.dependencyResolutionTime+=s-t,u?.debug?.log("NonVisualSystemFacade",`Created ${e} using strategy: ${r.strategy}`,{creationTime:r.creationTime,totalTime:s-t,injectedDependencies:r.injectedDependencies}),a}catch(i){throw this.currentMetrics.failedSystems++,this.currentMetrics.failedSystemsList.push(e),this.currentMetrics.systemErrors++,this.onSystemFailed&&this.onSystemFailed(e,i),u?.debug?.error("NonVisualSystemFacade",`Failed to create system ${e}:`,i),i}}injectDependencies(e,t){if(!this.facadeConfig.enableDependencyInjection)return;let i=this.systemDependencies.get(t)||[];i.includes("performanceAnalyzer")&&this.performanceAnalyzer&&e.setPerformanceAnalyzer&&e.setPerformanceAnalyzer(this.performanceAnalyzer),i.includes("cssConsciousnessController")&&this.cssConsciousnessController&&e.setCSSConsciousnessController&&e.setCSSConsciousnessController(this.cssConsciousnessController),i.includes("musicSyncService")&&this.musicSyncService&&e.setMusicSyncService&&e.setMusicSyncService(this.musicSyncService),i.includes("settingsManager")&&this.settingsManager&&e.setSettingsManager&&e.setSettingsManager(this.settingsManager),i.includes("year3000System")&&e.setYear3000System&&e.setYear3000System(this.year3000System),i.includes("performanceOrchestrator")&&this.performanceOrchestrator&&e.setSimplePerformanceCoordinator&&e.setSimplePerformanceCoordinator(this.performanceOrchestrator)}integratePerformanceMonitoring(e,t){if(!this.facadeConfig.enablePerformanceMonitoring||!this.performanceAnalyzer)return;let i=e.initialize;typeof i=="function"&&(e.initialize=async(...r)=>{let a=performance.now(),s=await i.call(e,...r),o=performance.now();return this.performanceAnalyzer?.recordMetric(`NonVisual_${t}_Initialize`,o-a),s});let n=e.updateAnimation;typeof n=="function"&&(e.updateAnimation=r=>{let a=performance.now();n.call(e,r);let s=performance.now();this.performanceAnalyzer?.recordMetric(`NonVisual_${t}_Animation`,s-a)})}async initializeAllSystems(){let e=Array.from(this.systemCache.entries()).map(async([n,r])=>{try{return r&&typeof r.initialize=="function"&&await r.initialize(),u?.debug?.log("NonVisualSystemFacade",`Initialized system: ${n}`),{key:n,success:!0}}catch(a){return u?.debug?.error("NonVisualSystemFacade",`Failed to initialize ${n}:`,a),{key:n,success:!1,error:a}}}),t=await Promise.allSettled(e),i=t.filter(n=>n.status==="fulfilled"&&n.value.success).length;u?.debug?.log("NonVisualSystemFacade",`Non-visual systems initialized: ${i}/${t.length}`)}async performHealthCheck(){let e={overall:"good",systems:new Map,recommendations:[],timestamp:performance.now(),metrics:{...this.currentMetrics}},t=0,i=0;for(let[r,a]of this.systemCache){i++;try{let s=a.healthCheck?await a.healthCheck():{status:"unknown",message:"No health check available"},o=s.status==="healthy"||s.status==="good";o&&t++,e.systems.set(r,{ok:o,details:s.message||s.details||"System operational"})}catch(s){e.systems.set(r,{ok:!1,details:`Health check failed: ${s}`})}}let n=i>0?t/i:1;return n>=.9?e.overall="excellent":n>=.7?e.overall="good":n>=.5?(e.overall="degraded",e.recommendations.push("Some non-visual systems are experiencing issues")):(e.overall="critical",e.recommendations.push("Multiple non-visual system failures detected")),this.currentMetrics.systemInitializationTime>3e3&&e.recommendations.push("High initialization time - consider optimizing system startup"),this.currentMetrics.memoryUsageMB>80&&e.recommendations.push("High memory usage - consider optimizing system memory usage"),this.lastHealthCheck=e,this.currentMetrics.lastHealthCheckTime=performance.now(),this.onHealthChange&&this.onHealthChange(e),e}createInitialMetrics(){return{systemCount:this.systemRegistry.size,initializedSystems:0,failedSystems:0,totalInitTime:0,averageInitTime:0,memoryUsageMB:0,systemHealth:"good",activeSystems:[],failedSystemsList:[],dependencyInjection:this.facadeConfig.enableDependencyInjection,performanceMonitoring:this.facadeConfig.enablePerformanceMonitoring,healthMonitoring:this.facadeConfig.enableSystemHealthMonitoring,systemInitializationTime:0,dependencyResolutionTime:0,lastHealthCheckTime:0,systemErrors:0}}async applyConfiguration(){switch(this.facadeConfig.mode){case"performance-first":this.facadeConfig.systemPreferences.lazyInitialization=!0,this.facadeConfig.systemPreferences.aggressiveCaching=!0;break;case"quality-first":this.facadeConfig.systemPreferences.lazyInitialization=!1,this.facadeConfig.systemPreferences.performanceOptimization=!0;break;case"battery-optimized":this.facadeConfig.performanceThresholds.maxCPUPercent=5,this.facadeConfig.systemPreferences.lazyInitialization=!0;break}}startMonitoring(){this.facadeConfig.enableSystemHealthMonitoring&&(this.healthCheckInterval=window.setInterval(async()=>{await this.performHealthCheck()},3e4),this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},5e3))}updateMetrics(){this.currentMetrics.systemCount=this.systemRegistry.size,this.currentMetrics.initializedSystems=this.systemCache.size,this.currentMetrics.averageInitTime=this.currentMetrics.totalInitTime/Math.max(1,this.currentMetrics.initializedSystems);let e=performance.memory;e&&(this.currentMetrics.memoryUsageMB=e.usedJSHeapSize/(1024*1024));let t=this.currentMetrics.failedSystems/Math.max(1,this.currentMetrics.systemCount);t===0?this.currentMetrics.systemHealth="excellent":t<.1?this.currentMetrics.systemHealth="good":t<.3?this.currentMetrics.systemHealth="degraded":this.currentMetrics.systemHealth="critical"}async cleanup(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this.cssConsciousnessController=null,this.performanceAnalyzer=null,this.performanceOrchestrator=null,this.musicSyncService=null,this.settingsManager=null}getMetrics(){return{...this.currentMetrics}}getLastHealthCheck(){return this.lastHealthCheck}getConfiguration(){return{...this.facadeConfig}}async setConfiguration(e){this.facadeConfig={...this.facadeConfig,...e},await this.applyConfiguration()}setOnSystemCreated(e){this.onSystemCreated=e}setOnSystemFailed(e){this.onSystemFailed=e}setOnHealthChange(e){this.onHealthChange=e}getSystemStatus(){return{initialized:this.isInitialized,systemsActive:this.systemCache.size,healthy:this.currentMetrics.systemHealth==="excellent"||this.currentMetrics.systemHealth==="good"}}async destroy(){await this.cleanup(),this.isInitialized=!1,this.systemCache.clear(),u?.debug?.log("NonVisualSystemFacade","Non-visual systems facade destroyed")}}});var ki,hs=b(()=>{"use strict";D();ki=class{constructor(e,t,i){this.systemName="CSSAnimationManager";this.animationStates=new Map;this.activeAnimations=new Map;this.animationObservers=new Map;this.frameCount=0;this.lastFrameTime=0;this.avgFrameTime=0;this.performanceMode="quality";this.beatSyncState={intensity:0,tempo:120,phase:0,lastBeatTime:0,avgBeatInterval:500};this.breathingState={currentType:"gentle",activeElements:new Set,currentAnimation:null,lastEnergyLevel:.5,lastTempoChange:0,targetEnergyLevel:.5,smoothedEnergyLevel:.5,targetTempo:120,smoothedTempo:120,lastFrameTime:0,energyHalfLife:.3,tempoHalfLife:.8};this.ANIMATION_CONFIGS={consciousnessGentleBreathing:{name:"consciousness-gentle-breathing",duration:4e3,easing:"ease-in-out",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},consciousnessEnergeticBreathing:{name:"consciousness-energetic-breathing",duration:2500,easing:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},consciousnessMeditativeBreathing:{name:"consciousness-meditative-breathing",duration:6e3,easing:"cubic-bezier(0.4, 0, 0.6, 1)",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},consciousnessCosmicBreathing:{name:"consciousness-cosmic-breathing",duration:3e3,easing:"cubic-bezier(0.25, 0.1, 0.25, 1)",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},bloom:{name:"year3000-bloom",duration:1500,easing:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",iterations:1,fillMode:"forwards",playState:"running",delay:0,direction:"normal"},ripple:{name:"year3000-ripple",duration:1200,easing:"ease-out",iterations:1,fillMode:"forwards",playState:"running",delay:0,direction:"normal"},oscillate:{name:"year3000-oscillate",duration:4e3,easing:"ease-in-out",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},harmonize:{name:"year3000-harmonize-flow",duration:8e3,easing:"linear",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},refract:{name:"year3000-refract",duration:800,easing:"ease-in-out",iterations:1,fillMode:"forwards",playState:"running",delay:0,direction:"normal"},temporalEcho:{name:"year3000-echo-core",duration:800,easing:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",iterations:1,fillMode:"forwards",playState:"running",delay:0,direction:"normal"},gravity:{name:"year3000-gravity-pull",duration:1e3,easing:"ease-in-out",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"}};this.config=e,this.cssConsciousnessController=t,this.animationCoordinator=i,this.eventBus=p,this.initializeDefaultState(),this.subscribeToEvents(),this.animationCoordinator.registerVisualSystem(this,"normal"),this.breathingState.lastFrameTime=performance.now(),this.config.enableDebug&&console.log("[CSSAnimationManager] Initialized with CSS animation coordination and LERP-smoothed breathing transitions")}onAnimate(e,t){this.frameCount++,this.lastFrameTime=e,this.avgFrameTime=this.avgFrameTime*.9+e*.1,this.updatePerformanceMode(t.performanceMode),t.beatIntensity!==void 0&&this.updateBeatSyncState(t.beatIntensity,t.timestamp);let i=e/1e3;this.updateBreathingLerpValues(i),this.updateAnimationVariables(t),this.updateActiveAnimations(t),this.frameCount%60===0&&this.reportPerformanceMetrics()}onPerformanceModeChange(e){this.performanceMode=e,this.updateAnimationQuality(e),this.config.enableDebug&&console.log(`[CSSAnimationManager] Performance mode changed to: ${e}`)}triggerKineticAnimation(e,t,i){let n={...this.ANIMATION_CONFIGS[t],...i};Array.from(e).forEach((r,a)=>{let s=(n.delay||0)+a*50,o={duration:n.duration||1e3,easing:n.easing||"ease-in-out",iterations:n.iterations==="infinite"?1/0:n.iterations||1,fill:n.fillMode||"forwards",delay:s,direction:n.direction||"normal"},l=r.animate([],o),m=`${t}_${Date.now()}_${a}`;this.activeAnimations.set(m,l),l.addEventListener("finish",()=>{this.activeAnimations.delete(m),r.classList.remove(`sn-${t}-active`)}),r.classList.add(`sn-${t}-active`)}),this.config.enableDebug&&console.log(`[CSSAnimationManager] Triggered ${t} animation on ${e.length} elements`)}enableBeatSync(e=!0){for(let[t,i]of this.animationStates)i.beatSyncEnabled=e,this.animationStates.set(t,i);this.cssConsciousnessController.updateMusicVariables({"beat.pulse.intensity":e?this.beatSyncState.intensity:0}),this.config.enableDebug&&console.log(`[CSSAnimationManager] Beat sync ${e?"enabled":"disabled"}`)}setAnimationIntensity(e){let t=Math.max(0,Math.min(1,e));for(let[i,n]of this.animationStates)n.intensityLevel=t,this.animationStates.set(i,n);this.cssConsciousnessController.updateAnimationVariables({"motion.scale":t}),this.cssConsciousnessController.updateMusicVariables({"beat.pulse.intensity":t}),this.config.enableDebug&&console.log(`[CSSAnimationManager] Animation intensity set to: ${t}`)}pauseAllAnimations(){for(let e of this.activeAnimations.values())e.pause();this.cssConsciousnessController.updateAnimationVariables({"motion.scale":0}),this.config.enableDebug&&console.log("[CSSAnimationManager] All animations paused")}resumeAllAnimations(){for(let e of this.activeAnimations.values())e.play();this.cssConsciousnessController.updateAnimationVariables({"motion.scale":1}),this.config.enableDebug&&console.log("[CSSAnimationManager] All animations resumed")}lerpSmooth(e,t,i,n){return n<=1e-5||i<=0?t:t+(e-t)*Math.pow(2,-i/n)}updateBreathingLerpValues(e){this.breathingState.smoothedEnergyLevel=this.lerpSmooth(this.breathingState.smoothedEnergyLevel,this.breathingState.targetEnergyLevel,e,this.breathingState.energyHalfLife),this.breathingState.smoothedTempo=this.lerpSmooth(this.breathingState.smoothedTempo,this.breathingState.targetTempo,e,this.breathingState.tempoHalfLife)}triggerConsciousnessBreathing(e,t=.5,i=120){this.breathingState.targetEnergyLevel=t,this.breathingState.targetTempo=i;let n=this.breathingState.smoothedEnergyLevel,r=this.breathingState.smoothedTempo,a=this.selectBreathingType(n,r);this.breathingState.currentAnimation&&this.breathingState.currentAnimation.cancel(),this.breathingState.activeElements.forEach(s=>{s.classList.remove("consciousness-gentle-breathing","consciousness-energetic-breathing","consciousness-meditative-breathing","consciousness-cosmic-breathing")}),this.breathingState.currentType=a,this.breathingState.lastEnergyLevel=n,this.breathingState.lastTempoChange=Date.now(),this.breathingState.activeElements.clear(),Array.from(e).forEach(s=>{this.breathingState.activeElements.add(s),s.classList.add(`consciousness-${a}-breathing`)}),this.updateBreathingVariables(a,n,r),this.config.enableDebug&&console.log(`[CSSAnimationManager] LERP-smoothed breathing: ${a} (raw: ${t.toFixed(2)}\u2192${n.toFixed(2)}, tempo: ${i}\u2192${r.toFixed(1)})`)}selectBreathingType(e,t){return this.performanceMode==="performance"&&e>.7?e>.8?"gentle":"meditative":e<.3?"meditative":e>.7&&t>140?"cosmic":e>.6?"energetic":"gentle"}updateBreathingVariables(e,t,i){let n=this.calculateBreathingDuration(e,i),r=Math.max(.05,Math.min(1,t));this.cssConsciousnessController.updateConsciousnessVariables({"breathing.type":e,"breathing.duration":`${n}ms`,"breathing.intensity":r,"breathing.energy":t}),this.cssConsciousnessController.updateMusicVariables({"tempo.bpm":i,"energy.level":t,"breathing.sync":1})}calculateBreathingDuration(e,t){let n={gentle:4e3,energetic:2500,meditative:6e3,cosmic:3e3}[e]||4e3,r=Math.max(.5,Math.min(2,120/t));return Math.round(n*r)}stopConsciousnessBreathing(){this.breathingState.currentAnimation&&(this.breathingState.currentAnimation.cancel(),this.breathingState.currentAnimation=null),this.breathingState.activeElements.forEach(e=>{e.classList.remove("consciousness-gentle-breathing","consciousness-energetic-breathing","consciousness-meditative-breathing","consciousness-cosmic-breathing")}),this.breathingState.activeElements.clear(),this.cssConsciousnessController.updateConsciousnessVariables({"breathing.sync":0}),this.config.enableDebug&&console.log("[CSSAnimationManager] Consciousness breathing stopped")}getPerformanceMetrics(){return{frameCount:this.frameCount,avgFrameTime:this.avgFrameTime,activeAnimations:this.activeAnimations.size,performanceMode:this.performanceMode}}destroy(){for(let e of this.activeAnimations.values())e.cancel();this.activeAnimations.clear(),this.animationStates.clear(),this.animationObservers.clear(),this.config.enableDebug&&console.log("[CSSAnimationManager] Destroyed")}initializeDefaultState(){let e={rippleActive:!1,bloomActive:!1,refractActive:!1,oscillateActive:!1,harmonizeActive:!1,temporalEchoActive:!1,gravityActive:!1,beatSyncEnabled:!0,intensityLevel:1,tempoMultiplier:1};this.animationStates.set("default",e)}subscribeToEvents(){this.eventBus.subscribe("music:beat",e=>{this.handleBeatEvent(e)},"CSSAnimationManager"),this.eventBus.subscribe("music:energy",e=>{this.handleTempoChange({bpm:e.tempo})},"CSSAnimationManager"),this.eventBus.subscribe("settings:changed",e=>{e.settingKey==="sn-animation-quality"&&this.handleAnimationQualityChange(e.newValue)},"CSSAnimationManager"),this.eventBus.subscribe("performance:frame",e=>{let t=e.fps<45?"performance":"quality";this.onPerformanceModeChange(t)},"CSSAnimationManager")}handleBeatEvent(e){let t=performance.now(),i=t-this.beatSyncState.lastBeatTime;if(this.beatSyncState.intensity=e.intensity||0,this.beatSyncState.phase=e.phase||0,this.beatSyncState.lastBeatTime=t,i>0&&i<2e3&&(this.beatSyncState.avgBeatInterval=this.beatSyncState.avgBeatInterval*.9+i*.1),this.cssConsciousnessController.updateMusicVariables({"beat.pulse.intensity":this.beatSyncState.intensity,"beat.phase":this.beatSyncState.phase}),e.energy!==void 0){let n=e.energy,r=this.beatSyncState.tempo,a=Math.abs(n-this.breathingState.lastEnergyLevel),s=t-this.breathingState.lastTempoChange;if(a>.15||s>5e3){let o=document.querySelectorAll(".Root__main-view::before, .Root__main-view, [data-consciousness-breathing]");o.length>0&&this.triggerConsciousnessBreathing(o,n,r)}}}handleTempoChange(e){let t=e.bpm||120;this.beatSyncState.tempo=t;let i=t/120;this.cssConsciousnessController.updateMusicVariables({"tempo.bpm":t}),this.cssConsciousnessController.updateAnimationVariables({"motion.scale":i});for(let[n,r]of this.animationStates)r.tempoMultiplier=i,this.animationStates.set(n,r)}updateBeatSyncState(e,t){this.beatSyncState.intensity=e,this.beatSyncState.lastBeatTime=t,this.cssConsciousnessController.updateMusicVariables({"beat.pulse.intensity":e})}updateAnimationVariables(e){this.cssConsciousnessController.updateAnimationVariables({"frame.fps":Math.round(1e3/e.deltaMs),"frame.budget":`${e.frameBudget}ms`}),e.tiltXY&&this.cssConsciousnessController.updateConsciousnessVariables({"hover.pull":`${Math.abs(e.tiltXY.x)+Math.abs(e.tiltXY.y)}px`})}updateActiveAnimations(e){if(e.timestamp-this.lastFrameTime<16)return;let t=this.performanceMode==="performance"?.7:1;for(let i of this.activeAnimations.values())i.playbackRate!==t&&(i.playbackRate=t)}handleAnimationQualityChange(e){let t;switch(e){case"low":t=.4;break;case"high":t=1;break;case"auto":default:t=this.performanceMode==="performance"?.6:1;break}this.applyQualityLevel(t),this.config.enableDebug&&console.log(`[CSSAnimationManager] Animation quality set to: ${e} (level: ${t})`)}updateAnimationQuality(e){let t=e==="performance"?.6:1;this.applyQualityLevel(t)}applyQualityLevel(e){let t=e<.5?"performance":"quality";this.cssConsciousnessController.updatePerformanceVariables({"quality.level":e,mode:t}),this.cssConsciousnessController.updateAnimationVariables({"motion.scale":e}),e<.5?this.cssConsciousnessController.updateUtilityVariables({"feature.animations.enabled":!1}):this.cssConsciousnessController.updateUtilityVariables({"feature.animations.enabled":!0})}updatePerformanceMode(e){this.performanceMode!==e&&(this.performanceMode=e,this.updateAnimationQuality(e))}reportPerformanceMetrics(){let e=this.getPerformanceMetrics();this.eventBus.emit("performance:frame",{deltaTime:e.avgFrameTime,fps:Math.round(1e3/e.avgFrameTime),memoryUsage:0,timestamp:Date.now()}),this.config.enableDebug&&console.log(`[CSSAnimationManager] Performance - FPS: ${Math.round(1e3/e.avgFrameTime)}, Active: ${e.activeAnimations}`)}}});var Di,ur,mr,gs=b(()=>{"use strict";Di=class{constructor(){this.breathingEngine=new ur,this.symbioticCore=new mr}getConsciousnessState(){return{cellularGrowthRate:1,breathingCycle:2,emotionalTemperature:6e3,membraneFluidityIndex:.5,symbioticResonance:.5,cinematicIntensity:.5}}},ur=class{updateBreathing(e){}getBreathingPhase(){return .5}initialize(){}updateBreathingCycle(e){}calculateBreathingCycle(e){return 2}adjustRhythm(e){}synchronizeWithBeat(e){}},mr=class{processAudioData(e){}getEmotionalState(){return{intensity:.5,valence:.5,arousal:.5,energy:.5}}initialize(){}updateSymbioticResonance(e){}calculateResonance(e){return .5}updateSymbioticEffects(e){}}});var kc,ps,fs,bs,ys,Oe,X,dr,hr,gr,Ss=b(()=>{"use strict";kc=`#version 300 es
in vec2 a_position;
void main() {
  gl_Position = vec4(a_position, 0.0, 1.0);
}`,ps=`
// Shared simplex noise implementation for visual effects
vec3 mod289(vec3 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec2 mod289(vec2 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec3 permute(vec3 x) {
  return mod289(((x*34.0)+1.0)*x);
}

float snoise(vec2 v) {
  const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);
  vec2 i = floor(v + dot(v, C.yy));
  vec2 x0 = v - i + dot(i, C.xx);
  vec2 i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
  vec4 x12 = x0.xyxy + C.xxzz;
  x12.xy -= i1;
  i = mod289(i);
  vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));
  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
  m = m*m;
  m = m*m;
  vec3 x = 2.0 * fract(p * C.www) - 1.0;
  vec3 h = abs(x) - 0.5;
  vec3 ox = floor(x + 0.5);
  vec3 a0 = x - ox;
  m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);
  vec3 g;
  g.x = a0.x * x0.x + h.x * x0.y;
  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
  return 130.0 * dot(m, g);
}`,fs=`
// Enhanced consciousness-aware breathing effect with multi-phase patterns
float consciousnessBreathing(float time, float phase, float intensity) {
  return sin(time * 0.05 + phase) * intensity;
}

// Deep consciousness breathing with emotional resonance
float deepConsciousnessBreathing(float time, float phase, float emotionalIntensity) {
  float primaryBreath = sin(time * 0.04 + phase) * 0.6;
  float secondaryBreath = sin(time * 0.07 + phase * 1.3) * 0.3;
  float emotionalBreath = sin(time * 0.02 + phase * 0.7) * 0.2;
  return (primaryBreath + secondaryBreath + emotionalBreath) * emotionalIntensity;
}

// Rhythmic pulse modulation from consciousness field
float rhythmicPulseModulation(float baseValue, float rhythmicPulse, float intensity) {
  return baseValue * (1.0 + rhythmicPulse * intensity);
}

// Musical flow direction calculation
vec2 calculateMusicalFlow(vec2 baseDirection, vec2 musicFlow, float sensitivity) {
  return baseDirection + musicFlow * sensitivity;
}

// Energy resonance modulation
float energyResonanceModulation(float baseValue, float energyResonance, float minMult, float maxMult) {
  return baseValue * (minMult + energyResonance * (maxMult - minMult));
}

// Membrane fluidity effect
float membraneFluidityEffect(float value, float fluidityIndex) {
  return mix(value, value * 1.2, fluidityIndex);
}

// === ADVANCED CONSCIOUSNESS FIELD PATTERNS ===

// Multi-dimensional consciousness field intensity calculation
float consciousnessFieldIntensity(vec2 position, float time, float musicEnergy) {
  // Primary consciousness wave
  float primaryField = snoise(position * 2.0 + time * 0.1) * 0.6;
  
  // Secondary awareness resonance
  float secondaryField = snoise(position * 4.0 + time * 0.05) * 0.3;
  
  // Musical consciousness enhancement
  float musicalField = snoise(position * 6.0 + time * 0.15) * 0.2;
  
  // Combine consciousness layers
  float combinedField = primaryField + secondaryField + (musicalField * musicEnergy);
  return clamp(combinedField * 0.5 + 0.5, 0.0, 1.0);
}

// Multi-dimensional awareness patterns for color modulation
vec3 awarenessResonance(vec3 baseColor, float consciousnessLevel, float musicIntensity) {
  // Consciousness-aware color temperature shift
  float temperatureShift = consciousnessLevel * 0.3;
  vec3 warmShift = vec3(1.0 + temperatureShift, 1.0 + temperatureShift * 0.5, 1.0);
  vec3 coolShift = vec3(1.0, 1.0 + temperatureShift * 0.3, 1.0 + temperatureShift);
  
  // Musical intensity affects color saturation
  float saturationBoost = 1.0 + musicIntensity * 0.4;
  
  // Apply consciousness-aware color modulation
  vec3 temperatureColor = mix(coolShift, warmShift, consciousnessLevel);
  return baseColor * temperatureColor * saturationBoost;
}

// Temporal flow patterns for Year 3000 streaming effects
vec2 temporalFlowDirection(vec2 position, float time, vec2 musicFlow) {
  // Primary temporal stream
  vec2 primaryFlow = vec2(
    sin(time * 0.08 + position.x * 3.0),
    cos(time * 0.06 + position.y * 2.5)
  ) * 0.02;
  
  // Secondary consciousness flow
  vec2 consciousnessFlow = vec2(
    sin(time * 0.05 + position.y * 4.0),
    cos(time * 0.04 + position.x * 3.5)
  ) * 0.015;
  
  // Musical synchronization flow
  vec2 musicalSync = musicFlow * 0.01;
  
  return primaryFlow + consciousnessFlow + musicalSync;
}

// Membrane consciousness dynamics for organic boundaries
float membraneConsciousnessFlow(vec2 position, float fluidityIndex, float awarenessLevel) {
  // Base membrane oscillation
  float membraneBase = sin(position.x * 8.0 + position.y * 6.0) * 0.1;
  
  // Consciousness-driven membrane flexibility
  float consciousnessFlex = awarenessLevel * fluidityIndex * 0.2;
  
  // Organic membrane breathing
  float membraneBreath = sin(position.x * 3.0 + position.y * 4.0) * 0.05;
  
  return membraneBase + consciousnessFlex + membraneBreath;
}

// Advanced consciousness breathing patterns
float consciousnessMemoryBreathing(float time, float phase, float memoryIntensity) {
  // Primary consciousness rhythm
  float primaryRhythm = sin(time * 0.03 + phase) * 0.5;
  
  // Memory echo patterns
  float memoryEcho = sin(time * 0.08 + phase * 1.7) * 0.3 * memoryIntensity;
  
  // Deep awareness pulse
  float awarenessePulse = sin(time * 0.015 + phase * 0.5) * 0.2;
  
  return primaryRhythm + memoryEcho + awarenessePulse;
}`,bs=`
// Convert screen coordinates to polar coordinates for radial flow
vec2 toPolar(vec2 uv) {
  vec2 centered = uv - 0.5;
  float angle = atan(centered.y, centered.x);
  float radius = length(centered);
  return vec2(angle, radius);
}

// Convert polar coordinates back to cartesian
vec2 fromPolar(vec2 polar) {
  float angle = polar.x;
  float radius = polar.y;
  return vec2(cos(angle) * radius, sin(angle) * radius) + 0.5;
}

// Signed distance field for a circle
float circleSDF(vec2 uv, vec2 center, float radius) {
  return length(uv - center) - radius;
}

// Smooth minimum for blending SDFs
float smin(float a, float b, float k) {
  float h = clamp(0.5 + 0.5 * (b - a) / k, 0.0, 1.0);
  return mix(b, a, h) - k * h * (1.0 - h);
}

// Enhanced multiple bubble corridors with organic consciousness-aware animations
float bubbleCorridors(vec2 uv, float time, float intensity) {
  // ===== ENHANCED PRIMARY BUBBLE APERTURES =====
  // Create 6 main circular apertures arranged in a ring with dynamic bubble count
  float baseBubbleCount = 6.0;
  float dynamicBubbleCount = baseBubbleCount + floor(intensity * 2.0); // 6-8 bubbles based on intensity
  float ringRadius = 0.28 + sin(time * 0.15) * 0.08; // Breathing ring radius (0.20-0.36)
  
  float minBubbleDistance = 2.0; // Track closest bubble distance
  
  // Calculate distance to each bubble position with enhanced organic movement
  for(float i = 0.0; i < dynamicBubbleCount; i += 1.0) {
    // Enhanced organic rotation with breathing rhythm
    float bubbleAngle = (i / dynamicBubbleCount) * 2.0 * 3.14159 + time * 0.08;
    
    // Add organic spiral motion for consciousness effect
    float spiralOffset = sin(time * 0.25 + i * 0.6) * 0.15;
    float dynamicRingRadius = ringRadius + spiralOffset;
    
    // Bubble center position with enhanced organic movement
    vec2 bubbleCenter = vec2(0.5) + vec2(
      cos(bubbleAngle) * dynamicRingRadius,
      sin(bubbleAngle) * dynamicRingRadius
    );
    
    // Enhanced breathing/pulsing animation with multi-frequency modulation
    float breathingPhase = sin(time * 0.6 + i * 0.8) * 0.04;
    float organicPhase = sin(time * 0.35 + i * 1.2) * 0.03;
    float consciousnessPhase = sin(time * 0.18 + i * 0.5) * 0.025;
    
    vec2 organicMovement = vec2(
      sin(time * 0.3 + i * 0.7) * (breathingPhase + organicPhase),
      cos(time * 0.4 + i * 0.9) * (breathingPhase + consciousnessPhase)
    );
    
    vec2 animatedCenter = bubbleCenter + organicMovement;
    
    // Calculate distance from current pixel to this bubble center
    float distanceToBubble = length(uv - animatedCenter);
    minBubbleDistance = min(minBubbleDistance, distanceToBubble);
  }
  
  // ===== ENHANCED BUBBLE APERTURE SIZING =====
  // Enhanced bubble size with multi-wave expansion patterns
  float baseBubbleSize = 0.08 * intensity;
  float primaryPulse = sin(time * 1.5) * 0.35;
  float organicPulse = sin(time * 0.8) * 0.25;
  float consciousnessPulse = sin(time * 2.2) * 0.15;
  
  float expandedBubbleSize = baseBubbleSize * (1.0 + primaryPulse + organicPulse + consciousnessPulse);
  
  // Create clean circular apertures with enhanced soft edges
  float primaryBubbleMask = 1.0 - smoothstep(expandedBubbleSize * 0.6, expandedBubbleSize * 1.1, minBubbleDistance);
  
  // ===== ENHANCED SECONDARY BUBBLE LAYER =====
  // Add smaller secondary bubbles with organic movement
  float secondaryBubbleCount = 4.0 + floor(intensity * 1.0); // 4-5 secondary bubbles
  float baseSecondaryRadius = 0.15;
  float secondaryRingRadius = baseSecondaryRadius * (1.0 + sin(time * 0.12) * 0.3);
  float minSecondaryDistance = 2.0;
  
  for(float i = 0.0; i < secondaryBubbleCount; i += 1.0) {
    // Counter-rotating secondary bubbles with organic offset
    float secondaryAngle = (i / secondaryBubbleCount) * 2.0 * 3.14159 - time * 0.15 + 1.57;
    
    // Add organic wobble to secondary bubble positions
    float wobbleX = sin(time * 0.45 + i * 1.1) * 0.02;
    float wobbleY = cos(time * 0.55 + i * 0.8) * 0.02;
    
    vec2 secondaryCenter = vec2(0.5) + vec2(
      cos(secondaryAngle) * secondaryRingRadius + wobbleX,
      sin(secondaryAngle) * secondaryRingRadius + wobbleY
    );
    
    float distanceToSecondary = length(uv - secondaryCenter);
    minSecondaryDistance = min(minSecondaryDistance, distanceToSecondary);
  }
  
  float secondaryBubbleSize = baseBubbleSize * 0.5 * (1.0 + sin(time * 1.8) * 0.3);
  float secondaryBubbleMask = 1.0 - smoothstep(secondaryBubbleSize * 0.6, secondaryBubbleSize * 1.0, minSecondaryDistance);
  secondaryBubbleMask *= 0.75; // Make secondary bubbles dimmer for depth
  
  // ===== ENHANCED CENTER SPOTLIGHT BUBBLE =====
  // Enhanced central bubble with complex pulsing patterns
  float centerDistance = length(uv - vec2(0.5));
  float centerPrimaryPulse = sin(time * 2.0) * 0.4;
  float centerSecondaryPulse = sin(time * 3.5) * 0.2;
  float centerBreathingPulse = sin(time * 0.6) * 0.3;
  
  float centerBubbleSize = 0.06 * intensity * (1.0 + centerPrimaryPulse + centerSecondaryPulse + centerBreathingPulse);
  float centerBubbleMask = 1.0 - smoothstep(centerBubbleSize * 0.4, centerBubbleSize * 0.9, centerDistance);
  
  // ===== ENHANCED COMBINATION AND BLENDING =====
  // Use smooth maximum for organic blending instead of hard max
  float corridorMask = primaryBubbleMask;
  corridorMask = max(corridorMask, secondaryBubbleMask * 0.9);
  corridorMask = max(corridorMask, centerBubbleMask * 1.1); // Center bubble slightly stronger
  
  // Enhanced radial falloff with organic variation
  vec2 center = uv - vec2(0.5);
  float radialDistance = length(center);
  float organicVariation = sin(time * 0.3 + radialDistance * 8.0) * 0.05;
  float radialFalloff = 1.0 - smoothstep(0.0, 0.65 + organicVariation, radialDistance);
  corridorMask *= radialFalloff;
  
  // Enhanced organic breathing pattern with consciousness harmonics
  float primaryBreathing = sin(time * 0.4) * 0.15;
  float secondaryBreathing = sin(time * 0.25) * 0.08;
  float consciousnessBreathing = sin(time * 0.6) * 0.05;
  float breathingCycle = 0.85 + primaryBreathing + secondaryBreathing + consciousnessBreathing;
  corridorMask *= breathingCycle;
  
  // Add subtle noise variation for organic consciousness texture
  float noisePattern = sin(radialDistance * 12.0 + time * 0.5) * cos(radialDistance * 8.0 - time * 0.3) * 0.03;
  corridorMask += noisePattern * intensity * 0.5;
  
  return clamp(corridorMask, 0.0, 1.0);
}

// Perspective depth calculation for inward flow
float calculatePerspectiveDepth(vec2 uv, float time, float flowStrength) {
  vec2 polar = toPolar(uv);
  float radius = polar.y;
  
  // Create perspective tunnel effect
  float depth = 1.0 - radius;
  depth = pow(depth, 2.2); // Gamma correction for natural falloff
  
  // Add inward flow animation
  float flowPhase = time * flowStrength + radius * 8.0;
  depth += sin(flowPhase) * 0.05 * (1.0 - radius);
  
  return clamp(depth, 0.0, 1.0);
}

// Dynamic aperture sizing based on music response
float musicResponsiveAperture(float baseMask, float beatIntensity, float bassResponse) {
  // Beat response expands apertures
  float beatExpansion = 1.0 + beatIntensity * 0.3;
  
  // Bass response adds pulsing
  float bassPulse = sin(bassResponse * 10.0) * 0.1;
  
  // Apply modulations
  float responsiveMask = baseMask * beatExpansion + bassPulse;
  
  return clamp(responsiveMask, 0.0, 1.0);
}

// ===================================================================
// DUNGEON CORRIDOR TUNNEL FUNCTIONS
// ===================================================================

// Signed distance field for rounded rectangle (corridor tunnel shape)
float roundedRectangleSDF(vec2 uv, vec2 center, vec2 size, float radius) {
  vec2 d = abs(uv - center) - size;
  return length(max(d, 0.0)) + min(max(d.x, d.y), 0.0) - radius;
}

// Apply perspective transformation for 3D tunnel illusion
vec2 perspectiveTunnelTransform(vec2 uv, float depth, float focalLength) {
  // Transform to centered coordinates
  vec2 centered = uv - 0.5;
  
  // Apply perspective projection with vanishing point at center
  float perspectiveFactor = focalLength / (focalLength + depth);
  vec2 perspective = centered * perspectiveFactor;
  
  // Return to UV space
  return perspective + 0.5;
}

// Calculate surface normal from SDF for lighting
vec2 tunnelNormalFromSDF(vec2 uv, vec2 center, vec2 size, float radius) {
  const float epsilon = 0.001;
  
  float centerSDF = roundedRectangleSDF(uv, center, size, radius);
  float rightSDF = roundedRectangleSDF(uv + vec2(epsilon, 0.0), center, size, radius);
  float upSDF = roundedRectangleSDF(uv + vec2(0.0, epsilon), center, size, radius);
  
  return normalize(vec2(rightSDF - centerSDF, upSDF - centerSDF));
}

// Advanced lighting system for dungeon corridors
vec3 calculateTunnelLighting(vec2 uv, float tunnelMask, vec2 normal, float depth, float time, float intensity) {
  // ===== AMBIENT SHADOW LAYER =====
  // Create dark base for corridor walls
  float ambientShadow = 0.15; // Base darkness level
  vec3 shadowColor = vec3(0.05, 0.08, 0.12); // Cool blue-gray shadows
  
  // ===== EDGE HIGHLIGHT LAYER =====
  // Bright rim lighting along corridor edges using surface normals
  float edgeIntensity = 1.0 - smoothstep(0.0, 0.3, tunnelMask);
  float edgeHighlight = pow(edgeIntensity, 2.0) * 0.8;
  
  // Edge lighting color shifts with music (warmer for high energy)
  vec3 edgeLightColor = mix(
    vec3(0.4, 0.5, 0.8), // Cool blue edge light
    vec3(0.8, 0.6, 0.3), // Warm orange edge light
    intensity * 0.7
  );
  
  // ===== END LIGHT SOURCE =====
  // Dynamic light at tunnel end that pulses with music
  float distanceFromCenter = length(uv - vec2(0.5));
  float endLightFalloff = 1.0 / (1.0 + distanceFromCenter * 4.0); // Inverse square falloff
  
  // Music-responsive light intensity with breathing effect
  float lightPulse = sin(time * 2.0) * 0.3 + 0.7;
  float endLightIntensity = intensity * lightPulse * endLightFalloff;
  
  // End light color temperature (cooler when distant, warmer when close)
  vec3 endLightColor = mix(
    vec3(0.3, 0.4, 0.9), // Cool distant light
    vec3(0.9, 0.7, 0.4), // Warm close light  
    endLightIntensity
  );
  
  // ===== FRESNEL EFFECT =====
  // Edge lighting intensity based on viewing angle
  vec2 viewDirection = normalize(uv - vec2(0.5));
  float fresnel = pow(1.0 - abs(dot(normal, viewDirection)), 2.0);
  
  // ===== COMBINE LIGHTING LAYERS =====
  vec3 ambientLayer = shadowColor * ambientShadow;
  vec3 edgeLayer = edgeLightColor * edgeHighlight * fresnel;
  vec3 endLayer = endLightColor * endLightIntensity * tunnelMask;
  
  // Apply depth-based attenuation
  float depthAttenuation = 1.0 - smoothstep(0.0, 1.0, depth);
  
  return (ambientLayer + edgeLayer + endLayer) * depthAttenuation;
}

// Create multiple dungeon corridor tunnels with realistic lighting
float dungeonCorridorTunnels(vec2 uv, float time, float intensity) {
  // ===== MAIN CORRIDOR TUNNELS =====
  float corridorCount = 4.0;
  float minCorridorDistance = 2.0;
  
  for(float i = 0.0; i < corridorCount; i += 1.0) {
    float corridorAngle = (i / corridorCount) * 2.0 * 3.14159 + time * 0.05;
    
    // Corridor center position with slight offset for organic feel
    vec2 corridorOffset = vec2(
      cos(corridorAngle) * 0.25,
      sin(corridorAngle) * 0.25
    );
    vec2 corridorCenter = vec2(0.5) + corridorOffset;
    
    // Apply perspective transformation for depth illusion
    float depth = 0.3 + sin(time * 0.3 + i) * 0.1;
    vec2 perspectiveUV = perspectiveTunnelTransform(uv, depth, 2.0);
    
    // Create elongated corridor tunnel shape
    vec2 corridorSize = vec2(0.15, 0.04) * (1.0 + intensity * 0.3); // Width varies with music
    float cornerRadius = 0.01;
    
    // Calculate distance to this corridor tunnel
    float corridorDistance = roundedRectangleSDF(perspectiveUV, corridorCenter, corridorSize, cornerRadius);
    minCorridorDistance = min(minCorridorDistance, corridorDistance);
  }
  
  // ===== SECONDARY TUNNEL LAYER =====
  // Add smaller secondary tunnels for depth complexity
  float secondaryCount = 2.0;
  float minSecondaryDistance = 2.0;
  
  for(float i = 0.0; i < secondaryCount; i += 1.0) {
    float secondaryAngle = (i / secondaryCount) * 2.0 * 3.14159 + time * 0.08 + 1.57;
    
    vec2 secondaryOffset = vec2(
      cos(secondaryAngle) * 0.15,
      sin(secondaryAngle) * 0.15  
    );
    vec2 secondaryCenter = vec2(0.5) + secondaryOffset;
    
    // Deeper perspective for secondary tunnels
    float secondaryDepth = 0.5 + sin(time * 0.2 + i) * 0.1;
    vec2 secondaryPerspectiveUV = perspectiveTunnelTransform(uv, secondaryDepth, 2.5);
    
    vec2 secondarySize = vec2(0.08, 0.025) * (1.0 + intensity * 0.2);
    float secondaryDistance = roundedRectangleSDF(secondaryPerspectiveUV, secondaryCenter, secondarySize, 0.005);
    minSecondaryDistance = min(minSecondaryDistance, secondaryDistance);
  }
  
  // ===== COMBINE TUNNEL LAYERS =====
  float primaryMask = 1.0 - smoothstep(0.0, 0.02, minCorridorDistance);
  float secondaryMask = 1.0 - smoothstep(0.0, 0.015, minSecondaryDistance);
  secondaryMask *= 0.7; // Dimmer secondary tunnels
  
  float combinedMask = max(primaryMask, secondaryMask);
  
  // ===== RADIAL FALLOFF FOR FOCUS =====
  vec2 center = uv - vec2(0.5);
  float radialDistance = length(center);
  float radialFalloff = 1.0 - smoothstep(0.2, 0.8, radialDistance);
  
  // ===== ORGANIC BREATHING PATTERN =====
  float breathingCycle = 0.9 + sin(time * 0.4) * 0.1;
  
  return clamp(combinedMask * radialFalloff * breathingCycle, 0.0, 1.0);
}

// Enhanced corridor gradient reveal with advanced dual-layer blending
vec4 corridorGradientReveal(vec2 uv, sampler2D gradientTex, float corridorMask, float time, float intensity) {
  // ===== ENHANCED BASE LAYER: Musical flow with consciousness awareness =====
  vec2 baseFlowUV = uv;
  vec2 flowDirection = normalize(vec2(1.0, 0.0));
  
  // Enhanced musical flow with multi-frequency modulation
  #ifdef HAS_FLOW_UNIFORMS
    flowDirection = normalize(u_musicalFlow.xy + vec2(0.001, 0.0));
  #endif
  
  // Multi-layered flow animation with consciousness patterns
  float primaryFlow = sin(time * 0.1) * 0.02;
  float organicFlow = sin(time * 0.07) * 0.015;
  float consciousnessFlow = sin(time * 0.13) * 0.008;
  
  baseFlowUV += flowDirection * (primaryFlow + organicFlow + consciousnessFlow);
  vec4 baseGradient = texture(gradientTex, vec2(baseFlowUV.x, 0.5));
  
  // Enhanced base layer with depth awareness
  vec2 polar = toPolar(uv);
  float baseDepthModulation = 1.0 + polar.y * 0.2; // Subtle depth variation
  baseGradient.rgb *= baseDepthModulation;
  
  // ===== ENHANCED CORRIDOR LAYER: Multi-dimensional inward flow =====
  float angle = polar.x;
  float radius = polar.y;
  
  // Advanced inward flow with multi-phase animation
  float primaryInwardPhase = time * 0.15 + radius * 6.0;
  float secondaryInwardPhase = time * 0.08 + radius * 4.5;
  float consciousnessInwardPhase = time * 0.22 + radius * 8.0;
  
  // Multi-layered inward flow combining multiple patterns
  float primaryInwardFlow = radius - (sin(primaryInwardPhase) * 0.1);
  float secondaryInwardFlow = radius - (cos(secondaryInwardPhase) * 0.06);
  float consciousnessInwardFlow = radius - (sin(consciousnessInwardPhase) * 0.04);
  
  float combinedInwardFlow = mix(
    mix(primaryInwardFlow, secondaryInwardFlow, 0.3),
    consciousnessInwardFlow, 0.2
  );
  
  // Enhanced gradient sampling with dual-layer coordination
  vec2 corridorFlowUV = vec2(
    fract(angle / (2.0 * 3.14159) + time * 0.02), // Slow rotation for organic feel
    clamp(combinedInwardFlow, 0.0, 1.0)
  );
  vec4 corridorGradient = texture(gradientTex, corridorFlowUV);
  
  // ===== ADVANCED DEPTH AND PERSPECTIVE =====
  float depth = calculatePerspectiveDepth(uv, time, intensity);
  
  // Enhanced tunnel brightness with organic variation
  float organicBrightnessVariation = sin(angle * 3.0 + time * 0.3) * 0.1;
  float tunnelBrightness = 1.0 + depth * 0.9 + organicBrightnessVariation;
  corridorGradient.rgb *= tunnelBrightness;
  
  // Advanced color shift with consciousness-aware color temperature
  vec3 warmShift = vec3(1.15, 1.05, 0.85); // Warm center
  vec3 coolShift = vec3(0.9, 1.0, 1.1);    // Cool edges
  vec3 colorTemperature = mix(coolShift, warmShift, depth);
  corridorGradient.rgb = mix(corridorGradient.rgb, corridorGradient.rgb * colorTemperature, depth * 0.4);
  
  // ===== ENHANCED DUAL-LAYER BLENDING =====
  // Multi-stage aperture masking for organic blending
  float softApertureMask = smoothstep(0.2, 0.8, corridorMask);
  float sharpApertureMask = smoothstep(0.4, 0.6, corridorMask);
  float organicApertureMask = mix(softApertureMask, sharpApertureMask, 0.6);
  
  // Enhanced blending with consciousness-aware mixing
  float consciousnessBlendFactor = 0.7 + sin(time * 0.4 + radius * 4.0) * 0.2;
  float dynamicIntensity = intensity * consciousnessBlendFactor;
  
  // Primary blend: base and corridor layers
  vec4 primaryBlend = mix(baseGradient, corridorGradient, organicApertureMask * dynamicIntensity);
  
  // ===== ADVANCED APERTURE EFFECTS =====
  // Enhanced rim lighting with organic variation 
  float rimLightBase = corridorMask * (1.0 - organicApertureMask);
  float rimLightVariation = sin(angle * 4.0 + time * 0.5) * 0.3 + 0.7;
  float enhancedRimLight = rimLightBase * rimLightVariation * 0.6;
  
  // Aperture glow effect for depth illusion
  float apertureGlow = softApertureMask * (1.0 - sharpApertureMask) * 0.4;
  vec3 glowColor = corridorGradient.rgb * 1.2;
  
  // ===== CONSCIOUSNESS-AWARE COLOR HARMONIZATION =====
  // Harmonize colors between layers for organic consciousness effect
  vec3 harmonizedColor = mix(
    primaryBlend.rgb,
    (primaryBlend.rgb + corridorGradient.rgb) * 0.5,
    organicApertureMask * 0.3
  );
  
  // Final composition with enhanced rim and glow effects
  vec4 finalColor = vec4(harmonizedColor, primaryBlend.a);
  finalColor.rgb += vec3(enhancedRimLight) * dynamicIntensity;
  finalColor.rgb += glowColor * apertureGlow * dynamicIntensity;
  
  // Organic breathing effect for consciousness integration
  float breathingCycle = 0.95 + sin(time * 0.3) * 0.05;
  finalColor.rgb *= breathingCycle;
  
  return finalColor;
}

// Advanced dungeon corridor gradient reveal with realistic lighting
vec4 dungeonCorridorGradientReveal(vec2 uv, sampler2D gradientTex, float corridorMask, float time, float intensity) {
  // ===== BASE LAYER: Dark stone/metal corridor walls =====
  vec4 baseWallColor = vec4(0.1, 0.12, 0.15, 1.0); // Dark stone base
  
  // ===== CORRIDOR TUNNEL CALCULATION =====
  // Use dungeon corridor tunnels instead of simple bubbles
  float tunnelMask = dungeonCorridorTunnels(uv, time, intensity);
  
  // ===== LIGHTING CALCULATION =====
  // Calculate lighting for tunnel areas
  vec2 tunnelCenter = vec2(0.5); // Simplified center for normal calculation
  vec2 tunnelSize = vec2(0.15, 0.04);
  vec2 surfaceNormal = tunnelNormalFromSDF(uv, tunnelCenter, tunnelSize, 0.01);
  
  float depth = length(uv - vec2(0.5)) * 0.5; // Distance-based depth
  vec3 tunnelLighting = calculateTunnelLighting(uv, tunnelMask, surfaceNormal, depth, time, intensity);
  
  // ===== CORRIDOR LAYER: Inward flowing magical light =====
  // Convert to polar coordinates for inward flow calculation
  vec2 polar = toPolar(uv);
  float angle = polar.x;
  float radius = polar.y;
  
  // Create magical inward flow animation - light streams toward center
  float magicalFlowPhase = time * 0.2 + radius * 8.0; // Faster flow for magical effect
  float inwardFlow = radius - (sin(magicalFlowPhase) * 0.15); // More dramatic flow
  
  // Sample gradient using inward flow for magical light colors
  vec2 corridorFlowUV = vec2(
    angle / (2.0 * 3.14159), // Normalize angle for gradient sampling
    clamp(inwardFlow, 0.0, 1.0) // Use inward flow for magical color variation
  );
  vec4 magicalLightGradient = texture(gradientTex, corridorFlowUV);
  
  // ===== ENHANCE MAGICAL LIGHT WITH MUSIC RESPONSIVENESS =====
  // Enhance magical light colors based on music intensity
  magicalLightGradient.rgb *= 1.5 + intensity * 0.8; // Brighter with music
  
  // Add magical shimmer effect
  float shimmerPhase = time * 4.0 + uv.x * 10.0 + uv.y * 8.0;
  float shimmer = sin(shimmerPhase) * 0.1 + 0.9;
  magicalLightGradient.rgb *= shimmer;
  
  // ===== DEPTH AND PERSPECTIVE EFFECTS =====
  float perspectiveDepth = calculatePerspectiveDepth(uv, time, intensity * 1.2);
  
  // Enhance magical light with depth - brighter toward tunnel end
  float tunnelEndBrightness = 1.0 + perspectiveDepth * 1.5;
  magicalLightGradient.rgb *= tunnelEndBrightness;
  
  // ===== CORRIDOR WALL TEXTURING =====
  // Add stone/metal texture to walls using noise-like patterns
  float wallTexturePhase = uv.x * 20.0 + uv.y * 15.0;
  float wallTexture = sin(wallTexturePhase) * 0.1 + 0.9;
  baseWallColor.rgb *= wallTexture;
  
  // ===== ADVANCED APERTURE BLENDING =====
  // Smooth tunnel aperture with realistic falloff
  float apertureMask = smoothstep(0.1, 0.8, tunnelMask);
  
  // ===== LIGHTING INTEGRATION =====
  // Apply calculated lighting to both wall and magical light
  vec4 litWallColor = baseWallColor;
  litWallColor.rgb += tunnelLighting; // Add ambient shadows, edge highlights, end illumination
  
  // Blend wall color with magical light streaming through tunnels
  vec4 finalColor = mix(litWallColor, magicalLightGradient, apertureMask * intensity);
  
  // ===== RIM LIGHTING FOR DEPTH ILLUSION =====
  // Enhanced rim lighting around tunnel apertures
  float rimIntensity = tunnelMask * (1.0 - apertureMask) * 0.8;
  vec3 rimColor = mix(
    vec3(0.3, 0.4, 0.8), // Cool rim light
    vec3(0.8, 0.5, 0.2), // Warm rim light
    intensity
  );
  finalColor.rgb += rimColor * rimIntensity;
  
  // ===== ATMOSPHERIC PERSPECTIVE =====
  // Add slight fog/haze effect for distance illusion
  float atmosphericHaze = depth * 0.2;
  vec3 hazeColor = vec3(0.15, 0.18, 0.25);
  finalColor.rgb = mix(finalColor.rgb, hazeColor, atmosphericHaze);
  
  return finalColor;
}`,ys=`
// Time and resolution (universal)
uniform float u_time;
uniform vec2 u_resolution;

// Enhanced consciousness field uniforms
uniform float u_rhythmicPulse;
uniform vec2 u_musicalFlow;
uniform float u_energyResonance;
uniform float u_breathingCycle;
uniform float u_membraneFluidityIndex;

// Advanced consciousness control uniforms
uniform float u_consciousnessLevel;        // 0-1 current consciousness intensity
uniform float u_awarenessLevel;           // 0-1 current awareness depth
uniform float u_emotionalIntensity;       // 0-1 emotional resonance strength
uniform float u_memoryIntensity;          // 0-1 consciousness memory patterns
uniform vec2 u_temporalFlowDirection;     // Year 3000 temporal stream direction
uniform float u_consciousnessTemperature; // Color temperature shift from consciousness

// Enhanced music sync uniforms
uniform float u_musicEnergy;
uniform float u_musicValence;
uniform float u_beatIntensity;
uniform float u_bassResponse;
uniform float u_musicalConsciousnessSync; // Music-consciousness synchronization level
uniform float u_genreConsciousnessShift;  // Genre-specific consciousness adjustments

// Corridor-specific uniforms
uniform float u_corridorIntensity;
uniform float u_corridorFlowStrength;
uniform float u_corridorDepthEffect;
uniform float u_corridorBubbleScale;

// Dungeon corridor uniforms
uniform float u_dungeonEnabled;
uniform float u_tunnelWidth;
uniform float u_lightingIntensity;
uniform float u_atmosphericHaze;
uniform vec3 u_wallColor;`,Oe=class{static buildFragmentShader(e){let{precision:t="precision mediump float;",additionalUniforms:i="",additionalFunctions:n="",mainShaderLogic:r,includeNoiseFunctions:a=!0,includeConsciousnessFunctions:s=!0,includeCorridorFunctions:o=!1}=e,l=`#version 300 es
${t}

`;return l+=ys+`

`,i&&(l+=i+`

`),l+=`out vec4 fragColor;

`,a&&(l+=ps+`

`),s&&(l+=fs+`

`),o&&(l+=bs+`

`),n&&(l+=n+`

`),l+=`void main() {
`,l+=`  vec2 uv = gl_FragCoord.xy / u_resolution.xy;

`,l+=r,l+=`
}`,l}static getStandardUniformNames(){return["u_time","u_resolution","u_rhythmicPulse","u_musicalFlow","u_energyResonance","u_breathingCycle","u_membraneFluidityIndex","u_consciousnessLevel","u_awarenessLevel","u_emotionalIntensity","u_memoryIntensity","u_temporalFlowDirection","u_consciousnessTemperature","u_musicEnergy","u_musicValence","u_beatIntensity","u_bassResponse","u_musicalConsciousnessSync","u_genreConsciousnessShift"]}static getWebGLUniformNames(){return[...this.getStandardUniformNames(),"u_gradientTex","u_flowStrength","u_noiseScale","u_colorIntensity","u_patternScale","u_animationSpeed"]}static getLiquidUniformNames(){return[...this.getStandardUniformNames(),"u_gradientTex","u_flowStrength","u_noiseScale","u_liquidPhase","u_breathingIntensity","u_auroraFlow","u_flowDirection","u_liquidTurbulence","u_consciousnessDepth","u_waveY","u_waveHeight","u_waveOffset","u_blurExp","u_blurMax"]}static getCorridorUniformNames(){return["u_time","u_resolution","u_gradientTex","u_rhythmicPulse","u_musicalFlow","u_energyResonance","u_breathingCycle","u_membraneFluidityIndex","u_musicEnergy","u_musicValence","u_beatIntensity","u_bassResponse","u_corridorIntensity","u_corridorFlowStrength","u_corridorDepthEffect","u_corridorBubbleScale"]}static getDungeonCorridorUniformNames(){return[...this.getCorridorUniformNames(),"u_dungeonEnabled","u_tunnelWidth","u_lightingIntensity","u_atmosphericHaze","u_wallColor"]}},X=class{static musicFlowLogic(){return`
  // Calculate enhanced music-driven flow
  vec2 flowDirection = calculateMusicalFlow(vec2(1.0, 0.5), u_musicalFlow, 0.5);
  float flowStrength = rhythmicPulseModulation(0.5, u_rhythmicPulse, 0.3);
  
  // Add temporal flow patterns for Year 3000 effects
  vec2 temporalFlow = temporalFlowDirection(uv, u_time, u_temporalFlowDirection);
  flowDirection += temporalFlow;
  
  // Apply enhanced breathing modulation with emotional resonance
  float breathingMod = deepConsciousnessBreathing(u_time, 0.0, u_emotionalIntensity);
  flowStrength *= (1.0 + breathingMod);
  
  // Apply consciousness field intensity
  float fieldIntensity = consciousnessFieldIntensity(uv, u_time, u_musicEnergy);
  flowStrength *= (0.5 + fieldIntensity * 0.5);`}static audioNoiseSampling(){return`
  // Generate enhanced audio-modulated noise
  vec2 noiseUV = uv + flowDirection * u_time * 0.03;
  
  // Multi-layered consciousness noise patterns
  float noise1 = snoise(noiseUV * 2.0);
  float noise2 = snoise(noiseUV * 4.0) * 0.5;
  float memoryNoise = snoise(noiseUV * 1.5 + u_time * 0.01) * u_memoryIntensity * 0.3;
  
  // Apply consciousness field modulation
  float consciousnessModulation = consciousnessFieldIntensity(noiseUV, u_time, u_musicEnergy);
  
  // Combine noise with enhanced consciousness influence
  float t = (noise1 + noise2 + memoryNoise) * energyResonanceModulation(1.0, u_energyResonance, 0.5, 1.5);
  t *= consciousnessModulation;
  t = clamp(t * 0.5 + 0.5, 0.0, 1.0);`}static consciousnessVignette(){return`
  // Apply enhanced consciousness-aware vignette
  vec2 center = uv - 0.5;
  float breathing = deepConsciousnessBreathing(u_time, u_breathingCycle, u_emotionalIntensity);
  
  // Add membrane consciousness flow for organic boundaries
  float membraneFlow = membraneConsciousnessFlow(uv, u_membraneFluidityIndex, u_awarenessLevel);
  
  // Calculate consciousness-aware vignette with membrane dynamics
  float vignette = (0.9 + breathing + membraneFlow) - dot(center, center) * 0.3;
  
  // Apply awareness resonance to color
  color.rgb = awarenessResonance(color.rgb, u_consciousnessLevel, u_musicEnergy);
  color.rgb *= vignette;`}static musicResponsiveAlpha(){return`
  // Music-responsive alpha modulation
  float musicAlpha = 0.8 + u_beatIntensity * 0.2 + u_bassResponse * 0.1;
  color.a *= musicAlpha;`}static auroraShimmerEffect(){return`
  // Aurora shimmer overlay
  float shimmerPhase = u_time * 3.0 + uv.x * 15.0 + uv.y * 10.0;
  float shimmer = sin(shimmerPhase) * 0.03 + 0.97;
  color.rgb *= shimmer;`}},dr=class{static webglGradientFragment(){return`
  ${X.musicFlowLogic()}
  
  // WebGL-specific gradient sampling
  ${X.audioNoiseSampling()}
  
  // Sample gradient texture
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  
  // Apply consciousness effects
  ${X.consciousnessVignette()}
  ${X.musicResponsiveAlpha()}
  
  fragColor = color;`}static liquidEffectsFragment(){return`
  ${X.musicFlowLogic()}
  
  // Liquid-specific turbulence and phase
  float liquidPhase = u_liquidPhase + u_rhythmicPulse * 0.5;
  vec2 turbulenceUV = uv * u_liquidTurbulence;
  float turbulence = snoise(turbulenceUV + u_time * 0.01);
  
  // Liquid consciousness noise
  vec2 liquidUV = uv + flowDirection * u_time * 0.03;
  liquidUV += vec2(sin(u_time * 0.04 + liquidPhase), cos(u_time * 0.03 + liquidPhase)) * 0.02;
  float liquidNoise = snoise(liquidUV * 2.0 + turbulence * 0.1);
  
  float t = clamp(liquidNoise * 0.5 + 0.5, 0.0, 1.0);
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  
  ${X.consciousnessVignette()}
  ${X.auroraShimmerEffect()}
  ${X.musicResponsiveAlpha()}
  
  fragColor = color;`}static corridorBubbleFragment(){return`
  ${X.musicFlowLogic()}
  
  // Calculate corridor bubble mask
  float corridorMask = bubbleCorridors(uv, u_time, u_corridorIntensity * u_corridorBubbleScale);
  
  // Apply music-responsive aperture modulation
  corridorMask = musicResponsiveAperture(corridorMask, u_beatIntensity, u_bassResponse);
  
  // Generate corridor gradient reveal effect
  vec4 color = corridorGradientReveal(uv, u_gradientTex, corridorMask, u_time, u_corridorIntensity);
  
  // Apply consciousness effects
  ${X.consciousnessVignette()}
  
  // Enhanced music responsiveness for corridor effects
  float corridorMusicAlpha = 0.85 + u_beatIntensity * 0.15 + u_bassResponse * 0.05;
  color.a *= corridorMusicAlpha;
  
  // Apply corridor depth effect for enhanced dimensionality
  float depth = calculatePerspectiveDepth(uv, u_time, u_corridorFlowStrength);
  color.rgb = mix(color.rgb, color.rgb * (1.0 + depth * 0.3), u_corridorDepthEffect);
  
  fragColor = color;`}static dungeonCorridorFragment(){return`
  ${X.musicFlowLogic()}
  
  // Calculate dungeon corridor tunnel mask
  float corridorMask = dungeonCorridorTunnels(uv, u_time, u_corridorIntensity * u_corridorBubbleScale);
  
  // Apply music-responsive corridor modulation  
  corridorMask = musicResponsiveAperture(corridorMask, u_beatIntensity, u_bassResponse);
  
  // Generate advanced dungeon corridor gradient reveal effect with realistic lighting
  vec4 color = dungeonCorridorGradientReveal(uv, u_gradientTex, corridorMask, u_time, u_corridorIntensity);
  
  // Apply consciousness effects for organic integration
  ${X.consciousnessVignette()}
  
  // Enhanced music responsiveness for dungeon atmosphere
  float dungeonMusicAlpha = 0.9 + u_beatIntensity * 0.1 + u_bassResponse * 0.05;
  color.a *= dungeonMusicAlpha;
  
  // Apply corridor depth effect for enhanced dimensionality
  float depth = calculatePerspectiveDepth(uv, u_time, u_corridorFlowStrength);
  color.rgb = mix(color.rgb, color.rgb * (1.0 + depth * 0.4), u_corridorDepthEffect);
  
  // Add subtle magical shimmer for mystical atmosphere
  float magicalShimmer = sin(u_time * 5.0 + uv.x * 12.0 + uv.y * 8.0) * 0.05 + 0.95;
  color.rgb *= magicalShimmer;
  
  fragColor = color;`}static advancedConsciousnessFieldFragment(){return`
  ${X.musicFlowLogic()}
  
  // Calculate multi-dimensional consciousness field
  float consciousnessField = consciousnessFieldIntensity(uv, u_time, u_musicEnergy);
  
  // Apply temporal flow effects for Year 3000 streaming
  vec2 temporalUV = uv + temporalFlowDirection(uv, u_time, u_temporalFlowDirection);
  
  // Enhanced consciousness noise sampling with memory patterns
  ${X.audioNoiseSampling()}
  
  // Sample gradient with consciousness field modulation
  vec4 color = texture(u_gradientTex, vec2(t * consciousnessField, 0.5));
  
  // Apply awareness resonance for consciousness-aware color
  color.rgb = awarenessResonance(color.rgb, u_consciousnessLevel, u_musicEnergy);
  
  // Enhanced membrane consciousness effects
  float membraneEffect = membraneConsciousnessFlow(temporalUV, u_membraneFluidityIndex, u_awarenessLevel);
  color.rgb *= (1.0 + membraneEffect * 0.3);
  
  // Apply consciousness memory breathing
  float memoryBreathing = consciousnessMemoryBreathing(u_time, u_breathingCycle, u_memoryIntensity);
  color.a *= (0.8 + memoryBreathing * 0.2 + u_beatIntensity * 0.1);
  
  // Enhanced consciousness vignette
  ${X.consciousnessVignette()}
  
  fragColor = color;`}static membraneConsciousnessDynamicsFragment(){return`
  ${X.musicFlowLogic()}
  
  // Calculate membrane consciousness position with flow
  vec2 membraneUV = uv;
  membraneUV += temporalFlowDirection(uv, u_time, u_temporalFlowDirection);
  
  // Apply membrane consciousness flow for organic boundaries
  float membraneFlow = membraneConsciousnessFlow(membraneUV, u_membraneFluidityIndex, u_awarenessLevel);
  membraneUV += vec2(membraneFlow * 0.02);
  
  // Enhanced noise sampling with membrane distortion
  vec2 noiseUV = membraneUV + flowDirection * u_time * 0.03;
  float membraneNoise = snoise(noiseUV * 3.0 + membraneFlow);
  float consciousnessNoise = snoise(noiseUV * 1.5) * u_consciousnessLevel;
  
  // Combine membrane and consciousness noise
  float t = (membraneNoise * 0.6 + consciousnessNoise * 0.4) * 0.5 + 0.5;
  t = clamp(t, 0.0, 1.0);
  
  // Sample gradient with membrane consciousness modulation
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  
  // Apply consciousness field influence to membrane
  float fieldInfluence = consciousnessFieldIntensity(membraneUV, u_time, u_musicEnergy);
  color.rgb = awarenessResonance(color.rgb, fieldInfluence, u_musicEnergy);
  
  // Enhanced membrane breathing with emotional resonance
  float membraneBreathing = deepConsciousnessBreathing(u_time, u_breathingCycle, u_emotionalIntensity);
  color.rgb *= (0.9 + membraneBreathing * 0.2 + membraneFlow * 0.1);
  
  // Musical consciousness synchronization
  color.a *= (0.85 + u_musicalConsciousnessSync * 0.15 + u_beatIntensity * 0.1);
  
  // Apply enhanced vignette with membrane dynamics
  ${X.consciousnessVignette()}
  
  fragColor = color;`}},hr=class{static generateOptimizedShader(e,t){switch(t){case"high":return e;case"medium":return e.replace(/snoise\(.*?\)/g,"snoise($1)").replace(/\* 0\.0[1-9]/g,"* 0.02");case"low":return e.replace(/snoise\(.*?\) \* 0\.[0-9]+/g,"0.5").replace(/sin\(.*?\) \* 0\.[0-9]+/g,"0.0");default:return e}}static calculateShaderComplexity(e){let t=0;return t+=(e.match(/snoise/g)||[]).length*10,t+=(e.match(/sin|cos|tan/g)||[]).length*2,t+=(e.match(/texture/g)||[]).length*3,t+=(e.match(/mix|smoothstep/g)||[]).length*1,t}static generateFallbackShader(){return Oe.buildFragmentShader({includeNoiseFunctions:!1,includeConsciousnessFunctions:!1,additionalUniforms:"uniform sampler2D u_gradientTex;",mainShaderLogic:`
  // Minimal fallback consciousness shader
  float t = uv.x + sin(u_time * 0.5 + u_rhythmicPulse) * 0.1;
  t = clamp(t, 0.0, 1.0);
  
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  color.a *= 0.8 + u_beatIntensity * 0.2;
  
  fragColor = color;`})}},gr={Template:Oe,VERTEX_SHADER:kc,NOISE_FUNCTIONS:ps,CONSCIOUSNESS_FUNCTIONS:fs,CORRIDOR_FUNCTIONS:bs,STANDARD_UNIFORMS:ys,LogicPatterns:X,Fragments:dr,Optimization:hr,AdvancedEffects:{CONSCIOUSNESS_FIELD_PATTERNS:["consciousnessFieldIntensity","awarenessResonance","temporalFlowDirection","membraneConsciousnessFlow","consciousnessMemoryBreathing"],YEAR_3000_PATTERNS:["temporalFlowDirection","consciousnessMemoryBreathing","deepConsciousnessBreathing"],MEMBRANE_DYNAMICS:["membraneConsciousnessFlow","membraneFluidityEffect"]}}});var Dc,Lc,Dt,vs=b(()=>{"use strict";U();$();D();ue();R();Ct();de();Ss();Dc=Oe.buildFragmentShader({additionalUniforms:`
// WebGL-specific uniforms
uniform sampler2D u_gradientTex;
uniform float u_flowStrength;
uniform float u_noiseScale;
uniform float u_colorIntensity;
uniform float u_patternScale;
uniform float u_animationSpeed;

// Wave stack uniforms
uniform float u_waveY[2];
uniform float u_waveHeight[2];
uniform float u_waveOffset[2];
uniform float u_blurExp;
uniform float u_blurMax;`,additionalFunctions:`
// Octave noise for richer detail
float octaveNoise(vec2 uv, float octaves, float persistence, float scale) {
  float value = 0.0;
  float amplitude = 1.0;
  float frequency = scale;
  float maxValue = 0.0;

  for(float i = 0.0; i < octaves; i++) {
    value += snoise(uv * frequency) * amplitude;
    maxValue += amplitude;
    amplitude *= persistence;
    frequency *= 2.0;
  }

  return value / maxValue;
}

// Wave alpha calculation
float waveAlpha(vec2 uv, int waveIndex) {
  float y = uv.y;
  float waveCenter = u_waveY[waveIndex];
  float waveHeight = u_waveHeight[waveIndex];

  float distance = abs(y - waveCenter);
  return 1.0 - smoothstep(0.0, waveHeight * 0.5, distance);
}

// Dynamic blur calculation
float calculateBlur(vec2 uv) {
  vec2 center = vec2(0.5, 0.5);
  float distance = length(uv - center);
  float blur = pow(distance, u_blurExp);
  return clamp(blur, 0.0, u_blurMax);
}`,mainShaderLogic:gr.Fragments.webglGradientFragment()}),Lc=Oe.buildFragmentShader({additionalUniforms:`
// WebGL-specific uniforms
uniform sampler2D u_gradientTex;
uniform float u_flowStrength;
uniform float u_noiseScale;`,includeCorridorFunctions:!0,mainShaderLogic:gr.Fragments.corridorBubbleFragment()}),Dt=class extends Q{constructor(t=w,i,n,r=null,a=null,s=null){super(t,i,n,r,a);this.canvas=null;this.wrapper=null;this.gl=null;this.shaderProgram=null;this.corridorShaderProgram=null;this.uniforms={};this.corridorUniforms={};this.gradientTexture=null;this.vertexBuffer=null;this.vao=null;this.settings={enabled:!0,intensity:"balanced",webglPersistenceMode:"adaptive",flowStrength:.7,noiseScale:1.2,waveY:[.25,.75],waveHeight:[.4,.3],waveOffset:[2.5,-1.8],blurExp:1.2,blurMax:.6,corridorEnabled:!1,corridorIntensity:.8,corridorFlowStrength:1.2,corridorDepthEffect:.6,corridorBubbleScale:1};this.isWebGLAvailable=!1;this.animationId=null;this.startTime=0;this.lastFrameTime=0;this.frameThrottleInterval=1e3/45;this.colorHarmonyEngine=null;this.cssConsciousnessController=null;this.eventSubscriptionIds=[];this.prefersReducedMotion=!1;this.consciousnessChoreographer=null;this.currentConsciousnessField=null;this.webglReady=!1;this.textureUpdatePending=!1;this.lastTextureUpdate=0;this.textureUpdateDebounceTimer=null;this.textureUpdateThrottleMs=50;this.textureUpdateDebounceMs=300;this.textureCreationInProgress=!1;this.contextLost=!1;this.pendingContextRestore=!1;this.contextLossCount=0;this.maxContextLossRetries=10;this.lastSuccessfulRender=0;this.contextRecoveryTimeouts=[100,200,400,800,1600,3200,5e3,5e3,5e3,5e3];this.currentRecoveryAttempt=0;this.currentQualityLevel=null;this.qualityCapabilities=[{name:"webgl-rendering",enabled:!0,qualityLevel:"high"},{name:"shader-complexity",enabled:!0,qualityLevel:"high"},{name:"noise-octaves",enabled:!0,qualityLevel:"medium"},{name:"wave-layers",enabled:!0,qualityLevel:"medium"},{name:"blur-effects",enabled:!0,qualityLevel:"low"},{name:"flow-strength",enabled:!0,qualityLevel:"low"},{name:"corridor-effects",enabled:!0,qualityLevel:"high"},{name:"corridor-sdf-complexity",enabled:!0,qualityLevel:"medium"},{name:"corridor-bubble-layers",enabled:!0,qualityLevel:"medium"},{name:"corridor-depth-effects",enabled:!0,qualityLevel:"low"}];this.qualityAdjustments={};this.systemName="WebGLGradientBackgroundSystem";this.lastColorHarmonizedData=null;this.lastColorHarmonizedTime=0;this.animate=()=>{if(!this.isActive||!this.gl||!this.canvas)return;let t=performance.now();if(t-this.lastFrameTime<this.frameThrottleInterval){this.animationId=requestAnimationFrame(this.animate);return}this.lastFrameTime=t,this.render(t),this.animationId=requestAnimationFrame(this.animate)};this.resize=()=>{if(!this.canvas)return;let t=window.devicePixelRatio||1,i=window.innerWidth,n=window.innerHeight;this.canvas.width=i*t,this.canvas.height=n*t,this.canvas.style.width=i+"px",this.canvas.style.height=n+"px"};this.colorHarmonyEngine=s?.colorHarmonyEngine||null,this.consciousnessChoreographer=s?.backgroundConsciousnessChoreographer||null,this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches}get systemPriority(){return"high"}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();let t=globalThis.year3000System;if(this.cssController=t?.cssConsciousnessController||T(),this.isWebGLAvailable=this.checkWebGL2Support(),!this.isWebGLAvailable)if(this.shouldAttemptWebGLRecovery()){if(u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL2 not available but persistence mode enabled - attempting WebGL1 compatibility mode"),this.isWebGLAvailable=this.checkWebGL1Support(),!this.isWebGLAvailable){u?.debug?.error("WebGLGradientBackgroundSystem","Neither WebGL2 nor WebGL1 available despite persistence mode"),this.fallbackToCSSGradient();return}}else{this.fallbackToCSSGradient();return}let i=new N;await i.initialize();let n=i.recommendPerformanceQuality(),r=i.getCapabilities();if(n==="low"?(u?.debug?.log("WebGLGradientBackgroundSystem","Low performance device detected - trying minimal WebGL quality",{performanceQuality:n,deviceCapabilities:r?.overall,memoryLevel:r?.memory.level,gpuLevel:r?.gpu.level}),this.frameThrottleInterval=1e3/20,this.textureUpdateThrottleMs=1e3,this.settings.corridorEnabled=!1,this.settings.intensity="minimal",this.settings.flowStrength=.3):u?.debug?.log("WebGLGradientBackgroundSystem","Device capabilities acceptable for WebGL",{performanceQuality:n,deviceCapabilities:r?.overall}),this.loadSettings(),!this.settings.enabled){this.fallbackToCSSGradient();return}try{await this.initializeWebGL(),this.subscribeToEvents(),this.registerWithConsciousnessChoreographer(),this.startAnimation();let a={"--sn.bg.webgl.ready":"1","--sn.bg.webgl.enabled":"1","--sn.bg.active-backend":"hybrid","--sn-gradient-crossfade-opacity":"0.5"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",a,"high","webgl-initialization"),u?.debug?.log("WebGLGradientBackgroundSystem","WebGL gradient system initialized successfully")}catch(a){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to initialize WebGL gradient:",a),this.fallbackToCSSGradient()}}checkWebGL2Support(){try{let i=document.createElement("canvas").getContext("webgl2");if(!i)return u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL2 context creation failed"),!1;let n=["EXT_color_buffer_float"],r=[];for(let o of n)i.getExtension(o)||r.push(o);r.length>0&&u?.debug?.warn("WebGLGradientBackgroundSystem","Missing WebGL2 extensions:",r);let a=i.getParameter(i.MAX_TEXTURE_SIZE),s=i.getParameter(i.MAX_RENDERBUFFER_SIZE);return u?.debug?.log("WebGLGradientBackgroundSystem","WebGL2 capability check:",{maxTextureSize:a,maxRenderbufferSize:s,missingExtensions:r.length>0?r:"none"}),!0}catch(t){return u?.debug?.error("WebGLGradientBackgroundSystem","WebGL2 support check failed:",t),!1}}checkWebGL1Support(){try{let t=document.createElement("canvas"),i=t.getContext("webgl")||t.getContext("experimental-webgl");if(!i)return u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL1 context creation failed"),!1;let n=i.getParameter(i.MAX_TEXTURE_SIZE),r=i.getParameter(i.MAX_RENDERBUFFER_SIZE);return u?.debug?.log("WebGLGradientBackgroundSystem","WebGL1 fallback capability check:",{maxTextureSize:n,maxRenderbufferSize:r}),!0}catch(t){return u?.debug?.error("WebGLGradientBackgroundSystem","WebGL1 support check failed:",t),!1}}findSpotifyContainer(){let t=[".Root__main-view",".main-view-container",".main-gridContainer-gridContainer",".Root__top-container","body"];for(let i of t){let n=document.querySelector(i);if(n)return u?.debug?.log("WebGLGradientBackgroundSystem",`Found container: ${i}`),n}return u?.debug?.warn("WebGLGradientBackgroundSystem","No Spotify container found, falling back to body"),document.body}loadSettings(){if(this.settingsManager)try{let t=this.settingsManager.get("sn-webgl-enabled"),i=this.settingsManager.get("sn-webgl-force-enabled"),n=this.settingsManager.get("sn-webgl-persistence-mode"),r=this.settingsManager.get("sn-gradient-intensity");if(t==="false"&&i!=="true"){this.settings.enabled=!1,u?.debug?.log("WebGLGradientBackgroundSystem","WebGL disabled by user setting");return}if(this.settings.webglPersistenceMode=n||"adaptive",r==="disabled"){this.settings.enabled=!1;return}switch(this.settings.intensity=r||"balanced",this.settings.intensity){case"minimal":this.settings.flowStrength=.4,this.settings.noiseScale=.8,this.settings.waveHeight=[.3,.2],this.settings.waveOffset=[1.5,-1],this.settings.blurExp=1,this.settings.blurMax=.4;break;case"balanced":this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.waveOffset=[2.5,-1.8],this.settings.blurExp=1.2,this.settings.blurMax=.6;break;case"intense":this.settings.flowStrength=1,this.settings.noiseScale=1.6,this.settings.waveHeight=[.5,.4],this.settings.waveOffset=[3.5,-2.5],this.settings.blurExp=1.4,this.settings.blurMax=.8;break}u?.debug?.log("WebGLGradientBackgroundSystem","Settings loaded:",{webglEnabled:t,webglForceEnabled:i,persistenceMode:this.settings.webglPersistenceMode,intensity:this.settings.intensity,enabled:this.settings.enabled})}catch(t){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to load settings, using defaults:",t)}}applyUpdatedSettings(t,i){if(this.settingsManager){u?.debug?.log("WebGLGradientBackgroundSystem",`Runtime setting changed: ${t} = ${i}`);try{switch(t){case"sn-webgl-enabled":i==="false"?(this.settings.enabled=!1,this.destroy()):i==="true"&&!this.settings.enabled&&(this.settings.enabled=!0,!this.gl&&this.canvas&&this.initialize());break;case"sn-webgl-force-enabled":this.settingsManager.get("sn-webgl-enabled")==="false"&&i!=="true"&&(this.settings.enabled=!1,this.destroy());break;case"sn-webgl-persistence-mode":this.settings.webglPersistenceMode=i||"adaptive",u?.debug?.log("WebGLGradientBackgroundSystem",`Persistence mode changed to: ${this.settings.webglPersistenceMode}`);break;case"sn-gradient-intensity":if(i==="disabled")this.settings.enabled=!1;else switch(this.settings.enabled=!0,this.settings.intensity=i||"balanced",this.settings.intensity){case"minimal":this.settings.flowStrength=.4,this.settings.noiseScale=.8,this.settings.waveHeight=[.3,.2],this.settings.waveOffset=[1.5,-1],this.settings.blurExp=1,this.settings.blurMax=.4;break;case"balanced":this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.waveOffset=[2.5,-1.8],this.settings.blurExp=1.2,this.settings.blurMax=.6;break;case"intense":this.settings.flowStrength=1,this.settings.noiseScale=1.6,this.settings.waveHeight=[.5,.4],this.settings.waveOffset=[3.5,-2.5],this.settings.blurExp=1.4,this.settings.blurMax=.8;break}break;default:return}this.forceRepaint?.(`setting-change:${t}`)}catch(n){u?.debug?.error("WebGLGradientBackgroundSystem",`Failed to apply runtime setting ${t}:`,n)}}}async initializeWebGL(){this.wrapper=document.createElement("div"),this.wrapper.className="sn-gradient-effects-wrapper",this.wrapper.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -11;
      pointer-events: none;
      overflow: hidden;
    `,this.canvas=document.createElement("canvas"),this.canvas.id="sn-webgl-gradient",this.canvas.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    `,this.wrapper.appendChild(this.canvas);try{if(this.gl=this.canvas.getContext("webgl2",{alpha:!0,antialias:!1,depth:!1,stencil:!1,powerPreference:"default"}),!this.gl)throw new Error("WebGL2 context creation returned null - likely unsupported");this.setupContextLossHandlers();let i=this.gl.getParameter(this.gl.VERSION);if(!i)throw new Error("WebGL2 context appears non-functional - getParameter failed");u?.debug?.log("WebGLGradientBackgroundSystem","WebGL2 context created successfully:",{version:i,renderer:this.gl.getParameter(this.gl.RENDERER),vendor:this.gl.getParameter(this.gl.VENDOR)})}catch(i){throw u?.debug?.error("WebGLGradientBackgroundSystem","WebGL2 context creation failed:",i),new Error(`Failed to create WebGL2 context: ${i instanceof Error?i.message:"Unknown error"}`)}await this.compileShaders(),this.createGeometry(),await this.updateGradientTexture(),this.setupUniforms(),this.resize(),this.findSpotifyContainer().appendChild(this.wrapper),window.addEventListener("resize",this.resize.bind(this))}async compileShaders(){if(!this.gl)throw new Error("WebGL context not available");let t=null,i=null,n="full";if(t=te.loadVertex(this.gl,vt),!t)throw new Error("Failed to compile vertex shader - even basic vertex shader failed");let r=[{name:"full",shader:Dc,description:"Full consciousness shader with all features"},{name:"simplified",shader:this.getSimplifiedFragmentShader(),description:"Simplified shader without complex noise functions"},{name:"basic",shader:this.getBasicFragmentShader(),description:"Basic gradient shader with minimal features"},{name:"emergency",shader:this.getEmergencyFragmentShader(),description:"Emergency shader for maximum hardware compatibility"}];for(let s of r)try{if(i=te.loadFragment(this.gl,s.shader),i){n=s.name,u?.debug?.log("WebGLGradientBackgroundSystem",`Successfully compiled shader variant: ${s.name}`,{description:s.description});break}}catch(o){u?.debug?.warn("WebGLGradientBackgroundSystem",`Failed to compile ${s.name} shader variant:`,o);continue}if(!i)throw new Error("Failed to compile any fragment shader variant");if(this.shaderProgram=te.createProgram(this.gl,t,i),!this.shaderProgram)throw new Error("Failed to create shader program");let a=te.loadFragment(this.gl,Lc);if(!a){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to compile corridor shader - corridor effects disabled"),this.settings.corridorEnabled=!1;return}this.corridorShaderProgram=te.createProgram(this.gl,t,a),this.corridorShaderProgram||(u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to create corridor shader program - corridor effects disabled"),this.settings.corridorEnabled=!1)}createGeometry(){if(!this.gl||!this.shaderProgram)return;let t=new Float32Array([-1,-1,3,-1,-1,3]);this.vertexBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW),this.vao=this.gl.createVertexArray(),this.gl.bindVertexArray(this.vao);let i=this.gl.getAttribLocation(this.shaderProgram,"a_position");this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,0,0),this.gl.bindVertexArray(null)}setupUniforms(){!this.gl||!this.shaderProgram||(this.uniforms.u_time=this.gl.getUniformLocation(this.shaderProgram,"u_time"),this.uniforms.u_gradientTex=this.gl.getUniformLocation(this.shaderProgram,"u_gradientTex"),this.uniforms.u_resolution=this.gl.getUniformLocation(this.shaderProgram,"u_resolution"),this.uniforms.u_flowStrength=this.gl.getUniformLocation(this.shaderProgram,"u_flowStrength"),this.uniforms.u_noiseScale=this.gl.getUniformLocation(this.shaderProgram,"u_noiseScale"),this.uniforms.u_waveY=this.gl.getUniformLocation(this.shaderProgram,"u_waveY"),this.uniforms.u_waveHeight=this.gl.getUniformLocation(this.shaderProgram,"u_waveHeight"),this.uniforms.u_waveOffset=this.gl.getUniformLocation(this.shaderProgram,"u_waveOffset"),this.uniforms.u_blurExp=this.gl.getUniformLocation(this.shaderProgram,"u_blurExp"),this.uniforms.u_blurMax=this.gl.getUniformLocation(this.shaderProgram,"u_blurMax"),this.corridorShaderProgram&&this.setupCorridorUniforms())}setupCorridorUniforms(){if(!this.gl||!this.corridorShaderProgram)return;let t=Oe.getCorridorUniformNames();for(let i of t)this.corridorUniforms[i]=this.gl.getUniformLocation(this.corridorShaderProgram,i)}updateConsciousnessUniforms(t,i){if(!this.gl)return;let n=this.currentConsciousnessField,r=n?.pulseRate??.5;t.u_rhythmicPulse&&this.gl.uniform1f(t.u_rhythmicPulse,r);let a=n?.flowDirection??{x:0,y:0};t.u_musicalFlow&&a&&this.gl.uniform2f(t.u_musicalFlow,a.x??0,a.y??0);let s=n?.energyLevel??.5;t.u_energyResonance&&this.gl.uniform1f(t.u_energyResonance,s);let o=Math.sin(i*.05)*.5+.5;t.u_breathingCycle&&this.gl.uniform1f(t.u_breathingCycle,o);let l=n?.fluidIntensity??.3;if(t.u_membraneFluidityIndex&&this.gl.uniform1f(t.u_membraneFluidityIndex,l),this.musicSyncService){let m=this.musicSyncService.getCurrentMusicState();if(m){let d=m.beat?.energy??.5,h=m.emotion?.valence??.5,g=m.intensity??0,f=m.beat?.energy??0;t.u_musicEnergy&&this.gl.uniform1f(t.u_musicEnergy,d),t.u_musicValence&&this.gl.uniform1f(t.u_musicValence,h),t.u_beatIntensity&&this.gl.uniform1f(t.u_beatIntensity,g),t.u_bassResponse&&this.gl.uniform1f(t.u_bassResponse,f)}}}async updateGradientTexture(){if(!this.gl){u?.debug?.warn("WebGLGradientBackgroundSystem","No WebGL context available");return}if(!this.isContextValid()){u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL context invalid, attempting recovery"),this.contextLost&&!this.pendingContextRestore&&(u?.debug?.log("WebGLGradientBackgroundSystem","Attempting WebGL context recovery"),this.fallbackToCSSGradient());return}let t=this.gl.getError();if(t!==this.gl.NO_ERROR)for(u?.debug?.warn("WebGLGradientBackgroundSystem",`WebGL error detected before texture update: ${t}`);this.gl.getError()!==this.gl.NO_ERROR;);if(this.textureCreationInProgress){u?.debug?.log("WebGLGradientBackgroundSystem","Texture creation already in progress, skipping update");return}this.textureCreationInProgress=!0;try{let i=this.getDefaultGradientStops(),n="default";if(this.colorHarmonyEngine)try{let o=this.colorHarmonyEngine.getCurrentGradient(5);if(o&&o.length>0)i=o.map((l,m)=>({r:l.r/255,g:l.g/255,b:l.b/255,a:1,position:m/(o.length-1)})),n="ColorHarmonyEngine",u?.debug?.log("WebGLGradientBackgroundSystem",`Updated gradient texture with ${i.length} stops from ColorHarmonyEngine`);else{let l=this.getCSSGradientStops();l&&l.length>0&&(i=l,n="CSS variables",u?.debug?.log("WebGLGradientBackgroundSystem",`ColorHarmonyEngine returned empty, using CSS gradient fallback with ${i.length} stops`))}}catch(o){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to get gradient from ColorHarmonyEngine, trying CSS fallback:",o);let l=this.getCSSGradientStops();l&&l.length>0&&(i=l,n="CSS variables (engine failed)",u?.debug?.log("WebGLGradientBackgroundSystem",`Using CSS gradient fallback after ColorHarmonyEngine error with ${i.length} stops`))}else{let o=this.getCSSGradientStops();o&&o.length>0&&(i=o,n="CSS variables (no engine)",u?.debug?.log("WebGLGradientBackgroundSystem",`No ColorHarmonyEngine available, using CSS gradient fallback with ${i.length} stops`))}if(u?.debug?.log("WebGLGradientBackgroundSystem",`Final color source: ${n}, stops: ${i.length}`),this.gl.isContextLost())throw new Error("WebGL context was lost during gradient preparation");if(this.gradientTexture){try{this.gl.deleteTexture(this.gradientTexture)}catch(o){u?.debug?.warn("WebGLGradientBackgroundSystem","Error deleting old texture:",o)}this.gradientTexture=null}(!i||i.length===0)&&(u?.debug?.warn("WebGLGradientBackgroundSystem","No valid color stops, using defaults"),i=this.getDefaultGradientStops());let r=null,a=0,s=3;for(;!r&&a<s;){a++;try{if(this.gl.isContextLost())throw new Error("WebGL context lost during texture creation attempt");if(r=oe(this.gl,i),r){u?.debug?.log("WebGLGradientBackgroundSystem",`Gradient texture created successfully on attempt ${a}`);break}}catch(o){u?.debug?.warn("WebGLGradientBackgroundSystem",`Texture creation attempt ${a} failed:`,o),a<s&&await new Promise(l=>setTimeout(l,a*10))}}if(r)this.gradientTexture=r;else{u?.debug?.error("WebGLGradientBackgroundSystem","Failed to create gradient texture after all attempts - trying default colors");try{let o=this.getDefaultGradientStops(),l=oe(this.gl,o);if(!l)throw new Error("Failed to create gradient texture even with default colors");this.gradientTexture=l,i=o,u?.debug?.log("WebGLGradientBackgroundSystem","Using default gradient fallback after all attempts failed")}catch(o){u?.debug?.error("WebGLGradientBackgroundSystem","Default gradient fallback failed, attempting emergency solid color:",o);try{let l=[{r:.196,g:.165,b:.282,a:1,position:0},{r:.196,g:.165,b:.282,a:1,position:1}],m=oe(this.gl,l);if(m)this.gradientTexture=m,i=l,u?.debug?.warn("WebGLGradientBackgroundSystem","Using emergency solid color texture as final fallback");else throw new Error("Emergency solid color texture creation failed")}catch(l){throw u?.debug?.error("WebGLGradientBackgroundSystem","Emergency solid color texture failed:",l),new Error(`All gradient texture creation methods failed: ${l}`)}}}this.lastTextureUpdate=performance.now(),u?.debug?.log("WebGLGradientBackgroundSystem",`Gradient texture updated successfully using ${n}`,{colorStops:i.length,source:n,firstColor:i[0]?`rgb(${Math.round(i[0].r*255)},${Math.round(i[0].g*255)},${Math.round(i[0].b*255)})`:"none"})}catch(i){if(u?.debug?.error("WebGLGradientBackgroundSystem","Critical error in updateGradientTexture:",i),i instanceof Error&&i.message.includes("context"))u?.debug?.log("WebGLGradientBackgroundSystem","WebGL context-related error detected, switching to CSS fallback"),this.fallbackToCSSGradient();else{u?.debug?.log("WebGLGradientBackgroundSystem","Attempting simple texture recovery with default colors");try{this.gradientTexture=null;let n=this.getDefaultGradientStops();if(this.gl&&!this.gl.isContextLost())if(this.gradientTexture=oe(this.gl,n),this.gradientTexture)u?.debug?.log("WebGLGradientBackgroundSystem","Successfully recovered with default gradient");else throw new Error("Recovery attempt failed");else throw new Error("WebGL context unavailable for recovery")}catch(n){u?.debug?.error("WebGLGradientBackgroundSystem","Recovery attempt failed, falling back to CSS:",n),this.fallbackToCSSGradient()}}}finally{this.textureCreationInProgress=!1}}async updateGradientTextureThrottled(){let t=performance.now();if(t-this.lastTextureUpdate<this.textureUpdateThrottleMs){if(!this.textureUpdatePending){this.textureUpdatePending=!0;let i=this.textureUpdateThrottleMs-(t-this.lastTextureUpdate);setTimeout(()=>{this.textureUpdatePending=!1,this.updateGradientTexture().catch(n=>{u?.debug?.error("WebGLGradientBackgroundSystem","Throttled texture update failed:",n)})},i)}return}await this.updateGradientTexture()}debouncedUpdateGradientTexture(){this.textureUpdateDebounceTimer&&clearTimeout(this.textureUpdateDebounceTimer),this.textureUpdateDebounceTimer=window.setTimeout(()=>{this.textureUpdateDebounceTimer=null,this.updateGradientTextureThrottled().catch(t=>{u?.debug?.error("WebGLGradientBackgroundSystem","Debounced texture update failed:",t)})},this.textureUpdateDebounceMs)}setupContextLossHandlers(){if(!this.canvas)return;this.canvas.addEventListener("webglcontextlost",async i=>{if(this.contextLossCount++,u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL context lost - Enhanced Recovery",{lossCount:this.contextLossCount,maxRetries:this.maxContextLossRetries}),i.preventDefault(),this.contextLost=!0,this.textureCreationInProgress=!1,this.contextLossCount<=this.maxContextLossRetries){let n=Math.min(this.contextLossCount-1,this.contextRecoveryTimeouts.length-1),r=this.contextRecoveryTimeouts[n]||5e3;if(u?.debug?.log("WebGLGradientBackgroundSystem",`Preparing for context recovery attempt ${this.contextLossCount}/${this.maxContextLossRetries} with ${r}ms backoff`,{shouldPersist:this.shouldPersistWebGL()}),this.gl)try{let{ShaderLoader:a}=await Promise.resolve().then(()=>(Ct(),In));a.clearContextCache(this.gl)}catch{}this.textureUpdateDebounceTimer&&(clearTimeout(this.textureUpdateDebounceTimer),this.textureUpdateDebounceTimer=null),this.textureUpdatePending=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}else this.shouldPersistWebGL()?(u?.debug?.warn("WebGLGradientBackgroundSystem",`Context lost ${this.contextLossCount} times but persistence mode enabled - resetting retry count and continuing`),this.contextLossCount=Math.max(1,this.maxContextLossRetries-3),this.currentRecoveryAttempt=0):(u?.debug?.error("WebGLGradientBackgroundSystem",`Context lost ${this.contextLossCount} times - falling back to CSS gradient`),this.fallbackToCSSGradient())},!1);let t=async()=>{if(!this.contextLost||this.pendingContextRestore)return;let i=Math.min(this.currentRecoveryAttempt,this.contextRecoveryTimeouts.length-1),n=this.contextRecoveryTimeouts[i]||5e3;u?.debug?.log("WebGLGradientBackgroundSystem",`Attempting context recovery in ${n}ms (attempt ${this.currentRecoveryAttempt+1})`),setTimeout(async()=>{if(this.contextLost){this.currentRecoveryAttempt++;try{this.gl&&this.gl.isContextLost()&&this.gl.getError()}catch(r){u?.debug?.warn("WebGLGradientBackgroundSystem","Error during context recovery attempt:",r)}this.contextLost&&this.currentRecoveryAttempt<this.maxContextLossRetries&&t()}},n)};this.canvas.addEventListener("webglcontextlost",()=>{this.currentRecoveryAttempt=0,t()}),this.canvas.addEventListener("webglcontextrestored",async()=>{u?.debug?.log("WebGLGradientBackgroundSystem","WebGL context restored - Enhanced Recovery",{lossCount:this.contextLossCount,maxRetries:this.maxContextLossRetries}),this.contextLost=!1,this.pendingContextRestore=!0;try{if(!this.gl||this.gl.isContextLost())throw new Error("Context is still lost after restore event");await this.reinitializeWebGLResources(),this.contextLossCount>=2?(u?.debug?.log("WebGLGradientBackgroundSystem","Reducing quality after multiple context losses"),this.adjustQualityForTier("low")):this.contextLossCount>=1&&(u?.debug?.log("WebGLGradientBackgroundSystem","Reducing quality after context loss"),this.adjustQualityForTier("medium")),this.startAnimation(),this.pendingContextRestore=!1,u?.debug?.log("WebGLGradientBackgroundSystem","WebGL context restore completed successfully",{lossCount:this.contextLossCount,qualityReduced:this.contextLossCount>0})}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to restore WebGL context:",i),this.pendingContextRestore=!1,this.contextLossCount++,this.contextLossCount>this.maxContextLossRetries&&(u?.debug?.error("WebGLGradientBackgroundSystem","Context restoration failed too many times - falling back to CSS"),this.fallbackToCSSGradient())}},!1)}async reinitializeWebGLResources(){if(!this.gl)throw new Error("WebGL context not available");this.shaderProgram=null,this.vertexBuffer=null,this.vao=null,this.gradientTexture=null;let{ShaderLoader:t}=await Promise.resolve().then(()=>(Ct(),In));t.clearContextCache(this.gl),await this.compileShaders(),this.createGeometry(),await this.updateGradientTexture(),this.setupUniforms(),u?.debug?.log("WebGLGradientBackgroundSystem","WebGL resources reinitialized after context restore")}isContextValid(){return!this.gl||this.contextLost?!1:this.gl.isContextLost()?(this.contextLost=!0,!1):!0}getDefaultGradientStops(){return[{r:.196,g:.165,b:.282,a:1,position:0},{r:.549,g:.408,b:.878,a:1,position:.3},{r:.788,g:.557,b:.902,a:1,position:.6},{r:.957,g:.761,b:.494,a:1,position:1}]}getCSSGradientStops(){try{let t=document.documentElement,i=getComputedStyle(t),n=["--sn-bg-gradient-primary-rgb","--sn-bg-gradient-secondary-rgb","--sn-bg-gradient-tertiary-rgb"],r=[];for(let o=0;o<n.length;o++){let l=n[o]||"--sn-bg-gradient-primary-rgb",m=i.getPropertyValue(l).trim();if(!m){u?.debug?.log("WebGLGradientBackgroundSystem",`CSS variable ${l} not set, trying without CSS fallback`);continue}let d=m.split(",").map(h=>parseInt(h.trim(),10));if(d.length!==3||d.some(h=>isNaN(h)||h<0||h>255)){u?.debug?.warn("WebGLGradientBackgroundSystem",`Invalid RGB values in ${l}: ${m}, skipping this color`);continue}r.push({r:(d[0]??0)/255,g:(d[1]??0)/255,b:(d[2]??0)/255,a:1,position:o/(n.length-1)})}if(r.length<2)return u?.debug?.log("WebGLGradientBackgroundSystem",`Only ${r.length} valid CSS colors found, need at least 2 for gradient`),null;let a=i.getPropertyValue("--sn-bg-gradient-opacity").trim(),s=a?parseFloat(a):1;return s!==1&&s>0&&s<=1&&r.forEach(o=>{o.a=s}),u?.debug?.log("WebGLGradientBackgroundSystem",`Successfully parsed ${r.length} CSS background gradient stops from OKLAB inheritance`,{colors:r.map(o=>`rgba(${Math.round(o.r*255)},${Math.round(o.g*255)},${Math.round(o.b*255)},${o.a})`),opacity:s!==1?s:"default"}),r}catch(t){return u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to parse CSS background gradient variables:",t),null}}subscribeToEvents(){let t=p.subscribe("colors:harmonized",this.handleColorHarmonized.bind(this),"WebGLGradientBackgroundSystem");this.eventSubscriptionIds.push(t);let i=p.subscribe("colors:applied",this.handleColorApplied.bind(this),"WebGLGradientBackgroundSystem");this.eventSubscriptionIds.push(i);let n=p.subscribe("performance:tier-changed",this.handlePerformanceTierChanged.bind(this),"WebGLGradientBackgroundSystem");this.eventSubscriptionIds.push(n),u?.debug?.log("WebGLGradientBackgroundSystem","Subscribed to unified events",{subscriptionCount:this.eventSubscriptionIds.length,events:["colors:harmonized","colors:applied","performance:tier-changed"]})}handleColorHarmonized(t){let i=performance.now(),n=`${t.accentHex}-${t.processingTime}-${t.strategies.join(",")}`;if(this.lastColorHarmonizedData===n&&i-this.lastColorHarmonizedTime<100){u?.debug?.log("WebGLGradientBackgroundSystem","Duplicate color harmonization event detected, skipping");return}this.lastColorHarmonizedData=n,this.lastColorHarmonizedTime=i,this.debouncedUpdateGradientTexture(),u?.debug?.log("WebGLGradientBackgroundSystem","Color harmonization processed",{strategies:t.strategies,processingTime:t.processingTime,accentHex:t.accentHex,deduplicationHash:n.substring(0,16)+"..."})}handleColorApplied(t){u?.debug?.log("WebGLGradientBackgroundSystem","Color application coordinated",{accentHex:t.accentHex,appliedAt:t.appliedAt})}handlePerformanceTierChanged(t){if(!(!this.isActive||!this.gl))switch(u?.debug?.log("WebGLGradientBackgroundSystem","Performance tier changed",{previousTier:t.previousTier,newTier:t.tier,timestamp:t.timestamp}),t.tier){case"excellent":this.adjustQualityForTier("high");break;case"good":this.adjustQualityForTier("medium");break;case"degraded":this.adjustQualityForTier("low"),u?.debug?.warn("WebGLGradientBackgroundSystem","Performance degraded - reducing WebGL quality instead of fallback");break;case"critical":t.previousTier==="degraded"?this.shouldPersistWebGL()?(u?.debug?.warn("WebGLGradientBackgroundSystem","Critical performance but persistence mode enabled - reducing to absolute minimum WebGL quality"),this.adjustQualityForTier("emergency")):(u?.debug?.warn("WebGLGradientBackgroundSystem","Critical performance detected - falling back to CSS gradient"),this.fallbackToCSSGradient()):(this.adjustQualityForTier("minimal"),u?.debug?.warn("WebGLGradientBackgroundSystem","Critical performance - using minimal WebGL quality"));break}}adjustQualityForTier(t){if(!this.gl||!this.canvas)return;switch(t){case"high":this.frameThrottleInterval=1e3/60;break;case"medium":this.frameThrottleInterval=1e3/45;break;case"low":this.frameThrottleInterval=1e3/30;break;case"minimal":this.frameThrottleInterval=1e3/15;break;case"emergency":this.frameThrottleInterval=1e3/10;break}switch(t){case"high":this.textureUpdateThrottleMs=100;break;case"medium":this.textureUpdateThrottleMs=200;break;case"low":this.textureUpdateThrottleMs=500;break;case"minimal":this.textureUpdateThrottleMs=1e3;break;case"emergency":this.textureUpdateThrottleMs=2e3;break}let i=this.findSpotifyContainer();if(i){let r=i.getBoundingClientRect(),a=1;switch(t){case"high":a=1;break;case"medium":a=.8;break;case"low":a=.6;break;case"minimal":a=.4;break;case"emergency":a=.1;break}let s=Math.floor(r.width*a),o=Math.floor(r.height*a);this.canvas.width=s,this.canvas.height=o,this.gl&&this.gl.viewport(0,0,s,o)}let n=this.settings.corridorEnabled;switch(t){case"high":this.settings.intensity="intense",this.settings.flowStrength=Math.max(this.settings.flowStrength,.7);break;case"medium":this.settings.intensity="balanced",this.settings.flowStrength=Math.min(this.settings.flowStrength,.6);break;case"low":this.settings.corridorEnabled=!1,this.settings.intensity="minimal",this.settings.flowStrength=Math.min(this.settings.flowStrength,.4);break;case"minimal":this.settings.corridorEnabled=!1,this.settings.intensity="minimal",this.settings.flowStrength=.2;break}n!==this.settings.corridorEnabled&&u?.debug?.log("WebGLGradientBackgroundSystem",`Corridor shader ${this.settings.corridorEnabled?"enabled":"disabled"} for ${t} quality`),u?.debug?.log("WebGLGradientBackgroundSystem",`Quality adjusted for ${t} performance tier`,{frameFPS:Math.round(1e3/this.frameThrottleInterval),textureFPS:Math.round(1e3/this.textureUpdateThrottleMs),canvasResolution:`${this.canvas.width}x${this.canvas.height}`,corridorEnabled:this.settings.corridorEnabled})}startAnimation(){this.startTime=performance.now(),this.lastFrameTime=this.startTime,this.animate()}render(t){if(!this.gl||!this.vao)return;if(!this.gradientTexture){u?.debug?.warn("WebGLGradientBackgroundSystem","No gradient texture during render - creating emergency texture");try{let s=[()=>{let o=this.getCSSGradientStops();return o?oe(this.gl,o):null},()=>{let o=this.getDefaultGradientStops();return oe(this.gl,o)},()=>{let o=[{r:.196,g:.165,b:.282,a:1,position:0},{r:.196,g:.165,b:.282,a:1,position:1}];return oe(this.gl,o)}];for(let o=0;o<s.length;o++)try{if(this.gradientTexture=s[o](),this.gradientTexture){u?.debug?.log("WebGLGradientBackgroundSystem",`Emergency texture created using method ${o+1}`);break}}catch(l){u?.debug?.warn("WebGLGradientBackgroundSystem",`Emergency texture method ${o+1} failed:`,l)}if(!this.gradientTexture){u?.debug?.error("WebGLGradientBackgroundSystem","All emergency texture creation methods failed - skipping render");return}}catch(s){u?.debug?.error("WebGLGradientBackgroundSystem","Emergency texture creation failed completely:",s);return}}if(this.lastSuccessfulRender=t,this.contextLossCount>0&&t-this.lastSuccessfulRender>3e4){let s=this.contextLossCount;this.contextLossCount=Math.max(0,this.contextLossCount-1),s!==this.contextLossCount&&u?.debug?.log("WebGLGradientBackgroundSystem","Context loss count reduced due to successful renders",{oldCount:s,newCount:this.contextLossCount})}let i=this.settings.corridorEnabled&&this.corridorShaderProgram&&this.currentQualityLevel!=="low",n=i?this.corridorShaderProgram:this.shaderProgram,r=i?this.corridorUniforms:this.uniforms;if(!n)return;if(this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.useProgram(n),this.gl.bindVertexArray(this.vao),!this.webglReady){this.webglReady=!0;let s={"--sn.bg.webgl.ready":"1","--sn.bg.webgl.enabled":"1","--sn.bg.active-backend":"hybrid","--sn-gradient-crossfade-opacity":"0.5"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",s,"critical","webgl-first-draw")}let a=this.prefersReducedMotion?0:(t-this.startTime)/1e3;if(r.u_time&&this.gl.uniform1f(r.u_time,a),r.u_resolution&&this.gl.uniform2f(r.u_resolution,this.canvas.width,this.canvas.height),r.u_flowStrength){let s=this.settings.flowStrength;try{let l=getComputedStyle(document.documentElement).getPropertyValue("--sn-flow-strength").trim();l&&(s=parseFloat(l))}catch{u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to read flow strength CSS variable, using settings value")}this.gl.uniform1f(r.u_flowStrength,s)}r.u_noiseScale&&this.gl.uniform1f(r.u_noiseScale,this.settings.noiseScale),i||(r.u_waveY&&this.gl.uniform1fv(r.u_waveY,this.settings.waveY),r.u_waveHeight&&this.gl.uniform1fv(r.u_waveHeight,this.settings.waveHeight),r.u_waveOffset&&this.gl.uniform1fv(r.u_waveOffset,this.settings.waveOffset),r.u_blurExp&&this.gl.uniform1f(r.u_blurExp,this.settings.blurExp),r.u_blurMax&&this.gl.uniform1f(r.u_blurMax,this.settings.blurMax)),i&&(r.u_corridorIntensity&&this.gl.uniform1f(r.u_corridorIntensity,this.settings.corridorIntensity),r.u_corridorFlowStrength&&this.gl.uniform1f(r.u_corridorFlowStrength,this.settings.corridorFlowStrength),r.u_corridorDepthEffect&&this.gl.uniform1f(r.u_corridorDepthEffect,this.settings.corridorDepthEffect),r.u_corridorBubbleScale&&this.gl.uniform1f(r.u_corridorBubbleScale,this.settings.corridorBubbleScale),this.updateConsciousnessUniforms(r,a)),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.gradientTexture),r.u_gradientTex&&this.gl.uniform1i(r.u_gradientTex,0),this.gl.drawArrays(this.gl.TRIANGLES,0,3),this.gl.bindVertexArray(null)}fallbackToCSSGradient(){let t={"--sn.bg.webgl.ready":"0","--sn.bg.webgl.enabled":"0","--sn.bg.active-backend":"css","--sn-gradient-crossfade-opacity":"0"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",t,"critical","webgl-css-fallback"),this.cssConsciousnessController&&this.startCSSFallbackAnimation(),u?.debug?.log("WebGLGradientBackgroundSystem","Using CSS gradient fallback")}startCSSFallbackAnimation(){if(!this.cssConsciousnessController)return;let t=()=>{if(!this.isActive)return;let i=performance.now()/1e3,n=Math.sin(i*.04)*20+Math.sin(i*.07)*8,r=Math.cos(i*.05)*20+Math.cos(i*.09)*6,a=1.15+Math.sin(i*.03)*.2,s={"--sn-gradient-flow-x":`${n}%`,"--sn-gradient-flow-y":`${r}%`,"--sn-gradient-flow-scale":a.toString()};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",s,"normal","css-fallback-animation"),setTimeout(t,this.frameThrottleInterval)};t()}handleSettingsChange(t){super.handleSettingsChange(t);let i=t,{key:n,value:r}=i.detail;if(n==="sn-gradient-intensity"){let a=this.settings.enabled;this.settings.intensity=r,this.loadSettings(),r==="disabled"&&a?(this.settings.enabled=!1,this.destroy(),this.fallbackToCSSGradient()):this.settings.enabled&&!a&&this.isWebGLAvailable&&this.initialize()}}_performSystemSpecificCleanup(){if(super._performSystemSpecificCleanup(),this.consciousnessChoreographer)try{this.consciousnessChoreographer.unregisterConsciousnessParticipant("WebGLGradientBackgroundSystem"),u?.debug?.log("WebGLGradientBackgroundSystem","Unregistered from consciousness choreographer")}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Error unregistering from consciousness choreographer:",i)}this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.textureUpdateDebounceTimer&&(clearTimeout(this.textureUpdateDebounceTimer),this.textureUpdateDebounceTimer=null),this.textureUpdatePending=!1,this.textureCreationInProgress=!1,this.lastColorHarmonizedData=null,this.gl&&(this.gradientTexture&&(this.gl.deleteTexture(this.gradientTexture),this.gradientTexture=null),this.vertexBuffer&&(this.gl.deleteBuffer(this.vertexBuffer),this.vertexBuffer=null),this.vao&&(this.gl.deleteVertexArray(this.vao),this.vao=null),this.shaderProgram&&(this.gl.deleteProgram(this.shaderProgram),this.shaderProgram=null),te.clearCache(this.gl)),this.wrapper&&this.wrapper.parentNode&&(this.wrapper.parentNode.removeChild(this.wrapper),this.wrapper=null),this.canvas=null,this.eventSubscriptionIds.forEach(i=>{p.unsubscribe(i)}),this.eventSubscriptionIds=[],u?.debug?.log("WebGLGradientBackgroundSystem","Unified event subscriptions cleaned up"),window.removeEventListener("resize",this.resize),this.gl=null;let t={"--sn.bg.webgl.ready":"0","--sn.bg.webgl.enabled":"0","--sn.bg.active-backend":"css","--sn-gradient-crossfade-opacity":"0"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",t,"critical","webgl-system-cleanup")}forceRepaint(t="settings-change"){this.isActive&&this.gradientTexture&&this.updateGradientTexture().catch(i=>{u?.debug?.error("WebGLGradientBackgroundSystem","Failed to repaint gradient:",i)})}setWaveY(t){this.settings.waveY=t}setWaveHeight(t){this.settings.waveHeight=t}setWaveOffset(t){this.settings.waveOffset=t}setBlurSettings(t,i){this.settings.blurExp=t,this.settings.blurMax=i}getMetrics(){return{fps:this.performanceMonitor?.getMedianFPS?.()||0,compileErrors:0,isActive:this.isActive,settings:{...this.settings}}}stopAnimation(){this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)}updateAnimation(t){if(!this.isActive||!this.gl||!this.isWebGLAvailable)return;let i=performance.now();this.shouldSkipFrame(i)||(this.shouldUpdateTexture()&&this.currentQualityLevel!=="low"&&this.updateGradientTextureThrottled(),this.webglReady?this.render(i):this.ensureBasicResources())}shouldSkipFrame(t){if(!this.frameThrottleInterval)return!1;let n=t-(this.lastFrameTime||0)<this.frameThrottleInterval;return n||(this.lastFrameTime=t),n}shouldUpdateTexture(){return performance.now()-this.lastTextureUpdate>=this.textureUpdateThrottleMs}ensureBasicResources(){if(!(!this.gl||this.contextLost)&&!this.gradientTexture)try{let t=this.getDefaultGradientStops();this.gradientTexture=oe(this.gl,t),this.gradientTexture&&u?.debug?.log("WebGLGradientBackgroundSystem","Emergency gradient texture created during animation update")}catch(t){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to create emergency gradient texture:",t)}}async healthCheck(){let t=this.webglReady&&this.initialized&&this.isActive;return{system:"WebGLGradientBackgroundSystem",healthy:t,metrics:{webglReady:this.webglReady,initialized:this.initialized,active:this.isActive,contextLost:this.contextLost,canvasExists:!!this.canvas},issues:t?[]:[...this.webglReady?[]:["WebGL not ready"],...this.initialized?[]:["System not initialized"],...this.isActive?[]:["System not active"],...this.contextLost?["WebGL context lost"]:[]]}}resizeTo(t,i){this.canvas&&(this.canvas.width=t,this.canvas.height=i,this.resize?.())}registerWithConsciousnessChoreographer(){if(!this.consciousnessChoreographer){u?.debug?.log("WebGLGradientBackgroundSystem","Consciousness choreographer not available, skipping registration");return}try{this.consciousnessChoreographer.registerConsciousnessParticipant(this),u?.debug?.log("WebGLGradientBackgroundSystem","Successfully registered with consciousness choreographer")}catch(t){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to register with consciousness choreographer:",t)}}getConsciousnessContribution(){return{webglLuminosity:this.settings.flowStrength||.5,shaderComplexity:this.isWebGLAvailable?.8:0,gpuUtilization:this.isWebGLAvailable?.6:0,renderingPipeline:"forward",textureResolution:1}}onConsciousnessFieldUpdate(t){if(!(!this.isWebGLAvailable||!this.webglReady))try{this.currentConsciousnessField=t,this.updateShaderFromConsciousness(t),u?.debug?.log("WebGLGradientBackgroundSystem","Updated from consciousness field:",{rhythmicPulse:t.pulseRate,webglLuminosity:t.luminosity,emotionalTemperature:t.colorTemperature})}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Error updating from consciousness field:",i)}}onChoreographyEvent(t,i){if(!(!this.isWebGLAvailable||!this.webglReady))try{switch(t){case"choreography:rhythm-shift":this.frameThrottleInterval=1e3/Math.max(30,Math.min(60,i.newRhythm?.bpm/2||45));break;case"choreography:energy-surge":let n=i.intensity||1;this.cssController.setVariable("WebGLGradientBackgroundSystem","--sn-webgl-energy-surge",n.toString(),"high","choreography-energy-surge");break;case"consciousness:breathing-cycle":let r=i.phase||0;this.cssController.setVariable("WebGLGradientBackgroundSystem","--sn-webgl-breathing-sync",r.toString(),"normal","consciousness-breathing-cycle");break}u?.debug?.log("WebGLGradientBackgroundSystem",`Handled choreography event: ${t}`,i)}catch(n){u?.debug?.error("WebGLGradientBackgroundSystem",`Error handling choreography event ${t}:`,n)}}updateShaderFromConsciousness(t){if(!this.gl||!this.shaderProgram)return;let i=this.settings.flowStrength*(.5+t.pulseRate*.5),n=this.gl.getUniformLocation(this.shaderProgram,"u_flowStrength");n&&this.gl.uniform1f(n,i);let r=this.settings.noiseScale*(.8+t.flowDirection.x*.4),a=this.gl.getUniformLocation(this.shaderProgram,"u_noiseScale");a&&this.gl.uniform1f(a,r);let s=Math.sin(Date.now()*.001*t.pulseRate)*.1,o=this.gl.getUniformLocation(this.shaderProgram,"u_waveY");if(o){let m=[this.settings.waveY[0]+s,this.settings.waveY[1]-s];this.gl.uniform1fv(o,m)}let l={"--sn-webgl-consciousness-flow":i.toString(),"--sn-webgl-consciousness-noise":r.toString(),"--sn-webgl-breathing-phase":s.toString()};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",l,"normal","consciousness-shader-update")}adjustQuality(t){this.setQualityLevel(t)}setQualityLevel(t){switch(this.currentQualityLevel=t,t){case"low":this.settings.flowStrength=.5,this.settings.noiseScale=1,this.settings.waveHeight=[.3,.2],this.settings.blurExp=1,this.settings.blurMax=.4,this.frameThrottleInterval=1e3/30;break;case"medium":this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.blurExp=1.2,this.settings.blurMax=.6,this.frameThrottleInterval=1e3/45;break;case"high":this.settings.flowStrength=.9,this.settings.noiseScale=1.4,this.settings.waveHeight=[.5,.4],this.settings.blurExp=1.3,this.settings.blurMax=.7,this.frameThrottleInterval=1e3/60;break;default:this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.blurExp=1.2,this.settings.blurMax=.6,this.frameThrottleInterval=1e3/45;break}this.updateQualityCapabilities(t),u?.debug?.log("WebGLGradientBackgroundSystem",`Quality level set to: ${t}`,{flowStrength:this.settings.flowStrength,frameRate:1e3/this.frameThrottleInterval})}getPerformanceImpact(){let t=this.lastFrameTime>0?1e3/this.lastFrameTime:60,i=this.estimateMemoryUsage();return{fps:t,frameTime:this.lastFrameTime,memoryUsage:i,cpuUsage:this.estimateCPUUsage()}}reduceQuality(t){this.qualityAdjustments["flow-reduction"]=(this.qualityAdjustments["flow-reduction"]||0)+t,this.qualityAdjustments["noise-reduction"]=(this.qualityAdjustments["noise-reduction"]||0)+t*.8,this.qualityAdjustments["wave-reduction"]=(this.qualityAdjustments["wave-reduction"]||0)+t*.6,this.settings.flowStrength=Math.max(.1,this.settings.flowStrength*(1-t)),this.settings.noiseScale=Math.max(.5,this.settings.noiseScale*(1-t*.8)),this.settings.waveHeight=[Math.max(.1,this.settings.waveHeight[0]*(1-t*.6)),Math.max(.1,this.settings.waveHeight[1]*(1-t*.6))],t>.5&&(this.frameThrottleInterval=Math.min(1e3/15,this.frameThrottleInterval*(1+t))),u?.debug?.log("WebGLGradientBackgroundSystem",`Quality reduced by ${t}`,this.settings)}increaseQuality(t){if(Object.keys(this.qualityAdjustments).forEach(i=>{this.qualityAdjustments[i]=Math.max(0,(this.qualityAdjustments[i]||0)-t)}),this.currentQualityLevel){let i=this.getBaseSettingsForLevel(this.currentQualityLevel)||this.settings;this.settings.flowStrength=Math.min(i.flowStrength,this.settings.flowStrength*(1+t*.5)),this.settings.noiseScale=Math.min(i.noiseScale,this.settings.noiseScale*(1+t*.3));let n=this.currentQualityLevel==="high"?60:this.currentQualityLevel==="medium"?45:30;this.frameThrottleInterval=Math.max(1e3/n,this.frameThrottleInterval*(1-t*.3))}u?.debug?.log("WebGLGradientBackgroundSystem",`Quality increased by ${t}`,this.settings)}getQualityCapabilities(){return[...this.qualityCapabilities]}updateQualityCapabilities(t){this.qualityCapabilities.forEach(i=>{switch(i.name){case"webgl-rendering":i.enabled=!0;break;case"shader-complexity":i.enabled=t==="high"||t==="medium";break;case"blur-effects":i.enabled=t!=="low";break;case"corridor-effects":i.enabled=t!=="low",t==="low"&&this.settings.corridorEnabled&&(this.settings.corridorEnabled=!1);break;case"corridor-sdf-complexity":let n=t==="high"?1:t==="medium"?.8:.6;this.settings.corridorBubbleScale=Math.max(.5,1*n),i.enabled=t!=="low";break;case"corridor-bubble-layers":let r=t==="high"?1:t==="medium"?.8:.6;this.settings.corridorIntensity=Math.max(.3,.8*r),i.enabled=t==="high"||t==="medium";break;case"corridor-depth-effects":let a=t==="high"?1:t==="medium"?.7:.4;this.settings.corridorDepthEffect=Math.max(.1,.6*a),i.enabled=t!=="low";break;default:i.enabled=t!=="low"}})}getBaseSettingsForLevel(t){let i={...this.settings};switch(t){case"minimal":return{...i,flowStrength:.3,noiseScale:.8,corridorEnabled:!1,corridorIntensity:.3,corridorFlowStrength:.5,corridorDepthEffect:.2,corridorBubbleScale:.5};case"low":return{...i,flowStrength:.5,noiseScale:1,corridorEnabled:!1,corridorIntensity:.4,corridorFlowStrength:.8,corridorDepthEffect:.3,corridorBubbleScale:.6};case"medium":return{...i,flowStrength:.7,noiseScale:1.2,corridorEnabled:!0,corridorIntensity:.6,corridorFlowStrength:1,corridorDepthEffect:.5,corridorBubbleScale:.8};case"high":return{...i,flowStrength:.9,noiseScale:1.4,corridorEnabled:!0,corridorIntensity:.8,corridorFlowStrength:1.2,corridorDepthEffect:.6,corridorBubbleScale:1};case"ultra":return{...i,flowStrength:1,noiseScale:1.6,corridorEnabled:!0,corridorIntensity:1,corridorFlowStrength:1.4,corridorDepthEffect:.8,corridorBubbleScale:1.2};default:return i}}setCorridorEffectsEnabled(t){this.settings.corridorEnabled=t&&this.corridorShaderProgram!==null,this.cssController.setVariable("WebGLGradientBackgroundSystem","--sn-corridor-enabled",t?"1":"0","normal","corridor-settings-update"),u?.debug?.log("WebGLGradientBackgroundSystem",`Corridor effects ${t?"enabled":"disabled"}`)}updateCorridorSettings(t){t.corridorIntensity!==void 0&&(this.settings.corridorIntensity=Math.max(0,Math.min(1,t.corridorIntensity))),t.corridorFlowStrength!==void 0&&(this.settings.corridorFlowStrength=Math.max(0,Math.min(2,t.corridorFlowStrength))),t.corridorDepthEffect!==void 0&&(this.settings.corridorDepthEffect=Math.max(0,Math.min(1,t.corridorDepthEffect))),t.corridorBubbleScale!==void 0&&(this.settings.corridorBubbleScale=Math.max(.1,Math.min(2,t.corridorBubbleScale))),u?.debug?.log("WebGLGradientBackgroundSystem","Corridor settings updated",t)}estimateMemoryUsage(){let t=5;if(this.canvas&&this.gl){let i=this.canvas.width*this.canvas.height;t+=i*4/(1024*1024),this.gradientTexture&&(t+=1),this.vertexBuffer&&(t+=.1)}return t}estimateCPUUsage(){let t=this.isWebGLAvailable?5:15,i=this.settings.flowStrength+this.settings.noiseScale/2;return Math.min(50,t*i)}getSimplifiedFragmentShader(){return`#version 300 es
      precision highp float;

      in vec2 vTextureCoords;
      out vec4 fragColor;

      uniform sampler2D u_gradientTexture;
      uniform float u_time;
      uniform float u_intensity;
      uniform float u_flowStrength;
      uniform vec2 u_resolution;

      // Simplified noise function - uses basic sin/cos instead of complex noise
      float simpleNoise(vec2 st) {
        return sin(st.x * 12.9898 + st.y * 78.233) * 43758.5453;
      }

      void main() {
        vec2 uv = vTextureCoords;
        
        // Simple flow effect without complex noise
        vec2 flow = vec2(
          sin(u_time * 0.5 + uv.y * 3.0) * 0.1,
          cos(u_time * 0.3 + uv.x * 2.0) * 0.1
        ) * u_flowStrength;
        
        // Apply flow offset
        vec2 flowUV = uv + flow;
        
        // Simple gradient lookup with basic distortion
        vec4 gradientColor = texture(u_gradientTexture, flowUV);
        
        // Simple intensity modulation
        float intensity = u_intensity * (0.8 + 0.2 * sin(u_time + uv.x + uv.y));
        
        fragColor = vec4(gradientColor.rgb * intensity, gradientColor.a);
      }`}getBasicFragmentShader(){return`#version 300 es
      precision mediump float;

      in vec2 vTextureCoords;
      out vec4 fragColor;

      uniform sampler2D u_gradientTexture;
      uniform float u_intensity;

      void main() {
        vec2 uv = vTextureCoords;
        
        // Basic gradient lookup without any effects
        vec4 gradientColor = texture(u_gradientTexture, uv);
        
        // Simple intensity scaling
        fragColor = vec4(gradientColor.rgb * u_intensity, gradientColor.a);
      }`}getEmergencyFragmentShader(){return`#version 300 es
      precision lowp float;

      in vec2 vTextureCoords;
      out vec4 fragColor;

      uniform sampler2D u_gradientTexture;

      void main() {
        // Ultra-simple gradient lookup with minimal processing
        // Use lowp precision for maximum compatibility
        vec2 uv = vTextureCoords;
        
        // Simple gradient sample - no effects, no animations
        vec4 color = texture(u_gradientTexture, uv);
        
        // Emergency mode: ensure we always output something visible
        // Fallback to magenta if texture fails (indicates shader compilation success)
        if (color.a < 0.01) {
          fragColor = vec4(0.2, 0.1, 0.3, 1.0); // Dark purple fallback
        } else {
          fragColor = color;
        }
      }`}shouldPersistWebGL(){return this.settings.webglPersistenceMode==="persistent"?!0:this.settings.webglPersistenceMode==="fallback"?!1:this.settings.webglPersistenceMode==="adaptive"&&this.settings.enabled&&this.isWebGLAvailable}shouldAttemptWebGLRecovery(){return this.shouldPersistWebGL()}applyContinuousQuality(t){try{let i=t;u?.debug?.log("WebGLGradientBackgroundSystem",`Applying simplified quality level: ${i}`),this.setQualityLevel(i),this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",{"--sn-webgl-quality-level":i,"--sn-webgl-corridor-enabled":this.settings.corridorEnabled?"1":"0"},"high","continuous-quality-update"),this.initialized&&this.gl&&this.forceRepaint("quality-level-changed")}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to apply continuous quality:",i)}}getCurrentQualityImpact(){let t=this.gl!==null&&this.isWebGLAvailable,i=this.settings.corridorEnabled&&this.corridorShaderProgram!==null,n=t?.15:.05,r=t?.1:.03,a=t?.2:0,s=i?.1:0,o=i?.05:0,l=i?.15:0,m=Math.max(.5,this.settings.flowStrength/2),d=60;return i&&(d-=10),this.settings.intensity==="intense"&&(d-=5),d=Math.max(30,d),{cpu:Math.min(1,(n+s)*m),memory:Math.min(1,(r+o)*m),gpu:Math.min(1,(a+l)*m),estimatedFPS:d}}onVisualStateUpdate(t){this.onConsciousnessFieldUpdate(t)}onVisualEffectEvent(t,i){switch(t){case"visual:rhythm-shift":i.intensity&&(this.settings.flowStrength=Math.min(5,i.intensity*3));break;case"visual:color-shift":this.forceRepaint("color-shift");break;case"visual:energy-surge":i.intensity>.7&&this.forceRepaint("energy-surge");break}}getVisualContribution(){return{luminosity:this.settings.intensity==="intense"?.8:.5,fluidIntensity:this.settings.flowStrength/5,effectDepth:this.getCurrentQualityImpact().cpu}}}});var Li,Cs=b(()=>{"use strict";U();R();de();Li=class extends Q{constructor(t=w,i,n,r=null,a=null){super(t,i,n,r,a);this.systemName="CSSBlobFallbackSystem";this.blobContainer=null;this.blobElements=[];this.isActive=!1;this.settings={enabled:!0,blobCount:6,musicResponsive:!0,performanceMode:!1,debugMode:!1,organicFlow:!0,membraneElasticity:.7,musicSync:!0,emotionalTemperature:.5,cellularGrowth:!0,organicBreathing:!0,fluidDynamics:!0};this.handleBeatEvent=t=>{if(!this.isActive||!this.settings.musicResponsive)return;let i=t,{intensity:n=.5}=i.detail||{};this.blobElements.forEach(a=>{a.classList.add("sn-beat-active")}),setTimeout(()=>{this.blobElements.forEach(a=>{a.classList.remove("sn-beat-active")})},500);let r=1+n*.15;document.documentElement.style.setProperty("--css-blob-beat-scale",r.toString())};this.handleEnergyChange=t=>{if(!this.isActive||!this.settings.musicResponsive)return;let i=t,{energy:n=.5}=i.detail||{};document.documentElement.style.setProperty("--css-blob-music-response",n.toString()),document.documentElement.style.setProperty("--css-blob-energy-opacity",(.4+n*.4).toString());let r=.8+n*.4,a=Math.round(8e3/r),s=Math.round(4e3/r);document.documentElement.style.setProperty("--css-blob-movement-speed",`${a}ms`),document.documentElement.style.setProperty("--css-blob-breathing-speed",`${s}ms`)};this.handleGenreChange=t=>{if(!this.isActive||!this.settings.musicResponsive)return;let i=t,{genre:n="unknown"}=i.detail||{};this.blobElements.forEach((r,a)=>{r.classList.remove("genre-electronic","genre-ambient","genre-classical");let s="genre-electronic";n.includes("ambient")||n.includes("chill")?s="genre-ambient":n.includes("classical")||n.includes("orchestral")?s="genre-classical":(n.includes("electronic")||n.includes("techno")||n.includes("house"))&&(s="genre-electronic");let o=["genre-electronic","genre-ambient","genre-classical"],l=(a+o.indexOf(s))%o.length,m=o[l];m&&r.classList.add(m)}),u?.debug?.log("CSSBlobFallbackSystem",`Updated blob genres for: ${n}`)}}async _performSystemSpecificInitialization(){if(await super._performSystemSpecificInitialization(),this.loadSettings(),this.checkWebGLAvailability()&&!this.settings.debugMode){u?.debug?.log("CSSBlobFallbackSystem","WebGL available - CSS blob fallback not needed");return}if(!this.settings.enabled){u?.debug?.log("CSSBlobFallbackSystem","CSS blob fallback disabled in settings");return}(this.performanceMonitor?.shouldReduceQuality?.()||!1)&&(this.settings.performanceMode=!0,this.settings.blobCount=Math.min(this.settings.blobCount,3));try{this.createBlobContainer(),this.createBlobElements(),this.settings.musicResponsive&&this.subscribeToEvents(),this.updateCSSVariables(),this.isActive=!0,u?.debug?.log("CSSBlobFallbackSystem",`CSS blob fallback activated with ${this.settings.blobCount} blobs`,{performanceMode:this.settings.performanceMode,musicResponsive:this.settings.musicResponsive})}catch(n){u?.debug?.error("CSSBlobFallbackSystem","Failed to initialize:",n)}}loadSettings(){if(this.settingsManager)try{let t=this.settingsManager?.get("sn-gradient-intensity"),i=this.settingsManager?.get("sn-performance-mode");switch(t){case"disabled":this.settings.enabled=!1;break;case"minimal":this.settings.blobCount=3,this.settings.musicResponsive=!1;break;case"balanced":this.settings.blobCount=6,this.settings.musicResponsive=!0;break;case"intense":this.settings.blobCount=8,this.settings.musicResponsive=!0;break}i==="enabled"&&(this.settings.performanceMode=!0,this.settings.blobCount=Math.min(this.settings.blobCount,4))}catch(t){u?.debug?.warn("CSSBlobFallbackSystem","Failed to load settings:",t)}}checkWebGLAvailability(){try{let t=document.createElement("canvas");return!!(t.getContext("webgl")||t.getContext("experimental-webgl"))}catch{return!1}}createBlobContainer(){let t=this.findTargetContainer();this.blobContainer=document.createElement("div"),this.blobContainer.className="sn-css-blob-container",this.settings.debugMode&&this.blobContainer.classList.add("css-blob-debug"),this.settings.performanceMode&&this.blobContainer.classList.add("css-blob-performance"),t.appendChild(this.blobContainer),u?.debug?.log("CSSBlobFallbackSystem","Blob container created and inserted")}createBlobElements(){if(this.blobContainer){this.blobElements.forEach(t=>t.remove()),this.blobElements=[];for(let t=0;t<this.settings.blobCount;t++){let i=document.createElement("div");i.className="sn-css-blob",i.setAttribute("data-blob-index",t.toString());let n=["genre-electronic","genre-ambient","genre-classical"],r=n[t%n.length];r&&i.classList.add(r),this.blobContainer.appendChild(i),this.blobElements.push(i)}u?.debug?.log("CSSBlobFallbackSystem",`Created ${this.settings.blobCount} blob elements`)}}findTargetContainer(){let t=[".Root__main-view",".main-view-container",".Root__top-container","body"];for(let i of t){let n=document.querySelector(i);if(n)return n}return document.body}updateCSSVariables(){document.documentElement.style.setProperty("--css-blob-enabled","1"),document.documentElement.style.setProperty("--css-blob-count",this.settings.blobCount.toString()),this.settings.performanceMode&&(document.documentElement.style.setProperty("--css-blob-quality","0"),document.documentElement.style.setProperty("--css-blob-filter-quality","0")),document.documentElement.style.setProperty("--sn-consciousness-organic-mode",this.settings.organicFlow?"1":"0"),document.documentElement.style.setProperty("--sn-consciousness-membrane-elasticity",this.settings.membraneElasticity.toString()),document.documentElement.style.setProperty("--sn-consciousness-musical-emotion",this.settings.emotionalTemperature.toString()),document.documentElement.style.setProperty("--sn-consciousness-cellular-growth",this.settings.cellularGrowth?"1":"0"),document.documentElement.style.setProperty("--sn-consciousness-breathing-intensity",this.settings.organicBreathing?"1":"0"),document.documentElement.style.setProperty("--sn-consciousness-viscosity",this.settings.fluidDynamics?"0.4":"0"),document.documentElement.style.setProperty("--sn-consciousness-css-fallback","1.0"),document.documentElement.style.setProperty("--sn-consciousness-webgl-coordination","0")}subscribeToEvents(){this.settings.musicResponsive&&(document.addEventListener("music-sync:beat-detected",this.handleBeatEvent),document.addEventListener("music-sync:energy-changed",this.handleEnergyChange),document.addEventListener("music-sync:genre-changed",this.handleGenreChange),document.addEventListener("year3000SystemSettingsChanged",this.handleSettingsChange.bind(this)),u?.debug?.log("CSSBlobFallbackSystem","Subscribed to music and settings events"))}handleSettingsChange(t){let i=t,{key:n}=i.detail||{};(n.startsWith("sn-gradient-")||n.startsWith("sn-performance-"))&&(this.loadSettings(),this.isActive&&this.blobContainer&&(this.createBlobElements(),this.updateCSSVariables()))}updateAnimation(t){}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),this.settings.musicResponsive&&(document.removeEventListener("music-sync:beat-detected",this.handleBeatEvent),document.removeEventListener("music-sync:energy-changed",this.handleEnergyChange),document.removeEventListener("music-sync:genre-changed",this.handleGenreChange),document.removeEventListener("year3000SystemSettingsChanged",this.handleSettingsChange.bind(this))),this.blobElements.forEach(t=>t.remove()),this.blobElements=[],this.blobContainer&&this.blobContainer.parentNode&&this.blobContainer.parentNode.removeChild(this.blobContainer),this.blobContainer=null,document.documentElement.style.removeProperty("--css-blob-enabled"),document.documentElement.style.removeProperty("--css-blob-count"),document.documentElement.style.removeProperty("--css-blob-quality"),this.isActive=!1,u?.debug?.log("CSSBlobFallbackSystem","CSS blob fallback system cleanup completed")}setEnabled(t){this.settings.enabled=t,this.blobContainer&&(this.blobContainer.style.display=t?"":"none"),document.documentElement.style.setProperty("--css-blob-enabled",t?"1":"0")}setPerformanceMode(t){this.settings.performanceMode=t,this.blobContainer&&this.blobContainer.classList.toggle("css-blob-performance",t),document.documentElement.style.setProperty("--css-blob-quality",t?"0":"1"),document.documentElement.style.setProperty("--css-blob-filter-quality",t?"0":"1")}setOrganicFlow(t){this.settings.organicFlow=t,document.documentElement.style.setProperty("--sn-consciousness-organic-mode",t?"1":"0")}setMembraneElasticity(t){this.settings.membraneElasticity=Math.max(0,Math.min(1,t)),document.documentElement.style.setProperty("--sn-consciousness-membrane-elasticity",this.settings.membraneElasticity.toString())}setConsciousnessSync(t){this.settings.musicSync=t}setEmotionalTemperature(t){this.settings.emotionalTemperature=Math.max(0,Math.min(1,t)),document.documentElement.style.setProperty("--sn-consciousness-musical-emotion",this.settings.emotionalTemperature.toString())}setCellularGrowth(t){this.settings.cellularGrowth=t,document.documentElement.style.setProperty("--sn-consciousness-cellular-growth",t?"1":"0")}setOrganicBreathing(t){this.settings.organicBreathing=t,document.documentElement.style.setProperty("--sn-consciousness-breathing-intensity",t?"1":"0")}setFluidDynamics(t){this.settings.fluidDynamics=t,document.documentElement.style.setProperty("--sn-consciousness-viscosity",t?"0.4":"0")}getStatus(){return{isActive:this.isActive,settings:{...this.settings},blobCount:this.blobElements.length,hasContainer:!!this.blobContainer}}}});var Bi,Ms=b(()=>{"use strict";$();D();R();de();Bi=class extends Q{constructor(t,i,n,r,a){super(t,i,n,r,a);this.systemName="ConsciousnessUIEffectsController";this.consciousnessChoreographer=null;this.currentConsciousnessField=null;this.shimmerElements=new Map;this.mutationObserver=null;this.intersectionObserver=null;this.animationFrameId=null;this.lastFrameTime=0;this.frameTimeHistory=[];this.eventUnsubscribeFunctions=[];this.customPerformanceMonitor={frameCount:0,totalFrameTime:0,lastPerformanceCheck:0,adaptiveQualityLevel:1};this.diagnosticTimerId=null;this.lastDiagnosticRun=0;this.uiEffectsConfig={enabled:!0,consciousnessThreshold:.3,shimmerEnabled:!0,shimmerIntensity:.6,shimmerType:"mixed",shimmerPerformanceLevel:"balanced",interactionTrackingEnabled:!0,digitalMeditationThreshold:3e4,scrollVelocityTracking:!0,diagnosticEnabled:!0,autoFixWhiteLayer:!0,diagnosticInterval:5e3,audioVisualEnabled:!0,beatSynchronization:!0,nebulaEffectIntensity:this.getNebulaIntensityFromSettings(),scrollEffectsEnabled:!0,prismaticSheenIntensity:.5,maxFrameTime:1,adaptiveQuality:!0,debugMode:t.enableDebug||!1},this.consciousnessState=this.createInitialConsciousnessState(),u?.debug?.log("ConsciousnessUIEffectsController","Unified UI effects consciousness controller created")}get systemPriority(){return"normal"}getNebulaIntensityFromSettings(){if(!this.settingsManager)return .7;switch(this.settingsManager.get("sn-gradient-intensity")){case"disabled":return 0;case"minimal":return .3;case"balanced":return .7;case"intense":return 1;default:return .7}}createInitialConsciousnessState(){return{consciousnessLevel:"dormant",shimmer:{intensity:0,effectType:"mixed",activeElements:new Set,performanceLevel:this.uiEffectsConfig.shimmerPerformanceLevel},interaction:{isActive:!1,lastInteractionTime:0,digitalMeditationDetected:!1,scrollVelocity:{x:0,y:0,direction:"none"},nexusState:"idle"},diagnostic:{whiteLayerIssues:[],webglContextHealthy:!0,lastDiagnosticTime:0,autoFixEnabled:this.uiEffectsConfig.autoFixWhiteLayer,criticalIssuesDetected:0},audioVisual:{beatIntensity:0,genreChangeDetected:!1,nebulaEffectIntensity:0,lastBeatTime:0,performanceAdaptive:this.uiEffectsConfig.adaptiveQuality},scroll:{sheenIntensity:0,scrollRatio:0,prismaticEffectActive:!1,lastScrollTime:0},performance:{frameTime:0,avgFrameTime:0,maxFrameTime:0,healthStatus:"excellent",adaptiveQualityEnabled:this.uiEffectsConfig.adaptiveQuality}}}async initialize(){try{u?.debug?.log("ConsciousnessUIEffectsController","Starting unified UI effects initialization..."),await this.initializeCSSConsciousness(),await this.initializeConsciousnessIntegration(),this.subscribeToUnifiedEvents(),this.uiEffectsConfig.shimmerEnabled&&await this.initializeShimmerEffects(),this.uiEffectsConfig.interactionTrackingEnabled&&await this.initializeInteractionTracking(),this.uiEffectsConfig.diagnosticEnabled&&await this.initializeDiagnosticSystem(),this.uiEffectsConfig.audioVisualEnabled&&await this.initializeAudioVisualEffects(),this.uiEffectsConfig.scrollEffectsEnabled&&await this.initializeScrollEffects(),this.startUnifiedAnimationLoop(),this.initialized=!0,u?.debug?.log("ConsciousnessUIEffectsController","Unified UI effects consciousness initialized")}catch(t){throw u?.debug?.error("ConsciousnessUIEffectsController","Failed to initialize:",t),t}}async initializeCSSConsciousness(){try{this.cssController=globalThis.unifiedCSSConsciousnessController||null,this.cssController=T(),this.cssController?u?.debug?.log("ConsciousnessUIEffectsController","Connected to unified CSS consciousness"):u?.debug?.warn("ConsciousnessUIEffectsController","CSS consciousness not available, using coordinator fallback")}catch(t){u?.debug?.warn("ConsciousnessUIEffectsController","CSS consciousness initialization failed:",t)}}async initializeConsciousnessIntegration(){try{this.consciousnessChoreographer=globalThis.backgroundConsciousnessChoreographer||null,this.consciousnessChoreographer?(this.consciousnessChoreographer.registerConsciousnessParticipant(this),u?.debug?.log("ConsciousnessUIEffectsController","Registered with consciousness choreographer")):u?.debug?.log("ConsciousnessUIEffectsController","Operating without consciousness choreographer integration")}catch(t){u?.debug?.warn("ConsciousnessUIEffectsController","Consciousness integration failed:",t)}}subscribeToUnifiedEvents(){let t=p.subscribe("music:beat",this.handleMusicBeat.bind(this),"ConsciousnessUIEffectsController");this.eventUnsubscribeFunctions.push(()=>p.unsubscribe(t));let i=p.subscribe("music:energy",this.handleMusicEnergy.bind(this),"ConsciousnessUIEffectsController");this.eventUnsubscribeFunctions.push(()=>p.unsubscribe(i));let n=p.subscribe("settings:changed",this.handleSettingsChange.bind(this),"ConsciousnessUIEffectsController");this.eventUnsubscribeFunctions.push(()=>p.unsubscribe(n)),u?.debug?.log("ConsciousnessUIEffectsController",`Subscribed to ${this.eventUnsubscribeFunctions.length} unified events`)}async initializeShimmerEffects(){try{this.setupElementObservers(),await this.discoverShimmerElements(),u?.debug?.log("ConsciousnessUIEffectsController",`Shimmer effects initialized with ${this.shimmerElements.size} elements`)}catch(t){u?.debug?.error("ConsciousnessUIEffectsController","Shimmer effects initialization failed:",t)}}async initializeInteractionTracking(){try{this.setupInteractionListeners(),u?.debug?.log("ConsciousnessUIEffectsController","Interaction tracking initialized")}catch(t){u?.debug?.error("ConsciousnessUIEffectsController","Interaction tracking initialization failed:",t)}}async initializeDiagnosticSystem(){try{this.startDiagnosticMonitoring(),u?.debug?.log("ConsciousnessUIEffectsController","Diagnostic system initialized")}catch(t){u?.debug?.error("ConsciousnessUIEffectsController","Diagnostic system initialization failed:",t)}}async initializeAudioVisualEffects(){try{u?.debug?.log("ConsciousnessUIEffectsController","Audio-visual effects initialized")}catch(t){u?.debug?.error("ConsciousnessUIEffectsController","Audio-visual effects initialization failed:",t)}}async initializeScrollEffects(){try{u?.debug?.log("ConsciousnessUIEffectsController","Scroll effects initialized")}catch(t){u?.debug?.error("ConsciousnessUIEffectsController","Scroll effects initialization failed:",t)}}setupElementObservers(){typeof MutationObserver<"u"&&(this.mutationObserver=new MutationObserver(t=>{let i=!1;t.forEach(n=>{n.type==="childList"&&n.addedNodes.forEach(r=>{r.nodeType===Node.ELEMENT_NODE&&(i=!0)})}),i&&this.discoverShimmerElements()}),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0})),typeof IntersectionObserver<"u"&&(this.intersectionObserver=new IntersectionObserver(t=>{t.forEach(i=>{let n=i.target.getAttribute("data-shimmer-id");n&&(i.isIntersecting?this.consciousnessState.shimmer.activeElements.add(n):this.consciousnessState.shimmer.activeElements.delete(n))})},{threshold:[0,.1,.5,1]}))}async discoverShimmerElements(){let t=[".main-card-card",".main-trackList-trackListRow",".main-button-primary",".main-playButton-button",'[data-testid="card-click-handler"]'],i=0;t.forEach(n=>{document.querySelectorAll(n).forEach((a,s)=>{let o=`shimmer-${n.replace(/[^\w]/g,"_")}-${s}`,l=a;l.setAttribute("data-shimmer-id",o),this.shimmerElements.set(o,l),this.intersectionObserver&&this.intersectionObserver.observe(l),i++})}),this.uiEffectsConfig.debugMode&&i>0&&u?.debug?.log("ConsciousnessUIEffectsController",`Discovered ${i} shimmer elements`)}setupInteractionListeners(){["click","keydown","mousemove","scroll","touchstart"].forEach(i=>{document.addEventListener(i,()=>{this.consciousnessState.interaction.isActive=!0,this.consciousnessState.interaction.lastInteractionTime=Date.now(),this.consciousnessState.interaction.digitalMeditationDetected=!1,this.updateNexusState()},{passive:!0})})}startDiagnosticMonitoring(){this.diagnosticTimerId=window.setInterval(()=>{this.runDiagnosticCheck()},this.uiEffectsConfig.diagnosticInterval)}startUnifiedAnimationLoop(){let t=i=>{if(!this.initialized)return;let n=i-this.lastFrameTime;this.lastFrameTime=i;let r=performance.now();try{this.updateConsciousnessState(n),this.uiEffectsConfig.shimmerEnabled&&this.updateShimmerEffects(n),this.uiEffectsConfig.interactionTrackingEnabled&&this.updateInteractionTracking(n),this.uiEffectsConfig.audioVisualEnabled&&this.updateAudioVisualEffects(n),this.uiEffectsConfig.scrollEffectsEnabled&&this.updateScrollEffects(n),this.applyCSSUpdates();let a=performance.now()-r;this.updatePerformanceMetrics(a),a>this.uiEffectsConfig.maxFrameTime&&this.handlePerformanceIssue(a)}catch(a){u?.debug?.error("ConsciousnessUIEffectsController","Animation loop error:",a)}this.animationFrameId=requestAnimationFrame(t)};this.animationFrameId=requestAnimationFrame(t)}updateConsciousnessState(t){let i=this.consciousnessState,n=i.shimmer.intensity*.2+(i.interaction.isActive?.3:0)+i.audioVisual.beatIntensity*.3+i.scroll.sheenIntensity*.2;n>.8?i.consciousnessLevel="transcendent":n>.5?i.consciousnessLevel="focused":n>.2?i.consciousnessLevel="aware":i.consciousnessLevel="dormant"}updateShimmerEffects(t){let i=this.consciousnessState.shimmer,n=this.consciousnessState.audioVisual.beatIntensity*.3,r=this.consciousnessState.interaction.isActive?.2:0;i.intensity=Math.min(this.uiEffectsConfig.shimmerIntensity+n+r,1),this.consciousnessState.performance.healthStatus==="degraded"?i.intensity*=.7:this.consciousnessState.performance.healthStatus==="critical"&&(i.intensity*=.3)}updateInteractionTracking(t){let i=this.consciousnessState.interaction,r=Date.now()-i.lastInteractionTime;r>this.uiEffectsConfig.digitalMeditationThreshold&&(i.digitalMeditationDetected||(i.digitalMeditationDetected=!0,u?.debug?.log("ConsciousnessUIEffectsController","Digital meditation detected",{inactiveTime:r}))),this.updateNexusState()}updateNexusState(){let t=this.consciousnessState.interaction,n=Date.now()-t.lastInteractionTime;t.digitalMeditationDetected?t.nexusState="meditation":n<1e3?t.nexusState="active":n<1e4?t.nexusState="flow":t.nexusState="idle"}updateAudioVisualEffects(t){let i=this.consciousnessState.audioVisual,n=this.consciousnessState.consciousnessLevel==="transcendent"?.2:0;i.nebulaEffectIntensity=Math.min(this.uiEffectsConfig.nebulaEffectIntensity+i.beatIntensity*.3+n,1)}updateScrollEffects(t){let i=this.consciousnessState.scroll;Date.now()-i.lastScrollTime<1e3?(i.prismaticEffectActive=!0,i.sheenIntensity=Math.min(i.scrollRatio*this.uiEffectsConfig.prismaticSheenIntensity,1)):(i.prismaticEffectActive=!1,i.sheenIntensity*=.95)}applyCSSUpdates(){let t=this.consciousnessState,i={"--sn-ui-consciousness-level":t.consciousnessLevel,"--sn-shimmer-intensity":t.shimmer.intensity.toFixed(3),"--sn-shimmer-effect-type":t.shimmer.effectType,"--sn-shimmer-performance":t.shimmer.performanceLevel,"--sn-interaction-nexus-state":t.interaction.nexusState,"--sn-interaction-meditation":t.interaction.digitalMeditationDetected?"1":"0","--sn-scroll-velocity-x":t.interaction.scrollVelocity.x.toFixed(2),"--sn-scroll-velocity-y":t.interaction.scrollVelocity.y.toFixed(2),"--sn-beat-intensity":t.audioVisual.beatIntensity.toFixed(3),"--sn-nebula-intensity":t.audioVisual.nebulaEffectIntensity.toFixed(3),"--sn-genre-change":t.audioVisual.genreChangeDetected?"1":"0","--sn-scroll-sheen-intensity":t.scroll.sheenIntensity.toFixed(3),"--sn-scroll-ratio":t.scroll.scrollRatio.toFixed(3),"--sn-prismatic-active":t.scroll.prismaticEffectActive?"1":"0","--sn-white-layer-issues":t.diagnostic.whiteLayerIssues.length.toString(),"--sn-webgl-healthy":t.diagnostic.webglContextHealthy?"1":"0"};try{this.cssController.batchSetVariables("ConsciousnessUIEffectsController",i,"normal","ui-consciousness-update")}catch(n){u?.debug?.warn("ConsciousnessUIEffectsController","CSS coordination error:",n)}}updatePerformanceMetrics(t){let i=this.consciousnessState.performance;i.frameTime=t,this.frameTimeHistory.push(t),this.frameTimeHistory.length>60&&this.frameTimeHistory.shift(),i.avgFrameTime=this.frameTimeHistory.reduce((n,r)=>n+r,0)/this.frameTimeHistory.length,i.maxFrameTime=Math.max(...this.frameTimeHistory),i.avgFrameTime>2?i.healthStatus="critical":i.avgFrameTime>1.5?i.healthStatus="degraded":i.avgFrameTime>1?i.healthStatus="good":i.healthStatus="excellent"}handlePerformanceIssue(t){this.uiEffectsConfig.adaptiveQuality&&(this.customPerformanceMonitor.adaptiveQualityLevel*=.9,this.customPerformanceMonitor.adaptiveQualityLevel<.5&&(this.consciousnessState.shimmer.performanceLevel="minimal"),this.uiEffectsConfig.debugMode&&u?.debug?.warn("ConsciousnessUIEffectsController",`Performance issue: ${t.toFixed(2)}ms, reduced quality to ${this.customPerformanceMonitor.adaptiveQualityLevel.toFixed(2)}`))}runDiagnosticCheck(){let t=this.consciousnessState.diagnostic,i=Date.now();t.lastDiagnosticTime=i,t.whiteLayerIssues=[];try{let n=document.createElement("canvas"),r=n.getContext("webgl")||n.getContext("experimental-webgl");t.webglContextHealthy=!!r;let a=document.querySelectorAll('[style*="background"], [style*="color"]'),s=0;a.forEach(o=>{let l=window.getComputedStyle(o);(l.backgroundColor==="rgb(255, 255, 255)"||l.color==="rgb(255, 255, 255)")&&s++}),s>10&&(t.whiteLayerIssues.push(`Excessive white layers detected: ${s}`),t.autoFixEnabled&&this.autoFixWhiteLayerIssues()),t.criticalIssuesDetected=t.whiteLayerIssues.length}catch(n){u?.debug?.error("ConsciousnessUIEffectsController","Diagnostic check failed:",n)}}autoFixWhiteLayerIssues(){try{this.cssController.batchSetVariables("ConsciousnessUIEffectsController",{"--spice-text":"var(--spice-main)","--spice-subtext":"var(--catppuccin-text)"},"critical","white-layer-autofix"),this.uiEffectsConfig.debugMode&&u?.debug?.log("ConsciousnessUIEffectsController","Applied white layer auto-fix")}catch(t){u?.debug?.error("ConsciousnessUIEffectsController","Auto-fix failed:",t)}}handleMusicBeat(t){let i=this.consciousnessState.audioVisual;if(i.beatIntensity=t.intensity||.5,i.lastBeatTime=Date.now(),this.uiEffectsConfig.shimmerEnabled){let n=i.beatIntensity*.2;this.consciousnessState.shimmer.intensity=Math.min(this.consciousnessState.shimmer.intensity+n,1)}}handleMusicEnergy(t){let i=this.consciousnessState.audioVisual;t.energy!==void 0&&(i.beatIntensity=Math.max(i.beatIntensity,t.energy*.8))}handleGenreChange(t){let i=this.consciousnessState.audioVisual;i.genreChangeDetected=!0,setTimeout(()=>{i.genreChangeDetected=!1},2e3)}handleUserScroll(t){let i=this.consciousnessState.scroll,n=this.consciousnessState.interaction;i.lastScrollTime=Date.now(),i.scrollRatio=t.scrollRatio||0,t.velocity&&(n.scrollVelocity={x:t.velocity.x||0,y:t.velocity.y||0,direction:t.direction||"none"}),this.handleUserInteraction({type:"scroll",timestamp:Date.now()})}handleUserInteraction(t){let i=this.consciousnessState.interaction;i.isActive=!0,i.lastInteractionTime=t.timestamp||Date.now(),i.digitalMeditationDetected=!1,this.updateNexusState()}handleSettingsChange(t){let{key:i,value:n}=t;i.startsWith("sn-ui-effects-")?this.updateConfigFromSettings(i,n):i==="sn-gradient-intensity"&&(this.uiEffectsConfig.nebulaEffectIntensity=this.getNebulaIntensityFromSettings(),u?.debug?.log("ConsciousnessUIEffectsController",`Updated nebula intensity to: ${this.uiEffectsConfig.nebulaEffectIntensity} from consolidated gradient setting: ${n}`))}updateConfigFromSettings(t,i){switch(t){case"sn-ui-effects-shimmer-intensity":this.uiEffectsConfig.shimmerIntensity=parseFloat(i)||.6;break;case"sn-ui-effects-diagnostic-enabled":this.uiEffectsConfig.diagnosticEnabled=i==="true"||i===!0;break;case"sn-ui-effects-adaptive-quality":this.uiEffectsConfig.adaptiveQuality=i==="true"||i===!0;break}}getConsciousnessContribution(){return{systemName:this.systemName,consciousnessLevel:this.consciousnessState.consciousnessLevel,shimmerIntensity:this.consciousnessState.shimmer.intensity,interactionState:this.consciousnessState.interaction.nexusState,audioVisualIntensity:this.consciousnessState.audioVisual.nebulaEffectIntensity,scrollActivity:this.consciousnessState.scroll.sheenIntensity,timestamp:Date.now()}}onConsciousnessFieldUpdate(t){try{this.currentConsciousnessField=t;let i=t.pulseRate*.2;this.consciousnessState.shimmer.intensity=Math.min(this.consciousnessState.shimmer.intensity+i,1),this.consciousnessState.audioVisual.nebulaEffectIntensity=Math.min(this.consciousnessState.audioVisual.nebulaEffectIntensity+i*.3,1)}catch(i){u?.debug?.error("ConsciousnessUIEffectsController","Error updating from consciousness field:",i)}}onChoreographyEvent(t,i){t==="transition:start"&&(this.consciousnessState.shimmer.intensity=Math.min(this.consciousnessState.shimmer.intensity+.2,1),this.consciousnessState.audioVisual.nebulaEffectIntensity=Math.min(this.consciousnessState.audioVisual.nebulaEffectIntensity+.15,1)),this.uiEffectsConfig.debugMode&&u?.debug?.log("ConsciousnessUIEffectsController",`Choreography event: ${t}`,i)}async healthCheck(){let t=this.consciousnessState,i=this.initialized&&t.performance.healthStatus!=="critical"&&t.diagnostic.criticalIssuesDetected===0;return{healthy:i,ok:i,details:`UI Effects Consciousness: ${t.consciousnessLevel}, Shimmer: ${t.shimmer.activeElements.size} elements, Interaction: ${t.interaction.nexusState}, Performance: ${t.performance.healthStatus}, Diagnostics: ${t.diagnostic.criticalIssuesDetected} issues`,system:"ConsciousnessUIEffectsController"}}updateConfiguration(t){Object.assign(this.uiEffectsConfig,t),t.shimmerEnabled!==void 0&&t.shimmerEnabled&&!this.consciousnessState.shimmer.activeElements.size&&this.discoverShimmerElements(),t.diagnosticEnabled!==void 0&&(t.diagnosticEnabled&&!this.diagnosticTimerId?this.startDiagnosticMonitoring():!t.diagnosticEnabled&&this.diagnosticTimerId&&(clearInterval(this.diagnosticTimerId),this.diagnosticTimerId=null)),u?.debug?.log("ConsciousnessUIEffectsController","Configuration updated:",t)}getConfiguration(){return{...this.uiEffectsConfig}}getConsciousnessState(){return{...this.consciousnessState}}getShimmerElements(){return new Map(this.shimmerElements)}getInteractionState(){return this.consciousnessState.interaction}getDiagnosticState(){return this.consciousnessState.diagnostic}async destroy(){u?.debug?.log("ConsciousnessUIEffectsController","Destroying unified UI effects controller..."),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.diagnosticTimerId&&(clearInterval(this.diagnosticTimerId),this.diagnosticTimerId=null),this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.intersectionObserver=null);for(let t of this.eventUnsubscribeFunctions)t();this.eventUnsubscribeFunctions=[],this.shimmerElements.clear(),this.consciousnessChoreographer,this.initialized=!1,u?.debug?.log("ConsciousnessUIEffectsController","Unified UI effects controller destroyed")}onVisualStateUpdate(t){t.musicIntensity>.6&&this.triggerIntensityEffects(t.musicIntensity),t.colorTemperature&&this.updateTemperatureEffects(t.colorTemperature)}onVisualEffectEvent(t,i){switch(t){case"visual:rhythm-shift":this.triggerShimmerEffects(i.intensity||.5);break;case"visual:color-shift":this.updateTemperatureEffects(i.temperature||6500);break;case"visual:energy-surge":i.intensity>.7&&this.triggerIntensityEffects(i.intensity);break}}getVisualContribution(){return{visualCoherence:this.consciousnessState.consciousnessLevel==="transcendent"?1:.7,systemHarmony:this.consciousnessState.shimmer.intensity,effectDepth:this.consciousnessState.audioVisual.nebulaEffectIntensity}}triggerIntensityEffects(t){this.uiEffectsConfig.shimmerEnabled&&(this.consciousnessState.shimmer.intensity=Math.min(this.consciousnessState.shimmer.intensity+t*.3,1)),this.uiEffectsConfig.audioVisualEnabled&&(this.consciousnessState.audioVisual.nebulaEffectIntensity=Math.min(this.consciousnessState.audioVisual.nebulaEffectIntensity+t*.2,1)),this.uiEffectsConfig.scrollEffectsEnabled&&(this.consciousnessState.scroll.sheenIntensity=Math.min(this.consciousnessState.scroll.sheenIntensity+t*.1,1))}updateTemperatureEffects(t){let i=Math.max(1e3,Math.min(1e4,t));this.uiEffectsConfig.shimmerEnabled&&(i<3e3?this.consciousnessState.shimmer.effectType="prism":i>7e3?this.consciousnessState.shimmer.effectType="oil-slick":this.consciousnessState.shimmer.effectType="rainbow");let n=(i-1e3)/9e3;this.uiEffectsConfig.audioVisualEnabled&&(this.consciousnessState.audioVisual.nebulaEffectIntensity=Math.min(this.consciousnessState.audioVisual.nebulaEffectIntensity+n*.1,1))}triggerShimmerEffects(t){if(!this.uiEffectsConfig.shimmerEnabled)return;this.consciousnessState.shimmer.intensity=Math.min(this.consciousnessState.shimmer.intensity+t*.4,1);let i=this.consciousnessState.shimmer.effectType;this.consciousnessState.shimmer.effectType="mixed",setTimeout(()=>{this.consciousnessState.shimmer.effectType=i},2e3)}}});var Fi,ws=b(()=>{"use strict";Ai();$();D();R();Fi=class extends Ve{constructor(t){super(t);this.effectsState={energy:.5,valence:.5,tempo:120,harmonyHue:0,intensity:.8,lastUpdateTime:0,animationActive:!0,preferredMotion:!0,frameRate:60,lastFrameTime:0};this.animationFrameId=0;this.updateInterval=0;this.eventDebounceTimers={musicEnergy:0,colorHarmony:0,beatSync:0,cssUpdate:0};this.eventDebounceMs=100;this.frameThrottleMs=16;this.lastCSSUpdateTime=0;this.previousCSSValues={energy:0,valence:0,harmonyHue:0,intensity:0,depth:0};this.cssChangeThreshold=.01}debouncedEventHandler(t,i){let n=performance.now();n-this.eventDebounceTimers[t]>=this.eventDebounceMs&&(i(),this.eventDebounceTimers[t]=n)}hasSignificantCSSChange(){let t=this.effectsState,i=1+t.energy*.5,n={energy:t.energy,valence:t.valence,harmonyHue:t.harmonyHue,intensity:t.intensity,depth:i};for(let[r,a]of Object.entries(n)){let s=this.previousCSSValues[r];if(Math.abs(a-s)>=this.cssChangeThreshold)return!0}return!1}updatePreviousCSSValues(){let t=this.effectsState,i=1+t.energy*.5;this.previousCSSValues.energy=t.energy,this.previousCSSValues.valence=t.valence,this.previousCSSValues.harmonyHue=t.harmonyHue,this.previousCSSValues.intensity=t.intensity,this.previousCSSValues.depth=i}batchApplyCSSUpdates(t,i="normal",n="header-effects"){let r={};for(let[a,s]of t)r[a]=s;this.cssController.batchSetVariables("HeaderVisualEffectsController",r,i,n)}scheduleEffectsUpdate(){this.debouncedEventHandler("cssUpdate",()=>{this.hasSignificantCSSChange()&&(this.updateHeaderEffectsVariables(),this.updatePreviousCSSValues())})}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{let t=globalThis.year3000System;this.cssController=t?.cssVariableController||T(),this.effectsState.preferredMotion=!window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.setupMusicEventListeners(),this.setupColorHarmonyListeners(),this.updateHeaderEffectsVariables(),this.effectsState.preferredMotion&&this.startAnimationLoop(),this.setupPerformanceMonitoring(),u?.debug?.log("HeaderVisualEffectsController","Header visual effects initialization complete")}catch(t){u?.debug?.error("HeaderVisualEffectsController","Initialization failed:",t)}}setupMusicEventListeners(){p.subscribe("music:energy",t=>{this.debouncedEventHandler("musicEnergy",()=>{typeof t.energy=="number"&&(this.effectsState.energy=Math.max(0,Math.min(1,t.energy)),this.scheduleEffectsUpdate()),typeof t.tempo=="number"&&(this.effectsState.tempo=Math.max(60,Math.min(200,t.tempo)),this.updateAnimationSpeed()),typeof t.valence=="number"&&(this.effectsState.valence=Math.max(0,Math.min(1,t.valence)),this.scheduleEffectsUpdate())})},"HeaderVisualEffectsController"),p.subscribe("music:beat",t=>{this.debouncedEventHandler("beatSync",()=>{if(this.effectsState.animationActive){let i=t.intensity||.8;this.onBeatDetected(i)}})},"HeaderVisualEffectsController"),p.subscribe("music:energy-changed",t=>{this.debouncedEventHandler("musicEnergy",()=>{typeof t.energy=="number"&&(this.effectsState.energy=Math.max(0,Math.min(1,t.energy)),this.scheduleEffectsUpdate())})},"HeaderVisualEffectsController")}setupColorHarmonyListeners(){p.subscribe("colors:harmonized",t=>{this.debouncedEventHandler("colorHarmony",()=>{t.coordinationMetrics?.coordinationStrategy&&this.updateHarmonyHue(t.coordinationMetrics.coordinationStrategy)})},"HeaderVisualEffectsController"),p.subscribe("colors:extracted",t=>{this.debouncedEventHandler("colorHarmony",()=>{if(t.musicData&&typeof t.musicData.energy=="number"){let i=t.musicData.energy*360;this.effectsState.harmonyHue=i,this.scheduleEffectsUpdate()}})},"HeaderVisualEffectsController")}updateHarmonyHue(t){let n={monochromatic:0,complementary:180,triadic:120,analogous:30,tetradic:90,"split-complementary":150}[t]||0;this.effectsState.harmonyHue=n,this.scheduleEffectsUpdate()}onBeatDetected(t){let i=Math.min(1,this.effectsState.energy+t*.3);this.batchApplyCSSUpdates([["--header-effects-energy",i.toString()]],"high","beat-sync");let n=performance.now()+150,r=()=>{performance.now()>=n&&this.initialized?this.batchApplyCSSUpdates([["--header-effects-energy",this.effectsState.energy.toString()]],"normal","beat-reset"):this.initialized&&requestAnimationFrame(r)};requestAnimationFrame(r)}updateAnimationSpeed(){let n=8/(this.effectsState.tempo/120);this.batchApplyCSSUpdates([["--header-effects-flow-speed",`${Math.max(2,Math.min(16,n))}s`]],"high","tempo-sync")}updateHeaderEffectsVariables(){if(!this.initialized)return;let t=this.effectsState,i=t.intensity*(.6+t.valence*.4)*(.8+t.energy*.2),n=1+t.energy*.5;this.batchApplyCSSUpdates([["--header-effects-energy",t.energy.toString()],["--header-effects-harmony",`${t.harmonyHue}deg`],["--header-effects-intensity",i.toString()],["--header-effects-depth",n.toString()]],"normal","effects-update"),this.effectsState.lastUpdateTime=Date.now()}startAnimationLoop(){let t=i=>{if(!this.initialized||!this.effectsState.animationActive)return;if(i-this.lastCSSUpdateTime<this.frameThrottleMs){this.animationFrameId=requestAnimationFrame(t);return}let n=i-this.effectsState.lastFrameTime;this.effectsState.frameRate=1e3/n,this.effectsState.lastFrameTime=i,i-this.effectsState.lastUpdateTime>100&&this.hasSignificantCSSChange()&&(this.updateHeaderEffectsVariables(),this.updatePreviousCSSValues()),this.lastCSSUpdateTime=i,this.animationFrameId=requestAnimationFrame(t)};this.animationFrameId=requestAnimationFrame(t)}setupPerformanceMonitoring(){this.updateInterval=window.setInterval(()=>{this.initialized&&(this.effectsState.frameRate<30&&u?.debug?.warn("HeaderVisualEffectsController","Performance degradation detected, reducing update frequency"),this.cssController.setVariable("HeaderVisualEffectsController","--header-effects-performance",this.effectsState.frameRate>50?"1":"0.5","low","performance-monitor"))},2e3)}setEffectsIntensity(t){this.effectsState.intensity=Math.max(0,Math.min(1,t)),this.updateHeaderEffectsVariables()}setAnimationActive(t){this.effectsState.animationActive=t,!t&&this.animationFrameId?(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=0):t&&this.effectsState.preferredMotion&&this.startAnimationLoop()}getEffectsState(){return{...this.effectsState}}async healthCheck(){let t=this.initialized&&this.effectsState.frameRate>20&&Date.now()-this.effectsState.lastUpdateTime<5e3;return{healthy:t,issues:t?[]:[this.effectsState.frameRate<=20?"Low frame rate detected":"",Date.now()-this.effectsState.lastUpdateTime>=5e3?"No recent updates":""].filter(i=>i),metrics:{frameRate:this.effectsState.frameRate,energy:this.effectsState.energy,intensity:this.effectsState.intensity,animationActive:this.effectsState.animationActive,lastUpdate:this.effectsState.lastUpdateTime}}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=0),this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=0),p.unsubscribeAll("HeaderVisualEffectsController"),u?.debug?.log("HeaderVisualEffectsController","Header visual effects system cleaned up")}async initialize(){await this._baseInitialize()}async destroy(){this._performSystemSpecificCleanup()}onAnimate(t){this.effectsState.animationActive&&this.updateHeaderEffectsVariables()}}});function Es(c,e){let t=Math.max(0,Math.min(.9999,c))*63,i=Math.max(0,Math.min(.9999,e))*63,n=Math.floor(t),r=Math.floor(i),a=n+1,s=r+1,o=t-n,l=i-r,m=mt[r*64+n],d=mt[r*64+a%64],h=mt[s%64*64+n],g=mt[s%64*64+a%64],f=(L,_,G)=>L+(_-L)*G,v=f(m.x,d.x,o),C=f(m.y,d.y,o),P=f(h.x,g.x,o),E=f(h.y,g.y,o);return{x:f(v,P,l),y:f(C,E,l)}}var mt,Ps=b(()=>{"use strict";mt=new Array(4096);(function(){for(let e=0;e<mt.length;e++){let t=Math.random()*Math.PI*2;mt[e]={x:Math.cos(t),y:Math.sin(t)}}})()});var Ts={};ie(Ts,{SidebarVisualEffectsSystem:()=>ht});var dt,ht,pr=b(()=>{"use strict";U();Ps();de();dt=class dt extends Q{constructor(t,i,n,r,a,s=null){super(t,i,n,r,a);this.rootNavBar=null;this.overlayContainer=null;this.resizeObserver=null;this.visualEffectsElement=null;this.harmonicModeIndicator=null;this.visualEffectsAnimationFrame=null;this.echoPool=[];this.currentEchoCount=0;this._elementsWithActiveEcho=new WeakSet;this._navInteractionHandler=null;this.echoTimerCounter=0;this._lastMotionDisabled=!1;this.interactionPatterns=new Map;this.proximityObserver=null;this.interactionElements=new Map;this.activeEffects=[];this.animationPhase=0;this.localFrameCount=0;this.musicBeatIntensity=0;this.musicEnergyLevel=0;this.cursorPosition={x:0,y:0};this.cursorVelocity={x:0,y:0};this.lastCursorUpdate=0;this.MAX_EFFECT_POINTS=50;this.EFFECT_DECAY_RATE=.05;this.PROXIMITY_THRESHOLD=100;this.INTERACTION_COOLDOWN=16;this.ANIMATION_LERP=.08;this.SMOOTHING_LERP=.12;this.INTENSITY_LERP=.15;this.year3000System=s,this.masterAnimationRegistered=!1,this.isUsingMasterAnimation=!1,this.currentHarmonicModeClass="",this.currentEnergyClass="",this.currentHarmonicModeKey="artist-vision",this.nexusVariables={},this.performanceMetrics={animationFrames:0,maxFrameTime:0,averageFrameTime:0,frameTimeHistory:[],cssVariableUpdates:0,elementUpdates:0},this.deviceCapabilities={supportsCSSFilter:this._detectCSSFilterSupport(),supportsTransforms:this._detectTransformSupport(),performanceLevel:this._detectPerformanceLevel(),reducedMotion:this._detectReducedMotion()},this.animationState={lastPulse:0,pulseDirection:1,baseOpacity:.7,currentScale:1,targetScale:1,smoothingFactor:.15},this.visualState={direction:"radial",intensity:.3,velocity:50,smoothing:.7,effectPoints:[]},this.userInteractionState={globalIntensity:0,dominantDirection:0,interactionCount:0,lastInteractionTime:0,proximityElements:[]},this.setupEffectPoints(),this.setupInteractionPatterns(),t.enableDebug&&console.log(`[${this.systemName}] Enhanced with visual interaction system`)}onAnimate(t){}_detectCSSFilterSupport(){let t=document.createElement("div");return t.style.filter="blur(1px)",!!t.style.filter}_detectTransformSupport(){let t=document.createElement("div");return t.style.transform="scale(1.1)",!!t.style.transform}_detectPerformanceLevel(){let t=navigator.deviceMemory||4,i=navigator.hardwareConcurrency||4;return t>=8&&i>=8?"high":t>=4&&i>=4?"medium":"low"}_detectReducedMotion(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}async initialize(){if(await super.initialize(),this.rootNavBar=document.querySelector(".Root__nav-bar"),!this.rootNavBar){this.initialized=!1;return}this._createOverlayContainer(),this._createVisualEffectsElement(),this.createHarmonicModeDisplay(),this.updateColors(),this.rootNavBar&&(this._navInteractionHandler=t=>{let i=t.target;!i||!(i instanceof HTMLElement)||i.matches("a, button, [role='link']")&&this._spawnNavEcho(i)},this.rootNavBar.addEventListener("focusin",this._navInteractionHandler,!0),this.rootNavBar.addEventListener("pointerenter",this._navInteractionHandler,!0)),this._tryRegisterWithMasterAnimation(),this._setupResizeObserver()}_createOverlayContainer(){this.overlayContainer=document.createElement("div"),this.overlayContainer.id="sidebar-consciousness-overlay",this.overlayContainer.style.position="absolute",this.overlayContainer.style.pointerEvents="none",this.overlayContainer.style.zIndex="1000",document.body.appendChild(this.overlayContainer)}_setupResizeObserver(){!this.rootNavBar||!this.overlayContainer||(this.resizeObserver=new ResizeObserver(t=>{for(let i of t){let{left:n,top:r,width:a,height:s}=i.contentRect;this.overlayContainer&&(this.overlayContainer.style.left=`${n}px`,this.overlayContainer.style.top=`${r}px`,this.overlayContainer.style.width=`${a}px`,this.overlayContainer.style.height=`${s}px`)}}),this.resizeObserver.observe(this.rootNavBar))}_tryRegisterWithMasterAnimation(){if(this.year3000System&&this.year3000System.registerAnimationSystem)try{this.year3000System.registerAnimationSystem("SidebarVisualEffectsSystem",this,"background",this.deviceCapabilities.performanceLevel==="high"?30:15),this.masterAnimationRegistered=!0,this.isUsingMasterAnimation=!0}catch{this._startFallbackVisualEffectsLoop()}else this._startFallbackVisualEffectsLoop()}_startFallbackVisualEffectsLoop(){this.isUsingMasterAnimation=!1,this.startVisualEffectsLoop()}updateAnimation(t){if(this.deviceCapabilities.reducedMotion||!this.visualEffectsElement||!this.rootNavBar)return;let n=performance.now()*.001,r=Math.sin(n*2)*.1+.9;if(this.animationState.targetScale=r,this.animationState.currentScale+=(this.animationState.targetScale-this.animationState.currentScale)*this.animationState.smoothingFactor,this.visualEffectsElement.style.transform=`translateX(-50%) scale(${this.animationState.currentScale.toFixed(3)})`,this.harmonicModeIndicator){let a=(Math.sin(n*1.5)*.1+.85).toFixed(2);this.harmonicModeIndicator.style.opacity=a}}onPerformanceModeChange(t){t==="low"?this.animationState.smoothingFactor=.3:this.animationState.smoothingFactor=.15}handleSettingsChange(t){super.handleSettingsChange(t),t.detail.key==="sn-harmonic-mode"&&this.updateHarmonicModeDisplay(t.detail.value)}_createVisualEffectsElement(){this.overlayContainer&&(this.visualEffectsElement=document.createElement("div"),this.visualEffectsElement.className="sidebar-visual-effects-element",this.overlayContainer.appendChild(this.visualEffectsElement))}createHarmonicModeDisplay(){this.overlayContainer&&(this.harmonicModeIndicator=document.createElement("div"),this.harmonicModeIndicator.className="harmonic-mode-indicator",this.overlayContainer.appendChild(this.harmonicModeIndicator))}updateColors(){if(!this.visualEffectsElement||!this.harmonicModeIndicator||!this.rootNavBar)return;let t=getComputedStyle(this.rootNavBar),i=t.getPropertyValue("--spice-sidebar"),n=t.getPropertyValue("--spice-text");this.visualEffectsElement.style.backgroundColor=i,this.visualEffectsElement.style.borderColor=n,this.visualEffectsElement.style.borderWidth="1px",this.visualEffectsElement.style.borderStyle="solid",this.harmonicModeIndicator&&(this.harmonicModeIndicator.style.backgroundColor=`rgba(${this.utils.hexToRgb(n)?.r}, ${this.utils.hexToRgb(n)?.g}, ${this.utils.hexToRgb(n)?.b}, 0.1)`,this.harmonicModeIndicator.style.color=n)}startVisualEffectsLoop(){this.visualEffectsAnimationFrame&&cancelAnimationFrame(this.visualEffectsAnimationFrame);let t=i=>{this.updateAnimation(16.67),this.visualEffectsAnimationFrame=requestAnimationFrame(t)};this.visualEffectsAnimationFrame=requestAnimationFrame(t)}updateHarmonicModeDisplay(t){if(this.currentHarmonicModeKey=t,this.rootNavBar){let i=this.rootNavBar.classList;i.forEach(r=>{r.startsWith("sn-harmonic-")&&i.remove(r)}),be[t]&&this.rootNavBar.classList.add(`sn-harmonic-${t}`)}}_updateSidebarVariables(t={}){if(!this.rootNavBar)return;let{visualIntensity:i=.5,moodIdentifier:n="neutral",energyLevel:r="low"}=t;this.rootNavBar.classList.remove("sn-music-low-energy","sn-music-mid-energy","sn-music-high-energy"),this.rootNavBar.classList.add(`sn-music-${r}-energy`),this.rootNavBar.setAttribute("data-mood",n);let a=Math.max(0,Math.min(1,i)),s=Math.min(.5,a*.6),o=(l,m)=>{this.year3000System&&this.year3000System.queueCSSVariableUpdate?this.year3000System.queueCSSVariableUpdate(l,m,this.rootNavBar):this.rootNavBar.style.setProperty(l,m)};o("--sn-nav-item-glow-intensity",`${a}`),o("--sn-nav-text-energy-opacity",`${s}`),o("--sidebar-intensity",`${i}`)}updateFromMusicAnalysis(t,i,n){this.initialized&&(super.updateFromMusicAnalysis(t),this._updateSidebarVariables(t))}updateModeConfiguration(t){super.updateModeConfiguration(t),this.currentHarmonicModeKey=t.activeMode||"artist-vision",this.updateVisualEffectsForMode(),this.updateHarmonicModeDisplay(this.currentHarmonicModeKey)}updateVisualEffectsForMode(){if(this.visualEffectsElement){let t=this.modeConfig?.intensityMultiplier||1;this.visualEffectsElement.style.opacity=`${.1*t}`}}destroy(){if(this.visualEffectsAnimationFrame&&cancelAnimationFrame(this.visualEffectsAnimationFrame),this.year3000System?.timerConsolidationSystem)for(let t=0;t<this.echoTimerCounter;t++)this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer(`SidebarVisualEffectsSystem-echo-${t}`);if(this.rootNavBar&&this._navInteractionHandler&&(this.rootNavBar.removeEventListener("focusin",this._navInteractionHandler,!0),this.rootNavBar.removeEventListener("pointerenter",this._navInteractionHandler,!0),this._navInteractionHandler=null),this.year3000System&&this.year3000System.unregisterAnimationSystem&&this.year3000System.unregisterAnimationSystem("SidebarVisualEffectsSystem"),this.resizeObserver&&this.rootNavBar&&(this.resizeObserver.unobserve(this.rootNavBar),this.resizeObserver.disconnect(),this.resizeObserver=null),this.overlayContainer&&this.overlayContainer.parentNode&&(this.overlayContainer.parentNode.removeChild(this.overlayContainer),this.overlayContainer=null),this.rootNavBar){let t=this.rootNavBar.classList;t.forEach(i=>{i.startsWith("sn-")&&t.remove(i)})}super.destroy()}get echoIntensitySetting(){let i=parseInt("2",10);return isNaN(i)?2:i}get dynamicMaxEchoes(){switch(this.echoIntensitySetting){case 0:return 0;case 1:return Math.ceil(dt.BASE_MAX_ECHOES/2);case 3:return dt.BASE_MAX_ECHOES*2;default:return dt.BASE_MAX_ECHOES}}_acquireEchoElement(){let t=this.echoPool.pop();return t?(t.style.animation="none",t.offsetWidth,t.style.animation=""):(t=document.createElement("div"),t.className="sn-temporal-echo"),t}_releaseEchoElement(t){this.echoPool.length<20&&this.echoPool.push(t)}_spawnNavEcho(t){if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||this.currentEchoCount>=this.dynamicMaxEchoes||this.echoIntensitySetting===0||this._elementsWithActiveEcho.has(t))return;let i=this.musicSyncService?.getLatestProcessedData()??{},n=i.energy??.5,r=i.valence??.5,a=Math.min(1.4,1+n*.4),s=((r-.5)*40).toFixed(1),o=t.getBoundingClientRect(),l=o.left/window.innerWidth,m=o.top/window.innerHeight,d=Es(l,m),h=this.musicSyncService?.getCurrentBeatVector?.()??{x:0,y:0},g=6+n*6,f=(d.x+h.x)*g,v=(d.y+h.y)*g,C=d.x*6,P=(Math.random()*360).toFixed(1),E=this._acquireEchoElement();E.style.setProperty("--sn-echo-radius-multiplier",a.toFixed(2)),E.style.setProperty("--sn-echo-hue-shift",`${s}deg`),E.style.setProperty("--sn-echo-offset-x",`${f.toFixed(1)}px`),E.style.setProperty("--sn-echo-offset-y",`${v.toFixed(1)}px`),E.style.setProperty("--sn-echo-skew",`${C.toFixed(2)}deg`),E.style.setProperty("--sn-echo-rotate",`${P}deg`),t.appendChild(E),this.currentEchoCount++,this._elementsWithActiveEcho.add(t);let L=`SidebarVisualEffectsSystem-echo-${this.echoTimerCounter++}`,_=()=>{E.parentElement&&E.parentElement.removeChild(E),this.currentEchoCount--,this._releaseEchoElement(E),this._elementsWithActiveEcho.delete(t)};this.year3000System?.timerConsolidationSystem?this.year3000System.timerConsolidationSystem.registerConsolidatedTimer(L,_,1100,"background"):setTimeout(_,1100)}applyPerformanceSettings(t){super.applyPerformanceSettings(t);let n=!t.enableGPUAcceleration||t.animationThrottle>=24||t.reducedMotion;this.rootNavBar&&n!==this._lastMotionDisabled&&(this.rootNavBar.classList.toggle("sn-motion-disabled",n),this._lastMotionDisabled=n)}setupEffectPoints(){this.visualState.effectPoints=[];let t=8,i=20;for(let n=0;n<t;n++)for(let r=0;r<t;r++){let a={x:n*i,y:r*i,magnitude:.5+Math.random()*.5,direction:Math.random()*Math.PI*2,influence:.3+Math.random()*.4};this.visualState.effectPoints.push(a)}}setupInteractionPatterns(){this.interactionPatterns.set("hover",{id:"hover",type:"hover",response:{intensityChange:.2,velocityChange:.1,smoothingChange:-.1,visualEffects:[{center:{x:0,y:0},radius:30,strength:.3,decay:.05,type:"wave"}],rippleEffect:!1,glowEffect:!0},duration:300,easing:"smooth",priority:3}),this.interactionPatterns.set("click",{id:"click",type:"click",response:{intensityChange:.5,velocityChange:.3,smoothingChange:-.2,visualEffects:[{center:{x:0,y:0},radius:50,strength:.7,decay:.08,type:"pulse"}],rippleEffect:!1,glowEffect:!0},duration:500,easing:"smooth",priority:8}),this.interactionPatterns.set("focus",{id:"focus",type:"focus",response:{intensityChange:.3,velocityChange:.05,smoothingChange:.1,visualEffects:[{center:{x:0,y:0},radius:40,strength:.4,decay:.02,type:"spiral"}],rippleEffect:!1,glowEffect:!0},duration:1e3,easing:"smooth",priority:6})}setupProximityDetection(){typeof IntersectionObserver<"u"&&(this.proximityObserver=new IntersectionObserver(t=>{t.forEach(i=>{let n=i.target,r=n.id||n.className;i.isIntersecting?(this.interactionElements.set(r,n),this.handleProximityEnter(n)):(this.interactionElements.delete(r),this.handleProximityExit(n))})},{threshold:[0,.1,.5,1],rootMargin:`${this.PROXIMITY_THRESHOLD}px`}))}handleProximityEnter(t){let i=t.getBoundingClientRect(),n={x:i.left+i.width/2,y:i.top+i.height/2},r=Math.sqrt(Math.pow(n.x-this.cursorPosition.x,2)+Math.pow(n.y-this.cursorPosition.y,2));this.userInteractionState.proximityElements.push({element:t,distance:r,influence:Math.max(0,1-r/this.PROXIMITY_THRESHOLD)})}handleProximityExit(t){this.userInteractionState.proximityElements=this.userInteractionState.proximityElements.filter(i=>i.element!==t)}updateVisualEffects(){this.activeEffects=this.activeEffects.filter(t=>(t.strength*=1-t.decay,t.strength>.01)),this.activeEffects.forEach(t=>{this.visualState.effectPoints.forEach(i=>{let n=Math.sqrt(Math.pow(i.x-t.center.x,2)+Math.pow(i.y-t.center.y,2));if(n<t.radius){let r=t.strength*(1-n/t.radius);switch(t.type){case"wave":i.magnitude+=r*.3;break;case"spiral":i.direction+=r*.5;break;case"pulse":i.magnitude+=r*.5,i.direction+=r*.2;break;case"vortex":let a=Math.atan2(i.y-t.center.y,i.x-t.center.x);i.direction=a+r*Math.PI*.5;break}}})})}updateMusicVisualEffects(){let t=this.musicBeatIntensity*.3;this.visualState.intensity=Math.max(this.visualState.intensity,t);let i=this.musicEnergyLevel*30;this.visualState.velocity=Math.min(200,this.visualState.velocity+i);let n=(1-this.musicEnergyLevel)*.2;this.visualState.smoothing=Math.max(.1,this.visualState.smoothing-n)}getVisualState(){return{...this.visualState}}getUserInteractionState(){return{...this.userInteractionState}}getActiveEffects(){return[...this.activeEffects]}};dt.BASE_MAX_ECHOES=4;ht=dt});var fr,Lt,xs=b(()=>{"use strict";D();fr=class{static selectOptimalBackend(e){let t=e.filter(i=>i.backend.isReady&&i.backend.capabilities).sort((i,n)=>n.priority-i.priority);for(let i of t){let n=i.capabilities;if(n.webgl2&&n.maxTextureSize>=2048||n.webgl&&n.maxTextureSize>=1024||i.backend.backendId==="css")return i.backend}return null}},Lt=class{constructor(e,t,i,n,r,a={}){this.initialized=!1;this.registeredBackends=new Map;this.activeBackend=null;this.rootElement=null;this.currentPalette=[];this.currentMusicMetrics=null;this.lastFrameTime=0;this.frameCount=0;this.performanceCheckInterval=null;this.eventBus=e||p,this.cssConsciousnessController=t,this.colorHarmonyEngine=i,this.musicSyncService=n,this.performanceAnalyzer=r,this.config={enabledBackends:["webgl","css"],defaultQuality:"high",transitionDuration:500,performanceMonitoring:!0,autoQualityScaling:!0,...a},this.currentConstraints={targetFPS:60,maxMemoryMB:50,cpuBudgetPercent:10,gpuBudgetPercent:25,qualityLevel:this.config.defaultQuality}}async initialize(){try{this.setupEventListeners(),this.setupCSSVariableUpdates(),this.config.performanceMonitoring&&this.startPerformanceMonitoring(),this.updateGlobalStatus(),this.initialized=!0,console.log("[GradientConductor] Initialized successfully",{enabledBackends:this.config.enabledBackends,registeredBackends:Array.from(this.registeredBackends.keys())})}catch(e){throw console.error("[GradientConductor] Initialization failed:",e),e}}registerBackend(e,t=0){let i={backend:e,priority:t,capabilities:e.capabilities,lastHealthCheck:new Date,isActive:!1};this.registeredBackends.set(e.backendId,i),console.log(`[GradientConductor] Registered backend: ${e.backendId}`,{priority:t,capabilities:e.capabilities}),this.evaluateActiveBackend()}unregisterBackend(e){let t=this.registeredBackends.get(e);t&&(t.backend.setEnabled(!1),this.registeredBackends.delete(e),this.activeBackend?.backendId===e&&(this.activeBackend=null,this.evaluateActiveBackend()),console.log(`[GradientConductor] Unregistered backend: ${e}`))}async initializeBackends(e){this.rootElement=e;let t=Array.from(this.registeredBackends.values()).map(async i=>{try{await i.backend.init(e,this.currentConstraints),console.log(`[GradientConductor] Backend ${i.backend.backendId} initialized`)}catch(n){console.error(`[GradientConductor] Failed to initialize backend ${i.backend.backendId}:`,n)}});await Promise.allSettled(t),this.evaluateActiveBackend(),this.activeBackend&&(this.currentPalette.length>0&&this.activeBackend.setPalette(this.currentPalette),this.currentMusicMetrics&&this.activeBackend.setMusicMetrics(this.currentMusicMetrics))}setPalette(e,t=this.config.transitionDuration){this.currentPalette=[...e],this.updateCSSGradientVariables(e),this.activeBackend&&this.activeBackend.setPalette(e,t),this.updateGlobalStatus(),console.log("[GradientConductor] Palette updated",{stops:e.length,activeBackend:this.activeBackend?.backendId,transition:t})}setMusicMetrics(e){this.currentMusicMetrics=e,this.updateCSSMusicVariables(e),this.activeBackend&&this.activeBackend.setMusicMetrics(e),this.eventBus.emit("music:energy",{energy:e.energy,valence:e.valence,tempo:e.bpm,timestamp:Date.now()})}setPerformanceConstraints(e){this.currentConstraints={...e};for(let t of this.registeredBackends.values())t.backend.setPerformanceConstraints(e);e.qualityLevel!==this.currentConstraints.qualityLevel&&this.evaluateActiveBackend(),console.log("[GradientConductor] Performance constraints updated",e)}getActiveBackend(){return this.activeBackend}async triggerMusicEmotionAnalysis(e,t){try{if(this.colorHarmonyEngine&&typeof this.colorHarmonyEngine.analyzeMusicEmotion=="function"){let i=await this.colorHarmonyEngine.analyzeMusicEmotion(e,t);i&&this.config.performanceMonitoring&&console.log(`[GradientConductor] Music emotion analysis triggered: ${i.primary} (${i.intensity.toFixed(2)} intensity)`)}else console.warn("[GradientConductor] ColorHarmonyEngine not available for music emotion analysis")}catch(i){console.error("[GradientConductor] Error triggering music emotion analysis:",i)}}getRegisteredBackends(){return Array.from(this.registeredBackends.values())}setActiveBackend(e){let t=this.registeredBackends.get(e);if(!t||!t.backend.isReady)return!1;if(this.activeBackend){this.activeBackend.setEnabled(!1);let i=this.registeredBackends.get(this.activeBackend.backendId);i&&(i.isActive=!1)}return this.activeBackend=t.backend,t.isActive=!0,t.backend.setEnabled(!0,this.config.transitionDuration),this.updateGlobalStatus(),console.log(`[GradientConductor] Forced backend switch to: ${e}`),!0}async healthCheck(){let e=[];for(let[t,i]of this.registeredBackends)try{let n=await i.backend.healthCheck();i.lastHealthCheck=new Date,n.ok||e.push(`Backend ${t}: ${n.details||"Health check failed"}`)}catch(n){e.push(`Backend ${t}: Health check error - ${n}`)}return{healthy:e.length===0,ok:e.length===0,details:e.length>0?`${e.length} backend issues detected`:"All backends healthy",issues:e,system:"GradientConductor"}}updateAnimation(e){this.frameCount++,this.lastFrameTime=e,this.activeBackend&&this.activeBackend.updateAnimation(e)}destroy(){this.performanceCheckInterval&&(clearInterval(this.performanceCheckInterval),this.performanceCheckInterval=null);for(let e of this.registeredBackends.values())e.backend.destroy();this.registeredBackends.clear(),this.activeBackend=null,this.initialized=!1,console.log("[GradientConductor] Destroyed")}setupEventListeners(){this.eventBus.subscribe("colors:harmonized",e=>{if(e&&e.processedColors){let t=Object.entries(e.processedColors).map(([i,n],r,a)=>{let s=n,o=128,l=128,m=128;if(s.startsWith("#")){let d=s.slice(1);o=parseInt(d.slice(0,2),16),l=parseInt(d.slice(2,4),16),m=parseInt(d.slice(4,6),16)}return{r:o,g:l,b:m,position:r/(a.length-1)}});this.setPalette(t)}},"GradientConductor"),this.eventBus.subscribe("music:energy",e=>{let t={energy:e.energy,valence:e.valence,bpm:e.tempo,beatIntensity:e.energy,rhythmPhase:0,breathingScale:1+e.energy*.2};this.setMusicMetrics(t)},"GradientConductor"),this.eventBus.subscribe("music:beat",e=>{let t={energy:e.intensity,valence:.5,bpm:e.bpm,beatIntensity:e.intensity,rhythmPhase:Date.now()/16.67%360,breathingScale:1+e.intensity*.1};this.setMusicMetrics(t)},"GradientConductor"),this.eventBus.subscribe("performance:tier-changed",e=>{let t={targetFPS:60,maxMemoryMB:50,cpuBudgetPercent:10,gpuBudgetPercent:25,qualityLevel:e.tier==="excellent"?"ultra":e.tier==="good"?"high":e.tier==="degraded"?"medium":"low"};this.setPerformanceConstraints(t)},"GradientConductor"),this.eventBus.subscribe("settings:changed",e=>{if(e.settingKey.includes("accessibility")||e.settingKey.includes("motion")){let t={reducedMotion:e.settingKey.includes("motion")&&e.newValue==="reduce",highContrast:e.settingKey.includes("contrast")&&e.newValue==="high",prefersTransparency:e.settingKey.includes("transparency")&&e.newValue==="reduce"};for(let i of this.registeredBackends.values())i.backend.applyAccessibilityPreferences?.(t)}},"GradientConductor"),this.eventBus.subscribe("emotion:analyzed",e=>{this.handleEmotionUpdate(e)},"GradientConductor"),this.eventBus.subscribe("emotionalColorContext:updated",e=>{this.handleEmotionalColorContext(e)},"GradientConductor")}setupCSSVariableUpdates(){["--sn.music.beat.pulse.intensity","--sn.music.rhythm.phase","--sn.music.breathing.scale","--sn.bg.webgl.ready","--sn.bg.active-backend","--sn-emotion-primary","--sn-emotion-intensity","--sn-color-temperature","--sn-consciousness-level","--sn-organic-flow","--sn-cinematic-depth"].forEach(t=>{this.cssConsciousnessController.addCriticalVariable(t)})}handleEmotionUpdate(e){try{let{emotion:t,colorTemperature:i,consciousnessLevel:n,organicFlow:r,cinematicDepth:a}=e;this.cssConsciousnessController.setProperty("--sn-emotion-primary",t.primary||"neutral"),this.cssConsciousnessController.setProperty("--sn-emotion-intensity",(t.intensity||.5).toString()),this.cssConsciousnessController.setProperty("--sn-emotion-confidence",(t.confidence||.5).toString()),this.cssConsciousnessController.setProperty("--sn-color-temperature",(i||6500).toString()),this.cssConsciousnessController.setProperty("--sn-consciousness-level",(n||.5).toString()),this.cssConsciousnessController.setProperty("--sn-organic-flow",(r||.5).toString()),this.cssConsciousnessController.setProperty("--sn-cinematic-depth",(a||.5).toString());for(let s of this.registeredBackends.values())s.backend.setEmotionalState&&s.backend.setEmotionalState(t);console.log(`[GradientConductor] Emotion updated: ${t.primary} (intensity: ${t.intensity?.toFixed(2)||"N/A"})`)}catch(t){console.error("[GradientConductor] Error handling emotion update:",t)}}handleEmotionalColorContext(e){try{let{primaryEmotion:t,emotionIntensity:i,colorTemperature:n,valence:r,arousal:a,dominance:s,organicFlow:o,cinematicDepth:l,consciousnessResonance:m}=e;this.cssConsciousnessController.setProperty("--sn-emotion-valence",(r||.5).toString()),this.cssConsciousnessController.setProperty("--sn-emotion-arousal",(a||.5).toString()),this.cssConsciousnessController.setProperty("--sn-emotion-dominance",(s||.5).toString()),this.cssConsciousnessController.setProperty("--sn-consciousness-resonance",(m||.5).toString());for(let d of this.registeredBackends.values())d.backend.setEmotionalContext&&d.backend.setEmotionalContext(e);console.log(`[GradientConductor] Emotional context updated: ${t} (temp: ${n}K)`)}catch(t){console.error("[GradientConductor] Error handling emotional color context:",t)}}updateCSSGradientVariables(e){if(e.length===0)return;let t=e[0],i=e[Math.floor(e.length/2)],n=e[e.length-1];this.cssConsciousnessController.setProperty("--sn.bg.gradient.primary.rgb",`${t.r}, ${t.g}, ${t.b}`),this.cssConsciousnessController.setProperty("--sn.bg.gradient.secondary.rgb",`${i.r}, ${i.g}, ${i.b}`),this.cssConsciousnessController.setProperty("--sn.bg.gradient.accent.rgb",`${n.r}, ${n.g}, ${n.b}`),this.cssConsciousnessController.setProperty("--sn.color.accent.rgb",`${n.r}, ${n.g}, ${n.b}`),this.cssConsciousnessController.setProperty("--sn.color.accent.hex",`#${Math.round(n.r).toString(16).padStart(2,"0")}${Math.round(n.g).toString(16).padStart(2,"0")}${Math.round(n.b).toString(16).padStart(2,"0")}`)}updateCSSMusicVariables(e){e.beatIntensity!==void 0&&this.cssConsciousnessController.setProperty("--sn.music.beat.pulse.intensity",e.beatIntensity.toString()),e.rhythmPhase!==void 0&&this.cssConsciousnessController.setProperty("--sn.music.rhythm.phase",`${e.rhythmPhase}deg`),e.breathingScale!==void 0&&this.cssConsciousnessController.setProperty("--sn.music.breathing.scale",e.breathingScale.toString()),this.cssConsciousnessController.setProperty("--sn.music.energy.level",e.energy.toString()),this.cssConsciousnessController.setProperty("--sn.music.valence",e.valence.toString()),this.cssConsciousnessController.setProperty("--sn.music.tempo.bpm",e.bpm.toString())}updateGlobalStatus(){this.cssConsciousnessController.setProperty("--sn.bg.webgl.ready",this.registeredBackends.has("webgl")?"1":"0"),this.cssConsciousnessController.setProperty("--sn.bg.active-backend",this.activeBackend?.backendId||"none"),typeof window<"u"&&(window.snActiveBackend=this.activeBackend?.backendId||"none")}evaluateActiveBackend(){let e=fr.selectOptimalBackend(Array.from(this.registeredBackends.values()));if(e&&e!==this.activeBackend){if(this.activeBackend){this.activeBackend.setEnabled(!1,this.config.transitionDuration);let i=this.registeredBackends.get(this.activeBackend.backendId);i&&(i.isActive=!1)}this.activeBackend=e;let t=this.registeredBackends.get(e.backendId);t&&(t.isActive=!0,e.setEnabled(!0,this.config.transitionDuration)),this.updateGlobalStatus(),console.log(`[GradientConductor] Switched to backend: ${e.backendId}`),this.eventBus.emit("system:initialized",{systemName:`GradientConductor-${e.backendId}`,timestamp:Date.now(),metadata:{previousBackend:this.activeBackend?.backendId,newBackend:e.backendId,capabilities:e.capabilities}})}}startPerformanceMonitoring(){this.performanceCheckInterval=window.setInterval(()=>{if(this.activeBackend)try{let e=this.activeBackend.getPerformanceMetrics();this.config.autoQualityScaling&&this.evaluateQualityScaling(e),this.performanceAnalyzer.recordMetric("gradientConductor.fps",e.fps),this.performanceAnalyzer.recordMetric("gradientConductor.memory",e.memoryUsageMB)}catch(e){console.warn("[GradientConductor] Performance monitoring error:",e)}},2e3)}evaluateQualityScaling(e){let t=this.currentConstraints;if(e.fps<t.targetFPS*.8||e.memoryUsageMB>t.maxMemoryMB*1.2){let i=t.qualityLevel;switch(t.qualityLevel){case"ultra":i="high";break;case"high":i="medium";break;case"medium":i="low";break;case"low":this.evaluateActiveBackend();return}console.log(`[GradientConductor] Auto-scaling quality: ${t.qualityLevel} \u2192 ${i}`),this.setPerformanceConstraints({...t,qualityLevel:i})}}}});var Gi,As=b(()=>{"use strict";Ai();K();fn();Gi=class extends Ve{constructor(t){super(t);this.musicIntensity=0;this.scaleMultiplier=1;this.animationPhase=0;this.colorTemperature=4e3;this.transitionFluidityLevel=.5;this.targetMusicIntensity=0;this.targetScaleMultiplier=1;this.targetColorTemperature=4e3;this.targetTransitionFluidityLevel=.5;this.lerpHalfLifeValues={intensityAttack:.05,intensityDecay:.15,scaleMultiplier:.08,colorTemperature:.3,transitionFluidity:.12};this.lastBeatTime=0;this.currentBPM=120;this.animationCycleDuration=2e3;this.musicSyncService=null;this.currentMusicalContext=null;this.lastBeatPhaseUpdate=0;this.performanceMetrics={syncUpdates:0,scaleEvents:0,animationCycles:0,emotionalShifts:0,averageFrameTime:0,memoryUsage:0};this.syncConfig={responseSensitivity:.7,animationIntensity:.8,colorTemperatureRange:{min:1e3,max:2e4},transitionFluidityEnabled:!0,visualParticlesEnabled:!0,cinematicEffectsEnabled:!0};this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F3B5} Music beat synchronizer initializing...")}setMusicSyncService(t){this.musicSyncService=t,this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F3B5} Music synchronization service activated")}onBeatDetected(t){let{intensity:i,bpm:n,energy:r,timestamp:a}=t;this.lastBeatTime=a||Date.now(),this.currentBPM=n||this.currentBPM,this.targetMusicIntensity=Math.min(1,i*this.syncConfig.responseSensitivity),this.targetScaleMultiplier=1+(r||.5)*.3,this.performanceMetrics.scaleEvents++,this.config.enableDebug&&console.log(`[MusicBeatSynchronizer] \u{1F3B5} Beat detected: intensity=${i}, energy=${r}, bpm=${n}`)}onEnergyChanged(t){let{energy:i,valence:n}=t;this.targetScaleMultiplier=1+i*.3,this.targetTransitionFluidityLevel=.3+n*.4,this.config.enableDebug&&console.log(`[MusicBeatSynchronizer] \u26A1 Energy change: energy=${i}, valence=${n}`)}onEmotionDetected(t){let{valence:i,energy:n}=t,r=4e3,a=(n-.5)*8e3,s=(i-.5)*6e3;this.targetColorTemperature=Math.max(1e3,Math.min(2e4,r+a+s)),this.performanceMetrics.emotionalShifts++,this.config.enableDebug&&console.log(`[MusicBeatSynchronizer] \u{1F308} Emotion detected: ${this.colorTemperature}K temperature`)}onTempoChanged(t){let{bpm:i,tempo:n,enhancedBPM:r}=t;this.currentBPM=r||i||n||120;let a=Math.max(.3,Math.min(3,this.currentBPM/120));this.animationCycleDuration=2e3/a,this.config.enableDebug&&console.log(`[MusicBeatSynchronizer] \u{1F3B6} Tempo changed: ${this.currentBPM} BPM, ${this.animationCycleDuration.toFixed(0)}ms cycle`)}async initialize(){this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F3B5} Initializing music synchronization system..."),this.registerCSSVariableGroup("music-sync-core","critical"),this.registerCSSVariableGroup("visual-scaling","high"),this.registerCSSVariableGroup("color-temperature","normal"),this.registerCSSVariableGroup("transition-fluidity","normal"),this.musicIntensity=0,this.scaleMultiplier=1,this.animationPhase=0,this.colorTemperature=4e3,this.transitionFluidityLevel=.5,this.subscribeToEvent("music:beat",t=>this.onBeatDetected(t)),this.subscribeToEvent("music:energy",t=>this.onEnergyChanged(t)),this.subscribeToEvent("music:emotion",t=>this.onEmotionDetected(t)),this.subscribeToEvent("music:bpm-change",t=>this.onTempoChanged(t)),this.registerAnimation(60),this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F31F} Music synchronization system ready")}destroy(){this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F343} Shutting down music synchronizer..."),this.musicIntensity=0,this.scaleMultiplier=1,this.animationPhase=0,this.colorTemperature=4e3,this.transitionFluidityLevel=.5,this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F30C} Music synchronizer cleanly shut down")}onAnimate(t){let i=performance.now();this.updateMusicalContext(),this.updateMusicSyncState(t),this.processVisualScaling(t),this.updateColorTemperature(t),this.animateTransitionFluidity(t),this.applyMusicSyncCSSVariables();let n=performance.now()-i;this.performanceMetrics.averageFrameTime=this.performanceMetrics.averageFrameTime*.9+n*.1,this.performanceMetrics.syncUpdates++,n>2&&this.config.enableDebug&&console.warn(`[MusicBeatSynchronizer] \u{1F40C} Music sync frame took ${n.toFixed(2)}ms (target: <2ms)`)}async healthCheck(){let t=[];return this.eventBus||t.push("EventBus not connected for music coordination"),this.performanceMetrics.averageFrameTime>2&&t.push(`Average frame time ${this.performanceMetrics.averageFrameTime.toFixed(2)}ms exceeds 2ms target`),this.musicIntensity===0&&Date.now()-this.lastBeatTime>1e4&&t.push("No music synchronization activity detected in last 10 seconds"),(this.colorTemperature<1e3||this.colorTemperature>2e4)&&t.push(`Color temperature ${this.colorTemperature}K outside 1000K-20000K range`),{healthy:t.length===0,ok:t.length===0,details:`Music synchronization health: ${t.length===0?"optimal":"needs attention"}`,issues:t,system:"MusicBeatSynchronizer"}}updateMusicSyncState(t){this.animationPhase+=t/this.animationCycleDuration*2*Math.PI,this.animationPhase>2*Math.PI&&(this.animationPhase-=2*Math.PI);let i=t/1e3,n=this.targetMusicIntensity>this.musicIntensity?this.lerpHalfLifeValues.intensityAttack:this.lerpHalfLifeValues.intensityDecay;this.musicIntensity=H(this.musicIntensity,this.targetMusicIntensity,i,n),Date.now()-this.lastBeatTime>2e3&&(this.targetMusicIntensity=H(this.targetMusicIntensity,0,i,this.lerpHalfLifeValues.intensityDecay))}processVisualScaling(t){let i=t/1e3;this.scaleMultiplier=H(this.scaleMultiplier,this.targetScaleMultiplier,i,this.lerpHalfLifeValues.scaleMultiplier),this.targetScaleMultiplier=H(this.targetScaleMultiplier,1,i,this.lerpHalfLifeValues.scaleMultiplier*2)}updateColorTemperature(t){let i=t/1e3;this.colorTemperature=H(this.colorTemperature,this.targetColorTemperature,i,this.lerpHalfLifeValues.colorTemperature);let n=4e3;this.targetColorTemperature=H(this.targetColorTemperature,n,i,this.lerpHalfLifeValues.colorTemperature*3)}animateTransitionFluidity(t){if(!this.syncConfig.transitionFluidityEnabled)return;let i=t/1e3;this.transitionFluidityLevel=H(this.transitionFluidityLevel,this.targetTransitionFluidityLevel,i,this.lerpHalfLifeValues.transitionFluidity)}applyMusicSyncCSSVariables(){this.updateCSSVariableGroup("music-sync-core",{"--sn-music-intensity":this.musicIntensity.toFixed(3),"--sn-music-bpm":this.currentBPM.toString(),"--sn-music-animation-phase":this.animationPhase.toFixed(4)}),this.updateCSSVariableGroup("visual-scaling",{"--sn-visual-scale":this.scaleMultiplier.toFixed(3),"--sn-visual-response-sensitivity":this.syncConfig.responseSensitivity.toFixed(2)}),this.updateCSSVariableGroup("color-temperature",{"--sn-color-temperature":`${this.colorTemperature.toFixed(0)}K`,"--sn-color-temperature-normalized":((this.colorTemperature-1e3)/19e3).toFixed(3)}),this.updateCSSVariableGroup("transition-fluidity",{"--sn-transition-fluidity":this.transitionFluidityLevel.toFixed(3),"--sn-transition-fluidity-enabled":this.syncConfig.transitionFluidityEnabled?"1":"0"})}getMusicSyncMetrics(){return{...this.performanceMetrics}}updateSyncConfig(t){this.syncConfig={...this.syncConfig,...t},this.config.enableDebug&&console.log("[MusicBeatSynchronizer] \u{1F527} Sync configuration updated:",this.syncConfig)}getMusicSyncState(){return{musicIntensity:this.musicIntensity,scaleMultiplier:this.scaleMultiplier,animationPhase:this.animationPhase,colorTemperature:this.colorTemperature,transitionFluidityLevel:this.transitionFluidityLevel,lastBeatTime:this.lastBeatTime,currentBPM:this.currentBPM}}forceRepaint(t){super.forceRepaint(t),this.musicIntensity=0,this.scaleMultiplier=1,this.animationPhase=0,this.applyMusicSyncCSSVariables(),this.config.enableDebug&&console.log(`[MusicBeatSynchronizer] \u{1F504} Music synchronization repaint: ${t}`)}updateMusicalContext(){if(!this.musicSyncService){this.currentMusicalContext=null;return}let t=Date.now();if(!(t-this.lastBeatPhaseUpdate<16)&&(this.lastBeatPhaseUpdate=t,this.currentMusicalContext=pn.createMusicalContext(this.musicSyncService,this.lastBeatTime),this.config.enableDebug&&this.currentMusicalContext)){let i=this.currentMusicalContext;console.log(`[MusicBeatSynchronizer] \u{1F3B5} Musical context: tempo=${i.tempo}, energy=${i.energy.toFixed(2)}, phase=${i.beatPhase}`)}}}});var Vi,Is=b(()=>{"use strict";di();D();R();De();$();mi();Ae();ne();Vi=class{constructor(e,t,i){this.holographicElements=new Map;this.interfaceContainer=null;this.isInitialized=!1;this.isEnabled=!0;this.performanceMetrics={elementsProcessed:0,effectsApplied:0,averageProcessingTime:0,memoryUsage:0,lastUpdate:0};this.animationState={lastFrameTime:0,flickerPhase:0,scanlinePhase:0,chromaticPhase:0,dataStreamPhase:0,interferencePhase:0,organicPhase:0,isAnimating:!1};this.holographicPresets={"star-wars":{flickerIntensity:.4,transparency:.8,chromatic:.3,scanlineIntensity:.6,dataStreamFlow:.5,interferenceLevel:.2,energyStability:.7,projectionDistance:.8},"blade-runner":{flickerIntensity:.6,transparency:.7,chromatic:.5,scanlineIntensity:.8,dataStreamFlow:.8,interferenceLevel:.4,energyStability:.6,projectionDistance:.6},"organic-consciousness":{flickerIntensity:.3,transparency:.9,chromatic:.2,scanlineIntensity:.4,dataStreamFlow:.6,interferenceLevel:.3,energyStability:.8,projectionDistance:.9}};this.lastMusicalContext=null;this.eventSubscriptionIds=[];this.lastScrollPosition=0;this.lastMouseMovement=0;this.lastUIClick=0;this.initialized=!1;this.currentQualityLevel=null;this.qualityCapabilities=[{name:"holographic-effects",enabled:!0,qualityLevel:"medium"},{name:"scanline-overlay",enabled:!0,qualityLevel:"low"},{name:"chromatic-aberration",enabled:!0,qualityLevel:"low"},{name:"data-streams",enabled:!0,qualityLevel:"medium"},{name:"interference-patterns",enabled:!0,qualityLevel:"low"},{name:"organic-integration",enabled:!0,qualityLevel:"high"}];this.qualityAdjustments={};this.manager=e,this.settingsManager=t||new ee,this.musicSyncService=i||new Ce,this.oklabProcessor=new M(!0),this.emotionalMapper=new J(!0),this.genreManager=new Be,this.holographicPreset=M.getPreset("COSMIC"),this.holographicState={flickerIntensity:.4,transparency:.8,chromatic:.3,scanlineIntensity:.6,dataStreamFlow:.5,interferenceLevel:.2,energyStability:.7,projectionDistance:.8},this.scanlineEffect={frequency:4,opacity:.1,animation:!0,speed:.5,organic:!1},this.chromaticAberration={offsetX:2,offsetY:1,redChannel:.5,greenChannel:0,blueChannel:-.5,intensity:.3},this.dataStream={characters:["0","1","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],speed:.5,density:.3,organic:!1,consciousness:!0,musicalSync:!0},this.interferencePattern={frequency:.1,amplitude:.05,phase:0,organic:!1,type:"wave"}}async initialize(){if(!this.initialized)try{let e=globalThis.year3000System;this.cssController=e?.cssConsciousnessController||T(),await this.createInterfaceContainer(),await this.initializeHolographicElements(),this.setupOKLABEventSubscriptions(),this.setupUserInteractionTracking(),this.startHolographicAnimation(),this.initialized=!0,this.isInitialized=!0,u?.debug?.log("HolographicUISystem","Initialized holographic interface system with OKLAB integration")}catch(e){throw u?.debug?.error("HolographicUISystem","Failed to initialize:",e),e}}async updateFromMusic(e,t,i){if(!this.isInitialized||!this.isEnabled)return;let n=performance.now();try{this.updateHolographicState(e,t),this.updateHolographicEffects(e,t,i),await this.updateElementAppearances();let r=performance.now()-n;this.updatePerformanceMetrics(r)}catch(r){console.error("[HolographicUISystem] Error updating from music:",r)}}updateHolographicState(e,t){let i=.2+e.intensity*.5+t.strength*.3;this.holographicState.flickerIntensity=this.smoothTransition(this.holographicState.flickerIntensity,i,.1);let n=.6+e.valence*.4;this.holographicState.transparency=this.smoothTransition(this.holographicState.transparency,n,.05);let r=.1+(e.arousal||.5)*.4;this.holographicState.chromatic=this.smoothTransition(this.holographicState.chromatic,r,.08);let a=.3+e.intensity*.5;this.holographicState.scanlineIntensity=this.smoothTransition(this.holographicState.scanlineIntensity,a,.06);let s=this.manager.getConsciousnessState(),o=.3+s.symbioticResonance*.7;this.holographicState.dataStreamFlow=this.smoothTransition(this.holographicState.dataStreamFlow,o,.04);let l=.1+s.membraneFluidityIndex*.3;this.holographicState.interferenceLevel=this.smoothTransition(this.holographicState.interferenceLevel,l,.03);let m=1-e.intensity*.4;this.holographicState.energyStability=this.smoothTransition(this.holographicState.energyStability,m,.02)}updateHolographicEffects(e,t,i){this.scanlineEffect.frequency=2+this.holographicState.scanlineIntensity*6,this.scanlineEffect.opacity=this.holographicState.scanlineIntensity*.15,this.scanlineEffect.speed=.3+this.holographicState.dataStreamFlow*.7,this.scanlineEffect.organic=this.holographicState.energyStability>.7,this.chromaticAberration.intensity=this.holographicState.chromatic,this.chromaticAberration.offsetX=this.holographicState.chromatic*3,this.chromaticAberration.offsetY=this.holographicState.chromatic*2,this.dataStream.speed=.2+this.holographicState.dataStreamFlow*.8,this.dataStream.density=.2+this.holographicState.dataStreamFlow*.6,this.dataStream.organic=this.holographicState.energyStability>.6,this.interferencePattern.frequency=.05+this.holographicState.interferenceLevel*.15,this.interferencePattern.amplitude=this.holographicState.interferenceLevel*.1,this.interferencePattern.organic=this.holographicState.energyStability>.5,e.type==="ambient"?this.interferencePattern.type="organic":e.intensity>.7?this.interferencePattern.type="noise":this.interferencePattern.type="wave"}async updateElementAppearances(){let e=[];for(let[t,i]of this.holographicElements)i.isActive&&e.push(this.updateElementAppearance(i));await Promise.allSettled(e)}async updateElementAppearance(e){let{element:t,holographicType:i,intensity:n,consciousnessLevel:r,organicIntegration:a}=e;try{switch(this.applyHolographicBase(t,n),i){case"translucent_panel":this.applyTranslucentPanel(t,n);break;case"data_stream":this.applyDataStream(t,n);break;case"energy_barrier":this.applyEnergyBarrier(t,n);break;case"consciousness_interface":this.applyConsciousnessInterface(t,n,r);break;case"organic_hologram":this.applyOrganicHologram(t,n,a);break;case"musical_visualization":this.applyMusicalVisualization(t,n);break;case"scanline_overlay":this.applyScanlineOverlay(t,n);break;case"chromatic_ghost":this.applyChromaticGhost(t,n);break}r>.5&&this.applyConsciousnessModifiers(t,r),a&&this.applyOrganicModifiers(t,n),e.lastUpdate=performance.now()}catch(s){console.warn(`[HolographicUISystem] Failed to update element ${e.id}:`,s)}}applyHolographicBase(e,t){let i=this.holographicState.transparency*t,n=this.holographicState.flickerIntensity*t,r=this.holographicState.chromatic*t;if(e.style.opacity=i.toString(),n>.3){let s=Math.sin(this.animationState.flickerPhase*10)*n*.3;e.style.opacity=Math.max(.1,i+s).toString()}if(r>.2){let s=r*2;e.style.filter=`
        drop-shadow(${s}px 0 0 rgba(255, 0, 0, 0.5))
        drop-shadow(-${s}px 0 0 rgba(0, 255, 255, 0.5))
      `}let a=t*.3;e.style.boxShadow=`
      0 0 ${a*20}px rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${a}),
      inset 0 0 ${a*10}px rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${a*.5})
    `}applyTranslucentPanel(e,t){let i=this.holographicState.transparency*t;e.style.background=`
      rgba(var(--spice-rgb-holographic-primary, var(--sn-holographic-rgb, 100, 255, 200)), ${i*.1}),
      linear-gradient(45deg,
        transparent 0%,
        rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${i*.05}) 50%,
        transparent 100%)
    `,e.style.backdropFilter=`blur(${Math.min(t*2,3)}px)`,e.style.border=`1px solid rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${i*.6})`}applyDataStream(e,t){let i=this.dataStream.speed*t,n=this.dataStream.density*t,r=this.generateDataStreamGradient(i,n);if(e.style.background=r,e.style.backgroundSize="100% 20px",e.style.animation=`dataStream ${2/i}s linear infinite`,!document.getElementById("dataStreamAnimation")){let a=document.createElement("style");a.id="dataStreamAnimation",a.textContent=`
        @keyframes dataStream {
          0% { background-position: 0 0; }
          100% { background-position: 0 20px; }
        }
      `,document.head.appendChild(a)}}applyEnergyBarrier(e,t){let i=this.holographicState.energyStability,n=this.holographicState.interferenceLevel*t,r=(1-i)*t;if(e.style.background=`
      linear-gradient(90deg,
        rgba(var(--sn-neon-glow-rgb, 0, 255, 255), ${r*.3}) 0%,
        rgba(var(--sn-neon-glow-rgb, 0, 255, 255), ${r*.1}) 50%,
        rgba(var(--sn-neon-glow-rgb, 0, 255, 255), ${r*.3}) 100%)
    `,e.style.backgroundSize="200% 100%",e.style.animation=`energyBarrier ${1/r}s ease-in-out infinite`,!document.getElementById("energyBarrierAnimation")){let a=document.createElement("style");a.id="energyBarrierAnimation",a.textContent=`
        @keyframes energyBarrier {
          0% { background-position: 0% 0%; }
          50% { background-position: 100% 0%; }
          100% { background-position: 0% 0%; }
        }
      `,document.head.appendChild(a)}}applyConsciousnessInterface(e,t,i){let r=this.manager.getConsciousnessState().symbioticResonance*i,a=r*t*.5;e.style.boxShadow=`
      0 0 ${a*30}px rgba(var(--sn-accent-rgb, 203, 166, 247), ${a}),
      inset 0 0 ${a*15}px rgba(var(--sn-accent-rgb, 203, 166, 247), ${a*.3})
    `;let s=.7+r*.3;if(e.style.opacity=s.toString(),r>.6){let o=this.animationState.organicPhase*2,l=1+Math.sin(o)*r*.2;e.style.transform=`scale(${l})`}}applyOrganicHologram(e,t,i){if(!i)return;let n=this.animationState.organicPhase,r=this.holographicState.energyStability*t,a=Math.sin(n*1.5)*r*2,s=Math.cos(n*2)*r*1.5;e.style.transform=`translate(${a}px, ${s}px)`;let o=n*.5,l=Math.sin(o)*r*30;e.style.filter=`hue-rotate(${l}deg)`;let m=n*.8,d=1+Math.sin(m)*r*.05;e.style.transform+=` scale(${d})`}applyMusicalVisualization(e,t){let n=this.manager.getConsciousnessState().symbioticResonance*t,r=this.animationState.dataStreamPhase*3,a=n*.8,s=Math.sin(r)*a*20;e.style.background=`
      linear-gradient(0deg,
        rgba(var(--sn-primary-rgb, 205, 214, 244), ${a*.8}) 0%,
        rgba(var(--sn-primary-rgb, 205, 214, 244), ${a*.4}) ${50+s}%,
        transparent ${50+s}%)
    `;let o=1+Math.sin(r*2)*n*.1;e.style.transform=`scaleY(${o})`}applyScanlineOverlay(e,t){let i=this.holographicState.scanlineIntensity*t,n=this.scanlineEffect.frequency;if(e.style.background=`
      repeating-linear-gradient(
        0deg,
        transparent 0px,
        transparent ${n-1}px,
        rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${i*.1}) ${n}px,
        rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${i*.1}) ${n}px
      )
    `,this.scanlineEffect.animation&&(e.style.animation=`scanlines ${1/this.scanlineEffect.speed}s linear infinite`),!document.getElementById("scanlineAnimation")){let r=document.createElement("style");r.id="scanlineAnimation",r.textContent=`
        @keyframes scanlines {
          0% { background-position: 0 0; }
          100% { background-position: 0 ${n}px; }
        }
      `,document.head.appendChild(r)}}applyChromaticGhost(e,t){let i=this.holographicState.chromatic*t,n=i*3,r=i*1.5,a=i*2;e.style.filter=`
      drop-shadow(${n}px 0 0 rgba(255, 0, 0, 0.4))
      drop-shadow(-${r}px 0 0 rgba(0, 255, 0, 0.4))
      drop-shadow(0 ${a}px 0 rgba(0, 0, 255, 0.4))
    `;let s=this.animationState.chromaticPhase,o=Math.sin(s*5)*i;e.style.transform=`translate(${o}px, 0)`}applyConsciousnessModifiers(e,t){let n=this.manager.getConsciousnessState().symbioticResonance*t,r=1+n*.3;e.style.filter=(e.style.filter||"")+` brightness(${r})`;let a=1+n*.5;e.style.filter=(e.style.filter||"")+` saturate(${a})`}applyOrganicModifiers(e,t){let i=this.animationState.organicPhase,n=this.holographicState.energyStability*t,r=i*1.2,a=Math.sin(r)*n*2,s=e.style.filter||"";!s.includes("blur(")&&a>0&&(e.style.filter=s+` blur(${Math.max(0,a)}px)`);let l=i*.7,m=1+Math.sin(l)*n*.2,d=parseFloat(e.style.opacity)||1;e.style.opacity=Math.max(.1,Math.min(1,d*m)).toString()}generateDataStreamGradient(e,t){let i=this.dataStream.characters,n=Math.floor(t*20),r="linear-gradient(90deg, ";for(let a=0;a<n;a++){let s=a/n*100,o=i[Math.floor(Math.random()*i.length)],l=.1+Math.random()*.3,m=this.getOKLABEnhancedDataStreamColor(l,this.lastMusicalContext);r+=`${m} ${s}%, `}return r=r.slice(0,-2)+")",r}async createInterfaceContainer(){this.interfaceContainer=document.createElement("div"),this.interfaceContainer.id="holographic-interface-container",this.interfaceContainer.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
      mix-blend-mode: normal;
    `,document.body.appendChild(this.interfaceContainer)}async initializeHolographicElements(){let e=[{selector:".main-view-container",type:"translucent_panel"},{selector:".Root__nav-bar",type:"data_stream"},{selector:".Root__now-playing-bar",type:"consciousness_interface"},{selector:".main-view-container__scroll-node",type:"organic_hologram"},{selector:".root-now-playing-view",type:"energy_barrier"},{selector:".main-view-container__scroll-node-child",type:"scanline_overlay"}];for(let t of e){let i=document.querySelectorAll(t.selector);for(let n of i){let r={id:`holographic-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,element:n,originalStyles:getComputedStyle(n),holographicType:t.type,intensity:.7,isActive:!0,lastUpdate:0,animation:null,consciousnessLevel:.8,organicIntegration:!0};this.holographicElements.set(r.id,r)}}}updateHolographicAnimation(e){if(!this.isInitialized||!this.isEnabled)return;let t=e/1e3;this.animationState.flickerPhase+=t*2,this.animationState.scanlinePhase+=t*this.scanlineEffect.speed,this.animationState.chromaticPhase+=t*1.5,this.animationState.dataStreamPhase+=t*this.dataStream.speed,this.animationState.interferencePhase+=t*this.interferencePattern.frequency,this.animationState.organicPhase+=t*.5,this.performanceMetrics.lastUpdate=performance.now()}startHolographicAnimation(){this.animationState.isAnimating=!0,this.animationState.lastFrameTime=performance.now();let e=t=>{if(!this.animationState.isAnimating)return;let i=t-this.animationState.lastFrameTime;this.animationState.lastFrameTime=t,this.updateHolographicAnimation(i),requestAnimationFrame(e)};requestAnimationFrame(e)}smoothTransition(e,t,i){return e+(t-e)*i}updatePerformanceMetrics(e){this.performanceMetrics.averageProcessingTime=this.performanceMetrics.averageProcessingTime*.9+e*.1,this.performanceMetrics.elementsProcessed=this.holographicElements.size,this.performanceMetrics.memoryUsage=this.holographicElements.size*256}getHolographicState(){return{...this.holographicState}}getPerformanceMetrics(){return{...this.performanceMetrics}}getElementCount(){return this.holographicElements.size}setEnabled(e){if(this.isEnabled=e,!e)for(let[t,i]of this.holographicElements)i.element.style.opacity="1",i.element.style.filter="",i.element.style.background="",i.element.style.boxShadow="",i.element.style.transform=""}setHolographicPreset(e){let t=this.holographicPresets[e];t&&(this.holographicState={...t})}setFlickerIntensity(e){this.holographicState.flickerIntensity=Math.max(0,Math.min(1,e))}enableVolumetricDepth(e=.8){let t=800+e*1200;this.interfaceContainer&&(this.interfaceContainer.style.perspective=`${t}px`,this.interfaceContainer.style.transformStyle="preserve-3d");for(let[i,n]of this.holographicElements)this.applyVolumetricLayers(n.element,e,n.intensity);console.log(`[HolographicUISystem] \u{1F30A} Volumetric depth enabled: ${t}px perspective`)}updateVolumetricLayers(e,t){let i=e*.8,n=(t-4e3)/4e3;for(let[r,a]of this.holographicElements)this.applyVolumetricLayers(a.element,i,a.intensity,n)}applyVolumetricLayers(e,t,i,n=.5){let r=t*100,a=n*50,s=r+a,o=e.style.transform||"",l=`translateZ(${s}px)`;o.includes("translateZ")?e.style.transform=o.replace(/translateZ\([^)]*\)/,l):e.style.transform=`${o} ${l}`.trim();let m=Math.abs(s)/100*i,d=m*30,h=s>0?m*5:-m*3,g=e.style.boxShadow||"",f=`0 ${h}px ${d}px rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${m*.3})`;g?e.style.boxShadow=`${g}, ${f}`:e.style.boxShadow=f,this.applyVolumetricAtmosphere(e,t,i)}applyVolumetricAtmosphere(e,t,i){let n=t*i,r=Math.max(0,(t-.5)*4),a=1+(t-.5)*.3,s=e.style.filter||"",o=s.includes("blur("),l=[r>0&&!o?`blur(${r}px)`:"",`brightness(${a})`,`saturate(${1+n*.2})`].filter(f=>f).join(" "),m=s.includes("brightness"),d=s.includes("saturate");s&&!m&&!d?e.style.filter=`${s} ${l}`:s||(e.style.filter=l);let h=parseFloat(e.style.opacity||"1"),g=Math.max(.3,h-(1-t)*.3);e.style.opacity=g.toString()}updateConsciousnessScanlines(e,t,i){let n=Math.max(.2,e*1.5),r=this.mapTemperatureToFrequency(t),a=Math.sin(performance.now()*.005*i)*.3+.7,s={"--consciousness-scanline-density":n.toString(),"--consciousness-scanline-frequency":`${r}px`,"--consciousness-scanline-opacity":(e*.15).toString(),"--musical-scanline-pulse":a.toString(),"--temperature-scanline-color-shift":`${(t-5e3)/3e3*30}deg`};this.cssController.batchSetVariables("HolographicUISystem",s,"high","consciousness-scanline-update")}updateAberrationEffects(e,t,i,n=!1){let r=document.documentElement,a=Math.min(1,e*1.2),s=Math.min(1,i*1.5),o=2+s*3,m=(Math.max(3e3,Math.min(8e3,t))-5500)/2500,d=1.5+m*2,h=-1.5-m*2,g=m*.5,f=Math.sin(performance.now()*.003*i)*.4+.6,v=n?1.5:1,C=1e3+e*2e3+i*1e3,P={"--aberration-intensity":(a*v).toString(),"--aberration-color-separation":`${o}px`,"--aberration-musical-sync":s.toString(),"--aberration-emotional-temperature":`${t}K`,"--aberration-consciousness-level":e.toString(),"--aberration-red-shift":`${d}px`,"--aberration-green-shift":`${g}px`,"--aberration-blue-shift":`${h}px`,"--aberration-wave-frequency":`${C}ms`,"--aberration-pulse-intensity":(f*v).toString()};this.cssController.batchSetVariables("HolographicUISystem",P,"high","aberration-effects-update");let E=parseFloat(r.style.getPropertyValue("--reading-mode-active")||"0"),L=Math.min(.8,E*.6);this.cssController.setVariable("HolographicUISystem","--aberration-reading-mode-reduction",L.toString(),"critical","aberration-reading-mode-update")}mapTemperatureToFrequency(e){return 2+(Math.max(3e3,Math.min(8e3,e))-3e3)/5e3*10}updateScanlineCSSVariables(e,t,i){let n={"--consciousness-scanline-density":e.toString(),"--consciousness-scanline-frequency":`${this.scanlineEffect.frequency}px`,"--consciousness-scanline-opacity":this.scanlineEffect.opacity.toString(),"--consciousness-scanline-speed":`${this.scanlineEffect.speed}s`,"--temperature-scanline-color-shift":`${(t-5e3)/2e3*30}deg`,"--musical-scanline-pulse":i.toString()};this.cssController.batchSetVariables("HolographicUISystem",n,"high","scanline-consciousness-update");let r={"--consciousness-scanline-interference":e>.7?"visible":"none","--consciousness-scanline-complexity":e>.7?Math.min(1,(e-.7)*3.33).toString():"0"};this.cssController.batchSetVariables("HolographicUISystem",r,"high","scanline-complexity-update")}detectReadingMode(){let e=document.documentElement,t=(window.getSelection()?.toString()||"").length>0,i=this.isUserCurrentlyScrolling(),n=this.isHoveringTextContent(),r=0;t&&(r+=.6),i&&(r+=.3),n&&(r+=.4),r=Math.min(1,r),this.cssController.setVariable("HolographicUISystem","--reading-mode-active",r.toString(),"critical","reading-mode-detection-update")}trackUserInteraction(){let e=document.documentElement,t=this.isMouseCurrentlyMoving(),i=this.wasRecentUIClick(),n=this.isFocusedOnInputElement(),r=0;t&&(r+=.4),i&&(r+=.5),n&&(r+=.6),r=Math.min(1,r),this.cssController.setVariable("HolographicUISystem","--user-interaction-detected",r.toString(),"high","user-interaction-update")}isUserCurrentlyScrolling(){let e=document.querySelector(".main-view-container__scroll-node");if(!e)return!1;let t=e.scrollTop,i=this.lastScrollPosition||0;return this.lastScrollPosition=t,Math.abs(t-i)>5}isHoveringTextContent(){let e=document.querySelector(":hover");return e?(e.textContent?.trim()||"").length>20:!1}isMouseCurrentlyMoving(){let e=performance.now(),t=this.lastMouseMovement||0;return e-t<2e3}wasRecentUIClick(){let e=performance.now(),t=this.lastUIClick||0;return e-t<1e3}isFocusedOnInputElement(){let e=document.activeElement;return e?["input","textarea","select"].includes(e.tagName.toLowerCase())||e.getAttribute("contenteditable")==="true":!1}setTransparency(e){this.holographicState.transparency=Math.max(0,Math.min(1,e))}setChromaticAberration(e){this.holographicState.chromatic=Math.max(0,Math.min(1,e))}destroy(){console.log("[HolographicUISystem] Destroying holographic UI system..."),this.animationState.isAnimating=!1;for(let[t,i]of this.holographicElements)i.element.style.opacity="1",i.element.style.filter="",i.element.style.background="",i.element.style.boxShadow="",i.element.style.transform="",i.animation&&i.animation.cancel();this.holographicElements.clear(),this.interfaceContainer&&this.interfaceContainer.parentNode&&this.interfaceContainer.parentNode.removeChild(this.interfaceContainer),["dataStreamAnimation","energyBarrierAnimation","scanlineAnimation"].forEach(t=>{let i=document.getElementById(t);i&&i.remove()}),this.isInitialized=!1,this.initialized=!1,this.eventSubscriptionIds.forEach(t=>{p.unsubscribe(t)}),this.eventSubscriptionIds=[]}setQualityLevel(e){switch(this.currentQualityLevel=e,e){case"low":this.holographicState.flickerIntensity=.1,this.holographicState.transparency=.9,this.holographicState.chromatic=.1,this.holographicState.scanlineIntensity=.2,this.holographicState.dataStreamFlow=.2,this.holographicState.interferenceLevel=0,this.scanlineEffect.animation=!1;break;case"low":this.holographicState.flickerIntensity=.2,this.holographicState.transparency=.85,this.holographicState.chromatic=.2,this.holographicState.scanlineIntensity=.3,this.holographicState.dataStreamFlow=.3,this.holographicState.interferenceLevel=.1,this.scanlineEffect.animation=!0,this.scanlineEffect.speed=.3;break;case"medium":this.holographicState.flickerIntensity=.4,this.holographicState.transparency=.8,this.holographicState.chromatic=.3,this.holographicState.scanlineIntensity=.6,this.holographicState.dataStreamFlow=.5,this.holographicState.interferenceLevel=.2,this.scanlineEffect.animation=!0,this.scanlineEffect.speed=.5;break;case"high":this.holographicState.flickerIntensity=.6,this.holographicState.transparency=.7,this.holographicState.chromatic=.5,this.holographicState.scanlineIntensity=.8,this.holographicState.dataStreamFlow=.8,this.holographicState.interferenceLevel=.4,this.scanlineEffect.animation=!0,this.scanlineEffect.speed=.8;break;case"high":this.holographicState.flickerIntensity=.8,this.holographicState.transparency=.6,this.holographicState.chromatic=.7,this.holographicState.scanlineIntensity=1,this.holographicState.dataStreamFlow=1,this.holographicState.interferenceLevel=.6,this.scanlineEffect.animation=!0,this.scanlineEffect.speed=1;break}this.updateQualityCapabilities(e)}getPerformanceImpact(){let e=this.holographicElements.size;return{fps:60,frameTime:this.calculateProcessingTime(),memoryUsage:this.estimateMemoryUsage(),cpuUsage:this.estimateCPUUsage(e)}}reduceQuality(e){this.qualityAdjustments["flicker-reduction"]=(this.qualityAdjustments["flicker-reduction"]||0)+e,this.qualityAdjustments["effect-reduction"]=(this.qualityAdjustments["effect-reduction"]||0)+e*.8,this.holographicState.flickerIntensity=Math.max(.1,this.holographicState.flickerIntensity*(1-e*.8)),this.holographicState.chromatic=Math.max(0,this.holographicState.chromatic*(1-e)),this.holographicState.scanlineIntensity=Math.max(.1,this.holographicState.scanlineIntensity*(1-e*.6)),this.holographicState.dataStreamFlow=Math.max(.1,this.holographicState.dataStreamFlow*(1-e*.4)),this.holographicState.interferenceLevel=Math.max(0,this.holographicState.interferenceLevel*(1-e)),e>.5&&(this.scanlineEffect.animation=!1)}increaseQuality(e){if(Object.keys(this.qualityAdjustments).forEach(t=>{this.qualityAdjustments[t]=Math.max(0,(this.qualityAdjustments[t]||0)-e)}),this.currentQualityLevel){let t=this.getPresetForLevel(this.currentQualityLevel);this.holographicState.flickerIntensity=Math.min(t.flickerIntensity,this.holographicState.flickerIntensity*(1+e*.3)),this.holographicState.chromatic=Math.min(t.chromatic,this.holographicState.chromatic*(1+e*.4)),this.holographicState.scanlineIntensity=Math.min(t.scanlineIntensity,this.holographicState.scanlineIntensity*(1+e*.2)),this.holographicState.dataStreamFlow=Math.min(t.dataStreamFlow,this.holographicState.dataStreamFlow*(1+e*.2)),e>.3&&(this.scanlineEffect.animation=!0)}}getQualityCapabilities(){return[...this.qualityCapabilities]}updateQualityCapabilities(e){this.qualityCapabilities.forEach(t=>{switch(t.name){case"holographic-effects":t.enabled=this.holographicState.flickerIntensity>.2;break;case"scanline-overlay":t.enabled=this.holographicState.scanlineIntensity>.3;break;case"chromatic-aberration":t.enabled=this.holographicState.chromatic>.2;break;case"data-streams":t.enabled=this.holographicState.dataStreamFlow>.3;break;case"interference-patterns":t.enabled=this.holographicState.interferenceLevel>.1;break;case"organic-integration":t.enabled=e!=="low";break}})}getPresetForLevel(e){switch(e){case"low":return this.holographicPresets["organic-consciousness"];case"medium":return this.holographicPresets["star-wars"];case"high":return this.holographicPresets["blade-runner"];default:return this.holographicPresets["star-wars"]}}calculateProcessingTime(){let e=this.holographicElements.size,t=(this.holographicState.flickerIntensity+this.holographicState.chromatic+this.holographicState.scanlineIntensity)/3;return Math.max(2,e*t*.5)}estimateMemoryUsage(){return .3*this.holographicElements.size+0}estimateCPUUsage(e){let i=(this.holographicState.flickerIntensity+this.holographicState.chromatic+this.holographicState.scanlineIntensity)/3,n=this.scanlineEffect.animation?1.5:1;return Math.min(30,2*e*i*n)}hexToRgb(e){try{let t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t&&t[1]&&t[2]&&t[3]?`${parseInt(t[1],16)}, ${parseInt(t[2],16)}, ${parseInt(t[3],16)}`:"100, 255, 200"}catch(t){return u?.debug?.warn("HolographicUISystem","Failed to convert hex to RGB:",t),"100, 255, 200"}}setupOKLABEventSubscriptions(){try{let e=p.subscribe("colors:oklab-enhanced",this.handleOKLABColorEvent.bind(this),"HolographicUISystem");this.eventSubscriptionIds.push(e);let t=p.subscribe("colors:musical-oklab-coordinated",this.handleMusicalOKLABEvent.bind(this),"HolographicUISystem");this.eventSubscriptionIds.push(t);let i=p.subscribe("colors:emotional-temperature-mapped",this.handleEmotionalTemperatureEvent.bind(this),"HolographicUISystem");this.eventSubscriptionIds.push(i);let n=p.subscribe("audio:genre-detected",this.handleGenreDetectionEvent.bind(this),"HolographicUISystem");this.eventSubscriptionIds.push(n),u?.debug?.log("HolographicUISystem","OKLAB event subscriptions established",{subscriptionCount:this.eventSubscriptionIds.length})}catch(e){u?.debug?.error("HolographicUISystem","Failed to setup OKLAB event subscriptions:",e)}}setupUserInteractionTracking(){try{document.addEventListener("mousemove",()=>{this.lastMouseMovement=performance.now()},{passive:!0}),document.addEventListener("click",()=>{this.lastUIClick=performance.now()},{passive:!0}),setInterval(()=>{this.detectReadingMode(),this.trackUserInteraction()},500),u?.debug?.log("HolographicUISystem","User interaction tracking initialized")}catch(e){u?.debug?.error("HolographicUISystem","Failed to setup user interaction tracking:",e)}}async handleOKLABColorEvent(e){try{let{enhancedColors:t,oklabPreset:i,rawColors:n,trackUri:r}=e;i&&(this.holographicPreset=i),t&&await this.updateHolographicColorsFromOKLAB(t),u?.debug?.log("HolographicUISystem","Updated holographic colors from OKLAB event",{preset:i?.name,trackUri:r,colorCount:Object.keys(t||{}).length})}catch(t){u?.debug?.error("HolographicUISystem","Failed to handle OKLAB color event:",t)}}async handleMusicalOKLABEvent(e){try{let{coordinatedColors:t,detectedGenre:i,emotionalResult:n,oklabPreset:r,musicInfluenceStrength:a,coordinationStrategy:s}=e;if(this.lastMusicalContext={genre:i,emotion:n?.primaryEmotion,preset:r,influence:a,strategy:s,timestamp:Date.now()},r&&(this.holographicPreset=r),t&&await this.updateHolographicColorsFromMusicalOKLAB(t,this.lastMusicalContext),n&&a!==void 0){let o=this.holographicState.flickerIntensity||.5,l=n.emotionalTemperature||6e3,m=a,d=n.beatDetected||!1;this.updateAberrationEffects(o,l,m,d)}u?.debug?.log("HolographicUISystem","Updated holographic effects from musical OKLAB coordination",{genre:i,emotion:n?.primaryEmotion,preset:r?.name,influence:a})}catch(t){u?.debug?.error("HolographicUISystem","Failed to handle musical OKLAB event:",t)}}async handleEmotionalTemperatureEvent(e){try{let{emotionalTemperature:t,primaryEmotion:i,perceptualColorHex:n,oklabPreset:r,cssVariables:a}=e;await this.updateHolographicEmotionalTemperature(t,i),n&&await this.updateHolographicColorFromEmotionalOKLAB(n,t);let s=this.holographicState.flickerIntensity||.5,o=this.lastMusicalContext?.influence||.5;this.updateAberrationEffects(s,t,o,!1),u?.debug?.log("HolographicUISystem","Updated holographic emotional temperature",{temperature:t,emotion:i,color:n})}catch(t){u?.debug?.error("HolographicUISystem","Failed to handle emotional temperature event:",t)}}async handleGenreDetectionEvent(e){try{let{detectedGenre:t,confidence:i,audioFeatures:n}=e,r=this.genreManager.getOKLABPresetForGenre(t);r&&(this.holographicPreset=r,await this.adjustHolographicEffectsForGenre(t,n)),u?.debug?.log("HolographicUISystem","Adjusted holographic effects for detected genre",{genre:t,confidence:i,preset:r?.name})}catch(t){u?.debug?.error("HolographicUISystem","Failed to handle genre detection event:",t)}}async updateHolographicColorsFromOKLAB(e){try{let t={};if(Object.entries(e).forEach(([i,n])=>{if(n&&typeof n=="string"){let r=this.oklabProcessor.processColor(n,this.holographicPreset);if(r.enhancedHex&&(t[`--holographic-${i.toLowerCase()}`]=r.enhancedHex,t[`--holographic-${i.toLowerCase()}-rgb`]=this.hexToRgb(r.enhancedHex),r.oklabEnhanced)){let{L:a,a:s,b:o}=r.oklabEnhanced;t[`--holographic-${i.toLowerCase()}-oklab`]=`${a.toFixed(3)} ${s.toFixed(3)} ${o.toFixed(3)}`}}}),e.VIBRANT||e.PRIMARY){let i=e.VIBRANT||e.PRIMARY;if(i){let n=this.oklabProcessor.processColor(i,this.holographicPreset);n.enhancedHex&&(t["--sn-holographic-rgb"]=this.hexToRgb(n.enhancedHex),t["--sn-holographic-primary"]=n.enhancedHex)}}Object.keys(t).length>0&&this.cssController.batchSetVariables("HolographicUISystem",t,"critical","oklab-holographic-colors-update")}catch(t){u?.debug?.error("HolographicUISystem","Failed to update holographic colors from OKLAB:",t)}}async updateHolographicColorsFromMusicalOKLAB(e,t){try{await this.updateHolographicColorsFromOKLAB(e),t.influence&&this.adjustHolographicIntensityFromMusicalInfluence(t.influence),t.genre&&await this.applyGenreSpecificHolographicEffects(t.genre,t.emotion)}catch(i){u?.debug?.error("HolographicUISystem","Failed to update holographic colors from musical OKLAB:",i)}}async updateHolographicColorFromEmotionalOKLAB(e,t){try{let i=document.documentElement,n=this.oklabProcessor.processColor(e,this.holographicPreset);if(n.enhancedHex){let r={"--holographic-emotional-primary":n.enhancedHex,"--holographic-emotional-rgb":this.hexToRgb(n.enhancedHex),"--holographic-emotional-temperature":`${t}K`};this.cssController.batchSetVariables("HolographicUISystem",r,"critical","emotional-oklab-holographic-update"),await this.updateHolographicEmotionalTemperature(t,null)}}catch(i){u?.debug?.error("HolographicUISystem","Failed to update holographic color from emotional OKLAB:",i)}}async updateHolographicEmotionalTemperature(e,t){try{let n=(Math.max(3e3,Math.min(8e3,e))-3e3)/5e3;this.holographicState.flickerIntensity=.2+n*.4,this.holographicState.chromatic=.1+n*.3,this.holographicState.energyStability=1-n*.3,n<.4?(this.holographicState.transparency=.9+n*.1,this.holographicState.dataStreamFlow=.3+n*.2):(this.holographicState.transparency=.8-(n-.4)*.2,this.holographicState.interferenceLevel=.1+(n-.4)*.3),u?.debug?.log("HolographicUISystem","Updated holographic effects from emotional temperature",{temperature:e,tempRatio:n,flicker:this.holographicState.flickerIntensity,chromatic:this.holographicState.chromatic})}catch(i){u?.debug?.error("HolographicUISystem","Failed to update holographic emotional temperature:",i)}}async adjustHolographicEffectsForGenre(e,t){try{switch(e.toLowerCase()){case"electronic":case"techno":case"edm":this.holographicState.dataStreamFlow=.8,this.holographicState.scanlineIntensity=.7,this.holographicState.interferenceLevel=.4,this.scanlineEffect.speed=.8;break;case"classical":case"orchestral":this.holographicState.transparency=.9,this.holographicState.energyStability=.8,this.holographicState.flickerIntensity=.2,this.scanlineEffect.organic=!0;break;case"rock":case"metal":this.holographicState.flickerIntensity=.6,this.holographicState.chromatic=.5,this.holographicState.interferenceLevel=.5,this.scanlineEffect.animation=!0;break;case"ambient":case"atmospheric":this.holographicState.transparency=.95,this.holographicState.dataStreamFlow=.3,this.holographicState.energyStability=.9,this.scanlineEffect.organic=!0,this.scanlineEffect.speed=.2;break;case"jazz":case"blues":this.holographicState.flickerIntensity=.4,this.holographicState.energyStability=.6,this.interferencePattern.type="organic",this.scanlineEffect.organic=!0;break;default:this.holographicState.flickerIntensity=.4,this.holographicState.transparency=.8,this.holographicState.chromatic=.3;break}u?.debug?.log("HolographicUISystem","Adjusted holographic effects for genre",{genre:e,flicker:this.holographicState.flickerIntensity,transparency:this.holographicState.transparency,dataFlow:this.holographicState.dataStreamFlow})}catch(i){u?.debug?.error("HolographicUISystem","Failed to adjust holographic effects for genre:",i)}}adjustHolographicIntensityFromMusicalInfluence(e){try{let t=.5+e*.5;this.holographicState.flickerIntensity*=t,this.holographicState.chromatic*=t,this.holographicState.scanlineIntensity*=t,this.holographicState.dataStreamFlow*=t,this.holographicState.interferenceLevel*=t,u?.debug?.log("HolographicUISystem","Adjusted holographic intensity from musical influence",{influence:e,multiplier:t})}catch(t){u?.debug?.error("HolographicUISystem","Failed to adjust holographic intensity from musical influence:",t)}}async applyGenreSpecificHolographicEffects(e,t){try{let i=`${e.toLowerCase()}-${t||"neutral"}`;e==="electronic"&&t==="energetic"?(this.setHolographicPreset("blade-runner"),this.holographicState.dataStreamFlow=1,this.holographicState.interferenceLevel=.6):e==="classical"&&t==="calm"?(this.setHolographicPreset("organic-consciousness"),this.holographicState.transparency=.95,this.holographicState.energyStability=.9):e==="rock"&&t==="aggressive"&&(this.setHolographicPreset("star-wars"),this.holographicState.flickerIntensity=.8,this.holographicState.chromatic=.6),u?.debug?.log("HolographicUISystem","Applied genre-specific holographic effects",{genre:e,emotion:t,effectKey:i})}catch(i){u?.debug?.error("HolographicUISystem","Failed to apply genre-specific holographic effects:",i)}}updateAnimation(e){this.updateHolographicAnimation(e)}async healthCheck(){try{let e=this.estimateMemoryUsage(),t=this.estimateCPUUsage(this.holographicElements.size),i=this.holographicElements.size,n=this.initialized&&e<10&&t<25&&i<100;return{healthy:n,message:n?"Holographic UI system operating normally":"Holographic UI system performance degraded",details:{initialized:this.initialized,activeElements:i,memoryUsageMB:e,cpuUsagePercent:t,oklabIntegration:this.eventSubscriptionIds.length>0,lastUpdate:this.performanceMetrics.lastUpdate}}}catch(e){return{healthy:!1,message:`Holographic UI system health check failed: ${e}`,details:{error:e instanceof Error?e.message:String(e)}}}}getOKLABEnhancedGlowColor(e){try{let t=getComputedStyle(document.documentElement).getPropertyValue("--sn-holographic-primary")?.trim()||"#64ffcc",i=this.oklabProcessor.processColor(t,this.holographicPreset);return i.enhancedHex?`rgba(${this.hexToRgb(i.enhancedHex)}, ${e})`:`rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${e})`}catch(t){return u?.debug?.warn("HolographicUISystem","Failed to get OKLAB enhanced glow color:",t),`rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${e})`}}getOKLABEnhancedPanelColor(e){try{let t=getComputedStyle(document.documentElement).getPropertyValue("--sn-holographic-primary")?.trim()||"#64ffcc",i=this.oklabProcessor.processColor(t,this.holographicPreset);if(i.enhancedHex){let n=this.hexToRgb(i.enhancedHex);return{background:`rgba(${n}, ${e*.1})`,gradient:`rgba(${n}, ${e*.05})`,border:`rgba(${n}, ${e*.6})`}}return{background:`rgba(var(--spice-rgb-holographic-primary, var(--sn-holographic-rgb, 100, 255, 200)), ${e*.1})`,gradient:`rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${e*.05})`,border:`rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${e*.6})`}}catch(t){return u?.debug?.warn("HolographicUISystem","Failed to get OKLAB enhanced panel color:",t),{background:`rgba(var(--spice-rgb-holographic-primary, var(--sn-holographic-rgb, 100, 255, 200)), ${e*.1})`,gradient:`rgba(var(--spice-rgb-holographic-accent, var(--sn-holographic-rgb, 100, 255, 200)), ${e*.05})`,border:`rgba(var(--spice-rgb-holographic-glow, var(--sn-holographic-rgb, 100, 255, 200)), ${e*.6})`}}}getOKLABConsciousnessGlow(e,t){try{let i=getComputedStyle(document.documentElement).getPropertyValue("--sn-accent-hex")?.trim()||"#cba6f7",n={...this.holographicPreset,chromaBoost:this.holographicPreset.chromaBoost*(1+t*.5),lightnessBoost:this.holographicPreset.lightnessBoost*(1+t*.3)},r=this.oklabProcessor.processColor(i,n);if(r.enhancedHex){let a=this.hexToRgb(r.enhancedHex);return{outer:`rgba(${a}, ${e})`,inner:`rgba(${a}, ${e*.3})`}}return{outer:`rgba(var(--sn-accent-rgb, 203, 166, 247), ${e})`,inner:`rgba(var(--sn-accent-rgb, 203, 166, 247), ${e*.3})`}}catch(i){return u?.debug?.warn("HolographicUISystem","Failed to get OKLAB consciousness glow:",i),{outer:`rgba(var(--sn-accent-rgb, 203, 166, 247), ${e})`,inner:`rgba(var(--sn-accent-rgb, 203, 166, 247), ${e*.3})`}}}getOKLABEnhancedDataStreamColor(e,t){try{let i="#64ffcc";if(t?.emotion){let r=this.emotionalMapper.mapMusicToEmotionalTemperature({energy:.5,valence:.5,tempo:120,genre:t.genre||"default"});r.perceptualColorHex&&(i=r.perceptualColorHex)}let n=this.oklabProcessor.processColor(i,this.holographicPreset);return n.enhancedHex?`rgba(${this.hexToRgb(n.enhancedHex)}, ${e})`:`rgba(var(--spice-rgb-holographic-primary, var(--sn-holographic-rgb, 100, 255, 200)), ${e})`}catch(i){return u?.debug?.warn("HolographicUISystem","Failed to get OKLAB enhanced data stream color:",i),`rgba(var(--spice-rgb-holographic-primary, var(--sn-holographic-rgb, 100, 255, 200)), ${e})`}}adjustQuality(e){switch(e){case"low":this.holographicState.energyStability=.3,this.holographicState.scanlineIntensity=.2,this.holographicState.interferenceLevel=.1;break;case"medium":this.holographicState.energyStability=.6,this.holographicState.scanlineIntensity=.5,this.holographicState.interferenceLevel=.3;break;case"high":default:this.holographicState.energyStability=1,this.holographicState.scanlineIntensity=.8,this.holographicState.interferenceLevel=.6;break}}}});var Hi,Rs=b(()=>{"use strict";D();de();$();Hi=class extends Q{constructor(t,i,n,r,a,s=null){super(t,i,n,r,a);this._scrollContainerElements=[];this._interactionHandler=null;this.year3000System=s,this.nexusState={currentNavigationScale:1,targetNavigationScale:1,userInfluence:0,lastEnergy:.5,lastValence:.5,lastVisualIntensity:.5,lastMoodIdentifier:"neutral"},this.biometricState={isMeditating:!1,lastUserInteractionTime:Date.now(),meditationGracePeriod:5e3,interactionCooldown:1e3,lastMeditationUpdateTime:null,desaturation:0,slowdown:1,targetDesaturation:0,targetSlowdown:1},this.lastHeavyUpdateTime=0,this.heavyUpdateInterval=1e3/10,this.lastBiometricCheckTime=0,this.biometricCheckInterval=1e3,this.lastInteractionRecordTime=0,this.interactionRecordInterval=200,this._animationRegistered=!1,this._performanceMode="auto",this._frameSkipCounter=0,this._maxFrameSkip=2,this.systemIntegrationMetrics={lastSystemsCheck:Date.now(),integrationHealth:"healthy",crossSystemErrors:0,meditationTransitions:0,navigationScaleUpdates:0};let o=this.utils.getHealthMonitor();o&&o.registerSystem("InteractionTrackingSystem",this),this.rootElement=this.utils.getRootStyle(),this.modalObserver=null,this._lastScrollTime=null,this._lastScrollTop=null}onAnimate(t){this.initialized&&this.updateAnimation(t)}async initialize(){await super.initialize();let t=globalThis.year3000System;this.cssController=t?.cssConsciousnessController||T(),this.initializeOptimizedQuantumSpace(),this.setupModalObserver(),this.setupOptimizedInteractionListener(),this._registerWithAnimationCoordinator()}_registerWithAnimationCoordinator(){this.year3000System&&this.year3000System.registerAnimationSystem?(this.year3000System.registerAnimationSystem("InteractionTrackingSystem",this,"normal",30),this._animationRegistered=!0):this._startFallbackAnimationLoops()}initializeOptimizedQuantumSpace(){if(!this.utils.getRootStyle())return;let i={"--sn-nav-item-transform-scale":"1.0","--sn-sidebar-meditation-desaturation":"0","--sn-sidebar-meditation-slowdown":"1"};this.cssController.batchSetVariables("InteractionTrackingSystem",i,"high","quantum-space-initialization")}recordUserInteraction(t){if(t.type==="scroll"){let r=t.target;if(r){let a=r.scrollTop,s=performance.now(),o=this._lastScrollTime?(a-(this._lastScrollTop??0))/(s-this._lastScrollTime):0,l=o<0?"up":"down";p.emit("user:scroll",{velocity:{x:0,y:o*1e3},direction:l,element:r.tagName||"unknown",timestamp:s}),this._lastScrollTop=a,this._lastScrollTime=s}}let n=performance.now();n-this.lastInteractionRecordTime<this.interactionRecordInterval||(this.lastInteractionRecordTime=n,this.nexusState.userInfluence+=.005,this.nexusState.userInfluence=Math.min(.5,this.nexusState.userInfluence),this.biometricState.lastUserInteractionTime=Date.now(),this.biometricState.isMeditating=!1)}setupModalObserver(){let t=document.querySelector(".main-modal-container");if(!t)return;let i=(n,r)=>{for(let a of n)if(a.type==="childList"){let s=t.children.length>0;this.nexusState.targetNavigationScale=s?.95:1}};this.modalObserver=new MutationObserver(i),this.modalObserver.observe(t,{childList:!0})}setupOptimizedInteractionListener(){this._interactionHandler=this.utils.throttle(a=>this.recordUserInteraction(a),100),["click","mousemove","keydown"].forEach(a=>{document.addEventListener(a,this._interactionHandler,{passive:!0})});let i=[".main-view-container__scroll-node",".main-view-container__scroll-node-child","section[data-testid='playlist-page']"],n=[];i.forEach(a=>{document.querySelectorAll(a).forEach(s=>{n.push(s)})}),(n.length?n:[document]).forEach(a=>{a.addEventListener("scroll",this._interactionHandler,{passive:!0})}),this._scrollContainerElements=n}updateFromMusicAnalysis(t,i,n){if(!this.initialized||!this.validateMusicData(t)){this.applySafeDefaults();return}this.updateNexusTargets(t)}updateNexusTargets(t){let{energy:i,valence:n,visualIntensity:r,moodIdentifier:a}=t;this.nexusState.lastEnergy=i,this.nexusState.lastValence=n,this.nexusState.lastVisualIntensity=r,this.nexusState.lastMoodIdentifier=a,this.nexusState.targetNavigationScale=this.calculateOptimizedNavigationScale(r,a)}updateDigitalMeditationState(t){let i=Date.now();if(i-this.lastBiometricCheckTime<this.biometricCheckInterval)return;this.lastBiometricCheckTime=i,i-this.biometricState.lastUserInteractionTime>this.biometricState.meditationGracePeriod&&t.energy<.3&&t.valence>.6?(this.biometricState.isMeditating=!0,this.biometricState.targetDesaturation=.6,this.biometricState.targetSlowdown=.5):(this.biometricState.isMeditating=!1,this.biometricState.targetDesaturation=0,this.biometricState.targetSlowdown=1)}updateAnimation(t){if(!this.initialized)return;let i=performance.now();if(this._frameSkipCounter++,!(this._frameSkipCounter<this._maxFrameSkip)&&(this._frameSkipCounter=0,this.animateOptimizedNexusFrame(t),i-this.lastHeavyUpdateTime>this.heavyUpdateInterval)){let n=this.musicSyncService?.getLatestProcessedData();n&&this.updateDigitalMeditationState(n),this.updateIntegrationMetrics(),this.lastHeavyUpdateTime=i}}onPerformanceModeChange(t){this._performanceMode=t,t==="performance"?(this.heavyUpdateInterval=1e3/5,this._maxFrameSkip=3,this.interactionRecordInterval=500):(this.heavyUpdateInterval=1e3/10,this._maxFrameSkip=2,this.interactionRecordInterval=200)}_startFallbackAnimationLoops(){let t=()=>{this.updateAnimation(16.67),requestAnimationFrame(t)};requestAnimationFrame(t)}animateOptimizedNexusFrame(t){let i=Math.min((t??16.67)/1e3*5,1);this.nexusState.currentNavigationScale=this.utils.lerp(this.nexusState.currentNavigationScale,this.nexusState.targetNavigationScale,i),this.biometricState.desaturation=this.utils.lerp(this.biometricState.desaturation,this.biometricState.targetDesaturation,i),this.biometricState.slowdown=this.utils.lerp(this.biometricState.slowdown,this.biometricState.targetSlowdown,i),this.applyOptimizedStateToCSS()}applyOptimizedStateToCSS(){let t={"--sn-nav-item-transform-scale":this.nexusState.currentNavigationScale.toFixed(3),"--sn-sidebar-meditation-desaturation":this.biometricState.desaturation.toFixed(3),"--sn-sidebar-meditation-slowdown":this.biometricState.slowdown.toFixed(3)};this.cssController.batchSetVariables("InteractionTrackingSystem",t,"high","interaction-state-update")}validateMusicData(t){return t&&typeof t.energy=="number"&&typeof t.valence=="number"&&typeof t.visualIntensity=="number"}applySafeDefaults(){let t={"--sn-nav-item-transform-scale":"1.0","--sn-sidebar-meditation-desaturation":"0","--sn-sidebar-meditation-slowdown":"1"};this.cssController.batchSetVariables("InteractionTrackingSystem",t,"critical","safe-defaults-fallback")}updateIntegrationMetrics(){}calculateIntegrationComplexity(){let t=0;return t+=this.nexusState.userInfluence*10,t+=this.nexusState.lastVisualIntensity*5,this.biometricState.isMeditating&&(t+=5),t}performCleanup(){this.nexusState.userInfluence>0&&(this.nexusState.userInfluence=Math.max(0,this.nexusState.userInfluence-.01))}calculateOptimizedNavigationScale(t=.5,i="neutral"){let n=1;return t>.7&&(n=1.02),i==="energetic"&&(n*=1.01),n}getNavigationScalingReport(){return{target:this.nexusState.targetNavigationScale,current:this.nexusState.currentNavigationScale,intensity:this.nexusState.lastVisualIntensity,mood:this.nexusState.lastMoodIdentifier}}getMeditationReport(){return{isMeditating:this.biometricState.isMeditating,timeSinceInteraction:(Date.now()-this.biometricState.lastUserInteractionTime)/1e3,desaturation:this.biometricState.desaturation,slowdown:this.biometricState.slowdown}}destroy(){this._interactionHandler&&(["click","mousemove","keydown"].forEach(t=>{document.removeEventListener(t,this._interactionHandler)}),this._scrollContainerElements.forEach(t=>{t.removeEventListener("scroll",this._interactionHandler)}),this._interactionHandler=null),super.destroy()}}});var zi,ks=b(()=>{"use strict";D();zi=class{constructor(e){this.year3000System=e;this.systemName="SpotifyUIApplicationSystem";this.initialized=!1;this.effectLayers=[];this.observerRegistry=new Map;this.lastDiscoveryLogTime=0;this.lastRefreshLogTime=0;this.debounceRefresh=this.debounce(()=>{this.refreshUITargets()},2e3);this.targets=this.initializeEmptyTargets()}updateAnimation(e){}async healthCheck(){try{let e=this.getTargetStats(),t=Object.values(e).reduce((r,a)=>r+a,0),i=this.initialized&&t>0,n=[];return t===0&&n.push("No UI elements discovered"),{healthy:i,ok:i,details:`UI Application System ${this.initialized?"active":"inactive"}, ${t} elements enhanced`,issues:n,system:"SpotifyUIApplicationSystem"}}catch(e){return{healthy:!1,ok:!1,details:"Health check failed",issues:[e instanceof Error?e.message:"Unknown error"],system:"SpotifyUIApplicationSystem"}}}forceRepaint(e){console.log(`\u{1F3A8} Force repaint requested: ${e||"manual trigger"}`),this.forceEffectCascade()}initializeEmptyTargets(){return{nowPlaying:[],sidebar:[],mainContent:[],buttons:[],cards:[],headers:[],textElements:[],iconElements:[],playbackControls:[],trackRows:[]}}async initialize(){if(!this.initialized)try{await this.discoverUITargets(),this.setupEffectLayers(),this.applyUnifiedState(),this.setupDOMObservers(),this.registerSystemCallbacks(),this.initialized=!0,console.log("\u2728 SpotifyUIApplicationSystem initialized successfully")}catch(e){throw console.error("Failed to initialize SpotifyUIApplicationSystem",e),e}}async discoverUITargets(){let e={nowPlaying:['[data-testid="now-playing-widget"]',".main-nowPlayingWidget-nowPlaying",".Root__now-playing-bar"],sidebar:['[data-testid="nav-bar"]',".main-navBar-navBar",".Root__nav-bar"],mainContent:['[data-testid="main"]',".main-view-container",".Root__main-view"],buttons:['button[class*="Button"]','[role="button"]',".main-playButton-PlayButton"],cards:['[data-testid*="card"]',".main-card-card",".main-entityCard-container"],headers:["h1, h2, h3, h4, h5, h6",'[data-testid*="header"]',".main-entityHeader-titleText"],textElements:['[data-testid="track-name"]','[data-testid="artist-name"]',".main-trackList-trackName",".main-trackList-artistName"],iconElements:['svg[class*="Icon"]','[data-testid*="icon"]',".Svg-sc-ytk21e-0"],playbackControls:['[data-testid="control-button"]',".main-playPauseButton-button",".player-controls__buttons"],trackRows:['[data-testid="tracklist-row"]',".main-trackList-trackListRow",".main-rootlist-rootlistItem"]},t={};for(let[n,r]of Object.entries(e))t[n]=r.join(", ");let i=new Map;for(let[n,r]of Object.entries(t))try{let a=document.querySelectorAll(r);for(let s of a)i.has(s)||i.set(s,[]),i.get(s).push(n)}catch{continue}this.targets=this.initializeEmptyTargets();for(let[n,r]of i)for(let a of r)this.targets[a].push(n);performance.now()-this.lastDiscoveryLogTime>=5e3&&(console.log("\u{1F3AF} UI targets discovered",{nowPlaying:this.targets.nowPlaying.length,sidebar:this.targets.sidebar.length,mainContent:this.targets.mainContent.length,buttons:this.targets.buttons.length,cards:this.targets.cards.length,headers:this.targets.headers.length,textElements:this.targets.textElements.length,iconElements:this.targets.iconElements.length,playbackControls:this.targets.playbackControls.length,trackRows:this.targets.trackRows.length}),this.lastDiscoveryLogTime=performance.now())}setupEffectLayers(){this.effectLayers=[{name:"background-containers",elements:[...this.targets.mainContent,...this.targets.sidebar],priority:10,cssVariables:{"--sn-bg-primary":"var(--sn-accent-primary)","--sn-bg-secondary":"var(--sn-accent-secondary)","--sn-gradient-start":"var(--sn-gradient-primary-rgb)","--sn-gradient-end":"var(--sn-gradient-secondary-rgb)"}},{name:"ui-cards",elements:this.targets.cards,priority:20,cssVariables:{"--sn-card-bg":"var(--sn-accent-primary)","--sn-card-border":"var(--sn-accent-secondary)","--sn-card-glow":"var(--sn-accent-tertiary)","--sn-glassmorphism-intensity":"var(--sn-effect-intensity)"},interactionEffects:!0},{name:"interactive-elements",elements:[...this.targets.buttons,...this.targets.playbackControls],priority:30,cssVariables:{"--sn-button-bg":"var(--sn-accent-primary)","--sn-button-hover":"var(--sn-accent-secondary)","--sn-button-active":"var(--sn-accent-tertiary)","--sn-beat-sync-intensity":"var(--sn-music-intensity)"},interactionEffects:!0},{name:"text-icon-effects",elements:[...this.targets.textElements,...this.targets.iconElements,...this.targets.headers],priority:40,cssVariables:{"--sn-text-primary":"var(--sn-accent-primary)","--sn-text-secondary":"var(--sn-accent-secondary)","--sn-text-glow":"var(--sn-accent-tertiary)","--sn-icon-color":"var(--sn-accent-primary)","--sn-icon-glow":"var(--sn-accent-secondary)"}},{name:"now-playing-effects",elements:this.targets.nowPlaying,priority:50,cssVariables:{"--sn-now-playing-bg":"var(--sn-accent-primary)","--sn-now-playing-glow":"var(--sn-accent-secondary)","--sn-beat-pulse":"var(--sn-music-intensity)","--sn-track-progress":"var(--sn-accent-tertiary)"},interactionEffects:!0}]}applyUnifiedState(){this.effectLayers.forEach(e=>{e.elements.forEach(t=>{this.applyEffectToElement(t,e)})})}safeQueueCSSVariableUpdate(e,t,i){this.year3000System?.queueCSSVariableUpdate?this.year3000System.queueCSSVariableUpdate(e,t,i||null):(i||document.documentElement).style.setProperty(e,t)}applyEffectToElement(e,t){e instanceof HTMLElement&&(Object.entries(t.cssVariables).forEach(([i,n])=>{this.safeQueueCSSVariableUpdate(i,n,e)}),e.classList.add(`sn-${t.name}`),e.classList.add("sn-ui-enhanced"),t.interactionEffects&&this.addInteractionEffects(e,t),e.setAttribute("data-sn-layer",t.name),e.setAttribute("data-sn-priority",t.priority.toString()))}addInteractionEffects(e,t){(t.name==="interactive-elements"||t.name==="now-playing-effects")&&(this.safeQueueCSSVariableUpdate("--sn-beat-response","var(--sn-music-intensity)",e),e.classList.add("sn-beat-responsive")),e.addEventListener("mouseenter",()=>{this.safeQueueCSSVariableUpdate("--sn-hover-intensity","1",e),e.classList.add("sn-hover-active")}),e.addEventListener("mouseleave",()=>{this.safeQueueCSSVariableUpdate("--sn-hover-intensity","0",e),e.classList.remove("sn-hover-active")}),e.addEventListener("click",()=>{this.safeQueueCSSVariableUpdate("--sn-click-intensity","1",e),e.classList.add("sn-click-active"),setTimeout(()=>{this.safeQueueCSSVariableUpdate("--sn-click-intensity","0",e),e.classList.remove("sn-click-active")},300)})}setupDOMObservers(){let e={childList:!0,subtree:!1,attributes:!1},t=new MutationObserver(n=>{let r=!1;n.forEach(a=>{a.type==="childList"&&a.addedNodes.length>0&&Array.from(a.addedNodes).some(o=>{if(o.nodeType===Node.ELEMENT_NODE){let l=o;return l.matches('[data-testid*="card"], [data-testid*="track"], [data-testid*="header"], [role="button"]')||l.querySelector('[data-testid*="card"], [data-testid*="track"], [data-testid*="header"], [role="button"]')}return!1})&&(r=!0)}),r&&this.debounceRefresh()}),i=document.querySelector('[data-testid="main"]')||document.body;t.observe(i,e),this.observerRegistry.set("main",t)}debounce(e,t){let i;return function(...r){let a=()=>{clearTimeout(i),e(...r)};clearTimeout(i),i=setTimeout(a,t)}}async refreshUITargets(){try{let e=this.calculateTargetHash();await this.discoverUITargets();let t=this.calculateTargetHash();e!==t&&(this.applyUnifiedState(),performance.now()-this.lastRefreshLogTime>=1e4&&(console.log("\u{1F504} UI targets refreshed"),this.lastRefreshLogTime=performance.now()))}catch(e){console.error("Failed to refresh UI targets",e)}}calculateTargetHash(){return Object.values(this.targets).map(t=>t.length).join("-")}registerSystemCallbacks(){try{p.subscribe("colors:harmonized",e=>{this.handleColorHarmonizedEvent({type:"colors/harmonized",payload:{processedColors:e.processedColors,accentHex:e.accentHex||"#cba6f7",accentRgb:e.accentRgb||"203,166,247",context:{rawColors:e.processedColors,trackUri:"",timestamp:Date.now()},cssVariables:{},metadata:{strategy:e.strategies[0]||"unknown",accentHex:e.accentHex,processingTime:e.processingTime}}})},"SpotifyUIApplicationSystem"),console.log("\u{1F3A8} [SpotifyUIApplicationSystem] Subscribed to colors:harmonized events")}catch(e){if(console.error("[SpotifyUIApplicationSystem] Failed to subscribe to colors:harmonized events:",e),this.year3000System.colorHarmonyEngine){let t=this.year3000System.applyColorsToTheme.bind(this.year3000System);this.year3000System.applyColorsToTheme=(i={})=>{t(i),this.updateColorVariables(i)},console.warn("[SpotifyUIApplicationSystem] Using legacy color application hook as fallback")}}if(this.year3000System.musicSyncService){let e=this.year3000System.updateFromMusicAnalysis.bind(this.year3000System);this.year3000System.updateFromMusicAnalysis=(t,i,n)=>{e(t,i,n),this.updateMusicIntensity(t)}}this.year3000System.beatSyncVisualSystem&&(this.year3000System.timerConsolidationSystem?this.year3000System.timerConsolidationSystem.registerConsolidatedTimer("SpotifyUIApplicationSystem-beatEffects",()=>{let e=this.getCurrentMusicIntensity();e>.5&&this.triggerBeatEffects({intensity:e})},200,"normal"):setInterval(()=>{let e=this.getCurrentMusicIntensity();e>.5&&this.triggerBeatEffects({intensity:e})},200))}getCurrentMusicIntensity(){let e=document.documentElement,t=getComputedStyle(e).getPropertyValue("--sn-kinetic-energy").trim();return parseFloat(t)||0}handleColorHarmonizedEvent(e){if(e.type!=="colors/harmonized")return;let{processedColors:t,cssVariables:i,metadata:n}=e.payload;console.log("\u{1F3A8} [SpotifyUIApplicationSystem] Received harmonized colors via event-driven pattern",{strategy:n.strategy,colorsCount:Object.keys(t).length,cssVariablesCount:Object.keys(i).length});try{this.updateColorVariables(t),i&&Object.keys(i).length>0&&this.applyCSSVariablesToSpotifyUI(i)}catch(r){console.error("[SpotifyUIApplicationSystem] Failed to apply harmonized colors from event:",r),this.updateColorVariables(t)}}applyCSSVariablesToSpotifyUI(e){try{let t=document.documentElement,i=document.querySelectorAll(".sn-ui-enhanced");for(let[n,r]of Object.entries(e))n&&r&&t.style.setProperty(n,r);i.forEach(n=>{if(n instanceof HTMLElement)for(let[r,a]of Object.entries(e))r&&a&&n.style.setProperty(r,a)}),console.log("\u{1F3A8} [SpotifyUIApplicationSystem] Applied CSS variables to Spotify UI",{variablesCount:Object.keys(e).length,enhancedElementsCount:i.length})}catch(t){console.error("[SpotifyUIApplicationSystem] Failed to apply CSS variables to Spotify UI:",t)}}updateColorVariables(e){document.querySelectorAll(".sn-ui-enhanced").forEach(i=>{i instanceof HTMLElement&&(this.safeQueueCSSVariableUpdate("--sn-accent-primary",e.primary||"var(--spice-accent)",i),this.safeQueueCSSVariableUpdate("--sn-accent-secondary",e.secondary||"var(--spice-accent)",i),this.safeQueueCSSVariableUpdate("--sn-accent-tertiary",e.tertiary||"var(--spice-accent)",i))})}updateMusicIntensity(e){let t=e?.processedEnergy||0;document.querySelectorAll(".sn-beat-responsive").forEach(n=>{n instanceof HTMLElement&&this.safeQueueCSSVariableUpdate("--sn-music-intensity",t.toString(),n)})}triggerBeatEffects(e){document.querySelectorAll(".sn-beat-responsive").forEach(i=>{i instanceof HTMLElement&&(this.safeQueueCSSVariableUpdate("--sn-beat-pulse","1",i),i.classList.add("sn-beat-active"),setTimeout(()=>{this.safeQueueCSSVariableUpdate("--sn-beat-pulse","0",i),i.classList.remove("sn-beat-active")},200))})}forceEffectCascade(){this.effectLayers.sort((e,t)=>e.priority-t.priority).forEach(e=>{e.elements.forEach(t=>{this.applyEffectToElement(t,e)})})}async destroy(){this.year3000System?.timerConsolidationSystem&&this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer("SpotifyUIApplicationSystem-beatEffects"),this.observerRegistry.forEach(t=>{t.disconnect()}),this.observerRegistry.clear(),document.querySelectorAll(".sn-ui-enhanced").forEach(t=>{t.classList.remove("sn-ui-enhanced"),t.removeAttribute("data-sn-layer"),t.removeAttribute("data-sn-priority")}),this.initialized=!1}getTargetStats(){return Object.fromEntries(Object.entries(this.targets).map(([e,t])=>[e,t.length]))}}});var Oi,Ds=b(()=>{"use strict";D();Ae();ne();Oi=class{constructor(e,t,i){this.initialized=!1;this.dramaticElements=new Map;this.performanceMetrics={energyBurstCount:0,averageProcessingTime:0,lastUpdateTime:0,cpuUsage:0};this.animationState={energyPhase:0,dramaticPhase:0,interferencePhase:0,lastFrameTime:0,isAnimating:!1};this.cinematicPalettes={"blade-runner":{primaryRed:{r:255,g:50,b:50},amberGlow:{r:255,g:140,b:0},deepBlue:{r:0,g:100,b:200},neonCyan:{r:0,g:255,b:255}},cyberpunk:{primaryRed:{r:255,g:0,b:100},amberGlow:{r:255,g:180,b:0},deepBlue:{r:50,g:50,b:255},neonCyan:{r:100,g:255,b:255}},"dramatic-noir":{primaryRed:{r:200,g:0,b:0},amberGlow:{r:255,g:120,b:0},deepBlue:{r:0,g:50,b:150},neonCyan:{r:0,g:200,b:255}}};this.holographicSystem=e,this.cssController=t,this.musicSyncService=i,this.oklabProcessor=new M(!0),this.emotionalMapper=new J(!0),this.cinematicPreset=M.getPreset("COSMIC"),this.energyBurstState={burstIntensity:0,burstFrequency:.5,colorTemperature:2500,interferenceLevel:0,scanlineVelocity:1,holographicDepth:0,musicTension:0,energyStability:1},this.cinematicConfig={energyActivationThreshold:.7,maxHolographicIntensity:.9,crtFilteringStrength:.8,bladeRunnerMode:!0,energyBurstDuration:1500,baseScanlineFrequency:120}}async initialize(){if(!this.initialized)try{console.log("[RedEnergyBurstSystem] Initializing red energy burst system..."),this.subscribeToColorConsciousness(),this.subscribeToOKLABColorEvents(),await this.initializeDramaticElements(),this.setupCinematicCSSVariables(),this.startCinematicAnimation(),this.initialized=!0,console.log("[RedEnergyBurstSystem] \u2705 Ready for dramatic consciousness moments")}catch(e){throw console.error("[RedEnergyBurstSystem] Failed to initialize:",e),e}}updateAnimation(e){if(!this.initialized)return;let t=e/1e3;this.animationState.energyPhase+=t*this.energyBurstState.burstFrequency*2,this.animationState.dramaticPhase+=t*.8,this.animationState.interferencePhase+=t*3,this.updateEnergyBurstFromMusic(),this.updateHolographicMapping(),this.updateDramaticElements(),this.updatePerformanceMetrics(e)}async healthCheck(){let e=this.initialized&&this.energyBurstState.burstIntensity>=0&&this.performanceMetrics.averageProcessingTime<5;return{system:"RedEnergyBurstSystem",healthy:e,metrics:{energyBurstCount:this.performanceMetrics.energyBurstCount,processingTime:this.performanceMetrics.averageProcessingTime,dramaticElementCount:this.dramaticElements.size,cpuUsage:this.performanceMetrics.cpuUsage},issues:e?[]:["Performance degradation detected"]}}subscribeToColorConsciousness(){p.subscribe("emotionalColorContext:updated",e=>{this.onColorConsciousnessUpdate(e)},"RedEnergyBurstSystem"),p.subscribe("emotion:analyzed",e=>{this.onMusicIntensitySpike(e)},"RedEnergyBurstSystem"),p.subscribe("emotion:analyzed",e=>{this.onDramaticMoment(e)},"RedEnergyBurstSystem")}subscribeToOKLABColorEvents(){p.subscribe("colors:harmonized",e=>{this.onOKLABColorsHarmonized(e)},"RedEnergyBurstSystem"),p.subscribe("colors:extracted",e=>{this.onColorsExtracted(e)},"RedEnergyBurstSystem")}onColorConsciousnessUpdate(e){let{palette:t,consciousnessLevel:i,emotionalTemperature:n}=e;this.energyBurstState.musicTension=i*.8,n<3e3?this.energyBurstState.colorTemperature=2200:n>6e3?this.energyBurstState.colorTemperature=2800:this.energyBurstState.colorTemperature=2500;let r=this.extractDominantRedColor(t);this.updateHolographicColors(r)}onMusicIntensitySpike(e){let{intensity:t,beat:i}=e;t>this.cinematicConfig.energyActivationThreshold&&this.triggerEnergyBurst(t,i)}onDramaticMoment(e){let{type:t,intensity:i}=e;this.energyBurstState.musicTension=Math.min(1,i*1.2),this.energyBurstState.interferenceLevel=i*.6,this.energyBurstState.energyStability=Math.max(.3,1-i*.7)}onOKLABColorsHarmonized(e){let{processedColors:t,coordinationMetrics:i}=e,n=this.extractCinematicOKLABColors(t);this.updateCinematicPaletteWithOKLAB(n),(i?.detectedGenre||i?.emotionalState)&&this.adjustCinematicPresetForContext(i)}onColorsExtracted(e){let{rawColors:t,musicData:i}=e;if(i){let n=this.emotionalMapper.mapMusicToEmotionalTemperature(i);this.adjustCinematicEffectsForEmotion(n),n.intensity>.7?this.cinematicPreset=M.getPreset("COSMIC"):n.intensity>.4?this.cinematicPreset=M.getPreset("VIBRANT"):this.cinematicPreset=M.getPreset("STANDARD")}}triggerEnergyBurst(e,t){let i=performance.now();this.energyBurstState.burstIntensity=Math.min(1,e*1.1),this.energyBurstState.burstFrequency=1+e*2,this.energyBurstState.holographicDepth=e*.8,this.energyBurstState.scanlineVelocity=1+t.strength*2,setTimeout(()=>{this.decayEnergyBurst()},this.cinematicConfig.energyBurstDuration),this.performanceMetrics.energyBurstCount++,this.performanceMetrics.lastUpdateTime=performance.now()-i,console.log(`[RedEnergyBurstSystem] \u{1F525} Red energy burst triggered! Intensity: ${e.toFixed(2)}`)}decayEnergyBurst(){let t=()=>{this.energyBurstState.burstIntensity*=.95,this.energyBurstState.holographicDepth*=.96,this.energyBurstState.interferenceLevel*=.97,this.energyBurstState.burstIntensity>.05?requestAnimationFrame(t):(this.energyBurstState.burstIntensity=0,this.energyBurstState.holographicDepth=0,this.energyBurstState.interferenceLevel=0)};requestAnimationFrame(t)}updateEnergyBurstFromMusic(){let e=this.musicSyncService.getCurrentMusicState();if(!e)return;let{emotion:t,beat:i,intensity:n}=e;if(i&&i.tempo){let r=Math.max(.5,Math.min(2,i.tempo/120));this.energyBurstState.burstFrequency=this.energyBurstState.burstFrequency*r}t&&t.arousal>.7&&(this.energyBurstState.interferenceLevel=Math.max(this.energyBurstState.interferenceLevel,t.arousal*.5))}updateHolographicMapping(){let e=this.cinematicPalettes["blade-runner"],t={primaryColor:this.blendRedColors(e.primaryRed,e.amberGlow,this.energyBurstState.colorTemperature/3e3),glowIntensity:this.energyBurstState.burstIntensity*this.cinematicConfig.maxHolographicIntensity,flickerRate:this.energyBurstState.burstFrequency*2,scanlineColor:e.amberGlow,atmosphericDepth:this.energyBurstState.holographicDepth,interferencePattern:this.getInterferencePattern()};this.updateCinematicCSSVariables(t)}blendRedColors(e,t,i){let n=Math.max(0,Math.min(1,i));try{let r=`#${e.r.toString(16).padStart(2,"0")}${e.g.toString(16).padStart(2,"0")}${e.b.toString(16).padStart(2,"0")}`,a=`#${t.r.toString(16).padStart(2,"0")}${t.g.toString(16).padStart(2,"0")}${t.b.toString(16).padStart(2,"0")}`;return this.oklabProcessor.interpolateOKLAB(r,a,n,this.cinematicPreset).enhancedRgb}catch{return{r:Math.round(e.r*(1-n)+t.r*n),g:Math.round(e.g*(1-n)+t.g*n),b:Math.round(e.b*(1-n)+t.b*n)}}}getInterferencePattern(){return this.energyBurstState.energyStability<.4?"chaotic":this.energyBurstState.musicTension>.7?"intense":this.energyBurstState.interferenceLevel>.5?"noise":"wave"}extractDominantRedColor(e){let t={r:255,g:50,b:50};if(e&&e.length>0){let i=e.filter(n=>n.r>n.g&&n.r>n.b);i.length>0&&(t=i[0])}return t}extractCinematicOKLABColors(e){let i={...this.cinematicPalettes["blade-runner"]};if(e.VIBRANT){let n=this.oklabProcessor.processColor(e.VIBRANT,this.cinematicPreset);i.primaryRed=n.enhancedRgb}if(e.PROMINENT){let n=this.oklabProcessor.processColor(e.PROMINENT,this.cinematicPreset);i.amberGlow=n.enhancedRgb}if(e.DARK_VIBRANT){let n=this.oklabProcessor.processColor(e.DARK_VIBRANT,this.cinematicPreset);i.deepBlue=n.enhancedRgb}return i}updateCinematicPaletteWithOKLAB(e){this.cinematicPalettes["blade-runner"]=e,this.cssController.queueCSSVariableUpdate("--cinematic-red-r",e.primaryRed.r.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-red-g",e.primaryRed.g.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-red-b",e.primaryRed.b.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-amber-r",e.amberGlow.r.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-amber-g",e.amberGlow.g.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-amber-b",e.amberGlow.b.toString())}adjustCinematicPresetForContext(e){let{detectedGenre:t,emotionalState:i,oklabPreset:n}=e;if(t)switch(t){case"electronic":case"dance":case"techno":this.cinematicPreset=M.getPreset("COSMIC"),this.cinematicConfig.bladeRunnerMode=!0;break;case"rock":case"metal":this.cinematicPreset=M.getPreset("VIBRANT"),this.cinematicConfig.energyActivationThreshold=.6;break;case"ambient":case"classical":this.cinematicPreset=M.getPreset("SUBTLE"),this.cinematicConfig.energyActivationThreshold=.8;break;default:this.cinematicPreset=M.getPreset("STANDARD")}if(i)switch(i){case"aggressive":case"energetic":this.energyBurstState.burstFrequency*=1.5,this.energyBurstState.interferenceLevel=Math.min(1,this.energyBurstState.interferenceLevel+.3);break;case"calm":case"ambient":this.energyBurstState.burstFrequency*=.7,this.energyBurstState.energyStability=Math.min(1,this.energyBurstState.energyStability+.2);break;case"mysterious":this.cinematicConfig.bladeRunnerMode=!0,this.energyBurstState.interferenceLevel=Math.min(1,this.energyBurstState.interferenceLevel+.2);break}}adjustCinematicEffectsForEmotion(e){let{primaryEmotion:t,intensity:i,temperature:n}=e;switch(this.energyBurstState.musicTension=i*.9,n<3e3?this.energyBurstState.colorTemperature=2200:n>6e3?this.energyBurstState.colorTemperature=2800:this.energyBurstState.colorTemperature=2500,t){case"aggressive":this.energyBurstState.interferenceLevel=Math.min(1,i*.8),this.energyBurstState.energyStability=Math.max(.2,1-i);break;case"calm":this.energyBurstState.energyStability=Math.min(1,.8+i*.2),this.energyBurstState.interferenceLevel*=.5;break;case"mysterious":this.energyBurstState.interferenceLevel=i*.6,this.cinematicConfig.bladeRunnerMode=!0;break;case"energetic":this.energyBurstState.burstFrequency=Math.min(3,1+i*2);break}}updateHolographicColors(e){this.cssController.queueCSSVariableUpdate("--cinematic-red-r",e.r.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-red-g",e.g.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-red-b",e.b.toString())}async initializeDramaticElements(){let e=[{selector:".Root__now-playing-bar",type:"energy_barrier"},{selector:".main-view-container",type:"cinematic_overlay"},{selector:".Root__nav-bar",type:"data_stream_red"},{selector:".player-controls",type:"dramatic_interface"}];for(let t of e){let i=document.querySelectorAll(t.selector);for(let n of i){let r={id:`dramatic-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,element:n,originalStyles:getComputedStyle(n),holographicType:t.type,intensity:.8,isActive:!0,lastUpdate:0,animation:null,consciousnessLevel:.9,organicIntegration:!0};this.dramaticElements.set(r.id,r)}}}setupCinematicCSSVariables(){let e={"--cinematic-red-r":"255","--cinematic-red-g":"50","--cinematic-red-b":"50","--cinematic-amber-r":"255","--cinematic-amber-g":"140","--cinematic-amber-b":"0","--cinematic-glow-intensity":"0","--cinematic-flicker-rate":"0.5","--cinematic-scanline-speed":"1.0","--cinematic-interference":"0","--cinematic-depth":"0"};for(let[t,i]of Object.entries(e))this.cssController.queueCSSVariableUpdate(t,i)}updateCinematicCSSVariables(e){this.cssController.queueCSSVariableUpdate("--cinematic-glow-intensity",e.glowIntensity.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-flicker-rate",e.flickerRate.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-scanline-speed",this.energyBurstState.scanlineVelocity.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-interference",this.energyBurstState.interferenceLevel.toString()),this.cssController.queueCSSVariableUpdate("--cinematic-depth",e.atmosphericDepth.toString())}updateDramaticElements(){for(let[e,t]of this.dramaticElements)t.isActive&&this.updateDramaticElement(t)}updateDramaticElement(e){let{element:t,intensity:i}=e;this.energyBurstState.burstIntensity>.1&&this.applyRedEnergyBurst(t,i),this.energyBurstState.interferenceLevel>.1&&this.applyCRTInterference(t,i),this.applyDramaticScanlines(t,i)}applyRedEnergyBurst(e,t){let i=this.energyBurstState.burstIntensity*t,n=Math.sin(this.animationState.energyPhase*3)*.5+.5,r=i*n*.8;e.style.boxShadow=`
      0 0 ${r*40}px rgba(var(--cinematic-red-r), var(--cinematic-red-g), var(--cinematic-red-b), ${r}),
      inset 0 0 ${r*20}px rgba(var(--cinematic-amber-r), var(--cinematic-amber-g), var(--cinematic-amber-b), ${r*.5})
    `,i>.3&&(e.style.border=`1px solid rgba(var(--cinematic-red-r), var(--cinematic-red-g), var(--cinematic-red-b), ${i})`)}applyCRTInterference(e,t){let i=this.energyBurstState.interferenceLevel*t,n=this.animationState.interferencePhase,r=i*3,a=Math.sin(n*2)*r,s=Math.cos(n*2.5)*r;if(e.style.filter=`
      drop-shadow(${a}px 0 0 rgba(var(--spice-rgb-cinematic-red, 255, 0, 0), ${i*.6}))
      drop-shadow(${s}px 0 0 rgba(var(--spice-rgb-cinematic-cyan, 0, 255, 255), ${i*.4}))
    `,i>.5){let o=Math.sin(n*10)*i*2;e.style.transform=`translateX(${o}px)`}}applyDramaticScanlines(e,t){let i=this.energyBurstState.burstIntensity*t*.6;if(i>.1){let n=this.cinematicConfig.baseScanlineFrequency/30;e.style.background=`
        ${e.style.background||""},
        repeating-linear-gradient(
          0deg,
          transparent 0px,
          transparent ${n-1}px,
          rgba(var(--cinematic-amber-r), var(--cinematic-amber-g), var(--cinematic-amber-b), ${i*.15}) ${n}px
        )
      `}}startCinematicAnimation(){this.animationState.isAnimating=!0,this.animationState.lastFrameTime=performance.now();let e=t=>{if(!this.animationState.isAnimating)return;let i=t-this.animationState.lastFrameTime;this.animationState.lastFrameTime=t,this.updateAnimation(i),requestAnimationFrame(e)};requestAnimationFrame(e)}updatePerformanceMetrics(e){this.performanceMetrics.averageProcessingTime=this.performanceMetrics.averageProcessingTime*.9+e*.1,this.performanceMetrics.cpuUsage=Math.min(100,e/16.67*100)}forceRepaint(e){console.log(`[RedEnergyBurstSystem] Force repaint triggered: ${e||"Unknown"}`),this.updateDramaticElements(),this.cssController.flushCSSVariableBatch()}destroy(){console.log("[RedEnergyBurstSystem] Destroying cinematic drama engine..."),this.animationState.isAnimating=!1,this.dramaticElements.clear(),this.energyBurstState={burstIntensity:0,burstFrequency:.5,colorTemperature:2500,interferenceLevel:0,scanlineVelocity:1,holographicDepth:0,musicTension:0,energyStability:1},this.initialized=!1}getEnergyBurstState(){return{...this.energyBurstState}}getCinematicConfig(){return{...this.cinematicConfig}}getPerformanceMetrics(){return{...this.performanceMetrics}}setRedEnergyThreshold(e){this.cinematicConfig.energyActivationThreshold=Math.max(0,Math.min(1,e))}setBladeRunnerMode(e){this.cinematicConfig.bladeRunnerMode=e,e&&console.log("[RedEnergyBurstSystem] \u{1F3AC} Blade Runner mode activated")}}});var Bt,Ls=b(()=>{"use strict";D();K();Bt=class{constructor(e,t,i){this.initialized=!1;this.etherealElements=new Map;this.performanceMetrics={emotionalMomentCount:0,averageProcessingTime:0,lastUpdateTime:0,gentleTransitionCount:0};this.animationState={mysticalPhase:0,dreamyPhase:0,flowingPhase:0,emotionalPulsePhase:0,lastFrameTime:0,isAnimating:!1};this.lerpHalfLifeValues={glowIntensity:.25,effectLevel:.35,shimmerEffect:.2};this.etherealPalettes={"dreamy-pastels":{primaryGlow:{r:203,g:166,b:247},shimmerColor:{r:148,g:226,b:213},mistBackground:{r:245,g:224,b:220},coreColor:{r:249,g:226,b:175},accentColor:{r:180,g:190,b:254}},"mystical-moonlight":{primaryGlow:{r:137,g:180,b:250},shimmerColor:{r:166,g:227,b:161},mistBackground:{r:205,g:214,b:244},coreColor:{r:243,g:139,b:168},accentColor:{r:137,g:220,b:235}},"gentle-aurora":{primaryGlow:{r:166,g:227,b:161},shimmerColor:{r:137,g:220,b:235},mistBackground:{r:186,g:194,b:222},coreColor:{r:250,g:179,b:135},accentColor:{r:203,g:166,b:247}}};this.holographicSystem=e,this.cssConsciousnessController=t,this.musicSyncService=i,this.glowState={glowIntensity:0,effectLevel:0,softness:.8,shimmerEffect:0,transparency:.9,gradientPhase:0,musicResponse:0,smoothnessFactor:1,targetGlowIntensity:0,targetEffectLevel:0,targetShimmerEffect:0},this.glowConfig={musicThreshold:.6,maxGlowIntensity:.8,transitionDuration:2e3,particleCount:15,blurRadius:8,gradientSpeed:.3}}async initialize(){if(!this.initialized)try{console.log("[SoftGlowEffectsManager] Awakening ethereal beauty consciousness..."),this.subscribeToEmotionalConsciousness(),await this.initializeGlowElements(),this.setupGlowCSSVariables(),this.startEtherealAnimation(),this.initialized=!0,console.log("[SoftGlowEffectsManager] \u2728 Ready for mystical emotional moments")}catch(e){throw console.error("[SoftGlowEffectsManager] Failed to initialize:",e),e}}updateAnimation(e){if(!this.initialized)return;let t=e/1e3;this.animationState.mysticalPhase+=t*.5,this.animationState.dreamyPhase+=t*.3,this.animationState.flowingPhase+=t*this.glowConfig.gradientSpeed,this.animationState.emotionalPulsePhase+=t*.8,this.updateEtherealFromMusic(),this.updateEtherealStateWithLERP(t),this.updateMysticalEffects(),this.updateGlowElements(),this.updatePerformanceMetrics(e)}async healthCheck(){let e=this.initialized&&this.glowState.effectLevel>=0&&this.performanceMetrics.averageProcessingTime<8;return{system:"SoftGlowEffectsManager",healthy:e,metrics:{emotionalMomentCount:this.performanceMetrics.emotionalMomentCount,processingTime:this.performanceMetrics.averageProcessingTime,etherealElementCount:this.etherealElements.size,gentleTransitionCount:this.performanceMetrics.gentleTransitionCount},issues:e?[]:["Performance degradation detected"]}}subscribeToEmotionalConsciousness(){p.subscribe("emotionalColorContext:updated",e=>{this.onColorConsciousnessUpdate(e)}),p.subscribe("emotion:analyzed",e=>{this.onEmotionalMoment(e)}),p.subscribe("settings:visual-guide-changed",e=>{this.onGentleTransition(e)})}onColorConsciousnessUpdate(e){let{palette:t,consciousnessLevel:i,emotionalTemperature:n}=e;this.glowState.musicResponse=i*.9,n>5e3?this.glowState.effectLevel=Math.min(.8,i*1.2):this.glowState.shimmerEffect=i*.7;let r=this.generateGlowColors(t,n);this.updateGlowColors(r)}onEmotionalMoment(e){let{type:t,intensity:i,valence:n}=e;n>this.glowConfig.musicThreshold&&this.triggerEtherealBeauty(i,n)}onGentleTransition(e){let{fromState:t,toState:i,duration:n}=e;this.createGentleTransition(t,i,n),this.performanceMetrics.gentleTransitionCount++}triggerEtherealBeauty(e,t){let i=performance.now();this.glowState.transparency=.8+t*.2,this.glowState.targetGlowIntensity=Math.max(this.glowState.targetGlowIntensity,e*.8),this.glowState.targetEffectLevel=Math.max(this.glowState.targetEffectLevel,t*.9),this.glowState.targetShimmerEffect=Math.max(this.glowState.targetShimmerEffect,t*.6),this.performanceMetrics.emotionalMomentCount++,this.performanceMetrics.lastUpdateTime=performance.now()-i,console.log(`[SoftGlowEffectsManager] \u2728 Ethereal beauty awakened! Intensity: ${e.toFixed(2)}, Valence: ${t.toFixed(2)}`)}updateEtherealStateWithLERP(e){this.glowState.glowIntensity=H(this.glowState.glowIntensity,this.glowState.targetGlowIntensity,e,this.lerpHalfLifeValues.glowIntensity),this.glowState.effectLevel=H(this.glowState.effectLevel,this.glowState.targetEffectLevel,e,this.lerpHalfLifeValues.effectLevel),this.glowState.shimmerEffect=H(this.glowState.shimmerEffect,this.glowState.targetShimmerEffect,e,this.lerpHalfLifeValues.shimmerEffect);let t=1.5;this.glowState.targetGlowIntensity=H(this.glowState.targetGlowIntensity,0,e,t),this.glowState.targetEffectLevel=H(this.glowState.targetEffectLevel,0,e,t*1.2),this.glowState.targetShimmerEffect=H(this.glowState.targetShimmerEffect,0,e,t*.8)}updateEtherealFromMusic(){let e=this.musicSyncService.getCurrentMusicState();if(!e)return;let{emotion:t,beat:i,intensity:n}=e;if(t&&t.valence>.5&&(this.glowState.shimmerEffect=Math.max(this.glowState.shimmerEffect,t.valence*n*.5),i&&i.tempo)){let r=Math.min(1.5,i.tempo/100);this.glowConfig.gradientSpeed=.3*r}}updateMysticalEffects(){let e=this.etherealPalettes["dreamy-pastels"],t={primaryGlow:this.blendSoftColors(e.primaryGlow,e.shimmerColor,this.glowState.shimmerEffect),shimmerColor:e.shimmerColor,mistBackground:e.mistBackground,coreColor:e.coreColor,accentColor:e.accentColor,transparency:this.glowState.transparency};this.updateGlowCSSVariables(t)}blendSoftColors(e,t,i){let n=Math.max(0,Math.min(1,i));return{r:Math.round(e.r*(1-n)+t.r*n),g:Math.round(e.g*(1-n)+t.g*n),b:Math.round(e.b*(1-n)+t.b*n)}}generateGlowColors(e,t){let i=this.etherealPalettes["dreamy-pastels"];return t<4e3?i=this.etherealPalettes["mystical-moonlight"]:t>7e3&&(i=this.etherealPalettes["gentle-aurora"]),{primaryGlow:i.primaryGlow,shimmerColor:i.shimmerColor,mistBackground:i.mistBackground,coreColor:i.coreColor,accentColor:i.accentColor,transparency:this.glowState.transparency}}updateGlowColors(e){this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-soft-r",e.primaryGlow.r.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-soft-g",e.primaryGlow.g.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-soft-b",e.primaryGlow.b.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-mystical-r",e.shimmerColor.r.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-mystical-g",e.shimmerColor.g.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-mystical-b",e.shimmerColor.b.toString())}async initializeGlowElements(){let e=[".main-view-container",".Root__now-playing-bar",".main-trackInfo-container",".cover-art",".player-controls"];for(let t of e){let i=document.querySelectorAll(t);for(let n of i){let r=`ethereal-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;this.etherealElements.set(r,n)}}}setupGlowCSSVariables(){let e={"--ethereal-soft-r":"203","--ethereal-soft-g":"166","--ethereal-soft-b":"247","--ethereal-mystical-r":"148","--ethereal-mystical-g":"226","--ethereal-mystical-b":"213","--ethereal-dreamy-r":"245","--ethereal-dreamy-g":"224","--ethereal-dreamy-b":"220","--ethereal-beauty-level":"0","--ethereal-mystical-shimmer":"0","--ethereal-gentle-transparency":"0.9","--ethereal-flowing-phase":"0","--ethereal-emotional-pulse":"0"};for(let[t,i]of Object.entries(e))this.cssConsciousnessController.queueCSSVariableUpdate(t,i)}updateGlowCSSVariables(e){this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-beauty-level",this.glowState.effectLevel.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-mystical-shimmer",this.glowState.shimmerEffect.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-gentle-transparency",e.transparency.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-flowing-phase",this.animationState.flowingPhase.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-emotional-pulse",Math.sin(this.animationState.emotionalPulsePhase).toString())}updateGlowElements(){for(let[e,t]of this.etherealElements)this.updateEtherealElement(t)}updateEtherealElement(e){this.glowState.effectLevel>.1&&this.applyEtherealBeauty(e),this.glowState.shimmerEffect>.1&&this.applyMysticalShimmer(e),this.applyFlowingGradients(e)}applyEtherealBeauty(e){let t=this.glowState.effectLevel,i=Math.sin(this.animationState.emotionalPulsePhase)*.5+.5,n=t*i*.6;e.style.boxShadow=`
      0 0 ${n*30}px rgba(var(--ethereal-soft-r), var(--ethereal-soft-g), var(--ethereal-soft-b), ${n*.6}),
      inset 0 0 ${n*20}px rgba(var(--ethereal-mystical-r), var(--ethereal-mystical-g), var(--ethereal-mystical-b), ${n*.3})
    `;let r=.9+t*.1;e.style.opacity=r.toString()}applyMysticalShimmer(e){let t=this.glowState.shimmerEffect,i=this.animationState.mysticalPhase,n=Math.sin(i*2)*t*2,r=1+Math.cos(i*1.5)*t*.05;e.style.transform=`translate(${n}px, 0) scale(${r})`;let a=Math.sin(i*.8)*t*15;e.style.filter=`hue-rotate(${a}deg) saturate(${1+t*.3})`}applyFlowingGradients(e){let t=this.animationState.flowingPhase,i=this.glowState.effectLevel*.8;if(i>.1){let n=(Math.sin(t)+1)*50;e.style.background=`
        ${e.style.background||""},
        linear-gradient(
          ${n}deg,
          rgba(var(--ethereal-soft-r), var(--ethereal-soft-g), var(--ethereal-soft-b), ${i*.1}) 0%,
          rgba(var(--ethereal-mystical-r), var(--ethereal-mystical-g), var(--ethereal-mystical-b), ${i*.15}) 50%,
          rgba(var(--ethereal-dreamy-r), var(--ethereal-dreamy-g), var(--ethereal-dreamy-b), ${i*.05}) 100%
        )
      `}}createGentleTransition(e,t,i){let n=performance.now(),r=a=>{let s=a-n,o=Math.min(1,s/i),l=1-Math.pow(1-o,3);this.glowState.effectLevel=e.beauty+(t.beauty-e.beauty)*l,this.glowState.shimmerEffect=e.shimmer+(t.shimmer-e.shimmer)*l,o<1&&requestAnimationFrame(r)};requestAnimationFrame(r)}startEtherealAnimation(){this.animationState.isAnimating=!0,this.animationState.lastFrameTime=performance.now();let e=t=>{if(!this.animationState.isAnimating)return;let i=t-this.animationState.lastFrameTime;this.animationState.lastFrameTime=t,this.updateAnimation(i),requestAnimationFrame(e)};requestAnimationFrame(e)}updatePerformanceMetrics(e){this.performanceMetrics.averageProcessingTime=this.performanceMetrics.averageProcessingTime*.9+e*.1}forceRepaint(e){console.log(`[SoftGlowEffectsManager] Force repaint triggered: ${e||"Unknown"}`),this.updateGlowElements(),this.cssConsciousnessController.flushCSSVariableBatch()}destroy(){console.log("[SoftGlowEffectsManager] Dissolving ethereal beauty..."),this.animationState.isAnimating=!1,this.etherealElements.clear(),this.glowState={glowIntensity:0,effectLevel:0,softness:.8,shimmerEffect:0,transparency:.9,gradientPhase:0,musicResponse:0,smoothnessFactor:1,targetGlowIntensity:0,targetEffectLevel:0,targetShimmerEffect:0},this.initialized=!1}getGlowState(){return{...this.glowState}}getGlowConfig(){return{...this.glowConfig}}getPerformanceMetrics(){return{...this.performanceMetrics,etherealElementCount:this.etherealElements.size}}setEmotionalThreshold(e){this.glowConfig.musicThreshold=Math.max(0,Math.min(1,e))}setMaxBeautyIntensity(e){this.glowConfig.maxGlowIntensity=Math.max(0,Math.min(1,e))}setGentleness(e){this.glowState.softness=Math.max(0,Math.min(1,e))}}});var Ui,Bs=b(()=>{"use strict";D();Ui=class{constructor(e,t,i){this.initialized=!1;this.naturalElements=new Map;this.performanceMetrics={peacefulMomentCount:0,averageProcessingTime:0,lastUpdateTime:0,breathingCycleCount:0};this.animationState={breathingPhase:0,seasonalPhase:0,variationPhase:0,harmonyPhase:0,lastFrameTime:0,isAnimating:!1};this.naturalPalettes={"spring-awakening":{earthyWarm:{r:166,g:227,b:161},forestGreen:{r:64,g:160,b:43},skyBlue:{r:137,g:220,b:235},sunsetGlow:{r:250,g:179,b:135},stoneGray:{r:108,g:112,b:134}},"summer-warmth":{earthyWarm:{r:249,g:226,b:175},forestGreen:{r:166,g:227,b:161},skyBlue:{r:116,g:199,b:236},sunsetGlow:{r:250,g:179,b:135},stoneGray:{r:147,g:153,b:178}},"autumn-grounding":{earthyWarm:{r:250,g:179,b:135},forestGreen:{r:148,g:226,b:213},skyBlue:{r:137,g:180,b:250},sunsetGlow:{r:235,g:160,b:172},stoneGray:{r:127,g:132,b:156}},"winter-peace":{earthyWarm:{r:186,g:194,b:222},forestGreen:{r:148,g:226,b:213},skyBlue:{r:137,g:220,b:235},sunsetGlow:{r:203,g:166,b:247},stoneGray:{r:88,g:91,b:112}}};this.holographicSystem=e,this.cssController=t,this.musicSyncService=i,this.breathingState={breathingIntensity:0,breathingFrequency:.4,breathingDepth:.8,grounding:0,warmth:.7,ambientLevel:0,colorShift:0,harmonyLevel:0},this.harmonyConfig={calmThreshold:.3,maxBreathingDepth:.9,frequencyRange:[.2,.8],colorStrength:.6,transitionDuration:3e3,cycleSpeed:.1}}injectServices(e){this.services=e}getRequiredServices(){return[]}getOptionalServices(){return["cssVariables","events","performance"]}async initialize(){if(!this.initialized)try{console.log("[BreathingEffectsController] Initializing breathing effects..."),this.subscribeToColorEvents(),await this.initializeBreathingElements(),this.setupBreathingCSSVariables(),this.startBreathingAnimation(),this.initialized=!0,console.log("[BreathingEffectsController] \u{1F33F} Breathing effects system ready")}catch(e){throw console.error("[BreathingEffectsController] Failed to initialize:",e),e}}updateAnimation(e){if(!this.initialized)return;let t=e/1e3;this.animationState.breathingPhase+=t*this.breathingState.breathingFrequency*2*Math.PI,this.animationState.seasonalPhase+=t*this.harmonyConfig.cycleSpeed,this.animationState.variationPhase+=t*.4,this.animationState.harmonyPhase+=t*.6,this.updateNaturalFromMusic(),this.updateBreathingVisuals(),this.updateBreathingElements(),this.updatePerformanceMetrics(e)}async healthCheck(){let e=this.initialized&&this.breathingState.breathingIntensity>=0&&this.performanceMetrics.averageProcessingTime<10;return{system:"NaturalHarmonyEngine",healthy:e,metrics:{peacefulMomentCount:this.performanceMetrics.peacefulMomentCount,processingTime:this.performanceMetrics.averageProcessingTime,naturalElementCount:this.naturalElements.size,breathingCycleCount:this.performanceMetrics.breathingCycleCount},issues:e?[]:["Performance degradation detected"]}}subscribeToColorEvents(){this.services?.events?(this.services.events.subscribe("BreathingEffectsController","emotionalColorContext:updated",this.onColorUpdate.bind(this)),this.services.events.subscribe("BreathingEffectsController","emotion:analyzed",this.onPeacefulMoment.bind(this)),this.services.events.subscribe("BreathingEffectsController","settings:visual-guide-changed",this.onVisualTransition.bind(this))):(p.subscribe("emotionalColorContext:updated",e=>{this.onColorUpdate(e)}),p.subscribe("emotion:analyzed",e=>{this.onPeacefulMoment(e)}),p.subscribe("settings:visual-guide-changed",e=>{this.onVisualTransition(e)}))}onColorUpdate(e){let{palette:t,effectsLevel:i,emotionalTemperature:n}=e;this.breathingState.harmonyLevel=i*.8,n<5e3?(this.breathingState.grounding=i*.6,this.breathingState.ambientLevel=i*.4):(this.breathingState.warmth=i*.8,this.breathingState.colorShift=i*.5);let r=this.generateBreathingColors(t,n);this.updateNaturalColors(r)}onPeacefulMoment(e){let{type:t,intensity:i,serenity:n}=e;this.triggerNaturalBreathing(i,n)}onVisualTransition(e){let{fromSeason:t,toSeason:i,duration:n}=e;this.createSeasonalTransition(t,i,n),this.performanceMetrics.breathingCycleCount++}triggerNaturalBreathing(e,t){(this.services?.performance?(n,r)=>this.services.performance.trackOperation("BreathingEffectsController",n,r):(n,r)=>r())("triggerNaturalBreathing",()=>{this.breathingState.breathingIntensity=t,this.breathingState.grounding=t*.7,this.breathingState.ambientLevel=t*.6,this.breathingState.warmth=.6+t*.3;let n=this.harmonyConfig.frequencyRange;this.breathingState.breathingFrequency=n[0]+t*(n[1]-n[0]),setTimeout(()=>{this.gentleDecayNaturalBreathing()},this.harmonyConfig.transitionDuration),this.performanceMetrics.peacefulMomentCount++,console.log(`[BreathingEffectsController] \u{1F33F} Breathing effects activated! Serenity: ${t.toFixed(2)}, Frequency: ${this.breathingState.breathingFrequency.toFixed(2)}Hz`)})}gentleDecayNaturalBreathing(){let t=()=>{this.breathingState.breathingIntensity*=.985,this.breathingState.grounding*=.988,this.breathingState.ambientLevel*=.991,this.breathingState.breathingIntensity>.05?requestAnimationFrame(t):(this.breathingState.breathingIntensity=0,this.breathingState.grounding=0,this.breathingState.ambientLevel=0)};requestAnimationFrame(t)}updateNaturalFromMusic(){let e=this.musicSyncService.getCurrentMusicState();if(!e)return;let{emotion:t,beat:i,intensity:n}=e;if(t&&n<this.harmonyConfig.calmThreshold&&(this.breathingState.ambientLevel=Math.max(this.breathingState.ambientLevel,(1-n)*.6),i&&i.tempo)){let r=Math.max(.5,Math.min(1.2,60/i.tempo));this.breathingState.breathingFrequency=.4*r}}updateBreathingVisuals(){let e=this.getCurrentSeason(),t=this.naturalPalettes[e],i={warmTone:this.blendBreathingColors(t.earthyWarm,t.sunsetGlow,this.breathingState.warmth),coolTone:t.forestGreen,accentBlue:t.skyBlue,highlightGlow:t.sunsetGlow,neutralGray:t.stoneGray,transparency:.85+this.breathingState.breathingIntensity*.15};this.updateNaturalCSSVariables(i)}getCurrentSeason(){let t=this.animationState.seasonalPhase%(2*Math.PI)/(2*Math.PI);return t<.25?"spring-awakening":t<.5?"summer-warmth":t<.75?"autumn-grounding":"winter-peace"}blendBreathingColors(e,t,i){let n=Math.max(0,Math.min(1,i));return{r:Math.round(e.r*(1-n)+t.r*n),g:Math.round(e.g*(1-n)+t.g*n),b:Math.round(e.b*(1-n)+t.b*n)}}generateBreathingColors(e,t){let i=this.naturalPalettes["spring-awakening"];return t<4e3?i=this.naturalPalettes["winter-peace"]:t>7e3?i=this.naturalPalettes["summer-warmth"]:t>5500&&(i=this.naturalPalettes["autumn-grounding"]),{warmTone:i.earthyWarm,coolTone:i.forestGreen,accentBlue:i.skyBlue,highlightGlow:i.sunsetGlow,neutralGray:i.stoneGray,transparency:this.breathingState.harmonyLevel}}updateNaturalColors(e){this.services?.cssVariables?this.services.cssVariables.queueBatchUpdate({"--sn-breathing-warm-r":e.warmTone.r.toString(),"--sn-breathing-warm-g":e.warmTone.g.toString(),"--sn-breathing-warm-b":e.warmTone.b.toString(),"--sn-breathing-cool-r":e.coolTone.r.toString(),"--sn-breathing-cool-g":e.coolTone.g.toString(),"--sn-breathing-cool-b":e.coolTone.b.toString()}):(this.cssController.queueCSSVariableUpdate("--sn-breathing-warm-r",e.warmTone.r.toString()),this.cssController.queueCSSVariableUpdate("--sn-breathing-warm-g",e.warmTone.g.toString()),this.cssController.queueCSSVariableUpdate("--sn-breathing-warm-b",e.warmTone.b.toString()),this.cssController.queueCSSVariableUpdate("--sn-breathing-cool-r",e.coolTone.r.toString()),this.cssController.queueCSSVariableUpdate("--sn-breathing-cool-g",e.coolTone.g.toString()),this.cssController.queueCSSVariableUpdate("--sn-breathing-cool-b",e.coolTone.b.toString()))}async initializeBreathingElements(){let e=[".main-view-container",".Root__now-playing-bar",".main-trackInfo-container",".progress-bar",".Root__nav-bar"];for(let t of e){let i=document.querySelectorAll(t);for(let n of i){let r=`natural-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;this.naturalElements.set(r,n)}}}setupBreathingCSSVariables(){let e={"--sn-breathing-earthy-r":"166","--sn-breathing-earthy-g":"227","--sn-breathing-earthy-b":"161","--sn-breathing-forest-r":"64","--sn-breathing-forest-g":"160","--sn-breathing-forest-b":"43","--sn-breathing-sky-r":"137","--sn-breathing-sky-g":"220","--sn-breathing-sky-b":"235","--sn-breathing-serenity-level":"0","--sn-breathing-breathing-frequency":"0.4","--sn-breathing-earth-connection":"0","--sn-breathing-breathing-depth":"0.8","--sn-breathing-seasonal-shift":"0"};if(this.services?.cssVariables)this.services.cssVariables.queueBatchUpdate(e);else for(let[t,i]of Object.entries(e))this.cssController.queueCSSVariableUpdate(t,i)}updateNaturalCSSVariables(e){let t=Math.sin(this.animationState.breathingPhase)*this.breathingState.breathingDepth,i={"--sn-breathing-breathing-intensity":this.breathingState.breathingIntensity.toString(),"--sn-breathing-breathing-frequency":this.breathingState.breathingFrequency.toString(),"--sn-breathing-grounding":this.breathingState.grounding.toString(),"--sn-breathing-breathing-depth":this.breathingState.breathingDepth.toString(),"--sn-breathing-color-shift":this.breathingState.colorShift.toString(),"--sn-breathing-breathing-phase":t.toString()};this.services?.cssVariables?this.services.cssVariables.queueBatchUpdate(i):Object.entries(i).forEach(([n,r])=>{this.cssController.queueCSSVariableUpdate(n,r)})}updateBreathingElements(){for(let[e,t]of this.naturalElements)this.updateNaturalElement(t)}updateNaturalElement(e){this.breathingState.breathingIntensity>.1&&this.applyNaturalBreathing(e),this.breathingState.grounding>.1&&this.applyEarthConnection(e),this.breathingState.ambientLevel>.1&&this.applyForestAtmosphere(e)}applyNaturalBreathing(e){let t=this.breathingState.breathingIntensity,i=Math.sin(this.animationState.breathingPhase),n=1+i*t*.02,r=.9+i*t*.1;e.style.transform=`scale(${n})`,e.style.opacity=r.toString();let a=t*(i*.5+.5)*.3;e.style.boxShadow=`
      0 0 ${a*20}px rgba(var(--sn-breathing-earthy-r), var(--sn-breathing-earthy-g), var(--sn-breathing-earthy-b), ${a*.5}),
      inset 0 0 ${a*10}px rgba(var(--sn-breathing-forest-r), var(--sn-breathing-forest-g), var(--sn-breathing-forest-b), ${a*.3})
    `}applyEarthConnection(e){let t=this.breathingState.grounding;e.style.border=`1px solid rgba(var(--sn-breathing-earthy-r), var(--sn-breathing-earthy-g), var(--sn-breathing-earthy-b), ${t*.4})`,e.style.background=`
      ${e.style.background||""},
      linear-gradient(180deg,
        rgba(var(--sn-breathing-earthy-r), var(--sn-breathing-earthy-g), var(--sn-breathing-earthy-b), ${t*.05}) 0%,
        rgba(var(--sn-breathing-forest-r), var(--sn-breathing-forest-g), var(--sn-breathing-forest-b), ${t*.08}) 100%
      )
    `}applyForestAtmosphere(e){let t=this.breathingState.ambientLevel,i=this.animationState.variationPhase,n=Math.sin(i*.8)*t*1;e.style.transform+=` translateY(${n}px)`;let r=Math.sin(i*.5)*t*5;e.style.filter=`hue-rotate(${r}deg) saturate(${1+t*.2})`}createSeasonalTransition(e,t,i){let n=performance.now(),r=a=>{let s=a-n,o=Math.min(1,s/i),l=.5*(1-Math.cos(o*Math.PI));this.breathingState.colorShift=l,o<1&&requestAnimationFrame(r)};requestAnimationFrame(r)}startBreathingAnimation(){this.animationState.isAnimating=!0,this.animationState.lastFrameTime=performance.now();let e=t=>{if(!this.animationState.isAnimating)return;let i=t-this.animationState.lastFrameTime;this.animationState.lastFrameTime=t,this.updateAnimation(i),requestAnimationFrame(e)};requestAnimationFrame(e)}updatePerformanceMetrics(e){this.performanceMetrics.averageProcessingTime=this.performanceMetrics.averageProcessingTime*.9+e*.1}forceRepaint(e){console.log(`[BreathingEffectsController] Force repaint triggered: ${e||"Unknown"}`),this.updateBreathingElements(),this.services?.cssVariables?this.services.cssVariables.flushUpdates():this.cssController.flushCSSVariableBatch()}destroy(){console.log("[BreathingEffectsController] Shutting down breathing effects system..."),this.services?.events&&this.services.events.cleanupSystem("BreathingEffectsController"),this.animationState.isAnimating=!1,this.naturalElements.clear(),this.breathingState={breathingIntensity:0,breathingFrequency:.4,breathingDepth:.8,grounding:0,warmth:.7,ambientLevel:0,colorShift:0,harmonyLevel:0},this.initialized=!1}getBreathingState(){return{...this.breathingState}}getBreathingConfig(){return{...this.harmonyConfig}}getPerformanceMetrics(){return{...this.performanceMetrics,naturalElementCount:this.naturalElements.size}}setCalmThreshold(e){this.harmonyConfig.calmThreshold=Math.max(0,Math.min(1,e))}setBreathingDepth(e){this.breathingState.breathingDepth=Math.max(0,Math.min(1,e))}setColorStrength(e){this.harmonyConfig.colorStrength=Math.max(0,Math.min(1,e))}}});var Ft,Fs=b(()=>{"use strict";hs();ue();R();gs();vs();Cs();Ms();ws();pr();xs();As();Is();Rs();ks();Ds();Ls();Bs();Ft=class{constructor(e,t,i,n,r,a,s,o,l,m){this.systemName="VisualSystemCoordinator";this.initialized=!1;this.colorHarmonyEngine=null;this.eventBus=null;this.animationCoordinator=null;this.isInitialized=!1;this.lastHealthCheck=null;this.boundAdaptationHandler=null;this.boundSettingsHandler=null;this.healthCheckInterval=null;this.metricsUpdateInterval=null;this.onSystemAdaptation=null;this.onHealthChange=null;this.onSystemCreated=null;this.config=e,this.utils=t,this.year3000System=i,this.cssVariableController=n,this.performanceAnalyzer=r,this.musicSyncService=a,this.settingsManager=s,this.colorHarmonyEngine=o||null,this.eventBus=l||null,this.animationCoordinator=m||null,this.deviceDetector=new N,this.systemRegistry=new Map,this.systemCache=new Map,this.systemDependencies=new Map,this.bridgeConfig={mode:"progressive",enablePerformanceMonitoring:!0,enableAdaptiveQuality:!0,enableEventCoordination:!0,performanceThresholds:{minFPS:45,maxMemoryMB:50,thermalLimit:70},qualityPreferences:{preferHighQuality:!0,allowDynamicScaling:!0,batteryConservation:!1}},this.currentMetrics=this.createInitialMetrics(),this.boundAdaptationHandler=this.handleAdaptationEvent.bind(this),this.boundSettingsHandler=this.handleSettingsChange.bind(this),this.registerVisualSystems(),u?.debug?.log("VisualSystemFacade","Factory facade initialized with visual systems")}registerVisualSystems(){this.systemRegistry.set("SidebarVisualEffects",ht),this.systemDependencies.set("SidebarVisualEffects",["eventBus","musicSyncService"]),this.systemRegistry.set("UIVisualEffects",Bi),this.systemDependencies.set("UIVisualEffects",["eventBus","musicSyncService","cssVariableController"]),this.systemRegistry.set("HeaderVisualEffects",Fi),this.systemDependencies.set("HeaderVisualEffects",["eventBus","musicSyncService","colorHarmonyEngine"]),this.systemRegistry.set("WebGLBackground",Dt),this.systemDependencies.set("WebGLBackground",["performanceAnalyzer","eventBus"]),this.systemRegistry.set("CSSBlobFallback",Li),this.systemDependencies.set("CSSBlobFallback",["performanceAnalyzer","musicSyncService","settingsManager"]),this.systemRegistry.set("MusicBeatSync",Gi),this.systemDependencies.set("MusicBeatSync",["performanceAnalyzer","cssVariableController","eventBus","musicSyncService","colorHarmonyEngine"]),this.systemRegistry.set("InteractionTracking",Hi),this.systemDependencies.set("InteractionTracking",["performanceAnalyzer","cssVariableController"]),this.systemRegistry.set("SpotifyUIApplication",zi),this.systemDependencies.set("SpotifyUIApplication",["year3000System"]),this.systemRegistry.set("CinematicDrama",Oi),this.systemDependencies.set("CinematicDrama",["performanceAnalyzer","cssVariableController","musicSyncService","colorHarmonyEngine","eventBus"]),this.systemRegistry.set("EtherealBeauty",Bt),this.systemDependencies.set("EtherealBeauty",["performanceAnalyzer","cssVariableController","musicSyncService","colorHarmonyEngine","eventBus"]),this.systemRegistry.set("NaturalHarmony",Ui),this.systemDependencies.set("NaturalHarmony",["performanceAnalyzer","cssVariableController","musicSyncService","colorHarmonyEngine","eventBus"]),this.systemRegistry.set("GradientConductor",Lt),this.systemDependencies.set("GradientConductor",["cssVariableController","colorHarmonyEngine","musicSyncService","performanceAnalyzer","eventBus"]),this.systemRegistry.set("CSSAnimationManager",ki),this.systemDependencies.set("CSSAnimationManager",["cssVariableController","animationCoordinator"]),this.systemRegistry.set("GlowEffects",Bt),this.systemDependencies.set("GlowEffects",["performanceAnalyzer","cssVariableController","musicSyncService","colorHarmonyEngine","eventBus"]),this.systemRegistry.set("UnifiedParticle",ht),this.systemDependencies.set("UnifiedParticle",["eventBus","musicSyncService"]),this.systemRegistry.set("DepthLayeredGradient",Lt),this.systemDependencies.set("DepthLayeredGradient",["cssVariableController","colorHarmonyEngine","musicSyncService","performanceAnalyzer","eventBus"]),this.systemRegistry.set("FluidGradientBackground",Dt),this.systemDependencies.set("FluidGradientBackground",["performanceAnalyzer","eventBus"])}async initialize(e){if(this.isInitialized){u?.debug?.warn("VisualSystemFacade","Already initialized");return}try{this.bridgeConfig={...this.bridgeConfig,...e},await this.deviceDetector.initialize(),await this.applyConfiguration(),this.subscribeToEvents(),this.startMonitoring(),await this.performVisualHealthCheck(),this.isInitialized=!0,this.initialized=!0,this.cssVariableController.queueCSSVariableUpdate("--sn-visual-bridge-active","1"),this.cssVariableController.queueCSSVariableUpdate("--sn-visual-bridge-mode",this.bridgeConfig.mode),u?.debug?.log("VisualSystemFacade","Facade fully initialized",{mode:this.bridgeConfig.mode,systemsRegistered:this.systemRegistry.size,performanceMonitoring:this.bridgeConfig.enablePerformanceMonitoring})}catch(t){throw u?.debug?.error("VisualSystemFacade","Initialization failed:",t),await this.cleanup(),t}}getVisualSystem(e){if(this.systemCache.has(e))return this.systemCache.get(e);let t=this.createVisualSystem(e);return this.systemCache.set(e,t),this.currentMetrics.activeVisualSystems.push(e),this.onSystemCreated&&this.onSystemCreated(e,t),t}createVisualSystem(e){let t=this.systemRegistry.get(e);if(!t)throw new Error(`Visual system '${e}' not found in registry`);let i=new t(this.config);if(typeof i._baseInitialize=="function"){let r=i;return this.injectUnifiedSystemDependencies(r,e),r}if(e==="SpotifyUIApplication"){let r=new t(this.year3000System);return this.injectDependencies(r,e),r}if(e==="GradientConductor"){let r=new t(this.eventBus,this.cssVariableController,this.colorHarmonyEngine,this.musicSyncService,this.performanceAnalyzer,{});return this.injectDependencies(r,e),r}if(e==="CSSAnimationManager"){let r=new t(this.config,this.cssVariableController,this.animationCoordinator);return this.injectDependencies(r,e),r}if(e==="CinematicDrama"||e==="EtherealBeauty"||e==="NaturalHarmony"){let r=new Di,a=new Vi(r,this.settingsManager,this.musicSyncService),s=new t(a,this.cssVariableController,this.musicSyncService);return this.injectDependencies(s,e),s}let n=new t(this.config,this.utils,this.performanceAnalyzer,this.musicSyncService,this.settingsManager,this.year3000System);return this.injectDependencies(n,e),n}injectDependencies(e,t){let i=this.systemDependencies.get(t)||[];i.includes("performanceAnalyzer")&&e.setPerformanceAnalyzer&&e.setPerformanceAnalyzer(this.performanceAnalyzer),i.includes("cssVariableController")&&e.setOptimizedCSSVariableManager&&e.setOptimizedCSSVariableManager(this.cssVariableController),i.includes("eventBus")&&this.eventBus&&e.setEventBus&&e.setEventBus(this.eventBus),this.colorHarmonyEngine&&e.setColorHarmonyEngine&&e.setColorHarmonyEngine(this.colorHarmonyEngine),i.includes("musicSyncService")&&e.setMusicSyncService&&e.setMusicSyncService(this.musicSyncService),i.includes("animationCoordinator")&&this.animationCoordinator&&e.setAnimationCoordinator&&e.setAnimationCoordinator(this.animationCoordinator),this.integratePerformanceMonitoring(e,t)}injectUnifiedSystemDependencies(e,t){this.cssVariableController&&(e.cssVariableController=this.cssVariableController),this.performanceAnalyzer&&(e.performanceAnalyzer=this.performanceAnalyzer),this.year3000System&&(globalThis.year3000System=this.year3000System),this.integratePerformanceMonitoring(e,t)}integratePerformanceMonitoring(e,t){if(!this.bridgeConfig.enablePerformanceMonitoring)return;let i=e.updateAnimation;typeof i=="function"&&(e.updateAnimation=r=>{let a=performance.now();i.call(e,r);let s=performance.now();this.performanceAnalyzer.recordMetric(`Visual_${t}`,s-a)});let n=e.onAnimate;typeof n=="function"&&(e.onAnimate=r=>{let a=performance.now();n.call(e,r);let s=performance.now();this.performanceAnalyzer.recordMetric(`Visual_${t}_Animate`,s-a)})}adaptiveQualityControl(e,t){this.eventBus&&(this.eventBus.subscribe("performance:degradation",i=>{e.reduceQuality&&e.reduceQuality(i.reductionLevel)}),this.eventBus.subscribe("performance:improvement",i=>{e.increaseQuality&&e.increaseQuality(i.improvementLevel)}))}handleAdaptationEvent(e){u?.debug?.log("VisualSystemFacade",`Adaptation event: ${e.type}`,e.reason),this.currentMetrics.currentQuality=e.newSettings,this.systemCache.forEach((t,i)=>{t.handleAdaptationEvent&&t.handleAdaptationEvent(e)}),this.onSystemAdaptation&&this.onSystemAdaptation(this.currentMetrics),this.cssVariableController.queueCSSVariableUpdate("--sn-adaptive-quality",(e.newSettings.gradientComplexity||0).toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-adaptive-fps",(e.newSettings.animationFPS||60).toString())}propagateVisualEvent(e){this.bridgeConfig.enableEventCoordination&&(this.systemCache.forEach((t,i)=>{if(t.handleVisualEvent)try{t.handleVisualEvent(e)}catch(n){u?.debug?.warn("VisualSystemFacade",`Error propagating event to ${i}:`,n)}}),this.currentMetrics.eventCount++,this.currentMetrics.lastEventTime=performance.now())}async initializeVisualSystems(){let e=Array.from(this.systemCache.entries()).map(async([n,r])=>{try{return typeof r._baseInitialize=="function"?await r._baseInitialize():await r.initialize(),u?.debug?.log("VisualSystemFacade",`Initialized visual system: ${n}`),{key:n,success:!0}}catch(a){return u?.debug?.error("VisualSystemFacade",`Failed to initialize ${n}:`,a),{key:n,success:!1,error:a}}}),t=await Promise.allSettled(e),i=t.filter(n=>n.status==="fulfilled"&&n.value.success).length;u?.debug?.log("VisualSystemFacade",`Visual systems initialized: ${i}/${t.length}`),await this.registerQualityScalingSystems()}async registerQualityScalingSystems(){try{let e=this.year3000System?.getCachedNonVisualSystem?.("SimplePerformanceCoordinator"),t=this.year3000System?.getCachedNonVisualSystem?.("QualityScalingManager");if(!e){u?.debug?.warn("VisualSystemFacade","SimplePerformanceCoordinator not available for quality scaling registration");return}if(!t){u?.debug?.warn("VisualSystemFacade","QualityScalingManager not available for quality scaling registration");return}for(let[i,n]of this.systemCache.entries())try{let r=n;typeof r.setQualityLevel=="function"&&typeof r.getPerformanceImpact=="function"&&typeof r.getQualityCapabilities=="function"&&(e.registerSystem(i,r),t.registerSystem(i,r),u?.debug?.log("VisualSystemFacade",`Registered ${i} for quality scaling and performance coordination`))}catch(r){u?.debug?.error("VisualSystemFacade",`Failed to register ${i} for quality scaling:`,r)}await this.initializeConsciousnessAwareAdaptation(t)}catch(e){u?.debug?.error("VisualSystemFacade","Failed to register quality scaling systems:",e)}}async initializeConsciousnessAwareAdaptation(e){try{let t=this.year3000System?.getCachedNonVisualSystem?.("MusicSyncService");if(!t){u?.debug?.warn("VisualSystemFacade","MusicSyncService not available for music-aware adaptation");return}let i=setInterval(()=>{try{let n=t.getOverallIntensity?.()||.5,r=t.getBeatStrength?.()||.5;e.adaptToMusicIntensity(n,r)}catch(n){u?.debug?.error("VisualSystemFacade","Error in music-aware adaptation:",n)}},2e3);this._musicAdaptationInterval=i,u?.debug?.log("VisualSystemFacade","Consciousness-aware quality adaptation initialized")}catch(t){u?.debug?.error("VisualSystemFacade","Failed to initialize music-aware adaptation:",t)}}async performVisualHealthCheck(){let e={overall:"good",systems:new Map,recommendations:[],timestamp:performance.now()},t=0,i=0;for(let[r,a]of this.systemCache){i++;try{let s=a.healthCheck?await a.healthCheck():{status:"unknown",message:"No health check available"},o=s.status==="healthy"||s.status==="good";o&&t++,e.systems.set(r,{ok:o,details:s.message||s.details||"System operational"})}catch(s){e.systems.set(r,{ok:!1,details:`Health check failed: ${s}`})}}let n=i>0?t/i:1;return n>=.9?e.overall="excellent":n>=.7?e.overall="good":n>=.5?(e.overall="degraded",e.recommendations.push("Some visual systems are experiencing issues")):(e.overall="critical",e.recommendations.push("Multiple visual system failures detected")),this.currentMetrics.currentFPS<30&&e.recommendations.push("Low FPS detected - consider reducing visual quality"),this.currentMetrics.memoryUsageMB>40&&e.recommendations.push("High memory usage - consider optimizing visual systems"),this.lastHealthCheck=e,this.cssVariableController.queueCSSVariableUpdate("--sn-visual-health",e.overall),e}createInitialMetrics(){return{currentFPS:0,averageFPS:0,frameTime:0,memoryUsageMB:0,systemHealth:"good",activeVisualSystems:[],currentQuality:{gradientComplexity:.6,particleDensity:.6,shaderPrecision:"medium",textureResolution:1,animationFPS:60,transitionQuality:"smooth",motionBlur:!1,bloomEnabled:!0,shadowQuality:"medium",antiAliasing:"fxaa",postProcessing:!0},adaptiveScaling:!0,performanceMonitoring:!0,eventCoordination:!0,lastEventTime:0,eventCount:0}}async applyConfiguration(){}subscribeToEvents(){this.settingsManager&&this.boundSettingsHandler&&document.addEventListener("year3000SystemSettingsChanged",this.boundSettingsHandler)}startMonitoring(){this.bridgeConfig.enablePerformanceMonitoring&&(this.healthCheckInterval=window.setInterval(async()=>{await this.performVisualHealthCheck()},1e4),this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},1e3))}updateMetrics(){this.currentMetrics.currentFPS=this.performanceAnalyzer.getMedianFPS()||0,this.currentMetrics.frameTime=this.currentMetrics.currentFPS>0?1e3/this.currentMetrics.currentFPS:1e3;let e=performance.memory;e&&(this.currentMetrics.memoryUsageMB=e.usedJSHeapSize/(1024*1024)),this.currentMetrics.currentFPS<20?this.currentMetrics.systemHealth="critical":this.currentMetrics.currentFPS<30?this.currentMetrics.systemHealth="degraded":this.currentMetrics.currentFPS>55?this.currentMetrics.systemHealth="excellent":this.currentMetrics.systemHealth="good"}handleSettingsChange(e){let t=e,{key:i,value:n}=t.detail;i.startsWith("sn-visual-")&&this.updateConfigurationFromSettings(i,n)}updateConfigurationFromSettings(e,t){switch(e){case"sn-visual-quality":this.bridgeConfig.qualityPreferences.preferHighQuality=t==="high";break;case"sn-visual-performance":this.bridgeConfig.enableAdaptiveQuality=t==="adaptive";break}}async cleanup(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this._musicAdaptationInterval&&(clearInterval(this._musicAdaptationInterval),this._musicAdaptationInterval=null),this.boundSettingsHandler&&document.removeEventListener("year3000SystemSettingsChanged",this.boundSettingsHandler),this.cssVariableController.queueCSSVariableUpdate("--sn-visual-bridge-active","0")}getMetrics(){return{...this.currentMetrics}}getLastHealthCheck(){return this.lastHealthCheck}getConfiguration(){return{...this.bridgeConfig}}async setConfiguration(e){this.bridgeConfig={...this.bridgeConfig,...e},await this.applyConfiguration()}setOnSystemAdaptation(e){this.onSystemAdaptation=e}setOnHealthChange(e){this.onHealthChange=e}setOnSystemCreated(e){this.onSystemCreated=e}getSystemStatus(){return{initialized:this.isInitialized,systemsActive:this.systemCache.size,healthy:this.currentMetrics.systemHealth==="excellent"||this.currentMetrics.systemHealth==="good"}}updateAnimation(e){this.initialized&&this.systemCache.forEach((t,i)=>{try{typeof t.updateAnimation=="function"?t.updateAnimation(e):typeof t.onAnimate=="function"&&t.onAnimate(e)}catch(n){u?.debug?.error("VisualSystemCoordinator",`Error updating ${i}:`,n)}})}async healthCheck(){try{let e=await this.performVisualHealthCheck(),t;switch(e.overall){case"excellent":case"good":t="healthy";break;case"degraded":t="degraded";break;case"critical":t="critical";break;default:t="healthy"}return{healthy:t==="healthy",ok:t!=="critical",details:`Visual system coordinator health: ${e.overall} (${e.systems.size} systems)`,system:"VisualSystemCoordinator",issues:e.recommendations,metrics:{overall:e.overall,systemCount:e.systems.size,recommendations:e.recommendations,currentMetrics:this.currentMetrics,status:t}}}catch(e){return{healthy:!1,ok:!1,details:`Health check failed: ${e}`,system:"VisualSystemCoordinator",issues:["Health check exception"],metrics:{error:String(e)}}}}forceRepaint(e){u?.debug?.log("VisualSystemCoordinator",`Force repaint requested${e?`: ${e}`:""}`),this.systemCache.forEach((t,i)=>{try{typeof t.forceRepaint=="function"?t.forceRepaint(e):typeof t.refresh=="function"&&t.refresh()}catch(n){u?.debug?.warn("VisualSystemCoordinator",`Error force repainting ${i}:`,n)}}),this.cssVariableController&&"flushPendingUpdates"in this.cssVariableController&&this.cssVariableController.flushPendingUpdates()}async destroy(){await this.cleanup(),this.isInitialized=!1,this.initialized=!1,this.systemCache.clear(),u?.debug?.log("VisualSystemCoordinator","Facade destroyed")}}});var Gt,Gs=b(()=>{"use strict";Hn();di();$();ds();jn();yi();Qn();ue();Mi();R();De();xn();Fs();Gt=class{constructor(e,t,i){this.visualBridge=null;this.nonVisualFacade=null;this.sharedUnifiedCSSVariableManager=null;this.sharedSimplePerformanceCoordinator=null;this.sharedWebGLSystemsIntegration=null;this.sharedEnhancedDeviceTierDetector=null;this.sharedDeviceCapabilityDetector=null;this.sharedPerformanceBudgetManager=null;this.sharedMusicSyncService=null;this.sharedSettingsManager=null;this.sharedColorHarmonyEngine=null;this.sharedSemanticColorManager=null;this.isInitialized=!1;this.lastHealthCheck=null;this.colorDependentSystems=new Set;this.colorSystemRefreshCallbacks=new Map;this.currentPhase="core";this.systemStates=new Map;this.phaseCompletionPromises=new Map;this.systemDependencies=new Map;this.initializationOrder=new Map;this.eventBus=null;this.crossFacadeEventListeners=new Map;this.healthCheckInterval=null;this.metricsUpdateInterval=null;this.onSystemCreated=null;this.onHealthChange=null;this.onPerformanceChange=null;this.config=e,this.utils=t,this.year3000System=i,this.coordinationConfig={mode:"unified",enableSharedDependencies:!0,enableCrossFacadeCommunication:!0,enableUnifiedPerformanceMonitoring:!0,enableResourceOptimization:!0,coordination:{enforceSequentialInitialization:!0,dependencyValidation:!0,enableInitializationGates:!0,systemReadinessTimeout:5e3,phaseTransitionTimeout:1e4},performanceThresholds:{maxTotalMemoryMB:150,maxTotalInitTime:8e3,maxCrossCommLatency:10},coordinationPreferences:{preferSharedResources:!0,enableEventPropagation:!0,enableHealthCoordination:!0}},this.setupCoordinationPhases(),this.currentMetrics=this.createInitialMetrics(),u?.debug?.log("SystemCoordinator","System coordinator initialized")}async initialize(e){if(this.isInitialized){u?.debug?.warn("SystemCoordinator","Already initialized");return}try{let t=performance.now();this.coordinationConfig={...this.coordinationConfig,...e},this.coordinationConfig.coordination.enforceSequentialInitialization?(u?.debug?.log("SystemCoordinator","Starting coordinated initialization"),await this.executeCoordinatedInitialization()):(u?.debug?.log("SystemCoordinator","Starting legacy initialization"),await this.executeLegacyInitialization());let i=performance.now();this.currentMetrics.totalInitTime=i-t,this.isInitialized=!0,u?.debug?.log("SystemCoordinator","System coordination fully initialized",{mode:this.coordinationConfig.mode,coordinationEnabled:this.coordinationConfig.coordination.enforceSequentialInitialization,currentPhase:this.currentPhase,visualSystems:this.currentMetrics.visualSystems,nonVisualSystems:this.currentMetrics.nonVisualSystems,initTime:this.currentMetrics.totalInitTime})}catch(t){throw u?.debug?.error("SystemCoordinator","Initialization failed:",t),await this.cleanup(),t}}async initializeSharedDependencies(){if(this.coordinationConfig.enableSharedDependencies){u?.debug?.log("SystemCoordinator","Initializing simplified shared dependencies");try{this.sharedDeviceCapabilityDetector=new N({enableDebug:!0,spicetifyContext:!0}),await this.sharedDeviceCapabilityDetector.initialize(),this.sharedEnhancedDeviceTierDetector=new me,this.sharedWebGLSystemsIntegration=new Qe(this.sharedDeviceCapabilityDetector),await this.sharedWebGLSystemsIntegration.initialize(),this.sharedDeviceCapabilityDetector=new N({enableDebug:this.config.enableDebug||!1,runStressTests:!1}),await this.sharedDeviceCapabilityDetector.initialize(),this.sharedPerformanceBudgetManager=new Ee({budgets:{animationFrame:16,cssVariableUpdate:2,domObservation:1,audioAnalysis:5,visualEffects:8,userInteraction:100},autoOptimize:{enabled:!0,violationThreshold:3,recoveryThreshold:.8},enableDebug:this.config.enableDebug||!1},this.sharedSimplePerformanceCoordinator),this.sharedSimplePerformanceCoordinator=new he(this.sharedEnhancedDeviceTierDetector,this.sharedWebGLSystemsIntegration),await this.sharedSimplePerformanceCoordinator.initialize();try{let e=this.sharedSimplePerformanceCoordinator;this.sharedUnifiedCSSVariableManager=new ve(this.config,e,{enableAdaptiveThrottling:!0,batchIntervalMs:16,maxBatchSize:50,priorityMappings:{critical:["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift","--sn-cosmic-base-hex","--sn-cosmic-accent-hex"],high:["--sn-gradient-primary","--sn-gradient-secondary","--sn-gradient-accent","--sn-color-base-hex","--sn-color-accent-hex"],normal:["--sn-gradient-","--sn-rs-","--sn-color-"],low:["--sn-debug-","--sn-dev-","--sn-meta-"]},thresholds:{excellentFPS:55,goodFPS:45,poorFPS:30}}),Tn(this.sharedUnifiedCSSVariableManager),await this.sharedUnifiedCSSVariableManager.initialize()}catch(e){u?.debug?.warn("SystemCoordinator","Failed to initialize OptimizedCSSVariableManager:",e),this.sharedUnifiedCSSVariableManager=null}this.sharedSettingsManager=new ee,await this.sharedSettingsManager.initialize(),this.sharedMusicSyncService=new Ce,await this.sharedMusicSyncService.initialize(),this.sharedColorHarmonyEngine=new Ye(this.config,this.utils,this.sharedSimplePerformanceCoordinator,this.sharedSettingsManager),await this.sharedColorHarmonyEngine.initialize(),u?.debug?.log("SystemCoordinator","Shared dependencies initialized successfully")}catch(e){throw u?.debug?.error("SystemCoordinator","Failed to initialize shared dependencies:",e),e}}}async initializeFacades(){u?.debug?.log("SystemCoordinator","Initializing facades");try{let e=this.nonVisualFacade?.getCachedSystem("EnhancedMasterAnimationCoordinator")||null;this.visualBridge=new Ft(this.config,this.utils,this.year3000System,this.sharedUnifiedCSSVariableManager,this.sharedSimplePerformanceCoordinator,this.sharedMusicSyncService,this.sharedSettingsManager,this.sharedColorHarmonyEngine,this.eventBus,e),await this.visualBridge.initialize({mode:this.coordinationConfig.mode==="performance-optimized"?"performance-first":"progressive",enablePerformanceMonitoring:this.coordinationConfig.enableUnifiedPerformanceMonitoring,enableEventCoordination:this.coordinationConfig.enableCrossFacadeCommunication}),this.visualBridge.setOnSystemCreated((t,i)=>{this.handleSystemCreated("visual",t,i)}),this.nonVisualFacade=new kt(this.config,this.utils,this.year3000System),await this.nonVisualFacade.initialize({mode:this.coordinationConfig.mode==="performance-optimized"?"performance-first":"progressive",enablePerformanceMonitoring:this.coordinationConfig.enableUnifiedPerformanceMonitoring,enableDependencyInjection:this.coordinationConfig.enableSharedDependencies}),this.nonVisualFacade.setOnSystemCreated((t,i)=>{this.handleSystemCreated("non-visual",t,i)}),this.injectSharedDependencies(),u?.debug?.log("SystemCoordinator","Facades initialized successfully")}catch(e){throw u?.debug?.error("SystemCoordinator","Failed to initialize facades:",e),e}}injectSharedDependencies(){!this.coordinationConfig.enableSharedDependencies||!this.nonVisualFacade||(this.sharedSimplePerformanceCoordinator&&(this.nonVisualFacade.simplePerformanceCoordinator=this.sharedSimplePerformanceCoordinator),this.sharedWebGLSystemsIntegration&&(this.nonVisualFacade.webglSystemsIntegration=this.sharedWebGLSystemsIntegration),this.sharedEnhancedDeviceTierDetector&&(this.nonVisualFacade.enhancedDeviceTierDetector=this.sharedEnhancedDeviceTierDetector),this.sharedSimplePerformanceCoordinator&&(this.nonVisualFacade.performanceAnalyzer=this.sharedSimplePerformanceCoordinator),this.sharedUnifiedCSSVariableManager&&(this.nonVisualFacade.cssVariableController=this.sharedUnifiedCSSVariableManager),this.sharedMusicSyncService&&(this.nonVisualFacade.musicSyncService=this.sharedMusicSyncService),this.sharedSettingsManager&&(this.nonVisualFacade.settingsManager=this.sharedSettingsManager),this.sharedColorHarmonyEngine&&(this.nonVisualFacade.colorHarmonyEngine=this.sharedColorHarmonyEngine),this.sharedSemanticColorManager&&(this.nonVisualFacade.semanticColorManager=this.sharedSemanticColorManager))}setupCrossFacadeCommunication(){this.coordinationConfig.enableCrossFacadeCommunication&&(u?.debug?.log("SystemCoordinator","Setting up cross-facade communication"),this.addEventListener("visual-event",e=>{this.visualBridge&&this.visualBridge.propagateVisualEvent(e)}),this.addEventListener("performance-event",e=>{this.visualBridge&&this.visualBridge.handleAdaptationEvent(e)}),this.coordinationConfig.coordinationPreferences.enableHealthCoordination&&this.addEventListener("health-degradation",e=>{this.handleHealthDegradation(e)}))}handleSystemCreated(e,t,i){e==="visual"?this.currentMetrics.visualSystems++:this.currentMetrics.nonVisualSystems++,this.currentMetrics.activeSystems++,this.onSystemCreated&&this.onSystemCreated(e,t,i),u?.debug?.log("SystemCoordinator",`System created: ${e}/${t}`)}handleHealthDegradation(e){u?.debug?.warn("SystemCoordinator","Health degradation detected:",e),this.coordinationConfig.mode==="performance-optimized"&&this.optimizeForPerformance()}optimizeForPerformance(){this.visualBridge&&this.visualBridge.setConfiguration({mode:"performance-first",enableAdaptiveQuality:!0,qualityPreferences:{preferHighQuality:!1,allowDynamicScaling:!0,batteryConservation:!0}}),this.nonVisualFacade&&this.nonVisualFacade.setConfiguration({mode:"performance-first",systemPreferences:{lazyInitialization:!0,aggressiveCaching:!0,performanceOptimization:!0}})}getVisualSystem(e){return this.visualBridge?this.visualBridge.getVisualSystem(e):null}getCachedNonVisualSystem(e){return this.nonVisualFacade?this.nonVisualFacade.getCachedSystem(e):null}async getNonVisualSystem(e){return this.nonVisualFacade?await this.nonVisualFacade.getSystem(e):null}async getSystem(e){if(this.visualBridge)try{return this.visualBridge.getVisualSystem(e)}catch{}if(this.nonVisualFacade)try{return await this.nonVisualFacade.getSystem(e)}catch{}return null}addEventListener(e,t){this.crossFacadeEventListeners.has(e)||this.crossFacadeEventListeners.set(e,[]),this.crossFacadeEventListeners.get(e).push(t)}removeEventListener(e,t){let i=this.crossFacadeEventListeners.get(e);if(i){let n=i.indexOf(t);n!==-1&&i.splice(n,1)}}emitEvent(e,t){let i=this.crossFacadeEventListeners.get(e);i&&i.forEach(n=>{try{n(t)}catch(r){u?.debug?.error("SystemCoordinator",`Error in event listener for ${e}:`,r)}}),this.currentMetrics.crossFacadeEvents++}async performHealthCheck(){let e={overall:"good",facades:{visual:{ok:!0,details:"Visual systems operational",systemCount:0},nonVisual:{ok:!0,details:"Non-visual systems operational",systemCount:0}},sharedResources:{simplePerformanceCoordinator:{ok:!0,details:"Simple performance coordinator operational"},cssVariableController:{ok:!0,details:"CSS variable batcher operational"},musicSyncService:{ok:!0,details:"Music sync service operational"},performanceAnalyzer:{ok:!0,details:"Legacy performance analyzer operational"}},recommendations:[],timestamp:performance.now()};if(this.visualBridge)try{let n=await this.visualBridge.performVisualHealthCheck();e.facades.visual.ok=n.overall==="excellent"||n.overall==="good",e.facades.visual.details=`Visual systems: ${n.overall}`,e.facades.visual.systemCount=n.systems.size}catch(n){e.facades.visual.ok=!1,e.facades.visual.details=`Visual facade error: ${n}`}if(this.nonVisualFacade)try{let n=await this.nonVisualFacade.performHealthCheck();e.facades.nonVisual.ok=n.overall==="excellent"||n.overall==="good",e.facades.nonVisual.details=`Non-visual systems: ${n.overall}`,e.facades.nonVisual.systemCount=n.systems.size}catch(n){e.facades.nonVisual.ok=!1,e.facades.nonVisual.details=`Non-visual facade error: ${n}`}if(this.sharedSimplePerformanceCoordinator)try{let n=await this.sharedSimplePerformanceCoordinator.healthCheck();e.sharedResources.simplePerformanceCoordinator.ok=n.healthy,e.sharedResources.simplePerformanceCoordinator.details=n.details||"Simple performance coordinator operational"}catch(n){e.sharedResources.simplePerformanceCoordinator.ok=!1,e.sharedResources.simplePerformanceCoordinator.details=`Simple performance coordinator error: ${n}`}if(this.sharedSimplePerformanceCoordinator)try{let n=await this.sharedSimplePerformanceCoordinator.healthCheck();e.sharedResources.performanceAnalyzer={ok:n.healthy,details:n.details||"Simple performance coordinator operational"}}catch(n){e.sharedResources.performanceAnalyzer={ok:!1,details:`Simple performance coordinator error: ${n}`}}if(this.sharedUnifiedCSSVariableManager)try{let n=await this.sharedUnifiedCSSVariableManager.healthCheck();e.sharedResources.cssVariableController.ok=n.healthy||n.ok||!1,e.sharedResources.cssVariableController.details=n.details||"CSS variable controller operational"}catch(n){e.sharedResources.cssVariableController.ok=!1,e.sharedResources.cssVariableController.details=`CSS variable controller error: ${n}`}if(this.sharedMusicSyncService)try{let n=await this.sharedMusicSyncService.healthCheck();e.sharedResources.musicSyncService.ok=n.status==="healthy",e.sharedResources.musicSyncService.details=n.message||"Music sync service operational"}catch(n){e.sharedResources.musicSyncService.ok=!1,e.sharedResources.musicSyncService.details=`Music sync service error: ${n}`}if(this.sharedSemanticColorManager)try{let n=await this.sharedSemanticColorManager.healthCheck(),r=n.healthy;e.sharedResources.semanticColorManager={ok:r,details:n.details||"Semantic color manager operational"}}catch(n){e.sharedResources.semanticColorManager={ok:!1,details:`Semantic color manager error: ${n}`}}let t=e.facades.visual.ok&&e.facades.nonVisual.ok,i=e.sharedResources.simplePerformanceCoordinator.ok&&e.sharedResources.cssVariableController.ok&&e.sharedResources.musicSyncService.ok&&e.sharedResources.semanticColorManager?.ok!==!1&&e.sharedResources.performanceAnalyzer?.ok!==!1;return t&&i?e.overall="excellent":t||i?e.overall="good":(e.overall="critical",e.recommendations.push("Multiple system failures detected - consider system restart")),this.currentMetrics.totalMemoryMB>120&&e.recommendations.push("High memory usage - consider optimizing system memory"),this.currentMetrics.totalInitTime>6e3&&e.recommendations.push("High initialization time - consider optimizing system startup"),this.lastHealthCheck=e,this.onHealthChange&&this.onHealthChange(e),e}createInitialMetrics(){return{totalSystems:0,visualSystems:0,nonVisualSystems:0,activeSystems:0,failedSystems:0,totalMemoryMB:0,totalInitTime:0,averageSystemInitTime:0,crossFacadeLatency:0,overallHealth:"good",visualHealth:"good",nonVisualHealth:"good",sharedDependencies:6,crossFacadeEvents:0,resourceOptimization:0}}startMonitoring(){this.coordinationConfig.enableUnifiedPerformanceMonitoring&&(this.healthCheckInterval=window.setInterval(async()=>{await this.performHealthCheck()},2e4),this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},2e3))}updateMetrics(){if(this.visualBridge){let t=this.visualBridge.getMetrics();this.currentMetrics.visualHealth=t.systemHealth}if(this.nonVisualFacade){let t=this.nonVisualFacade.getMetrics();this.currentMetrics.nonVisualHealth=t.systemHealth}let e=performance.memory;e&&(this.currentMetrics.totalMemoryMB=e.usedJSHeapSize/(1024*1024)),this.currentMetrics.visualHealth==="excellent"&&this.currentMetrics.nonVisualHealth==="excellent"?this.currentMetrics.overallHealth="excellent":this.currentMetrics.visualHealth==="critical"||this.currentMetrics.nonVisualHealth==="critical"?this.currentMetrics.overallHealth="critical":this.currentMetrics.visualHealth==="degraded"||this.currentMetrics.nonVisualHealth==="degraded"?this.currentMetrics.overallHealth="degraded":this.currentMetrics.overallHealth="good",this.onPerformanceChange&&this.onPerformanceChange(this.currentMetrics)}setupCoordinationPhases(){this.systemDependencies.set("MusicSyncService",[]),this.systemDependencies.set("ColorHarmonyEngine",["MusicSyncService","SemanticColorManager"]),this.systemDependencies.set("PerformanceAnalyzer",[]),this.systemDependencies.set("UnifiedCSSVariableManager",["PerformanceAnalyzer"]),this.systemDependencies.set("SettingsManager",[]),this.systemDependencies.set("SemanticColorManager",["UnifiedCSSVariableManager"]),this.initializationOrder.set("core",["PerformanceAnalyzer","UnifiedCSSVariableManager"]),this.initializationOrder.set("services",["SettingsManager","MusicSyncService","SemanticColorManager"]),this.initializationOrder.set("visual-systems",["ColorHarmonyEngine"]),this.initializationOrder.set("integration",["VisualSystemCoordinator","NonVisualSystemFacade"]);for(let[e,t]of this.initializationOrder.entries())for(let i of t)this.systemStates.set(i,"uninitialized");u?.debug?.log("SystemCoordinator","Coordination phases configured",{phases:Array.from(this.initializationOrder.keys()),totalSystems:this.systemStates.size,dependencies:Object.fromEntries(this.systemDependencies)})}async executeCoordinatedInitialization(){let e=["core","services","visual-systems","integration"];for(let t of e){u?.debug?.log("SystemCoordinator",`Starting phase: ${t}`),this.currentPhase=t;try{await this.executePhase(t),u?.debug?.log("SystemCoordinator",`Phase ${t} completed successfully`)}catch(i){throw u?.debug?.error("SystemCoordinator",`Phase ${t} failed:`,i),new Error(`Orchestration failed at phase ${t}: ${i}`)}}this.currentPhase="completed",this.setupCrossFacadeCommunication(),await this.setupGradientSystemCoordination(),this.setupDefaultColorDependentSystems(),this.startMonitoring(),await this.performHealthCheck()}async executePhase(e){let t=this.initializationOrder.get(e);if(!t)throw new Error(`Unknown phase: ${e}`);let i=[];for(let n of t)i.push(this.initializeSystemWithDependencies(n));await Promise.all(i);for(let n of t){let r=this.systemStates.get(n);if(r!=="ready")throw new Error(`System ${n} not ready after phase ${e} (state: ${r})`)}}async initializeSystemWithDependencies(e){if(this.systemStates.get(e)!=="ready"){this.systemStates.set(e,"initializing");try{let t=this.systemDependencies.get(e)||[];for(let i of t)await this.waitForSystemReady(i);switch(e){case"PerformanceAnalyzer":await this.initializePerformanceAnalyzer();break;case"UnifiedCSSVariableManager":await this.initializeUnifiedCSSController();break;case"SettingsManager":await this.initializeSettingsManager();break;case"MusicSyncService":await this.initializeMusicSyncService();break;case"ColorHarmonyEngine":await this.initializeColorHarmonyEngine();break;case"SemanticColorManager":await this.initializeSemanticColorManager();break;case"VisualSystemCoordinator":await this.initializeVisualFacade();break;case"NonVisualSystemFacade":await this.initializeNonVisualFacade();break;default:throw new Error(`Unknown system: ${e}`)}this.systemStates.set(e,"ready"),u?.debug?.log("SystemCoordinator",`System ${e} initialized successfully`)}catch(t){throw this.systemStates.set(e,"failed"),u?.debug?.error("SystemCoordinator",`System ${e} initialization failed:`,t),t}}}async waitForSystemReady(e){let t=this.coordinationConfig.coordination.systemReadinessTimeout,i=Date.now();for(;Date.now()-i<t;){let n=this.systemStates.get(e);if(n==="ready")return;if(n==="failed")throw new Error(`Dependency ${e} failed to initialize`);await new Promise(r=>setTimeout(r,50))}throw new Error(`Timeout waiting for dependency ${e} to be ready`)}async initializePerformanceAnalyzer(){this.sharedDeviceCapabilityDetector||(this.sharedDeviceCapabilityDetector=new N({enableDebug:!0,spicetifyContext:!0}),await this.sharedDeviceCapabilityDetector.initialize()),this.sharedEnhancedDeviceTierDetector=new me,this.sharedWebGLSystemsIntegration=new Qe(this.sharedDeviceCapabilityDetector),await this.sharedWebGLSystemsIntegration.initialize(),this.sharedSimplePerformanceCoordinator=new he(this.sharedEnhancedDeviceTierDetector,this.sharedWebGLSystemsIntegration),await this.sharedSimplePerformanceCoordinator.initialize()}async initializeUnifiedCSSController(){if(!this.sharedSimplePerformanceCoordinator)throw new Error("SimplePerformanceCoordinator dependency not available");try{this.sharedDeviceCapabilityDetector=new N({enableDebug:this.config.enableDebug||!1,runStressTests:!1}),await this.sharedDeviceCapabilityDetector.initialize(),this.sharedPerformanceBudgetManager=new Ee({budgets:{animationFrame:16,cssVariableUpdate:2,domObservation:1,audioAnalysis:5,visualEffects:8,userInteraction:100},autoOptimize:{enabled:!0,violationThreshold:3,recoveryThreshold:.8},enableDebug:this.config.enableDebug||!1},this.sharedSimplePerformanceCoordinator);let e=this.sharedDeviceCapabilityDetector.getCapabilities(),t={getCurrentPerformanceMode:()=>({name:"balanced",qualityLevel:.8,animationQuality:.8,effectQuality:.8,blurQuality:.8,shadowQuality:.8,frameRate:60,optimizationLevel:1}),getDeviceCapabilities:()=>e||{performanceTier:"mid",memoryGB:8,isMobile:!1,gpuAcceleration:!0},getBatteryState:()=>({level:1,charging:!1}),getThermalState:()=>({temperature:"normal"})};this.sharedUnifiedCSSVariableManager=new ve(this.config,t,{enableAdaptiveThrottling:!0,batchIntervalMs:16,maxBatchSize:50,priorityMappings:{critical:["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift","--sn-cosmic-base-hex","--sn-cosmic-accent-hex"],high:["--sn-gradient-primary","--sn-gradient-secondary","--sn-gradient-accent","--sn-color-base-hex","--sn-color-accent-hex"],normal:["--sn-gradient-","--sn-rs-","--sn-color-"],low:["--sn-debug-","--sn-dev-","--sn-meta-"]},thresholds:{excellentFPS:55,goodFPS:45,poorFPS:30}}),Tn(this.sharedUnifiedCSSVariableManager),await this.sharedUnifiedCSSVariableManager.initialize()}catch(e){u?.debug?.warn("SystemCoordinator","Failed to initialize OptimizedCSSVariableManager:",e),this.sharedUnifiedCSSVariableManager=null}}async initializeSettingsManager(){this.sharedSettingsManager=new ee,await this.sharedSettingsManager.initialize()}async initializeMusicSyncService(){this.sharedMusicSyncService=new Ce({YEAR3000_CONFIG:this.config,Year3000Utilities:this.utils,performanceMonitor:this.sharedSimplePerformanceCoordinator,settingsManager:this.sharedSettingsManager,year3000System:this.year3000System}),await this.sharedMusicSyncService.initialize()}async initializeSemanticColorManager(){if(!this.sharedUnifiedCSSVariableManager)throw new Error("OptimizedCSSVariableManager dependency not available");this.sharedSemanticColorManager=new rt({enableDebug:this.config.enableDebug||!1,fallbackToSpiceColors:!0,cacheDuration:5e3}),await this.sharedSemanticColorManager.initialize(this.sharedUnifiedCSSVariableManager),u?.debug?.log("SystemCoordinator","SemanticColorManager initialized successfully",{systemMetrics:this.sharedSemanticColorManager.getSystemMetrics()})}async initializeColorHarmonyEngine(){if(!this.sharedMusicSyncService)throw new Error("MusicSyncService dependency not available");if(!this.sharedSemanticColorManager)throw new Error("SemanticColorManager dependency not available");this.sharedColorHarmonyEngine=new Ye(this.config,this.utils,this.sharedSimplePerformanceCoordinator||void 0,this.sharedSettingsManager||void 0),await this.sharedColorHarmonyEngine.initialize()}async initializeVisualFacade(){this.visualBridge=new Ft(this.config,this.utils,this,this.sharedUnifiedCSSVariableManager,this.sharedSimplePerformanceCoordinator,this.sharedMusicSyncService,this.sharedSettingsManager,this.sharedColorHarmonyEngine||void 0,this.eventBus),await this.visualBridge.initialize()}async initializeNonVisualFacade(){this.nonVisualFacade=new kt(this.config,this.utils,{performanceAnalyzer:this.sharedSimplePerformanceCoordinator,unifiedCSSConsciousnessController:this.sharedUnifiedCSSVariableManager,musicSyncService:this.sharedMusicSyncService,settingsManager:this.sharedSettingsManager,colorHarmonyEngine:this.sharedColorHarmonyEngine,performanceOrchestrator:this.sharedSimplePerformanceCoordinator,semanticColorManager:this.sharedSemanticColorManager}),await this.nonVisualFacade.initialize()}async executeLegacyInitialization(){await this.initializeSharedDependencies(),await this.initializeFacades(),this.setupCrossFacadeCommunication(),await this.setupGradientSystemCoordination(),this.setupDefaultColorDependentSystems(),this.startMonitoring(),await this.performHealthCheck()}getCurrentPhase(){return this.currentPhase}getSystemState(e){return this.systemStates.get(e)}getAllSystemStates(){return new Map(this.systemStates)}isOrchestrationEnabled(){return this.coordinationConfig.coordination.enforceSequentialInitialization}async cleanup(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this.visualBridge&&(await this.visualBridge.destroy(),this.visualBridge=null),this.nonVisualFacade&&(await this.nonVisualFacade.destroy(),this.nonVisualFacade=null),this.sharedSimplePerformanceCoordinator&&(this.sharedSimplePerformanceCoordinator.destroy(),this.sharedSimplePerformanceCoordinator=null),this.sharedWebGLSystemsIntegration&&(this.sharedWebGLSystemsIntegration.destroy(),this.sharedWebGLSystemsIntegration=null),this.sharedEnhancedDeviceTierDetector&&(this.sharedEnhancedDeviceTierDetector=null),this.sharedSemanticColorManager&&(this.sharedSemanticColorManager.destroy(),this.sharedSemanticColorManager=null),this.sharedColorHarmonyEngine&&(this.sharedColorHarmonyEngine.destroy(),this.sharedColorHarmonyEngine=null),this.sharedMusicSyncService&&(this.sharedMusicSyncService.destroy(),this.sharedMusicSyncService=null),this.sharedSettingsManager&&(this.sharedSettingsManager.destroy(),this.sharedSettingsManager=null),this.sharedUnifiedCSSVariableManager&&(this.sharedUnifiedCSSVariableManager.destroy(),this.sharedUnifiedCSSVariableManager=null),this.sharedSimplePerformanceCoordinator&&(this.sharedSimplePerformanceCoordinator.destroy(),this.sharedSimplePerformanceCoordinator=null),this.sharedPerformanceBudgetManager&&(this.sharedPerformanceBudgetManager.destroy(),this.sharedPerformanceBudgetManager=null),this.sharedDeviceCapabilityDetector&&(this.sharedDeviceCapabilityDetector.destroy(),this.sharedDeviceCapabilityDetector=null),this.crossFacadeEventListeners.clear()}getMetrics(){return{...this.currentMetrics}}getLastHealthCheck(){return this.lastHealthCheck}getConfiguration(){return{...this.coordinationConfig}}async setConfiguration(e){this.coordinationConfig={...this.coordinationConfig,...e}}setOnSystemCreated(e){this.onSystemCreated=e}setOnHealthChange(e){this.onHealthChange=e}setOnPerformanceChange(e){this.onPerformanceChange=e}getSystemStatus(){return{initialized:this.isInitialized,visualSystems:this.visualBridge?.getSystemStatus().systemsActive||0,nonVisualSystems:this.nonVisualFacade?.getSystemStatus().systemsActive||0,healthy:this.currentMetrics.overallHealth==="excellent"||this.currentMetrics.overallHealth==="good"}}async setupGradientSystemCoordination(){if(!this.visualBridge){u?.debug?.warn("SystemCoordinator","VisualSystemCoordinator not available - skipping gradient system coordination");return}u?.debug?.log("SystemCoordinator","Setting up gradient system coordination");let e=performance.now(),t=0;try{await this.coordinateGradientConductor(),t++,await this.coordinateWebGLGradientSystem(),t++,this.setupGradientSystemRefreshCallbacks(),this.setupGradientSystemCommunication();let i=performance.now()-e;u?.debug?.log("SystemCoordinator","Gradient system coordination completed",{coordinatedSystems:t,duration:`${i.toFixed(2)}ms`,systems:["GradientConductor","WebGLGradientBackgroundSystem","GradientTransitionOrchestrator"]})}catch(i){throw u?.debug?.error("SystemCoordinator","Failed to setup gradient system coordination:",i),i}}async coordinateGradientConductor(){try{let e=this.visualBridge.getVisualSystem("GradientConductor");if(!e){u?.debug?.warn("SystemCoordinator","GradientConductor not available via VisualSystemCoordinator");return}this.addEventListener("gradient-conductor-event",t=>{e&&typeof e.handleSystemEvent=="function"&&e.handleSystemEvent(t)}),this.registerColorDependentSystem("GradientConductor",async t=>{if(e&&typeof e.refreshColorState=="function")await e.refreshColorState(t);else if(e&&typeof e.setPalette=="function"){let i=this.sharedColorHarmonyEngine;if(i)try{let n=await i.getCurrentGradient();n&&e.setPalette(n)}catch(n){u?.debug?.warn("SystemCoordinator","Failed to refresh GradientConductor colors:",n)}}}),u?.debug?.log("SystemCoordinator","GradientConductor coordination established")}catch(e){u?.debug?.error("SystemCoordinator","Failed to coordinate GradientConductor:",e)}}async coordinateWebGLGradientSystem(){try{let e=this.visualBridge.getVisualSystem("WebGLBackground");if(!e){u?.debug?.warn("SystemCoordinator","WebGLGradientBackgroundSystem not available via VisualSystemCoordinator");return}this.addEventListener("webgl-gradient-event",t=>{e&&typeof e.handleSystemEvent=="function"&&e.handleSystemEvent(t)}),this.registerColorDependentSystem("WebGLGradientBackgroundSystem",async t=>{e&&typeof e.refreshColorState=="function"?await e.refreshColorState(t):e&&typeof e.updateGradientTexture=="function"&&await e.updateGradientTexture()}),u?.debug?.log("SystemCoordinator","WebGLGradientBackgroundSystem coordination established")}catch(e){u?.debug?.error("SystemCoordinator","Failed to coordinate WebGLGradientBackgroundSystem:",e)}}setupGradientSystemRefreshCallbacks(){try{this.registerColorDependentSystem("GradientTransitionOrchestrator"),u?.debug?.log("SystemCoordinator","GradientTransitionOrchestrator registered for color updates")}catch(e){u?.debug?.warn("SystemCoordinator","Failed to register GradientTransitionOrchestrator:",e)}}setupGradientSystemCommunication(){this.addEventListener("color-harmony-updated",async e=>{try{await this.refreshColorDependentSystems("color-harmony-update"),this.emitEvent("gradient-systems-updated",{trigger:"color-harmony-update",timestamp:Date.now(),systems:["GradientConductor","WebGLGradientBackgroundSystem","GradientTransitionOrchestrator"]})}catch(t){u?.debug?.error("SystemCoordinator","Failed to propagate color harmony update to gradient systems:",t)}}),this.addEventListener("performance-event",e=>{try{this.emitEvent("gradient-performance-event",{...e,timestamp:Date.now()})}catch(t){u?.debug?.error("SystemCoordinator","Failed to propagate performance event to gradient systems:",t)}}),u?.debug?.log("SystemCoordinator","Gradient system communication established")}getGradientSystemStatus(){let e=["GradientConductor","WebGLGradientBackgroundSystem","GradientTransitionOrchestrator"],t=e.filter(i=>this.colorDependentSystems.has(i));return{coordinatedSystems:e,colorDependentGradientSystems:t,communicationActive:this.crossFacadeEventListeners.size>0}}registerColorDependentSystem(e,t){this.colorDependentSystems.add(e),t&&this.colorSystemRefreshCallbacks.set(e,t),u?.debug?.log("SystemCoordinator",`Registered color-dependent system: ${e}`)}unregisterColorDependentSystem(e){this.colorDependentSystems.delete(e),this.colorSystemRefreshCallbacks.delete(e),u?.debug?.log("SystemCoordinator",`Unregistered color-dependent system: ${e}`)}getColorDependentSystems(){return Array.from(this.colorDependentSystems)}async refreshColorDependentSystems(e){if(this.colorDependentSystems.size===0){u?.debug?.log("SystemCoordinator","No color-dependent systems to refresh");return}let t=performance.now(),i=[],n=0,r=0;u?.debug?.log("SystemCoordinator",`Refreshing ${this.colorDependentSystems.size} color-dependent systems for trigger: ${e}`);for(let o of this.colorDependentSystems){let l=this.colorSystemRefreshCallbacks.get(o);l?i.push(l(e).then(()=>{n++,u?.debug?.log("SystemCoordinator",`Successfully refreshed color system: ${o}`)}).catch(m=>{r++,u?.debug?.warn("SystemCoordinator",`Failed to refresh color system ${o}:`,m)})):i.push(this.getSystemAndRefresh(o,e).then(()=>{n++}).catch(m=>{r++,u?.debug?.warn("SystemCoordinator",`Failed to refresh color system ${o}:`,m)}))}await Promise.all(i);let s=performance.now()-t;u?.debug?.log("SystemCoordinator","Color system refresh completed",{trigger:e,duration:`${s.toFixed(2)}ms`,success:n,failures:r,totalSystems:this.colorDependentSystems.size}),this.emitEvent("color-systems-refreshed",{trigger:e,duration:s,successCount:n,failureCount:r,totalSystems:this.colorDependentSystems.size,timestamp:Date.now()})}async getSystemAndRefresh(e,t){if(this.visualBridge)try{let i=this.visualBridge.getVisualSystem(e);if(i&&typeof i.refreshColorState=="function"){await i.refreshColorState(t);return}}catch{}if(this.nonVisualFacade)try{let i=await this.nonVisualFacade.getSystem(e);if(i&&typeof i.refreshColorState=="function"){await i.refreshColorState(t);return}}catch{}u?.debug?.warn("SystemCoordinator",`System ${e} not found or doesn't support color refresh`)}setupDefaultColorDependentSystems(){let e=["CinematicDrama","EtherealBeauty","NaturalHarmony","FluidGradientBackgroundSystem","WebGLGradientBackgroundSystem","IridescentShimmerEffectsSystem","ColorHarmonyEngine","GradientTransitionOrchestrator","GradientConductor","SemanticColorManager","Card3DManager","GlassmorphismManager"];for(let t of e)this.registerColorDependentSystem(t);u?.debug?.log("SystemCoordinator",`Auto-registered ${e.length} default color-dependent systems`)}async destroy(){await this.cleanup(),this.isInitialized=!1,u?.debug?.log("SystemCoordinator","System coordinator destroyed")}getSharedMusicSyncService(){return this.sharedMusicSyncService||void 0}getSharedColorHarmonyEngine(){return this.sharedColorHarmonyEngine||void 0}getSharedSettingsManager(){return this.sharedSettingsManager||void 0}getSharedSemanticColorManager(){return this.sharedSemanticColorManager||void 0}getSharedSimplePerformanceCoordinator(){return this.sharedSimplePerformanceCoordinator||void 0}getSharedWebGLSystemsIntegration(){return this.sharedWebGLSystemsIntegration||void 0}getSharedEnhancedDeviceTierDetector(){return this.sharedEnhancedDeviceTierDetector||void 0}getSharedPerformanceAnalyzer(){return this.sharedSimplePerformanceCoordinator||void 0}getSharedPerformanceOrchestrator(){return this.sharedSimplePerformanceCoordinator||void 0}}});var br,Vs,Hs=b(()=>{"use strict";D();$();bt();br=class{constructor(e){this.initialized=!1;this.settingsManager=null;this.currentState=null;this.isUpdating=!1;this.updateCount=0;this.lastUpdateTime=0;this.settingsManager=e||null}async initialize(){if(this.initialized)return;let e=globalThis.year3000System;this.cssController=e?.cssConsciousnessController||T(),p.subscribe("settings:changed",this.handleSettingsChange.bind(this),"ColorStateManager"),p.subscribe("colors:harmonized",this.handleProcessedColors.bind(this),"ColorStateManager"),p.subscribe("colors:extracted",this.handleExtractedColors.bind(this),"ColorStateManager"),p.subscribe("consciousness:updated",this.handleConsciousnessUpdate.bind(this),"ColorStateManager"),p.subscribe("music:energy",this.handleMusicEnergyUpdate.bind(this),"ColorStateManager"),p.subscribe("system:css-variables",this.handleSystemCSSVariables.bind(this),"ColorStateManager"),this.settingsManager||(this.settingsManager=globalThis.__SN_settingsManager||globalThis.Y3K?.system?.settingsManager),this.settingsManager&&await this.applyInitialColorState(),this.initialized=!0,console.log("\u{1F3A8} [ColorStateManager] Initialized successfully")}async healthCheck(){let e=[];this.settingsManager||e.push("SettingsManager not available"),this.currentState||e.push("No current color state"),this.updateCount===0&&e.push("No color updates performed yet");let t=Date.now()-this.lastUpdateTime;return t>3e5&&e.push(`Last update was ${Math.round(t/1e3)}s ago`),{healthy:e.length===0,ok:e.length===0,details:`Color state manager - ${this.updateCount} updates performed`,issues:e,system:"ColorStateManager"}}updateAnimation(e){}destroy(){p.unsubscribeAll("ColorStateManager"),this.currentState=null,this.initialized=!1}getCurrentConfig(){return this.settingsManager?{paletteSystemFlavor:this.settingsManager.get("catppuccin-flavor")||j.getCurrentDefaultFlavor(),brightnessMode:this.settingsManager.get("sn-brightness-mode"),accentColor:this.settingsManager.get("catppuccin-accentColor"),preserveAlbumArt:!0,enableTransitions:!0}:{paletteSystemFlavor:j.getCurrentDefaultFlavor(),brightnessMode:"dark",accentColor:"mauve",preserveAlbumArt:!0,enableTransitions:!0}}calculateColorState(e){let{paletteSystemFlavor:t,brightnessMode:i,accentColor:n,dynamicAlbumColors:r}=e,a=ha(t,i),s=ga(t,i),o;n==="dynamic"&&r?o=r.accent:n==="dynamic"?o=pa(t):o=fa(n,t);let m=j.getCurrentPalette()[t];if(!m)throw new Error(`Flavor '${t}' not found in current palette system`);let d=m.text;return{baseColor:a,surfaceColor:s,accentColor:o,textColor:d,effectiveConfig:e,timestamp:Date.now()}}async applyColorStateToCSSVariables(e){let t=performance.now(),i={"--sn-cosmic-base-hex":e.baseColor.hex,"--sn-cosmic-accent-hex":e.accentColor.hex,"--spice-accent":e.accentColor.hex,"--spice-base":e.baseColor.hex,"--sn-color-base-hex":e.baseColor.hex,"--sn-color-base-rgb":e.baseColor.rgb,"--sn-color-surface-hex":e.surfaceColor.hex,"--sn-color-surface-rgb":e.surfaceColor.rgb,"--sn-color-accent-hex":e.accentColor.hex,"--sn-color-accent-rgb":e.accentColor.rgb,"--sn-dynamic-accent-hex":e.accentColor.hex,"--sn-dynamic-accent-rgb":e.accentColor.rgb,"--sn-cosmic-base-rgb":e.baseColor.rgb,"--sn-cosmic-surface-hex":e.surfaceColor.hex,"--sn-cosmic-surface-rgb":e.surfaceColor.rgb,"--sn-cosmic-accent-rgb":e.accentColor.rgb,"--sn-color-text-hex":e.textColor.hex,"--sn-color-text-rgb":e.textColor.rgb,"--sn-cosmic-text-hex":e.textColor.hex,"--sn-cosmic-text-rgb":e.textColor.rgb,"--spice-surface1":e.surfaceColor.hex,"--spice-text":e.textColor.hex,"--spice-rgb-base":e.baseColor.rgb,"--spice-rgb-surface1":e.surfaceColor.rgb,"--spice-rgb-accent":e.accentColor.rgb,"--spice-rgb-text":e.textColor.rgb,"--sn-bg-gradient-primary-rgb":e.accentColor.rgb,"--sn-bg-gradient-secondary-rgb":e.surfaceColor.rgb,"--sn-bg-gradient-accent-rgb":e.accentColor.rgb,"--sn-color-state-flavor":`"${e.effectiveConfig.paletteSystemFlavor}"`,"--sn-color-state-brightness":`"${e.effectiveConfig.brightnessMode}"`,"--sn-color-state-accent":`"${e.effectiveConfig.accentColor}"`,"--sn-color-state-palette-system":`"${j.getCurrentPaletteSystem()}"`,"--sn-color-state-timestamp":e.timestamp.toString()};await this.applyColorVariablesWithPriorities(i);let r=performance.now()-t;console.log(`\u{1F3A8} [ColorStateManager] Applied ${Object.keys(i).length} CSS variables in ${r.toFixed(2)}ms (via OptimizedCSSVariableManager)`)}async applyColorVariablesWithPriorities(e){let t=["--sn-cosmic-base-hex","--sn-cosmic-accent-hex","--spice-accent","--spice-base"],i=["--sn-color-","--sn-dynamic-accent-"],n={},r={},a={},s={};Object.entries(e).forEach(([o,l])=>{t.some(m=>o.includes(m))?n[o]=l:i.some(m=>o.includes(m))?r[o]=l:o.includes("state-")||o.includes("timestamp")?s[o]=l:a[o]=l}),Object.keys(n).length>0&&this.cssController.batchSetVariables("ColorStateManager",n,"critical","color-state-critical"),Object.keys(r).length>0&&this.cssController.batchSetVariables("ColorStateManager",r,"high","color-state-high"),Object.keys(a).length>0&&this.cssController.batchSetVariables("ColorStateManager",a,"normal","color-state-normal"),Object.keys(s).length>0&&this.cssController.batchSetVariables("ColorStateManager",s,"low","color-state-meta")}queueCSSVariableUpdate(e,t,i="normal"){let n=i==="critical"?"critical":i==="high"?"high":i==="low"?"low":"normal";this.cssController.setVariable("ColorStateManager",e,t,n,"color-state-queue")}async verifyCSSVariablesApplied(e){let t=["--sn-cosmic-base-hex","--sn-cosmic-accent-hex","--spice-base"];for(let i of t)if(e[i]){let n=getComputedStyle(document.documentElement).getPropertyValue(i).trim(),r=e[i];if(n!==r)return console.warn(`\u{1F3A8} [ColorStateManager] Variable verification failed: ${i} = "${n}" (expected "${r}")`),!1}return!0}async updateColorState(e="settings"){if(!this.isUpdating){this.isUpdating=!0;try{let t=this.getCurrentConfig(),i=this.calculateColorState(t);if(!this.currentState||this.currentState.baseColor.hex!==i.baseColor.hex||this.currentState.surfaceColor.hex!==i.surfaceColor.hex||this.currentState.accentColor.hex!==i.accentColor.hex||this.currentState.effectiveConfig.paletteSystemFlavor!==i.effectiveConfig.paletteSystemFlavor||this.currentState.effectiveConfig.brightnessMode!==i.effectiveConfig.brightnessMode){let r=this.currentState;await this.applyColorStateToCSSVariables(i),this.currentState=i,this.updateCount++,this.lastUpdateTime=Date.now(),p.emit("colors:applied",{oldState:r,newState:i,trigger:e,cssVariables:{"--sn-cosmic-base-hex":i.baseColor.hex,"--sn-cosmic-accent-hex":i.accentColor.hex},accentHex:i.accentColor.hex,accentRgb:i.accentColor.rgb,appliedAt:Date.now()}),console.log(`\u{1F3A8} [ColorStateManager] Color state updated (${e}):`,{flavor:i.effectiveConfig.paletteSystemFlavor,brightness:i.effectiveConfig.brightnessMode,accent:i.effectiveConfig.accentColor,paletteSystem:j.getCurrentPaletteSystem(),base:i.baseColor.hex,surface:i.surfaceColor.hex,accentHex:i.accentColor.hex})}}finally{this.isUpdating=!1}}}async applyInitialColorState(){await this.updateColorState("initialization")}async handleSettingsChange(e){let{settingKey:t,newValue:i,oldValue:n}=e;if(["catppuccin-flavor","sn-brightness-mode","catppuccin-accentColor"].includes(t)){let r="settings";t==="catppuccin-flavor"?r="flavor":t==="sn-brightness-mode"?r="brightness":t==="catppuccin-accentColor"&&(r="accent"),p.emit(`colorState:${r}Changed`,{settingKey:t,newValue:i,oldValue:n,timestamp:Date.now()}),await this.updateColorState(r)}}async handleProcessedColors(e){let{processedColors:t,accentHex:i,accentRgb:n,strategies:r,coordinationMetrics:a}=e,s={};Object.entries(t).forEach(([o,l])=>{if(l){let m=o.startsWith("--")?o:`--sn-${o.toLowerCase().replace(/_/g,"-")}`;s[m]=l}}),i&&(s["--sn-accent-hex"]=i,s["--sn-processed-accent-hex"]=i),n&&(s["--sn-accent-rgb"]=n,s["--sn-processed-accent-rgb"]=n),a&&(a.emotionalState&&(s["--sn-emotional-state"]=`"${a.emotionalState}"`),a.musicInfluenceStrength!==void 0&&(s["--sn-music-influence"]=a.musicInfluenceStrength.toFixed(3))),Object.entries(s).forEach(([o,l])=>{let m="normal";o.includes("accent-hex")||o.includes("accent-rgb")?m="high":(o.includes("debug")||o.includes("state")||o.includes("influence"))&&(m="low"),this.queueCSSVariableUpdate(o,l,m)}),console.log(`\u{1F3A8} [ColorStateManager] Applied ${Object.keys(s).length} processed color variables`)}async handleExtractedColors(e){let{rawColors:t,trackUri:i,musicData:n}=e,r={};Object.entries(t).forEach(([a,s])=>{s&&(r[`--sn-extracted-${a.toLowerCase()}`]=s)}),i&&(r["--sn-current-track-id"]=`"${i}"`),Object.entries(r).forEach(([a,s])=>{this.queueCSSVariableUpdate(a,s,"low")})}async handleConsciousnessUpdate(e){let{payload:t}=e;if(!t)return;let i={"--sn-consciousness-level":(t.consciousnessLevel||0).toFixed(3),"--sn-emotional-temperature":(t.emotionalTemperature||6500).toString(),"--sn-transcendence-level":(t.transcendenceLevel||0).toFixed(3),"--sn-volumetric-depth":(t.volumetricDepth||0).toFixed(3),"--sn-data-stream-intensity":(t.dataStreamIntensity||0).toFixed(3),"--sn-cosmic-resonance":(t.cosmicResonance||0).toFixed(3)};Object.entries(i).forEach(([n,r])=>{this.queueCSSVariableUpdate(n,r,"normal")})}async handleMusicEnergyUpdate(e){let{energy:t,valence:i,tempo:n}=e,r={};t!==void 0&&(r["--sn-music-energy"]=t.toFixed(3)),i!==void 0&&(r["--sn-music-valence"]=i.toFixed(3)),n!==void 0&&(r["--sn-music-tempo"]=n.toString()),Object.entries(r).forEach(([a,s])=>{this.queueCSSVariableUpdate(a,s,"high")})}async handleSystemCSSVariables(e){let{source:t,variables:i,timestamp:n}=e;!i||typeof i!="object"||(Object.entries(i).forEach(([r,a])=>{let s="normal";r.includes("harmony")||r.includes("glow")||r.includes("pulse")?s="high":(r.includes("debug")||r.includes("breathing"))&&(s="low"),this.queueCSSVariableUpdate(r,a,s)}),console.log(`\u{1F3A8} [ColorStateManager] Applied ${Object.keys(i).length} CSS variables from ${t}`))}getCurrentState(){return this.currentState?{...this.currentState}:null}async refresh(){await this.updateColorState("settings")}},Vs=new br});function zs(c,e=!1){let t=document.querySelector(k.nowPlayingBar);if(!t)return e&&console.warn("\u{1F3B5} [NowPlayingDomWatcher] nowPlayingBar element not found \u2013 watcher inactive"),()=>{};let i=new MutationObserver(()=>{c(),e&&console.log("\u{1F3B5} [NowPlayingDomWatcher] DOM mutation detected \u2192 onChange dispatched")});return i.observe(t,{childList:!0,subtree:!0}),e&&console.log("\u{1F3B5} [NowPlayingDomWatcher] watcher active"),()=>{i.disconnect(),e&&console.log("\u{1F3B5} [NowPlayingDomWatcher] watcher disposed")}}var Os=b(()=>{"use strict";tr()});function Bc(){let c=document.querySelector(".sn-stars-container");if(c)return c;let e=document.createElement("div");e.className="sn-stars-container";for(let t=1;t<=5;t++){let i=document.createElement("div");i.className="star",Math.random()>.7&&i.classList.add("twinkle"),e.appendChild(i)}return document.body.appendChild(e),e}function Vt(c,e){w.enableDebug&&console.log("[StarryNightEffects] Applying consolidated effect settings:",{effectIntensity:c});let t=document.body,i=["sn-gradient-disabled","sn-gradient-minimal","sn-gradient-balanced","sn-gradient-intense"],n=["sn-stars-disabled","sn-stars-minimal","sn-stars-balanced","sn-stars-intense"];t.classList.remove(...i,...n),c!=="balanced"&&(t.classList.add(`sn-gradient-${c}`),t.classList.add(`sn-stars-${c}`));let r=document.querySelector(".sn-stars-container");c==="disabled"?r?.remove():r||Bc()}var yr=b(()=>{"use strict";De();U()});var Ht,Us,_s,Sr=b(()=>{"use strict";Gs();Hs();ui();D();U();K();Os();yr();Ht=class{constructor(e=w){this.healthCheckInterval=null;this.facadeCoordinator=null;this.colorStateManager=null;this._initializationResults=null;this._dynamicCatppuccinBridge=null;this.processingState={isProcessingSongChange:!1,lastProcessedTrackUri:null,lastProcessingTime:0,processingChain:[],eventLoopDetected:!1};this.colorEventState={processedEvents:new Map,isProcessingColorEvent:!1,eventTimeout:null};this.PROCESSING_TIMEOUT=5e3;this.MAX_CHAIN_LENGTH=10;this.COLOR_EVENT_CACHE_TTL=2e3;this.availableAPIs=null;this._songChangeHandler=null;this._lastInitializationTime=null;this._initializationRetryHistory=[];this._systemStartTime=null;this._disposeNowPlayingWatcher=null;this.allowHarmonicEvolution=!0;this.performanceGuardActive=!1;this.YEAR3000_CONFIG=this._deepCloneConfig(e),typeof this.YEAR3000_CONFIG.init=="function"&&this.YEAR3000_CONFIG.init(),this.utils=A,this.initialized=!1,this._systemStartTime=Date.now(),this._initializationResults=null,this.YEAR3000_CONFIG?.enableDebug&&console.log("\u{1F31F} [Year3000System] Constructor: Instance created with Enhanced Master Animation Coordinator"),this._boundExternalSettingsHandler=this._handleExternalSettingsChange.bind(this),document.addEventListener("year3000SystemSettingsChanged",this._boundExternalSettingsHandler),this._boundArtisticModeHandler=this._onArtisticModeChanged.bind(this),document.addEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),this._boundVisibilityChangeHandler=this._handleVisibilityChange.bind(this),document.addEventListener("visibilitychange",this._boundVisibilityChangeHandler),this._disposeNowPlayingWatcher=zs(()=>{let t=Date.now().toString();this.queueCSSVariableUpdate("--sn-force-refresh",t),p.emit("music:track-changed",{timestamp:parseInt(t),trackUri:"unknown",artist:"unknown",title:"unknown"})},this.YEAR3000_CONFIG.enableDebug),this.allowHarmonicEvolution=this.YEAR3000_CONFIG.harmonicEvolution??!0,setTimeout(()=>{this._applyPerformanceProfile()},0)}get enhancedMasterAnimationCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("EnhancedMasterAnimationCoordinator")||null}get timerConsolidationSystem(){return this.facadeCoordinator?.getCachedNonVisualSystem("TimerConsolidationSystem")||null}get cssVariableController(){return this.facadeCoordinator?.getCachedNonVisualSystem("OptimizedCSSVariableManager")||null}get simplePerformanceCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimplePerformanceCoordinator")||null}get simpleTierBasedPerformanceSystem(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimpleTierBasedPerformanceSystem")||null}get enhancedDeviceTierDetector(){return this.facadeCoordinator?.getCachedNonVisualSystem("EnhancedDeviceTierDetector")||null}get webglSystemsIntegration(){return this.facadeCoordinator?.getCachedNonVisualSystem("WebGLSystemsIntegration")||null}get unifiedCSSManager(){return this.cssVariableController||null}get performanceCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedPerformanceCoordinator")||null}get deviceCapabilityDetector(){return this.facadeCoordinator?.getCachedNonVisualSystem("DeviceCapabilityDetector")||null}get performanceAnalyzer(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimplePerformanceCoordinator")||null}get unifiedPerformanceCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedPerformanceCoordinator")||null}get performanceCSSIntegration(){return this.cssVariableController||null}get performanceOrchestrator(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimplePerformanceCoordinator")||null}get performanceBudgetManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("PerformanceBudgetManager")||null}get systemHealthMonitor(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedDebugManager")||null}get settingsManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("SettingsManager")||null}get colorHarmonyEngine(){return this.facadeCoordinator?.getCachedNonVisualSystem("ColorHarmonyEngine")||null}get unifiedColorProcessingEngine(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedColorProcessingEngine")||null}get musicColorIntegrationBridge(){return null}get colorEventOrchestrator(){let e=this.unifiedColorProcessingEngine;return e||null}get colorOrchestrator(){let e=this.unifiedColorProcessingEngine;return e||null}get enhancedColorOrchestrator(){let e=this.unifiedColorProcessingEngine;return e||null}get colorEffectsState(){return this.visualEffectsCoordinator||null}get musicSyncService(){return this.facadeCoordinator?.getCachedNonVisualSystem("MusicSyncService")||null}get glassmorphismManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("GlassmorphismManager")||null}get card3DManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("Card3DManager")||null}get genreGradientEvolution(){return this.facadeCoordinator?.getCachedNonVisualSystem("GenreGradientEvolution")||null}get musicEmotionAnalyzer(){return this.facadeCoordinator?.getCachedNonVisualSystem("MusicEmotionAnalyzer")||null}get visualEffectsCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("VisualEffectsCoordinator")||null}get colorEffectsManager(){return this.visualEffectsCoordinator||null}get dynamicCatppuccinBridge(){return this._dynamicCatppuccinBridge||this.visualEffectsCoordinator||null}set dynamicCatppuccinBridge(e){this._dynamicCatppuccinBridge=e}get particleVisualEffectsModule(){return this.facadeCoordinator?.getVisualSystem("Particle")||null}get sidebarVisualEffectsController(){return this.facadeCoordinator?.getVisualSystem("SidebarVisualEffects")||null}get uiVisualEffectsController(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get headerVisualEffectsController(){return this.facadeCoordinator?.getVisualSystem("HeaderVisualEffects")||null}get lightweightParticleSystem(){return this.facadeCoordinator?.getVisualSystem("Particle")||null}get iridescentShimmerEffectsSystem(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get interactionTrackingSystem(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get whiteLayerDiagnosticSystem(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get audioVisualController(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get prismaticScrollSheenSystem(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get beatSyncVisualSystem(){return this.facadeCoordinator?.getVisualSystem("MusicBeatSync")||null}get webGLGradientBackgroundSystem(){return this.facadeCoordinator?.getVisualSystem("WebGLBackground")||null}get particleFieldSystem(){return this.facadeCoordinator?.getVisualSystem("Particle")||null}get emergentChoreographyEngine(){return this.enhancedMasterAnimationCoordinator||null}get spotifyUIApplicationSystem(){return this.facadeCoordinator?.getVisualSystem("SpotifyUIApplication")||null}get musicBeatSyncVisualEffects(){return this.facadeCoordinator?.getVisualSystem("MusicBeatSync")||this.beatSyncVisualSystem}get sidebarSystemsIntegration(){return this.facadeCoordinator?.getCachedNonVisualSystem("SidebarSystemsIntegration")||null}_deepCloneConfig(e){return e}updateConfiguration(e,t){if(!this.YEAR3000_CONFIG){console.warn("[Year3000System] Cannot update configuration - config not initialized");return}let i=e.split(".").filter(Boolean);if(!i.length)return;let n=this.YEAR3000_CONFIG,r=i.pop();if(!r)return;for(let s of i)(typeof n[s]!="object"||n[s]===null)&&(n[s]={}),n=n[s];let a=n[r];n[r]=t,this.YEAR3000_CONFIG.enableDebug&&console.log(`[Year3000System] Configuration updated: ${e} = ${t} (was: ${a})`),this._notifyConfigurationChange(e,t,a)}_notifyConfigurationChange(e,t,i){}async initializeAllSystems(){this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] initializeAllSystems(): Starting full system initialization..."),this._systemStartTime=Date.now();let e=performance.now(),t={success:[],failed:[],skipped:[]};this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing Facade Coordination System...");try{this.facadeCoordinator=new Gt(this.YEAR3000_CONFIG,this.utils,this),await this.facadeCoordinator.initialize({mode:"unified",enableSharedDependencies:!0,enableCrossFacadeCommunication:!0,enableUnifiedPerformanceMonitoring:!0,enableResourceOptimization:!0,coordination:{enforceSequentialInitialization:!0,dependencyValidation:!0,enableInitializationGates:!0,systemReadinessTimeout:5e3,phaseTransitionTimeout:1e4},performanceThresholds:{maxTotalMemoryMB:100,maxTotalInitTime:5e3,maxCrossCommLatency:50},coordinationPreferences:{preferSharedResources:!0,enableEventPropagation:!0,enableHealthCoordination:!0}}),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Facade Coordination System initialized successfully"),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing ColorStateManager...");try{this.colorStateManager=Vs,this.colorStateManager.initialized||await this.colorStateManager.initialize(),t.success.push("ColorStateManager"),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] ColorStateManager initialized successfully")}catch(n){console.error("\u{1F30C} [Year3000System] Failed to initialize ColorStateManager:",n),t.failed.push("ColorStateManager")}await this._initializeFacadeSystems()}catch(n){throw console.error("\u{1F30C} [Year3000System] Failed to initialize Facade Coordination System:",n),n}t.success.push("FacadeCoordinationSystem"),this.performanceAnalyzer&&(this.performanceAnalyzer.startMonitoring(),this.performanceGuardActive=!0),this.enhancedMasterAnimationCoordinator?(await this._registerEnhancedAnimationSystems(),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3AC} [Year3000System] Enhanced animation system registration phase complete")):console.warn("[Year3000System] EnhancedMasterAnimationCoordinator not available for enhanced registration phase"),this._initializationResults=t,this.initialized=!0;let i=performance.now();this._lastInitializationTime=i-e,this.YEAR3000_CONFIG.enableDebug&&(console.log(`[Year3000System] System initialization complete in ${this._lastInitializationTime.toFixed(2)}ms.`),console.log(`[Year3000System] Results: ${t.success.length} success, ${t.failed.length} failed.`),t.failed.length>0&&console.warn(`[Year3000System] Failed systems: ${t.failed.join(", ")}`),t.skipped&&t.skipped.length>0&&console.info(`[Year3000System] Skipped systems: ${t.skipped.join(", ")}`),t.success.length>0&&console.info(`[Year3000System] Successful systems: ${t.success.join(", ")}`),this.systemHealthMonitor&&this.systemHealthMonitor.logHealthReport())}async _initializeEssentialFacadeSystems(){if(!this.facadeCoordinator)throw new Error("Facade coordinator not available for essential system initialization");this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing essential systems for degraded mode...");try{let e=["SimplePerformanceCoordinator","UnifiedCSSVariableManager","UnifiedDebugManager","DeviceCapabilityDetector","TimerConsolidationSystem"];for(let t of e)try{let i=await this.facadeCoordinator.getNonVisualSystem(t);i&&typeof i.initialize=="function"&&(await i.initialize(),this.YEAR3000_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] Essential: Initialized ${t} via facade`))}catch(i){console.error(`\u{1F30C} [Year3000System] Failed to initialize essential ${t}:`,i)}this.performanceAnalyzer&&(this.performanceAnalyzer.startMonitoring(),this.performanceGuardActive=!0,this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Essential: Performance monitoring started"))}catch(e){throw console.error("\u{1F30C} [Year3000System] Essential facade system initialization failed:",e),e}}async _initializeFacadeSystems(){if(!this.facadeCoordinator)throw new Error("Facade coordinator not available for system initialization");this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing essential systems through facades...");try{let e=["SimplePerformanceCoordinator","UnifiedDebugManager","SettingsManager","DeviceCapabilityDetector","TimerConsolidationSystem"],t=["UnifiedCSSVariableManager","UnifiedPerformanceCoordinator"],i=["MusicSyncService","ColorHarmonyEngine","GenreGradientEvolution","MusicEmotionAnalyzer"],n=["GlassmorphismManager","Card3DManager"];this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing foundation systems in parallel...");let r=e.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.YEAR3000_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(r),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing dependent systems in parallel...");let a=t.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.YEAR3000_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(a),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing event-driven systems in parallel...");let s=i.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.YEAR3000_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(s),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing UI systems in parallel...");let o=n.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.YEAR3000_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(o);try{await st.initialize(),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] ColorOrchestrator initialized for strategy pattern coordination")}catch(d){console.error("\u{1F3A8} [Year3000System] Failed to initialize ColorOrchestrator:",d)}this.performanceAnalyzer&&(this.performanceAnalyzer.startMonitoring(),this.performanceGuardActive=!0,this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Performance monitoring started"));let l=["Particle","WebGLBackground","SpotifyUIApplication","OrganicBeatSync","HeaderVisualEffects","InteractionTracking"];this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing visual systems in parallel...");let m=l.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=this.facadeCoordinator.getVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.YEAR3000_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 Visual ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize visual ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(m),await this._linkSystemDependencies(),await this._validateFacadeIntegration(),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Facade system initialization complete")}catch(e){throw console.error("\u{1F30C} [Year3000System] Facade system initialization failed:",e),e}}async _validateFacadeIntegration(){this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F50D} [Year3000System] Performing facade integration validation...");let e={cssControllerAlias:!1,strategyPatternSystems:!1,parallelInitialization:!1,facadeHealthCheck:!1,errors:[]};try{if(this.facadeCoordinator){try{let s=await this.facadeCoordinator.getNonVisualSystem("UnifiedCSSVariableManager"),o=await this.facadeCoordinator.getNonVisualSystem("OptimizedCSSVariableManager");s&&o?(e.cssControllerAlias=!0,this.YEAR3000_CONFIG.enableDebug&&console.log("\u2713 [Validation] CSS Controller alias registration working")):e.errors.push("CSS Controller alias registration failed")}catch(s){e.errors.push(`CSS Controller validation error: ${s}`)}let n=["ColorHarmonyEngine","GenreGradientEvolution","MusicEmotionAnalyzer"],r=0;for(let s of n)try{await this.facadeCoordinator.getNonVisualSystem(s)&&r++}catch(o){e.errors.push(`Strategy system ${s} not found: ${o}`)}e.strategyPatternSystems=r===n.length,e.strategyPatternSystems&&this.YEAR3000_CONFIG.enableDebug&&console.log("\u2713 [Validation] Strategy pattern systems registration working");let a=performance.now();try{let s=await this.facadeCoordinator.getNonVisualSystem("PerformanceAnalyzer"),l=performance.now()-a;e.parallelInitialization=l<100,e.parallelInitialization&&this.YEAR3000_CONFIG.enableDebug?console.log(`\u2713 [Validation] Parallel initialization optimization working (${l.toFixed(2)}ms)`):this.YEAR3000_CONFIG.enableDebug&&console.warn(`\u26A0 [Validation] Initialization may be slow (${l.toFixed(2)}ms)`)}catch(s){e.errors.push(`Parallel initialization test failed: ${s}`)}try{let s=await this.facadeCoordinator.performHealthCheck();e.facadeHealthCheck=s.overall==="excellent"||s.overall==="good",e.facadeHealthCheck&&this.YEAR3000_CONFIG.enableDebug?console.log(`\u2713 [Validation] Facade health check passed (${s.overall})`):(e.errors.push(`Facade health check failed: ${s.overall}`),s.recommendations?.length>0&&console.warn("\u{1F527} [Validation] Health recommendations:",s.recommendations))}catch(s){e.errors.push(`Facade health check error: ${s}`)}}else e.errors.push("Facade coordinator not available for validation");let t=4,i=[e.cssControllerAlias,e.strategyPatternSystems,e.parallelInitialization,e.facadeHealthCheck].filter(Boolean).length;this.YEAR3000_CONFIG.enableDebug&&(console.log(`\u{1F50D} [Year3000System] Facade validation complete: ${i}/${t} tests passed`),e.errors.length>0&&console.warn("\u26A0 [Year3000System] Validation errors:",e.errors),i===t&&console.log("\u{1F389} [Year3000System] All facade integration fixes validated successfully!")),window.Y3K_FACADE_VALIDATION=e}catch(t){console.error("\u{1F50D} [Year3000System] Facade validation failed:",t),e.errors.push(`Validation process error: ${t}`)}}async _linkSystemDependencies(){this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Linking system dependencies...");try{if(this.musicSyncService&&this.colorHarmonyEngine&&(this.musicSyncService.setColorHarmonyEngine(this.colorHarmonyEngine),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] ColorHarmonyEngine linked to MusicSyncService")),this.colorHarmonyEngine&&this.enhancedMasterAnimationCoordinator&&(this.colorHarmonyEngine.setEmergentEngine(this.enhancedMasterAnimationCoordinator),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] EnhancedMasterAnimationCoordinator (with emergent functionality) linked to ColorHarmonyEngine")),this.systemHealthMonitor){let e=[{name:"MusicSyncService",system:this.musicSyncService},{name:"ColorHarmonyEngine",system:this.colorHarmonyEngine},{name:"SettingsManager",system:this.settingsManager}];for(let{name:t,system:i}of e)i&&this.systemHealthMonitor.registerSystem(t,i);this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Systems registered with health monitor")}}catch(e){console.error("\u{1F30C} [Year3000System] Failed to link system dependencies:",e)}}_shouldSkipPredictionSystem(e){return!1}async _initializeVisualSystems(e){if(!this.performanceAnalyzer||!this.musicSyncService||!this.settingsManager){console.error("[Year3000System] Cannot initialize visual systems due to missing core dependencies (SimplePerformanceCoordinator, MusicSyncService, or SettingsManager)."),["InteractionTrackingSystem","BeatSyncVisualSystem","SidebarSystemsIntegration"].forEach(i=>e.skipped.push(i));return}this.colorHarmonyEngine&&this.enhancedMasterAnimationCoordinator&&(this.colorHarmonyEngine.setEmergentEngine(this.enhancedMasterAnimationCoordinator),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F517} [Year3000System] EnhancedMasterAnimationCoordinator (emergent functionality) linked to ColorHarmonyEngine."))}async destroyAllSystems(){this.facadeCoordinator&&(await this.facadeCoordinator.destroy(),this.facadeCoordinator=null),this._initializationResults=null,Spicetify.Player&&this._songChangeHandler&&Spicetify.Player.removeEventListener("songchange",this._songChangeHandler),this.initialized=!1,this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F525} [Year3000System] All systems have been destroyed."),document.removeEventListener("year3000SystemSettingsChanged",this._boundExternalSettingsHandler),document.removeEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),document.removeEventListener("visibilitychange",this._boundVisibilityChangeHandler),this._disposeNowPlayingWatcher&&(this._disposeNowPlayingWatcher(),this._disposeNowPlayingWatcher=null)}async applyInitialSettings(e){if(!this.settingsManager){console.warn("[Year3000System] SettingsManager not ready, cannot apply initial settings.");return}this.YEAR3000_CONFIG.enableDebug&&console.log(`\u{1F3A8} [Year3000System] Inside applyInitialSettings. Trigger: ${e||"full"}, SettingsManager valid:`,!!this.settingsManager);try{if(e==="flavor"||e==="brightness"||e==="accent"){console.log(`\u{1F3A8} [Year3000System] Selective update for trigger: ${e}`),await this.updateColorStateOnly(e),await this.refreshColorDependentSystems(e);return}if(console.log("\u{1F3A8} [Year3000System] applyInitialSettings: Getting initial settings..."),this.colorStateManager&&!this.colorStateManager.initialized&&(console.log("\u{1F3A8} [Year3000System] Initializing ColorStateManager..."),await this.colorStateManager.initialize()),this.colorStateManager?.initialized)console.log("\u{1F3A8} [Year3000System] Applying initial color state via ColorStateManager..."),await this.colorStateManager.applyInitialColorState();else{console.warn("\u{1F3A8} [Year3000System] ColorStateManager not available, using legacy color application");let l=this.settingsManager.get("catppuccin-accentColor");l!=="dynamic"&&await this._applyCatppuccinAccent(l)}let t=this.settingsManager.get("sn-gradient-intensity"),i=t,n=this.settingsManager.get("sn-harmonic-intensity"),r=this.settingsManager.get("sn-harmonic-evolution"),a=this.settingsManager.get("sn-current-harmonic-mode");a&&(this.YEAR3000_CONFIG.currentHarmonicMode=String(a)),console.log(`\u{1F3A8} [Year3000System] applyInitialSettings: Gradient=${t}, Stars=${i}, ColorState=${!!this.colorStateManager?.initialized}`),await this._applyStarryNightSettings(t,i);let s=parseFloat(n);Number.isNaN(s)||(this.colorHarmonyEngine&&this.colorHarmonyEngine.setIntensity?.(s),this.YEAR3000_CONFIG.harmonicIntensity=s);let o=r==="true";this.allowHarmonicEvolution=o,this.YEAR3000_CONFIG.harmonicEvolution=o,console.log("\u{1F3A8} [Year3000System] applyInitialSettings: Successfully applied initial settings.")}catch(t){console.error("[Year3000System] Error applying initial settings:",t)}}async updateColorStateOnly(e){if(!this.colorStateManager?.initialized){console.warn(`\u{1F3A8} [Year3000System] ColorStateManager not available for ${e} update`);return}console.log(`\u{1F3A8} [Year3000System] Updating color state for trigger: ${e}`),await this.colorStateManager.updateColorState(e)}async refreshColorDependentSystems(e){if(!this.facadeCoordinator){console.warn(`\u{1F3A8} [Year3000System] No facade coordinator available for ${e} refresh`);return}console.log(`\u{1F3A8} [Year3000System] Refreshing color-dependent systems for trigger: ${e}`),await this.facadeCoordinator.refreshColorDependentSystems(e)}async _applyCatppuccinAccent(e){if(e==="dynamic"){this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] _applyCatppuccinAccent: 'dynamic' accent selected \u2013 skipping static accent overrides.");return}console.log(`\u{1F3A8} [Year3000System] _applyCatppuccinAccent: Applying accent color '${e}'`);let t=e==="none"?"text":e,i=Spicetify.Config.color_scheme||"mocha",n=document.querySelector("body > script.marketplaceScript")?`url('https://github.com/catppuccin/spicetify/blob/main/catppuccin/assets/${i}/equalizer-animated-${t}.gif?raw=true')`:`url('${i}/equalizer-animated-${t}.gif')`;this.cssVariableController?.queueCSSVariableUpdate("--spice-text",`var(--spice-${t})`),this.cssVariableController?.queueCSSVariableUpdate("--spice-button-active",`var(--spice-${t})`),this.cssVariableController?.queueCSSVariableUpdate("--spice-equalizer",n),this.cssVariableController?.flushCSSVariableBatch(),console.log("\u{1F3A8} [Year3000System] _applyCatppuccinAccent: Flushed CSS variables for accent color.")}async _applyStarryNightSettings(e,t){try{Vt(e,t)}catch{console.error("[Year3000System] Failed to apply starry night settings")}}applyColorsToTheme(e={}){let t=e;if(this.colorHarmonyEngine)try{t=this.colorHarmonyEngine.blendWithCatppuccin(e)}catch(r){console.error("[Year3000System] ColorHarmonyEngine blend failed:",r)}let i=t.accentHex||t.VIBRANT||t.PROMINENT||Object.values(t)[0]||"#37416b",n=t.accentRgb||(()=>{let r=this.utils.hexToRgb(i);return r?`${r.r},${r.g},${r.b}`:"166,173,200"})();this._applyColorsViaFacadeSystem(t,i,n)}handleColorHarmonizedEvent(e){if(this.colorEventState.isProcessingColorEvent){this.YEAR3000_CONFIG.enableDebug&&console.warn("\u{1F504} [Year3000System] Already processing color event - skipping to prevent recursion");return}let t=JSON.stringify(e).substring(0,100),i=this._generateEventHash(t),n=Date.now();if(this.colorEventState.processedEvents.has(i)){let r=this.colorEventState.processedEvents.get(i);if(n-r<this.COLOR_EVENT_CACHE_TTL){this.YEAR3000_CONFIG.enableDebug&&console.warn("\u{1F504} [Year3000System] Event recently processed - skipping duplicate");return}}this.colorEventState.isProcessingColorEvent=!0,this.colorEventState.processedEvents.set(i,n),this.colorEventState.eventTimeout=window.setTimeout(()=>{this.YEAR3000_CONFIG.enableDebug&&console.warn("\u{1F504} [Year3000System] Color event processing timeout - resetting state"),this._resetColorEventState()},this.PROCESSING_TIMEOUT);try{if(this.processingState.processingChain.push("handleColorHarmonizedEvent"),this.processingState.processingChain.length>this.MAX_CHAIN_LENGTH){this.processingState.eventLoopDetected=!0,console.error("\u{1F504} [Year3000System] CRITICAL: Event loop detected - chain length exceeded",this.processingState.processingChain),this._resetProcessingState();return}let r,a,s,o,l;if(e.processedColors&&e.accentHex&&e.accentRgb)r=e.processedColors,a=e.accentHex,s=e.accentRgb,o=e.strategies||["ColorHarmonyEngine"],l=e.processingTime||0;else if(e.payload&&e.payload.processedColors)r=e.payload.processedColors,a=e.payload.accentHex||Object.values(r)[0]||"#a6adc8",s=this.utils.hexToRgb(a)?.r+","+this.utils.hexToRgb(a)?.g+","+this.utils.hexToRgb(a)?.b||"166,173,200",o=[e.payload.metadata?.strategy||"Unknown"],l=e.payload.metadata?.processingTime||0;else{if(e.type==="colors/harmonized")return;this.YEAR3000_CONFIG.enableDebug&&console.warn("\u{1F3A8} [Year3000System] Unrecognized colors:harmonized event format:",e);return}this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Processing colors:harmonized event:",{strategies:o,processingTime:l,colorsCount:Object.keys(r).length,accentHex:a,accentRgb:s,chainLength:this.processingState.processingChain.length}),this._applyColorsViaFacadeSystem(r,a,s)}catch(r){console.error("[Year3000System] Failed to handle colors:harmonized event:",r)}finally{this._resetColorEventState();let r=this.processingState.processingChain.indexOf("handleColorHarmonizedEvent");r>-1&&this.processingState.processingChain.splice(r,1)}}_generateEventHash(e){let t=0;for(let i=0;i<e.length;i++){let n=e.charCodeAt(i);t=(t<<5)-t+n,t=t&t}return t.toString()}_resetColorEventState(){this.colorEventState.isProcessingColorEvent=!1,this.colorEventState.eventTimeout&&(clearTimeout(this.colorEventState.eventTimeout),this.colorEventState.eventTimeout=null);let e=Date.now();for(let[t,i]of this.colorEventState.processedEvents.entries())e-i>this.COLOR_EVENT_CACHE_TTL&&this.colorEventState.processedEvents.delete(t)}_resetProcessingState(){this.processingState.isProcessingSongChange=!1,this.processingState.processingChain=[],this.processingState.eventLoopDetected=!1,this.processingState.lastProcessingTime=Date.now(),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F504} [Year3000System] Processing state reset")}_applyColorsViaFacadeSystem(e,t,i){try{let n={};Object.entries(e).forEach(([a,s])=>{if(this.utils.isValidHexColor(s)){let o=this.utils.hexToRgb(s);o&&(n[`--sn-processed-${a.toLowerCase()}-hex`]=s,n[`--sn-processed-${a.toLowerCase()}-rgb`]=`${o.r},${o.g},${o.b}`)}else this.YEAR3000_CONFIG.enableDebug&&console.debug(`[Year3000System] Skipping non-hex processedColor: ${a}=${s}`)});let r={"--sn-musical-harmony-primary-rgb":e.VIBRANT||e.PRIMARY||i,"--sn-musical-harmony-secondary-rgb":e.DARK_VIBRANT||e.SECONDARY||i,"--sn-musical-harmony-tertiary-rgb":e.VIBRANT_NON_ALARMING||e.LIGHT_VIBRANT||i,"--sn-musical-harmony-quaternary-rgb":e.DESATURATED||e.EMOTIONAL_BLEND||i,"--sn-musical-harmony-primary-hex":e.VIBRANT||e.PRIMARY||t,"--sn-musical-harmony-secondary-hex":e.DARK_VIBRANT||e.SECONDARY||t,"--sn-musical-harmony-tertiary-hex":e.VIBRANT_NON_ALARMING||e.LIGHT_VIBRANT||t,"--sn-musical-harmony-quaternary-hex":e.DESATURATED||e.EMOTIONAL_BLEND||t,"--sn-musical-oklab-primary-rgb":e.VIBRANT||e.PRIMARY||e.PROMINENT||i,"--sn-musical-oklab-accent-rgb":e.DARK_VIBRANT||e.DESATURATED||i,"--sn-musical-oklab-highlight-rgb":e.VIBRANT_NON_ALARMING||e.LIGHT_VIBRANT||i,"--sn-musical-oklab-shadow-rgb":e.DARK_VIBRANT||e.DESATURATED||i,"--sn-musical-oklab-complementary-rgb":e.SECONDARY||e.EMOTIONAL_BLEND||i,"--sn-musical-oklab-triadic-rgb":e.LIGHT_VIBRANT||e.VIBRANT_NON_ALARMING||i};Object.entries(r).forEach(([a,s])=>{if(!(!s||typeof s!="string")){if(a.includes("-hex"))n[a]=s;else if(a.includes("-rgb"))if(this.utils.isValidHexColor(s)){let o=this.utils.hexToRgb(s);o&&(n[a]=`${o.r},${o.g},${o.b}`)}else s.includes(",")&&(n[a]=s)}}),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Musical Harmony Color Processing:",{colorHarmonyKeys:Object.keys(e),colorHarmonyValues:e,musicalHarmonyVariables:r,expectedCSSChain:["--sn-musical-oklab-primary-rgb","--sn-musical-harmony-primary-rgb","--sn-gradient-primary-rgb"],totalVariablesSet:Object.keys(n).length,cssAuthorityDelegation:"ColorStateManager + DynamicCatppuccinBridge"}),this.cssVariableController&&typeof this.cssVariableController.batchSetVariables=="function"?this.cssVariableController.batchSetVariables("Year3000System-ColorHarmonized",n,"high","color-harmony-event-application"):this._applyCSSVariables(n),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F527} [Year3000System] Applied musical harmony variables via CSS coordination:",{totalVariables:Object.keys(n).length,accentColor:t,cssControllerUsed:!!this.cssVariableController,spicetifyDelegation:"ColorStateManager + DynamicCatppuccinBridge handle --spice-* variables"})}catch(n){console.error("[Year3000System] Failed to apply musical harmony variables:",n);let r={"--sn-musical-harmony-primary-hex":t,"--sn-musical-harmony-primary-rgb":i};this._applyCSSVariables(r)}}_applyCSSVariables(e){try{let t=document.documentElement;for(let[i,n]of Object.entries(e))i&&n&&t.style.setProperty(i,n);this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Applied CSS variables directly",{variablesCount:Object.keys(e).length,variables:Object.keys(e)})}catch(t){console.error("[Year3000System] Failed to apply CSS variables:",t)}}queueCSSVariableUpdate(e,t,i=null){this.unifiedCSSManager?this.unifiedCSSManager.queueUpdate(e,t,"normal","Year3000System"):this.cssVariableController?this.cssVariableController.queueCSSVariableUpdate(e,t,i||void 0):(i||document.documentElement).style.setProperty(e,t)}setGradientParameters(){this.colorHarmonyEngine}async updateColorsFromCurrentTrack(){this.musicSyncService&&await this.musicSyncService.processSongUpdate()}evolveHarmonicSignature(e,t){if(this.colorHarmonyEngine){let i=this.utils.hexToRgb(t);if(i){let n=this.colorHarmonyEngine.generateHarmonicVariations(i);return{derivedDarkVibrantHex:n.darkVibrantHex,derivedLightVibrantHex:n.lightVibrantHex}}}return null}async waitForTrackData(e=10,t=100){for(let i=0;i<e;i++){if(Spicetify.Player.data?.track?.uri)return Spicetify.Player.data;await this.utils.sleep(t)}return null}updateHarmonicBaseColor(e){if(this.colorHarmonyEngine&&this.cssVariableController){let t=this.utils.hexToRgb(e);if(t){let i=this.colorHarmonyEngine.generateHarmonicVariations(t);this.cssVariableController.queueCSSVariableUpdate("--sn-harmonic-base-dark-vibrant",i.darkVibrantHex),this.cssVariableController.queueCSSVariableUpdate("--sn-harmonic-base-light-vibrant",i.lightVibrantHex),this.cssVariableController.flushCSSVariableBatch()}}}async processColorsViaFacade(e){try{let t=await this.facadeCoordinator?.getNonVisualSystem("ColorOrchestrator");t&&typeof t.handleColorExtraction=="function"?(await t.handleColorExtraction(e),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Color processing routed through facade pattern - ColorOrchestrator",{context:e?.trackUri||"unknown",rawColorsCount:e?.rawColors?Object.keys(e.rawColors).length:0})):this.colorHarmonyEngine&&typeof this.colorHarmonyEngine.processColors=="function"?(await this.colorHarmonyEngine.processColors(e),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Color processing fallback to direct ColorHarmonyEngine")):console.warn("[Year3000System] No color processing system available via facade pattern")}catch(t){console.error("[Year3000System] Failed to process colors via facade pattern:",t),e?.rawColors&&this.applyColorsToTheme(e.rawColors)}}setupMusicAnalysisAndColorExtraction(){if(console.log("\u{1F3B5} [Year3000System] setupMusicAnalysisAndColorExtraction called"),!this.musicSyncService){console.error("[Year3000System] MusicSyncService is not available to set up song change handler.");return}if(console.log("\u{1F3B5} [Year3000System] MusicSyncService available, checking Spicetify Player..."),!window.Spicetify?.Player){console.warn("[Year3000System] Spicetify.Player not available - music analysis disabled");return}try{p.subscribe("colors:harmonized",t=>{this.handleColorHarmonizedEvent(t)},"Year3000System"),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Subscribed to colors:harmonized events for event-driven color application")}catch(t){console.error("[Year3000System] Failed to subscribe to colors:harmonized events:",t)}let e=async()=>{console.log("\u{1F3B5} [Year3000System] processSongUpdate triggered - checking MusicSyncService..."),this.musicSyncService?(console.log("\u{1F3B5} [Year3000System] Calling musicSyncService.processSongUpdate()"),await this.musicSyncService.processSongUpdate(),console.log("\u2705 [Year3000System] musicSyncService.processSongUpdate() completed")):console.error("\u274C [Year3000System] MusicSyncService not available in processSongUpdate")};this._songChangeHandler=e;try{console.log("\u{1F3B5} [Year3000System] Adding songchange event listener..."),window.Spicetify.Player.addEventListener("songchange",this._songChangeHandler),console.log("\u2705 [Year3000System] Music analysis and color extraction set up successfully - song change listener active"),console.log("\u{1F3B5} [Year3000System] Triggering initial song processing..."),setTimeout(e,1e3)}catch(t){console.error("[Year3000System] Failed to set up music analysis:",t),this._songChangeHandler=null}}updateFromMusicAnalysis(e,t,i){e&&this._updateGlobalKinetics(e)}_updateGlobalKinetics(e){let t=this.utils.getRootStyle();if(!t)return;let i=(l,m=0)=>Number.isFinite(l)?l:m,n=i(e.processedEnergy),r=i(e.valence),a=i(e.enhancedBPM),s=i(e.beatInterval),o=i(e.animationSpeedFactor,1);t.style.setProperty("--sn-kinetic-energy",n.toFixed(3)),t.style.setProperty("--sn-kinetic-valence",r.toFixed(3)),t.style.setProperty("--sn-kinetic-bpm",a.toFixed(2)),t.style.setProperty("--sn-kinetic-beat-interval",`${s.toFixed(0)}ms`),t.style.setProperty("--sn-kinetic-animation-speed",o.toFixed(3))}registerAnimationSystem(e,t,i="normal",n=60){return this.enhancedMasterAnimationCoordinator?(this.enhancedMasterAnimationCoordinator.registerAnimationSystem(e,t,i,n),!0):(console.warn(`[Year3000System] Cannot register ${e} - EnhancedMasterAnimationCoordinator not ready`),!1)}unregisterAnimationSystem(e){return this.enhancedMasterAnimationCoordinator?(this.enhancedMasterAnimationCoordinator.unregisterAnimationSystem(e),!0):!1}getSystem(e){if(!e)return null;if(this.facadeCoordinator){let i=this.facadeCoordinator.getVisualSystem(e);if(i)return i;let n=this.facadeCoordinator.getCachedNonVisualSystem(e);if(n)return n}let t=e.charAt(0).toLowerCase()+e.slice(1);if(this[t])return this[t];for(let i of Object.keys(this)){let n=this[i];if(n&&n.constructor?.name===e)return n}return null}async getFacadeSystemHealthStatus(){return this.facadeCoordinator?await this.facadeCoordinator.performHealthCheck():null}async _registerAnimationSystems(){if(!this.enhancedMasterAnimationCoordinator){console.warn("[Year3000System] EnhancedMasterAnimationCoordinator not available for visual system registration");return}let e=[{name:"BeatSyncVisualSystem",system:this.beatSyncVisualSystem,priority:"critical"},{name:"SidebarSystemsIntegration",system:this.sidebarSystemsIntegration,priority:"normal"},{name:"ParticleConsciousnessModule",system:this.particleVisualEffectsModule,priority:"background"},{name:"InteractionTrackingSystem",system:this.interactionTrackingSystem,priority:"background"},{name:"SpotifyUIApplicationSystem",system:this.spotifyUIApplicationSystem,priority:"normal"}];for(let{name:t,system:i,priority:n}of e)if(i&&(typeof i.onAnimate=="function"||typeof i.updateAnimation=="function")){let r=n,a=60,s=i.currentPerformanceProfile;if(s?.frameRate)a=s.frameRate;else if(s?.quality){let o=s.quality;a=o==="high"?60:o==="low"?30:45}t.includes("BeatSync")?r="critical":(t.includes("Particle")||t.includes("DataGlyph"))&&(r="background",a=Math.min(a,30)),this.enhancedMasterAnimationCoordinator.registerAnimationSystem(t,i,r,a),this.YEAR3000_CONFIG.enableDebug&&console.log(`\u{1F3AC} [Year3000System] Registered ${t} with Enhanced Master Animation Coordinator (${r} priority, ${a}fps) - using ${typeof i.onAnimate=="function"?"onAnimate":"updateAnimation"} hook`)}}async _registerEnhancedAnimationSystems(){if(!this.enhancedMasterAnimationCoordinator){console.warn("[Year3000System] EnhancedMasterAnimationCoordinator not available for enhanced visual system registration");return}let e=[{name:"BeatSyncVisualSystem",system:this.beatSyncVisualSystem,priority:"critical",type:"animation"},{name:"SidebarSystemsIntegration",system:this.sidebarSystemsIntegration,priority:"normal",type:"animation"},{name:"ParticleConsciousnessModule",system:this.particleVisualEffectsModule,priority:"background",type:"animation"},{name:"InteractionTrackingSystem",system:this.interactionTrackingSystem,priority:"background",type:"animation"},{name:"SpotifyUIApplicationSystem",system:this.spotifyUIApplicationSystem,priority:"normal",type:"animation"}];for(let{name:t,system:i,priority:n,type:r}of e)if(i)try{let a=!1;r==="animation"&&(typeof i.onAnimate=="function"||typeof i.updateAnimation=="function")&&(a=this.enhancedMasterAnimationCoordinator.registerAnimationSystem(t,i,n,60)),a&&this.YEAR3000_CONFIG.enableDebug?console.log(`\u{1F3AC} [Year3000System] Enhanced registration: ${t} (${n} priority, ${r} type)`):a||console.warn(`[Year3000System] Failed to register ${t} with EnhancedMasterAnimationCoordinator`)}catch(a){console.error(`[Year3000System] Error registering ${t} with EnhancedMasterAnimationCoordinator:`,a)}}async initializeWithAvailableAPIs(e){this.availableAPIs=e,this.YEAR3000_CONFIG.enableDebug&&(console.log(`\u{1F31F} [Year3000System] Progressive initialization mode: ${e.degradedMode?"DEGRADED":"FULL"}`),console.log("\u{1F31F} [Year3000System] Available APIs:",{player:!!e.player,platform:!!e.platform,config:!!e.config})),e.degradedMode?(console.log("\u{1F31F} [Year3000System] Initializing in degraded mode (visual-only systems)"),await this.initializeVisualOnlySystems()):(console.log("\u{1F31F} [Year3000System] Initializing in full mode (all systems)"),await this.initializeAllSystems()),e.degradedMode&&this.setupProgressiveEnhancement()}async initializeVisualOnlySystems(){this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Starting visual-only system initialization...");let e=performance.now(),t={success:[],failed:[],skipped:[]};try{this.facadeCoordinator=new Gt(this.YEAR3000_CONFIG,this.utils,this),await this.facadeCoordinator.initialize({mode:"performance-optimized",enableSharedDependencies:!0,enableCrossFacadeCommunication:!1,enableUnifiedPerformanceMonitoring:!0,enableResourceOptimization:!0,performanceThresholds:{maxTotalMemoryMB:50,maxTotalInitTime:3e3,maxCrossCommLatency:100},coordinationPreferences:{preferSharedResources:!0,enableEventPropagation:!1,enableHealthCoordination:!0}}),await this._initializeEssentialFacadeSystems(),t.success.push("FacadeCoordinationSystem")}catch(a){console.error("\u{1F30C} [Year3000System] Failed to initialize degraded facade system:",a),t.failed.push("FacadeCoordinationSystem")}let i=["SettingsManager","MusicSyncService","ColorHarmonyEngine","GlassmorphismManager","Card3DManager","All Visual Systems"];t.skipped.push(...i),this._initializationResults=t,this.initialized=!0;let r=performance.now()-e;this.YEAR3000_CONFIG.enableDebug&&(console.log(`\u{1F31F} [Year3000System] Visual-only initialization complete in ${r.toFixed(2)}ms`),console.log(`\u{1F31F} [Year3000System] Results: ${t.success.length} success, ${t.failed.length} failed, ${t.skipped.length} skipped`))}setupProgressiveEnhancement(){this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Setting up progressive enhancement monitoring...");let e=0,t=30,i=setInterval(()=>{e++;let n=!!window.Spicetify?.Player,r=!!window.Spicetify?.Platform;n&&r&&this.availableAPIs?.degradedMode&&(this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] APIs now available! Triggering upgrade to full mode..."),clearInterval(i),this.upgradeToFullMode().catch(a=>{console.error("[Year3000System] Upgrade to full mode failed:",a)})),e>=t&&(this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Progressive enhancement monitoring stopped (timeout)"),clearInterval(i))},2e3)}async upgradeToFullMode(){this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Upgrading from degraded mode to full mode..."),this.availableAPIs={player:window.Spicetify?.Player,platform:window.Spicetify?.Platform,config:window.Spicetify?.Config,degradedMode:!1};try{let e={success:[],failed:[],skipped:[]};try{this.systemHealthMonitor&&this.systemHealthMonitor.registerSystem("SettingsManager",this.settingsManager),e.success.push("SettingsManager")}catch(t){e.failed.push("SettingsManager"),console.error("[Year3000System] Failed to upgrade SettingsManager:",t)}if(this.settingsManager)try{}catch{}if(this.performanceAnalyzer&&this.settingsManager){try{}catch{}this.enhancedMasterAnimationCoordinator&&await this._registerAnimationSystems()}this.YEAR3000_CONFIG.enableDebug&&console.log("[Year3000System] Checking music analysis setup conditions:",{musicSyncService:!!this.musicSyncService,playerAPI:!!this.availableAPIs.player,musicSyncInitialized:this.musicSyncService?.initialized}),this.musicSyncService&&this.availableAPIs.player?(console.log("\u{1F3B5} [Year3000System] Setting up music analysis and color extraction..."),this.setupMusicAnalysisAndColorExtraction()):console.warn("\u26A0\uFE0F [Year3000System] Music analysis setup skipped - missing dependencies:",{musicSyncService:!!this.musicSyncService,playerAPI:!!this.availableAPIs.player}),this.settingsManager&&await this.applyInitialSettings(),this.YEAR3000_CONFIG.enableDebug&&(console.log(`\u{1F31F} [Year3000System] Upgrade complete: ${e.success.length} success, ${e.failed.length} failed`),e.failed.length>0&&console.warn(`\u{1F31F} [Year3000System] Upgrade failed systems: ${e.failed.join(", ")}`),e.skipped&&e.skipped.length>0&&console.info(`\u{1F31F} [Year3000System] Upgrade skipped systems: ${e.skipped.join(", ")}`),e.success.length>0&&console.info(`\u{1F31F} [Year3000System] Upgrade successful systems: ${e.success.join(", ")}`))}catch(e){console.error("[Year3000System] Error during upgrade to full mode:",e)}}_handleExternalSettingsChange(e){let{key:t,value:i}=e.detail||{};if(t){switch(t){case"artisticMode":{try{typeof this.YEAR3000_CONFIG.safeSetArtisticMode=="function"&&this.YEAR3000_CONFIG.safeSetArtisticMode(i)}catch(n){console.warn("[Year3000System] Failed to apply artistic mode",n)}break}case"harmonicIntensity":{let n=parseFloat(i);Number.isNaN(n)||(this.YEAR3000_CONFIG.harmonicIntensity=n,this.colorHarmonyEngine&&(this.colorHarmonyEngine.setIntensity?.(n),this.updateColorsFromCurrentTrack?.()));break}case"harmonicEvolution":{let n=i==="true"||i===!0;this.allowHarmonicEvolution=n,this.YEAR3000_CONFIG.harmonicEvolution=n;break}case"manualBaseColor":{typeof i=="string"&&i.trim()!==""&&i.startsWith("#")?(this.updateHarmonicBaseColor(i),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Manual base color applied:",i)):this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Manual base color cleared - using album art colors");break}case"harmonicMode":{i!=null&&(this.YEAR3000_CONFIG.currentHarmonicMode=String(i),this.updateColorsFromCurrentTrack?.());break}default:break}this._broadcastSettingChange(t,i),this._refreshConditionalSystems()}}_broadcastSettingChange(e,t){[this.colorHarmonyEngine,this.glassmorphismManager,this.card3DManager,this.lightweightParticleSystem,this.interactionTrackingSystem,this.beatSyncVisualSystem,this.sidebarSystemsIntegration,this.particleFieldSystem].forEach(n=>{if(n&&typeof n.applyUpdatedSettings=="function")try{n.applyUpdatedSettings(e,t)}catch(r){console.warn(`[Year3000System] ${n.systemName||n.constructor?.name||"UnknownSystem"} failed to applyUpdatedSettings`,r)}})}_applyPerformanceProfile(){}_refreshConditionalSystems(){}_onArtisticModeChanged(){try{this.updateColorsFromCurrentTrack?.()}catch(e){console.warn("[Year3000System] _onArtisticModeChanged stub error",e)}}_handleVisibilityChange(){if(document.visibilityState==="hidden")try{this.cssVariableController?.flushCSSVariableBatch?.();try{}catch{}this.YEAR3000_CONFIG?.enableDebug&&console.log("\u{1F31F} [Year3000System] Visibility hidden \u2192 forced flush of pending style updates")}catch(e){this.YEAR3000_CONFIG?.enableDebug&&console.warn("[Year3000System] VisibilityChange flush error",e)}}async destroy(){try{await this.destroyAllSystems(),document.removeEventListener("visibilitychange",this._handleVisibilityChange.bind(this)),this.initialized=!1,console.log("\u{1F31F} [Year3000System] System destroyed successfully")}catch(e){console.error("\u274C [Year3000System] Error during destroy:",e)}}},Us=new Ht;typeof window<"u"&&(window.year3000System=Us);_s=Us});var Ks={};ie(Ks,{enableDragCartography:()=>Hc,getDragMap:()=>zc});function Hc(){let c=globalThis;c.__SN_dragCartographer||(c.__SN_dragCartographer=new qi,console.info("\u{1F6F0}\uFE0F  DragCartographer enabled \u2013 logging dragstart events"))}function zc(){return qi.getDragMap()}var Ue,qi,js=b(()=>{"use strict";Ue=class Ue{constructor(){this.seen=new WeakSet;this.handleDragStart=e=>{let t=e.target;if(!t||this.seen.has(t))return;this.seen.add(t);let i=Ue.buildSelectorPath(t),n={time:new Date().toLocaleTimeString(),selector:i};try{let s=e.dataTransfer;if(s){let o=s.getData("text/spotify")||s.getData("text/uri-list");o&&(n.uris=o.split(/\n|,/).filter(Boolean));let l=s.getData("text/plain");l&&(n.label=l)}}catch{}let r=Ue.aggregate,a=r.get(i);a?(a.count+=1,a.samples.length<3&&a.samples.push(n)):r.set(i,{selector:i,count:1,samples:[n]}),console.groupCollapsed(`%c[DragCartographer] dragstart \u2192 ${i}`,"color:#7dd3fc;font-weight:600"),console.table(n),console.log("Event:",e),console.log("Target element snapshot:",t),console.groupEnd()};document.addEventListener("dragstart",this.handleDragStart,!0)}static buildSelectorPath(e){let t=[],i=e,n=0;for(;i&&n<Ue.MAX_PATH_DEPTH;){let r=i.tagName.toLowerCase(),a=i.id?`#${i.id}`:"",s=i.className&&typeof i.className=="string"?"."+i.className.split(/\s+/).slice(0,2).join("."):"";t.push(`${r}${a}${s}`),i=i.parentElement,n+=1}return t.join(" > ")}static getDragMap(){return Array.from(Ue.aggregate.values()).sort((e,t)=>t.count-e.count)}};Ue.MAX_PATH_DEPTH=4,Ue.aggregate=new Map;qi=Ue});function Xs(c,e,t={}){let i=`${c}|${e}|${t.size}|${t.dpr}`,n=Qs.get(i);if(n)return n;let r=t.size??72,a=t.dpr??(window.devicePixelRatio||1),s=t.borderRadius??8,o=document.createElement("canvas");o.width=r*a,o.height=r*a,o.style.width=`${r}px`,o.style.height=`${r}px`;let l=o.getContext("2d");l.scale(a,a),l.fillStyle="rgba(32,32,35,0.9)",l.roundRect(0,0,r,r,s),l.fill(),t.shadow!==!1&&(l.shadowColor="rgba(0,0,0,0.4)",l.shadowBlur=6);let m=r-16;if(e){let h=new Image;h.src=e;let g=()=>{l.save(),l.beginPath(),l.roundRect(8,8,m,m,s-2),l.clip(),l.drawImage(h,8,8,m,m),l.restore(),d()};h.complete?g():(h.onload=g,h.onerror=d)}else d();function d(){l.fillStyle="#fff",l.font="500 12px Inter, sans-serif",l.textAlign="center",l.textBaseline="middle";let h=r-10,g=c;for(;l.measureText(g).width>h&&g.length>4;)g=g.slice(0,-2);g!==c&&(g=g.slice(0,-1)+"\u2026"),l.fillText(g,r/2,r-10)}return Qs.set(i,o),o}var Qs,Zs=b(()=>{"use strict";Qs=new Map});var eo={};ie(eo,{enableEnhancedDragPreview:()=>Wc});function Uc(c,e){try{return Xs(c,e)}catch{let t=document.createElement("div");return t.textContent=c,t.style.padding="4px 6px",t.style.fontSize="12px",t.style.background="rgba(32,32,35,0.9)",t.style.color="#fff",t}}function Js(c){let e=c.querySelector("img[src]");if(e?.src)return e.src;let t=getComputedStyle(c).backgroundImage,i=t&&/url\("?([^\"]+)"?\)/.exec(t);return i?i[1]:void 0}function _c(c){let e=c.getAttribute("aria-label")||c.getAttribute("title");return e||(document.createTreeWalker(c,NodeFilter.SHOW_TEXT,{acceptNode(n){return n.textContent?.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}}).nextNode()?.textContent?.trim()||"").slice(0,60)}function Nc(c){if(Mr.has(c))return Mr.get(c);let e=_c(c);if(!e)return null;let t=Js(c),i=t?{label:e,img:t}:{label:e};return Mr.set(c,i),i}function $c(c){try{if(!c.dataTransfer||typeof c.dataTransfer.setDragImage!="function")return;let e=c.target;if(!e)return;let t=c.dataTransfer.getData("text/plain"),i;if(t)i=Js(e);else{let s=Nc(e);if(!s)return;t=s.label,i=s.img}let n=Uc(t,i);document.body.appendChild(n);let r=n.offsetWidth/2;c.dataTransfer.setDragImage(n,r,r);let a=()=>{n.remove(),window.removeEventListener("dragend",a,!0)};window.addEventListener("dragend",a,!0)}catch(e){console.debug("[StarryNight] DragPreviewManager failed:",e)}}function Wc(c={}){let e=globalThis;e.__SN_enhancedDragPreview||(e.__SN_enhancedDragPreview=!0,Object.assign(Oc,c),document.addEventListener("dragstart",$c,!0),console.info("\u{1F320} Enhanced drag preview enabled"))}var Oc,Mr,to=b(()=>{"use strict";Zs();Oc={size:72,borderRadius:8,fontSize:12},Mr=new WeakMap});function Yi(c){let e=c.stiffness??260,t=c.damping??24,i=c.mass??1,n={},r={},a={},s=null;function o(){let l=!0,m=1/60;for(let d in a){let h=n[d]??0,g=r[d]??0,f=a[d]??0,v=-e*(h-f),C=-t*g,P=(v+C)/i,E=g+P*m,L=h+E*m;r[d]=E,n[d]=L,(Math.abs(E)>.1||Math.abs(L-f)>.1)&&(l=!1)}c.onUpdate(n),l||(s=requestAnimationFrame(o))}return{to(l){a=l,s||(s=requestAnimationFrame(o))}}}var wr=b(()=>{"use strict";window.snFlipSpringLoaded=!0});function Er(){let c=document.querySelector(qc);if(!c)return null;let e=c.getBoundingClientRect();return{node:c,rect:e}}function Pr(){let c=!!Er(),e=typeof Element.prototype.cloneNode=="function",t=!!window.snFlipSpringLoaded;return c&&e&&t}var qc,Tr=b(()=>{"use strict";qc='[data-testid="rootlist-container"]'});var ro={};ie(ro,{destroySidebarClone:()=>Ki,launchSidebarClone:()=>Yc});function Yc(c){Ne&&(Ne.abort(),Ne=null),_e&&Ki(),Ne=new AbortController;let{signal:e}=Ne;if(_e)return;let t=Er();if(!t)return;let i=t.node.cloneNode(!0);i.id="",i.setAttribute("aria-hidden","true"),i.classList.add("sn-clone-overlay"),i.style.position="fixed",i.style.top=`${t.rect.top}px`,i.style.left=`${t.rect.left}px`,i.style.width=`${t.rect.width}px`,i.style.height=`${t.rect.height}px`,i.style.zIndex="9999",i.style.willChange="transform, opacity",i.style.contain="paint",function(f){let v=document.createTreeWalker(f,NodeFilter.SHOW_ELEMENT);for(;v.nextNode();){let C=v.currentNode;C.hasAttribute("aria-label")&&C.removeAttribute("aria-label"),C.tabIndex>=0&&(C.tabIndex=-1)}}(i),document.body.appendChild(i),_e=i;let n=0,r=0,a=1,s=c.cursorX-t.rect.left-t.rect.width*.2,o=c.cursorY-t.rect.top-t.rect.height*.2,l=.6;if(window.matchMedia("(prefers-reduced-motion: reduce)").matches){i.style.transform=`translate(${s}px, ${o}px) scale(${l})`,no(i,c);return}let d=Yi({stiffness:220,damping:20,onUpdate:g=>{e.aborted||(i.style.transform=`translate(${g.x}px, ${g.y}px) scale(${g.s})`)}});i.style.transformOrigin="top left",i.style.transform=`translate(${n}px, ${r}px) scale(${a})`,requestAnimationFrame(()=>d.to({x:s,y:o,s:l}));let h=setTimeout(()=>{!e.aborted&&_e&&no(_e,c)},400);e.addEventListener("abort",()=>clearTimeout(h)),e.addEventListener("abort",()=>Ki())}function Ki(){xr.forEach(c=>c()),xr.length=0,_e&&(_e.remove(),_e=null),Ne&&(Ne.abort(),Ne=null)}function Kc(c,e){try{let t=window.Spicetify?.CosmosAsync;if(!t)return;let i=`/v1/playlists/${c.split(":").pop()}/tracks`;t.post(i,{uris:e})}catch{}}function no(c,e){let t=Array.from(c.querySelectorAll('[data-uri^="spotify:playlist:"]'));if(!t.length)return;let i=t.slice(0,5);t.slice(5).forEach(r=>{r.classList.add("sn-prune-out"),setTimeout(()=>r.remove(),180)}),i.forEach((r,a)=>{r.setAttribute("data-index",String(a+1)),r.setAttribute("role","button"),r.tabIndex=0,r.style.setProperty("--sn-glow-level","0"),r.style.backgroundImage="paint(sn-aura)",r.addEventListener("mouseenter",()=>r.style.setProperty("--sn-glow-level","1")),r.addEventListener("mouseleave",()=>r.style.setProperty("--sn-glow-level","0"));let s=r.getAttribute("data-uri");if(!s)return;let o=e.uris,l=m=>{m.preventDefault(),m.stopPropagation();let d=r.querySelector("img");jc(s,d?.src||"",r.textContent?.trim()||"Playlist"),Kc(s,o),Qc("Track added to "+(r.textContent?.trim()||"playlist")),Ki()};r.addEventListener("click",l),r.addEventListener("keydown",m=>{(m.key==="Enter"||m.key===" ")&&l(m)})});let n=r=>{let a=parseInt(r.key,10);a>=1&&a<=i.length&&i[a-1]?.click()};window.addEventListener("keydown",n,{capture:!0}),xr.push(()=>window.removeEventListener("keydown",n,{capture:!0}))}function jc(c,e,t){try{let i=localStorage.getItem(io),n=i?JSON.parse(i):[],r=n.findIndex(a=>a.uri===c);r!==-1&&n.splice(r,1),n.unshift({uri:c,image:e,name:t}),localStorage.setItem(io,JSON.stringify(n.slice(0,10)))}catch{}}function Qc(c){let e=document.getElementById("sn-live");e&&(e.textContent=c)}var _e,xr,Ne,io,ao=b(()=>{"use strict";wr();Tr();_e=null,xr=[],Ne=null,io="sn-recent-playlists"});var oo={};ie(oo,{enableQuickAddRadialMenu:()=>ul});function Jc(){let c=document.getElementById(kr);return c||(c=document.createElement("div"),c.id=kr,c.setAttribute("aria-live","polite"),c.style.position="absolute",c.style.width="1px",c.style.height="1px",c.style.overflow="hidden",c.style.clipPath="inset(100%)",c.style.clip="rect(1px,1px,1px,1px)",c.style.whiteSpace="nowrap",document.body.appendChild(c)),c}function el(c,e,t,i){let n=c-t,r=e-i;return Math.sqrt(n*n+r*r)}function so(){try{let c=localStorage.getItem("sn-recent-playlists");if(!c)return[];let e=JSON.parse(c);return Array.isArray(e)?e.slice(0,ji):[]}catch{return[]}}function tl(c,e){try{let t=`/v1/playlists/${c.split(":").pop()}/tracks`;window.Spicetify?.CosmosAsync.post(t,{uris:e})}catch(t){console.warn("[StarryNight] QuickAddRadial failed to add tracks:",t)}}function il(c){try{let e=so(),t=e.findIndex(n=>n.uri===c.uri);t!==-1&&e.splice(t,1),e.unshift(c);let i=e.slice(0,10);localStorage.setItem("sn-recent-playlists",JSON.stringify(i))}catch{}}function nl(c,e,t){if(!t.length)return;Dr(),ce=document.createElement("div"),ce.className="sn-quick-add-overlay",ce.style.position="fixed",ce.style.inset="0",ce.style.pointerEvents="none",ce.style.zIndex="9999";let i=document.createElement("div");i.className="sn-quick-add-center",i.style.position="absolute",i.style.left=`${c}px`,i.style.top=`${e}px`,i.style.width="0",i.style.height="0",ce.appendChild(i),document.body.appendChild(ce);let n=90,r=Math.PI*2/t.length;t.forEach((s,o)=>{let l=r*o-Math.PI/2,m=document.createElement("button");m.className="sn-quick-add-btn",m.style.position="absolute",m.style.width="64px",m.style.height="64px",m.style.borderRadius="50%",m.style.border="2px solid rgba(255,255,255,0.4)",m.style.background=`url('${s.image}') center/cover no-repeat`,m.style.cursor="pointer",m.style.pointerEvents="auto";let d=n*Math.cos(l),h=n*Math.sin(l);m.style.transform=`translate(${d-32}px, ${h-32}px)`,m.style.transformOrigin="center center";let g=0,f=0;m.style.transform=`translate(${g}px, ${f}px) scale(0.1)`,requestAnimationFrame(()=>{Yi({stiffness:220,damping:20,onUpdate:C=>{m.style.transform=`translate(${C.x}px, ${C.y}px) scale(${C.s})`}}).to({x:d-32,y:h-32,s:1})}),m.title=`Add to ${s.name}`,m.addEventListener("click",v=>{v.preventDefault(),v.stopPropagation(),$t&&tl(s.uri,$t),il(s),Dr()}),i.appendChild(m)});let a=Jc();a.textContent="Quick-add menu open. Press number keys 1 to 5 to pick a playlist or continue dragging."}function Dr(){ce?.remove(),ce=null;let c=document.getElementById(kr);c&&(c.textContent="")}function Lr(){Nt&&(clearTimeout(Nt),Nt=null)}function rl(c){Ar=c.clientX,Ir=c.clientY,$t=(c.dataTransfer?.getData("text/spotify")||"").split(/[\n,]/).filter(Boolean);let e=Pr();Lr(),Nt=window.setTimeout(async()=>{if(e)(await Promise.resolve().then(()=>(ao(),ro))).launchSidebarClone({cursorX:Rr.x,cursorY:Rr.y,uris:$t??[]});else{let t=await ll();nl(Ar,Ir,t)}},Xc)}function al(){Lr(),Dr(),$t=null}function sl(c){Rr={x:c.clientX,y:c.clientY},Nt&&el(Ar,Ir,c.clientX,c.clientY)>Zc&&Lr()}async function ol(){try{let c=window.Spicetify?.CosmosAsync;if(!c)return[];let e=await c.get("https://api.spotify.com/v1/me/playlists?limit=10");return e?.items?e.items.slice(0,ji).map(t=>({uri:t.uri,name:t.name,image:t.images?.[0]?.url||""})):[]}catch{return[]}}function cl(){try{let c=Array.from(document.querySelectorAll('[data-testid="rootlist-card"]')),e=[];for(let t of c){let i=t.getAttribute("data-uri")||t.querySelector("a")?.getAttribute("href")?.replace("/playlist/","spotify:playlist:");if(!i)continue;let n=t.querySelector("img"),r=n?.src||"",a=n?.alt||t.textContent?.trim()||"Playlist";if(e.push({uri:i,image:r,name:a}),e.length>=ji)break}return e}catch{return[]}}async function ll(){let c=so();if(c.length)return c;let e=cl();return e.length?e:await ol()}function ul(){let c=globalThis;c.__SN_quickAddRadial||(c.__SN_quickAddRadial=!0,window.addEventListener("dragstart",rl,!0),window.addEventListener("dragend",al,!0),window.addEventListener("pointermove",sl,!0),console.info("\u{1F30C} Quick-Add radial menu enabled"),console.info(`[StarryNight] Sidebar clone capability: ${Pr()}`))}var Xc,Zc,ji,Nt,Ar,Ir,ce,$t,Rr,kr,co=b(()=>{"use strict";wr();Tr();Xc=250,Zc=8,ji=5,Nt=null,Ar=0,Ir=0,ce=null,$t=null,Rr={x:0,y:0},kr="sn-live";document.addEventListener("keydown",c=>{if(!ce)return;let e=parseInt(c.key,10);e>=1&&e<=ji&&ce.querySelectorAll(".sn-quick-add-btn")[e-1]?.click()})});var uo={};ie(uo,{PrismaticScrollSheenSystem:()=>Qi,initializePrismaticScrollSheen:()=>lo});function lo(){try{let c=new Qi;_s?.registerVisualSystem?.(c,"background")}catch(c){console.error("[PrismaticScrollSheen] Failed to init:",c)}}var ml,Qi,mo=b(()=>{"use strict";Sr();$();ml=6e3,Qi=class{constructor(e=ml){this.cyclePx=e;this.systemName="PrismaticScrollSheen";this._lastRatio=-1;let t=globalThis.year3000System;this.cssController=t?.cssConsciousnessController||T(),this.cssController.setVariable("PrismaticScrollSheenSystem","--sn-scroll-cycle-px",String(e),"normal","scroll-cycle-init")}onAnimate(e,t){let i=t.scrollRatio??0;if(Math.abs(i-this._lastRatio)<.001)return;this._lastRatio=i;let n={"--sn-cdf-scroll-ratio":i.toFixed(4),"--sn-scroll-ratio":i.toFixed(4)};this.cssController.batchSetVariables("PrismaticScrollSheenSystem",n,"high","scroll-ratio-update")}onPerformanceModeChange(){}destroy(){}};window.Y3K?.system?.registerVisualSystem&&lo()});var q,ho,Xi,go=b(()=>{"use strict";q=Nr(Ur("react")),ho=Nr(Ur("react-dom")),Xi=class{constructor(e,t,i={}){this.name=e;this.settingsId=t;this.initialSettingsFields=i;this.settingsFields=this.initialSettingsFields;this.setRerender=null;this.pushSettings=async()=>{for(Object.entries(this.settingsFields).forEach(([e,t])=>{t.type!=="button"&&this.getFieldValue(e)===void 0&&this.setFieldValue(e,t.defaultValue)});!window.Spicetify?.Platform?.History?.listen;)await new Promise(e=>setTimeout(e,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=window.Spicetify.Platform.History.listen(e=>{e.pathname==="/preferences"&&this.render()}),window.Spicetify.Platform.History.location.pathname==="/preferences"&&await this.render()};this.rerender=()=>{this.setRerender?.(Math.random())};this.addDropDown=(e,t,i,n,r,a)=>{this.settingsFields[e]={type:"dropdown",description:t,defaultValue:i[n],options:i,events:a}};this.addToggle=(e,t,i,n)=>{this.settingsFields[e]={type:"toggle",description:t,defaultValue:i,events:n}};this.addInput=(e,t,i,n="text",r)=>{this.settingsFields[e]={type:"input",description:t,defaultValue:i,inputType:n,events:r}};this.getFieldValue=e=>{let t=window.Spicetify?.LocalStorage.get(e);if(t==null){let i=`${this.settingsId}.${e}`,n=window.Spicetify?.LocalStorage.get(i);if(n)try{let a=JSON.parse(n)?.value??n;return window.Spicetify?.LocalStorage.set(e,a),window.Spicetify?.LocalStorage.remove(i),a}catch{return n}return}return t};this.FieldsContainer=()=>{let[e,t]=(0,q.useState)(0);return this.setRerender=t,q.default.createElement("div",{className:"x-settings-section",key:e},q.default.createElement("h2",{className:"TypeElement-cello-textBase-type"},this.name),Object.entries(this.settingsFields).map(([i,n])=>q.default.createElement(this.Field,{key:i,nameId:i,field:n})))};this.Field=({nameId:e,field:t})=>{let i=`${this.settingsId}.${e}`,n=t.type==="button"?t.value:this.getFieldValue(e)??t.defaultValue,[r,a]=(0,q.useState)(n),s=m=>{a(m),this.setFieldValue(e,m);try{let d=new CustomEvent("year3000SystemSettingsChanged",{detail:{key:e,value:m}});document.dispatchEvent(d)}catch(d){console.warn(`[SettingsSection] Failed to emit settings change event for ${e}:`,d)}};if(t.type==="hidden")return q.default.createElement(q.default.Fragment,null);let o=q.default.createElement("label",{className:"TypeElement-viola-textSubdued-type",htmlFor:i},t.description||""),l=null;switch(t.type){case"dropdown":l=q.default.createElement("select",{className:"main-dropDown-dropDown",id:i,...t.events,onChange:m=>{let d=m.currentTarget.selectedIndex,h=t.options[d];s(h),t.events?.onChange?.(m)}},t.options.map((m,d)=>q.default.createElement("option",{key:m,value:m,selected:m===r},m)));break;case"toggle":l=q.default.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},q.default.createElement("input",{id:i,className:"x-toggle-input",type:"checkbox",checked:!!r,...t.events,onClick:m=>{let d=m.currentTarget.checked;s(d),t.events?.onClick?.(m)}}),q.default.createElement("span",{className:"x-toggle-indicatorWrapper"},q.default.createElement("span",{className:"x-toggle-indicator"})));break;case"input":l=q.default.createElement("input",{className:"x-settings-input",id:i,dir:"ltr",value:r,type:t.inputType||"text",...t.events,onChange:m=>{s(m.currentTarget.value),t.events?.onChange?.(m)}});break;case"button":l=q.default.createElement("button",{id:i,className:"Button-sc-y0gtbx-0 Button-small-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button",...t.events,onClick:m=>{t.events?.onClick?.(m)},type:"button"},r);break;default:l=null}return q.default.createElement("div",{className:"x-settings-row"},q.default.createElement("div",{className:"x-settings-firstColumn"},o),q.default.createElement("div",{className:"x-settings-secondColumn"},l))}}async render(){for(;!document.getElementById("desktop.settings.selectLanguage");){if(window.Spicetify.Platform.History.location.pathname!=="/preferences")return;await new Promise(i=>setTimeout(i,100))}let e=document.querySelector(".main-view-container__scroll-node-child main div");if(!e)return console.error("[StarryNight] settings container not found");let t=Array.from(e.children).find(i=>i.id===this.settingsId);t||(t=document.createElement("div"),t.id=this.settingsId,e.appendChild(t)),ho.default.render(q.default.createElement(this.FieldsContainer,null),t)}setFieldValue(e,t){window.Spicetify?.LocalStorage.set(e,t)}}});var Br={};ie(Br,{initializeStarryNightSettings:()=>dl});function po(){return globalThis.year3000System?.cssConsciousnessController||T()}async function dl(){let c=new Xi("StarryNight Theme","starrynight-settings"),e=["dynamic","rosewater","flamingo","pink","mauve","red","maroon","peach","yellow","green","teal","sky","sapphire","blue","lavender"];function t(){let F=window.Y3K?.system?.settingsManager;if(F)return F;let V=globalThis.__SN_settingsManager;if(V)return V;let z=new ee;return globalThis.__SN_settingsManager=z,z}let i=t(),n=i.get("catppuccin-accentColor");c.addDropDown("catppuccin-accentColor","Accent colour (primary theme color)",e,Math.max(0,e.indexOf(n)),void 0,{onChange:F=>{try{let V=F?.currentTarget?.selectedIndex??0,z=e[V]??"mauve";i.set("catppuccin-accentColor",z);let qt=i.get("sn-gradient-intensity");Vt(qt,qt);try{globalThis.Y3K?.system?.applyInitialSettings?.("accent")}catch(Zi){console.warn("[StarryNight] Unable to trigger Year3000System colour refresh",Zi)}}catch(V){console.error("[StarryNight] Failed to update accent colour",V)}}});let r=["disabled","minimal","balanced","intense"],a=i.get("sn-gradient-intensity");c.addDropDown("sn-gradient-intensity","Background effects intensity (stars, nebula, flow gradients)",r,Math.max(0,r.indexOf(a)),void 0,{onChange:F=>{let V=F?.currentTarget?.selectedIndex??0,z=r[V]??"balanced";i.set("sn-gradient-intensity",z),Vt(z,z)}});let s=["bright","balanced","dark"],o=i.get("sn-brightness-mode")||"dark";c.addDropDown("sn-brightness-mode","Brightness mode",s,Math.max(0,s.indexOf(o)),void 0,{onChange:F=>{let V=F?.currentTarget?.selectedIndex??0,z=s[V]??"bright";i.set("sn-brightness-mode",z);let qt=po(),Zi={"--sn-brightness-mode":`"${z}"`,"--sn-brightness-data-attr":z};qt.batchSetVariables("StarryNightSettings",Zi,"high","brightness-mode-change"),document.documentElement.setAttribute("data-sn-brightness",z);try{globalThis.Y3K?.system?.applyInitialSettings?.("brightness"),console.log(`[StarryNight] Brightness mode changed to: ${z}`)}catch(Mo){console.warn("[StarryNight] Unable to trigger Year3000System brightness refresh",Mo)}}});let l=["latte","frappe","macchiato","mocha"],m=i.get("catppuccin-flavor");c.addDropDown("catppuccin-flavor","Catppuccin flavour (light/dark theme base)",l,Math.max(0,l.indexOf(m)),void 0,{onChange:F=>{let V=F?.currentTarget?.selectedIndex??0;i.set("catppuccin-flavor",l[V]);try{globalThis.Y3K?.system?.applyInitialSettings?.("flavor")}catch(z){console.warn("[StarryNight] Unable to trigger flavor refresh",z)}}});let d=["catppuccin","year3000"],h=["Catppuccin Classic","Year 3000 Cinematic"],g=i.get("sn-palette-system");c.addDropDown("sn-palette-system","Palette system (color foundation vs enhancement)",h,Math.max(0,d.indexOf(g)),void 0,{onChange:F=>{let V=F?.currentTarget?.selectedIndex??0;i.set("sn-palette-system",d[V]);try{globalThis.Y3K?.system?.applyInitialSettings?.("palette")}catch(z){console.warn("[StarryNight] Unable to trigger palette system refresh",z)}}});let f=["disabled","minimal","moderate","intense"],v=i.get("sn-glassmorphism-level");c.addDropDown("sn-glassmorphism-level","Glassmorphism",f,Math.max(0,f.indexOf(v)),void 0,{onChange:F=>{let V=F?.currentTarget?.selectedIndex??0;i.set("sn-glassmorphism-level",f[V])}});let C=["corporate-safe","artist-vision","cosmic-maximum"],P=i.get("sn-artistic-mode");c.addDropDown("sn-artistic-mode","Artistic mode",C,Math.max(0,C.indexOf(P)),void 0,{onChange:F=>{let V=F?.currentTarget?.selectedIndex??0,z=C[V];i.set("sn-artistic-mode",z),globalThis.year3000System?.YEAR3000_CONFIG?.safeSetArtisticMode?.(z)}});let E=Object.keys(be),L=i.get("sn-current-harmonic-mode");E.length&&c.addDropDown("sn-current-harmonic-mode","Harmonic colour mode",E,Math.max(0,E.indexOf(L)),void 0,{onChange:F=>{let V=F?.currentTarget?.selectedIndex??0,z=E[V];i.set("sn-current-harmonic-mode",z),globalThis.Y3K?.system?.evolveHarmonicSignature?.(z)}});let _=i.get("sn-harmonic-intensity")||"0.7";c.addInput("sn-harmonic-intensity","Harmonic intensity (music-color sync strength 0-1)",_,"number",{onChange:F=>{let V=F.currentTarget.value;i.set("sn-harmonic-intensity",V)}});let G=i.get("sn-harmonic-evolution")==="true";c.addToggle("sn-harmonic-evolution","Allow harmonic evolution",G,{onClick:F=>{let V=F.currentTarget.checked;i.set("sn-harmonic-evolution",V?"true":"false")}});let B=i.get("sn-webgl-enabled")==="true";c.addToggle("sn-webgl-enabled","WebGL effects (master toggle for all WebGL backgrounds)",B,{onClick:F=>{let V=F.currentTarget.checked;i.set("sn-webgl-enabled",V?"true":"false")}});let W=["low","medium","high"],O=i.get("sn-webgl-quality")||"medium";c.addDropDown("sn-webgl-quality","WebGL quality (performance vs visual quality)",W,Math.max(0,W.indexOf(O)),void 0,{onChange:F=>{let V=F?.currentTarget?.selectedIndex??1,z=W[V]??"medium";i.set("sn-webgl-quality",z)}});let I=["auto","low","high"],re=i.get("sn-animation-quality")||"auto";c.addDropDown("sn-animation-quality","Animation quality (auto/low/high performance)",I,Math.max(0,I.indexOf(re)),void 0,{onChange:F=>{let V=F?.currentTarget?.selectedIndex??0,z=I[V]??"auto";i.set("sn-animation-quality",z)}}),await c.pushSettings(),console.log("\u2728 [StarryNight] spcr-settings panel initialised");let Te=i.get("sn-brightness-mode")||"dark",ge=po(),Ze={"--sn-brightness-mode":`"${Te}"`,"--sn-brightness-data-attr":Te};ge.batchSetVariables("StarryNightSettings",Ze,"high","brightness-mode-init"),document.documentElement.setAttribute("data-sn-brightness",Te),console.log(`[StarryNight] Initial brightness mode set to: ${Te}`);let zr=()=>c.rerender(),Or=globalThis.Spicetify?.Platform?.History;try{Or?.listen&&Or.listen(({location:F})=>{F?.pathname==="/settings"&&setTimeout(zr,100)})}catch(F){console.warn("[StarryNight] Could not hook navigation for settings",F)}window.location.pathname==="/settings"&&setTimeout(zr,300)}var Fr=b(()=>{"use strict";U();$();go();De();yr()});var fo={};ie(fo,{DepthConsciousnessController:()=>Gr});var Gr,bo=b(()=>{"use strict";U();$();R();K();de();Gr=class extends Q{constructor(t=w,i=A,n=null,r=null,a=null){super(t,i,n,r,a);this.contentAreas=new Map;this.chromeAreas=new Set;this.userState={isScrolling:!1,isHovering:!1,lastInteractionTime:0,readingModeActive:!1,interactionTarget:null,currentMode:"browsing",focusDepth:.3,scrollVelocity:0,dwellTime:0,interactionPattern:"casual",contentEngagement:.5};this.musicalState={energy:.5,valence:.5,instrumental:!1,tempo:120,emotionalTemperature:.5,musicSyncStrength:.7,genreConsciousnessProfile:{ambientLevel:.5,energyResponse:.6,visualComplexity:.5},musicalMemoryPatterns:.4};this.readingModeTimer=0;this.interactionTimer=0;this.consciousnessUpdateInterval=0;this.lastUpdate=0;this.updateThreshold=100;this.consciousnessIntensity=.7;this.adaptiveProtectionMap=new Map;this.scrollVelocityHistory=[];this.dwellTimeTracker=new Map}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{let t=globalThis.year3000System;this.cssController=t?.cssConsciousnessController||T(),this.detectContentAndChromeAreas(),this.setupInteractionListeners(),this.initializeConsciousnessVariables(),this.startConsciousnessUpdate(),u?.debug?.log("DepthConsciousnessController","Consciousness system awakened")}catch(t){u?.debug?.error("DepthConsciousnessController","Failed to initialize consciousness:",t)}}detectContentAndChromeAreas(){let t={text:[".main-view-container__scroll-node",".main-trackList-trackListRow",'[data-testid*="tracklist"]','[data-testid*="playlist"]',".main-entityHeader-titleText",".main-entityHeader-subtitle",".main-trackList-rowTitle",".main-trackList-rowSubTitle","h1, h2, h3, h4, h5, h6","p",".lyrics-lyricsContainer-container",".main-cardSubHeader-root",".main-trackList-indexNumber",".main-trackInfo-name",".main-trackInfo-artists"],interactive:["button","a[role='button']","[tabindex='0']",".main-playButton-button",".main-addButton-button",".main-moreButton-button",".main-trackList-rowPlayPause",".control-button","input","select"],visual:[".main-image-container",".main-entityHeader-image",".cover-art",".main-coverSlot-container",".main-image-image"],media:["video","audio",".main-nowPlayingWidget-trackInfo",".main-coverSlot-container",".main-nowPlayingView-coverArt"],navigation:[".main-navBar-navBarLink",".main-rootlist-rootlistItem",".main-collectionLinkText-text"]},i=[".Root__nav-bar",".Root__top-bar",".Root__now-playing-bar",".main-topBar-container",".main-navBar-navBar",".main-entityHeader-container",".main-actionBar-container",".main-view-container",".Root__main-view",".main-rootlist-wrapper"];Object.entries(t).forEach(([r,a])=>{a.forEach(s=>{document.querySelectorAll(s).forEach(o=>{let l={element:o,type:r,protectionLevel:this.calculateAdvancedProtectionLevel(o,r),lastInteraction:0,consciousnessLevel:this.calculateConsciousnessLevel(o),readingIntensity:0,contextualImportance:this.calculateContextualImportance(o),adaptiveProtection:this.calculateProtectionLevel(o)};this.contentAreas.set(o,l),o.classList.add("content-sanctuary"),o.classList.add(`content-${r}`),o.setAttribute("data-consciousness-protected","true"),o.setAttribute("data-content-type",l.type),o.setAttribute("data-consciousness-level",l.consciousnessLevel.toString()),o.setAttribute("data-contextual-importance",l.contextualImportance.toString()),this.adaptiveProtectionMap.set(o,l.adaptiveProtection),this.dwellTimeTracker.set(o,0)})})}),i.forEach(r=>{document.querySelectorAll(r).forEach(a=>{this.chromeAreas.add(a),a.classList.add("ui-chrome-area"),a.setAttribute("data-consciousness-enhanced","true")})});let n=this.analyzeContentDistribution();u?.debug?.log("DepthConsciousnessController",`Enhanced detection: ${this.contentAreas.size} content areas, ${this.chromeAreas.size} chrome areas`,n)}determineContentType(t){return t.matches("h1, h2, h3, h4, h5, h6, .main-entityHeader-titleText")?"text":t.matches('button, a, [role="button"], [tabindex], input, select')?"interactive":t.matches(".main-image-container, .main-entityHeader-image, .cover-art")?"visual":t.matches(".Root__nav-bar, .Root__top-bar, .main-topBar-container")?"chrome":"text"}calculateProtectionLevel(t){switch(this.determineContentType(t)){case"text":return .95;case"interactive":return .9;case"visual":return .6;case"chrome":return .3;case"media":return .5;case"navigation":return .7;default:return .85}}calculateAdvancedProtectionLevel(t,i){let n=this.calculateProtectionLevel(t),r=0;i==="text"&&t.textContent&&t.textContent.length>50&&(r+=.05);let a=t.getBoundingClientRect();return a.top>=0&&a.left>=0&&a.bottom<=window.innerHeight&&a.right<=window.innerWidth&&(r+=.02),t.matches('h1, h2, .main-entityHeader-titleText, [data-testid*="title"]')&&(r+=.03),Math.min(n+r,.98)}calculateConsciousnessLevel(t){let i=t.getBoundingClientRect(),n=i.width*i.height,r=window.innerWidth*window.innerHeight,a=n/r,s=Math.min(a*2,.8);return t.matches(".Root__main-view, .main-view-container")&&(s+=.3),t.matches(".main-nowPlayingBar-container")&&(s+=.4),Math.min(s,1)}calculateContextualImportance(t){let i=.5;return t.matches('button, a, [role="button"], [tabindex="0"]')&&(i+=.2),t.matches(".main-view-container, .main-entityHeader, .main-trackList")&&(i+=.3),t.matches(".main-nowPlayingWidget, .main-nowPlayingBar")&&(i+=.4),t.matches(":focus, :focus-within, :hover")&&(i+=.2),Math.min(i,1)}analyzeContentDistribution(){let t={totalAreas:this.contentAreas.size,textAreas:0,interactiveAreas:0,visualAreas:0,mediaAreas:0,navigationAreas:0,chromeAreas:this.chromeAreas.size,averageProtection:0,highProtectionAreas:0},i=0;return this.contentAreas.forEach(n=>{switch(n.type){case"text":t.textAreas++;break;case"interactive":t.interactiveAreas++;break;case"visual":t.visualAreas++;break;case"media":t.mediaAreas++;break;case"navigation":t.navigationAreas++;break}i+=n.protectionLevel,n.protectionLevel>.8&&t.highProtectionAreas++}),t.averageProtection=i/this.contentAreas.size||0,t}analyzeScrollingBehavior(){if(this.scrollVelocityHistory.length<3)return;let t=this.scrollVelocityHistory.reduce((n,r)=>n+r,0)/this.scrollVelocityHistory.length,i=this.scrollVelocityHistory.reduce((n,r)=>n+Math.pow(r-t,2),0)/this.scrollVelocityHistory.length;i<100&&t<300?(this.userState.contentEngagement=Math.min(this.userState.contentEngagement+.05,1),this.userState.interactionPattern="contemplative"):t>1500&&i>500?(this.userState.contentEngagement=Math.max(this.userState.contentEngagement-.1,.1),this.userState.interactionPattern="rapid"):this.userState.interactionPattern="casual",this.userState.contentEngagement>.7?this.consciousnessIntensity=Math.min(this.consciousnessIntensity+.05,.9):this.userState.contentEngagement<.3&&(this.consciousnessIntensity=Math.max(this.consciousnessIntensity-.1,.3))}calculateInteractionModifier(){let t=0;if(this.userState.readingModeActive&&(t-=.6),this.userState.isHovering){let i=this.contentAreas.get(this.userState.interactionTarget);if(i){let n=i.type==="text"?.4:i.type==="interactive"?.3:i.type==="chrome"?.1:.2;t-=n}}return this.userState.scrollVelocity>1e3&&(t-=.2),this.userState.focusDepth>.7&&!this.userState.readingModeActive&&(t+=.2),t}calculateContextualModifier(){let t=0;return this.userState.interactionTarget?.matches(".main-nowPlayingBar, .main-nowPlayingWidget")&&(t+=.3),this.userState.interactionTarget?.matches(".main-trackList, .main-entityHeader-subtitle")&&(t-=this.userState.currentMode==="exploring"?.1:.3),this.userState.currentMode==="ambient"&&(t+=.4),this.userState.currentMode==="navigating"&&(t-=.2),t}getModeNumericValue(t){return{reading:0,browsing:1,exploring:2,navigating:3,ambient:4}[t]/4}getPatternNumericValue(t){return{contemplative:0,casual:1,deliberate:2,rapid:3}[t]/3}calculateMembraneFluidityIndex(){let t=.5;return t+=this.musicalState.energy*.3,t+=this.userState.contentEngagement*.2,t+=this.musicalState.emotionalTemperature*.2,this.userState.interactionPattern==="contemplative"?t-=.2:this.userState.interactionPattern==="rapid"&&(t+=.3),Math.max(.1,Math.min(1,t))}calculateGenreConsciousnessShift(){if(!this.musicalState.genre)return .5;let i={ambient:.8,electronic:.7,classical:.6,jazz:.5,rock:.4,pop:.3,"hip-hop":.2}[this.musicalState.genre.toLowerCase()]||.5,n=0;return this.musicalState.valence>.7&&(n+=.1),this.musicalState.energy>.8&&(n+=.1),Math.max(.1,Math.min(1,i+n))}setupInteractionListeners(){let t,i=window.scrollY,n=Date.now();document.addEventListener("scroll",()=>{let s=Date.now(),o=window.scrollY,l=s-n,m=Math.abs(o-i);this.userState.scrollVelocity=l>0?m/l*1e3:0,this.scrollVelocityHistory.push(this.userState.scrollVelocity),this.scrollVelocityHistory.length>10&&this.scrollVelocityHistory.shift();let d=this.scrollVelocityHistory.reduce((h,g)=>h+g,0)/this.scrollVelocityHistory.length;d>2e3?(this.userState.interactionPattern="rapid",this.userState.currentMode="browsing"):d>500?(this.userState.interactionPattern="deliberate",this.userState.currentMode="exploring"):this.userState.interactionPattern="contemplative",this.userState.isScrolling=!0,this.userState.lastInteractionTime=s,i=o,n=s,clearTimeout(t),t=window.setTimeout(()=>{this.userState.isScrolling=!1,this.analyzeScrollingBehavior()},150),this.updateUserInteractionState()},{passive:!0}),this.contentAreas.forEach((s,o)=>{let l=0;o.addEventListener("mouseenter",()=>{l=Date.now(),this.userState.isHovering=!0,this.userState.interactionTarget=o,this.userState.lastInteractionTime=l,s.lastInteraction=l,this.dwellTimeTracker.set(o,l),this.userState.focusDepth=Math.min(this.userState.focusDepth+.1,1),s.type==="text"&&(this.userState.focusDepth=Math.min(this.userState.focusDepth+.2,1)),this.updateUserInteractionState()}),o.addEventListener("mouseleave",()=>{let d=Date.now()-l;if(this.userState.dwellTime=d,s.readingIntensity=Math.min(d/5e3,1),s.type==="text"&&d>1e3&&(this.userState.contentEngagement=Math.min(this.userState.contentEngagement+.1,1),s.contextualImportance=Math.min(s.contextualImportance+.05,1)),d>3e3){let h=this.adaptiveProtectionMap.get(o)||s.protectionLevel;this.adaptiveProtectionMap.set(o,Math.min(h+.05,.98))}this.userState.isHovering=!1,this.userState.interactionTarget=null,this.userState.focusDepth=Math.max(this.userState.focusDepth-.05,.1),this.updateUserInteractionState()})}),document.addEventListener("mousemove",()=>{clearTimeout(this.readingModeTimer),this.userState.readingModeActive=!1,this.userState.focusDepth>.7?this.userState.currentMode="reading":this.userState.scrollVelocity>1e3?this.userState.currentMode="browsing":this.userState.currentMode="exploring";let s=this.userState.currentMode==="reading"?1500:2e3;this.readingModeTimer=window.setTimeout(()=>{if(this.userState.interactionTarget&&this.contentAreas.has(this.userState.interactionTarget)){this.userState.readingModeActive=!0,this.userState.currentMode="reading",this.userState.focusDepth=Math.min(this.userState.focusDepth+.3,1);let o=this.contentAreas.get(this.userState.interactionTarget);if(o&&o.type==="text"){let l=this.adaptiveProtectionMap.get(this.userState.interactionTarget)||o.protectionLevel;this.adaptiveProtectionMap.set(this.userState.interactionTarget,Math.min(l+.1,.98))}this.updateUserInteractionState()}},s)});let r,a=()=>{clearTimeout(r),r=window.setTimeout(()=>{this.userState.currentMode="ambient",this.userState.focusDepth=Math.max(this.userState.focusDepth-.5,.1),this.updateUserInteractionState()},3e4)};["mousedown","mousemove","keydown","scroll","touchstart"].forEach(s=>{document.addEventListener(s,a,{passive:!0})}),a(),document.addEventListener("music-state-change",s=>{let o=s;o.detail&&this.syncWithMusic(o.detail)}),document.addEventListener("beat-detected",()=>{this.handleBeatPulse()})}initializeConsciousnessVariables(){let t={"--consciousness-system-active":"1","--content-protection-level":"0.95","--chrome-enhancement-level":"2.0","--consciousness-breath-rate":"4s","--musical-sync-intensity":"0.5","--reading-mode-active":"0","--user-interaction-detected":"0"};this.cssController.batchSetVariables("DepthConsciousnessController",t,"normal","consciousness-initialization")}startConsciousnessUpdate(){let t=()=>{if(!this.isActive)return;let i=performance.now();i-this.lastUpdate>=this.updateThreshold&&(this.updateConsciousnessState(),this.lastUpdate=i),requestAnimationFrame(t)};t()}updateConsciousnessState(){let t=document.documentElement,i=this.consciousnessIntensity,n=this.musicalState.energy*this.musicalState.musicSyncStrength*.3,r=this.calculateInteractionModifier(),a=this.calculateContextualModifier(),s=this.musicalState.emotionalTemperature*.2,l={"--consciousness-intensity":Math.max(.05,Math.min(1,i+n+r+a+s)).toString(),"--consciousness-level":this.consciousnessIntensity.toString(),"--awareness-level":this.userState.focusDepth.toString(),"--musical-sync-intensity":this.musicalState.energy.toString(),"--musical-sync-strength":this.musicalState.musicSyncStrength.toString(),"--sn-color-temperature":this.musicalState.emotionalTemperature.toString(),"--reading-mode-active":this.userState.readingModeActive?"1":"0","--user-interaction-detected":this.userState.isScrolling||this.userState.isHovering?"1":"0","--current-interaction-mode":this.getModeNumericValue(this.userState.currentMode).toString(),"--focus-depth":this.userState.focusDepth.toString(),"--content-engagement":this.userState.contentEngagement.toString(),"--scroll-velocity":Math.min(this.userState.scrollVelocity/2e3,1).toString(),"--dwell-time-factor":Math.min(this.userState.dwellTime/5e3,1).toString(),"--interaction-pattern":this.getPatternNumericValue(this.userState.interactionPattern).toString(),"--temporal-flow-direction-x":(Math.sin(Date.now()*1e-4)*.5+.5).toString(),"--temporal-flow-direction-y":(Math.cos(Date.now()*1e-4)*.5+.5).toString(),"--memory-intensity":this.musicalState.musicalMemoryPatterns.toString(),"--sn-fluidity-index":this.calculateMembraneFluidityIndex().toString(),"--genre-consciousness-shift":this.calculateGenreConsciousnessShift().toString()};this.cssController.batchSetVariables("DepthConsciousnessController",l,"normal","consciousness-state-update"),t.classList.remove("music-energy-high","music-energy-calm"),this.musicalState.energy>.7?t.classList.add("music-energy-high"):this.musicalState.energy<.3&&t.classList.add("music-energy-calm"),t.setAttribute("data-user-interacting",(this.userState.isScrolling||this.userState.isHovering).toString()),t.setAttribute("data-reading-mode",this.userState.readingModeActive.toString())}updateUserInteractionState(){this.updateConsciousnessState()}syncWithMusic(t){if(Object.assign(this.musicalState,t),t.tempo){let i=Math.max(2,Math.min(8,60/(t.tempo/60)*4));this.cssController.setVariable("DepthConsciousnessController","--consciousness-breath-rate",`${i}s`,"high","musical-tempo-sync")}this.updateConsciousnessState(),u?.debug?.log("DepthConsciousnessController",`Musical consciousness sync: energy=${t.energy}, tempo=${t.tempo}`)}handleBeatPulse(){if(this.userState.readingModeActive)return;let t=document.documentElement,i=parseFloat(t.style.getPropertyValue("--consciousness-intensity")||"0.5"),n=Math.min(1,i+.1);this.cssController.setVariable("DepthConsciousnessController","--consciousness-intensity",n.toString(),"high","beat-pulse"),setTimeout(()=>{this.isActive&&this.updateConsciousnessState()},100)}protectNewContent(t){if(this.contentAreas.has(t))return;let i={element:t,type:this.determineContentType(t),protectionLevel:this.calculateProtectionLevel(t),lastInteraction:0,consciousnessLevel:.5,readingIntensity:0,contextualImportance:this.calculateProtectionLevel(t),adaptiveProtection:.5};this.contentAreas.set(t,i),t.classList.add("content-sanctuary"),t.setAttribute("data-consciousness-protected","true"),t.setAttribute("data-content-type",i.type),u?.debug?.log("DepthConsciousnessController",`Protected new content element: ${t.tagName}.${t.className}`)}enhanceNewChrome(t){this.chromeAreas.has(t)||(this.chromeAreas.add(t),t.classList.add("ui-chrome-area"),t.setAttribute("data-consciousness-enhanced","true"),u?.debug?.log("DepthConsciousnessController",`Enhanced new chrome element: ${t.tagName}.${t.className}`))}forceReadingMode(t){this.userState.readingModeActive=t,this.updateUserInteractionState(),u?.debug?.log("DepthConsciousnessController",`Reading mode ${t?"activated":"deactivated"}`)}getConsciousnessMetrics(){return{contentAreas:this.contentAreas.size,chromeAreas:this.chromeAreas.size,consciousnessIntensity:parseFloat(document.documentElement.style.getPropertyValue("--consciousness-intensity")||"0.5"),readingModeActive:this.userState.readingModeActive,userInteracting:this.userState.isScrolling||this.userState.isHovering,musicalEnergy:this.musicalState.energy}}async healthCheck(){let t=this.getConsciousnessMetrics(),i=t.contentAreas>0&&t.chromeAreas>0;return{healthy:i,issues:i?[]:["Consciousness system not properly initialized"],metrics:{consciousnessLevel:t.contentAreas>0?1:0,protectedAreas:t.contentAreas,enhancedAreas:t.chromeAreas,musicalEnergy:t.musicalEnergy}}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),clearTimeout(this.readingModeTimer),clearTimeout(this.interactionTimer),this.contentAreas.forEach((n,r)=>{r.classList.remove("content-sanctuary"),r.removeAttribute("data-consciousness-protected"),r.removeAttribute("data-content-type")}),this.chromeAreas.forEach(n=>{n.classList.remove("ui-chrome-area"),n.removeAttribute("data-consciousness-enhanced")});let t={"--consciousness-system-active":"","--consciousness-intensity":"","--reading-mode-active":"","--user-interaction-detected":"","--consciousness-breath-rate":"","--musical-sync-intensity":"","--content-protection-level":"","--chrome-enhancement-level":""};this.cssController.batchSetVariables("DepthConsciousnessController",t,"critical","system-cleanup");let i=document.documentElement;i.classList.remove("music-energy-high","music-energy-calm"),i.removeAttribute("data-user-interacting"),i.removeAttribute("data-reading-mode"),u?.debug?.log("DepthConsciousnessController","Consciousness system deactivated")}}});var yo={};ie(yo,{DynamicCatppuccinBridge:()=>Vr});var Vr,So=b(()=>{"use strict";U();D();$();R();K();de();Vr=class extends Q{constructor(t=w,i=A,n=null,r=null,a=null){super(t,i,n,r,a);this.colorHarmonyEngine=null;this.depthConsciousnessController=null;this.dynamicColorState={currentAccentHex:"#675c8f",currentAccentRgb:"203,166,247",baseBackgroundHex:"#0d1117",baseBackgroundRgb:"13,17,23",lastUpdateTime:0,musicEnergy:.5,transitionInProgress:!1};this.integrationConfig={accentUpdateEnabled:!0,baseTransformationEnabled:!0,consciousnessIntegrationEnabled:!0,smoothTransitionDuration:800,energyResponseMultiplier:1.2};this.transitionTimer=0;this.lastTransitionStartTime=0;this.transitionFromAccent="";this.transitionToAccent=""}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{let t=globalThis.year3000System;this.cssController=t?.cssConsciousnessController||T(),this.setupColorExtractionListeners(),this.setupSettingsListeners(),this.initializeCurrentState();let i=this.checkDynamicAccentEnabled();this.integrationConfig.accentUpdateEnabled=i,i?u?.debug?.log("DynamicCatppuccinBridge","Dynamic accent enabled - bridge active"):u?.debug?.log("DynamicCatppuccinBridge","Dynamic accent disabled - bridge standby (will activate when enabled)"),u?.debug?.log("DynamicCatppuccinBridge","Color Extension Facade initialized successfully")}catch(t){u?.debug?.error("DynamicCatppuccinBridge","Failed to initialize facade:",t)}}checkDynamicAccentEnabled(){try{if(!this.settingsManager)return!1;let t=this.settingsManager.get("catppuccin-accentColor"),i=String(t)==="dynamic";return this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinBridge",`Accent setting: ${t}, Dynamic: ${i}`),i}catch(t){return u?.debug?.error("DynamicCatppuccinBridge","Error checking dynamic accent setting:",t),!1}}setupColorExtractionListeners(){p.subscribe("colors:extracted",t=>{t.rawColors&&this.handleExtractedColors(t.rawColors)},"DynamicCatppuccinBridge"),p.subscribe("colors:harmonized",t=>{t.processedColors&&this.handleHarmonizedColors(t.processedColors)},"DynamicCatppuccinBridge"),p.subscribe("colors:applied",t=>{t.cssVariables&&this.integrationConfig.accentUpdateEnabled&&this.handleCSSVariablesApplied(t.cssVariables,t.accentHex,t.accentRgb)},"DynamicCatppuccinBridge"),document.addEventListener("colors-extracted",t=>{let i=t;i.detail&&i.detail.extractedColors&&this.handleExtractedColors(i.detail.extractedColors)}),document.addEventListener("colors-harmonized",t=>{let i=t;i.detail&&i.detail.harmonizedColors&&this.handleHarmonizedColors(i.detail.harmonizedColors)}),document.addEventListener("music-state-change",t=>{let i=t;i.detail&&this.handleMusicStateChange(i.detail)}),document.addEventListener("spice-colors/update-request",t=>{let i=t;i.detail&&this.integrationConfig.accentUpdateEnabled&&this.handleSpiceColorUpdateRequest(i.detail)}),u?.debug?.log("DynamicCatppuccinBridge","Enhanced color extraction and coordination listeners setup complete (UnifiedEventBus + DOM)")}handleSpiceColorUpdateRequest(t){let{accentHex:i,primaryHex:n,secondaryHex:r,source:a}=t;this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinBridge",`Received spice color update request from ${a}:`,{accent:i,primary:n,secondary:r}),i&&i!==this.dynamicColorState.currentAccentHex&&this.scheduleSmoothAccentTransition(i),n&&this.updateLivingBaseBackground(n),document.dispatchEvent(new CustomEvent("spice-colors/updated",{detail:{source:"DynamicCatppuccinBridge",applied:{accent:i,primary:n,secondary:r},timestamp:Date.now()}}))}setupSettingsListeners(){document.addEventListener("year3000SystemSettingsChanged",t=>{let i=t,{key:n,value:r}=i.detail||{};if(n==="catppuccin-accentColor"){let a=String(r)==="dynamic";this.integrationConfig.accentUpdateEnabled=a,a&&!this.isActive?this.initialize():!a&&this.isActive&&this.destroy(),u?.debug?.log("DynamicCatppuccinBridge",`Accent setting changed to: ${r}, Bridge active: ${this.isActive}`)}})}initializeCurrentState(){let t=document.documentElement,i=getComputedStyle(t),n=i.getPropertyValue("--sn-accent-hex").trim()||i.getPropertyValue("--sn-musical-harmony-primary-hex").trim()||i.getPropertyValue("--sn-dynamic-accent-hex").trim()||i.getPropertyValue("--sn-cosmic-accent-hex").trim()||i.getPropertyValue("--spice-accent").trim();if(n){this.dynamicColorState.currentAccentHex=n;let s=this.utils.hexToRgb(n);s&&(this.dynamicColorState.currentAccentRgb=`${s.r},${s.g},${s.b}`)}let r=i.getPropertyValue("--sn-cosmic-base-hex").trim()||i.getPropertyValue("--spice-base").trim()||"#0d1117";this.dynamicColorState.baseBackgroundHex=r;let a=this.utils.hexToRgb(r);a&&(this.dynamicColorState.baseBackgroundRgb=`${a.r},${a.g},${a.b}`),this.dynamicColorState.lastUpdateTime=Date.now(),u?.debug?.log("DynamicCatppuccinBridge","Current state initialized:",{accent:this.dynamicColorState.currentAccentHex,base:this.dynamicColorState.baseBackgroundHex})}handleExtractedColors(t){if(this.integrationConfig.accentUpdateEnabled)try{let i=this.selectBestAccentColor(t);i&&i!==this.dynamicColorState.currentAccentHex&&this.scheduleSmoothAccentTransition(i),u?.debug?.log("DynamicCatppuccinBridge","Processed extracted colors:",{input:Object.keys(t),selectedAccent:i})}catch(i){u?.debug?.error("DynamicCatppuccinBridge","Error handling extracted colors:",i)}}handleHarmonizedColors(t){if(this.integrationConfig.accentUpdateEnabled)try{let i=t.VIBRANT||t.PROMINENT||t.VIBRANT_NON_ALARMING||t.LIGHT_VIBRANT||t.PRIMARY||Object.values(t)[0];i&&i!==this.dynamicColorState.currentAccentHex&&(this.config.enableDebug&&console.log("\u{1F3A8} [DynamicCatppuccinBridge] Applying harmonized accent color:",{from:this.dynamicColorState.currentAccentHex,to:i,source:"ColorHarmonyEngine harmonized colors"}),this.scheduleSmoothAccentTransition(i)),this.applyHarmonizedColorsToDynamicSystem(t)}catch(i){console.error("\u{1F3A8} [DynamicCatppuccinBridge] Error handling harmonized colors:",i)}}handleCSSVariablesApplied(t,i,n){if(this.integrationConfig.accentUpdateEnabled)try{i&&i!==this.dynamicColorState.currentAccentHex&&(this.dynamicColorState.currentAccentHex=i,this.dynamicColorState.currentAccentRgb=n,this.dynamicColorState.lastUpdateTime=Date.now());let r={},a=t["--sn-accent-hex"]||t["--spice-accent"]||i,s=t["--sn-accent-rgb"]||t["--spice-rgb-accent"]||n;a&&s&&(r["--sn-dynamic-accent-hex"]=a,r["--sn-dynamic-accent-rgb"]=s,r["--sn-dynamic-primary-hex"]=a,r["--sn-dynamic-primary-rgb"]=s,Object.keys(r).length>0&&this.cssController.batchSetVariables("DynamicCatppuccinBridge",r,"critical","css-variables-applied-enhancement")),u?.debug?.log("DynamicCatppuccinBridge","Processed colors:applied event:",{accentHex:a,accentRgb:s,variablesProcessed:Object.keys(t).length,enhancedVariables:Object.keys(r).length})}catch(r){u?.debug?.error("DynamicCatppuccinBridge","Error handling CSS variables applied:",r)}}handleMusicStateChange(t){t.energy!==void 0&&(this.dynamicColorState.musicEnergy=t.energy,this.integrationConfig.consciousnessIntegrationEnabled&&this.updateConsciousnessWithMusicEnergy(t.energy))}selectBestAccentColor(t){let i=["VIBRANT_NON_ALARMING","VIBRANT","LIGHT_VIBRANT","PROMINENT","PRIMARY","DARK_VIBRANT"];for(let n of i){let r=t[n];if(r&&this.utils.hexToRgb(r))return r}return null}scheduleSmoothAccentTransition(t){if(this.dynamicColorState.transitionInProgress){this.transitionToAccent=t;return}this.transitionFromAccent=this.dynamicColorState.currentAccentHex,this.transitionToAccent=t,this.dynamicColorState.transitionInProgress=!0,this.lastTransitionStartTime=Date.now(),this.animateAccentTransition(),u?.debug?.log("DynamicCatppuccinBridge",`Accent transition scheduled: ${this.transitionFromAccent} \u2192 ${t}`)}animateAccentTransition(){let t=()=>{if(!this.dynamicColorState.transitionInProgress)return;let i=Date.now()-this.lastTransitionStartTime,n=Math.min(i/this.integrationConfig.smoothTransitionDuration,1),r=1-Math.pow(1-n,3),a=this.interpolateColors(this.transitionFromAccent,this.transitionToAccent,r);if(a&&this.applyDynamicAccent(a),n>=1){this.dynamicColorState.transitionInProgress=!1,this.dynamicColorState.currentAccentHex=this.transitionToAccent,this.dynamicColorState.lastUpdateTime=Date.now();let s=this.utils.hexToRgb(this.transitionToAccent);s&&(this.dynamicColorState.currentAccentRgb=`${s.r},${s.g},${s.b}`),u?.debug?.log("DynamicCatppuccinBridge",`Accent transition complete: ${this.transitionToAccent}`)}else requestAnimationFrame(t)};requestAnimationFrame(t)}interpolateColors(t,i,n){let r=this.utils.hexToRgb(t),a=this.utils.hexToRgb(i);if(!r||!a)return null;let s=Math.round(r.r+(a.r-r.r)*n),o=Math.round(r.g+(a.g-r.g)*n),l=Math.round(r.b+(a.b-r.b)*n);return this.utils.rgbToHex(s,o,l)}applyDynamicAccent(t){console.log("\u{1F3A8} [DynamicCatppuccinBridge] Applying dynamic accent color:",{accentHex:t,previousAccent:this.dynamicColorState.currentAccentHex,timestamp:Date.now()});let i=document.documentElement,n=this.utils.hexToRgb(t);if(!n){console.error("\u{1F3A8} [DynamicCatppuccinBridge] Failed to convert accent hex to RGB:",t);return}let r=`${n.r},${n.g},${n.b}`,a={"--sn-dynamic-accent-hex":t,"--sn-dynamic-accent-rgb":r,"--sn-dynamic-primary-hex":t,"--sn-dynamic-primary-rgb":r,"--spice-accent":t,"--spice-button":t,"--spice-button-active":t,"--spice-rgb-accent":r,"--spice-rgb-button":r,"--sn-color-extracted-primary-rgb":r,"--sn-color-extracted-vibrant-rgb":r,"--sn-color-extracted-dominant-rgb":r};console.log("\u{1F3A8} [DynamicCatppuccinBridge] Setting CSS variables:",a),this.cssController.batchSetVariables("DynamicCatppuccinBridge",a,"critical","dynamic-accent-application"),this.integrationConfig.consciousnessIntegrationEnabled&&this.updateConsciousnessWithAccent(t,r),this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinBridge",`Applied gradient colors: --sn-bg-gradient-primary=${t}, --sn-bg-gradient-primary-rgb=${r}`)}applyHarmonizedColorsToDynamicSystem(t){let i=t.VIBRANT||t.PRIMARY;i&&this.integrationConfig.baseTransformationEnabled&&this.updateLivingBaseBackground(i)}updateConsciousnessWithAccent(t,i){let n=document.documentElement,r={"--sn-holographic-rgb":i,"--holographic-scanline-rgb":i,"--consciousness-intensity":`calc(0.5 + var(--musical-sync-intensity) * ${this.integrationConfig.energyResponseMultiplier})`};this.cssController.batchSetVariables("DynamicCatppuccinBridge",r,"high","consciousness-accent-update"),this.depthConsciousnessController&&u?.debug?.log("DynamicCatppuccinBridge","Notifying depth consciousness of accent change")}updateConsciousnessWithMusicEnergy(t){let i=document.documentElement,n=t*this.integrationConfig.energyResponseMultiplier,r={"--musical-sync-intensity":n.toString(),"--holographic-music-flicker-intensity":n.toString()};this.cssController.batchSetVariables("DynamicCatppuccinBridge",r,"high","musical-energy-update");let s=Math.max(.1,Math.min(1,.5+n*.3));this.cssController.setVariable("DynamicCatppuccinBridge","--consciousness-intensity",s.toString(),"high","consciousness-intensity-update")}updateLivingBaseBackground(t){let i=document.documentElement,n=this.utils.hexToRgb(t);if(!n)return;let r=`${n.r},${n.g},${n.b}`,a={"--sn-dynamic-secondary-hex":t,"--sn-dynamic-secondary-rgb":r,"--sn-color-extracted-secondary-rgb":r,"--sn-color-harmony-complementary-rgb":r};this.cssController.batchSetVariables("DynamicCatppuccinBridge",a,"high","secondary-color-update");let s=`
      linear-gradient(135deg,
        var(--spice-base) 0%,
        rgba(${r}, 0.08) 30%,
        var(--spice-base) 70%
      ),
      var(--spice-base)
    `,o={"--living-base-gradient":s,"--consciousness-base-gradient":s};this.cssController.batchSetVariables("DynamicCatppuccinBridge",o,"normal","living-gradient-update"),this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinBridge",`Living base updated: --sn-bg-gradient-secondary=${t}, --sn-bg-gradient-secondary-rgb=${r}`)}linkWithColorHarmonyEngine(t){this.colorHarmonyEngine=t,u?.debug?.log("DynamicCatppuccinBridge","Linked with ColorHarmonyEngine")}linkWithDepthConsciousness(t){this.depthConsciousnessController=t,u?.debug?.log("DynamicCatppuccinBridge","Linked with DepthLayerController")}getDynamicColorState(){return{...this.dynamicColorState}}getFacadeVariableStatus(){let t=document.documentElement,i=getComputedStyle(t);return{spicetifyVars:{accent:i.getPropertyValue("--spice-accent").trim(),button:i.getPropertyValue("--spice-button").trim(),rgbAccent:i.getPropertyValue("--spice-rgb-accent").trim(),base:i.getPropertyValue("--spice-base").trim()},consciousnessVars:{gradientPrimary:i.getPropertyValue("--sn-bg-gradient-primary-rgb").trim(),accentHex:i.getPropertyValue("--sn-color-accent-hex").trim(),accentRgb:i.getPropertyValue("--sn-color-accent-rgb").trim(),extractedPrimary:i.getPropertyValue("--sn-color-extracted-primary-rgb").trim(),livingBaseGradient:i.getPropertyValue("--living-base-gradient").trim()},config:{dynamicAccentEnabled:this.checkDynamicAccentEnabled(),accentUpdateEnabled:this.integrationConfig.accentUpdateEnabled,consciousnessEnabled:this.integrationConfig.consciousnessIntegrationEnabled,isActive:this.isActive}}}updateConfig(t){this.integrationConfig={...this.integrationConfig,...t},u?.debug?.log("DynamicCatppuccinBridge","Configuration updated:",t)}async healthCheck(){let t=this.checkDynamicAccentEnabled(),i=Date.now()-this.dynamicColorState.lastUpdateTime<3e4;return{healthy:this.isActive&&t,issues:this.isActive&&!t?["Dynamic accent not enabled in settings"]:[],metrics:{dynamicAccentEnabled:t,currentAccent:this.dynamicColorState.currentAccentHex,lastUpdateAge:Date.now()-this.dynamicColorState.lastUpdateTime,hasRecentUpdate:i,transitionInProgress:this.dynamicColorState.transitionInProgress,musicEnergy:this.dynamicColorState.musicEnergy}}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=0),this.dynamicColorState.transitionInProgress=!1,p.unsubscribeAll("DynamicCatppuccinBridge"),u?.debug?.log("DynamicCatppuccinBridge","Dynamic Catppuccin bridge cleaned up (including UnifiedEventBus subscriptions)")}}});var vo={};ie(vo,{CDFVariableBridge:()=>Hr});var Hr,Co=b(()=>{"use strict";D();Hr=class{constructor(e){this.batcher=e;this.reduceMotionMQ=null;this._mqHandler=null;let t=p.subscribe("performance:frame",i=>{let n={deltaMs:i.deltaTime||16.67,timestamp:i.timestamp||Date.now(),performanceMode:"performance",frameBudget:16.67};this._handleFrame(n)},"CDFVariableBridge");if(this.unsubscribe=()=>p.unsubscribe(t),typeof window<"u"&&window.matchMedia){this.reduceMotionMQ=window.matchMedia("(prefers-reduced-motion: reduce)"),this._syncReducedMotion(this.reduceMotionMQ.matches),this._mqHandler=i=>{this._syncReducedMotion(i.matches)};try{this.reduceMotionMQ.addEventListener("change",this._mqHandler)}catch{this.reduceMotionMQ.addListener(this._mqHandler)}}}destroy(){if(this.unsubscribe?.(),this.reduceMotionMQ&&this._mqHandler)try{this.reduceMotionMQ.removeEventListener("change",this._mqHandler)}catch{this.reduceMotionMQ.removeListener(this._mqHandler)}}_handleFrame(e){if(typeof e.scrollRatio=="number"&&(this.batcher.queueCSSVariableUpdate("--sn-cdf-scroll-ratio",e.scrollRatio.toFixed(3)),this.batcher.queueCSSVariableUpdate("--sn-scroll-ratio",e.scrollRatio.toFixed(3))),typeof e.beatIntensity=="number"){let t=e.beatIntensity.toFixed(3);this.batcher.queueCSSVariableUpdate("--sn-cdf-energy",t),this.batcher.queueCSSVariableUpdate("--sn-beat-intensity",t)}}_syncReducedMotion(e){this.batcher.queueCSSVariableUpdate("--sn-cdf-enabled",e?"0":"1")}}});U();Sr();R();K();async function Ns(c=1e4,e=100){let t=Date.now();for(;Date.now()-t<c;){let i=window.Spicetify;if(i?.showNotification&&i?.Platform)return!0;await new Promise(n=>setTimeout(n,e))}return!1}$();var _i=class{constructor(e,t=null){this.parent=e;this.y3k=t;this.gl=null;this.program=null;this.tex=null;this.strength=.4;this.rafId=null;this.frameStart=0;this._defaultSize=256;this._boundContextLost=e=>this._handleContextLost(e);this._boundContextRestored=()=>this._handleContextRestored();this.canvas=document.createElement("canvas"),this.canvas.width=this._defaultSize,this.canvas.height=this._defaultSize,this.canvas.style.width="100%",this.canvas.style.height="100%",Object.assign(this.canvas.style,{position:"absolute",inset:"0",pointerEvents:"none",mixBlendMode:"overlay",zIndex:"-1",opacity:"0.6"}),this.parent.appendChild(this.canvas),this.perf=t?.performanceAnalyzer??null,this.canvas.addEventListener("webglcontextlost",this._boundContextLost,!1),this.canvas.addEventListener("webglcontextrestored",this._boundContextRestored,!1),this._initGL()}_initGL(){let e=this.canvas.getContext("webgl",{premultipliedAlpha:!1,alpha:!0,antialias:!1});if(!e){console.warn("[AberrationCanvas] WebGL not available \u2013 effect disabled");return}this.gl=e;let t="attribute vec2 aPos; varying vec2 vUv; void main(){ vUv = (aPos+1.0)*0.5; gl_Position = vec4(aPos,0.0,1.0); }",i="precision mediump float; uniform sampler2D uTex; uniform float uStrength; uniform float uTime; varying vec2 vUv; void main(){ float freq = 8.0; vec2 offset = vec2(sin(vUv.y*freq+uTime)*uStrength, 0.0); vec4 c; c.r = texture2D(uTex, vUv + offset).r; c.g = texture2D(uTex, vUv).g; c.b = texture2D(uTex, vUv - offset).b; c.a = clamp(uStrength * 1.5, 0.0, 0.6); gl_FragColor = c; }",n=(h,g)=>{let f=e.createShader(h);return e.shaderSource(f,g),e.compileShader(f),f},r=n(e.VERTEX_SHADER,t),a=n(e.FRAGMENT_SHADER,i),s=e.createProgram();if(e.attachShader(s,r),e.attachShader(s,a),e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS)){console.error("[AberrationCanvas] Shader link failed");return}this.program=s,e.useProgram(s);let o=new Float32Array([-1,-1,1,-1,-1,1,1,1]),l=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,o,e.STATIC_DRAW);let m=e.getAttribLocation(s,"aPos");e.enableVertexAttribArray(m),e.vertexAttribPointer(m,2,e.FLOAT,!1,0,0);let d=e.createTexture();e.bindTexture(e.TEXTURE_2D,d),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([0,0,0,0])),this.tex=d}setStrength(e){this.strength=e}updateSourceBitmap(e){if(!this.gl||!this.tex)return;let t=this.gl;t.bindTexture(t.TEXTURE_2D,this.tex),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e)}render(e){if(!this.gl||!this.program)return;let t=this.gl;this.perf&&(this.frameStart=performance.now()),t.viewport(0,0,this.canvas.width,this.canvas.height),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT),t.useProgram(this.program);let i=t.getUniformLocation(this.program,"uTex"),n=t.getUniformLocation(this.program,"uStrength"),r=t.getUniformLocation(this.program,"uTime");if(t.uniform1i(i,0),t.uniform1f(n,this.strength),t.uniform1f(r,e*.001),t.drawArrays(t.TRIANGLE_STRIP,0,4),this.perf){let a=performance.now()-this.frameStart;a>.5&&console.warn(`[AberrationCanvas] Frame ${a.toFixed(2)} ms exceeds 0.5 ms budget`)}}destroy(){this.rafId&&cancelAnimationFrame(this.rafId),this.gl&&this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.canvas.removeEventListener("webglcontextlost",this._boundContextLost),this.canvas.removeEventListener("webglcontextrestored",this._boundContextRestored),this.canvas.remove()}setPixelSize(e){e!==this.canvas.width&&(this.canvas.width=e,this.canvas.height=e)}_handleContextLost(e){e.preventDefault(),console.warn("[AberrationCanvas] WebGL context lost \u2013 waiting for restore"),this.gl=null,this.program=null}_handleContextRestored(){console.info("[AberrationCanvas] WebGL context restored \u2013 re-initializing GL"),this._initGL()}};var Ni=class{constructor(e,t){this.systemName="AberrationCanvas";this._elapsed=0;this._canvas=e,this._perf=t}onAnimate(e,t){this._elapsed+=e;let i=0;this._perf&&(i=this._perf.startTiming("AberrationVisualSystem")),this._canvas.render(this._elapsed),this._perf&&i&&this._perf.endTiming("AberrationVisualSystem",i)}onPerformanceModeChange(e){e==="performance"?(this._canvas.setPixelSize(128),this._canvas.setStrength(.25)):(this._canvas.setPixelSize(256),this._canvas.setStrength(.4))}destroy(){this._canvas.destroy()}};var Fc=[".main-view-container__scroll-node",".main-viewContainer-scrollNode",".main-viewContainer__scrollNode"].join(", ");function $s(){return document.querySelector(Fc)}var Z=null,$i=null;function vr(c){return(c||globalThis.year3000System)?.cssConsciousnessController||T()}function Gc(){return!1}function zt(c){if(!Gc()){Ot(!1,c),Ut(!1,c);return}let e=$s();e&&(Z&&Z.parent===e||(Z?.destroy(),Z=new _i(e,c),window.__SN_DEBUG_ABERRATION&&console.log("[AberrationManager] canvas attached",e),Ot(!0,c),Ut(!0,c),c&&Z&&($i=new Ni(Z,c.performanceAnalyzer||void 0),c?.registerVisualSystem?.($i,"critical"),console.log("[AberrationManager] AberrationCanvas attached"))))}function Ot(c,e){vr(e).setVariable("AberrationManager","--sn-nebula-noise-opacity",c?"0.03":"0","normal","nebula-noise-toggle")}function Ut(c,e){let t={"--aberration-webgl-active":c?"1":"0","--aberration-css-enabled":c?"1":"0","--aberration-hybrid-mode":c?"1":"0"};vr(e).batchSetVariables("AberrationManager",t,"normal","css-aberration-toggle")}function Ws(c=null){zt(c),Z||(Ot(!1,c),Ut(!1,c));let e=window.Spicetify?.Platform?.History;e?.listen&&e.listen(()=>setTimeout(()=>zt(c),0)),document.addEventListener("spicetify:appchange",()=>zt(c));let t=new MutationObserver(()=>{Z?t.disconnect():(zt(c),Z||(Ot(!1,c),Ut(!1,c)))});t.observe(document.documentElement,{childList:!0,subtree:!0}),document.addEventListener("year3000SystemSettingsChanged",i=>{let{key:n,value:r}=i.detail||{};if(n==="sn-enable-aberration"){let a=r==="true";a&&!Z?zt(c):!a&&Z&&(Z.destroy(),Z=null,c?.unregisterAnimationSystem("AberrationCanvas"),$i?.destroy(),$i=null,console.log("[AberrationManager] AberrationCanvas detached")),Ot(a&&!!Z,c),Ut(a&&!!Z,c)}if(n==="sn-nebula-aberration-strength"){let a=parseFloat(r);!Number.isNaN(a)&&Z&&Z.setStrength(a),vr(c).setVariable("AberrationManager","--sn-nebula-aberration-strength",String(r),"normal","aberration-strength-update")}})}$();D();var qs="sn_seen_genres_v1",Wi=class{constructor(){let e=typeof localStorage<"u"?localStorage.getItem(qs):null;this.seen=new Set(e?JSON.parse(e):[])}hasSeen(e){return this.seen.has(e.toLowerCase())}markSeen(e){let t=e.toLowerCase();this.seen.has(t)||(this.seen.add(t),this._persist())}_persist(){try{typeof localStorage<"u"&&localStorage.setItem(qs,JSON.stringify([...this.seen]))}catch{}}};function Vc(c){if(!c.length)return 0;let e=[...c].sort((r,a)=>r-a),t=Math.floor(e.length/2);if(e.length%2!==0)return e[t]??0;let i=e[t-1]??0,n=e[t]??0;return(i+n)/2}var _t=class _t{constructor(e=null,t,i){this.perf=null;this.unsubscribers=[];this.frameDurations=[];this.enabled=!0;this.intensitySetting="balanced";this.intensityFactor=1;this.genreHistory=new Wi;this.activeGlowTimeout=null;this.interactionOffHandler=null;this.year3000System=e,this.cssController=t??e?.cssVariableController??T(),this.perf=i||(e?.performanceAnalyzer??null);let n=window.matchMedia("(prefers-reduced-motion: reduce)").matches,r=e?.deviceCapabilityDetector?.deviceCapabilities?.overall,a=e?.settingsManager;switch(a&&(this.intensitySetting=a.get("sn-gradient-intensity")??"balanced"),this.intensitySetting){case"disabled":this.enabled=!1;break;case"minimal":this.intensityFactor=.6;break;case"balanced":this.intensityFactor=1;break;case"intense":this.intensityFactor=1.4;break}(n||r==="low")&&(this.enabled=!1),this.enabled?this._subscribe():this.cssController.setVariable("AudioVisualController","--sn-nebula-beat-intensity","0","low","disabled-initialization")}_subscribe(){let e=[p.subscribe("music:beat",t=>{this._handleBeat({energy:t.intensity,bpm:t.bpm})},"AudioVisualController"),p.subscribe("music:track-changed",t=>{this._handleGenreChange({genre:"unknown"})},"AudioVisualController"),p.subscribe("user:scroll",t=>{this._handleScroll({velocity:t.velocity?.x||t.velocity?.y||0,direction:t.direction==="up"?"up":"down"})},"AudioVisualController")];this.unsubscribers=e.map(t=>()=>p.unsubscribe(t))}_handleBeat(e){let t=performance.now(),i=typeof e.energy=="number"?e.energy:.5,n=(.8+Math.min(Math.max(i,0),1)*.6)*this.intensityFactor;this._queueVar("--sn-nebula-beat-intensity",n.toFixed(3),"high","beat-sync");let r=(i*.6).toFixed(3);this._queueVar("--sn-nebula-aberration-strength",r,"normal","beat-aberration"),this._recordDuration(t)}_handleGenreChange(e){let t=performance.now();if(this.genreHistory.hasSeen(e.genre))return;this.genreHistory.markSeen(e.genre);let i=.18*this.intensityFactor;this._queueVar("--sn-nebula-layer-0-opacity",i.toFixed(3),"high","genre-discovery");let n=()=>{this.year3000System?.timerConsolidationSystem?this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer("AudioVisualController-glowTimeout"):this.activeGlowTimeout&&(clearTimeout(this.activeGlowTimeout),this.activeGlowTimeout=null),this._queueVar("--sn-nebula-layer-0-opacity","0.05","normal","genre-clear"),this.interactionOffHandler&&(document.removeEventListener("pointerdown",this.interactionOffHandler),document.removeEventListener("keydown",this.interactionOffHandler),this.interactionOffHandler=null)};this.year3000System?.timerConsolidationSystem?(this.year3000System.timerConsolidationSystem.registerConsolidatedTimer("AudioVisualController-glowTimeout",n,4e3,"normal"),this.activeGlowTimeout=null):this.activeGlowTimeout=setTimeout(n,4e3),this.interactionOffHandler=()=>n(),document.addEventListener("pointerdown",this.interactionOffHandler,{once:!0}),document.addEventListener("keydown",this.interactionOffHandler,{once:!0}),this._queueVar("--sn-nebula-ease-t","1","normal","ease-trigger"),this._recordDuration(t)}_handleScroll(e){let t=performance.now(),i=typeof e.velocity=="number"?e.velocity:0,r=Math.min(Math.abs(i),50)/50*2*this.intensityFactor;this._queueVar("--sn-nebula-layer-3-blur",`calc(var(--sn-depth-layer-3-blur) + ${r.toFixed(2)}px)`,"normal","scroll-blur");let a=150,o=Math.max(Math.min(e.velocity??0,50),-50)/50*50,l=Math.max(140,Math.min(200,a+o));this._queueVar("--sn-nebula-noise-scale-y",`${l.toFixed(1)}%`,"normal","scroll-noise"),this._recordDuration(t)}_queueVar(e,t,i="normal",n="audio-visual"){this.enabled&&this.cssController.setVariable("AudioVisualController",e,t,i,n)}_recordDuration(e){let t=performance.now()-e;if(this.frameDurations.push(t),this.frameDurations.length>_t.FRAME_HISTORY&&this.frameDurations.shift(),this.frameDurations.length===_t.FRAME_HISTORY){let i=Vc(this.frameDurations);i>2&&(console.warn(`[AudioVisualController] Median scripting cost ${i.toFixed(2)} ms exceeds 2 ms budget.`),this._queueVar("--sn-nebula-blend-mode","screen","critical","performance-fallback"))}}destroy(){this.year3000System?.timerConsolidationSystem&&this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer("AudioVisualController-glowTimeout"),this.activeGlowTimeout&&(clearTimeout(this.activeGlowTimeout),this.activeGlowTimeout=null),this.interactionOffHandler&&(document.removeEventListener("pointerdown",this.interactionOffHandler),document.removeEventListener("keydown",this.interactionOffHandler),this.interactionOffHandler=null),this.unsubscribers.forEach(e=>e()),this.unsubscribers=[]}};_t.FRAME_HISTORY=120;var Cr=_t;function Ys(c=null){let e=globalThis;if(e.__SN_audioVisualController)return e.__SN_audioVisualController;let t=new Cr(c);return e.__SN_audioVisualController=t,t}async function Wt(c,e=5e3){let t=Date.now(),i=null,n=0;for(;Date.now()-t<e;){n++;try{let s=c.split(".").reduce((o,l)=>o?.[l],window);if(s)return console.log(`\u2705 [StarryNight] API ${c} available after ${n} attempts (${Date.now()-t}ms)`),s}catch(s){i=s}await new Promise(s=>setTimeout(s,100))}console.warn(`\u274C [StarryNight] API ${c} timeout after ${e}ms (${n} attempts)`),i&&console.warn(`\u274C [StarryNight] Last error for ${c}:`,i.message);let r=c.split("."),a=window;for(let s=0;s<r.length;s++){let o=r[s];if(!o||!a||typeof a!="object"||a[o]===void 0){console.warn(`\u274C [StarryNight] API path ${c} breaks at '${o}' (step ${s+1}/${r.length})`);break}a=a[o]}return null}async function hl(c,e=5e3){let t=Date.now(),i=0;for(;Date.now()-t<e;){i++;try{let n=document.querySelector(c);if(n)return console.log(`\u2705 [StarryNight] DOM element '${c}' found after ${i} attempts (${Date.now()-t}ms)`),n}catch(n){console.warn(`\u274C [StarryNight] DOM query error for '${c}':`,n)}await new Promise(n=>setTimeout(n,200))}return console.warn(`\u274C [StarryNight] DOM element '${c}' not found after ${e}ms (${i} attempts)`),null}async function gl(c=5e3){let e=Date.now();for(;Date.now()-e<c;){try{let t=getComputedStyle(document.documentElement),i=t.getPropertyValue("--spice-base").trim(),n=t.getPropertyValue("--spice-accent").trim(),r=t.getPropertyValue("--spice-text").trim(),a=s=>{let o=s.toLowerCase();return s&&!o.includes("#ffffff")&&!o.includes("#fff")&&!o.includes("white")&&o.match(/^#[0-9a-f]{6}$/i)};if(a(i)&&a(n)&&a(r))return console.log(`\u{1F3A8} [StarryNight] Catppuccin theme loaded: base=${i}, accent=${n}, text=${r}`),!0;console.log(`\u{1F3A8} [StarryNight] Waiting for Catppuccin theme... (base=${i}, accent=${n})`)}catch{}await new Promise(t=>setTimeout(t,200))}return console.warn(`\u{1F3A8} [StarryNight] Catppuccin theme not fully loaded after ${c}ms - proceeding with fallbacks`),!1}function pl(){let c=globalThis;if(c.__STARLIGHT_REACT_SHIM__)return;let e=t=>{if(t==="react")return c.Spicetify?.React;if(t==="react-dom")return c.Spicetify?.ReactDOM;throw new Error(`[StarryNight shim] Module '${t}' not available`)};if(typeof c.require=="function"){let t=c.require.bind(c);c.require=i=>i==="react"||i==="react-dom"?e(i):t(i)}else c.require=e;c.__STARLIGHT_REACT_SHIM__=!0}pl();(async function(){let e=Date.now();if(console.log("\u{1F31F} [Catppuccin StarryNight] Theme entry point starting..."),await Ns(1e4)?console.log("\u2705 [StarryNight] Spicetify platform fully ready"):(console.error("\u274C [StarryNight] CRITICAL: Spicetify not fully ready after 10s \u2013 proceeding with degraded visual-only mode."),console.error("\u274C [StarryNight] Available Spicetify objects:",{Spicetify:!!window.Spicetify,showNotification:!!window.Spicetify?.showNotification,Platform:!!window.Spicetify?.Platform})),await gl(8e3))console.log("\u2705 [StarryNight] Catppuccin theme fully loaded");else{console.error("\u274C [StarryNight] CRITICAL: Catppuccin theme not fully loaded after 8s \u2013 may experience color issues");let h=getComputedStyle(document.documentElement);console.error("\u274C [StarryNight] Current CSS variables:",{base:h.getPropertyValue("--spice-base").trim(),accent:h.getPropertyValue("--spice-accent").trim(),text:h.getPropertyValue("--spice-text").trim()})}let n={player:await Wt("Spicetify.Player",3e3),platform:await Wt("Spicetify.Platform",3e3),menu:await Wt("Spicetify.Menu",2e3),react:await Wt("Spicetify.React",2e3),reactDOM:await Wt("Spicetify.ReactDOM",2e3)},r=[".main-viewContainer-scrollNode",".main-view-container__scroll-node-child",".main-view-container",".main-container","#main","[data-testid='main-container']"],a=null;for(let h of r)if(a=await hl(h,1e3),a){console.log(`\u2705 [StarryNight] Found main container using selector: ${h}`);break}a?console.log("\u2705 [StarryNight] Enhanced UI features initialized with DOM container"):(console.warn("\u26A0\uFE0F [StarryNight] No suitable main container found - enhanced UI features disabled"),console.warn("\u26A0\uFE0F [StarryNight] Tried selectors:",r.join(", ")),console.warn("\u26A0\uFE0F [StarryNight] Core functionality (music sync, color extraction) will still work"));let o=!(n.player&&n.platform);o?(console.error("\u274C [StarryNight] DEGRADED MODE: Initializing with limited functionality due to missing APIs"),console.error("\u274C [StarryNight] API availability status:",{player:!!n.player,platform:!!n.platform,menu:!!n.menu,react:!!n.react,reactDOM:!!n.reactDOM,mainContainer:!!a+" (optional)"}),console.error("\u274C [StarryNight] DEGRADED MODE limitations:"),console.error("  - Music synchronization disabled"),console.error("  - Advanced visual effects may not function"),console.error("  - UI integration features disabled"),console.error("  - Color extraction from album art disabled")):console.log("\u2705 [StarryNight] FULL MODE: All required APIs available - initializing complete functionality"),!0&&(w.enableDebug=!0,Promise.resolve().then(()=>(js(),Ks)).then(h=>{h.enableDragCartography?.(),window.getDragMap=h.getDragMap}));let m=new Ht(w);try{if(o)await m.initializeWithAvailableAPIs({player:n.player,platform:n.platform,config:window.Spicetify?.Config,degradedMode:!0}),console.log("\u{1F31F} [StarryNight] Initialized in degraded mode - visual systems only"),fl(m,n);else{await m.initializeAllSystems(),m.setupMusicAnalysisAndColorExtraction(),console.log("\u{1F31F} [StarryNight] Full initialization complete");try{Ys(m),Ws(m),Promise.resolve().then(()=>(to(),eo)).then(h=>h.enableEnhancedDragPreview?.()),Promise.resolve().then(()=>(co(),oo)).then(h=>h.enableQuickAddRadialMenu?.()),a&&Promise.resolve().then(()=>(mo(),uo)).then(h=>h.initializePrismaticScrollSheen?.()),console.log("\u{1F31F} [StarryNight] UI controllers initialized successfully")}catch(h){console.error("[StarryNight] UI controller initialization failed:",h)}}}catch(h){console.error("[StarryNight] System initialization failed:",h)}try{n.react&&n.reactDOM?(await(await Promise.resolve().then(()=>(Fr(),Br))).initializeStarryNightSettings?.(),console.log("\u{1F31F} [StarryNight] Spicetify native settings with Year3000System integration initialized")):console.warn("\u{1F31F} [StarryNight] React APIs not available - continuing with CSS-only theme")}catch(h){console.error("[StarryNight] Failed to initialize native settings:",h),console.warn("\u{1F31F} [StarryNight] Continuing with CSS-only theme (no settings UI)")}w.enableDebug&&(window.Y3K={system:m,music:m.musicSyncService,settings:m.settingsManager,debug:u.debug,health:m.systemHealthMonitor,mode:o?"degraded":"full",availableAPIs:n});try{let{SidebarVisualEffectsSystem:h}=await Promise.resolve().then(()=>(pr(),Ts)),{SidebarPerformanceCoordinator:g}=await Promise.resolve().then(()=>(ir(),rs));if(m.performanceAnalyzer){let f=g.getInstance({enableDebug:w.enableDebug,performanceAnalyzer:m.performanceAnalyzer,onFlushComplete:()=>{m.performanceAnalyzer?.emitTrace?.("[SidebarPerformanceCoordinator] Flush completed")}}),v=new h(w,A,m.performanceAnalyzer,m.musicSyncService,m.settingsManager,m);await v.initialize(),m.sidebarVisualEffectsSystem=v,m.sidebarCoordinator=f}}catch(h){console.error("[StarryNight] Failed to initialize Consolidated Sidebar System",h)}try{let{DepthConsciousnessController:h}=await Promise.resolve().then(()=>(bo(),fo)),g=new h(w,A,m.performanceAnalyzer,m.musicSyncService,m.settingsManager);await g.initialize(),m.depthConsciousnessController=g,console.log("\u{1F30A} [StarryNight] Depth Consciousness Controller awakened")}catch(h){console.error("[StarryNight] Failed to initialize DepthConsciousnessController",h)}try{let{DynamicCatppuccinBridge:h}=await Promise.resolve().then(()=>(So(),yo)),g=new h(w,A,m.performanceAnalyzer,m.musicSyncService,m.settingsManager);await g.initialize(),m.colorHarmonyEngine&&g.linkWithColorHarmonyEngine(m.colorHarmonyEngine),m.depthConsciousnessController&&g.linkWithDepthConsciousness(m.depthConsciousnessController),m.dynamicCatppuccinBridge=g,console.log("\u{1F3A8} [StarryNight] Dynamic Catppuccin Bridge connected")}catch(h){console.error("[StarryNight] Failed to initialize DynamicCatppuccinBridge",h)}try{let{LivingGradientStrategy:h}=await Promise.resolve().then(()=>(An(),Aa)),g=new h(w,A,m.performanceAnalyzer,m.musicSyncService,m.settingsManager);await g.initialize(),m.dynamicCatppuccinBridge&&console.log("\u{1F30A} [StarryNight] Consolidated Living Gradient System linked with Dynamic Catppuccin Bridge"),m.depthConsciousnessController&&console.log("\u{1F30A} [StarryNight] Consolidated Living Gradient System linked with Depth Consciousness"),m.livingGradientSystem=g,m.livingGradientStrategy=g,console.log("\u{1F30A} [StarryNight] Consolidated Living Gradient Strategy System awakened - unified color processing and visual system lifecycle with performance optimizations")}catch(h){console.error("[StarryNight] Failed to initialize Consolidated Living Gradient Strategy System",h)}try{let{CDFVariableBridge:h}=await Promise.resolve().then(()=>(Co(),vo));m.cssVariableController&&new h(m.cssVariableController)}catch(h){console.error("[StarryNight] Failed to initialize CDFVariableBridge",h)}let d=Date.now()-e;console.log(`\u{1F30C} Catppuccin StarryNight Theme initialized in ${d}ms (${o?"degraded":"full"} mode). Welcome to the future of sound!`)})();function fl(c,e){console.log("\u{1F504} [StarryNight] Setting up progressive enhancement monitoring...");let t=0,i=30,n=1e4,r=()=>{t++;let o={player:window.Spicetify?.Player,platform:window.Spicetify?.Platform,menu:window.Spicetify?.Menu,react:window.Spicetify?.React,reactDOM:window.Spicetify?.ReactDOM};if(o.player&&o.platform){console.log("\u2705 [StarryNight] Required APIs now available - upgrading to full mode!"),clearInterval(a),bl(c,o).then(()=>{console.log("\u{1F31F} [StarryNight] Successfully upgraded from degraded mode to full mode!"),window.Y3K&&(window.Y3K.mode="full",window.Y3K.availableAPIs=o)}).catch(m=>{console.error("\u274C [StarryNight] Failed to upgrade to full mode:",m)});return}if(t>=i){console.log(`\u23F0 [StarryNight] Progressive enhancement monitoring ended after ${t} attempts (${t*n/1e3}s)`),clearInterval(a);return}t%5===0&&(console.log(`\u{1F504} [StarryNight] Still monitoring for API availability... (attempt ${t}/${i})`),console.log("\u{1F504} [StarryNight] Current API status:",{player:!!o.player,platform:!!o.platform,menu:!!o.menu,react:!!o.react,reactDOM:!!o.reactDOM}))},a=setInterval(r,n),s=()=>{console.log("\u{1F3B5} [StarryNight] Spicetify ready event detected - checking for upgrade..."),r()};window.Spicetify&&window.Spicetify.Player&&window.Spicetify.Player.addEventListener?.("songchange",s),setTimeout(()=>{window.Spicetify?.Player&&window.Spicetify.Player.removeEventListener?.("songchange",s)},i*n)}async function bl(c,e){try{if(console.log("\u{1F680} [StarryNight] Beginning upgrade to full mode..."),!c)throw new Error("Year3000System instance not available");if(typeof c.upgradeToFullMode=="function")console.log("\u{1F527} [StarryNight] Using system's built-in upgrade method..."),await c.upgradeToFullMode({player:e.player,platform:e.platform,config:window.Spicetify?.Config,degradedMode:!1});else if(console.log("\u{1F527} [StarryNight] System upgrade method not available - attempting manual initialization..."),c.setupMusicAnalysisAndColorExtraction&&(console.log("\u{1F3B5} [StarryNight] Setting up music analysis and color extraction..."),await c.setupMusicAnalysisAndColorExtraction()),e.react&&e.reactDOM)try{console.log("\u2699\uFE0F [StarryNight] Initializing settings UI..."),await(await Promise.resolve().then(()=>(Fr(),Br))).initializeStarryNightSettings?.(),console.log("\u2705 [StarryNight] Settings UI initialized successfully")}catch(t){console.warn("\u26A0\uFE0F [StarryNight] Failed to initialize settings UI during upgrade:",t)}c.eventBus?.emitSync&&c.eventBus.emitSync("system:upgraded-to-full-mode",{timestamp:Date.now(),availableAPIs:{player:!!e.player,platform:!!e.platform,menu:!!e.menu,react:!!e.react,reactDOM:!!e.reactDOM}}),console.log("\u{1F31F} [StarryNight] Upgrade to full mode completed successfully!")}catch(t){throw console.error("\u274C [StarryNight] Upgrade to full mode failed:",t),t}}})();
