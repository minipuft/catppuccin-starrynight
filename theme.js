"use strict";(()=>{var To=Object.create;var er=Object.defineProperty;var xo=Object.getOwnPropertyDescriptor;var Po=Object.getOwnPropertyNames;var Ao=Object.getPrototypeOf,Io=Object.prototype.hasOwnProperty;var Ya=(o=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(o,{get:(t,e)=>(typeof require<"u"?require:t)[e]}):o)(function(o){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+o+'" is not supported')});var v=(o,t)=>()=>(o&&(t=o(o=0)),t);var ne=(o,t)=>{for(var e in t)er(o,e,{get:t[e],enumerable:!0})},Do=(o,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Po(t))!Io.call(o,r)&&r!==e&&er(o,r,{get:()=>t[r],enumerable:!(i=xo(t,r))||i.enumerable});return o};var ja=(o,t,e)=>(e=o!=null?To(Ao(o)):{},Do(t||!o||!o.__esModule?er(e,"default",{value:o,enumerable:!0}):e,o));var Ka,Qa,ot,tr=v(()=>{"use strict";Ka={latte:{name:"Latte",base:"#eff1f5",text:"#4c4f69",isDark:!1},frappe:{name:"Frapp\xE9",base:"#303446",text:"#c6d0f5",isDark:!0},macchiato:{name:"Macchiato",base:"#24273a",text:"#cad3f5",isDark:!0},mocha:{name:"Mocha",base:"#1e1e2e",text:"#cdd6f4",isDark:!0}},Qa=["rosewater","flamingo","pink","mauve","red","maroon","peach","yellow","green","teal","sky","sapphire","blue","lavender","text","none"],ot={flavor:o=>typeof o=="string"&&o in Ka,accentColor:o=>typeof o=="string"&&Qa.includes(o),brightnessMode:o=>typeof o=="string"&&["bright","balanced","dark"].includes(o),paletteSystem:o=>typeof o=="string"&&["catppuccin","year3000"].includes(o),gradientIntensity:o=>typeof o=="string"&&["disabled","minimal","balanced","intense"].includes(o),glassmorphismLevel:o=>typeof o=="string"&&["disabled","minimal","moderate","intense"].includes(o),webglEnabled:o=>typeof o=="boolean"||typeof o=="string"&&["true","false"].includes(o),animationQuality:o=>typeof o=="string"&&["auto","low","high"].includes(o),webglQuality:o=>typeof o=="string"&&["low","medium","high"].includes(o)}});var wt,ir,rr,lt,jt=v(()=>{"use strict";wt={"analogous-flow":{rule:"analogous",angle:30,description:"Flowing cinematic gradients with adjacent hues"},"triadic-trinity":{rule:"triadic",angle:120,description:"Dramatic three-color gradient dynamics"},"complementary-yin-yang":{rule:"complementary",angle:180,description:"Electric contrast gradients with opposing forces"},"tetradic-advanced-cross":{rule:"tetradic",angle:90,description:"Complex four-color gradient matrix"},"split-complementary-spectrum":{rule:"split-complementary",angle:150,description:"Spectrum-like gradient flows with polar contrasts"},"monochromatic-calm":{rule:"monochromatic",angle:0,description:"Intense single-hue gradient depth"}},ir={energyScaling:{low:.8,medium:1.2,high:1.8},valenceScaling:{sad:1,neutral:1.2,happy:1.6},danceabilityEffects:{enable:!0,animationSpeedMultiplier:1.5,blurVariation:.3}},rr={enable:!0,useSmartCalculation:!0,useRealisticData:!0,danceabilityEstimation:{highDance:{min:120,max:140,value:.8},mediumDance:{min:100,max:160,value:.6},lowMediumDance:{min:80,max:180,value:.4},lowDance:{value:.2}},energyEstimation:{tempoWeight:.6,loudnessWeight:.4,tempoRange:{min:60,max:180},loudnessRange:{min:-60,max:0}},danceabilityThresholds:{high:.7,low:.3},energyMultiplierRange:{min:.8,max:1.4},tempoMultipliers:{highDance:1,mediumDance:.75,lowDance:.5},fallbacks:{tempo:120,loudness:-10,danceability:.5,energy:.5,key:0,timeSignature:4}},lt={...wt,"tetradic-cosmic-cross":wt["tetradic-advanced-cross"],"split-complementary-aurora":wt["split-complementary-spectrum"],"monochromatic-meditation":wt["monochromatic-calm"]}});var Re,Kt=v(()=>{"use strict";Re={"corporate-safe":{displayName:"Corporate Safe",description:"Subtle gradient elegance with professional restraint and refined color transitions",philosophy:"Gentle gradient flows that maintain workspace harmony while providing sophisticated visual depth",multipliers:{opacity:.2,saturation:1.15,brightness:1.08,contrast:1.05,musicEnergyBoost:.4,animationIntensity:.3,timeBasedEffectFactor:.2,interactionStrength:.2,advancedAnimations:!1,visualIntensityBase:.9,kineticIntensity:.3,timeBasedPlayFactor:.2,aestheticGravityStrength:.2,emergentChoreography:!1},features:{rippleEffects:!1,timeBasedEcho:!1,particleStreams:!1,predictiveHighlights:!0,glassEffects:!0,beatSync:!1,colorHarmony:!1,userInteractions:!1,aestheticGravity:!1},performance:{maxParticles:0,animationThrottle:32,enableGPUAcceleration:!1,reducedMotion:!0}},"artist-vision":{displayName:"Artist Vision",description:"Cinematic gradient expression with vibrant, flowing color transitions",philosophy:"Dramatic gradient harmonies that create depth and emotional resonance through bold color interactions",multipliers:{opacity:.35,saturation:1.45,brightness:1.25,contrast:1.3,musicEnergyBoost:1.2,animationIntensity:.8,timeBasedEffectFactor:.7,interactionStrength:.6,advancedAnimations:!0,visualIntensityBase:1.2,kineticIntensity:.8,timeBasedPlayFactor:.7,aestheticGravityStrength:.6,emergentChoreography:!0},features:{rippleEffects:!0,timeBasedEcho:!0,particleStreams:!0,predictiveHighlights:!0,glassEffects:!0,beatSync:!0,colorHarmony:!0,userInteractions:!0,aestheticGravity:!0},performance:{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1}},"advanced-maximum":{displayName:"Advanced Maximum",description:"Ultra-intense cinematic gradients with maximum color saturation and fluid dynamics",philosophy:"Maximum gradient intensity through electric color combinations that create immersive visual landscapes",multipliers:{opacity:.55,saturation:1.65,brightness:1.35,contrast:1.5,musicEnergyBoost:2.5,animationIntensity:2,timeBasedEffectFactor:3,interactionStrength:2,advancedAnimations:!0,visualIntensityBase:1.8,kineticIntensity:2,timeBasedPlayFactor:3,aestheticGravityStrength:2,emergentChoreography:!0},features:{rippleEffects:!0,timeBasedEcho:!0,particleStreams:!0,predictiveHighlights:!0,glassEffects:!0,beatSync:!0,colorHarmony:!0,userInteractions:!0,aestheticGravity:!0},performance:{maxParticles:50,animationThrottle:30,enableGPUAcceleration:!0,reducedMotion:!1}}};Re["cosmic-maximum"]={...Re["advanced-maximum"],displayName:"Cosmic Maximum",description:"Ultra-intense cinematic gradients with maximum color saturation and fluid dynamics",philosophy:"Maximum gradient intensity through electric color combinations that create immersive visual landscapes"}});var Qt,ar,nr=v(()=>{"use strict";Qt={low:{maxParticles:15,animationThrottle:32,enableGPUAcceleration:!1,enableAdvancedShaders:!1,textureResolution:.5},balanced:{maxParticles:40,animationThrottle:16,enableGPUAcceleration:!0,enableAdvancedShaders:!1,textureResolution:1},high:{maxParticles:75,animationThrottle:16,enableGPUAcceleration:!0,enableAdvancedShaders:!0,textureResolution:1},ultra:{maxParticles:150,animationThrottle:8,enableGPUAcceleration:!0,enableAdvancedShaders:!0,textureResolution:2}},ar={level:"info",performance:{enableFrameBudgetWarnings:!0,throttleWarnings:!0,throttleInterval:5e3,enableAdaptiveDegradation:!0}}});var Xa,Za,Ja,Xt=v(()=>{"use strict";Xa="sn-harmonic-intensity",Za="sn-harmonic-evolution",Ja="sn-glassmorphism-level"});function Zt(o,t){return Me[o].validator(t)}function Jt(o,t){let e=Me[o];return e.parser?e.parser(t):e.validator(t)?t:null}function sr(o,t){let e=Me[o];return e.serializer?e.serializer(t):String(t)}function ei(o){return Me[o].defaultValue}function Mt(){return Object.keys(Me)}function ti(o){return o in Me}var Me,or=v(()=>{"use strict";jt();Kt();tr();Me={"catppuccin-flavor":{defaultValue:"mocha",validator:ot.flavor,description:"Catppuccin color theme variant",category:"core"},"catppuccin-accentColor":{defaultValue:"mauve",validator:ot.accentColor,description:"Primary accent color for UI elements",category:"core"},"sn-brightness-mode":{defaultValue:"bright",validator:ot.brightnessMode,description:"Overall theme brightness level",category:"core"},"sn-palette-system":{defaultValue:"catppuccin",validator:ot.paletteSystem,description:"Color palette system (Catppuccin or Year 3000)",category:"advanced"},"sn-artistic-mode":{defaultValue:"artist-vision",validator:o=>typeof o=="string"&&o in Re,description:"Visual intensity and behavior preset",category:"advanced"},"sn-current-harmonic-mode":{defaultValue:"analogous-flow",validator:o=>typeof o=="string"&&o in lt,description:"Color harmony rule for music synchronization",category:"advanced"},"sn-harmonic-intensity":{defaultValue:.7,validator:o=>typeof o=="number"&&o>=0&&o<=1,parser:o=>{let t=parseFloat(o);return!isNaN(t)&&t>=0&&t<=1?t:null},serializer:o=>o.toString(),description:"Intensity of color harmony effects (0-1)",category:"advanced"},"sn-harmonic-evolution":{defaultValue:!0,validator:o=>typeof o=="boolean",parser:o=>o==="true"?!0:o==="false"?!1:null,serializer:o=>o.toString(),description:"Enable dynamic color harmony evolution",category:"advanced"},"sn-gradient-intensity":{defaultValue:"balanced",validator:o=>typeof o=="string"&&["disabled","minimal","balanced","intense"].includes(o),description:"Master control for all gradient background effects",category:"visual"},"sn-glassmorphism-level":{defaultValue:"balanced",validator:o=>typeof o=="string"&&["disabled","minimal","balanced","intense"].includes(o),description:"Glass-like transparency effects intensity",category:"visual"},"sn-webgl-enabled":{defaultValue:!0,validator:o=>typeof o=="boolean",parser:o=>o==="true"?!0:o==="false"?!1:null,serializer:o=>o.toString(),description:"Enable WebGL-accelerated visual effects",category:"performance"},"sn-animation-quality":{defaultValue:"auto",validator:o=>typeof o=="string"&&["auto","low","high"].includes(o),description:"Animation performance vs quality balance",category:"performance"},"sn-webgl-quality":{defaultValue:"medium",validator:o=>typeof o=="string"&&["low","medium","high"].includes(o),description:"WebGL rendering quality level",category:"performance"}}});var Tt,lr=v(()=>{"use strict";or();Tt=class{constructor(t){this.changeListeners=new Set;this.cache=new Map;this.storage=t}get(t){if(this.cache.has(t))return this.cache.get(t);let e=Me[t],i=this.storage.get(t);if(i==null){let a=e.defaultValue;return this.cache.set(t,a),a}let r=Jt(t,i);if(r===null){console.warn(`[TypedSettingsManager] Invalid stored value for ${t}: "${i}", using default`);let a=e.defaultValue;return this.cache.set(t,a),a}return this.cache.set(t,r),r}set(t,e){if(!Zt(t,e))return console.error(`[TypedSettingsManager] Invalid value for ${t}:`,e),!1;let i=this.cache.get(t)??this.get(t),r=sr(t,e),a=this.storage.set(t,r);if(a){this.cache.set(t,e);let n={settingKey:t,oldValue:i,newValue:e,timestamp:Date.now()};this.notifyChangeListeners(n)}return a}getMultiple(t){let e={};for(let i of t)e[i]=this.get(i);return e}setMultiple(t){let e={};for(let[i,r]of Object.entries(t))ti(i)&&(e[i]=this.set(i,r));return e}getAllSettings(){let t={};for(let e of Mt())t[e]=this.get(e);return t}reset(t){let e=ei(t);return this.set(t,e)}resetAll(){let t={};for(let e of Mt())t[e]=this.reset(e);return t}exists(t){return this.storage.get(t)!==null}remove(t){let e=this.storage.remove(t);return e&&this.cache.delete(t),e}clearCache(){this.cache.clear()}onChange(t){this.changeListeners.add(t)}offChange(t){this.changeListeners.delete(t)}notifyChangeListeners(t){for(let e of this.changeListeners)try{e(t)}catch(i){console.error("[TypedSettingsManager] Error in change listener:",i)}}validateAllSettings(){let t={valid:0,invalid:[],missing:[]};for(let e of Mt()){let i=this.storage.get(e);if(i===null){t.missing.push({key:e,usingDefault:ei(e)});continue}Jt(e,i)===null?t.invalid.push({key:e,value:i,error:"Failed to parse or validate value"}):t.valid++}return t}export(){return this.getAllSettings()}import(t){let e={imported:0,failed:[]};for(let[i,r]of Object.entries(t)){if(!ti(i)){e.failed.push({key:i,error:"Unknown setting key"});continue}if(!Zt(i,r)){e.failed.push({key:i,error:"Invalid value for setting"});continue}this.set(i,r)?e.imported++:e.failed.push({key:i,error:"Failed to store setting"})}return e}}});function cr(){return new Ye}var Ye,ur=v(()=>{"use strict";Ye=class{constructor(){this._available=null}isAvailable(){if(this._available!==null)return this._available;try{return this._available=typeof Spicetify<"u"&&typeof Spicetify.LocalStorage?.get=="function"&&typeof Spicetify.LocalStorage?.set=="function",this._available&&Spicetify.LocalStorage.get("__test__"),this._available}catch(t){return console.warn("[SpicetifyStorageAdapter] Spicetify.LocalStorage not available:",t),this._available=!1,!1}}get(t){if(!this.isAvailable())return console.warn(`[SpicetifyStorageAdapter] Cannot get ${t}: Spicetify not available`),null;try{return Spicetify.LocalStorage.get(t)}catch(e){return console.error(`[SpicetifyStorageAdapter] Error reading key ${t}:`,e),null}}set(t,e){if(!this.isAvailable())return console.warn(`[SpicetifyStorageAdapter] Cannot set ${t}: Spicetify not available`),!1;try{return Spicetify.LocalStorage.set(t,e),!0}catch(i){return console.error(`[SpicetifyStorageAdapter] Error setting key ${t}:`,i),!1}}remove(t){if(!this.isAvailable())return console.warn(`[SpicetifyStorageAdapter] Cannot remove ${t}: Spicetify not available`),!1;try{return typeof Spicetify.LocalStorage.remove=="function"?Spicetify.LocalStorage.remove(t):Spicetify.LocalStorage.set(t,null),!0}catch(e){return console.error(`[SpicetifyStorageAdapter] Error removing key ${t}:`,e),!1}}healthCheck(){let t={available:!1,readable:!1,writable:!1,issues:[]};if(t.available=this.isAvailable(),!t.available)return t.issues.push("Spicetify.LocalStorage not available"),t;try{this.get("__health_check_read__"),t.readable=!0}catch(e){t.issues.push(`Read test failed: ${e}`)}try{let e="__health_check_write__",i="test_"+Date.now();this.set(e,i)?this.get(e)===i?(t.writable=!0,this.remove(e)):t.issues.push("Write-read consistency test failed"):t.issues.push("Write operation failed")}catch(e){t.issues.push(`Write test failed: ${e}`)}return t}getDiagnostics(){let t=[];return typeof Spicetify<"u"&&Spicetify.LocalStorage&&t.push(...Object.getOwnPropertyNames(Spicetify.LocalStorage)),{spicetifyVersion:typeof Spicetify<"u"?Spicetify.version:void 0,apiMethods:t,testResults:this.healthCheck()}}}});function mr(o){return new ct(o)}var ct,dr=v(()=>{"use strict";ct=class{constructor(t="sn-"){this.prefix=t}getPrefixedKey(t){return t.startsWith(this.prefix)?t:`${this.prefix}${t}`}isAvailable(){try{return typeof localStorage<"u"&&localStorage!==null}catch{return!1}}get(t){if(!this.isAvailable())return console.warn(`[BrowserStorageAdapter] localStorage not available for key: ${t}`),null;try{return localStorage.getItem(this.getPrefixedKey(t))}catch(e){return console.error(`[BrowserStorageAdapter] Error reading key ${t}:`,e),null}}set(t,e){if(!this.isAvailable())return console.warn(`[BrowserStorageAdapter] localStorage not available for key: ${t}`),!1;try{return localStorage.setItem(this.getPrefixedKey(t),e),!0}catch(i){return console.error(`[BrowserStorageAdapter] Error setting key ${t}:`,i),!1}}remove(t){if(!this.isAvailable())return console.warn(`[BrowserStorageAdapter] localStorage not available for key: ${t}`),!1;try{return localStorage.removeItem(this.getPrefixedKey(t)),!0}catch(e){return console.error(`[BrowserStorageAdapter] Error removing key ${t}:`,e),!1}}getAllKeys(){if(!this.isAvailable())return[];let t=[];try{for(let e=0;e<localStorage.length;e++){let i=localStorage.key(e);i&&i.startsWith(this.prefix)&&t.push(i.substring(this.prefix.length))}}catch(e){console.error("[BrowserStorageAdapter] Error enumerating keys:",e)}return t}clear(){if(!this.isAvailable())return!1;try{let t=this.getAllKeys();for(let e of t)localStorage.removeItem(this.getPrefixedKey(e));return!0}catch(t){return console.error("[BrowserStorageAdapter] Error clearing storage:",t),!1}}getUsageStats(){let t={totalKeys:0,totalSize:0,avgKeySize:0};if(!this.isAvailable())return t;try{let e=this.getAllKeys();t.totalKeys=e.length;for(let i of e){let r=this.get(i);r!==null&&(t.totalSize+=i.length+r.length)}t.avgKeySize=t.totalKeys>0?t.totalSize/t.totalKeys:0,typeof navigator<"u"&&"storage"in navigator&&"estimate"in navigator.storage&&navigator.storage.estimate().then(i=>{i.quota!==void 0&&(t.availableQuota=i.quota)}).catch(()=>{})}catch(e){console.error("[BrowserStorageAdapter] Error calculating usage stats:",e)}return t}}});function en(){return hr||(hr=new ii),hr}function je(){return en().getSettings()}var ii,hr,E,tn=v(()=>{"use strict";lr();ur();dr();ii=class{constructor(t){this.storageAdapter=t||this.detectBestStorage(),this.settingsManager=new Tt(this.storageAdapter)}detectBestStorage(){let t=cr(),e=t.healthCheck();if(e.available&&e.readable&&e.writable)return console.log("[SettingsProvider] Using Spicetify storage adapter"),t;let i=mr();return console.log("[SettingsProvider] Using browser storage adapter (localStorage)"),i}getSettings(){return this.settingsManager}getStorage(){return this.storageAdapter}getDiagnostics(){let t=this.storageAdapter instanceof Ye?"spicetify":this.storageAdapter instanceof ct?"browser":"unknown",e=null;return this.storageAdapter instanceof Ye&&(e=this.storageAdapter.healthCheck()),{storageType:t,storageHealth:e,settingsValidation:this.settingsManager.validateAllSettings(),totalSettings:Object.keys(this.settingsManager.getAllSettings()).length}}async migrateFromLegacyStorage(t){console.log("[SettingsProvider] Starting legacy settings migration...");let e=this.settingsManager.import(t);return e.imported>0&&console.log(`[SettingsProvider] Successfully migrated ${e.imported} settings`),e.failed.length>0&&console.warn(`[SettingsProvider] Failed to migrate ${e.failed.length} settings:`,e.failed),{migrated:e.imported,failed:e.failed}}healthCheck(){let t=this.getDiagnostics(),e=t.settingsValidation,i={overall:"healthy",storage:{type:t.storageType,available:!0,issues:[]},settings:{valid:e.valid,invalid:e.invalid.length,missing:e.missing.length},recommendations:[]};return t.storageHealth&&(i.storage.available=t.storageHealth.available,t.storageHealth.issues&&(i.storage.issues=t.storageHealth.issues)),!i.storage.available||i.storage.issues.length>0?(i.overall="unhealthy",i.recommendations.push("Storage system needs attention")):i.settings.invalid>0?(i.overall="degraded",i.recommendations.push("Some settings have invalid values")):i.settings.missing>5&&(i.overall="degraded",i.recommendations.push("Many settings are using defaults")),i.settings.invalid>0&&i.recommendations.push("Run settings validation and repair"),t.storageType==="browser"&&i.recommendations.push("Consider using in Spicetify environment for better integration"),i}},hr=null;E={get:o=>je().get(o),set:(o,t)=>je().set(o,t),reset:o=>je().reset(o),onChange:o=>je().onChange(o),export:()=>je().export(),import:o=>je().import(o)}});var ee=v(()=>{"use strict";tr();jt();Kt();nr();Xt();lr();or();tn();ur();dr();ee()});var ri,xt,w,B=v(()=>{"use strict";ee();jt();Kt();nr();ri=lt,xt=Re,w={enableDebug:!0,enableContextualIntelligence:!0,paletteSystem:"catppuccin",performanceProfiles:Qt,logging:ar,healthCheckInterval:1e4,visual:{lightweightParticleSystem:{mode:"artist-vision"},spatialNexusSystem:{mode:"artist-vision"},dataGlyphSystem:{mode:"artist-vision"},beatSyncVisualSystem:{mode:"artist-vision"},behavioralPredictionEngine:{mode:"artist-vision"},predictiveMaterializationSystem:{mode:"artist-vision"},sidebarVisualStateSystem:{mode:"artist-vision"}},enableColorExtraction:!0,enableMusicAnalysis:!0,enableAdvancedSync:!0,musicModulationIntensity:.4,artisticMode:"artist-vision",boundGetCurrentMultipliers:null,boundGetCurrentFeatures:null,boundGetCurrentPerformanceSettings:null,_pendingArtisticMode:null,init(){return this.boundGetCurrentMultipliers=this.getCurrentMultipliers.bind(this),this.boundGetCurrentFeatures=this.getCurrentFeatures.bind(this),this.boundGetCurrentPerformanceSettings=this.getCurrentPerformanceSettings.bind(this),!this.artisticMode||!this.paletteSystem?(this.enableDebug&&console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Loading preferences (current: artistic=${this.artisticMode}, palette=${this.paletteSystem})`),this.loadArtisticPreference()):this.enableDebug&&console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Skipping preference load (current: artistic=${this.artisticMode}, palette=${this.paletteSystem})`),this._pendingArtisticMode&&this.isFullyInitialized()&&(this.enableDebug&&console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Applying pending artistic mode: ${this._pendingArtisticMode}`),this.setArtisticMode(this._pendingArtisticMode),this._pendingArtisticMode=null),this.enableDebug&&console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Initialized with context-bound methods"),this},currentColorHarmonyMode:"analogous-flow",colorHarmonyBaseColor:null,colorHarmonyIntensity:.85,colorHarmonyEvolution:!0,musicVisualSync:{...ir,enhancedBPM:rr},getCurrentModeProfile(){let o=this.artisticMode||"artist-vision";return xt[o]||xt["artist-vision"]},getCurrentMultipliers(){try{if(typeof this.getCurrentModeProfile!="function")return console.warn("[ADVANCED_SYSTEM_CONFIG] getCurrentModeProfile method not available, using fallback multipliers"),this.artisticMultipliers;let o=this.getCurrentModeProfile();return!o||!o.multipliers?(console.warn("[ADVANCED_SYSTEM_CONFIG] Invalid profile or missing multipliers, using fallback"),this.artisticMultipliers):o.multipliers}catch(o){return console.error("[ADVANCED_SYSTEM_CONFIG] Error in getCurrentMultipliers:",o),this.artisticMultipliers}},getCurrentFeatures(){try{if(typeof this.getCurrentModeProfile!="function")return console.warn("[ADVANCED_SYSTEM_CONFIG] getCurrentModeProfile method not available, using fallback features"),{enableAdvancedEffects:!0,enableHarmony:!0,beatSync:!0,colorHarmony:!0};let o=this.getCurrentModeProfile();return!o||!o.features?(console.warn("[ADVANCED_SYSTEM_CONFIG] Invalid profile or missing features, using fallback"),{enableAdvancedEffects:!0,enableHarmony:!0,beatSync:!0,colorHarmony:!0}):o.features}catch(o){return console.error("[ADVANCED_SYSTEM_CONFIG] Error in getCurrentFeatures:",o),{enableAdvancedEffects:!0,enableHarmony:!0,beatSync:!0,colorHarmony:!0}}},getCurrentPerformanceSettings(){try{if(typeof this.getCurrentModeProfile!="function")return console.warn("[ADVANCED_SYSTEM_CONFIG] getCurrentModeProfile method not available, using fallback performance settings"),{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1};let o=this.getCurrentModeProfile();return!o||!o.performance?(console.warn("[ADVANCED_SYSTEM_CONFIG] Invalid profile or missing performance settings, using fallback"),{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1}):o.performance}catch(o){return console.error("[ADVANCED_SYSTEM_CONFIG] Error in getCurrentPerformanceSettings:",o),{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1}}},isFullyInitialized(){return["setArtisticMode","getCurrentModeProfile","getCurrentMultipliers","getCurrentFeatures","getCurrentPerformanceSettings"].every(t=>typeof this[t]=="function")},safeSetArtisticMode(o){return this.isFullyInitialized()?this.setArtisticMode(o):(console.warn("[ADVANCED_SYSTEM_CONFIG] Not fully initialized, deferring artistic mode change"),this._pendingArtisticMode=o,!1)},setArtisticMode(o){let t=Object.keys(xt);if(t.includes(o)){let e=this.artisticMode;return this.artisticMode=o,this.enableDebug&&(console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Artistic mode changed: ${e} \u2192 ${o}`),console.log("\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] New profile:",this.getCurrentModeProfile())),typeof document<"u"&&document.dispatchEvent(new CustomEvent("year3000ArtisticModeChanged",{detail:{previousMode:e,newMode:o,profile:this.getCurrentModeProfile()}})),typeof globalThis.year3000System<"u"&&globalThis.year3000System.setGradientParameters&&globalThis.year3000System.setGradientParameters(document.documentElement),!0}return console.warn(`[ADVANCED_SYSTEM_CONFIG] Invalid artistic mode: ${o}. Valid modes:`,t),!1},setLoggingLevel(o){let t=["off","error","warn","info","debug","verbose"];return t.includes(o)?(this.logging.level=o,o!=="off"&&console.log(`\u{1F527} [ADVANCED_SYSTEM_CONFIG] Logging level set to: ${o}`),!0):(console.warn(`[ADVANCED_SYSTEM_CONFIG] Invalid logging level: ${o}. Valid levels:`,t),!1)},disablePerformanceWarnings(){this.logging.performance.enableFrameBudgetWarnings=!1,console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Performance warnings disabled")},enablePerformanceWarnings(){this.logging.performance.enableFrameBudgetWarnings=!0,console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Performance warnings enabled")},setPerformanceWarningThrottle(o){return typeof o=="number"&&o>=0?(this.logging.performance.throttleInterval=o,this.logging.performance.throttleWarnings=o>0,console.log(`\u{1F527} [ADVANCED_SYSTEM_CONFIG] Performance warning throttle set to: ${o}ms`),!0):(console.warn("[ADVANCED_SYSTEM_CONFIG] Invalid throttle interval. Must be a non-negative number."),!1)},setupForProduction(){this.setLoggingLevel("warn"),this.disablePerformanceWarnings(),this.logging.performance.enableAdaptiveDegradation=!0,console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Configured for production environment")},setupForDevelopment(){this.setLoggingLevel("debug"),this.enablePerformanceWarnings(),this.setPerformanceWarningThrottle(2e3),this.logging.performance.enableAdaptiveDegradation=!0,console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Configured for development environment")},setupForDebugging(){this.setLoggingLevel("verbose"),this.enablePerformanceWarnings(),this.setPerformanceWarningThrottle(500),this.logging.performance.enableAdaptiveDegradation=!1,console.log("\u{1F527} [ADVANCED_SYSTEM_CONFIG] Configured for debugging environment")},validateConfigHealth(){let o=[],t={healthy:!0,system:"AdvancedSystemConfig",details:"Configuration health validation",issues:[],metrics:{}},i=Object.keys(this).filter(a=>typeof this[a]=="function");for(let a of i)this.hasOwnProperty(a)||o.push({key:String(a),severity:"warning",message:`Method ${a} is not an own property, may indicate prototype chain issues.`});let r=a=>{if(!xt[a]){o.push({key:`artisticMode:${a}`,severity:"critical",message:`Artistic mode profile for '${a}' is missing.`});return}t.metrics[`${a}Profile`]="ok"};return r(this.artisticMode),r("artist-vision"),r("corporate-safe"),o.length>0&&(t.healthy=!1,t.issues=o.map(a=>`[${a.severity.toUpperCase()}] ${a.key}: ${a.message}`),t.details=o.some(a=>a.severity==="critical")?"Critical configuration issues detected":"Configuration issues detected"),this.enableDebug&&console.log("[ADVANCED_SYSTEM_CONFIG] Health Check Report:",t),t},loadArtisticPreference(){try{let o=E.get("sn-artistic-mode"),t=Object.keys(xt);o&&t.includes(String(o))&&this.artisticMode!==o?(this.artisticMode=String(o),this.enableDebug&&console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Updated artistic mode from storage: ${o}`)):!o&&this.artisticMode!=="artist-vision"&&(this.artisticMode="artist-vision",this.enableDebug&&console.log("\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Reset artistic mode to default: artist-vision"));let e=E.get("sn-palette-system");e&&["catppuccin","year3000"].includes(String(e))&&this.paletteSystem!==e?(this.paletteSystem=String(e),this.enableDebug&&console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Updated palette system from storage: ${e}`)):!e&&this.paletteSystem!=="catppuccin"&&(this.paletteSystem="catppuccin",this.enableDebug&&console.log("\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Reset palette system to default: catppuccin")),this.enableDebug&&(console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Current artistic preference: ${this.artisticMode}`),console.log(`\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Current palette system: ${this.paletteSystem}`))}catch(o){this.enableDebug&&console.warn("\u{1F3A8} [ADVANCED_SYSTEM_CONFIG] Failed to load preferences:",o),this.artisticMode="artist-vision",this.paletteSystem="catppuccin"}}};typeof w.init=="function"&&w.init()});var ce,u,rn,R=v(()=>{"use strict";B();ce=class o{constructor(t={}){this.registeredSystems=new Map;this.reportHistory=[];this.monitoring=!1;this.monitoringInterval=null;this.performanceMetrics=new Map;this.config={enableConsoleReporting:w.enableDebug,reportingInterval:3e4,enablePerformanceTracking:!0,enableSystemHealthMonitoring:!0,maxHistoryEntries:50,verboseLogging:w.enableDebug,...t},this.config.enableConsoleReporting&&console.log("\u{1F527} [DebugCoordinator] Debug system initialized")}static getInstance(t){return o.instance||(o.instance=new o(t)),o.instance}registerSystem(t,e,i="unified"){let r={name:t,type:i,initialized:e.initialized||!1,healthy:!0,lastUpdate:Date.now(),issues:[],metrics:{}};this.registeredSystems.set(t,r),this.config.verboseLogging&&console.log(`\u{1F527} [UnifiedDebugManager] Registered system: ${t} (${i})`),this.registeredSystems.size===1&&!this.monitoring&&this.startMonitoring()}unregisterSystem(t){this.registeredSystems.delete(t),this.performanceMetrics.delete(t),this.config.verboseLogging&&console.log(`\u{1F527} [UnifiedDebugManager] Unregistered system: ${t}`),this.registeredSystems.size===0&&this.stopMonitoring()}updateSystem(t,e){let i=this.registeredSystems.get(t);i&&(Object.assign(i,e,{lastUpdate:Date.now()}),this.registeredSystems.set(t,i))}recordMetric(t,e,i){if(!this.config.enablePerformanceTracking)return;let r=this.registeredSystems.get(t);r&&(r.metrics[e]=i,r.lastUpdate=Date.now());let a=`${t}_${e}`,n=this.performanceMetrics.get(a)||[];n.push(i),n.length>100&&n.splice(0,n.length-100),this.performanceMetrics.set(a,n)}recordIssue(t,e){let i=this.registeredSystems.get(t);i&&(i.issues.push(e),i.healthy=!1,i.lastUpdate=Date.now(),this.config.verboseLogging&&console.warn(`\u26A0\uFE0F [${t}] ${e}`))}async performHealthCheck(){let t=Date.now(),e=[],i=0,r=0,a=0,n=0,s=0;for(let[h,g]of this.registeredSystems)try{let f=null,S=g.initialized,C=globalThis.year3000System;if(C){if(C.facadeCoordinator){try{f=C.facadeCoordinator.getCachedNonVisualSystem?.(h)||await C.facadeCoordinator.getNonVisualSystem?.(h)}catch{}if(!f)try{f=C.facadeCoordinator.getVisualSystem?.(h)}catch{}}if(!f){let M=h.charAt(0).toLowerCase()+h.slice(1);f=C[M]||C[h]}}if(f||(f=globalThis[h]),f){if(typeof f.initialized=="boolean")S=f.initialized;else if(typeof f.isInitialized=="function")try{S=await f.isInitialized()}catch{}else if(typeof f.getInitializationStatus=="function")try{let M=await f.getInitializationStatus();S=M?.initialized??M?.ready??!1}catch{}}let x=g.initialized;if(g.initialized=S,g.lastUpdate=t,this.config.verboseLogging&&x!==S&&console.log(`\u{1F527} [UnifiedDebugManager] ${h} initialization status updated: ${x} \u2192 ${S}`),f&&typeof f.healthCheck=="function"){let M=await f.healthCheck();g.healthy=M.healthy??M.ok,M.ok?g.issues=[]:g.issues=[M.details||"Health check failed"]}else g.healthy=S,S?g.issues=[]:g.issues=["System not initialized"];g.frameTime&&(a+=g.frameTime,s++),g.memoryUsage&&(n+=g.memoryUsage),g.healthy?i++:r+=g.issues.length,e.push({...g})}catch(f){g.healthy=!1,g.issues=[`Health check error: ${f}`],r++,this.config.verboseLogging&&console.error(`\u274C [${h}] Health check failed:`,f)}let l=this.registeredSystems.size>0?i/this.registeredSystems.size:1,c;if(l>=.9?c="excellent":l>=.7?c="good":l>=.5?c="degraded":c="critical",this.config.verboseLogging){console.log("\u{1F527} [UnifiedDebugManager] System initialization status for recommendations:");for(let h of e)console.log(`   ${h.name}: ${h.initialized?"\u2705":"\u274C"} initialized`)}let m=this.generateRecommendations(e,c),d={timestamp:t,overallHealth:c,systemCount:this.registeredSystems.size,healthySystems:i,totalIssues:r,systemDetails:e,performance:{avgFrameTime:s>0?a/s:0,totalMemoryMB:n,cpuUsageEstimate:this.estimateCPUUsage()},recommendations:m};return this.reportHistory.push(d),this.reportHistory.length>this.config.maxHistoryEntries&&this.reportHistory.splice(0,this.reportHistory.length-this.config.maxHistoryEntries),d}generateRecommendations(t,e){let i=[];e==="critical"&&i.push("\u{1F6A8} Critical: Multiple systems failing - check console for errors");let r=t.filter(s=>!s.initialized);r.length>0&&i.push(`\u26A0\uFE0F ${r.length} systems not initialized: ${r.map(s=>s.name).join(", ")}`);let a=t.filter(s=>s.frameTime&&s.frameTime>16.67);a.length>0&&i.push(`\u{1F40C} Performance: ${a.length} systems exceeding 16.67ms frame time`);let n=t.filter(s=>s.memoryUsage&&s.memoryUsage>50);return n.length>0&&i.push(`\u{1F4BE} Memory: ${n.length} systems using >50MB`),i.length===0&&i.push("\u2705 All systems operating within normal parameters"),i}estimateCPUUsage(){let t=0,e=0;for(let r of this.registeredSystems.values())r.frameTime&&(t+=r.frameTime,e++);if(e===0)return 0;let i=t/e;return Math.min(100,i/16.67*5)}startMonitoring(){this.monitoring||(this.monitoring=!0,this.monitoringInterval=window.setInterval(()=>{this.performHealthCheck().then(t=>{this.config.enableConsoleReporting&&this.logHealthReport(t)})},this.config.reportingInterval),this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] Monitoring started"))}stopMonitoring(){this.monitoring&&(this.monitoring=!1,this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] Monitoring stopped"))}logHealthReport(t){if(!t){this.performHealthCheck().then(i=>this.logHealthReport(i));return}let e={excellent:"\u{1F31F}",good:"\u2705",degraded:"\u26A0\uFE0F",critical:"\u{1F6A8}"}[t.overallHealth];console.group(`${e} Year 3000 System Health Report - ${new Date().toLocaleTimeString()}`),console.log(`\u{1F4CA} Overall: ${t.overallHealth.toUpperCase()} (${t.healthySystems}/${t.systemCount} healthy)`),t.totalIssues>0&&console.log(`\u{1F6A8} Issues: ${t.totalIssues} total`),console.log(`\u26A1 Performance: ${t.performance.avgFrameTime.toFixed(2)}ms avg frame, ${t.performance.totalMemoryMB.toFixed(1)}MB memory, ~${t.performance.cpuUsageEstimate.toFixed(1)}% CPU`),t.systemDetails.length>0&&(console.group("\u{1F527} System Details"),t.systemDetails.forEach(i=>{let r=i.healthy?"\u2705":"\u274C",a=i.frameTime?` (${i.frameTime.toFixed(2)}ms)`:"";console.log(`${r} ${i.name} [${i.type}]${a}`),i.issues.length>0&&i.issues.forEach(n=>{console.log(`    \u26A0\uFE0F ${n}`)})}),console.groupEnd()),t.recommendations.length>0&&(console.group("\u{1F4A1} Recommendations"),t.recommendations.forEach(i=>console.log(`  ${i}`)),console.groupEnd()),console.groupEnd()}getLatestReport(){return this.reportHistory[this.reportHistory.length-1]||null}getReportHistory(){return[...this.reportHistory]}getSystemInfo(t){return this.registeredSystems.get(t)||null}getAllSystems(){return Array.from(this.registeredSystems.values())}async checkHealth(){let t=await this.performHealthCheck();this.logHealthReport(t)}updateConfig(t){this.config={...this.config,...t},this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] Configuration updated:",t)}reset(){this.stopMonitoring(),this.registeredSystems.clear(),this.reportHistory=[],this.performanceMetrics.clear(),this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] System reset")}destroy(){this.reset(),o.instance=null}},u={debug:{log:(o,t,...e)=>{w?.enableDebug&&console.log(`[${o}] ${t}`,...e)},error:(o,t,e)=>{console.error(`[${o}] ${t}`,e),ce.getInstance().recordIssue(o,`${t}${e?`: ${e}`:""}`)},warn:(o,t,...e)=>{console.warn(`[${o}] ${t}`,...e),ce.getInstance().recordIssue(o,t)},metric:(o,t,e)=>{ce.getInstance().recordMetric(o,t,e)},register:(o,t,e)=>{ce.getInstance().registerSystem(o,t,e)},unregister:o=>{ce.getInstance().unregisterSystem(o)},checkHealth:()=>ce.getInstance().checkHealth(),getReport:()=>ce.getInstance().getLatestReport()}};typeof window<"u"&&(window.DebugCoordinator=ce,window.UnifiedDebugManager=ce,window.Y3K=u,console.log("\u{1F527} [DebugCoordinator] Global debug interface available:"),console.log("  Y3K.debug.checkHealth() - Check system health"),console.log("  Y3K.debug.getReport() - Get latest debug report"),console.log("  DebugCoordinator.getInstance() - Get debug manager"));rn=ce});var ke,gr,p,_=v(()=>{"use strict";R();ke=class ke{constructor(){this.subscriptions=new Map;this.eventMetrics={totalEvents:0,totalSubscriptions:0,activeSubscriptions:0,eventsPerSecond:0,topEvents:[],memoryUsage:0};this.eventQueue=[];this.processingQueue=!1;this.maxQueueSize=1e3;this.subscriptionCleanupInterval=null;this.metricsUpdateInterval=null;this.startMetricsMonitoring(),this.startSubscriptionCleanup(),u?.debug?.log("UnifiedEventBus","Unified event bus initialized")}static getInstance(){return ke.instance||(ke.instance=new ke),ke.instance}subscribe(t,e,i="anonymous",r={}){let a=this.generateSubscriptionId();this.subscriptions.has(t)||this.subscriptions.set(t,new Map);let n={id:a,eventName:t,handler:e,subscriberName:i,once:r.once||!1,createdAt:Date.now(),triggerCount:0};return this.subscriptions.get(t).set(a,n),this.eventMetrics.totalSubscriptions++,this.eventMetrics.activeSubscriptions++,u?.debug?.log("UnifiedEventBus",`Subscription added: ${i} -> ${t}`,{subscriptionId:a,totalSubscriptions:this.eventMetrics.activeSubscriptions}),a}once(t,e,i="anonymous"){return this.subscribe(t,e,i,{once:!0})}unsubscribe(t){for(let[e,i]of this.subscriptions.entries())if(i.has(t)){let r=i.get(t);return i.delete(t),i.size===0&&this.subscriptions.delete(e),this.eventMetrics.activeSubscriptions--,u?.debug?.log("UnifiedEventBus",`Subscription removed: ${r.subscriberName} -> ${e}`,{subscriptionId:t,remainingSubscriptions:this.eventMetrics.activeSubscriptions}),!0}return!1}unsubscribeAll(t){let e=0;for(let[i,r]of this.subscriptions.entries()){let a=Array.from(r.values()).filter(n=>n.subscriberName===t);for(let n of a)r.delete(n.id),e++,this.eventMetrics.activeSubscriptions--;r.size===0&&this.subscriptions.delete(i)}return e>0&&u?.debug?.log("UnifiedEventBus",`Removed ${e} subscriptions for: ${t}`),e}async emit(t,e){let i=Date.now();if(this.processingQueue||this.eventQueue.length>0){if(this.eventQueue.length>=this.maxQueueSize){u?.debug?.warn("UnifiedEventBus",`Event queue full, dropping event: ${t}`);return}this.eventQueue.push({eventName:t,data:e,timestamp:i}),this.processEventQueue();return}await this.processEvent(t,e,i)}emitSync(t,e){let i=Date.now();this.processEventSync(t,e,i)}async processEvent(t,e,i){let r=this.subscriptions.get(t);if(!r||r.size===0)return;this.eventMetrics.totalEvents++;let a=[],n=[];for(let[l,c]of r.entries())a.push({subscription:c,handler:c.handler}),c.once&&n.push(l),c.lastTriggered=i,c.triggerCount++;let s=a.map(async({subscription:l,handler:c})=>{try{await c(e)}catch(m){u?.debug?.error("UnifiedEventBus",`Handler error in ${l.subscriberName} for ${t}:`,m),this.emitSync("system:error",{systemName:l.subscriberName,error:m instanceof Error?m.message:"Unknown error",severity:"error",timestamp:Date.now()})}});await Promise.all(s);for(let l of n)r.delete(l),this.eventMetrics.activeSubscriptions--;r.size===0&&this.subscriptions.delete(t),u?.debug?.log("UnifiedEventBus",`Event processed: ${t}`,{handlerCount:a.length,processingTime:Date.now()-i})}processEventSync(t,e,i){let r=this.subscriptions.get(t);if(!r||r.size===0)return;this.eventMetrics.totalEvents++;let a=[];for(let[n,s]of r.entries())try{s.handler(e),s.lastTriggered=i,s.triggerCount++,s.once&&a.push(n)}catch(l){u?.debug?.error("UnifiedEventBus",`Sync handler error in ${s.subscriberName} for ${t}:`,l)}for(let n of a)r.delete(n),this.eventMetrics.activeSubscriptions--;r.size===0&&this.subscriptions.delete(t)}async processEventQueue(){if(!this.processingQueue){for(this.processingQueue=!0;this.eventQueue.length>0;){let t=this.eventQueue.shift();await this.processEvent(t.eventName,t.data,t.timestamp)}this.processingQueue=!1}}getMetrics(){return{...this.eventMetrics}}getActiveSubscriptions(){let t=[];for(let[e,i]of this.subscriptions.entries())for(let[r,a]of i.entries())t.push({eventName:e,subscriberName:a.subscriberName,subscriptionId:r,createdAt:a.createdAt,triggerCount:a.triggerCount});return t.sort((e,i)=>i.createdAt-e.createdAt)}startMetricsMonitoring(){this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},5e3)}startSubscriptionCleanup(){this.subscriptionCleanupInterval=window.setInterval(()=>{this.cleanupAbandonedSubscriptions()},6e4)}updateMetrics(){let t=Date.now(),e=this.eventMetrics.totalEvents,i=new Map;for(let[r,a]of this.subscriptions.entries()){let n=0;for(let s of a.values())n+=s.triggerCount;i.set(r,n)}this.eventMetrics.topEvents=Array.from(i.entries()).sort((r,a)=>a[1]-r[1]).slice(0,10).map(([r,a])=>({eventName:r,count:a})),this.eventMetrics.memoryUsage=this.eventMetrics.activeSubscriptions*256}cleanupAbandonedSubscriptions(){let t=Date.now()-3e5,e=0;for(let[i,r]of this.subscriptions.entries()){let a=Array.from(r.values()).filter(n=>!n.lastTriggered&&n.createdAt<t);for(let n of a)r.delete(n.id),e++,this.eventMetrics.activeSubscriptions--;r.size===0&&this.subscriptions.delete(i)}e>0&&u?.debug?.log("UnifiedEventBus",`Cleaned up ${e} abandoned subscriptions`)}generateSubscriptionId(){return`sub_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}destroy(){this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this.subscriptionCleanupInterval&&(clearInterval(this.subscriptionCleanupInterval),this.subscriptionCleanupInterval=null),this.subscriptions.clear(),this.eventQueue=[],this.eventMetrics={totalEvents:0,totalSubscriptions:0,activeSubscriptions:0,eventsPerSecond:0,topEvents:[],memoryUsage:0},u?.debug?.log("UnifiedEventBus","Unified event bus destroyed"),ke.instance=null}};ke.instance=null;gr=ke,p=gr.getInstance()});var ai,an=v(()=>{"use strict";ai=o=>({version:"1.0.0",userId:o,createdAt:Date.now(),lastModified:Date.now(),colorMemories:new Map,rhythmicPreferences:new Map,emotionalResonanceProfile:{},evolutionaryTrajectory:{adaptability:.5,explorationFactor:.5,lastUpdate:Date.now()}})});function Lo(){return nn||(nn=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Ro(){return sn||(sn=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}function ko(o){let t=new Promise((e,i)=>{let r=()=>{o.removeEventListener("success",a),o.removeEventListener("error",n)},a=()=>{e(Ke(o.result)),r()},n=()=>{i(o.error),r()};o.addEventListener("success",a),o.addEventListener("error",n)});return ni.set(t,o),t}function Vo(o){if(yr.has(o))return;let t=new Promise((e,i)=>{let r=()=>{o.removeEventListener("complete",a),o.removeEventListener("error",n),o.removeEventListener("abort",n)},a=()=>{e(),r()},n=()=>{i(o.error||new DOMException("AbortError","AbortError")),r()};o.addEventListener("complete",a),o.addEventListener("error",n),o.addEventListener("abort",n)});yr.set(o,t)}function un(o){vr=o(vr)}function Fo(o){return Ro().includes(o)?function(...t){return o.apply(Sr(this),t),Ke(this.request)}:function(...t){return Ke(o.apply(Sr(this),t))}}function Go(o){return typeof o=="function"?Fo(o):(o instanceof IDBTransaction&&Vo(o),br(o,Lo())?new Proxy(o,vr):o)}function Ke(o){if(o instanceof IDBRequest)return ko(o);if(pr.has(o))return pr.get(o);let t=Go(o);return t!==o&&(pr.set(o,t),ni.set(t,o)),t}function mn(o,t,{blocked:e,upgrade:i,blocking:r,terminated:a}={}){let n=indexedDB.open(o,t),s=Ke(n);return i&&n.addEventListener("upgradeneeded",l=>{i(Ke(n.result),l.oldVersion,l.newVersion,Ke(n.transaction),l)}),e&&n.addEventListener("blocked",l=>e(l.oldVersion,l.newVersion,l)),s.then(l=>{a&&l.addEventListener("close",()=>a()),r&&l.addEventListener("versionchange",c=>r(c.oldVersion,c.newVersion,c))}).catch(()=>{}),s}function on(o,t){if(!(o instanceof IDBDatabase&&!(t in o)&&typeof t=="string"))return;if(fr.get(t))return fr.get(t);let e=t.replace(/FromIndex$/,""),i=t!==e,r=Bo.includes(e);if(!(e in(i?IDBIndex:IDBObjectStore).prototype)||!(r||_o.includes(e)))return;let a=async function(n,...s){let l=this.transaction(n,r?"readwrite":"readonly"),c=l.store;return i&&(c=c.index(s.shift())),(await Promise.all([c[e](...s),r&&l.done]))[0]};return fr.set(t,a),a}async function*Oo(...o){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...o)),!t)return;t=t;let e=new Proxy(t,zo);for(dn.set(e,t),ni.set(e,Sr(t));t;)yield e,t=await(Cr.get(e)||t.continue()),Cr.delete(e)}function cn(o,t){return t===Symbol.asyncIterator&&br(o,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&br(o,[IDBIndex,IDBObjectStore])}var br,nn,sn,yr,pr,ni,vr,Sr,_o,Bo,fr,Ho,ln,Cr,dn,zo,hn=v(()=>{br=(o,t)=>t.some(e=>o instanceof e);yr=new WeakMap,pr=new WeakMap,ni=new WeakMap;vr={get(o,t,e){if(o instanceof IDBTransaction){if(t==="done")return yr.get(o);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return Ke(o[t])},set(o,t,e){return o[t]=e,!0},has(o,t){return o instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in o}};Sr=o=>ni.get(o);_o=["get","getKey","getAll","getAllKeys","count"],Bo=["put","add","delete","clear"],fr=new Map;un(o=>({...o,get:(t,e,i)=>on(t,e)||o.get(t,e,i),has:(t,e)=>!!on(t,e)||o.has(t,e)}));Ho=["continue","continuePrimaryKey","advance"],ln={},Cr=new WeakMap,dn=new WeakMap,zo={get(o,t){if(!Ho.includes(t))return o[t];let e=ln[t];return e||(e=ln[t]=function(...i){Cr.set(this,dn.get(this)[t](...i))}),e}};un(o=>({...o,get(t,e,i){return cn(t,e)?Oo:o.get(t,e,i)},has(t,e){return cn(t,e)||o.has(t,e)}}))});var Uo,No,si,gn,Er,Pt,pn=v(()=>{"use strict";an();hn();Uo="Year3000-TemporalMemory",No=1,si="aestheticSignatures",gn="currentUser",Er=class{constructor(){this.dbPromise=mn(Uo,No,{upgrade(t){t.objectStoreNames.contains(si)||t.createObjectStore(si)}})}async getSignature(t="defaultUser"){try{let i=await(await this.dbPromise).get(si,gn);if(i)return i;{let r=ai(t);return await this.saveSignature(r),r}}catch(e){return console.error("[TemporalMemoryService] Failed to get signature from IndexedDB. Returning default.",e),ai(t)}}async saveSignature(t){try{let e=await this.dbPromise;t.lastModified=Date.now(),await e.put(si,t,gn)}catch(e){console.error("[TemporalMemoryService] Failed to save signature to IndexedDB.",e)}}async resetSignature(t="defaultUser"){let e=ai(t);return await this.saveSignature(e),console.log("[TemporalMemoryService] Aesthetic signature has been reset."),e}async getSignatureTrends(t){if(!t)return null;let e={dominantColor:null,dominantRhythm:null,avgEnergy:0,avgValence:0},i=null;t.colorMemories.forEach((s,l)=>{(!i||s.count>i.count)&&(i={hex:l,count:s.count}),e.avgValence+=s.emotionalValence*s.count});let r=0;t.colorMemories.forEach(s=>r+=s.count),r>0&&(e.avgValence/=r),e.dominantColor=i;let a=null;t.rhythmicPreferences.forEach((s,l)=>{(!a||s.count>a.count)&&(a={id:l,count:s.count}),e.avgEnergy+=s.associatedEnergy*s.count});let n=0;return t.rhythmicPreferences.forEach(s=>n+=s.count),n>0&&(e.avgEnergy/=n),e.dominantRhythm=a,e}},Pt=new Er});var Te,ut,wr=v(()=>{"use strict";_();pn();Te=class Te{constructor(t,e,i,r){this.performanceCoordinator=null;this.cssAnimationManager=null;this.animations=new Map;this.frameCallbacks=new Map;this.callbackCounter=0;this.animationFrameId=null;this.isRunning=!1;this.isPaused=!1;this.lastTimestamp=0;this.frameCount=0;this.startTime=0;this.frameTimeBudget=16;this.metrics={totalFrames:0,droppedFrames:0,averageFrameTime:0,maxFrameTime:0,performanceMode:"quality",activeAnimations:0,activeCallbacks:0,frameRate:60,lastOptimization:0};this.frameContext={timestamp:0,deltaMs:0,performanceMode:"quality",frameBudget:16,beatIntensity:0,scrollRatio:0,tiltXY:{x:0,y:0}};this.performanceHistory=[];this.MAX_HISTORY_SIZE=60;this.cssVariableManager=null;this.cssAnimationStates=new Map;this.activeCSSAnimations=new Map;this.cssAnimationObservers=new Map;this.beatSyncState={intensity:0,tempo:120,phase:0,lastBeatTime:0,avgBeatInterval:500};this.lerpOperations=new Map;this.CSS_ANIMATION_CONFIGS={visualEffectsGentleBreathing:{name:"visualEffects-gentle-animation",duration:4e3,easing:"ease-in-out",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},energeticPulse:{name:"energetic-pulse-animation",duration:1200,easing:"cubic-bezier(0.23, 1, 0.32, 1)",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"alternate"},meditativeFlow:{name:"meditative-flow-animation",duration:8e3,easing:"ease-in-out",iterations:"infinite",fillMode:"both",playState:"running",delay:0,direction:"normal"}};this.signature=null;this.saveInterval=null;this.currentBpm=120;this.currentIntensity=.5;this.emergentEventSubscriptions=[];this.animate=()=>{if(!this.isRunning)return;let t=performance.now(),e=t-this.lastTimestamp;if(this.isPaused){this.animationFrameId=requestAnimationFrame(this.animate);return}this.frameContext.timestamp=t,this.frameContext.deltaMs=e;let i=performance.now(),r=this.frameTimeBudget,a=performance.now();this.executeFrameCallbacks(e,t);let n=performance.now()-a,s=r-n;s>2?this.executeAnimationSystemsWithBudget(e,t,s):(this.metrics.droppedFrames++,this.config.enableDebug&&Math.random()<.1&&console.warn(`[AnimationFrameCoordinator] Skipped animation systems - budget exceeded: ${n.toFixed(2)}ms`));let l=performance.now()-i;l<r*.7&&this.updateConsolidatedAnimations(t,e),l<r*.8&&this.updateAdaptiveAnimations(e);let c=performance.now()-i;this.updatePerformanceMetrics(c),this.performanceCoordinator&&this.performanceCoordinator.trackSubsystem("MasterAnimationCoordinator",{frameTime:c,fps:this.metrics.frameRate,memoryUsage:performance.memory?.usedJSHeapSize||0,cpuUsage:c>this.frameTimeBudget?c/this.frameTimeBudget*10:0}),this.lastTimestamp=t,this.frameCount++,c>r*1.5?setTimeout(()=>{this.animationFrameId=requestAnimationFrame(this.animate)},4):this.animationFrameId=requestAnimationFrame(this.animate)};this.config=t,this.eventBus=p,this.performanceCoordinator=e||null,this.cssAnimationManager=i||null,this.cssVariableManager=r||null,this.startTime=performance.now(),this.lastTimestamp=this.startTime,this.currentMultipliers=this.config.cosmicMultipliers,this.initializeConsolidatedSystems(),this.subscribeToEvents(),this.initializeAdaptiveSystem(),this.updateFrameBudget(),this.config.enableDebug&&console.log("[AnimationFrameCoordinator] Initialized with unified animation coordination, CSS management, and LERP orchestration")}updateVisualPulseEffects(t){if(!this.cssAnimationManager)return;let e=t.energy||t.intensity||.5,i=t.bpm||this.currentBpm||120;if(Math.abs(e-this.currentIntensity)<.1&&Math.abs(i-this.currentBpm)<5)return;let a=document.querySelectorAll(".Root__main-view::before, .Root__main-view, [data-visual-effects-pulsing]");a.length>0&&(this.triggerConsciousnessBreathing(a,e,i),this.config.enableDebug&&console.log(`[AnimationFrameCoordinator] Visual effects pulsing coordinated - Energy: ${e.toFixed(2)}, Tempo: ${i} BPM`)),this.currentIntensity=e,this.currentBpm=i}static getInstance(t,e,i){if(!Te.instance){if(!t)throw new Error("AnimationFrameCoordinator requires config for first initialization");Te.instance=new Te(t,e,i)}return Te.instance}registerCSSAnimationManager(t){this.cssAnimationManager=t,this.config.enableDebug&&console.log("[AnimationFrameCoordinator] CSSAnimationManager registered for pulsing coordination")}registerAnimationSystem(t,e,i="normal",r=60){if(this.animations.has(t))return this.config.enableDebug&&console.warn(`[AnimationFrameCoordinator] Animation system ${t} already registered`),!1;let a={name:t,system:e,priority:i,targetFPS:r,type:"animation",enabled:!0,frameInterval:1e3/r,lastUpdate:0,frameCount:0,totalTime:0,averageFrameTime:0,maxFrameTime:0,skippedFrames:0};return this.animations.set(t,a),this.isRunning||this.startMasterAnimationLoop(),this.updateMetrics(),this.config.enableDebug&&console.log(`[AnimationFrameCoordinator] Registered animation system: ${t} (priority: ${i}, fps: ${r})`),!0}registerVisualSystem(t,e="normal"){if(this.animations.has(t.systemName))return this.config.enableDebug&&console.warn(`[AnimationFrameCoordinator] Visual system ${t.systemName} already registered`),!1;let i={name:t.systemName,system:t,priority:e,targetFPS:60,type:"visual",enabled:!0,frameInterval:16.67,lastUpdate:0,frameCount:0,totalTime:0,averageFrameTime:0,maxFrameTime:0,skippedFrames:0};return this.animations.set(t.systemName,i),this.isRunning||this.startMasterAnimationLoop(),this.updateMetrics(),this.config.enableDebug&&console.log(`[AnimationFrameCoordinator] Registered visual system: ${t.systemName} (priority: ${e})`),!0}registerFrameCallback(t,e="normal",i){let r=`callback_${++this.callbackCounter}`,a={id:r,callback:t,priority:e,system:i||void 0,enabled:!0,frameCount:0,totalTime:0,lastExecution:0};return this.frameCallbacks.set(r,a),this.isRunning||this.startMasterAnimationLoop(),this.updateMetrics(),this.config.enableDebug&&console.log(`[AnimationFrameCoordinator] Registered frame callback: ${r} (priority: ${e})`),r}unregisterAnimationSystem(t){let e=this.animations.delete(t);return e&&(this.updateMetrics(),this.animations.size===0&&this.frameCallbacks.size===0&&this.stopMasterAnimationLoop(),this.config.enableDebug&&console.log(`[AnimationFrameCoordinator] Unregistered animation system: ${t}`)),e}unregisterFrameCallback(t){let e=this.frameCallbacks.delete(t);return e&&(this.updateMetrics(),this.animations.size===0&&this.frameCallbacks.size===0&&this.stopMasterAnimationLoop(),this.config.enableDebug&&console.log(`[AnimationFrameCoordinator] Unregistered frame callback: ${t}`)),e}startMasterAnimationLoop(){this.isRunning||(this.isRunning=!0,this.isPaused=!1,this.lastTimestamp=performance.now(),this.frameCount=0,this.animate(),this.config.enableDebug&&console.log("[AnimationFrameCoordinator] Master animation loop started"))}stopMasterAnimationLoop(){this.isRunning&&(this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.config.enableDebug&&console.log("[AnimationFrameCoordinator] Master animation loop stopped"))}pauseAnimationLoop(){this.isPaused=!0,this.config.enableDebug&&console.log("[AnimationFrameCoordinator] Animation loop paused")}resumeAnimationLoop(){this.isPaused&&(this.isPaused=!1,this.lastTimestamp=performance.now(),this.config.enableDebug&&console.log("[AnimationFrameCoordinator] Animation loop resumed"))}setPerformanceMode(t){this.metrics.performanceMode=t,this.frameContext.performanceMode=t,this.frameTimeBudget=t==="performance"?8:16,this.frameContext.frameBudget=this.frameTimeBudget;for(let e of this.animations.values())e.system.onPerformanceModeChange&&e.system.onPerformanceModeChange(t);this.config.enableDebug&&console.log(`[AnimationFrameCoordinator] Performance mode set to: ${t}`)}getPerformanceMetrics(){return{...this.metrics}}getRegisteredSystems(){return{animations:new Map(this.animations),callbacks:new Map(this.frameCallbacks)}}setSystemEnabled(t,e){let i=this.animations.get(t);return i?(i.enabled=e,this.updateMetrics(),this.config.enableDebug&&console.log(`[AnimationFrameCoordinator] System ${t} ${e?"enabled":"disabled"}`),!0):!1}getCurrentMultipliers(){return this.currentMultipliers}async updateEvolutionaryTrajectory(){await this._updateEvolutionaryTrajectory()}destroy(){this.stopMasterAnimationLoop(),this.destroyConsolidatedSystems(),this.destroyAdaptiveSystem();for(let t of this.animations.values())if(t.type==="visual"&&"destroy"in t.system)try{t.system.destroy()}catch(e){console.error(`[AnimationFrameCoordinator] Error destroying system ${t.name}:`,e)}this.animations.clear(),this.frameCallbacks.clear(),Te.instance===this&&(Te.instance=null),this.config.enableDebug&&console.log("[AnimationFrameCoordinator] Destroyed")}executeFrameCallbacks(t,e){let i=Array.from(this.frameCallbacks.values()).filter(r=>r.enabled).sort((r,a)=>{let n={critical:0,normal:1,background:2};return n[r.priority]-n[a.priority]});for(let r of i){let a=performance.now();try{r.callback(t,e);let n=performance.now()-a;r.totalTime+=n,r.frameCount++,r.lastExecution=e,n>this.frameTimeBudget*.5&&this.config.enableDebug&&console.warn(`[AnimationFrameCoordinator] Callback ${r.id} exceeded budget: ${n.toFixed(2)}ms`)}catch(n){console.error(`[AnimationFrameCoordinator] Error in callback ${r.id}:`,n)}}}executeAnimationSystems(t,e){let i=Array.from(this.animations.values()).filter(r=>r.enabled).sort((r,a)=>{let n={critical:0,normal:1,background:2};return n[r.priority]-n[a.priority]});for(let r of i){if(e-r.lastUpdate<r.frameInterval){r.skippedFrames++;continue}let a=performance.now();try{if(r.type==="visual")r.system.onAnimate(t,this.frameContext);else{let s=r.system;s.onAnimate&&s.onAnimate(t),s.updateAnimation&&s.updateAnimation(e,t)}let n=performance.now()-a;r.totalTime+=n,r.frameCount++,r.lastUpdate=e,r.averageFrameTime=r.totalTime/r.frameCount,r.maxFrameTime=Math.max(r.maxFrameTime,n),n>this.frameTimeBudget*.8&&this.config.enableDebug&&console.warn(`[AnimationFrameCoordinator] System ${r.name} exceeded budget: ${n.toFixed(2)}ms`)}catch(n){console.error(`[AnimationFrameCoordinator] Error in system ${r.name}:`,n)}}}executeAnimationSystemsWithBudget(t,e,i){let r=performance.now(),a=Array.from(this.animations.values()).filter(c=>c.enabled).sort((c,m)=>{let d={critical:0,normal:1,background:2};return d[c.priority]-d[m.priority]}),n=0,s=0;for(let c of a){if(performance.now()-r>=i*.9){s=a.length-n,this.config.enableDebug&&s>0&&console.warn(`[AnimationFrameCoordinator] Budget exhausted: skipped ${s} systems`);break}if(e-c.lastUpdate<c.frameInterval){c.skippedFrames++;continue}let d=performance.now();try{if(c.type==="visual")c.system.onAnimate(t,this.frameContext);else{let g=c.system;g.onAnimate&&g.onAnimate(t),g.updateAnimation&&g.updateAnimation(e,t)}let h=performance.now()-d;c.totalTime+=h,c.frameCount++,c.lastUpdate=e,c.averageFrameTime=c.totalTime/c.frameCount,c.maxFrameTime=Math.max(c.maxFrameTime,h),n++,h>i*.3&&this.config.enableDebug&&console.warn(`[AnimationFrameCoordinator] System ${c.name} consuming excessive budget: ${h.toFixed(2)}ms`)}catch(h){console.error(`[AnimationFrameCoordinator] Error in system ${c.name}:`,h),n++}}let l=performance.now()-r;s>0&&(this.metrics.droppedFrames+=s),this.config.enableDebug&&Math.random()<.02&&console.log(`[AnimationFrameCoordinator] Budget usage: ${l.toFixed(2)}ms/${i.toFixed(2)}ms, processed: ${n}/${a.length}`)}updatePerformanceMetrics(t){this.metrics.totalFrames++,this.metrics.maxFrameTime=Math.max(this.metrics.maxFrameTime,t),this.performanceHistory.push(t),this.performanceHistory.length>this.MAX_HISTORY_SIZE&&this.performanceHistory.shift(),this.metrics.averageFrameTime=this.performanceHistory.reduce((e,i)=>e+i,0)/this.performanceHistory.length,this.metrics.frameRate=this.performanceHistory.length>0?1e3/this.metrics.averageFrameTime:60,t>this.frameTimeBudget*1.5&&this.metrics.droppedFrames++,this.metrics.averageFrameTime>this.frameTimeBudget*1.2&&this.metrics.performanceMode==="quality"?(this.setPerformanceMode("performance"),this.metrics.lastOptimization=Date.now()):this.metrics.averageFrameTime<this.frameTimeBudget*.8&&this.metrics.performanceMode==="performance"&&Date.now()-this.metrics.lastOptimization>5e3&&this.setPerformanceMode("quality")}updateFrameBudget(){this.frameTimeBudget=this.metrics.performanceMode==="performance"?8:16,this.frameContext.frameBudget=this.frameTimeBudget}updateMetrics(){this.metrics.activeAnimations=Array.from(this.animations.values()).filter(t=>t.enabled).length,this.metrics.activeCallbacks=Array.from(this.frameCallbacks.values()).filter(t=>t.enabled).length}subscribeToEvents(){this.eventBus.subscribe("music:beat",t=>{this.frameContext.beatIntensity=t.intensity||0,this.updateVisualPulseEffects(t)},"AnimationFrameCoordinator"),this.eventBus.subscribe("performance:frame",t=>{if(t.fps<45){for(let e of this.animations.values())e.frameInterval=Math.min(e.frameInterval*1.5,33.33);this.setPerformanceMode("performance")}else t.fps>55&&this.setPerformanceMode("quality")},"AnimationFrameCoordinator")}async initializeAdaptiveSystem(){try{this.signature=await Pt.getSignature(),this.registerEmergentEventListeners(),this.saveInterval=setInterval(()=>{this.signature&&Pt.saveSignature(this.signature)},3e4),this.config.enableDebug&&console.log("[AnimationFrameCoordinator] Emergent choreography initialized")}catch(t){console.error("[AnimationFrameCoordinator] Failed to initialize adaptive choreography:",t)}}registerEmergentEventListeners(){let t=this.eventBus.subscribe("music:beat",a=>this.handleBeatFrame(a),"AnimationFrameCoordinator"),e=this.eventBus.subscribe("colors:harmonized",a=>this.handleHarmonyFrame(a),"AnimationFrameCoordinator"),i=this.eventBus.subscribe("music:energy",a=>{this.currentBpm=a.tempo},"AnimationFrameCoordinator"),r=this.eventBus.subscribe("music:beat",a=>{this.currentIntensity=a.intensity},"AnimationFrameCoordinator");this.emergentEventSubscriptions.push(t,e,i,r)}handleBeatFrame(t){this.signature&&(this.signature.lastModified=Date.now(),this.updateVisualPulseEffects({intensity:t.intensity||this.currentIntensity,energy:t.energy||this.currentIntensity,bpm:this.currentBpm}))}handleHarmonyFrame(t){if(!this.signature)return;let{kineticState:e}=t;this.signature.lastModified=Date.now()}async _updateEvolutionaryTrajectory(){if(!this.signature)return;let t=await Pt.getSignatureTrends(this.signature);if(!t)return;let{avgEnergy:e,avgValence:i}=t,r=.5+(e-.5)*.2;this.signature.evolutionaryTrajectory.explorationFactor=Math.max(.1,Math.min(.9,r));let a=.5+(Math.abs(i)-.2)*.3;this.signature.evolutionaryTrajectory.adaptability=Math.max(.1,Math.min(.9,a)),this.signature.evolutionaryTrajectory.lastUpdate=Date.now()}_calculateVisualPulse(t){let e=6e4/this.currentBpm,i=performance.now()%e/e,r=Math.sin(i*2*Math.PI+Math.PI/2)*15*this.currentIntensity;return{timestamp:performance.now(),bpm:this.currentBpm,intensity:this.currentIntensity,phase:i,hueShift:r}}_calculateAdaptiveCoefficients(){if(!this.signature)return;let{adaptability:t,explorationFactor:e}=this.signature.evolutionaryTrajectory,i=.5+t*.5,r=.8+e*.4;this.currentMultipliers={...this.config.cosmicMultipliers,kineticIntensity:i,visualIntensityBase:r}}updateAdaptiveAnimations(t){if(!this.signature)return;this._calculateAdaptiveCoefficients(),this.signature&&Date.now()-this.signature.evolutionaryTrajectory.lastUpdate>6e4&&this._updateEvolutionaryTrajectory();let e=this._calculateVisualPulse(t),i={timestamp:performance.now(),deltaMs:t}}destroyAdaptiveSystem(){this.signature&&Pt.saveSignature(this.signature),this.saveInterval&&(clearInterval(this.saveInterval),this.saveInterval=null),this.emergentEventSubscriptions.forEach(t=>this.eventBus.unsubscribe(t)),this.emergentEventSubscriptions=[],this.config.enableDebug&&console.log("[AnimationFrameCoordinator] Emergent choreography destroyed")}initializeConsolidatedSystems(){this.cssAnimationStates.set("default",{rippleActive:!1,bloomActive:!1,refractActive:!1,oscillateActive:!1,harmonizeActive:!1,timeBasedEchoActive:!1,gravityActive:!1,beatSyncEnabled:!0,intensityLevel:.5,tempoMultiplier:1});try{this.eventBus.subscribe("music:beat",t=>{this.onBeatDetected(t)}),this.eventBus.subscribe("music:energy",t=>{this.onMusicalAnalysis(t)})}catch{console.warn("[AnimationFrameCoordinator] Event subscription failed, using manual coordination")}this.config.enableDebug&&console.log("[AnimationFrameCoordinator] Consolidated systems initialized")}static calculateMusicalLerp(t,e="flow",i){let r=Math.max(.3,Math.min(2,t.tempo/120)),a=Math.max(.1,Math.min(1,t.energy)),n=i||16.67*(2-a)*(1/r),s={flow:{intensityMod:.7,easingPower:1.2},pulse:{intensityMod:1.3,easingPower:2},smooth:{intensityMod:.5,easingPower:.8},sharp:{intensityMod:1.1,easingPower:3}},l=s[e]||s.flow,c=a*l.intensityMod;return{halfLife:n,intensity:c,easing:d=>Math.pow(d,l.easingPower)}}createCSSAnimation(t,e,i){try{let r=i?.animate?.({},{duration:e.duration,easing:e.easing,iterations:e.iterations==="infinite"?1/0:e.iterations,fill:e.fillMode,delay:e.delay,direction:e.direction});r&&(this.activeCSSAnimations.set(t,r),this.cssVariableManager&&this.cssVariableManager.batchSetVariables({[`--sn-animation-${t}-duration`]:`${e.duration}ms`,[`--sn-animation-${t}-easing`]:e.easing,[`--sn-animation-${t}-delay`]:`${e.delay}ms`}))}catch(r){console.warn(`[AnimationFrameCoordinator] Failed to create CSS animation ${t}:`,r)}}createMusicalLerp(t,e,i,r,a){let n={id:t,startValue:e,targetValue:i,startTime:performance.now(),duration:r,easing:a.easing||(s=>s),onUpdate:a.onUpdate};a.musicalContext&&(n.musicalContext=a.musicalContext),a.onComplete&&(n.onComplete=a.onComplete),this.lerpOperations.set(t,n),this.config.enableDebug&&console.log(`[AnimationFrameCoordinator] Created musical LERP: ${t}`)}onBeatDetected(t){this.beatSyncState.intensity=t.intensity||.5,this.beatSyncState.tempo=t.bpm||120,this.beatSyncState.lastBeatTime=performance.now(),this.cssVariableManager&&this.cssVariableManager.batchSetVariables({"--sn-beat-intensity":this.beatSyncState.intensity.toString(),"--sn-beat-tempo":this.beatSyncState.tempo.toString(),"--sn-beat-phase":(performance.now()%1e3/1e3).toString()}),this.triggerBeatSyncAnimations()}onMusicalAnalysis(t){let e={tempo:t.bpm||120,energy:t.energy||.5,valence:t.valence||.5,danceability:t.danceability||.5,emotionalTemperature:t.emotionalTemperature||4e3,beatPhase:t.beatPhase||"sustain",beatConfidence:t.beatConfidence||.5,beatInterval:t.beatInterval||500,timeSinceLastBeat:t.timeSinceLastBeat||0,bpm:t.bpm||120,beat:t.beat||0,energyLevel:t.energy||.5,harmonicContent:t.harmonic||.5,rhythmicStability:t.stability||.8,harmonicComplexity:t.harmonicComplexity||.5,rhythmicDensity:t.rhythmicDensity||.5,spectralCentroid:t.spectralCentroid||.5};this.lerpOperations.forEach((i,r)=>{i.musicalContext&&(i.musicalContext={...i.musicalContext,...e})})}triggerBeatSyncAnimations(){this.cssAnimationStates.forEach((t,e)=>{if(t.beatSyncEnabled){let i=this.beatSyncState.intensity*t.intensityLevel,r=this.beatSyncState.tempo*t.tempoMultiplier;this.cssVariableManager&&this.cssVariableManager.batchSetVariables({[`--sn-${e}-beat-intensity`]:i.toString(),[`--sn-${e}-beat-tempo`]:r.toString()})}})}processLerpOperations(t){let e=[];this.lerpOperations.forEach((i,r)=>{let a=t-i.startTime,n=Math.min(a/i.duration,1),s=i.easing(n),l=i.startValue+(i.targetValue-i.startValue)*s,c=l;if(i.musicalContext){let m=Math.sin(t*.001*i.musicalContext.bpm/60)*.1;c=l+m*i.musicalContext.energyLevel}i.onUpdate(c),n>=1&&(i.onComplete&&i.onComplete(),e.push(r))}),e.forEach(i=>this.lerpOperations.delete(i))}updateConsolidatedAnimations(t,e){if(this.processLerpOperations(t),this.updateCSSAnimationSync(t,e),this.beatSyncState.tempo>0){let i=6e4/this.beatSyncState.tempo,r=(t-this.beatSyncState.lastBeatTime)/i;this.cssVariableManager&&this.cssVariableManager.setVariable("--sn-beat-phase",(r%1).toString())}}updateCSSAnimationSync(t,e){this.activeCSSAnimations.forEach((i,r)=>{if(i.playState==="running"){let a=this.cssAnimationStates.get(r);if(a?.beatSyncEnabled){let n=this.beatSyncState.tempo/120;i.playbackRate=n*a.tempoMultiplier}}})}getConsolidatedMetrics(){return{...this.metrics,activeCSSAnimations:this.activeCSSAnimations.size,activeLerpOperations:this.lerpOperations.size,beatSyncState:{...this.beatSyncState},cssAnimationStates:this.cssAnimationStates.size}}destroyConsolidatedSystems(){this.activeCSSAnimations.forEach(t=>t.cancel()),this.activeCSSAnimations.clear(),this.lerpOperations.clear(),this.cssAnimationStates.clear(),this.config.enableDebug&&console.log("[AnimationFrameCoordinator] Consolidated systems destroyed")}triggerConsciousnessBreathing(t,e=.5,i=120){if(!t)return;(Array.isArray(t)?t:t instanceof NodeList?Array.from(t):[t]).forEach(a=>{if(a instanceof Element){this.cssVariableManager&&this.cssVariableManager.batchSetVariables({"--sn-consciousness-energy":e.toString(),"--sn-consciousness-tempo":i.toString(),"--sn-consciousness-duration":`${Math.max(1e3,4e3/Math.max(.5,e))}ms`,"--sn-consciousness-active":"1"}),a.classList.add("sn-consciousness-breathing");let n=Math.max(1e3,4e3/Math.max(.5,e));setTimeout(()=>{a.classList.remove("sn-consciousness-breathing")},n)}}),this.config.enableDebug&&console.log(`[AnimationFrameCoordinator] Triggered consciousness breathing - Energy: ${e.toFixed(2)}, Tempo: ${i} BPM`)}stopConsciousnessBreathing(){document.querySelectorAll(".sn-consciousness-breathing").forEach(e=>{e.classList.remove("sn-consciousness-breathing")}),this.cssVariableManager&&this.cssVariableManager.batchSetVariables({"--sn-consciousness-active":"0","--sn-consciousness-energy":"0","--sn-consciousness-tempo":"120"}),this.config.enableDebug&&console.log("[AnimationFrameCoordinator] Stopped consciousness breathing")}triggerRipple(t,e=.5){!t||!(t instanceof Element)||(this.cssVariableManager&&this.cssVariableManager.batchSetVariables({"--sn-ripple-intensity":e.toString(),"--sn-ripple-active":"1"}),t.classList.add("sn-ripple-effect"),setTimeout(()=>{t.classList.remove("sn-ripple-effect"),this.cssVariableManager&&this.cssVariableManager.setVariable("--sn-ripple-active","0")},1e3))}getCSSAnimationManagerInterface(){return{triggerConsciousnessBreathing:this.triggerConsciousnessBreathing.bind(this),stopConsciousnessBreathing:this.stopConsciousnessBreathing.bind(this),triggerRipple:this.triggerRipple.bind(this)}}};Te.instance=null;ut=Te});var k={};ne(k,{adjustColor:()=>gl,bpmToAnimationFrameRate:()=>Xo,bpmToInterval:()=>At,calculateBreathingScale:()=>rl,calculateContrastRatio:()=>Yo,calculateNavigationScale:()=>al,calculateOklabDerivedProperties:()=>sl,calculateRhythmPhase:()=>il,colorDifference:()=>cl,debounce:()=>Wo,easeBeatAnimation:()=>tl,findRequiredLuminance:()=>dl,generateHarmonicOklabColors:()=>ol,getBeatPhase:()=>Jo,getCanonicalAccent:()=>pl,getHealthMonitor:()=>ml,getNextBeatTime:()=>el,getRootStyle:()=>fn,hexToRgb:()=>be,hslToRgb:()=>yn,intervalToBpm:()=>Qo,isOnBeat:()=>Zo,isValidHexColor:()=>bn,lerp:()=>ll,lerpSmooth:()=>K,lerpSmoothMusical:()=>vn,lerpSmoothMusicalPerformance:()=>jo,lerpSmoothSimpleMusical:()=>Ko,oklabToRgb:()=>nl,processOklabColor:()=>Pr,rgbToHex:()=>oi,rgbToHsl:()=>xr,rgbToOklab:()=>Mr,sanitizeColorMap:()=>qo,sleep:()=>hl,throttle:()=>$o});function fn(){return document.documentElement}function $o(o,t){let e;return function(...r){e||(o(...r),e=!0,setTimeout(()=>e=!1,t))}}function Wo(o,t){let e;return function(...r){clearTimeout(e),e=window.setTimeout(()=>o(...r),t)}}function bn(o){if(typeof o!="string")return!1;let t=o.trim(),e=t.startsWith("#")?t:`#${t}`;return/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/.test(e)}function be(o){if(typeof o!="string")return{r:0,g:0,b:0};if(!bn(o))return{r:0,g:0,b:0};let t=o.trim(),e=t.startsWith("#")?t:`#${t}`;e=e.replace(/##+/g,"#"),e.length===4&&(e=`#${e[1]}${e[1]}${e[2]}${e[2]}${e[3]}${e[3]}`);let i=/^#([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(i)try{return{r:parseInt(i[1]||"0",16),g:parseInt(i[2]||"0",16),b:parseInt(i[3]||"0",16)}}catch{return{r:0,g:0,b:0}}else return{r:0,g:0,b:0}}function qo(o){console.log("\u{1F3A8} [ThemeUtilities] sanitizeColorMap input:",{input:o,inputKeys:o?Object.keys(o):[],inputEntries:o?Object.entries(o):[]});let t=/^#?[0-9a-fA-F]{3}(?:[0-9a-fA-F]{3})?$/,e={};if(!o||typeof o!="object")return console.warn("\u{1F3A8} [ThemeUtilities] sanitizeColorMap: Invalid input type"),e;let i=[];return Object.entries(o).forEach(([r,a])=>{if(typeof a!="string"){i.push([r,a]),console.warn(`\u{1F3A8} [ThemeUtilities] Dropped non-string color: ${r} = ${a} (type: ${typeof a})`);return}let n=a.trim();if(!n||n==="undefined"){i.push([r,a]),console.warn(`\u{1F3A8} [ThemeUtilities] Dropped empty/undefined color: ${r} = "${a}"`);return}if(!t.test(n)){i.push([r,a]),console.warn(`\u{1F3A8} [ThemeUtilities] Dropped invalid hex color: ${r} = "${a}"`);return}let s=n.startsWith("#")?n:`#${n}`;e[r]=s}),console.log("\u{1F3A8} [ThemeUtilities] sanitizeColorMap output:",{sanitized:e,sanitizedKeys:Object.keys(e),sanitizedEntries:Object.entries(e),droppedCount:i.length,droppedEntries:i}),w?.enableDebug&&Object.keys(o).length!==Object.keys(e).length&&console.warn(`[StarryNight sanitizeColorMap] Dropped ${Object.keys(o).length-Object.keys(e).length} invalid colour entries.`),e}function xr(o,t,e){o/=255,t/=255,e/=255;let i=Math.max(o,t,e),r=Math.min(o,t,e),a=0,n=0,s=(i+r)/2;if(i!==r){let l=i-r;switch(n=s>.5?l/(2-i-r):l/(i+r),i){case o:a=(t-e)/l+(t<e?6:0);break;case t:a=(e-o)/l+2;break;case e:a=(o-t)/l+4;break}a/=6}return{h:a*360,s:n*100,l:s*100}}function yn(o,t,e){o/=360,t/=100,e/=100;let i=(s,l,c)=>(c<0&&(c+=1),c>1&&(c-=1),c<1/6?s+(l-s)*6*c:c<1/2?l:c<2/3?s+(l-s)*(2/3-c)*6:s),r,a,n;if(t===0)r=a=n=e;else{let s=e<.5?e*(1+t):e+t-e*t,l=2*e-s;r=i(l,s,o+1/3),a=i(l,s,o),n=i(l,s,o-1/3)}return{r:Math.round(r*255),g:Math.round(a*255),b:Math.round(n*255)}}function oi(o,t,e){let i=s=>{if(!Number.isFinite(s))return 0;let l=s<=1?s*255:s;return Math.min(255,Math.max(0,Math.round(l)))},[r,a,n]=[i(o),i(t),i(e)];return"#"+[r,a,n].map(s=>s.toString(16).padStart(2,"0")).join("")}function Yo(o,t){let e=c=>{let[m=0,d=0,h=0]=[c.r,c.g,c.b].map(g=>(g=g/255,g<=.03928?g/12.92:Math.pow((g+.055)/1.055,2.4)));return .2126*m+.7152*d+.0722*h},i=be(o),r=be(t);if(!i||!r)return 1;let a=e(i),n=e(r),s=Math.max(a,n),l=Math.min(a,n);return(s+.05)/(l+.05)}function K(o,t,e,i){return i<=1e-5||e<=0?(w?.enableDebug&&i<=1e-5,t):t+(o-t)*Math.pow(2,-e/i)}function vn(o,t,e,i,r="flow",a){let n=ut.calculateMusicalLerp(i,r,a);return K(o,t,e,n.halfLife)}function jo(o,t,e,i,r,a="flow",n){return r?.calculatePerformanceAwareMusicalLerp?r.calculatePerformanceAwareMusicalLerp(o,t,e,i,a,n):vn(o,t,e,i,a,n)}function Ko(o,t,e,i=120,r=.5,a=.15){let n=Math.pow(i/120,.3),s=1+r*.3,l=a/n*s;return K(o,t,e,l)}function At(o){return!o||o<=0?500:6e4/o}function Qo(o){return!o||o<=0?120:6e4/o}function Xo(o,t=4){return At(o)/t}function Zo(o,t,e,i=50){let r=At(e),n=(o-t)%r;return n<=i||n>=r-i}function Jo(o,t,e){let i=At(e);return(o-t)%i/i}function el(o,t,e){let i=At(e),r=o-t,a=Math.floor(r/i);return t+(a+1)*i}function tl(o,t="ease-out"){switch(t){case"ease-in":return o*o;case"linear":return o;case"ease-out":default:return o*(2-o)}}function il(o,t=1){let e=.001*t;return o*e%(2*Math.PI)}function rl(o,t=.5){let i=.02*t;return 1+Math.sin(o)*i}function al(o=.5,t="neutral"){let i=t==="energetic"?1.2:t==="calm"?.8:1;return 1+.05*o*i}function Mr(o,t,e){let i=o/255,r=t/255,a=e/255,n=.4122214708*i+.5363325363*r+.0514459929*a,s=.2119034982*i+.6806995451*r+.1073969566*a,l=.0883024619*i+.2817188376*r+.6299787005*a,c=Math.cbrt(n),m=Math.cbrt(s),d=Math.cbrt(l);return{L:.2104542553*c+.793617785*m-.0040720468*d,a:1.9779984951*c-2.428592205*m+.4505937099*d,b:.0259040371*c+.7827717662*m-.808675766*d}}function nl(o,t,e){let i=o+.3963377774*t+.2158037573*e,r=o-.1055613458*t-.0638541728*e,a=o-.0894841775*t-1.291485548*e,n=i*i*i,s=r*r*r,l=a*a*a,c=4.0767416621*n-3.3077115913*s+.2309699292*l,m=-1.2684380046*n+2.6097574011*s-.3413193965*l,d=-.0041960863*n-.7034186147*s+1.707614701*l;return c=Math.round(Math.max(0,Math.min(1,c))*255),m=Math.round(Math.max(0,Math.min(1,m))*255),d=Math.round(Math.max(0,Math.min(1,d))*255),{r:c,g:m,b:d}}function Pr(o,t={}){let{L:e,a:i,b:r}=o,a=Math.sqrt(i*i+r*r),n=Math.atan2(r,i);n<0&&(n+=2*Math.PI);let s=n*(180/Math.PI),{energy:l=.5,valence:c=.5,artisticMode:m="artist-vision"}=t,d=w.getCurrentMultipliers(),h=e*(1+(c-.5)*.1),g=a*(1+(l-.5)*.2)*(d?.saturation||1);return h=Math.max(0,Math.min(1,h*(d?.brightness||1))),{L:h,C:g,h:a>.001?s:null}}function sl(o){let{L:t,C:e,h:i}=Pr(o),r=i!==null?i>=0&&i<90||i>=270&&i<=360:!1,a=i!==null?i>=90&&i<270:!1,n="neutral";return t>.7&&e>.1?n="bright":t<.4?n="dark":r&&e>.1?n="warm":a&&e>.1&&(n="cool"),{lightness:t,chroma:e,hue:i,isWarm:r,isCool:a,mood:n}}function ol(o,t="analogous",e=30){let i=Pr(o);if(i.h===null)return[o];let r=(c,m,d)=>{let h=d*(Math.PI/180),g=m*Math.cos(h),f=m*Math.sin(h);return{L:c,a:g,b:f}},a=[o],{L:n,C:s,h:l}=i;switch(t){case"complementary":a.push(r(n,s,(l+180)%360));break;case"analogous":a.push(r(n,s,(l+e)%360)),a.push(r(n,s,(l-e+360)%360));break;case"triadic":a.push(r(n,s,(l+120)%360)),a.push(r(n,s,(l+240)%360));break;case"tetradic":a.push(r(n,s,(l+90)%360)),a.push(r(n,s,(l+180)%360)),a.push(r(n,s,(l+270)%360));break;case"split-complementary":a.push(r(n,s,(l+180-e)%360)),a.push(r(n,s,(l+180+e)%360));break;case"monochromatic":a.push({L:Math.max(0,n-.2),a:o.a,b:o.b}),a.push({L:Math.min(1,n+.2),a:o.a,b:o.b});break}return a}function ll(o,t,e){return(1-e)*o+e*t}function cl(o,t){let e=Mr(o.r,o.g,o.b),i=Mr(t.r,t.g,t.b),r=e.L-i.L,a=e.a-i.a,n=e.b-i.b;return Math.sqrt(r*r+a*a+n*n)}function ml(){return ul}function dl(o,t,e){let i=c=>{let[m=0,d=0,h=0]=[c.r,c.g,c.b].map(g=>(g=g/255,g<=.03928?g/12.92:Math.pow((g+.055)/1.055,2.4)));return .2126*m+.7152*d+.0722*h},r=i(t),a;a=e*(r+.05)-.05;let n=xr(o.r,o.g,o.b),s=i(o),l=a/s;return n.l}function hl(o){return new Promise(t=>setTimeout(t,o))}function gl(o,{brightness:t=1,saturation:e=1,hue:i=0}){let r=xr(o.r,o.g,o.b);return r.h=(r.h+i)%360,r.s=Math.max(0,Math.min(100,r.s*e)),r.l=Math.max(0,Math.min(100,r.l*t)),yn(r.h,r.s,r.l)}function pl(){let o=fn(),t=getComputedStyle(o),e=t.getPropertyValue("--sn-accent-hex").trim(),i=t.getPropertyValue("--sn-accent-rgb").trim();if(!e&&i){let[r="0",a="0",n="0"]=i.split(/\s*,\s*/),s=parseInt(r,10)||0,l=parseInt(a,10)||0,c=parseInt(n,10)||0;e=oi(s,l,c)}if(!i&&e){let r=be(e);r&&(i=`${r.r},${r.g},${r.b}`)}return{hex:e,rgb:i}}var Tr,ul,te=v(()=>{"use strict";B();wr();Tr=class{registerSystem(t,e){}updateSystemMetrics(t,e){}},ul=new Tr});var xe,T,ue=v(()=>{"use strict";R();te();xe=class xe{constructor(t=!1){this.utils=k;this.debugEnabled=t}processColor(t,e=xe.PRESETS.STANDARD){let i=performance.now(),r=null;try{if(r=this.utils.hexToRgb(t),!r)throw new Error(`Invalid hex color: ${t}`);let a=this.utils.rgbToOklab(r.r,r.g,r.b),n=this.enhanceOKLABColor(a,e),s=this.generateShadowColor(a,e),l=this.generateHighlightColor(a,e),c=this.utils.oklabToRgb(n.L,n.a,n.b),m=this.utils.oklabToRgb(s.L,s.a,s.b),d=this.utils.oklabToRgb(l.L,l.a,l.b),h=this.utils.rgbToHex(c.r,c.g,c.b),g=this.utils.rgbToHex(m.r,m.g,m.b),f=this.utils.rgbToHex(d.r,d.g,d.b),S=this.convertOklabToOklch(n),C=performance.now()-i,x={originalHex:t,originalRgb:r,enhancedHex:h,enhancedRgb:c,shadowHex:g,shadowRgb:m,highlightHex:f,highlightRgb:d,oklabOriginal:a,oklabEnhanced:n,oklabShadow:s,oklabHighlight:l,oklchEnhanced:S,processingTime:C};return this.debugEnabled&&u?.debug?.log("OKLABColorProcessor","Color processed:",{input:t,enhanced:h,shadow:g,highlight:f,preset:e.name,processingTime:`${C.toFixed(2)}ms`}),x}catch(a){this.debugEnabled&&u?.debug?.error("OKLABColorProcessor","Color processing failed:",a);let n=r||{r:124,g:58,b:237};return this.createFallbackResult(t,n)}}processColorPalette(t,e=xe.PRESETS.STANDARD){let i={};return Object.entries(t).forEach(([r,a])=>{a&&this.utils.hexToRgb(a)&&(i[r]=this.processColor(a,e))}),i}generateCSSVariables(t,e="sn-oklab"){let i={};return i[`--${e}-enhanced-hex`]=t.enhancedHex,i[`--${e}-enhanced-rgb`]=`${t.enhancedRgb.r},${t.enhancedRgb.g},${t.enhancedRgb.b}`,i[`--${e}-enhanced-r`]=Math.round(t.enhancedRgb.r).toString(),i[`--${e}-enhanced-g`]=Math.round(t.enhancedRgb.g).toString(),i[`--${e}-enhanced-b`]=Math.round(t.enhancedRgb.b).toString(),i[`--${e}-shadow-hex`]=t.shadowHex,i[`--${e}-shadow-rgb`]=`${t.shadowRgb.r},${t.shadowRgb.g},${t.shadowRgb.b}`,i[`--${e}-lightness`]=t.oklabEnhanced.L.toFixed(3),i[`--${e}-chroma-a`]=t.oklabEnhanced.a.toFixed(3),i[`--${e}-chroma-b`]=t.oklabEnhanced.b.toFixed(3),i[`--${e}-oklch-l`]=t.oklchEnhanced.L.toFixed(3),i[`--${e}-oklch-c`]=t.oklchEnhanced.C.toFixed(3),i[`--${e}-oklch-h`]=t.oklchEnhanced.H.toFixed(1),i}interpolateOKLAB(t,e,i,r=xe.PRESETS.STANDARD){let a=this.utils.hexToRgb(t),n=this.utils.hexToRgb(e);if(!a||!n)throw new Error("Invalid hex colors for interpolation");let s=this.utils.rgbToOklab(a.r,a.g,a.b),l=this.utils.rgbToOklab(n.r,n.g,n.b),c={L:s.L+(l.L-s.L)*i,a:s.a+(l.a-s.a)*i,b:s.b+(l.b-s.b)*i},m=this.utils.oklabToRgb(c.L,c.a,c.b),d=this.utils.rgbToHex(m.r,m.g,m.b);return this.processColor(d,r)}generateOKLABGradient(t,e,i=5,r=xe.PRESETS.STANDARD){let a=[];for(let n=0;n<i;n++){let s=n/(i-1),l=this.interpolateOKLAB(t,e,s,r);a.push(l)}return a}enhanceOKLABColor(t,e){let i=Math.sqrt(t.a*t.a+t.b*t.b),r=Math.min(1,Math.max(0,t.L*e.lightnessBoost)),a=i>e.vibrantThreshold?e.chromaBoost:1,n=t.a*a,s=t.b*a;return{L:r,a:n,b:s}}generateShadowColor(t,e){return{L:Math.max(.02,t.L*e.shadowReduction),a:t.a*.8,b:t.b*.8}}generateHighlightColor(t,e){let i=2-e.shadowReduction;return{L:Math.min(1,t.L*i),a:t.a*.9,b:t.b*.9}}convertOklabToOklch(t){let e=t.L,i=Math.sqrt(t.a*t.a+t.b*t.b),r=Math.atan2(t.b,t.a)*(180/Math.PI);return r<0&&(r+=360),{L:e,C:i,H:r}}createFallbackResult(t,e){let i=this.utils.rgbToOklab(e.r,e.g,e.b);return{originalHex:t,originalRgb:e,enhancedHex:t,enhancedRgb:e,shadowHex:"#000000",shadowRgb:{r:0,g:0,b:0},highlightHex:"#FFFFFF",highlightRgb:{r:255,g:255,b:255},oklabOriginal:i,oklabEnhanced:i,oklabShadow:{L:.05,a:0,b:0},oklabHighlight:{L:.95,a:0,b:0},oklchEnhanced:this.convertOklabToOklch(i),processingTime:0}}static getPreset(t){return xe.PRESETS[t.toUpperCase()]||xe.PRESETS.STANDARD}static createCustomPreset(t,e,i,r,a=.3,n=.1){return{name:t,description:e,lightnessBoost:Math.max(.5,Math.min(1.5,i)),chromaBoost:Math.max(.5,Math.min(2,r)),shadowReduction:Math.max(.1,Math.min(.5,a)),vibrantThreshold:Math.max(.05,Math.min(.2,n))}}};xe.PRESETS={SUBTLE:{name:"Subtle Enhancement",description:"Minimal color enhancement for conservative aesthetics",lightnessBoost:1.05,chromaBoost:1.1,shadowReduction:.4,vibrantThreshold:.08},STANDARD:{name:"Standard Enhancement",description:"Balanced color enhancement for general use",lightnessBoost:1.1,chromaBoost:1.15,shadowReduction:.3,vibrantThreshold:.1},VIBRANT:{name:"Vibrant Enhancement",description:"Enhanced vibrancy for dynamic color experiences",lightnessBoost:1.15,chromaBoost:1.25,shadowReduction:.25,vibrantThreshold:.12},COSMIC:{name:"Cosmic Enhancement",description:"Maximum enhancement for Year 3000 visual-effects experiences",lightnessBoost:1.1,chromaBoost:1.2,shadowReduction:.2,vibrantThreshold:.15}};T=xe});var It,Sn=v(()=>{"use strict";It=class o{constructor(){this.coreParameters={electronic:{energy:.85,organicSynthetic:.9,rhythmComplexity:.6,harmonicSophistication:.5,dynamicRange:.4,tempo:"fast",accessibility:.7,emotionalRange:"wide"},rock:{energy:.8,organicSynthetic:.3,rhythmComplexity:.6,harmonicSophistication:.5,dynamicRange:.7,tempo:"medium",accessibility:.8,emotionalRange:"wide"},classical:{energy:.4,organicSynthetic:.1,rhythmComplexity:.7,harmonicSophistication:.9,dynamicRange:.9,tempo:"variable",accessibility:.4,emotionalRange:"extreme"},jazz:{energy:.5,organicSynthetic:.2,rhythmComplexity:.8,harmonicSophistication:.9,dynamicRange:.7,tempo:"medium",accessibility:.5,emotionalRange:"wide"},hiphop:{energy:.7,organicSynthetic:.6,rhythmComplexity:.7,harmonicSophistication:.4,dynamicRange:.5,tempo:"medium",accessibility:.9,emotionalRange:"moderate"},ambient:{energy:.2,organicSynthetic:.7,rhythmComplexity:.2,harmonicSophistication:.6,dynamicRange:.6,tempo:"slow",accessibility:.5,emotionalRange:"narrow"},pop:{energy:.6,organicSynthetic:.5,rhythmComplexity:.4,harmonicSophistication:.3,dynamicRange:.3,tempo:"medium",accessibility:.95,emotionalRange:"moderate"},folk:{energy:.4,organicSynthetic:.1,rhythmComplexity:.3,harmonicSophistication:.5,dynamicRange:.6,tempo:"medium",accessibility:.7,emotionalRange:"moderate"},metal:{energy:.95,organicSynthetic:.4,rhythmComplexity:.8,harmonicSophistication:.6,dynamicRange:.6,tempo:"fast",accessibility:.5,emotionalRange:"extreme"},punk:{energy:.9,organicSynthetic:.2,rhythmComplexity:.3,harmonicSophistication:.2,dynamicRange:.5,tempo:"fast",accessibility:.6,emotionalRange:"moderate"},indie:{energy:.5,organicSynthetic:.3,rhythmComplexity:.5,harmonicSophistication:.6,dynamicRange:.7,tempo:"medium",accessibility:.6,emotionalRange:"wide"},reggae:{energy:.5,organicSynthetic:.3,rhythmComplexity:.6,harmonicSophistication:.4,dynamicRange:.5,tempo:"medium",accessibility:.7,emotionalRange:"moderate"},blues:{energy:.5,organicSynthetic:.2,rhythmComplexity:.4,harmonicSophistication:.6,dynamicRange:.7,tempo:"slow",accessibility:.6,emotionalRange:"wide"},country:{energy:.5,organicSynthetic:.2,rhythmComplexity:.3,harmonicSophistication:.4,dynamicRange:.6,tempo:"medium",accessibility:.8,emotionalRange:"moderate"},techno:{energy:.85,organicSynthetic:.95,rhythmComplexity:.7,harmonicSophistication:.4,dynamicRange:.3,tempo:"fast",accessibility:.6,emotionalRange:"narrow"},house:{energy:.75,organicSynthetic:.85,rhythmComplexity:.5,harmonicSophistication:.4,dynamicRange:.4,tempo:"fast",accessibility:.8,emotionalRange:"moderate"},trance:{energy:.8,organicSynthetic:.9,rhythmComplexity:.4,harmonicSophistication:.5,dynamicRange:.5,tempo:"fast",accessibility:.7,emotionalRange:"wide"},dubstep:{energy:.9,organicSynthetic:.95,rhythmComplexity:.8,harmonicSophistication:.3,dynamicRange:.8,tempo:"medium",accessibility:.5,emotionalRange:"extreme"},funk:{energy:.7,organicSynthetic:.3,rhythmComplexity:.8,harmonicSophistication:.6,dynamicRange:.6,tempo:"medium",accessibility:.7,emotionalRange:"moderate"},default:{energy:.5,organicSynthetic:.5,rhythmComplexity:.5,harmonicSophistication:.5,dynamicRange:.5,tempo:"medium",accessibility:.7,emotionalRange:"moderate"}};this.characteristicsCache=new Map;this.visualStyleCache=new Map}static getInstance(){return o.instance||(o.instance=new o),o.instance}calculateCharacteristics(t){let e=t;if(this.characteristicsCache.has(e))return this.characteristicsCache.get(e);let i=this.coreParameters[e]||this.coreParameters.default,r={bassEmphasis:this.calculateBassEmphasis(i),midFrequencyPattern:this.calculateMidFrequencyPattern(i),trebleSharpness:this.calculateTrebleSharpness(i),dynamicRange:i.dynamicRange,rhythmComplexity:i.rhythmComplexity,syncopation:this.calculateSyncopation(i),grooveWeight:this.calculateGrooveWeight(i),tempoVariability:this.calculateTempoVariability(i),musicalComplexity:i.harmonicSophistication,dissonanceTolerance:this.calculateDissonanceTolerance(i),modalInfluence:this.calculateModalInfluence(i),microtonal:this.calculateMicrotonal(i),compression:this.calculateCompression(i),saturation:this.calculateSaturation(i),stereoWidth:this.calculateStereoWidth(i),artificialProcessing:i.organicSynthetic,smoothness:this.calculateSmoothness(i),accessibility:i.accessibility,experimentalFactor:this.calculateExperimentalFactor(i),emotionalRange:this.emotionalRangeToNumber(i.emotionalRange)};return this.characteristicsCache.set(e,r),r}calculateVisualStyle(t){let e=t;if(this.visualStyleCache.has(e))return this.visualStyleCache.get(e);let i=this.coreParameters[e]||this.coreParameters.default,r={primaryHueRange:this.calculatePrimaryHueRange(i),saturationProfile:this.calculateSaturationProfile(i),brightnessProfile:this.calculateBrightnessProfile(i),contrastLevel:this.calculateContrastLevel(i),gradientComplexity:this.calculateGradientComplexity(i),shapeGeometry:this.calculateShapeGeometry(i),edgeSharpness:this.calculateEdgeSharpness(i),symmetryLevel:this.calculateSymmetryLevel(i),animationStyle:this.calculateAnimationStyle(i),pulseBehavior:this.calculatePulseBehavior(i),flowDirection:this.calculateFlowDirection(i),transitionCharacter:this.calculateTransitionCharacter(i),layerBlending:this.calculateLayerBlending(i),depthIllusion:this.calculateDepthIllusion(i),particleInfluence:this.calculateParticleInfluence(i),nebulaCharacter:this.calculateNebulaCharacter(i),memoryInfluence:this.calculateMemoryInfluence(i),adaptationSpeed:this.calculateAdaptationSpeed(i),stabilityPreference:this.calculateStabilityPreference(i),emergencePattern:this.calculateEmergencePattern(i)};return this.visualStyleCache.set(e,r),r}calculateBassEmphasis(t){return(1-t.organicSynthetic)*.3+t.energy*.5+t.rhythmComplexity*.2}calculateMidFrequencyPattern(t){return t.harmonicSophistication*.6+(1-t.organicSynthetic)*.4}calculateTrebleSharpness(t){return t.organicSynthetic*.7+t.energy*.3}calculateSyncopation(t){return t.rhythmComplexity*.8+(1-t.accessibility)*.2}calculateGrooveWeight(t){return t.rhythmComplexity*.5+(1-t.organicSynthetic)*.3+t.accessibility*.2}calculateTempoVariability(t){return t.tempo==="variable"?.8:(1-t.accessibility)*.5+t.harmonicSophistication*.3}calculateDissonanceTolerance(t){return(1-t.accessibility)*.7+t.harmonicSophistication*.3}calculateModalInfluence(t){return t.harmonicSophistication*.6+(1-t.accessibility)*.4}calculateMicrotonal(t){return(1-t.accessibility)*.7+(1-t.organicSynthetic)*.3}calculateCompression(t){return(1-t.dynamicRange)*.8+t.accessibility*.2}calculateSaturation(t){return t.energy*.6+(1-t.organicSynthetic)*.4}calculateStereoWidth(t){return t.organicSynthetic*.5+t.harmonicSophistication*.3+t.accessibility*.2}calculateSmoothness(t){return(1-t.organicSynthetic)*.6+t.accessibility*.4}calculateExperimentalFactor(t){return(1-t.accessibility)*.7+t.harmonicSophistication*.3}emotionalRangeToNumber(t){return{narrow:.3,moderate:.5,wide:.7,extreme:.9}[t]}calculatePrimaryHueRange(t){let e=t.organicSynthetic*240+(1-t.organicSynthetic)*30,i=t.emotionalRange==="extreme"?100:t.emotionalRange==="wide"?80:60;return[e-i/2,e+i/2]}calculateSaturationProfile(t){let e=t.energy*.5+t.organicSynthetic*.3+.2,i=t.rhythmComplexity*.3+(1-t.accessibility)*.2;return[e,i]}calculateBrightnessProfile(t){let e=.8+t.energy*.4,i=t.dynamicRange*.5;return[e,i]}calculateContrastLevel(t){return t.energy*.6+t.dynamicRange*.4}calculateGradientComplexity(t){return t.harmonicSophistication*.5+t.rhythmComplexity*.3+(1-t.accessibility)*.2}calculateShapeGeometry(t){return t.organicSynthetic>.7?"geometric":t.accessibility<.5?"abstract":t.harmonicSophistication>.7?"hybrid":"smooth"}calculateEdgeSharpness(t){return t.organicSynthetic*.7+(1-t.accessibility)*.3}calculateSymmetryLevel(t){return t.accessibility*.6+(1-t.rhythmComplexity)*.4}calculateAnimationStyle(t){return t.rhythmComplexity>.7&&t.energy>.7?"chaotic":t.rhythmComplexity>.6?"rhythmic":t.energy<.4?"minimal":"smooth"}calculatePulseBehavior(t){return t.rhythmComplexity>.7?"syncopated":t.energy<.4?"subtle":1-t.accessibility>.5?"irregular":"steady"}calculateFlowDirection(t){return t.organicSynthetic>.7?"linear":t.harmonicSophistication>.7?"spiral":1-t.accessibility>.6?"random":"radial"}calculateTransitionCharacter(t){return t.organicSynthetic>.7?"mechanical":t.energy>.7?"sharp":t.accessibility>.7?"smooth":"fluid"}calculateLayerBlending(t){return 1-t.accessibility>.6?"clashing":t.harmonicSophistication>.7?"complementary":t.energy>.7?"contrasting":"harmonious"}calculateDepthIllusion(t){return t.harmonicSophistication*.5+t.dynamicRange*.3+(1-t.accessibility)*.2}calculateParticleInfluence(t){return t.organicSynthetic*.6+t.energy*.4}calculateNebulaCharacter(t){return t.organicSynthetic>.7?"structured":t.energy>.7?"dense":t.accessibility<.5?"wispy":"ethereal"}calculateMemoryInfluence(t){return t.harmonicSophistication*.5+(1-t.accessibility)*.3+t.rhythmComplexity*.2}calculateAdaptationSpeed(t){return t.energy*.5+t.rhythmComplexity*.3+t.accessibility*.2}calculateStabilityPreference(t){return t.accessibility*.6+(1-t.rhythmComplexity)*.4}calculateEmergencePattern(t){return t.harmonicSophistication>.7?"progressive":t.rhythmComplexity>.7?"cyclical":t.energy>.7?"sudden":"gradual"}clearCache(){this.characteristicsCache.clear(),this.visualStyleCache.clear()}}});var Qe,ye,Dt=v(()=>{"use strict";B();ue();Sn();Qe={electronic:{energyBoost:1.1,beatEmphasis:1.2,precision:.9,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"dynamic"}},dance:{energyBoost:1.2,beatEmphasis:1.25,precision:.95,oklabPreset:"COSMIC",colorCharacteristics:{vibrancyLevel:"cosmic",emotionalRange:"extreme",colorTemperature:"dynamic"}},house:{energyBoost:1.2,beatEmphasis:1.25,precision:.95,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"warm"}},techno:{energyBoost:1.15,beatEmphasis:1.3,precision:1,oklabPreset:"COSMIC",colorCharacteristics:{vibrancyLevel:"cosmic",emotionalRange:"extreme",colorTemperature:"cool"}},trance:{energyBoost:1.15,beatEmphasis:1.1,precision:.85,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"dynamic"}},rock:{energyBoost:1.05,intensityMultiplier:1.1,dynamicRange:1.1,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"warm"}},metal:{energyBoost:1.15,intensityMultiplier:1.2,dynamicRange:1.2,oklabPreset:"COSMIC",colorCharacteristics:{vibrancyLevel:"cosmic",emotionalRange:"extreme",colorTemperature:"cool"}},punk:{energyBoost:1.2,intensityMultiplier:1.1,precision:.8,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"dynamic"}},hiphop:{beatEmphasis:1.3,grooveFactor:1.2,tempoMultiplier:.95,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"warm"}},rap:{beatEmphasis:1.3,grooveFactor:1.2,tempoMultiplier:.95,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"}},jazz:{adaptiveVariation:!0,complexity:1.2,smoothingFactor:1.3,oklabPreset:"SUBTLE",colorCharacteristics:{vibrancyLevel:"subtle",emotionalRange:"wide",colorTemperature:"warm"}},classical:{gentleMode:!0,dynamicRange:1.4,tempoVariationHandling:"adaptive",oklabPreset:"SUBTLE",colorCharacteristics:{vibrancyLevel:"subtle",emotionalRange:"extreme",colorTemperature:"neutral"}},ambient:{subtleMode:!0,intensityReduction:.7,smoothingFactor:1.5,oklabPreset:"SUBTLE",colorCharacteristics:{vibrancyLevel:"subtle",emotionalRange:"narrow",colorTemperature:"cool"}},pop:{energyBoost:1.05,beatEmphasis:1.1,precision:.85,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"warm"}},rnb:{grooveFactor:1.25,smoothingFactor:1.1,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"warm"}},soul:{grooveFactor:1.3,smoothingFactor:1.15,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"wide",colorTemperature:"warm"}},default:{balanced:!0,energyBoost:1,beatEmphasis:1,precision:1,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"}}},ye=class{constructor(t={}){this.currentGenre="default";this.genreConfidence=.5;this.genreHistory=[];this.historyMaxLength=10;this.config=t.ADVANCED_SYSTEM_CONFIG||t.YEAR3000_CONFIG||w,this.config.enableDebug&&console.log("\u{1F9EC} [GenreProfileManager] Initialized")}_getGenreFromAudioFeatures(t){if(!t)return"default";let{danceability:e=.5,energy:i=.5,acousticness:r=.5,instrumentalness:a=.5,tempo:n=120}=t;return a>.6&&r<.2&&i>.6?n>120?"techno":"electronic":e>.7&&i>.7?"dance":r>.7&&i<.4?"classical":r>.5&&a<.1?"jazz":i>.7&&a<.1&&e>.5?"rock":e>.7&&a<.2&&i>.5&&n<110?"hiphop":"default"}getProfileForTrack(t){let e=this._getGenreFromAudioFeatures(t),i=Qe[e];if(this.config.enableDebug&&console.log(`[GenreProfileManager] Detected genre: '${e}'. Applying profile.`),i)return i;let r=Qe.default;if(r)return r;throw new Error("[GenreProfileManager] Critical: Default genre profile is missing.")}detectGenre(t){let e=this._getGenreFromAudioFeatures(t),i=this._calculateGenreConfidence(t,e);return this.currentGenre=e,this.genreConfidence=i,this.genreHistory.push({genre:e,confidence:i,timestamp:Date.now()}),this.genreHistory.length>this.historyMaxLength&&this.genreHistory.shift(),this.config.enableDebug&&console.log(`\u{1F9EC} [GenreProfileManager] Genre detected: '${e}' (confidence: ${i.toFixed(2)})`),e}_calculateGenreConfidence(t,e){if(!t||!e)return .5;let{energy:i=.5,danceability:r=.5,acousticness:a=.5}=t,n=.5;return e==="electronic"&&i>.7&&a<.3?n=.9:e==="rock"&&i>.7&&a<.5?n=.85:e==="classical"&&a>.7&&i<.4?n=.9:e==="jazz"&&a>.5?n=.8:e==="hiphop"&&r>.7?n=.85:e==="ambient"&&i<.3?n=.8:n=.6,Math.min(1,Math.max(0,n))}getCurrentGenre(){return this.currentGenre}getGenreConfidence(){return this.genreConfidence}getGenreHistory(){return[...this.genreHistory]}getOKLABPresetForGenre(t){let e=Qe[t]||Qe.default,i=e.oklabPreset||"STANDARD";try{let r=T.getPreset(i);return this.config.enableDebug&&console.log(`\u{1F9EC} [GenreProfileManager] OKLAB preset for genre '${t}':`,{genre:t,preset:i,colorCharacteristics:e.colorCharacteristics}),r}catch(r){return this.config.enableDebug&&console.warn(`\u{1F9EC} [GenreProfileManager] Failed to get OKLAB preset '${i}' for genre '${t}', using STANDARD:`,r),T.getPreset("STANDARD")}}getOKLABPresetForTrack(t){let e=this.detectGenre(t);return this.getOKLABPresetForGenre(e)}getColorCharacteristicsForGenre(t){let i=(Qe[t]||Qe.default).colorCharacteristics||{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"};return this.config.enableDebug&&console.log(`\u{1F9EC} [GenreProfileManager] Color characteristics for genre '${t}':`,i),i}getColorCharacteristicsForTrack(t){let e=this.detectGenre(t);return this.getColorCharacteristicsForGenre(e)}createContextualOKLABPreset(t,e=1,i="contextual"){let r=this.detectGenre(t),a=this.getOKLABPresetForGenre(r),n=this.getColorCharacteristicsForGenre(r),s=t.energy||.5,l=t.danceability||.5,c=(s+l)/2*e,m=a.chromaBoost*(.8+c*.4),d=a.lightnessBoost*(.9+c*.2),h=T.createCustomPreset(`${r}-${i}`,`Contextual ${a.description} for ${r}`,d,m,a.shadowReduction,a.vibrantThreshold);return this.config.enableDebug&&console.log("\u{1F9EC} [GenreProfileManager] Created contextual OKLAB preset:",{genre:r,basePreset:a.name,contextualPreset:h.name,adjustments:{chromaBoost:`${a.chromaBoost} \u2192 ${m}`,lightnessBoost:`${a.lightnessBoost} \u2192 ${d}`,intensityMultiplier:e,combinedIntensity:c}}),h}getAllGenreOKLABMappings(){let t={};return Object.entries(Qe).forEach(([e,i])=>{t[e]={preset:i.oklabPreset||"STANDARD",characteristics:i.colorCharacteristics}}),this.config.enableDebug&&console.log("\u{1F9EC} [GenreProfileManager] All genre-OKLAB mappings:",t),t}getCharacteristics(t){let i=It.getInstance().calculateCharacteristics(t);return this.config.enableDebug&&console.log(`\u{1F9EC} [GenreProfileManager] Characteristics for genre '${t}':`,i),i}getCharacteristicsForTrack(t){let e=this.detectGenre(t);return this.getCharacteristics(e)}getVisualStyle(t){let i=It.getInstance().calculateVisualStyle(t);return this.config.enableDebug&&console.log(`\u{1F9EC} [GenreProfileManager] Visual style for genre '${t}':`,i),i}getVisualStyleForTrack(t){let e=this.detectGenre(t);return this.getVisualStyle(e)}getFullGenreData(t){return{profile:this.getProfileForTrack({}),characteristics:this.getCharacteristics(t),visualStyle:this.getVisualStyle(t)}}}});var li,se,Xe=v(()=>{"use strict";ue();li={calm:{temperatureRange:[2700,4e3],baseTemperature:3200,characteristics:{energy:[0,.3],valence:[.4,.8],intensity:.6},cssClass:"smooth-emotion-calm",description:"Warm, soothing, meditative states",oklabBaseColor:"#89b4fa",oklabPreset:"SUBTLE",perceptualCharacteristics:{lightness:[.6,.8],chromaBoost:.9,hueShift:15}},melancholy:{temperatureRange:[2200,3500],baseTemperature:2800,characteristics:{energy:[0,.4],valence:[0,.4],intensity:.8},cssClass:"smooth-emotion-melancholy",description:"Deep, introspective, amber-golden tones",oklabBaseColor:"#f9e2af",oklabPreset:"STANDARD",perceptualCharacteristics:{lightness:[.4,.6],chromaBoost:1.1,hueShift:-10}},energetic:{temperatureRange:[5500,7500],baseTemperature:6500,characteristics:{energy:[.6,1],valence:[.5,1],intensity:1},cssClass:"smooth-emotion-energetic",description:"Bright, vibrant, high-energy states",oklabBaseColor:"#a6e3a1",oklabPreset:"VIBRANT",perceptualCharacteristics:{lightness:[.7,.9],chromaBoost:1.3,hueShift:5}},aggressive:{temperatureRange:[8e3,12e3],baseTemperature:1e4,characteristics:{energy:[.7,1],valence:[0,.6],intensity:1.2},cssClass:"smooth-emotion-aggressive",description:"Cool, intense, high-energy negative valence",oklabBaseColor:"#f38ba8",oklabPreset:"COSMIC",perceptualCharacteristics:{lightness:[.5,.7],chromaBoost:1.4,hueShift:-5}},happy:{temperatureRange:[4500,6500],baseTemperature:5500,characteristics:{energy:[.4,.8],valence:[.6,1],intensity:.9},cssClass:"smooth-emotion-happy",description:"Balanced, joyful, warm-white tones",oklabBaseColor:"#fab387",oklabPreset:"STANDARD",perceptualCharacteristics:{lightness:[.75,.85],chromaBoost:1.15,hueShift:8}},romantic:{temperatureRange:[2500,3500],baseTemperature:3e3,characteristics:{energy:[.2,.6],valence:[.5,.9],intensity:.7},cssClass:"smooth-emotion-romantic",description:"Soft, intimate, warm tones with pink accent",oklabBaseColor:"#f5c2e7",oklabPreset:"SUBTLE",perceptualCharacteristics:{lightness:[.65,.8],chromaBoost:1,hueShift:12}},mysterious:{temperatureRange:[1800,2800],baseTemperature:2300,characteristics:{energy:[.1,.5],valence:[.1,.5],intensity:.9},cssClass:"smooth-emotion-mysterious",description:"Deep, enigmatic, low temperature with purple accent",oklabBaseColor:"#cba6f7",oklabPreset:"VIBRANT",perceptualCharacteristics:{lightness:[.3,.5],chromaBoost:1.2,hueShift:-15}},epic:{temperatureRange:[7e3,15e3],baseTemperature:11e3,characteristics:{energy:[.6,1],valence:[.3,.8],intensity:1.3},cssClass:"smooth-emotion-epic",description:"Grand, cinematic, high contrast blue-gold",oklabBaseColor:"#74c7ec",oklabPreset:"COSMIC",perceptualCharacteristics:{lightness:[.6,.9],chromaBoost:1.35,hueShift:20}},ambient:{temperatureRange:[3e3,5e3],baseTemperature:4e3,characteristics:{energy:[.1,.4],valence:[.3,.7],intensity:.5},cssClass:"smooth-emotion-ambient",description:"Atmospheric, floating, neutral temperature",oklabBaseColor:"#94e2d5",oklabPreset:"SUBTLE",perceptualCharacteristics:{lightness:[.5,.7],chromaBoost:.8,hueShift:0}}},se=class{constructor(t=!1){this.enableDebug=t,this.oklabProcessor=new T(t)}mapMusicToEmotionalTemperature(t){let{energy:e=.5,valence:i=.5,danceability:r=.5,tempo:a=120,mode:n=1}=t,s,l,c=1;if(e>=.6&&i>=.6?(s=r>.7?"energetic":"happy",e>.8&&i>.8&&(l="epic",c=.7)):e>=.6&&i<.5?(s=e>.8?"aggressive":"epic",i<.3&&(l="mysterious",c=.8)):e<.4&&i>=.5?(s=i>.7?"calm":"romantic",e<.2&&(l="ambient",c=.6)):(s=i<.3?"melancholy":"mysterious",e<.2&&i<.2&&(l="ambient",c=.8)),t.genre){let P=this.getGenreEmotionalAdjustment(t.genre,s);P&&(P.override&&(s=P.override),P.secondary&&(l=P.secondary,c=P.blendRatio||.7))}let m=li[s].characteristics.intensity,d=e*.3,h=Math.abs(i-.5)*.2,g=a>140?.1:a<80?-.1:0,f=Math.max(.1,Math.min(1.5,m+d+h+g)),S=li[s],[C,x]=S.temperatureRange,M=e*.6+i*.4,V=C+(x-C)*M,z=T.getPreset(S.oklabPreset),G,I;try{let P=this.createContextualOKLABPreset(S,f,e,i);G=this.oklabProcessor.processColor(S.oklabBaseColor,P),I=G.enhancedHex,this.enableDebug&&console.log("\u{1F321}\uFE0F [EmotionalTemperatureMapper] OKLAB processing:",{emotion:s,baseColor:S.oklabBaseColor,preset:P.name,enhanced:I,oklabCoords:G.oklabEnhanced})}catch(P){this.enableDebug&&console.warn("\u{1F321}\uFE0F [EmotionalTemperatureMapper] OKLAB processing failed:",P),I=S.oklabBaseColor}let N=this.generateEmotionalCSSVariables(s,l,f,V,c,G,I),F={primaryEmotion:s,...l&&{secondaryEmotion:l},intensity:f,temperature:Math.round(V),blendRatio:c,cssClass:S.cssClass,cssVariables:N,oklabPreset:z,...G&&{oklabResult:G},...I&&{perceptualColorHex:I}};return this.enableDebug&&console.log("\u{1F321}\uFE0F [EmotionalTemperatureMapper] Music analysis result:",{input:{energy:e,valence:i,genre:t.genre},output:F,reasoning:{energyValenceQuadrant:this.getEnergyValenceQuadrant(e,i),genreInfluence:t.genre,intensityFactors:{baseIntensity:m,energyBoost:d,valenceInfluence:h,tempoInfluence:g}}}),F}createContextualOKLABPreset(t,e,i,r){let a=T.getPreset(t.oklabPreset),n=t.perceptualCharacteristics,s=i*.5+r*.3+.2,l=n.lightness[0]+(n.lightness[1]-n.lightness[0])*s,c=n.chromaBoost*e*(.8+i*.4);return T.createCustomPreset(`${t.cssClass}-contextual`,`Contextual ${a.description} for ${t.description}`,l/.5,c,a.shadowReduction,a.vibrantThreshold)}getGenreEmotionalAdjustment(t,e){let i={edm:{secondary:"energetic",blendRatio:.8},house:{secondary:"energetic",blendRatio:.7},ambient:{override:"ambient"},downtempo:{override:"calm",secondary:"ambient",blendRatio:.6},metal:{override:"aggressive"},"hard-rock":{secondary:"aggressive",blendRatio:.8},alternative:{secondary:"epic",blendRatio:.7},classical:{override:"epic",secondary:"calm",blendRatio:.6},soundtrack:{override:"epic"},orchestral:{override:"epic"},jazz:{override:"mysterious",secondary:"romantic",blendRatio:.7},blues:{override:"melancholy"},soul:{secondary:"romantic",blendRatio:.6},folk:{override:"calm",secondary:"melancholy",blendRatio:.6},acoustic:{override:"romantic",secondary:"calm",blendRatio:.7},"hip-hop":{secondary:"aggressive",blendRatio:.8},trap:{secondary:"aggressive",blendRatio:.9},pop:{secondary:"happy",blendRatio:.7},"indie-pop":{secondary:"happy",blendRatio:.6}},r=t.toLowerCase().replace(/[\s-_]/g,"-");return i[r]||null}getEnergyValenceQuadrant(t,e){return t>=.5&&e>=.5?"High Energy + Positive":t>=.5&&e<.5?"High Energy + Negative":t<.5&&e>=.5?"Low Energy + Positive":"Low Energy + Negative"}generateEmotionalCSSVariables(t,e,i,r,a,n,s){let l={};l["--smooth-current-emotion"]=t,l["--smooth-emotional-intensity"]=i.toString(),l["--smooth-current-temperature"]=r.toString(),l["--smooth-emotion-primary"]=t,e&&(l["--smooth-emotion-secondary"]=e,l["--smooth-emotion-blend-ratio"]=a.toString()),l["--smooth-emotional-saturation"]=Math.max(.5,i).toString(),l["--smooth-cinematic-contrast"]=Math.max(.8,i*1.2).toString(),l["--smooth-warmth"]=this.calculateWarmth(r).toString();let c=this.calculatePulsingSpeed(t,i);l["--smooth-pulsing-cycle"]=`${c}s`;let m=this.calculateTemperatureFilters(r,i);return Object.assign(l,m),n&&s&&(l["--smooth-emotion-oklab-hex"]=s,l["--smooth-emotion-oklab-rgb"]=`${n.enhancedRgb.r},${n.enhancedRgb.g},${n.enhancedRgb.b}`,l["--smooth-emotion-oklab-l"]=n.oklabEnhanced.L.toFixed(3),l["--smooth-emotion-oklab-a"]=n.oklabEnhanced.a.toFixed(3),l["--smooth-emotion-oklab-b"]=n.oklabEnhanced.b.toFixed(3),l["--smooth-emotion-oklch-l"]=n.oklchEnhanced.L.toFixed(3),l["--smooth-emotion-oklch-c"]=n.oklchEnhanced.C.toFixed(3),l["--smooth-emotion-oklch-h"]=n.oklchEnhanced.H.toFixed(1),l["--smooth-emotion-oklab-shadow-hex"]=n.shadowHex,l["--smooth-emotion-oklab-shadow-rgb"]=`${n.shadowRgb.r},${n.shadowRgb.g},${n.shadowRgb.b}`,l["--smooth-perceptual-emotion-color"]=s,l["--smooth-perceptual-emotion-rgb"]=`${n.enhancedRgb.r},${n.enhancedRgb.g},${n.enhancedRgb.b}`,this.enableDebug&&console.log("\u{1F3A8} [EmotionalTemperatureMapper] Generated OKLAB CSS variables:",{emotion:t,perceptualColor:s,oklabCoords:n.oklabEnhanced,oklchCoords:n.oklchEnhanced})),l}calculateWarmth(t){return t<=4e3?.7+(4e3-t)/2200*.3:t>=7e3?Math.max(.2,.7-(t-7e3)/8e3*.5):.5+(7e3-t)/3e3*.2}calculatePulsingSpeed(t,e){let r={calm:6,melancholy:8,energetic:2,aggressive:1.5,happy:3,romantic:5,mysterious:7,epic:2.5,ambient:10}[t],a=Math.max(.5,Math.min(2,2-e));return r*a}calculateTemperatureFilters(t,e){let i={},r=this.mapTemperatureToHue(t);i["--smooth-temperature-hue-shift"]=`${r}deg`;let a=Math.max(.8,Math.min(1.5,1+(e-.5)*.4));i["--smooth-temperature-saturation"]=a.toString();let n=this.mapTemperatureToBrightness(t);return i["--smooth-temperature-brightness"]=n.toString(),i}mapTemperatureToHue(t){return t<=4e3?-15+(4e3-t)/2e3*-15:t>=8e3?10+(t-8e3)/7e3*20:-5+(t-4e3)/4e3*15}mapTemperatureToBrightness(t){return .9+(t-2e3)/13e3*.3}applyEmotionalTemperature(t,e){let i=Array.from(t.classList).filter(r=>r.startsWith("smooth-emotion-"));t.classList.remove(...i),t.classList.add(e.cssClass),e.secondaryEmotion&&t.classList.add(`smooth-emotion-blend-${e.secondaryEmotion}`),Object.entries(e.cssVariables).forEach(([r,a])=>{t.style.setProperty(r,a)}),this.enableDebug&&console.log("\u{1F3A8} [EmotionalTemperatureMapper] Applied emotional temperature:",{element:t.tagName,emotion:e.primaryEmotion,secondary:e.secondaryEmotion,intensity:e.intensity,temperature:e.temperature})}static getAvailableEmotions(){return Object.keys(li)}static getEmotionCharacteristics(t){return li[t]}}});function b(o,t,e,i){let r=parseInt(o.slice(1,3),16),a=parseInt(o.slice(3,5),16),n=parseInt(o.slice(5,7),16),s=(.299*r+.587*a+.114*n)/255;return{hex:o,rgb:`${r}, ${a}, ${n}`,hsl:[t,e,i],brightness:s}}function Cn(o,t){let e=Ve[o],i=fl[t];switch(t){case"bright":return o==="latte"?e.surface2:e.surface1;case"balanced":return o==="latte"?e.surface0:e.base;case"dark":return e.mantle;default:return e.base}}function En(o,t){let e=Ve[o];switch(t){case"bright":return e.surface2;case"balanced":return e.surface1;case"dark":return e.surface0;default:return e.surface1}}function wn(o,t){return Ve[o][t]}function Mn(o){let t=Ve[o];return o==="latte"?t.blue:t.mauve}var Ve,fl,Ar=v(()=>{"use strict";Ve={mocha:{rosewater:b("#f5e0dc",10,56,91),flamingo:b("#f2cdcd",0,59,88),pink:b("#f5c2e7",316,72,86),mauve:b("#cba6f7",267,84,81),red:b("#f38ba8",343,81,75),maroon:b("#eba0ac",350,65,77),peach:b("#fab387",23,92,75),yellow:b("#f9e2af",41,86,83),green:b("#a6e3a1",115,54,76),teal:b("#94e2d5",174,57,73),sky:b("#89dceb",189,71,73),sapphire:b("#74c7ec",199,76,69),blue:b("#89b4fa",217,92,76),lavender:b("#b4befe",232,97,85),text:b("#cdd6f4",226,64,88),subtext1:b("#bac2de",227,35,80),subtext0:b("#a6adc8",228,24,72),overlay2:b("#9399b2",228,17,64),overlay1:b("#7f849c",230,13,55),overlay0:b("#6c7086",231,11,47),surface2:b("#585b70",233,12,39),surface1:b("#45475a",234,13,31),surface0:b("#313244",237,16,23),base:b("#1e1e2e",240,21,15),mantle:b("#181825",240,18,13),crust:b("#11111b",240,23,9)},latte:{rosewater:b("#dc8a78",11,59,67),flamingo:b("#dd7878",0,60,67),pink:b("#ea76cb",316,73,69),mauve:b("#8839ef",266,85,58),red:b("#d20f39",347,87,44),maroon:b("#e64553",355,76,59),peach:b("#fe640b",22,99,52),yellow:b("#df8e1d",35,77,49),green:b("#40a02b",109,58,40),teal:b("#179299",183,74,35),sky:b("#04a5e5",197,97,46),sapphire:b("#209fb5",189,70,42),blue:b("#1e66f5",220,91,54),lavender:b("#7287fd",231,97,72),text:b("#4c4f69",234,16,35),subtext1:b("#5c5f77",233,13,41),subtext0:b("#6c6f85",233,10,47),overlay2:b("#7c7f93",232,10,53),overlay1:b("#8c8fa1",231,10,59),overlay0:b("#9ca0b0",228,11,65),surface2:b("#acb0be",227,12,71),surface1:b("#bcc0cc",226,14,77),surface0:b("#ccd0da",225,16,83),base:b("#eff1f5",220,23,95),mantle:b("#e6e9ef",220,22,92),crust:b("#dce0e8",220,21,89)},frappe:{rosewater:b("#f2d5cf",10,57,88),flamingo:b("#eebebe",0,58,84),pink:b("#f4b8e4",316,73,84),mauve:b("#ca9ee6",277,59,76),red:b("#e78284",359,68,71),maroon:b("#ea999c",358,56,76),peach:b("#ef9f76",20,79,70),yellow:b("#e5c890",40,62,73),green:b("#a6d189",96,44,68),teal:b("#81c8be",172,39,65),sky:b("#99d1db",189,48,73),sapphire:b("#85c1dc",199,55,69),blue:b("#8caaee",222,74,74),lavender:b("#babbf1",239,66,84),text:b("#c6d0f5",227,70,87),subtext1:b("#b5bfe2",229,44,80),subtext0:b("#a5adce",230,34,72),overlay2:b("#949cbb",231,19,64),overlay1:b("#838ba7",232,16,56),overlay0:b("#737994",232,13,49),surface2:b("#626880",233,16,42),surface1:b("#51576d",234,16,35),surface0:b("#414559",235,16,30),base:b("#303446",229,19,23),mantle:b("#292c3c",231,19,20),crust:b("#232634",229,20,17)},macchiato:{rosewater:b("#f4dbd6",10,58,90),flamingo:b("#f0c6c6",0,58,86),pink:b("#f5bde6",316,74,85),mauve:b("#c6a0f6",267,83,79),red:b("#ed8796",351,74,73),maroon:b("#ee99a0",357,70,77),peach:b("#f5a97f",21,86,73),yellow:b("#eed49f",42,79,78),green:b("#a6da95",105,48,72),teal:b("#8bd5ca",172,47,69),sky:b("#91d7e3",189,59,73),sapphire:b("#7dc4e4",199,66,69),blue:b("#8aadf4",220,83,75),lavender:b("#b7bdf8",238,82,84),text:b("#cad3f5",227,68,88),subtext1:b("#b8c0e0",228,39,81),subtext0:b("#a5adcb",227,27,72),overlay2:b("#939ab7",228,20,64),overlay1:b("#8087a2",230,15,56),overlay0:b("#6e738d",230,12,48),surface2:b("#5b6078",233,16,40),surface1:b("#494d64",234,15,33),surface0:b("#363a4f",235,16,26),base:b("#24273a",232,23,19),mantle:b("#1e2030",233,23,16),crust:b("#181926",236,23,13)}},fl={bright:{baseColorTarget:.25,surfaceColorTarget:.35,textContrastMin:4.5},balanced:{baseColorTarget:.15,surfaceColorTarget:.25,textContrastMin:4.5},dark:{baseColorTarget:.08,surfaceColorTarget:.15,textContrastMin:3}}});function y(o,t,e,i){let r=parseInt(o.slice(1,3),16),a=parseInt(o.slice(3,5),16),n=parseInt(o.slice(5,7),16),s=(.299*r+.587*a+.114*n)/255;return{hex:o,rgb:`${r}, ${a}, ${n}`,hsl:[t,e,i],brightness:s}}function Tn(o,t){let e=Fe[o],i=yl[t];switch(t){case"bright":return e.surface1;case"balanced":return e.surface0;case"dark":return e.base;default:return e.base}}function xn(o,t){let e=Fe[o];switch(t){case"bright":return e.surface2;case"balanced":return e.surface1;case"dark":return e.surface0;default:return e.surface1}}function Pn(o,t){return Fe[o][t]}function An(o){return Fe[o].mauve}function In(o,t="medium"){let e=Fe[o];switch(t){case"low":return[e.mauve,e.blue];case"medium":return[e.pink,e.peach];case"high":return[e.red,e.teal];default:return[e.mauve,e.pink]}}function Dn(o){let t=Fe[o];return{primary:t.mauve,secondary:t.pink,tertiary:t.sky,atmosphere:t.base}}var Fe,yl,Ir=v(()=>{"use strict";Fe={subtle:{rosewater:y("#e8d5d1",15,45,85),flamingo:y("#e5c3c3",0,45,82),pink:y("#d8a8cc",316,40,75),mauve:y("#9d7bc7",267,45,65),red:y("#c85a7a",343,45,60),maroon:y("#c27882",350,35,65),peach:y("#d18a5f",23,50,60),yellow:y("#d4c285",41,45,70),green:y("#8cc98a",115,35,65),teal:y("#7bc5b8",174,35,65),sky:y("#7ab5c7",189,40,65),sapphire:y("#6baac7",199,45,60),blue:y("#7d9dd4",217,50,65),lavender:y("#a8aed9",232,45,75),text:y("#c2c8d4",226,25,80),subtext1:y("#b2b8c8",227,20,72),subtext0:y("#9ca4b8",228,15,65),overlay2:y("#868ea8",228,12,58),overlay1:y("#757d95",230,10,52),overlay0:y("#656c82",231,8,45),surface2:y("#555c70",233,8,38),surface1:y("#454c5a",234,8,32),surface0:y("#353a46",237,10,25),base:y("#252832",240,12,17),mantle:y("#1f222a",240,10,15),crust:y("#181b22",240,15,12)},balanced:{rosewater:y("#f2d8d3",15,60,88),flamingo:y("#eec6c6",0,60,85),pink:y("#e8b3d8",316,55,80),mauve:y("#b388d6",267,55,70),red:y("#d16b8a",343,55,65),maroon:y("#d08692",350,45,70),peach:y("#e59a6f",23,65,65),yellow:y("#e0d295",41,55,75),green:y("#9cd49a",115,40,70),teal:y("#8bd0c3",174,40,70),sky:y("#8ac0d2",189,50,70),sapphire:y("#7bb5d2",199,55,65),blue:y("#8da8e0",217,60,70),lavender:y("#b8bee5",232,55,80),text:y("#ced4e0",226,35,85),subtext1:y("#bec4d3",227,25,77),subtext0:y("#a8b0c3",228,20,70),overlay2:y("#929ab3",228,15,63),overlay1:y("#8289a0",230,12,57),overlay0:y("#72798f",231,10,50),surface2:y("#62697d",233,10,43),surface1:y("#525968",234,10,37),surface0:y("#424954",237,12,30),base:y("#2f323e",240,15,22),mantle:y("#282b36",240,12,19),crust:y("#21242e",240,18,16)},cinematic:{rosewater:y("#fce0db",15,85,92),flamingo:y("#f5c9c9",0,85,88),pink:y("#ff6b9d",316,100,70),mauve:y("#6c5ce7",267,85,65),red:y("#ff4757",343,100,65),maroon:y("#e84393",350,80,70),peach:y("#fd7f28",23,95,58),yellow:y("#f39c12",41,88,52),green:y("#a6e3a1",115,54,76),teal:y("#00cec9",174,100,40),sky:y("#74b9ff",189,100,72),sapphire:y("#0984e3",199,100,46),blue:y("#a29bfe",217,95,80),lavender:y("#c77dff",232,100,75),text:y("#e8f0ff",226,100,95),subtext1:y("#d0d8f0",227,65,88),subtext0:y("#b8c0d8",228,45,80),overlay2:y("#a0a8c0",228,30,70),overlay1:y("#8890a8",230,20,60),overlay0:y("#707890",231,15,50),surface2:y("#586078",233,15,42),surface1:y("#485060",234,15,35),surface0:y("#384048",237,18,28),base:y("#202030",240,25,16),mantle:y("#181828",240,22,13),crust:y("#101020",240,30,9)},maximum:{rosewater:y("#ffe5e0",15,100,95),flamingo:y("#ffcccc",0,100,90),pink:y("#ff3d7f",316,100,62),mauve:y("#5a4fcf",267,100,55),red:y("#ff2942",343,100,58),maroon:y("#e6337a",350,90,65),peach:y("#ff6500",23,100,50),yellow:y("#f1c40f",48,89,50),green:y("#00ff88",150,100,50),teal:y("#00ffff",180,100,50),sky:y("#4da6ff",189,100,65),sapphire:y("#0066ff",199,100,50),blue:y("#8a7fff",217,100,75),lavender:y("#b347ff",232,100,65),text:y("#ffffff",0,0,100),subtext1:y("#e8e8ff",240,100,95),subtext0:y("#d0d0ff",240,100,90),overlay2:y("#b8b8ff",240,100,85),overlay1:y("#a0a0ff",240,100,80),overlay0:y("#8888ff",240,100,75),surface2:y("#4040aa",240,60,45),surface1:y("#303088",240,65,35),surface0:y("#202066",240,70,25),base:y("#0f0f33",240,70,13),mantle:y("#0a0a22",240,75,10),crust:y("#050511",240,80,5)}},yl={bright:{baseColorTarget:.25,surfaceColorTarget:.35,textContrastMin:4.5},balanced:{baseColorTarget:.15,surfaceColorTarget:.25,textContrastMin:4.5},dark:{baseColorTarget:.08,surfaceColorTarget:.15,textContrastMin:3}}});function Ln(o,t="balanced"){return Z.getBrightnessAdjustedBaseColor(o,t)}function Rn(o,t="balanced"){return Z.getBrightnessAdjustedSurfaceColor(o,t)}function Lr(o){return Z.getDefaultAccentColor(o)}function kn(o,t){return Z.getAccentColor(o,t)}var Dr,Z,Lt=v(()=>{"use strict";B();Ar();Ir();Ar();Ir();Dr=class o{constructor(){}static getInstance(){return o.instance||(o.instance=new o),o.instance}getCurrentPaletteSystem(){return w.paletteSystem||"catppuccin"}getCurrentPalette(){return this.getCurrentPaletteSystem()==="year3000"?Fe:Ve}getCurrentDefaultFlavor(){return this.getCurrentPaletteSystem()==="year3000"?"balanced":"mocha"}getBrightnessAdjustedBaseColor(t,e="balanced"){let i=this.getCurrentPaletteSystem(),r=t||this.getCurrentDefaultFlavor();return i==="year3000"?Tn(r,e):Cn(r,e)}getBrightnessAdjustedSurfaceColor(t,e="balanced"){let i=this.getCurrentPaletteSystem(),r=t||this.getCurrentDefaultFlavor();return i==="year3000"?xn(r,e):En(r,e)}getDefaultAccentColor(t){let e=this.getCurrentPaletteSystem(),i=t||this.getCurrentDefaultFlavor();return e==="year3000"?An(i):Mn(i)}getAccentColor(t,e){let i=this.getCurrentPaletteSystem(),r=e||this.getCurrentDefaultFlavor();return i==="year3000"?Pn(r,t):wn(r,t)}getCinematicGradientPair(t,e="medium"){let i=this.getCurrentPaletteSystem(),r=t||this.getCurrentDefaultFlavor();if(i==="year3000")return In(r,e);{let a=Ve[r];switch(e){case"low":return[a.mauve,a.blue];case"medium":return[a.pink,a.peach];case"high":return[a.red,a.teal];default:return[a.mauve,a.pink]}}}getAnimatedFlowColors(t){let e=this.getCurrentPaletteSystem(),i=t||this.getCurrentDefaultFlavor();if(e==="year3000")return Dn(i);{let r=Ve[i];return{primary:r.mauve,secondary:r.pink,tertiary:r.blue,atmosphere:r.base}}}supportsCinematicFeatures(){return this.getCurrentPaletteSystem()==="year3000"}getPaletteSystemDisplayName(){return this.getCurrentPaletteSystem()==="year3000"?"Year 3000 Cinematic":"Catppuccin Classic"}},Z=Dr.getInstance()});var ci,ui,Vn=v(()=>{"use strict";ci={jazz:{temperatureShift:15,saturationBoost:1.1,warmth:.8},electronic:{temperatureShift:-10,saturationBoost:1.2,warmth:.2},classical:{temperatureShift:5,saturationBoost:.9,warmth:.6},rock:{temperatureShift:0,saturationBoost:1.15,warmth:.5},ambient:{temperatureShift:-5,saturationBoost:.8,warmth:.3},hiphop:{temperatureShift:8,saturationBoost:1.25,warmth:.7},pop:{temperatureShift:0,saturationBoost:1,warmth:.5},metal:{temperatureShift:-15,saturationBoost:1.3,warmth:.1},indie:{temperatureShift:10,saturationBoost:.95,warmth:.6},default:{temperatureShift:0,saturationBoost:1,warmth:.5}},ui=class{constructor(t,e){this.paletteCache={};this.cacheTTL=3e5;this.maxCacheSize=50;this.config=t,this.utils=e}async loadCustomPalette(t,e){let i=this.paletteCache[t];if(i&&Date.now()-i.timestamp<this.cacheTTL&&i.isValid)return this.config.enableDebug&&console.log(`[PaletteExtensionManager] Cache hit for palette: ${t}`),i.palette;try{let r=this.generateFallbackPalette(t);if(this.validatePalette(r))return this.cachePalette(t,r,!0),r}catch(r){this.config.enableDebug&&console.warn(`[PaletteExtensionManager] Failed to load palette ${t}:`,r)}return null}generateFallbackPalette(t){let e=this.utils.getRootStyle(),i=getComputedStyle(e),r=i.getPropertyValue("--spice-main").trim()||i.getPropertyValue("--spice-base").trim()||"#1e1e2e",a=i.getPropertyValue("--sn-gradient-accent").trim()||i.getPropertyValue("--spice-button").trim()||i.getPropertyValue("--sn-dynamic-accent").trim()||i.getPropertyValue("--spice-accent").trim()||"#8caaee",n=this.utils.hexToRgb(r.startsWith("#")?r:`#${r}`),s=this.utils.hexToRgb(a.startsWith("#")?a:`#${a}`);if(!n||!s){let m=i.getPropertyValue("--sn-dynamic-accent").trim(),d=i.getPropertyValue("--spice-base").trim();return{name:t,version:"1.0.0",accents:{mauve:m||"#ca9ee6",pink:"#f4b8e4",blue:m||"#8caaee",sapphire:"#85c1dc",sky:"#99d1db",teal:"#81c8be",green:"#a6d189",yellow:"#e5c890",peach:"#ef9f76",red:"#e78284",lavender:"#babbf1"},neutrals:{base:d||"#1e1e2e",surface0:"#313244",surface1:"#45475a",surface2:"#585b70",overlay0:"#6c7086",overlay1:"#7f849c",overlay2:"#9399b2",text:"#cdd6f4"},metadata:{author:"PaletteExtensionManager",description:`Generated fallback for ${t}`,temperature:"neutral"}}}let l=this.utils.rgbToHsl(n.r,n.g,n.b),c=this.utils.rgbToHsl(s.r,s.g,s.b);return{name:t,version:"1.0.0",accents:this.generateAccentVariations(c),neutrals:this.generateNeutralVariations(l),metadata:{author:"PaletteExtensionManager",description:`Generated palette for ${t}`,temperature:this.detectTemperature(l,c)}}}applyGenreAwareModifications(t,e){let i=ci[e]||ci.default;this.config.enableDebug&&console.log(`[PaletteExtensionManager] Applying ${e} hints to palette:`,i);let r={...t,accents:{},neutrals:{},metadata:{...t.metadata,genre:[...t.metadata?.genre||[],e]}};for(let[a,n]of Object.entries(t.accents))r.accents[a]=this.applyGenreColorModification(n,i.temperatureShift,i.saturationBoost);for(let[a,n]of Object.entries(t.neutrals))r.neutrals[a]=this.applyGenreColorModification(n,i.temperatureShift*.3,i.saturationBoost*.7);return r}validatePalette(t){if(!t||typeof t!="object"||!t.name||typeof t.name!="string"||!t.version||typeof t.version!="string"||!t.accents||typeof t.accents!="object"||!t.neutrals||typeof t.neutrals!="object")return!1;let e=[...Object.values(t.accents),...Object.values(t.neutrals)];for(let i of e)if(typeof i!="string"||!this.isValidHexColor(i))return!1;return!0}cachePalette(t,e,i){if(Object.keys(this.paletteCache).length>=this.maxCacheSize){let a=Object.entries(this.paletteCache).sort(([,n],[,s])=>n.timestamp-s.timestamp)[0]?.[0];a&&this.paletteCache[a]&&delete this.paletteCache[a]}this.paletteCache[t]={palette:e,timestamp:Date.now(),isValid:i}}generateAccentVariations(t){let e={},i=[0,30,60,120,180,210,240,300,330,45,90],r=["primary","secondary","tertiary","complement","opposite","warm1","cool1","accent1","accent2","highlight","emphasis"];return i.forEach((a,n)=>{let s=r[n]||`variant${n}`,l=(t.h+a)%360,c=this.utils.hslToRgb(l,t.s,t.l);c&&(e[s]=this.utils.rgbToHex(c.r,c.g,c.b))}),e}generateNeutralVariations(t){let e={};return[{name:"base",l:t.l},{name:"surface0",l:Math.min(95,t.l+10)},{name:"surface1",l:Math.min(90,t.l+20)},{name:"surface2",l:Math.min(85,t.l+30)},{name:"overlay0",l:Math.min(80,t.l+40)},{name:"overlay1",l:Math.min(75,t.l+50)},{name:"text",l:Math.min(95,t.l+60)}].forEach(r=>{let a=this.utils.hslToRgb(t.h,Math.max(0,t.s-20),r.l);a&&(e[r.name]=this.utils.rgbToHex(a.r,a.g,a.b))}),e}detectTemperature(t,e){let i=(t.h+e.h)/2;return i>=0&&i<=60||i>=300&&i<=360?"warm":i>=120&&i<=240?"cool":"neutral"}applyGenreColorModification(t,e,i){let r=this.utils.hexToRgb(t);if(!r)return t;let a=this.utils.rgbToHsl(r.r,r.g,r.b),n=(a.h+e+360)%360,s=Math.max(0,Math.min(100,a.s*i)),l=this.utils.hslToRgb(n,s,a.l);return l?this.utils.rgbToHex(l.r,l.g,l.b):t}isValidHexColor(t){return/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(t)}getGenreHints(t){return ci[t]||ci.default}clearCache(){this.paletteCache={},this.config.enableDebug&&console.log("[PaletteExtensionManager] Palette cache cleared")}}});function Rr(o){kt&&kt!==o&&console.warn("[CSSVariableWriter] Replacing existing global instance. This may indicate multiple SystemIntegrationCoordinator initializations."),kt=o}function A(){if(!kt)throw new Error("[CSSVariableWriter] Global instance not initialized. SystemIntegrationCoordinator must call setGlobalCSSVariableWriter() during initialization.");return kt}var Rt,ve,Pe,kt,$=v(()=>{"use strict";_();Rt=new Set(["--sn-beat-pulse-intensity","--sn-animation-scale","--sn-accent-hex","--sn-accent-rgb","--sn.music.beat.pulse.intensity","--sn.music.animation.scale","--sn.music.rhythm.phase","--sn.music.spectrum.phase","--sn.color.accent.hex","--sn.color.accent.rgb","--sn.bg.webgl.ready","--sn.bg.active-backend"]),ve=class ve{constructor(t,e){this.initialized=!1;this.cssVariableQueue=new Map;this.batchUpdateTimer=null;this.rafHandle=null;this.microtaskScheduled=!1;this.pendingTransactions=new Map;this.transactionCounter=0;this.updateQueue=new Map;this.flushTimer=null;this.currentDeviceCapabilities=null;this.currentPerformanceMode=null;this.lastCSSUpdate=0;this.cssUpdateThrottle=100;this.appliedClasses=new Set;this.visualEffectsState=null;this.visualEffectsUpdateTimer=null;this.lastVisualEffectsUpdate=0;this.optimizedConfig={};this.lastFPSCheck=0;this.currentPerformanceLevel="good";this.adaptiveThrottleLevel=1;this.priorityQueues=new Map;this.adaptiveMonitoringInterval=null;this.frameContextUnsubscribe=null;this.reduceMotionMQ=null;this.mqHandler=null;this.performanceMetrics={totalBatches:0,totalUpdates:0,totalBatchTime:0,maxBatchTime:0,averageBatchSize:0,overBudgetBatches:0,conflictResolutions:0,transactionCount:0,visualEffectsUpdates:0};this.PRIORITY_WEIGHTS={low:1,normal:2,high:3,critical:4};this.config=t,this.performanceCoordinator=e,this.eventBus=p,this.cssConfig={batchIntervalMs:0,maxBatchSize:50,enableDebug:t.enableDebug,useCssTextFastPath:!1,autoHijack:!0,enableAdaptiveOptimization:!0,enableThermalThrottling:!0,enableBatteryOptimization:!0,enableDeviceTierOptimization:!0,debugPerformanceClasses:t.enableDebug,enableVisualEffectsIntegration:!0,visualEffectsUpdateInterval:16,enableMusicVisualEffects:!0,enableAestheticVisualEffects:!0,enableAdaptiveThrottling:!0,priorityMappings:{critical:["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift"],high:["--sn-gradient-primary","--sn-gradient-secondary","--sn-gradient-accent"],normal:["--sn-gradient-","--sn-rs-"],low:["--sn-debug-","--sn-dev-"]},thresholds:{excellentFPS:55,goodFPS:45,poorFPS:30}},this.optimizedConfig=this.cssConfig,this.currentDeviceCapabilities=this.performanceCoordinator.getDeviceCapabilities(),this.currentPerformanceMode=this.performanceCoordinator.getCurrentPerformanceMode(),this.config.enableDebug&&console.log("\u{1F30C} [CSSVariableWriter] Created with visual-effects-driven CSS management")}async initialize(){this.initialized||(this.subscribeToEvents(),this.applyInitialOptimizations(),this.cssConfig.enableVisualEffectsIntegration&&this.startVisualEffectsIntegration(),this.cssConfig.autoHijack&&this.enableGlobalHijack(),this.initializeOptimizedFeatures(),this.initializeFrameContextIntegration(),this.initialized=!0,this.config.enableDebug&&console.log("\u{1F30C} [CSSVariableWriter] Initialized with device tier:",this.currentDeviceCapabilities?.performanceTier))}updateAnimation(t){}async healthCheck(){let t=this.cssVariableQueue.size+this.updateQueue.size,e=this.pendingTransactions.size,i=t<=1e3&&e<=100;return{system:"CSSVariableWriter",healthy:i,ok:i,details:i?"CSS visual-effects controller operating normally":"High queue size or pending transactions",metrics:{queueSize:t,pendingTransactions:e,performanceMetrics:this.performanceMetrics,visualEffectsActive:this.visualEffectsState!==null,deviceTier:this.currentDeviceCapabilities?.performanceTier,performanceMode:this.currentPerformanceMode?.name}}}forceRepaint(t){this.flushCSSVariableBatch(),this.config.enableDebug&&t&&console.log(`\u{1F30C} [CSSVariableWriter] Force repaint: ${t}`)}queueCSSVariableUpdate(t,e,i=null,r="normal",a="unknown"){let n=i||document.documentElement,s=this.optimizedConfig.enableAdaptiveThrottling?this.determineVariablePriority(t,r):r;if(s==="critical"||Rt.has(t)){this.applyCriticalUpdate(t,e,n);return}if(this.optimizedConfig.enableAdaptiveThrottling&&this.priorityQueues.size>0){this.queueByPriority(t,e,n,s,a);return}let c=`${i?`element_${i.id||i.className||"unnamed"}`:"root"}:${t}`,m={element:n,property:t,value:e,timestamp:performance.now(),priority:s,source:a},d=this.cssVariableQueue.get(c);d?this.shouldReplaceUpdate(d,m)&&(this.cssVariableQueue.set(c,m),this.performanceMetrics.conflictResolutions++):this.cssVariableQueue.set(c,m),this.performanceMetrics.totalUpdates++,this.scheduleFlush(s),(s==="critical"||this.cssVariableQueue.size>=this.cssConfig.maxBatchSize)&&this.flushCSSVariableBatch()}updateVariables(t,e="normal",i="unknown"){let r=`tx_${++this.transactionCounter}`,a=new Map(Object.entries(t)),n={id:r,variables:a,timestamp:performance.now(),priority:e,completed:!1};this.pendingTransactions.set(r,n);for(let[s,l]of a)this.queueCSSVariableUpdate(s,l,null,e,`${i}:${r}`);this.performanceMetrics.transactionCount++,this.config.enableDebug&&console.log(`\u{1F30C} [CSSVariableWriter] Transaction ${r} queued with ${a.size} variables`)}updateVisualEffectsVariables(t){if(!this.cssConfig.enableVisualEffectsIntegration)return;this.visualEffectsState=t,this.performanceMetrics.visualEffectsUpdates++;let e={};t.musicState&&this.cssConfig.enableMusicVisualEffects&&(e["--sn.music.beat.pulse.intensity"]=t.musicState.intensity.toString(),e["--sn.music.tempo.bpm"]=t.musicState.bpm.toString(),e["--sn.music.rhythm.phase"]=`${t.musicState.rhythmPhase}deg`,e["--sn.music.animation.scale"]=t.musicState.animationScale.toString(),e["--sn.music.energy.level"]=t.musicState.energy.toString(),e["--sn.music.valence"]=t.musicState.valence.toString()),t.aestheticState&&this.cssConfig.enableAestheticVisualEffects&&(e["--sn.aesthetic.harmony.level"]=t.aestheticState.harmonyLevel.toString(),e["--sn.aesthetic.evolution.factor"]=t.aestheticState.evolutionFactor.toString(),e["--sn.color.temperature"]=t.aestheticState.colorTemperature.toString()),t.performanceState&&(e["--sn.performance.mode"]=t.performanceState.mode,e["--sn.device.tier"]=t.performanceState.deviceTier,e["--sn.performance.optimization.level"]=t.performanceState.optimizationLevel.toString()),this.updateVariables(e,"high","visual-effects-system"),this.config.enableDebug&&console.log(`\u{1F30C} [CSSVariableWriter] Consciousness state updated with ${Object.keys(e).length} variables`)}applyPerformanceOptimizations(t){if(!this.cssConfig.enableAdaptiveOptimization)return;this.currentPerformanceMode=t;let e={"--sn.performance.mode":t.name,"--sn.performance.quality.level":t.qualityLevel.toString(),"--sn.performance.fps.target":t.frameRate.toString(),"--sn.performance.frame.budget":(1e3/t.frameRate).toString(),"--sn.performance.optimization.level":t.optimizationLevel.toString(),"--sn.performance.blur.quality":t.blurQuality.toString(),"--sn.performance.shadow.quality":t.shadowQuality.toString(),"--sn.performance.animation.quality":t.animationQuality.toString(),"--sn.performance.effect.quality":t.effectQuality.toString()};this.updateVariables(e,"high","performance-coordinator"),this.applyPerformanceModeOptimizations(),this.config.enableDebug&&console.log(`\u{1F30C} [CSSVariableWriter] Performance optimizations applied for mode: ${t.name}`)}getVariable(t){return getComputedStyle(document.documentElement).getPropertyValue(t).trim()||null}flushUpdates(){this.flushCSSVariableBatch()}flushCSSVariableBatch(){if(this.cssVariableQueue.size===0)return;let t=performance.now(),e=8,i=Array.from(this.cssVariableQueue.values());this.cssVariableQueue.clear(),this.rafHandle!==null&&(cancelAnimationFrame(this.rafHandle),this.rafHandle=null),this.microtaskScheduled=!1;try{let r=new Map;for(let n of i)r.has(n.element)||r.set(n.element,[]),r.get(n.element).push(n);for(let[n,s]of r.entries()){if(performance.now()-t>e){for(let l of s){let c=`${l.element.id||"root"}:${l.property}`;this.cssVariableQueue.set(c,l)}this.scheduleFlush("high");break}if(s.length>=3)this.applyCSSTextBatch(n,s);else for(let l of s)ve.nativeSetProperty?ve.nativeSetProperty.call(n.style,l.property,l.value):n.style.setProperty(l.property,l.value)}let a=performance.now()-t;this.updatePerformanceMetrics(a,i.length),a>e&&this.config.enableDebug?console.warn(`\u{1F30C} [CSSVariableWriter] CSS batch exceeded frame budget: ${a.toFixed(2)}ms (${i.length} updates)`):this.config.enableDebug&&Math.random()<.05&&console.log(`\u{1F30C} [CSSVariableWriter] Efficient CSS batch: ${i.length} updates in ${a.toFixed(2)}ms`)}catch(r){console.error("[CSSVariableWriter] Error in optimized CSS batch processing:",r),this.applyUpdatesWithFallback(i)}}applyCSSTextBatch(t,e){try{let i=t.style.cssText,r=new Map;if(i){let n=i.split(";");for(let s of n){let l=s.indexOf(":");if(l>0){let c=s.slice(0,l).trim(),m=s.slice(l+1).trim();c&&m&&r.set(c,m)}}}for(let n of e)r.set(n.property,n.value);let a=[];for(let[n,s]of r)a.push(`${n}:${s}`);t.style.cssText=a.join(";")}catch{for(let r of e)try{t.style.setProperty(r.property,r.value)}catch(a){console.warn(`Failed to apply ${r.property}:`,a)}}}applyUpdatesWithFallback(t){for(let e of t)try{ve.nativeSetProperty?ve.nativeSetProperty.call(e.element.style,e.property,e.value):e.element.style.setProperty(e.property,e.value)}catch(i){console.warn(`[CSSVariableWriter] Failed to apply CSS property ${e.property}:`,i)}}setMusicMetrics(t){let e={};t.beatIntensity!==void 0&&(e["--sn.music.beat.pulse.intensity"]=t.beatIntensity.toString()),t.rhythmPhase!==void 0&&(e["--sn.music.rhythm.phase"]=`${t.rhythmPhase}deg`),t.animationScale!==void 0&&(e["--sn.music.animation.scale"]=t.animationScale.toString()),t.spectrumPhase!==void 0&&(e["--sn.music.spectrum.phase"]=`${t.spectrumPhase}deg`),t.energy!==void 0&&(e["--sn.music.energy.level"]=t.energy.toString()),t.valence!==void 0&&(e["--sn.music.valence"]=t.valence.toString()),t.bpm!==void 0&&(e["--sn.music.tempo.bpm"]=t.bpm.toString()),this.updateVariables(e,"critical","music-system")}setColorTokens(t){let e={};t.accentHex&&(e["--sn.color.accent.hex"]=t.accentHex),t.accentRgb&&(e["--sn.color.accent.rgb"]=t.accentRgb),t.primaryRgb&&(e["--sn.bg.gradient.primary.rgb"]=t.primaryRgb),t.secondaryRgb&&(e["--sn.bg.gradient.secondary.rgb"]=t.secondaryRgb),t.gradientOpacity!==void 0&&(e["--sn.bg.gradient.opacity"]=t.gradientOpacity.toString()),t.gradientBlur&&(e["--sn.bg.gradient.blur"]=t.gradientBlur),this.updateVariables(e,"high","color-system")}setPerformanceTokens(t){let e={};t.webglReady!==void 0&&(e["--sn.bg.webgl.ready"]=t.webglReady?"1":"0"),t.activeBackend&&(e["--sn.bg.active-backend"]=t.activeBackend),t.qualityLevel&&(e["--sn.perf.quality.level"]=t.qualityLevel),t.reducedMotion!==void 0&&(e["--sn.anim.motion.reduced"]=t.reducedMotion?"1":"0"),t.gpuAcceleration!==void 0&&(e["--sn.perf.gpu.acceleration.enabled"]=t.gpuAcceleration?"1":"0"),this.updateVariables(e,"high","performance-system")}setProperty(t,e,i=null){if(t.startsWith("--spice-")&&this.config.enableSpiceVariableDebug){let r=new Error().stack?.split(`
`)[2]?.trim().replace(/^\s*at\s+/,"")||"unknown";console.log(`\u{1F527} [CSS Debug] Setting ${t} = ${e} (from: ${r})`)}this.queueCSSVariableUpdate(t,e,i)}applyDeviceOptimizations(){if(!this.cssConfig.enableDeviceTierOptimization||!this.currentDeviceCapabilities)return;this.removeClassesByPrefix("device-tier-"),this.removeClassesByPrefix("device-mobile-"),this.removeClassesByPrefix("device-gpu-");let t=`device-tier-${this.currentDeviceCapabilities.performanceTier}`;this.addCSSClass(t),this.currentDeviceCapabilities.isMobile&&this.addCSSClass("device-mobile-optimized"),this.currentDeviceCapabilities.gpuAcceleration?this.addCSSClass("device-gpu-accelerated"):this.addCSSClass("device-gpu-fallback");let e=this.getMemoryTier(this.currentDeviceCapabilities.memoryGB);this.addCSSClass(`device-memory-${e}`)}applyPerformanceModeOptimizations(){if(!this.currentPerformanceMode)return;this.removeClassesByPrefix("performance-mode-");let t=`performance-mode-${this.currentPerformanceMode.name}`;this.addCSSClass(t);let e=`optimization-level-${this.currentPerformanceMode.optimizationLevel}`;this.addCSSClass(e)}getPerformanceReport(){let t=this.performanceMetrics.totalBatches>0?this.performanceMetrics.totalBatchTime/this.performanceMetrics.totalBatches:0;return{enabled:!0,pendingUpdates:this.cssVariableQueue.size+this.updateQueue.size,totalUpdates:this.performanceMetrics.totalUpdates,totalBatches:this.performanceMetrics.totalBatches,averageBatchSize:Math.round(this.performanceMetrics.averageBatchSize*10)/10,averageBatchTime:Math.round(t*100)/100,maxBatchTime:Math.round(this.performanceMetrics.maxBatchTime*100)/100,overBudgetBatches:this.performanceMetrics.overBudgetBatches,conflictResolutions:this.performanceMetrics.conflictResolutions,transactionCount:this.performanceMetrics.transactionCount,visualEffectsUpdates:this.performanceMetrics.visualEffectsUpdates,visualEffectsActive:this.visualEffectsState!==null,deviceTier:this.currentDeviceCapabilities?.performanceTier,performanceMode:this.currentPerformanceMode?.name}}subscribeToEvents(){this.eventBus.subscribe("performance:tier-changed",t=>{this.currentPerformanceMode=this.performanceCoordinator.getCurrentPerformanceMode(),this.applyPerformanceModeOptimizations(),this.updateCSSPerformanceVariables()},"CSSVariableWriter"),this.eventBus.subscribe("performance:frame",t=>{t.temperature&&t.temperature>80&&this.applyThermalOptimizations(t.temperature)},"CSSVariableWriter")}applyInitialOptimizations(){try{this.applyDeviceOptimizations(),this.applyPerformanceModeOptimizations(),this.updateCSSPerformanceVariables(),this.cssConfig.debugPerformanceClasses&&this.addCSSClass("debug-performance")}catch(t){this.config.enableDebug&&console.warn("[CSSVariableWriter] Error applying initial optimizations:",t)}}applyCurrentOptimizations(){this.applyDeviceOptimizations(),this.applyPerformanceModeOptimizations();let t=this.performanceCoordinator.getBatteryState(),e=this.performanceCoordinator.getThermalState();t&&this.applyBatteryOptimizations(t.level,t.charging);let i=e.temperature||"normal";this.applyThermalOptimizations(i)}updateCSSPerformanceVariables(){let t=Date.now();if(!(t-this.lastCSSUpdate<this.cssUpdateThrottle)&&(this.lastCSSUpdate=t,!(!this.currentPerformanceMode||!this.currentDeviceCapabilities)))try{let e={"--sn.performance.mode":this.currentPerformanceMode.name||"balanced","--sn.performance.quality.level":(this.currentPerformanceMode.qualityLevel??.8).toString(),"--sn.performance.fps.target":(this.currentPerformanceMode.frameRate??60).toString(),"--sn.performance.frame.budget":(1e3/(this.currentPerformanceMode.frameRate??60)).toString(),"--sn.performance.optimization.level":(this.currentPerformanceMode.optimizationLevel??1).toString(),"--sn.device.tier":this.currentDeviceCapabilities.performanceTier??"mid","--sn.device.memory":(this.currentDeviceCapabilities.memoryGB??8).toString(),"--sn.device.gpu":this.currentDeviceCapabilities.gpuAcceleration??!0?"1":"0","--sn.device.mobile":this.currentDeviceCapabilities.isMobile??!1?"1":"0","--sn.performance.blur.quality":(this.currentPerformanceMode.blurQuality??.8).toString(),"--sn.performance.shadow.quality":(this.currentPerformanceMode.shadowQuality??.8).toString(),"--sn.performance.animation.quality":(this.currentPerformanceMode.animationQuality??.8).toString(),"--sn.performance.effect.quality":(this.currentPerformanceMode.effectQuality??.8).toString()};this.updateVariables(e,"high","performance-coordinator")}catch(e){this.config.enableDebug&&console.warn("[CSSVariableWriter] Error updating CSS performance variables:",e)}}startVisualEffectsIntegration(){if(this.visualEffectsUpdateTimer)return;let t=()=>{let e=performance.now();e-this.lastVisualEffectsUpdate>=this.cssConfig.visualEffectsUpdateInterval&&(this.lastVisualEffectsUpdate=e,this.visualEffectsState&&this.updateVisualEffectsVariables(this.visualEffectsState)),this.visualEffectsUpdateTimer=setTimeout(t,this.cssConfig.visualEffectsUpdateInterval)};t()}shouldReplaceUpdate(t,e){let i=this.PRIORITY_WEIGHTS[t.priority],r=this.PRIORITY_WEIGHTS[e.priority];return r>i?!0:r===i?e.timestamp>t.timestamp:!1}scheduleFlush(t){if(this.rafHandle!==null||this.microtaskScheduled)return;let e=()=>{this.rafHandle=null,this.microtaskScheduled=!1,this.flushCSSVariableBatch()};typeof document<"u"&&document.visibilityState==="hidden"?(this.microtaskScheduled=!0,queueMicrotask(e)):typeof requestAnimationFrame=="function"?this.rafHandle=requestAnimationFrame(e):setTimeout(e,0)}updatePerformanceMetrics(t,e){this.performanceMetrics.totalBatches++,this.performanceMetrics.totalBatchTime+=t,this.performanceMetrics.maxBatchTime=Math.max(this.performanceMetrics.maxBatchTime,t),this.performanceMetrics.averageBatchSize=(this.performanceMetrics.averageBatchSize*(this.performanceMetrics.totalBatches-1)+e)/this.performanceMetrics.totalBatches,t>8&&(this.performanceMetrics.overBudgetBatches++,this.config.enableDebug&&console.warn(`[CSSVariableWriter] CSS batch took ${t.toFixed(2)}ms for ${e} updates`))}enableGlobalHijack(){if(ve.hijackEnabled)return;let t=CSSStyleDeclaration.prototype.setProperty;ve.nativeSetProperty=t;let e=this;CSSStyleDeclaration.prototype.setProperty=function(i,r,a){i&&(i.startsWith("--sn-")||i.startsWith("--sn."))&&e?e.queueCSSVariableUpdate(i,String(r??"")):t.call(this,i,r,a)},ve.hijackEnabled=!0,this.config.enableDebug&&console.log("\u{1F30C} [CSSVariableWriter] Global setProperty hijack enabled (--sn- and --sn. namespaces)")}addCSSClass(t){this.appliedClasses.has(t)||(document.body.classList.add(t),this.appliedClasses.add(t))}removeCSSClass(t){this.appliedClasses.has(t)&&(document.body.classList.remove(t),this.appliedClasses.delete(t))}removeClassesByPrefix(t){let e=Array.from(this.appliedClasses).filter(i=>i.startsWith(t));for(let i of e)this.removeCSSClass(i)}getMemoryTier(t){return t>=16?"high":t>=8?"medium":t>=4?"low":"minimal"}applyThermalOptimizations(t){if(!this.cssConfig.enableThermalThrottling)return;this.removeClassesByPrefix("thermal-");let e=`thermal-${t}`;this.addCSSClass(e)}applyBatteryOptimizations(t,e){this.cssConfig.enableBatteryOptimization&&(this.removeClassesByPrefix("battery-"),t<.2?this.addCSSClass("battery-low"):t<.5?this.addCSSClass("battery-medium"):this.addCSSClass("battery-high"),e&&this.addCSSClass("battery-charging"))}updateMusicVariables(t){let e={};for(let[i,r]of Object.entries(t))if(r!==void 0){let a=`--sn-music-${i.replace(/\./g,"-")}`;e[a]=String(r)}this.updateVariables(e,"critical","music-system")}updateColorVariables(t){let e={};for(let[i,r]of Object.entries(t))if(r!==void 0){let a=`--sn-color-${i.replace(/\./g,"-")}`;e[a]=String(r)}this.updateVariables(e,"high","color-system")}updateAnimationVariables(t){let e={};for(let[i,r]of Object.entries(t))if(r!==void 0){let a=`--sn-anim-${i.replace(/\./g,"-")}`;e[a]=typeof r=="boolean"?r?"1":"0":String(r)}this.updateVariables(e,"normal","animation-system")}updatePerformanceVariables(t){let e={};for(let[i,r]of Object.entries(t))if(r!==void 0){let a=`--sn-performance-${i.replace(/\./g,"-")}`;e[a]=typeof r=="boolean"?r?"1":"0":String(r)}this.updateVariables(e,"high","performance-system")}updateUtilityVariables(t){let e={};for(let[i,r]of Object.entries(t))if(r!==void 0){let a=`--sn-${i.replace(/\./g,"-")}`;e[a]=typeof r=="boolean"?r?"1":"0":String(r)}this.updateVariables(e,"low","utility-system")}queueUpdate(t,e,i="normal",r="unknown"){this.queueCSSVariableUpdate(t,e,null,i,r)}queueTransaction(t,e="normal",i="unknown"){let r=`tx_${++this.transactionCounter}`,a=new Map(Object.entries(t)),n={id:r,variables:a,timestamp:performance.now(),priority:e,completed:!1};this.pendingTransactions.set(r,n);for(let[s,l]of a)this.queueUpdate(s,l,e,`${i}:${r}`);return this.performanceMetrics.transactionCount++,this.config.enableDebug&&console.log(`\u{1F30C} [CSSVariableWriter] Transaction ${r} queued with ${a.size} variables`),r}forceFlush(){this.flushCSSVariableBatch()}registerVariableGroup(t,e="normal",i=50,r=16){this.config.enableDebug&&console.log(`\u{1F30C} [CSSVariableWriter] Variable group registration: ${t} (handled internally)`)}updateVariableGroup(t,e,i="unknown"){this.updateVariables(e,"normal",`group:${t}:${i}`)}updateConfig(t){this.cssConfig={...this.cssConfig,...t},this.config.enableDebug&&console.log("\u{1F30C} [CSSVariableWriter] Configuration updated:",t)}flushNow(){this.flushCSSVariableBatch()}setBatchingEnabled(t){this.config.enableDebug&&console.log(`\u{1F30C} [CSSVariableWriter] Batching ${t?"enabled":"disabled"}`)}addCriticalVariable(t){Rt.add(t),this.config.enableDebug&&console.log(`\u{1F30C} [CSSVariableWriter] Added critical variable: ${t}`)}removeCriticalVariable(t){Rt.delete(t),this.config.enableDebug&&console.log(`\u{1F30C} [CSSVariableWriter] Removed critical variable: ${t}`)}isCriticalVariable(t){return Rt.has(t)}getCriticalVariables(){return Array.from(Rt)}updateVisualEffectsIntensity(t,e,i){let r=Math.max(0,Math.min(1,t));this.queueCSSVariableUpdate("--visual-effects-intensity",r.toString(),null,"high",`visual-effects-${e}`),this.eventBus&&this.eventBus.emitSync("visual-effects:intensity-changed",{intensity:r,userEngagement:.5,timestamp:Date.now(),sourceStrategy:e,musicEnergy:i??0}),this.config.enableDebug&&console.log(`\u{1F30C} [CSSVariableWriter] Consciousness intensity updated by ${e}: ${r}`)}updateCrossfadeOpacity(t,e,i){let r=Math.max(0,Math.min(1,t));i||(r=0),this.queueCSSVariableUpdate("--sn-gradient-crossfade-opacity",r.toString(),null,"high",`crossfade-${e}`),this.eventBus&&this.eventBus.emitSync("gradient:crossfade-changed",{opacity:r,sourceStrategy:e,webglEnabled:i,timestamp:Date.now()}),this.config.enableDebug&&console.log(`\u{1F30C} [CSSVariableWriter] Crossfade opacity updated by ${e}: ${r} (WebGL: ${i})`)}subscribeToVisualEffectsChanges(t){if(!this.eventBus)return console.warn("[CSSVariableWriter] No UnifiedEventBus available for visual-effects subscriptions"),()=>{};let e=this.eventBus.subscribe("visual-effects:intensity-changed",t,"CSSVariableWriter");return()=>this.eventBus?.unsubscribe(e)}subscribeToCrossfadeChanges(t){if(!this.eventBus)return console.warn("[CSSVariableWriter] No UnifiedEventBus available for crossfade subscriptions"),()=>{};let e=this.eventBus.subscribe("gradient:crossfade-changed",t,"CSSVariableWriter");return()=>this.eventBus?.unsubscribe(e)}setVariable(t,e,i,r,a){let n,s,l,c;arguments.length>=4?(n=e,s=i,l=r||"normal",c=`${t}${a?`:${a}`:""}`):(n=t,s=e,l=i||"normal",c="legacy-api");let m=l||"normal";this.queueCSSVariableUpdate(n,s,null,m,c)}batchSetVariables(t,e,i,r){let a,n,s;typeof t=="string"?(a=e,n=i||"normal",s=`${t}${r?`:${r}`:""}`):(a=t,n=e||"normal",s="legacy-batch-api");let l=n||"normal";this.updateVariables(a,l,s)}initializeOptimizedFeatures(){this.currentDeviceCapabilities?.performanceTier,this.config.enableDebug&&console.log("[CSSVariableWriter] Optimized features initialized")}initializeFrameContextIntegration(){this.config.enableDebug&&console.log("[CSSVariableWriter] Frame context integration initialized")}determineVariablePriority(t,e){return t.includes("sn-critical")||t.includes("spice-main")?"critical":t.includes("music")||t.includes("beat")||t.includes("energy")?"high":t.includes("color")||t.includes("accent")?"normal":e||"low"}applyCriticalUpdate(t,e,i){let r=i||document.documentElement;try{r.style.setProperty(t,e),this.config.enableDebug&&console.log(`[CSSVariableWriter] Critical update applied: ${t} = ${e}`)}catch(a){console.warn("[CSSVariableWriter] Critical update failed:",a)}}queueByPriority(t,e,i,r,a){this.priorityQueues.has(r)||this.priorityQueues.set(r,new Map),this.priorityQueues.get(r).set(t,{property:t,value:e,timestamp:Date.now()}),(r==="critical"||r==="high")&&this.flushCSSVariableBatch()}destroyFrameContextIntegration(){this.config.enableDebug&&console.log("[CSSVariableWriter] Frame context integration destroyed")}destroy(){this.adaptiveMonitoringInterval&&(clearInterval(this.adaptiveMonitoringInterval),this.adaptiveMonitoringInterval=null),this.destroyFrameContextIntegration(),this.priorityQueues.clear(),this.visualEffectsUpdateTimer&&(clearTimeout(this.visualEffectsUpdateTimer),this.visualEffectsUpdateTimer=null),this.cssVariableQueue.clear(),p.unsubscribeAll("CSSVariableWriter"),this.initialized=!1}};ve.hijackEnabled=!1;Pe=ve,kt=null});function Gn(o,t,e,i){let r=o,a=t||o,n=e||kr(o,.3),s=i||Fn(o,.2),l=kr(o,.6),c=kr(o,.4),m=a,d=Fn(a,.15),h=mi(o,120),g=mi(o,-60),f=mi(o,180);return{primary:r,surface0:c,surface1:m,surface2:d,base:l,shadow:n,highlight:s,harmonyPrimary:h,harmonySecondary:g,harmonyTertiary:f}}function _n(o){let t={};return Object.entries(o).forEach(([e,i])=>{t[e]=O(i)}),t}function kr(o,t){try{let e=re(o);if(!e)return o;let i=Math.max(0,Math.round(e.r*(1-t))),r=Math.max(0,Math.round(e.g*(1-t))),a=Math.max(0,Math.round(e.b*(1-t)));return ie(i,r,a)}catch(e){return console.warn("[SpicetifyColorGenerators] Failed to generate darker variant:",e),o}}function Fn(o,t){try{let e=re(o);if(!e)return o;let i=Math.min(255,Math.round(e.r+(255-e.r)*t)),r=Math.min(255,Math.round(e.g+(255-e.g)*t)),a=Math.min(255,Math.round(e.b+(255-e.b)*t));return ie(i,r,a)}catch(e){return console.warn("[SpicetifyColorGenerators] Failed to generate lighter variant:",e),o}}function mi(o,t){try{let e=re(o);if(!e)return o;let i=Bn(e.r,e.g,e.b);i.h=(i.h+t)%360,i.h<0&&(i.h+=360);let r=Hn(i.h,i.s,i.l);return ie(r.r,r.g,r.b)}catch(e){return console.warn("[SpicetifyColorGenerators] Failed to generate hue-rotated color:",e),o}}function Vr(o){try{let t=re(o);if(!t)return"#FF0000";let e=Math.min(255,t.r+100),i=Math.max(0,Math.min(t.g*.3,100)),r=Math.max(0,Math.min(t.b*.2,80));return ie(e,i,r)}catch(t){return console.warn("[SpicetifyColorGenerators] Failed to generate cinematic red:",t),"#FF0000"}}function Fr(o){try{let t=re(o);if(!t)return"#00FFFF";let e=Math.min(255,t.g+120),i=Math.min(255,t.b+140),r=Math.max(0,Math.min(t.r*.2,60));return ie(r,e,i)}catch(t){return console.warn("[SpicetifyColorGenerators] Failed to generate cinematic cyan:",t),"#00FFFF"}}function Gr(o){try{let t=re(o);if(!t)return"#FFFF00";let e=Math.min(255,t.r+80),i=Math.min(255,t.g+100),r=Math.max(0,Math.min(t.b*.3,120));return ie(e,i,r)}catch(t){return console.warn("[SpicetifyColorGenerators] Failed to generate cinematic yellow:",t),"#FFFF00"}}function _r(o){try{let t=re(o);if(!t)return"#8A2BE2";let e=Bn(t.r,t.g,t.b),i=Math.min(100,e.s+30),r=Math.min(80,Math.max(40,e.l+10)),a=Hn(e.h,i,r);return ie(a.r,a.g,a.b)}catch(t){return console.warn("[SpicetifyColorGenerators] Failed to generate holographic primary:",t),"#8A2BE2"}}function Br(o){try{return mi(o,45)}catch(t){return console.warn("[SpicetifyColorGenerators] Failed to generate holographic accent:",t),"#FF00FF"}}function Hr(o){try{let t=re(o);if(!t)return"#E0E0FF";let e=.7,i=Math.min(255,t.r+(255-t.r)*e),r=Math.min(255,t.g+(255-t.g)*e),a=Math.min(255,t.b+(255-t.b)*e);return ie(i,r,a)}catch(t){return console.warn("[SpicetifyColorGenerators] Failed to generate holographic glow:",t),"#E0E0FF"}}function zr(o){try{let t=re(o);return t&&(.299*t.r+.587*t.g+.114*t.b)/255>.5?"#24273A":"#CAD3F5"}catch(t){return console.warn("[SpicetifyColorGenerators] Failed to generate text color:",t),"#CAD3F5"}}function Or(o){try{let t=re(o);return t&&(.299*t.r+.587*t.g+.114*t.b)/255>.5?"#5B6078":"#A5ADCB"}catch(t){return console.warn("[SpicetifyColorGenerators] Failed to generate subtext color:",t),"#A5ADCB"}}function Ze(o,t){try{let e=re(o);if(!e)return`rgba(88,91,112,${t})`;if((.299*e.r+.587*e.g+.114*e.b)/255>.5){let r=1-t*2,a=Math.max(0,Math.round(e.r*r)),n=Math.max(0,Math.round(e.g*r)),s=Math.max(0,Math.round(e.b*r));return ie(a,n,s)}else{let r=t*255,a=Math.min(255,Math.round(e.r+r)),n=Math.min(255,Math.round(e.g+r)),s=Math.min(255,Math.round(e.b+r));return ie(a,n,s)}}catch(e){return console.warn("[SpicetifyColorGenerators] Failed to generate overlay color:",e),`rgba(88,91,112,${t})`}}function Ur(o){try{let t=re(o);if(!t)return"#232634";if((.299*t.r+.587*t.g+.114*t.b)/255>.5){let i=Math.max(0,Math.round(t.r*.8)),r=Math.max(0,Math.round(t.g*.8)),a=Math.max(0,Math.round(t.b*.8));return ie(i,r,a)}else{let i=Math.min(255,Math.round(t.r+20)),r=Math.min(255,Math.round(t.g+20)),a=Math.min(255,Math.round(t.b+20));return ie(i,r,a)}}catch(t){return console.warn("[SpicetifyColorGenerators] Failed to generate crust color:",t),"#232634"}}function Nr(o){try{let t=re(o);if(!t)return"#1e2030";if((.299*t.r+.587*t.g+.114*t.b)/255>.5){let i=Math.max(0,Math.round(t.r*.95)),r=Math.max(0,Math.round(t.g*.95)),a=Math.max(0,Math.round(t.b*.95));return ie(i,r,a)}else{let i=Math.min(255,Math.round(t.r+10)),r=Math.min(255,Math.round(t.g+10)),a=Math.min(255,Math.round(t.b+10));return ie(i,r,a)}}catch(t){return console.warn("[SpicetifyColorGenerators] Failed to generate mantle color:",t),"#1e2030"}}function he(o,t){try{let e=re(o);if(!e)return console.warn(`[SpicetifyColorGenerators] Failed to parse RGB from ${o}`),o;let r={flamingo:{rAdjust:20,gAdjust:-10,bAdjust:-5},lavender:{rAdjust:10,gAdjust:-5,bAdjust:15},peach:{rAdjust:25,gAdjust:10,bAdjust:-15},rosewater:{rAdjust:15,gAdjust:-8,bAdjust:0},sapphire:{rAdjust:-20,gAdjust:-10,bAdjust:25}}[t],a=Math.max(0,Math.min(255,e.r+r.rAdjust)),n=Math.max(0,Math.min(255,e.g+r.gAdjust)),s=Math.max(0,Math.min(255,e.b+r.bAdjust));return ie(a,n,s)}catch(e){return console.warn(`[SpicetifyColorGenerators] Failed to generate ${t} color:`,e),o}}function le(o,t){try{let e=re(o);if(!e)return console.warn(`[SpicetifyColorGenerators] Failed to parse RGB from ${o}`),o;let r={pink:{rAdjust:30,gAdjust:-20,bAdjust:-10},sky:{rAdjust:-30,gAdjust:10,bAdjust:30},red:{rAdjust:35,gAdjust:-25,bAdjust:-15},maroon:{rAdjust:25,gAdjust:-15,bAdjust:-10},yellow:{rAdjust:30,gAdjust:25,bAdjust:-30},green:{rAdjust:-25,gAdjust:30,bAdjust:-20}}[t],a=Math.max(0,Math.min(255,e.r+r.rAdjust)),n=Math.max(0,Math.min(255,e.g+r.gAdjust)),s=Math.max(0,Math.min(255,e.b+r.bAdjust));return ie(a,n,s)}catch(e){return console.warn(`[SpicetifyColorGenerators] Failed to generate ${t} color:`,e),o}}function re(o){let t=o.replace("#","");if(t.length!==6&&t.length!==3)return null;let e,i,r;return t.length===6?(e=parseInt(t.substring(0,2),16),i=parseInt(t.substring(2,4),16),r=parseInt(t.substring(4,6),16)):(e=parseInt(t[0]+t[0],16),i=parseInt(t[1]+t[1],16),r=parseInt(t[2]+t[2],16)),{r:e,g:i,b:r}}function ie(o,t,e){let i=r=>{let a=Math.round(Math.max(0,Math.min(255,r))).toString(16);return a.length===1?"0"+a:a};return`#${i(o)}${i(t)}${i(e)}`}function Bn(o,t,e){o/=255,t/=255,e/=255;let i=Math.max(o,t,e),r=Math.min(o,t,e),a=0,n=0,s=(i+r)/2;if(i===r)a=n=0;else{let l=i-r;switch(n=s>.5?l/(2-i-r):l/(i+r),i){case o:a=(t-e)/l+(t<e?6:0);break;case t:a=(e-o)/l+2;break;case e:a=(o-t)/l+4;break}a/=6}return{h:a*360,s:n*100,l:s*100}}function Hn(o,t,e){o/=360,t/=100,e/=100;let i=(s,l,c)=>(c<0&&(c+=1),c>1&&(c-=1),c<1/6?s+(l-s)*6*c:c<1/2?l:c<2/3?s+(l-s)*(2/3-c)*6:s),r,a,n;if(t===0)r=a=n=e;else{let s=e<.5?e*(1+t):e+t-e*t,l=2*e-s;r=i(l,s,o+1/3),a=i(l,s,o),n=i(l,s,o-1/3)}return{r:Math.round(r*255),g:Math.round(a*255),b:Math.round(n*255)}}function O(o){let t=re(o);return t?`${t.r}, ${t.g}, ${t.b}`:"0, 0, 0"}var zn=v(()=>{"use strict"});function On(){return typeof window<"u"&&window.Spicetify?window.Spicetify:null}function Cl(){return!!On()?.Platform}var Ge,mt,$r=v(()=>{"use strict";$();zn();_();te();Ge=class Ge{constructor(t={}){this.colorCache=new Map;this.lastCacheUpdate=0;this.initialized=!1;this.eventSubscriptionIds=[];this.lastColorUpdate=0;this.colorUpdateCount=0;this.lastAppliedVariables={};this.lastUpdateDuration=0;this.updateDurations=[];this.skippedUpdateCount=0;this.config={enableDebug:!1,fallbackToSpiceColors:!0,cacheDuration:5e3,...t}}async initialize(t){if(this.initialized){console.warn("[SpicetifyColorBridge] Already initialized, skipping");return}try{this.cssController=t||A(),this.setupEventSubscriptions(),this.initialized=!0,this.lastColorUpdate=Date.now(),this.config.enableDebug&&console.log("\u{1F3A8} [SpicetifyColorBridge] Initialized as IManagedSystem with",{mappings:Ge.SEMANTIC_MAPPINGS.length,batcherAvailable:!!this.cssController,spicetifyAvailable:this.isSpicetifyAvailable(),eventSubscriptions:this.eventSubscriptionIds.length}),p.emitSync("system:initialized",{systemName:"SpicetifyColorBridge",timestamp:Date.now(),metadata:{mappings:Ge.SEMANTIC_MAPPINGS.length,spicetifyAvailable:this.isSpicetifyAvailable()?1:0}})}catch(e){throw console.error("[SpicetifyColorBridge] Initialization failed:",e),p.emitSync("system:error",{systemName:"SpicetifyColorBridge",error:e instanceof Error?e.message:"Initialization failed",severity:"critical",timestamp:Date.now()}),e}}async updateSemanticColors(){if(!this.initialized){console.warn("[SpicetifyColorBridge] Not initialized, cannot update colors");return}let t=Date.now();if(!(t-this.lastCacheUpdate<(this.config.cacheDuration||5e3))){console.log("\u{1F3A8} [SpicetifyColorBridge] Starting semantic color update...");try{let e={},i={},r={};for(let a of Ge.SEMANTIC_MAPPINGS){let n=await this.getSemanticColor(a.semanticColor);e[a.cssVariable]={semanticColor:a.semanticColor,retrievedColor:n,fallbackColor:a.fallbackColor,description:a.description},i[a.cssVariable]=n;let s=be(n);if(s){let l=a.cssVariable.replace("--spice-","--spice-rgb-");r[l]=`${s.r},${s.g},${s.b}`,e[l]=`${s.r},${s.g},${s.b}`}}this.cssController.batchSetVariables("SpicetifyColorBridge",i,"high","semantic-color-update"),this.cssController.batchSetVariables("SpicetifyColorBridge",r,"high","semantic-rgb-update"),console.log("\u{1F3A8} [SpicetifyColorBridge] Color update complete:",e),this.lastCacheUpdate=t,this.config.enableDebug&&console.log("\u{1F3A8} [SpicetifyColorBridge] Updated all semantic colors")}catch(e){console.error("[SpicetifyColorBridge] Failed to update semantic colors:",e)}}}async getSemanticColor(t){let e=this.colorCache.get(t);if(e&&Date.now()-this.lastCacheUpdate<(this.config.cacheDuration||5e3))return e;let i;try{let r=On();this.isSpicetifyAvailable()&&r?.Platform?.getSemanticColors?(i=(await r.Platform.getSemanticColors())[t],console.log(`\u{1F3A8} [SpicetifyColorBridge] Spicetify returned for ${t}:`,{rawValue:i,type:typeof i,isWhite:i==="#ffffff"||i==="#fff"||i==="white",isInvalid:!i||i==="undefined"||i==="null"})):(console.warn(`\u{1F3A8} [SpicetifyColorBridge] Spicetify not available, using fallback for ${t}`),i=this.getFallbackColor(t))}catch(r){this.config.enableDebug&&console.warn(`[SpicetifyColorBridge] Failed to get semantic color ${t}:`,r),i=this.getFallbackColor(t)}return i=this.validateColor(i,t),this.colorCache.set(t,i),i}validateColor(t,e){let i=t?.toLowerCase().trim();if(!i||["#ffffff","#fff","white","#000000","#000","black","","undefined","null","transparent"].includes(i)){let a=this.getFallbackColor(e);return this.config.enableDebug&&console.warn(`\u{1F527} [SpicetifyColorBridge] Invalid color "${t}" for ${e}, using fallback: ${a}`),a}if(!i.match(/^#[0-9a-f]{6}$/i)&&!i.match(/^#[0-9a-f]{3}$/i)){let a=this.getFallbackColor(e);return this.config.enableDebug&&console.warn(`\u{1F527} [SpicetifyColorBridge] Malformed color "${t}" for ${e}, using fallback: ${a}`),a}return t}getFallbackColor(t){let e=Ge.SEMANTIC_MAPPINGS.find(i=>i.semanticColor===t);return e?e.fallbackColor:t.startsWith("text")?"#cad3f5":t.startsWith("background")?"#24273a":t.startsWith("essential")?"#c6a0f6":t.startsWith("decorative")?"#939ab7":"#cad3f5"}applyColorToCSS(t,e,i="normal",r="semantic-color-manager"){this.cssController.setVariable("SpicetifyColorBridge",t,e,i,r)}isSpicetifyAvailable(){return Cl()}flushUpdates(){this.cssController&&this.cssController.flushUpdates()}clearCache(){this.colorCache.clear(),this.lastCacheUpdate=0}updateWithAlbumColors(t){console.log("\u{1F3A8} [SpicetifyColorBridge] \u2550\u2550\u2550 updateWithAlbumColors() CALLED \u2550\u2550\u2550");let e="processedColors"in t,i=e?t.processedColors:t,r=e?t.metadata:null;if(console.log("\u{1F3A8} [SpicetifyColorBridge] Input data:",{isEventData:e,hasMetadata:!!r,hasOKLABMetadata:!!r?.oklabMetadata,colorKeys:Object.keys(i),colorCount:Object.keys(i).length,colors:i}),!this.initialized){console.error("\u{1F3A8} [SpicetifyColorBridge] \u274C CRITICAL: Not initialized, cannot update with album colors!"),console.warn("[SpicetifyColorBridge] Not initialized, cannot update with album colors");return}try{let a=performance.now();console.log("\u{1F3A8} [SpicetifyColorBridge] Extracting key colors from OKLAB result...");let n=i.OKLAB_PRIMARY||i.VIBRANT||i.PRIMARY,s=i.OKLAB_ACCENT||i.LIGHT_VIBRANT||i.SECONDARY,l=i.OKLAB_SHADOW||i.DARK_VIBRANT||i.DARK,c=i.OKLAB_HIGHLIGHT||i.VIBRANT_NON_ALARMING||i.LIGHT;if(console.log("\u{1F3A8} [SpicetifyColorBridge] Extracted colors:",{primary:n,accent:s,shadow:l,highlight:c}),!n){console.error("\u{1F3A8} [SpicetifyColorBridge] \u274C CRITICAL: No primary color found in OKLAB result!"),console.warn("[SpicetifyColorBridge] No primary color found in OKLAB result, skipping update");return}let m=Gn(n,s,l,c),d=_n(m),h=r?.oklabMetadata;console.log("\u{1F3A8} [SpicetifyColorBridge] OKLAB metadata:",{hasOKLABMetadata:!!h,enhancedHex:h?.enhancedHex,shadowHex:h?.shadowHex,oklchL:h?.oklchL,oklchC:h?.oklchC,oklchH:h?.oklchH});let g={"--spice-accent":m.primary,"--spice-rgb-accent":d.primary,"--spice-surface1":m.surface1,"--spice-rgb-surface1":d.surface1,"--spice-button-active":m.primary,"--spice-rgb-button-active":d.primary,"--spice-highlight":m.highlight,"--spice-rgb-highlight":d.highlight,"--spice-press":m.shadow,"--spice-rgb-press":d.shadow},f={"--spice-surface0":m.surface0,"--spice-rgb-surface0":d.surface0,"--spice-surface2":m.surface2,"--spice-rgb-surface2":d.surface2,"--spice-base":m.base,"--spice-rgb-base":d.base},S={"--spice-main":m.base,"--spice-rgb-main":d.base,"--spice-main-elevated":m.surface0,"--spice-rgb-main-elevated":d.surface0,"--spice-sidebar":m.surface1,"--spice-rgb-sidebar":d.surface1,"--spice-text":zr(m.base),"--spice-rgb-text":O(zr(m.base)),"--spice-subtext":Or(m.base),"--spice-rgb-subtext":O(Or(m.base)),"--spice-highlight-elevated":m.surface2,"--spice-rgb-highlight-elevated":d.surface2,"--spice-overlay0":Ze(m.base,.04),"--spice-rgb-overlay0":O(Ze(m.base,.04)),"--spice-overlay1":Ze(m.base,.08),"--spice-rgb-overlay1":O(Ze(m.base,.08)),"--spice-overlay2":Ze(m.base,.12),"--spice-rgb-overlay2":O(Ze(m.base,.12)),"--spice-crust":Ur(m.base),"--spice-rgb-crust":O(Ur(m.base)),"--spice-mantle":Nr(m.base),"--spice-rgb-mantle":O(Nr(m.base))},C={"--spice-blue":m.harmonyPrimary,"--spice-rgb-blue":d.harmonyPrimary,"--spice-mauve":m.harmonySecondary,"--spice-rgb-mauve":d.harmonySecondary,"--spice-teal":m.harmonyTertiary,"--spice-rgb-teal":d.harmonyTertiary,"--spice-flamingo":he(m.primary,"flamingo"),"--spice-rgb-flamingo":O(he(m.primary,"flamingo")),"--spice-lavender":he(m.highlight,"lavender"),"--spice-rgb-lavender":O(he(m.highlight,"lavender")),"--spice-peach":he(m.surface2,"peach"),"--spice-rgb-peach":O(he(m.surface2,"peach")),"--spice-rosewater":he(m.surface1,"rosewater"),"--spice-rgb-rosewater":O(he(m.surface1,"rosewater")),"--spice-sapphire":he(m.harmonyPrimary,"sapphire"),"--spice-rgb-sapphire":O(he(m.harmonyPrimary,"sapphire"))},x={"--spice-pink":le(m.primary,"pink"),"--spice-rgb-pink":O(le(m.primary,"pink")),"--spice-sky":le(m.harmonyPrimary,"sky"),"--spice-rgb-sky":O(le(m.harmonyPrimary,"sky")),"--spice-red":le(m.highlight,"red"),"--spice-rgb-red":O(le(m.highlight,"red")),"--spice-maroon":le(m.shadow,"maroon"),"--spice-rgb-maroon":O(le(m.shadow,"maroon")),"--spice-yellow":le(m.surface2,"yellow"),"--spice-rgb-yellow":O(le(m.surface2,"yellow")),"--spice-green":le(m.harmonyTertiary,"green"),"--spice-rgb-green":O(le(m.harmonyTertiary,"green")),"--spice-misc":m.surface1,"--spice-rgb-misc":d.surface1},M={"--spice-shimmer-primary":m.harmonyPrimary,"--spice-rgb-shimmer-primary":d.harmonyPrimary,"--spice-shimmer-secondary":m.harmonySecondary,"--spice-rgb-shimmer-secondary":d.harmonySecondary,"--spice-shimmer-tertiary":m.harmonyTertiary,"--spice-rgb-shimmer-tertiary":d.harmonyTertiary,"--spice-shimmer-quaternary":m.primary,"--spice-rgb-shimmer-quaternary":d.primary,"--spice-particle-glow":m.highlight,"--spice-rgb-particle-glow":d.highlight,"--spice-particle-core":m.primary,"--spice-rgb-particle-core":d.primary,"--spice-particle-trail":m.shadow,"--spice-rgb-particle-trail":d.shadow,"--spice-cinematic-red":Vr(m.primary),"--spice-rgb-cinematic-red":O(Vr(m.primary)),"--spice-cinematic-cyan":Fr(m.primary),"--spice-rgb-cinematic-cyan":O(Fr(m.primary)),"--spice-cinematic-yellow":Gr(m.highlight),"--spice-rgb-cinematic-yellow":O(Gr(m.highlight)),"--spice-holographic-primary":_r(m.primary),"--spice-rgb-holographic-primary":O(_r(m.primary)),"--spice-holographic-accent":Br(m.harmonyPrimary),"--spice-rgb-holographic-accent":O(Br(m.harmonyPrimary)),"--spice-holographic-glow":Hr(m.highlight),"--spice-rgb-holographic-glow":O(Hr(m.highlight))},V={...g,...f,...S,...C,...x,...M},z={"--sn-bg-gradient-accent":m.primary,"--sn-bg-gradient-accent-rgb":d.primary,"--sn-bg-gradient-primary":m.primary,"--sn-bg-gradient-primary-rgb":d.primary,"--sn-bg-gradient-secondary":m.surface1,"--sn-bg-gradient-secondary-rgb":d.surface1},G={"--sn-color-accent-hex":m.primary,"--sn-color-accent-rgb":d.primary,"--sn-accent-hex":m.primary,"--sn-accent-rgb":d.primary,"--sn-color-extracted-primary-rgb":d.primary,"--sn-color-extracted-secondary-rgb":d.surface1,"--sn-color-harmony-complementary-rgb":d.shadow,"--sn-color-harmony-analogous-rgb":d.highlight,"--sn-color-harmony-triadic-rgb":d.harmonyPrimary},I={};r?.dynamicAccentEnabled&&h&&(I["--sn-dynamic-accent-hex"]=h.enhancedHex,I["--sn-dynamic-accent-rgb"]=h.enhancedRgb,I["--sn-dynamic-accent-shadow-hex"]=h.shadowHex,I["--sn-dynamic-accent-shadow-rgb"]=h.shadowRgb,I["--sn-oklch-l"]=String(h.oklchL),I["--sn-oklch-c"]=String(h.oklchC),I["--sn-oklch-h"]=String(h.oklchH),I["--sn-dynamic-accent-original-hex"]=h.originalHex,I["--sn-dynamic-accent-original-rgb"]=h.originalRgb,console.log("\u{1F3A8} [SpicetifyColorBridge] Applied OKLAB dynamic accent variables:",{enhancedHex:h.enhancedHex,shadowHex:h.shadowHex,oklchCoordinates:`L:${h.oklchL} C:${h.oklchC} H:${h.oklchH}`}));let N={};r?.musicEnergy!==void 0&&(N["--sn-music-energy"]=String(r.musicEnergy),N["--sn-energy-response-multiplier"]=String(r.energyResponseMultiplier||1),console.log("\u{1F3A8} [SpicetifyColorBridge] Applied music energy variables:",{energy:r.musicEnergy,multiplier:r.energyResponseMultiplier}));let F={};r?.baseTransformationEnabled&&h&&(F["--sn-living-base-hex"]=h.enhancedHex,F["--sn-living-base-rgb"]=h.enhancedRgb,console.log("\u{1F3A8} [SpicetifyColorBridge] Applied living gradient variables"));let P={};r?.visualEffectsIntegrationEnabled&&h&&(P["--sn-visual-effects-accent-hex"]=h.enhancedHex,P["--sn-visual-effects-accent-rgb"]=h.enhancedRgb,P["--sn-visual-effects-shadow-hex"]=h.shadowHex,P["--sn-visual-effects-shadow-rgb"]=h.shadowRgb,console.log("\u{1F3A8} [SpicetifyColorBridge] Applied visual effects variables"));let J={...V,...z,...G,...I,...N,...F,...P},we=this.detectChangedVariables(J);if(Object.keys(we).length===0){this.skippedUpdateCount++,this.config.enableDebug&&console.log(`\u{1F3A8} [SpicetifyColorBridge] No color changes, skipping update (${this.skippedUpdateCount} skipped)`);return}this.cssController.batchSetVariables("SpicetifyColorBridge",we,"critical","album-color-update-optimized"),this.lastAppliedVariables={...this.lastAppliedVariables,...J},this.clearCache();let ae=performance.now()-a;this.lastUpdateDuration=ae,this.updateDurations.push(ae),this.updateDurations.length>10&&this.updateDurations.shift(),this.lastColorUpdate=Date.now(),this.colorUpdateCount++;let oe=Object.keys(J).length,L=Object.keys(we).length;p.emitSync("colors:applied",{cssVariables:J,accentHex:m.primary,accentRgb:d.primary,appliedAt:this.lastColorUpdate}),this.config.enableDebug&&console.log("\u{1F3A8} [SpicetifyColorBridge] Optimized color update with change detection:",{primaryColor:m.primary,accentColor:m.surface1,shadowColor:m.shadow,highlightColor:m.highlight,surfaceProgression:[m.base,m.surface0,m.surface1,m.surface2],harmonyColors:[m.harmonyPrimary,m.harmonySecondary,m.harmonyTertiary],performanceMetrics:{updateDuration:ae.toFixed(2)+"ms",totalVariablesCalculated:oe,totalVariablesApplied:L,skippedVariables:oe-L,changeDetectionEfficiency:((oe-L)/oe*100).toFixed(1)+"%",totalSkippedUpdates:this.skippedUpdateCount},effectColors:{shimmerColors:4,particleColors:3,cinematicColors:3,holographicColors:3},eventEmitted:!0}),console.log("\u{1F3A8} [SpicetifyColorBridge] \u2550\u2550\u2550 updateWithAlbumColors() COMPLETE \u2550\u2550\u2550"),console.log("\u{1F3A8} [SpicetifyColorBridge] \u2705 Successfully updated CSS variables:",{updateDuration:`${ae.toFixed(2)}ms`,totalVariablesCalculated:oe,totalVariablesApplied:L,primaryColor:m.primary})}catch(a){console.error("\u{1F3A8} [SpicetifyColorBridge] \u274C FAILED to update with album colors:",a),console.error("[SpicetifyColorBridge] Failed to update with album colors:",a)}}getColorMappings(){return Ge.SEMANTIC_MAPPINGS}detectChangedVariables(t){let e={},i=0;return Object.entries(t).forEach(([r,a])=>{this.lastAppliedVariables[r]!==a&&(e[r]=a,i++)}),this.config.enableDebug&&i===0&&console.log(`\u{1F3A8} [SpicetifyColorBridge] No changes detected in ${Object.keys(t).length} variables`),e}destroy(){try{this.cleanupEventSubscriptions(),this.clearCache(),this.cssController=null,this.initialized=!1,this.lastColorUpdate=0,this.colorUpdateCount=0,this.lastAppliedVariables={},this.lastUpdateDuration=0,this.updateDurations=[],this.skippedUpdateCount=0,p.emitSync("system:destroyed",{systemName:"SpicetifyColorBridge",timestamp:Date.now(),reason:"Manual destruction"}),this.config.enableDebug&&console.log("\u{1F3A8} [SpicetifyColorBridge] System destroyed and cleaned up")}catch(t){console.error("[SpicetifyColorBridge] Error during destruction:",t)}}updateAnimation(t){}async healthCheck(){let t=this.updateDurations.length>0?this.updateDurations.reduce((a,n)=>a+n,0)/this.updateDurations.length:0,e=this.colorUpdateCount+this.skippedUpdateCount,i=e>0?this.skippedUpdateCount/e*100:0,r={system:"SpicetifyColorBridge",healthy:!0,details:"SpicetifyColorBridge operational",issues:[],metrics:{initialized:this.initialized,spicetifyAvailable:this.isSpicetifyAvailable(),cssControllerAvailable:!!this.cssController,lastColorUpdate:this.lastColorUpdate,colorUpdateCount:this.colorUpdateCount,eventSubscriptions:this.eventSubscriptionIds.length,cacheSize:this.colorCache.size,lastCacheUpdate:this.lastCacheUpdate,lastUpdateDuration:parseFloat(this.lastUpdateDuration.toFixed(2)),averageUpdateDuration:parseFloat(t.toFixed(2)),skippedUpdateCount:this.skippedUpdateCount,changeDetectionEfficiency:parseFloat(i.toFixed(1)),cssVariablesManaged:96,updatePerformanceStatus:t<50?"optimal":t<100?"acceptable":"needs-optimization"}};return this.initialized||(r.healthy=!1,r.issues.push("System not initialized")),this.isSpicetifyAvailable()||(r.healthy=!1,r.issues.push("Spicetify API not available")),this.colorUpdateCount===0&&this.initialized&&r.issues.push("No color updates performed since initialization"),this.eventSubscriptionIds.length===0&&this.initialized&&r.issues.push("No event subscriptions active"),t>100&&this.colorUpdateCount>5&&r.issues.push(`Average update duration ${t.toFixed(2)}ms exceeds 100ms threshold`),t>50&&t<=100&&this.colorUpdateCount>5&&r.issues.push(`Average update duration ${t.toFixed(2)}ms exceeds optimal 50ms target (acceptable)`),r.issues.length>0&&(r.details=`Issues detected: ${r.issues.join(", ")}`,r.issues.length>=2&&(r.healthy=!1)),r}setupEventSubscriptions(){let t=p.subscribe("music:track-changed",async r=>{this.config.enableDebug&&console.log("\u{1F3A8} [SpicetifyColorBridge] Track changed, preparing for color refresh:",r.trackUri),this.clearCache()},"SpicetifyColorBridge"),e=p.subscribe("settings:changed",async r=>{(r.settingKey.includes("color")||r.settingKey.includes("theme"))&&(this.config.enableDebug&&console.log("\u{1F3A8} [SpicetifyColorBridge] Color-related setting changed:",r.settingKey),this.clearCache())},"SpicetifyColorBridge");console.log("\u{1F3A8} [SpicetifyColorBridge] Subscribing to 'colors:harmonized' event...");let i=p.subscribe("colors:harmonized",r=>{console.log("\u{1F3A8} [SpicetifyColorBridge] \u2550\u2550\u2550 RECEIVED 'colors:harmonized' EVENT \u2550\u2550\u2550"),console.log("\u{1F3A8} [SpicetifyColorBridge] Event data:",{hasProcessedColors:!!r?.processedColors,colorCount:r?.processedColors?Object.keys(r.processedColors).length:0,accentHex:r?.accentHex,accentRgb:r?.accentRgb,strategies:r?.strategies,processingTime:r?.processingTime}),r.processedColors?(console.log("\u{1F3A8} [SpicetifyColorBridge] Processed colors received:",r.processedColors),this.config.enableDebug&&console.log("\u{1F3A8} [SpicetifyColorBridge] Received harmonized colors from ColorProcessor:",{colorCount:Object.keys(r.processedColors).length,strategies:r.strategies,processingTime:r.processingTime}),console.log("\u{1F3A8} [SpicetifyColorBridge] Updating CSS variables with album colors..."),this.updateWithAlbumColors(r),console.log("\u{1F3A8} [SpicetifyColorBridge] \u2705 CSS variables updated")):console.warn("\u{1F3A8} [SpicetifyColorBridge] \u26A0\uFE0F No processed colors in event data!")},"SpicetifyColorBridge");console.log("\u{1F3A8} [SpicetifyColorBridge] \u2705 Subscribed to 'colors:harmonized'"),this.eventSubscriptionIds=[t,e,i],this.config.enableDebug&&console.log("\u{1F3A8} [SpicetifyColorBridge] Event subscriptions established:",this.eventSubscriptionIds.length)}cleanupEventSubscriptions(){for(let t of this.eventSubscriptionIds)p.unsubscribe(t);this.eventSubscriptionIds=[],this.config.enableDebug&&console.log("\u{1F3A8} [SpicetifyColorBridge] Event subscriptions cleaned up")}getSystemMetrics(){return{initialized:this.initialized,lastColorUpdate:this.lastColorUpdate,colorUpdateCount:this.colorUpdateCount,eventSubscriptions:this.eventSubscriptionIds.length,cacheSize:this.colorCache.size,spicetifyAvailable:this.isSpicetifyAvailable()}}};Ge.SEMANTIC_MAPPINGS=[{semanticColor:"textBase",cssVariable:"--spice-text",fallbackColor:"#cad3f5",description:"Primary text color"},{semanticColor:"textSubdued",cssVariable:"--spice-subtext",fallbackColor:"#a5adcb",description:"Secondary text color"},{semanticColor:"textBrightAccent",cssVariable:"--spice-accent",fallbackColor:"#c6a0f6",description:"Accent text color"},{semanticColor:"textNegative",cssVariable:"--spice-red",fallbackColor:"#ed8796",description:"Error text color"},{semanticColor:"textWarning",cssVariable:"--spice-yellow",fallbackColor:"#eed49f",description:"Warning text color"},{semanticColor:"textPositive",cssVariable:"--spice-green",fallbackColor:"#a6da95",description:"Success text color"},{semanticColor:"textAnnouncement",cssVariable:"--spice-blue",fallbackColor:"#8aadf4",description:"Info text color"},{semanticColor:"essentialBase",cssVariable:"--spice-button",fallbackColor:"#cad3f5",description:"Primary button color"},{semanticColor:"essentialSubdued",cssVariable:"--spice-button-disabled",fallbackColor:"#6e738d",description:"Disabled button color"},{semanticColor:"essentialBrightAccent",cssVariable:"--spice-button-active",fallbackColor:"#c6a0f6",description:"Active button color"},{semanticColor:"essentialNegative",cssVariable:"--spice-notification-error",fallbackColor:"#ed8796",description:"Error button color"},{semanticColor:"essentialWarning",cssVariable:"--spice-notification-warning",fallbackColor:"#eed49f",description:"Warning button color"},{semanticColor:"essentialPositive",cssVariable:"--spice-notification-success",fallbackColor:"#a6da95",description:"Success button color"},{semanticColor:"backgroundBase",cssVariable:"--spice-main",fallbackColor:"#24273a",description:"Main background color"},{semanticColor:"backgroundHighlight",cssVariable:"--spice-highlight",fallbackColor:"#363a4f",description:"Highlight background color"},{semanticColor:"backgroundPress",cssVariable:"--spice-press",fallbackColor:"#494d64",description:"Press state background color"},{semanticColor:"backgroundElevatedBase",cssVariable:"--spice-card",fallbackColor:"#1e2030",description:"Card background color"},{semanticColor:"backgroundElevatedHighlight",cssVariable:"--spice-card-highlight",fallbackColor:"#363a4f",description:"Card highlight background"},{semanticColor:"backgroundTintedBase",cssVariable:"--spice-sidebar",fallbackColor:"#363a4f",description:"Sidebar background color"},{semanticColor:"backgroundTintedHighlight",cssVariable:"--spice-sidebar-highlight",fallbackColor:"#494d64",description:"Sidebar highlight background"},{semanticColor:"decorativeBase",cssVariable:"--spice-decorative",fallbackColor:"#cad3f5",description:"Decorative element color"},{semanticColor:"decorativeSubdued",cssVariable:"--spice-decorative-subdued",fallbackColor:"#939ab7",description:"Subdued decorative color"}];mt=Ge});function Nn(){try{let t=document.createElement("canvas").getContext("webgl2");if(!t)return!1;let e=t.getExtension("EXT_color_buffer_float")!==null;return!0}catch{return!1}}function El(o,t){try{let e={alpha:t.alpha??!0,antialias:t.antialias??!0,preserveDrawingBuffer:t.preserveDrawingBuffer??!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1},i=o.getContext("webgl2",e);if(!i)return null;let r=i.getParameter(i.MAX_TEXTURE_SIZE);return{canvas:o,ctx:i,type:"webgl2",capabilities:{supportsGPUAcceleration:!0,supports3D:!0,maxTextureSize:r}}}catch(e){return console.warn("[VisualCanvasFactory] WebGL2 context creation failed:",e),null}}function Un(o,t){let e={alpha:t.alpha??!0,desynchronized:!0},i=o.getContext("2d",e);return{canvas:o,ctx:i,type:"2d",capabilities:{supportsGPUAcceleration:!1,supports3D:!1}}}async function di(o){let t=document.createElement("canvas");t.id=o.id,t.width=o.width??window.innerWidth,t.height=o.height??window.innerHeight;let e=o.fallbackChain??["webgl2","2d"];if(o.preferredType){let i=[o.preferredType,...e.filter(r=>r!==o.preferredType)];e.splice(0,e.length,...i)}for(let i of e){let r=null;switch(i){case"webgl2":Nn()&&(r=El(t,o));break;case"2d":r=Un(t,o);break}if(r)return r}return Un(t,o)}function hi(){let o=Nn(),t="2d";return o&&(t="webgl2"),{webgl2:o,recommendedType:t}}var Wr=v(()=>{"use strict"});function $n(o,t,e={}){let{trace:i}=e;if(!t||typeof t!="object")return i?.("[visualPerformance] No performanceProfiles provided \u2013 skipping selection"),null;let r=t[o];if(r||(i?.(`[visualPerformance] Profile '${o}' not found, falling back to 'balanced'`),r=t.balanced),!r){let a=Object.keys(t)[0];r=t[a],i?.(`[visualPerformance] Using first available profile '${a}' as fallback`)}return r}var Wn=v(()=>{"use strict"});var q,ge=v(()=>{"use strict";B();Wr();te();Wn();q=class{constructor(t=w,e=k,i,r){this.canvasCapabilities=null;this.activeCanvasResults=new Map;this.config=t,this.utils=e,this.performanceMonitor=i,this.musicSyncService=r,this.systemName=this.constructor.name,this.initialized=!1,this.isActive=!1,this.currentPerformanceProfile={},this.metrics={initializationTime:0,updates:0,errors:0},this._resizeHandler=null,this.boundHandleSettingsChange=this.handleSettingsChange.bind(this),this.config.enableDebug&&console.log(`[${this.systemName}] Constructor`)}async initialize(){let t=this.config.enableDebug?performance.now():0;this.config.enableDebug&&console.log(`[${this.systemName}] Initializing...`),document.addEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange);try{let e=globalThis.year3000System?.deviceCapabilityDetector,i="balanced";e?.isInitialized&&(i=e.recommendPerformanceQuality()),this.config.enableDebug&&console.log(`[${this.systemName}] Auto-selected performance quality '${i}' based on device capability.`),this._applyPerformanceProfile(i)}catch(e){this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Device capability detection failed; defaulting to 'balanced'.`,e),this._applyPerformanceProfile("balanced")}if(await this._performSystemSpecificInitialization(),this.initialized=!0,this.isActive=!0,this.musicSyncService&&(this._validateDependenciesForSubscription()?(this.musicSyncService.subscribe(this,this.systemName),this.config.enableDebug&&console.log(`[${this.systemName}] Subscribed to MusicSyncService.`)):console.warn(`[${this.systemName}] Dependency validation failed; subscription skipped.`)),this.config.enableDebug){let e=performance.now()-t;console.log(`[${this.systemName}] Initialization complete in ${e.toFixed(2)}ms`)}}async _performSystemSpecificInitialization(){this.canvasCapabilities=hi(),this.canvasCapabilities&&this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Canvas capabilities detected: WebGL2=${this.canvasCapabilities.webgl2}, Recommended=${this.canvasCapabilities.recommendedType}`)}_validateDependenciesForSubscription(){return typeof this.updateFromMusicAnalysis!="function"?(console.error(`[${this.systemName}] Missing updateFromMusicAnalysis method.`),!1):this.initialized?this._performAdditionalDependencyValidation():(console.warn(`[${this.systemName}] System not initialized.`),!1)}_performAdditionalDependencyValidation(){return!0}destroy(){this.config.enableDebug&&console.log(`[${this.systemName}] Destroying...`);try{this.initialized=!1,this.isActive=!1,this.musicSyncService&&this.musicSyncService.unsubscribe(this.systemName),this.boundHandleSettingsChange&&document.removeEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange),this._resizeHandler&&(window.removeEventListener("resize",this._resizeHandler),this._resizeHandler=null),this._performSystemSpecificCleanup()}catch(t){console.error(`[${this.systemName}] Error during destruction:`,t),this.metrics.errors++}}_performSystemSpecificCleanup(){for(let[t,e]of this.activeCanvasResults){let i=e.canvas;i.parentNode&&i.parentNode.removeChild(i),this.config.enableDebug&&console.log(`[${this.systemName}] Cleaned up canvas: ${t} (type: ${e.type})`)}this.activeCanvasResults.clear()}updateFromMusicAnalysis(t,...e){}onAnimate(t){}updateAnimation(t){this.onAnimate(t)}async healthCheck(){let t=this.initialized&&this.isActive&&this.metrics.errors===0;return{system:this.systemName,healthy:t,metrics:{initialized:this.initialized,active:this.isActive,errors:this.metrics.errors,updates:this.metrics.updates,initializationTime:this.metrics.initializationTime},issues:t?[]:[...this.initialized?[]:["System not initialized"],...this.isActive?[]:["System not active"],...this.metrics.errors===0?[]:[`${this.metrics.errors} errors detected`]]}}updateModeConfiguration(t){}handleSettingsChange(t){}_applyPerformanceProfile(t){if(!this.config?.performanceProfiles){this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Performance profiles not found in config.`);return}let e=$n(t,this.config.performanceProfiles,{trace:i=>this.performanceMonitor?.emitTrace(i)});e?(this.currentPerformanceProfile=e,this.performanceMonitor?.emitTrace?.(`[BaseVisualSystem (${this.systemName})] Applied performance profile '${t}'`,e)):this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Performance profile '${t}' not found.`)}getCosmicState(){if(typeof document>"u")return{};let t=document.documentElement,e=getComputedStyle(t);return{energy:parseFloat(e.getPropertyValue("--sn-kinetic-energy"))||.5,valence:parseFloat(e.getPropertyValue("--sn-kinetic-valence"))||.5,bpm:parseFloat(e.getPropertyValue("--sn-kinetic-bpm"))||120,tempoMultiplier:parseFloat(e.getPropertyValue("--sn-kinetic-tempo-multiplier"))||1,beatPhase:parseFloat(e.getPropertyValue("--sn-kinetic-beat-phase"))||0,beatPulse:parseFloat(e.getPropertyValue("--sn-kinetic-beat-pulse"))||0}}async _createOptimizedKineticCanvas(t,e=5,i="screen",r="pulse"){let a=document.getElementById(t);a&&a.remove();let n="2d";this.canvasCapabilities&&this.currentPerformanceProfile&&(this.currentPerformanceProfile.quality||"balanced")!=="low"&&this.canvasCapabilities.webgl2&&(n="webgl2");let s=await di({id:t,width:window.innerWidth,height:window.innerHeight,alpha:!0,antialias:!0,preferredType:n}),l=s.canvas;l.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: ${e};
      pointer-events: none;
      mix-blend-mode: ${i};
    `,l.classList.add("year3000-kinetic-canvas"),l.dataset.kineticMode=r,l.dataset.systemName=this.systemName,l.dataset.canvasType=s.type;let c=this._getKineticStyles(r);return Object.assign(l.style,c),document.body.appendChild(l),this.activeCanvasResults.set(t,s),this._resizeHandler=()=>{l.width=window.innerWidth,l.height=window.innerHeight,typeof this.handleResize=="function"&&this.handleResize()},window.addEventListener("resize",this._resizeHandler),this._resizeHandler(),this.config.enableDebug&&console.log(`[BaseVisualSystem (${this.systemName})] Created optimized kinetic canvas: ${s.type} (mode: ${r})`),s}getCanvasCapabilities(){return this.canvasCapabilities}hasGPUAcceleration(){return this.canvasCapabilities?.webgl2||!1}_createKineticCanvas(t,e=5,i="screen",r="pulse"){let a=this._createCanvasElement(t,e,i);a.classList.add("year3000-kinetic-canvas"),a.dataset.kineticMode=r,a.dataset.systemName=this.systemName;let n=this._getKineticStyles(r);return Object.assign(a.style,n),this.config.enableDebug&&console.log(`[BaseVisualSystem (${this.systemName})] Created kinetic canvas with mode: ${r}`),a}_getKineticStyles(t){let e={transition:"all 150ms cubic-bezier(0.25, 0.46, 0.45, 0.94)"};switch(t){case"pulse":return{...e,animation:"year3000-pulse calc(var(--sn-kinetic-tempo-multiplier, 1) * 1s) ease-in-out infinite"};case"breathe":return{...e,animation:"year3000-breathe calc(var(--sn-kinetic-tempo-multiplier, 1) * 4s) ease-in-out infinite"};case"flow":return{...e,animation:"year3000-flow calc(var(--sn-kinetic-tempo-multiplier, 1) * 8s) linear infinite"};default:return e}}_createCanvasElement(t,e,i){let r=document.getElementById(t);r&&r.remove();let a=document.createElement("canvas");return a.id=t,a.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: ${e};
      pointer-events: none;
      mix-blend-mode: ${i};
    `,document.body.appendChild(a),this._resizeHandler=()=>{a.width=window.innerWidth,a.height=window.innerHeight,typeof this.handleResize=="function"&&this.handleResize()},window.addEventListener("resize",this._resizeHandler),this._resizeHandler(),a}applyPerformanceSettings(t){this.currentPerformanceProfile=t,t.quality&&typeof this._applyPerformanceProfile=="function"&&this._applyPerformanceProfile?.(t.quality),this.config.enableDebug&&this.performanceMonitor?.emitTrace?.(`[BaseVisualSystem (${this.systemName})] Performance settings applied`,t)}applyUpdatedSettings(t,e){let i=new CustomEvent("year3000SystemSettingsChanged",{detail:{key:t,value:e}});try{this.handleSettingsChange(i)}catch(r){this.config.enableDebug&&console.warn(`[BaseVisualSystem] ${this.systemName} applyUpdatedSettings error`,r)}}forceRepaint(t){this.config.enableDebug&&console.log(`[${this.systemName}] Force repaint requested: ${t||"Unknown reason"}`)}}});var dt,qr,Yr,jr,Kr,Qr=v(()=>{"use strict";dt=class{constructor(t={}){this.initialized=!1;this.emotionHistory=[];this.currentEmotion=null;this.emotionCache=new Map;this.emotionSubscribers=new Set;this.config={emotionSensitivity:.7,confidenceThreshold:.6,smoothingFactor:.3,memoryDecay:.1,visualEffectsAwareness:!0,smoothFlowDetection:!0,cinematicAnalysis:!0,analysisInterval:500,cacheSize:100,...t},this.valenceEnergyMapper=new qr,this.audioFeatureAnalyzer=new Yr,this.temperatureCalculator=new jr,this.visualEffectsDetector=new Kr}async initialize(){if(!this.initialized)try{await this.valenceEnergyMapper.initialize(),await this.audioFeatureAnalyzer.initialize(),await this.temperatureCalculator.initialize(),this.config.visualEffectsAwareness&&await this.visualEffectsDetector.initialize(),this.initialized=!0,console.log("\u{1F3B5} MusicEmotionAnalyzer initialized with visual effects awareness")}catch(t){throw console.error("\u274C Failed to initialize MusicEmotionAnalyzer:",t),t}}updateAnimation(t){}async healthCheck(){let t=[];return this.initialized||t.push("MusicEmotionAnalyzer not initialized"),this.emotionHistory.length===0&&t.push("No emotion analysis history available"),this.currentEmotion&&this.currentEmotion.confidence<this.config.confidenceThreshold&&t.push(`Low emotion confidence: ${this.currentEmotion.confidence.toFixed(2)}`),{healthy:t.length===0,issues:t,metrics:{emotionHistorySize:this.emotionHistory.length,currentConfidence:this.currentEmotion?.confidence??0,subscriberCount:this.emotionSubscribers.size,cacheSize:this.emotionCache.size}}}destroy(){this.emotionSubscribers.clear(),this.emotionHistory=[],this.emotionCache.clear(),this.currentEmotion=null,this.initialized=!1}async analyzeEmotion(t,e){if(!this.initialized)throw new Error("MusicEmotionAnalyzer must be initialized before analysis");try{let i=this.createCacheKey(t);if(this.emotionCache.has(i)){let a=this.emotionCache.get(i);if(a)return this.updateCurrentEmotion(a),a}let r=await this.performEmotionAnalysis(t,e);return this.cacheEmotion(i,r),this.updateCurrentEmotion(r),this.notifyEmotionUpdate(r),r}catch(i){return console.error("\u274C Error analyzing emotion:",i),this.createNeutralEmotion(t)}}getCurrentEmotion(){return this.currentEmotion}getEmotionHistory(t){return t?this.emotionHistory.slice(-t):[...this.emotionHistory]}onEmotionUpdate(t){return this.emotionSubscribers.add(t),()=>{this.emotionSubscribers.delete(t)}}updateConfig(t){this.config={...this.config,...t}}async performEmotionAnalysis(t,e){let i=this.audioFeatureAnalyzer.extractCharacteristics(t),r=this.valenceEnergyMapper.mapToEmotion(t.valence,t.energy,i),a=this.temperatureCalculator.calculateTemperature(r,i),n={};this.config.visualEffectsAwareness&&(n=await this.visualEffectsDetector.analyze(t,i,e));let s=this.applyTemporalSmoothing(r,i);return{primary:s.primary,secondary:s.secondary,intensity:s.intensity,confidence:s.confidence,valence:t.valence,arousal:t.energy,dominance:this.calculateDominance(t,i),colorTemperature:a,timestamp:Date.now(),duration:this.calculateEmotionDuration(s,i),musicalCharacteristics:{...i,smoothFlow:n.smoothFlow??i.smoothFlow,cinematicDepth:n.cinematicDepth??i.cinematicDepth,visualEffectsResonance:n.visualEffectsResonance??.5}}}applyTemporalSmoothing(t,e){if(!this.currentEmotion||this.config.smoothingFactor===0)return t;let i=this.config.smoothingFactor,r=t.intensity*(1-i)+this.currentEmotion.intensity*i,a=t.confidence*(1-i)+this.currentEmotion.confidence*i;return{primary:t.confidence>this.config.confidenceThreshold?t.primary:this.currentEmotion.primary,secondary:t.secondary,intensity:r,confidence:a}}calculateDominance(t,e){let i=Math.min(e.tempo/140,1),r=t.energy,a=Math.min((t.loudness+60)/60,1);return i*.3+r*.4+a*.3}calculateEmotionDuration(t,e){let r=6e4/e.tempo,a=t.confidence*2;return Math.min(2e3*r*a,1e4)}createCacheKey(t){return[Math.round(t.valence*100),Math.round(t.energy*100),Math.round(t.danceability*100),Math.round(t.acousticness*100),t.key,t.mode].join("-")}cacheEmotion(t,e){if(this.emotionCache.size>=this.config.cacheSize){let i=this.emotionCache.keys().next().value;i!==void 0&&this.emotionCache.delete(i)}this.emotionCache.set(t,e)}updateCurrentEmotion(t){this.currentEmotion=t,this.emotionHistory.push(t),this.emotionHistory.length>1e3&&(this.emotionHistory=this.emotionHistory.slice(-500))}notifyEmotionUpdate(t){this.emotionSubscribers.forEach(e=>{try{e(t)}catch(i){console.error("\u274C Error in emotion subscriber callback:",i)}})}createNeutralEmotion(t){return{primary:"serenity",secondary:[],intensity:.5,confidence:.3,valence:t.valence??.5,arousal:t.energy??.5,dominance:.5,colorTemperature:6500,timestamp:Date.now(),duration:3e3,musicalCharacteristics:this.audioFeatureAnalyzer.extractCharacteristics(t)}}},qr=class{async initialize(){}mapToEmotion(t,e,i){let r,a=[],n,s=.8;return t>=.6&&e>=.6?(r=i.danceability>.7?"excitement":"joy",a=["joy","excitement"],n=Math.min(t+e-.2,1)):t>=.6&&e<.4?(r=i.acousticness>.6?"serenity":"love",a=["serenity","love"],n=t*.8):t<.4&&e>=.6?(r=i.mode===0?"anger":"fear",a=["anger","fear"],n=e):t<.4&&e<.4?(r=i.acousticness>.5?"melancholy":"sadness",a=["sadness","melancholy"],n=(1-t)*.8):(i.instrumentalness>.8?(r="transcendence",a=["transcendence","visual-effects"]):(r="nostalgia",a=["nostalgia"]),n=Math.abs(t-.5)+Math.abs(e-.5),s=.6),i.smoothFlow>.8&&a.push("smooth-flow"),i.visualEffectsResonance>.7&&a.push("visual-effects"),{primary:r,secondary:a,intensity:n,confidence:s}}},Yr=class{async initialize(){}extractCharacteristics(t){return{tempo:t.tempo,key:t.key,mode:t.mode,timeSignature:t.timeSignature,energy:t.energy,danceability:t.danceability,acousticness:t.acousticness,instrumentalness:t.instrumentalness,liveness:t.liveness,speechiness:t.speechiness,smoothFlow:this.calculateSmoothFlow(t),cinematicDepth:this.calculateCinematicDepth(t),visualEffectsResonance:this.calculateVisualEffectsResonance(t)}}calculateSmoothFlow(t){let e=t.acousticness*.4,i=(1-Math.min(t.tempo/140,1))*.3,r=(1-t.energy)*.2,a=t.danceability*.1;return Math.min(e+i+r+a,1)}calculateCinematicDepth(t){let e=t.instrumentalness*.4,i=(1-t.liveness)*.2,r=(1-t.speechiness)*.2,a=Math.abs(t.energy-.5)*.2;return Math.min(e+i+r+a,1)}calculateVisualEffectsResonance(t){let e=1-Math.abs(t.valence-.5)*2,i=1-Math.abs(t.energy-.4)*2,r=t.instrumentalness*.3,a=t.acousticness*.2;return Math.max(0,(e+i)*.5+r+a)}},jr=class{async initialize(){}calculateTemperature(t,e){let i;switch(t.primary){case"joy":case"excitement":i=8e3;break;case"love":case"serenity":i=3e3;break;case"anger":i=15e3;break;case"fear":i=12e3;break;case"sadness":case"melancholy":i=2e3;break;case"nostalgia":i=2500;break;case"transcendence":case"visual-effects":i=6500;break;case"smooth-flow":i=4e3;break;default:i=6500}let r=(t.intensity-.5)*2e3,a=(e.tempo-120)*10,n=(e.energy-.5)*1e3,s=i+r+a+n;return Math.max(1e3,Math.min(2e4,s))}},Kr=class{async initialize(){}async analyze(t,e,i){let r=e.smoothFlow,a=e.cinematicDepth,n=e.visualEffectsResonance;if(i?.waveform){let s=this.analyzeWaveformPatterns(i.waveform);r=Math.min(1,r+s.smoothness*.2),a=Math.min(1,a+s.dynamicRange*.3),n=Math.min(1,n+s.harmonicComplexity*.2)}return{smoothFlow:r,cinematicDepth:a,visualEffectsResonance:n}}analyzeWaveformPatterns(t){let e=0,i=0,r=0;if(t.length>1){let a=0;for(let l=1;l<t.length;l++){let c=t[l],m=t[l-1];c!==void 0&&m!==void 0&&(a+=Math.abs(c-m))}e=1-Math.min(a/t.length,1);let n=Math.max(...t),s=Math.min(...t);i=n-s,r=Math.min(this.estimateHarmonicContent(t),1)}return{smoothness:e,dynamicRange:i,harmonicComplexity:r}}estimateHarmonicContent(t){let e=0;for(let i=1;i<t.length;i++){let r=t[i],a=t[i-1];r!==void 0&&a!==void 0&&r>=0!=a>=0&&e++}return Math.min(e/(t.length*.1),1)}}});var _e,Xr,gi,Zr=v(()=>{"use strict";Xt();Dt();_();R();Xe();ue();Lt();Vn();te();$r();ge();Qr();_e=class _e extends q{constructor(e,i,r,a){super(e,i||k,r,null);this.animationEngine=null;this.userIntensity=.7;this.evolutionEnabled=!0;this._evolutionTimer=null;this._pendingPaletteRefresh=null;this._lastGenre=null;this.systemName="ColorHarmonyEngine",this.paletteExtensionManager=new ui(this.config,this.utils),a?this.semanticColorManager=a:this.semanticColorManager=new mt({enableDebug:this.config.enableDebug,fallbackToSpiceColors:!0,cacheDuration:5e3}),this.currentTheme=this.detectCurrentTheme();let n=e;if(n&&typeof n.colorHarmonyIntensity=="number"&&Number.isFinite(n.colorHarmonyIntensity)){let s=Math.max(0,Math.min(1,n.colorHarmonyIntensity));this.userIntensity=s}this.harmonyMetrics={totalHarmonyCalculations:0,musicInfluencedAdjustments:0,temporalMemoryEvents:0,performance:[]},this.musicalMemory={recentTracks:[],userColorPreferences:new Map,energyHistory:[],maxMemorySize:50},this.kineticState={currentPulse:0,animationPhase:0,lastBeatTime:0,visualMomentum:0},this.catppuccinPalettes={frappe:{accents:{rosewater:"#f2d5cf",flamingo:"#eebebe",pink:"#ff6b9d",mauve:"#c77dff",red:"#ff4757",maroon:"#ea999c",peach:"#ff7675",yellow:"#fdcb6e",green:"#6c5ce7",teal:"#00cec9",sky:"#74b9ff",sapphire:"#0984e3",blue:"#a29bfe",lavender:"#fd79a8"},neutrals:{base:"#303446",surface0:"#414559",surface1:"#51576d",surface2:"#626880"}},latte:{accents:{rosewater:"#dc8a78",flamingo:"#dd7878",pink:"#e84393",mauve:"#a55eea",red:"#fd79a8",maroon:"#e64553",peach:"#fd7f28",yellow:"#f39c12",green:"#00b894",teal:"#00cec9",sky:"#0984e3",sapphire:"#6c5ce7",blue:"#74b9ff",lavender:"#a29bfe"},neutrals:{base:"#eff1f5",surface0:"#e6e9ef",surface1:"#dce0e8",surface2:"#c5c9d1"}},macchiato:{accents:{rosewater:"#f4dbd6",flamingo:"#f0c6c6",pink:"#ff6b9d",mauve:"#c77dff",red:"#ff4757",maroon:"#ee99a0",peach:"#ff7675",yellow:"#fdcb6e",green:"#6c5ce7",teal:"#00cec9",sky:"#74b9ff",sapphire:"#0984e3",blue:"#a29bfe",lavender:"#fd79a8"},neutrals:{base:"#24273a",surface0:"#363a4f",surface1:"#494d64",surface2:"#5b6078"}},mocha:{accents:{rosewater:"#f5e0dc",flamingo:"#f2cdcd",pink:"#ff6b9d",mauve:"#c77dff",red:"#ff4757",maroon:"#eba0ac",peach:"#ff7675",yellow:"#fdcb6e",green:"#6c5ce7",teal:"#00cec9",sky:"#74b9ff",sapphire:"#0984e3",blue:"#a29bfe",lavender:"#fd79a8"},neutrals:{base:"#1e1e2e",surface0:"#313244",surface1:"#45475a",surface2:"#585b70"}}},this.vibrancyConfig={defaultBlendRatio:.75,minimumSaturation:.6,maximumDesaturation:.1,contrastBoostIntensity:1.4,harmonyTolerance:.3,artisticSaturationBoost:1.35,enhancedLuminanceBoost:1.25,energyResponsiveness:.8,getBlendRatio(s="artist-vision"){return{"corporate-safe":.6,"artist-vision":.75,"advanced-maximum":.85,"cosmic-maximum":.85}[s]||this.defaultBlendRatio}},this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Initialized with Year 3000 Quantum Empathy"),e&&typeof e.colorHarmonyEvolution=="boolean"?this.evolutionEnabled=e.colorHarmonyEvolution:e&&typeof e.harmonicEvolution=="boolean"&&(this.evolutionEnabled=e.harmonicEvolution),this.emotionalTemperatureMapper=new se(this.config.enableDebug),this.oklabProcessor=new T(this.config.enableDebug),this.musicEmotionAnalyzer=new dt({emotionSensitivity:.7,confidenceThreshold:.6,visualEffectsAwareness:!0,smoothFlowDetection:!0,cinematicAnalysis:!0,analysisInterval:500}),this.genreProfileManager=new ye,this.oklabState={currentPreset:T.PRESETS.STANDARD,processedPalette:{},perceptualGradientCache:new Map,colorHarmonyCache:new Map,lastProcessingTime:0,colorVariationCache:new Map},this.emotionalState={currentEmotion:null,emotionHistory:[],lastEmotionUpdate:0,emotionInfluenceIntensity:.8},this.genreState={currentGenre:"unknown",genreConfidence:0,genreHistory:[],lastGenreUpdate:0,genreInfluenceIntensity:.7},this._boundSettingsChangeHandler=this._handleSettingsChange.bind(this),this._boundArtisticModeHandler=this._handleArtisticModeChanged.bind(this),document.addEventListener("year3000SystemSettingsChanged",this._boundSettingsChangeHandler),document.addEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),this.evolutionEnabled&&this._startEvolutionLoop()}getCurrentActivePalette(){try{if(Z.getCurrentPaletteSystem()==="year3000"){let i=Z.getCurrentPalette(),r=Z.getCurrentDefaultFlavor(),a=i[r];if(!a)throw new Error(`No palette found for flavor: ${r}`);let n={},s={};return Object.entries(a).forEach(([l,c])=>{["base","surface0","surface1","surface2","mantle","crust"].includes(l)?s[l]=c.hex:n[l]=c.hex}),{accents:n,neutrals:s}}else return this.catppuccinPalettes[this.currentTheme]}catch(e){return console.warn("[ColorHarmonyEngine] Failed to get active palette, using fallback:",e),this.catppuccinPalettes[this.currentTheme]}}updateAnimation(e,i){let r=i??e;this.onAnimate(r)}onAnimate(e){this._updateCSSVariables(e),this._calculateBeatPulse(e),p.emitSync("performance:frame",{deltaTime:e,fps:60,memoryUsage:performance.memory?.usedJSHeapSize||0,timestamp:performance.now()})}_updateCSSVariables(e){let i={"--sn-harmony-energy":this.kineticState.visualMomentum.toFixed(3),"--sn-harmony-pulse":this.kineticState.currentPulse.toFixed(3),"--sn-harmony-animation-phase":(Math.sin(this.kineticState.animationPhase)*.5+.5).toFixed(3)};this.kineticState.musicIntensityMultiplier!==void 0&&(i["--sn-harmony-intensity"]=this.kineticState.musicIntensityMultiplier.toFixed(3)),this.kineticState.valenceGravity!==void 0&&(i["--sn-harmony-valence"]=this.kineticState.valenceGravity.toFixed(3)),this.kineticState.beatPhase!==void 0&&(i["--sn-harmony-beat-phase"]=this.kineticState.beatPhase.toFixed(3)),this.kineticState.hueShift!==void 0&&(i["--sn-harmony-hue-shift"]=`${this.kineticState.hueShift.toFixed(1)}deg`);let r=Math.max(0,Math.min(1,this.kineticState.currentPulse*1.2));i["--sn-text-glow-intensity"]=r.toFixed(3),p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:i,timestamp:Date.now()})}_calculateBeatPulse(e){this.kineticState.currentPulse*=Math.pow(.95,e/16.67),this.kineticState.animationPhase+=e/1e3*.5,this.kineticState.animationPhase>2*Math.PI&&(this.kineticState.animationPhase-=2*Math.PI),this._emitGradientAnimationEvents(e)}_emitGradientAnimationEvents(e){let i=this._calculateCurrentEnergyLevel(),r=this._detectBeatFromAudioAnalysis();Math.random()<.1&&p.emit("music:energy",{energy:i.energy,valence:i.valence,tempo:120,timestamp:performance.now()}),r.detected&&p.emit("music:beat",{intensity:r.intensity,confidence:r.confidence,timestamp:performance.now(),bpm:120})}_calculateCurrentEnergyLevel(){let e=.5+Math.sin(this.kineticState.animationPhase)*.3;return{energy:Math.max(.2,e),valence:.5+this.kineticState.currentPulse*.3,arousal:.4+this.kineticState.currentPulse*.4}}_detectBeatFromAudioAnalysis(){let i=this.kineticState.currentPulse;return i>.3?{detected:!0,intensity:Math.min(1,i*1.5),confidence:Math.min(1,(i-.3)/(1-.3))}:Math.sin(this.kineticState.animationPhase)>.8?{detected:!0,intensity:.4,confidence:.6}:{detected:!1,intensity:0,confidence:0}}async initialize(){await super.initialize();let e=this.performanceMonitor?this.performanceMonitor.cssVisualEffectsController:void 0;this.semanticColorManager.initialize(e),this.config.enableDebug&&console.log("\u{1F3AD} [ColorHarmonyEngine] Initialized for music emotion analysis.");try{await this.musicEmotionAnalyzer.initialize(),this.musicEmotionAnalyzer.onEmotionUpdate(i=>{this.handleEmotionUpdate(i)}),this.config.enableDebug&&console.log("\u{1F3AD} [ColorHarmonyEngine] MusicEmotionAnalyzer initialized with audioAnalysis awareness")}catch(i){console.warn("\u{1F3AD} [ColorHarmonyEngine] Failed to initialize MusicEmotionAnalyzer:",i)}this.config.enableDebug&&console.log("\u{1F3B6} [ColorHarmonyEngine] GenreProfileManager ready for genre detection"),this.config.enableDebug&&(console.log("\u{1F3A8} [ColorHarmonyEngine] Initialized with Year 3000 Quantum Empathy via BaseVisualSystem and SpicetifyColorBridge."),console.log("\u{1F3A8} [ColorHarmonyEngine] Subscribed to 'colors/extracted' events for strategy pattern processing.")),this.initialized=!0}handleEmotionUpdate(e){if(this.initialized)try{this.emotionalState.currentEmotion=e,this.emotionalState.emotionHistory.push(e),this.emotionalState.lastEmotionUpdate=Date.now(),this.emotionalState.emotionHistory.length>50&&(this.emotionalState.emotionHistory=this.emotionalState.emotionHistory.slice(-25)),p.emit("music:emotion-analyzed",{emotion:e,colorTemperature:e.colorTemperature,visualEffectsLevel:e.musicalCharacteristics.visualEffectsResonance,smoothFlow:e.musicalCharacteristics.smoothFlow,cinematicDepth:e.musicalCharacteristics.cinematicDepth,timestamp:e.timestamp}),this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Emotion updated: ${e.primary} (intensity: ${e.intensity.toFixed(2)}, confidence: ${e.confidence.toFixed(2)})`),this.triggerEmotionalColorUpdate(e)}catch(i){console.error("\u{1F3AD} [ColorHarmonyEngine] Error handling emotion update:",i)}}triggerEmotionalColorUpdate(e){this.emotionalState.emotionInfluenceIntensity>0&&e.confidence>.6&&(this._pendingPaletteRefresh&&clearTimeout(this._pendingPaletteRefresh),this._pendingPaletteRefresh=setTimeout(()=>{this.refreshPaletteWithEmotion(e),this._pendingPaletteRefresh=null},100))}async refreshPaletteWithEmotion(e){try{let i={primaryEmotion:e.primary,emotionIntensity:e.intensity,colorTemperature:e.colorTemperature,valence:e.valence,arousal:e.arousal,dominance:e.dominance,smoothFlow:e.musicalCharacteristics.smoothFlow,cinematicDepth:e.musicalCharacteristics.cinematicDepth,visualEffectsResonance:e.musicalCharacteristics.visualEffectsResonance};p.emit("music:emotional-context-updated",i),this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Refreshing colors with ${e.primary} emotion influence`)}catch(i){console.error("\u{1F3AD} [ColorHarmonyEngine] Error refreshing palette with emotion:",i)}}async healthCheck(){return this.getCurrentActivePalette()?{healthy:!0,ok:!0,details:"Palettes are loaded correctly.",issues:[],system:"ColorHarmonyEngine"}:{healthy:!1,ok:!1,details:`Current theme '${this.currentTheme}' not found in palettes.`,issues:[`Current theme '${this.currentTheme}' not found in palettes.`],system:"ColorHarmonyEngine"}}generateCSSVariables(e){let i={};i["--sn-accent-hex"]=e.accentHex,i["--sn-accent-rgb"]=e.accentRgb,i[_e.CANONICAL_HEX_VAR]=e.accentHex,i[_e.CANONICAL_RGB_VAR]=e.accentRgb;let r=e.processedColors,a=r.VIBRANT||r.PROMINENT||e.accentHex,n=r.DARK_VIBRANT||r.DESATURATED||a,s=r.VIBRANT_NON_ALARMING||r.LIGHT_VIBRANT||a;i["--sn-bg-gradient-primary"]=a,i["--sn-bg-gradient-secondary"]=n,i["--sn-bg-gradient-accent"]=s;let l=this.utils.hexToRgb(a),c=this.utils.hexToRgb(n),m=this.utils.hexToRgb(s);return l&&(i["--sn-bg-gradient-primary-rgb"]=`${l.r},${l.g},${l.b}`),c&&(i["--sn-bg-gradient-secondary-rgb"]=`${c.r},${c.g},${c.b}`),m&&(i["--sn-bg-gradient-accent-rgb"]=`${m.r},${m.g},${m.b}`),this.generateOKLABVariables(i,e),this.config.enableDebug&&console.log("\u{1F527} [ColorHarmonyEngine] Generated background gradient CSS variables:",{primary:`${a} -> ${i["--sn-bg-gradient-primary-rgb"]}`,secondary:`${n} -> ${i["--sn-bg-gradient-secondary-rgb"]}`,accent:`${s} -> ${i["--sn-bg-gradient-accent-rgb"]}`,totalVariables:Object.keys(i).length,note:"CSS mapping automatically updates --sn-gradient-* variables"}),i}generateOKLABVariables(e,i){try{let r=i.accentHex,a=i.processedColors,n=a.DARK_VIBRANT||a.DESATURATED||r,s=this.utils.hexToRgb(r),l=this.utils.hexToRgb(n);if(s){let d=this.utils.rgbToOklab(s.r,s.g,s.b),h={L:Math.min(1,d.L*1.1),a:d.a*1.15,b:d.b*1.15},g=this.utils.oklabToRgb(h.L,h.a,h.b);e["--sn-color-oklab-primary-r"]=Math.round(g.r).toString(),e["--sn-color-oklab-primary-g"]=Math.round(g.g).toString(),e["--sn-color-oklab-primary-b"]=Math.round(g.b).toString(),e["--sn-color-oklab-accent-r"]=Math.round(g.r).toString(),e["--sn-color-oklab-accent-g"]=Math.round(g.g).toString(),e["--sn-color-oklab-accent-b"]=Math.round(g.b).toString(),e["--sn-color-oklab-accent-luminance"]=h.L.toFixed(3);let f=this.convertOklabToOklch(h);e["--sn-color-oklch-accent-l"]=f.L.toFixed(3),e["--sn-color-oklch-accent-c"]=f.C.toFixed(3),e["--sn-color-oklch-accent-h"]=f.H.toFixed(1),e["--sn-color-oklch-primary-l"]=f.L.toFixed(3),e["--sn-color-oklch-primary-c"]=f.C.toFixed(3),e["--sn-color-oklch-primary-h"]=f.H.toFixed(1)}if(l){let d=this.utils.rgbToOklab(l.r,l.g,l.b),h={L:Math.max(.05,d.L*.3),a:d.a*.8,b:d.b*.8},g=this.utils.oklabToRgb(h.L,h.a,h.b);e["--sn-color-oklab-base-luminance"]=h.L.toFixed(3)}let c=a.SHADOW,m=a.HIGHLIGHT;if(c){let d=this.utils.hexToRgb(c);d&&(e["--sn-oklab-shadow-rgb"]=`${d.r},${d.g},${d.b}`)}if(m){let d=this.utils.hexToRgb(m);d&&(e["--sn-oklab-highlight-rgb"]=`${d.r},${d.g},${d.b}`)}this.config.enableDebug&&console.log("\u{1F52C} [ColorHarmonyEngine] Generated OKLAB-processed variables:",{primaryColor:r,secondaryColor:n,oklabVariablesCount:Object.keys(e).filter(d=>d.includes("oklab")).length,oklchVariablesCount:Object.keys(e).filter(d=>d.includes("oklch")).length})}catch(r){this.config.enableDebug&&console.warn("\u{1F52C} [ColorHarmonyEngine] OKLAB processing failed, using fallbacks:",r)}}convertOklabToOklch(e){let i=e.L,r=Math.sqrt(e.a*e.a+e.b*e.b),a=Math.atan2(e.b,e.a)*(180/Math.PI);return a<0&&(a+=360),{L:i,C:r,H:a}}detectCurrentTheme(){let e=this.utils.getRootStyle();if(!e)return console.warn("[ColorHarmonyEngine detectCurrentTheme] Root element not found. Defaulting to mocha."),"mocha";let r=getComputedStyle(e).getPropertyValue("--spice-main").trim(),a=r.startsWith("#")?r.substring(1).toUpperCase():r.toUpperCase(),s={303446:"frappe",EFF1F5:"latte","24273A":"macchiato","1E1E2E":"mocha"}[a];if(s)return this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Detected Catppuccin theme: ${s}`),s;this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Unknown theme detected (${a}), attempting to generate fallback`);let l=`custom-${a.toLowerCase()}`;try{let c=this.paletteExtensionManager.generateFallbackPalette(l);this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Generated fallback palette for theme: ${l}`,c)}catch(c){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Failed to generate fallback palette:",c)}return this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Falling back to mocha theme for unknown base color: ${a}`),"mocha"}async _getGenreAwarePalette(e){let i=this.getCurrentActivePalette();if(!e||!i)return i;try{let r={name:this.currentTheme,version:"1.0.0",accents:i.accents,neutrals:i.neutrals,metadata:{author:"Catppuccin",description:`${this.currentTheme} flavor`,temperature:"neutral"}},a=this.paletteExtensionManager.applyGenreAwareModifications(r,e);return{accents:a.accents,neutrals:a.neutrals}}catch(r){return this.config.enableDebug&&console.warn(`[ColorHarmonyEngine] Failed to apply genre modifications for ${e}:`,r),i}}getMusicIntensityMultiplier(e=.5,i=.5){let r=this.config.getCurrentMultipliers().musicEnergyBoost,a=e>.7?1.3:e>.4?1:.8,n=i>.6?1.2:i<.4?.9:1;return r*a*n}validateColorHarmony(e,i="general"){let r=performance.now();this.harmonyMetrics.totalHarmonyCalculations++;let a={general:{minContrast:1.8,minHarmony:this.vibrancyConfig.harmonyTolerance},search:{minContrast:2.8,minHarmony:.4},navigation:{minContrast:2.5,minHarmony:.45},text:{minContrast:4.5,minHarmony:.6},accent:{minContrast:1.5,minHarmony:.3}},n=a[i]||a.general,s=this.getCurrentActivePalette();if(!s?.neutrals?.base){let x=`[StarryNight] Catppuccin palette or base neutral not found for theme: ${this.currentTheme}`;return console.error(x),{isValid:!1,error:"Palette configuration error.",contrastRatio:0,harmonyScore:0,meetsContrast:!1,isHarmonious:!1,artisticMode:this.config.artisticMode,adjustedRequirements:n,recommendations:[]}}let l=s.neutrals.base,c=this.utils.rgbToHex(e.r,e.g,e.b),m=this.utils.calculateContrastRatio(c,l),d=this.calculateHarmonyScore(e,s),h=this.config.artisticMode,g={...n};h==="advanced-maximum"||h==="cosmic-maximum"?(g.minContrast*=.7,g.minHarmony*=.6):h==="artist-vision"&&(g.minContrast*=.85,g.minHarmony*=.8);let f=m>=g.minContrast,S=d>=g.minHarmony,C=performance.now();return this.harmonyMetrics.performance.push(C-r),{isValid:f&&S,contrastRatio:m,harmonyScore:d,meetsContrast:f,isHarmonious:S,artisticMode:h,adjustedRequirements:g,recommendations:this.generateRecommendations(e,m,d,g)}}calculateHarmonyScore(e,i){let r=this.utils.rgbToHsl(e.r,e.g,e.b),a=0,n=Object.values(i.accents);for(let s of n){let l=this.utils.hexToRgb(s);if(!l)continue;let c=this.utils.rgbToHsl(l.r,l.g,l.b),m=Math.abs(r.h-c.h),d=Math.min(m,360-m),h=[0,30,60,90,120,150,180,210,240,270,300,330];if(h.some(f=>Math.abs(d-f)<20)){let f=1-Math.min(...h.map(S=>Math.abs(d-S)))/20;a=Math.max(a,f)}}return a}findBestHarmoniousAccent(e,i){let r={name:"mauve",hex:this.utils.getRootStyle()?.style.getPropertyValue("--sn-dynamic-accent")?.trim()||this.utils.getRootStyle()?.style.getPropertyValue("--spice-accent")?.trim()||"#cba6f7",rgb:{r:203,g:166,b:247}},a=["mauve","lavender","blue","sapphire","sky","pink","peach","teal"],n=-1,s=this.utils.rgbToHsl(e.r,e.g,e.b);for(let l of a){let c=i.accents[l];if(c){let m=this.utils.hexToRgb(c);if(!m)continue;let d=this.utils.rgbToHsl(m.r,m.g,m.b),h=Math.abs(s.h-d.h),f=1-Math.min(h,360-h)/180,S=d.s*.3,C=f+S;C>n&&(n=C,r={name:l,hex:c,rgb:m})}}return r}blendColors(e,i,r=this.vibrancyConfig.defaultBlendRatio){let a=Math.max(0,Math.min(1,r)),n=this.utils.rgbToOklab(e.r,e.g,e.b),s=this.utils.rgbToOklab(i.r,i.g,i.b),l=(V,z)=>V*a+z*(1-a),c={L:l(n.L,s.L),a:l(n.a,s.a),b:l(n.b,s.b)},m=this.utils.oklabToRgb(c.L,c.a,c.b),d=this.utils.rgbToHsl(m.r,m.g,m.b),h=this.config?.artisticMode??"artist-vision",g=this.animationEngine?.getCurrentMultipliers?.()||void 0,f=(h==="advanced-maximum"||h==="cosmic-maximum")&&!!g,S=g||{},C=f?(S.visualIntensityBase||1)*1.25:this.vibrancyConfig.artisticSaturationBoost,x=f?(S.aestheticGravityStrength||1)*1.15:this.vibrancyConfig.enhancedLuminanceBoost;d.s=Math.max(d.s,this.vibrancyConfig.minimumSaturation*100),d.s=Math.min(100,d.s*C),h!=="corporate-safe"&&(d.l=Math.min(95,d.l*x));let M=this.utils.hslToRgb(d.h,d.s,d.l);return{r:M.r,g:M.g,b:M.b}}blendWithCatppuccin(e,i=null){this.performanceMonitor?.emitTrace?.("[ColorHarmonyEngine] Starting blendWithCatppuccin");let r=null;if(i)try{let s={energy:i.energy||.5,valence:i.valence||.5,danceability:i.danceability,tempo:i.enhancedBPM||i.tempo,loudness:i.loudness,acousticness:i.acousticness,instrumentalness:i.instrumentalness,speechiness:i.speechiness,mode:i.mode,key:i.key,genre:i.genre};r=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(s),r&&(p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:r.cssVariables,timestamp:Date.now()}),document.body.classList.remove(...Array.from(document.body.classList).filter(l=>l.startsWith("smooth-emotion-"))),document.body.classList.add(r.cssClass),r.secondaryEmotion&&document.body.classList.add(`smooth-emotion-blend-${r.secondaryEmotion}`)),this.config.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Applied emotional temperature:",r)}catch(s){this.config.enableDebug&&console.warn("\u{1F321}\uFE0F [ColorHarmonyEngine] Failed to apply emotional temperature:",s)}this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] blendWithCatppuccin debug:",{extractedColors:e,musicContext:i,emotionalTemperature:r,currentTheme:this.currentTheme,vibrancyConfig:this.vibrancyConfig,userIntensity:this.userIntensity});let a=this.getCurrentActivePalette();if(!a)return console.error(`[StarryNight] Catppuccin palette not found for theme: ${this.currentTheme}`),e;let n={};for(let[s,l]of Object.entries(e)){if(!l)continue;let c=this.utils.hexToRgb(l);if(!c){this.config.enableDebug&&console.warn(`\u{1F3A8} [ColorHarmonyEngine] Failed to parse color for role ${s}: ${l}`),n[s]=l;continue}let m=this.utils.rgbToHsl(c.r,c.g,c.b),d=m.s>=this.vibrancyConfig.minimumSaturation*100;this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Processing color ${s}:`,{originalColor:l,rgb:c,hsl:m,saturationCheck:d,minimumSaturationRequired:this.vibrancyConfig.minimumSaturation*100,actualSaturation:m.s});let h=this.findBestHarmoniousAccent(c,a);if(!h?.rgb){console.warn(`[StarryNight] Could not find a valid harmonious accent for role: ${s}. Using original color.`),n[s]=l;continue}let g=this.vibrancyConfig.getBlendRatio(this.config.artisticMode);if(r){let C=r.intensity;g*=C*this.userIntensity;let x=this.calculateTemperatureBlendInfluence(r.temperature);g*=x,g=Math.max(0,Math.min(1,g)),this.config.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Emotional temperature blend adjustment:",{originalRatio:this.vibrancyConfig.getBlendRatio(this.config.artisticMode),emotionalIntensity:C,temperatureInfluence:x,finalBlendRatio:g,temperature:r.temperature})}else if(i){let C=this.getMusicIntensityMultiplier(i.energy,i.valence);g*=C*this.userIntensity,g=Math.max(0,Math.min(1,g))}this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Blending ${s}:`,{extractedRgb:c,bestAccent:h.hex,blendRatio:g,artisticMode:this.config.artisticMode});let f=this.blendColors(c,h.rgb,g),S=this.utils.rgbToHex(f.r,f.g,f.b);n[s]=S,this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Final color for ${s}: ${l} \u2192 ${S}`)}return this.harmonyMetrics.musicInfluencedAdjustments++,this.performanceMonitor?.emitTrace?.("[ColorHarmonyEngine] Completed blendWithCatppuccin"),this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Final harmonized result:",{inputColors:e,outputColors:n,colorCount:Object.keys(n).length}),this.updateSemanticColorsWithHarmonizedPalette(n),n}updateSemanticColorsWithHarmonizedPalette(e){if(this.semanticColorManager)try{this.semanticColorManager.updateWithAlbumColors(e);let i=e.VIBRANT||e.PRIMARY,r=e.DARK_VIBRANT||e.SECONDARY,a=e.VIBRANT_NON_ALARMING||e.LIGHT_VIBRANT;i&&this.semanticColorManager.getSemanticColor("essentialBrightAccent").then(n=>{let s=this.blendWithSemanticColor(i,n,.7);this.applyCSSVariable("--spice-accent",s),this.applyCSSVariable("--spice-button-active",s)}),r&&this.semanticColorManager.getSemanticColor("backgroundElevatedHighlight").then(n=>{let s=this.blendWithSemanticColor(r,n,.5);this.applyCSSVariable("--spice-highlight",s)}),a&&this.semanticColorManager.getSemanticColor("textBrightAccent").then(n=>{let s=this.blendWithSemanticColor(a,n,.6);this.applyCSSVariable("--spice-text-accent",s)}),this.semanticColorManager.flushUpdates()}catch(i){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Failed to update semantic colors:",i)}}blendWithSemanticColor(e,i,r){let a=this.utils.hexToRgb(e),n=this.utils.hexToRgb(i);if(!a||!n)return e;let s=this.blendColors(a,n,r);return this.utils.rgbToHex(s.r,s.g,s.b)}applyCSSVariable(e,i){p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:{[e]:i},timestamp:Date.now()})}enhanceCSSVariablesForUIComponents(e){let i={...e},r=i["--sn-accent-hex"]||i[_e.CANONICAL_HEX_VAR],a=i["--sn-accent-rgb"]||i[_e.CANONICAL_RGB_VAR],n=i["--sn-bg-gradient-primary"],s=i["--sn-bg-gradient-primary-rgb"],l=i["--sn-bg-gradient-secondary"],c=i["--sn-bg-gradient-secondary-rgb"];r&&a&&(i["--spice-accent"]=r,i["--spice-button"]=r,i["--spice-button-active"]=r,i["--spice-rgb-accent"]=a,i["--spice-rgb-button"]=a,i["--spice-text-accent"]=r,i["--sn-sidebar-entanglement-color-rgb"]=a,i["--sn-sidebar-accent-color"]=r,i["--sn-sidebar-accent-rgb"]=a,i["--sn-sidebar-dynamic-accent"]=r,i["--sn-nowplaying-accent-color"]=r,i["--sn-nowplaying-accent-rgb"]=a,i["--sn-nowplaying-primary-color"]=r,i["--sn-nowplaying-primary-rgb"]=a,i["--sn-main-feed-accent-color"]=r,i["--sn-main-feed-accent-rgb"]=a,i["--sn-content-accent-color"]=r,i["--sn-content-accent-rgb"]=a),n&&s&&(i["--sn-primary-gradient-color"]=n,i["--sn-primary-gradient-rgb"]=s,i["--sn-main-feed-primary-color"]=n,i["--sn-main-feed-primary-rgb"]=s),l&&c&&(i["--sn-secondary-gradient-color"]=l,i["--sn-secondary-gradient-rgb"]=c,i["--sn-main-feed-secondary-color"]=l,i["--sn-main-feed-secondary-rgb"]=c);let m=i["--sn-oklab-highlight-rgb"];m&&(i["--sn-audioAnalysis-bright-accent-rgb"]=m,i["--sn-layered-accent-rgb"]=m,i["--smooth-layered-rgb"]=m,i["--sn-holographic-accent-rgb"]=m,i["--smooth-holographic-rgb"]=m);let d=i["--sn-oklab-shadow-rgb"];return d&&(i["--sn-audioAnalysis-shadow-rgb"]=d,i["--sn-depth-shadow-rgb"]=d),i}generateRecommendations(e,i,r,a){let n=[],s=this.getCurrentActivePalette(),l=this.utils.hexToRgb(s?.neutrals?.base||"#1e1e2e");if(!l)return[];if(i<a.minContrast){let c=this.utils.findRequiredLuminance(e,l,a.minContrast),m=this.utils.rgbToHsl(e.r,e.g,e.b),d=this.utils.hslToRgb(m.h,m.s,c),h={r:d.r,g:d.g,b:d.b};n.push({type:"contrast",suggestion:`Adjust luminance to meet contrast of ${a.minContrast}`,recommendedColor:this.utils.rgbToHex(h.r,h.g,h.b)})}if(r<a.minHarmony){let c=this.findBestHarmoniousAccent(e,s),m=this.blendColors(e,c.rgb,.5);n.push({type:"harmony",suggestion:`Blend with harmonious accent color to improve score to at least ${a.minHarmony}`,recommendedColor:this.utils.rgbToHex(m.r,m.g,m.b)})}return n}getPerformanceReport(){return{system:this.systemName,metrics:this.harmonyMetrics,kineticState:this.kineticState,musicalMemorySize:this.musicalMemory.recentTracks.length,currentTheme:this.currentTheme}}updateFromMusicAnalysis(e,i,r){if(!e)return;let a=e.genre;a&&a!==this._lastGenre&&this._applyGenrePalette(a).then(()=>{this._lastGenre=a,this._forcePaletteRepaint()}),this._updateMusicalMemory(e,r),this._updateKineticState(e),this._applyAestheticGravity(e),this._calculateMusicAwareDynamics(e)}_calculateMusicAwareDynamics(e){let{energy:i=.5,valence:r=.5,enhancedBPM:a=120,beatOccurred:n=!1}=e,s=this._calculateMusicIntensityMultiplier(i,r),l=this._calculateBeatPhase(a),c=(r-.5)*2,m=this._calculateHueShift(n,i,l);this.kineticState={...this.kineticState,musicIntensityMultiplier:s,beatPhase:l,valenceGravity:c,hueShift:m}}_calculateMusicIntensityMultiplier(e,i){let r=e*.7+i*.3,a=Math.abs(i-.5)*.4;return Math.max(.1,Math.min(2,r+a))}_calculateBeatPhase(e){let i=performance.now(),r=6e4/e;return i%r/r}_calculateHueShift(e,i,r){if(window.matchMedia("(prefers-reduced-motion: reduce)").matches)return 0;let a=this.config.artisticMode,n=a==="advanced-maximum"||a==="cosmic-maximum"?8:5,s=Math.sin(r*2*Math.PI)*n;e&&(s+=i*(a==="advanced-maximum"||a==="cosmic-maximum"?12:10));let l=a==="advanced-maximum"||a==="cosmic-maximum"?25:15;return Math.max(-l,Math.min(l,s))}_updateMusicalMemory(e,i){this.musicalMemory.recentTracks.unshift({trackUri:i,...e,timestamp:Date.now()}),this.musicalMemory.recentTracks.length>this.musicalMemory.maxMemorySize&&this.musicalMemory.recentTracks.pop(),this.musicalMemory.energyHistory.unshift(e.energy),this.musicalMemory.energyHistory.length>20&&this.musicalMemory.energyHistory.pop(),this.harmonyMetrics.temporalMemoryEvents++}_updateKineticState(e){let{energy:i,enhancedBPM:r,beatOccurred:a}=e,n=performance.now();a?(this.kineticState.lastBeatTime=n,this.kineticState.currentPulse=1):this.kineticState.currentPulse*=.95;let s=n-this.kineticState.lastBeatTime,l=6e4/(r||120);this.kineticState.animationPhase=s%l/l*2*Math.PI,this.kineticState.visualMomentum=this.utils.lerp(this.kineticState.visualMomentum,i,.1)}_applyAestheticGravity(e){let{visualIntensity:i,valence:r,energy:a}=e,n=(r-.5)*2,s=(a-.5)*2,l=i;p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:{"--sn-gravity-x":n.toFixed(3),"--sn-gravity-y":s.toFixed(3),"--sn-gravity-strength":l.toFixed(3)},timestamp:Date.now()})}generateHarmonicVariations(e){let i=this.utils.rgbToOklab(e.r,e.g,e.b),r=Math.max(0,Math.min(1,i.L*.75)),a=this.utils.oklabToRgb(r,i.a,i.b),n=Math.max(0,Math.min(1,i.L*1.25)),s=this.utils.oklabToRgb(n,i.a,i.b);return{darkVibrantHex:this.utils.rgbToHex(a.r,a.g,a.b),lightVibrantHex:this.utils.rgbToHex(s.r,s.g,s.b)}}getCurrentGradient(e=5){try{if(!this.getCurrentActivePalette())return null;let r=this.utils.getRootStyle();if(!r)return this.generateFallbackGradient(e);let a=getComputedStyle(r),n=this.getInheritedGradientColors(a);if(!n)return u?.debug?.warn("ColorHarmonyEngine","Failed to inherit processed gradient variables, using fallback"),this.generateFallbackGradient(e);let s=[],l=this.kineticState.musicIntensityMultiplier||1,c=this.kineticState.hueShift||0,m=this.kineticState.valenceGravity||.5,d=this.emotionalState?.currentEmotion?.colorTemperature||.5,{primary:h,secondary:g,accent:f,emotional:S,tertiary:C}=n,x=[h,g,f,S,C];for(let M=0;M<e;M++){let V=M/(e-1),z;if(e===1)z=f;else{let I=V*(x.length-1),N=Math.floor(I),F=Math.min(N+1,x.length-1),P=I-N,J=Math.sin(d*Math.PI)*.3,we=Math.max(0,Math.min(1,P+J)),ae=x[N],oe=x[F];ae&&oe?z={r:ae.r+(oe.r-ae.r)*we,g:ae.g+(oe.g-ae.g)*we,b:ae.b+(oe.b-ae.b)*we}:z=f}let G=this._applyVisualEffectsModulation(z,{musicInfluence:l,valenceGravity:m,hueShift:c,emotionalTemperature:d,position:V});s.push({r:Math.round(Math.max(0,Math.min(255,G.r))),g:Math.round(Math.max(0,Math.min(255,G.g))),b:Math.round(Math.max(0,Math.min(255,G.b)))})}return this.config?.enableDebug&&console.log(`[ColorHarmonyEngine] Generated gradient with ${e} stops:`,s),s}catch(i){let r=i instanceof Error?i.message:"Unknown error",a={method:"getCurrentGradient",stopCount:e,currentTheme:this.currentTheme,kineticState:this.kineticState,timestamp:Date.now(),error:r};u?.debug?.error("ColorHarmonyEngine","Failed to generate gradient colors",a),p.emit("system:error",{systemName:"ColorHarmonyEngine",error:`Gradient generation failed: ${r}`,severity:"error",timestamp:Date.now()});try{let n=this.generateFallbackGradient(e);if(n&&n.length>0)return u?.debug?.warn("ColorHarmonyEngine","Using fallback gradient after error",{fallbackColorCount:n.length}),n}catch(n){u?.debug?.error("ColorHarmonyEngine","Fallback gradient generation also failed",n)}return null}}getInheritedGradientColors(e){try{let i=this.parseRGBVariable(e,"--sn-bg-gradient-primary-rgb")||this.parseRGBVariable(e,"--sn-musical-harmony-primary-rgb"),r=this.parseRGBVariable(e,"--sn-bg-gradient-secondary-rgb")||this.parseRGBVariable(e,"--sn-musical-harmony-secondary-rgb"),a=this.parseRGBVariable(e,"--sn-bg-gradient-accent-rgb")||this.parseRGBVariable(e,"--sn-color-accent-rgb"),n=this.parseRGBVariable(e,"--sn-oklab-emotional-temperature-rgb")||this.parseRGBVariable(e,"--sn-emotional-temperature-warm-rgb")||a,s=this.parseRGBVariable(e,"--sn-oklab-highlight-rgb")||this.parseRGBVariable(e,"--sn-audioAnalysis-flow-rgb")||this.parseRGBVariable(e,"--sn-musical-harmony-tertiary-rgb");return!i||!a?(u?.debug?.warn("ColorHarmonyEngine","Missing essential inherited colors",{hasPrimary:!!i,hasAccent:!!a}),null):{primary:i,secondary:r||i,accent:a,emotional:n||a,tertiary:s||a}}catch(i){return u?.debug?.error("ColorHarmonyEngine","Failed to inherit gradient colors:",i),null}}parseRGBVariable(e,i){try{let r=e.getPropertyValue(i).trim();if(!r)return null;let a=r.match(/(\d+),\s*(\d+),\s*(\d+)/);return a&&a[1]&&a[2]&&a[3]?{r:parseInt(a[1],10),g:parseInt(a[2],10),b:parseInt(a[3],10)}:null}catch{return null}}interpolateOKLABColors(e,i,r){let n=Math.pow(e.r/255,2.2),s=Math.pow(e.g/255,2.2),l=Math.pow(e.b/255,2.2),c=Math.pow(i.r/255,2.2),m=Math.pow(i.g/255,2.2),d=Math.pow(i.b/255,2.2),h=n+(c-n)*r,g=s+(m-s)*r,f=l+(d-l)*r;return{r:Math.round(Math.pow(h,1/2.2)*255),g:Math.round(Math.pow(g,1/2.2)*255),b:Math.round(Math.pow(f,1/2.2)*255)}}_applyVisualEffectsModulation(e,i){try{let r=this.utils.rgbToHsl(e.r,e.g,e.b),{h:a,s:n,l:s}=r;n=Math.max(0,Math.min(1,n*(.7+i.musicInfluence*.6))),a=(a+i.hueShift+(i.emotionalTemperature-.5)*60)%360;let l=i.valenceGravity*.2*Math.sin(i.position*Math.PI);s=Math.max(.1,Math.min(.9,s+l));let c=this.utils.hslToRgb(a,n,s);return{r:c.r,g:c.g,b:c.b}}catch{return e}}generateFallbackGradient(e){try{let i=["#1e1e2e","#313244","#45475a","#585b70","#cba6f7","#f5c2e7","#fab387"];(e<2||e>i.length)&&(u?.debug?.warn("ColorHarmonyEngine",`Invalid fallback stopCount: ${e}, using default`),e=Math.min(Math.max(e,2),i.length));let r=[];for(let a=0;a<e;a++){let n=Math.floor(a/(e-1)*(i.length-1)),s=i[n],l=s?this.utils.hexToRgb(s):null;l?r.push(l):r.push({r:203,g:166,b:247})}return r.length<2&&r.push({r:30,g:30,b:46},{r:203,g:166,b:247}),u?.debug?.log("ColorHarmonyEngine",`Generated fallback gradient with ${r.length} colors`,r),r}catch(i){return u?.debug?.error("ColorHarmonyEngine","Critical error in fallback gradient generation",i),null}}async analyzeMusicEmotion(e,i){if(!this.initialized||!this.musicEmotionAnalyzer)return this.config.enableDebug&&console.warn("\u{1F3AD} [ColorHarmonyEngine] Cannot analyze music emotion: not initialized"),null;try{let r=await this.musicEmotionAnalyzer.analyzeEmotion(e,i);return this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Analyzed music emotion: ${r.primary} (${r.intensity.toFixed(2)} intensity, ${r.confidence.toFixed(2)} confidence)`),r}catch(r){return console.error("\u{1F3AD} [ColorHarmonyEngine] Error analyzing music emotion:",r),null}}getCurrentEmotion(){return this.emotionalState?.currentEmotion||null}getEmotionHistory(e=10){return this.emotionalState?.emotionHistory?this.emotionalState.emotionHistory.slice(-e):[]}setEmotionInfluenceIntensity(e){this.emotionalState&&(this.emotionalState.emotionInfluenceIntensity=Math.max(0,Math.min(1,e)),this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Emotion influence intensity set to ${this.emotionalState.emotionInfluenceIntensity}`))}_createVariant(e,i,r,a){let n=this.utils.rgbToOklab(e.r,e.g,e.b),s=Math.max(0,Math.min(1,n.L+i*.2)),l=.8+r*.4,c=n.a*l,m=n.b*l,d=a*.1,h=c*Math.cos(d)-m*Math.sin(d),g=c*Math.sin(d)+m*Math.cos(d);return this.utils.oklabToRgb(s,h,g)}_applyMusicInfluence(e,i,r){let a=1+Math.sin(r*Math.PI)*.2,n=Math.max(.7,Math.min(1.3,i*a));return{r:e.r*n,g:e.g*n,b:e.b*n}}setIntensity(e){let i=Math.max(0,Math.min(1,e));this.userIntensity=i,this.config?.enableDebug&&console.log(`[ColorHarmonyEngine] User color harmony intensity set to ${i}`)}updatePalette(e){e?.length&&(this.config?.enableDebug&&console.log("[ColorHarmonyEngine] updatePalette invoked",{count:e.length}),this.forceRepaint("external-palette"))}_handleSettingsChange(e){let{key:i,value:r}=e.detail||{};switch(i){case Xa:{let a=parseFloat(r);Number.isNaN(a)||this.setIntensity(a);break}case Za:{let a=r==="true"||r===!0;this._setEvolutionEnabled(a);break}}}_handleArtisticModeChanged(){this.currentTheme=this.detectCurrentTheme(),this._pendingPaletteRefresh||(this._pendingPaletteRefresh=setTimeout(()=>{this._pendingPaletteRefresh=null,this.refreshPalette()},80))}_forcePaletteRepaint(){this.kineticState.hueShift=(this.kineticState.hueShift||0)+.01}_startEvolutionLoop(){if(this._evolutionTimer)return;let i=3e4/Math.max(.1,this.userIntensity);this._evolutionTimer=setInterval(()=>{let r=2*this.userIntensity,a=this.kineticState.hueShift??0;this.kineticState.hueShift=(a+r+360)%360-180},i)}_stopEvolutionLoop(){this._evolutionTimer&&(clearInterval(this._evolutionTimer),this._evolutionTimer=null)}_setEvolutionEnabled(e){this.evolutionEnabled!==e&&(this.evolutionEnabled=e,e?this._startEvolutionLoop():this._stopEvolutionLoop())}destroy(){this._stopEvolutionLoop(),document.removeEventListener("year3000SystemSettingsChanged",this._boundSettingsChangeHandler),document.removeEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),this.semanticColorManager&&this.semanticColorManager.destroy(),this.musicEmotionAnalyzer&&this.musicEmotionAnalyzer.destroy(),this.emotionalState&&(this.emotionalState.currentEmotion=null,this.emotionalState.emotionHistory=[]),super.destroy?.()}async refreshPalette(){try{let e=globalThis.year3000System;if(e?.updateColorsFromCurrentTrack){await e.updateColorsFromCurrentTrack();return}let i=this.utils.getRootStyle();if(!i)return;let a=getComputedStyle(i).getPropertyValue("--sn-gradient-primary").trim();if(a){let n=this.utils.hexToRgb(a),s={"--sn-bg-gradient-primary":a};n&&(s["--sn-bg-gradient-primary-rgb"]=`${n.r},${n.g},${n.b}`),p.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:s,timestamp:Date.now()})}}catch(e){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] refreshPalette failed",e)}}async _applyGenrePalette(e){try{let i=await this._getGenreAwarePalette(e);if(!i)return;this.catppuccinPalettes[this.currentTheme]=i,await this.refreshPalette(),this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Genre changed to: ${e}`)}catch(i){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] _applyGenrePalette failed",i)}}setEmergentEngine(e){this.animationEngine=e}calculateTemperatureBlendInfluence(e){let i=Math.max(0,Math.min(1,(e-1e3)/19e3));return e<=4e3?1+(4e3-e)/3e3*.3:e>=8e3?1.1+(e-8e3)/12e3*.2:.9+Math.abs(e-6e3)/2e3*.2}forceRepaint(e="settings-change"){this.refreshPalette?.()}determineOptimalOKLABPreset(e){let i=e.musicData,r=T.PRESETS.STANDARD;if(i){let{energy:a=.5,valence:n=.5}=i;a>.8&&n>.7?r=T.PRESETS.COSMIC:a>.7&&n<.4?r=T.PRESETS.VIBRANT:a<.3&&(r=T.PRESETS.SUBTLE)}return e.performanceHints?.preferLightweight&&(r=T.PRESETS.SUBTLE),this.config?.enableDebug&&console.log("\u{1F52C} [ColorHarmonyEngine] OKLAB preset selection:",{energy:i?.energy,valence:i?.valence,selectedPreset:r.name,reason:this.getPresetSelectionReason(i,e)}),r}async getAdvancedEmotionalTemperature(e,i){if(!this.emotionalTemperatureMapper||!e)return null;try{let r={energy:e.energy||.5,valence:e.valence||.5,danceability:e.danceability,tempo:e.tempo,loudness:e.loudness,acousticness:e.acousticness,instrumentalness:e.instrumentalness,speechiness:e.speechiness,mode:e.mode,key:e.key,genre:e.genre},a=await this.enhanceWithAlbumArtPsychology(r,i),n=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(a);return this.config?.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Advanced emotional temperature with album art enhancement:",{input:r,enhanced:a,albumArtInfluence:i?Object.keys(i).length+" colors":"None",emotion:n.primaryEmotion,secondaryEmotion:n.secondaryEmotion,intensity:n.intensity,temperature:n.temperature,oklabPreset:n.oklabPreset.name,perceptualColor:n.perceptualColorHex}),n}catch(r){return console.warn("[ColorHarmonyEngine] Advanced emotional temperature analysis failed:",r),null}}async enhanceWithAlbumArtPsychology(e,i){if(!i||Object.keys(i).length===0)return e;try{let r=this.analyzeAlbumArtPsychology(i),a={...e},n=a.energy||.5,s=a.valence||.5;if(r.warmth>.6&&(a.energy=Math.min(1,n*(1+r.warmth*.3)),a.valence=Math.min(1,s+r.warmth*.2)),r.coolness>.6&&(a.energy=Math.max(0,n*(1-r.coolness*.2)),r.saturation>.5&&(a.valence=Math.min(1,s+r.coolness*.15))),r.saturation>.7&&(a.energy=Math.min(1,n+r.saturation*.2)),r.saturation<.3&&(a.valence=Math.max(0,s-.15),a.energy=Math.max(0,n-.1)),r.darkness>.7){let l=a.energy||n;l>.6?a.energy=Math.min(1,l+.1):a.valence=Math.max(0,(a.valence||s)-.2)}return r.brightness>.8&&(a.valence=Math.min(1,(a.valence||s)+r.brightness*.2)),r.harmony>.8?a.valence=Math.min(1,(a.valence||s)+.1):r.harmony<.3&&(a.energy=Math.min(1,(a.energy||n)+.15)),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Album art psychology enhancement:",{original:{energy:e.energy||.5,valence:e.valence||.5},enhanced:{energy:a.energy||.5,valence:a.valence||.5},colorPsychology:r,adjustments:{energyChange:(a.energy||.5)-(e.energy||.5),valenceChange:(a.valence||.5)-(e.valence||.5)}}),a}catch(r){return console.warn("[ColorHarmonyEngine] Album art psychology enhancement failed:",r),e}}analyzeAlbumArtPsychology(e){try{let i=Object.values(e);if(i.length===0)return{warmth:.5,coolness:.5,saturation:.5,brightness:.5,darkness:.5,harmony:.5,dominantHue:180,emotionalIntensity:.5,genreIndicators:{electronicLikelihood:.5,smoothLikelihood:.5,metalHardcoreLikelihood:.5,popCommercialLikelihood:.5,jazzClassicalLikelihood:.5,folkAcousticLikelihood:.5},artistAwareness:{visualSophistication:.5,artisticIntention:.5,culturalIndicators:[],emotionalDepth:.5}};let r=0,a=0,n=0,s=0,l=0,c=[];for(let G of i){let I=this.utils.hexToRgb(G);if(!I)continue;let N=this.utils.rgbToHsl(I.r,I.g,I.b),{h:F,s:P,l:J}=N;c.push(F),F>=0&&F<=60||F>=300&&F<=360?r+=P*J:F>=120&&F<=240&&(a+=P*J),n+=P,s+=J,l+=1-J}let m=i.length,d=r/m,h=a/m,g=n/m,f=s/m,S=l/m,C=this.calculateColorHarmony(c),x=this.calculateDominantHue(c),M=Math.min(1,(g+this.calculateContrast(i))/2),V=this._analyzeGenreIndicatorsFromColors({warmth:Math.min(1,d),coolness:Math.min(1,h),saturation:g,brightness:f,darkness:S,harmony:C,dominantHue:x,emotionalIntensity:M}),z=this._analyzeArtistAwareness(i,{avgSaturation:g,avgBrightness:f,harmony:C,emotionalIntensity:M,colorCount:i.length});return{warmth:Math.min(1,d),coolness:Math.min(1,h),saturation:g,brightness:f,darkness:S,harmony:C,dominantHue:x,emotionalIntensity:M,genreIndicators:V,artistAwareness:z}}catch(i){return console.warn("[ColorHarmonyEngine] Album art psychology analysis failed:",i),{warmth:.5,coolness:.5,saturation:.5,brightness:.5,darkness:.5,harmony:.5,dominantHue:180,emotionalIntensity:.5,genreIndicators:{electronicLikelihood:.5,smoothLikelihood:.5,metalHardcoreLikelihood:.5,popCommercialLikelihood:.5,jazzClassicalLikelihood:.5,folkAcousticLikelihood:.5},artistAwareness:{visualSophistication:.5,artisticIntention:.5,culturalIndicators:[],emotionalDepth:.5}}}}calculateColorHarmony(e){if(e.length<=1)return 1;let i=0,r=[60,120,30,90];for(let n=0;n<e.length;n++)for(let s=n+1;s<e.length;s++){let l=e[n],c=e[s];if(l===void 0||c===void 0)continue;let m=Math.abs(l-c),d=Math.min(m,360-m);for(let h of r)Math.abs(d-h)<=15&&(i+=1)}let a=e.length*(e.length-1)/2;return Math.min(1,i/a)}calculateDominantHue(e){if(e.length===0)return 180;let i=new Array(12).fill(0);for(let a of e){let n=Math.floor(a/30);i[n]++}return i.indexOf(Math.max(...i))*30+15}calculateContrast(e){if(e.length<=1)return 0;let i=0,r=0;for(let a=0;a<e.length;a++)for(let n=a+1;n<e.length;n++){let s=e[a],l=e[n];if(!s||!l)continue;let c=this.utils.hexToRgb(s),m=this.utils.hexToRgb(l);if(c&&m){let d=(c.r*.299+c.g*.587+c.b*.114)/255,h=(m.r*.299+m.g*.587+m.b*.114)/255;i+=Math.abs(d-h),r++}}return r>0?i/r:0}async blendWithAdvancedOKLAB(e,i,r,a){let n={...e};try{let s=r?.oklabPreset||this.oklabState.currentPreset,l=s;a&&a.confidence>.5&&this.genreState.genreInfluenceIntensity>0&&(l=this.applyGenreColorAesthetics(s,a));let c=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let h of c){let g=e[h];if(g&&this.isValidHex(g))try{let f=a?`-${a.genre}`:"",S=`${g}-${l.name}${f}`;if(this.oklabState.processedPalette[S]){n[h]=this.oklabState.processedPalette[S].enhancedHex;continue}let C=this.applyBrightnessModeMultipliers(g),x=this.oklabProcessor.processColor(C,l);n[h]=x.enhancedHex,this.oklabState.processedPalette[S]=x,this.config?.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] OKLAB enhanced ${h}:`,{original:g,enhanced:x.enhancedHex,preset:s.name,processingTime:x.processingTime})}catch(f){console.warn(`[ColorHarmonyEngine] OKLAB processing failed for ${h}:`,f)}}let m=n.PRIMARY||n.VIBRANT||n.PROMINENT;if(m&&this.isValidHex(m))try{let h=this.oklabProcessor.processColor(m,l);n.SHADOW=h.shadowHex,n.HIGHLIGHT=h.highlightHex,this.config?.enableDebug&&console.log("\u{1F317} [ColorHarmonyEngine] Derived shadow/highlight colors:",{primary:m,shadow:h.shadowHex,highlight:h.highlightHex,preset:l.name})}catch(h){console.warn("[ColorHarmonyEngine] Shadow/highlight derivation failed:",h)}if(r?.perceptualColorHex&&n.PRIMARY)try{let h=this.oklabProcessor.interpolateOKLAB(n.PRIMARY,r.perceptualColorHex,r.intensity*.3,s);n.EMOTIONAL_BLEND=h.enhancedHex,this.config?.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Emotional color blending:",{primary:n.PRIMARY,emotionalColor:r.perceptualColorHex,blendFactor:r.intensity*.3,result:h.enhancedHex})}catch(h){console.warn("[ColorHarmonyEngine] Emotional color blending failed:",h)}this.oklabState.lastProcessingTime=Date.now();let d=this.getAlbumArtInfluenceSetting();if(d>0&&e&&Object.keys(e).length>0)try{let h=await this._applyDirectAlbumColorBlending(n,e,d,l);Object.assign(n,h),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Applied direct album color blending:",{albumInfluence:(d*100).toFixed(1)+"%",blendedKeys:Object.keys(h),note:"album colors now directly influence final UI colors"})}catch(h){console.warn("[ColorHarmonyEngine] Direct album color blending failed:",h)}if(this.semanticColorManager)try{this.semanticColorManager.updateWithAlbumColors(n),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Applied comprehensive Spicetify variable updates via strategy pattern:",{processedColorCount:Object.keys(n).length,methodUsed:"blendWithAdvancedOKLAB"})}catch(h){console.warn("[ColorHarmonyEngine] Failed to update Spicetify variables via strategy pattern:",h)}}catch(s){console.error("[ColorHarmonyEngine] Advanced OKLAB blending failed:",s)}return n}applyProgressiveResistance(e,i,r,a=0){let n=(e-a)/(r-a);if(i>=1){let s=Math.pow(n,2),l=1+(i-1)*(1-s),c=e*l;return Math.max(a,Math.min(c,r))}else{let s=Math.pow(1-n,2),l=1-(1-i)*(1-s),c=e*l;return Math.max(a,Math.min(c,r))}}applyBrightnessModeMultipliers(e){try{let i=getComputedStyle(document.documentElement),r=parseFloat(i.getPropertyValue("--sn-bg-gradient-saturation"))||1,a=parseFloat(i.getPropertyValue("--sn-bg-gradient-brightness"))||1,n=parseFloat(i.getPropertyValue("--sn-bg-gradient-contrast"))||1;if(r===1&&a===1&&n===1)return e;let s=this.utils.hexToRgb(e);if(!s)return e;let l=this.utils.rgbToHsl(s.r,s.g,s.b);if(!l)return e;let c={h:l.h,s:this.applyProgressiveResistance(l.s,r,85,0),l:this.applyProgressiveResistance(l.l,a,75,15)},m=this.utils.hslToRgb(c.h,c.s,c.l),d=m?this.utils.rgbToHex(m.r,m.g,m.b):e;return this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Applied brightness mode multipliers:",{original:e,adjusted:d,multipliers:{saturation:r,brightness:a,contrast:n},hslChange:{from:l,to:c}}),d}catch(i){return console.warn("[ColorHarmonyEngine] Failed to apply brightness mode multipliers:",i),e}}generateAdvancedOKLABCSSVariables(e){let i={};try{if(Object.entries(e.processedColors).forEach(([r,a])=>{a&&typeof a=="string"&&(i[`--sn-processed-${r.toLowerCase()}`]=a)}),Object.entries(this.oklabState.processedPalette).forEach(([r,a])=>{let[n,s]=r.split("-");if(n&&s){let l=`sn-oklab-${s.toLowerCase()}`,c=this.oklabProcessor.generateCSSVariables(a,l);Object.assign(i,c)}}),this.oklabState.perceptualGradientCache.size>0){let r=Array.from(this.oklabState.perceptualGradientCache.entries()),[a,n]=r[0]||[];if(n&&n.length>0){n.forEach((l,c)=>{let m=c/(n.length-1)*100;i[`--sn-oklab-gradient-stop-${c}`]=l.enhancedHex,i[`--sn-oklab-gradient-stop-${c}-rgb`]=`${l.enhancedRgb.r},${l.enhancedRgb.g},${l.enhancedRgb.b}`,i[`--sn-oklab-gradient-stop-${c}-pos`]=`${m}%`});let s=n.map((l,c)=>{let m=c/(n.length-1)*100;return`${l.enhancedHex} ${m}%`}).join(", ");i["--sn-oklab-perceptual-gradient"]=`linear-gradient(135deg, ${s})`,i["--sn-oklab-gradient-stop-count"]=n.length.toString()}}if(e.processedColors.EMOTIONAL_BLEND){i["--sn-audioAnalysis-emotional-color"]=e.processedColors.EMOTIONAL_BLEND;let r=be(e.processedColors.EMOTIONAL_BLEND);r&&(i["--sn-audioAnalysis-emotional-rgb"]=`${r.r},${r.g},${r.b}`)}i["--sn-oklab-preset-active"]=this.oklabState.currentPreset.name,i["--sn-oklab-cache-size"]=Object.keys(this.oklabState.processedPalette).length.toString(),i["--sn-oklab-last-processing"]=this.oklabState.lastProcessingTime.toString(),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Generated advanced OKLAB CSS variables:",{totalVariables:Object.keys(i).length,gradientStops:this.oklabState.perceptualGradientCache.size,oklabProcessedColors:Object.keys(this.oklabState.processedPalette).length})}catch(r){console.error("[ColorHarmonyEngine] Advanced OKLAB CSS variable generation failed:",r)}return i}generateColorVariations(e){let i={};try{let r=e.accentHex,a=e.context?.trackUri||"",n=`${a}-${r}`;if(this.oklabState.colorVariationCache.has(n)){let m=this.oklabState.colorVariationCache.get(n);return this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Using cached color variations:",{trackUri:a,baseColor:r,variantCount:Object.keys(m).length}),m}let s=this.utils.hexToRgb(r);if(!s)return this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Failed to parse base color for variations:",r),i;let l=this.utils.rgbToOklab(s.r,s.g,s.b),c=this.convertOklabToOklch(l);for(let m=0;m<16;m++){let d=m%4,h=Math.floor(m/4),g=-15+d*(30/4),f=.7+h*(.6/3),S={L:c.L,C:c.C*f,H:(c.H+g+360)%360},C=this.convertOklchToOklab(S),x=this.utils.oklabToRgb(C.L,C.a,C.b);i[`--sn-shimmer-variant-${m}-rgb`]=`${Math.round(x.r)},${Math.round(x.g)},${Math.round(x.b)}`}for(let m=0;m<8;m++){let d=-5+m*10/7,h={L:c.L,C:c.C*.85,H:(c.H+d+360)%360},g=this.convertOklchToOklab(h),f=this.utils.oklabToRgb(g.L,g.a,g.b);i[`--sn-atmosphere-variant-${m}-rgb`]=`${Math.round(f.r)},${Math.round(f.g)},${Math.round(f.b)}`}if(a&&r&&(this.oklabState.colorVariationCache.set(n,i),this.oklabState.colorVariationCache.size>50)){let m=this.oklabState.colorVariationCache.keys().next().value;m&&this.oklabState.colorVariationCache.delete(m)}this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Generated color variations:",{baseColor:r,trackUri:a||"unknown",shimmerVariants:16,atmosphereVariants:8,totalVariables:Object.keys(i).length,cached:!0,cacheSize:this.oklabState.colorVariationCache.size,performanceNote:"Pre-computed to eliminate runtime filters"})}catch(r){console.error("[ColorHarmonyEngine] Color variation generation failed:",r)}return i}convertOklchToOklab(e){let i=e.L,r=e.H*Math.PI/180,a=e.C*Math.cos(r),n=e.C*Math.sin(r);return{L:i,a,b:n}}generatePerceptualGradientData(e){try{let i=e.processedColors.PRIMARY,r=e.processedColors.SECONDARY||e.processedColors.EMOTIONAL_BLEND;if(!i||!this.isValidHex(i))return;let a=i,n=r&&this.isValidHex(r)?r:this.generateComplementaryColor(i),s=`${a}-${n}-${this.oklabState.currentPreset.name}`;if(this.oklabState.perceptualGradientCache.has(s))return;let l=7,c=this.oklabProcessor.generateOKLABGradient(a,n,l,this.oklabState.currentPreset);if(this.oklabState.perceptualGradientCache.set(s,c),this.oklabState.perceptualGradientCache.size>10){let m=this.oklabState.perceptualGradientCache.keys().next().value;m&&this.oklabState.perceptualGradientCache.delete(m)}this.config?.enableDebug&&console.log("\u{1F308} [ColorHarmonyEngine] Generated perceptual gradient data:",{startColor:a,endColor:n,stopCount:l,preset:this.oklabState.currentPreset.name,cacheKey:s,cacheSize:this.oklabState.perceptualGradientCache.size})}catch(i){console.error("[ColorHarmonyEngine] Perceptual gradient generation failed:",i)}}updateAdvancedHarmonyMetrics(e,i){try{let r=e.processedColors.PRIMARY,a=e.processedColors.SECONDARY,n=.5;if(r&&this.isValidHex(r)){let l=be(r);if(l){let c=this.calculateColorVibrancy(l);n=Math.min(1,c*.8+.2)}}let s={processingTime:i,harmonyScore:n,oklabProcessedColors:Object.keys(this.oklabState.processedPalette).length,perceptualGradientsCached:this.oklabState.perceptualGradientCache.size,currentPreset:this.oklabState.currentPreset.name,lastUpdate:Date.now()};e.metadata&&(e.metadata.advancedHarmonyMetrics=s),this.config?.enableDebug&&console.log("\u{1F4CA} [ColorHarmonyEngine] Advanced harmony metrics updated:",s)}catch(r){console.error("[ColorHarmonyEngine] Advanced harmony metrics update failed:",r)}}getPresetSelectionReason(e,i){if(!e)return"No music data available";let{energy:r=.5,valence:a=.5}=e;return i.performanceHints?.preferLightweight?"Performance optimization requested":r>.8&&a>.7?"High energy + positive valence":r>.7&&a<.4?"High energy + negative valence":r<.3?"Low energy music":"Standard balanced processing"}generateComplementaryColor(e){try{let i=be(e);if(!i)return e;let r=this.rgbToHsl(i.r,i.g,i.b),a=(r.h+180)%360,n=this.hslToRgb(a,r.s,r.l);return oi(n.r,n.g,n.b)}catch(i){return console.warn("[ColorHarmonyEngine] Complementary color generation failed:",i),e}}calculateColorVibrancy(e){let i=Math.max(e.r,e.g,e.b),r=Math.min(e.r,e.g,e.b),a=i-r;if(i===0)return 0;let n=a/i,s=i/255,l=1-Math.abs(s-.5)*2;return n*l}isValidHex(e){return/^#[0-9A-Fa-f]{6}$/.test(e)}rgbToHsl(e,i,r){e/=255,i/=255,r/=255;let a=Math.max(e,i,r),n=Math.min(e,i,r),s=a-n,l=0,c=0,m=(a+n)/2;if(s!==0){switch(c=m>.5?s/(2-a-n):s/(a+n),a){case e:l=(i-r)/s+(i<r?6:0);break;case i:l=(r-e)/s+2;break;case r:l=(e-i)/s+4;break}l/=6}return{h:l*360,s:c,l:m}}hslToRgb(e,i,r){e/=360;let a=(c,m,d)=>(d<0&&(d+=1),d>1&&(d-=1),d<1/6?c+(m-c)*6*d:d<1/2?m:d<2/3?c+(m-c)*(2/3-d)*6:c),n,s,l;if(i===0)n=s=l=r;else{let c=r<.5?r*(1+i):r+i-r*i,m=2*r-c;n=a(m,c,e+1/3),s=a(m,c,e),l=a(m,c,e-1/3)}return{r:Math.round(n*255),g:Math.round(s*255),b:Math.round(l*255)}}async analyzeGenreAesthetics(e,i){try{if(!this.genreProfileManager)return null;let r=this.genreProfileManager.getCurrentGenre(),a=this.genreProfileManager.getGenreConfidence();if(a<.3)return null;let n=this.genreProfileManager.getCharacteristics(r),s=this.genreProfileManager.getVisualStyle(r),l=1,c=a;if(i&&Object.keys(i).length>0)try{l=this._analyzeAlbumGenreHarmony(i,r,n).harmonyScore,c=a*l,this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Album-Genre harmony analysis:",{genre:r,originalConfidence:(a*100).toFixed(1)+"%",harmonyScore:(l*100).toFixed(1)+"%",validatedConfidence:(c*100).toFixed(1)+"%",albumColorCount:Object.keys(i).length})}catch(m){console.warn("[ColorHarmonyEngine] Album-genre harmony analysis failed:",m)}return this.genreState.currentGenre=r,this.genreState.genreConfidence=c,this.genreState.lastGenreUpdate=Date.now(),this.genreState.genreHistory.unshift({genre:r,confidence:c,timestamp:Date.now()}),this.genreState.genreHistory.length>10&&(this.genreState.genreHistory=this.genreState.genreHistory.slice(0,10)),this.config.enableDebug&&console.log(`\u{1F3B6} [ColorHarmonyEngine] Genre aesthetic analysis: ${r} (${(c*100).toFixed(1)}% album-validated confidence)`),{genre:r,confidence:c,characteristics:n,visualStyle:s}}catch(r){return console.warn("[ColorHarmonyEngine] Error analyzing genre aesthetics:",r),null}}applyGenreColorAesthetics(e,i){let{characteristics:r,visualStyle:a,confidence:n}=i,s={...e,name:`${e.name}-${i.genre}`,description:`${e.description} with ${i.genre} aesthetic characteristics`},l=n*this.genreState.genreInfluenceIntensity;return r.saturation>.7?s.chromaBoost=Math.min(2,e.chromaBoost+.3*l):r.saturation<.3&&(s.chromaBoost=Math.max(.8,e.chromaBoost-.2*l)),r.musicalComplexity>.7?s.vibrantThreshold=Math.max(.05,e.vibrantThreshold-.05*l):r.musicalComplexity<.3&&(s.vibrantThreshold=Math.min(.2,e.vibrantThreshold+.03*l)),r.emotionalRange>.7&&r.smoothness>.6?s.lightnessBoost=Math.max(.9,e.lightnessBoost-.1*l):r.artificialProcessing>.7&&(s.lightnessBoost=Math.min(1.4,e.lightnessBoost+.2*l)),a.contrastLevel>.7?s.shadowReduction=Math.max(.1,e.shadowReduction-.1*l):r.smoothness>.6&&(s.shadowReduction=Math.min(.5,e.shadowReduction+.1*l)),this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Applied ${i.genre} aesthetics to ${e.name} preset:`,{chromaBoost:`${e.chromaBoost} \u2192 ${s.chromaBoost}`,lightnessBoost:`${e.lightnessBoost} \u2192 ${s.lightnessBoost}`,vibrantThreshold:`${e.vibrantThreshold} \u2192 ${s.vibrantThreshold}`,genreInfluence:`${(l*100).toFixed(1)}%`}),s}_analyzeAlbumGenreHarmony(e,i,r){try{let a=1,n=[],s=Object.entries(e).map(([F,P])=>{let J=this.utils.hexToRgb(P);return J?this.utils.rgbToHsl(J.r,J.g,J.b):null}).filter(F=>F!==null);if(s.length===0)return{harmonyScore:1,explanation:"No valid album colors found"};let l=s.reduce((F,P)=>F+P.s,0)/s.length,c=r.saturation||.5,m=Math.abs(l/100-c);m<.2?(a*=1.1,n.push(`album saturation matches genre (\xB1${(m*100).toFixed(1)}%)`)):m>.4&&(a*=.85,n.push(`album saturation differs from genre expectations (${(m*100).toFixed(1)}% diff)`));let d=s.reduce((F,P)=>F+P.h,0)/s.length,h=d>=15&&d<=45||d>=315&&d<=345,g=d>=180&&d<=270,f=r.energyLevel||.5;f>.6&&h?(a*=1.15,n.push("warm album colors match high-energy genre")):f<.4&&g?(a*=1.1,n.push("cool album colors match low-energy genre")):(f>.6&&g||f<.4&&h)&&(a*=.9,n.push("album color temperature differs from genre energy"));let S=s.reduce((F,P)=>F+P.l,0)/s.length,C=S<40,x=S>70;i.includes("metal")||i.includes("goth")||i.includes("dark")?C?(a*=1.2,n.push("dark album aesthetic matches genre")):x&&(a*=.8,n.push("bright album conflicts with dark genre aesthetic")):(i.includes("pop")||i.includes("dance")||i.includes("electronic"))&&x&&(a*=1.15,n.push("bright album aesthetic matches energetic genre"));let M=s.map(F=>F.h),V=Math.max(...M)-Math.min(...M),z=V<30,G=V>120,I=r.musicalComplexity||r.harmonicComplexity||.5;I>.7&&G?(a*=1.1,n.push("diverse album colors match complex genre")):I<.3&&z&&(a*=1.1,n.push("unified album colors match simple genre")),a=Math.max(.7,Math.min(1.3,a));let N=n.length>0?n.join("; "):"album colors analyzed for genre harmony";return{harmonyScore:a,explanation:N}}catch(a){return console.warn("[ColorHarmonyEngine] Album-genre harmony analysis error:",a),{harmonyScore:1,explanation:"harmony analysis failed, using default confidence"}}}getAlbumArtInfluenceSetting(){return .5}async _applyDirectAlbumColorBlending(e,i,r,a){let n={};try{let s=this._extractDominantAlbumColors(i);if(s.length===0)return{};let l=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING"];for(let c of l){let m=e[c];if(!(!m||!this.isValidHex(m)))try{let d=this._selectHarmoniousAlbumColor(m,s);if(d){let h=this.oklabProcessor.interpolateOKLAB(m,d,r*.6,a);n[c]=h.enhancedHex,this.config?.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Album-blended ${c}:`,{original:m,albumColor:d,blended:h.enhancedHex,blendFactor:(r*.6).toFixed(2)})}}catch(d){console.warn(`[ColorHarmonyEngine] Album blending failed for ${c}:`,d)}}if(s.length>0&&r>.3)try{let c=this._selectMostVibrantColor(s);if(c){let m=this.oklabProcessor.processColor(c,a);n.ALBUM_ACCENT=m.enhancedHex,this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Created ALBUM_ACCENT:",{source:c,enhanced:m.enhancedHex})}}catch(c){console.warn("[ColorHarmonyEngine] Album accent creation failed:",c)}return n}catch(s){return console.error("[ColorHarmonyEngine] Direct album color blending error:",s),{}}}_extractDominantAlbumColors(e){let i=[],r=["VIBRANT","DOMINANT","PRIMARY","PROMINENT","LIGHT_VIBRANT","DARK_VIBRANT"];for(let a of r){let n=e[a];n&&this.isValidHex(n)&&i.push(n)}return i.length<3&&Object.values(e).forEach(a=>{a&&this.isValidHex(a)&&!i.includes(a)&&i.push(a)}),i.slice(0,5)}_selectHarmoniousAlbumColor(e,i){if(i.length===0)return null;try{let r=this.utils.hexToRgb(e);if(!r)return i[0]||null;let a=this.utils.rgbToHsl(r.r,r.g,r.b),n=i[0]||null,s=0;for(let l of i){let c=this.utils.hexToRgb(l);if(!c)continue;let m=this.utils.rgbToHsl(c.r,c.g,c.b),d=Math.abs(a.h-m.h),h=Math.min(d,360-d),g=0;h<30?g=.9:h>150&&h<210?g=.8:h>90&&h<150?g=.6:g=.4,Math.abs(a.s-m.s)<20&&(g+=.1),g>s&&(s=g,n=l)}return n}catch(r){return console.warn("[ColorHarmonyEngine] Harmonious color selection failed:",r),i[0]||null}}_selectMostVibrantColor(e){if(e.length===0)return null;try{let i=e[0]||null,r=0;for(let a of e){let n=this.utils.hexToRgb(a);if(!n)continue;let s=this.utils.rgbToHsl(n.r,n.g,n.b),l=s.s/100*(1-Math.abs(s.l-50)/50);l>r&&(r=l,i=a)}return i}catch(i){return console.warn("[ColorHarmonyEngine] Most vibrant color selection failed:",i),e[0]||null}}_analyzeGenreIndicatorsFromColors(e){let{warmth:i,coolness:r,saturation:a,brightness:n,darkness:s,harmony:l,dominantHue:c,emotionalIntensity:m}=e,d=Math.min(1,a*.4+r*.3+(n>.7||s<.3?.2:0)+(c>=180&&c<=270?.1:0)),h=Math.min(1,(i>r?i:0)*.3+(a>=.3&&a<=.7?.3:0)+(n>=.4&&n<=.7?.2:0)+l*.2),g=Math.min(1,s*.4+m*.3+(c>=0&&c<=30||c>=330?.2:0)+(a>.6||a<.2?.1:0)),f=Math.min(1,(n>.6?n*.3:0)+a*.3+(i>.5?i*.2:0)+(m>.5?.2:0)),S=Math.min(1,l*.4+(a>=.4&&a<=.8?.3:0)+(n>=.3&&n<=.8?.2:0)+(i+r)/2*.1),C=Math.min(1,i*.4+(a>=.2&&a<=.6?.3:0)+l*.2+(c>=15&&c<=60?.1:0));return{electronicLikelihood:d,smoothLikelihood:h,metalHardcoreLikelihood:g,popCommercialLikelihood:f,jazzClassicalLikelihood:S,folkAcousticLikelihood:C}}_analyzeArtistAwareness(e,i){let{avgSaturation:r,avgBrightness:a,harmony:n,emotionalIntensity:s,colorCount:l}=i,c=Math.min(1,n*.4+(l>2&&l<=5?.3:.1)+(r>=.3&&r<=.8?.2:0)+(a>=.2&&a<=.8?.1:0)),m=Math.min(1,n*.5+s*.3+(l>=2&&l<=4?.2:0)),d=[];r>.8&&s>.7&&d.push("high-energy-culture"),n>.7&&r<.6&&d.push("minimalist-aesthetic"),a<.3&&s>.6&&d.push("dark-artistic"),a>.7&&r>.6&&d.push("commercial-pop");let h=Math.min(1,s*.5+(r>.4?.2:0)+(n>.5?.2:0)+(l>=3?.1:0));return{visualSophistication:c,artisticIntention:m,culturalIndicators:d,emotionalDepth:h}}};_e.CANONICAL_HEX_VAR="--sn-accent-hex",_e.CANONICAL_RGB_VAR="--sn-accent-rgb";Xr=_e,gi=Xr});var ht,qn=v(()=>{"use strict";ht=class{static async getAudioData(){try{return typeof Spicetify<"u"&&Spicetify.getAudioData?await Spicetify.getAudioData():(console.warn("[SpicetifyCompat] Spicetify.getAudioData not available"),null)}catch(t){return console.error("[SpicetifyCompat] Error fetching audio data:",t),null}}static isAvailable(){return typeof Spicetify<"u"&&!!Spicetify.getAudioData}static async getAudioDataWithRetry(t=200,e=10){for(let i=0;i<e;i++)try{let r=await this.getAudioData();if(r)return r}catch(r){i<e-1?(console.log(`[SpicetifyCompat] Retrying audio data fetch (${i+1}/${e})...`),await new Promise(a=>setTimeout(a,t))):console.warn(`[SpicetifyCompat] Audio data fetch failed after ${e} attempts:`,r)}return null}}});function Be(){return typeof window<"u"&&window.Spicetify?window.Spicetify:null}function wl(){return!!Be()?.CosmosAsync}var j,Je,Jr=v(()=>{"use strict";B();_();te();qn();ee();Dt();ue();Xe();j={enableDebug:!0,enableBeatSynchronization:!0,enableGenreAnalysis:!0,enableMoodAdaptation:!0,bpmCalculation:{useEnhancedAlgorithm:!0,danceabilityWeight:.9,energyWeight:.6,bpmWeight:.6,energyThreshold:.5,danceabilityThreshold:.5,bpmThreshold:.8,maxBPM:180,minBPM:60},performance:{cacheSize:100,cacheTTL:3e5,maxRetries:10,retryDelay:200,enableMetrics:!0,processingTimeTarget:50},synchronization:{beatAccuracyTarget:50,maxSyncDelay:1e3,adaptiveQuality:!0,predictiveCaching:!0,debounceRapidChanges:200},genreProfiles:{electronic:{intensityMultiplier:1.2,precisionBoost:1.1},jazz:{smoothingFactor:1.3,adaptiveVariation:!0},classical:{gentleMode:!0,tempoVariationHandling:"adaptive"},rock:{energyBoost:1.15,consistentTiming:!0},ambient:{subtleMode:!0,intensityReduction:.7},hiphop:{beatEmphasis:1.25,rhythmPrecision:"high"},default:{balanced:!0}},musicVisualSync:{enhancedBPM:{fallbacks:{tempo:120,loudness:-5,key:0,timeSignature:4},danceabilityEstimation:{highDance:{min:125,max:145,value:.8},mediumDance:{min:100,max:124,value:.7},lowMediumDance:{min:80,max:99,value:.6},lowDance:{value:.5}},energyEstimation:{tempoRange:{min:80,max:160},loudnessRange:{min:-15,max:0},tempoWeight:.6,loudnessWeight:.4}}}},Je=class{constructor(t={}){this.isInitialized=!1;this.currentTrack=null;this.audioData=null;this.currentTrackUri=null;this.latestProcessedData=null;this.beatSchedulerTimer=null;this.songChangeDebounceTimer=null;this.nextBeatIndex=0;this.currentSongBeats=[];this.songStartTimestamp=0;this.metrics={bpmCalculations:0,beatSyncs:0,cacheHits:0,cacheMisses:0,avgProcessingTime:0,performance:[],errors:0,updates:0};this.unifiedCache=new Map;this.subscribers=new Map;this.beatSync={lastBeatTime:0,nextBeatTime:0,beatInterval:0,confidence:0,isActive:!1};this.performanceInterval=null;this.cacheCleanupInterval=null;this.CACHE_KEY_VERSION_PREFIX="v3";this.eventProcessingState={isProcessingEvent:!1,eventChain:[],lastEventTime:0,consecutiveEvents:0};this.MAX_CONSECUTIVE_EVENTS=5;this.EVENT_RESET_TIMEOUT=3e3;this.currentBeatVector={x:0,y:0};this.config=t.ADVANCED_SYSTEM_CONFIG||t.YEAR3000_CONFIG||w,this.utils=t.ThemeUtilities||k,this.year3000System=t.year3000System||null,this.genreProfileManager=t.genreProfileManager||new ye({ADVANCED_SYSTEM_CONFIG:this.config}),this.oklabProcessor=new T(this.config.enableDebug),this.emotionalTemperatureMapper=new se(this.config.enableDebug),this.cacheTTL=j.performance.cacheTTL,this.userPreferences=this.loadUserPreferences(),this.config.enableDebug&&(console.log("\u{1F3B5} MusicSyncService constructor called"),console.log("\u{1F3B5} [MusicSyncService] Initialized with GenreProfileManager support"))}get initialized(){return this.isInitialized}async initialize(){try{this.config.enableDebug&&console.log("\u{1F3B5} Initializing unified MusicSyncService..."),ht.isAvailable()||console.warn("[MusicSyncService] Spicetify audio data API not available at initialization. Some features may be limited."),this.setupCacheManagement(),j.performance.enableMetrics&&this.setupPerformanceMonitoring(),this.isInitialized=!0,this.config.enableDebug&&console.log("\u{1F31F} MusicSyncService initialized successfully!")}catch(t){console.error("\u274C MusicSyncService initialization failed:",t),this.metrics.errors++}}subscribe(t,e){if(!t||typeof t.updateFromMusicAnalysis!="function"){console.warn(`[MusicSyncService] Invalid system or missing updateFromMusicAnalysis method: ${e}`);return}if(this.subscribers.has(e)){this.config.enableDebug&&console.warn(`[MusicSyncService] System ${e} already subscribed.`);return}if(this.subscribers.set(e,t),this.config.enableDebug&&console.log(`[MusicSyncService] System subscribed: ${e}`),this.latestProcessedData&&t.initialized)try{t.updateFromMusicAnalysis(this.latestProcessedData,null,this.currentTrackUri)}catch(i){console.error(`[MusicSyncService] Error notifying new subscriber ${e}:`,i)}}unsubscribe(t){this.subscribers.has(t)&&(this.subscribers.delete(t),this.config.enableDebug&&console.log(`[MusicSyncService] System unsubscribed: ${t}`))}notifySubscribers(t,e,i){if(!this.isInitialized){console.warn("[MusicSyncService] Not initialized, cannot notify subscribers.");return}this.latestProcessedData=t;for(let[r,a]of this.subscribers)try{a.initialized&&typeof a.updateFromMusicAnalysis=="function"&&a.updateFromMusicAnalysis(t,e,i)}catch(n){console.error(`[MusicSyncService] Error notifying subscriber ${r}:`,n),this.metrics.errors++}}async fetchAudioData(t={}){let{retryDelay:e=j.performance.retryDelay,maxRetries:i=j.performance.maxRetries}=t,a=Be()?.Player?.data?.item?.uri;if(!a)return this.config.enableDebug&&console.warn("[MusicSyncService] No current track URI to fetch audio data."),null;let n=this.generateCacheKey(a,"audioData"),s=this.getFromCache(n);if(s?.audioData){if(this.isValidAudioData(s.audioData))return this.metrics.cacheHits++,this.config.enableDebug&&console.log(`[MusicSyncService] Cache hit for audioData: ${n}`),s.audioData;this.unifiedCache.delete(n)}this.metrics.cacheMisses++;for(let l=0;l<i;l++){try{let c=await ht.getAudioData();if(!c)continue;let m=this.convertSpicetifyToAudioData(c);if(this.isValidAudioData(m))return this.setInCache(n,{audioData:m}),m;this.config.enableDebug&&console.log(`[MusicSyncService] Audio analysis unavailable (attempt ${l+1}/${i}). Retrying\u2026`)}catch(c){if(l===i-1){this.config.enableDebug&&console.warn("[MusicSyncService] Audio data fetch error on final attempt:",c),this.metrics.errors++;let m={tempo:120,energy:.5,valence:.5,loudness:-10,key:0,time_signature:4,danceability:.5,acousticness:.5,instrumentalness:0,speechiness:.05,liveness:.2,mode:1};return this.config.enableDebug&&console.warn("[MusicSyncService] All audio-data attempts failed \u2013 using fallback defaults"),m}}await new Promise(c=>setTimeout(c,e))}return null}async getAudioFeatures(){try{let e=Be()?.Player?.data?.item;if(!e?.uri)return null;let i=e.uri.split(":")[2]||"fallback",r=this.generateCacheKey(i,"features"),a=this.getFromCache(r);if(a?.audioFeatures)return this.metrics.cacheHits++,this.config.enableDebug&&console.log(`[MusicSyncService] Cache hit for audioFeatures: ${r}`),a.audioFeatures;this.metrics.cacheMisses++;let n=Be();if(!wl()||!n?.CosmosAsync)throw new Error("CosmosAsync not available");let s=await n.CosmosAsync.get(`https://api.spotify.com/v1/audio-features/${i}`),l={danceability:s.danceability,energy:s.energy,valence:s.valence,acousticness:s.acousticness,instrumentalness:s.instrumentalness,tempo:s.tempo};return this.setInCache(r,{audioFeatures:l}),l}catch(t){return this.config.enableDebug&&console.warn("[MusicSyncService] Could not fetch audio features:",t),null}}generateCacheKey(t,e="default"){return`${this.CACHE_KEY_VERSION_PREFIX}-${t}-${e}`}getFromCache(t){let e=this.unifiedCache.get(t);return e&&Date.now()-e.timestamp<this.cacheTTL?e.data:(e&&this.unifiedCache.delete(t),null)}setInCache(t,e){this.unifiedCache.set(t,{data:e,timestamp:Date.now()})}async calculateEnhancedBPM(t,e={}){let i=performance.now();try{if(!t?.tempo)return this.config.enableDebug&&console.warn("[MusicSyncService] No BPM data available for track"),this.getFallbackBPM();let r=t.tempo,a={...j.bpmCalculation,...e},n=await this.getAudioFeatures();if(!n)return this.config.enableDebug&&console.log("[MusicSyncService] Using basic BPM calculation"),this.validateBPM(r);let{danceability:s,energy:l,valence:c=.5}=n;this.config.enableDebug&&console.log(`[MusicSyncService] Audio features - Danceability: ${s}, Energy: ${l}, Valence: ${c}`);let m=this.genreProfileManager.getProfileForTrack(n||void 0),d=this.genreProfileManager.detectGenre(n||void 0),h=this.computeAdvancedBPM({trackBPM:r,danceability:s,energy:l,valence:c,config:a,profile:m}),g=Be(),S=(g?.Player?.data?.item||g?.Player?.data)?.uri?.split(":")??[],C=S.length>2&&S[2]?S[2]:"fallback",x=this.generateCacheKey(C,"bpm");return this.setInCache(x,{bpm:h,audioFeatures:n}),this.metrics.bpmCalculations++,this.config.enableDebug&&console.log(`[MusicSyncService] Enhanced BPM: ${h} (original: ${r})`),h}catch(r){return console.error("[MusicSyncService] BPM calculation failed:",r),this.metrics.errors++,this.getFallbackBPM()}}computeAdvancedBPM(t){let{trackBPM:e,danceability:i,energy:r,valence:a,config:n,profile:s}=t,{danceabilityWeight:l,energyWeight:c,bpmWeight:m,energyThreshold:d,danceabilityThreshold:h,bpmThreshold:g,maxBPM:f,minBPM:S}=n,C=Math.min(e/120,2),x=l,M=c,V=m;i<h&&(x*=i),r<d&&(M*=r),C<g&&(V=.9);let z=1;a>.6?z=1.05:a<.4&&r<.5&&(z=.95);let G=x+M+V,N=(i*x+r*M+C*V)/G*120*z;return s.beatEmphasis&&(N*=s.beatEmphasis),N=Math.max(S,Math.min(f,N)),Math.round(N*100)/100}validateBPM(t){let{minBPM:e,maxBPM:i}=j.bpmCalculation;return Math.max(e,Math.min(i*2,Math.round(t*100)/100))}getFallbackBPM(){return 75}estimateDanceabilityFromTempo(t){let e=j.musicVisualSync.enhancedBPM.danceabilityEstimation;return t>=e.highDance.min&&t<=e.highDance.max?e.highDance.value:t>=e.mediumDance.min&&t<=e.mediumDance.max?e.mediumDance.value:t>=e.lowMediumDance.min&&t<=e.lowMediumDance.max?e.lowMediumDance.value:e.lowDance.value}estimateEnergyFromTempoLoudness(t,e){let i=j.musicVisualSync.enhancedBPM.energyEstimation,r=Math.max(0,Math.min(1,(t-i.tempoRange.min)/(i.tempoRange.max-i.tempoRange.min))),a=Math.max(0,Math.min(1,(e-i.loudnessRange.min)/(i.loudnessRange.max-i.loudnessRange.min)));return r*i.tempoWeight+a*i.loudnessWeight}estimateValenceFromKey(t){return[0,2,4,5,7,9,11].includes(t)?.6:.4}getFallbackProcessedData(t){let e=j.musicVisualSync.enhancedBPM.fallbacks,i=6e4/e.tempo;return{trackUri:t,timestamp:Date.now(),tempo:e.tempo,loudness:e.loudness,key:e.key,timeSignature:e.timeSignature,estimatedDanceability:this.estimateDanceabilityFromTempo(e.tempo),estimatedEnergy:this.estimateEnergyFromTempoLoudness(e.tempo,e.loudness),estimatedValence:.5,energy:.5,valence:.5,processedEnergy:.5,visualIntensity:.5,moodIdentifier:"neutral",baseBPM:e.tempo,enhancedBPM:e.tempo,beatInterval:i,bmpCalculationMethod:"fallback",dataSource:"fallback"}}async createOKLABEnhancedFallbackColors(t){let e={VIBRANT:"#f2cdcd",DARK_VIBRANT:"#cba6f7",LIGHT_VIBRANT:"#f5c2e7",PROMINENT:"#cba6f7",VIBRANT_NON_ALARMING:"#f2cdcd",DESATURATED:"#9399b2"};if(!t||typeof t.energy!="number"||typeof t.valence!="number"){let s=T.getPreset("STANDARD"),l={};for(let[c,m]of Object.entries(e))try{let d=this.oklabProcessor.processColor(m,s);l[c]=d.enhancedHex}catch(d){this.config.enableDebug&&console.warn(`\u{1F3A8} [MusicSyncService] OKLAB processing failed for ${c}:`,d),l[c]=m}return l}let i={energy:t.energy,valence:t.valence,danceability:t.danceability,tempo:t.tempo,mode:t.mode,genre:this.genreProfileManager.detectGenre(t)},r=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(i),a;r.intensity>=1?a=T.getPreset("COSMIC"):r.intensity>=.7?a=T.getPreset("VIBRANT"):r.intensity>=.5?a=T.getPreset("STANDARD"):a=T.getPreset("SUBTLE");let n={};for(let[s,l]of Object.entries(e))try{let c=this.oklabProcessor.processColor(l,a);n[s]=c.enhancedHex}catch(c){this.config.enableDebug&&console.warn(`\u{1F3A8} [MusicSyncService] OKLAB processing failed for ${s}:`,c),n[s]=l}return n["--sn-emotional-primary"]=r.perceptualColorHex||r.primaryEmotion,n["--sn-emotional-intensity"]=r.intensity.toString(),n["--sn-emotional-preset"]=a.name,this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Created OKLAB-enhanced fallback colors:",{emotion:r.primaryEmotion,intensity:r.intensity,preset:a.name,oklabCoordination:n,musicContext:{energy:t.energy,valence:t.valence}}),n}async enhanceExtractedColorsWithOKLAB(t,e){let i={},r=T.getPreset("STANDARD");if(e&&typeof e.energy=="number"&&typeof e.valence=="number"){let a={energy:e.energy,valence:e.valence,danceability:e.danceability,tempo:e.tempo,mode:e.mode,genre:this.genreProfileManager.detectGenre(e)},n=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(a);n.intensity>=1?r=T.getPreset("COSMIC"):n.intensity>=.7?r=T.getPreset("VIBRANT"):n.intensity>=.5?r=T.getPreset("STANDARD"):r=T.getPreset("SUBTLE"),i["--sn-emotional-primary"]=n.perceptualColorHex||`oklabColorProcessor-${n.primaryEmotion}`,i["--sn-emotional-intensity"]=n.intensity.toString(),i["--sn-emotional-temperature"]=n.temperature.toString(),this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Applying OKLAB enhancement with emotional context:",{emotion:n.primaryEmotion,intensity:n.intensity,preset:r.name,colorCount:Object.keys(t).length})}for(let[a,n]of Object.entries(t)){if(!n||typeof n!="string"||!n.startsWith("#")){i[a]=n;continue}try{let s=this.oklabProcessor.processColor(n,r);i[a]=s.enhancedHex,i[`${a}-oklab-l`]=s.oklabEnhanced.L.toFixed(3),i[`${a}-oklab-a`]=s.oklabEnhanced.a.toFixed(3),i[`${a}-oklab-b`]=s.oklabEnhanced.b.toFixed(3),i[`${a}-oklch-c`]=s.oklchEnhanced.C.toFixed(3),i[`${a}-oklch-h`]=s.oklchEnhanced.H.toFixed(1)}catch(s){this.config.enableDebug&&console.warn(`\u{1F3A8} [MusicSyncService] OKLAB processing failed for ${a} (${n}):`,s),i[a]=n}}return i["--sn-oklab-preset"]=r.name,i["--sn-oklab-enhanced"]="true",this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] OKLAB color enhancement completed:",{originalCount:Object.keys(t).length,enhancedCount:Object.keys(i).length,preset:r.name,sampleEnhanced:{original:t.VIBRANT||t[Object.keys(t)[0]||""],enhanced:i.VIBRANT||i[Object.keys(i)[0]||""]}}),i}async processAudioFeatures(t,e,i){if(!this.isInitialized){console.warn("[MusicSyncService] Not initialized, skipping processing.");return}this.stopBeatScheduler(),this.currentTrackUri=e;let r=this.generateCacheKey(e,"processed"),a=this.getFromCache(r);if(a?.processedData){this.notifySubscribers(a.processedData,null,e);return}try{let n=t;if(n||(n=await this.fetchAudioData()),!n)throw new Error("Failed to fetch or receive audio data.");n.beats&&n.beats.length>0&&(this.currentSongBeats=n.beats,this.songStartTimestamp=Date.now(),this.nextBeatIndex=0,this.scheduleNextBeatEvent());let s=await this.calculateEnhancedBPM(n),l=s>0?6e4/s:0,c=n,{tempo:m=j.musicVisualSync.enhancedBPM.fallbacks.tempo,loudness:d=j.musicVisualSync.enhancedBPM.fallbacks.loudness,key:h=j.musicVisualSync.enhancedBPM.fallbacks.key,time_signature:g=j.musicVisualSync.enhancedBPM.fallbacks.timeSignature}=c,f=await this.getAudioFeatures(),S=f?.danceability??this.estimateDanceabilityFromTempo(m),C=f?.energy??this.estimateEnergyFromTempoLoudness(m,d),x=f?.valence??this.estimateValenceFromKey(h),M=this.config.getCurrentMultipliers?.()||{musicEnergyBoost:1,visualIntensityBase:1},V=Math.max(.1,Math.min(1,C*(M.musicEnergyBoost||1))),G=(C*.6+S*.4)*(M.visualIntensityBase||1),I="neutral";x>.6&&C>.6?I="energetic-happy":x>.6&&C<=.6?I="calm-happy":x<=.4&&C>.6?I="intense-moody":x<=.4&&C<=.4&&(I="calm-melancholy");let N=Math.max(.5,.8+G*.4),F=this.genreProfileManager.detectGenre(f||void 0),P={trackUri:e,timestamp:Date.now(),tempo:m,loudness:d,key:h,timeSignature:g,duration:i,estimatedDanceability:S,estimatedEnergy:C,estimatedValence:x,energy:C,valence:x,processedEnergy:V,visualIntensity:G,moodIdentifier:I,baseBPM:m,enhancedBPM:s,beatInterval:l,bmpCalculationMethod:"unified-service",dataSource:"unified-music-sync-service",beatOccurred:!1,animationSpeedFactor:N,genre:F};this.setInCache(r,{processedData:P}),this.latestProcessedData=P,this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] Processed music data:",{baseTempo:m,enhancedBPM:s,mood:I,energy:C.toFixed(2),visualIntensity:G.toFixed(2)}),this.notifySubscribers(P,t,e),p.emitSync("music:beat",{bpm:P.enhancedBPM,intensity:P.visualIntensity,timestamp:performance.now(),confidence:.8}),p.emitSync("music:energy",{energy:P.energy||.5,valence:P.valence||.5,tempo:P.enhancedBPM,timestamp:performance.now()}),p.emitSync("performance:frame",{deltaTime:16,fps:60,memoryUsage:performance.memory?.usedJSHeapSize||0,timestamp:performance.now()}),this.config.enableDebug&&console.log("[MusicSyncService] Successfully processed audio features.",{baseTempo:m,enhancedBPM:s,mood:I,energy:C.toFixed(2),visualIntensity:G.toFixed(2)})}catch(n){console.error("[MusicSyncService] Processing failed:",n),this.metrics.errors++;let s=this.getFallbackProcessedData(e);this.latestProcessedData=s,this.notifySubscribers(s,null,e)}}async processSongUpdate(t=!1){let i=Be()?.Player?.data?.item?.uri;if(i&&!(!t&&i===this.currentTrackUri)){if(this.songChangeDebounceTimer&&clearTimeout(this.songChangeDebounceTimer),t){await this._processSongUpdateInternal(i);return}this.songChangeDebounceTimer=setTimeout(async()=>{this.songChangeDebounceTimer=null,await this._processSongUpdateInternal(i)},j.synchronization.debounceRapidChanges)}}async _processSongUpdateInternal(t){if(this.eventProcessingState.isProcessingEvent){this.config.enableDebug&&console.warn("\u{1F504} [MusicSyncService] Already processing song update - skipping to prevent recursion");return}if(this.eventProcessingState.isProcessingEvent=!0,this.eventProcessingState.lastEventTime=Date.now(),this.eventProcessingState.consecutiveEvents++,this.eventProcessingState.eventChain.push("_processSongUpdateInternal"),this.eventProcessingState.consecutiveEvents>this.MAX_CONSECUTIVE_EVENTS){console.error("\u{1F504} [MusicSyncService] CRITICAL: Too many consecutive events - circuit breaker activated",{consecutiveEvents:this.eventProcessingState.consecutiveEvents,eventChain:this.eventProcessingState.eventChain}),this._resetEventProcessingState();return}let e=setTimeout(()=>{this.config.enableDebug&&console.warn("\u{1F504} [MusicSyncService] Event processing timeout - resetting state"),this._resetEventProcessingState()},this.EVENT_RESET_TIMEOUT);try{console.log("\u{1F3B5} [MusicSyncService] \u2550\u2550\u2550 PROCESSING SONG UPDATE \u2550\u2550\u2550"),console.log("\u{1F3B5} [MusicSyncService] Track URI:",t),this.invalidateTrackCaches(t);let r=Be()?.Player?.data?.item?.duration||0;console.log("\u{1F3B5} [MusicSyncService] Fetching audio features and extracting colors...");let a=await Promise.allSettled([this.getAudioFeatures(),this.robustColorExtraction(t)]);console.log("\u{1F3B5} [MusicSyncService] Extraction results:",{audioFeaturesSuccess:a[0].status==="fulfilled",colorExtractionSuccess:a[1].status==="fulfilled"});let n=a[0].status==="fulfilled"?a[0].value:null,s=a[1].status==="fulfilled"?a[1].value:null;if(a[0].status==="rejected"&&this.config.enableDebug&&console.warn("[MusicSyncService] Audio features retrieval failed, continuing without music analysis:",a[0].reason),a[1].status==="rejected"&&this.config.enableDebug&&console.warn("[MusicSyncService] Color extraction failed, continuing without color processing:",a[1].reason),this.config.enableDebug){let g=(n?1:0)+(s?1:0);g===1?console.log(`[MusicSyncService] Graceful degradation: Continuing with ${n?"audio features only":"color extraction only"}`):g===2?console.log("[MusicSyncService] Full feature extraction successful"):console.warn("[MusicSyncService] Both strategies failed, will use fallback data")}console.log("\u{1F3A8} [MusicSyncService] Raw colors BEFORE sanitization:",{rawColors:s,rawColorType:typeof s,rawColorKeys:s?Object.keys(s):[],rawColorEntries:s?Object.entries(s):[]});let l=this.utils.sanitizeColorMap(s||{});console.log("\u{1F3A8} [MusicSyncService] Colors AFTER sanitization:",{sanitizedColors:l,sanitizedColorType:typeof l,sanitizedColorKeys:Object.keys(l),sanitizedColorEntries:Object.entries(l),colorCount:Object.keys(l).length,droppedCount:s?Object.keys(s).length-Object.keys(l).length:0}),this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Color extraction debug:",{trackUri:t,rawColorsReceived:s,sanitizedColors:l,colorCount:Object.keys(l).length,colorExtractorFailed:a[1].status==="rejected"});let c=l,m=!1;if(Object.keys(l).length>0)try{c=await this.enhanceExtractedColorsWithOKLAB(l,n),this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Successfully enhanced extracted colors with OKLAB processing")}catch(g){this.config.enableDebug&&console.warn("\u{1F3A8} [MusicSyncService] OKLAB enhancement failed, using original extracted colors:",g),c=l}if(Object.keys(l).length===0)try{c=await this.createOKLABEnhancedFallbackColors(n),m=!0,this.config.enableDebug&&console.warn("\u{1F3A8} [MusicSyncService] Color extraction failed, using OKLAB-enhanced Catppuccin fallback colors with emotional context")}catch(g){this.config.enableDebug&&console.warn("\u{1F3A8} [MusicSyncService] OKLAB fallback processing failed, using static fallback colors:",g),c={VIBRANT:"#f2cdcd",DARK_VIBRANT:"#cba6f7",LIGHT_VIBRANT:"#f5c2e7",PROMINENT:"#cba6f7",VIBRANT_NON_ALARMING:"#f2cdcd",DESATURATED:"#9399b2"},m=!0}let d={rawColors:c,trackUri:t,timestamp:Date.now(),colorHarmonyMode:this.config.currentColorHarmonyMode||"catppuccin",harmonicMode:this.config.currentColorHarmonyMode||"catppuccin",musicData:n?{energy:n.energy,valence:n.valence,tempo:n.tempo,genre:this.genreProfileManager.detectGenre(n)}:void 0,performanceHints:{preferLightweight:!1,enableAdvancedBlending:!0,maxProcessingTime:100}};console.log("\u{1F3A8} [MusicSyncService] FINAL colors before event emission:",{finalColors:c,finalColorKeys:Object.keys(c),finalColorEntries:Object.entries(c),usingFallback:m,extractionFailed:Object.keys(l).length===0});let h={rawColors:d.rawColors,trackUri:d.trackUri,timestamp:Date.now()};if(d.musicData&&(h.musicData=d.musicData),console.log("\u{1F3B5} [MusicSyncService] \u2550\u2550\u2550 EMITTING 'colors:extracted' EVENT \u2550\u2550\u2550"),console.log("\u{1F3B5} [MusicSyncService] Event data:",{trackUri:h.trackUri,rawColorKeys:h.rawColors?Object.keys(h.rawColors):[],rawColorCount:h.rawColors?Object.keys(h.rawColors).length:0,hasMusicData:!!h.musicData,timestamp:h.timestamp}),console.log("\u{1F3B5} [MusicSyncService] Raw colors being sent:",h.rawColors),console.log("\u{1F3B5} [MusicSyncService] Broadcasting to event bus..."),p.emitSync("colors:extracted",h),console.log("\u{1F3B5} [MusicSyncService] \u2705 Event emitted to bus"),this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] Emitted colors:extracted event for strategy processing",{trackUri:t,colorCount:Object.keys(c).length,usingFallback:m,extractionFailed:Object.keys(l).length===0}),n){let g=this.convertFeaturesToAudioData(n);await this.processAudioFeatures(g,t,r)}(async()=>{let g=await this.fetchAudioData();this.isValidAudioData(g)&&await this.processAudioFeatures(g,t,r)})()}catch(i){console.error(`[MusicSyncService] Error processing song update for ${t}:`,i),this.metrics.errors++}finally{clearTimeout(e),this._resetEventProcessingState();let i=this.eventProcessingState.eventChain.indexOf("_processSongUpdateInternal");i>-1&&this.eventProcessingState.eventChain.splice(i,1)}}_resetEventProcessingState(){this.eventProcessingState.isProcessingEvent=!1,this.eventProcessingState.eventChain=[];let e=Date.now()-this.eventProcessingState.lastEventTime;if(e>this.EVENT_RESET_TIMEOUT)this.eventProcessingState.consecutiveEvents=0;else{let i=Math.min(1,e/this.EVENT_RESET_TIMEOUT);this.eventProcessingState.consecutiveEvents=Math.floor(this.eventProcessingState.consecutiveEvents*(1-i))}this.config.enableDebug&&this.eventProcessingState.consecutiveEvents>0&&console.log("\u{1F504} [MusicSyncService] Event processing state reset",{consecutiveEvents:this.eventProcessingState.consecutiveEvents,timeSinceLastEvent:e})}setupCacheManagement(){this.cacheCleanupInterval=setInterval(()=>{let t=Date.now();for(let[e,i]of this.unifiedCache.entries())t-i.timestamp>this.cacheTTL&&this.unifiedCache.delete(e)},this.cacheTTL)}setupPerformanceMonitoring(){this.performanceInterval=setInterval(()=>{if(this.metrics.performance.length>0){let t=this.metrics.performance.reduce((e,i)=>e+i,0)/this.metrics.performance.length;this.metrics.avgProcessingTime=t,this.metrics.performance=[]}},6e4)}loadUserPreferences(){try{return{enableMusicSync:!0,audioAnalysisQuality:E.get("sn-webgl-quality")||"medium",gradientIntensity:E.get("sn-gradient-intensity")||"balanced",artisticMode:E.get("sn-artistic-mode")||"artist-vision"}}catch{return{enableMusicSync:!0,audioAnalysisQuality:"medium",gradientIntensity:"balanced",artisticMode:"artist-vision"}}}saveUserPreferences(){try{this.config.enableDebug&&console.log("[MusicSyncService] User preferences updated via settings system")}catch(t){this.config.enableDebug&&console.warn("[MusicSyncService] Could not save user preferences:",t)}}updateConfiguration(t){let e={...j};Object.assign(j,t),this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] Configuration updated",{from:e,to:j}),this.cacheTTL=j.performance.cacheTTL,e.performance.enableMetrics!==j.performance.enableMetrics&&(j.performance.enableMetrics?this.setupPerformanceMonitoring():this.performanceInterval&&(clearInterval(this.performanceInterval),this.performanceInterval=null))}destroy(){this.songChangeDebounceTimer&&(clearTimeout(this.songChangeDebounceTimer),this.songChangeDebounceTimer=null),this.stopBeatScheduler(),this.performanceInterval&&clearInterval(this.performanceInterval),this.cacheCleanupInterval&&clearInterval(this.cacheCleanupInterval),this.subscribers.clear(),this.unifiedCache.clear(),this.isInitialized=!1,this.latestProcessedData=null,this.metrics={bpmCalculations:0,beatSyncs:0,cacheHits:0,cacheMisses:0,avgProcessingTime:0,performance:[],errors:0,updates:0},this.cacheCleanupInterval=null}setColorHarmonyEngine(t){this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] setColorHarmonyEngine called - now using event-driven pattern instead of direct dependency.")}getLatestProcessedData(){return this.latestProcessedData}getCurrentBeatVector(){return{...this.currentBeatVector}}stopBeatScheduler(){this.beatSchedulerTimer&&(clearTimeout(this.beatSchedulerTimer),this.beatSchedulerTimer=null)}triggerBeatEvent(){let e=this.nextBeatIndex*.61803398875%1*Math.PI*2;if(this.currentBeatVector={x:Math.cos(e),y:Math.sin(e)},this.latestProcessedData){let i={...this.latestProcessedData,beatOccurred:!0,beatVector:this.currentBeatVector};this.notifySubscribers(i,null,this.currentTrackUri)}this.nextBeatIndex++,this.scheduleNextBeatEvent()}scheduleNextBeatEvent(){if(this.nextBeatIndex>=this.currentSongBeats.length)return;let t=this.currentSongBeats[this.nextBeatIndex];if(!t)return;let e=Date.now()-this.songStartTimestamp,i=t.start*1e3-e;i>=0?this.beatSchedulerTimer=setTimeout(()=>this.triggerBeatEvent(),i):(this.nextBeatIndex++,this.scheduleNextBeatEvent())}isValidAudioData(t){return!!t&&typeof t.tempo=="number"&&t.tempo>0}invalidateTrackCaches(t){if(t)for(let e of this.unifiedCache.keys())e.includes(t)&&this.unifiedCache.delete(e)}convertFeaturesToAudioData(t){let e=j.musicVisualSync.enhancedBPM.fallbacks;return{tempo:t.tempo,energy:t.energy,valence:t.valence,loudness:e.loudness,key:e.key,time_signature:e.timeSignature,danceability:t.danceability,acousticness:t.acousticness,instrumentalness:t.instrumentalness,speechiness:0,liveness:0,mode:0}}convertSpicetifyToAudioData(t){return{tempo:t.tempo,energy:t.energy,valence:t.valence,loudness:t.loudness,key:t.key,time_signature:t.time_signature||t.timeSignature,danceability:t.danceability,acousticness:t.acousticness,instrumentalness:t.instrumentalness,speechiness:t.speechiness,liveness:t.liveness,mode:t.mode}}async robustColorExtraction(t,e=3){console.log("\u{1F3A8} [MusicSyncService] Starting robust color extraction:",{trackUri:t,maxRetries:e,timestamp:Date.now()});for(let i=1;i<=e;i++)try{if(!t)return console.warn("\u{1F3A8} [MusicSyncService] Empty trackUri provided to color extraction"),null;console.log(`\u{1F3A8} [MusicSyncService] Calling Spicetify.colorExtractor (attempt ${i})...`);let r=Be();if(!r?.colorExtractor)throw new Error("colorExtractor not available");let a=await r.colorExtractor(t);if(console.log(`\u{1F3A8} [MusicSyncService] Raw color extraction result (attempt ${i}):`,{trackUri:t,success:!!a,colorsType:typeof a,colorsIsNull:a===null,colorsIsUndefined:a===void 0,colorCount:a?Object.keys(a).length:0,rawColors:a,colorKeys:a?Object.keys(a):[],colorValues:a?Object.values(a):[]}),a&&typeof a=="object"&&Object.keys(a).length>0)return Object.entries(a).forEach(([n,s])=>{console.log(`\u{1F3A8} [MusicSyncService] Extracted color: ${n} = ${s}`)}),a;console.warn(`\u{1F3A8} [MusicSyncService] Color extraction returned empty/invalid data on attempt ${i}`)}catch(r){if(console.error(`\u{1F3A8} [MusicSyncService] Color extraction attempt ${i} failed with error:`,r,{errorMessage:r instanceof Error?r.message:String(r),errorStack:r instanceof Error?r.stack:void 0}),i<e){let a=100*i;console.log(`\u{1F3A8} [MusicSyncService] Waiting ${a}ms before retry...`),await new Promise(n=>setTimeout(n,a))}}return console.error(`\u{1F3A8} [MusicSyncService] CRITICAL: All color extraction attempts failed for ${t}`),null}updateMetrics(t){this.latestProcessedData=t}getCurrentMusicState(){return!this.latestProcessedData||!this.audioData?null:{emotion:this.latestProcessedData.emotion||null,beat:{tempo:this.latestProcessedData.bpm||this.audioData.tempo||120,energy:this.latestProcessedData.energy||this.audioData.energy||.5,timestamp:Date.now()},intensity:this.latestProcessedData.intensity||this.audioData.energy||.5}}async healthCheck(){try{let t=ht.isAvailable(),e=this.subscribers.size>0,i=this.latestProcessedData!==null,r=this.metrics.bpmCalculations+this.metrics.beatSyncs+this.metrics.cacheHits+this.metrics.cacheMisses,a=r>0?this.metrics.errors/r:0;return this.isInitialized?t?a>.5?{status:"degraded",message:`High error rate detected: ${(a*100).toFixed(1)}%`,details:{initialized:this.isInitialized,spicetifyAvailable:t,subscribers:e,recentData:i,errorRate:a,errors:this.metrics.errors,totalOperations:r}}:{status:"healthy",message:"Music sync service operational",details:{initialized:this.isInitialized,spicetifyAvailable:t,subscribers:e,subscriberCount:this.subscribers.size,recentData:i,errorRate:a,bpmCalculations:this.metrics.bpmCalculations,beatSyncs:this.metrics.beatSyncs,cacheHits:this.metrics.cacheHits,cacheMisses:this.metrics.cacheMisses,avgProcessingTime:this.metrics.avgProcessingTime,errors:this.metrics.errors,updates:this.metrics.updates}}:{status:"degraded",message:"Spicetify audio data API not available - running in limited mode",details:{initialized:this.isInitialized,spicetifyAvailable:t,subscribers:e,recentData:i,errorRate:a}}:{status:"critical",message:"System not initialized",details:{initialized:this.isInitialized,spicetifyAvailable:t}}}catch(t){return{status:"critical",message:`Health check failed: ${t instanceof Error?t.message:"Unknown error"}`,details:{error:t instanceof Error?t.message:"Unknown error"}}}}}});var pi,Yn=v(()=>{"use strict";pi=class{constructor(t={}){this._timerRegistry=new Map;this._timerMasterInterval=null;this.config={timerIntervalMs:t.timerIntervalMs||50,maxTimerBudget:t.maxTimerBudget||10,enableDebug:t.enableDebug||!1,...t},this._timerPerformanceMetrics={totalExecutions:0,totalTime:0,maxExecutionTime:0,averageExecutionTime:0,skippedTimers:0,timerCallbacks:new Map},this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Initialized")}initialize(){this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Timer consolidation initialized")}registerConsolidatedTimer(t,e,i,r="normal"){if(this._timerRegistry.has(t)){console.warn(`[TimerConsolidationSystem] Timer ${t} already registered`);return}let a={callback:e,intervalMs:i,priority:r,lastExecution:0,enabled:!0,executionCount:0,totalExecutionTime:0,maxExecutionTime:0,skippedExecutions:0};this._timerRegistry.set(t,a),this._timerPerformanceMetrics.timerCallbacks.set(t,{calls:0,totalTime:0,maxTime:0}),this.config.enableDebug&&console.log(`\u23F1\uFE0F [TimerConsolidationSystem] Registered timer: ${t} (${i}ms, ${r} priority)`),this._timerRegistry.size===1&&!this._timerMasterInterval&&this._startMasterTimer()}unregisterConsolidatedTimer(t){this._timerRegistry.has(t)&&(this._timerRegistry.delete(t),this._timerPerformanceMetrics.timerCallbacks.delete(t),this.config.enableDebug&&console.log(`\u23F1\uFE0F [TimerConsolidationSystem] Unregistered timer: ${t}`),this._timerRegistry.size===0&&this._stopMasterTimer())}_startMasterTimer(){this._timerMasterInterval||(this._timerMasterInterval=setInterval(()=>{this._executeMasterTimerFrame()},this.config.timerIntervalMs),this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Master timer started"))}_stopMasterTimer(){this._timerMasterInterval&&(clearInterval(this._timerMasterInterval),this._timerMasterInterval=null),this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Master timer stopped")}_executeMasterTimerFrame(){let t=performance.now(),e=this.config.maxTimerBudget,i=Array.from(this._timerRegistry.entries()).sort(([,a],[,n])=>{let s={critical:0,normal:1,background:2};return s[a.priority]-s[n.priority]});for(let[a,n]of i){if(!n.enabled||e<=0&&n.priority==="background"){e<=0&&n.skippedExecutions++;continue}if(t-n.lastExecution<n.intervalMs)continue;let l=performance.now();try{n.callback();let c=performance.now()-l;n.executionCount++,n.totalExecutionTime+=c,n.maxExecutionTime=Math.max(n.maxExecutionTime,c),n.lastExecution=t;let m=this._timerPerformanceMetrics.timerCallbacks.get(a);m&&(m.calls++,m.totalTime+=c,m.maxTime=Math.max(m.maxTime,c)),e-=c}catch(c){console.error(`[TimerConsolidationSystem] Error in timer ${a}:`,c),n.enabled=!1}}let r=performance.now()-t;this._updateTimerPerformanceMetrics(r)}_updateTimerPerformanceMetrics(t){let e=this._timerPerformanceMetrics;e.totalExecutions++,e.totalTime+=t,e.maxExecutionTime=Math.max(e.maxExecutionTime,t),e.averageExecutionTime=e.totalTime/e.totalExecutions,t>this.config.maxTimerBudget&&e.skippedTimers++}destroy(){this._stopMasterTimer(),this._timerRegistry.clear(),this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Destroyed")}}});var Ae,et,ea=v(()=>{"use strict";_();Ae=class Ae{constructor(t,e){this.performanceAnalyzer=null;this.subsystemMetrics=new Map;this.optimizationStrategies=new Map;this.adaptiveOptimizationEnabled=!1;this.optimizationInterval=null;this.activeIssues=new Map;this.issueHistory=[];this.lastHealthCheck=0;this.healthCheckInterval=null;this.HEALTH_CHECK_INTERVAL=5e3;this.batteryState=null;this.frameTimeHistory=[];this.memoryUsageHistory=[];this.lastOptimizationTime=0;this.optimizationCooldown=5e3;this.PERFORMANCE_THRESHOLDS={frameTime:{warning:16.67,critical:33.33},memoryUsage:{warning:50*1024*1024,critical:100*1024*1024},cpuUsage:{warning:15,critical:30},fps:{warning:50,critical:30}};this.PERFORMANCE_MODES={battery:{name:"battery",qualityLevel:.4,animationQuality:.3,effectQuality:.2,blurQuality:.3,shadowQuality:.2,frameRate:30,optimizationLevel:3},balanced:{name:"balanced",qualityLevel:.8,animationQuality:.8,effectQuality:.7,blurQuality:.8,shadowQuality:.7,frameRate:60,optimizationLevel:1},performance:{name:"performance",qualityLevel:1,animationQuality:1,effectQuality:1,blurQuality:1,shadowQuality:1,frameRate:60,optimizationLevel:0},auto:{name:"auto",qualityLevel:.8,animationQuality:.8,effectQuality:.8,blurQuality:.8,shadowQuality:.8,frameRate:60,optimizationLevel:1}};this.config=t,this.performanceAnalyzer=e||null,this.eventBus=p,this.initializeDeviceCapabilities(),this.initializeThermalMonitoring(),this.initializeBatteryMonitoring(),this.currentPerformanceMode=this.PERFORMANCE_MODES.auto,this.initializeDefaultStrategies(),this.startHealthMonitoring(),this.subscribeToEvents(),this.config.enableDebug&&console.log("[PerformanceAnalyzer] Initialized with enhanced device capabilities, thermal monitoring, and battery optimization")}static getInstance(t,e){if(!Ae.instance){if(!t||!e)throw new Error("PerformanceAnalyzer requires config and performanceAnalyzer for first initialization");Ae.instance=new Ae(t,e)}return Ae.instance}trackSubsystem(t,e){let i=performance.now(),a={...this.subsystemMetrics.get(t)||{name:t,frameTime:0,memoryUsage:0,cpuUsage:0,fps:60,lastUpdate:i,status:"healthy",issues:[]},...e,lastUpdate:i};a.status=this.calculateHealthStatus(a),this.updateSubsystemIssues(a),this.subsystemMetrics.set(t,a),this.performanceAnalyzer&&(this.performanceAnalyzer.recordMetric?.(`subsystem_${t}_frame_time`,a.frameTime),this.performanceAnalyzer.recordMetric?.(`subsystem_${t}_memory`,a.memoryUsage),this.performanceAnalyzer.recordMetric?.(`subsystem_${t}_fps`,a.fps)),this.adaptiveOptimizationEnabled&&a.status!=="healthy"&&this.checkAndTriggerOptimization(a),this.config.enableDebug&&a.status!=="healthy"&&console.warn(`[PerformanceAnalyzer] Subsystem ${t} status: ${a.status}`,a)}getSystemHealth(){let t=performance.now(),e=new Map(this.subsystemMetrics),i=0,r=0,a=0;for(let d of e.values())switch(d.status){case"healthy":i++;break;case"warning":r++;break;case"critical":a++;break}let n=e.size,s="healthy";a>0?s="critical":r>0&&(s="warning");let l=this.calculatePerformanceScore(e),c=this.generateRecommendations(e),m={overall:s,totalSubsystems:n,healthySubsystems:i,warningSubsystems:r,criticalSubsystems:a,subsystems:e,recommendations:c,performanceScore:l,lastUpdate:t};return this.lastHealthCheck=t,m}startMonitoring(){this.enableAdaptiveOptimization(),this.healthCheckInterval||this.startHealthMonitoring(),this.config.enableDebug&&console.log("[PerformanceAnalyzer] Monitoring started")}enableAdaptiveOptimization(){this.adaptiveOptimizationEnabled||(this.adaptiveOptimizationEnabled=!0,this.optimizationInterval=setInterval(()=>{this.performOptimizationCheck()},2e3),this.config.enableDebug&&console.log("[PerformanceAnalyzer] Adaptive optimization enabled"))}disableAdaptiveOptimization(){this.adaptiveOptimizationEnabled&&(this.adaptiveOptimizationEnabled=!1,this.optimizationInterval&&(clearInterval(this.optimizationInterval),this.optimizationInterval=null),this.config.enableDebug&&console.log("[PerformanceAnalyzer] Adaptive optimization disabled"))}registerOptimizationStrategy(t){this.optimizationStrategies.set(t.name,t),this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Registered optimization strategy: ${t.name}`)}triggerOptimization(t){this.activeIssues.set(`${t.subsystem}:${t.type}`,t),this.issueHistory.push(t),this.issueHistory.length>100&&this.issueHistory.shift();let e=Array.from(this.optimizationStrategies.values()).filter(i=>i.subsystem===t.subsystem||i.subsystem==="*").sort((i,r)=>r.priority-i.priority);for(let i of e){let r=this.subsystemMetrics.get(t.subsystem);if(r&&i.condition(r))try{i.action(r),this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Applied optimization strategy: ${i.name} for ${t.subsystem}`);break}catch(a){console.error(`[PerformanceAnalyzer] Error applying optimization strategy ${i.name}:`,a)}}}getMetrics(){return{subsystems:new Map(this.subsystemMetrics),issues:new Map(this.activeIssues),strategies:new Map(this.optimizationStrategies),adaptiveOptimizationEnabled:this.adaptiveOptimizationEnabled}}destroy(){this.disableAdaptiveOptimization(),this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.subsystemMetrics.clear(),this.optimizationStrategies.clear(),this.activeIssues.clear(),this.issueHistory=[],Ae.instance===this&&(Ae.instance=null),this.config.enableDebug&&console.log("[PerformanceAnalyzer] Destroyed")}initializeDefaultStrategies(){this.registerOptimizationStrategy({name:"memory-cleanup",type:"memory_cleanup",priority:100,subsystem:"*",description:"Trigger garbage collection and memory cleanup",condition:t=>t.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.warning,action:t=>{}}),this.registerOptimizationStrategy({name:"fps-optimization",type:"reduce_quality",priority:80,subsystem:"*",description:"Reduce quality settings to improve FPS",condition:t=>t.fps<this.PERFORMANCE_THRESHOLDS.fps.warning,action:t=>{}}),this.registerOptimizationStrategy({name:"cpu-throttling",type:"throttle_updates",priority:70,subsystem:"*",description:"Throttle update frequency to reduce CPU usage",condition:t=>t.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.warning,action:t=>{}})}calculateHealthStatus(t){let e=[];return t.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.critical?e.push("critical-frame-time"):t.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.warning&&e.push("warning-frame-time"),t.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.critical?e.push("critical-memory"):t.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.warning&&e.push("warning-memory"),t.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.critical?e.push("critical-cpu"):t.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.warning&&e.push("warning-cpu"),t.fps<this.PERFORMANCE_THRESHOLDS.fps.critical?e.push("critical-fps"):t.fps<this.PERFORMANCE_THRESHOLDS.fps.warning&&e.push("warning-fps"),t.issues=e,e.some(i=>i.startsWith("critical"))?"critical":e.some(i=>i.startsWith("warning"))?"warning":"healthy"}updateSubsystemIssues(t){let e=`${t.name}:performance`;if(t.status==="healthy"){if(this.activeIssues.has(e)){let i=this.activeIssues.get(e);i.resolved=!0,this.activeIssues.delete(e)}}else{let i={type:"render",severity:t.status==="critical"?"critical":"medium",subsystem:t.name,message:`Performance degradation detected: ${t.issues.join(", ")}`,timestamp:Date.now(),resolved:!1};this.activeIssues.set(e,i)}}checkAndTriggerOptimization(t){let e=`${t.name}:performance`,i=this.activeIssues.get(e);i&&!i.resolved&&this.triggerOptimization(i)}performOptimizationCheck(){let t=performance.now();for(let[e,i]of this.subsystemMetrics)t-i.lastUpdate>1e4||i.status!=="healthy"&&this.checkAndTriggerOptimization(i)}calculatePerformanceScore(t){if(t.size===0)return 100;let e=0;for(let i of t.values()){let r=100;i.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.warning&&(r-=20),i.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.critical&&(r-=30),i.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.warning&&(r-=15),i.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.critical&&(r-=25),i.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.warning&&(r-=10),i.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.critical&&(r-=20),i.fps<this.PERFORMANCE_THRESHOLDS.fps.warning&&(r-=15),i.fps<this.PERFORMANCE_THRESHOLDS.fps.critical&&(r-=25),e+=Math.max(0,r)}return Math.round(e/t.size)}generateRecommendations(t){let e=[],i=Array.from(t.values()).flatMap(a=>a.issues),r=new Map;for(let a of i)r.set(a,(r.get(a)||0)+1);for(let[a,n]of r)if(n>=2)switch(a){case"critical-frame-time":case"warning-frame-time":e.push("Consider reducing animation quality or frequency");break;case"critical-memory":case"warning-memory":e.push("Memory cleanup needed - consider reducing cache sizes");break;case"critical-cpu":case"warning-cpu":e.push("High CPU usage detected - consider throttling updates");break;case"critical-fps":case"warning-fps":e.push("Low FPS detected - consider disabling non-essential effects");break}return e.length===0&&e.push("System performance is optimal"),e}startHealthMonitoring(){this.healthCheckInterval=setInterval(()=>{this.getSystemHealth()},this.HEALTH_CHECK_INTERVAL)}subscribeToEvents(){}initializeDeviceCapabilities(){let t=navigator,e=performance.memory,i=document.createElement("canvas"),r=i.getContext("webgl2")||i.getContext("webgl"),a=2048;r&&(a=r.getParameter(r.MAX_TEXTURE_SIZE)||2048);let n=e?Math.round(e.jsHeapSizeLimit/(1024*1024*1024)):4,s="medium";n>=8&&t.hardwareConcurrency>=8&&a>=4096?s="premium":n>=4&&t.hardwareConcurrency>=4?s="high":n>=2&&t.hardwareConcurrency>=2?s="medium":s="low",this.deviceCapabilities={performanceTier:s,memoryGB:n,cpuCores:t.hardwareConcurrency||4,gpuAcceleration:!!r,isMobile:/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(t.userAgent),supportsWebGL:!!r,supportsBackdropFilter:CSS.supports("backdrop-filter","blur(10px)"),maxTextureSize:a,devicePixelRatio:window.devicePixelRatio||1},this.config.enableDebug&&console.log("[PerformanceAnalyzer] Device capabilities detected:",this.deviceCapabilities)}initializeThermalMonitoring(){this.thermalState={temperature:"normal",throttleLevel:0,cpuUsage:0,gpuUsage:0,memoryUsage:0},setInterval(()=>{this.updateThermalState()},1e4)}async initializeBatteryMonitoring(){try{let t=navigator;if("getBattery"in t){let e=await t.getBattery();this.batteryState={level:e.level,charging:e.charging,chargingTime:e.chargingTime,dischargingTime:e.dischargingTime},e.addEventListener("levelchange",()=>{this.batteryState&&(this.batteryState.level=e.level,this.adjustPerformanceModeForBattery())}),e.addEventListener("chargingchange",()=>{this.batteryState&&(this.batteryState.charging=e.charging,this.adjustPerformanceModeForBattery())}),this.config.enableDebug&&console.log("[PerformanceAnalyzer] Battery monitoring initialized")}}catch{this.config.enableDebug&&console.log("[PerformanceAnalyzer] Battery API not available")}}updateThermalState(){let t=this.performanceAnalyzer?.getMedianFPS?.()||60,e=performance.memory,i=e?e.usedJSHeapSize/e.jsHeapSizeLimit:0,r="normal",a=0;t<30||i>.9?(r="critical",a=.8):t<45||i>.7?(r="hot",a=.4):(t<55||i>.5)&&(r="warm",a=.2),this.thermalState={temperature:r,throttleLevel:a,cpuUsage:Math.min(1-t/60,1),gpuUsage:0,memoryUsage:i},r==="critical"&&this.currentPerformanceMode.name!=="battery"?this.setPerformanceMode("battery"):r==="normal"&&this.currentPerformanceMode.name==="battery"&&this.setPerformanceMode("auto")}adjustPerformanceModeForBattery(){this.batteryState&&(!this.batteryState.charging&&this.batteryState.level<.2?this.setPerformanceMode("battery"):this.batteryState.charging&&this.currentPerformanceMode.name==="battery"&&this.setPerformanceMode("auto"))}setPerformanceMode(t){let e=this.PERFORMANCE_MODES[t];e&&(this.currentPerformanceMode=e,this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Performance mode changed to: ${t}`))}getDeviceCapabilities(){return{...this.deviceCapabilities}}getThermalState(){return{...this.thermalState}}getBatteryState(){return this.batteryState?{...this.batteryState}:null}getCurrentPerformanceMode(){return{...this.currentPerformanceMode}}emitTrace(t,e){this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Trace: ${t}`,e)}recordMetric(t,e){let i=t.match(/^subsystem_(.+)_(.+)$/);if(i&&i.length>=3){let r=i[1]||"unknown",a=i[2]||"unknown",n=this.subsystemMetrics.get(r)||{name:r,frameTime:0,memoryUsage:0,cpuUsage:0,fps:60,lastUpdate:performance.now(),status:"healthy",issues:[]};switch(a){case"frame_time":n.frameTime=e;break;case"memory":n.memoryUsage=e;break;case"fps":n.fps=e;break;case"cpu":n.cpuUsage=e;break}this.trackSubsystem(r,n)}this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Metric: ${t}=${e}`)}getMedianFPS(){let t=Array.from(this.subsystemMetrics.values()).map(i=>i.fps);if(t.length>0){t.sort((r,a)=>r-a);let i=Math.floor(t.length/2);return t.length%2===0?((t[i-1]||0)+(t[i]||0))/2:t[i]||0}switch(this.deviceCapabilities.performanceTier){case"premium":return 60;case"high":return 60;case"medium":return 50;case"low":return 30;default:return 30}}calculateHealthScore(){return this.getSystemHealth().performanceScore/100}shouldReduceQuality(){let t=this.deviceCapabilities.performanceTier,e=this.thermalState.temperature,i=this.calculateHealthScore();return t==="low"||e==="hot"||e==="critical"||i<.5}timeOperation(t,e){let i=performance.now(),r=e(),a=performance.now()-i;return this.recordMetric(`operation_${t}_duration`,a),this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Operation ${t}: ${a.toFixed(2)}ms`),r}async timeOperationAsync(t,e){let i=performance.now(),r=await e(),a=performance.now()-i;return this.recordMetric(`async_operation_${t}_duration`,a),this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Async operation ${t}: ${a.toFixed(2)}ms`),r}getAverageTime(t){switch(this.deviceCapabilities.performanceTier){case"premium":return 3;case"high":return 5;case"medium":return 15;case"low":return 30;default:return 15}}updateBudget(t,e){this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Budget update ignored: ${t}=${e} (using adaptive optimization instead)`)}startTiming(t){let e=`${t}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Timing started: ${t} (${e})`),e}endTiming(t,e){this.config.enableDebug&&console.log(`[PerformanceAnalyzer] Timing ended: ${t}`,e)}getWebGLStatus(){let t=this.deviceCapabilities.supportsWebGL,e=this.deviceCapabilities.performanceTier;if(!t)return{state:"disabled",quality:"low",enabled:!1};let i="medium";return e==="premium"||e==="high"?i=this.thermalState.temperature==="normal"?"high":"medium":(e==="low"||this.thermalState.temperature==="critical")&&(i="low"),{state:"webgl-active",quality:i,enabled:!0}}getPerformanceSummary(){let t=this.getWebGLStatus(),e=this.getSystemHealth(),i=this.deviceCapabilities.performanceTier==="premium"?"high":this.deviceCapabilities.performanceTier,r=`${this.deviceCapabilities.memoryGB}GB RAM, ${this.deviceCapabilities.cpuCores} cores, ${this.deviceCapabilities.supportsWebGL?"WebGL":"No WebGL"}${this.deviceCapabilities.isMobile?", Mobile":""}`,a=e.performanceScore/100,n=[];n.push(`Device tier: ${i} (${this.deviceCapabilities.performanceTier})`),n.push(`Memory: ${this.deviceCapabilities.memoryGB}GB`),n.push(`CPU cores: ${this.deviceCapabilities.cpuCores}`),this.deviceCapabilities.supportsWebGL&&n.push(`WebGL supported (${this.deviceCapabilities.maxTextureSize}px max texture)`),this.thermalState.temperature!=="normal"&&n.push(`Thermal state: ${this.thermalState.temperature}`);let s=this.currentPerformanceMode.name==="performance"&&this.thermalState.temperature==="normal"&&(this.batteryState?.charging||(this.batteryState?.level||0)>.5||!this.batteryState);return{deviceTier:i,deviceDescription:r,confidence:a,reasoning:n,webglStatus:t,energyBoost:s,settings:this.currentPerformanceMode}}getDeviceTier(){return this.deviceCapabilities.performanceTier==="premium"?"high":this.deviceCapabilities.performanceTier}getDeviceDescription(){return`${this.deviceCapabilities.memoryGB}GB RAM, ${this.deviceCapabilities.cpuCores} cores, ${this.deviceCapabilities.supportsWebGL?"WebGL":"No WebGL"}${this.deviceCapabilities.isMobile?", Mobile":""}`}hasEnergyBoost(){return this.currentPerformanceMode.name==="performance"&&this.thermalState.temperature==="normal"&&(this.batteryState?.charging||(this.batteryState?.level||0)>.5||!this.batteryState)}getCurrentSettings(){return{performanceMode:this.currentPerformanceMode,deviceCapabilities:this.deviceCapabilities,thermalState:this.thermalState,batteryState:this.batteryState,webglStatus:this.getWebGLStatus()}}};Ae.instance=null;et=Ae});var Se,ta=v(()=>{"use strict";ea();B();R();Se=class{constructor(t,e){this.initialized=!1;typeof process<"u",this.config=w;try{this.unifiedCoordinator=et.getInstance(this.config,this)}catch{this.unifiedCoordinator=new et(this.config,this)}u?.debug?.log("SimplePerformanceCoordinator","High-level performance management - delegating to PerformanceAnalyzer")}async initialize(){this.initialized||(this.initialized=!0,u?.debug?.log("SimplePerformanceCoordinator","Compatibility layer initialized - delegating to PerformanceAnalyzer"))}async healthCheck(){if(!this.initialized)return{healthy:!1,details:"Not initialized",system:"SimplePerformanceCoordinator"};let t=this.unifiedCoordinator.getSystemHealth();return{healthy:t.overall==="healthy",details:t.overall==="healthy"?`Performance monitoring active (${t.totalSubsystems} subsystems)`:`Performance issues detected: ${t.recommendations.join(", ")}`,system:"SimplePerformanceCoordinator"}}destroy(){this.initialized=!1,u?.debug?.log("SimplePerformanceCoordinator","Compatibility layer destroyed")}updateAnimation(t){}getPerformanceSystem(){return this.unifiedCoordinator}getDeviceTier(){return this.unifiedCoordinator.getDeviceTier()}getDeviceDescription(){return this.unifiedCoordinator.getDeviceDescription()}hasEnergyBoost(){return this.unifiedCoordinator.hasEnergyBoost()}getCurrentSettings(){return this.unifiedCoordinator.getCurrentSettings()}getWebGLStatus(){return this.unifiedCoordinator.getWebGLStatus()}getPerformanceSummary(){return this.unifiedCoordinator.getPerformanceSummary()}getDeviceCapabilities(){return this.unifiedCoordinator.getDeviceCapabilities()}getCurrentPerformanceMode(){return this.unifiedCoordinator.getCurrentPerformanceMode()}getBatteryState(){return this.unifiedCoordinator.getBatteryState()}getThermalState(){return this.unifiedCoordinator.getThermalState()}startMonitoring(){this.unifiedCoordinator.startMonitoring(),u?.debug?.log("SimplePerformanceCoordinator","Monitoring started (delegated to PerformanceAnalyzer)")}emitTrace(t,e){return this.unifiedCoordinator.emitTrace(t,e)}recordMetric(t,e){return this.unifiedCoordinator.recordMetric(t,e)}getMedianFPS(){return this.unifiedCoordinator.getMedianFPS()}calculateHealthScore(){return this.unifiedCoordinator.calculateHealthScore()}shouldReduceQuality(){return this.unifiedCoordinator.shouldReduceQuality()}timeOperation(t,e){return this.unifiedCoordinator.timeOperation(t,e)}async timeOperationAsync(t,e){return this.unifiedCoordinator.timeOperationAsync(t,e)}getAverageTime(t){return this.unifiedCoordinator.getAverageTime(t)}updateBudget(t,e){return this.unifiedCoordinator.updateBudget(t,e)}startTiming(t){return this.unifiedCoordinator.startTiming(t)}endTiming(t,e){return this.unifiedCoordinator.endTiming(t,e)}}});var W,pe=v(()=>{"use strict";W=class{constructor(t={}){this.deviceCapabilities=null;this.isInitialized=!1;this.benchmarkCache=new Map;this.detectionStartTime=0;this.config={enableDebug:t.enableDebug||!1,runStressTests:t.runStressTests!==!1,spicetifyContext:t.spicetifyContext||this._detectSpicetifyContext(),...t},this.config.enableDebug&&console.log("\u{1F50D} [DeviceCapabilityDetector] Initialized",this.config.spicetifyContext?"(Spicetify-optimized)":"(Standard)")}_detectSpicetifyContext(){return!!window.Spicetify}async initialize(){if(this.isInitialized)return this.deviceCapabilities;this.detectionStartTime=performance.now(),this.config.enableDebug&&console.log("\u{1F50D} [DeviceCapabilityDetector] Starting enhanced capability detection...",this.config.spicetifyContext?"(Spicetify mode)":"(Standard mode)");let t=await this._analyzeMemoryCapabilities(),e=await this._analyzeCPUCapabilities(),i=await this._analyzeGPUCapabilities();this.deviceCapabilities={memory:t,cpu:e,gpu:i,browser:{supportsOffscreenCanvas:this._detectOffscreenCanvasSupport(),supportsWorkers:this._detectWorkerSupport(),supportsSharedArrayBuffer:this._detectSharedArrayBufferSupport(),supportsWASM:this._detectWASMSupport(),supportsCSSHoudini:this._detectCSSHoudiniSupport()},display:{pixelRatio:window.devicePixelRatio||1,refreshRate:await this._detectRefreshRate(),colorGamut:this._detectColorGamut(),contrastRatio:this._detectContrastCapability(),reducedMotion:this._detectReducedMotion()},network:{effectiveType:navigator.connection?.effectiveType||"unknown",downlink:navigator.connection?.downlink||0,rtt:navigator.connection?.rtt||0,saveData:navigator.connection?.saveData||!1},overall:"detecting",spicetifyProfile:await this._createSpicetifyProfile(t,e,i)},this.config.runStressTests&&(await this._runCapabilityTests(),this.deviceCapabilities.spicetifyProfile=await this._createSpicetifyProfile(this.deviceCapabilities.memory,this.deviceCapabilities.cpu,this.deviceCapabilities.gpu)),this.deviceCapabilities.overall=this._calculateOverallPerformanceLevel(),this.isInitialized=!0;let r=performance.now()-this.detectionStartTime;return this.config.enableDebug&&console.log("\u{1F4CA} [DeviceCapabilityDetector] Enhanced detection completed in",`${r.toFixed(1)}ms`,`
Spicetify Profile:`,this.deviceCapabilities.spicetifyProfile),this.config.enableDebug&&console.log("\u{1F4CA} [DeviceCapabilityDetector] Capabilities detected:",this.deviceCapabilities),this.deviceCapabilities}getSpicetifyProfile(){return this.deviceCapabilities?.spicetifyProfile||null}getRecommendedQualityLevel(){return this.deviceCapabilities?.spicetifyProfile?.recommendedQualityLevel||50}async _analyzeMemoryCapabilities(){let t=navigator.deviceMemory,e=typeof t=="number",i=t||this._estimateMemoryFromOtherSources(),r=performance.memory?.jsHeapSizeLimit||0,a=this._estimateAvailableMemory(),n=this.config.spicetifyContext?this._estimateSpicetifyOverhead():0,s=this._calculateMemoryScore(i,r,a);return{total:i,score:s,level:s>=7?"high":s>=4?"medium":"low",jsHeapSizeLimit:r,estimatedAvailable:a,spicetifyOverhead:n,confidenceLevel:e?.9:.6}}_detectMemoryLevel(){let t=navigator.deviceMemory||6;return t>=8?"high":t>=4?"medium":"low"}_estimateAvailableMemory(){return performance.memory?performance.memory.jsHeapSizeLimit-performance.memory.usedJSHeapSize:(navigator.deviceMemory||4)*1024*1024*1024*.7}async _analyzeCPUCapabilities(){let t=navigator.hardwareConcurrency||4,e=await this._benchmarkSingleThreadPerformance(),i=this._estimateThermalThrottlingRisk(t),r=this._calculateCPUScore(t,e);return{cores:t,score:r,level:r>=7?"high":r>=4?"medium":"low",singleThreadPerformance:e,thermalThrottlingRisk:i,confidenceLevel:t>1?.8:.5}}_detectCPULevel(){let t=navigator.hardwareConcurrency||4;return t>=8?"high":t>=4?"medium":"low"}_detectWebGLSupport(){try{let t=document.createElement("canvas");return!!(t.getContext("webgl")||t.getContext("experimental-webgl"))}catch{return!1}}_detectWebGL2Support(){try{return!!document.createElement("canvas").getContext("webgl2")}catch{return!1}}_getMaxTextureSize(){try{let t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");return e?e.getParameter(e.MAX_TEXTURE_SIZE):0}catch{return 0}}_getGPUVendor(){try{let t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");if(!e)return"unknown";let i=e.getExtension("WEBGL_debug_renderer_info");return i?e.getParameter(i.UNMASKED_VENDOR_WEBGL):"unknown"}catch{return"unknown"}}_getGPURenderer(){try{let t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");if(!e)return"unknown";let i=e.getExtension("WEBGL_debug_renderer_info");return i?e.getParameter(i.UNMASKED_RENDERER_WEBGL):"unknown"}catch{return"unknown"}}async _analyzeGPUCapabilities(){let t=this._detectWebGLSupport(),e=this._detectWebGL2Support(),i=this._getMaxTextureSize(),r=this._getGPUVendor(),a=this._getGPURenderer(),n=await this._benchmarkWebGLCapabilities(),s=this._calculateGPUScore(a,n,e,i);return{supportsWebGL:t,supportsWebGL2:e,maxTextureSize:i,score:s,level:s>=7?"high":s>=4?"medium":"low",vendor:r,renderer:a,webglCapabilityScore:n,confidenceLevel:t?.8:.3}}_detectGPULevel(){let t=this._getGPURenderer().toLowerCase();return/rtx|radeon rx|gtx 16|gtx 20|apple m[1-9]|iris xe/.test(t)?"high":/gtx|radeon|intel iris|intel uhd|vega|ryzen/.test(t)?"medium":"low"}_detectOffscreenCanvasSupport(){return typeof OffscreenCanvas<"u"}_detectWorkerSupport(){return typeof Worker<"u"}_detectSharedArrayBufferSupport(){return typeof SharedArrayBuffer<"u"}_detectWASMSupport(){return typeof WebAssembly<"u"}_detectCSSHoudiniSupport(){return typeof CSS<"u"&&CSS.paintWorklet!==void 0}async _detectRefreshRate(){return new Promise(t=>{let e=performance.now(),i=0,r=[],a=()=>{let n=performance.now(),s=n-e;if(r.push(1e3/s),e=n,i++,i<10)requestAnimationFrame(a);else{let l=r.reduce((c,m)=>c+m,0)/r.length;t(Math.round(l))}};requestAnimationFrame(a)})}_detectColorGamut(){return window.matchMedia("(color-gamut: p3)").matches?"p3":window.matchMedia("(color-gamut: srgb)").matches?"srgb":"limited"}_detectContrastCapability(){return window.matchMedia("(dynamic-range: high)").matches||window.matchMedia("(contrast: high)").matches?"high":"standard"}_detectReducedMotion(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}async _runCapabilityTests(){this.deviceCapabilities&&(this.deviceCapabilities.gpu.stressTestScore=await this._runGPUStressTest(),this.deviceCapabilities.memory.stressTestScore=await this._runMemoryStressTest()),this.config.enableDebug&&console.log("\u26A1 [DeviceCapabilityDetector] Capability tests completed")}async _runGPUStressTest(){return 0}async _runMemoryStressTest(){return 0}_estimateMemoryFromOtherSources(){let t=navigator.hardwareConcurrency||4,e=window.screen,i=4;return t>=8?i=16:t>=6?i=12:t>=4?i=8:t>=2&&(i=6),e.width*e.height>2073600&&(i*=1.5),Math.round(i)}_estimateSpicetifyOverhead(){return this.config.spicetifyContext?.15:0}_calculateMemoryScore(t,e,i){let r=Math.min(t/2,10);if(e>0){let a=e/1073741824;r=Math.max(r,Math.min(a,10))}return this.config.spicetifyContext&&(r*=.85),Math.min(Math.max(r,1),10)}async _benchmarkSingleThreadPerformance(){let t="singleThreadPerf";return this.benchmarkCache.has(t)?this.benchmarkCache.get(t):new Promise(e=>{let i=performance.now(),r=0;for(let s=0;s<5e5;s++)r+=Math.sin(s)*Math.cos(s);let a=performance.now()-i,n=Math.max(1,Math.min(10,50/a));this.benchmarkCache.set(t,n),e(n)})}_estimateThermalThrottlingRisk(t){let e=/Mobi|Android/i.test(navigator.userAgent),i=.1;return t>=8&&(i+=.2),e&&(i+=.3),Math.min(i,1)}_calculateCPUScore(t,e){let i=Math.min(t/2,10),r=.7;return Math.min(i*(1-r)+e*r,10)}async _benchmarkWebGLCapabilities(){let t="webglCapability";if(this.benchmarkCache.has(t))return this.benchmarkCache.get(t);if(!this._detectWebGLSupport())return this.benchmarkCache.set(t,0),0;let e=document.createElement("canvas"),i=e.getContext("webgl2")||e.getContext("webgl");if(!i)return this.benchmarkCache.set(t,0),0;let r=2;i.getExtension("OES_texture_float")&&(r+=1),i.getExtension("WEBGL_depth_texture")&&(r+=1),i.getExtension("OES_element_index_uint")&&(r+=1);let a=i.getParameter(i.MAX_TEXTURE_SIZE);return a>=4096?r+=2:a>=2048&&(r+=1),i.getParameter(i.MAX_VERTEX_ATTRIBS)>=16&&(r+=1),i instanceof WebGL2RenderingContext&&(r+=2),this.benchmarkCache.set(t,Math.min(r,10)),Math.min(r,10)}_calculateGPUScore(t,e,i,r){let a=e,n=t.toLowerCase();return/rtx|radeon rx|apple m[1-9]|arc a/.test(n)?a+=2:/gtx|radeon|vega|iris xe|ryzen/.test(n)?a+=1:/intel|qualcomm|mali|adreno/.test(n)&&(a+=.5),Math.min(Math.max(a,1),10)}async _createSpicetifyProfile(t,e,i){let r=t.score,a=e.score,n=i.score,s=Math.round((r*.3+a*.4+n*.3)*10),l=Math.min(s,100);this.config.spicetifyContext&&(l*=1-t.spicetifyOverhead),l=Math.max(l,20);let c=(t.confidenceLevel+e.confidenceLevel+i.confidenceLevel)/3;return{memoryScore:r,cpuScore:a,gpuScore:n,compositeScore:s,spicetifyOverhead:t.spicetifyOverhead,userQualityPreference:"auto",confidenceLevel:c,recommendedQualityLevel:Math.round(l)}}_calculateOverallPerformanceLevel(){if(!this.deviceCapabilities)return"low";let t=this.deviceCapabilities.spicetifyProfile.compositeScore,e=this.deviceCapabilities.spicetifyProfile.confidenceLevel,i=t*(.7+e*.3);return i>=70?"high":i>=40?"medium":"low"}getCapabilities(){return this.isInitialized?this.deviceCapabilities:(console.warn("[DeviceCapabilityDetector] Not initialized - call initialize() first"),null)}hasWebGLSupport(){return this.isInitialized&&this.deviceCapabilities?this.deviceCapabilities.gpu.supportsWebGL:this._detectWebGLSupport()}hasWebGL2Support(){return this.isInitialized&&this.deviceCapabilities?this.deviceCapabilities.gpu.supportsWebGL2:this._detectWebGL2Support()}destroy(){this.deviceCapabilities=null,this.isInitialized=!1,this.config.enableDebug&&console.log("\u{1F50D} [DeviceCapabilityDetector] Destroyed")}recommendPerformanceQuality(){if(!this.isInitialized||!this.deviceCapabilities)return"balanced";switch(this.deviceCapabilities.overall){case"high":return"high";case"medium":return"balanced";case"low":default:return"low"}}static detectTier(){let t=this._analyzeBasicCapabilities(),e=[],i="medium",r=.8;this._isHighTierDevice(t,e)?(i="high",r=.9):this._isLowTierDevice(t,e)?(i="low",r=.85):(e.push("Standard modern device - full experience enabled"),e.push(`${t.memory}GB RAM, ${t.cores} cores, WebGL2: ${t.webgl2}`));let a={tier:i,confidence:r,reasoning:e,capabilities:t};return console.log("\u{1F50D} [DeviceCapabilityDetector] Enhanced tier detection complete",a),a}static _analyzeBasicCapabilities(){let t=navigator.deviceMemory||this._estimateMemory(),e=navigator.hardwareConcurrency||this._estimateCores(),i=this._checkWebGLSupport(),r=this._checkWebGL2Support(),a=navigator.userAgent,n=navigator.platform||"unknown";return{memory:t,cores:e,webgl:i,webgl2:r,userAgent:a,platform:n,hardwareInfo:{isHighEnd:this._detectHighEndHardware(t,e,a),isMobile:this._isMobileDevice(a,n),isOldDevice:this._isOldDevice(a),hasPerformanceIndicators:this._hasPerformanceIndicators(a)}}}static _isHighTierDevice(t,e){let{memory:i,cores:r,webgl2:a,hardwareInfo:n}=t;if(!(i>=8&&r>=6&&a))return!1;let l=[];return i>=16&&l.push("16+GB RAM"),r>=8&&l.push("8+ CPU cores"),n.hasPerformanceIndicators&&l.push("Performance GPU detected"),n.isHighEnd&&l.push("High-end hardware signatures"),l.length>=2?(e.push("High-end device detected"),e.push(`Specs: ${i}GB RAM, ${r} cores, WebGL2: ${a}`),e.push(`Indicators: ${l.join(", ")}`),!0):this._isGamingOrWorkstation(t)?(e.push("Gaming/workstation device detected"),e.push("High-performance device indicators found"),!0):!1}static _isLowTierDevice(t,e){let{memory:i,cores:r,webgl2:a,hardwareInfo:n}=t,s=[];return i<4&&s.push(`Low memory: ${i}GB`),r<4&&s.push(`Few CPU cores: ${r}`),a||s.push("No WebGL2 support"),n.isOldDevice&&s.push("Legacy device detected"),n.isMobile&&i<=4&&r<=4&&s.push("Resource-constrained mobile device"),s.length>=2?(e.push("Budget/legacy device detected - enabling performance optimizations"),e.push(...s),!0):!1}static _estimateMemory(){let t=navigator.userAgent.toLowerCase();return t.includes("mobile")||t.includes("android")?4:t.includes("ipad")||t.includes("tablet")?6:8}static _estimateCores(){return navigator.userAgent.toLowerCase().includes("mobile"),4}static _checkWebGLSupport(){try{let t=document.createElement("canvas"),i=(t.getContext("webgl")||t.getContext("experimental-webgl"))!==null;return t.remove(),i}catch{return!1}}static _checkWebGL2Support(){try{let t=document.createElement("canvas"),i=t.getContext("webgl2")!==null;return t.remove(),i}catch{return!1}}static _detectHighEndHardware(t,e,i){let r=i.toLowerCase();return[r.includes("gaming"),r.includes("nvidia"),r.includes("amd"),r.includes("geforce"),r.includes("radeon"),t>=16,e>=8].filter(Boolean).length>=2}static _isMobileDevice(t,e){let i=t.toLowerCase(),r=e.toLowerCase();return i.includes("mobile")||i.includes("android")||i.includes("iphone")||i.includes("ipad")||r.includes("arm")||"ontouchstart"in window}static _isOldDevice(t){let e=t.toLowerCase();return[/chrome\/[1-6]\d\./,/firefox\/[1-5]\d\./,/safari\/[1-9]\./,/msie|trident/].some(r=>r.test(e))}static _hasPerformanceIndicators(t){let e=t.toLowerCase();return["nvidia","amd","geforce","radeon","quadro","gaming","performance"].some(r=>e.includes(r))}static _isGamingOrWorkstation(t){let{userAgent:e,memory:i,cores:r}=t,a=e.toLowerCase();return[a.includes("gaming"),a.includes("nvidia"),a.includes("geforce"),a.includes("rog"),a.includes("alienware"),i>=16&&r>=8].filter(Boolean).length>=2}}});var fe,fi=v(()=>{"use strict";pe();R();fe=class{static detectTier(){typeof process<"u";let t=W.detectTier();return u?.debug?.log("EnhancedDeviceTierDetector","Compatibility layer - delegating to DeviceCapabilityDetector",t),t}static _analyzeDeviceCapabilities(){let t=navigator.deviceMemory||this._estimateMemory(),e=navigator.hardwareConcurrency||this._estimateCores(),i=this._checkWebGLSupport(),r=this._checkWebGL2Support(),a=navigator.userAgent,n=navigator.platform||"unknown";return{memory:t,cores:e,webgl:i,webgl2:r,userAgent:a,platform:n,hardwareInfo:{isHighEnd:this._detectHighEndHardware(t,e,a),isMobile:this._isMobileDevice(a,n),isOldDevice:this._isOldDevice(a),hasPerformanceIndicators:this._hasPerformanceIndicators(a)}}}static _estimateMemory(){let t=navigator.userAgent.toLowerCase();return t.includes("mobile")||t.includes("android")?4:t.includes("ipad")||t.includes("tablet")?6:8}static _estimateCores(){return navigator.userAgent.toLowerCase().includes("mobile"),4}static _checkWebGLSupport(){try{let t=document.createElement("canvas"),i=(t.getContext("webgl")||t.getContext("experimental-webgl"))!==null;return t.remove(),i}catch{return!1}}static _checkWebGL2Support(){try{let t=document.createElement("canvas"),i=t.getContext("webgl2")!==null;return t.remove(),i}catch{return!1}}static _detectHighEndHardware(t,e,i){let r=i.toLowerCase();return[r.includes("gaming"),r.includes("nvidia"),r.includes("amd"),r.includes("geforce"),r.includes("radeon"),t>=16,e>=8].filter(Boolean).length>=2}static _isMobileDevice(t,e){let i=t.toLowerCase(),r=e.toLowerCase();return i.includes("mobile")||i.includes("android")||i.includes("iphone")||i.includes("ipad")||r.includes("arm")||"ontouchstart"in window}static _isOldDevice(t){let e=t.toLowerCase();return[/chrome\/[1-6]\d\./,/firefox\/[1-5]\d\./,/safari\/[1-9]\./,/msie|trident/].some(r=>r.test(e))}static _hasPerformanceIndicators(t){let e=t.toLowerCase();return["nvidia","amd","geforce","radeon","quadro","gaming","performance"].some(r=>e.includes(r))}static getDeviceDescription(t){typeof process<"u";let{memory:e,cores:i,platform:r,hardwareInfo:a}=t,n=a.isMobile?"Mobile":"Desktop",s=[];return a.isHighEnd&&s.push("High-End"),a.isOldDevice&&s.push("Legacy"),`${n} Device (${e}GB RAM, ${i} cores, ${r})${s.length?` [${s.join(", ")}]`:""}`}}});var bi,jn=v(()=>{"use strict";fi();_();R();bi=class{constructor(t){this.initialized=!1;this.webglIntegration=null;this.deviceTier="medium";this.tierDetectionResult=null;this.energyBoostActive=!1;this.energyBoostTimeout=null;this.tierSettings={low:{webglQuality:"low",animationDensity:.6,updateFrequency:45,particleMultiplier:.4,corridorEffects:!1,advancedFeatures:!1,experimentalFeatures:!1},medium:{webglQuality:"high",animationDensity:.9,updateFrequency:60,particleMultiplier:1,corridorEffects:!0,advancedFeatures:!0,experimentalFeatures:!1},high:{webglQuality:"high",animationDensity:1,updateFrequency:60,particleMultiplier:1.2,corridorEffects:!0,advancedFeatures:!0,experimentalFeatures:!0}};this.energyBoostSettings={animationBoost:1.3,particleBoost:1.5,duration:1e4};this.enhancedDeviceTierDetector=t,this.currentSettings=this.tierSettings.medium,u?.debug?.log("SimpleTierBasedPerformanceSystem","Initialized with tier-based performance management")}async initialize(){this.initialized||(this.tierDetectionResult=fe.detectTier(),this.deviceTier=this.tierDetectionResult.tier,this.currentSettings=this.tierSettings[this.deviceTier],this._setupMusicAnalysisListener(),this._applyTierSettings(),this.initialized=!0,u?.debug?.log("SimpleTierBasedPerformanceSystem","Initialization complete",{deviceTier:this.deviceTier,confidence:this.tierDetectionResult.confidence,reasoning:this.tierDetectionResult.reasoning,deviceDescription:fe.getDeviceDescription(this.tierDetectionResult.capabilities),settings:this.currentSettings}))}async healthCheck(){return this.initialized?{healthy:!0,details:`Performance tier: ${this.deviceTier}, Energy boost: ${this.energyBoostActive?"active":"inactive"}`,system:"SimpleTierBasedPerformanceSystem"}:{healthy:!1,details:"Not initialized",system:"SimpleTierBasedPerformanceSystem"}}destroy(){this.energyBoostTimeout&&(clearTimeout(this.energyBoostTimeout),this.energyBoostTimeout=null),p.unsubscribe("colors:extracted"),p.unsubscribe("music:track-changed"),this.initialized=!1,u?.debug?.log("SimpleTierBasedPerformanceSystem","Destroyed")}updateAnimation(t){}registerWebGLIntegration(t){this.webglIntegration=t,this.initialized&&this._applyWebGLSettings(),u?.debug?.log("SimpleTierBasedPerformanceSystem","WebGL integration registered")}getDeviceTier(){return this.deviceTier}getTierDetectionResult(){return this.tierDetectionResult}getDeviceDescription(){return this.tierDetectionResult?fe.getDeviceDescription(this.tierDetectionResult.capabilities):"Unknown device"}getCurrentSettings(){return{...this.currentSettings}}hasEnergyBoost(){return this.energyBoostActive}getEffectiveSettings(){let t={...this.currentSettings};return this.energyBoostActive?{...t,animationDensity:Math.min(1,t.animationDensity*this.energyBoostSettings.animationBoost),particleMultiplier:t.particleMultiplier*this.energyBoostSettings.particleBoost,energyBoosted:!0}:{...t,energyBoosted:!1}}setTier(t){this.deviceTier=t,this.currentSettings=this.tierSettings[t],this._applyTierSettings(),u?.debug?.log("SimpleTierBasedPerformanceSystem",`Tier manually set to ${t}`)}_setupMusicAnalysisListener(){p.subscribe("colors:extracted",t=>{t.musicData&&this._handleMusicAnalysis({energy:t.musicData.energy||.5,valence:t.musicData.valence||.5,bpm:t.musicData.tempo||120,genre:t.musicData.genre||"unknown"})}),p.subscribe("music:track-changed",t=>{this._handleSongChange(t)})}_handleSongChange(t){t.analysis&&this._checkEnergyBoost(t.analysis)}_handleMusicAnalysis(t){this._checkEnergyBoost(t)}_checkEnergyBoost(t){let e=t.energy>.7&&t.bpm>130&&(t.danceability||0)>.6,i=e&&!this.energyBoostActive,r=!e&&this.energyBoostActive;i?this._activateEnergyBoost(t):r&&this._deactivateEnergyBoost()}_activateEnergyBoost(t){this.energyBoostActive=!0,this.energyBoostTimeout&&clearTimeout(this.energyBoostTimeout),this._applyTierSettings(),this.energyBoostTimeout=window.setTimeout(()=>{this._deactivateEnergyBoost()},this.energyBoostSettings.duration),p.emit("performance:tier-changed",{tier:this.deviceTier,previousTier:this.deviceTier,timestamp:Date.now()}),u?.debug?.log("SimpleTierBasedPerformanceSystem","Energy boost activated",{bpm:t.bpm,energy:t.energy,danceability:t.danceability})}_deactivateEnergyBoost(){this.energyBoostActive&&(this.energyBoostActive=!1,this.energyBoostTimeout&&(clearTimeout(this.energyBoostTimeout),this.energyBoostTimeout=null),this._applyTierSettings(),p.emit("performance:tier-changed",{tier:this.deviceTier,previousTier:this.deviceTier,timestamp:Date.now()}),u?.debug?.log("SimpleTierBasedPerformanceSystem","Energy boost deactivated"))}_applyTierSettings(){this._applyWebGLSettings(),this._applySystemSettings();let t=this.getEffectiveSettings();p.emit("performance:tier-changed",{tier:this.deviceTier,previousTier:this.deviceTier,timestamp:Date.now()})}_applyWebGLSettings(){if(!this.webglIntegration)return;let t=this.getEffectiveSettings();this.webglIntegration.setQuality(t.webglQuality),u?.debug?.log("SimpleTierBasedPerformanceSystem","WebGL settings applied",{tier:this.deviceTier,quality:t.webglQuality,energyBoosted:t.energyBoosted})}_applySystemSettings(){let t=this.getEffectiveSettings();p.emit("performance:frame",{deltaTime:16,fps:t.updateFrequency,memoryUsage:.5,timestamp:Date.now()})}}});var yi,Kn=v(()=>{"use strict";R();_();yi=class{constructor(t){this.initialized=!1;this.currentState="disabled";this.webglSystems=new Map;this.lastStateChange=0;this.stateChangeHistory=[];this.userExplicitlyDisabled=!1;this.userExplicitQuality=null;this.deviceCapabilities=t,this.config={enabled:!0,quality:"medium",forceEnabled:!1,allowPerformanceAdjustment:!0},u?.debug?.log("UnifiedWebGLController","Initialized with unified WebGL management")}async initialize(){this.initialized||(this.deviceCapabilities.isInitialized||await this.deviceCapabilities.initialize(),await this._loadSettings(),await this._determineInitialState(),this._setupEventListeners(),this._applyStateToAllSystems(),this.initialized=!0,u?.debug?.log("UnifiedWebGLController","Initialization complete",{state:this.currentState,quality:this.config.quality,systemCount:this.webglSystems.size}))}async healthCheck(){if(!this.initialized)return{healthy:!1,details:"Not initialized",system:"UnifiedWebGLController"};let t=[];for(let[i,r]of this.webglSystems)if(r.system.healthCheck)try{let a=await r.system.healthCheck();a.healthy||t.push(`${i}: ${a.details||"unhealthy"}`)}catch{t.push(`${i}: health check failed`)}let e=this.stateChangeHistory.filter(i=>Date.now()-i.timestamp<3e4).length;return t.length>0||e>3?{healthy:!0,details:`Issues detected: ${t.join(", ")}`,issues:t,system:"UnifiedWebGLController"}:{healthy:!0,details:"All WebGL systems operating normally",system:"UnifiedWebGLController"}}destroy(){this._setState("disabled"),this.webglSystems.clear(),p.unsubscribe("settings:changed"),p.unsubscribe("system:state-changed"),this.initialized=!1,u?.debug?.log("UnifiedWebGLController","Destroyed - all WebGL systems disabled")}updateAnimation(t){if(this.currentState==="webgl-active"){for(let[e,i]of this.webglSystems)if(i.system.updateAnimation)try{i.system.updateAnimation(t)}catch(r){u?.debug?.warn("UnifiedWebGLController",`Animation update failed for ${e}:`,r)}}}enable(){this.userExplicitlyDisabled=!1,this.config.enabled=!0,this._determineAndApplyState(),this._saveSettings(),u?.debug?.log("UnifiedWebGLController","WebGL enabled by user")}disable(){this.userExplicitlyDisabled=!0,this.config.enabled=!1,this._setState("css-fallback"),this._saveSettings(),u?.debug?.log("UnifiedWebGLController","WebGL disabled by user")}setQuality(t){this.userExplicitQuality=t,this.config.quality=t,this._applyQualityToAllSystems(),this._saveSettings(),u?.debug?.log("UnifiedWebGLController",`Quality set to ${t} by user`)}isEnabled(){return this.currentState==="webgl-active"}isAvailable(){return this.deviceCapabilities.getSpicetifyProfile()?.webglCapabilities?.available||!1}getState(){return this.currentState}getQuality(){return this.config.quality}forceEnable(t=!0){this.config.forceEnabled=t,this._determineAndApplyState(),this._saveSettings(),u?.debug?.log("UnifiedWebGLController",`Force enable set to ${t}`)}registerSystem(t,e,i=0){this.webglSystems.set(t,{system:e,name:t,priority:i}),this.initialized&&this._applyStateToSystem(t,e),u?.debug?.log("UnifiedWebGLController",`System registered: ${t} (priority: ${i})`)}unregisterSystem(t){let e=this.webglSystems.get(t);e&&(e.system.setEnabled&&e.system.setEnabled(!1),this.webglSystems.delete(t),u?.debug?.log("UnifiedWebGLController",`System unregistered: ${t}`))}suggestQualityAdjustment(t,e){if(!this.config.allowPerformanceAdjustment){u?.debug?.log("UnifiedWebGLController",`Performance adjustment ignored (not allowed): ${e}`);return}if(this.userExplicitQuality!==null){u?.debug?.log("UnifiedWebGLController",`Performance adjustment ignored (user set explicit quality): ${e}`);return}if(this.config.quality!==t){let i=this.config.quality;this.config.quality=t,this._applyQualityToAllSystems(),u?.debug?.log("UnifiedWebGLController",`Quality adjusted by performance system: ${i} \u2192 ${t} (${e})`)}}performanceDisable(t){!this.config.allowPerformanceAdjustment||this.userExplicitlyDisabled===!1||this.currentState==="webgl-active"&&(this._setState("css-fallback"),u?.debug?.log("UnifiedWebGLController",`WebGL disabled by performance system: ${t}`))}performanceEnable(t){!this.config.allowPerformanceAdjustment||this.userExplicitlyDisabled||this.currentState==="css-fallback"&&this.config.enabled&&(this._determineAndApplyState(),u?.debug?.log("UnifiedWebGLController",`WebGL re-enabled by performance system: ${t}`))}async _loadSettings(){try{let t=localStorage.getItem("sn-webgl-enabled"),e=localStorage.getItem("sn-webgl-quality"),i=localStorage.getItem("sn-webgl-force-enabled");t!==null&&(this.config.enabled=t==="true",t==="false"&&(this.userExplicitlyDisabled=!0)),e&&["low","medium","high"].includes(e)&&(this.config.quality=e,this.userExplicitQuality=e),i!==null&&(this.config.forceEnabled=i==="true"),u?.debug?.log("UnifiedWebGLController","Settings loaded",this.config)}catch(t){u?.debug?.warn("UnifiedWebGLController","Failed to load settings:",t)}}_saveSettings(){try{localStorage.setItem("sn-webgl-enabled",this.config.enabled.toString()),localStorage.setItem("sn-webgl-quality",this.config.quality),localStorage.setItem("sn-webgl-force-enabled",this.config.forceEnabled.toString())}catch(t){u?.debug?.warn("UnifiedWebGLController","Failed to save settings:",t)}}async _determineInitialState(){if(!this.config.enabled||this.userExplicitlyDisabled){this._setState("css-fallback");return}this.config.forceEnabled||this.isAvailable()?this._setState("webgl-active"):this._setState("css-fallback")}_determineAndApplyState(){!this.config.enabled||this.userExplicitlyDisabled?this._setState("css-fallback"):this.config.forceEnabled||this.isAvailable()?this._setState("webgl-active"):this._setState("css-fallback")}_setState(t){if(this.currentState===t)return;let e=this.currentState;this.currentState=t,this.lastStateChange=Date.now(),this.stateChangeHistory.push({state:t,quality:this.config.quality,timestamp:this.lastStateChange}),this.stateChangeHistory.length>20&&(this.stateChangeHistory=this.stateChangeHistory.slice(-20)),this._applyStateToAllSystems(),p.emit("performance:tier-changed",{tier:t,previousTier:e,timestamp:this.lastStateChange}),u?.debug?.log("UnifiedWebGLController",`State changed: ${e} \u2192 ${t}`)}_applyStateToAllSystems(){let t=Array.from(this.webglSystems.entries()).sort(([,e],[,i])=>i.priority-e.priority);for(let[e,i]of t)this._applyStateToSystem(e,i.system)}_applyStateToSystem(t,e){try{let i=this.currentState==="webgl-active";if(e.setEnabled&&e.setEnabled(i),i&&e.setQuality&&e.setQuality(this.config.quality),t==="corridor-effects"&&e.setEnabled){let r=i&&(this.config.quality==="medium"||this.config.quality==="high");e.setEnabled(r)}}catch(i){u?.debug?.warn("UnifiedWebGLController",`Failed to apply state to ${t}:`,i)}}_applyQualityToAllSystems(){if(this.currentState==="webgl-active"){for(let[t,e]of this.webglSystems)try{if(e.system.setQuality&&e.system.setQuality(this.config.quality),t==="corridor-effects"){let i=this.config.quality==="medium"||this.config.quality==="high";e.system.setEnabled&&e.system.setEnabled(i)}}catch(i){u?.debug?.warn("UnifiedWebGLController",`Failed to apply quality to ${t}:`,i)}p.emit("performance:tier-changed",{tier:this.config.quality,previousTier:this.config.quality,timestamp:Date.now()})}}_setupEventListeners(){p.subscribe("settings:changed",t=>{t.settingKey==="sn-webgl-enabled"?(this.config.enabled=t.newValue==="true",this.userExplicitlyDisabled=t.newValue==="false",this._determineAndApplyState()):t.settingKey==="sn-webgl-quality"?this.setQuality(t.newValue):t.settingKey==="sn-webgl-force-enabled"&&(this.config.forceEnabled=t.newValue==="true",this._determineAndApplyState())}),p.subscribe("performance:tier-changed",t=>{let e=t.tier==="excellent"?"high":t.tier==="good"?"medium":"low";e!==this.config.quality&&this.setQuality(e)})}}});var tt,ia=v(()=>{"use strict";Kn();R();tt=class{constructor(t,e){this.initialized=!1;this.visualSystemCoordinator=null;this.controller=new yi(t),this.visualSystemCoordinator=e||null,u?.debug?.log("WebGLSystemsIntegration","Created WebGL systems integration",{hasVisualCoordinator:!!e})}async initialize(){this.initialized||(await this.controller.initialize(),await this._registerWebGLSystems(),this.initialized=!0,u?.debug?.log("WebGLSystemsIntegration","Integration initialized",{controllerState:this.controller.getState(),quality:this.controller.getQuality(),registeredSystems:this._getRegisteredSystemNames()}))}async healthCheck(){if(!this.initialized)return{healthy:!1,details:"Not initialized",system:"WebGLSystemsIntegration"};let t=await this.controller.healthCheck();return t.healthy?{healthy:!0,details:"WebGL controller healthy",system:"WebGLSystemsIntegration"}:{healthy:!1,details:`Controller unhealthy: ${t.details}`,system:"WebGLSystemsIntegration"}}destroy(){this.controller.destroy(),this.initialized=!1,u?.debug?.log("WebGLSystemsIntegration","Integration destroyed")}updateAnimation(t){this.initialized&&this.controller.updateAnimation(t)}getController(){return this.controller}enableWebGL(){this.controller.enable()}disableWebGL(){this.controller.disable()}setQuality(t){this.controller.setQuality(t)}isWebGLActive(){return this.controller.isEnabled()}getWebGLState(){return this.controller.getState()}getQuality(){return this.controller.getQuality()}setVisualSystemCoordinator(t){this.visualSystemCoordinator=t,this.initialized&&this._registerWebGLSystems().catch(e=>{u?.debug?.warn("WebGLSystemsIntegration","Failed to register WebGLGradientStrategy after late binding:",e)}),u?.debug?.log("WebGLSystemsIntegration","VisualEffectsCoordinator reference set (Phase 2.2 late binding)")}handlePerformanceQualityAdjustment(t,e){this.controller.suggestQualityAdjustment(t,e)}handlePerformanceDisable(t){this.controller.performanceDisable(t)}handlePerformanceEnable(t){this.controller.performanceEnable(t)}setQualityFromTier(t){this.controller.setQuality(t),u?.debug?.log("WebGLSystemsIntegration",`Quality set from device tier: ${t}`)}async _registerWebGLSystems(){try{if(this.visualSystemCoordinator){let t=this.visualSystemCoordinator.getWebGLGradientStrategy();t?(this.controller.registerSystem("webgl-gradient",t,100),u?.debug?.log("WebGLSystemsIntegration","\u2713 WebGLGradientStrategy registered with UnifiedWebGLController (Phase 3 direct quality scaling)",{systemName:t.getSystemName?.()||"WebGLGradientStrategy",isCapable:t.isCapable?.()||!1,isEnabled:t.isEnabled?.()||!1})):u?.debug?.warn("WebGLSystemsIntegration","\u26A0 WebGLGradientStrategy not yet created by VisualEffectsCoordinator - will use lazy registration")}else u?.debug?.warn("WebGLSystemsIntegration","\u26A0 VisualEffectsCoordinator not provided - WebGLGradientStrategy cannot be registered for quality scaling");u?.debug?.log("WebGLSystemsIntegration","WebGL systems registration complete")}catch(t){u?.debug?.warn("WebGLSystemsIntegration","Failed to register some WebGL systems:",t)}}_getRegisteredSystemNames(){return[]}}});var He,gt,ra=v(()=>{"use strict";He=class He{constructor(t={},e){this.cssVariableManager=null;this.optimizationLevel="none";this.disabledFeatures=new Set;this.config={budgets:{animationFrame:16.67,cssVariableUpdate:2,domObservation:5,audioAnalysis:10,visualEffects:8,userInteraction:100},autoOptimize:{enabled:!0,violationThreshold:5,recoveryThreshold:80},enableDebug:!1,...t},this.performanceAnalyzer=e,this.setupBudgetMonitoring()}static getInstance(t,e){return!He.instance&&e&&(He.instance=new He(t,e)),He.instance}registerCSSVariableWriter(t){this.cssVariableManager=t}setupBudgetMonitoring(){this.config.autoOptimize.enabled&&setInterval(()=>{this.checkBudgets()},5e3)}checkBudgets(){this.performanceAnalyzer.calculateHealthScore()>=this.config.autoOptimize.recoveryThreshold&&this.recoverOptimizations()}optimizeOperation(t){if(!this.disabledFeatures.has(t)){switch(t){case"cssVariableUpdate":this.optimizeCSSVariableUpdates();break;case"domObservation":this.optimizeDOMObservation();break;case"visualEffects":this.optimizeVisualEffects();break;case"audioAnalysis":this.optimizeAudioAnalysis();break}this.disabledFeatures.add(t),this.config.enableDebug&&console.log(`\u{1F3AF} [PerformanceBudgetManager] Optimized ${t} due to budget violations`)}}optimizeCSSVariableUpdates(){this.cssVariableManager&&this.cssVariableManager.updateConfig({batchIntervalMs:32,maxBatchSize:25})}optimizeDOMObservation(){document.dispatchEvent(new CustomEvent("year3000:optimize-dom-observation",{detail:{level:this.optimizationLevel}}))}optimizeVisualEffects(){document.dispatchEvent(new CustomEvent("year3000:optimize-visual-effects",{detail:{level:this.optimizationLevel}}))}optimizeAudioAnalysis(){document.dispatchEvent(new CustomEvent("year3000:optimize-audio-analysis",{detail:{level:this.optimizationLevel}}))}escalateOptimization(){this.optimizationLevel==="none"?this.optimizationLevel="conservative":this.optimizationLevel==="conservative"&&(this.optimizationLevel="aggressive"),this.config.enableDebug&&console.log(`\u{1F3AF} [PerformanceBudgetManager] Escalated to ${this.optimizationLevel} optimization`)}recoverOptimizations(){this.optimizationLevel!=="none"&&(this.disabledFeatures.clear(),this.cssVariableManager&&this.cssVariableManager.updateConfig({batchIntervalMs:16,maxBatchSize:50}),document.dispatchEvent(new CustomEvent("year3000:recover-optimizations",{detail:{previousLevel:this.optimizationLevel}})),this.optimizationLevel="none",this.config.enableDebug&&console.log("\u{1F3AF} [PerformanceBudgetManager] Recovered from optimizations"))}getOptimizationStatus(){return{level:this.optimizationLevel,disabledFeatures:Array.from(this.disabledFeatures),budgetViolations:[],healthScore:this.performanceAnalyzer.calculateHealthScore()}}manualOptimize(t){this.optimizeOperation(t)}manualRecover(){this.recoverOptimizations()}updateBudgets(t){this.config.budgets={...this.config.budgets,...t};for(let[e,i]of Object.entries(t))this.performanceAnalyzer.updateBudget(e,i)}destroy(){this.disabledFeatures.clear(),this.cssVariableManager=null,He.instance=null}};He.instance=null;gt=He});var vi,Qn=v(()=>{"use strict";vi=class{constructor(t){this.initialized=!1;this.observer=null;this.loadingElements=new WeakSet;this.activeContexts=new Map;this.config={enableLoadingAnimations:!0,enableGrainTexture:!0,enableMusicSync:!1,intensity:"normal",performanceMode:!1};this.detectionCount=0;this.applicationCount=0;this.lastPerformanceCheck=Date.now();this.CONTEXT_SELECTORS={playlist:['.main-entityHeader-container[data-testid="playlist-header"]',".main-trackList-trackListRow",'[data-testid="playlist-tracklist"]'],artist:['.main-entityHeader-container[data-testid="artist-header"]','[data-testid="artist-page"]'],search:['[data-testid="search-page"]',".main-searchSection-searchSection"],home:['[data-testid="home-page"]',".main-home-content"]};this.LOADING_INDICATORS=['[aria-busy="true"]',".loading-indicator",".skeleton-loader",'[data-testid*="loading"]',".main-skeleton-skeletonLoader"];t&&(this.config={...this.config,...t})}async initialize(){if(!this.initialized)try{if(!document.body)throw new Error("DOM not ready - cannot initialize LoadingStateService");this.observer=new MutationObserver(t=>{this.handleMutations(t)}),this.observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["aria-busy","class","data-testid"]}),this.performInitialScan(),this.initialized=!0,console.log("[LoadingStateService] Initialized successfully")}catch(t){throw console.error("[LoadingStateService] Initialization failed:",t),t}}updateAnimation(t){if(!this.initialized||!this.config.enableLoadingAnimations)return;let e=Date.now();e-this.lastPerformanceCheck>5e3&&(this.cleanupStaleStates(),this.lastPerformanceCheck=e)}async healthCheck(){let t=this.initialized&&this.observer!==null,e=[`Initialized: ${this.initialized}`,`Observer active: ${this.observer!==null}`,`Active contexts: ${this.activeContexts.size}`,`Detection count: ${this.detectionCount}`,`Application count: ${this.applicationCount}`,`Config: ${JSON.stringify(this.config)}`].join(", ");return{system:"LoadingStateService",healthy:t,ok:t,details:e,metrics:{initialized:this.initialized,isActive:this.observer!==null,totalOperations:this.detectionCount+this.applicationCount,activeLoadingStates:this.activeContexts.size}}}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.activeContexts.forEach((t,e)=>{this.removeLoadingState(e)}),this.activeContexts.clear(),this.loadingElements=new WeakSet,this.initialized=!1,console.log("[LoadingStateService] Destroyed")}updateConfig(t){this.config={...this.config,...t},this.config.enableLoadingAnimations||(this.activeContexts.forEach((e,i)=>{this.removeLoadingState(i)}),this.activeContexts.clear())}handleMutations(t){let e=performance.now(),i=this.config.performanceMode?5:10;for(let r of t){if(performance.now()-e>i)break;r.type==="attributes"?this.handleAttributeChange(r):r.type==="childList"&&this.handleChildListChange(r)}this.detectionCount++}handleAttributeChange(t){let e=t.target,i=this.isElementLoading(e);if(i&&!this.loadingElements.has(e)){let r=this.detectContext(e);this.applyLoadingState(e,r)}else!i&&this.loadingElements.has(e)&&this.removeLoadingState(e)}handleChildListChange(t){t.addedNodes.forEach(e=>{if(e.nodeType!==Node.ELEMENT_NODE)return;let i=e;if(this.isElementLoading(i)){let a=this.detectContext(i);this.applyLoadingState(i,a)}i.querySelectorAll(this.LOADING_INDICATORS.join(", ")).forEach(a=>{if(!this.loadingElements.has(a)){let n=this.detectContext(a);this.applyLoadingState(a,n)}})})}performInitialScan(){document.querySelectorAll(this.LOADING_INDICATORS.join(", ")).forEach(e=>{let i=this.detectContext(e);this.applyLoadingState(e,i)})}isElementLoading(t){if(t.getAttribute("aria-busy")==="true")return!0;let e=t.classList;if(e.contains("skeleton-loader")||e.contains("loading-indicator")||e.contains("main-skeleton-skeletonLoader"))return!0;let i=t.getAttribute("data-testid");return!!(i&&i.includes("loading"))}detectContext(t){let e=t;for(;e&&e!==document.body;){if(this.CONTEXT_SELECTORS.playlist.some(i=>e.matches(i)))return"playlist";if(this.CONTEXT_SELECTORS.artist.some(i=>e.matches(i)))return"artist";if(this.CONTEXT_SELECTORS.search.some(i=>e.matches(i)))return"search";if(this.CONTEXT_SELECTORS.home.some(i=>e.matches(i)))return"home";e=e.parentElement}return"default"}applyLoadingState(t,e){this.config.enableLoadingAnimations&&(t.classList.add("loading-state"),t.classList.add(`loading-context-${e}`),t.classList.add(`loading-intensity-${this.config.intensity}`),this.config.enableGrainTexture&&t.classList.add("loading-grain-texture"),this.config.enableMusicSync&&t.classList.add("loading-music-sync"),this.loadingElements.add(t),this.activeContexts.set(t,{type:e,element:t,appliedAt:Date.now()}),this.applicationCount++)}removeLoadingState(t){t.classList.remove("loading-state","loading-context-playlist","loading-context-artist","loading-context-search","loading-context-home","loading-context-default","loading-intensity-subtle","loading-intensity-normal","loading-intensity-intense","loading-grain-texture","loading-music-sync"),this.activeContexts.delete(t)}cleanupStaleStates(){let t=Date.now(),e=3e4;this.activeContexts.forEach((i,r)=>{if(!document.body.contains(r)){this.activeContexts.delete(r);return}if(!this.isElementLoading(r)){this.removeLoadingState(r);return}t-i.appliedAt>e&&this.removeLoadingState(r)})}getStatistics(){return{initialized:this.initialized,activeContexts:this.activeContexts.size,detectionCount:this.detectionCount,applicationCount:this.applicationCount,config:this.config}}}});var pt,aa=v(()=>{"use strict";$();_();R();Xe();pt=class{constructor(t,e=null){this.musicSyncService=null;this.currentEmotionalProfile=null;this.emotionalHistory=[];this.maxHistorySize=50;this.isActive=!1;this.emotionAnalysisSubscriptionId=null;this.settingsSubscriptionId=null;this.currentEmotionalTemperature=null;this.moodProfiles={euphoric:{hueShift:15,saturationMultiplier:1.3,brightnessMultiplier:1.2,contrastMultiplier:1.2,animationSpeed:1.5,pulseIntensity:.8,layerHarmony:.9,discordLevel:.1,transitionSpeed:.8},content:{hueShift:5,saturationMultiplier:1.1,brightnessMultiplier:1.1,contrastMultiplier:1,animationSpeed:.8,pulseIntensity:.4,layerHarmony:.95,discordLevel:.05,transitionSpeed:1.5},melancholic:{hueShift:-30,saturationMultiplier:.8,brightnessMultiplier:.8,contrastMultiplier:.9,animationSpeed:.6,pulseIntensity:.3,layerHarmony:.8,discordLevel:.2,transitionSpeed:2},aggressive:{hueShift:-15,saturationMultiplier:1.3,brightnessMultiplier:1.2,contrastMultiplier:1.5,animationSpeed:2,pulseIntensity:1,layerHarmony:.6,discordLevel:.4,transitionSpeed:.5},mysterious:{hueShift:-45,saturationMultiplier:.9,brightnessMultiplier:.8,contrastMultiplier:1.3,animationSpeed:.7,pulseIntensity:.6,layerHarmony:.7,discordLevel:.3,transitionSpeed:1.8},peaceful:{hueShift:25,saturationMultiplier:.8,brightnessMultiplier:1,contrastMultiplier:.9,animationSpeed:.5,pulseIntensity:.2,layerHarmony:1,discordLevel:0,transitionSpeed:3},dramatic:{hueShift:0,saturationMultiplier:1.3,brightnessMultiplier:1.1,contrastMultiplier:1.4,animationSpeed:1.2,pulseIntensity:.9,layerHarmony:.6,discordLevel:.4,transitionSpeed:.7},ambient:{hueShift:10,saturationMultiplier:.8,brightnessMultiplier:.9,contrastMultiplier:.8,animationSpeed:.3,pulseIntensity:.1,layerHarmony:.9,discordLevel:.1,transitionSpeed:4},chaotic:{hueShift:0,saturationMultiplier:1.3,brightnessMultiplier:1.2,contrastMultiplier:1.6,animationSpeed:2.5,pulseIntensity:.9,layerHarmony:.3,discordLevel:.7,transitionSpeed:.3},nostalgic:{hueShift:-10,saturationMultiplier:.8,brightnessMultiplier:.95,contrastMultiplier:.9,animationSpeed:.7,pulseIntensity:.4,layerHarmony:.85,discordLevel:.15,transitionSpeed:2.2},heroic:{hueShift:20,saturationMultiplier:1.2,brightnessMultiplier:1.2,contrastMultiplier:1.3,animationSpeed:1.3,pulseIntensity:.7,layerHarmony:.8,discordLevel:.2,transitionSpeed:1},contemplative:{hueShift:-5,saturationMultiplier:.9,brightnessMultiplier:1,contrastMultiplier:1.1,animationSpeed:.6,pulseIntensity:.3,layerHarmony:.8,discordLevel:.2,transitionSpeed:2.5},neutral:{hueShift:0,saturationMultiplier:1,brightnessMultiplier:1,contrastMultiplier:1,animationSpeed:1,pulseIntensity:.5,layerHarmony:.75,discordLevel:.25,transitionSpeed:1.5}};this.cssController=t||A(),this.musicSyncService=e,this.currentGradientState=this.createNeutralGradientState(),this.emotionalTemperatureMapper=new se(!0),this.moodToEmotionMap={euphoric:"energetic",content:"happy",melancholic:"melancholy",aggressive:"aggressive",mysterious:"mysterious",peaceful:"calm",dramatic:"epic",ambient:"ambient",chaotic:"aggressive",nostalgic:"melancholy",heroic:"epic",contemplative:"calm",neutral:"ambient"}}async initialize(){this.emotionAnalysisSubscriptionId=p.subscribe("music:emotion-analyzed",this.handleEmotionAnalysis.bind(this),"EmotionalGradientMapper"),this.settingsSubscriptionId=p.subscribe("settings:changed",this.handleSettingsChange.bind(this),"EmotionalGradientMapper"),this.isActive=!0,u?.debug?.log("EmotionalGradientMapper","Emotional mapping system initialized with UnifiedEventBus")}createNeutralGradientState(){return{hueShift:0,saturationMultiplier:1,brightnessMultiplier:1,contrastMultiplier:1,animationSpeed:1,pulseIntensity:.5,flowDirection:0,layerHarmony:.75,discordLevel:.25,depthPerception:.5,transitionSpeed:1.5,smoothing:.7,responsiveness:.8}}handleEmotionAnalysis(t){if(!this.isActive)return;let e={energy:t.emotion.musicalCharacteristics.energy,valence:t.emotion.valence,danceability:t.emotion.musicalCharacteristics.danceability,tempo:t.emotion.musicalCharacteristics.tempo,loudness:t.emotion.dominance,acousticness:t.emotion.musicalCharacteristics.acousticness,instrumentalness:t.emotion.musicalCharacteristics.instrumentalness,speechiness:t.emotion.musicalCharacteristics.speechiness,mode:1,key:0,genre:t.emotion.primary};this.processMusicalEmotionalData(e)}processMusicalEmotionalData(t){let e=this.analyzeEmotionalContent(t);try{let r={energy:e.energy,valence:e.valence,danceability:e.arousal,tempo:120,loudness:e.dynamics,acousticness:1-e.complexity,instrumentalness:.5,speechiness:.1,mode:e.mode==="major"?1:0,key:0,genre:this.inferGenreFromProfile(e)};this.currentEmotionalTemperature=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(r),this.applyEmotionalTemperatureToDocument(this.currentEmotionalTemperature),u?.debug?.log("EmotionalGradientMapper","\u{1F321}\uFE0F Applied emotional temperature:",{mood:e.mood,emotionalState:this.currentEmotionalTemperature.primaryEmotion,temperature:this.currentEmotionalTemperature.temperature,intensity:this.currentEmotionalTemperature.intensity})}catch(r){u?.debug?.warn("EmotionalGradientMapper","\u{1F321}\uFE0F Failed to apply emotional temperature:",r)}this.storeEmotionalHistory(e);let i=this.mapEmotionToGradient(e);this.currentGradientState=this.smoothGradientTransition(this.currentGradientState,i,e.stability),this.updateGradientVariables(),this.currentEmotionalProfile=e}analyzeEmotionalContent(t){let e=t.valence||.5,i=t.energy||.5,r=t.danceability||.5,a=this.calculateTension(t),n=this.detectMode(t),s=this.calculateDynamics(t),l=this.calculateComplexity(t),c=this.calculateStability(),m=this.calculatePredictability(),d=this.classifyMood(e,i,r,a,n),h=this.calculateMoodConfidence(e,i,r,a);return{valence:e,energy:i,arousal:r,tension:a,mode:n,dynamics:s,complexity:l,stability:c,predictability:m,mood:d,confidence:h}}calculateTension(t){let e=Math.abs((t.loudness||0)/-60),i=t.tempo?Math.min(1,(t.tempo-60)/140):.5,r=1-(t.acousticness||.5),a=t.speechiness||0;return Math.max(0,Math.min(1,e*.4+i*.3+r*.2+a*.1))}calculateDynamics(t){let e=Math.abs((t.loudness||0)/-60),i=t.energy||.5;return Math.max(0,Math.min(1,(e+i)/2))}calculateComplexity(t){let e=t.instrumentalness||.5,i=t.speechiness||0,r=1-(t.acousticness||.5);return Math.max(0,Math.min(1,(e+i+r)/3))}detectMode(t){if(typeof t.mode=="number")return t.mode===1?"major":"minor";let e=t.valence||.5,i=t.acousticness||.5;return e>.6&&i>.5?"major":e<.4||i<.3?"minor":"neutral"}calculateStability(){if(this.emotionalHistory.length<2)return .5;let t=Math.min(10,this.emotionalHistory.length),e=0;for(let i=1;i<t;i++){let r=this.emotionalHistory[this.emotionalHistory.length-i],a=this.emotionalHistory[this.emotionalHistory.length-i-1];r&&a&&(e+=Math.abs(r.valence-a.valence),e+=Math.abs(r.energy-a.energy),e+=Math.abs(r.arousal-a.arousal))}return Math.max(0,Math.min(1,1-e/(t*3)))}calculatePredictability(){if(this.emotionalHistory.length<5)return .5;let t=this.emotionalHistory.slice(-5),e=0;for(let i=1;i<t.length;i++){let r=t[i],a=t[i-1];if(r&&a){let n=r.valence-a.valence,s=r.energy-a.energy;Math.abs(n)<.1&&Math.abs(s)<.1&&e++}}return e/(t.length-1)}classifyMood(t,e,i,r,a){return t>.7&&e>.7?"euphoric":t>.7&&e<.3?"content":t<.3&&e<.3?"melancholic":t<.3&&e>.7?"aggressive":t<.4&&r>.6?"mysterious":t>.6&&r<.3?"peaceful":r>.7&&i>.6?"dramatic":e<.4&&i<.4?"ambient":r>.6&&e>.6?"chaotic":a==="minor"&&t>.3&&t<.7?"nostalgic":a==="major"&&e>.6&&t>.5?"heroic":i<.5&&t>.4&&t<.6?"contemplative":"neutral"}calculateMoodConfidence(t,e,i,r){let a=[t,e,i,r].map(n=>Math.abs(n-.5)*2);return a.reduce((n,s)=>n+s,0)/a.length}mapEmotionToGradient(t){let e=this.moodProfiles[t.mood],i={...this.createNeutralGradientState(),...e};return{...i,hueShift:i.hueShift+(t.valence-.5)*20,saturationMultiplier:i.saturationMultiplier*(.5+t.arousal*.5),brightnessMultiplier:i.brightnessMultiplier*(.7+t.energy*.6),contrastMultiplier:i.contrastMultiplier*(.6+t.tension*.8),animationSpeed:i.animationSpeed*(.3+t.energy*1.4),pulseIntensity:i.pulseIntensity*t.arousal,flowDirection:t.valence*360,layerHarmony:i.layerHarmony*(.3+t.stability*.7),discordLevel:i.discordLevel*(.1+t.tension*.9),depthPerception:.3+t.complexity*.7,transitionSpeed:i.transitionSpeed/(.5+t.predictability*1.5),smoothing:.4+t.stability*.6,responsiveness:.4+t.confidence*.6}}smoothGradientTransition(t,e,i){let r=.1+i*.4;return{hueShift:this.lerp(t.hueShift,e.hueShift,r),saturationMultiplier:this.lerp(t.saturationMultiplier,e.saturationMultiplier,r),brightnessMultiplier:this.lerp(t.brightnessMultiplier,e.brightnessMultiplier,r),contrastMultiplier:this.lerp(t.contrastMultiplier,e.contrastMultiplier,r),animationSpeed:this.lerp(t.animationSpeed,e.animationSpeed,r),pulseIntensity:this.lerp(t.pulseIntensity,e.pulseIntensity,r),flowDirection:this.lerp(t.flowDirection,e.flowDirection,r),layerHarmony:this.lerp(t.layerHarmony,e.layerHarmony,r),discordLevel:this.lerp(t.discordLevel,e.discordLevel,r),depthPerception:this.lerp(t.depthPerception,e.depthPerception,r),transitionSpeed:this.lerp(t.transitionSpeed,e.transitionSpeed,r*.5),smoothing:this.lerp(t.smoothing,e.smoothing,.1),responsiveness:this.lerp(t.responsiveness,e.responsiveness,.1)}}lerp(t,e,i){return t+(e-t)*Math.max(0,Math.min(1,i))}updateGradientVariables(){let t=this.currentGradientState,e={"--sn-emotional-hue-shift":`${t.hueShift}deg`,"--sn-emotional-saturation-multiplier":t.saturationMultiplier.toString(),"--sn-emotional-brightness-multiplier":t.brightnessMultiplier.toString(),"--sn-emotional-contrast-multiplier":t.contrastMultiplier.toString(),"--sn-emotional-animation-speed":t.animationSpeed.toString(),"--sn-emotional-pulse-intensity":t.pulseIntensity.toString(),"--sn-emotional-flow-direction":`${t.flowDirection}deg`,"--sn-emotional-layer-harmony":t.layerHarmony.toString(),"--sn-emotional-discord-level":t.discordLevel.toString(),"--sn-emotional-depth-perception":t.depthPerception.toString(),"--sn-emotional-transition-speed":t.transitionSpeed.toString()};if(this.cssController.batchSetVariables("EmotionalGradientMapper",e,"normal","emotional-gradient-mapping"),this.currentEmotionalTemperature){let i={...this.currentEmotionalTemperature.cssVariables,"--sn-emotional-temperature":this.currentEmotionalTemperature.temperature.toString(),"--sn-emotional-temperature-intensity":this.currentEmotionalTemperature.intensity.toString(),"--sn-emotional-temperature-class":this.currentEmotionalTemperature.cssClass,"--sn-emotional-temperature-blend":this.currentEmotionalTemperature.intensity.toString()};this.cssController.batchSetVariables("EmotionalGradientMapper",i,"high","emotional-temperature-mapping"),u?.debug?.log("EmotionalGradientMapper","\u{1F321}\uFE0F Applied temperature CSS variables:",{temperature:this.currentEmotionalTemperature.temperature,intensity:this.currentEmotionalTemperature.intensity,cssClass:this.currentEmotionalTemperature.cssClass,variableCount:Object.keys(this.currentEmotionalTemperature.cssVariables).length})}if(this.updateEmotionalGradientCoordination(t),this.currentEmotionalProfile){let i={"--sn-current-mood":this.currentEmotionalProfile.mood,"--sn-mood-confidence":this.currentEmotionalProfile.confidence.toString(),"--sn-emotional-valence":this.currentEmotionalProfile.valence.toString(),"--sn-emotional-energy":this.currentEmotionalProfile.energy.toString()};this.cssController.batchSetVariables("EmotionalGradientMapper",i,"normal","mood-state-tracking")}}updateEmotionalGradientCoordination(t){let e=getComputedStyle(document.documentElement),i=e.getPropertyValue("--sn-bg-gradient-primary").trim(),r=e.getPropertyValue("--sn-bg-gradient-secondary").trim(),a=e.getPropertyValue("--sn-bg-gradient-accent").trim();if(i||r||a){let n={"--sn-bg-gradient-flow-x":(t.flowDirection*.01).toString(),"--sn-bg-gradient-flow-y":(Math.sin(t.flowDirection*Math.PI/180)*.5).toString(),"--sn-bg-gradient-opacity":(.8*t.layerHarmony).toString(),"--sn-bg-gradient-blur":`${120*(1+t.depthPerception*.5)}px`,"--sn-bg-gradient-saturation":t.saturationMultiplier.toString(),"--sn-bg-gradient-brightness":t.brightnessMultiplier.toString(),"--sn-bg-gradient-contrast":t.contrastMultiplier.toString()};this.cssController.batchSetVariables("EmotionalGradientMapper",n,"normal","bg-gradient-coordination"),u?.debug?.log("EmotionalGradientMapper",`Coordinated emotional modifications with gradient system: flow=${t.flowDirection}\xB0, opacity=${.8*t.layerHarmony}`)}}storeEmotionalHistory(t){this.emotionalHistory.push(t),this.emotionalHistory.length>this.maxHistorySize&&this.emotionalHistory.shift()}handleSettingsChange(t){let{settingKey:e,newValue:i}=t;(e.startsWith("sn-emotional-")||e.startsWith("sn-gradient-"))&&u?.debug?.log("EmotionalGradientMapper","Settings changed via UnifiedEventBus, updating emotional sensitivity",{settingKey:e,newValue:i})}getCurrentEmotionalProfile(){return this.currentEmotionalProfile}getCurrentGradientState(){return{...this.currentGradientState}}getEmotionalHistory(){return[...this.emotionalHistory]}setMoodOverride(t,e=5e3){let i=this.moodProfiles[t];i&&(this.currentGradientState={...this.currentGradientState,...i},this.updateGradientVariables(),setTimeout(()=>{u?.debug?.log("EmotionalGradientMapper","Mood override expired, returning to automatic detection")},e))}applyEmotionalTemperatureToDocument(t){let e=Array.from(document.body.classList).filter(i=>i.startsWith("smooth-emotion-"));document.body.classList.remove(...e),document.body.classList.add(t.cssClass),t.secondaryEmotion&&document.body.classList.add(`smooth-emotion-blend-${t.secondaryEmotion}`),this.cssController.batchSetVariables("EmotionalGradientMapper",t.cssVariables,"high","emotional-temperature-document"),u?.debug?.log("EmotionalGradientMapper","\u{1F321}\uFE0F Applied emotional temperature to document:",{primaryClass:t.cssClass,secondaryEmotion:t.secondaryEmotion,cssVariableCount:Object.keys(t.cssVariables).length})}inferGenreFromProfile(t){let{mood:e,energy:i,valence:r,tension:a,arousal:n,mode:s}=t;return e==="aggressive"||i>.8&&r<.4?a>.7?"metal":"hard-rock":e==="euphoric"||i>.7&&r>.7?n>.8?"edm":"pop":e==="melancholic"||i<.4&&r<.4?s==="minor"?"blues":"folk":e==="peaceful"||i<.3&&r>.6?"ambient":e==="dramatic"||a>.6&&i>.5?"classical":e==="mysterious"||r<.5&&a>.5?"jazz":e==="heroic"||s==="major"&&i>.6?"soundtrack":"indie-pop"}getCurrentEmotionalTemperature(){return this.currentEmotionalTemperature}setEmotionalTemperatureOverride(t,e=1,i=5e3){try{let r={energy:e,valence:e>.5?.7:.3,genre:"override"},a=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(r);a.primaryEmotion=t,a.intensity=e,a.cssClass=`smooth-emotion-${t}`,this.currentEmotionalTemperature=a,this.applyEmotionalTemperatureToDocument(a),u?.debug?.log("EmotionalGradientMapper","\u{1F321}\uFE0F Applied emotional temperature override:",{emotion:t,intensity:e,duration:i}),setTimeout(()=>{u?.debug?.log("EmotionalGradientMapper","\u{1F321}\uFE0F Emotional temperature override expired")},i)}catch(r){u?.debug?.warn("EmotionalGradientMapper","\u{1F321}\uFE0F Failed to apply emotional temperature override:",r)}}destroy(){if(this.isActive=!1,this.emotionAnalysisSubscriptionId&&(p.unsubscribe(this.emotionAnalysisSubscriptionId),this.emotionAnalysisSubscriptionId=null),this.settingsSubscriptionId&&(p.unsubscribe(this.settingsSubscriptionId),this.settingsSubscriptionId=null),u?.debug?.log("EmotionalGradientMapper","Unsubscribed from UnifiedEventBus events"),this.currentEmotionalTemperature){let t=Array.from(document.body.classList).filter(e=>e.startsWith("smooth-emotion-"));document.body.classList.remove(...t)}this.emotionalHistory=[],this.currentEmotionalProfile=null,this.currentEmotionalTemperature=null,u?.debug?.log("EmotionalGradientMapper","Emotional mapping system destroyed")}}});var Si,Xn=v(()=>{"use strict";B();$();_();R();ge();Si=class extends q{constructor(e=w,i,r,a=null){super(e,i,r,a);this.colorHarmonyEngine=null;this.lastBeatTime=0;this.lastFlowUpdate=0;this.flowSmoothingBuffer=[];this.currentGenre=null;this.beatSubscriptionId=null;this.energySubscriptionId=null;this.updateThrottleInterval=1e3/30;this.colorHarmonyEngine=null;let n=A();n?this.cssVariableController=n:(u?.debug?.warn("GradientDirectionalFlowSystem","CSSVariableWriter not available, CSS integration disabled"),this.cssVariableController=null),this.flowSettings={enabled:!0,flowSensitivity:.8,beatResponseStrength:.9,genreAdaptation:!0,spectralSeparation:!0,smoothingFactor:.7,maxFlowIntensity:1,corridorFlowEnabled:!0,radialFlowStrength:.8,inwardFlowIntensity:.7,corridorBeatResponse:1.3},this.currentFlowVector={x:0,y:0,intensity:0,timestamp:performance.now()},this.currentRadialFlow={angle:0,radius:.5,intensity:0,inwardFlow:0,timestamp:performance.now()},this.genreFlowPatterns={electronic:{x:1,y:.2,intensity:.9,timestamp:0},ambient:{x:.3,y:.8,intensity:.4,timestamp:0},rock:{x:.7,y:.5,intensity:.8,timestamp:0},pop:{x:.6,y:.6,intensity:.7,timestamp:0},jazz:{x:.4,y:.7,intensity:.6,timestamp:0},classical:{x:.2,y:.9,intensity:.5,timestamp:0},default:{x:.5,y:.5,intensity:.6,timestamp:0}},this.spectralFlowMapping={bassFlow:{x:.8,y:.2,intensity:.7,timestamp:0},midFlow:{x:.5,y:.6,intensity:.6,timestamp:0},trebleFlow:{x:.3,y:.9,intensity:.5,timestamp:0},harmonyFlow:{x:.6,y:.4,intensity:.8,timestamp:0}},this.flowSmoothingBuffer=Array(5).fill(null).map(()=>({...this.currentFlowVector}))}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization(),this.subscribeToMusicEvents(),this.startFlowUpdates(),u?.debug?.log("GradientDirectionalFlowSystem","Gradient flow system initialized")}subscribeToMusicEvents(){this.beatSubscriptionId=p.subscribe("music:beat",this.handleBeatEvent.bind(this),"GradientDirectionalFlowSystem"),this.energySubscriptionId=p.subscribe("music:energy",this.handleEnergyChange.bind(this),"GradientDirectionalFlowSystem"),u?.debug?.log("GradientDirectionalFlowSystem","Subscribed to unified music events")}handleBeatEvent(e){let i=performance.now();if(i-this.lastBeatTime<50)return;this.lastBeatTime=i;let{intensity:r,bpm:a,confidence:n}=e,s=this.calculateBeatFlow(r,a,n),l=this.applyGenreModifications(s);this.updateFlowVector(l),u?.debug?.log("GradientDirectionalFlowSystem",`Beat flow: ${s.x.toFixed(2)}, ${s.y.toFixed(2)}, intensity: ${s.intensity.toFixed(2)}`)}handleEnergyChange(e){let{energy:i,valence:r}=e,a=i*this.flowSettings.flowSensitivity,n=r*.5;this.currentFlowVector.intensity=Math.min(this.flowSettings.maxFlowIntensity,a+n)}calculateBeatFlow(e,i,r){let n=performance.now()/1e3*(i/60)*Math.PI*2,s=e*this.flowSettings.beatResponseStrength*r,l=Math.cos(n)*s,c=Math.sin(n)*s;return{x:l,y:c,intensity:s,timestamp:performance.now()}}applyGenreModifications(e){if(!this.flowSettings.genreAdaptation||!this.currentGenre)return e;let i=this.genreFlowPatterns[this.currentGenre.genre]||this.genreFlowPatterns.default,r=.3;return{x:e.x*(1-r)+i.x*r,y:e.y*(1-r)+i.y*r,intensity:e.intensity*(1-r)+i.intensity*r,timestamp:performance.now()}}mapSpectralToFlow(e){let{bassEnergy:i,midEnergy:r,trebleEnergy:a,harmonicContent:n}=e;return this.spectralFlowMapping.bassFlow={x:i*.8,y:i*.2,intensity:i,timestamp:performance.now()},this.spectralFlowMapping.midFlow={x:r*.6,y:r*.6,intensity:r,timestamp:performance.now()},this.spectralFlowMapping.trebleFlow={x:a*.2,y:a*.8,intensity:a,timestamp:performance.now()},this.spectralFlowMapping.harmonyFlow={x:n*.5,y:n*.7,intensity:n,timestamp:performance.now()},this.spectralFlowMapping}blendSpectralFlow(e){let i={bass:.4,mid:.3,treble:.2,harmony:.1},r=e.bassFlow.x*i.bass+e.midFlow.x*i.mid+e.trebleFlow.x*i.treble+e.harmonyFlow.x*i.harmony,a=e.bassFlow.y*i.bass+e.midFlow.y*i.mid+e.trebleFlow.y*i.treble+e.harmonyFlow.y*i.harmony,n=e.bassFlow.intensity*i.bass+e.midFlow.intensity*i.mid+e.trebleFlow.intensity*i.treble+e.harmonyFlow.intensity*i.harmony;return{x:r,y:a,intensity:n,timestamp:performance.now()}}updateFlowVector(e){this.flowSmoothingBuffer.push(e),this.flowSmoothingBuffer.length>5&&this.flowSmoothingBuffer.shift();let i=this.calculateSmoothedFlow();this.currentFlowVector=i,this.flowSettings.corridorFlowEnabled&&this.updateRadialFlow(i),this.updateCSSVariables()}calculateSmoothedFlow(){let e=this.flowSmoothingBuffer,i=this.flowSettings.smoothingFactor,r=e[0]?.x||0,a=e[0]?.y||0,n=e[0]?.intensity||0;for(let s=1;s<e.length;s++)r=r*i+e[s].x*(1-i),a=a*i+e[s].y*(1-i),n=n*i+e[s].intensity*(1-i);return{x:r,y:a,intensity:n,timestamp:performance.now()}}updateRadialFlow(e){let s=performance.now()/1e3*.1+e.x*Math.PI*2,l=-Math.cos(s),c=-Math.sin(s),m=Math.sqrt(l*l+c*c),d=l/(m||1),h=c/(m||1),g=this.flowSettings.inwardFlowIntensity,f=this.calculateBeatModifier(),S=this.calculateGenreInwardModifier(),C=Math.min(1,g*f*S*this.flowSettings.corridorBeatResponse);this.currentRadialFlow={angle:Math.atan2(h,d),radius:Math.min(1,m*this.flowSettings.radialFlowStrength),intensity:e.intensity,inwardFlow:C,timestamp:performance.now()},this.cssVariableController&&(this.cssVariableController.queueCSSVariableUpdate("--sn-inward-vector-x",d.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-inward-vector-y",h.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-radial-distance",m.toFixed(3)))}calculateBeatModifier(){if(!this.musicSyncService)return 1;let e=this.musicSyncService.getCurrentMusicState();if(!e)return 1;let r=performance.now()-this.lastBeatTime,n=Math.max(0,1-r/500);return .6+(e.beat?.energy??.5)*.8+n*.4}calculateGenreInwardModifier(){if(!this.currentGenre)return 1;let e={electronic:1.2,ambient:.8,rock:1,pop:.9,jazz:.7,classical:.6},i=this.currentGenre.genre;return e[i]??1}updateCSSVariables(){let e=performance.now();if(!(e-this.lastFlowUpdate<this.updateThrottleInterval)&&(this.lastFlowUpdate=e,this.cssVariableController)){this.cssVariableController.queueCSSVariableUpdate("--sn-flow-direction-x",this.currentFlowVector.x.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-flow-direction-y",this.currentFlowVector.y.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-flow-intensity",this.currentFlowVector.intensity.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-flow-strength",(this.currentFlowVector.intensity*.8).toFixed(3));let i=Math.atan2(this.currentFlowVector.y,this.currentFlowVector.x);this.cssVariableController.queueCSSVariableUpdate("--sn-flow-angle",`${(i*180/Math.PI).toFixed(1)}deg`),this.flowSettings.corridorFlowEnabled?(this.cssVariableController.queueCSSVariableUpdate("--sn-corridor-flow-angle",this.currentRadialFlow.angle.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-corridor-flow-radius",this.currentRadialFlow.radius.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-corridor-inward-flow",this.currentRadialFlow.inwardFlow.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-corridor-flow-intensity",this.currentRadialFlow.intensity.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-corridor-flow-enabled","1")):this.cssVariableController.queueCSSVariableUpdate("--sn-corridor-flow-enabled","0")}}adaptFlowToGenre(e){let i=this.genreFlowPatterns[e.genre]||this.genreFlowPatterns.default;document.dispatchEvent(new CustomEvent("gradient-flow:genre-adapted",{detail:{genre:e,flowPattern:i,timestamp:performance.now()}}))}startFlowUpdates(){let e=()=>{if(!this.isActive)return;let r=performance.now()-this.lastFlowUpdate;this.animateFlowPatterns(r),setTimeout(e,this.updateThrottleInterval)};e()}animateFlowPatterns(e){let i=performance.now()/1e3*.1,r=this.currentFlowVector.x,a=this.currentFlowVector.y,n=r+Math.sin(i)*.05,s=a+Math.cos(i)*.05;this.cssVariableController&&(this.cssVariableController.queueCSSVariableUpdate("--sn-flow-animated-x",n.toFixed(3)),this.cssVariableController.queueCSSVariableUpdate("--sn-flow-animated-y",s.toFixed(3)))}updateAnimation(e){this.animateFlowPatterns(e)}async healthCheck(){let e=this.flowSettings.enabled&&this.currentFlowVector.timestamp>0&&this.musicSyncService!==null;return{system:"GradientDirectionalFlowSystem",healthy:e,metrics:{enabled:this.flowSettings.enabled,lastUpdateTime:this.currentFlowVector.timestamp,musicSyncConnected:!!this.musicSyncService,flowIntensity:this.currentFlowVector.intensity},issues:e?[]:[...this.flowSettings.enabled?[]:["System disabled"],...this.currentFlowVector.timestamp>0?[]:["No flow updates"],...this.musicSyncService?[]:["Music sync disconnected"]]}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),this.beatSubscriptionId&&(p.unsubscribe(this.beatSubscriptionId),this.beatSubscriptionId=null),this.energySubscriptionId&&(p.unsubscribe(this.energySubscriptionId),this.energySubscriptionId=null),u?.debug?.log("GradientDirectionalFlowSystem","Unsubscribed from unified music events")}setFlowSensitivity(e){this.flowSettings.flowSensitivity=Math.max(0,Math.min(1,e))}setBeatResponseStrength(e){this.flowSettings.beatResponseStrength=Math.max(0,Math.min(1,e))}setGenreAdaptation(e){this.flowSettings.genreAdaptation=e}setSpectralSeparation(e){this.flowSettings.spectralSeparation=e}getCurrentFlowVector(){return{...this.currentFlowVector}}getFlowSettings(){return{...this.flowSettings}}getGenreFlowPatterns(){return{...this.genreFlowPatterns}}setCorridorFlowEnabled(e){this.flowSettings.corridorFlowEnabled=e,this.cssVariableController&&this.cssVariableController.queueCSSVariableUpdate("--sn-corridor-flow-enabled",e?"1":"0"),u?.debug?.log("GradientDirectionalFlowSystem",`Corridor flow ${e?"enabled":"disabled"}`)}getCurrentRadialFlow(){return{...this.currentRadialFlow}}updateCorridorFlowSettings(e){e.radialFlowStrength!==void 0&&(this.flowSettings.radialFlowStrength=Math.max(0,Math.min(2,e.radialFlowStrength))),e.inwardFlowIntensity!==void 0&&(this.flowSettings.inwardFlowIntensity=Math.max(0,Math.min(1,e.inwardFlowIntensity))),e.corridorBeatResponse!==void 0&&(this.flowSettings.corridorBeatResponse=Math.max(0,Math.min(3,e.corridorBeatResponse))),u?.debug?.log("GradientDirectionalFlowSystem","Corridor flow settings updated",e)}getCorridorFlowMapping(){return{linearFlow:{...this.currentFlowVector},radialFlow:{...this.currentRadialFlow},enabled:this.flowSettings.corridorFlowEnabled}}calculateInwardVectorForPosition(e,i){let n=.5-e,s=.5-i,l=Math.sqrt(n*n+s*s),c=l>.001?n/l:0,m=l>.001?s/l:0,d=Math.min(1,l*2),h=this.currentFlowVector.intensity*this.flowSettings.inwardFlowIntensity,g=this.calculateBeatModifier(),f=d*h*g;return{inwardX:c,inwardY:m,distanceFromCenter:l,flowIntensity:Math.min(1,f)}}getInwardFlowVectorsForShader(){let e=[];for(let r=0;r<8;r++){let a=r/8*Math.PI*2,n=.4,s=.5+Math.cos(a)*n,l=.5+Math.sin(a)*n,c=this.calculateInwardVectorForPosition(s,l);e.push({angle:a,inwardX:c.inwardX,inwardY:c.inwardY,intensity:c.flowIntensity})}return e}}});var Ci,Zn=v(()=>{"use strict";aa();Dt();B();_();pe();R();te();ge();Ci=class extends q{constructor(e=w,i,r,a=null,n=null){super(e,i,r,a);this.colorHarmonyEngine=null;this.emotionalGradientMapper=null;this.genreProfileManager=null;this.containerElement=null;this.backgroundContainer=null;this.spectralData={bassResponse:0,midResponse:0,trebleResponse:0,vocalPresence:0};this.lastAnimationTime=0;this.scrollY=0;this.scrollX=0;this.boundScrollHandler=null;this.boundResizeHandler=null;this.eventSubscriptionIds=[];this.visualEffectsCoordinator=null;this.currentVisualEffectState=null;this.lerpHalfLifeValues={parallaxOffset:.15,opacity:.2,blur:.25,hueRotate:.3,scale:.18};this.systemName="DepthLayeredGradientSystem";this.layerTemplates={cosmic:{gradient:"radial-gradient(ellipse 60% 40% at 25% 30%, rgba(88, 91, 112, 0.9) 0%, rgba(49, 50, 68, 0.5) 40%, transparent 80%), radial-gradient(ellipse 40% 60% at 75% 70%, rgba(49, 50, 68, 0.7) 0%, rgba(30, 30, 46, 0.3) 50%, transparent 85%), radial-gradient(circle 30% at 50% 50%, rgba(88, 91, 112, 0.4) 0%, transparent 70%)",animation:"cosmic-drift",duration:"120s"},void:{gradient:"radial-gradient(ellipse 50% 35% at 40% 25%, rgba(30, 30, 46, 0.95) 0%, rgba(49, 50, 68, 0.7) 35%, transparent 90%), radial-gradient(ellipse 35% 50% at 65% 75%, rgba(49, 50, 68, 0.8) 0%, rgba(88, 91, 112, 0.4) 45%, transparent 85%), radial-gradient(circle 25% at 20% 80%, rgba(30, 30, 46, 0.6) 0%, transparent 80%)",animation:"void-expansion",duration:"480s"},multiBlobPrimary:{gradient:"radial-gradient(circle 20% at 15% 20%, rgba(203, 166, 247, 0.6) 0%, rgba(203, 166, 247, 0.2) 50%, transparent 70%), radial-gradient(circle 25% at 45% 60%, rgba(245, 194, 231, 0.5) 0%, rgba(245, 194, 231, 0.15) 45%, transparent 75%), radial-gradient(circle 18% at 75% 35%, rgba(137, 180, 250, 0.55) 0%, rgba(137, 180, 250, 0.18) 48%, transparent 72%), radial-gradient(circle 15% at 85% 85%, rgba(203, 166, 247, 0.4) 0%, transparent 65%)",animation:"multi-blob-primary",duration:"200s"},multiBlobSecondary:{gradient:"radial-gradient(circle 22% at 30% 75%, rgba(250, 179, 135, 0.5) 0%, rgba(250, 179, 135, 0.12) 50%, transparent 75%), radial-gradient(circle 28% at 70% 25%, rgba(166, 227, 161, 0.45) 0%, rgba(166, 227, 161, 0.1) 48%, transparent 78%), radial-gradient(circle 16% at 10% 50%, rgba(245, 194, 231, 0.52) 0%, rgba(245, 194, 231, 0.15) 46%, transparent 70%), radial-gradient(circle 20% at 90% 60%, rgba(137, 180, 250, 0.4) 0%, transparent 68%)",animation:"multi-blob-secondary",duration:"280s"},smoothBubbles:{gradient:"radial-gradient(ellipse 45% 35% at 35% 40%, rgba(203, 166, 247, 0.4) 0%, rgba(203, 166, 247, 0.1) 60%, transparent 90%), radial-gradient(ellipse 35% 45% at 70% 65%, rgba(137, 180, 250, 0.35) 0%, rgba(137, 180, 250, 0.08) 65%, transparent 95%), radial-gradient(circle 25% at 25% 75%, rgba(245, 194, 231, 0.3) 0%, transparent 80%), radial-gradient(ellipse 20% 30% at 80% 20%, rgba(250, 179, 135, 0.25) 0%, transparent 75%)",animation:"smooth-bubble-flow",duration:"320s"},nebula:{gradient:"conic-gradient(from 45deg, rgba(203, 166, 247, 0.3) 0%, rgba(245, 194, 231, 0.2) 25%, rgba(250, 179, 135, 0.1) 50%, rgba(166, 227, 161, 0.2) 75%, rgba(203, 166, 247, 0.3) 100%)",animation:"nebula-flow",duration:"180s"},stellar:{gradient:"linear-gradient(45deg, rgba(137, 180, 250, 0.2) 0%, rgba(203, 166, 247, 0.1) 25%, rgba(245, 194, 231, 0.2) 50%, rgba(250, 179, 135, 0.1) 75%, rgba(166, 227, 161, 0.2) 100%)",animation:"stellar-motion",duration:"240s"},dimensional:{gradient:"linear-gradient(135deg, rgba(137, 180, 250, 0.1) 0%, rgba(203, 166, 247, 0.2) 20%, rgba(245, 194, 231, 0.1) 40%, rgba(250, 179, 135, 0.2) 60%, rgba(166, 227, 161, 0.1) 80%, rgba(137, 180, 250, 0.2) 100%)",animation:"dimensional-shift",duration:"360s"}};this.colorHarmonyEngine=n?.colorHarmonyEngine||null,this.visualEffectsCoordinator=n?.backgroundConsciousnessChoreographer||null,this.cssVariableController=null,this.deviceCapabilities=new W,this.depthLayers=new Map,this.visualEffectsLayers=new Map,this.depthSettings={enabled:!0,layerCount:6,maxDepth:1e3,parallaxStrength:.5,depthFogIntensity:.7,infiniteScrolling:!0,qualityLevel:"medium",performanceMode:!1,musicalVisualEffects:{enabled:!0,activityLevel:.7,temporalMemory:.3,harmonicSensitivity:.6,flowDynamics:.4,stellarDensity:.5,dimensionalDepth:3}},this.performanceMetrics={totalLayers:0,visibleLayers:0,averageDepth:0,parallaxRange:0,renderTime:0,memoryUsage:0},this.boundScrollHandler=this.handleScroll.bind(this),this.boundResizeHandler=this.handleResize.bind(this),this.adaptToDeviceCapabilities()}setOptimizedCSSVariableManager(e){this.cssVariableController=e,this.initializeMusicalVisualEffects()}async initializeMusicalVisualEffectsAsync(){this.initializeMusicalVisualEffects(),this.emotionalGradientMapper&&await this.emotionalGradientMapper.initialize()}initializeMusicalVisualEffects(){if(!this.cssVariableController){u?.debug?.warn("DepthLayeredGradientSystem","CSS variable controller not available, musical visual effects disabled");return}try{this.emotionalGradientMapper=new pt(this.cssVariableController,this.musicSyncService),this.genreProfileManager=new ye,u?.debug?.log("DepthLayeredGradientSystem","Musical visual effects components initialized")}catch(e){u?.debug?.error("DepthLayeredGradientSystem","Failed to initialize musical visual effects:",e),this.emotionalGradientMapper=null,this.genreProfileManager=null}}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization(),this.loadSettings(),this.createContainerElements(),this.createDepthAnimations(),this.initializeDepthLayers(),this.initializeVisualEffectsLayers(),this.cssVariableController&&await this.initializeMusicalVisualEffectsAsync(),this.setupEventListeners(),this.registerWithVisualEffectsCoordinator(),u?.debug?.log("DepthLayeredGradientSystem","Depth-layered gradient system initialized")}loadSettings(){}adaptToDeviceCapabilities(){switch(this.deviceCapabilities.recommendPerformanceQuality()){case"low":this.depthSettings.qualityLevel="low",this.depthSettings.layerCount=3,this.depthSettings.performanceMode=!0;break;case"balanced":this.depthSettings.qualityLevel="medium",this.depthSettings.layerCount=6,this.depthSettings.performanceMode=!1;break;case"high":this.depthSettings.qualityLevel="high",this.depthSettings.layerCount=9,this.depthSettings.performanceMode=!1;break}}adjustQualitySettings(){switch(this.depthSettings.qualityLevel){case"low":this.depthSettings.layerCount=3,this.depthSettings.parallaxStrength=.3,this.depthSettings.depthFogIntensity=.5;break;case"medium":this.depthSettings.layerCount=6,this.depthSettings.parallaxStrength=.5,this.depthSettings.depthFogIntensity=.7;break;case"high":this.depthSettings.layerCount=9,this.depthSettings.parallaxStrength=.8,this.depthSettings.depthFogIntensity=.9;break}}createContainerElements(){this.containerElement=document.querySelector(".Root__main-view")||document.querySelector(".main-view-container")||document.body,this.backgroundContainer=document.createElement("div"),this.backgroundContainer.className="sn-depth-background-container",this.backgroundContainer.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -20;
      pointer-events: none;
      overflow: hidden;
      perspective: 1000px;
      transform-style: preserve-3d;
    `,this.containerElement.insertBefore(this.backgroundContainer,this.containerElement.firstChild)}createDepthAnimations(){let e=document.createElement("style");e.textContent=`
      .sn-depth-layer {
        position: absolute;
        width: 120%;
        height: 120%;
        top: -10%;
        left: -10%;
        pointer-events: none;
        transform-style: preserve-3d;
        will-change: transform, opacity;
      }

      @keyframes cosmic-drift {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        25% { transform: translate3d(-2%, 1%, 0) rotate(0.5deg) scale(1.02); }
        50% { transform: translate3d(0, -1%, 0) rotate(0deg) scale(0.98); }
        75% { transform: translate3d(2%, 0.5%, 0) rotate(-0.5deg) scale(1.01); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes nebula-flow {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        33% { transform: translate3d(1%, -1%, 0) rotate(1deg) scale(1.03); }
        66% { transform: translate3d(-1%, 1%, 0) rotate(-1deg) scale(0.97); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes stellar-motion {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        20% { transform: translate3d(-1%, 0.5%, 0) rotate(0.3deg) scale(1.01); }
        40% { transform: translate3d(0.5%, -0.5%, 0) rotate(-0.3deg) scale(0.99); }
        60% { transform: translate3d(1%, 0.5%, 0) rotate(0.2deg) scale(1.02); }
        80% { transform: translate3d(-0.5%, 1%, 0) rotate(-0.2deg) scale(0.98); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes quantum-field {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); filter: blur(0px); }
        25% { transform: translate3d(0.5%, -0.5%, 0) rotate(0.1deg) scale(1.01); filter: blur(0.5px); }
        50% { transform: translate3d(-0.5%, 0.5%, 0) rotate(-0.1deg) scale(0.99); filter: blur(1px); }
        75% { transform: translate3d(0.3%, 0.3%, 0) rotate(0.05deg) scale(1.005); filter: blur(0.3px); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); filter: blur(0px); }
      }

      @keyframes dimensional-shift {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        16% { transform: translate3d(0.2%, -0.2%, 0) rotate(0.1deg) scale(1.005); }
        32% { transform: translate3d(-0.2%, 0.2%, 0) rotate(-0.1deg) scale(0.995); }
        48% { transform: translate3d(0.1%, 0.1%, 0) rotate(0.05deg) scale(1.002); }
        64% { transform: translate3d(-0.1%, -0.1%, 0) rotate(-0.05deg) scale(0.998); }
        80% { transform: translate3d(0.15%, 0%, 0) rotate(0.02deg) scale(1.001); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes void-expansion {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.9; }
        50% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1.1); opacity: 0.6; }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.9; }
      }

      @keyframes multi-blob-primary {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.8; }
        20% { transform: translate3d(1%, -0.5%, 0) rotate(0.3deg) scale(1.03); opacity: 0.9; }
        40% { transform: translate3d(-0.5%, 1%, 0) rotate(-0.2deg) scale(0.97); opacity: 0.7; }
        60% { transform: translate3d(0.8%, 0.3%, 0) rotate(0.4deg) scale(1.05); opacity: 0.85; }
        80% { transform: translate3d(-0.3%, -0.8%, 0) rotate(-0.3deg) scale(0.98); opacity: 0.75; }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.8; }
      }

      @keyframes multi-blob-secondary {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.7; }
        25% { transform: translate3d(-1.2%, 0.8%, 0) rotate(-0.4deg) scale(1.04); opacity: 0.85; }
        50% { transform: translate3d(0.6%, -0.6%, 0) rotate(0.3deg) scale(0.96); opacity: 0.6; }
        75% { transform: translate3d(0.3%, 1.1%, 0) rotate(-0.2deg) scale(1.02); opacity: 0.8; }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.7; }
      }

      @keyframes smooth-bubble-flow {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.75; }
        12% { transform: translate3d(0.4%, -0.3%, 0) rotate(0.15deg) scale(1.02); opacity: 0.85; }
        24% { transform: translate3d(-0.3%, 0.6%, 0) rotate(-0.25deg) scale(0.98); opacity: 0.65; }
        36% { transform: translate3d(0.7%, 0.2%, 0) rotate(0.35deg) scale(1.04); opacity: 0.8; }
        48% { transform: translate3d(-0.2%, -0.5%, 0) rotate(-0.15deg) scale(0.99); opacity: 0.7; }
        60% { transform: translate3d(0.5%, 0.8%, 0) rotate(0.25deg) scale(1.03); opacity: 0.85; }
        72% { transform: translate3d(-0.6%, -0.1%, 0) rotate(-0.3deg) scale(0.97); opacity: 0.6; }
        84% { transform: translate3d(0.1%, -0.7%, 0) rotate(0.1deg) scale(1.01); opacity: 0.8; }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.75; }
      }

      @media (prefers-reduced-motion: reduce) {
        .sn-depth-layer {
          animation: none !important;
        }
      }
    `,document.head.appendChild(e)}initializeDepthLayers(){if(!this.backgroundContainer)return;let e=Object.keys(this.layerTemplates);for(let i=0;i<this.depthSettings.layerCount;i++){let r=(i+1)*(this.depthSettings.maxDepth/this.depthSettings.layerCount),a=e[i%e.length],n=this.layerTemplates[a],s=document.createElement("div");s.className="sn-depth-layer",s.id=`sn-depth-layer-${i}`;let l=r/this.depthSettings.maxDepth,c=1-l*this.depthSettings.parallaxStrength,m=1-l*this.depthSettings.depthFogIntensity,d=1+l*.2,h=l*3;s.style.cssText=`
        background: ${n.gradient};
        transform: translate3d(0, 0, ${-r}px) scale(${d});
        opacity: ${m};
        filter: blur(${h}px);
        animation: ${n.animation} ${n.duration} ease-in-out infinite;
        animation-delay: ${i*.5}s;
      `;let g={id:`depth-layer-${i}`,element:s,depth:r,parallaxFactor:c,opacityRange:[m*.5,m],scaleRange:[d*.95,d*1.05],rotationSpeed:.01+i*.001,colorShift:i*30,blurAmount:h,animationPhase:i*Math.PI/4,enabled:!0,currentOffsetY:0,targetOffsetY:0,currentOpacity:m,targetOpacity:m,currentBlur:h,targetBlur:h,currentHueRotate:0,targetHueRotate:0,currentScale:d,targetScale:d};this.depthLayers.set(g.id,g),this.backgroundContainer.appendChild(s)}this.updatePerformanceMetrics(),u?.debug?.log("DepthLayeredGradientSystem",`Initialized ${this.depthLayers.size} depth layers`)}initializeVisualEffectsLayers(){if(!this.backgroundContainer||!this.depthSettings.musicalVisualEffects.enabled)return;let e=this.performanceMonitor?.averageFPS||60,i=this.performanceMonitor?.getDeviceTier?.()==="low"||!1,r=this.performanceMonitor?.shouldReduceQuality?.()||!1;if(e<45||i||r){this.depthSettings.musicalVisualEffects.enabled=!1,u?.debug?.log("DepthLayeredGradientSystem",`Performance mode activated - visual effects layers disabled (FPS: ${e})`);return}let a=this.findSpotifyContainer(),n=document.createElement("div");n.className="sn-harmonic-layer",n.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -8;
      pointer-events: none;
      will-change: auto;
    `;let s=document.createElement("div");s.className="sn-flow-dynamics-primary",s.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -7;
      pointer-events: none;
      will-change: auto;
    `;let l=document.createElement("div");l.className="sn-wave-dynamics",l.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -5;
      pointer-events: none;
      will-change: transform, opacity, clip-path;
    `;let c=document.createElement("div");c.className="sn-flow-effects",c.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -4;
      pointer-events: none;
      will-change: transform, opacity, clip-path;
    `;let m=document.createElement("div");m.className="sn-procedural-nebula",m.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -3;
      pointer-events: none;
      will-change: transform, opacity, filter;
    `;let d=document.createElement("div");d.className="sn-stellar-layer",d.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -6;
      pointer-events: none;
      will-change: auto;
    `,this.visualEffectsLayers.set("harmonic",n),this.visualEffectsLayers.set("flowDynamics",s),this.visualEffectsLayers.set("waveDynamics",l),this.visualEffectsLayers.set("flowEffects",c),this.visualEffectsLayers.set("proceduralNebula",m),this.visualEffectsLayers.set("stellar",d),a.appendChild(n),a.appendChild(s),a.appendChild(d),a.appendChild(l),a.appendChild(c),a.appendChild(m),u?.debug?.log("DepthLayeredGradientSystem",`Initialized ${this.visualEffectsLayers.size} visual effects layers`)}findSpotifyContainer(){let e=[".Root__main-view",".main-view-container",".main-gridContainer-gridContainer",".Root__top-container","body"];for(let i of e){let r=document.querySelector(i);if(r)return r}return document.body}setupEventListeners(){this.boundScrollHandler&&window.addEventListener("scroll",this.boundScrollHandler,{passive:!0}),this.boundResizeHandler&&window.addEventListener("resize",this.boundResizeHandler,{passive:!0});let e=p.subscribe("music:beat",this.handleMusicBeat.bind(this),"DepthLayeredGradientSystem");this.eventSubscriptionIds.push(e);let i=p.subscribe("music:energy",this.handleMusicEnergy.bind(this),"DepthLayeredGradientSystem");this.eventSubscriptionIds.push(i),u?.debug?.log("DepthLayeredGradientSystem","Event listeners set up",{unifiedEventSubscriptions:this.eventSubscriptionIds.length})}handleScroll(e){this.scrollY=window.scrollY,this.scrollX=window.scrollX,this.updateParallaxEffects()}handleResize(e){this.updateLayerDimensions()}handleMusicBeat(e){this.pulseDepthLayers(e.intensity),this.handleMusicalVisualEffectsBeat(e.intensity),u?.debug?.log("DepthLayeredGradientSystem","Music beat processed",{bpm:e.bpm,intensity:e.intensity})}handleMusicEnergy(e){this.updateDepthWithMusicEnergy(e.energy),this.handleMusicalVisualEffectsSpectralData({energy:e.energy,valence:e.valence}),u?.debug?.log("DepthLayeredGradientSystem","Music energy processed",{energy:e.energy,valence:e.valence})}handleMusicalVisualEffectsBeat(e){this.depthSettings.musicalVisualEffects.enabled&&this.updateFlowDynamics(e)}handleMusicalVisualEffectsSpectralData(e){this.depthSettings.musicalVisualEffects.enabled&&(this.spectralData.bassResponse=e.energy*.8,this.spectralData.midResponse=e.energy*.6,this.spectralData.trebleResponse=e.energy*.4,this.spectralData.vocalPresence=e.valence*.7,this.updateSpectralVariables())}updateParallaxEffects(){this.depthSettings.infiniteScrolling&&this.depthLayers.forEach(e=>{let i=this.scrollY*e.parallaxFactor,r=this.scrollX*e.parallaxFactor*.5;this.cssVariableController&&(this.cssVariableController.queueCSSVariableUpdate(`--layer-${e.depth}-x`,`${r}px`),this.cssVariableController.queueCSSVariableUpdate(`--layer-${e.depth}-y`,`${i}px`),this.cssVariableController.queueCSSVariableUpdate(`--layer-${e.depth}-z`,`${-e.depth}px`))})}updateLayerDimensions(){this.depthLayers.forEach(e=>{let r=1+e.depth/this.depthSettings.maxDepth*.2;this.cssVariableController&&this.cssVariableController.queueCSSVariableUpdate(`--layer-${e.depth}-scale`,r.toString())})}updateDepthWithMusicEnergy(e){let i=e*.3;this.depthLayers.forEach(r=>{let a=r.opacityRange[0],n=r.opacityRange[1],s=a+i*(n-a);this.cssVariableController&&this.cssVariableController.queueCSSVariableUpdate(`--layer-${r.depth}-opacity`,s.toString())})}pulseDepthLayers(e){let i=e*.1;this.depthLayers.forEach(r=>{let a=r.scaleRange[0],n=r.scaleRange[1],s=a+i*(n-a);this.cssVariableController&&(this.cssVariableController.queueCSSVariableUpdate(`--layer-${r.depth}-pulse-scale`,s.toString()),setTimeout(()=>{this.cssVariableController&&this.cssVariableController.queueCSSVariableUpdate(`--layer-${r.depth}-pulse-scale`,a.toString())},200))})}updateDepthAnimations(e){let i=e/1e3;this.depthLayers.forEach(r=>{r.animationPhase+=r.rotationSpeed*e*.001,this.updateLayerTargetsFromMusic(r),r.currentOffsetY=K(r.currentOffsetY,r.targetOffsetY,i,this.lerpHalfLifeValues.parallaxOffset),r.currentOpacity=K(r.currentOpacity,r.targetOpacity,i,this.lerpHalfLifeValues.opacity),r.currentBlur=K(r.currentBlur,r.targetBlur,i,this.lerpHalfLifeValues.blur),r.currentHueRotate=K(r.currentHueRotate,r.targetHueRotate,i,this.lerpHalfLifeValues.hueRotate),r.currentScale=K(r.currentScale,r.targetScale,i,this.lerpHalfLifeValues.scale),this.applyLayerProperties(r)})}updateLayerTargetsFromMusic(e){let i=this.musicSyncService?.getCurrentMusicState();if(i){let{intensity:r,beat:a,emotion:n}=i,s=Math.sin(e.animationPhase)*.05*r,l=e.opacityRange[0]+(e.opacityRange[1]-e.opacityRange[0])*.5;e.targetOpacity=Math.max(0,Math.min(1,l+s)),e.targetOffsetY=this.scrollY*e.parallaxFactor+Math.sin(e.animationPhase*.5)*r*10;let c=e.scaleRange[0]+(e.scaleRange[1]-e.scaleRange[0])*.5;if(e.targetScale=c+r*.05,e.targetBlur=e.blurAmount+r*2,n){let m=n==="energetic"?15:n==="calm"?-10:n==="melancholy"?-20:0;e.targetHueRotate=m+e.colorShift*.1}}else{let r=Math.sin(e.animationPhase)*.02,a=e.opacityRange[0]+(e.opacityRange[1]-e.opacityRange[0])*.5;e.targetOpacity=Math.max(0,Math.min(1,a+r)),e.targetOffsetY=this.scrollY*e.parallaxFactor,e.targetScale=e.scaleRange[0]+(e.scaleRange[1]-e.scaleRange[0])*.5,e.targetBlur=e.blurAmount,e.targetHueRotate=0}}applyLayerProperties(e){this.cssVariableController&&(this.cssVariableController.queueCSSVariableUpdate(`--layer-${e.depth}-offset-y`,`${e.currentOffsetY}px`),this.cssVariableController.queueCSSVariableUpdate(`--layer-${e.depth}-depth-z`,`${-e.depth}px`),this.cssVariableController.queueCSSVariableUpdate(`--layer-${e.depth}-scale`,e.currentScale.toString()),this.cssVariableController.queueCSSVariableUpdate(`--layer-${e.depth}-opacity`,e.currentOpacity.toString()),this.cssVariableController.queueCSSVariableUpdate(`--layer-${e.depth}-blur`,`${e.currentBlur}px`),this.cssVariableController.queueCSSVariableUpdate(`--layer-${e.depth}-hue`,`${e.currentHueRotate}deg`))}updatePerformanceMetrics(){this.performanceMetrics.totalLayers=this.depthLayers.size,this.performanceMetrics.visibleLayers=Array.from(this.depthLayers.values()).filter(e=>e.currentOpacity>.01).length,this.performanceMetrics.averageDepth=Array.from(this.depthLayers.values()).reduce((e,i)=>e+i.depth,0)/this.depthLayers.size,this.performanceMetrics.parallaxRange=this.depthSettings.parallaxStrength,this.performanceMetrics.renderTime=performance.now()-this.lastAnimationTime,this.cssVariableController&&(this.cssVariableController.queueCSSVariableUpdate("--sn-depth-layers-total",this.performanceMetrics.totalLayers.toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-depth-layers-visible",this.performanceMetrics.visibleLayers.toString()))}updateVisualEffectsVariables(){if(!this.cssVariableController||!this.depthSettings.musicalVisualEffects.enabled)return;let e=this.performanceMonitor?.currentFPS||60;if(e<40&&this.depthSettings.musicalVisualEffects.enabled){this.depthSettings.musicalVisualEffects.enabled=!1,this.destroyVisualEffectsLayers(),u?.debug?.log("DepthLayeredGradientSystem",`Runtime performance degradation detected - visual effects layers disabled (FPS: ${e})`);return}let i=this.depthSettings.musicalVisualEffects;[["--sn-gradient-activity-level",i.activityLevel.toString()],["--sn-gradient-temporal-memory",i.temporalMemory.toString()],["--sn-gradient-harmonic-resonance",i.harmonicSensitivity.toString()],["--sn-gradient-flow-dynamics",i.flowDynamics.toString()],["--sn-gradient-nebula-density",i.stellarDensity.toString()],["--sn-gradient-dimensional-depth",i.dimensionalDepth.toString()],["--sn-gradient-layer-activity","1"],["--sn-gradient-layer-temporal","0.8"],["--sn-gradient-layer-harmonic",(i.harmonicSensitivity*.6).toString()],["--sn-gradient-layer-flow",(i.flowDynamics*.4).toString()],["--sn-gradient-layer-stellar",(i.stellarDensity*.2).toString()],["--sn-gradient-wave-intensity",(Math.round(i.activityLevel*40)/100).toString()],["--sn-gradient-flow-intensity",(Math.round(i.harmonicSensitivity*30)/100).toString()],["--sn-gradient-temporal-flow-speed",Math.max(.5,Math.round(i.temporalMemory*100)/100).toString()]].forEach(([a,n])=>{a&&n!==void 0&&this.cssVariableController&&this.cssVariableController.queueCSSVariableUpdate(a,n)})}updateSpectralVariables(){this.cssVariableController&&(this.cssVariableController.queueCSSVariableUpdate("--sn-gradient-bass-response",this.spectralData.bassResponse.toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-gradient-mid-response",this.spectralData.midResponse.toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-gradient-treble-response",this.spectralData.trebleResponse.toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-gradient-vocal-presence",this.spectralData.vocalPresence.toString()))}updateFlowDynamics(e){if(!this.cssVariableController)return;let i=Math.min(this.depthSettings.musicalVisualEffects.flowDynamics+e*.3,1);this.cssVariableController.queueCSSVariableUpdate("--sn-gradient-flow-dynamics",i.toString()),setTimeout(()=>{this.cssVariableController&&this.cssVariableController.queueCSSVariableUpdate("--sn-gradient-flow-dynamics",this.depthSettings.musicalVisualEffects.flowDynamics.toString())},500)}destroyVisualEffectsLayers(){this.visualEffectsLayers.forEach((e,i)=>{e.parentNode&&e.parentNode.removeChild(e)}),this.visualEffectsLayers.clear(),this.cssVariableController&&["--sn-gradient-activity-level","--sn-gradient-layer-activity","--sn-gradient-layer-temporal","--sn-gradient-layer-harmonic","--sn-gradient-layer-flow","--sn-gradient-layer-stellar"].forEach(i=>{this.cssVariableController.queueCSSVariableUpdate(i,"0")})}updateAnimation(e){if(this.isActive&&(this.updateDepthAnimations(e),this.updatePerformanceMetrics(),this.depthSettings.musicalVisualEffects.enabled&&this.cssVariableController)){let i=performance.now(),r=i/1e4%1;this.cssVariableController.queueCSSVariableUpdate("--sn-gradient-temporal-phase",r.toString()),i%1e3<16&&this.updateVisualEffectsVariables()}}async healthCheck(){let e=this.depthSettings.enabled&&this.depthLayers.size>0&&this.backgroundContainer!==null;return{system:"DepthLayeredGradientSystem",healthy:e,metrics:{enabled:this.depthSettings.enabled,layerCount:this.depthLayers.size,hasContainer:!!this.backgroundContainer,layerSettings:this.depthSettings.layerCount},issues:e?[]:[...this.depthSettings.enabled?[]:["System disabled"],...this.depthLayers.size>0?[]:["No active layers"],...this.backgroundContainer?[]:["Missing container element"]]}}_performSystemSpecificCleanup(){if(super._performSystemSpecificCleanup(),this.visualEffectsCoordinator)try{this.visualEffectsCoordinator.unregisterVisualEffectsParticipant("DepthLayeredGradientSystem"),u?.debug?.log("DepthLayeredGradientSystem","Unregistered from visual effects coordinator")}catch(e){u?.debug?.error("DepthLayeredGradientSystem","Error unregistering from visual effects coordinator:",e)}this.boundScrollHandler&&window.removeEventListener("scroll",this.boundScrollHandler),this.boundResizeHandler&&window.removeEventListener("resize",this.boundResizeHandler),this.eventSubscriptionIds.forEach(e=>{p.unsubscribe(e)}),this.eventSubscriptionIds=[],this.depthLayers.forEach(e=>{e.element.parentNode&&e.element.parentNode.removeChild(e.element)}),this.depthLayers.clear(),this.destroyVisualEffectsLayers(),this.emotionalGradientMapper&&(this.emotionalGradientMapper.destroy(),this.emotionalGradientMapper=null),this.genreProfileManager=null,this.backgroundContainer&&this.backgroundContainer.parentNode&&(this.backgroundContainer.parentNode.removeChild(this.backgroundContainer),this.backgroundContainer=null),this.boundScrollHandler=null,this.boundResizeHandler=null}setDepthEnabled(e){this.depthSettings.enabled=e,this.backgroundContainer&&(this.backgroundContainer.style.display=e?"block":"none")}setQualityLevel(e){this.depthSettings.qualityLevel=e,this.adjustQualitySettings(),this.depthLayers.forEach(i=>{i.element.parentNode&&i.element.parentNode.removeChild(i.element)}),this.depthLayers.clear(),this.initializeDepthLayers()}setParallaxStrength(e){this.depthSettings.parallaxStrength=Math.max(0,Math.min(1,e)),this.depthLayers.forEach(i=>{let r=i.depth/this.depthSettings.maxDepth;i.parallaxFactor=1-r*this.depthSettings.parallaxStrength})}setDepthFogIntensity(e){this.depthSettings.depthFogIntensity=Math.max(0,Math.min(1,e)),this.depthLayers.forEach(i=>{let a=1-i.depth/this.depthSettings.maxDepth*this.depthSettings.depthFogIntensity;this.cssVariableController&&this.cssVariableController.queueCSSVariableUpdate(`--layer-${i.depth}-fog-opacity`,a.toString()),i.currentOpacity=a})}getDepthSettings(){return{...this.depthSettings}}getPerformanceMetrics(){return{...this.performanceMetrics}}getDepthLayerCount(){return this.depthLayers.size}getVisibleLayerCount(){return this.performanceMetrics.visibleLayers}setVisualEffectsLevel(e){this.depthSettings.musicalVisualEffects.activityLevel=Math.max(0,Math.min(1,e)),this.updateVisualEffectsVariables()}setTemporalMemory(e){this.depthSettings.musicalVisualEffects.temporalMemory=Math.max(0,Math.min(1,e)),this.updateVisualEffectsVariables()}setHarmonicSensitivity(e){this.depthSettings.musicalVisualEffects.harmonicSensitivity=Math.max(0,Math.min(1,e)),this.updateVisualEffectsVariables()}setStellarDrift(e){this.cssVariableController&&this.cssVariableController.queueCSSVariableUpdate("--sn-gradient-stellar-drift",`${e}deg`)}getVisualEffectsMetrics(){return{activityLevel:this.depthSettings.musicalVisualEffects.activityLevel,temporalMemory:this.depthSettings.musicalVisualEffects.temporalMemory,harmonicSensitivity:this.depthSettings.musicalVisualEffects.harmonicSensitivity,flowDynamics:this.depthSettings.musicalVisualEffects.flowDynamics,stellarDensity:this.depthSettings.musicalVisualEffects.stellarDensity,dimensionalDepth:this.depthSettings.musicalVisualEffects.dimensionalDepth,spectralData:{...this.spectralData},emotionalProfile:this.emotionalGradientMapper?.getCurrentEmotionalProfile()||null,gradientState:this.emotionalGradientMapper?.getCurrentGradientState()||null,currentGenre:this.genreProfileManager?.getCurrentGenre()||null,genreConfidence:this.genreProfileManager?.getGenreConfidence()||0,genreHistory:this.genreProfileManager?.getGenreHistory()||[]}}getEmotionalGradientMapper(){return this.emotionalGradientMapper}getGenreProfileManager(){return this.genreProfileManager}registerWithVisualEffectsCoordinator(){if(!this.visualEffectsCoordinator){u?.debug?.log("DepthLayeredGradientSystem","Visual effects coordinator not available, skipping registration");return}try{this.visualEffectsCoordinator.registerVisualEffectsParticipant(this),u?.debug?.log("DepthLayeredGradientSystem","Successfully registered with visual effects coordinator")}catch(e){u?.debug?.error("DepthLayeredGradientSystem","Failed to register with visual effects coordinator:",e)}}get systemPriority(){return"high"}getVisualEffectsContribution(){return{depthPerception:this.depthSettings.maxDepth/10,layerCount:this.depthLayers.size,parallaxStrength:this.depthSettings.parallaxStrength,fogDensity:this.depthSettings.depthFogIntensity,infinityPerception:this.depthSettings.infiniteScrolling?1:.5,spatialAwareness:this.performanceMetrics.visibleLayers/this.performanceMetrics.totalLayers}}onVisualEffectsFieldUpdate(e){try{this.currentVisualEffectState=e,this.updateDepthFromVisualEffects(e),u?.debug?.log("DepthLayeredGradientSystem","Updated from visual effects field:",{rhythmicPulse:e.pulseRate,depthPerception:e.depthPerception,animationCycle:e.pulseRate})}catch(i){u?.debug?.error("DepthLayeredGradientSystem","Error updating from visual effects field:",i)}}updateDepthFromVisualEffects(e){let i=this.depthSettings.parallaxStrength*(.7+e.pulseRate*.6);for(let[r,a]of this.depthLayers.entries()){if(!a.element)continue;let s=(a.opacityRange[0]+(a.opacityRange[1]-a.opacityRange[0])*e.flowDirection.x)*(.8+e.depthPerception*.4),l=1+Math.sin(e.pulseRate*Math.PI*2)*.05,m=(a.scaleRange[0]+(a.scaleRange[1]-a.scaleRange[0])*e.energyLevel)*l;if(this.cssVariableController){this.cssVariableController.queueCSSVariableUpdate(`--layer-${a.depth}-effect-opacity`,s.toString()),this.cssVariableController.queueCSSVariableUpdate(`--layer-${a.depth}-effect-scale`,m.toString()),this.cssVariableController.queueCSSVariableUpdate(`--layer-${a.depth}-effect-translate-z`,`${a.depth*i}px`),this.cssVariableController.queueCSSVariableUpdate(`--layer-${a.depth}-effect-rotate`,`${a.animationPhase*a.rotationSpeed}deg`);let d=a.blurAmount*(1+e.depthPerception*.5);this.cssVariableController.queueCSSVariableUpdate(`--layer-${a.depth}-effect-blur`,`${d}px`)}a.currentOpacity=s}this.cssVariableController&&(this.cssVariableController.queueCSSVariableUpdate("--sn-depth-activity-parallax",i.toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-depth-perception-intensity",e.depthPerception.toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-depth-fog-intensity",this.depthSettings.depthFogIntensity.toString()),this.cssVariableController.queueCSSVariableUpdate("--sn-depth-spatial-awareness",(this.performanceMetrics.visibleLayers/this.performanceMetrics.totalLayers).toString()))}updateLayerScalesWithAnimation(e){let i=Math.sin(e*Math.PI*2)*.03;for(let r of this.depthLayers.values()){if(!r.element)continue;let n=(r.scaleRange[0]+(r.scaleRange[1]-r.scaleRange[0])*.5)*(1+i);this.cssVariableController&&this.cssVariableController.queueCSSVariableUpdate(`--layer-${r.depth}-anim-scale`,n.toString())}}updateDepthFogIntensity(){for(let e of this.depthLayers.values()){if(!e.element)continue;let i=e.depth/this.depthSettings.maxDepth*this.depthSettings.depthFogIntensity,r=Math.max(0,Math.min(.8,i)),a=50*i;this.cssVariableController&&(this.cssVariableController.queueCSSVariableUpdate(`--layer-${e.depth}-fog-spread`,`${a}px`),this.cssVariableController.queueCSSVariableUpdate(`--layer-${e.depth}-fog-opacity`,r.toString()))}}updateDepthPerception(){let e=Array.from(this.depthLayers.values()).sort((i,r)=>i.depth-r.depth);e.forEach((i,r)=>{let a=r/(e.length-1);if(i.depth=a*this.depthSettings.maxDepth,i.element){let n=i.depth*this.depthSettings.parallaxStrength;this.cssVariableController&&this.cssVariableController.queueCSSVariableUpdate(`--layer-${i.depth}-translate-z`,`${n}px`)}})}onVisualStateUpdate(e){this.onVisualEffectsFieldUpdate(e)}onVisualEffectEvent(e,i){switch(e){case"visual-effects:rhythm-shift":i.intensity&&(this.depthSettings.parallaxStrength=Math.min(10,i.intensity*5));break;case"visual-effects:color-shift":this.forceRepaint?.("color-shift");break;case"visual-effects:energy-surge":i.intensity>.6&&(this.depthSettings.depthFogIntensity=Math.min(1,i.intensity));break}}getVisualContribution(){return{depthPerception:this.depthSettings.parallaxStrength/10,effectDepth:this.depthSettings.depthFogIntensity,visualCoherence:this.depthSettings.maxDepth/100}}onConsciousnessFieldUpdate(e){return this.onVisualEffectsFieldUpdate(e)}getConsciousnessContribution(){return this.getVisualEffectsContribution()}setConsciousnessLevel(e){return this.setVisualEffectsLevel(e)}getConsciousnessMetrics(){return this.getVisualEffectsMetrics()}onChoreographyEvent(e,i){return this.onVisualEffectEvent(e,i)}}});var na={};ne(na,{DEFAULT_VERTEX_SHADER:()=>Vt,ShaderLoader:()=>Q,createGradientTexture:()=>me});function me(o,t,e=256){try{if(!o)return u?.debug?.error("ShaderLoader","WebGL context is null or undefined"),null;if(!t||t.length===0)return u?.debug?.error("ShaderLoader","Invalid or empty color stops array"),null;if(e<=0||e>8192)return u?.debug?.error("ShaderLoader",`Invalid texture width: ${e}`),null;let i=o.getError();if(i!==o.NO_ERROR&&u?.debug?.warn("ShaderLoader",`WebGL context has pending error: ${i}`),o.isContextLost())return u?.debug?.error("ShaderLoader","WebGL context is lost"),null;let r=document.createElement("canvas");if(!r)return u?.debug?.error("ShaderLoader","Failed to create canvas element"),null;r.width=e,r.height=1;let a=r.getContext("2d",{willReadFrequently:!1});if(!a)return u?.debug?.error("ShaderLoader","Failed to get 2D canvas context"),null;let n=t.filter(c=>typeof c.r!="number"||typeof c.g!="number"||typeof c.b!="number"||typeof c.a!="number"||typeof c.position!="number"?(u?.debug?.warn("ShaderLoader","Invalid color stop found, skipping"),!1):((c.position<0||c.position>1)&&(u?.debug?.warn("ShaderLoader",`Invalid color stop position: ${c.position}, clamping`),c.position=Math.max(0,Math.min(1,c.position))),!0));if(n.length===0)return u?.debug?.error("ShaderLoader","No valid color stops after validation"),null;n.sort((c,m)=>c.position-m.position);let s=a.createLinearGradient(0,0,e,0);if(!s)return u?.debug?.error("ShaderLoader","Failed to create linear gradient"),null;try{n.forEach((c,m)=>{let d=Math.max(0,Math.min(255,Math.round(c.r*255))),h=Math.max(0,Math.min(255,Math.round(c.g*255))),g=Math.max(0,Math.min(255,Math.round(c.b*255))),f=Math.max(0,Math.min(1,c.a)),S=`rgba(${d}, ${h}, ${g}, ${f})`;s.addColorStop(c.position,S)})}catch(c){return u?.debug?.error("ShaderLoader","Failed to add color stops to gradient:",c),null}try{a.fillStyle=s,a.fillRect(0,0,e,1)}catch(c){return u?.debug?.error("ShaderLoader","Failed to fill canvas with gradient:",c),null}let l=o.createTexture();if(!l)return u?.debug?.error("ShaderLoader","Failed to create WebGL texture - gl.createTexture() returned null"),null;try{o.bindTexture(o.TEXTURE_2D,l);let c=o.getError();if(c!==o.NO_ERROR)return u?.debug?.error("ShaderLoader",`WebGL error after texture binding: ${c}`),o.deleteTexture(l),null;o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,r);let m=o.getError();if(m!==o.NO_ERROR)return u?.debug?.error("ShaderLoader",`WebGL error after texture upload: ${m}`),o.deleteTexture(l),null;o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR);let d=o.getError();return d!==o.NO_ERROR?(u?.debug?.error("ShaderLoader",`WebGL error after setting texture parameters: ${d}`),o.deleteTexture(l),null):(o.bindTexture(o.TEXTURE_2D,null),u?.debug?.log("ShaderLoader",`Gradient texture created successfully: ${e}x1, ${n.length} stops`),l)}catch(c){return u?.debug?.error("ShaderLoader","Exception during WebGL texture operations:",c),l&&o.deleteTexture(l),null}}catch(i){return u?.debug?.error("ShaderLoader",`Gradient texture creation failed: ${i instanceof Error?i.message:"Unknown error"}`),null}}var Q,Vt,ft=v(()=>{"use strict";R();Q=class{static loadFragment(t,e,i){let r=i||this.hashSource(e),a=this.getContextCache(t);if(a[r])return a[r];try{let n=this.compileShader(t,t.FRAGMENT_SHADER,e);return n&&(a[r]=n,u?.debug?.log("ShaderLoader",`Fragment shader compiled: ${r.substring(0,8)}...`)),n}catch(n){return u?.debug?.error("ShaderLoader",`Fragment shader compilation failed: ${n}`),null}}static loadVertex(t,e,i){let r=i||this.hashSource(e),a=this.getContextCache(t);if(a[r])return a[r];try{let n=this.compileShader(t,t.VERTEX_SHADER,e);return n&&(a[r]=n,u?.debug?.log("ShaderLoader",`Vertex shader compiled: ${r.substring(0,8)}...`)),n}catch(n){return u?.debug?.error("ShaderLoader",`Vertex shader compilation failed: ${n}`),null}}static createProgram(t,e,i){try{let r=t.createProgram();if(!r)return null;if(t.attachShader(r,e),t.attachShader(r,i),t.linkProgram(r),!t.getProgramParameter(r,t.LINK_STATUS)){let a=t.getProgramInfoLog(r);throw t.deleteProgram(r),new Error(`Program linking failed: ${a}`)}return r}catch(r){return u?.debug?.error("ShaderLoader",`Program creation failed: ${r}`),null}}static clearCache(t){let e=this.cache.get(t);e&&(Object.values(e).forEach(i=>{t.deleteShader(i)}),this.cache.delete(t))}static clearAllCaches(){this.cache.clear()}static compileShader(t,e,i){let r=t.createShader(e);if(!r)return null;if(t.shaderSource(r,i),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS)){let a=t.getShaderInfoLog(r);throw t.deleteShader(r),new Error(`Shader compilation failed: ${a}`)}return r}static clearContextCache(t){if(this.cache.has(t)){let e=this.cache.get(t);Object.values(e).forEach(i=>{if(i&&t&&!t.isContextLost())try{t.deleteShader(i)}catch{}}),this.cache.set(t,{}),u?.debug?.log("ShaderLoader","Context cache cleared due to WebGL context loss/restore")}}static getContextCache(t){return this.cache.has(t)||this.cache.set(t,{}),this.cache.get(t)}static hashSource(t){let e=0;for(let i=0;i<t.length;i++){let r=t.charCodeAt(i);e=(e<<5)-e+r,e=e&e}return e.toString(16)}};Q.cache=new Map;Vt=`#version 300 es
precision mediump float;

in vec2 a_position;
out vec2 v_uv;

void main() {
  v_uv = a_position * 0.5 + 0.5;
  gl_Position = vec4(a_position, 0.0, 1.0);
}`});var Ml,Jn,es,ts,is,ze,X,sa,oa,la,rs=v(()=>{"use strict";Ml=`#version 300 es
in vec2 a_position;
void main() {
  gl_Position = vec4(a_position, 0.0, 1.0);
}`,Jn=`
// Shared simplex noise implementation for visual effects
vec3 mod289(vec3 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec2 mod289(vec2 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec3 permute(vec3 x) {
  return mod289(((x*34.0)+1.0)*x);
}

float snoise(vec2 v) {
  const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);
  vec2 i = floor(v + dot(v, C.yy));
  vec2 x0 = v - i + dot(i, C.xx);
  vec2 i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
  vec4 x12 = x0.xyxy + C.xxzz;
  x12.xy -= i1;
  i = mod289(i);
  vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));
  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
  m = m*m;
  m = m*m;
  vec3 x = 2.0 * fract(p * C.www) - 1.0;
  vec3 h = abs(x) - 0.5;
  vec3 ox = floor(x + 0.5);
  vec3 a0 = x - ox;
  m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);
  vec3 g;
  g.x = a0.x * x0.x + h.x * x0.y;
  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
  return 130.0 * dot(m, g);
}`,es=`
// Enhanced visualEffects-aware animation effect with multi-phase patterns
float visualEffectsPulsing(float time, float phase, float intensity) {
  return sin(time * 0.05 + phase) * intensity;
}

// Deep visualEffects animation with emotional resonance
float deepVisualEffectsPulsing(float time, float phase, float emotionalIntensity) {
  float primaryBreath = sin(time * 0.04 + phase) * 0.6;
  float secondaryBreath = sin(time * 0.07 + phase * 1.3) * 0.3;
  float emotionalBreath = sin(time * 0.02 + phase * 0.7) * 0.2;
  return (primaryBreath + secondaryBreath + emotionalBreath) * emotionalIntensity;
}

// Rhythmic pulse modulation from visualEffects field
float rhythmicPulseModulation(float baseValue, float rhythmicPulse, float intensity) {
  return baseValue * (1.0 + rhythmicPulse * intensity);
}

// Musical flow direction calculation
vec2 calculateMusicalFlow(vec2 baseDirection, vec2 musicFlow, float sensitivity) {
  return baseDirection + musicFlow * sensitivity;
}

// Energy resonance modulation
float energyResonanceModulation(float baseValue, float energyResonance, float minMult, float maxMult) {
  return baseValue * (minMult + energyResonance * (maxMult - minMult));
}

// Surface fluidity effect
float surfaceFluidityEffect(float value, float fluidityIndex) {
  return mix(value, value * 1.2, fluidityIndex);
}

// === ADVANCED VISUAL_EFFECTS FIELD PATTERNS ===

// Multi-dimensional visualEffects field intensity calculation
float visualEffectsFieldIntensity(vec2 position, float time, float musicEnergy) {
  // Primary visualEffects wave
  float primaryField = snoise(position * 2.0 + time * 0.1) * 0.6;
  
  // Secondary awareness resonance
  float secondaryField = snoise(position * 4.0 + time * 0.05) * 0.3;
  
  // Musical visualEffects enhancement
  float musicalField = snoise(position * 6.0 + time * 0.15) * 0.2;
  
  // Combine visualEffects layers
  float combinedField = primaryField + secondaryField + (musicalField * musicEnergy);
  return clamp(combinedField * 0.5 + 0.5, 0.0, 1.0);
}

// Multi-dimensional awareness patterns for color modulation
vec3 awarenessResonance(vec3 baseColor, float visualEffectsLevel, float musicIntensity) {
  // VisualEffects-aware color temperature shift
  float temperatureShift = visualEffectsLevel * 0.3;
  vec3 warmShift = vec3(1.0 + temperatureShift, 1.0 + temperatureShift * 0.5, 1.0);
  vec3 coolShift = vec3(1.0, 1.0 + temperatureShift * 0.3, 1.0 + temperatureShift);
  
  // Musical intensity affects color saturation
  float saturationBoost = 1.0 + musicIntensity * 0.4;
  
  // Apply visualEffects-aware color modulation
  vec3 temperatureColor = mix(coolShift, warmShift, visualEffectsLevel);
  return baseColor * temperatureColor * saturationBoost;
}

// Temporal flow patterns for Year 3000 streaming effects
vec2 temporalFlowDirection(vec2 position, float time, vec2 musicFlow) {
  // Primary temporal stream
  vec2 primaryFlow = vec2(
    sin(time * 0.08 + position.x * 3.0),
    cos(time * 0.06 + position.y * 2.5)
  ) * 0.02;
  
  // Secondary visualEffects flow
  vec2 visualEffectsFlow = vec2(
    sin(time * 0.05 + position.y * 4.0),
    cos(time * 0.04 + position.x * 3.5)
  ) * 0.015;
  
  // Musical synchronization flow
  vec2 musicalSync = musicFlow * 0.01;
  
  return primaryFlow + visualEffectsFlow + musicalSync;
}

// Surface visualEffects dynamics for smooth boundaries
float surfaceVisualEffectsFlow(vec2 position, float fluidityIndex, float awarenessLevel) {
  // Base surface oscillation
  float surfaceBase = sin(position.x * 8.0 + position.y * 6.0) * 0.1;
  
  // VisualEffects-driven surface flexibility
  float visualEffectsFlex = awarenessLevel * fluidityIndex * 0.2;
  
  // Smooth surface animation
  float surfaceBreath = sin(position.x * 3.0 + position.y * 4.0) * 0.05;
  
  return surfaceBase + visualEffectsFlex + surfaceBreath;
}

// Advanced visualEffects animation patterns
float visualEffectsMemoryPulsing(float time, float phase, float memoryIntensity) {
  // Primary visualEffects rhythm
  float primaryRhythm = sin(time * 0.03 + phase) * 0.5;
  
  // Memory echo patterns
  float memoryEcho = sin(time * 0.08 + phase * 1.7) * 0.3 * memoryIntensity;
  
  // Deep awareness pulse
  float awarenessePulse = sin(time * 0.015 + phase * 0.5) * 0.2;
  
  return primaryRhythm + memoryEcho + awarenessePulse;
}`,ts=`
// Convert screen coordinates to polar coordinates for radial flow
vec2 toPolar(vec2 uv) {
  vec2 centered = uv - 0.5;
  float angle = atan(centered.y, centered.x);
  float radius = length(centered);
  return vec2(angle, radius);
}

// Convert polar coordinates back to cartesian
vec2 fromPolar(vec2 polar) {
  float angle = polar.x;
  float radius = polar.y;
  return vec2(cos(angle) * radius, sin(angle) * radius) + 0.5;
}

// Signed distance field for a circle
float circleSDF(vec2 uv, vec2 center, float radius) {
  return length(uv - center) - radius;
}

// Smooth minimum for blending SDFs
float smin(float a, float b, float k) {
  float h = clamp(0.5 + 0.5 * (b - a) / k, 0.0, 1.0);
  return mix(b, a, h) - k * h * (1.0 - h);
}

// Enhanced multiple bubble corridors with smooth visualEffects-aware animations
float bubbleCorridors(vec2 uv, float time, float intensity) {
  // ===== ENHANCED PRIMARY BUBBLE APERTURES =====
  // Create 6 main circular apertures arranged in a ring with dynamic bubble count
  float baseBubbleCount = 6.0;
  float dynamicBubbleCount = baseBubbleCount + floor(intensity * 2.0); // 6-8 bubbles based on intensity
  float ringRadius = 0.28 + sin(time * 0.15) * 0.08; // Pulsing ring radius (0.20-0.36)
  
  float minBubbleDistance = 2.0; // Track closest bubble distance
  
  // Calculate distance to each bubble position with enhanced smooth movement
  for(float i = 0.0; i < dynamicBubbleCount; i += 1.0) {
    // Enhanced smooth rotation with animation rhythm
    float bubbleAngle = (i / dynamicBubbleCount) * 2.0 * 3.14159 + time * 0.08;
    
    // Add smooth spiral motion for visualEffects effect
    float spiralOffset = sin(time * 0.25 + i * 0.6) * 0.15;
    float dynamicRingRadius = ringRadius + spiralOffset;
    
    // Bubble center position with enhanced smooth movement
    vec2 bubbleCenter = vec2(0.5) + vec2(
      cos(bubbleAngle) * dynamicRingRadius,
      sin(bubbleAngle) * dynamicRingRadius
    );
    
    // Enhanced animation/pulsing animation with multi-frequency modulation
    float animationPhase = sin(time * 0.6 + i * 0.8) * 0.04;
    float smoothPhase = sin(time * 0.35 + i * 1.2) * 0.03;
    float visualEffectsPhase = sin(time * 0.18 + i * 0.5) * 0.025;
    
    vec2 smoothMovement = vec2(
      sin(time * 0.3 + i * 0.7) * (animationPhase + smoothPhase),
      cos(time * 0.4 + i * 0.9) * (animationPhase + visualEffectsPhase)
    );
    
    vec2 animatedCenter = bubbleCenter + smoothMovement;
    
    // Calculate distance from current pixel to this bubble center
    float distanceToBubble = length(uv - animatedCenter);
    minBubbleDistance = min(minBubbleDistance, distanceToBubble);
  }
  
  // ===== ENHANCED BUBBLE APERTURE SIZING =====
  // Enhanced bubble size with multi-wave expansion patterns
  float baseBubbleSize = 0.08 * intensity;
  float primaryPulse = sin(time * 1.5) * 0.35;
  float smoothPulse = sin(time * 0.8) * 0.25;
  float visualEffectsPulse = sin(time * 2.2) * 0.15;
  
  float expandedBubbleSize = baseBubbleSize * (1.0 + primaryPulse + smoothPulse + visualEffectsPulse);
  
  // Create clean circular apertures with enhanced soft edges
  float primaryBubbleMask = 1.0 - smoothstep(expandedBubbleSize * 0.6, expandedBubbleSize * 1.1, minBubbleDistance);
  
  // ===== ENHANCED SECONDARY BUBBLE LAYER =====
  // Add smaller secondary bubbles with smooth movement
  float secondaryBubbleCount = 4.0 + floor(intensity * 1.0); // 4-5 secondary bubbles
  float baseSecondaryRadius = 0.15;
  float secondaryRingRadius = baseSecondaryRadius * (1.0 + sin(time * 0.12) * 0.3);
  float minSecondaryDistance = 2.0;
  
  for(float i = 0.0; i < secondaryBubbleCount; i += 1.0) {
    // Counter-rotating secondary bubbles with smooth offset
    float secondaryAngle = (i / secondaryBubbleCount) * 2.0 * 3.14159 - time * 0.15 + 1.57;
    
    // Add smooth wobble to secondary bubble positions
    float wobbleX = sin(time * 0.45 + i * 1.1) * 0.02;
    float wobbleY = cos(time * 0.55 + i * 0.8) * 0.02;
    
    vec2 secondaryCenter = vec2(0.5) + vec2(
      cos(secondaryAngle) * secondaryRingRadius + wobbleX,
      sin(secondaryAngle) * secondaryRingRadius + wobbleY
    );
    
    float distanceToSecondary = length(uv - secondaryCenter);
    minSecondaryDistance = min(minSecondaryDistance, distanceToSecondary);
  }
  
  float secondaryBubbleSize = baseBubbleSize * 0.5 * (1.0 + sin(time * 1.8) * 0.3);
  float secondaryBubbleMask = 1.0 - smoothstep(secondaryBubbleSize * 0.6, secondaryBubbleSize * 1.0, minSecondaryDistance);
  secondaryBubbleMask *= 0.75; // Make secondary bubbles dimmer for depth
  
  // ===== ENHANCED CENTER SPOTLIGHT BUBBLE =====
  // Enhanced central bubble with complex pulsing patterns
  float centerDistance = length(uv - vec2(0.5));
  float centerPrimaryPulse = sin(time * 2.0) * 0.4;
  float centerSecondaryPulse = sin(time * 3.5) * 0.2;
  float centerPulsingPulse = sin(time * 0.6) * 0.3;
  
  float centerBubbleSize = 0.06 * intensity * (1.0 + centerPrimaryPulse + centerSecondaryPulse + centerPulsingPulse);
  float centerBubbleMask = 1.0 - smoothstep(centerBubbleSize * 0.4, centerBubbleSize * 0.9, centerDistance);
  
  // ===== ENHANCED COMBINATION AND BLENDING =====
  // Use smooth maximum for smooth blending instead of hard max
  float corridorMask = primaryBubbleMask;
  corridorMask = max(corridorMask, secondaryBubbleMask * 0.9);
  corridorMask = max(corridorMask, centerBubbleMask * 1.1); // Center bubble slightly stronger
  
  // Enhanced radial falloff with smooth variation
  vec2 center = uv - vec2(0.5);
  float radialDistance = length(center);
  float smoothVariation = sin(time * 0.3 + radialDistance * 8.0) * 0.05;
  float radialFalloff = 1.0 - smoothstep(0.0, 0.65 + smoothVariation, radialDistance);
  corridorMask *= radialFalloff;
  
  // Enhanced smooth animation pattern with visualEffects harmonics
  float primaryPulsing = sin(time * 0.4) * 0.15;
  float secondaryPulsing = sin(time * 0.25) * 0.08;
  float visualEffectsPulsing = sin(time * 0.6) * 0.05;
  float animationCycle = 0.85 + primaryPulsing + secondaryPulsing + visualEffectsPulsing;
  corridorMask *= animationCycle;
  
  // Add subtle noise variation for smooth visualEffects texture
  float noisePattern = sin(radialDistance * 12.0 + time * 0.5) * cos(radialDistance * 8.0 - time * 0.3) * 0.03;
  corridorMask += noisePattern * intensity * 0.5;
  
  return clamp(corridorMask, 0.0, 1.0);
}

// Perspective depth calculation for inward flow
float calculatePerspectiveDepth(vec2 uv, float time, float flowStrength) {
  vec2 polar = toPolar(uv);
  float radius = polar.y;
  
  // Create perspective tunnel effect
  float depth = 1.0 - radius;
  depth = pow(depth, 2.2); // Gamma correction for natural falloff
  
  // Add inward flow animation
  float flowPhase = time * flowStrength + radius * 8.0;
  depth += sin(flowPhase) * 0.05 * (1.0 - radius);
  
  return clamp(depth, 0.0, 1.0);
}

// Dynamic aperture sizing based on music response
float musicResponsiveAperture(float baseMask, float beatIntensity, float bassResponse) {
  // Beat response expands apertures
  float beatExpansion = 1.0 + beatIntensity * 0.3;
  
  // Bass response adds pulsing
  float bassPulse = sin(bassResponse * 10.0) * 0.1;
  
  // Apply modulations
  float responsiveMask = baseMask * beatExpansion + bassPulse;
  
  return clamp(responsiveMask, 0.0, 1.0);
}

// ===================================================================
// DUNGEON CORRIDOR TUNNEL FUNCTIONS
// ===================================================================

// Signed distance field for rounded rectangle (corridor tunnel shape)
float roundedRectangleSDF(vec2 uv, vec2 center, vec2 size, float radius) {
  vec2 d = abs(uv - center) - size;
  return length(max(d, 0.0)) + min(max(d.x, d.y), 0.0) - radius;
}

// Apply perspective transformation for 3D tunnel illusion
vec2 perspectiveTunnelTransform(vec2 uv, float depth, float focalLength) {
  // Transform to centered coordinates
  vec2 centered = uv - 0.5;
  
  // Apply perspective projection with vanishing point at center
  float perspectiveFactor = focalLength / (focalLength + depth);
  vec2 perspective = centered * perspectiveFactor;
  
  // Return to UV space
  return perspective + 0.5;
}

// Calculate surface normal from SDF for lighting
vec2 tunnelNormalFromSDF(vec2 uv, vec2 center, vec2 size, float radius) {
  const float epsilon = 0.001;
  
  float centerSDF = roundedRectangleSDF(uv, center, size, radius);
  float rightSDF = roundedRectangleSDF(uv + vec2(epsilon, 0.0), center, size, radius);
  float upSDF = roundedRectangleSDF(uv + vec2(0.0, epsilon), center, size, radius);
  
  return normalize(vec2(rightSDF - centerSDF, upSDF - centerSDF));
}

// Advanced lighting system for dungeon corridors
vec3 calculateTunnelLighting(vec2 uv, float tunnelMask, vec2 normal, float depth, float time, float intensity) {
  // ===== AMBIENT SHADOW LAYER =====
  // Create dark base for corridor walls
  float ambientShadow = 0.15; // Base darkness level
  vec3 shadowColor = vec3(0.05, 0.08, 0.12); // Cool blue-gray shadows
  
  // ===== EDGE HIGHLIGHT LAYER =====
  // Bright rim lighting along corridor edges using surface normals
  float edgeIntensity = 1.0 - smoothstep(0.0, 0.3, tunnelMask);
  float edgeHighlight = pow(edgeIntensity, 2.0) * 0.8;
  
  // Edge lighting color shifts with music (warmer for high energy)
  vec3 edgeLightColor = mix(
    vec3(0.4, 0.5, 0.8), // Cool blue edge light
    vec3(0.8, 0.6, 0.3), // Warm orange edge light
    intensity * 0.7
  );
  
  // ===== END LIGHT SOURCE =====
  // Dynamic light at tunnel end that pulses with music
  float distanceFromCenter = length(uv - vec2(0.5));
  float endLightFalloff = 1.0 / (1.0 + distanceFromCenter * 4.0); // Inverse square falloff
  
  // Music-responsive light intensity with animation effect
  float lightPulse = sin(time * 2.0) * 0.3 + 0.7;
  float endLightIntensity = intensity * lightPulse * endLightFalloff;
  
  // End light color temperature (cooler when distant, warmer when close)
  vec3 endLightColor = mix(
    vec3(0.3, 0.4, 0.9), // Cool distant light
    vec3(0.9, 0.7, 0.4), // Warm close light  
    endLightIntensity
  );
  
  // ===== FRESNEL EFFECT =====
  // Edge lighting intensity based on viewing angle
  vec2 viewDirection = normalize(uv - vec2(0.5));
  float fresnel = pow(1.0 - abs(dot(normal, viewDirection)), 2.0);
  
  // ===== COMBINE LIGHTING LAYERS =====
  vec3 ambientLayer = shadowColor * ambientShadow;
  vec3 edgeLayer = edgeLightColor * edgeHighlight * fresnel;
  vec3 endLayer = endLightColor * endLightIntensity * tunnelMask;
  
  // Apply depth-based attenuation
  float depthAttenuation = 1.0 - smoothstep(0.0, 1.0, depth);
  
  return (ambientLayer + edgeLayer + endLayer) * depthAttenuation;
}

// Create multiple dungeon corridor tunnels with realistic lighting
float dungeonCorridorTunnels(vec2 uv, float time, float intensity) {
  // ===== MAIN CORRIDOR TUNNELS =====
  float corridorCount = 4.0;
  float minCorridorDistance = 2.0;
  
  for(float i = 0.0; i < corridorCount; i += 1.0) {
    float corridorAngle = (i / corridorCount) * 2.0 * 3.14159 + time * 0.05;
    
    // Corridor center position with slight offset for smooth feel
    vec2 corridorOffset = vec2(
      cos(corridorAngle) * 0.25,
      sin(corridorAngle) * 0.25
    );
    vec2 corridorCenter = vec2(0.5) + corridorOffset;
    
    // Apply perspective transformation for depth illusion
    float depth = 0.3 + sin(time * 0.3 + i) * 0.1;
    vec2 perspectiveUV = perspectiveTunnelTransform(uv, depth, 2.0);
    
    // Create elongated corridor tunnel shape
    vec2 corridorSize = vec2(0.15, 0.04) * (1.0 + intensity * 0.3); // Width varies with music
    float cornerRadius = 0.01;
    
    // Calculate distance to this corridor tunnel
    float corridorDistance = roundedRectangleSDF(perspectiveUV, corridorCenter, corridorSize, cornerRadius);
    minCorridorDistance = min(minCorridorDistance, corridorDistance);
  }
  
  // ===== SECONDARY TUNNEL LAYER =====
  // Add smaller secondary tunnels for depth complexity
  float secondaryCount = 2.0;
  float minSecondaryDistance = 2.0;
  
  for(float i = 0.0; i < secondaryCount; i += 1.0) {
    float secondaryAngle = (i / secondaryCount) * 2.0 * 3.14159 + time * 0.08 + 1.57;
    
    vec2 secondaryOffset = vec2(
      cos(secondaryAngle) * 0.15,
      sin(secondaryAngle) * 0.15  
    );
    vec2 secondaryCenter = vec2(0.5) + secondaryOffset;
    
    // Deeper perspective for secondary tunnels
    float secondaryDepth = 0.5 + sin(time * 0.2 + i) * 0.1;
    vec2 secondaryPerspectiveUV = perspectiveTunnelTransform(uv, secondaryDepth, 2.5);
    
    vec2 secondarySize = vec2(0.08, 0.025) * (1.0 + intensity * 0.2);
    float secondaryDistance = roundedRectangleSDF(secondaryPerspectiveUV, secondaryCenter, secondarySize, 0.005);
    minSecondaryDistance = min(minSecondaryDistance, secondaryDistance);
  }
  
  // ===== COMBINE TUNNEL LAYERS =====
  float primaryMask = 1.0 - smoothstep(0.0, 0.02, minCorridorDistance);
  float secondaryMask = 1.0 - smoothstep(0.0, 0.015, minSecondaryDistance);
  secondaryMask *= 0.7; // Dimmer secondary tunnels
  
  float combinedMask = max(primaryMask, secondaryMask);
  
  // ===== RADIAL FALLOFF FOR FOCUS =====
  vec2 center = uv - vec2(0.5);
  float radialDistance = length(center);
  float radialFalloff = 1.0 - smoothstep(0.2, 0.8, radialDistance);
  
  // ===== ORGANIC BREATHING PATTERN =====
  float animationCycle = 0.9 + sin(time * 0.4) * 0.1;
  
  return clamp(combinedMask * radialFalloff * animationCycle, 0.0, 1.0);
}

// Enhanced corridor gradient reveal with advanced dual-layer blending
vec4 corridorGradientReveal(vec2 uv, sampler2D gradientTex, float corridorMask, float time, float intensity) {
  // ===== ENHANCED BASE LAYER: Musical flow with visualEffects awareness =====
  vec2 baseFlowUV = uv;
  vec2 flowDirection = normalize(vec2(1.0, 0.0));
  
  // Enhanced musical flow with multi-frequency modulation
  #ifdef HAS_FLOW_UNIFORMS
    flowDirection = normalize(u_musicalFlow.xy + vec2(0.001, 0.0));
  #endif
  
  // Multi-layered flow animation with visualEffects patterns
  float primaryFlow = sin(time * 0.1) * 0.02;
  float smoothFlow = sin(time * 0.07) * 0.015;
  float visualEffectsFlow = sin(time * 0.13) * 0.008;
  
  baseFlowUV += flowDirection * (primaryFlow + smoothFlow + visualEffectsFlow);
  vec4 baseGradient = texture(gradientTex, vec2(baseFlowUV.x, 0.5));
  
  // Enhanced base layer with depth awareness
  vec2 polar = toPolar(uv);
  float baseDepthModulation = 1.0 + polar.y * 0.2; // Subtle depth variation
  baseGradient.rgb *= baseDepthModulation;
  
  // ===== ENHANCED CORRIDOR LAYER: Multi-dimensional inward flow =====
  float angle = polar.x;
  float radius = polar.y;
  
  // Advanced inward flow with multi-phase animation
  float primaryInwardPhase = time * 0.15 + radius * 6.0;
  float secondaryInwardPhase = time * 0.08 + radius * 4.5;
  float visualEffectsInwardPhase = time * 0.22 + radius * 8.0;
  
  // Multi-layered inward flow combining multiple patterns
  float primaryInwardFlow = radius - (sin(primaryInwardPhase) * 0.1);
  float secondaryInwardFlow = radius - (cos(secondaryInwardPhase) * 0.06);
  float visualEffectsInwardFlow = radius - (sin(visualEffectsInwardPhase) * 0.04);
  
  float combinedInwardFlow = mix(
    mix(primaryInwardFlow, secondaryInwardFlow, 0.3),
    visualEffectsInwardFlow, 0.2
  );
  
  // Enhanced gradient sampling with dual-layer coordination
  vec2 corridorFlowUV = vec2(
    fract(angle / (2.0 * 3.14159) + time * 0.02), // Slow rotation for smooth feel
    clamp(combinedInwardFlow, 0.0, 1.0)
  );
  vec4 corridorGradient = texture(gradientTex, corridorFlowUV);
  
  // ===== ADVANCED DEPTH AND PERSPECTIVE =====
  float depth = calculatePerspectiveDepth(uv, time, intensity);
  
  // Enhanced tunnel brightness with smooth variation
  float smoothBrightnessVariation = sin(angle * 3.0 + time * 0.3) * 0.1;
  float tunnelBrightness = 1.0 + depth * 0.9 + smoothBrightnessVariation;
  corridorGradient.rgb *= tunnelBrightness;
  
  // Advanced color shift with visualEffects-aware color temperature
  vec3 warmShift = vec3(1.15, 1.05, 0.85); // Warm center
  vec3 coolShift = vec3(0.9, 1.0, 1.1);    // Cool edges
  vec3 colorTemperature = mix(coolShift, warmShift, depth);
  corridorGradient.rgb = mix(corridorGradient.rgb, corridorGradient.rgb * colorTemperature, depth * 0.4);
  
  // ===== ENHANCED DUAL-LAYER BLENDING =====
  // Multi-stage aperture masking for smooth blending
  float softApertureMask = smoothstep(0.2, 0.8, corridorMask);
  float sharpApertureMask = smoothstep(0.4, 0.6, corridorMask);
  float smoothApertureMask = mix(softApertureMask, sharpApertureMask, 0.6);
  
  // Enhanced blending with visualEffects-aware mixing
  float visualEffectsBlendFactor = 0.7 + sin(time * 0.4 + radius * 4.0) * 0.2;
  float dynamicIntensity = intensity * visualEffectsBlendFactor;
  
  // Primary blend: base and corridor layers
  vec4 primaryBlend = mix(baseGradient, corridorGradient, smoothApertureMask * dynamicIntensity);
  
  // ===== ADVANCED APERTURE EFFECTS =====
  // Enhanced rim lighting with smooth variation 
  float rimLightBase = corridorMask * (1.0 - smoothApertureMask);
  float rimLightVariation = sin(angle * 4.0 + time * 0.5) * 0.3 + 0.7;
  float enhancedRimLight = rimLightBase * rimLightVariation * 0.6;
  
  // Aperture glow effect for depth illusion
  float apertureGlow = softApertureMask * (1.0 - sharpApertureMask) * 0.4;
  vec3 glowColor = corridorGradient.rgb * 1.2;
  
  // ===== VISUAL_EFFECTS-AWARE COLOR HARMONIZATION =====
  // Harmonize colors between layers for smooth visualEffects effect
  vec3 harmonizedColor = mix(
    primaryBlend.rgb,
    (primaryBlend.rgb + corridorGradient.rgb) * 0.5,
    smoothApertureMask * 0.3
  );
  
  // Final composition with enhanced rim and glow effects
  vec4 finalColor = vec4(harmonizedColor, primaryBlend.a);
  finalColor.rgb += vec3(enhancedRimLight) * dynamicIntensity;
  finalColor.rgb += glowColor * apertureGlow * dynamicIntensity;
  
  // Smooth animation effect for visualEffects integration
  float animationCycle = 0.95 + sin(time * 0.3) * 0.05;
  finalColor.rgb *= animationCycle;
  
  return finalColor;
}

// Advanced dungeon corridor gradient reveal with realistic lighting
vec4 dungeonCorridorGradientReveal(vec2 uv, sampler2D gradientTex, float corridorMask, float time, float intensity) {
  // ===== BASE LAYER: Dark stone/metal corridor walls =====
  vec4 baseWallColor = vec4(0.1, 0.12, 0.15, 1.0); // Dark stone base
  
  // ===== CORRIDOR TUNNEL CALCULATION =====
  // Use dungeon corridor tunnels instead of simple bubbles
  float tunnelMask = dungeonCorridorTunnels(uv, time, intensity);
  
  // ===== LIGHTING CALCULATION =====
  // Calculate lighting for tunnel areas
  vec2 tunnelCenter = vec2(0.5); // Simplified center for normal calculation
  vec2 tunnelSize = vec2(0.15, 0.04);
  vec2 surfaceNormal = tunnelNormalFromSDF(uv, tunnelCenter, tunnelSize, 0.01);
  
  float depth = length(uv - vec2(0.5)) * 0.5; // Distance-based depth
  vec3 tunnelLighting = calculateTunnelLighting(uv, tunnelMask, surfaceNormal, depth, time, intensity);
  
  // ===== CORRIDOR LAYER: Inward flowing magical light =====
  // Convert to polar coordinates for inward flow calculation
  vec2 polar = toPolar(uv);
  float angle = polar.x;
  float radius = polar.y;
  
  // Create magical inward flow animation - light streams toward center
  float magicalFlowPhase = time * 0.2 + radius * 8.0; // Faster flow for magical effect
  float inwardFlow = radius - (sin(magicalFlowPhase) * 0.15); // More dramatic flow
  
  // Sample gradient using inward flow for magical light colors
  vec2 corridorFlowUV = vec2(
    angle / (2.0 * 3.14159), // Normalize angle for gradient sampling
    clamp(inwardFlow, 0.0, 1.0) // Use inward flow for magical color variation
  );
  vec4 magicalLightGradient = texture(gradientTex, corridorFlowUV);
  
  // ===== ENHANCE MAGICAL LIGHT WITH MUSIC RESPONSIVENESS =====
  // Enhance magical light colors based on music intensity
  magicalLightGradient.rgb *= 1.5 + intensity * 0.8; // Brighter with music
  
  // Add magical shimmer effect
  float shimmerPhase = time * 4.0 + uv.x * 10.0 + uv.y * 8.0;
  float shimmer = sin(shimmerPhase) * 0.1 + 0.9;
  magicalLightGradient.rgb *= shimmer;
  
  // ===== DEPTH AND PERSPECTIVE EFFECTS =====
  float perspectiveDepth = calculatePerspectiveDepth(uv, time, intensity * 1.2);
  
  // Enhance magical light with depth - brighter toward tunnel end
  float tunnelEndBrightness = 1.0 + perspectiveDepth * 1.5;
  magicalLightGradient.rgb *= tunnelEndBrightness;
  
  // ===== CORRIDOR WALL TEXTURING =====
  // Add stone/metal texture to walls using noise-like patterns
  float wallTexturePhase = uv.x * 20.0 + uv.y * 15.0;
  float wallTexture = sin(wallTexturePhase) * 0.1 + 0.9;
  baseWallColor.rgb *= wallTexture;
  
  // ===== ADVANCED APERTURE BLENDING =====
  // Smooth tunnel aperture with realistic falloff
  float apertureMask = smoothstep(0.1, 0.8, tunnelMask);
  
  // ===== LIGHTING INTEGRATION =====
  // Apply calculated lighting to both wall and magical light
  vec4 litWallColor = baseWallColor;
  litWallColor.rgb += tunnelLighting; // Add ambient shadows, edge highlights, end illumination
  
  // Blend wall color with magical light streaming through tunnels
  vec4 finalColor = mix(litWallColor, magicalLightGradient, apertureMask * intensity);
  
  // ===== RIM LIGHTING FOR DEPTH ILLUSION =====
  // Enhanced rim lighting around tunnel apertures
  float rimIntensity = tunnelMask * (1.0 - apertureMask) * 0.8;
  vec3 rimColor = mix(
    vec3(0.3, 0.4, 0.8), // Cool rim light
    vec3(0.8, 0.5, 0.2), // Warm rim light
    intensity
  );
  finalColor.rgb += rimColor * rimIntensity;
  
  // ===== ATMOSPHERIC PERSPECTIVE =====
  // Add slight fog/haze effect for distance illusion
  float atmosphericHaze = depth * 0.2;
  vec3 hazeColor = vec3(0.15, 0.18, 0.25);
  finalColor.rgb = mix(finalColor.rgb, hazeColor, atmosphericHaze);
  
  return finalColor;
}`,is=`
// Time and resolution (universal)
uniform float u_time;
uniform vec2 u_resolution;

// Enhanced visualEffects field uniforms
uniform float u_rhythmicPulse;
uniform vec2 u_musicalFlow;
uniform float u_energyResonance;
uniform float u_animationCycle;
uniform float u_surfaceFluidityIndex;

// Advanced visualEffects control uniforms
uniform float u_visualEffectsLevel;        // 0-1 current visualEffects intensity
uniform float u_awarenessLevel;           // 0-1 current awareness depth
uniform float u_emotionalIntensity;       // 0-1 emotional resonance strength
uniform float u_memoryIntensity;          // 0-1 visualEffects memory patterns
uniform vec2 u_temporalFlowDirection;     // Year 3000 temporal stream direction
uniform float u_visualEffectsTemperature; // Color temperature shift from visualEffects

// Enhanced music sync uniforms
uniform float u_musicEnergy;
uniform float u_musicValence;
uniform float u_beatIntensity;
uniform float u_bassResponse;
uniform float u_musicalVisualEffectsSync; // Music-visualEffects synchronization level
uniform float u_genreVisualEffectsShift;  // Genre-specific visualEffects adjustments

// Corridor-specific uniforms
uniform float u_corridorIntensity;
uniform float u_corridorFlowStrength;
uniform float u_corridorDepthEffect;
uniform float u_corridorBubbleScale;

// Dungeon corridor uniforms
uniform float u_dungeonEnabled;
uniform float u_tunnelWidth;
uniform float u_lightingIntensity;
uniform float u_atmosphericHaze;
uniform vec3 u_wallColor;`,ze=class{static buildFragmentShader(t){let{precision:e="precision mediump float;",additionalUniforms:i="",additionalFunctions:r="",mainShaderLogic:a,includeNoiseFunctions:n=!0,includeVisualEffectsFunctions:s=!0,includeCorridorFunctions:l=!1}=t,c=`#version 300 es
${e}

`;return c+=is+`

`,i&&(c+=i+`

`),c+=`out vec4 fragColor;

`,n&&(c+=Jn+`

`),s&&(c+=es+`

`),l&&(c+=ts+`

`),r&&(c+=r+`

`),c+=`void main() {
`,c+=`  vec2 uv = gl_FragCoord.xy / u_resolution.xy;

`,c+=a,c+=`
}`,c}static getStandardUniformNames(){return["u_time","u_resolution","u_rhythmicPulse","u_musicalFlow","u_energyResonance","u_animationCycle","u_surfaceFluidityIndex","u_visualEffectsLevel","u_awarenessLevel","u_emotionalIntensity","u_memoryIntensity","u_temporalFlowDirection","u_visualEffectsTemperature","u_musicEnergy","u_musicValence","u_beatIntensity","u_bassResponse","u_musicalVisualEffectsSync","u_genreVisualEffectsShift"]}static getWebGLUniformNames(){return[...this.getStandardUniformNames(),"u_gradientTex","u_flowStrength","u_noiseScale","u_colorIntensity","u_patternScale","u_animationSpeed"]}static getLiquidUniformNames(){return[...this.getStandardUniformNames(),"u_gradientTex","u_flowStrength","u_noiseScale","u_liquidPhase","u_animationIntensity","u_auroraFlow","u_flowDirection","u_liquidTurbulence","u_visualEffectsDepth","u_waveY","u_waveHeight","u_waveOffset","u_blurExp","u_blurMax"]}static getCorridorUniformNames(){return["u_time","u_resolution","u_gradientTex","u_rhythmicPulse","u_musicalFlow","u_energyResonance","u_animationCycle","u_surfaceFluidityIndex","u_musicEnergy","u_musicValence","u_beatIntensity","u_bassResponse","u_corridorIntensity","u_corridorFlowStrength","u_corridorDepthEffect","u_corridorBubbleScale"]}static getTunnelVisualizationUniformNames(){return[...this.getCorridorUniformNames(),"u_tunnelEnabled","u_tunnelWidth","u_lightingIntensity","u_atmosphericHaze","u_wallColor"]}},X=class{static musicFlowLogic(){return`
  // Calculate enhanced music-driven flow
  vec2 flowDirection = calculateMusicalFlow(vec2(1.0, 0.5), u_musicalFlow, 0.5);
  float flowStrength = rhythmicPulseModulation(0.5, u_rhythmicPulse, 0.3);
  
  // Add temporal flow patterns for Year 3000 effects
  vec2 temporalFlow = temporalFlowDirection(uv, u_time, u_temporalFlowDirection);
  flowDirection += temporalFlow;
  
  // Apply enhanced animation modulation with emotional resonance
  float animationMod = deepVisualEffectsPulsing(u_time, 0.0, u_emotionalIntensity);
  flowStrength *= (1.0 + animationMod);
  
  // Apply visualEffects field intensity
  float fieldIntensity = visualEffectsFieldIntensity(uv, u_time, u_musicEnergy);
  flowStrength *= (0.5 + fieldIntensity * 0.5);`}static audioNoiseSampling(){return`
  // Generate enhanced audio-modulated noise
  vec2 noiseUV = uv + flowDirection * u_time * 0.03;
  
  // Multi-layered visualEffects noise patterns
  float noise1 = snoise(noiseUV * 2.0);
  float noise2 = snoise(noiseUV * 4.0) * 0.5;
  float memoryNoise = snoise(noiseUV * 1.5 + u_time * 0.01) * u_memoryIntensity * 0.3;
  
  // Apply visualEffects field modulation
  float visualEffectsModulation = visualEffectsFieldIntensity(noiseUV, u_time, u_musicEnergy);
  
  // Combine noise with enhanced visualEffects influence
  float t = (noise1 + noise2 + memoryNoise) * energyResonanceModulation(1.0, u_energyResonance, 0.5, 1.5);
  t *= visualEffectsModulation;
  t = clamp(t * 0.5 + 0.5, 0.0, 1.0);`}static visualEffectsVignette(){return`
  // Apply enhanced visualEffects-aware vignette
  vec2 center = uv - 0.5;
  float animation = deepVisualEffectsPulsing(u_time, u_animationCycle, u_emotionalIntensity);
  
  // Add surface visualEffects flow for smooth boundaries
  float surfaceFlow = surfaceVisualEffectsFlow(uv, u_surfaceFluidityIndex, u_awarenessLevel);
  
  // Calculate visualEffects-aware vignette with surface dynamics
  float vignette = (0.9 + animation + surfaceFlow) - dot(center, center) * 0.3;
  
  // Apply awareness resonance to color
  color.rgb = awarenessResonance(color.rgb, u_visualEffectsLevel, u_musicEnergy);
  color.rgb *= vignette;`}static musicResponsiveAlpha(){return`
  // Music-responsive alpha modulation
  float musicAlpha = 0.8 + u_beatIntensity * 0.2 + u_bassResponse * 0.1;
  color.a *= musicAlpha;`}static auroraShimmerEffect(){return`
  // Aurora shimmer overlay
  float shimmerPhase = u_time * 3.0 + uv.x * 15.0 + uv.y * 10.0;
  float shimmer = sin(shimmerPhase) * 0.03 + 0.97;
  color.rgb *= shimmer;`}},sa=class{static webglGradientFragment(){return`
  ${X.musicFlowLogic()}
  
  // WebGL-specific gradient sampling
  ${X.audioNoiseSampling()}
  
  // Sample gradient texture
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  
  // Apply visualEffects effects
  ${X.visualEffectsVignette()}
  ${X.musicResponsiveAlpha()}
  
  fragColor = color;`}static liquidEffectsFragment(){return`
  ${X.musicFlowLogic()}
  
  // Liquid-specific turbulence and phase
  float liquidPhase = u_liquidPhase + u_rhythmicPulse * 0.5;
  vec2 turbulenceUV = uv * u_liquidTurbulence;
  float turbulence = snoise(turbulenceUV + u_time * 0.01);
  
  // Liquid visualEffects noise
  vec2 liquidUV = uv + flowDirection * u_time * 0.03;
  liquidUV += vec2(sin(u_time * 0.04 + liquidPhase), cos(u_time * 0.03 + liquidPhase)) * 0.02;
  float liquidNoise = snoise(liquidUV * 2.0 + turbulence * 0.1);
  
  float t = clamp(liquidNoise * 0.5 + 0.5, 0.0, 1.0);
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  
  ${X.visualEffectsVignette()}
  ${X.auroraShimmerEffect()}
  ${X.musicResponsiveAlpha()}
  
  fragColor = color;`}static corridorBubbleFragment(){return`
  ${X.musicFlowLogic()}
  
  // Calculate corridor bubble mask
  float corridorMask = bubbleCorridors(uv, u_time, u_corridorIntensity * u_corridorBubbleScale);
  
  // Apply music-responsive aperture modulation
  corridorMask = musicResponsiveAperture(corridorMask, u_beatIntensity, u_bassResponse);
  
  // Generate corridor gradient reveal effect
  vec4 color = corridorGradientReveal(uv, u_gradientTex, corridorMask, u_time, u_corridorIntensity);
  
  // Apply visualEffects effects
  ${X.visualEffectsVignette()}
  
  // Enhanced music responsiveness for corridor effects
  float corridorMusicAlpha = 0.85 + u_beatIntensity * 0.15 + u_bassResponse * 0.05;
  color.a *= corridorMusicAlpha;
  
  // Apply corridor depth effect for enhanced dimensionality
  float depth = calculatePerspectiveDepth(uv, u_time, u_corridorFlowStrength);
  color.rgb = mix(color.rgb, color.rgb * (1.0 + depth * 0.3), u_corridorDepthEffect);
  
  fragColor = color;`}static dungeonCorridorFragment(){return`
  ${X.musicFlowLogic()}
  
  // Calculate dungeon corridor tunnel mask
  float corridorMask = dungeonCorridorTunnels(uv, u_time, u_corridorIntensity * u_corridorBubbleScale);
  
  // Apply music-responsive corridor modulation  
  corridorMask = musicResponsiveAperture(corridorMask, u_beatIntensity, u_bassResponse);
  
  // Generate advanced dungeon corridor gradient reveal effect with realistic lighting
  vec4 color = dungeonCorridorGradientReveal(uv, u_gradientTex, corridorMask, u_time, u_corridorIntensity);
  
  // Apply visualEffects effects for smooth integration
  ${X.visualEffectsVignette()}
  
  // Enhanced music responsiveness for dungeon atmosphere
  float dungeonMusicAlpha = 0.9 + u_beatIntensity * 0.1 + u_bassResponse * 0.05;
  color.a *= dungeonMusicAlpha;
  
  // Apply corridor depth effect for enhanced dimensionality
  float depth = calculatePerspectiveDepth(uv, u_time, u_corridorFlowStrength);
  color.rgb = mix(color.rgb, color.rgb * (1.0 + depth * 0.4), u_corridorDepthEffect);
  
  // Add subtle magical shimmer for mystical atmosphere
  float magicalShimmer = sin(u_time * 5.0 + uv.x * 12.0 + uv.y * 8.0) * 0.05 + 0.95;
  color.rgb *= magicalShimmer;
  
  fragColor = color;`}static advancedVisualEffectsFieldFragment(){return`
  ${X.musicFlowLogic()}
  
  // Calculate multi-dimensional visualEffects field
  float visualEffectsField = visualEffectsFieldIntensity(uv, u_time, u_musicEnergy);
  
  // Apply temporal flow effects for Year 3000 streaming
  vec2 temporalUV = uv + temporalFlowDirection(uv, u_time, u_temporalFlowDirection);
  
  // Enhanced visualEffects noise sampling with memory patterns
  ${X.audioNoiseSampling()}
  
  // Sample gradient with visualEffects field modulation
  vec4 color = texture(u_gradientTex, vec2(t * visualEffectsField, 0.5));
  
  // Apply awareness resonance for visualEffects-aware color
  color.rgb = awarenessResonance(color.rgb, u_visualEffectsLevel, u_musicEnergy);
  
  // Enhanced surface visualEffects effects
  float surfaceEffect = surfaceVisualEffectsFlow(temporalUV, u_surfaceFluidityIndex, u_awarenessLevel);
  color.rgb *= (1.0 + surfaceEffect * 0.3);
  
  // Apply visualEffects memory animation
  float memoryPulsing = visualEffectsMemoryPulsing(u_time, u_animationCycle, u_memoryIntensity);
  color.a *= (0.8 + memoryPulsing * 0.2 + u_beatIntensity * 0.1);
  
  // Enhanced visualEffects vignette
  ${X.visualEffectsVignette()}
  
  fragColor = color;`}static surfaceVisualEffectsDynamicsFragment(){return`
  ${X.musicFlowLogic()}
  
  // Calculate surface visualEffects position with flow
  vec2 surfaceUV = uv;
  surfaceUV += temporalFlowDirection(uv, u_time, u_temporalFlowDirection);
  
  // Apply surface visualEffects flow for smooth boundaries
  float surfaceFlow = surfaceVisualEffectsFlow(surfaceUV, u_surfaceFluidityIndex, u_awarenessLevel);
  surfaceUV += vec2(surfaceFlow * 0.02);
  
  // Enhanced noise sampling with surface distortion
  vec2 noiseUV = surfaceUV + flowDirection * u_time * 0.03;
  float surfaceNoise = snoise(noiseUV * 3.0 + surfaceFlow);
  float visualEffectsNoise = snoise(noiseUV * 1.5) * u_visualEffectsLevel;
  
  // Combine surface and visualEffects noise
  float t = (surfaceNoise * 0.6 + visualEffectsNoise * 0.4) * 0.5 + 0.5;
  t = clamp(t, 0.0, 1.0);
  
  // Sample gradient with surface visualEffects modulation
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  
  // Apply visualEffects field influence to surface
  float fieldInfluence = visualEffectsFieldIntensity(surfaceUV, u_time, u_musicEnergy);
  color.rgb = awarenessResonance(color.rgb, fieldInfluence, u_musicEnergy);
  
  // Enhanced surface animation with emotional resonance
  float surfacePulsing = deepVisualEffectsPulsing(u_time, u_animationCycle, u_emotionalIntensity);
  color.rgb *= (0.9 + surfacePulsing * 0.2 + surfaceFlow * 0.1);
  
  // Musical visualEffects synchronization
  color.a *= (0.85 + u_musicalVisualEffectsSync * 0.15 + u_beatIntensity * 0.1);
  
  // Apply enhanced vignette with surface dynamics
  ${X.visualEffectsVignette()}
  
  fragColor = color;`}},oa=class{static generateOptimizedShader(t,e){switch(e){case"high":return t;case"medium":return t.replace(/snoise\(.*?\)/g,"snoise($1)").replace(/\* 0\.0[1-9]/g,"* 0.02");case"low":return t.replace(/snoise\(.*?\) \* 0\.[0-9]+/g,"0.5").replace(/sin\(.*?\) \* 0\.[0-9]+/g,"0.0");default:return t}}static calculateShaderComplexity(t){let e=0;return e+=(t.match(/snoise/g)||[]).length*10,e+=(t.match(/sin|cos|tan/g)||[]).length*2,e+=(t.match(/texture/g)||[]).length*3,e+=(t.match(/mix|smoothstep/g)||[]).length*1,e}static generateFallbackShader(){return ze.buildFragmentShader({includeNoiseFunctions:!1,includeVisualEffectsFunctions:!1,additionalUniforms:"uniform sampler2D u_gradientTex;",mainShaderLogic:`
  // Minimal fallback visualEffects shader
  float t = uv.x + sin(u_time * 0.5 + u_rhythmicPulse) * 0.1;
  t = clamp(t, 0.0, 1.0);
  
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  color.a *= 0.8 + u_beatIntensity * 0.2;
  
  fragColor = color;`})}},la={Template:ze,VERTEX_SHADER:Ml,NOISE_FUNCTIONS:Jn,VISUAL_EFFECTS_FUNCTIONS:es,CORRIDOR_FUNCTIONS:ts,STANDARD_UNIFORMS:is,LogicPatterns:X,Fragments:sa,Optimization:oa,AdvancedEffects:{VISUAL_EFFECTS_FIELD_PATTERNS:["visualEffectsFieldIntensity","awarenessResonance","temporalFlowDirection","surfaceVisualEffectsFlow","visualEffectsMemoryPulsing"],YEAR_3000_PATTERNS:["temporalFlowDirection","visualEffectsMemoryPulsing","deepVisualEffectsPulsing"],MEMBRANE_DYNAMICS:["surfaceVisualEffectsFlow","surfaceFluidityEffect"]}}});var Tl,xl,bt,ca=v(()=>{"use strict";B();$();_();pe();R();ee();ft();ge();rs();Tl=ze.buildFragmentShader({additionalUniforms:`
// WebGL-specific uniforms
uniform sampler2D u_gradientTex;
uniform float u_flowStrength;
uniform float u_noiseScale;
uniform float u_colorIntensity;
uniform float u_patternScale;
uniform float u_animationSpeed;

// Wave stack uniforms
uniform float u_waveY[2];
uniform float u_waveHeight[2];
uniform float u_waveOffset[2];
uniform float u_blurExp;
uniform float u_blurMax;`,additionalFunctions:`
// Octave noise for richer detail
float octaveNoise(vec2 uv, float octaves, float persistence, float scale) {
  float value = 0.0;
  float amplitude = 1.0;
  float frequency = scale;
  float maxValue = 0.0;

  for(float i = 0.0; i < octaves; i++) {
    value += snoise(uv * frequency) * amplitude;
    maxValue += amplitude;
    amplitude *= persistence;
    frequency *= 2.0;
  }

  return value / maxValue;
}

// Wave alpha calculation
float waveAlpha(vec2 uv, int waveIndex) {
  float y = uv.y;
  float waveCenter = u_waveY[waveIndex];
  float waveHeight = u_waveHeight[waveIndex];

  float distance = abs(y - waveCenter);
  return 1.0 - smoothstep(0.0, waveHeight * 0.5, distance);
}

// Dynamic blur calculation
float calculateBlur(vec2 uv) {
  vec2 center = vec2(0.5, 0.5);
  float distance = length(uv - center);
  float blur = pow(distance, u_blurExp);
  return clamp(blur, 0.0, u_blurMax);
}`,mainShaderLogic:la.Fragments.webglGradientFragment()}),xl=ze.buildFragmentShader({additionalUniforms:`
// WebGL-specific uniforms
uniform sampler2D u_gradientTex;
uniform float u_flowStrength;
uniform float u_noiseScale;`,includeCorridorFunctions:!0,mainShaderLogic:la.Fragments.corridorBubbleFragment()}),bt=class extends q{constructor(e=w,i,r,a=null,n=null){super(e,i,r,a);this.canvas=null;this.wrapper=null;this.gl=null;this.shaderProgram=null;this.corridorShaderProgram=null;this.uniforms={};this.corridorUniforms={};this.gradientTexture=null;this.vertexBuffer=null;this.vao=null;this.settings={enabled:!0,intensity:"balanced",webglPersistenceMode:"adaptive",flowStrength:.7,noiseScale:1.2,waveY:[.25,.75],waveHeight:[.4,.3],waveOffset:[2.5,-1.8],blurExp:1.2,blurMax:.6,corridorEnabled:!1,corridorIntensity:.8,corridorFlowStrength:1.2,corridorDepthEffect:.6,corridorBubbleScale:1};this.isWebGLAvailable=!1;this.startTime=0;this.lastFrameTime=0;this.frameThrottleInterval=1e3/60;this.colorHarmonyEngine=null;this.cssVisualEffectsController=null;this.eventSubscriptionIds=[];this.prefersReducedMotion=!1;this.visualEffectsChoreographer=null;this.currentVisualEffectsField=null;this.webglReady=!1;this.textureUpdatePending=!1;this.lastTextureUpdate=0;this.textureUpdateDebounceTimer=null;this.textureUpdateThrottleMs=50;this.textureUpdateDebounceMs=300;this.textureCreationInProgress=!1;this.contextLost=!1;this.pendingContextRestore=!1;this.contextLossCount=0;this.maxContextLossRetries=10;this.lastSuccessfulRender=0;this.contextRecoveryTimeouts=[100,200,400,800,1600,3200,5e3,5e3,5e3,5e3];this.currentRecoveryAttempt=0;this.currentQualityLevel=null;this.qualityCapabilities=[{name:"webgl-rendering",enabled:!0,qualityLevel:"high"},{name:"shader-complexity",enabled:!0,qualityLevel:"high"},{name:"noise-octaves",enabled:!0,qualityLevel:"medium"},{name:"wave-layers",enabled:!0,qualityLevel:"medium"},{name:"blur-effects",enabled:!0,qualityLevel:"low"},{name:"flow-strength",enabled:!0,qualityLevel:"low"},{name:"corridor-effects",enabled:!0,qualityLevel:"high"},{name:"corridor-sdf-complexity",enabled:!0,qualityLevel:"medium"},{name:"corridor-bubble-layers",enabled:!0,qualityLevel:"medium"},{name:"corridor-depth-effects",enabled:!0,qualityLevel:"low"}];this.qualityAdjustments={};this.systemName="WebGLGradientBackgroundSystem";this.lastColorHarmonizedData=null;this.lastColorHarmonizedTime=0;this.resize=()=>{if(!this.canvas)return;let e=window.devicePixelRatio||1,i=window.innerWidth,r=window.innerHeight;this.canvas.width=i*e,this.canvas.height=r*e,this.canvas.style.width=i+"px",this.canvas.style.height=r+"px"};e.enableDebug&&u?.debug?.warn("WebGLGradientBackgroundSystem","\u26A0\uFE0F DEPRECATED: WebGLGradientBackgroundSystem is being phased out. Please migrate to WebGLGradientStrategy (src-js/visual/strategies/WebGLGradientStrategy.ts) which provides OKLAB color processing, progressive fallbacks, and better error handling. This class will be removed after migration is complete."),this.colorHarmonyEngine=n?.colorHarmonyEngine||null,this.visualEffectsChoreographer=n?.backgroundVisualEffectsChoreographer||null,this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches}get systemPriority(){return"high"}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();let e=globalThis.year3000System;if(this.cssController=e?.cssVisualEffectsController||A(),this.isWebGLAvailable=this.checkWebGL2Support(),!this.isWebGLAvailable)if(this.shouldAttemptWebGLRecovery()){if(u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL2 not available but persistence mode enabled - attempting WebGL1 compatibility mode"),this.isWebGLAvailable=this.checkWebGL1Support(),!this.isWebGLAvailable){u?.debug?.error("WebGLGradientBackgroundSystem","Neither WebGL2 nor WebGL1 available despite persistence mode"),this.fallbackToCSSGradient();return}}else{this.fallbackToCSSGradient();return}let i=new W;await i.initialize();let r=i.recommendPerformanceQuality(),a=i.getCapabilities();if(r==="low"?(u?.debug?.log("WebGLGradientBackgroundSystem","Low performance device detected - trying minimal WebGL quality",{performanceQuality:r,deviceCapabilities:a?.overall,memoryLevel:a?.memory.level,gpuLevel:a?.gpu.level}),this.frameThrottleInterval=1e3/20,this.textureUpdateThrottleMs=1e3,this.settings.corridorEnabled=!1,this.settings.intensity="minimal",this.settings.flowStrength=.3):u?.debug?.log("WebGLGradientBackgroundSystem","Device capabilities acceptable for WebGL",{performanceQuality:r,deviceCapabilities:a?.overall}),this.loadSettings(),!this.settings.enabled){this.fallbackToCSSGradient();return}try{await this.initializeWebGL(),this.subscribeToEvents(),this.registerWithVisualEffectsChoreographer();let n={"--sn.bg.webgl.ready":"1","--sn.bg.webgl.enabled":"1","--sn.bg.active-backend":"hybrid","--sn-gradient-crossfade-opacity":"0.5"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",n,"high","webgl-initialization"),u?.debug?.log("WebGLGradientBackgroundSystem","WebGL gradient system initialized successfully")}catch(n){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to initialize WebGL gradient:",n),this.fallbackToCSSGradient()}}checkWebGL2Support(){try{let i=document.createElement("canvas").getContext("webgl2");if(!i)return u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL2 context creation failed"),!1;let r=["EXT_color_buffer_float"],a=[];for(let l of r)i.getExtension(l)||a.push(l);a.length>0&&u?.debug?.warn("WebGLGradientBackgroundSystem","Missing WebGL2 extensions:",a);let n=i.getParameter(i.MAX_TEXTURE_SIZE),s=i.getParameter(i.MAX_RENDERBUFFER_SIZE);return u?.debug?.log("WebGLGradientBackgroundSystem","WebGL2 capability check:",{maxTextureSize:n,maxRenderbufferSize:s,missingExtensions:a.length>0?a:"none"}),!0}catch(e){return u?.debug?.error("WebGLGradientBackgroundSystem","WebGL2 support check failed:",e),!1}}checkWebGL1Support(){try{let e=document.createElement("canvas"),i=e.getContext("webgl")||e.getContext("experimental-webgl");if(!i)return u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL1 context creation failed"),!1;let r=i.getParameter(i.MAX_TEXTURE_SIZE),a=i.getParameter(i.MAX_RENDERBUFFER_SIZE);return u?.debug?.log("WebGLGradientBackgroundSystem","WebGL1 fallback capability check:",{maxTextureSize:r,maxRenderbufferSize:a}),!0}catch(e){return u?.debug?.error("WebGLGradientBackgroundSystem","WebGL1 support check failed:",e),!1}}findSpotifyContainer(){let e=[".Root__main-view",".main-view-container",".main-gridContainer-gridContainer",".Root__top-container","body"];for(let i of e){let r=document.querySelector(i);if(r)return u?.debug?.log("WebGLGradientBackgroundSystem",`Found container: ${i}`),r}return u?.debug?.warn("WebGLGradientBackgroundSystem","No Spotify container found, falling back to body"),document.body}loadSettings(){try{let e=E.get("sn-webgl-enabled"),i=E.get("sn-gradient-intensity");if(!e){this.settings.enabled=!1,u?.debug?.log("WebGLGradientBackgroundSystem","WebGL disabled by user setting");return}if(this.settings.webglPersistenceMode="adaptive",i==="disabled"){this.settings.enabled=!1;return}switch(this.settings.intensity=i||"balanced",this.settings.intensity){case"minimal":this.settings.flowStrength=.4,this.settings.noiseScale=.8,this.settings.waveHeight=[.3,.2],this.settings.waveOffset=[1.5,-1],this.settings.blurExp=1,this.settings.blurMax=.4;break;case"balanced":this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.waveOffset=[2.5,-1.8],this.settings.blurExp=1.2,this.settings.blurMax=.6;break;case"intense":this.settings.flowStrength=1,this.settings.noiseScale=1.6,this.settings.waveHeight=[.5,.4],this.settings.waveOffset=[3.5,-2.5],this.settings.blurExp=1.4,this.settings.blurMax=.8;break}u?.debug?.log("WebGLGradientBackgroundSystem","Settings loaded:",{webglEnabled:e,persistenceMode:this.settings.webglPersistenceMode,intensity:this.settings.intensity,enabled:this.settings.enabled})}catch(e){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to load settings, using defaults:",e)}}applyUpdatedSettings(e,i){u?.debug?.log("WebGLGradientBackgroundSystem",`Runtime setting changed: ${e} = ${i}`);try{switch(e){case"sn-webgl-enabled":i?i&&!this.settings.enabled&&(this.settings.enabled=!0,!this.gl&&this.canvas&&this.initialize()):(this.settings.enabled=!1,this.destroy());break;case"sn-gradient-intensity":if(i==="disabled")this.settings.enabled=!1;else switch(this.settings.enabled=!0,this.settings.intensity=i||"balanced",this.settings.intensity){case"minimal":this.settings.flowStrength=.4,this.settings.noiseScale=.8,this.settings.waveHeight=[.3,.2],this.settings.waveOffset=[1.5,-1],this.settings.blurExp=1,this.settings.blurMax=.4;break;case"balanced":this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.waveOffset=[2.5,-1.8],this.settings.blurExp=1.2,this.settings.blurMax=.6;break;case"intense":this.settings.flowStrength=1,this.settings.noiseScale=1.6,this.settings.waveHeight=[.5,.4],this.settings.waveOffset=[3.5,-2.5],this.settings.blurExp=1.4,this.settings.blurMax=.8;break}break;default:return}this.forceRepaint?.(`setting-change:${e}`)}catch(r){u?.debug?.error("WebGLGradientBackgroundSystem",`Failed to apply runtime setting ${e}:`,r)}}async initializeWebGL(){this.wrapper=document.createElement("div"),this.wrapper.className="sn-gradient-effects-wrapper",this.wrapper.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -11;
      pointer-events: none;
      overflow: hidden;
    `,this.canvas=document.createElement("canvas"),this.canvas.id="sn-webgl-gradient",this.canvas.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    `,this.wrapper.appendChild(this.canvas);try{if(this.gl=this.canvas.getContext("webgl2",{alpha:!0,antialias:!1,depth:!1,stencil:!1,powerPreference:"default"}),!this.gl)throw new Error("WebGL2 context creation returned null - likely unsupported");this.setupContextLossHandlers();let i=this.gl.getParameter(this.gl.VERSION);if(!i)throw new Error("WebGL2 context appears non-functional - getParameter failed");u?.debug?.log("WebGLGradientBackgroundSystem","WebGL2 context created successfully:",{version:i,renderer:this.gl.getParameter(this.gl.RENDERER),vendor:this.gl.getParameter(this.gl.VENDOR)})}catch(i){throw u?.debug?.error("WebGLGradientBackgroundSystem","WebGL2 context creation failed:",i),new Error(`Failed to create WebGL2 context: ${i instanceof Error?i.message:"Unknown error"}`)}await this.compileShaders(),this.createGeometry(),await this.updateGradientTexture(),this.setupUniforms(),this.resize(),this.findSpotifyContainer().appendChild(this.wrapper),window.addEventListener("resize",this.resize.bind(this))}async compileShaders(){if(!this.gl)throw new Error("WebGL context not available");let e=null,i=null,r="full";if(e=Q.loadVertex(this.gl,Vt),!e)throw new Error("Failed to compile vertex shader - even basic vertex shader failed");let a=[{name:"full",shader:Tl,description:"Full visualEffects shader with all features"},{name:"simplified",shader:this.getSimplifiedFragmentShader(),description:"Simplified shader without complex noise functions"},{name:"basic",shader:this.getBasicFragmentShader(),description:"Basic gradient shader with minimal features"},{name:"emergency",shader:this.getEmergencyFragmentShader(),description:"Emergency shader for maximum hardware compatibility"}];for(let s of a)try{if(i=Q.loadFragment(this.gl,s.shader),i){r=s.name,u?.debug?.log("WebGLGradientBackgroundSystem",`Successfully compiled shader variant: ${s.name}`,{description:s.description});break}}catch(l){u?.debug?.warn("WebGLGradientBackgroundSystem",`Failed to compile ${s.name} shader variant:`,l);continue}if(!i)throw new Error("Failed to compile any fragment shader variant");if(this.shaderProgram=Q.createProgram(this.gl,e,i),!this.shaderProgram)throw new Error("Failed to create shader program");let n=Q.loadFragment(this.gl,xl);if(!n){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to compile corridor shader - corridor effects disabled"),this.settings.corridorEnabled=!1;return}this.corridorShaderProgram=Q.createProgram(this.gl,e,n),this.corridorShaderProgram||(u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to create corridor shader program - corridor effects disabled"),this.settings.corridorEnabled=!1)}createGeometry(){if(!this.gl||!this.shaderProgram)return;let e=new Float32Array([-1,-1,3,-1,-1,3]);this.vertexBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.STATIC_DRAW),this.vao=this.gl.createVertexArray(),this.gl.bindVertexArray(this.vao);let i=this.gl.getAttribLocation(this.shaderProgram,"a_position");this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,0,0),this.gl.bindVertexArray(null)}setupUniforms(){!this.gl||!this.shaderProgram||(this.uniforms.u_time=this.gl.getUniformLocation(this.shaderProgram,"u_time"),this.uniforms.u_gradientTex=this.gl.getUniformLocation(this.shaderProgram,"u_gradientTex"),this.uniforms.u_resolution=this.gl.getUniformLocation(this.shaderProgram,"u_resolution"),this.uniforms.u_flowStrength=this.gl.getUniformLocation(this.shaderProgram,"u_flowStrength"),this.uniforms.u_noiseScale=this.gl.getUniformLocation(this.shaderProgram,"u_noiseScale"),this.uniforms.u_waveY=this.gl.getUniformLocation(this.shaderProgram,"u_waveY"),this.uniforms.u_waveHeight=this.gl.getUniformLocation(this.shaderProgram,"u_waveHeight"),this.uniforms.u_waveOffset=this.gl.getUniformLocation(this.shaderProgram,"u_waveOffset"),this.uniforms.u_blurExp=this.gl.getUniformLocation(this.shaderProgram,"u_blurExp"),this.uniforms.u_blurMax=this.gl.getUniformLocation(this.shaderProgram,"u_blurMax"),this.corridorShaderProgram&&this.setupCorridorUniforms())}setupCorridorUniforms(){if(!this.gl||!this.corridorShaderProgram)return;let e=ze.getCorridorUniformNames();for(let i of e)this.corridorUniforms[i]=this.gl.getUniformLocation(this.corridorShaderProgram,i)}updateVisualEffectsUniforms(e,i){if(!this.gl)return;let r=this.currentVisualEffectsField,a=r?.pulseRate??.5;e.u_rhythmicPulse&&this.gl.uniform1f(e.u_rhythmicPulse,a);let n=r?.flowDirection??{x:0,y:0};e.u_musicalFlow&&n&&this.gl.uniform2f(e.u_musicalFlow,n.x??0,n.y??0);let s=r?.energyLevel??.5;e.u_energyResonance&&this.gl.uniform1f(e.u_energyResonance,s);let l=Math.sin(i*.05)*.5+.5;e.u_pulsingCycle&&this.gl.uniform1f(e.u_pulsingCycle,l);let c=r?.fluidIntensity??.3;if(e.u_surfaceFluidityIndex&&this.gl.uniform1f(e.u_surfaceFluidityIndex,c),this.musicSyncService){let m=this.musicSyncService.getCurrentMusicState();if(m){let d=m.beat?.energy??.5,h=m.emotion?.valence??.5,g=m.intensity??0,f=m.beat?.energy??0;e.u_musicEnergy&&this.gl.uniform1f(e.u_musicEnergy,d),e.u_musicValence&&this.gl.uniform1f(e.u_musicValence,h),e.u_beatIntensity&&this.gl.uniform1f(e.u_beatIntensity,g),e.u_bassResponse&&this.gl.uniform1f(e.u_bassResponse,f)}}}async updateGradientTexture(){if(!this.gl){u?.debug?.warn("WebGLGradientBackgroundSystem","No WebGL context available");return}if(!this.isContextValid()){u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL context invalid, attempting recovery"),this.contextLost&&!this.pendingContextRestore&&(u?.debug?.log("WebGLGradientBackgroundSystem","Attempting WebGL context recovery"),this.fallbackToCSSGradient());return}let e=this.gl.getError();if(e!==this.gl.NO_ERROR)for(u?.debug?.warn("WebGLGradientBackgroundSystem",`WebGL error detected before texture update: ${e}`);this.gl.getError()!==this.gl.NO_ERROR;);if(this.textureCreationInProgress){u?.debug?.log("WebGLGradientBackgroundSystem","Texture creation already in progress, skipping update");return}this.textureCreationInProgress=!0;try{let i=this.getDefaultGradientStops(),r="default";if(this.colorHarmonyEngine)try{let l=this.colorHarmonyEngine.getCurrentGradient(5);if(l&&l.length>0)i=l.map((c,m)=>({r:c.r/255,g:c.g/255,b:c.b/255,a:1,position:m/(l.length-1)})),r="ColorHarmonyEngine",u?.debug?.log("WebGLGradientBackgroundSystem",`Updated gradient texture with ${i.length} stops from ColorHarmonyEngine`);else{let c=this.getCSSGradientStops();c&&c.length>0&&(i=c,r="CSS variables",u?.debug?.log("WebGLGradientBackgroundSystem",`ColorHarmonyEngine returned empty, using CSS gradient fallback with ${i.length} stops`))}}catch(l){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to get gradient from ColorHarmonyEngine, trying CSS fallback:",l);let c=this.getCSSGradientStops();c&&c.length>0&&(i=c,r="CSS variables (engine failed)",u?.debug?.log("WebGLGradientBackgroundSystem",`Using CSS gradient fallback after ColorHarmonyEngine error with ${i.length} stops`))}else{let l=this.getCSSGradientStops();l&&l.length>0&&(i=l,r="CSS variables (no engine)",u?.debug?.log("WebGLGradientBackgroundSystem",`No ColorHarmonyEngine available, using CSS gradient fallback with ${i.length} stops`))}if(u?.debug?.log("WebGLGradientBackgroundSystem",`Final color source: ${r}, stops: ${i.length}`),this.gl.isContextLost())throw new Error("WebGL context was lost during gradient preparation");if(this.gradientTexture){try{this.gl.deleteTexture(this.gradientTexture)}catch(l){u?.debug?.warn("WebGLGradientBackgroundSystem","Error deleting old texture:",l)}this.gradientTexture=null}(!i||i.length===0)&&(u?.debug?.warn("WebGLGradientBackgroundSystem","No valid color stops, using defaults"),i=this.getDefaultGradientStops());let a=null,n=0,s=3;for(;!a&&n<s;){n++;try{if(this.gl.isContextLost())throw new Error("WebGL context lost during texture creation attempt");if(a=me(this.gl,i),a){u?.debug?.log("WebGLGradientBackgroundSystem",`Gradient texture created successfully on attempt ${n}`);break}}catch(l){u?.debug?.warn("WebGLGradientBackgroundSystem",`Texture creation attempt ${n} failed:`,l),n<s&&await new Promise(c=>setTimeout(c,n*10))}}if(a)this.gradientTexture=a;else{u?.debug?.error("WebGLGradientBackgroundSystem","Failed to create gradient texture after all attempts - trying default colors");try{let l=this.getDefaultGradientStops(),c=me(this.gl,l);if(!c)throw new Error("Failed to create gradient texture even with default colors");this.gradientTexture=c,i=l,u?.debug?.log("WebGLGradientBackgroundSystem","Using default gradient fallback after all attempts failed")}catch(l){u?.debug?.error("WebGLGradientBackgroundSystem","Default gradient fallback failed, attempting emergency solid color:",l);try{let c=[{r:.196,g:.165,b:.282,a:1,position:0},{r:.196,g:.165,b:.282,a:1,position:1}],m=me(this.gl,c);if(m)this.gradientTexture=m,i=c,u?.debug?.warn("WebGLGradientBackgroundSystem","Using emergency solid color texture as final fallback");else throw new Error("Emergency solid color texture creation failed")}catch(c){throw u?.debug?.error("WebGLGradientBackgroundSystem","Emergency solid color texture failed:",c),new Error(`All gradient texture creation methods failed: ${c}`)}}}this.lastTextureUpdate=performance.now(),u?.debug?.log("WebGLGradientBackgroundSystem",`Gradient texture updated successfully using ${r}`,{colorStops:i.length,source:r,firstColor:i[0]?`rgb(${Math.round(i[0].r*255)},${Math.round(i[0].g*255)},${Math.round(i[0].b*255)})`:"none"})}catch(i){if(u?.debug?.error("WebGLGradientBackgroundSystem","Critical error in updateGradientTexture:",i),i instanceof Error&&i.message.includes("context"))u?.debug?.log("WebGLGradientBackgroundSystem","WebGL context-related error detected, switching to CSS fallback"),this.fallbackToCSSGradient();else{u?.debug?.log("WebGLGradientBackgroundSystem","Attempting simple texture recovery with default colors");try{this.gradientTexture=null;let r=this.getDefaultGradientStops();if(this.gl&&!this.gl.isContextLost())if(this.gradientTexture=me(this.gl,r),this.gradientTexture)u?.debug?.log("WebGLGradientBackgroundSystem","Successfully recovered with default gradient");else throw new Error("Recovery attempt failed");else throw new Error("WebGL context unavailable for recovery")}catch(r){u?.debug?.error("WebGLGradientBackgroundSystem","Recovery attempt failed, falling back to CSS:",r),this.fallbackToCSSGradient()}}}finally{this.textureCreationInProgress=!1}}async updateGradientTextureThrottled(){let e=performance.now();if(e-this.lastTextureUpdate<this.textureUpdateThrottleMs){if(!this.textureUpdatePending){this.textureUpdatePending=!0;let i=this.textureUpdateThrottleMs-(e-this.lastTextureUpdate);setTimeout(()=>{this.textureUpdatePending=!1,this.updateGradientTexture().catch(r=>{u?.debug?.error("WebGLGradientBackgroundSystem","Throttled texture update failed:",r)})},i)}return}await this.updateGradientTexture()}debouncedUpdateGradientTexture(){this.textureUpdateDebounceTimer&&clearTimeout(this.textureUpdateDebounceTimer),this.textureUpdateDebounceTimer=window.setTimeout(()=>{this.textureUpdateDebounceTimer=null,this.updateGradientTextureThrottled().catch(e=>{u?.debug?.error("WebGLGradientBackgroundSystem","Debounced texture update failed:",e)})},this.textureUpdateDebounceMs)}setupContextLossHandlers(){if(!this.canvas)return;this.canvas.addEventListener("webglcontextlost",async i=>{if(this.contextLossCount++,u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL context lost - Enhanced Recovery",{lossCount:this.contextLossCount,maxRetries:this.maxContextLossRetries}),i.preventDefault(),this.contextLost=!0,this.textureCreationInProgress=!1,this.contextLossCount<=this.maxContextLossRetries){let r=Math.min(this.contextLossCount-1,this.contextRecoveryTimeouts.length-1),a=this.contextRecoveryTimeouts[r]||5e3;if(u?.debug?.log("WebGLGradientBackgroundSystem",`Preparing for context recovery attempt ${this.contextLossCount}/${this.maxContextLossRetries} with ${a}ms backoff`,{shouldPersist:this.shouldPersistWebGL()}),this.gl)try{let{ShaderLoader:n}=await Promise.resolve().then(()=>(ft(),na));n.clearContextCache(this.gl)}catch{}this.textureUpdateDebounceTimer&&(clearTimeout(this.textureUpdateDebounceTimer),this.textureUpdateDebounceTimer=null),this.textureUpdatePending=!1}else this.shouldPersistWebGL()?(u?.debug?.warn("WebGLGradientBackgroundSystem",`Context lost ${this.contextLossCount} times but persistence mode enabled - resetting retry count and continuing`),this.contextLossCount=Math.max(1,this.maxContextLossRetries-3),this.currentRecoveryAttempt=0):(u?.debug?.error("WebGLGradientBackgroundSystem",`Context lost ${this.contextLossCount} times - falling back to CSS gradient`),this.fallbackToCSSGradient())},!1);let e=async()=>{if(!this.contextLost||this.pendingContextRestore)return;let i=Math.min(this.currentRecoveryAttempt,this.contextRecoveryTimeouts.length-1),r=this.contextRecoveryTimeouts[i]||5e3;u?.debug?.log("WebGLGradientBackgroundSystem",`Attempting context recovery in ${r}ms (attempt ${this.currentRecoveryAttempt+1})`),setTimeout(async()=>{if(this.contextLost){this.currentRecoveryAttempt++;try{this.gl&&this.gl.isContextLost()&&this.gl.getError()}catch(a){u?.debug?.warn("WebGLGradientBackgroundSystem","Error during context recovery attempt:",a)}this.contextLost&&this.currentRecoveryAttempt<this.maxContextLossRetries&&e()}},r)};this.canvas.addEventListener("webglcontextlost",()=>{this.currentRecoveryAttempt=0,e()}),this.canvas.addEventListener("webglcontextrestored",async()=>{u?.debug?.log("WebGLGradientBackgroundSystem","WebGL context restored - Enhanced Recovery",{lossCount:this.contextLossCount,maxRetries:this.maxContextLossRetries}),this.contextLost=!1,this.pendingContextRestore=!0;try{if(!this.gl||this.gl.isContextLost())throw new Error("Context is still lost after restore event");await this.reinitializeWebGLResources(),this.contextLossCount>=2?(u?.debug?.log("WebGLGradientBackgroundSystem","Reducing quality after multiple context losses"),this.adjustQualityForTier("low")):this.contextLossCount>=1&&(u?.debug?.log("WebGLGradientBackgroundSystem","Reducing quality after context loss"),this.adjustQualityForTier("medium")),this.pendingContextRestore=!1,u?.debug?.log("WebGLGradientBackgroundSystem","WebGL context restore completed successfully",{lossCount:this.contextLossCount,qualityReduced:this.contextLossCount>0})}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to restore WebGL context:",i),this.pendingContextRestore=!1,this.contextLossCount++,this.contextLossCount>this.maxContextLossRetries&&(u?.debug?.error("WebGLGradientBackgroundSystem","Context restoration failed too many times - falling back to CSS"),this.fallbackToCSSGradient())}},!1)}async reinitializeWebGLResources(){if(!this.gl)throw new Error("WebGL context not available");this.shaderProgram=null,this.vertexBuffer=null,this.vao=null,this.gradientTexture=null;let{ShaderLoader:e}=await Promise.resolve().then(()=>(ft(),na));e.clearContextCache(this.gl),await this.compileShaders(),this.createGeometry(),await this.updateGradientTexture(),this.setupUniforms(),u?.debug?.log("WebGLGradientBackgroundSystem","WebGL resources reinitialized after context restore")}isContextValid(){return!this.gl||this.contextLost?!1:this.gl.isContextLost()?(this.contextLost=!0,!1):!0}getDefaultGradientStops(){return[{r:.196,g:.165,b:.282,a:1,position:0},{r:.549,g:.408,b:.878,a:1,position:.3},{r:.788,g:.557,b:.902,a:1,position:.6},{r:.957,g:.761,b:.494,a:1,position:1}]}getCSSGradientStops(){try{let e=document.documentElement,i=getComputedStyle(e),r=["--sn-bg-gradient-primary-rgb","--sn-bg-gradient-secondary-rgb","--sn-bg-gradient-tertiary-rgb"],a=[];for(let l=0;l<r.length;l++){let c=r[l]||"--sn-bg-gradient-primary-rgb",m=i.getPropertyValue(c).trim();if(!m){u?.debug?.log("WebGLGradientBackgroundSystem",`CSS variable ${c} not set, trying without CSS fallback`);continue}let d=m.split(",").map(h=>parseInt(h.trim(),10));if(d.length!==3||d.some(h=>isNaN(h)||h<0||h>255)){u?.debug?.warn("WebGLGradientBackgroundSystem",`Invalid RGB values in ${c}: ${m}, skipping this color`);continue}a.push({r:(d[0]??0)/255,g:(d[1]??0)/255,b:(d[2]??0)/255,a:1,position:l/(r.length-1)})}if(a.length<2)return u?.debug?.log("WebGLGradientBackgroundSystem",`Only ${a.length} valid CSS colors found, need at least 2 for gradient`),null;let n=i.getPropertyValue("--sn-bg-gradient-opacity").trim(),s=n?parseFloat(n):1;return s!==1&&s>0&&s<=1&&a.forEach(l=>{l.a=s}),u?.debug?.log("WebGLGradientBackgroundSystem",`Successfully parsed ${a.length} CSS background gradient stops from OKLAB inheritance`,{colors:a.map(l=>`rgba(${Math.round(l.r*255)},${Math.round(l.g*255)},${Math.round(l.b*255)},${l.a})`),opacity:s!==1?s:"default"}),a}catch(e){return u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to parse CSS background gradient variables:",e),null}}subscribeToEvents(){let e=p.subscribe("colors:harmonized",this.handleColorHarmonized.bind(this),"WebGLGradientBackgroundSystem");this.eventSubscriptionIds.push(e);let i=p.subscribe("colors:applied",this.handleColorApplied.bind(this),"WebGLGradientBackgroundSystem");this.eventSubscriptionIds.push(i);let r=p.subscribe("performance:tier-changed",this.handlePerformanceTierChanged.bind(this),"WebGLGradientBackgroundSystem");this.eventSubscriptionIds.push(r),u?.debug?.log("WebGLGradientBackgroundSystem","Subscribed to unified events",{subscriptionCount:this.eventSubscriptionIds.length,events:["colors:harmonized","colors:applied","performance:tier-changed"]})}handleColorHarmonized(e){let i=performance.now(),r=`${e.accentHex}-${e.processingTime}-${e.strategies.join(",")}`;if(this.lastColorHarmonizedData===r&&i-this.lastColorHarmonizedTime<100){u?.debug?.log("WebGLGradientBackgroundSystem","Duplicate color harmonization event detected, skipping");return}this.lastColorHarmonizedData=r,this.lastColorHarmonizedTime=i,this.debouncedUpdateGradientTexture(),u?.debug?.log("WebGLGradientBackgroundSystem","Color harmonization processed",{strategies:e.strategies,processingTime:e.processingTime,accentHex:e.accentHex,deduplicationHash:r.substring(0,16)+"..."})}handleColorApplied(e){u?.debug?.log("WebGLGradientBackgroundSystem","Color application coordinated",{accentHex:e.accentHex,appliedAt:e.appliedAt})}handlePerformanceTierChanged(e){if(!(!this.isActive||!this.gl))switch(u?.debug?.log("WebGLGradientBackgroundSystem","Performance tier changed",{previousTier:e.previousTier,newTier:e.tier,timestamp:e.timestamp}),e.tier){case"excellent":this.adjustQualityForTier("high");break;case"good":this.adjustQualityForTier("medium");break;case"degraded":this.adjustQualityForTier("low"),u?.debug?.warn("WebGLGradientBackgroundSystem","Performance degraded - reducing WebGL quality instead of fallback");break;case"critical":e.previousTier==="degraded"?this.shouldPersistWebGL()?(u?.debug?.warn("WebGLGradientBackgroundSystem","Critical performance but persistence mode enabled - reducing to absolute minimum WebGL quality"),this.adjustQualityForTier("emergency")):(u?.debug?.warn("WebGLGradientBackgroundSystem","Critical performance detected - falling back to CSS gradient"),this.fallbackToCSSGradient()):(this.adjustQualityForTier("minimal"),u?.debug?.warn("WebGLGradientBackgroundSystem","Critical performance - using minimal WebGL quality"));break}}adjustQualityForTier(e){if(!this.gl||!this.canvas)return;switch(e){case"high":this.frameThrottleInterval=1e3/60;break;case"medium":this.frameThrottleInterval=1e3/45;break;case"low":this.frameThrottleInterval=1e3/30;break;case"minimal":this.frameThrottleInterval=1e3/15;break;case"emergency":this.frameThrottleInterval=1e3/10;break}switch(e){case"high":this.textureUpdateThrottleMs=100;break;case"medium":this.textureUpdateThrottleMs=200;break;case"low":this.textureUpdateThrottleMs=500;break;case"minimal":this.textureUpdateThrottleMs=1e3;break;case"emergency":this.textureUpdateThrottleMs=2e3;break}let i=this.findSpotifyContainer();if(i){let a=i.getBoundingClientRect(),n=1;switch(e){case"high":n=1;break;case"medium":n=.8;break;case"low":n=.6;break;case"minimal":n=.4;break;case"emergency":n=.1;break}let s=Math.floor(a.width*n),l=Math.floor(a.height*n);this.canvas.width=s,this.canvas.height=l,this.gl&&this.gl.viewport(0,0,s,l)}let r=this.settings.corridorEnabled;switch(e){case"high":this.settings.intensity="intense",this.settings.flowStrength=Math.max(this.settings.flowStrength,.7);break;case"medium":this.settings.intensity="balanced",this.settings.flowStrength=Math.min(this.settings.flowStrength,.6);break;case"low":this.settings.corridorEnabled=!1,this.settings.intensity="minimal",this.settings.flowStrength=Math.min(this.settings.flowStrength,.4);break;case"minimal":this.settings.corridorEnabled=!1,this.settings.intensity="minimal",this.settings.flowStrength=.2;break}r!==this.settings.corridorEnabled&&u?.debug?.log("WebGLGradientBackgroundSystem",`Corridor shader ${this.settings.corridorEnabled?"enabled":"disabled"} for ${e} quality`),u?.debug?.log("WebGLGradientBackgroundSystem",`Quality adjusted for ${e} performance tier`,{frameFPS:Math.round(1e3/this.frameThrottleInterval),textureFPS:Math.round(1e3/this.textureUpdateThrottleMs),canvasResolution:`${this.canvas.width}x${this.canvas.height}`,corridorEnabled:this.settings.corridorEnabled})}render(e){if(!this.gl||!this.vao)return;if(!this.gradientTexture){u?.debug?.warn("WebGLGradientBackgroundSystem","No gradient texture during render - creating emergency texture");try{let s=[()=>{let l=this.getCSSGradientStops();return l?me(this.gl,l):null},()=>{let l=this.getDefaultGradientStops();return me(this.gl,l)},()=>{let l=[{r:.196,g:.165,b:.282,a:1,position:0},{r:.196,g:.165,b:.282,a:1,position:1}];return me(this.gl,l)}];for(let l=0;l<s.length;l++)try{if(this.gradientTexture=s[l](),this.gradientTexture){u?.debug?.log("WebGLGradientBackgroundSystem",`Emergency texture created using method ${l+1}`);break}}catch(c){u?.debug?.warn("WebGLGradientBackgroundSystem",`Emergency texture method ${l+1} failed:`,c)}if(!this.gradientTexture){u?.debug?.error("WebGLGradientBackgroundSystem","All emergency texture creation methods failed - skipping render");return}}catch(s){u?.debug?.error("WebGLGradientBackgroundSystem","Emergency texture creation failed completely:",s);return}}if(this.lastSuccessfulRender=e,this.contextLossCount>0&&e-this.lastSuccessfulRender>3e4){let s=this.contextLossCount;this.contextLossCount=Math.max(0,this.contextLossCount-1),s!==this.contextLossCount&&u?.debug?.log("WebGLGradientBackgroundSystem","Context loss count reduced due to successful renders",{oldCount:s,newCount:this.contextLossCount})}let i=this.settings.corridorEnabled&&this.corridorShaderProgram&&this.currentQualityLevel!=="low",r=i?this.corridorShaderProgram:this.shaderProgram,a=i?this.corridorUniforms:this.uniforms;if(!r)return;if(this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.useProgram(r),this.gl.bindVertexArray(this.vao),!this.webglReady){this.webglReady=!0;let s={"--sn.bg.webgl.ready":"1","--sn.bg.webgl.enabled":"1","--sn.bg.active-backend":"hybrid","--sn-gradient-crossfade-opacity":"0.5"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",s,"critical","webgl-first-draw")}let n=this.prefersReducedMotion?0:(e-this.startTime)/1e3;if(a.u_time&&this.gl.uniform1f(a.u_time,n),a.u_resolution&&this.gl.uniform2f(a.u_resolution,this.canvas.width,this.canvas.height),a.u_flowStrength){let s=this.settings.flowStrength;try{let c=getComputedStyle(document.documentElement).getPropertyValue("--sn-flow-strength").trim();c&&(s=parseFloat(c))}catch{u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to read flow strength CSS variable, using settings value")}this.gl.uniform1f(a.u_flowStrength,s)}a.u_noiseScale&&this.gl.uniform1f(a.u_noiseScale,this.settings.noiseScale),i||(a.u_waveY&&this.gl.uniform1fv(a.u_waveY,this.settings.waveY),a.u_waveHeight&&this.gl.uniform1fv(a.u_waveHeight,this.settings.waveHeight),a.u_waveOffset&&this.gl.uniform1fv(a.u_waveOffset,this.settings.waveOffset),a.u_blurExp&&this.gl.uniform1f(a.u_blurExp,this.settings.blurExp),a.u_blurMax&&this.gl.uniform1f(a.u_blurMax,this.settings.blurMax)),i&&(a.u_corridorIntensity&&this.gl.uniform1f(a.u_corridorIntensity,this.settings.corridorIntensity),a.u_corridorFlowStrength&&this.gl.uniform1f(a.u_corridorFlowStrength,this.settings.corridorFlowStrength),a.u_corridorDepthEffect&&this.gl.uniform1f(a.u_corridorDepthEffect,this.settings.corridorDepthEffect),a.u_corridorBubbleScale&&this.gl.uniform1f(a.u_corridorBubbleScale,this.settings.corridorBubbleScale),this.updateVisualEffectsUniforms(a,n)),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.gradientTexture),a.u_gradientTex&&this.gl.uniform1i(a.u_gradientTex,0),this.gl.drawArrays(this.gl.TRIANGLES,0,3),this.gl.bindVertexArray(null)}fallbackToCSSGradient(){let e={"--sn.bg.webgl.ready":"0","--sn.bg.webgl.enabled":"0","--sn.bg.active-backend":"css","--sn-gradient-crossfade-opacity":"0"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",e,"critical","webgl-css-fallback"),this.cssVisualEffectsController&&this.startCSSFallbackAnimation(),u?.debug?.log("WebGLGradientBackgroundSystem","Using CSS gradient fallback")}startCSSFallbackAnimation(){if(!this.cssVisualEffectsController)return;let e=()=>{if(!this.isActive)return;let i=performance.now()/1e3,r=Math.sin(i*.04)*20+Math.sin(i*.07)*8,a=Math.cos(i*.05)*20+Math.cos(i*.09)*6,n=1.15+Math.sin(i*.03)*.2,s={"--sn-gradient-flow-x":`${r}%`,"--sn-gradient-flow-y":`${a}%`,"--sn-gradient-flow-scale":n.toString()};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",s,"normal","css-fallback-animation"),setTimeout(e,this.frameThrottleInterval)};e()}handleSettingsChange(e){super.handleSettingsChange(e);let i=e,{key:r,value:a}=i.detail;if(r==="sn-gradient-intensity"){let n=this.settings.enabled;this.settings.intensity=a,this.loadSettings(),a==="disabled"&&n?(this.settings.enabled=!1,this.destroy(),this.fallbackToCSSGradient()):this.settings.enabled&&!n&&this.isWebGLAvailable&&this.initialize()}}_performSystemSpecificCleanup(){if(super._performSystemSpecificCleanup(),this.visualEffectsChoreographer)try{this.visualEffectsChoreographer.unregisterVisualEffectsParticipant("WebGLGradientBackgroundSystem"),u?.debug?.log("WebGLGradientBackgroundSystem","Unregistered from visualEffects choreographer")}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Error unregistering from visualEffects choreographer:",i)}this.textureUpdateDebounceTimer&&(clearTimeout(this.textureUpdateDebounceTimer),this.textureUpdateDebounceTimer=null),this.textureUpdatePending=!1,this.textureCreationInProgress=!1,this.lastColorHarmonizedData=null,this.gl&&(this.gradientTexture&&(this.gl.deleteTexture(this.gradientTexture),this.gradientTexture=null),this.vertexBuffer&&(this.gl.deleteBuffer(this.vertexBuffer),this.vertexBuffer=null),this.vao&&(this.gl.deleteVertexArray(this.vao),this.vao=null),this.shaderProgram&&(this.gl.deleteProgram(this.shaderProgram),this.shaderProgram=null),Q.clearCache(this.gl)),this.wrapper&&this.wrapper.parentNode&&(this.wrapper.parentNode.removeChild(this.wrapper),this.wrapper=null),this.canvas=null,this.eventSubscriptionIds.forEach(i=>{p.unsubscribe(i)}),this.eventSubscriptionIds=[],u?.debug?.log("WebGLGradientBackgroundSystem","Unified event subscriptions cleaned up"),window.removeEventListener("resize",this.resize),this.gl=null;let e={"--sn.bg.webgl.ready":"0","--sn.bg.webgl.enabled":"0","--sn.bg.active-backend":"css","--sn-gradient-crossfade-opacity":"0"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",e,"critical","webgl-system-cleanup")}forceRepaint(e="settings-change"){this.isActive&&this.gradientTexture&&this.updateGradientTexture().catch(i=>{u?.debug?.error("WebGLGradientBackgroundSystem","Failed to repaint gradient:",i)})}setWaveY(e){this.settings.waveY=e}setWaveHeight(e){this.settings.waveHeight=e}setWaveOffset(e){this.settings.waveOffset=e}setBlurSettings(e,i){this.settings.blurExp=e,this.settings.blurMax=i}getMetrics(){return{fps:this.performanceMonitor?.getMedianFPS?.()||0,compileErrors:0,isActive:this.isActive,settings:{...this.settings}}}stopAnimation(){}updateAnimation(e){if(!this.isActive||!this.gl||!this.isWebGLAvailable)return;let i=performance.now();this.shouldSkipFrame(i)||(this.shouldUpdateTexture()&&this.currentQualityLevel!=="low"&&this.updateGradientTextureThrottled(),this.webglReady?this.render(i):this.ensureBasicResources())}shouldSkipFrame(e){if(!this.frameThrottleInterval)return!1;let r=e-(this.lastFrameTime||0)<this.frameThrottleInterval;return r||(this.lastFrameTime=e),r}shouldUpdateTexture(){return performance.now()-this.lastTextureUpdate>=this.textureUpdateThrottleMs}ensureBasicResources(){if(!(!this.gl||this.contextLost)&&!this.gradientTexture)try{let e=this.getDefaultGradientStops();this.gradientTexture=me(this.gl,e),this.gradientTexture&&u?.debug?.log("WebGLGradientBackgroundSystem","Emergency gradient texture created during animation update")}catch(e){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to create emergency gradient texture:",e)}}async healthCheck(){let e=this.webglReady&&this.initialized&&this.isActive;return{system:"WebGLGradientBackgroundSystem",healthy:e,metrics:{webglReady:this.webglReady,initialized:this.initialized,active:this.isActive,contextLost:this.contextLost,canvasExists:!!this.canvas},issues:e?[]:[...this.webglReady?[]:["WebGL not ready"],...this.initialized?[]:["System not initialized"],...this.isActive?[]:["System not active"],...this.contextLost?["WebGL context lost"]:[]]}}resizeTo(e,i){this.canvas&&(this.canvas.width=e,this.canvas.height=i,this.resize?.())}registerWithVisualEffectsChoreographer(){if(!this.visualEffectsChoreographer){u?.debug?.log("WebGLGradientBackgroundSystem","VisualEffects choreographer not available, skipping registration");return}try{this.visualEffectsChoreographer.registerVisualEffectsParticipant(this),u?.debug?.log("WebGLGradientBackgroundSystem","Successfully registered with visualEffects choreographer")}catch(e){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to register with visualEffects choreographer:",e)}}getVisualEffectsContribution(){return{webglLuminosity:this.settings.flowStrength||.5,shaderComplexity:this.isWebGLAvailable?.8:0,gpuUtilization:this.isWebGLAvailable?.6:0,renderingPipeline:"forward",textureResolution:1}}onVisualEffectsFieldUpdate(e){if(!(!this.isWebGLAvailable||!this.webglReady))try{this.currentVisualEffectsField=e,this.updateShaderFromVisualEffects(e),u?.debug?.log("WebGLGradientBackgroundSystem","Updated from visualEffects field:",{rhythmicPulse:e.pulseRate,webglLuminosity:e.luminosity,emotionalTemperature:e.colorTemperature})}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Error updating from visualEffects field:",i)}}onChoreographyEvent(e,i){if(!(!this.isWebGLAvailable||!this.webglReady))try{switch(e){case"choreography:rhythm-shift":this.frameThrottleInterval=1e3/Math.max(30,Math.min(60,i.newRhythm?.bpm/2||45));break;case"choreography:energy-surge":let r=i.intensity||1;this.cssController.setVariable("WebGLGradientBackgroundSystem","--sn-webgl-energy-surge",r.toString(),"high","choreography-energy-surge");break;case"visualEffects:pulsing-cycle":let a=i.phase||0;this.cssController.setVariable("WebGLGradientBackgroundSystem","--sn-webgl-pulsing-sync",a.toString(),"normal","visualEffects-pulsing-cycle");break}u?.debug?.log("WebGLGradientBackgroundSystem",`Handled choreography event: ${e}`,i)}catch(r){u?.debug?.error("WebGLGradientBackgroundSystem",`Error handling choreography event ${e}:`,r)}}updateShaderFromVisualEffects(e){if(!this.gl||!this.shaderProgram)return;let i=this.settings.flowStrength*(.5+e.pulseRate*.5),r=this.gl.getUniformLocation(this.shaderProgram,"u_flowStrength");r&&this.gl.uniform1f(r,i);let a=this.settings.noiseScale*(.8+e.flowDirection.x*.4),n=this.gl.getUniformLocation(this.shaderProgram,"u_noiseScale");n&&this.gl.uniform1f(n,a);let s=Math.sin(Date.now()*.001*e.pulseRate)*.1,l=this.gl.getUniformLocation(this.shaderProgram,"u_waveY");if(l){let m=[this.settings.waveY[0]+s,this.settings.waveY[1]-s];this.gl.uniform1fv(l,m)}let c={"--sn-webgl-visualEffects-flow":i.toString(),"--sn-webgl-visualEffects-noise":a.toString(),"--sn-webgl-pulsing-phase":s.toString()};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",c,"normal","visualEffects-shader-update")}adjustQuality(e){this.setQualityLevel(e)}setQualityLevel(e){switch(this.currentQualityLevel=e,e){case"low":this.settings.flowStrength=.5,this.settings.noiseScale=1,this.settings.waveHeight=[.3,.2],this.settings.blurExp=1,this.settings.blurMax=.4,this.frameThrottleInterval=1e3/30;break;case"medium":this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.blurExp=1.2,this.settings.blurMax=.6,this.frameThrottleInterval=1e3/45;break;case"high":this.settings.flowStrength=.9,this.settings.noiseScale=1.4,this.settings.waveHeight=[.5,.4],this.settings.blurExp=1.3,this.settings.blurMax=.7,this.frameThrottleInterval=1e3/60;break;default:this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.blurExp=1.2,this.settings.blurMax=.6,this.frameThrottleInterval=1e3/45;break}this.updateQualityCapabilities(e),u?.debug?.log("WebGLGradientBackgroundSystem",`Quality level set to: ${e}`,{flowStrength:this.settings.flowStrength,frameRate:1e3/this.frameThrottleInterval})}getPerformanceImpact(){let e=this.lastFrameTime>0?1e3/this.lastFrameTime:60,i=this.estimateMemoryUsage();return{fps:e,frameTime:this.lastFrameTime,memoryUsage:i,cpuUsage:this.estimateCPUUsage()}}reduceQuality(e){this.qualityAdjustments["flow-reduction"]=(this.qualityAdjustments["flow-reduction"]||0)+e,this.qualityAdjustments["noise-reduction"]=(this.qualityAdjustments["noise-reduction"]||0)+e*.8,this.qualityAdjustments["wave-reduction"]=(this.qualityAdjustments["wave-reduction"]||0)+e*.6,this.settings.flowStrength=Math.max(.1,this.settings.flowStrength*(1-e)),this.settings.noiseScale=Math.max(.5,this.settings.noiseScale*(1-e*.8)),this.settings.waveHeight=[Math.max(.1,this.settings.waveHeight[0]*(1-e*.6)),Math.max(.1,this.settings.waveHeight[1]*(1-e*.6))],e>.5&&(this.frameThrottleInterval=Math.min(1e3/15,this.frameThrottleInterval*(1+e))),u?.debug?.log("WebGLGradientBackgroundSystem",`Quality reduced by ${e}`,this.settings)}increaseQuality(e){if(Object.keys(this.qualityAdjustments).forEach(i=>{this.qualityAdjustments[i]=Math.max(0,(this.qualityAdjustments[i]||0)-e)}),this.currentQualityLevel){let i=this.getBaseSettingsForLevel(this.currentQualityLevel)||this.settings;this.settings.flowStrength=Math.min(i.flowStrength,this.settings.flowStrength*(1+e*.5)),this.settings.noiseScale=Math.min(i.noiseScale,this.settings.noiseScale*(1+e*.3));let r=this.currentQualityLevel==="high"?60:this.currentQualityLevel==="medium"?45:30;this.frameThrottleInterval=Math.max(1e3/r,this.frameThrottleInterval*(1-e*.3))}u?.debug?.log("WebGLGradientBackgroundSystem",`Quality increased by ${e}`,this.settings)}getQualityCapabilities(){return[...this.qualityCapabilities]}updateQualityCapabilities(e){this.qualityCapabilities.forEach(i=>{switch(i.name){case"webgl-rendering":i.enabled=!0;break;case"shader-complexity":i.enabled=e==="high"||e==="medium";break;case"blur-effects":i.enabled=e!=="low";break;case"corridor-effects":i.enabled=e!=="low",e==="low"&&this.settings.corridorEnabled&&(this.settings.corridorEnabled=!1);break;case"corridor-sdf-complexity":let r=e==="high"?1:e==="medium"?.8:.6;this.settings.corridorBubbleScale=Math.max(.5,1*r),i.enabled=e!=="low";break;case"corridor-bubble-layers":let a=e==="high"?1:e==="medium"?.8:.6;this.settings.corridorIntensity=Math.max(.3,.8*a),i.enabled=e==="high"||e==="medium";break;case"corridor-depth-effects":let n=e==="high"?1:e==="medium"?.7:.4;this.settings.corridorDepthEffect=Math.max(.1,.6*n),i.enabled=e!=="low";break;default:i.enabled=e!=="low"}})}getBaseSettingsForLevel(e){let i={...this.settings};switch(e){case"minimal":return{...i,flowStrength:.3,noiseScale:.8,corridorEnabled:!1,corridorIntensity:.3,corridorFlowStrength:.5,corridorDepthEffect:.2,corridorBubbleScale:.5};case"low":return{...i,flowStrength:.5,noiseScale:1,corridorEnabled:!1,corridorIntensity:.4,corridorFlowStrength:.8,corridorDepthEffect:.3,corridorBubbleScale:.6};case"medium":return{...i,flowStrength:.7,noiseScale:1.2,corridorEnabled:!0,corridorIntensity:.6,corridorFlowStrength:1,corridorDepthEffect:.5,corridorBubbleScale:.8};case"high":return{...i,flowStrength:.9,noiseScale:1.4,corridorEnabled:!0,corridorIntensity:.8,corridorFlowStrength:1.2,corridorDepthEffect:.6,corridorBubbleScale:1};case"ultra":return{...i,flowStrength:1,noiseScale:1.6,corridorEnabled:!0,corridorIntensity:1,corridorFlowStrength:1.4,corridorDepthEffect:.8,corridorBubbleScale:1.2};default:return i}}setCorridorEffectsEnabled(e){this.settings.corridorEnabled=e&&this.corridorShaderProgram!==null,this.cssController.setVariable("WebGLGradientBackgroundSystem","--sn-corridor-enabled",e?"1":"0","normal","corridor-settings-update"),u?.debug?.log("WebGLGradientBackgroundSystem",`Corridor effects ${e?"enabled":"disabled"}`)}updateCorridorSettings(e){e.corridorIntensity!==void 0&&(this.settings.corridorIntensity=Math.max(0,Math.min(1,e.corridorIntensity))),e.corridorFlowStrength!==void 0&&(this.settings.corridorFlowStrength=Math.max(0,Math.min(2,e.corridorFlowStrength))),e.corridorDepthEffect!==void 0&&(this.settings.corridorDepthEffect=Math.max(0,Math.min(1,e.corridorDepthEffect))),e.corridorBubbleScale!==void 0&&(this.settings.corridorBubbleScale=Math.max(.1,Math.min(2,e.corridorBubbleScale))),u?.debug?.log("WebGLGradientBackgroundSystem","Corridor settings updated",e)}estimateMemoryUsage(){let e=5;if(this.canvas&&this.gl){let i=this.canvas.width*this.canvas.height;e+=i*4/(1024*1024),this.gradientTexture&&(e+=1),this.vertexBuffer&&(e+=.1)}return e}estimateCPUUsage(){let e=this.isWebGLAvailable?5:15,i=this.settings.flowStrength+this.settings.noiseScale/2;return Math.min(50,e*i)}getSimplifiedFragmentShader(){return`#version 300 es
      precision highp float;

      in vec2 vTextureCoords;
      out vec4 fragColor;

      uniform sampler2D u_gradientTexture;
      uniform float u_time;
      uniform float u_intensity;
      uniform float u_flowStrength;
      uniform vec2 u_resolution;

      // Simplified noise function - uses basic sin/cos instead of complex noise
      float simpleNoise(vec2 st) {
        return sin(st.x * 12.9898 + st.y * 78.233) * 43758.5453;
      }

      void main() {
        vec2 uv = vTextureCoords;
        
        // Simple flow effect without complex noise
        vec2 flow = vec2(
          sin(u_time * 0.5 + uv.y * 3.0) * 0.1,
          cos(u_time * 0.3 + uv.x * 2.0) * 0.1
        ) * u_flowStrength;
        
        // Apply flow offset
        vec2 flowUV = uv + flow;
        
        // Simple gradient lookup with basic distortion
        vec4 gradientColor = texture(u_gradientTexture, flowUV);
        
        // Simple intensity modulation
        float intensity = u_intensity * (0.8 + 0.2 * sin(u_time + uv.x + uv.y));
        
        fragColor = vec4(gradientColor.rgb * intensity, gradientColor.a);
      }`}getBasicFragmentShader(){return`#version 300 es
      precision mediump float;

      in vec2 vTextureCoords;
      out vec4 fragColor;

      uniform sampler2D u_gradientTexture;
      uniform float u_intensity;

      void main() {
        vec2 uv = vTextureCoords;
        
        // Basic gradient lookup without any effects
        vec4 gradientColor = texture(u_gradientTexture, uv);
        
        // Simple intensity scaling
        fragColor = vec4(gradientColor.rgb * u_intensity, gradientColor.a);
      }`}getEmergencyFragmentShader(){return`#version 300 es
      precision lowp float;

      in vec2 vTextureCoords;
      out vec4 fragColor;

      uniform sampler2D u_gradientTexture;

      void main() {
        // Ultra-simple gradient lookup with minimal processing
        // Use lowp precision for maximum compatibility
        vec2 uv = vTextureCoords;
        
        // Simple gradient sample - no effects, no animations
        vec4 color = texture(u_gradientTexture, uv);
        
        // Emergency mode: ensure we always output something visible
        // Fallback to magenta if texture fails (indicates shader compilation success)
        if (color.a < 0.01) {
          fragColor = vec4(0.2, 0.1, 0.3, 1.0); // Dark purple fallback
        } else {
          fragColor = color;
        }
      }`}shouldPersistWebGL(){return this.settings.webglPersistenceMode==="persistent"?!0:this.settings.webglPersistenceMode==="fallback"?!1:this.settings.webglPersistenceMode==="adaptive"&&this.settings.enabled&&this.isWebGLAvailable}shouldAttemptWebGLRecovery(){return this.shouldPersistWebGL()}applyContinuousQuality(e){try{let i=e;u?.debug?.log("WebGLGradientBackgroundSystem",`Applying simplified quality level: ${i}`),this.setQualityLevel(i),this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",{"--sn-webgl-quality-level":i,"--sn-webgl-corridor-enabled":this.settings.corridorEnabled?"1":"0"},"high","continuous-quality-update"),this.initialized&&this.gl&&this.forceRepaint("quality-level-changed")}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to apply continuous quality:",i)}}getCurrentQualityImpact(){let e=this.gl!==null&&this.isWebGLAvailable,i=this.settings.corridorEnabled&&this.corridorShaderProgram!==null,r=e?.15:.05,a=e?.1:.03,n=e?.2:0,s=i?.1:0,l=i?.05:0,c=i?.15:0,m=Math.max(.5,this.settings.flowStrength/2),d=60;return i&&(d-=10),this.settings.intensity==="intense"&&(d-=5),d=Math.max(30,d),{cpu:Math.min(1,(r+s)*m),memory:Math.min(1,(a+l)*m),gpu:Math.min(1,(n+c)*m),estimatedFPS:d}}onVisualStateUpdate(e){this.onVisualEffectsFieldUpdate(e)}onVisualEffectEvent(e,i){switch(e){case"visual:rhythm-shift":i.intensity&&(this.settings.flowStrength=Math.min(5,i.intensity*3));break;case"visual:color-shift":this.forceRepaint("color-shift");break;case"visual:energy-surge":i.intensity>.7&&this.forceRepaint("energy-surge");break}}getVisualContribution(){return{luminosity:this.settings.intensity==="intense"?.8:.5,fluidIntensity:this.settings.flowStrength/5,effectDepth:this.getCurrentQualityImpact().cpu}}}});var Pl,Ei,as=v(()=>{"use strict";B();$();_();R();ft();ge();ca();Pl=`#version 300 es
precision mediump float;

uniform float u_time;
uniform sampler2D u_gradientTex;
uniform vec2 u_resolution;
uniform float u_flowStrength;
uniform float u_noiseScale;

// Enhanced liquid visual effects uniforms
uniform float u_liquidPhase;
uniform float u_animationIntensity;
uniform float u_auroraFlow;
uniform vec2 u_flowDirection;
uniform float u_liquidTurbulence;
uniform float u_visualEffectsDepth;

// Advanced liquid physics uniforms
uniform float u_surfaceTension;
uniform float u_viscosity;
uniform float u_liquidGravity;
uniform float u_particleDensity;
uniform float u_fluidDynamics;
uniform float u_surfaceElasticity;
uniform vec2 u_liquidVelocity;
uniform float u_visualEffectsTemperature;

// Music sync uniforms
uniform float u_musicEnergy;
uniform float u_musicValence;
uniform float u_beatIntensity;
uniform float u_bassResponse;
uniform float u_genreInfluence;
uniform float u_emotionalTemperature;

// Multi-layer visual effects uniforms
uniform float u_visualEffectsLevel;
uniform float u_activityLevel;
uniform float u_memoryIntensity;
uniform float u_temporalFlowStrength;

// Wave stack uniforms
uniform float u_waveY[3];
uniform float u_waveHeight[3];
uniform float u_waveOffset[3];
uniform float u_blurExp;
uniform float u_blurMax;

out vec4 fragColor;

// Improved simplex noise with liquid visualEffects modifications
vec3 mod289(vec3 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec2 mod289(vec2 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec3 permute(vec3 x) {
  return mod289(((x*34.0)+1.0)*x);
}

float snoise(vec2 v) {
  const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);
  vec2 i = floor(v + dot(v, C.yy));
  vec2 x0 = v - i + dot(i, C.xx);
  vec2 i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
  vec4 x12 = x0.xyxy + C.xxzz;
  x12.xy -= i1;
  i = mod289(i);
  vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));
  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
  m = m*m;
  m = m*m;
  vec3 x = 2.0 * fract(p * C.www) - 1.0;
  vec3 h = abs(x) - 0.5;
  vec3 ox = floor(x + 0.5);
  vec3 a0 = x - ox;
  m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);
  vec3 g;
  g.x = a0.x * x0.x + h.x * x0.y;
  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
  return 130.0 * dot(m, g);
}

// Advanced liquid physics simulation functions
float calculateSurfaceTension(vec2 uv, float baseValue) {
  // Surface tension creates natural droplet boundaries
  float distance = length(uv - 0.5);
  float tensionEffect = smoothstep(0.3, 0.7, distance) * u_surfaceTension;
  return baseValue * (1.0 + tensionEffect * 0.3);
}

vec2 calculateViscosityFlow(vec2 uv, vec2 baseFlow, float timeOffset) {
  // Viscosity affects flow resistance and creates more dynamic movement
  float viscosityResistance = 1.0 - u_viscosity * 0.8;
  vec2 viscousFlow = baseFlow * viscosityResistance;
  
  // Add viscous swirl patterns
  float swirl = sin(u_time * 0.1 + timeOffset + length(uv - 0.5) * 10.0) * u_viscosity * 0.2;
  viscousFlow += vec2(-swirl * (uv.y - 0.5), swirl * (uv.x - 0.5));
  
  return viscousFlow;
}

float simulateGravityEffect(vec2 uv, float baseIntensity) {
  // Gravity creates natural settling patterns
  float gravityInfluence = (1.0 - uv.y) * u_liquidGravity;
  float settlingPattern = sin(u_time * 0.05 + uv.x * 5.0) * gravityInfluence * 0.1;
  return baseIntensity + settlingPattern;
}

// Enhanced liquid visual effects noise with advanced physics
float liquidVisualEffectsNoise(vec2 uv, float timeOffset) {
  vec2 flowUV = uv;
  float adjustedTime = u_time + timeOffset;

  // Enhanced liquid flow with physics simulation
  vec2 musicFlowDirection = normalize(u_flowDirection + vec2(
    sin(adjustedTime * 0.1 + u_musicEnergy * 2.0) * u_musicValence,
    cos(adjustedTime * 0.15 + u_musicEnergy * 1.5) * u_musicValence
  ));
  
  // Apply viscosity to flow
  vec2 viscousFlow = calculateViscosityFlow(uv, musicFlowDirection, timeOffset);
  
  // Add liquid velocity for momentum
  viscousFlow += u_liquidVelocity * 0.5;

  // Enhanced animation effect with visualEffects depth
  float animationPhase = sin(adjustedTime * 0.05 + u_liquidPhase) * u_animationIntensity;
  float visualEffectsWave = sin(adjustedTime * 0.02 + u_visualEffectsDepth) * 0.3;
  
  // VisualEffects memory patterns
  float memoryPattern = sin(adjustedTime * 0.008 + u_memoryIntensity * 5.0) * 0.15;
  
  // Temporal flow effects
  float temporalDistortion = sin(adjustedTime * 0.12 + u_temporalFlowStrength * 3.0) * 0.1;

  // Aurora flow patterns with enhanced physics
  flowUV += viscousFlow * adjustedTime * 0.03 * u_auroraFlow;
  flowUV += vec2(
    sin(adjustedTime * 0.04 + uv.y * 6.28) * (animationPhase + memoryPattern),
    cos(adjustedTime * 0.03 + uv.x * 6.28) * (animationPhase + temporalDistortion)
  ) * 0.02;

  // Enhanced turbulence with particle density
  vec2 turbulenceUV = flowUV * u_liquidTurbulence;
  float particleInfluence = u_particleDensity * 0.3;
  float turbulence1 = snoise(turbulenceUV + adjustedTime * 0.01) * (1.0 + particleInfluence);
  float turbulence2 = snoise(turbulenceUV * 2.0 + adjustedTime * 0.02) * (1.0 + particleInfluence * 0.5);
  
  // Fluid dynamics creates more complex flow patterns
  float fluidDynamicsEffect = snoise(flowUV * 3.0 + adjustedTime * 0.005) * u_fluidDynamics;

  // Multi-octave liquid noise with visualEffects layers
  float noise1 = snoise(flowUV * u_noiseScale + turbulence1 * 0.1) * u_visualEffectsLevel;
  float noise2 = snoise(flowUV * u_noiseScale * 2.0 + turbulence2 * 0.05) * u_activityLevel;
  float noise3 = snoise(flowUV * u_noiseScale * 0.5 + visualEffectsWave) * (1.0 - u_visualEffectsLevel * 0.3);
  float memoryNoise = snoise(flowUV * u_noiseScale * 1.5 + memoryPattern) * u_memoryIntensity * 0.3;

  // Apply surface tension effects
  float surfaceTensionEffect = calculateSurfaceTension(uv, 1.0);
  
  // Apply gravity settling
  float gravityEffect = simulateGravityEffect(uv, 1.0);

  // Blend with enhanced music and visualEffects responsiveness
  float baseNoise = (noise1 * 0.4 + noise2 * 0.3 + noise3 * 0.2 + memoryNoise * 0.1) * surfaceTensionEffect * gravityEffect;
  baseNoise += fluidDynamicsEffect * 0.1;
  
  // Enhanced musical modulation with genre influence
  float musicModulation = u_beatIntensity * 0.2 + u_bassResponse * 0.1 + u_genreInfluence * 0.05;
  
  // Emotional temperature affects liquid characteristics
  float temperatureEffect = mix(0.8, 1.2, u_emotionalTemperature);

  return clamp((baseNoise + musicModulation) * temperatureEffect * 0.5 + 0.5, 0.0, 1.0);
}

// Advanced liquid wave physics with surface elasticity
float liquidWaveAlpha(vec2 uv, int waveIndex) {
  float y = uv.y;
  float waveCenter = u_waveY[waveIndex];
  float waveHeight = u_waveHeight[waveIndex];

  // Enhanced animation modulation with visualEffects memory
  float animationMod = sin(u_time * 0.1 + float(waveIndex) * 2.0) * u_animationIntensity * 0.2;
  float visualEffectsBreathing = sin(u_time * 0.06 + u_visualEffectsLevel * 3.0) * 0.15;
  float memoryBreathing = sin(u_time * 0.04 + u_memoryIntensity * 2.0) * 0.1;
  
  float totalBreathing = animationMod + visualEffectsBreathing + memoryBreathing;
  float adjustedWaveHeight = waveHeight * (1.0 + totalBreathing);

  // Enhanced liquid distortion with surface elasticity
  float surfaceElastic = snoise(vec2(uv.x * 6.0 + u_time * 0.3, uv.y * 4.0)) * u_surfaceElasticity * 0.08;
  float liquidDistortion = snoise(vec2(uv.x * 8.0, u_time * 0.5)) * 0.05 * u_liquidTurbulence;
  float fluidDeformation = sin(uv.x * 10.0 + u_time * 0.7) * u_fluidDynamics * 0.03;
  
  float totalDistortion = liquidDistortion + surfaceElastic + fluidDeformation;
  float adjustedWaveCenter = waveCenter + totalDistortion;

  // Surface tension creates natural wave boundaries
  float distance = abs(y - adjustedWaveCenter);
  float tensionSmoothness = mix(0.3, 0.7, u_surfaceTension);
  float alpha = 1.0 - smoothstep(0.0, adjustedWaveHeight * tensionSmoothness, distance);

  // Enhanced shimmer with visualEffects and emotional temperature
  float baseShimmer = sin(u_time * 2.0 + uv.x * 20.0) * 0.1 + 0.9;
  float visualEffectsShimmer = sin(u_time * 1.5 + uv.y * 15.0 + u_visualEffectsLevel * 5.0) * 0.05 + 0.975;
  float temperatureShimmer = mix(0.95, 1.05, u_emotionalTemperature);
  
  alpha *= baseShimmer * visualEffectsShimmer * temperatureShimmer;

  // Viscosity affects wave edge softness
  alpha = mix(alpha, smoothstep(0.2, 0.8, alpha), u_viscosity);

  return clamp(alpha, 0.0, 1.0);
}

// Dynamic blur with visualEffects depth
float liquidBlur(vec2 uv) {
  vec2 center = vec2(0.5, 0.5);
  float distance = length(uv - center);

  // VisualEffects depth affects blur
  float depthModulation = sin(u_time * 0.08 + u_visualEffectsDepth) * 0.2 + 0.8;
  float adjustedBlurExp = u_blurExp * depthModulation;

  float blur = pow(distance, adjustedBlurExp);
  blur = clamp(blur, 0.0, u_blurMax);

  return blur;
}

void main() {
  vec2 uv = gl_FragCoord.xy / u_resolution.xy;

  // Generate enhanced liquid visualEffects noise fields with physics
  float liquidNoise1 = liquidVisualEffectsNoise(uv, u_waveOffset[0]);
  float liquidNoise2 = liquidVisualEffectsNoise(uv, u_waveOffset[1]);
  float liquidNoise3 = liquidVisualEffectsNoise(uv, u_waveOffset[2]);

  // Calculate advanced liquid wave alphas with physics simulation
  float alpha1 = liquidWaveAlpha(uv, 0);
  float alpha2 = liquidWaveAlpha(uv, 1);
  float alpha3 = liquidWaveAlpha(uv, 2);

  // Enhanced normalization with particle density influence
  float totalAlpha = alpha1 + alpha2 + alpha3;
  float particleWeight = 1.0 + u_particleDensity * 0.3;
  if (totalAlpha > 0.0) {
    alpha1 = (alpha1 / totalAlpha) * particleWeight;
    alpha2 = (alpha2 / totalAlpha) * particleWeight;
    alpha3 = (alpha3 / totalAlpha) * particleWeight;
  }

  // Blend liquid visualEffects noise fields with physics
  float t = liquidNoise1 * alpha1 + liquidNoise2 * alpha2 + liquidNoise3 * alpha3;
  
  // Apply visualEffects temperature modulation
  t = mix(t * 0.8, t * 1.2, u_visualEffectsTemperature);
  t = clamp(t, 0.0, 1.0);

  // Sample gradient texture with enhanced visualEffects modulation
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));

  // Apply dynamic blur with visualEffects awareness
  float blurAmount = liquidBlur(uv);
  float visualEffectsBlur = mix(blurAmount, blurAmount * 0.5, u_visualEffectsLevel);

  // Enhanced vignette with visualEffects memory patterns
  vec2 center = uv - 0.5;
  float animationVignette = sin(u_time * 0.06 + u_liquidPhase) * 0.1 + 0.9;
  float visualEffectsVignette = sin(u_time * 0.04 + u_visualEffectsLevel * 3.0) * 0.05 + 0.975;
  float memoryVignette = sin(u_time * 0.03 + u_memoryIntensity * 2.0) * 0.03 + 0.985;
  
  float combinedVignette = animationVignette * visualEffectsVignette * memoryVignette;
  float vignette = combinedVignette - dot(center, center) * (0.3 + visualEffectsBlur * 0.2);
  color.rgb *= vignette;

  // Enhanced shimmer overlay with visualEffects patterns
  float shimmerPhase = u_time * 3.0 + uv.x * 15.0 + uv.y * 10.0;
  float baseShimmer = sin(shimmerPhase) * 0.03 + 0.97;
  float awarenessShimmer = sin(u_time * 2.5 + uv.x * 12.0 + u_activityLevel * 8.0) * 0.02 + 0.98;
  float temporalShimmer = sin(u_time * 1.8 + u_temporalFlowStrength * 6.0) * 0.015 + 0.985;
  
  color.rgb *= baseShimmer * awarenessShimmer * temporalShimmer;

  // Enhanced music-responsive alpha with visualEffects integration
  float musicAlpha = 0.8 + u_beatIntensity * 0.2 + u_bassResponse * 0.1 + u_genreInfluence * 0.05;
  float visualEffectsAlpha = 0.9 + u_visualEffectsLevel * 0.1 - u_activityLevel * 0.05;
  
  color.a *= musicAlpha * visualEffectsAlpha * (1.0 - visualEffectsBlur * 0.3);

  // Apply emotional temperature to final color
  color.rgb = mix(
    color.rgb * vec3(0.9, 0.95, 1.1),  // Cool temperature
    color.rgb * vec3(1.1, 1.05, 0.9),  // Warm temperature
    u_emotionalTemperature
  );

  fragColor = color;
}`,Ei=class extends q{constructor(e=w,i,r,a=null,n=null){super(e,i,r,a);this.shaderProgram=null;this.gl=null;this.eventSubscriptionIds=[];this.animationPhase=0;this.lastMusicUpdate=0;this.visualEffectsChoreographer=null;this.currentVisualEffectsField=null;this.systemName="FluidGradientBackgroundSystem";this.webglGradientSystem=new bt(e,i,r,a,n),this.visualEffectsChoreographer=n?.backgroundVisualEffectsChoreographer||null,this.liquidSettings={enabled:!0,liquidPhase:0,animationIntensity:.8,auroraFlow:.6,flowDirection:[1,.5],liquidTurbulence:1.2,visualEffectsDepth:.7,surfaceTension:.6,viscosity:.4,liquidGravity:.3,particleDensity:.5,smoothDynamics:.7,surfaceElasticity:.5,liquidVelocity:[0,0],visualEffectsTemperature:.5,visualEffectsLevel:.7,awarenessLevel:.6,memoryIntensity:.4,temporalFlowStrength:.5,genreInfluence:.3,emotionalTemperature:.5,flowIntensity:.7,turbulenceScale:.9,colorMixingStrength:.8,animationSpeed:1},this.liquidUniforms={u_time:null,u_gradientTex:null,u_resolution:null,u_flowStrength:null,u_noiseScale:null,u_liquidPhase:null,u_animationIntensity:null,u_auroraFlow:null,u_flowDirection:null,u_liquidTurbulence:null,u_visualEffectsDepth:null,u_surfaceTension:null,u_viscosity:null,u_liquidGravity:null,u_particleDensity:null,u_smoothDynamics:null,u_surfaceElasticity:null,u_liquidVelocity:null,u_visualEffectsTemperature:null,u_musicEnergy:null,u_musicValence:null,u_beatIntensity:null,u_bassResponse:null,u_genreInfluence:null,u_emotionalTemperature:null,u_visualEffectsLevel:null,u_activityLevel:null,u_memoryIntensity:null,u_temporalFlowStrength:null,u_waveY:null,u_waveHeight:null,u_waveOffset:null,u_blurExp:null,u_blurMax:null}}async _performSystemSpecificInitialization(){if(await super._performSystemSpecificInitialization(),await this.webglGradientSystem.initialize(),this.gl=this.webglGradientSystem.gl,!this.gl){u?.debug?.log("FluidGradientBackgroundSystem","WebGL not available, using base system");return}try{await this.compileLiquidShader(),this.setupLiquidUniforms(),this.subscribeToUnifiedEvents(),this.registerWithVisualEffectsChoreographer(),u?.debug?.log("FluidGradientBackgroundSystem","Liquid visualEffects system initialized")}catch(e){u?.debug?.error("FluidGradientBackgroundSystem","Failed to initialize liquid visualEffects:",e)}}async compileLiquidShader(){if(!this.gl)throw new Error("WebGL context not available");let e=Q.loadVertex(this.gl,`#version 300 es
      in vec2 a_position;
      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
      }
    `),i=Q.loadFragment(this.gl,Pl);if(!e||!i)throw new Error("Failed to compile liquid visualEffects shaders");if(this.shaderProgram=Q.createProgram(this.gl,e,i),!this.shaderProgram)throw new Error("Failed to create liquid visualEffects shader program")}setupLiquidUniforms(){if(!this.gl||!this.shaderProgram)return;["u_time","u_gradientTex","u_resolution","u_flowStrength","u_noiseScale","u_liquidPhase","u_animationIntensity","u_auroraFlow","u_flowDirection","u_liquidTurbulence","u_visualEffectsDepth","u_musicEnergy","u_musicValence","u_beatIntensity","u_bassResponse","u_waveY","u_waveHeight","u_waveOffset","u_blurExp","u_blurMax","u_surfaceTension","u_viscosity","u_liquidGravity","u_particleDensity","u_surfaceElasticity","u_smoothDynamics","u_visualEffectsLevel","u_visualEffectsTemperature","u_memoryIntensity","u_emotionalTemperature","u_genreInfluence"].forEach(i=>{this.liquidUniforms[i]=this.gl.getUniformLocation(this.shaderProgram,i)})}subscribeToUnifiedEvents(){let e=p.subscribe("music:beat",this.handleMusicBeat.bind(this),"FluidGradientBackgroundSystem");this.eventSubscriptionIds.push(e);let i=p.subscribe("music:energy",this.handleMusicEnergy.bind(this),"FluidGradientBackgroundSystem");this.eventSubscriptionIds.push(i);let r=p.subscribe("music:state-changed",this.handleMusicStateChange.bind(this),"FluidGradientBackgroundSystem");this.eventSubscriptionIds.push(r);let a=p.subscribe("colors:harmonized",this.handleColorHarmonized.bind(this),"FluidGradientBackgroundSystem");this.eventSubscriptionIds.push(a),u?.debug?.log("FluidGradientBackgroundSystem","Subscribed to unified events",{subscriptionCount:this.eventSubscriptionIds.length})}handleMusicBeat(e){let i=performance.now();i-this.lastMusicUpdate<33||(this.lastMusicUpdate=i,this.animationPhase+=.1,this.updateFlowDirection(e.intensity),u?.debug?.log("FluidGradientBackgroundSystem","Music beat processed",{bpm:e.bpm,intensity:e.intensity,confidence:e.confidence}))}handleMusicEnergy(e){this.liquidSettings.animationIntensity=.5+e.energy*.5,this.liquidSettings.auroraFlow=.4+e.valence*.6,u?.debug?.log("FluidGradientBackgroundSystem","Music energy processed",{energy:e.energy,valence:e.valence,tempo:e.tempo})}handleMusicStateChange(e){e.isPlaying?this.liquidSettings.visualEffectsDepth=Math.max(.7,this.liquidSettings.visualEffectsDepth):this.liquidSettings.visualEffectsDepth=Math.min(.3,this.liquidSettings.visualEffectsDepth),u?.debug?.log("FluidGradientBackgroundSystem","Music state change processed",{isPlaying:e.isPlaying,position:e.position,duration:e.duration})}handleColorHarmonized(e){let i=e.strategies.length;this.liquidSettings.liquidTurbulence=Math.max(.8,Math.min(1.5,i*.3)),u?.debug?.log("FluidGradientBackgroundSystem","Color harmonization processed",{strategies:e.strategies,processingTime:e.processingTime,turbulenceAdjustment:this.liquidSettings.liquidTurbulence})}updateFlowDirection(e){let i=this.animationPhase;this.liquidSettings.flowDirection=[Math.sin(i*.3)*e,Math.cos(i*.2)*e]}updateAnimation(e){this.webglGradientSystem?.updateAnimation?.(e),this.liquidSettings.liquidPhase+=e*.001,this.liquidSettings.visualEffectsDepth=.5+Math.sin(this.liquidSettings.liquidPhase*.5)*.3,this.gl&&this.shaderProgram&&this.updateLiquidUniforms()}updateLiquidUniforms(){!this.gl||!this.shaderProgram||(this.gl.useProgram(this.shaderProgram),this.liquidUniforms.u_liquidPhase&&this.gl.uniform1f(this.liquidUniforms.u_liquidPhase,this.liquidSettings.liquidPhase),this.liquidUniforms.u_animationIntensity&&this.gl.uniform1f(this.liquidUniforms.u_animationIntensity,this.liquidSettings.animationIntensity),this.liquidUniforms.u_auroraFlow&&this.gl.uniform1f(this.liquidUniforms.u_auroraFlow,this.liquidSettings.auroraFlow),this.liquidUniforms.u_flowDirection&&this.gl.uniform2fv(this.liquidUniforms.u_flowDirection,this.liquidSettings.flowDirection),this.liquidUniforms.u_liquidTurbulence&&this.gl.uniform1f(this.liquidUniforms.u_liquidTurbulence,this.liquidSettings.liquidTurbulence),this.liquidUniforms.u_visualEffectsDepth&&this.gl.uniform1f(this.liquidUniforms.u_visualEffectsDepth,this.liquidSettings.visualEffectsDepth),this.liquidUniforms.u_surfaceTension&&this.gl.uniform1f(this.liquidUniforms.u_surfaceTension,this.liquidSettings.surfaceTension),this.liquidUniforms.u_viscosity&&this.gl.uniform1f(this.liquidUniforms.u_viscosity,this.liquidSettings.viscosity),this.liquidUniforms.u_liquidGravity&&this.gl.uniform1f(this.liquidUniforms.u_liquidGravity,this.liquidSettings.liquidGravity),this.liquidUniforms.u_particleDensity&&this.gl.uniform1f(this.liquidUniforms.u_particleDensity,this.liquidSettings.particleDensity),this.liquidUniforms.u_surfaceElasticity&&this.gl.uniform1f(this.liquidUniforms.u_surfaceElasticity,this.liquidSettings.surfaceElasticity),this.liquidUniforms.u_smoothDynamics&&this.gl.uniform1f(this.liquidUniforms.u_smoothDynamics,this.liquidSettings.smoothDynamics),this.liquidUniforms.u_visualEffectsLevel&&this.gl.uniform1f(this.liquidUniforms.u_visualEffectsLevel,this.liquidSettings.visualEffectsLevel),this.liquidUniforms.u_visualEffectsTemperature&&this.gl.uniform1f(this.liquidUniforms.u_visualEffectsTemperature,this.liquidSettings.visualEffectsTemperature),this.liquidUniforms.u_memoryIntensity&&this.gl.uniform1f(this.liquidUniforms.u_memoryIntensity,this.liquidSettings.memoryIntensity),this.liquidUniforms.u_emotionalTemperature&&this.gl.uniform1f(this.liquidUniforms.u_emotionalTemperature,this.liquidSettings.emotionalTemperature),this.liquidUniforms.u_genreInfluence&&this.gl.uniform1f(this.liquidUniforms.u_genreInfluence,this.liquidSettings.genreInfluence),this.updateMusicUniforms())}updateMusicUniforms(){if(!this.gl||!this.musicSyncService)return;let e=this.musicSyncService.getLatestProcessedData?.()||{},i=e.energy||0,r=e.valence||0,a=e.beatIntensity||0,n=e.bassResponse||0;this.liquidUniforms.u_musicEnergy&&this.gl.uniform1f(this.liquidUniforms.u_musicEnergy,i),this.liquidUniforms.u_musicValence&&this.gl.uniform1f(this.liquidUniforms.u_musicValence,r),this.liquidUniforms.u_beatIntensity&&this.gl.uniform1f(this.liquidUniforms.u_beatIntensity,a),this.liquidUniforms.u_bassResponse&&this.gl.uniform1f(this.liquidUniforms.u_bassResponse,n)}async healthCheck(){let e=this.liquidSettings.enabled&&this.shaderProgram!==null;return{system:"FluidGradientBackgroundSystem",healthy:e,metrics:{enabled:this.liquidSettings.enabled,hasShaderProgram:!!this.shaderProgram,initialized:this.initialized,flowIntensity:this.liquidSettings.flowIntensity},issues:e?[]:[...this.liquidSettings.enabled?[]:["System disabled"],...this.shaderProgram?[]:["Shader program not initialized"]]}}forceRepaint(e="liquid-visualEffects-update"){this.webglGradientSystem.forceRepaint(e)}adjustQuality(e){this.setQualityLevel(e)}setQualityLevel(e){switch(e){case"low":this.liquidSettings.flowIntensity=.5,this.liquidSettings.turbulenceScale=.7,this.liquidSettings.colorMixingStrength=.6,this.liquidSettings.animationSpeed=.8;break;case"medium":this.liquidSettings.flowIntensity=.7,this.liquidSettings.turbulenceScale=.9,this.liquidSettings.colorMixingStrength=.8,this.liquidSettings.animationSpeed=1;break;case"high":this.liquidSettings.flowIntensity=.9,this.liquidSettings.turbulenceScale=1.1,this.liquidSettings.colorMixingStrength=1,this.liquidSettings.animationSpeed=1.2;break;default:this.liquidSettings.flowIntensity=.7,this.liquidSettings.turbulenceScale=.9,this.liquidSettings.colorMixingStrength=.8,this.liquidSettings.animationSpeed=1;break}this.webglGradientSystem.setQualityLevel(e),w.enableDebug&&u?.debug?.log("FluidGradientBackgroundSystem",`Quality level set to: ${e}`,this.liquidSettings)}getPerformanceImpact(){let e=this.webglGradientSystem.getPerformanceImpact();return{fps:e.fps,frameTime:e.frameTime+1.2,memoryUsage:e.memoryUsage+5,cpuUsage:e.cpuUsage+3}}reduceQuality(e){this.liquidSettings.flowIntensity=Math.max(.1,this.liquidSettings.flowIntensity-e*.3),this.liquidSettings.turbulenceScale=Math.max(.2,this.liquidSettings.turbulenceScale-e*.4),this.liquidSettings.colorMixingStrength=Math.max(.2,this.liquidSettings.colorMixingStrength-e*.3),this.liquidSettings.animationSpeed=Math.max(.3,this.liquidSettings.animationSpeed-e*.5),this.webglGradientSystem.reduceQuality(e)}increaseQuality(e){this.liquidSettings.flowIntensity=Math.min(1,this.liquidSettings.flowIntensity+e*.2),this.liquidSettings.turbulenceScale=Math.min(1.5,this.liquidSettings.turbulenceScale+e*.3),this.liquidSettings.colorMixingStrength=Math.min(1.2,this.liquidSettings.colorMixingStrength+e*.2),this.liquidSettings.animationSpeed=Math.min(1.6,this.liquidSettings.animationSpeed+e*.3),this.webglGradientSystem.increaseQuality(e)}getQualityCapabilities(){return[{name:"liquid-flow-intensity",enabled:this.liquidSettings.flowIntensity>.5,qualityLevel:"medium"},{name:"turbulence-complexity",enabled:this.liquidSettings.turbulenceScale>.8,qualityLevel:"high"},{name:"color-mixing-quality",enabled:this.liquidSettings.colorMixingStrength>.7,qualityLevel:"low"},{name:"animation-smoothness",enabled:this.liquidSettings.animationSpeed>1,qualityLevel:"medium"}]}_performSystemSpecificCleanup(){if(super._performSystemSpecificCleanup(),this.visualEffectsChoreographer)try{this.visualEffectsChoreographer.unregisterVisualEffectsParticipant("FluidGradientBackgroundSystem"),u?.debug?.log("FluidGradientBackgroundSystem","Unregistered from visualEffects choreographer")}catch(e){u?.debug?.error("FluidGradientBackgroundSystem","Error unregistering from visualEffects choreographer:",e)}this.eventSubscriptionIds.forEach(e=>{p.unsubscribe(e)}),this.eventSubscriptionIds=[],u?.debug?.log("FluidGradientBackgroundSystem","Unified event subscriptions cleaned up"),this.gl&&this.shaderProgram&&(this.gl.deleteProgram(this.shaderProgram),this.shaderProgram=null),this.webglGradientSystem.destroy()}setLiquidPhase(e){this.liquidSettings.liquidPhase=e}setAnimationIntensity(e){this.liquidSettings.animationIntensity=Math.max(0,Math.min(1,e))}setAuroraFlow(e){this.liquidSettings.auroraFlow=Math.max(0,Math.min(1,e))}setFlowDirection(e,i){this.liquidSettings.flowDirection=[e,i]}setLiquidTurbulence(e){this.liquidSettings.liquidTurbulence=Math.max(0,Math.min(2,e))}setVisualEffectsDepth(e){this.liquidSettings.visualEffectsDepth=Math.max(0,Math.min(1,e))}setSurfaceTension(e){this.liquidSettings.surfaceTension=Math.max(0,Math.min(1,e))}setViscosity(e){this.liquidSettings.viscosity=Math.max(0,Math.min(1,e))}setLiquidGravity(e){this.liquidSettings.liquidGravity=Math.max(0,Math.min(1,e))}setParticleDensity(e){this.liquidSettings.particleDensity=Math.max(0,Math.min(2,e))}setSurfaceElasticity(e){this.liquidSettings.surfaceElasticity=Math.max(0,Math.min(1,e))}setSmoothDynamics(e){this.liquidSettings.smoothDynamics=Math.max(0,Math.min(1,e))}setVisualEffectsLevel(e){this.liquidSettings.visualEffectsLevel=Math.max(0,Math.min(1,e))}setVisualEffectsTemperature(e){this.liquidSettings.visualEffectsTemperature=Math.max(0,Math.min(1,e))}setMemoryIntensity(e){this.liquidSettings.memoryIntensity=Math.max(0,Math.min(1,e))}setEmotionalTemperature(e){this.liquidSettings.emotionalTemperature=Math.max(0,Math.min(1,e))}setGenreInfluence(e){this.liquidSettings.genreInfluence=Math.max(0,Math.min(1,e))}getLiquidSettings(){return{...this.liquidSettings}}registerWithVisualEffectsChoreographer(){if(!this.visualEffectsChoreographer){u?.debug?.log("FluidGradientBackgroundSystem","VisualEffects choreographer not available, skipping registration");return}try{this.visualEffectsChoreographer.registerVisualEffectsParticipant(this),u?.debug?.log("FluidGradientBackgroundSystem","Successfully registered with visualEffects choreographer")}catch(e){u?.debug?.error("FluidGradientBackgroundSystem","Failed to register with visualEffects choreographer:",e)}}get systemPriority(){return"high"}getVisualEffectsContribution(){return{liquidDensity:this.liquidSettings.liquidTurbulence||.5,smoothDynamics:this.liquidSettings.auroraFlow||.6,surfaceFluidityIndex:this.liquidSettings.animationIntensity||.8,turbulenceLevel:this.liquidSettings.liquidTurbulence||.5,viscosityIndex:1,flowPatterns:["aurora","liquid","visualEffects"]}}onVisualEffectsFieldUpdate(e){if(!(!this.gl||!this.shaderProgram))try{this.currentVisualEffectsField=e,this.updateLiquidFromVisualEffects(e),u?.debug?.log("FluidGradientBackgroundSystem","Updated from visualEffects field:",{rhythmicPulse:e.pulseRate,liquidDensity:e.fluidIntensity,surfaceFluidityIndex:e.fluidIntensity})}catch(i){u?.debug?.error("FluidGradientBackgroundSystem","Error updating from visualEffects field:",i)}}onChoreographyEvent(e,i){if(!(!this.gl||!this.shaderProgram))try{switch(e){case"choreography:rhythm-shift":let r=i.newRhythm?.bpm||120;this.liquidSettings.auroraFlow=Math.max(.2,Math.min(1,r/120));break;case"choreography:energy-surge":let a=i.intensity||1;this.liquidSettings.liquidTurbulence=Math.min(1,this.liquidSettings.liquidTurbulence*(1+a*.5));break;case"visualEffects:animation-cycle":let n=i.phase||0;this.liquidSettings.animationIntensity=.5+Math.sin(n*Math.PI*2)*.3;break;case"visualEffects:surface-fluid":let s=i.fluidityIndex||.5;this.liquidSettings.visualEffectsDepth=s;break}this.currentVisualEffectsField&&this.updateLiquidFromVisualEffects(this.currentVisualEffectsField),u?.debug?.log("FluidGradientBackgroundSystem",`Handled choreography event: ${e}`,i)}catch(r){u?.debug?.error("FluidGradientBackgroundSystem",`Error handling choreography event ${e}:`,r)}}updateLiquidFromVisualEffects(e){if(!this.gl||!this.shaderProgram)return;let i=this.liquidSettings.liquidPhase+e.pulseRate*.5,r=this.gl.getUniformLocation(this.shaderProgram,"u_liquidPhase");r&&this.gl.uniform1f(r,i);let a=this.liquidSettings.animationIntensity*(.7+e.pulseRate*.3),n=this.gl.getUniformLocation(this.shaderProgram,"u_animationIntensity");n&&this.gl.uniform1f(n,a);let s=this.gl.getUniformLocation(this.shaderProgram,"u_auroraFlow");s&&this.gl.uniform1f(s,this.liquidSettings.auroraFlow*(.8+e.flowDirection.x*.4));let l=this.gl.getUniformLocation(this.shaderProgram,"u_flowDirection");l&&this.gl.uniform2f(l,e.flowDirection.x,e.flowDirection.y);let c=this.gl.getUniformLocation(this.shaderProgram,"u_liquidTurbulence");if(c){let d=this.liquidSettings.liquidTurbulence*(.5+e.energyLevel*.5);this.gl.uniform1f(c,d)}let m=this.gl.getUniformLocation(this.shaderProgram,"u_visualEffectsDepth");m&&this.gl.uniform1f(m,e.fluidIntensity);try{let d=A();d.queueCSSVariableUpdate("--sn-visualEffects-flow-direction",i.toString()),d.queueCSSVariableUpdate("--sn-visualEffects-animation-intensity",a.toString()),d.queueCSSVariableUpdate("--sn-visualEffects-aurora-flow",this.liquidSettings.auroraFlow.toString()),d.queueCSSVariableUpdate("--sn-visualEffects-viscosity",this.liquidSettings.liquidTurbulence.toString()),d.queueCSSVariableUpdate("--sn-visualEffects-surface-tension",this.liquidSettings.surfaceTension.toString()),d.queueCSSVariableUpdate("--sn-visualEffects-surface-elasticity",this.liquidSettings.surfaceElasticity.toString()),d.queueCSSVariableUpdate("--sn-visualEffects-animation-scale",this.liquidSettings.particleDensity.toString())}catch(d){u?.debug?.warn("FluidGradientBackgroundSystem","Global CSS controller not available:",d)}}onVisualStateUpdate(e){this.onVisualEffectsFieldUpdate(e)}onVisualEffectEvent(e,i){switch(e){case"visual:rhythm-shift":i.intensity&&(this.liquidSettings.liquidTurbulence=Math.min(1,i.intensity*.8));break;case"visual:color-shift":this.forceRepaint("color-shift");break;case"visual:energy-surge":i.intensity>.5&&(this.liquidSettings.particleDensity=Math.min(1,i.intensity));break}}getVisualContribution(){return{fluidIntensity:this.liquidSettings.liquidTurbulence,effectDepth:this.liquidSettings.particleDensity,systemHarmony:this.liquidSettings.surfaceTension}}onConsciousnessFieldUpdate(e){return this.onVisualEffectsFieldUpdate(e)}}});var wi,ns=v(()=>{"use strict";B();$();R();ge();wi=class extends q{constructor(e=w,i,r){super(e,i,r,null);this.intersectionObserver=null;this.animationFrameId=null;this.lastAnimationTime=0;this.styleElement=null;this.prefersReducedMotion=!1;this.currentQualityLevel=null;this.qualityCapabilities=[{name:"shimmer-effects",enabled:!0,qualityLevel:"medium"},{name:"oil-slick-intensity",enabled:!0,qualityLevel:"medium"},{name:"chromatic-aberration",enabled:!0,qualityLevel:"low"},{name:"interference-patterns",enabled:!0,qualityLevel:"low"},{name:"gpu-acceleration",enabled:!0,qualityLevel:"medium"},{name:"element-pooling",enabled:!0,qualityLevel:"low"}];this.qualityAdjustments={};this.shimmerElements=new Map;try{this.cssController=A()}catch(a){throw u?.debug?.warn("IridescentShimmerEffectsSystem","CSSVariableWriter not available:",a),a}this.shimmerSettings={enabled:!0,intensity:"balanced",targetSelectors:[".main-entityHeader-container",".sn-card",".main-card-card",".main-playButton-PlayButton",".main-actionBarRow-ActionBarRow",".main-trackList-trackListRow",".main-nowPlayingWidget-nowPlaying"],animationSpeed:.5,colorShift:30,opacityRange:[.1,.3],scaleRange:[.8,1.2],rotationSpeed:.2,blurRadius:8,saturationBoost:1.5,oilSlickIntensity:.7,chromaticAberration:2,refractionStrength:1.5,interferencePattern:!0,surfaceTension:.8,useGPUAcceleration:!0,maxSimultaneousShimmers:12,adaptiveQuality:!0,poolingEnabled:!0},this.shimmerKeyframes={shimmer:[{transform:"translateX(-100%) translateY(-100%) rotate(0deg) scale(0.8)",opacity:"0",filter:"hue-rotate(0deg) saturate(1)"},{transform:"translateX(0%) translateY(0%) rotate(45deg) scale(1.1)",opacity:"0.3",filter:"hue-rotate(120deg) saturate(1.8)"},{transform:"translateX(100%) translateY(100%) rotate(90deg) scale(1.2)",opacity:"0.1",filter:"hue-rotate(240deg) saturate(1.3)"},{transform:"translateX(200%) translateY(200%) rotate(180deg) scale(0.9)",opacity:"0",filter:"hue-rotate(360deg) saturate(1)"}],prism:[{background:"linear-gradient(45deg, rgba(var(--spice-rgb-shimmer-primary, 255, 0, 150), 0.1) 0%, rgba(var(--spice-rgb-shimmer-secondary, 0, 255, 255), 0.1) 50%, rgba(var(--spice-rgb-shimmer-tertiary, 255, 255, 0), 0.1) 100%)",transform:"rotate(0deg) scale(1)",mixBlendMode:"multiply"},{background:"linear-gradient(135deg, rgba(var(--spice-rgb-shimmer-secondary, 0, 255, 150), 0.12) 0%, rgba(var(--spice-rgb-shimmer-quaternary, 255, 0, 255), 0.12) 50%, rgba(var(--spice-rgb-shimmer-tertiary, 0, 150, 255), 0.12) 100%)",transform:"rotate(120deg) scale(1.1)",mixBlendMode:"overlay"},{background:"linear-gradient(225deg, rgba(var(--spice-rgb-shimmer-tertiary, 255, 150, 0), 0.12) 0%, rgba(var(--spice-rgb-shimmer-quaternary, 150, 255, 0), 0.12) 50%, rgba(var(--spice-rgb-shimmer-primary, 255, 0, 150), 0.12) 100%)",transform:"rotate(240deg) scale(0.9)",mixBlendMode:"overlay"},{background:"linear-gradient(315deg, rgba(var(--spice-rgb-shimmer-quaternary, 150, 0, 255), 0.08) 0%, rgba(var(--spice-rgb-shimmer-tertiary, 255, 255, 0), 0.08) 50%, rgba(var(--spice-rgb-shimmer-secondary, 0, 255, 150), 0.08) 100%)",transform:"rotate(360deg) scale(1)",mixBlendMode:"multiply"}],oilSlick:[{backdropFilter:"blur(2px) hue-rotate(0deg) saturate(1.5)",transform:"scaleX(1) scaleY(1) rotate(0deg)",opacity:"0.8"},{backdropFilter:"blur(4px) hue-rotate(90deg) saturate(2.2)",transform:"scaleX(1.05) scaleY(0.95) rotate(2deg)",opacity:"0.6"},{backdropFilter:"blur(6px) hue-rotate(180deg) saturate(1.8)",transform:"scaleX(0.95) scaleY(1.05) rotate(-2deg)",opacity:"0.7"},{backdropFilter:"blur(3px) hue-rotate(270deg) saturate(1.3)",transform:"scaleX(1.02) scaleY(0.98) rotate(1deg)",opacity:"0.9"},{backdropFilter:"blur(2px) hue-rotate(360deg) saturate(1.5)",transform:"scaleX(1) scaleY(1) rotate(0deg)",opacity:"0.8"}],rainbow:[{filter:"hue-rotate(0deg) saturate(1.2) brightness(1.1)"},{filter:"hue-rotate(60deg) saturate(1.8) brightness(1.2)"},{filter:"hue-rotate(120deg) saturate(1.5) brightness(1.1)"},{filter:"hue-rotate(180deg) saturate(1.9) brightness(1.3)"},{filter:"hue-rotate(240deg) saturate(1.4) brightness(1.1)"},{filter:"hue-rotate(300deg) saturate(1.6) brightness(1.2)"},{filter:"hue-rotate(360deg) saturate(1.2) brightness(1.1)"}]},this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,window.matchMedia("(prefers-reduced-motion: reduce)").addEventListener("change",a=>{this.prefersReducedMotion=a.matches,this.updateShimmerElements()})}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization(),this.loadSettings(),this.createShimmerStyles(),this.setupIntersectionObserver(),this.setupShimmerElements(),u?.debug?.log("IridescentShimmerEffectsSystem","Iridescent shimmer system initialized")}loadSettings(){}applyIntensitySettings(){switch(this.shimmerSettings.intensity){case"minimal":this.shimmerSettings.animationSpeed=.3,this.shimmerSettings.opacityRange=[.05,.15],this.shimmerSettings.colorShift=15,this.shimmerSettings.blurRadius=4,this.shimmerSettings.saturationBoost=1.2;break;case"balanced":this.shimmerSettings.animationSpeed=.5,this.shimmerSettings.opacityRange=[.1,.3],this.shimmerSettings.colorShift=30,this.shimmerSettings.blurRadius=8,this.shimmerSettings.saturationBoost=1.5;break;case"intense":this.shimmerSettings.animationSpeed=.8,this.shimmerSettings.opacityRange=[.15,.5],this.shimmerSettings.colorShift=60,this.shimmerSettings.blurRadius=12,this.shimmerSettings.saturationBoost=2;break}}createShimmerStyles(){this.styleElement=document.createElement("style"),this.styleElement.textContent=`
      .sn-shimmer-container {
        position: relative;
        overflow: hidden;
        isolation: isolate;
      }

      .sn-shimmer-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
        opacity: calc(var(--shimmer-intensity, 0.3) * 0.6);
        will-change: transform, filter;
      }

      /* Single unified shimmer effect - replaces 3 separate layers */
      .sn-shimmer-unified {
        background:
          conic-gradient(
            from var(--shimmer-phase, 0deg) at 50% 50%,
            rgba(var(--spice-rgb-shimmer-primary, 255, 0, 150), 0.08) 0%,
            rgba(var(--spice-rgb-shimmer-secondary, 0, 255, 255), 0.12) 25%,
            rgba(var(--spice-rgb-shimmer-tertiary, 255, 255, 0), 0.08) 50%,
            rgba(var(--spice-rgb-shimmer-quaternary, 150, 0, 255), 0.10) 75%,
            rgba(var(--spice-rgb-shimmer-primary, 255, 0, 150), 0.08) 100%
          ),
          linear-gradient(
            45deg,
            rgba(var(--spice-rgb-shimmer-primary, 255, 0, 150), 0.06) 0%,
            rgba(var(--spice-rgb-shimmer-secondary, 0, 255, 255), 0.04) 50%,
            rgba(var(--spice-rgb-shimmer-primary, 255, 0, 150), 0.06) 100%
          );
        backdrop-filter:
          blur(calc(var(--shimmer-intensity, 0.3) * 6px))
          saturate(calc(1 + var(--shimmer-intensity, 0.3) * 0.8));
        mix-blend-mode: overlay;
        animation:
          sn-shimmer-unified var(--shimmer-duration, 10s) ease-in-out infinite,
          sn-shimmer-rotation calc(var(--shimmer-duration, 10s) * 1.5) linear infinite;
        animation-delay: calc(var(--shimmer-phase, 0deg) / 360deg * var(--shimmer-duration, 10s));
      }

      @keyframes sn-shimmer-unified {
        0%, 100% {
          transform: scale(1) translateX(0%) translateY(0%);
          filter: hue-rotate(0deg) brightness(1.05);
        }
        25% {
          transform: scale(1.02) translateX(0.5%) translateY(-0.5%);
          filter: hue-rotate(90deg) brightness(1.15);
        }
        50% {
          transform: scale(0.98) translateX(-0.3%) translateY(0.3%);
          filter: hue-rotate(180deg) brightness(1.1);
        }
        75% {
          transform: scale(1.01) translateX(0.2%) translateY(-0.2%);
          filter: hue-rotate(270deg) brightness(1.08);
        }
      }

      @keyframes sn-shimmer-rotation {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Performance optimization for reduced motion */
      @media (prefers-reduced-motion: reduce) {
        .sn-shimmer-unified {
          animation: none;
          transform: none;
          filter: none;
          opacity: calc(var(--shimmer-intensity, 0.3) * 0.3);
        }
      }

      /* GPU acceleration hints */
      .sn-shimmer-unified {
        transform: translateZ(0);
        backface-visibility: hidden;
        perspective: 1000px;
      }
    `,document.head.appendChild(this.styleElement)}setupIntersectionObserver(){this.intersectionObserver=new IntersectionObserver(e=>{e.forEach(i=>{let r=this.shimmerElements.get(i.target);r&&(r.isVisible=i.isIntersecting,r.bounds=i.boundingClientRect,r.isVisible?this.activateShimmer(r):this.deactivateShimmer(r))})},{root:null,rootMargin:"50px",threshold:.1})}setupShimmerElements(){this.shimmerSettings.targetSelectors.forEach(i=>{document.querySelectorAll(i).forEach(a=>{this.addShimmerToElement(a)})}),new MutationObserver(i=>{i.forEach(r=>{r.addedNodes.forEach(a=>{if(a.nodeType===Node.ELEMENT_NODE){let n=a;this.shimmerSettings.targetSelectors.forEach(s=>{n.matches(s)&&this.addShimmerToElement(n),n.querySelectorAll(s).forEach(c=>{this.addShimmerToElement(c)})})}})})}).observe(document.body,{childList:!0,subtree:!0})}addShimmerToElement(e){if(this.shimmerElements.has(e))return;let i=document.createElement("div");i.className="sn-shimmer-layer sn-shimmer-unified";let r=this.getIntensityValue(),a=Math.random()*360;i.style.setProperty("--shimmer-intensity",r.toString()),i.style.setProperty("--shimmer-phase",`${a}deg`),i.style.setProperty("--shimmer-duration",`${8+Math.random()*4}s`),e.classList.add("sn-shimmer-container"),e.appendChild(i);let n={element:e,shimmerLayer:i,animationPhase:a,intensity:r,lastUpdate:0,isVisible:!1,bounds:e.getBoundingClientRect()};this.shimmerElements.set(e,n),this.intersectionObserver&&this.intersectionObserver.observe(e),this.config.enableDebug&&u?.debug?.log("IridescentShimmerEffectsSystem",`Added optimized shimmer to ${e.tagName}.${e.className.substring(0,20)}`)}getIntensityValue(){return{minimal:.3,balanced:.6,intense:1}[this.shimmerSettings.intensity]}activateShimmer(e){if(this.prefersReducedMotion){e.shimmerLayer.style.setProperty("--shimmer-intensity","0.1"),e.shimmerLayer.style.opacity="0.1";return}e.shimmerLayer.style.setProperty("--shimmer-intensity",e.intensity.toString()),e.shimmerLayer.style.opacity="1",e.shimmerLayer.style.animationPlayState="running"}deactivateShimmer(e){e.shimmerLayer.style.opacity="0",e.shimmerLayer.style.animationPlayState="paused"}updateShimmerElements(){if(!this.shimmerSettings.enabled){this.disableAllShimmers();return}let e={"--sn-shimmer-global-intensity":this.getIntensityValue().toString(),"--sn-shimmer-global-speed":`${this.shimmerSettings.animationSpeed}s`,"--sn-shimmer-global-blur":`${this.shimmerSettings.blurRadius}px`};this.cssController.batchSetVariables("IridescentShimmerEffectsSystem",e,"normal","shimmer-global-settings"),this.shimmerElements.forEach(i=>{i.isVisible?this.activateShimmer(i):this.deactivateShimmer(i)})}disableAllShimmers(){this.shimmerElements.forEach(e=>{this.deactivateShimmer(e)})}updateAnimation(e){}async healthCheck(){let e=this.shimmerSettings.enabled&&this.shimmerElements.size>0;return{system:"IridescentShimmerEffectsSystem",healthy:e,metrics:{enabled:this.shimmerSettings.enabled,elementCount:this.shimmerElements.size,intensity:this.shimmerSettings.intensity,initialized:this.initialized},issues:e?[]:[...this.shimmerSettings.enabled?[]:["System disabled"],...this.shimmerElements.size>0?[]:["No shimmer elements found"]]}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.intersectionObserver=null),this.shimmerElements.forEach((e,i)=>{i.classList.remove("sn-shimmer-container"),e.shimmerLayer.parentNode&&e.shimmerLayer.parentNode.removeChild(e.shimmerLayer)}),this.shimmerElements.clear(),this.styleElement&&this.styleElement.parentNode&&(this.styleElement.parentNode.removeChild(this.styleElement),this.styleElement=null)}setShimmerIntensity(e){this.shimmerSettings.intensity=e,this.applyIntensitySettings(),this.updateShimmerElements()}setShimmerEnabled(e){this.shimmerSettings.enabled=e,this.updateShimmerElements()}addShimmerTarget(e){this.shimmerSettings.targetSelectors.includes(e)||(this.shimmerSettings.targetSelectors.push(e),document.querySelectorAll(e).forEach(r=>{this.addShimmerToElement(r)}))}removeShimmerTarget(e){let i=this.shimmerSettings.targetSelectors.indexOf(e);i>-1&&(this.shimmerSettings.targetSelectors.splice(i,1),document.querySelectorAll(e).forEach(a=>{let n=this.shimmerElements.get(a);n&&(this.shimmerElements.delete(a),this.intersectionObserver&&this.intersectionObserver.unobserve(a),a.classList.remove("sn-shimmer-container"),n.shimmerLayer.parentNode&&n.shimmerLayer.parentNode.removeChild(n.shimmerLayer))}))}getShimmerSettings(){return{...this.shimmerSettings}}getShimmerElementCount(){return this.shimmerElements.size}setQualityLevel(e){switch(this.currentQualityLevel=e,e){case"low":this.shimmerSettings.enabled=!0,this.shimmerSettings.intensity="minimal",this.shimmerSettings.maxSimultaneousShimmers=5,this.shimmerSettings.animationSpeed=.3,this.shimmerSettings.oilSlickIntensity=.4,this.shimmerSettings.chromaticAberration=1,this.shimmerSettings.useGPUAcceleration=!1,this.shimmerSettings.interferencePattern=!1;break;case"medium":this.shimmerSettings.enabled=!0,this.shimmerSettings.intensity="balanced",this.shimmerSettings.maxSimultaneousShimmers=8,this.shimmerSettings.animationSpeed=.5,this.shimmerSettings.oilSlickIntensity=.7,this.shimmerSettings.chromaticAberration=2,this.shimmerSettings.useGPUAcceleration=!0,this.shimmerSettings.interferencePattern=!0;break;case"high":this.shimmerSettings.enabled=!0,this.shimmerSettings.intensity="intense",this.shimmerSettings.maxSimultaneousShimmers=12,this.shimmerSettings.animationSpeed=.7,this.shimmerSettings.oilSlickIntensity=.9,this.shimmerSettings.chromaticAberration=2.5,this.shimmerSettings.useGPUAcceleration=!0,this.shimmerSettings.interferencePattern=!0;break;case"high":this.shimmerSettings.enabled=!0,this.shimmerSettings.intensity="intense",this.shimmerSettings.maxSimultaneousShimmers=16,this.shimmerSettings.animationSpeed=1,this.shimmerSettings.oilSlickIntensity=1,this.shimmerSettings.chromaticAberration=3,this.shimmerSettings.useGPUAcceleration=!0,this.shimmerSettings.interferencePattern=!0;break}this.updateQualityCapabilities(e),this.applyQualityToExistingElements(),u?.debug?.log("IridescentShimmerEffectsSystem",`Quality level set to: ${e}`,{maxShimmers:this.shimmerSettings.maxSimultaneousShimmers,oilSlickIntensity:this.shimmerSettings.oilSlickIntensity,gpuAcceleration:this.shimmerSettings.useGPUAcceleration})}getPerformanceImpact(){let e=Array.from(this.shimmerElements.values()).filter(a=>a.isVisible).length,i=this.calculateAverageProcessingTime(),r=this.estimateMemoryUsage();return{fps:60,frameTime:i,memoryUsage:r,cpuUsage:this.estimateCPUUsage(e)}}reduceQuality(e){this.qualityAdjustments["shimmer-reduction"]=(this.qualityAdjustments["shimmer-reduction"]||0)+e,this.qualityAdjustments["animation-reduction"]=(this.qualityAdjustments["animation-reduction"]||0)+e*.8,this.qualityAdjustments["effect-reduction"]=(this.qualityAdjustments["effect-reduction"]||0)+e*.6,this.shimmerSettings.maxSimultaneousShimmers=Math.max(2,Math.floor(this.shimmerSettings.maxSimultaneousShimmers*(1-e*.5))),this.shimmerSettings.animationSpeed=Math.max(.1,this.shimmerSettings.animationSpeed*(1-e*.4)),this.shimmerSettings.oilSlickIntensity=Math.max(.2,this.shimmerSettings.oilSlickIntensity*(1-e*.6)),this.shimmerSettings.chromaticAberration=Math.max(.5,this.shimmerSettings.chromaticAberration*(1-e*.5)),e>.6&&(this.shimmerSettings.useGPUAcceleration=!1),e>.4&&(this.shimmerSettings.interferencePattern=!1),this.applyQualityToExistingElements(),u?.debug?.log("IridescentShimmerEffectsSystem",`Quality reduced by ${e}`,this.shimmerSettings)}increaseQuality(e){if(Object.keys(this.qualityAdjustments).forEach(i=>{this.qualityAdjustments[i]=Math.max(0,(this.qualityAdjustments[i]||0)-e)}),this.currentQualityLevel){let i=this.getBaseSettingsForLevel(this.currentQualityLevel);this.shimmerSettings.maxSimultaneousShimmers=Math.min(i.maxSimultaneousShimmers||this.shimmerSettings.maxSimultaneousShimmers,Math.floor(this.shimmerSettings.maxSimultaneousShimmers*(1+e*.3))),this.shimmerSettings.animationSpeed=Math.min(i.animationSpeed||this.shimmerSettings.animationSpeed,this.shimmerSettings.animationSpeed*(1+e*.2)),this.shimmerSettings.oilSlickIntensity=Math.min(i.oilSlickIntensity||this.shimmerSettings.oilSlickIntensity,this.shimmerSettings.oilSlickIntensity*(1+e*.3)),this.shimmerSettings.chromaticAberration=Math.min(i.chromaticAberration||this.shimmerSettings.chromaticAberration,this.shimmerSettings.chromaticAberration*(1+e*.2)),e>.3&&(this.shimmerSettings.interferencePattern=i.interferencePattern||!1),e>.5&&(this.shimmerSettings.useGPUAcceleration=i.useGPUAcceleration||!1)}this.applyQualityToExistingElements(),u?.debug?.log("IridescentShimmerEffectsSystem",`Quality increased by ${e}`,this.shimmerSettings)}getQualityCapabilities(){return[...this.qualityCapabilities]}updateQualityCapabilities(e){this.qualityCapabilities.forEach(i=>{switch(i.name){case"shimmer-effects":i.enabled=this.shimmerSettings.enabled;break;case"oil-slick-intensity":i.enabled=this.shimmerSettings.oilSlickIntensity>.3;break;case"chromatic-aberration":i.enabled=this.shimmerSettings.chromaticAberration>1;break;case"interference-patterns":i.enabled=this.shimmerSettings.interferencePattern;break;case"gpu-acceleration":i.enabled=this.shimmerSettings.useGPUAcceleration;break;case"element-pooling":i.enabled=this.shimmerSettings.poolingEnabled;break}})}getBaseSettingsForLevel(e){switch(e){case"low":return{maxSimultaneousShimmers:3,animationSpeed:.2,oilSlickIntensity:.3,chromaticAberration:.5,useGPUAcceleration:!1,interferencePattern:!1};case"low":return{maxSimultaneousShimmers:5,animationSpeed:.3,oilSlickIntensity:.4,chromaticAberration:1,useGPUAcceleration:!1,interferencePattern:!1};case"medium":return{maxSimultaneousShimmers:8,animationSpeed:.5,oilSlickIntensity:.7,chromaticAberration:2,useGPUAcceleration:!0,interferencePattern:!0};case"high":return{maxSimultaneousShimmers:16,animationSpeed:1,oilSlickIntensity:1,chromaticAberration:3,useGPUAcceleration:!0,interferencePattern:!0};default:return{}}}applyQualityToExistingElements(){this.shimmerElements.forEach((e,i)=>{e.animation&&(e.animation.playbackRate=this.shimmerSettings.animationSpeed),e.intensity=this.shimmerSettings.oilSlickIntensity;let r={"--sn-shimmer-intensity":this.shimmerSettings.oilSlickIntensity.toString(),"--sn-shimmer-chromatic":this.shimmerSettings.chromaticAberration.toString(),"--sn-shimmer-speed":this.shimmerSettings.animationSpeed.toString()};this.cssController.batchSetVariables("IridescentShimmerEffectsSystem",r,"normal","shimmer-quality-update")})}calculateAverageProcessingTime(){let e=Array.from(this.shimmerElements.values()).filter(a=>a.isVisible).length,i=2,r=(this.shimmerSettings.oilSlickIntensity+this.shimmerSettings.chromaticAberration/3+this.shimmerSettings.animationSpeed)/3;return i*e*r}estimateMemoryUsage(){let e=Array.from(this.shimmerElements.values()).filter(a=>a.isVisible).length,i=.5,r=this.shimmerSettings.useGPUAcceleration?2:0;return i*e+r}estimateCPUUsage(e){let r=(this.shimmerSettings.oilSlickIntensity+this.shimmerSettings.chromaticAberration/3)/2,a=this.shimmerSettings.useGPUAcceleration?.5:1;return Math.min(40,3*e*r*a)}adjustQuality(e){switch(this.currentQualityLevel=e,e){case"low":this.shimmerSettings.intensity="minimal",this.shimmerSettings.oilSlickIntensity=.2,this.shimmerSettings.useGPUAcceleration=!1;break;case"medium":this.shimmerSettings.intensity="balanced",this.shimmerSettings.oilSlickIntensity=.5,this.shimmerSettings.useGPUAcceleration=!0;break;case"high":default:this.shimmerSettings.intensity="intense",this.shimmerSettings.oilSlickIntensity=.8,this.shimmerSettings.useGPUAcceleration=!0;break}}}});function ss(o,t){let e=Math.max(0,Math.min(.9999,o))*63,i=Math.max(0,Math.min(.9999,t))*63,r=Math.floor(e),a=Math.floor(i),n=r+1,s=a+1,l=e-r,c=i-a,m=yt[a*64+r],d=yt[a*64+n%64],h=yt[s%64*64+r],g=yt[s%64*64+n%64],f=(V,z,G)=>V+(z-V)*G,S=f(m.x,d.x,l),C=f(m.y,d.y,l),x=f(h.x,g.x,l),M=f(h.y,g.y,l);return{x:f(S,x,c),y:f(C,M,c)}}var yt,os=v(()=>{"use strict";yt=new Array(4096);(function(){for(let t=0;t<yt.length;t++){let e=Math.random()*Math.PI*2;yt[t]={x:Math.cos(e),y:Math.sin(e)}}})()});var ls={};ne(ls,{SidebarVisualEffectsSystem:()=>Ft});var vt,Ft,ua=v(()=>{"use strict";B();os();ge();vt=class vt extends q{constructor(e,i,r,a,n=null){super(e,i,r,a);this.rootNavBar=null;this.overlayContainer=null;this.resizeObserver=null;this.visualEffectsElement=null;this.harmonicModeIndicator=null;this.echoPool=[];this.currentEchoCount=0;this._elementsWithActiveEcho=new WeakSet;this._navInteractionHandler=null;this.echoTimerCounter=0;this._lastMotionDisabled=!1;this.interactionPatterns=new Map;this.proximityObserver=null;this.interactionElements=new Map;this.activeEffects=[];this.animationPhase=0;this.localFrameCount=0;this.musicBeatIntensity=0;this.musicEnergyLevel=0;this.cursorPosition={x:0,y:0};this.cursorVelocity={x:0,y:0};this.lastCursorUpdate=0;this.MAX_EFFECT_POINTS=50;this.EFFECT_DECAY_RATE=.05;this.PROXIMITY_THRESHOLD=100;this.INTERACTION_COOLDOWN=16;this.ANIMATION_LERP=.08;this.SMOOTHING_LERP=.12;this.INTENSITY_LERP=.15;this.HARMONIC_MODE_TO_CSS_CLASS={"analogous-flow":"sn-color-harmony-analogous-flow","triadic-trinity":"sn-color-harmony-triadic-scheme","complementary-yin-yang":"sn-color-harmony-complementary-contrast","tetradic-advanced-cross":"sn-color-harmony-tetradic-cross","tetradic-cosmic-cross":"sn-color-harmony-tetradic-cross","split-complementary-spectrum":"sn-color-harmony-split-complementary-spectrum","split-complementary-aurora":"sn-color-harmony-split-complementary-spectrum","monochromatic-calm":"sn-color-harmony-monochromatic-calm","monochromatic-meditation":"sn-color-harmony-monochromatic-calm"};this.year3000System=n,this.masterAnimationRegistered=!1,this.isUsingMasterAnimation=!1,this.currentHarmonicModeClass="",this.currentEnergyClass="",this.currentHarmonicModeKey="artist-vision",this.nexusVariables={},this.performanceMetrics={animationFrames:0,maxFrameTime:0,averageFrameTime:0,frameTimeHistory:[],cssVariableUpdates:0,elementUpdates:0},this.deviceCapabilities={supportsCSSFilter:this._detectCSSFilterSupport(),supportsTransforms:this._detectTransformSupport(),performanceLevel:this._detectPerformanceLevel(),reducedMotion:this._detectReducedMotion()},this.animationState={lastPulse:0,pulseDirection:1,baseOpacity:.7,currentScale:1,targetScale:1,smoothingFactor:.15},this.visualState={direction:"radial",intensity:.3,velocity:50,smoothing:.7,effectPoints:[]},this.userInteractionState={globalIntensity:0,dominantDirection:0,interactionCount:0,lastInteractionTime:0,proximityElements:[]},this.setupEffectPoints(),this.setupInteractionPatterns(),e.enableDebug&&console.log(`[${this.systemName}] Enhanced with visual interaction system`)}onAnimate(e){}_detectCSSFilterSupport(){let e=document.createElement("div");return e.style.filter="blur(1px)",!!e.style.filter}_detectTransformSupport(){let e=document.createElement("div");return e.style.transform="scale(1.1)",!!e.style.transform}_detectPerformanceLevel(){let e=navigator.deviceMemory||4,i=navigator.hardwareConcurrency||4;return e>=8&&i>=8?"high":e>=4&&i>=4?"medium":"low"}_detectReducedMotion(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}async initialize(){if(await super.initialize(),this.rootNavBar=document.querySelector(".Root__nav-bar"),!this.rootNavBar){this.initialized=!1;return}this._createOverlayContainer(),this._createVisualEffectsElement(),this.createHarmonicModeDisplay(),this.updateColors(),this.rootNavBar&&(this._navInteractionHandler=e=>{let i=e.target;!i||!(i instanceof HTMLElement)||i.matches("a, button, [role='link']")&&this._spawnNavEcho(i)},this.rootNavBar.addEventListener("focusin",this._navInteractionHandler,!0),this.rootNavBar.addEventListener("pointerenter",this._navInteractionHandler,!0)),this._tryRegisterWithMasterAnimation(),this._setupResizeObserver()}_createOverlayContainer(){this.overlayContainer=document.createElement("div"),this.overlayContainer.id="sidebar-visual-effects-overlay",this.overlayContainer.style.position="absolute",this.overlayContainer.style.pointerEvents="none",this.overlayContainer.style.zIndex="1000",document.body.appendChild(this.overlayContainer)}_setupResizeObserver(){!this.rootNavBar||!this.overlayContainer||(this.resizeObserver=new ResizeObserver(e=>{for(let i of e){let{left:r,top:a,width:n,height:s}=i.contentRect;this.overlayContainer&&(this.overlayContainer.style.left=`${r}px`,this.overlayContainer.style.top=`${a}px`,this.overlayContainer.style.width=`${n}px`,this.overlayContainer.style.height=`${s}px`)}}),this.resizeObserver.observe(this.rootNavBar))}_tryRegisterWithMasterAnimation(){if(this.year3000System&&this.year3000System.registerAnimationSystem)try{this.year3000System.registerAnimationSystem("SidebarVisualEffectsSystem",this,"background",this.deviceCapabilities.performanceLevel==="high"?30:15),this.masterAnimationRegistered=!0,this.isUsingMasterAnimation=!0}catch{this._startFallbackVisualEffectsLoop()}else this._startFallbackVisualEffectsLoop()}_startFallbackVisualEffectsLoop(){this.isUsingMasterAnimation=!0}updateAnimation(e){if(this.deviceCapabilities.reducedMotion||!this.visualEffectsElement||!this.rootNavBar)return;let r=performance.now()*.001,a=Math.sin(r*2)*.1+.9;if(this.animationState.targetScale=a,this.animationState.currentScale+=(this.animationState.targetScale-this.animationState.currentScale)*this.animationState.smoothingFactor,this.visualEffectsElement.style.transform=`translateX(-50%) scale(${this.animationState.currentScale.toFixed(3)})`,this.harmonicModeIndicator){let n=(Math.sin(r*1.5)*.1+.85).toFixed(2);this.harmonicModeIndicator.style.opacity=n}}onPerformanceModeChange(e){e==="low"?this.animationState.smoothingFactor=.3:this.animationState.smoothingFactor=.15}handleSettingsChange(e){super.handleSettingsChange(e),e.detail.key==="sn-harmonic-mode"&&this.updateHarmonicModeDisplay(e.detail.value)}_createVisualEffectsElement(){this.overlayContainer&&(this.visualEffectsElement=document.createElement("div"),this.visualEffectsElement.className="sidebar-visual-effects-element",this.overlayContainer.appendChild(this.visualEffectsElement))}createHarmonicModeDisplay(){this.overlayContainer&&(this.harmonicModeIndicator=document.createElement("div"),this.harmonicModeIndicator.className="harmonic-mode-indicator",this.overlayContainer.appendChild(this.harmonicModeIndicator))}updateColors(){if(!this.visualEffectsElement||!this.harmonicModeIndicator||!this.rootNavBar)return;let e=getComputedStyle(this.rootNavBar),i=e.getPropertyValue("--spice-sidebar"),r=e.getPropertyValue("--spice-text");this.visualEffectsElement.style.backgroundColor=i,this.visualEffectsElement.style.borderColor=r,this.visualEffectsElement.style.borderWidth="1px",this.visualEffectsElement.style.borderStyle="solid",this.harmonicModeIndicator&&(this.harmonicModeIndicator.style.backgroundColor=`rgba(${this.utils.hexToRgb(r)?.r}, ${this.utils.hexToRgb(r)?.g}, ${this.utils.hexToRgb(r)?.b}, 0.1)`,this.harmonicModeIndicator.style.color=r)}updateHarmonicModeDisplay(e){if(this.currentHarmonicModeKey=e,this.rootNavBar){let i=this.rootNavBar.classList;i.forEach(n=>{n.startsWith("sn-color-harmony-")&&i.remove(n)});let r=ri[e],a=this.HARMONIC_MODE_TO_CSS_CLASS[e];r&&a&&this.rootNavBar.classList.add(a)}}_updateSidebarVariables(e={}){if(!this.rootNavBar)return;let{visualIntensity:i=.5,moodIdentifier:r="neutral",energyLevel:a="low"}=e;this.rootNavBar.classList.remove("sn-music-low-energy","sn-music-mid-energy","sn-music-high-energy"),this.rootNavBar.classList.add(`sn-music-${a}-energy`),this.rootNavBar.setAttribute("data-mood",r);let n=Math.max(0,Math.min(1,i)),s=Math.min(.5,n*.6),l=(c,m)=>{this.year3000System&&this.year3000System.queueCSSVariableUpdate?this.year3000System.queueCSSVariableUpdate(c,m,this.rootNavBar):this.rootNavBar.style.setProperty(c,m)};l("--sn-nav-item-glow-intensity",`${n}`),l("--sn-nav-text-energy-opacity",`${s}`),l("--sidebar-intensity",`${i}`)}updateFromMusicAnalysis(e,i,r){this.initialized&&(super.updateFromMusicAnalysis(e),this._updateSidebarVariables(e))}updateModeConfiguration(e){super.updateModeConfiguration(e),this.currentHarmonicModeKey=e.activeMode||"artist-vision",this.updateVisualEffectsForMode(),this.updateHarmonicModeDisplay(this.currentHarmonicModeKey)}updateVisualEffectsForMode(){if(this.visualEffectsElement){let e=this.modeConfig?.intensityMultiplier||1;this.visualEffectsElement.style.opacity=`${.1*e}`}}destroy(){if(this.year3000System?.timerConsolidationSystem)for(let e=0;e<this.echoTimerCounter;e++)this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer(`SidebarVisualEffectsSystem-echo-${e}`);if(this.rootNavBar&&this._navInteractionHandler&&(this.rootNavBar.removeEventListener("focusin",this._navInteractionHandler,!0),this.rootNavBar.removeEventListener("pointerenter",this._navInteractionHandler,!0),this._navInteractionHandler=null),this.year3000System&&this.year3000System.unregisterAnimationSystem&&this.year3000System.unregisterAnimationSystem("SidebarVisualEffectsSystem"),this.resizeObserver&&this.rootNavBar&&(this.resizeObserver.unobserve(this.rootNavBar),this.resizeObserver.disconnect(),this.resizeObserver=null),this.overlayContainer&&this.overlayContainer.parentNode&&(this.overlayContainer.parentNode.removeChild(this.overlayContainer),this.overlayContainer=null),this.rootNavBar){let e=this.rootNavBar.classList;e.forEach(i=>{i.startsWith("sn-")&&e.remove(i)})}super.destroy()}get echoIntensitySetting(){let i=parseInt("2",10);return isNaN(i)?2:i}get dynamicMaxEchoes(){switch(this.echoIntensitySetting){case 0:return 0;case 1:return Math.ceil(vt.BASE_MAX_ECHOES/2);case 3:return vt.BASE_MAX_ECHOES*2;default:return vt.BASE_MAX_ECHOES}}_acquireEchoElement(){let e=this.echoPool.pop();return e?(e.style.animation="none",e.offsetWidth,e.style.animation=""):(e=document.createElement("div"),e.className="sn-temporal-echo"),e}_releaseEchoElement(e){this.echoPool.length<20&&this.echoPool.push(e)}_spawnNavEcho(e){if(window.matchMedia("(prefers-reduced-motion: reduce)").matches||this.currentEchoCount>=this.dynamicMaxEchoes||this.echoIntensitySetting===0||this._elementsWithActiveEcho.has(e))return;let i=this.musicSyncService?.getLatestProcessedData()??{},r=i.energy??.5,a=i.valence??.5,n=Math.min(1.4,1+r*.4),s=((a-.5)*40).toFixed(1),l=e.getBoundingClientRect(),c=l.left/window.innerWidth,m=l.top/window.innerHeight,d=ss(c,m),h=this.musicSyncService?.getCurrentBeatVector?.()??{x:0,y:0},g=6+r*6,f=(d.x+h.x)*g,S=(d.y+h.y)*g,C=d.x*6,x=(Math.random()*360).toFixed(1),M=this._acquireEchoElement();M.style.setProperty("--sn-echo-radius-multiplier",n.toFixed(2)),M.style.setProperty("--sn-echo-hue-shift",`${s}deg`),M.style.setProperty("--sn-echo-offset-x",`${f.toFixed(1)}px`),M.style.setProperty("--sn-echo-offset-y",`${S.toFixed(1)}px`),M.style.setProperty("--sn-echo-skew",`${C.toFixed(2)}deg`),M.style.setProperty("--sn-echo-rotate",`${x}deg`),e.appendChild(M),this.currentEchoCount++,this._elementsWithActiveEcho.add(e);let V=`SidebarVisualEffectsSystem-echo-${this.echoTimerCounter++}`,z=()=>{M.parentElement&&M.parentElement.removeChild(M),this.currentEchoCount--,this._releaseEchoElement(M),this._elementsWithActiveEcho.delete(e)};this.year3000System?.timerConsolidationSystem?this.year3000System.timerConsolidationSystem.registerConsolidatedTimer(V,z,1100,"background"):setTimeout(z,1100)}applyPerformanceSettings(e){super.applyPerformanceSettings(e);let r=!e.enableGPUAcceleration||e.animationThrottle>=24||e.reducedMotion;this.rootNavBar&&r!==this._lastMotionDisabled&&(this.rootNavBar.classList.toggle("sn-motion-disabled",r),this._lastMotionDisabled=r)}setupEffectPoints(){this.visualState.effectPoints=[];let e=8,i=20;for(let r=0;r<e;r++)for(let a=0;a<e;a++){let n={x:r*i,y:a*i,magnitude:.5+Math.random()*.5,direction:Math.random()*Math.PI*2,influence:.3+Math.random()*.4};this.visualState.effectPoints.push(n)}}setupInteractionPatterns(){this.interactionPatterns.set("hover",{id:"hover",type:"hover",response:{intensityChange:.2,velocityChange:.1,smoothingChange:-.1,visualEffects:[{center:{x:0,y:0},radius:30,strength:.3,decay:.05,type:"wave"}],rippleEffect:!1,glowEffect:!0},duration:300,easing:"smooth",priority:3}),this.interactionPatterns.set("click",{id:"click",type:"click",response:{intensityChange:.5,velocityChange:.3,smoothingChange:-.2,visualEffects:[{center:{x:0,y:0},radius:50,strength:.7,decay:.08,type:"pulse"}],rippleEffect:!1,glowEffect:!0},duration:500,easing:"smooth",priority:8}),this.interactionPatterns.set("focus",{id:"focus",type:"focus",response:{intensityChange:.3,velocityChange:.05,smoothingChange:.1,visualEffects:[{center:{x:0,y:0},radius:40,strength:.4,decay:.02,type:"spiral"}],rippleEffect:!1,glowEffect:!0},duration:1e3,easing:"smooth",priority:6})}setupProximityDetection(){typeof IntersectionObserver<"u"&&(this.proximityObserver=new IntersectionObserver(e=>{e.forEach(i=>{let r=i.target,a=r.id||r.className;i.isIntersecting?(this.interactionElements.set(a,r),this.handleProximityEnter(r)):(this.interactionElements.delete(a),this.handleProximityExit(r))})},{threshold:[0,.1,.5,1],rootMargin:`${this.PROXIMITY_THRESHOLD}px`}))}handleProximityEnter(e){let i=e.getBoundingClientRect(),r={x:i.left+i.width/2,y:i.top+i.height/2},a=Math.sqrt(Math.pow(r.x-this.cursorPosition.x,2)+Math.pow(r.y-this.cursorPosition.y,2));this.userInteractionState.proximityElements.push({element:e,distance:a,influence:Math.max(0,1-a/this.PROXIMITY_THRESHOLD)})}handleProximityExit(e){this.userInteractionState.proximityElements=this.userInteractionState.proximityElements.filter(i=>i.element!==e)}updateVisualEffects(){this.activeEffects=this.activeEffects.filter(e=>(e.strength*=1-e.decay,e.strength>.01)),this.activeEffects.forEach(e=>{this.visualState.effectPoints.forEach(i=>{let r=Math.sqrt(Math.pow(i.x-e.center.x,2)+Math.pow(i.y-e.center.y,2));if(r<e.radius){let a=e.strength*(1-r/e.radius);switch(e.type){case"wave":i.magnitude+=a*.3;break;case"spiral":i.direction+=a*.5;break;case"pulse":i.magnitude+=a*.5,i.direction+=a*.2;break;case"vortex":let n=Math.atan2(i.y-e.center.y,i.x-e.center.x);i.direction=n+a*Math.PI*.5;break}}})})}updateMusicVisualEffects(){let e=this.musicBeatIntensity*.3;this.visualState.intensity=Math.max(this.visualState.intensity,e);let i=this.musicEnergyLevel*30;this.visualState.velocity=Math.min(200,this.visualState.velocity+i);let r=(1-this.musicEnergyLevel)*.2;this.visualState.smoothing=Math.max(.1,this.visualState.smoothing-r)}getVisualState(){return{...this.visualState}}getUserInteractionState(){return{...this.userInteractionState}}getActiveEffects(){return[...this.activeEffects]}};vt.BASE_MAX_ECHOES=4;Ft=vt});var Mi,cs=v(()=>{"use strict";$();_();R();ee();ge();Mi=class extends q{constructor(e,i,r,a){super(e,i,r,a);this.systemName="UIVisualEffectsController";this.legacySystemName="UIVisualEffectsController";this.visualEffectsCoordinator=null;this.currentVisualField=null;this.currentConsciousnessField=null;this.shimmerElements=new Map;this.mutationObserver=null;this.intersectionObserver=null;this.lastFrameTime=0;this.frameTimeHistory=[];this.eventUnsubscribeFunctions=[];this.customPerformanceMonitor={frameCount:0,totalFrameTime:0,lastPerformanceCheck:0,adaptiveQualityLevel:1};this.diagnosticTimerId=null;this.lastDiagnosticRun=0;this.uiEffectsConfig={enabled:!0,activityThreshold:.3,shimmerEnabled:!0,shimmerIntensity:.6,shimmerType:"mixed",shimmerPerformanceLevel:"balanced",interactionTrackingEnabled:!0,digitalMeditationThreshold:3e4,scrollVelocityTracking:!0,diagnosticEnabled:!0,autoFixWhiteLayer:!0,diagnosticInterval:5e3,audioVisualEnabled:!0,beatSynchronization:!0,nebulaEffectIntensity:this.getNebulaIntensityFromSettings(),scrollEffectsEnabled:!0,prismaticSheenIntensity:.5,maxFrameTime:1,adaptiveQuality:!0,debugMode:e.enableDebug||!1},this.activityState=this.createInitialActivityState(),u?.debug?.log("UIVisualEffectsController","Unified UI effects controller created")}get systemPriority(){return"normal"}getNebulaIntensityFromSettings(){switch(E.get("sn-gradient-intensity")){case"disabled":return 0;case"minimal":return .3;case"balanced":return .7;case"intense":return 1;default:return .7}}createInitialActivityState(){return{activityLevel:"dormant",shimmer:{intensity:0,effectType:"mixed",activeElements:new Set,performanceLevel:this.uiEffectsConfig.shimmerPerformanceLevel},interaction:{isActive:!1,lastInteractionTime:0,digitalMeditationDetected:!1,scrollVelocity:{x:0,y:0,direction:"none"},nexusState:"idle"},diagnostic:{whiteLayerIssues:[],webglContextHealthy:!0,lastDiagnosticTime:0,autoFixEnabled:this.uiEffectsConfig.autoFixWhiteLayer,criticalIssuesDetected:0},audioVisual:{beatIntensity:0,genreChangeDetected:!1,nebulaEffectIntensity:0,lastBeatTime:0,performanceAdaptive:this.uiEffectsConfig.adaptiveQuality},scroll:{sheenIntensity:0,scrollRatio:0,prismaticEffectActive:!1,lastScrollTime:0},performance:{frameTime:0,avgFrameTime:0,maxFrameTime:0,healthStatus:"excellent",adaptiveQualityEnabled:this.uiEffectsConfig.adaptiveQuality}}}async initialize(){try{u?.debug?.log("UIVisualEffectsController","Starting unified UI effects initialization..."),await this.initializeVisualCSS(),await this.initializeVisualCoordination(),this.subscribeToUnifiedEvents(),this.uiEffectsConfig.shimmerEnabled&&await this.initializeShimmerEffects(),this.uiEffectsConfig.interactionTrackingEnabled&&await this.initializeInteractionTracking(),this.uiEffectsConfig.diagnosticEnabled&&await this.initializeDiagnosticSystem(),this.uiEffectsConfig.audioVisualEnabled&&await this.initializeAudioVisualEffects(),this.uiEffectsConfig.scrollEffectsEnabled&&await this.initializeScrollEffects(),this.initialized=!0,u?.debug?.log("UIVisualEffectsController","Unified UI effects controller initialized")}catch(e){throw u?.debug?.error("UIVisualEffectsController","Failed to initialize:",e),e}}async initializeVisualCSS(){return this.initializeCSSConsciousness()}async initializeCSSConsciousness(){try{this.cssController=globalThis.unifiedVisualCSSController||globalThis.unifiedCSSConsciousnessController||null,this.cssController=A(),this.cssController?u?.debug?.log("UIVisualEffectsController","Connected to unified CSS visual effects"):u?.debug?.warn("UIVisualEffectsController","CSS visual effects not available, using coordinator fallback")}catch(e){u?.debug?.warn("UIVisualEffectsController","CSS visual effects initialization failed:",e)}}async initializeVisualCoordination(){return this.initializeConsciousnessIntegration()}async initializeConsciousnessIntegration(){try{this.visualEffectsCoordinator=globalThis.backgroundVisualCoordinator||globalThis.backgroundConsciousnessChoreographer||null,this.visualEffectsCoordinator?(this.visualEffectsCoordinator.registerVisualEffectsParticipant?this.visualEffectsCoordinator.registerVisualEffectsParticipant(this):this.visualEffectsCoordinator.registerConsciousnessParticipant&&this.visualEffectsCoordinator.registerConsciousnessParticipant(this),u?.debug?.log("UIVisualEffectsController","Registered with visual effects coordinator")):u?.debug?.log("UIVisualEffectsController","Operating without visual effects coordinator integration")}catch(e){u?.debug?.warn("UIVisualEffectsController","Visual coordination integration failed:",e)}}subscribeToUnifiedEvents(){let e=p.subscribe("music:beat",this.handleMusicBeat.bind(this),"UIVisualEffectsController");this.eventUnsubscribeFunctions.push(()=>p.unsubscribe(e));let i=p.subscribe("music:energy",this.handleMusicEnergy.bind(this),"UIVisualEffectsController");this.eventUnsubscribeFunctions.push(()=>p.unsubscribe(i));let r=p.subscribe("settings:changed",this.handleSettingsChange.bind(this),"UIVisualEffectsController");this.eventUnsubscribeFunctions.push(()=>p.unsubscribe(r)),u?.debug?.log("UIVisualEffectsController",`Subscribed to ${this.eventUnsubscribeFunctions.length} unified events`)}async initializeShimmerEffects(){try{this.setupElementObservers(),await this.discoverShimmerElements(),u?.debug?.log("UIVisualEffectsController",`Shimmer effects initialized with ${this.shimmerElements.size} elements`)}catch(e){u?.debug?.error("UIVisualEffectsController","Shimmer effects initialization failed:",e)}}async initializeInteractionTracking(){try{this.setupInteractionListeners(),u?.debug?.log("UIVisualEffectsController","Interaction tracking initialized")}catch(e){u?.debug?.error("UIVisualEffectsController","Interaction tracking initialization failed:",e)}}async initializeDiagnosticSystem(){try{this.startDiagnosticMonitoring(),u?.debug?.log("UIVisualEffectsController","Diagnostic system initialized")}catch(e){u?.debug?.error("UIVisualEffectsController","Diagnostic system initialization failed:",e)}}async initializeAudioVisualEffects(){try{u?.debug?.log("UIVisualEffectsController","Audio-visual effects initialized")}catch(e){u?.debug?.error("UIVisualEffectsController","Audio-visual effects initialization failed:",e)}}async initializeScrollEffects(){try{u?.debug?.log("UIVisualEffectsController","Scroll effects initialized")}catch(e){u?.debug?.error("UIVisualEffectsController","Scroll effects initialization failed:",e)}}setupElementObservers(){typeof MutationObserver<"u"&&(this.mutationObserver=new MutationObserver(e=>{let i=!1;e.forEach(r=>{r.type==="childList"&&r.addedNodes.forEach(a=>{a.nodeType===Node.ELEMENT_NODE&&(i=!0)})}),i&&this.discoverShimmerElements()}),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0})),typeof IntersectionObserver<"u"&&(this.intersectionObserver=new IntersectionObserver(e=>{e.forEach(i=>{let r=i.target.getAttribute("data-shimmer-id");r&&(i.isIntersecting?this.activityState.shimmer.activeElements.add(r):this.activityState.shimmer.activeElements.delete(r))})},{threshold:[0,.1,.5,1]}))}async discoverShimmerElements(){let e=[".sn-card",".main-card-card",".main-trackList-trackListRow",".main-button-primary",".main-playButton-button",'[data-testid="card-click-handler"]'],i=0;e.forEach(r=>{document.querySelectorAll(r).forEach((n,s)=>{let l=`shimmer-${r.replace(/[^\w]/g,"_")}-${s}`,c=n;c.setAttribute("data-shimmer-id",l),this.shimmerElements.set(l,c),this.intersectionObserver&&this.intersectionObserver.observe(c),i++})}),this.uiEffectsConfig.debugMode&&i>0&&u?.debug?.log("UIVisualEffectsController",`Discovered ${i} shimmer elements`)}setupInteractionListeners(){["click","keydown","mousemove","scroll","touchstart"].forEach(i=>{document.addEventListener(i,()=>{this.activityState.interaction.isActive=!0,this.activityState.interaction.lastInteractionTime=Date.now(),this.activityState.interaction.digitalMeditationDetected=!1,this.updateNexusState()},{passive:!0})})}startDiagnosticMonitoring(){this.diagnosticTimerId=window.setInterval(()=>{this.runDiagnosticCheck()},this.uiEffectsConfig.diagnosticInterval)}updateAnimation(e){if(!this.initialized)return;let i=performance.now();this.lastFrameTime=i;let r=i;try{this.updateVisualActivityState(e),this.uiEffectsConfig.shimmerEnabled&&this.updateShimmerEffects(e),this.uiEffectsConfig.interactionTrackingEnabled&&this.updateInteractionTracking(e),this.uiEffectsConfig.audioVisualEnabled&&this.updateAudioVisualEffects(e),this.uiEffectsConfig.scrollEffectsEnabled&&this.updateScrollEffects(e),this.applyCSSUpdates();let a=performance.now()-r;this.updatePerformanceMetrics(a),a>this.uiEffectsConfig.maxFrameTime&&this.handlePerformanceIssue(a)}catch(a){u?.debug?.error("UIVisualEffectsController","Animation loop error:",a)}}updateVisualActivityState(e){let i=this.activityState,r=i.shimmer.intensity*.2+(i.interaction.isActive?.3:0)+i.audioVisual.beatIntensity*.3+i.scroll.sheenIntensity*.2;r>.8?(i.activityLevel="enhanced",i.transcendentLevel="advanced"):r>.5?i.activityLevel="focused":r>.2?i.activityLevel="aware":i.activityLevel="dormant"}updateShimmerEffects(e){let i=this.activityState.shimmer,r=this.activityState.audioVisual.beatIntensity*.3,a=this.activityState.interaction.isActive?.2:0;i.intensity=Math.min(this.uiEffectsConfig.shimmerIntensity+r+a,1),this.activityState.performance.healthStatus==="degraded"?i.intensity*=.7:this.activityState.performance.healthStatus==="critical"&&(i.intensity*=.3)}updateInteractionTracking(e){let i=this.activityState.interaction,a=Date.now()-i.lastInteractionTime;a>this.uiEffectsConfig.digitalMeditationThreshold&&(i.digitalMeditationDetected||(i.digitalMeditationDetected=!0,u?.debug?.log("UIVisualEffectsController","Digital meditation detected",{inactiveTime:a}))),this.updateNexusState()}updateNexusState(){let e=this.activityState.interaction,r=Date.now()-e.lastInteractionTime;e.digitalMeditationDetected?e.nexusState="meditation":r<1e3?e.nexusState="active":r<1e4?e.nexusState="flow":e.nexusState="idle"}updateAudioVisualEffects(e){let i=this.activityState.audioVisual,r=this.activityState.activityLevel==="enhanced"?.2:0;i.nebulaEffectIntensity=Math.min(this.uiEffectsConfig.nebulaEffectIntensity+i.beatIntensity*.3+r,1)}updateScrollEffects(e){let i=this.activityState.scroll;Date.now()-i.lastScrollTime<1e3?(i.prismaticEffectActive=!0,i.sheenIntensity=Math.min(i.scrollRatio*this.uiEffectsConfig.prismaticSheenIntensity,1)):(i.prismaticEffectActive=!1,i.sheenIntensity*=.95)}applyCSSUpdates(){let e=this.activityState,i={"--sn-ui-activity-level":e.activityLevel,"--sn-shimmer-intensity":e.shimmer.intensity.toFixed(3),"--sn-shimmer-effect-type":e.shimmer.effectType,"--sn-shimmer-performance":e.shimmer.performanceLevel,"--sn-interaction-nexus-state":e.interaction.nexusState,"--sn-interaction-meditation":e.interaction.digitalMeditationDetected?"1":"0","--sn-scroll-velocity-x":e.interaction.scrollVelocity.x.toFixed(2),"--sn-scroll-velocity-y":e.interaction.scrollVelocity.y.toFixed(2),"--sn-beat-intensity":e.audioVisual.beatIntensity.toFixed(3),"--sn-nebula-intensity":e.audioVisual.nebulaEffectIntensity.toFixed(3),"--sn-genre-change":e.audioVisual.genreChangeDetected?"1":"0","--sn-scroll-sheen-intensity":e.scroll.sheenIntensity.toFixed(3),"--sn-scroll-ratio":e.scroll.scrollRatio.toFixed(3),"--sn-prismatic-active":e.scroll.prismaticEffectActive?"1":"0","--sn-white-layer-issues":e.diagnostic.whiteLayerIssues.length.toString(),"--sn-webgl-healthy":e.diagnostic.webglContextHealthy?"1":"0"};try{this.cssController.batchSetVariables("UIVisualEffectsController",i,"normal","ui-activity-update")}catch(r){u?.debug?.warn("UIVisualEffectsController","CSS coordination error:",r)}}updatePerformanceMetrics(e){let i=this.activityState.performance;i.frameTime=e,this.frameTimeHistory.push(e),this.frameTimeHistory.length>60&&this.frameTimeHistory.shift(),i.avgFrameTime=this.frameTimeHistory.reduce((r,a)=>r+a,0)/this.frameTimeHistory.length,i.maxFrameTime=Math.max(...this.frameTimeHistory),i.avgFrameTime>2?i.healthStatus="critical":i.avgFrameTime>1.5?i.healthStatus="degraded":i.avgFrameTime>1?i.healthStatus="good":i.healthStatus="excellent"}handlePerformanceIssue(e){this.uiEffectsConfig.adaptiveQuality&&(this.customPerformanceMonitor.adaptiveQualityLevel*=.9,this.customPerformanceMonitor.adaptiveQualityLevel<.5&&(this.activityState.shimmer.performanceLevel="minimal"),this.uiEffectsConfig.debugMode&&u?.debug?.warn("UIVisualEffectsController",`Performance issue: ${e.toFixed(2)}ms, reduced quality to ${this.customPerformanceMonitor.adaptiveQualityLevel.toFixed(2)}`))}runDiagnosticCheck(){let e=this.activityState.diagnostic,i=Date.now();e.lastDiagnosticTime=i,e.whiteLayerIssues=[];try{let r=document.createElement("canvas"),a=r.getContext("webgl")||r.getContext("experimental-webgl");e.webglContextHealthy=!!a;let n=document.querySelectorAll('[style*="background"], [style*="color"]'),s=0;n.forEach(l=>{let c=window.getComputedStyle(l);(c.backgroundColor==="rgb(255, 255, 255)"||c.color==="rgb(255, 255, 255)")&&s++}),s>10&&(e.whiteLayerIssues.push(`Excessive white layers detected: ${s}`),e.autoFixEnabled&&this.autoFixWhiteLayerIssues()),e.criticalIssuesDetected=e.whiteLayerIssues.length}catch(r){u?.debug?.error("UIVisualEffectsController","Diagnostic check failed:",r)}}autoFixWhiteLayerIssues(){try{this.cssController.batchSetVariables("UIVisualEffectsController",{"--spice-text":"var(--spice-main)","--spice-subtext":"var(--catppuccin-text)"},"critical","white-layer-autofix"),this.uiEffectsConfig.debugMode&&u?.debug?.log("UIVisualEffectsController","Applied white layer auto-fix")}catch(e){u?.debug?.error("UIVisualEffectsController","Auto-fix failed:",e)}}handleMusicBeat(e){let i=this.activityState.audioVisual;if(i.beatIntensity=e.intensity||.5,i.lastBeatTime=Date.now(),this.uiEffectsConfig.shimmerEnabled){let r=i.beatIntensity*.2;this.activityState.shimmer.intensity=Math.min(this.activityState.shimmer.intensity+r,1)}}handleMusicEnergy(e){let i=this.activityState.audioVisual;e.energy!==void 0&&(i.beatIntensity=Math.max(i.beatIntensity,e.energy*.8))}handleGenreChange(e){let i=this.activityState.audioVisual;i.genreChangeDetected=!0,setTimeout(()=>{i.genreChangeDetected=!1},2e3)}handleUserScroll(e){let i=this.activityState.scroll,r=this.activityState.interaction;i.lastScrollTime=Date.now(),i.scrollRatio=e.scrollRatio||0,e.velocity&&(r.scrollVelocity={x:e.velocity.x||0,y:e.velocity.y||0,direction:e.direction||"none"}),this.handleUserInteraction({type:"scroll",timestamp:Date.now()})}handleUserInteraction(e){let i=this.activityState.interaction;i.isActive=!0,i.lastInteractionTime=e.timestamp||Date.now(),i.digitalMeditationDetected=!1,this.updateNexusState()}handleSettingsChange(e){let{key:i,value:r}=e;i.startsWith("sn-ui-effects-")?this.updateConfigFromSettings(i,r):i==="sn-gradient-intensity"&&(this.uiEffectsConfig.nebulaEffectIntensity=this.getNebulaIntensityFromSettings(),u?.debug?.log("UIVisualEffectsController",`Updated nebula intensity to: ${this.uiEffectsConfig.nebulaEffectIntensity} from consolidated gradient setting: ${r}`))}updateConfigFromSettings(e,i){switch(e){case"sn-ui-effects-shimmer-intensity":this.uiEffectsConfig.shimmerIntensity=parseFloat(i)||.6;break;case"sn-ui-effects-diagnostic-enabled":this.uiEffectsConfig.diagnosticEnabled=i==="true"||i===!0;break;case"sn-ui-effects-adaptive-quality":this.uiEffectsConfig.adaptiveQuality=i==="true"||i===!0;break}}getConsciousnessContribution(){return{systemName:this.systemName,activityLevel:this.activityState.activityLevel,shimmerIntensity:this.activityState.shimmer.intensity,interactionState:this.activityState.interaction.nexusState,audioVisualIntensity:this.activityState.audioVisual.nebulaEffectIntensity,scrollActivity:this.activityState.scroll.sheenIntensity,timestamp:Date.now()}}onVisualFieldUpdate(e){return this.onConsciousnessFieldUpdate(e)}onConsciousnessFieldUpdate(e){try{this.currentVisualField=e,this.currentConsciousnessField=e;let i=e.pulseRate*.2;this.activityState.shimmer.intensity=Math.min(this.activityState.shimmer.intensity+i,1),this.activityState.audioVisual.nebulaEffectIntensity=Math.min(this.activityState.audioVisual.nebulaEffectIntensity+i*.3,1)}catch(i){u?.debug?.error("UIVisualEffectsController","Error updating from visual effects state:",i)}}onVisualCoordinationEvent(e,i){return this.onChoreographyEvent(e,i)}onChoreographyEvent(e,i){e==="transition:start"&&(this.activityState.shimmer.intensity=Math.min(this.activityState.shimmer.intensity+.2,1),this.activityState.audioVisual.nebulaEffectIntensity=Math.min(this.activityState.audioVisual.nebulaEffectIntensity+.15,1)),this.uiEffectsConfig.debugMode&&u?.debug?.log("UIVisualEffectsController",`Visual coordination event: ${e}`,i)}async healthCheck(){let e=this.activityState,i=this.initialized&&e.performance.healthStatus!=="critical"&&e.diagnostic.criticalIssuesDetected===0;return{healthy:i,ok:i,details:`UI Effects Activity: ${e.activityLevel}, Shimmer: ${e.shimmer.activeElements.size} elements, Interaction: ${e.interaction.nexusState}, Performance: ${e.performance.healthStatus}, Diagnostics: ${e.diagnostic.criticalIssuesDetected} issues`,system:"UIVisualEffectsController"}}updateConfiguration(e){let i={...this.uiEffectsConfig},r=[],a=[];try{for(let[n,s]of Object.entries(e))n in this.uiEffectsConfig?r.push(n):a.push(`Unknown configuration property: ${n}`),n==="shimmerIntensity"&&typeof s=="number"&&(s<0||s>1)&&a.push("shimmerIntensity must be between 0 and 1"),n==="digitalMeditationThreshold"&&typeof s=="number"&&s<1e3&&a.push("digitalMeditationThreshold must be at least 1000ms");return a.length===0&&(Object.assign(this.uiEffectsConfig,e),e.shimmerEnabled!==void 0&&e.shimmerEnabled&&!this.activityState.shimmer.activeElements.size&&this.discoverShimmerElements(),e.diagnosticEnabled!==void 0&&(e.diagnosticEnabled&&!this.diagnosticTimerId?this.startDiagnosticMonitoring():!e.diagnosticEnabled&&this.diagnosticTimerId&&(clearInterval(this.diagnosticTimerId),this.diagnosticTimerId=null)),u?.debug?.log("UIEffectsController","Configuration updated:",e)),{success:a.length===0,updatedProperties:r,validationErrors:a,previousConfig:i,newConfig:{...this.uiEffectsConfig}}}catch(n){let s=n instanceof Error?n.message:"Unknown error during configuration update";return{success:!1,updatedProperties:r,validationErrors:[...a,s],previousConfig:i,newConfig:i}}}getConfiguration(){return{...this.uiEffectsConfig}}getVisualState(){return this.getConsciousnessState()}getConsciousnessState(){return{...this.activityState}}generateDiagnosticReport(){let e=performance.now(),i=performance.memory,r=100,a={whiteLayerProblems:[...this.activityState.diagnostic.whiteLayerIssues],webglContextIssues:[],performanceWarnings:[],configurationErrors:[]},n=[];this.activityState.performance.avgFrameTime>33&&(r-=20,a.performanceWarnings.push(`High frame time: ${this.activityState.performance.avgFrameTime.toFixed(1)}ms`),n.push("Consider reducing visual effect quality or disabling intensive effects")),this.activityState.diagnostic.webglContextHealthy||(r-=30,a.webglContextIssues.push("WebGL context is unhealthy or lost"),n.push("Restart visual effects or check browser WebGL support")),this.uiEffectsConfig.enabled||(a.configurationErrors.push("UI effects are disabled"),n.push("Enable UI effects in settings for full experience")),this.activityState.diagnostic.whiteLayerIssues.length>0&&(r-=15*this.activityState.diagnostic.whiteLayerIssues.length,n.push("Enable auto-fix for white layer issues or check CSS customizations"));let s;return r>=90?s="excellent":r>=70?s="good":r>=50?s="degraded":s="critical",{timestamp:e,systemHealth:s,activeEffects:{shimmer:this.uiEffectsConfig.shimmerEnabled&&this.activityState.shimmer.intensity>0,interaction:this.uiEffectsConfig.interactionTrackingEnabled&&this.activityState.interaction.isActive,audioVisual:this.uiEffectsConfig.audioVisualEnabled&&this.activityState.audioVisual.beatIntensity>0,scroll:this.uiEffectsConfig.scrollEffectsEnabled&&this.activityState.scroll.prismaticEffectActive},performanceMetrics:{averageFrameTime:this.activityState.performance.avgFrameTime,maxFrameTime:this.activityState.performance.maxFrameTime,memoryUsage:i?.usedJSHeapSize||0,cpuUsage:this.activityState.performance.frameTime/16.67},issues:a,recommendations:n}}getShimmerElements(){return new Map(this.shimmerElements)}getInteractionState(){return this.activityState.interaction}getDiagnosticState(){return this.activityState.diagnostic}async destroy(){u?.debug?.log("UIVisualEffectsController","Destroying unified UI effects controller..."),this.diagnosticTimerId&&(clearInterval(this.diagnosticTimerId),this.diagnosticTimerId=null),this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.intersectionObserver=null);for(let e of this.eventUnsubscribeFunctions)e();this.eventUnsubscribeFunctions=[],this.shimmerElements.clear(),this.visualEffectsCoordinator,this.initialized=!1,u?.debug?.log("UIVisualEffectsController","Unified UI effects controller destroyed")}onVisualStateUpdate(e){e.musicIntensity>.6&&this.triggerIntensityEffects(e.musicIntensity),e.colorTemperature&&this.updateTemperatureEffects(e.colorTemperature)}onVisualEffectEvent(e,i){switch(e){case"visual:rhythm-shift":this.triggerShimmerEffects(i.intensity||.5);break;case"visual:color-shift":this.updateTemperatureEffects(i.temperature||6500);break;case"visual:energy-surge":i.intensity>.7&&this.triggerIntensityEffects(i.intensity);break}}getVisualContribution(){let e=[],i=0,r={};return this.uiEffectsConfig.shimmerEnabled&&this.activityState.shimmer.intensity>0&&(r.visualCoherence=this.activityState.activityLevel==="enhanced"?1:.7,r.systemHarmony=this.activityState.shimmer.intensity,e.push("shimmer"),i+=.3),this.uiEffectsConfig.audioVisualEnabled&&this.activityState.audioVisual.nebulaEffectIntensity>0&&(r.effectDepth=this.activityState.audioVisual.nebulaEffectIntensity,r.energyLevel=this.activityState.audioVisual.beatIntensity,e.push("audioVisual"),i+=.4),this.activityState.interaction.isActive&&Math.sqrt(this.activityState.interaction.scrollVelocity.x**2+this.activityState.interaction.scrollVelocity.y**2)>0&&(r.flowDirection={x:this.activityState.interaction.scrollVelocity.x/100,y:this.activityState.interaction.scrollVelocity.y/100},e.push("interaction"),i+=.2),this.activityState.performance.healthStatus!=="critical"&&(e.push("performance"),i+=.1),{contribution:r,confidence:Math.min(1,i),sources:e,timestamp:performance.now()}}triggerIntensityEffects(e){this.uiEffectsConfig.shimmerEnabled&&(this.activityState.shimmer.intensity=Math.min(this.activityState.shimmer.intensity+e*.3,1)),this.uiEffectsConfig.audioVisualEnabled&&(this.activityState.audioVisual.nebulaEffectIntensity=Math.min(this.activityState.audioVisual.nebulaEffectIntensity+e*.2,1)),this.uiEffectsConfig.scrollEffectsEnabled&&(this.activityState.scroll.sheenIntensity=Math.min(this.activityState.scroll.sheenIntensity+e*.1,1))}updateTemperatureEffects(e){let i=Math.max(1e3,Math.min(1e4,e));this.uiEffectsConfig.shimmerEnabled&&(i<3e3?this.activityState.shimmer.effectType="prism":i>7e3?this.activityState.shimmer.effectType="oil-slick":this.activityState.shimmer.effectType="rainbow");let r=(i-1e3)/9e3;this.uiEffectsConfig.audioVisualEnabled&&(this.activityState.audioVisual.nebulaEffectIntensity=Math.min(this.activityState.audioVisual.nebulaEffectIntensity+r*.1,1))}triggerShimmerEffects(e){if(!this.uiEffectsConfig.shimmerEnabled)return;this.activityState.shimmer.intensity=Math.min(this.activityState.shimmer.intensity+e*.4,1);let i=this.activityState.shimmer.effectType;this.activityState.shimmer.effectType="mixed",setTimeout(()=>{this.activityState.shimmer.effectType=i},2e3)}}});var ma,da,ha,ga,pa,it,Ti,us=v(()=>{"use strict";R();Wr();ma=class{constructor(){this.systems=new Map}async initializeSystem(t,e,i){let r=this.systems.get(t);if(r?.initialized){u?.debug?.warn("SystemLifecycle",`System ${t} already initialized`);return}let a=performance.now();try{u?.debug?.log("SystemLifecycle",`Initializing system: ${t}`),await i();let n=performance.now()-a,s=Date.now();this.systems.set(t,{initialized:!0,initializationTime:n,lastInitialized:s,initializationCount:(r?.initializationCount||0)+1}),u?.debug?.log("SystemLifecycle",`System ${t} initialized in ${n.toFixed(2)}ms`)}catch(n){throw u?.debug?.error("SystemLifecycle",`Failed to initialize system ${t}:`,n),n}}destroySystem(t,e){let i=this.systems.get(t);if(!i?.initialized){u?.debug?.warn("SystemLifecycle",`System ${t} not initialized`);return}try{u?.debug?.log("SystemLifecycle",`Destroying system: ${t}`),e(),this.systems.set(t,{...i,initialized:!1})}catch(r){u?.debug?.error("SystemLifecycle",`Failed to destroy system ${t}:`,r)}}isSystemInitialized(t){return this.systems.get(t)?.initialized??!1}getSystemMetrics(t){let e=this.systems.get(t);return e?{initializationTime:e.initializationTime,lastInitialized:e.lastInitialized,initializationCount:e.initializationCount}:null}},da=class{constructor(){this.systemMetrics=new Map}trackOperation(t,e,i){let r=performance.now();try{let a=i(),n=performance.now()-r;return this.recordOperationTime(t,e,n),a}catch(a){let n=performance.now()-r;throw this.recordOperationTime(t,e,n),a}}async trackOperationAsync(t,e,i){let r=performance.now();try{let a=await i(),n=performance.now()-r;return this.recordOperationTime(t,e,n),a}catch(a){let n=performance.now()-r;throw this.recordOperationTime(t,e,n),a}}recordMetric(t,e,i){let r=this.systemMetrics.get(t)||{operationTimes:{},metrics:{}};r.metrics[e]=i,this.systemMetrics.set(t,r)}recordOperationTime(t,e,i){let r=this.systemMetrics.get(t)||{operationTimes:{},metrics:{}};r.operationTimes[e]||(r.operationTimes[e]=[]),r.operationTimes[e].push(i),r.operationTimes[e].length>100&&r.operationTimes[e].shift(),this.systemMetrics.set(t,r)}getMetrics(t){let e=this.systemMetrics.get(t);if(!e)return null;let i=[];return Object.values(e.operationTimes).forEach(r=>i.push(...r)),{operationTimes:{...e.operationTimes},metrics:{...e.metrics},averageOperationTime:i.length>0?i.reduce((r,a)=>r+a,0)/i.length:0,lastOperationTime:i[i.length-1]||0}}},ha=class{constructor(){this.updateQueue=new Map;this.flushScheduled=!1;this.lastFlushTime=0}queueUpdate(t,e){this.updateQueue.set(t,e),this.scheduleFlush()}queueBatchUpdate(t){Object.entries(t).forEach(([e,i])=>{this.updateQueue.set(e,i)}),this.scheduleFlush()}flushUpdates(){if(this.updateQueue.size===0)return;let t=document.documentElement,e=performance.now();for(let[r,a]of this.updateQueue)t.style.setProperty(r,a);let i=performance.now()-e;this.updateQueue.clear(),this.lastFlushTime=Date.now(),this.flushScheduled=!1,u?.debug?.log("CSSVariableService",`Flushed ${this.updateQueue.size} CSS updates in ${i.toFixed(2)}ms`)}scheduleFlush(){this.flushScheduled||(this.flushScheduled=!0,requestAnimationFrame(()=>{this.flushUpdates()}))}getCurrentValue(t){return getComputedStyle(document.documentElement).getPropertyValue(t)||null}getQueueStatus(){return{queueSize:this.updateQueue.size,lastFlushTime:this.lastFlushTime,pendingUpdates:Array.from(this.updateQueue.keys())}}},ga=class{constructor(){this.systemSubscriptions=new Map}subscribe(t,e,i){let r=this.systemSubscriptions.get(t)||{eventUnsubscribers:[],domUnsubscribers:[]},a=globalThis.unifiedEventBus;if(a?.subscribe){let n=a.subscribe(e,i,t);r.eventUnsubscribers.push(()=>n())}else{let n=s=>{i(s.detail)};document.addEventListener(e,n),r.domUnsubscribers.push(()=>{document.removeEventListener(e,n)})}this.systemSubscriptions.set(t,r)}subscribeToDOM(t,e,i,r,a){let n=this.systemSubscriptions.get(t)||{eventUnsubscribers:[],domUnsubscribers:[]};e.addEventListener(i,r,a),n.domUnsubscribers.push(()=>{e.removeEventListener(i,r,a)}),this.systemSubscriptions.set(t,n)}unsubscribe(t,e){this.cleanupSystem(t)}cleanupSystem(t){let e=this.systemSubscriptions.get(t);e&&(e.eventUnsubscribers.forEach(i=>{try{i()}catch(r){u?.debug?.warn("EventSubscriptionService",`Error unsubscribing for ${t}:`,r)}}),e.domUnsubscribers.forEach(i=>{try{i()}catch(r){u?.debug?.warn("EventSubscriptionService",`Error removing DOM listener for ${t}:`,r)}}),this.systemSubscriptions.delete(t))}getSubscriptionStatus(t){let e=this.systemSubscriptions.get(t);return e?{eventSubscriptions:[],domSubscriptions:e.domUnsubscribers.length,totalSubscriptions:e.eventUnsubscribers.length+e.domUnsubscribers.length}:{eventSubscriptions:[],domSubscriptions:0,totalSubscriptions:0}}},pa=class{constructor(){this.systemCanvases=new Map;this.capabilities=hi()}async createCanvas(t,e,i){let r=this.systemCanvases.get(t)||new Map,a=r.get(e);if(a)return u?.debug?.warn("CanvasManagement",`Canvas ${e} already exists for system ${t}`),a;try{let n=await di({id:e,width:i.width||800,height:i.height||600,alpha:i.alpha??!0,preserveDrawingBuffer:i.preserveDrawingBuffer??!1,preferredType:i.contextType});return r.set(e,n),this.systemCanvases.set(t,r),u?.debug?.log("CanvasManagement",`Created ${i.contextType} canvas ${e} for system ${t} (${i.width}x${i.height})`),n}catch(n){throw u?.debug?.error("CanvasManagement",`Failed to create canvas ${e} for system ${t}:`,n),n}}getCanvas(t,e){return this.systemCanvases.get(t)?.get(e)||null}resizeCanvas(t,e,i,r){let a=this.getCanvas(t,e);if(!a)return!1;try{return a.canvas.width=i,a.canvas.height=r,a.ctx&&"viewport"in a.ctx&&a.ctx.viewport(0,0,i,r),!0}catch(n){return u?.debug?.error("CanvasManagement",`Failed to resize canvas ${e} for system ${t}:`,n),!1}}destroyCanvas(t,e){let i=this.systemCanvases.get(t);if(!i)return;let r=i.get(e);if(r){if(r.ctx&&"getExtension"in r.ctx){let n=r.ctx.getExtension("WEBGL_lose_context");n&&n.loseContext()}r.canvas.parentNode&&r.canvas.parentNode.removeChild(r.canvas),i.delete(e),u?.debug?.log("CanvasManagement",`Destroyed canvas ${e} for system ${t}`)}}cleanupSystem(t){let e=this.systemCanvases.get(t);if(e){for(let i of e.keys())this.destroyCanvas(t,i);this.systemCanvases.delete(t)}}getCanvasCapabilities(){return{webgl2:this.capabilities.webgl2,webgl:!1,recommendedType:this.capabilities.recommendedType,maxTextureSize:2048,maxViewportDims:[2048,2048]}}getCanvasStats(t){let e=this.systemCanvases.get(t);if(!e)return null;let i=[],r=0;for(let a of e.values())i.push(a.type),r+=a.canvas.width*a.canvas.height*4;return{activeCanvases:e.size,totalMemoryUsage:r,contexts:i}}},it=class it{static getServices(){return it.services||(it.services={lifecycle:new ma,performance:new da,cssVariables:new ha,events:new ga,canvas:new pa}),it.services}static resetServices(){it.services=null}};it.services=null;Ti=it});var Gt,xi,fa=v(()=>{"use strict";B();R();te();us();Gt=class{constructor(t=w){this.initialized=!1;this.destroyed=!1;this._legacyPerformanceAnalyzer=null;this._legacyCSSController=null;this._legacyEventBus=null;this.config=t,this.systemName=this.constructor.name,this.services=Ti.getServices(),this.setupLegacyAdapters(),u?.debug?.log("ServiceSystemBase",`Created ${this.systemName} with service composition`)}get performanceAnalyzer(){return this._legacyPerformanceAnalyzer}get cssConsciousnessController(){return this._legacyCSSController}get eventBus(){return this._legacyEventBus}injectServices(t){this.services={...this.services,...t},this.setupLegacyAdapters()}getRequiredServices(){return["lifecycle","performance"]}getOptionalServices(){return["cssVariables","events","canvas"]}setupLegacyAdapters(){this.services.cssVariables&&(this._legacyCSSController={queueCSSVariableUpdate:(t,e)=>{this.services.cssVariables.queueUpdate(t,e)},queueBatchUpdate:t=>{this.services.cssVariables.queueBatchUpdate(t)},flushPendingUpdates:()=>{this.services.cssVariables.flushUpdates()}}),this.services.events&&(this._legacyEventBus={subscribe:(t,e)=>{this.services.events.subscribe(this.systemName,t,e)},emit:(t,e)=>{let i=globalThis.unifiedEventBus;if(i?.emit)i.emit(t,e);else{let r=new CustomEvent(t,{detail:e});document.dispatchEvent(r)}}})}async initialize(){if(!this.services.lifecycle)throw new Error(`${this.systemName}: Lifecycle service not available`);await this.services.lifecycle.initializeSystem(this.systemName,this.config,async()=>{await this._performSystemSpecificInitialization()}),this.initialized=!0}async healthCheck(){try{let t=await this.performSystemHealthCheck(),e=this.initialized&&!this.destroyed&&t.healthy;return{healthy:e,ok:e,system:this.systemName,details:t.details||`${this.systemName} system health check`,issues:t.issues||[],metrics:{initialized:this.initialized,destroyed:this.destroyed,...t.metrics}}}catch(t){return{healthy:!1,ok:!1,system:this.systemName,details:`Health check failed: ${t}`,issues:["Health check exception"],metrics:{error:String(t)}}}}destroy(){if(!this.services.lifecycle){u?.debug?.warn("ServiceSystemBase",`${this.systemName}: Lifecycle service not available for cleanup`);return}this.services.lifecycle.destroySystem(this.systemName,()=>{this._performSystemSpecificCleanup()}),this.services.events?.cleanupSystem(this.systemName),this.services.canvas?.cleanupSystem(this.systemName),this.destroyed=!0,this.initialized=!1}forceRepaint(t){u?.debug?.log("ServiceSystemBase",`${this.systemName} force repaint: ${t||"no reason"}`),this.services.cssVariables?.flushUpdates(),this.performSystemRepaint?.(t)}trackPerformance(t,e){return this.services.performance?this.services.performance.trackOperation(this.systemName,t,e):e()}async trackPerformanceAsync(t,e){return this.services.performance?await this.services.performance.trackOperationAsync(this.systemName,t,e):await e()}subscribeToEvent(t,e){this.services.events?.subscribe(this.systemName,t,e)}publishEvent(t,e){this._legacyEventBus?.emit(t,e)}updateCSSVariable(t,e){this.services.cssVariables?.queueUpdate(t,e)}updateCSSVariables(t){this.services.cssVariables?.queueBatchUpdate(t)}},xi=class extends Gt{constructor(e=w,i=k,r,a){super(e);this.activeCanvasResults=new Map;this.canvasCapabilities=null;this.utils=k;this.musicSyncService=null;this.isActive=!1;this.utils=i,this.musicSyncService=a||null,r&&(this._legacyPerformanceAnalyzer=r),this.services.canvas&&(this.canvasCapabilities=this.services.canvas.getCanvasCapabilities())}getRequiredServices(){return[...super.getRequiredServices(),"canvas"]}async createCanvas(e,i){if(!this.services.canvas)throw new Error(`${this.systemName}: Canvas service not available`);let r=await this.services.canvas.createCanvas(this.systemName,e,i);return this.activeCanvasResults.set(e,r),r}getCanvas(e){return this.services.canvas?.getCanvas(this.systemName,e)||null}resizeCanvas(e,i,r){return this.services.canvas?.resizeCanvas(this.systemName,e,i,r)||!1}handleSettingsChange(e){u?.debug?.log("ServiceVisualSystemBase",`${this.systemName} received settings change event`)}async _performSystemSpecificInitialization(){this.isActive=!0,this.services.events&&this.services.events.subscribeToDOM(this.systemName,document,"year3000SystemSettingsChanged",this.handleSettingsChange.bind(this)),await this.performVisualSystemInitialization()}_performSystemSpecificCleanup(){this.isActive=!1,this.services.canvas?.cleanupSystem(this.systemName),this.activeCanvasResults.clear(),this.performVisualSystemCleanup()}}});var Pi,ms=v(()=>{"use strict";fa();$();_();R();Pi=class extends xi{constructor(e){super(e);this.effectsState={energy:.5,valence:.5,tempo:120,harmonyHue:0,intensity:.8,lastUpdateTime:0,animationActive:!0,preferredMotion:!0,frameRate:60,lastFrameTime:0};this.updateInterval=0;this.eventDebounceTimers={musicEnergy:0,colorHarmony:0,beatSync:0,cssUpdate:0};this.eventDebounceMs=100;this.frameThrottleMs=16;this.lastCSSUpdateTime=0;this.previousCSSValues={energy:0,valence:0,harmonyHue:0,intensity:0,depth:0};this.cssChangeThreshold=.01}debouncedEventHandler(e,i){let r=performance.now();r-this.eventDebounceTimers[e]>=this.eventDebounceMs&&(i(),this.eventDebounceTimers[e]=r)}hasSignificantCSSChange(){let e=this.effectsState,i=1+e.energy*.5,r={energy:e.energy,valence:e.valence,harmonyHue:e.harmonyHue,intensity:e.intensity,depth:i};for(let[a,n]of Object.entries(r)){let s=this.previousCSSValues[a];if(Math.abs(n-s)>=this.cssChangeThreshold)return!0}return!1}updatePreviousCSSValues(){let e=this.effectsState,i=1+e.energy*.5;this.previousCSSValues.energy=e.energy,this.previousCSSValues.valence=e.valence,this.previousCSSValues.harmonyHue=e.harmonyHue,this.previousCSSValues.intensity=e.intensity,this.previousCSSValues.depth=i}batchApplyCSSUpdates(e,i="normal",r="header-effects"){let a={};for(let[n,s]of e)a[n]=s;this.cssController.batchSetVariables("HeaderVisualEffectsController",a,i,r)}scheduleEffectsUpdate(){this.debouncedEventHandler("cssUpdate",()=>{this.hasSignificantCSSChange()&&(this.updateHeaderEffectsVariables(),this.updatePreviousCSSValues())})}async performVisualSystemInitialization(){try{let e=globalThis.year3000System;this.cssController=e?.cssVariableController||A(),this.effectsState.preferredMotion=!window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.setupMusicEventListeners(),this.setupColorHarmonyListeners(),this.updateHeaderEffectsVariables(),this.effectsState.preferredMotion,this.setupPerformanceMonitoring(),u?.debug?.log("HeaderVisualEffectsController","Header visual effects initialization complete")}catch(e){u?.debug?.error("HeaderVisualEffectsController","Initialization failed:",e)}}setupMusicEventListeners(){p.subscribe("music:energy",e=>{this.debouncedEventHandler("musicEnergy",()=>{typeof e.energy=="number"&&(this.effectsState.energy=Math.max(0,Math.min(1,e.energy)),this.scheduleEffectsUpdate()),typeof e.tempo=="number"&&(this.effectsState.tempo=Math.max(60,Math.min(200,e.tempo)),this.updateAnimationSpeed()),typeof e.valence=="number"&&(this.effectsState.valence=Math.max(0,Math.min(1,e.valence)),this.scheduleEffectsUpdate())})},"HeaderVisualEffectsController"),p.subscribe("music:beat",e=>{this.debouncedEventHandler("beatSync",()=>{if(this.effectsState.animationActive){let i=e.intensity||.8;this.onBeatDetected(i)}})},"HeaderVisualEffectsController"),p.subscribe("music:energy-changed",e=>{this.debouncedEventHandler("musicEnergy",()=>{typeof e.energy=="number"&&(this.effectsState.energy=Math.max(0,Math.min(1,e.energy)),this.scheduleEffectsUpdate())})},"HeaderVisualEffectsController")}setupColorHarmonyListeners(){p.subscribe("colors:harmonized",e=>{this.debouncedEventHandler("colorHarmony",()=>{e.coordinationMetrics?.coordinationStrategy&&this.updateHarmonyHue(e.coordinationMetrics.coordinationStrategy)})},"HeaderVisualEffectsController"),p.subscribe("colors:extracted",e=>{this.debouncedEventHandler("colorHarmony",()=>{if(e.musicData&&typeof e.musicData.energy=="number"){let i=e.musicData.energy*360;this.effectsState.harmonyHue=i,this.scheduleEffectsUpdate()}})},"HeaderVisualEffectsController")}updateHarmonyHue(e){let r={monochromatic:0,complementary:180,triadic:120,analogous:30,tetradic:90,"split-complementary":150}[e]||0;this.effectsState.harmonyHue=r,this.scheduleEffectsUpdate()}onBeatDetected(e){let i=Math.min(1,this.effectsState.energy+e*.3);this.batchApplyCSSUpdates([["--header-effects-energy",i.toString()]],"high","beat-sync");let r=performance.now()+150,a=()=>{performance.now()>=r&&this.initialized?this.batchApplyCSSUpdates([["--header-effects-energy",this.effectsState.energy.toString()]],"normal","beat-reset"):this.initialized&&requestAnimationFrame(a)};requestAnimationFrame(a)}updateAnimationSpeed(){let r=8/(this.effectsState.tempo/120);this.batchApplyCSSUpdates([["--header-effects-flow-speed",`${Math.max(2,Math.min(16,r))}s`]],"high","tempo-sync")}updateHeaderEffectsVariables(){if(!this.initialized)return;let e=this.effectsState,i=e.intensity*(.6+e.valence*.4)*(.8+e.energy*.2),r=1+e.energy*.5;this.batchApplyCSSUpdates([["--header-effects-energy",e.energy.toString()],["--header-effects-harmony",`${e.harmonyHue}deg`],["--header-effects-intensity",i.toString()],["--header-effects-depth",r.toString()]],"normal","effects-update"),this.effectsState.lastUpdateTime=Date.now()}updateAnimation(e){if(!this.initialized||!this.effectsState.animationActive||!this.effectsState.preferredMotion)return;let i=performance.now();i-this.lastCSSUpdateTime<this.frameThrottleMs||(this.effectsState.frameRate=1e3/e,this.effectsState.lastFrameTime=i,i-this.effectsState.lastUpdateTime>100&&this.hasSignificantCSSChange()&&(this.updateHeaderEffectsVariables(),this.updatePreviousCSSValues()),this.lastCSSUpdateTime=i)}setupPerformanceMonitoring(){this.updateInterval=window.setInterval(()=>{this.initialized&&(this.effectsState.frameRate<30&&u?.debug?.warn("HeaderVisualEffectsController","Performance degradation detected, reducing update frequency"),this.cssController.setVariable("HeaderVisualEffectsController","--header-effects-performance",this.effectsState.frameRate>50?"1":"0.5","low","performance-monitor"))},2e3)}setEffectsIntensity(e){this.effectsState.intensity=Math.max(0,Math.min(1,e)),this.updateHeaderEffectsVariables()}setAnimationActive(e){this.effectsState.animationActive=e}getEffectsState(){return{...this.effectsState}}async performSystemHealthCheck(){let e=this.initialized&&this.effectsState.frameRate>20&&Date.now()-this.effectsState.lastUpdateTime<5e3;return{healthy:e,details:e?"Header visual effects controller operational":"Header visual effects controller degraded",issues:e?[]:[this.effectsState.frameRate<=20?"Low frame rate detected":"",Date.now()-this.effectsState.lastUpdateTime>=5e3?"No recent updates":""].filter(i=>i),metrics:{frameRate:this.effectsState.frameRate,energy:this.effectsState.energy,intensity:this.effectsState.intensity,animationActive:this.effectsState.animationActive,lastUpdate:this.effectsState.lastUpdateTime}}}performVisualSystemCleanup(){this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=0),p.unsubscribeAll("HeaderVisualEffectsController"),u?.debug?.log("HeaderVisualEffectsController","Header visual effects system cleaned up")}onAnimate(e){this.updateAnimation(e)}}});var Ce,Ee,Ie,rt,ba=v(()=>{"use strict";aa();Xn();_();R();Zn();as();ca();ns();ua();cs();ms();Ce={VISUAL_EFFECTS:"--sn-visual-effects-",VISUAL_STATE:"--sn-visual-state-",VISUAL_COORDINATION:"--sn-visual-coordination-",VISUAL_PERFORMANCE:"--sn-visual-performance-"},Ee={ENERGY_LEVEL:Ce.VISUAL_STATE+"energy-level",FLOW_DIRECTION_X:Ce.VISUAL_STATE+"flow-direction-x",FLOW_DIRECTION_Y:Ce.VISUAL_STATE+"flow-direction-y",COLOR_TEMPERATURE:Ce.VISUAL_STATE+"color-temperature",ADAPTIVE_QUALITY:Ce.VISUAL_PERFORMANCE+"adaptive-quality",PARTICIPANT_COUNT:Ce.VISUAL_COORDINATION+"participant-count",UPDATE_RATE:Ce.VISUAL_PERFORMANCE+"update-rate",PULSE_RATE:Ce.VISUAL_EFFECTS+"pulse-rate",TRANSITION_FLUIDITY:Ce.VISUAL_EFFECTS+"transition-fluidity",SYSTEM_HARMONY:Ce.VISUAL_EFFECTS+"system-harmony"},Ie=class Ie{constructor(t,e,i,r,a,n,s,l,c){this.initialized=!1;this.cssController=null;this.performanceCoordinator=null;this.musicSyncService=null;this.colorHarmonyEngine=null;this.colorProcessor=null;this.emotionalGradientMapper=null;this.currentVisualState=null;this.previousVisualState=null;this.fieldUpdateTimer=null;this.lastFieldUpdate=0;this.registeredParticipants=new Map;this.participantContributions=new Map;this.transitionConfig={enabled:!0,transitionDuration:1e3,easingFunction:"smooth",intensityFactor:1,coherenceThreshold:.3};this.isActive=!1;this.updateInterval=16;this.performanceMetrics={stateUpdates:0,coordinationEvents:0,animationTransitions:0,lastUpdate:0,averageUpdateTime:0};this.systemRegistry=new Map;this.systemInstances=new Map;this.systemDependencies=new Map;this.factoryConfig={mode:"progressive",enablePerformanceMonitoring:!0,enableAdaptiveQuality:!0,enableEventCoordination:!0,enableGradientTransitions:!0,performanceThresholds:{minFPS:45,maxMemoryMB:100,thermalThreshold:.7}};this.gradientEffectsState={liquidVisualEffects:!1,directionalFlow:!1,shimmerEffects:!1,depthLayers:!1,performanceOptimization:!0};this.gradientSystems=new Map;this.transitionQueue=[];this.currentBackend="css";this.transitionInProgress=!1;this.backendStabilityCheck=null;this.utils=null;this.year3000System=null;this.animationCoordinator=null;this.onSystemCreated=null;this.config=t,this.eventBus=p,this.cssController=e||null,this.performanceCoordinator=i||null,this.musicSyncService=r||null,this.colorHarmonyEngine=a||null,this.colorProcessor=n||null,this.utils=s||null,this.year3000System=l||null,this.animationCoordinator=c||null,this.cssController&&this.musicSyncService&&(this.emotionalGradientMapper=new pt(this.cssController,this.musicSyncService)),this.initializeFactoryRegistry(),this.initializeGradientSystems(),this.initializeTransitionManagement(),this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator","Enhanced visual effects coordinator created with consolidated functionality")}static getInstance(t,e,i,r,a,n,s,l){if(!Ie.instance){if(!t)throw new Error("VisualEffectsCoordinator requires configuration for first initialization");Ie.instance=new Ie(t,e,i,r,a,n,s,l)}return Ie.instance}async initialize(t){if(!this.initialized)try{t&&this.setConfiguration(t),this.emotionalGradientMapper&&await this.emotionalGradientMapper.initialize(),this.currentVisualState=this.createInitialVisualState(),this.startVisualEffectsUpdates(),this.subscribeToEvents(),this.initialized=!0,this.isActive=!0,this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator","Visual effects coordinator initialized")}catch(e){throw u?.debug?.error("VisualEffectsCoordinator","Failed to initialize:",e),e}}updateAnimation(t){this.performanceMetrics.lastUpdate=performance.now()}async healthCheck(){let t=this.registeredParticipants.size,e=this.currentVisualState?performance.now()-this.currentVisualState.timestamp:0,i=this.isActive&&e<1e3&&t>0;return{system:"VisualEffectsCoordinator",healthy:i,ok:i,details:i?"Visual effects coordination active":"Visual effects state inactive or stale",metrics:{isActive:this.isActive,participantCount:t,fieldAge:e,stateUpdates:this.performanceMetrics.stateUpdates,coordinationEvents:this.performanceMetrics.coordinationEvents,animationTransitions:this.performanceMetrics.animationTransitions,averageUpdateTime:this.performanceMetrics.averageUpdateTime}}}destroy(){this.fieldUpdateTimer&&(clearTimeout(this.fieldUpdateTimer),this.fieldUpdateTimer=null),this.unsubscribeFromEvents(),this.emotionalGradientMapper&&(this.emotionalGradientMapper.destroy(),this.emotionalGradientMapper=null),this.registeredParticipants.clear(),this.participantContributions.clear(),this.currentVisualState=null,this.previousVisualState=null,this.isActive=!1,this.initialized=!1,Ie.instance===this&&(Ie.instance=null),this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator","Visual effects coordinator destroyed")}createInitialVisualState(){let t=this.performanceCoordinator?.getDeviceCapabilities()||{performanceTier:"medium",memoryGB:4,cpuCores:2,gpuAcceleration:!1,isMobile:!1,supportsWebGL:!1,supportsBackdropFilter:!1,maxTextureSize:2048,devicePixelRatio:1},e=this.performanceCoordinator?.getCurrentPerformanceMode()||{name:"balanced",qualityLevel:.7,animationQuality:.7,effectQuality:.7,blurQuality:.7,shadowQuality:.7,frameRate:60,optimizationLevel:1};return{musicIntensity:.5,flowDirection:{x:0,y:0},energyLevel:.5,colorTemperature:6500,tempoModulation:1,harmonicComplexity:.5,fluidIntensity:1,depthPerception:.7,luminosity:t.gpuAcceleration?1.2:.8,colorHarmony:.6,visualCoherence:.8,pulseRate:2,transitionFluidity:.5,scalingFactor:1,effectDepth:.6,systemHarmony:.7,deviceCapabilities:t,performanceMode:e,adaptiveQuality:e.qualityLevel,thermalState:0,batteryConservation:0,timestamp:performance.now(),evolutionPhase:0,continuityIndex:1}}updateVisualEffectsState(){let t=performance.now();if(!this.currentVisualState){this.currentVisualState=this.createInitialVisualState();return}this.previousVisualState={...this.currentVisualState};let e=this.evolveVisualState(this.currentVisualState);this.transitionConfig.enabled?this.currentVisualState=this.applyDynamicTransition(this.currentVisualState,e):this.currentVisualState=e,this.applyStandardizedVisualVariables().catch(a=>{u?.debug?.error("VisualEffectsCoordinator","Failed to apply CSS variables:",a)});let i=this.choreographVisualEffectsUpdate();!i.success&&this.config.enableDebug&&u?.debug?.warn("VisualEffectsCoordinator",`Visual effects update had ${i.errorCount} errors, notified ${i.participantsNotified} participants`);let r=performance.now()-t;this.performanceMetrics.stateUpdates++,this.performanceMetrics.averageUpdateTime=(this.performanceMetrics.averageUpdateTime+r)/2,this.config.enableDebug&&this.performanceMetrics.stateUpdates%60===0&&u?.debug?.log("VisualEffectsCoordinator",`Visual effects state evolved - Update #${this.performanceMetrics.stateUpdates}, avg time: ${this.performanceMetrics.averageUpdateTime.toFixed(2)}ms`)}evolveVisualState(t){let e={...t};return e.timestamp=performance.now(),e.evolutionPhase=Math.min(1,e.evolutionPhase+.001),this.updateFromMusicAnalysis(e),this.integrateParticipantContributions(e),this.applyAnimationTransitions(e),this.updatePerformanceAwareness(e),this.previousVisualState&&(e.continuityIndex=this.calculateContinuityIndex(this.previousVisualState,e)),e}updateFromMusicAnalysis(t){if(this.emotionalGradientMapper){let e=this.emotionalGradientMapper.getCurrentEmotionalProfile();if(e){t.pulseRate=e.energy,t.energyLevel=e.arousal,t.colorTemperature=3e3+e.valence*1e4,t.harmonicComplexity=e.complexity;let i={euphoric:{x:1,y:1},aggressive:{x:-1,y:1},peaceful:{x:0,y:-.5},melancholic:{x:-.5,y:-1},mysterious:{x:.7,y:0},contemplative:{x:0,y:.3}};t.flowDirection=i[e.mood]||{x:0,y:0},t.tempoModulation=.5+e.energy*1.5}}this.musicSyncService}integrateParticipantContributions(t){if(this.participantContributions.size===0)return;let e=0,i=[];for(let[r,a]of this.participantContributions)i.push(a),e+=1;if(e>0)for(let r of i)r.fluidIntensity!==void 0&&(t.fluidIntensity=this.dynamicBlend(t.fluidIntensity,r.fluidIntensity,.1)),r.depthPerception!==void 0&&(t.depthPerception=this.dynamicBlend(t.depthPerception,r.depthPerception,.1)),r.luminosity!==void 0&&(t.luminosity=this.dynamicBlend(t.luminosity,r.luminosity,.1))}applyAnimationTransitions(t){let i=performance.now()/1e3%t.pulseRate/t.pulseRate,r=Math.sin(i*Math.PI*2)*.1;t.scalingFactor+=r,t.transitionFluidity=Math.max(0,Math.min(1,t.transitionFluidity+r*.5)),t.effectDepth=Math.max(0,Math.min(1,t.effectDepth+t.evolutionPhase*.001)),t.systemHarmony=Math.max(0,Math.min(1,(t.visualCoherence+t.continuityIndex)/2))}updatePerformanceAwareness(t){if(this.performanceCoordinator){t.deviceCapabilities=this.performanceCoordinator.getDeviceCapabilities(),t.performanceMode=this.performanceCoordinator.getCurrentPerformanceMode(),t.adaptiveQuality=t.performanceMode.qualityLevel;let e=this.performanceCoordinator.getThermalState(),i=this.performanceCoordinator.getBatteryState();t.thermalState=e.throttleLevel||0,t.batteryConservation=i&&!i.charging?(1-i.level)*.5:0}}calculateContinuityIndex(t,e){let i=[Math.abs(t.pulseRate-e.pulseRate),Math.abs(t.energyLevel-e.energyLevel),Math.abs(t.fluidIntensity-e.fluidIntensity),Math.abs(t.depthPerception-e.depthPerception),Math.abs(t.luminosity-e.luminosity)],r=i.reduce((a,n)=>a+n,0)/i.length;return Math.max(0,Math.min(1,1-r))}applyDynamicTransition(t,e){let i=this.calculateDynamicTransitionSpeed(t,e),r=this.applyDynamicEasing(i);return this.blendVisualStates(t,e,r)}applySmoothTransition(t,e){return this.applyDynamicTransition(t,e)}calculateDynamicTransitionSpeed(t,e){let i=.016666666666666666,r=1+Math.sin(performance.now()/1e3/t.pulseRate*Math.PI*2)*.2,a=.5+t.energyLevel*1.5;return i*r*a*this.transitionConfig.intensityFactor}calculateSmoothTransitionSpeed(t,e){return this.calculateDynamicTransitionSpeed(t,e)}applyDynamicEasing(t){switch(this.transitionConfig.easingFunction){case"smooth":return t*t*(3-2*t);case"harmonic":return(Math.sin((t-.5)*Math.PI)+1)/2;case"exponential":return t*t;case"cubic":return t*t*t;default:return t}}applySmoothEasing(t){return this.applyDynamicEasing(t)}blendVisualStates(t,e,i){let r={...t};return r.pulseRate=this.dynamicBlend(t.pulseRate,e.pulseRate,i),r.energyLevel=this.dynamicBlend(t.energyLevel,e.energyLevel,i),r.colorTemperature=this.dynamicBlend(t.colorTemperature,e.colorTemperature,i),r.fluidIntensity=this.dynamicBlend(t.fluidIntensity,e.fluidIntensity,i),r.depthPerception=this.dynamicBlend(t.depthPerception,e.depthPerception,i),r.luminosity=this.dynamicBlend(t.luminosity,e.luminosity,i),r.colorHarmony=this.dynamicBlend(t.colorHarmony,e.colorHarmony,i),r.visualCoherence=this.dynamicBlend(t.visualCoherence,e.visualCoherence,i),r.transitionFluidity=this.dynamicBlend(t.transitionFluidity,e.transitionFluidity,i),r.scalingFactor=this.dynamicBlend(t.scalingFactor,e.scalingFactor,i),r.effectDepth=this.dynamicBlend(t.effectDepth,e.effectDepth,i),r.systemHarmony=this.dynamicBlend(t.systemHarmony,e.systemHarmony,i),r.tempoModulation=this.dynamicBlend(t.tempoModulation,e.tempoModulation,i),r.harmonicComplexity=this.dynamicBlend(t.harmonicComplexity,e.harmonicComplexity,i),r.adaptiveQuality=this.dynamicBlend(t.adaptiveQuality,e.adaptiveQuality,i),r.flowDirection={x:this.dynamicBlend(t.flowDirection.x,e.flowDirection.x,i),y:this.dynamicBlend(t.flowDirection.y,e.flowDirection.y,i)},r.timestamp=performance.now(),r.continuityIndex=t.continuityIndex,r}dynamicBlend(t,e,i){return t+(e-t)*i}smoothBlend(t,e,i){return this.dynamicBlend(t,e,i)}registerVisualEffectsParticipant(t){try{if(this.registeredParticipants.has(t.systemName))return{success:!1,participantName:t.systemName,contributionReceived:!1,errorMessage:`Participant '${t.systemName}' is already registered`};this.registeredParticipants.set(t.systemName,t);let e=!1;try{let i=t.getVisualContribution();this.participantContributions.set(t.systemName,i),e=!0}catch(i){u?.debug?.warn("VisualEffectsCoordinator",`Failed to get initial contribution from ${t.systemName}:`,i)}return this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Registered participant: ${t.systemName}`),{success:!0,participantName:t.systemName,contributionReceived:e}}catch(e){let i=e instanceof Error?e.message:"Unknown registration error";return u?.debug?.error("VisualEffectsCoordinator",`Failed to register participant ${t.systemName}:`,e),{success:!1,participantName:t.systemName,contributionReceived:!1,errorMessage:i}}}unregisterVisualEffectsParticipant(t){this.registeredParticipants.delete(t),this.participantContributions.delete(t),this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Unregistered participant: ${t}`)}updateParticipantContribution(t,e){this.registeredParticipants.has(t)&&this.participantContributions.set(t,e)}choreographVisualEffectsUpdate(){let t=performance.now(),e=0,i=0;if(!this.currentVisualState)return{success:!1,participantsNotified:0,updateDuration:0,continuityIndex:0,errorCount:1};try{this.eventBus.emit("visual-effects:field-updated",{rhythmicPulse:this.currentVisualState.pulseRate,musicalFlow:this.currentVisualState.flowDirection,energyResonance:this.currentVisualState.energyLevel,depthPerception:this.currentVisualState.depthPerception,pulsingCycle:this.currentVisualState.pulseRate})}catch(a){u?.debug?.error("VisualEffectsCoordinator","Error broadcasting visual effects state update:",a),i++}for(let a of this.registeredParticipants.values())try{a.onVisualStateUpdate(this.currentVisualState),e++}catch(n){u?.debug?.error("VisualEffectsCoordinator",`Error updating participant ${a.systemName}:`,n),i++}this.performanceMetrics.coordinationEvents++;let r=performance.now()-t;return{success:i===0,participantsNotified:e,updateDuration:r,continuityIndex:this.currentVisualState.continuityIndex,errorCount:i}}choreographEvent(t,e){if(t&&typeof t=="string")try{let i=this.mapChoreographyEventToUnified(t);i&&this.eventBus.emit(i.eventName,i.payload)}catch{this.eventBus.emit(`visual-effects:${t}`,e)}for(let i of this.registeredParticipants.values())try{t.startsWith("visual:")?i.onVisualEffectEvent(t,e):i.onVisualEffectEvent("visual:coordination",{...e,originalEventType:t})}catch(r){u?.debug?.error("VisualEffectsCoordinator",`Error sending choreography event to ${i.systemName}:`,r)}this.performanceMetrics.coordinationEvents++,this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Choreographed event: ${t}`,e)}startVisualEffectsUpdates(){if(this.fieldUpdateTimer)return;let t=()=>{this.isActive&&(this.updateVisualEffectsState(),this.fieldUpdateTimer=setTimeout(t,this.updateInterval))};t(),this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Started visual effects state updates (${this.updateInterval}ms interval)`)}subscribeToEvents(){this.musicSyncService&&(this.eventBus.subscribe("music:track-changed",t=>{this.choreographEvent("rhythm-shift",{newTrack:t,transitionType:"smooth"})},"VisualEffectsCoordinator"),this.eventBus.subscribe("music:emotion-analyzed",t=>{this.choreographEvent("intensity-peak",{intensity:t?.energy||.5,affectedSystems:["all"],surgeType:"full-spectrum",duration:1e3,falloffCurve:"smooth"})},"VisualEffectsCoordinator")),this.performanceCoordinator&&this.eventBus.subscribe("performance:tier-changed",t=>{this.choreographEvent("genre-transition",{newMode:t||{name:"auto",qualityLevel:.8,frameRate:60,optimizationLevel:.5},adaptationType:"smooth",reason:"automatic",affectedSystems:["all"]})},"VisualEffectsCoordinator"),this.eventBus.subscribe("settings:visual-guide-changed",t=>{(t?.key?.includes("visual-effects")||t?.key?.includes("choreography"))&&this.updateDynamicTransitionConfig(t)},"VisualEffectsCoordinator")}unsubscribeFromEvents(){}mapChoreographyEventToUnified(t){switch(t){case"rhythm-shift":return{eventName:"visual-effects:coordination",payload:{source:"choreographer",type:"rhythm-shift"}};case"intensity-peak":return{eventName:"visual-effects:intensity-changed",payload:{intensity:.8,userEngagement:.6,timestamp:Date.now()}};case"genre-transition":return{eventName:"visual-effects:coordination",payload:{source:"choreographer",type:"genre-transition"}};case"emotional-shift":return{eventName:"visual-effects:coordination",payload:{source:"choreographer",type:"emotional-shift"}};default:return{eventName:"visual-effects:coordination",payload:{source:"choreographer",type:t}}}}updateDynamicTransitionConfig(t){let{key:e,value:i}=t;if(e.includes("transition-intensity"))this.transitionConfig.intensityFactor=Math.max(0,Math.min(2,parseFloat(i)||1));else if(e.includes("transition-duration"))this.transitionConfig.transitionDuration=Math.max(100,Math.min(5e3,parseInt(i)||1e3));else if(e.includes("animation-cycle")){let r=Math.max(.5,Math.min(4,parseFloat(i)||2));this.currentVisualState&&(this.currentVisualState.pulseRate=r)}this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Updated dynamic transition config: ${e} = ${i}`)}updateSmoothTransitionConfig(t){return this.updateDynamicTransitionConfig(t)}async applyStandardizedVisualVariables(t){if(!this.currentVisualState)return;let e=t||document.documentElement,i=this.currentVisualState,r={[Ee.ENERGY_LEVEL]:i.energyLevel.toFixed(3),[Ee.FLOW_DIRECTION_X]:i.flowDirection.x.toFixed(3),[Ee.FLOW_DIRECTION_Y]:i.flowDirection.y.toFixed(3),[Ee.COLOR_TEMPERATURE]:i.colorTemperature.toString(),[Ee.ADAPTIVE_QUALITY]:i.adaptiveQuality.toFixed(3),[Ee.PARTICIPANT_COUNT]:this.registeredParticipants.size.toString(),[Ee.UPDATE_RATE]:(1e3/this.updateInterval).toString(),[Ee.PULSE_RATE]:i.pulseRate.toFixed(3),[Ee.TRANSITION_FLUIDITY]:i.transitionFluidity.toFixed(3),[Ee.SYSTEM_HARMONY]:i.systemHarmony.toFixed(3)};if(this.cssController)for(let[a,n]of Object.entries(r))await this.cssController.setVariable("VisualEffectsCoordinator",a,n,"normal","standardized-vars");else for(let[a,n]of Object.entries(r))e.style.setProperty(a,n);this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Applied ${Object.keys(r).length} standardized visual effect CSS variables`)}getCurrentVisualEffectsState(){return this.currentVisualState?{...this.currentVisualState}:null}getRegisteredParticipants(){return Array.from(this.registeredParticipants.keys())}updateDynamicTransitionConfiguration(t){this.transitionConfig={...this.transitionConfig,...t},this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator","Updated dynamic transition configuration:",t)}updateSmoothTransitionConfiguration(t){return this.updateDynamicTransitionConfiguration(t)}forceVisualEffectsStateUpdate(){this.updateVisualEffectsState()}getPerformanceMetrics(){return{...this.performanceMetrics}}initializeFactoryRegistry(){this.systemRegistry.set("SidebarVisualEffects",Ft),this.systemDependencies.set("SidebarVisualEffects",["eventBus","musicSyncService"]),this.systemRegistry.set("UIVisualEffects",Mi),this.systemDependencies.set("UIVisualEffects",["eventBus","musicSyncService","cssVariableController"]),this.systemRegistry.set("HeaderVisualEffects",Pi),this.systemDependencies.set("HeaderVisualEffects",["eventBus","musicSyncService","colorHarmonyEngine"]),this.systemRegistry.set("WebGLBackground",bt),this.systemDependencies.set("WebGLBackground",["performanceAnalyzer","eventBus"]),this.systemRegistry.set("FluidGradient",Ei),this.systemDependencies.set("FluidGradient",["performanceAnalyzer","musicSyncService","cssVariableController"]),this.systemRegistry.set("DepthLayers",Ci),this.systemDependencies.set("DepthLayers",["performanceAnalyzer","musicSyncService","cssVariableController"]),this.systemRegistry.set("IridescentShimmer",wi),this.systemDependencies.set("IridescentShimmer",["performanceAnalyzer","musicSyncService","cssVariableController"]),this.systemRegistry.set("DirectionalFlow",Si),this.systemDependencies.set("DirectionalFlow",["performanceAnalyzer","musicSyncService","cssVariableController"])}initializeGradientSystems(){this.gradientEffectsState={liquidVisualEffects:!1,directionalFlow:!1,shimmerEffects:!1,depthLayers:!1,performanceOptimization:!0}}initializeTransitionManagement(){this.currentBackend="css",this.transitionInProgress=!1,this.transitionQueue=[]}async createVisualSystem(t,e=!1){try{let i=t;if(!e&&this.systemInstances.has(i))return this.systemInstances.get(i)||null;let r=this.systemRegistry.get(t);if(!r)return console.warn(`Visual system '${t}' not found in registry`),null;let a=this.resolveDependencies(i),n=new r(...a);return n.initialize&&await n.initialize(),this.systemInstances.set(i,n),this.onSystemCreated&&this.onSystemCreated(t,n),this.config.enableDebug&&u?.debug?.log("VisualSystemFactory",`Created visual system: ${t}`),n}catch(i){return console.error(`Failed to create visual system '${t}':`,i),null}}async orchestrateGradientEffects(t){try{if(this.gradientEffectsState={...this.gradientEffectsState,...t},t.liquidVisualEffects){let e=await this.createVisualSystem("FluidGradient");e&&this.gradientSystems.set("FluidGradient",e)}if(t.depthLayers){let e=await this.createVisualSystem("DepthLayers");e&&this.gradientSystems.set("DepthLayers",e)}if(t.shimmerEffects){let e=await this.createVisualSystem("IridescentShimmer");e&&this.gradientSystems.set("IridescentShimmer",e)}if(t.directionalFlow){let e=await this.createVisualSystem("DirectionalFlow");e&&this.gradientSystems.set("DirectionalFlow",e)}this.config.enableDebug&&u?.debug?.log("GradientOrchestration","Gradient effects orchestrated",this.gradientEffectsState)}catch(e){console.error("Failed to orchestrate gradient effects:",e)}}async coordinateBackendTransition(t,e={}){if(!(this.transitionInProgress||this.currentBackend===t))try{this.transitionInProgress=!0;let i={mode:e.mode||"crossfade",duration:e.duration||1e3,easing:e.easing||"ease-in-out",preserveState:e.preserveState??!0,fallbackDelay:e.fallbackDelay||5e3};this.transitionQueue.push({from:this.currentBackend,to:t,config:i,startTime:Date.now()}),t==="webgl"?await this.transitionToWebGL(i):t==="css"?await this.transitionToCSS(i):t==="hybrid"&&await this.transitionToHybrid(i),this.currentBackend=t,this.transitionInProgress=!1,this.config.enableDebug&&u?.debug?.log("TransitionCoordination",`Transitioned to ${t} backend`)}catch(i){console.error("Backend transition failed:",i),this.transitionInProgress=!1}}async getConsolidatedHealthCheck(){let t=new Map;for(let[a,n]of this.systemInstances)try{let s=n.healthCheck?await n.healthCheck():{healthy:!0,details:"No health check method"};t.set(a,{ok:s.healthy,details:s.details||"OK"})}catch(s){t.set(a,{ok:!1,details:`Health check failed: ${s}`})}for(let[a,n]of this.gradientSystems)try{let s=n.healthCheck?await n.healthCheck():{healthy:!0,details:"No health check method"};t.set(`gradient-${a}`,{ok:s.healthy,details:s.details||"OK"})}catch(s){t.set(`gradient-${a}`,{ok:!1,details:`Health check failed: ${s}`})}let e=Array.from(t.values()).filter(a=>!a.ok),i=e.length===0?"excellent":e.length<=2?"good":e.length<=5?"degraded":"critical",r=[];return e.length>0&&r.push(`${e.length} systems require attention`),this.transitionQueue.length>3&&r.push("High transition queue - consider reducing visual complexity"),{overall:i,systems:t,gradientEffects:this.gradientEffectsState,transitions:{activeTransitions:this.transitionQueue.length,backendStability:!this.transitionInProgress},recommendations:r,timestamp:Date.now()}}resolveDependencies(t){let e=this.systemDependencies.get(t)||[],i=[];for(let r of e)switch(r){case"eventBus":i.push(this.eventBus);break;case"musicSyncService":i.push(this.musicSyncService);break;case"cssVariableController":i.push(this.cssController);break;case"colorHarmonyEngine":i.push(this.colorHarmonyEngine);break;case"performanceAnalyzer":i.push(this.performanceCoordinator);break;default:i.push(null)}return i}async transitionToWebGL(t){let e=await this.createVisualSystem("WebGLBackground");e&&e.initialize&&await e.initialize()}async transitionToCSS(t){let e=await this.createVisualSystem("FluidGradient");e&&e.initialize&&await e.initialize()}async transitionToHybrid(t){await Promise.all([this.transitionToCSS(t),this.transitionToWebGL(t)])}registerConsciousnessParticipant(t){return this.registerVisualEffectsParticipant(t)}unregisterConsciousnessParticipant(t){this.unregisterVisualEffectsParticipant(t)}getCurrentConsciousnessField(){return this.getCurrentVisualEffectsState()}forceConsciousnessFieldUpdate(){this.forceVisualEffectsStateUpdate()}registerBackgroundSystemParticipant(t){return this.registerVisualEffectsParticipant(t)}unregisterBackgroundSystemParticipant(t){this.unregisterVisualEffectsParticipant(t)}getCurrentBackgroundState(){return this.getCurrentVisualEffectsState()}choreographBackgroundEvent(t,e){return this.choreographEvent(t,e)}setOnSystemCreated(t){this.onSystemCreated=t}propagateVisualEvent(t){let e=t.type||t.eventType||"visual:coordination",i={...t,originalEventType:t.type,metadata:t.data||t.payload||{}};this.choreographEvent(e,i)}handleAdaptationEvent(t){if(this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Handling adaptation event: ${t.type}`,t.reason),t.newSettings){let e=t.newSettings.level||"medium",i=t.newSettings.gradientComplexity||.7;this.factoryConfig={...this.factoryConfig,enableAdaptiveQuality:!0,performanceThresholds:{minFPS:t.newSettings.animationFPS||45,maxMemoryMB:this.factoryConfig.performanceThresholds?.maxMemoryMB||512,thermalThreshold:this.factoryConfig.performanceThresholds?.thermalThreshold||.8}}}this.registeredParticipants.forEach(e=>{if(e.handleAdaptationEvent)try{e.handleAdaptationEvent(t)}catch(i){u?.debug?.warn("VisualEffectsCoordinator",`Error propagating adaptation to ${e.systemName}:`,i)}}),this.systemInstances.forEach((e,i)=>{if(e.handleAdaptationEvent)try{e.handleAdaptationEvent(t)}catch(r){u?.debug?.warn("VisualEffectsCoordinator",`Error propagating adaptation to system ${i}:`,r)}}),this.choreographEvent("visual:performance-adapt",{adaptationType:t.type,reason:t.reason?t.reason:"automatic",metadata:t.newSettings})}setConfiguration(t){this.factoryConfig={...this.factoryConfig,...t},this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator","Configuration updated",this.factoryConfig)}getMetrics(){return{currentFPS:this.performanceCoordinator?.getMedianFPS?.()||60,averageFPS:this.performanceCoordinator?.getMedianFPS?.()||60,frameTime:16.67,memoryUsageMB:0,activeSystems:this.systemInstances.size,gradientBackend:this.currentBackend,transitionCount:this.performanceMetrics.animationTransitions,performanceScore:.8,systemHealth:"excellent"}}getWebGLGradientStrategy(){return this.systemInstances.get("WebGLBackground")||null}async getVisualSystem(t){return this.systemInstances.has(t)?this.systemInstances.get(t):await this.createVisualSystem(t,!1)}getCachedVisualSystem(t){return this.systemInstances.get(t)||null}async performVisualHealthCheck(){return await this.getConsolidatedHealthCheck()}async initializeVisualSystems(){let t=[];for(let[e,i]of this.systemInstances)i.initialized||t.push(i.initialize().catch(r=>{u?.debug?.error("VisualEffectsCoordinator",`Failed to initialize ${e}:`,r)}));await Promise.allSettled(t),this.config.enableDebug&&u?.debug?.log("VisualEffectsCoordinator",`Visual systems initialized: ${this.systemInstances.size} systems`)}getSystemStatus(){return{initialized:this.initialized,systemsActive:this.systemInstances.size,healthy:this.initialized&&this.isActive}}};Ie.instance=null;rt=Ie});var Ai,ds=v(()=>{"use strict";Dt();B();R();Xe();ue();Ai=class{constructor(t=w.enableDebug){this.coordinationCache=new Map;this.cacheMaxSize=20;this.cacheTimeoutMs=3e5;this.enableDebug=t,this.oklabProcessor=new T(t),this.emotionalMapper=new se(t),this.genreManager=new ye({ADVANCED_SYSTEM_CONFIG:w}),this.enableDebug&&u?.debug?.log("MusicalOKLABProcessor","Unified music-to-OKLAB coordinator initialized")}async processMusicalColors(t,e={}){let i=performance.now(),r=this.generateCacheKey(t),a=this.coordinationCache.get(r);if(a)return this.enableDebug&&u?.debug?.log("MusicalOKLABProcessor","Using cached processing result",{cacheKey:r}),a;try{let n=this.determineProcessingStrategy(t,e),s=await this.getOptimalOKLABPreset(t,n,e),l=await this.processColorsWithMusicalContext(t.rawColors,t.musicData,s),c=this.emotionalMapper.mapMusicToEmotionalTemperature(t.musicData),m=this.genreManager.detectGenre(t.musicData),d=this.genreManager.getColorCharacteristicsForGenre(m),h=this.calculateMusicInfluenceStrength(t.musicData,c),g=this.generateUnifiedCSSVariables(l,c,d,s,m,n),{accentHex:f,accentRgb:S}=this.selectOptimalAccentColor(l);g["--sn-accent-hex"]=f||"var(--sn-brightness-adjusted-accent-hex, #cba6f7)",g["--sn-accent-rgb"]=S||"var(--sn-brightness-adjusted-accent-rgb, 203, 166, 247)";let C=performance.now()-i,x={enhancedColors:Object.fromEntries(Object.entries(l).map(([M,V])=>[M,V.enhancedHex])),accentHex:f,accentRgb:S,oklabPreset:s,oklabResults:l,detectedGenre:m,emotionalResult:c,genreCharacteristics:d,processingTime:C,musicInfluenceStrength:h,processingStrategy:n,cssVariables:g};return this.cacheResult(r,x),this.enableDebug&&u?.debug?.log("MusicalOKLABProcessor","Musical OKLAB processing completed",{genre:m,emotion:c.primaryEmotion,strategy:n,preset:s.name,processingTime:C,colorCount:Object.keys(l).length}),x}catch(n){return this.enableDebug&&u?.debug?.error("MusicalOKLABProcessor","Musical processing failed:",n),this.createFallbackResult(t,performance.now()-i)}}determineProcessingStrategy(t,e){let{musicData:i}=t;if(!i||typeof i.energy!="number"||typeof i.valence!="number")return"fallback";if(e.preferGenreOverEmotion===!0)return"genre-primary";if(e.preferGenreOverEmotion===!1)return"emotion-primary";let r=Math.abs(i.energy-.5)*2,a=Math.abs(i.valence-.5)*2;return(r+a)/2>.6?"emotion-primary":this.genreManager.detectGenre(i)!=="default"?"genre-primary":"balanced"}async getOptimalOKLABPreset(t,e,i){let{musicData:r}=t;try{let a;switch(e){case"genre-primary":a=this.genreManager.getOKLABPresetForTrack(r);break;case"emotion-primary":a=this.emotionalMapper.mapMusicToEmotionalTemperature(r).oklabPreset;break;case"balanced":let s=this.genreManager.getOKLABPresetForTrack(r),l=this.emotionalMapper.mapMusicToEmotionalTemperature(r);a=this.processBlendedPresets(s,l.oklabPreset,i.intensityMultiplier||1);break;default:a=T.getPreset("STANDARD")}return a}catch(a){return this.enableDebug&&u?.debug?.warn("MusicalOKLABProcessor","Failed to get optimal preset, using STANDARD:",a),T.getPreset("STANDARD")}}processBlendedPresets(t,e,i){let r=(t.chromaBoost+e.chromaBoost)/2*i,a=(t.lightnessBoost+e.lightnessBoost)/2,n=(t.shadowReduction+e.shadowReduction)/2,s=(t.vibrantThreshold+e.vibrantThreshold)/2;return T.createCustomPreset("blended-genre-emotion",`Blended ${t.name} + ${e.name}`,a,r,n,s)}async processColorsWithMusicalContext(t,e,i){let r={};for(let[a,n]of Object.entries(t))if(!(!n||typeof n!="string"||!n.startsWith("#")))try{let s=this.oklabProcessor.processColor(n,i);r[a]=s}catch(s){this.enableDebug&&u?.debug?.warn("MusicalOKLABProcessor",`Failed to process color ${a}:`,s)}return r}calculateMusicInfluenceStrength(t,e){let i=t.energy||.5,r=Math.abs((t.valence||.5)-.5)*2,a=e.intensity,n=(i+r+a)/3,s=1;return t.tempo&&t.tempo>0&&(s+=.1),t.danceability&&t.danceability>.7&&(s+=.1),t.genre&&t.genre!=="default"&&(s+=.1),Math.min(1,n*s)}generateUnifiedCSSVariables(t,e,i,r,a,n){let s={};return Object.entries(t).forEach(([l,c])=>{s[`--sn-${l.toLowerCase()}-enhanced`]=c.enhancedHex,s[`--sn-${l.toLowerCase()}-oklab-l`]=c.oklabEnhanced.L.toFixed(3),s[`--sn-${l.toLowerCase()}-oklab-a`]=c.oklabEnhanced.a.toFixed(3),s[`--sn-${l.toLowerCase()}-oklab-b`]=c.oklabEnhanced.b.toFixed(3),s[`--sn-${l.toLowerCase()}-oklch-c`]=c.oklchEnhanced.C.toFixed(3),s[`--sn-${l.toLowerCase()}-oklch-h`]=c.oklchEnhanced.H.toFixed(1),s[`--sn-${l.toLowerCase()}-shadow`]=c.shadowHex}),Object.entries(e.cssVariables).forEach(([l,c])=>{s[l]=c}),s["--sn-color-processing-strategy"]=n,s["--sn-detected-genre"]=a,s["--sn-emotional-state"]=e.primaryEmotion,s["--sn-active-oklab-preset"]=r.name,s["--sn-color-temperature"]=i?i.colorTemperature:"neutral",s["--sn-emotional-range"]=i?i.emotionalRange:"moderate",s["--sn-oklab-preset-name"]=r.name,s["--sn-oklab-chroma-boost"]=r.chromaBoost.toString(),s["--sn-oklab-lightness-boost"]=r.lightnessBoost.toString(),s["--sn-musical-oklab-processing"]="enabled",s["--sn-color-processing-mode"]="unified-musical-oklab",s}selectOptimalAccentColor(t){let e=["VIBRANT","PROMINENT","DARK_VIBRANT","LIGHT_VIBRANT"];for(let r of e)if(t[r]){let a=t[r];return{accentHex:a.enhancedHex,accentRgb:`${a.enhancedRgb.r},${a.enhancedRgb.g},${a.enhancedRgb.b}`}}let i=Object.values(t)[0];return i?{accentHex:i.enhancedHex,accentRgb:`${i.enhancedRgb.r},${i.enhancedRgb.g},${i.enhancedRgb.b}`}:{accentHex:"#cba6f7",accentRgb:"203,166,247"}}createFallbackResult(t,e){let i=T.getPreset("STANDARD");return{enhancedColors:t.rawColors,accentHex:"#cba6f7",accentRgb:"203,166,247",oklabPreset:i,oklabResults:{},detectedGenre:"default",emotionalResult:{primaryEmotion:"calm",intensity:.5,temperature:3500,blendRatio:1,cssClass:"smooth-emotion-calm",cssVariables:{},oklabPreset:i},genreCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"},processingTime:e,musicInfluenceStrength:.5,processingStrategy:"fallback",cssVariables:{"--sn-musical-oklab-processing":"fallback","--sn-oklab-preset-name":"STANDARD"}}}generateCacheKey(t){return`${t.trackUri}-${t.timestamp}-${JSON.stringify(t.musicData)}`}cacheResult(t,e){if(this.coordinationCache.size>=this.cacheMaxSize){let i=this.coordinationCache.keys().next().value;i&&this.coordinationCache.delete(i)}this.coordinationCache.set(t,e),setTimeout(()=>{this.coordinationCache.delete(t)},this.cacheTimeoutMs)}convertToColorResult(t,e){return{processedColors:{...t.enhancedColors,...t.cssVariables},accentHex:t.accentHex,accentRgb:t.accentRgb,metadata:{strategy:"musical-oklab-processor",processingTime:t.processingTime,detectedGenre:t.detectedGenre,emotionalState:t.emotionalResult.primaryEmotion,oklabPreset:t.oklabPreset.name,processingStrategy:t.processingStrategy,musicInfluenceStrength:t.musicInfluenceStrength},context:{rawColors:e.rawColors,trackUri:e.trackUri,timestamp:e.timestamp,harmonicMode:e.harmonicMode||"musical-oklab-processing",musicData:e.musicData}}}clearProcessingCache(){this.coordinationCache.clear(),this.enableDebug&&u?.debug?.log("MusicalOKLABProcessor","Processing cache cleared")}getProcessingMetrics(){return{cacheSize:this.coordinationCache.size,maxCacheSize:this.cacheMaxSize,cacheTimeoutMs:this.cacheTimeoutMs,enableDebug:this.enableDebug}}}});var Ii,hs=v(()=>{"use strict";R();Ii=class{constructor(){this.strategiesMap=new Map;this.metrics={totalStrategies:0,healthyStrategies:0,averageResponseTime:0,totalUsageCount:0,cacheHitRate:0,memoryUsage:0};this.healthCheckInterval=null;this.HEALTH_CHECK_INTERVAL_MS=3e4;this.startHealthMonitoring(),u?.debug?.log("ColorStrategyRegistry","Strategy registry initialized")}register(t){let e=t.getStrategyName();this.strategiesMap.has(e)&&u?.debug?.warn("ColorStrategyRegistry",`Strategy ${e} is already registered, replacing...`);try{let i={strategy:t,registrationTime:Date.now(),lastUsed:0,usageCount:0,errorCount:0,averageProcessingTime:0,isHealthy:!0,metadata:this.inferStrategyMetadata(t)};this.strategiesMap.set(e,i),this.updateMetrics(),u?.debug?.log("ColorStrategyRegistry",`Registered strategy: ${e}`,{category:i.metadata.category,priority:i.metadata.priority,memoryImpact:i.metadata.memoryImpact})}catch(i){u?.debug?.error("ColorStrategyRegistry",`Failed to register strategy ${e}:`,i)}}selectStrategy(t){let e=Array.from(this.strategiesMap.values()).filter(r=>r.isHealthy).sort((r,a)=>this.scoreStrategy(a,t)-this.scoreStrategy(r,t));if(e.length===0)return u?.debug?.warn("ColorStrategyRegistry","No healthy strategies available"),null;let i=e[0];return i?(this.recordStrategyUsage(i.strategy.getStrategyName()),u?.debug?.log("ColorStrategyRegistry",`Selected strategy: ${i.strategy.getStrategyName()}`,{score:this.scoreStrategy(i,t),totalAvailable:e.length}),i.strategy):(u?.debug?.warn("ColorStrategyRegistry","No strategies available after filtering"),null)}getStrategies(){return Array.from(this.strategiesMap.values()).filter(t=>t.isHealthy).map(t=>t.strategy)}getStrategy(t){let e=this.strategiesMap.get(t);return e&&e.isHealthy?e.strategy:null}selectMultipleStrategies(t,e=4){let i=Array.from(this.strategiesMap.values()).filter(a=>a.isHealthy).map(a=>({registration:a,score:this.scoreStrategy(a,t)})).sort((a,n)=>n.score-a.score).slice(0,e);i.forEach(a=>{this.recordStrategyUsage(a.registration.strategy.getStrategyName())});let r=i.map(a=>a.registration.strategy);return u?.debug?.log("ColorStrategyRegistry",`Selected ${r.length} strategies`,{strategies:r.map(a=>a.getStrategyName()),scores:i.map(a=>a.score)}),r}scoreStrategy(t,e){let i=0;switch(i+=t.metadata.priority*10,e.performance){case"high":t.metadata.memoryImpact==="low"&&(i+=20),t.averageProcessingTime<10&&(i+=15);break;case"medium":t.metadata.memoryImpact!=="high"&&(i+=10),t.averageProcessingTime<20&&(i+=10);break;case"low":break}switch(e.quality){case"premium":t.metadata.category==="enhancement"&&(i+=15),t.metadata.tags.includes("webgl")&&(i+=10);break;case"enhanced":t.metadata.category!=="effects"&&(i+=10);break;case"basic":t.metadata.category==="foundation"&&(i+=15);break}if(e.deviceCapabilities&&(e.deviceCapabilities.hasWebGL&&t.metadata.tags.includes("webgl")&&(i+=15),e.deviceCapabilities.isMobile&&t.metadata.memoryImpact==="low"&&(i+=10),e.deviceCapabilities.memoryMB&&e.deviceCapabilities.memoryMB<4e3&&t.metadata.memoryImpact==="high"&&(i-=20)),e.userPreferences&&(e.userPreferences.enableAdvancedBlending&&t.metadata.tags.includes("advanced-blending")&&(i+=12),e.userPreferences.harmonicMode)){let n=e.userPreferences.harmonicMode;t.metadata.tags.includes(n)&&(i+=8)}let r=t.usageCount>0?t.errorCount/t.usageCount:0;return i-=r*30,Date.now()-t.lastUsed<3e5&&(i+=5),Math.max(0,i)}inferStrategyMetadata(t){let e=t.getStrategyName(),i=[],r="enhancement",a=5,n="medium",s=[];switch(e){case"dynamic-catppuccin":r="accent",a=10,n="low",i.push("catppuccin","dynamic","accent","spicetify");break;case"living-gradient":r="foundation",a=8,n="low",i.push("gradient","pulsing","foundation","css");break;case"webgl-gradient":r="enhancement",a=6,n="high",s.push("webgl"),i.push("webgl","gradient","performance","advanced-blending");break;case"depth-layered":r="effects",a=7,n="medium",i.push("depth","layers","parallax","visual-effects","cosmic","cinematic");break;default:break}return{category:r,priority:a,memoryImpact:n,deviceRequirements:s,tags:i}}recordStrategyUsage(t){let e=this.strategiesMap.get(t);e&&(e.usageCount++,e.lastUsed=Date.now())}recordStrategyError(t,e){let i=this.strategiesMap.get(t);if(i){i.errorCount++;let r=i.errorCount/Math.max(1,i.usageCount);r>.5&&i.usageCount>5&&(i.isHealthy=!1,u?.debug?.warn("ColorStrategyRegistry",`Strategy ${t} marked as unhealthy`,{errorRate:r,errorCount:i.errorCount,usageCount:i.usageCount}))}}recordStrategyProcessingTime(t,e){let i=this.strategiesMap.get(t);if(i){let r=i.averageProcessingTime*(i.usageCount-1)+e;i.averageProcessingTime=r/i.usageCount}}startHealthMonitoring(){this.healthCheckInterval=window.setInterval(()=>{this.performHealthChecks()},this.HEALTH_CHECK_INTERVAL_MS)}async performHealthChecks(){try{for(let[t,e]of this.strategiesMap.entries())try{if("healthCheck"in e.strategy&&typeof e.strategy.healthCheck=="function"){let i=await e.strategy.healthCheck();e.isHealthy=i?.healthy??!0,e.isHealthy||u?.debug?.warn("ColorStrategyRegistry",`Strategy ${t} failed health check:`,i)}}catch(i){e.isHealthy=!1,u?.debug?.error("ColorStrategyRegistry",`Health check failed for strategy ${t}:`,i)}this.updateMetrics()}catch(t){u?.debug?.error("ColorStrategyRegistry","Health check monitoring failed:",t)}}updateMetrics(){let t=Array.from(this.strategiesMap.values());this.metrics.totalStrategies=t.length,this.metrics.healthyStrategies=t.filter(i=>i.isHealthy).length,this.metrics.totalUsageCount=t.reduce((i,r)=>i+r.usageCount,0);let e=t.filter(i=>i.averageProcessingTime>0).map(i=>i.averageProcessingTime);e.length>0&&(this.metrics.averageResponseTime=e.reduce((i,r)=>i+r,0)/e.length),this.metrics.memoryUsage=t.reduce((i,r)=>{let a=r.metadata.memoryImpact==="high"?3:r.metadata.memoryImpact==="medium"?2:1;return i+a},0)}getRegistryMetrics(){return{...this.metrics}}getStrategyInfo(t){let e=this.strategiesMap.get(t);return e?{...e}:null}getAllStrategyInfo(){return Array.from(this.strategiesMap.entries()).map(([t,e])=>({name:t,registration:{...e}}))}unregister(t){let e=this.strategiesMap.delete(t);return e&&(this.updateMetrics(),u?.debug?.log("ColorStrategyRegistry",`Unregistered strategy: ${t}`)),e}clear(){this.strategiesMap.clear(),this.updateMetrics(),u?.debug?.log("ColorStrategyRegistry","All strategies cleared from registry")}destroy(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null);for(let[t,e]of this.strategiesMap.entries())if("destroy"in e.strategy&&typeof e.strategy.destroy=="function")try{e.strategy.destroy()}catch(i){u?.debug?.warn("ColorStrategyRegistry",`Error destroying strategy ${t}:`,i)}this.clear(),u?.debug?.log("ColorStrategyRegistry","Strategy registry destroyed")}}});var St,ya=v(()=>{"use strict";B();$();pe();R();ee();te();St=class{constructor(){this.utils=k;this.config=w;this.cssController=null;this.depthState={containerElement:null,backgroundContainer:null,depthLayers:new Map,animationFrameId:null,lastAnimationTime:0,scrollY:0,scrollX:0,lastUpdateTime:0,isInitialized:!1,stylesInjected:!1};this.animationElapsedTime=0;this.depthSettings={enabled:!0,layerCount:6,maxDepth:1e3,parallaxStrength:.5,depthFogIntensity:.7,infiniteScrolling:!0,qualityLevel:"medium",performanceMode:!1,musicResponsiveness:1};this.performanceMetrics={totalLayers:0,visibleLayers:0,averageDepth:0,parallaxRange:0,renderTime:0,memoryUsage:0};this.layerTemplates={cosmic:{animation:"cosmic-drift",duration:"120s",baseGradient:"radial-gradient(ellipse at center, {primary} 0%, {secondary} 50%, {base} 100%)"},nebula:{animation:"nebula-flow",duration:"180s",baseGradient:"conic-gradient(from 45deg, {primary} 0%, {secondary} 25%, {tertiary} 50%, {quaternary} 75%, {primary} 100%)"},stellar:{animation:"stellar-motion",duration:"240s",baseGradient:"linear-gradient(45deg, {primary} 0%, {secondary} 25%, {tertiary} 50%, {quaternary} 75%, {primary} 100%)"},quantum:{animation:"quantum-field",duration:"300s",baseGradient:"radial-gradient(circle at 30% 70%, {primary} 0%, transparent 50%), radial-gradient(circle at 70% 30%, {secondary} 0%, transparent 50%)"},dimensional:{animation:"dimensional-shift",duration:"360s",baseGradient:"linear-gradient(135deg, {primary} 0%, {secondary} 20%, {tertiary} 40%, {quaternary} 60%, {primary} 80%, {secondary} 100%)"},void:{animation:"void-expansion",duration:"480s",baseGradient:"radial-gradient(ellipse at center, {base} 0%, {secondary} 30%, {primary} 60%, transparent 100%)"}};this.boundScrollHandler=null;this.boundResizeHandler=null;this.deviceDetector=new W,this.cssController=A(),this.loadDepthSettings(),this.adaptToDeviceCapabilities(),this.boundScrollHandler=this.handleScroll.bind(this),this.boundResizeHandler=this.handleResize.bind(this),u?.debug?.log("DepthLayeredStrategy","Depth layered strategy initialized",{layerCount:this.depthSettings.layerCount,qualityLevel:this.depthSettings.qualityLevel,deviceCapability:this.deviceDetector.recommendPerformanceQuality()})}getStrategyName(){return"depth-layered"}canProcess(t){return this.depthSettings.enabled}getEstimatedProcessingTime(t){let i=this.depthSettings.layerCount/6,r=this.depthSettings.qualityLevel==="high"?1.3:this.depthSettings.qualityLevel==="low"?.7:1;return Math.round(15*i*r)}async processColors(t){let e=performance.now();try{this.depthState.isInitialized||await this.initializeDepthSystem();let i=this.extractDepthColors(t.rawColors);await this.updateDepthLayers(i),this.depthState.animationFrameId||this.startDepthAnimation(),t.musicData?.energy!==void 0&&this.updateDepthWithMusicEnergy(t.musicData.energy),this.depthState.lastUpdateTime=Date.now(),this.updatePerformanceMetrics();let r=performance.now()-e,a={processedColors:{depthLayers:this.depthState.depthLayers.size.toString(),depthEnabled:this.depthSettings.enabled.toString(),qualityLevel:this.depthSettings.qualityLevel,...t.rawColors},accentHex:this.selectPrimaryColor(t.rawColors)||"#cba6f7",accentRgb:this.convertToRgbString(this.selectPrimaryColor(t.rawColors)||"#cba6f7"),metadata:{strategy:this.getStrategyName(),processingTime:r,cacheKey:`depth-layered-${t.trackUri}`,harmonicIntensity:this.depthSettings.parallaxStrength,layerCount:this.depthState.depthLayers.size},context:t};return u?.debug?.log("DepthLayeredStrategy","Depth layered processing completed",{layerCount:this.depthState.depthLayers.size,processingTime:r,trackUri:t.trackUri}),a}catch(i){let r=performance.now()-e;return u?.debug?.error("DepthLayeredStrategy","Depth layered processing failed:",i),{processedColors:t.rawColors,accentHex:this.selectPrimaryColor(t.rawColors)||"#cba6f7",accentRgb:this.convertToRgbString(this.selectPrimaryColor(t.rawColors)||"#cba6f7"),metadata:{strategy:this.getStrategyName(),processingTime:r,error:i instanceof Error?i.message:"Unknown error"},context:t}}}loadDepthSettings(){try{let t=E.get("sn-gradient-intensity");if(t){let i=t==="intense"?"high":t==="balanced"?"medium":t==="minimal"?"low":"medium";this.depthSettings.qualityLevel=i,this.adjustQualitySettings()}let e=t!=="disabled";e!==void 0&&(this.depthSettings.enabled=e)}catch(t){u?.debug?.warn("DepthLayeredStrategy","Failed to load settings:",t)}}adaptToDeviceCapabilities(){switch(this.deviceDetector.recommendPerformanceQuality()){case"low":this.depthSettings.qualityLevel="low",this.depthSettings.layerCount=3,this.depthSettings.performanceMode=!0,this.depthSettings.parallaxStrength=.3,this.depthSettings.depthFogIntensity=.5;break;case"balanced":this.depthSettings.qualityLevel="medium",this.depthSettings.layerCount=6,this.depthSettings.performanceMode=!1,this.depthSettings.parallaxStrength=.5,this.depthSettings.depthFogIntensity=.7;break;case"high":this.depthSettings.qualityLevel="high",this.depthSettings.layerCount=9,this.depthSettings.performanceMode=!1,this.depthSettings.parallaxStrength=.8,this.depthSettings.depthFogIntensity=.9;break}}adjustQualitySettings(){switch(this.depthSettings.qualityLevel){case"low":this.depthSettings.layerCount=3,this.depthSettings.parallaxStrength=.3,this.depthSettings.depthFogIntensity=.5;break;case"medium":this.depthSettings.layerCount=6,this.depthSettings.parallaxStrength=.5,this.depthSettings.depthFogIntensity=.7;break;case"high":this.depthSettings.layerCount=9,this.depthSettings.parallaxStrength=.8,this.depthSettings.depthFogIntensity=.9;break}}async initializeDepthSystem(){this.createContainerElements(),this.injectDepthAnimations(),this.setupEventListeners(),this.depthState.isInitialized=!0,u?.debug?.log("DepthLayeredStrategy","Depth system initialized successfully")}createContainerElements(){this.depthState.containerElement=document.querySelector(".Root__main-view")||document.querySelector(".main-view-container")||document.body,this.depthState.backgroundContainer=document.createElement("div"),this.depthState.backgroundContainer.className="sn-depth-background-container",this.depthState.backgroundContainer.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -20;
      pointer-events: none;
      overflow: hidden;
      perspective: 1000px;
      transform-style: preserve-3d;
    `,this.depthState.containerElement.insertBefore(this.depthState.backgroundContainer,this.depthState.containerElement.firstChild)}injectDepthAnimations(){if(this.depthState.stylesInjected)return;let t=document.createElement("style");t.textContent=`
      .sn-depth-layer {
        position: absolute;
        width: 120%;
        height: 120%;
        top: -10%;
        left: -10%;
        pointer-events: none;
        transform-style: preserve-3d;
        will-change: transform, opacity;
      }

      @keyframes cosmic-drift {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        25% { transform: translate3d(-2%, 1%, 0) rotate(0.5deg) scale(1.02); }
        50% { transform: translate3d(0, -1%, 0) rotate(0deg) scale(0.98); }
        75% { transform: translate3d(2%, 0.5%, 0) rotate(-0.5deg) scale(1.01); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes nebula-flow {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        33% { transform: translate3d(1%, -1%, 0) rotate(1deg) scale(1.03); }
        66% { transform: translate3d(-1%, 1%, 0) rotate(-1deg) scale(0.97); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes stellar-motion {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        20% { transform: translate3d(-1%, 0.5%, 0) rotate(0.3deg) scale(1.01); }
        40% { transform: translate3d(0.5%, -0.5%, 0) rotate(-0.3deg) scale(0.99); }
        60% { transform: translate3d(1%, 0.5%, 0) rotate(0.2deg) scale(1.02); }
        80% { transform: translate3d(-0.5%, 1%, 0) rotate(-0.2deg) scale(0.98); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes quantum-field {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); filter: blur(0px); }
        25% { transform: translate3d(0.5%, -0.5%, 0) rotate(0.1deg) scale(1.01); filter: blur(0.5px); }
        50% { transform: translate3d(-0.5%, 0.5%, 0) rotate(-0.1deg) scale(0.99); filter: blur(1px); }
        75% { transform: translate3d(0.3%, 0.3%, 0) rotate(0.05deg) scale(1.005); filter: blur(0.3px); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); filter: blur(0px); }
      }

      @keyframes dimensional-shift {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        16% { transform: translate3d(0.2%, -0.2%, 0) rotate(0.1deg) scale(1.005); }
        32% { transform: translate3d(-0.2%, 0.2%, 0) rotate(-0.1deg) scale(0.995); }
        48% { transform: translate3d(0.1%, 0.1%, 0) rotate(0.05deg) scale(1.002); }
        64% { transform: translate3d(-0.1%, -0.1%, 0) rotate(-0.05deg) scale(0.998); }
        80% { transform: translate3d(0.15%, 0%, 0) rotate(0.02deg) scale(1.001); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes void-expansion {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.9; }
        50% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1.1); opacity: 0.6; }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.9; }
      }

      @media (prefers-reduced-motion: reduce) {
        .sn-depth-layer {
          animation: none !important;
        }
      }
    `,document.head.appendChild(t),this.depthState.stylesInjected=!0}setupEventListeners(){this.boundScrollHandler&&window.addEventListener("scroll",this.boundScrollHandler,{passive:!0}),this.boundResizeHandler&&window.addEventListener("resize",this.boundResizeHandler,{passive:!0})}extractDepthColors(t){let e=["PRIMARY","VIBRANT","LIGHT_VIBRANT","DARK_VIBRANT","VIBRANT_NON_ALARMING","PROMINENT","SECONDARY","DESATURATED"],i=[],r=new Set;for(let a of e){let n=t[a];if(n&&!r.has(n)&&this.utils.hexToRgb(n)&&(i.push(n),r.add(n),i.length>=this.depthSettings.layerCount))break}for(;i.length<this.depthSettings.layerCount;){let a=i[0]||"#cba6f7",n=this.createColorVariation(a,i.length);i.push(n)}return i}createColorVariation(t,e){let i=this.utils.hexToRgb(t);if(!i)return t;let r=.8-e*.1,a=Math.round(i.r*r),n=Math.round(i.g*r),s=Math.round(i.b*r);return this.utils.rgbToHex(a,n,s)}async updateDepthLayers(t){if(!this.depthState.backgroundContainer)return;this.depthState.depthLayers.forEach(i=>{i.element.parentNode&&i.element.parentNode.removeChild(i.element)}),this.depthState.depthLayers.clear();let e=Object.keys(this.layerTemplates);for(let i=0;i<this.depthSettings.layerCount;i++){let r=(i+1)*(this.depthSettings.maxDepth/this.depthSettings.layerCount),a=e[i%e.length],n=this.layerTemplates[a],s=document.createElement("div");s.className="sn-depth-layer",s.id=`sn-depth-layer-${i}`;let l=r/this.depthSettings.maxDepth,c=1-l*this.depthSettings.parallaxStrength,m=1-l*this.depthSettings.depthFogIntensity,d=1+l*.2,h=l*3,g=this.createDepthGradient(n.baseGradient,t,i);s.style.cssText=`
        background: ${g};
        transform: var(--sn-depth-layer-${i}-transform, translate3d(0, 0, ${-r}px) scale(${d}));
        opacity: var(--sn-depth-layer-${i}-opacity, ${m});
        filter: blur(${h}px);
        animation: ${n.animation} ${n.duration} ease-in-out infinite;
        animation-delay: ${i*.5}s;
      `;let f={id:`depth-layer-${i}`,element:s,depth:r,parallaxFactor:c,opacityRange:[m*.5,m],scaleRange:[d*.95,d*1.05],rotationSpeed:.01+i*.001,colorShift:i*30,blurAmount:h,animationPhase:i*Math.PI/4,enabled:!0,gradientColors:t.slice(i,i+4),cachedOpacity:m,cachedTransform:`translate3d(0, 0, ${-r}px) scale(${d})`};this.depthState.depthLayers.set(f.id,f),this.depthState.backgroundContainer.appendChild(s)}u?.debug?.log("DepthLayeredStrategy",`Updated ${this.depthState.depthLayers.size} depth layers with new colors`)}createDepthGradient(t,e,i){let r=e.length,a=i%r,n=(i+1)%r,s=(i+2)%r,l=(i+3)%r,m=.8-i/this.depthSettings.layerCount*.6,d=this.convertToRgba(e[a]||"#cba6f7",m),h=this.convertToRgba(e[n]||"#f5c2e7",m*.7),g=this.convertToRgba(e[s]||"#fab387",m*.5),f=this.convertToRgba(e[l]||"#a6e3a1",m*.3),S=this.convertToRgba("#1e1e2e",m*.9);return t.replace(/\{primary\}/g,d).replace(/\{secondary\}/g,h).replace(/\{tertiary\}/g,g).replace(/\{quaternary\}/g,f).replace(/\{base\}/g,S)}convertToRgba(t,e){let i=this.utils.hexToRgb(t);return i?`rgba(${i.r}, ${i.g}, ${i.b}, ${e})`:`rgba(203, 166, 247, ${e})`}startDepthAnimation(){u?.debug?.log("DepthLayeredStrategy","Animation loop delegated to AnimationFrameCoordinator")}updateDepthAnimations(t){this.depthState.depthLayers.forEach(e=>{e.animationPhase+=e.rotationSpeed*t*.001;let i=Math.sin(e.animationPhase)*.05,r=Math.max(0,Math.min(1,e.cachedOpacity+i));if(e.cachedOpacity=r,this.cssController){let a=e.id.replace("depth-layer-","");this.cssController.queueCSSVariableUpdate(`--sn-depth-layer-${a}-opacity`,r.toString())}})}updateDepthWithMusicEnergy(t){let e=t*this.depthSettings.musicResponsiveness*.3;this.depthState.depthLayers.forEach(i=>{let r=i.opacityRange[0],a=i.opacityRange[1],n=Math.max(0,Math.min(1,r+e*(a-r)));if(i.cachedOpacity=n,this.cssController){let s=i.id.replace("depth-layer-","");this.cssController.queueCSSVariableUpdate(`--sn-depth-layer-${s}-opacity`,n.toString())}})}handleScroll(t){this.depthSettings.infiniteScrolling&&(this.depthState.scrollY=window.scrollY,this.depthState.scrollX=window.scrollX,this.updateParallaxEffects())}handleResize(t){this.updateLayerDimensions()}updateParallaxEffects(){this.depthState.depthLayers.forEach(t=>{let e=this.depthState.scrollY*t.parallaxFactor,i=this.depthState.scrollX*t.parallaxFactor*.5,r=t.cachedTransform.match(/scale\(([^)]+)\)/),a=r?r[1]:"1",n=`translate3d(${i}px, ${e}px, ${-t.depth}px) scale(${a})`;if(t.cachedTransform=n,this.cssController){let s=t.id.replace("depth-layer-","");this.cssController.queueCSSVariableUpdate(`--sn-depth-layer-${s}-transform`,n)}})}updateLayerDimensions(){this.depthState.depthLayers.forEach(t=>{let i=1+t.depth/this.depthSettings.maxDepth*.2,r=t.cachedTransform.match(/translate3d\([^)]+\)/),n=`${r?r[0]:`translate3d(0, 0, ${-t.depth}px)`} scale(${i})`;if(t.cachedTransform=n,this.cssController){let s=t.id.replace("depth-layer-","");this.cssController.queueCSSVariableUpdate(`--sn-depth-layer-${s}-transform`,n)}})}updateAnimation(t){this.depthState.isInitialized&&(this.animationElapsedTime+=t,!(this.animationElapsedTime<33)&&(this.updateDepthAnimations(this.animationElapsedTime),this.updatePerformanceMetrics(),this.animationElapsedTime=0))}updatePerformanceMetrics(){this.performanceMetrics.totalLayers=this.depthState.depthLayers.size,this.performanceMetrics.visibleLayers=Array.from(this.depthState.depthLayers.values()).filter(t=>t.cachedOpacity>.01).length,this.performanceMetrics.averageDepth=Array.from(this.depthState.depthLayers.values()).reduce((t,e)=>t+e.depth,0)/this.depthState.depthLayers.size,this.performanceMetrics.parallaxRange=this.depthSettings.parallaxStrength,this.performanceMetrics.renderTime=this.animationElapsedTime,this.cssController&&(this.cssController.queueCSSVariableUpdate("--sn-depth-layers-total",this.performanceMetrics.totalLayers.toString()),this.cssController.queueCSSVariableUpdate("--sn-depth-layers-visible",this.performanceMetrics.visibleLayers.toString()))}selectPrimaryColor(t){let e=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let i of e){let r=t[i];if(r&&this.utils.hexToRgb(r))return r}return null}convertToRgbString(t){let e=this.utils.hexToRgb(t);return e?`${e.r},${e.g},${e.b}`:"203,166,247"}updateConfig(t){this.depthSettings={...this.depthSettings,...t},t.qualityLevel&&this.adjustQualitySettings(),u?.debug?.log("DepthLayeredStrategy","Configuration updated:",t)}async healthCheck(){let t=Date.now()-this.depthState.lastUpdateTime<3e4;return{healthy:this.depthState.isInitialized&&this.depthSettings.enabled,canProcess:this.canProcess({}),issues:this.depthState.isInitialized?this.depthSettings.enabled?[]:["Depth layers disabled in settings"]:["Depth system not initialized"],metrics:{isInitialized:this.depthState.isInitialized,depthEnabled:this.depthSettings.enabled,layerCount:this.depthState.depthLayers.size,qualityLevel:this.depthSettings.qualityLevel,parallaxStrength:this.depthSettings.parallaxStrength,hasRecentUpdate:t,animationActive:this.depthState.animationFrameId!==null,performanceMetrics:this.performanceMetrics}}}destroy(){this.depthState.animationFrameId&&(cancelAnimationFrame(this.depthState.animationFrameId),this.depthState.animationFrameId=null),this.boundScrollHandler&&(window.removeEventListener("scroll",this.boundScrollHandler),this.boundScrollHandler=null),this.boundResizeHandler&&(window.removeEventListener("resize",this.boundResizeHandler),this.boundResizeHandler=null),this.depthState.depthLayers.forEach(t=>{t.element.parentNode&&t.element.parentNode.removeChild(t.element)}),this.depthState.depthLayers.clear(),this.depthState.backgroundContainer&&this.depthState.backgroundContainer.parentNode&&(this.depthState.backgroundContainer.parentNode.removeChild(this.depthState.backgroundContainer),this.depthState.backgroundContainer=null),this.depthState.isInitialized=!1,this.depthState.containerElement=null,u?.debug?.log("DepthLayeredStrategy","Depth layered strategy destroyed")}}});var Di,gs=v(()=>{"use strict";B();$();R();ee();ue();Lt();te();Di=class{constructor(t){this.utils=k;this.config=w;this.dynamicColorState=this.getInitialColorState();this.integrationConfig={accentUpdateEnabled:!0,baseTransformationEnabled:!0,visualEffectsIntegrationEnabled:!0,oklabEnhancementEnabled:!0,smoothTransitionDuration:800,energyResponseMultiplier:1.2,oklabPreset:"VIBRANT"};this.transitionTimer=0;this.lastTransitionStartTime=0;this.transitionFromAccent="";this.transitionToAccent="";this.cssController=t||A(),this.oklabProcessor=new T(this.config.enableDebug),this.initializeCurrentState(),u?.debug?.log("DynamicCatppuccinStrategy","Color strategy initialized with CSS coordinator and OKLAB processing")}getInitialColorState(){try{let t=Z.getDefaultAccentColor(),e=Z.getBrightnessAdjustedBaseColor();return{currentAccentHex:t.hex,currentAccentRgb:t.rgb,baseBackgroundHex:e.hex,baseBackgroundRgb:e.rgb,lastUpdateTime:0,musicEnergy:.5,transitionInProgress:!1}}catch(t){return console.warn("[DynamicCatppuccinStrategy] Failed to get initial colors, using fallback:",t),{currentAccentHex:"#7c3aed",currentAccentRgb:"124,58,237",baseBackgroundHex:"#0d1117",baseBackgroundRgb:"13,17,23",lastUpdateTime:0,musicEnergy:.5,transitionInProgress:!1}}}getStrategyName(){return"dynamic-catppuccin"}canProcess(t){return this.checkDynamicAccentEnabled()}getEstimatedProcessingTime(t){return 5}async processColors(t){let e=performance.now();try{let i=this.selectBestAccentColor(t.rawColors);if(!i)throw new Error("No suitable accent color found in extracted colors");let r=i,a=this.utils.hexToRgb(i),n=null;if(this.integrationConfig.oklabEnhancementEnabled){let c=T.getPreset(this.integrationConfig.oklabPreset);n=this.oklabProcessor.processColor(i,c),r=n.enhancedHex,a=n.enhancedRgb,u?.debug?.log("DynamicCatppuccinStrategy","OKLAB color enhancement applied:",{original:i,enhanced:r,preset:c.name,processingTime:`${n.processingTime.toFixed(2)}ms`})}this.dynamicColorState.currentAccentHex=r,a&&(this.dynamicColorState.currentAccentRgb=`${a.r},${a.g},${a.b}`),this.dynamicColorState.lastUpdateTime=Date.now(),t.musicData?.energy!==void 0&&(this.dynamicColorState.musicEnergy=t.musicData.energy);let s=performance.now()-e,l={processedColors:{accent:r,primary:r,originalAccent:i,...t.rawColors},accentHex:r,accentRgb:this.dynamicColorState.currentAccentRgb,metadata:{strategy:this.getStrategyName(),processingTime:s,cacheKey:`dynamic-catppuccin-${t.trackUri}`,harmonicIntensity:this.integrationConfig.energyResponseMultiplier,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,oklabPreset:this.integrationConfig.oklabPreset,musicEnergy:this.dynamicColorState.musicEnergy,energyResponseMultiplier:this.integrationConfig.energyResponseMultiplier,dynamicAccentEnabled:!0,visualEffectsIntegrationEnabled:this.integrationConfig.visualEffectsIntegrationEnabled,baseTransformationEnabled:this.integrationConfig.baseTransformationEnabled,...n&&{oklabMetadata:{originalHex:n.originalHex,originalRgb:n.originalRgb,enhancedHex:n.enhancedHex,enhancedRgb:n.enhancedRgb,shadowHex:n.shadowHex,shadowRgb:n.shadowRgb,oklabProcessingTime:n.processingTime,oklchL:n.oklchEnhanced.L,oklchC:n.oklchEnhanced.C,oklchH:n.oklchEnhanced.H,fullOKLABResult:n}}},context:t};return u?.debug?.log("DynamicCatppuccinStrategy","Color processing completed",{originalAccent:i,processedAccent:r,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,processingTime:s,trackUri:t.trackUri}),l}catch(i){let r=performance.now()-e;return u?.debug?.error("DynamicCatppuccinStrategy","Color processing failed:",i),{processedColors:t.rawColors,accentHex:this.dynamicColorState.currentAccentHex,accentRgb:this.dynamicColorState.currentAccentRgb,metadata:{strategy:this.getStrategyName(),processingTime:r,error:i instanceof Error?i.message:"Unknown error"},context:t}}}checkDynamicAccentEnabled(){try{let t=E.get("catppuccin-accentColor"),e=String(t)==="dynamic";return this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinStrategy",`Accent setting: ${t}, Dynamic: ${e}`),e}catch(t){return u?.debug?.error("DynamicCatppuccinStrategy","Error checking dynamic accent setting:",t),!1}}initializeCurrentState(){let t=document.documentElement,e=getComputedStyle(t),i=e.getPropertyValue("--spice-accent").trim()||e.getPropertyValue("--sn-color-accent-hex").trim();if(i){this.dynamicColorState.currentAccentHex=i;let n=this.utils.hexToRgb(i);n&&(this.dynamicColorState.currentAccentRgb=`${n.r},${n.g},${n.b}`)}let r=e.getPropertyValue("--spice-base").trim()||"#1e1e2e";this.dynamicColorState.baseBackgroundHex=r;let a=this.utils.hexToRgb(r);a&&(this.dynamicColorState.baseBackgroundRgb=`${a.r},${a.g},${a.b}`),this.dynamicColorState.lastUpdateTime=Date.now(),u?.debug?.log("DynamicCatppuccinStrategy","Current state initialized:",{accent:this.dynamicColorState.currentAccentHex,base:this.dynamicColorState.baseBackgroundHex})}selectBestAccentColor(t){let e=["VIBRANT_NON_ALARMING","VIBRANT","LIGHT_VIBRANT","PROMINENT","PRIMARY","DARK_VIBRANT"];for(let i of e){let r=t[i];if(r&&this.utils.hexToRgb(r))return r}return null}getDynamicColorState(){return{...this.dynamicColorState}}updateConfig(t){this.integrationConfig={...this.integrationConfig,...t},("oklabEnhancementEnabled"in t||"oklabPreset"in t)&&(this.oklabProcessor=new T(this.config.enableDebug)),u?.debug?.log("DynamicCatppuccinStrategy","Configuration updated:",{...t,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,oklabPreset:this.integrationConfig.oklabPreset})}async healthCheck(){let t=this.checkDynamicAccentEnabled(),e=Date.now()-this.dynamicColorState.lastUpdateTime<3e4;return{healthy:t,canProcess:t,issues:t?[]:["Dynamic accent not enabled in settings"],metrics:{dynamicAccentEnabled:t,currentAccent:this.dynamicColorState.currentAccentHex,lastUpdateAge:Date.now()-this.dynamicColorState.lastUpdateTime,hasRecentUpdate:e,transitionInProgress:this.dynamicColorState.transitionInProgress,musicEnergy:this.dynamicColorState.musicEnergy,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,oklabPreset:this.integrationConfig.oklabPreset,visualEffectsIntegration:this.integrationConfig.visualEffectsIntegrationEnabled}}}destroy(){this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=0),this.dynamicColorState.transitionInProgress=!1,u?.debug?.log("DynamicCatppuccinStrategy","Dynamic Catppuccin strategy destroyed")}}});var ps={};ne(ps,{DynamicGradientStrategy:()=>at});var at,Li=v(()=>{"use strict";B();$();_();pe();R();ue();te();ge();at=class extends q{constructor(e=w,i=k,r=null,a=null,n,s){super(e,i,r,a);this.utils=k;this.config=w;this.livingBaseState={currentBaseHex:"#1e1e2e",currentBaseRgb:"30,30,46",currentPrimaryHex:"var(--sn-brightness-adjusted-accent-hex, #cba6f7)",currentPrimaryRgb:"var(--sn-brightness-adjusted-accent-rgb, 203, 166, 247)",visualEffectsIntensity:.5,musicEnergy:.5,lastUpdateTime:0,webglIntegrationActive:!1,oklabGradientStops:[]};this.gradientConfig={baseTransformationEnabled:!0,webglIntegrationEnabled:!0,responsiveAnimationEnabled:!0,visualEffectsLayerOpacity:.08,dynamicFlowIntensity:1.2,musicResponsiveness:1,oklabInterpolationEnabled:!0,oklabPreset:"STANDARD",gradientSmoothness:.8,animationThrottleFps:30,enablePerformanceBudget:!0,maxFrameTimeMs:16};this.cssAnimationManager=null;this.oklabCache=new Map;this.gradientCache=new Map;this.cacheValidityMs=5e3;this.lastCacheCleanup=0;this.musicEventDebounceTimers={musicState:0,harmonizedColors:0,webglState:0,visualEffectsIntensity:0};this.eventDebounceMs=100;this.cssController=n||A(),this.oklabProcessor=new T(this.config.enableDebug),this.deviceDetector=new W,this.cssAnimationManager=s,this.initializeBaseState(),this.applyDeviceAwareSettings().catch(l=>{u?.debug?.warn("DynamicGradientStrategy","Failed to apply device-aware settings:",l)}),u?.debug?.log("DynamicGradientStrategy","Living gradient strategy initialized with OKLAB interpolation and device-aware performance")}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{this.setupConsciousnessListeners(),this.setupWebGLIntegrationListeners(),this.initializeBaseState(),this.initializeConsciousnessBreathing(),await this.applyLivingConsciousnessBase(),u?.debug?.log("DynamicGradientStrategy","Living gradient system awakened with visual system lifecycle")}catch(e){u?.debug?.error("DynamicGradientStrategy","Failed to initialize living gradient system:",e)}}setupConsciousnessListeners(){typeof p<"u"&&p.subscribe("colors:harmonized",e=>{e&&e.processedColors&&this.handleHarmonizedColorUpdate(e.processedColors)},"LivingGradientStrategy"),document.addEventListener("music-state-change",e=>{let i=e;i.detail&&this.handleMusicStateChange(i.detail)}),document.addEventListener("visualEffects-intensity-change",e=>{let i=e;i.detail&&typeof i.detail.intensity=="number"&&this.updateConsciousnessIntensity(i.detail.intensity)}),u?.debug?.log("DynamicGradientStrategy","Consciousness listeners established")}setupWebGLIntegrationListeners(){document.addEventListener("webgl-state-change",e=>{let i=e;i.detail&&this.handleWebGLStateChange(i.detail)}),document.addEventListener("webgl-gradient-update",e=>{let i=e;i.detail&&this.coordinateWithWebGLGradient(i.detail)}),u?.debug?.log("DynamicGradientStrategy","WebGL integration listeners established")}handleHarmonizedColorUpdate(e){this.debouncedEventHandler("harmonizedColors",()=>{let i=e.VIBRANT||e.PRIMARY||e.PROMINENT;if(i&&i!==this.livingBaseState.currentPrimaryHex){this.livingBaseState.currentPrimaryHex=i;let r=this.utils.hexToRgb(i);r&&(this.livingBaseState.currentPrimaryRgb=`${r.r},${r.g},${r.b}`),this.updateLivingConsciousnessBase(),this.triggerConsciousnessBreathing(),u?.debug?.log("DynamicGradientStrategy","Living base updated with harmonized colors:",i)}})}handleMusicStateChange(e){this.debouncedEventHandler("musicState",()=>{if(e.energy!==void 0){this.livingBaseState.musicEnergy=e.energy;let i=.5,r=e.energy*this.gradientConfig.musicResponsiveness;this.livingBaseState.visualEffectsIntensity=Math.max(.1,Math.min(1,i+r*.3)),this.updateMusicResponsiveVariables()}})}handleWebGLStateChange(e){this.debouncedEventHandler("webglState",()=>{e.enabled!==void 0&&(this.livingBaseState.webglIntegrationActive=e.enabled,this.coordinateWithWebGLSystem(e.enabled),u?.debug?.log("DynamicGradientStrategy",`WebGL integration ${e.enabled?"activated":"deactivated"}`))})}updateConsciousnessIntensity(e){this.debouncedEventHandler("visualEffectsIntensity",()=>{this.livingBaseState.visualEffectsIntensity=Math.max(0,Math.min(1,e)),this.updateConsciousnessVariables()})}debouncedEventHandler(e,i){let r=performance.now();r-this.musicEventDebounceTimers[e]>=this.eventDebounceMs&&(i(),this.musicEventDebounceTimers[e]=r)}initializeConsciousnessBreathing(){if(this.gradientConfig.responsiveAnimationEnabled){if(!this.cssAnimationManager){u?.debug?.warn("DynamicGradientStrategy","CSSAnimationManager not available, falling back to basic visualEffects");return}this.triggerConsciousnessBreathing(),u?.debug?.log("DynamicGradientStrategy","CSS-first visualEffects animation initialized")}}triggerConsciousnessBreathing(){if(!this.cssAnimationManager||!this.gradientConfig.responsiveAnimationEnabled)return;let e=document.querySelectorAll(".Root__main-view::before, .Root__main-view, [data-visualEffects-animation]");if(e.length===0){let i=document.querySelector(".Root__main-view")||document.body;i&&(i.setAttribute("data-visualEffects-animation","true"),this.cssAnimationManager.triggerConsciousnessBreathing([i],this.livingBaseState.musicEnergy,120))}else this.cssAnimationManager.triggerConsciousnessBreathing(e,this.livingBaseState.musicEnergy,120);u?.debug?.log("DynamicGradientStrategy",`CSS-first visualEffects animation triggered for ${e.length} elements`)}async applyDeviceAwareSettings(){if(!this.deviceDetector.isInitialized)try{await this.deviceDetector.initialize()}catch(r){u?.debug?.warn("DynamicGradientStrategy","Device detection failed, using default settings:",r);return}let e=this.deviceDetector.getCapabilities();if(!e){u?.debug?.warn("DynamicGradientStrategy","No device capabilities available, using default settings");return}let i=e.overall;switch(i){case"high":this.gradientConfig.animationThrottleFps=30,this.gradientConfig.maxFrameTimeMs=16,this.gradientConfig.enablePerformanceBudget=!0;break;case"medium":this.gradientConfig.animationThrottleFps=20,this.gradientConfig.maxFrameTimeMs=20,this.gradientConfig.enablePerformanceBudget=!0;break;case"low":this.gradientConfig.animationThrottleFps=15,this.gradientConfig.maxFrameTimeMs=33,this.gradientConfig.enablePerformanceBudget=!0,this.gradientConfig.visualEffectsLayerOpacity*=.7,this.gradientConfig.dynamicFlowIntensity*=.8,this.gradientConfig.oklabInterpolationEnabled=!1;break;default:this.gradientConfig.animationThrottleFps=20,this.gradientConfig.maxFrameTimeMs=20;break}e.gpu.supportsWebGL||(this.gradientConfig.webglIntegrationEnabled=!1),e.memory.level==="low"&&(this.cacheValidityMs=2e3),e.cpu.cores<=2&&(this.gradientConfig.animationThrottleFps=Math.min(this.gradientConfig.animationThrottleFps,15)),e.display.reducedMotion&&(this.gradientConfig.responsiveAnimationEnabled=!1,u?.debug?.log("DynamicGradientStrategy","Breathing animation disabled due to reduced motion preference")),u?.debug?.log("DynamicGradientStrategy",`Device-aware settings applied for ${i}: ${this.gradientConfig.animationThrottleFps}fps, CSS-first animation coordination`)}getStrategyName(){return"living-gradient"}canProcess(e){return this.gradientConfig.baseTransformationEnabled}getEstimatedProcessingTime(e){return 8}async processColors(e){let i=performance.now();try{let r=this.selectPrimaryColor(e.rawColors),a=this.selectSecondaryColor(e.rawColors);if(!r)throw new Error("No suitable primary color found for living gradient");let n=r,s=a,l=[];if(this.gradientConfig.oklabInterpolationEnabled&&r){let d=T.getPreset(this.gradientConfig.oklabPreset);if(n=this.oklabProcessor.processColor(r,d).enhancedHex,a){s=this.oklabProcessor.processColor(a,d).enhancedHex;let f=Math.ceil(5*this.gradientConfig.gradientSmoothness)+3;l=this.oklabProcessor.generateOKLABGradient(n,s,f,d)}else{let g=this.livingBaseState.currentBaseHex;l=this.oklabProcessor.generateOKLABGradient(n,g,5,d),s=l[l.length-1]?.enhancedHex||n}u?.debug?.log("DynamicGradientStrategy","OKLAB gradient processing applied:",{originalPrimary:r,processedPrimary:n,originalSecondary:a,processedSecondary:s,gradientStops:l.length,preset:d.name})}await this.updateDynamicGradientState(n,s,e,l),await this.applyLivingConsciousnessBase(),this.triggerConsciousnessBreathing(),await this.updateWebGLIntegration();let c=performance.now()-i,m={processedColors:{primary:n,secondary:s||n,originalPrimary:r,...a&&{originalSecondary:a},livingBase:this.livingBaseState.currentBaseHex,...e.rawColors},accentHex:n,accentRgb:this.livingBaseState.currentPrimaryRgb,metadata:{strategy:this.getStrategyName(),processingTime:c,cacheKey:`living-gradient-${e.trackUri}`,harmonicIntensity:this.gradientConfig.dynamicFlowIntensity,oklabInterpolation:this.gradientConfig.oklabInterpolationEnabled,oklabPreset:this.gradientConfig.oklabPreset,gradientStopCount:l.length,gradientSmoothness:this.gradientConfig.gradientSmoothness},context:e};return u?.debug?.log("DynamicGradientStrategy","Living gradient processing completed",{originalPrimary:r,processedPrimary:n,originalSecondary:a,processedSecondary:s,oklabProcessing:this.gradientConfig.oklabInterpolationEnabled,gradientStops:l.length,processingTime:c,trackUri:e.trackUri}),m}catch(r){let a=performance.now()-i;return u?.debug?.error("DynamicGradientStrategy","Living gradient processing failed:",r),{processedColors:e.rawColors,accentHex:this.livingBaseState.currentPrimaryHex,accentRgb:this.livingBaseState.currentPrimaryRgb,metadata:{strategy:this.getStrategyName(),processingTime:a,error:r instanceof Error?r.message:"Unknown error"},context:e}}}initializeBaseState(){let e=document.documentElement,i=getComputedStyle(e),r=i.getPropertyValue("--spice-base").trim()||"#1e1e2e";this.livingBaseState.currentBaseHex=r;let a=this.utils.hexToRgb(r);a&&(this.livingBaseState.currentBaseRgb=`${a.r},${a.g},${a.b}`);let n=i.getPropertyValue("--sn-bg-gradient-primary-rgb").trim();if(n){let s=n.split(",").map(l=>parseInt(l.trim()));s.length===3&&(this.livingBaseState.currentPrimaryRgb=n,this.livingBaseState.currentPrimaryHex=this.utils.rgbToHex(s[0],s[1],s[2]))}this.livingBaseState.lastUpdateTime=Date.now(),u?.debug?.log("DynamicGradientStrategy","Base state initialized:",{base:this.livingBaseState.currentBaseHex,primary:this.livingBaseState.currentPrimaryHex})}selectPrimaryColor(e){let i=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let r of i){let a=e[r];if(a&&this.utils.hexToRgb(a))return a}return null}selectSecondaryColor(e){let i=["SECONDARY","DARK_VIBRANT","DESATURATED","LIGHT_VIBRANT"];for(let r of i){let a=e[r];if(a&&this.utils.hexToRgb(a))return a}return null}async updateDynamicGradientState(e,i,r,a=[]){let n=this.utils.hexToRgb(e);if(n){if(this.livingBaseState.currentPrimaryHex=e,this.livingBaseState.currentPrimaryRgb=`${n.r},${n.g},${n.b}`,this.livingBaseState.oklabGradientStops=a,r.musicData?.energy!==void 0){this.livingBaseState.musicEnergy=r.musicData.energy;let s=this.gradientConfig.visualEffectsLayerOpacity,l=1+r.musicData.energy*this.gradientConfig.musicResponsiveness;this.livingBaseState.visualEffectsIntensity=Math.max(.05,Math.min(1,s*l))}this.livingBaseState.lastUpdateTime=Date.now()}}async applyLivingConsciousnessBase(){let e=this.createLivingGradient(this.livingBaseState.oklabGradientStops),r=performance.now()/4e3*Math.PI*2,a=1+Math.sin(r)*.2,n=this.livingBaseState.visualEffectsIntensity*a,s=Math.sin(r*.7)*this.gradientConfig.dynamicFlowIntensity,l=Math.cos(r*.5)*this.gradientConfig.dynamicFlowIntensity,c=4e3,m=.5+this.livingBaseState.musicEnergy*1.5,d=c/m,h={"--living-base-gradient":e,"--visualEffects-base-gradient":e,"--visualEffects-layer-opacity":n.toString(),"--visualEffects-flow-x":`${s}%`,"--visualEffects-flow-y":`${l}%`,"--visualEffects-animation-duration":`${d}ms`};await this.cssController.batchSetVariables("DynamicGradientStrategy",h,"high","living-visualEffects-base"),u?.debug?.log("DynamicGradientStrategy","Applied coordinated living visualEffects base gradient")}createGradientCacheKey(e,i,r,a){let n=r.map((s,l)=>`${s.enhancedHex}-${l}`).join("|");return`${e}-${i}-${n}-${Math.floor(a*10)}`}cleanupCache(){let e=Date.now();e-this.lastCacheCleanup<1e4||(this.lastCacheCleanup=e,this.gradientCache.clear(),this.config.enableDebug&&u?.debug?.log("DynamicGradientStrategy","Cache cleanup completed"))}createLivingGradient(e=[]){let i=this.livingBaseState.currentPrimaryRgb,r=this.livingBaseState.currentBaseRgb,n=performance.now()/4e3*Math.PI*2,s=this.createGradientCacheKey(i,r,e,n),l=this.gradientCache.get(s);if(l)return this.cleanupCache(),l;let c=this.generateLivingGradient(i,r,e);return this.gradientCache.set(s,c),c}generateLivingGradient(e,i,r){return this.gradientConfig.oklabInterpolationEnabled&&r.length>0?`
        radial-gradient(
          ellipse at calc(50% + var(--visualEffects-flow-x)) calc(50% + var(--visualEffects-flow-y)),
          ${r.map((n,s)=>{let l=s/(r.length-1)*100,c=`${n.enhancedRgb.r},${n.enhancedRgb.g},${n.enhancedRgb.b}`,m=.6*(1-s/r.length)+.1;return`rgba(${c}, calc(var(--visualEffects-layer-opacity) * ${m})) ${l}%`}).join(", ")}
        ),
        linear-gradient(
          135deg,
          rgba(${r[0]?.enhancedRgb.r||e.split(",")[0]},${r[0]?.enhancedRgb.g||e.split(",")[1]},${r[0]?.enhancedRgb.b||e.split(",")[2]}, calc(var(--visualEffects-layer-opacity) * 0.4)) 0%,
          var(--spice-base) 50%,
          rgba(${r[r.length-1]?.enhancedRgb.r||e.split(",")[0]},${r[r.length-1]?.enhancedRgb.g||e.split(",")[1]},${r[r.length-1]?.enhancedRgb.b||e.split(",")[2]}, calc(var(--visualEffects-layer-opacity) * 0.2)) 100%
        ),
        var(--spice-base)
      `:`
      radial-gradient(
        ellipse at calc(50% + var(--visualEffects-flow-x)) calc(50% + var(--visualEffects-flow-y)),
        rgba(${e}, calc(var(--visualEffects-layer-opacity) * 0.6)) 0%,
        rgba(${e}, calc(var(--visualEffects-layer-opacity) * 0.3)) 30%,
        rgba(${i}, calc(var(--visualEffects-layer-opacity) * 0.1)) 60%,
        var(--spice-base) 100%
      ),
      linear-gradient(
        135deg,
        rgba(${e}, calc(var(--visualEffects-layer-opacity) * 0.4)) 0%,
        var(--spice-base) 50%,
        rgba(${e}, calc(var(--visualEffects-layer-opacity) * 0.2)) 100%
      ),
      var(--spice-base)
    `}updateBreathingAnimation(){this.triggerConsciousnessBreathing()}startBreathingAnimation(){this.triggerConsciousnessBreathing(),u?.debug?.log("DynamicGradientStrategy","CSS-first visualEffects animation started - 90%+ JavaScript overhead eliminated")}scheduleDebouncedCssUpdate(){u?.debug?.log("DynamicGradientStrategy","Debounced CSS updates eliminated - using CSS-first animation")}async updateWebGLIntegration(){if(!this.gradientConfig.webglIntegrationEnabled)return;let e={"--sn-bg-gradient-primary-rgb":this.livingBaseState.currentPrimaryRgb,"--sn-webgl-living-gradient-sync":"1","--sn-gradient-visualEffects-level":this.livingBaseState.visualEffectsIntensity.toString()};await this.cssController.batchSetVariables("DynamicGradientStrategy",e,"high","webgl-living-gradient-integration"),this.livingBaseState.webglIntegrationActive=!0,u?.debug?.log("DynamicGradientStrategy","WebGL integration updated")}getDynamicGradientState(){return{...this.livingBaseState}}updateLivingConsciousnessBase(){this.applyLivingConsciousnessBase().catch(i=>{u?.debug?.error("DynamicGradientStrategy","Failed to update living visualEffects base:",i)});let e=new CustomEvent("living-base-update",{detail:{baseHex:this.livingBaseState.currentBaseHex,primaryHex:this.livingBaseState.currentPrimaryHex,visualEffectsIntensity:this.livingBaseState.visualEffectsIntensity,timestamp:Date.now()}});document.dispatchEvent(e)}updateMusicResponsiveVariables(){let e={"--visualEffects-music-energy":this.livingBaseState.musicEnergy.toString(),"--visualEffects-music-intensity":this.livingBaseState.visualEffectsIntensity.toString()};try{this.cssController.batchSetVariables("DynamicGradientStrategy",e,3,"music-responsive")}catch(i){u?.debug?.error("DynamicGradientStrategy","Failed to update music responsive variables:",i)}}updateConsciousnessVariables(){let e={"--visualEffects-intensity-global":this.livingBaseState.visualEffectsIntensity.toString(),"--visualEffects-layer-opacity":(this.gradientConfig.visualEffectsLayerOpacity*this.livingBaseState.visualEffectsIntensity).toString()};try{this.cssController.batchSetVariables("DynamicGradientStrategy",e,3,"visualEffects-vars")}catch(i){u?.debug?.error("DynamicGradientStrategy","Failed to update visualEffects variables:",i)}}coordinateWithWebGLSystem(e){let i=e?{"--visualEffects-webgl-coordination":"0.7","--visualEffects-css-fallback":"0.3"}:{"--visualEffects-webgl-coordination":"0","--visualEffects-css-fallback":"1.0"};try{this.cssController.batchSetVariables("DynamicGradientStrategy",i,"high","webgl-coordination")}catch(r){u?.debug?.error("DynamicGradientStrategy","Failed to coordinate with WebGL system:",r)}u?.debug?.log("DynamicGradientStrategy",`WebGL coordination ${e?"enabled":"disabled"}`)}coordinateWithWebGLGradient(e){this.gradientConfig.webglIntegrationEnabled&&(e.flowState&&this.updateFlowStateFromWebGL(e.flowState),e.colorState&&this.updateColorStateFromWebGL(e.colorState))}updateFlowStateFromWebGL(e){let i={};if(e.flowX!==void 0&&(i["--visualEffects-webgl-flow-x"]=`${e.flowX}%`),e.flowY!==void 0&&(i["--visualEffects-webgl-flow-y"]=`${e.flowY}%`),e.flowScale!==void 0&&(i["--visualEffects-webgl-scale"]=e.flowScale.toString()),Object.keys(i).length>0)try{this.cssController.batchSetVariables("DynamicGradientStrategy",i,3,"webgl-flow")}catch(r){u?.debug?.error("DynamicGradientStrategy","Failed to update WebGL flow state:",r)}}updateColorStateFromWebGL(e){e.primaryColor&&(this.livingBaseState.currentPrimaryRgb=e.primaryColor,this.updateLivingConsciousnessBase())}async healthCheck(){let e=await this.getStrategyHealthCheck();return{healthy:e.healthy&&this.isActive,canProcess:e.canProcess,issues:e.issues||[],metrics:{...e.metrics,systemType:"consolidated-living-gradient",isVisualSystem:!0,isColorProcessor:!0,isActive:this.isActive,initialized:this.initialized}}}async getStrategyHealthCheck(){let e=Date.now()-this.livingBaseState.lastUpdateTime<3e4;return{healthy:this.gradientConfig.baseTransformationEnabled,canProcess:this.gradientConfig.baseTransformationEnabled,issues:this.gradientConfig.baseTransformationEnabled?[]:["Base transformation disabled in configuration"],metrics:{baseTransformationEnabled:this.gradientConfig.baseTransformationEnabled,responsiveAnimationEnabled:this.gradientConfig.responsiveAnimationEnabled,webglIntegrationActive:this.livingBaseState.webglIntegrationActive,visualEffectsIntensity:this.livingBaseState.visualEffectsIntensity,musicEnergy:this.livingBaseState.musicEnergy,hasRecentUpdate:e,cssFirstBreathing:!0,oklabInterpolation:this.gradientConfig.oklabInterpolationEnabled,oklabPreset:this.gradientConfig.oklabPreset,gradientSmoothness:this.gradientConfig.gradientSmoothness,oklabGradientStops:this.livingBaseState.oklabGradientStops.length}}}destroy(){this.cssAnimationManager&&this.cssAnimationManager.stopConsciousnessBreathing(),this.oklabCache.clear(),this.gradientCache.clear(),super.destroy(),u?.debug?.log("DynamicGradientStrategy","Consolidated living gradient system destroyed with complete cleanup")}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),u?.debug?.log("DynamicGradientStrategy","Living gradient system cleaned up")}updateConfig(e){this.gradientConfig={...this.gradientConfig,...e},("oklabInterpolationEnabled"in e||"oklabPreset"in e)&&(this.oklabProcessor=new T(this.config.enableDebug)),u?.debug?.log("DynamicGradientStrategy","Configuration updated:",{...e,oklabInterpolation:this.gradientConfig.oklabInterpolationEnabled,oklabPreset:this.gradientConfig.oklabPreset,gradientSmoothness:this.gradientConfig.gradientSmoothness})}stopBreathingAnimation(){this.cssAnimationManager&&this.cssAnimationManager.stopConsciousnessBreathing(),u?.debug?.log("DynamicGradientStrategy","CSS-first visualEffects animation stopped")}}});var Ct,fs=v(()=>{"use strict";Ct=class{static getAnimationDensity(t){switch(t){case"low":return .3;case"medium":return .7;case"high":return 1}}static getUpdateFrequency(t){switch(t){case"low":return 30;case"medium":return 45;case"high":return 60}}static getShaderComplexity(t){switch(t){case"low":return .4;case"medium":return .7;case"high":return 1}}static getParticleMultiplier(t){switch(t){case"low":return .3;case"medium":return .6;case"high":return 1}}static shouldEnableCorridorEffects(t){return t==="medium"||t==="high"}static shouldEnableAdvancedFeatures(t){return t==="high"}static getBlendMode(t){switch(t){case"low":return"normal";case"medium":return"screen";case"high":return"screen"}}static getFrameThrottling(t){switch(t){case"low":return 33;case"medium":return 22;case"high":return 16}}}});var Al,nt,va=v(()=>{"use strict";B();$();pe();R();fs();ee();ue();Lt();te();ft();Al=`#version 300 es
precision mediump float;

uniform float u_time;
uniform sampler2D u_gradientTex;
uniform vec2 u_resolution;
uniform float u_flowStrength;
uniform float u_noiseScale;

// Wave stack uniforms
uniform float u_waveY[2];
uniform float u_waveHeight[2];
uniform float u_waveOffset[2];
uniform float u_blurExp;
uniform float u_blurMax;

out vec4 fragColor;

// Simplex noise implementation
vec3 mod289(vec3 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec2 mod289(vec2 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec3 permute(vec3 x) {
  return mod289(((x*34.0)+1.0)*x);
}

float snoise(vec2 v) {
  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0
                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)
                     -0.577350269189626,  // -1.0 + 2.0 * C.x
                      0.024390243902439); // 1.0 / 41.0
  vec2 i  = floor(v + dot(v, C.yy) );
  vec2 x0 = v -   i + dot(i, C.xx);

  vec2 i1;
  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
  vec4 x12 = x0.xyxy + C.xxzz;
  x12.xy -= i1;

  i = mod289(i);
  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))
    + i.x + vec3(0.0, i1.x, 1.0 ));

  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
  m = m*m ;
  m = m*m ;

  vec3 x = 2.0 * fract(p * C.www) - 1.0;
  vec3 h = abs(x) - 0.5;
  vec3 ox = floor(x + 0.5);
  vec3 a0 = x - ox;

  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );

  vec3 g;
  g.x  = a0.x  * x0.x  + h.x  * x0.y;
  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
  return 130.0 * dot(m, g);
}

// Octave noise for richer detail
float octaveNoise(vec2 uv, float octaves, float persistence, float scale) {
  float value = 0.0;
  float amplitude = 1.0;
  float frequency = scale;
  float maxValue = 0.0;

  for(float i = 0.0; i < octaves; i++) {
    value += snoise(uv * frequency) * amplitude;
    maxValue += amplitude;
    amplitude *= persistence;
    frequency *= 2.0;
  }

  return value / maxValue;
}

// Wave alpha calculation with smooth transitions
float wave_alpha(vec2 uv, int waveIndex) {
  float y = uv.y;
  float waveCenter = u_waveY[waveIndex];
  float waveHeight = u_waveHeight[waveIndex];

  float distance = abs(y - waveCenter);
  float alpha = 1.0 - smoothstep(0.0, waveHeight * 0.5, distance);

  return alpha;
}

// Dynamic blur calculation using power function
float calc_blur(vec2 uv) {
  vec2 center = vec2(0.5, 0.5);
  float distance = length(uv - center);

  float blur = pow(distance, u_blurExp);
  blur = clamp(blur, 0.0, u_blurMax);

  return blur;
}

// Background noise generator with time offset
float background_noise(vec2 uv, float timeOffset) {
  vec2 flowUV = uv;
  float adjustedTime = u_time + timeOffset;

  flowUV.x += adjustedTime * 0.02 * u_flowStrength;
  flowUV.y += sin(adjustedTime * 0.03 + uv.x * 3.14159) * 0.01 * u_flowStrength;

  float noise1 = octaveNoise(flowUV * u_noiseScale, 4.0, 0.5, 1.0);
  float noise2 = octaveNoise(flowUV * u_noiseScale * 2.0 + vec2(100.0), 3.0, 0.4, 1.0);

  return (noise1 + noise2 * 0.3) * 0.5 + 0.5;
}

void main() {
  vec2 uv = gl_FragCoord.xy / u_resolution.xy;

  // Generate three distinct background noise fields with time offsets
  float noise1 = background_noise(uv, u_waveOffset[0]);
  float noise2 = background_noise(uv, u_waveOffset[1]);
  float noise3 = background_noise(uv, 0.0); // Base noise without offset

  // Calculate wave alphas for blending
  float alpha1 = wave_alpha(uv, 0);
  float alpha2 = wave_alpha(uv, 1);
  float alpha3 = 1.0 - alpha1 - alpha2; // Remaining area
  alpha3 = max(alpha3, 0.0); // Ensure non-negative

  // Normalize alphas to ensure they sum to 1.0
  float totalAlpha = alpha1 + alpha2 + alpha3;
  if (totalAlpha > 0.0) {
    alpha1 /= totalAlpha;
    alpha2 /= totalAlpha;
    alpha3 /= totalAlpha;
  }

  // Blend the three noise fields based on wave alphas
  float t = noise1 * alpha1 + noise2 * alpha2 + noise3 * alpha3;
  t = clamp(t, 0.0, 1.0);

  // Sample gradient texture
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));

  // Apply dynamic blur based on position
  float blurAmount = calc_blur(uv);

  // Apply subtle vignette with blur modulation
  vec2 center = uv - 0.5;
  float vignette = 1.0 - dot(center, center) * (0.3 + blurAmount * 0.2);
  color.rgb *= vignette;

  // Apply blur effect to alpha channel for depth
  color.a *= (1.0 - blurAmount * 0.3);

  fragColor = color;
}`,nt=class{constructor(t){this.initialized=!1;this.utils=k;this.config=w;this.webglState={canvas:null,wrapper:null,gl:null,shaderProgram:null,gradientTexture:null,vertexBuffer:null,vao:null,isWebGLAvailable:!1,webglReady:!1,animationId:null,startTime:0,lastFrameTime:0,lastUpdateTime:0,currentFlowStrength:.3,targetFlowStrength:.3,currentNoiseScale:1,targetNoiseScale:1,currentBlurExp:1.2,targetBlurExp:1.2,currentBlurMax:.5,targetBlurMax:.5,currentWaveY:[.3,.7],targetWaveY:[.3,.7],currentWaveHeight:[.4,.3],targetWaveHeight:[.4,.3],currentWaveOffset:[.1,.6],targetWaveOffset:[.1,.6]};this.uniforms={u_time:null,u_gradientTex:null,u_resolution:null,u_flowStrength:null,u_noiseScale:null,u_waveY:null,u_waveHeight:null,u_waveOffset:null,u_blurExp:null,u_blurMax:null};this.flowSettings={enabled:!0,intensity:"balanced",flowStrength:.7,noiseScale:1.2,waveY:[.25,.75],waveHeight:[.4,.3],waveOffset:[2.5,-1.8],blurExp:1.2,blurMax:.6,frameThrottleInterval:1e3/45,oklabProcessingEnabled:!0,oklabPreset:"VIBRANT",gradientTextureSize:512};this.prefersReducedMotion=!1;this.animateWebGL=()=>{if(!this.webglState.webglReady||!this.webglState.gl||!this.webglState.canvas)return;let t=performance.now();if(t-this.webglState.lastFrameTime<this.flowSettings.frameThrottleInterval){this.webglState.animationId=requestAnimationFrame(this.animateWebGL);return}this.webglState.lastFrameTime=t,this.renderWebGLFrame(t),this.webglState.animationId=requestAnimationFrame(this.animateWebGL)};this.lerpHalfLifeValues={flowStrength:.25,noiseScale:.3,blur:.2,wave:.35};this.resizeWebGLCanvas=()=>{if(!this.webglState.canvas)return;let t=window.devicePixelRatio||1,e=window.innerWidth,i=window.innerHeight;this.webglState.canvas.width=e*t,this.webglState.canvas.height=i*t,this.webglState.canvas.style.width=e+"px",this.webglState.canvas.style.height=i+"px"};this.deviceDetector=new W,this.cssController=t||A(),this.oklabProcessor=new T(this.config.enableDebug),this.cssController=A(),this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.webglState.isWebGLAvailable=this.checkWebGL2Support(),this.loadFlowSettings(),u?.debug?.log("WebGLGradientStrategy","\u{1F30A} WebGL gradient strategy initialized - Flow Gradient Recovery Debug",{webglAvailable:this.webglState.isWebGLAvailable,deviceCapability:this.deviceDetector.recommendPerformanceQuality(),oklabProcessing:this.flowSettings.oklabProcessingEnabled,flowSettings:{enabled:this.flowSettings.enabled,intensity:this.flowSettings.intensity,flowStrength:this.flowSettings.flowStrength,noiseScale:this.flowSettings.noiseScale},prefersReducedMotion:this.prefersReducedMotion,webgl2ContextTest:this.checkWebGL2Support()})}getStrategyName(){return"webgl-gradient"}canProcess(t){return u?.debug?.log("WebGLGradientStrategy","\u{1F50D} canProcess() - WebGL Gradient Capability Check",{isWebGLAvailable:this.webglState.isWebGLAvailable,flowSettingsEnabled:this.flowSettings.enabled,webglReady:this.webglState.webglReady,contextTrackUri:t.trackUri,contextColorCount:Object.keys(t.rawColors).length}),this.webglState.isWebGLAvailable?this.flowSettings.enabled?E.get("sn-webgl-enabled")?(u?.debug?.log("WebGLGradientStrategy","canProcess: WebGL force enabled - bypassing device restrictions"),!0):(this.deviceDetector.recommendPerformanceQuality()==="low"&&u?.debug?.log("WebGLGradientStrategy","canProcess: Low performance device detected, allowing based on strategy selection (not force mode)"),!0):(u?.debug?.warn("WebGLGradientStrategy","\u274C canProcess: WebGL strategy disabled in settings"),!1):(u?.debug?.warn("WebGLGradientStrategy","\u274C canProcess: WebGL not available - failed WebGL2 context check"),!1)}getEstimatedProcessingTime(t){let i=this.flowSettings.intensity==="intense"?1.3:1;return Math.round(12*i)}async processColors(t){let e=performance.now(),i={};try{this.webglState.webglReady||await this.initializeWebGLGradient();let r=t.rawColors;if(this.flowSettings.oklabProcessingEnabled){let c=T.getPreset(this.flowSettings.oklabPreset);i=this.oklabProcessor.processColorPalette(t.rawColors,c),r=Object.fromEntries(Object.entries(i).map(([m,d])=>[m,d.enhancedHex])),u?.debug?.log("WebGLGradientStrategy","OKLAB color enhancement applied:",{originalColors:Object.keys(t.rawColors).length,processedColors:Object.keys(r).length,preset:c.name})}let a=this.createGradientStops(r,i);await this.updateGradientTexture(a),await this.enableHybridCoordination(),this.webglState.animationId||this.startWebGLAnimation(),t.musicData?.energy!==void 0&&await this.updateFlowWithMusicEnergy(t.musicData.energy),this.webglState.lastUpdateTime=Date.now();let n=performance.now()-e,s=this.selectPrimaryColor(r)||Z.getDefaultAccentColor().hex,l={processedColors:{webgl:"active",gradientStops:a.length.toString(),...r,...Object.keys(t.rawColors).length>0&&{originalColors:JSON.stringify(t.rawColors)}},accentHex:s,accentRgb:this.convertToRgbString(s),metadata:{strategy:this.getStrategyName(),processingTime:n,cacheKey:`webgl-gradient-${t.trackUri}`,harmonicIntensity:this.flowSettings.flowStrength,webglReady:this.webglState.webglReady,oklabProcessing:this.flowSettings.oklabProcessingEnabled,oklabPreset:this.flowSettings.oklabPreset,gradientTextureSize:this.flowSettings.gradientTextureSize,oklabResultsCount:Object.keys(i).length},context:t};return u?.debug?.log("WebGLGradientStrategy","WebGL gradient processing completed",{gradientStops:a.length,processingTime:n,trackUri:t.trackUri}),l}catch(r){let a=performance.now()-e;u?.debug?.error("WebGLGradientStrategy","WebGL gradient processing failed:",r);let n=await this.executeProgressiveFallback(t,r);return{...n,metadata:{...n.metadata,strategy:this.getStrategyName(),processingTime:a,error:r instanceof Error?r.message:"Unknown error"},context:t}}}async initialize(){if(this.initialized){u?.debug?.warn("WebGLGradientStrategy","Already initialized, skipping");return}try{await this.deviceDetector.initialize(),this.webglState.isWebGLAvailable?await this.initializeWebGLGradient():u?.debug?.warn("WebGLGradientStrategy","WebGL2 not available, will use CSS fallback when processColors is called"),this.initialized=!0,u?.debug?.log("WebGLGradientStrategy","System initialized successfully",{webglAvailable:this.webglState.isWebGLAvailable,webglReady:this.webglState.webglReady})}catch(t){u?.debug?.error("WebGLGradientStrategy","Initialization failed:",t),this.initialized=!0}}updateAnimation(t){this.webglState.webglReady&&!this.webglState.animationId&&this.startWebGLAnimation()}checkWebGL2Support(){return document.createElement("canvas").getContext("webgl2")!==null}loadFlowSettings(){try{let t=E.get("sn-gradient-intensity");if(t==="disabled"){this.flowSettings.enabled=!1;return}switch(this.flowSettings.intensity=t||"balanced",this.flowSettings.intensity){case"minimal":this.flowSettings.flowStrength=.4,this.flowSettings.noiseScale=.8,this.flowSettings.waveHeight=[.3,.2],this.flowSettings.waveOffset=[1.5,-1],this.flowSettings.blurExp=1,this.flowSettings.blurMax=.4;break;case"balanced":this.flowSettings.flowStrength=.7,this.flowSettings.noiseScale=1.2,this.flowSettings.waveHeight=[.4,.3],this.flowSettings.waveOffset=[2.5,-1.8],this.flowSettings.blurExp=1.2,this.flowSettings.blurMax=.6;break;case"intense":this.flowSettings.flowStrength=1,this.flowSettings.noiseScale=1.6,this.flowSettings.waveHeight=[.5,.4],this.flowSettings.waveOffset=[3.5,-2.5],this.flowSettings.blurExp=1.4,this.flowSettings.blurMax=.8;break}}catch(t){u?.debug?.warn("WebGLGradientStrategy","Failed to load settings, using defaults:",t)}}async initializeWebGLGradient(){if(!this.webglState.isWebGLAvailable)throw new Error("WebGL2 not available");await this.createWebGLCanvas(),await this.initializeWebGLContext(),await this.compileWebGLShaders(),this.createWebGLGeometry(),this.setupWebGLUniforms(),this.resizeWebGLCanvas(),this.attachWebGLToDom(),window.addEventListener("resize",this.resizeWebGLCanvas.bind(this)),this.webglState.webglReady=!0;try{let t=A();t.setPerformanceTokens({webglReady:!0,activeBackend:"webgl-strategy",qualityLevel:"high",gpuAcceleration:!0}),u?.debug?.log("WebGLGradientStrategy","\u{1F3A8} WebGL readiness announced to CSS visual effects system - CSS Variables Set",{webglReady:!0,activeBackend:"webgl-strategy",qualityLevel:"high",gpuAcceleration:!0,cssControllerReady:!!t})}catch(t){u?.debug?.warn("WebGLGradientStrategy","\u274C Failed to announce WebGL readiness - CSS Variables NOT Set:",t)}u?.debug?.log("WebGLGradientStrategy","WebGL gradient system initialized successfully")}async createWebGLCanvas(){u?.debug?.log("WebGLGradientStrategy","\u{1F3A8} Creating WebGL canvas and wrapper elements"),this.webglState.wrapper=document.createElement("div"),this.webglState.wrapper.className="sn-webgl-gradient-wrapper",this.webglState.wrapper.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -11;
      pointer-events: none;
      overflow: hidden;
    `,this.webglState.canvas=document.createElement("canvas"),this.webglState.canvas.id="sn-webgl-gradient-strategy",this.webglState.canvas.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    `,this.webglState.wrapper.appendChild(this.webglState.canvas),u?.debug?.log("WebGLGradientStrategy","\u2705 WebGL canvas and wrapper created successfully",{wrapperId:this.webglState.wrapper.className,canvasId:this.webglState.canvas.id,wrapperStyle:this.webglState.wrapper.style.cssText.replace(/\s+/g," ").trim()})}async initializeWebGLContext(){if(!this.webglState.canvas)throw new Error("Canvas not created");if(this.webglState.gl=this.webglState.canvas.getContext("webgl2",{alpha:!0,antialias:!1,depth:!1,stencil:!1,powerPreference:"default"}),!this.webglState.gl)throw new Error("Failed to get WebGL2 context")}async compileWebGLShaders(){if(!this.webglState.gl)throw new Error("WebGL context not available");let t=Q.loadVertex(this.webglState.gl,Vt),e=Q.loadFragment(this.webglState.gl,Al);if(!t||!e)throw new Error("Failed to compile shaders");if(this.webglState.shaderProgram=Q.createProgram(this.webglState.gl,t,e),!this.webglState.shaderProgram)throw new Error("Failed to create shader program")}createWebGLGeometry(){if(!this.webglState.gl||!this.webglState.shaderProgram)return;let t=new Float32Array([-1,-1,3,-1,-1,3]);this.webglState.vertexBuffer=this.webglState.gl.createBuffer(),this.webglState.gl.bindBuffer(this.webglState.gl.ARRAY_BUFFER,this.webglState.vertexBuffer),this.webglState.gl.bufferData(this.webglState.gl.ARRAY_BUFFER,t,this.webglState.gl.STATIC_DRAW),this.webglState.vao=this.webglState.gl.createVertexArray(),this.webglState.gl.bindVertexArray(this.webglState.vao);let e=this.webglState.gl.getAttribLocation(this.webglState.shaderProgram,"a_position");this.webglState.gl.enableVertexAttribArray(e),this.webglState.gl.vertexAttribPointer(e,2,this.webglState.gl.FLOAT,!1,0,0),this.webglState.gl.bindVertexArray(null)}setupWebGLUniforms(){!this.webglState.gl||!this.webglState.shaderProgram||(this.uniforms.u_time=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_time"),this.uniforms.u_gradientTex=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_gradientTex"),this.uniforms.u_resolution=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_resolution"),this.uniforms.u_flowStrength=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_flowStrength"),this.uniforms.u_noiseScale=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_noiseScale"),this.uniforms.u_waveY=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_waveY"),this.uniforms.u_waveHeight=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_waveHeight"),this.uniforms.u_waveOffset=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_waveOffset"),this.uniforms.u_blurExp=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_blurExp"),this.uniforms.u_blurMax=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_blurMax"))}createGradientStops(t,e={}){let i=["PRIMARY","VIBRANT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT","DARK_VIBRANT","PROMINENT"],r=[],a=new Set,n=0;for(let s of i){let l=t[s];if(l&&!a.has(l)){let c=e[s],m=c?c.enhancedHex:l,d=this.utils.hexToRgb(m);if(d&&(r.push({r:d.r/255,g:d.g/255,b:d.b/255,a:1,position:n/(Math.min(i.length,4)-1),...c&&{oklabOriginal:c.originalHex,oklabEnhanced:c.enhancedHex}}),a.add(l),n++,r.length>=4))break}}return r.length===0?this.getDefaultGradientStops():r}getDefaultGradientStops(){return[{r:.196,g:.165,b:.282,a:1,position:0},{r:.549,g:.408,b:.878,a:1,position:.3},{r:.788,g:.557,b:.902,a:1,position:.6},{r:.957,g:.761,b:.494,a:1,position:1}]}async updateGradientTexture(t){if(this.webglState.gl){if(this.webglState.gradientTexture&&this.webglState.gl.deleteTexture(this.webglState.gradientTexture),this.webglState.gradientTexture=me(this.webglState.gl,t),!this.webglState.gradientTexture)throw new Error("Failed to create gradient texture");await this.updateCSSFallbackVariables(t)}}async updateCSSFallbackVariables(t){let e=Math.min(8,t.length),i={"--sn-grad-stop-count":String(e)};for(let r=0;r<e;r++){let a=t[r];a&&(i[`--sn-grad-stop-${r}-rgb`]=`${Math.round(a.r*255)},${Math.round(a.g*255)},${Math.round(a.b*255)}`)}await this.cssController.batchSetVariables("WebGLGradientStrategy",i,"normal","gradient-stops-configuration")}async enableHybridCoordination(){let t={"--sn-webgl-ready":"1","--sn-webgl-enabled":"1","--sn-current-backend":"hybrid","--sn-gradient-crossfade-opacity":"0.5"};u?.debug?.log("WebGLGradientStrategy","\u{1F517} Setting hybrid coordination CSS variables - WebGL Gradient Activation",{variables:t,cssControllerReady:!!this.cssController}),await this.cssController.batchSetVariables("WebGLGradientStrategy",t,"high","hybrid-coordination-enable"),u?.debug?.log("WebGLGradientStrategy","\u2705 Hybrid coordination CSS variables set successfully")}startWebGLAnimation(){this.webglState.startTime=performance.now(),this.webglState.lastFrameTime=this.webglState.startTime,this.animateWebGL()}updateUniformsWithLERP(t){this.webglState.targetFlowStrength=this.flowSettings.flowStrength,this.webglState.targetNoiseScale=this.flowSettings.noiseScale,this.webglState.targetBlurExp=this.flowSettings.blurExp,this.webglState.targetBlurMax=this.flowSettings.blurMax,this.webglState.targetWaveY=[this.flowSettings.waveY[0],this.flowSettings.waveY[1]],this.webglState.targetWaveHeight=[this.flowSettings.waveHeight[0],this.flowSettings.waveHeight[1]],this.webglState.targetWaveOffset=[this.flowSettings.waveOffset[0],this.flowSettings.waveOffset[1]],this.webglState.currentFlowStrength=K(this.webglState.currentFlowStrength,this.webglState.targetFlowStrength,t,this.lerpHalfLifeValues.flowStrength),this.webglState.currentNoiseScale=K(this.webglState.currentNoiseScale,this.webglState.targetNoiseScale,t,this.lerpHalfLifeValues.noiseScale),this.webglState.currentBlurExp=K(this.webglState.currentBlurExp,this.webglState.targetBlurExp,t,this.lerpHalfLifeValues.blur),this.webglState.currentBlurMax=K(this.webglState.currentBlurMax,this.webglState.targetBlurMax,t,this.lerpHalfLifeValues.blur);let e=0,i=1;this.webglState.currentWaveY[e]=K(this.webglState.currentWaveY[e],this.webglState.targetWaveY[e],t,this.lerpHalfLifeValues.wave),this.webglState.currentWaveY[i]=K(this.webglState.currentWaveY[i],this.webglState.targetWaveY[i],t,this.lerpHalfLifeValues.wave),this.webglState.currentWaveHeight[e]=K(this.webglState.currentWaveHeight[e],this.webglState.targetWaveHeight[e],t,this.lerpHalfLifeValues.wave),this.webglState.currentWaveHeight[i]=K(this.webglState.currentWaveHeight[i],this.webglState.targetWaveHeight[i],t,this.lerpHalfLifeValues.wave),this.webglState.currentWaveOffset[e]=K(this.webglState.currentWaveOffset[e],this.webglState.targetWaveOffset[e],t,this.lerpHalfLifeValues.wave),this.webglState.currentWaveOffset[i]=K(this.webglState.currentWaveOffset[i],this.webglState.targetWaveOffset[i],t,this.lerpHalfLifeValues.wave)}renderWebGLFrame(t){if(!this.webglState.gl||!this.webglState.shaderProgram||!this.webglState.vao||!this.webglState.gradientTexture)return;let e=(t-this.webglState.lastFrameTime)/1e3;this.updateUniformsWithLERP(e),this.webglState.gl.viewport(0,0,this.webglState.canvas.width,this.webglState.canvas.height),this.webglState.gl.clearColor(0,0,0,0),this.webglState.gl.clear(this.webglState.gl.COLOR_BUFFER_BIT),this.webglState.gl.useProgram(this.webglState.shaderProgram),this.webglState.gl.bindVertexArray(this.webglState.vao);let i=this.prefersReducedMotion?0:(t-this.webglState.startTime)/1e3;this.uniforms.u_time&&this.webglState.gl.uniform1f(this.uniforms.u_time,i),this.uniforms.u_resolution&&this.webglState.gl.uniform2f(this.uniforms.u_resolution,this.webglState.canvas.width,this.webglState.canvas.height),this.uniforms.u_flowStrength&&this.webglState.gl.uniform1f(this.uniforms.u_flowStrength,this.webglState.currentFlowStrength),this.uniforms.u_noiseScale&&this.webglState.gl.uniform1f(this.uniforms.u_noiseScale,this.webglState.currentNoiseScale),this.uniforms.u_waveY&&this.webglState.gl.uniform1fv(this.uniforms.u_waveY,this.webglState.currentWaveY),this.uniforms.u_waveHeight&&this.webglState.gl.uniform1fv(this.uniforms.u_waveHeight,this.webglState.currentWaveHeight),this.uniforms.u_waveOffset&&this.webglState.gl.uniform1fv(this.uniforms.u_waveOffset,this.webglState.currentWaveOffset),this.uniforms.u_blurExp&&this.webglState.gl.uniform1f(this.uniforms.u_blurExp,this.webglState.currentBlurExp),this.uniforms.u_blurMax&&this.webglState.gl.uniform1f(this.uniforms.u_blurMax,this.webglState.currentBlurMax),this.webglState.gl.activeTexture(this.webglState.gl.TEXTURE0),this.webglState.gl.bindTexture(this.webglState.gl.TEXTURE_2D,this.webglState.gradientTexture),this.uniforms.u_gradientTex&&this.webglState.gl.uniform1i(this.uniforms.u_gradientTex,0),this.webglState.gl.drawArrays(this.webglState.gl.TRIANGLES,0,3),this.webglState.gl.bindVertexArray(null)}async updateFlowWithMusicEnergy(t){let e=this.flowSettings.flowStrength,i=1+t*.5,r=e*i;await this.cssController.setVariable("WebGLGradientStrategy","--sn-flow-strength",r.toString(),"high","music-energy-flow-strength")}attachWebGLToDom(){if(!this.webglState.wrapper){u?.debug?.error("WebGLGradientStrategy","\u274C Cannot attach to DOM - wrapper element not created");return}u?.debug?.log("WebGLGradientStrategy","\u{1F517} Attaching WebGL canvas to DOM - Searching for container");let t=[".Root__main-view",".main-view-container",".main-gridContainer-gridContainer",".Root__top-container","body"],e=null,i=[];for(let r of t)if(e=document.querySelector(r),i.push({selector:r,found:!!e}),e)break;e||(e=document.body),e.appendChild(this.webglState.wrapper),u?.debug?.log("WebGLGradientStrategy","\u2705 WebGL canvas attached to DOM successfully",{containerSearch:i,selectedContainer:e?.tagName||"unknown",containerClass:e?.className||"none",wrapperId:this.webglState.wrapper.className,canvasId:this.webglState.canvas?.id||"not-created"})}async executeProgressiveFallback(t,e){let i=this.selectPrimaryColor(t.rawColors)||Z.getDefaultAccentColor().hex;try{return u?.debug?.warn("WebGLGradientStrategy","Attempting CSS gradient fallback"),await this.fallbackToCSSGradient(),{processedColors:{...t.rawColors,fallbackMethod:"css-gradient"},accentHex:i,accentRgb:this.convertToRgbString(i),metadata:{strategy:this.getStrategyName(),processingTime:0,fallbackMode:"css-gradient",fallbackReason:"webgl-failed",gradientStops:Object.keys(t.rawColors).length},context:t}}catch(r){return u?.debug?.error("WebGLGradientStrategy","CSS gradient fallback failed, using solid color:",r),await this.fallbackToSolidColor(t,i,e,r)}}async fallbackToSolidColor(t,e,i,r){try{return await this.cssController?.queueUpdate("--sn-accent-color",e,"critical","solid-color-fallback"),{processedColors:{accentColor:e,fallbackMethod:"solid-color",originalColors:JSON.stringify(t.rawColors)},accentHex:e,accentRgb:this.convertToRgbString(e),metadata:{strategy:this.getStrategyName(),processingTime:0,fallbackMode:"solid-color",fallbackReason:"all-gradients-failed",webglError:i instanceof Error?i.message:"Unknown WebGL error",cssError:r instanceof Error?r.message:"Unknown CSS error",emergencyMode:!0},context:t}}catch(a){return u?.debug?.error("WebGLGradientStrategy","All fallback methods failed, using emergency mode:",a),{processedColors:{emergencyMode:"true"},accentHex:"#ff6b9d",accentRgb:"rgb(255, 107, 157)",metadata:{strategy:this.getStrategyName(),processingTime:0,fallbackMode:"emergency",fallbackReason:"complete-system-failure",criticalError:!0},context:t}}}async fallbackToCSSGradient(){let t={"--sn-webgl-ready":"0","--sn-webgl-enabled":"0","--sn-current-backend":"css","--sn-gradient-crossfade-opacity":"0"};await this.cssController.batchSetVariables("WebGLGradientStrategy",t,"critical","css-gradient-fallback"),this.cssController&&this.startCSSFallbackAnimation(),u?.debug?.log("WebGLGradientStrategy","Using CSS gradient fallback")}startCSSFallbackAnimation(){if(!this.cssController)return;let t=()=>{if(!this.webglState.webglReady)return;let e=performance.now()/1e3,i=Math.sin(e*.04)*20+Math.sin(e*.07)*8,r=Math.cos(e*.05)*20+Math.cos(e*.09)*6,a=1.15+Math.sin(e*.03)*.2;this.cssController.queueCSSVariableUpdate("--sn-gradient-flow-x",`${i}%`),this.cssController.queueCSSVariableUpdate("--sn-gradient-flow-y",`${r}%`),this.cssController.queueCSSVariableUpdate("--sn-gradient-flow-scale",a.toString()),setTimeout(t,this.flowSettings.frameThrottleInterval)};t()}selectPrimaryColor(t){let e=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let i of e){let r=t[i];if(r&&this.utils.hexToRgb(r))return r}return null}convertToRgbString(t){let e=this.utils.hexToRgb(t);return e?`${e.r},${e.g},${e.b}`:"203,166,247"}updateConfig(t){this.flowSettings={...this.flowSettings,...t},("oklabProcessingEnabled"in t||"oklabPreset"in t)&&(this.oklabProcessor=new T(this.config.enableDebug)),u?.debug?.log("WebGLGradientStrategy","Configuration updated:",{...t,oklabProcessing:this.flowSettings.oklabProcessingEnabled,oklabPreset:this.flowSettings.oklabPreset,gradientTextureSize:this.flowSettings.gradientTextureSize})}async healthCheck(){let t=Date.now()-this.webglState.lastUpdateTime<3e4,e=this.webglState.webglReady&&this.flowSettings.enabled,i=[];this.webglState.webglReady||i.push("WebGL system not ready"),this.flowSettings.enabled||i.push("WebGL gradient disabled in settings");let r={system:"WebGLGradientStrategy",healthy:e,details:e?"WebGL gradient rendering active":i.join("; "),metrics:{webglAvailable:this.webglState.isWebGLAvailable,webglReady:this.webglState.webglReady,flowEnabled:this.flowSettings.enabled,initialized:this.initialized,intensity:this.flowSettings.intensity,deviceCapability:this.deviceDetector.recommendPerformanceQuality(),hasRecentUpdate:t,animationActive:this.webglState.animationId!==null,oklabProcessing:this.flowSettings.oklabProcessingEnabled,oklabPreset:this.flowSettings.oklabPreset,gradientTextureSize:this.flowSettings.gradientTextureSize,...this.webglState.canvas&&{canvasSize:{width:this.webglState.canvas.width,height:this.webglState.canvas.height}},canProcess:this.canProcess({})}};return i.length>0&&(r.issues=i),r}destroy(){this.webglState.animationId&&(cancelAnimationFrame(this.webglState.animationId),this.webglState.animationId=null),this.webglState.gl&&(this.webglState.gradientTexture&&(this.webglState.gl.deleteTexture(this.webglState.gradientTexture),this.webglState.gradientTexture=null),this.webglState.vertexBuffer&&(this.webglState.gl.deleteBuffer(this.webglState.vertexBuffer),this.webglState.vertexBuffer=null),this.webglState.vao&&(this.webglState.gl.deleteVertexArray(this.webglState.vao),this.webglState.vao=null),this.webglState.shaderProgram&&(this.webglState.gl.deleteProgram(this.webglState.shaderProgram),this.webglState.shaderProgram=null),Q.clearCache(this.webglState.gl)),this.webglState.wrapper&&this.webglState.wrapper.parentNode&&(this.webglState.wrapper.parentNode.removeChild(this.webglState.wrapper),this.webglState.wrapper=null),this.webglState.canvas=null,this.webglState.gl=null,this.webglState.webglReady=!1,window.removeEventListener("resize",this.resizeWebGLCanvas);let t={"--sn-webgl-ready":"0","--sn-webgl-enabled":"0","--sn-current-backend":"css","--sn-gradient-crossfade-opacity":"0"};try{this.cssController.batchSetVariables("WebGLGradientStrategy",t,"critical","strategy-destroy-cleanup")}catch(e){u?.debug?.error("WebGLGradientStrategy","Error during destroy cleanup:",e)}u?.debug?.log("WebGLGradientStrategy","WebGL gradient strategy destroyed")}setEnabled(t){t&&this.isCapable()?(this.webglState.webglReady?this.webglState.animationId||(this.startWebGLAnimation(),u?.debug?.log("WebGLGradientStrategy","WebGL animation resumed")):this.initializeWebGLGradient().then(()=>{this.webglState.webglReady&&(this.startWebGLAnimation(),u?.debug?.log("WebGLGradientStrategy","WebGL enabled and animation started"))}).catch(e=>{u?.debug?.warn("WebGLGradientStrategy","Failed to enable WebGL:",e)}),this.flowSettings.enabled=!0,this.cssController.setVariable("--sn-current-backend","webgl","critical","webgl-enable")):(this.webglState.animationId&&(cancelAnimationFrame(this.webglState.animationId),this.webglState.animationId=null),this.flowSettings.enabled=!1,this.cssController.setVariable("--sn-current-backend","css","critical","webgl-disable"),u?.debug?.log("WebGLGradientStrategy","WebGL disabled, using CSS fallback"))}setQuality(t){let e,i;switch(t){case"low":e="minimal",i=Ct.getFrameThrottling(t);break;case"medium":e="balanced",i=Ct.getFrameThrottling(t);break;case"high":e="intense",i=Ct.getFrameThrottling(t);break}let r=this.flowSettings.intensity;this.flowSettings.intensity=e,this.flowSettings.frameThrottleInterval=i,this.loadFlowSettings(),u?.debug?.log("WebGLGradientStrategy",`Quality changed: ${t} (${r} \u2192 ${e}, ${i.toFixed(1)}ms frame target)`)}isEnabled(){return this.flowSettings.enabled&&this.webglState.webglReady&&this.webglState.animationId!==null}isCapable(){return this.webglState.isWebGLAvailable}getQuality(){switch(this.flowSettings.intensity){case"minimal":return"low";case"balanced":return"medium";case"intense":return"high";default:return"medium"}}getSystemName(){return"WebGLGradientStrategy"}}});var Ri,bs=v(()=>{"use strict";pe();R();ee();ya();gs();Li();va();Ri=class{constructor(){this.strategyInstances=new Map;this.strategyMetadata=new Map;this.deviceDetector=new W,this.initializeStrategyMetadata(),u?.debug?.log("ColorStrategySelector","Strategy selector initialized")}initializeStrategyMetadata(){this.strategyMetadata.set("dynamic-catppuccin",{name:"dynamic-catppuccin",priority:10,estimatedProcessingTime:5,memoryImpact:2,qualityScore:9,compatibilityScore:10}),this.strategyMetadata.set("living-gradient",{name:"living-gradient",priority:8,estimatedProcessingTime:8,memoryImpact:3,qualityScore:8,compatibilityScore:9}),this.strategyMetadata.set("webgl-gradient",{name:"webgl-gradient",priority:6,estimatedProcessingTime:12,memoryImpact:7,qualityScore:10,compatibilityScore:6}),this.strategyMetadata.set("webgl-gradient-degraded",{name:"webgl-gradient-degraded",priority:5,estimatedProcessingTime:8,memoryImpact:4,qualityScore:6,compatibilityScore:8}),this.strategyMetadata.set("depth-layered",{name:"depth-layered",priority:7,estimatedProcessingTime:15,memoryImpact:5,qualityScore:9,compatibilityScore:7})}selectStrategies(t,e){let i=performance.now(),r=[];try{let a=e.deviceContext||this.buildDeviceContext(),n=e.settingsContext||this.buildSettingsContext();u?.debug?.log("ColorStrategySelector","\u{1F3AF} Strategy Selection Debug - WebGL Gradient Analysis",{trackUri:t.trackUri,colorCount:Object.keys(t.rawColors).length,deviceContext:{supportsWebGL:a.supportsWebGL,performanceLevel:a.performanceLevel,memoryCapacity:a.memoryCapacity,isMobile:a.isMobile},settingsContext:{webglEnabled:n.webglEnabled,webglForceEnabled:n.webglForceEnabled,gradientIntensity:n.gradientIntensity,visualEffectsLevel:n.visualEffectsLevel}});let s=this.analyzeStrategyCompatibility(t,{...e,deviceContext:a,settingsContext:n});for(let c of s)if(u?.debug?.log("ColorStrategySelector",`Strategy decision: ${c.strategyName}`,{shouldInclude:c.shouldInclude,reason:c.reason,score:c.score}),c.shouldInclude){let m=this.getOrCreateStrategy(c.strategyName);if(m){let d=m.canProcess(t);u?.debug?.log("ColorStrategySelector",`Strategy ${c.strategyName} canProcess check`,{canProcess:d,strategyName:c.strategyName,contextColors:Object.keys(t.rawColors).length}),d?(r.push(m),u?.debug?.log("ColorStrategySelector",`\u2705 Selected strategy: ${c.strategyName}`)):u?.debug?.warn("ColorStrategySelector",`\u274C Strategy rejected by canProcess(): ${c.strategyName}`)}else u?.debug?.error("ColorStrategySelector",`Failed to create strategy: ${c.strategyName}`)}if(r.length===0){let c=this.getOrCreateStrategy("living-gradient");c?.canProcess(t)&&r.push(c)}let l=performance.now()-i;return u?.debug?.log("ColorStrategySelector","\u{1F3AF} Strategy selection completed",{selectedCount:r.length,strategies:r.map(c=>c.getStrategyName()),processingTime:l,deviceLevel:a.performanceLevel,visualGuideMode:n.visualGuideMode,webglEnabled:n.webglEnabled,webglForceEnabled:n.webglForceEnabled,supportsWebGL:a.supportsWebGL,totalDecisions:s.length,includedDecisions:s.filter(c=>c.shouldInclude).length}),r}catch(a){u?.debug?.error("ColorStrategySelector","Strategy selection failed:",a);let n=this.getOrCreateStrategy("living-gradient");return n?[n]:[]}}analyzeStrategyCompatibility(t,e){let i=[],r=this.scoreDynamicCatppuccinStrategy(e);i.push({strategyName:"dynamic-catppuccin",shouldInclude:e.settingsContext.dynamicAccentEnabled&&r>.5,reason:e.settingsContext.dynamicAccentEnabled?`Dynamic accent enabled (score: ${r.toFixed(2)})`:"Dynamic accent disabled in settings",score:r});let a=this.scoreDynamicGradientStrategy(e);i.push({strategyName:"living-gradient",shouldInclude:a>.3,reason:`Living gradient foundation (score: ${a.toFixed(2)})`,score:a});let n=this.scoreWebGLGradientStrategy(e),s=this.scoreWebGLDegradedStrategy(e),l=e.settingsContext.webglEnabled&&e.deviceContext.supportsWebGL&&(e.deviceContext.performanceLevel!=="low"||e.settingsContext.webglForceEnabled)&&n>.6;i.push({strategyName:"webgl-gradient",shouldInclude:l,reason:`WebGL full quality (score: ${n.toFixed(2)}, device: ${e.deviceContext.performanceLevel}${e.settingsContext.webglForceEnabled?", FORCED":""})`,score:n}),i.push({strategyName:"webgl-gradient-degraded",shouldInclude:e.settingsContext.webglEnabled&&e.deviceContext.supportsWebGL&&e.deviceContext.performanceLevel==="low"&&!e.settingsContext.webglForceEnabled&&s>.4,reason:`WebGL degraded mode (score: ${s.toFixed(2)}, device: low${e.settingsContext.webglForceEnabled?", skipped due to force":""})`,score:s});let c=this.scoreDepthLayeredStrategy(e);return i.push({strategyName:"depth-layered",shouldInclude:e.settingsContext.depthLayersEnabled&&e.settingsContext.visualEffectsLevel>.4&&e.deviceContext.performanceLevel!=="low"&&c>.5,reason:`Depth visual effects (score: ${c.toFixed(2)}, visual-effects: ${e.settingsContext.visualEffectsLevel})`,score:c}),i}scoreDynamicCatppuccinStrategy(t){let e=.8;return t.settingsContext.dynamicAccentEnabled&&(e+=.2),t.musicContext?.energy&&t.musicContext.energy>.7&&(e+=.1),["cosmic","cinematic","ethereal","natural"].includes(t.settingsContext.visualGuideMode)&&(e+=.1),e+=.1,Math.min(1,e)}scoreDynamicGradientStrategy(t){let e=.9;return t.settingsContext.pulsingAnimationEnabled&&(e+=.1),e+=t.settingsContext.visualEffectsLevel*.2,t.musicContext?.valence!==void 0&&(e+=.05),t.deviceContext.performanceLevel==="high"&&(e+=.05),Math.min(1,e)}scoreWebGLGradientStrategy(t){let e=0;if(!t.deviceContext.supportsWebGL||!t.settingsContext.webglEnabled)return 0;switch(e=.6,t.settingsContext.webglForceEnabled&&(e+=.4,u?.debug?.log("ColorStrategySelector","WebGL force enabled - boosting score by 0.4")),t.deviceContext.performanceLevel){case"high":e+=.3;break;case"medium":e+=.2;break;case"low":if(!t.settingsContext.webglForceEnabled)return 0;e+=.1;break}return t.deviceContext.memoryCapacity>4e3&&(e+=.1),t.deviceContext.memoryCapacity>8e3&&(e+=.1),t.settingsContext.visualEffectsLevel>.7&&(e+=.1),t.musicContext?.energy&&t.musicContext.energy>.8&&(e+=.1),t.deviceContext.isMobile&&(e-=.2),Math.min(1,Math.max(0,e))}scoreWebGLDegradedStrategy(t){let e=0;return!t.deviceContext.supportsWebGL||!t.settingsContext.webglEnabled||t.deviceContext.performanceLevel!=="low"?0:(e=.5,e+=.3,t.settingsContext.visualEffectsLevel>.5&&(e+=.1),t.musicContext?.energy&&t.musicContext.energy>.6&&(e+=.05),t.deviceContext.isMobile&&(e-=.1),t.deviceContext.memoryCapacity>2e3&&(e+=.05),Math.min(1,Math.max(0,e)))}scoreDepthLayeredStrategy(t){let e=0;if(!t.settingsContext.depthLayersEnabled)return 0;switch(e=.5,e+=t.settingsContext.visualEffectsLevel*.4,t.deviceContext.performanceLevel){case"high":e+=.2;break;case"medium":e+=.1;break;case"low":return e=0,0}return["cosmic","cinematic"].includes(t.settingsContext.visualGuideMode)&&(e+=.2),t.musicContext?.tempo&&t.musicContext.tempo<100&&(e+=.1),t.deviceContext.memoryCapacity>6e3&&(e+=.1),t.deviceContext.isMobile&&(e-=.15),Math.min(1,Math.max(0,e))}buildDeviceContext(){let t=window.navigator.deviceMemory?window.navigator.deviceMemory*1024:4096,e=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);return{supportsWebGL:this.deviceDetector.hasWebGLSupport(),performanceLevel:this.deviceDetector.recommendPerformanceQuality(),memoryCapacity:t,isMobile:e}}buildSettingsContext(){try{return{dynamicAccentEnabled:!0,gradientIntensity:E.get("sn-gradient-intensity"),webglEnabled:E.get("sn-webgl-enabled"),webglForceEnabled:E.get("sn-webgl-enabled"),visualGuideMode:E.get("sn-artistic-mode"),depthLayersEnabled:E.get("sn-gradient-intensity")!=="disabled",visualEffectsLevel:.8,pulsingAnimationEnabled:!0}}catch(t){return u?.debug?.warn("ColorStrategySelector","Failed to load settings, using defaults:",t),{dynamicAccentEnabled:!0,gradientIntensity:"balanced",webglEnabled:!0,webglForceEnabled:!1,visualGuideMode:"cosmic",depthLayersEnabled:!0,visualEffectsLevel:.8,pulsingAnimationEnabled:!0}}}getOrCreateStrategy(t){if(this.strategyInstances.has(t))return this.strategyInstances.get(t);let e=null;try{switch(t){case"dynamic-catppuccin":e=new Di;break;case"living-gradient":e=new at;break;case"webgl-gradient":e=new nt;break;case"webgl-gradient-degraded":e=new nt;break;case"depth-layered":e=new St;break;default:return u?.debug?.warn("ColorStrategySelector",`Unknown strategy: ${t}`),null}e&&(this.strategyInstances.set(t,e),u?.debug?.log("ColorStrategySelector",`Created strategy instance: ${t}`))}catch(i){return u?.debug?.error("ColorStrategySelector",`Failed to create strategy ${t}:`,i),null}return e}getEstimatedProcessingTime(t,e){return t.reduce((i,r)=>i+r.getEstimatedProcessingTime(e),0)}getStrategyMetadata(t){return this.strategyMetadata.get(t)||null}getAvailableStrategyNames(){return Array.from(this.strategyMetadata.keys())}updateSelectionCriteria(t){u?.debug?.log("ColorStrategySelector","Strategy selection criteria updated:",t)}destroy(){this.strategyInstances.forEach((t,e)=>{if("destroy"in t&&typeof t.destroy=="function")try{t.destroy()}catch(i){u?.debug?.warn("ColorStrategySelector",`Error destroying strategy ${e}:`,i)}}),this.strategyInstances.clear(),this.strategyMetadata.clear(),u?.debug?.log("ColorStrategySelector","Strategy selector destroyed")}}});var ys={};ne(ys,{ColorProcessor:()=>st,globalColorProcessor:()=>ki,globalUnifiedColorProcessingEngine:()=>Ll});var st,Il,Dl,ki,Ll,Sa=v(()=>{"use strict";_();pe();R();ds();ue();hs();bs();va();ya();Li();st=class{constructor(t){this.initialized=!1;this.processingState={isProcessing:!1,currentTrackUri:null,lastExtractedColors:null,lastProcessedResult:null,lastProcessingTime:0,processingQueue:[],queueSize:0};this.metrics={totalExtractions:0,totalProcessed:0,totalApplied:0,averageProcessingTime:0,successRate:0,errorCount:0,lastProcessingTime:0,oklabCoordinations:0,strategySelections:0,cacheHits:0};this.orchestrationMetrics={totalProcessingTime:0,strategiesProcessed:0,strategiesSucceeded:0,strategiesFailed:0,cacheHits:0,averageStrategyTime:0,memoryUsage:0,oklabCoordinations:0,oklabProcessingTime:0};this.oklabCoordinationEnabled=!0;this.multiStrategyProcessingEnabled=!0;this.resultCache=new Map;this.cacheMaxSize=50;this.cacheTimeoutMs=3e5;this.processedContexts=new Map;this.CONTEXT_CACHE_TTL=2e3;this.processingTimeout=null;this.PROCESSING_TIMEOUT_MS=1e4;this.MAX_QUEUE_SIZE=10;this.processingCache=new Map;this.CACHE_TTL_MS=3e4;this.performanceAnalyzer=t||null,this.deviceCapabilityDetector=new W,this.strategyRegistry=new Ii,this.strategySelector=new Ri,this.oklabProcessor=new T,this.musicalOKLABProcessor=new Ai(!0)}async initialize(){if(this.initialized){console.log("\u{1F3A8} [ColorProcessor] Already initialized, skipping");return}console.log("\u{1F3A8} [ColorProcessor] \u2550\u2550\u2550 INITIALIZATION START \u2550\u2550\u2550");try{console.log("\u{1F3A8} [ColorProcessor] Step 1: Initializing device capability detector..."),await this.deviceCapabilityDetector.initialize(),console.log("\u{1F3A8} [ColorProcessor] \u2705 Device capability detector initialized"),console.log("\u{1F3A8} [ColorProcessor] Step 2: Setting up event subscriptions..."),this.setupEventSubscriptions(),console.log("\u{1F3A8} [ColorProcessor] \u2705 Event subscriptions configured"),console.log("\u{1F3A8} [ColorProcessor] Step 3: Registering color processing strategies..."),this.registerDefaultStrategies(),console.log("\u{1F3A8} [ColorProcessor] \u2705 Strategies registered"),this.initialized=!0,console.log("\u{1F3A8} [ColorProcessor] \u2550\u2550\u2550 INITIALIZATION COMPLETE \u2550\u2550\u2550"),console.log("\u{1F3A8} [ColorProcessor] Ready to receive 'colors:extracted' events"),u?.debug?.log("ColorProcessor","\u{1F3A8} Unified color processing engine initialized successfully",{strategiesCount:this.strategyRegistry.getStrategies().length,eventSubscriptions:"colors:extracted, settings:changed",initialized:this.initialized})}catch(t){throw console.error("\u{1F3A8} [ColorProcessor] \u274C INITIALIZATION FAILED:",t),u?.debug?.error("ColorProcessor","Failed to initialize:",t),t}}async healthCheck(){let t=[];return this.initialized||t.push("Engine not initialized"),this.processingState.isProcessing&&Date.now()-this.processingState.lastProcessingTime>this.PROCESSING_TIMEOUT_MS&&t.push("Processing appears stuck"),this.metrics.errorCount>0&&this.metrics.successRate<.8&&t.push(`Low success rate: ${(this.metrics.successRate*100).toFixed(1)}%`),this.processingState.queueSize>this.MAX_QUEUE_SIZE&&t.push(`Queue overflow: ${this.processingState.queueSize} items`),{healthy:t.length===0,ok:t.length===0,details:`Unified color processing - ${this.metrics.totalProcessed} processed, ${this.metrics.successRate.toFixed(2)} success rate`,issues:t,system:"UnifiedColorProcessingEngine"}}updateAnimation(t){this.processingCache.size>50&&this.cleanupCache()}destroy(){this.processingTimeout&&(clearTimeout(this.processingTimeout),this.processingTimeout=null),this.processingState.processingQueue=[],this.processingCache.clear(),p.unsubscribeAll("UnifiedColorProcessingEngine"),this.initialized=!1}setupEventSubscriptions(){console.log("\u{1F3A8} [ColorProcessor] Setting up event bus subscriptions..."),console.log("\u{1F3A8} [ColorProcessor] Subscribing to 'colors:extracted' event..."),p.subscribe("colors:extracted",t=>{console.log("\u{1F3A8} [ColorProcessor] \u{1F3B5} RECEIVED 'colors:extracted' EVENT",{hasRawColors:!!t?.rawColors,trackUri:t?.trackUri,timestamp:t?.timestamp,colorCount:t?.rawColors?Object.keys(t.rawColors).length:0}),this.handleColorExtraction(t)},"UnifiedColorProcessingEngine"),console.log("\u{1F3A8} [ColorProcessor] \u2705 Subscribed to 'colors:extracted'"),console.log("\u{1F3A8} [ColorProcessor] Subscribing to 'settings:changed' event..."),p.subscribe("settings:changed",t=>{console.log("\u{1F3A8} [ColorProcessor] \u2699\uFE0F Settings changed:",t?.settingKey),this.handleSettingsChange(t)},"UnifiedColorProcessingEngine"),console.log("\u{1F3A8} [ColorProcessor] \u2705 Subscribed to 'settings:changed'"),console.log("\u{1F3A8} [ColorProcessor] Event subscriptions complete")}async processColors(t){let e=performance.now();try{let i=this.generateCacheKey(t),r=this.getCachedResult(i);if(r)return this.metrics.cacheHits++,this.orchestrationMetrics.cacheHits++,r;if(this.isDuplicateContext(t))return u?.debug?.log("UnifiedColorProcessingEngine","Skipping duplicate context within TTL"),this.getLastProcessedResult()||this.createFallbackResult(t,new Error("No previous result"));let a;if(this.multiStrategyProcessingEnabled)a=await this.processMultipleStrategies(t);else{let l=await this.selectOptimalStrategy(t);this.metrics.strategySelections++,a=await this.processWithOKLAB(t,l)}let n=performance.now()-e;this.updateMetrics(n,!0),this.updateOrchestrationMetrics(n,!0);let s={...a,processingTime:n,strategy:a.metadata?.strategy?{getStrategyName:()=>a.metadata.strategy}:await this.selectOptimalStrategy(t),success:!0,timestamp:Date.now(),coordinationMetrics:{detectedGenre:t.musicData?.genre||"unknown",emotionalState:t.musicData?.energy?this.classifyEmotionalState(t.musicData.energy):"neutral",oklabPreset:this.determineOKLABPreset(t),coordinationStrategy:a.metadata?.strategy||"unified",musicInfluenceStrength:t.musicData?.energy||.5}};return this.cacheResult(i,s),this.cacheContext(t),this.processingState.lastProcessedResult=s,console.log("\u{1F3A8} [ColorProcessor] \u2550\u2550\u2550 COLOR PROCESSING COMPLETE \u2550\u2550\u2550"),console.log("\u{1F3A8} [ColorProcessor] \u{1F3A8} Emitting 'colors:harmonized' event",{processedColorKeys:Object.keys(a.processedColors),processedColorCount:Object.keys(a.processedColors).length,accentHex:a.accentHex||"var(--sn-brightness-adjusted-accent-hex, #cba6f7)",accentRgb:a.accentRgb||"var(--sn-brightness-adjusted-accent-rgb, 203, 166, 247)",strategy:s.coordinationMetrics.coordinationStrategy,processingTime:`${n.toFixed(2)}ms`}),u?.debug?.log("ColorProcessor","\u{1F3A8} Emitting colors:harmonized event",{processedColorKeys:Object.keys(a.processedColors),processedColorCount:Object.keys(a.processedColors).length,accentHex:a.accentHex||"var(--sn-brightness-adjusted-accent-hex, #cba6f7)",accentRgb:a.accentRgb||"var(--sn-brightness-adjusted-accent-rgb, 203, 166, 247)",strategy:s.coordinationMetrics.coordinationStrategy,processingTime:`${n.toFixed(2)}ms`}),console.log("\u{1F3A8} [ColorProcessor] Broadcasting 'colors:harmonized' to event bus..."),p.emit("colors:harmonized",{processedColors:a.processedColors,accentHex:a.accentHex||"var(--sn-brightness-adjusted-accent-hex, #cba6f7)",accentRgb:a.accentRgb||"var(--sn-brightness-adjusted-accent-rgb, 203, 166, 247)",strategies:[s.coordinationMetrics.coordinationStrategy],coordinationMetrics:s.coordinationMetrics,oklabData:s.oklabData,processingTime:n,timestamp:Date.now(),metadata:a.metadata}),console.log("\u{1F3A8} [ColorProcessor] \u2705 'colors:harmonized' event emitted successfully"),s}catch(i){let r=performance.now()-e;return this.updateMetrics(r,!1),this.updateOrchestrationMetrics(r,!1),u?.debug?.error("UnifiedColorProcessingEngine","Processing failed:",i),this.createFallbackResult(t,i)}}async processMultipleStrategies(t){let e=performance.now();try{let i=await this.selectMultipleStrategies(t);if(i.length===0)throw new Error("No strategies available for processing");let r=i.map(async s=>{let l=performance.now();try{let c=await s.processColors(t),m=performance.now()-l;return{strategy:s,result:c,processingTime:m,success:!0,oklabData:c.metadata?.oklabData}}catch(c){let m=performance.now()-l;return u?.debug?.warn("UnifiedColorProcessingEngine",`Strategy ${s.getStrategyName()} failed:`,c),{strategy:s,result:this.createFallbackResult(t,c),processingTime:m,success:!1,error:c.message}}}),a=await Promise.all(r);this.orchestrationMetrics.strategiesProcessed+=a.length,this.orchestrationMetrics.strategiesSucceeded+=a.filter(s=>s.success).length,this.orchestrationMetrics.strategiesFailed+=a.filter(s=>!s.success).length,this.orchestrationMetrics.totalProcessingTime+=performance.now()-e,this.orchestrationMetrics.averageStrategyTime=a.reduce((s,l)=>s+l.processingTime,0)/a.length;let n;return this.oklabCoordinationEnabled&&a.some(s=>s.success)?(n=await this.coordinateOKLABProcessing(t,a),this.orchestrationMetrics.oklabCoordinations++):n=this.mergeStrategyResults(a,t),n}catch(i){u?.debug?.error("UnifiedColorProcessingEngine","Multi-strategy processing failed:",i);let r=await this.selectOptimalStrategy(t);return await this.processWithOKLAB(t,r)}}async coordinateOKLABProcessing(t,e){let i=performance.now();try{let r=e.filter(d=>d.success);if(r.length===0)throw new Error("No successful strategy results for OKLAB coordination");let a={};r.forEach(d=>{Object.entries(d.result.processedColors).forEach(([h,g])=>{a[h]||(a[h]=[]),a[h].push(g)})});let n={rawColors:t.rawColors,musicData:t.musicData,trackUri:t.trackUri,timestamp:t.timestamp},s=await this.musicalOKLABProcessor.processMusicalColors(n),l=this.blendOKLABWithStrategies(a,s),c=this.selectPrimaryResult(r),m={...c.result,processedColors:l,metadata:{...c.result.metadata,oklabCoordination:s,coordinationStrategy:"multi-strategy-oklab",strategiesUsed:r.map(d=>d.strategy.getStrategyName()),oklabProcessingTime:performance.now()-i}};return this.orchestrationMetrics.oklabProcessingTime+=performance.now()-i,m}catch(r){return u?.debug?.error("UnifiedColorProcessingEngine","OKLAB coordination failed, falling back to merge:",r),this.mergeStrategyResults(e,t)}}mergeStrategyResults(t,e,i={priorityWeighting:!0,conflictResolution:"merge",preserveMetadata:!0,visualEffectsBlending:!0,oklabCoordination:!1}){let r=t.filter(c=>c.success);if(r.length===0)return this.createFallbackResult(e,new Error("No successful strategies"));if(r.length===1){let c=r[0];return c?c.result:this.createFallbackResult(e,new Error("Single result is undefined"))}let a=i.priorityWeighting?this.prioritizeResults(r):r;if(a.length===0)return this.createFallbackResult(e,new Error("No prioritized results"));let n=a[0];if(!n)return this.createFallbackResult(e,new Error("Primary result is undefined"));let s={...n.result.processedColors};a.slice(1).forEach(c=>{Object.entries(c.result.processedColors).forEach(([m,d])=>{if(s[m])switch(i.conflictResolution){case"override":break;case"merge":s[`${m}-${c.strategy.getStrategyName()}`]=d;break;case"average":this.isValidHexColor(s[m])&&this.isValidHexColor(d)&&(s[m]=this.averageColors(s[m],d));break}else s[m]=d})});let l=i.preserveMetadata?this.mergeMetadata(a.map(c=>c.result.metadata)):n.result.metadata;return{...n.result,processedColors:s,metadata:{...l,mergeStrategy:i.conflictResolution,strategiesUsed:r.map(c=>c.strategy.getStrategyName()),mergeTimestamp:Date.now()}}}async handleColorExtraction(t){return"rawColors"in t&&"trackUri"in t?this.processColorContext(t):this.handleColorExtractionEvent(t)}async processColorContext(t){this.metrics.totalExtractions++;try{if(this.processingState.isProcessing){this.addToQueue(t);return}await this.processWithTimeout(t)}catch(e){this.metrics.errorCount++,u?.debug?.error("UnifiedColorProcessingEngine","Color context processing failed:",e)}}async handleColorExtractionEvent(t){this.metrics.totalExtractions++;try{let e={rawColors:t.rawColors,trackUri:t.trackUri,musicData:t.musicData,timestamp:t.timestamp||Date.now()};if(this.processingState.isProcessing){this.addToQueue(e);return}await this.processWithTimeout(e)}catch(e){this.metrics.errorCount++,u?.debug?.error("UnifiedColorProcessingEngine","Color extraction handling failed:",e)}}async processWithOKLAB(t,e){let i={rawColors:t.rawColors,musicData:t.musicData,trackUri:t.trackUri,timestamp:t.timestamp},r=await this.musicalOKLABProcessor.processMusicalColors(i);this.metrics.oklabCoordinations++;let a=await e.processColors(t),n=await this.enhanceWithOKLAB(a.processedColors,r);return{...a,processedColors:n,metadata:{...a.metadata,oklabPreset:this.determineOKLABPreset(t),oklabCoordination:r}}}async selectOptimalStrategy(t){try{let i=this.deviceCapabilityDetector.getCapabilities(),r={performance:"medium",quality:"enhanced",deviceCapabilities:{hasWebGL:i?.gpu?.supportsWebGL||!0,memoryMB:i?.memory?.total||4096,isMobile:!1},userPreferences:{harmonicMode:"cosmic",intensity:.8,enableAdvancedBlending:!0},settingsContext:{dynamicAccentEnabled:!0,gradientIntensity:"medium",webglEnabled:i?.gpu?.supportsWebGL||!0,webglForceEnabled:!1,visualGuideMode:"enhanced",depthLayersEnabled:!0,visualEffectsLevel:.8,pulsingAnimationEnabled:!0},deviceContext:{supportsWebGL:i?.gpu?.supportsWebGL||!0,performanceLevel:"medium",memoryCapacity:i?.memory?.total||4096,isMobile:!1}},a=this.strategySelector.selectStrategies(t,r);if(a&&a.length>0&&a[0])return a[0]}catch(i){u?.debug?.warn("UnifiedColorProcessingEngine","Strategy selection failed, using fallback:",i)}return{getStrategyName:()=>"fallback",canProcess:i=>!0,getEstimatedProcessingTime:i=>50,processColors:async i=>({processedColors:i.rawColors,accentHex:"var(--sn-brightness-adjusted-accent-hex, #cba6f7)",accentRgb:"var(--sn-brightness-adjusted-accent-rgb, 203, 166, 247)",context:i,metadata:{strategy:"fallback",timestamp:Date.now(),processingTime:0}})}}addToQueue(t){this.processingState.queueSize>=this.MAX_QUEUE_SIZE&&this.processingState.processingQueue.shift(),this.processingState.processingQueue.push(t),this.processingState.queueSize=this.processingState.processingQueue.length}async processQueue(){for(;this.processingState.processingQueue.length>0&&!this.processingState.isProcessing;){let t=this.processingState.processingQueue.shift();this.processingState.queueSize=this.processingState.processingQueue.length,await this.processWithTimeout(t)}}async processWithTimeout(t){this.processingState.isProcessing=!0,this.processingState.lastProcessingTime=Date.now(),this.processingTimeout=window.setTimeout(()=>{u?.debug?.warn("UnifiedColorProcessingEngine","Processing timeout - forcing reset"),this.processingState.isProcessing=!1,this.metrics.errorCount++},this.PROCESSING_TIMEOUT_MS);try{await this.processColors(t),this.metrics.totalProcessed++}finally{this.processingTimeout&&(clearTimeout(this.processingTimeout),this.processingTimeout=null),this.processingState.isProcessing=!1,this.processingState.processingQueue.length>0&&setTimeout(()=>this.processQueue(),0)}}generateCacheKey(t){let e={colors:Object.keys(t.rawColors).sort().join(","),music:t.musicData?.energy||0};return JSON.stringify(e)}getCachedResult(t){let e=this.processingCache.get(t);return e&&Date.now()-e.timestamp<this.CACHE_TTL_MS?e:null}cacheResult(t,e){if(this.processingCache.set(t,{...e,timestamp:Date.now()}),this.resultCache.set(t,e),this.resultCache.size>this.cacheMaxSize){let i=Array.from(this.resultCache.entries());i.slice(0,i.length-this.cacheMaxSize).forEach(([a])=>this.resultCache.delete(a))}}cleanupCache(){let t=Date.now();for(let[e,i]of this.processingCache.entries())t-i.timestamp>this.CACHE_TTL_MS&&this.processingCache.delete(e)}updateMetrics(t,e){this.metrics.averageProcessingTime=(this.metrics.averageProcessingTime*this.metrics.totalProcessed+t)/(this.metrics.totalProcessed+1),e?this.metrics.successRate=(this.metrics.successRate*this.metrics.totalProcessed+1)/(this.metrics.totalProcessed+1):this.metrics.successRate=this.metrics.successRate*this.metrics.totalProcessed/(this.metrics.totalProcessed+1),this.metrics.lastProcessingTime=Date.now()}async selectMultipleStrategies(t){try{let e=this.deviceCapabilityDetector.getCapabilities(),i=this.buildSelectionCriteria(e);return this.strategySelector.selectStrategies(t,i)?.slice(0,3)||[]}catch(e){return u?.debug?.warn("UnifiedColorProcessingEngine","Multi-strategy selection failed, using single strategy:",e),[await this.selectOptimalStrategy(t)]}}isDuplicateContext(t){if(!t.trackUri)return!1;let e=this.processedContexts.get(t.trackUri);return e?Date.now()-e<this.CONTEXT_CACHE_TTL:!1}cacheContext(t){if(t.trackUri&&(this.processedContexts.set(t.trackUri,Date.now()),this.processedContexts.size>100)){let e=Date.now()-this.CONTEXT_CACHE_TTL*2;for(let[i,r]of this.processedContexts.entries())r<e&&this.processedContexts.delete(i)}}getLastProcessedResult(){return this.processingState.lastProcessedResult}updateOrchestrationMetrics(t,e){this.orchestrationMetrics.totalProcessingTime+=t,e||this.orchestrationMetrics.strategiesFailed++,this.orchestrationMetrics.memoryUsage=Math.round((this.resultCache.size*1024+this.processedContexts.size*256)/1024)}blendOKLABWithStrategies(t,e){let i={};return e.enhancedColors&&Object.entries(e.enhancedColors).forEach(([r,a])=>{i[`oklab-${r}`]=a}),Object.entries(t).forEach(([r,a])=>{a.length===1&&a[0]?i[r]=a[0]:a.length>1&&a[0]&&(i[r]=a[0],a.slice(1).forEach((n,s)=>{n&&(i[`${r}-variant-${s+1}`]=n)}))}),i}selectPrimaryResult(t){if(t.length===0)throw new Error("Cannot select primary result from empty results array");let i=t.sort((r,a)=>r.success&&!a.success?-1:!r.success&&a.success?1:r.processingTime-a.processingTime)[0];if(!i)throw new Error("Primary result is undefined after sorting");return i}prioritizeResults(t){return t.length===0?[]:t.sort((e,i)=>e.success&&!i.success?-1:!e.success&&i.success?1:e.success&&i.success?e.processingTime-i.processingTime:0)}mergeMetadata(t){if(t.length===0)return{};if(t.length===1)return t[0]||{};let e={...t[0]},i=[];return t.forEach(r=>{r?.strategy&&i.push(r.strategy),r?.strategiesUsed&&i.push(...r.strategiesUsed)}),e.strategiesUsed=[...new Set(i)],e.mergeTimestamp=Date.now(),e}isValidHexColor(t){return/^#[0-9A-F]{6}$/i.test(t)}averageColors(t,e){try{let i=parseInt(t.substring(1,3),16),r=parseInt(t.substring(3,5),16),a=parseInt(t.substring(5,7),16),n=parseInt(e.substring(1,3),16),s=parseInt(e.substring(3,5),16),l=parseInt(e.substring(5,7),16),c=Math.round((i+n)/2),m=Math.round((r+s)/2),d=Math.round((a+l)/2);return`#${c.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}`}catch{return t}}buildSelectionCriteria(t){return{performance:"medium",quality:"enhanced",deviceCapabilities:{hasWebGL:t?.gpu?.supportsWebGL||!0,memoryMB:t?.memory?.total||4096,isMobile:!1},userPreferences:{harmonicMode:"cosmic",intensity:.8,enableAdvancedBlending:!0},settingsContext:{dynamicAccentEnabled:!0,gradientIntensity:"medium",webglEnabled:t?.gpu?.supportsWebGL||!0,webglForceEnabled:!1,visualGuideMode:"enhanced",depthLayersEnabled:!0,visualEffectsLevel:.8,pulsingAnimationEnabled:!0},deviceContext:{supportsWebGL:t?.gpu?.supportsWebGL||!0,performanceLevel:"medium",memoryCapacity:t?.memory?.total||4096,isMobile:!1}}}async enhanceWithOKLAB(t,e){let i={...t};return e.enhancedColors&&Object.entries(e.enhancedColors).forEach(([r,a])=>{i[`oklab-${r}`]=a}),i}classifyEmotionalState(t){return t>.8?"energetic":t>.6?"upbeat":t>.4?"moderate":t>.2?"calm":"peaceful"}determineOKLABPreset(t){let e=t.musicData?.energy||.5;return e>.8?"high-energy":e>.6?"dynamic":e>.4?"balanced":"ambient"}createFallbackResult(t,e){return{processedColors:{fallback:"var(--sn-brightness-adjusted-accent-hex, #cba6f7)"},accentHex:"var(--sn-brightness-adjusted-accent-hex, #cba6f7)",accentRgb:"var(--sn-brightness-adjusted-accent-rgb, 203, 166, 247)",context:t,metadata:{strategy:"fallback",error:e.message,timestamp:Date.now(),processingTime:0}}}registerDefaultStrategies(){try{let t=new nt;this.strategyRegistry.register(t);let e=new St;this.strategyRegistry.register(e);let i=new at;this.strategyRegistry.register(i),u?.debug?.log("ColorProcessor",`\u2705 Registered ${this.strategyRegistry.getStrategies().length} default color processing strategies`,this.strategyRegistry.getStrategies().map(r=>r.getStrategyName()))}catch(t){u?.debug?.error("ColorProcessor","\u274C Strategy registration failed:",t)}}async handleSettingsChange(t){["catppuccin-flavor","catppuccin-accentColor","sn-dynamic-color-intensity"].includes(t.settingKey)&&(this.processingCache.clear(),u?.debug?.log("UnifiedColorProcessingEngine","Cache cleared due to settings change:",t.settingKey))}async handlePerformanceWarning(t){t.memoryUsage>50&&(this.processingCache.clear(),u?.debug?.log("UnifiedColorProcessingEngine","Cache cleared due to memory pressure"))}getMetrics(){return{...this.metrics}}async forceReprocessColors(){if(this.processingCache.clear(),this.processingState.lastExtractedColors){let t={rawColors:this.processingState.lastExtractedColors,trackUri:this.processingState.currentTrackUri||"",timestamp:Date.now()};await this.processColors(t)}}getProcessingState(){return{...this.processingState}}getStatus(){return{isProcessing:this.processingState.isProcessing,queueSize:this.processingState.queueSize}}setSelectionCriteria(t){u?.debug?.log("UnifiedColorProcessingEngine","Strategy selection criteria updated:",t)}},Il=()=>{let o=globalThis.year3000System;return{performanceAnalyzer:o?.performanceAnalyzer||o?.facadeCoordinator?.getCachedNonVisualSystem?.("PerformanceAnalyzer")}},{performanceAnalyzer:Dl}=Il(),ki=new st(Dl),Ll=ki});var Vi,vs=v(()=>{"use strict";Xe();ue();_();Vi=class o{constructor(t,e){this.initialized=!1;this.cardQuerySelector=".sn-card, .main-card-card, .main-card-cardContainer, .main-gridContainer-gridContainer.main-gridContainer-fixedWidth";this.cardEventHandlers=new WeakMap;this.musicSyncService=null;this.currentQualityLevel=null;this.qualityCapabilities=[];this.effectCoordinationCallbacks=new Set;this.config={perspective:1e3,maxRotation:5,scale:1.02,transitionSpeed:"200ms",glowOpacity:.8,selector:".main-card-card, .main-card-cardContainer, .main-grid-grid > *, .main-shelf-shelf > * > *",depthMultiplier:1.5,musicResponseStrength:.8,beatSyncIntensity:.6,effectIntensityMultiplier:1.2},this.performanceMonitor=t,this.utils=e,this.cards=document.querySelectorAll(this.config.selector),this.musicTemperatureMapper=new se(!0),this.oklabProcessor=new T(!0),this.effectPreset=T.getPreset("VIBRANT"),this.effectState={currentMusicMood:"neutral",musicIntensity:.5,beatPhase:0,lastBeatTime:0,effectIntensityLevel:0,dynamicAccentHex:"#cba6f7",dynamicAccentRgb:"203,166,247",overallIntensityLevel:.5},this.boundHandleSettingsChange=this.handleSettingsChange.bind(this)}static getInstance(t,e){return o.instance||(o.instance=new o(t,e)),o.instance}async initialize(){if(this.initialized)return;let t=this.performanceMonitor.shouldReduceQuality();this.cards=document.querySelectorAll(this.config.selector),await this.applyEventListeners(),await this.initializeMusicIntegration(),this.initializeCrossSystemCoordination(),document.addEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange),this.initialized=!0}async healthCheck(){let t=document.querySelectorAll(this.cardQuerySelector);return t.length>0?{healthy:!0,ok:!0,details:`Found ${t.length} cards to manage.`,issues:[],system:"Card3DManager"}:{healthy:!1,ok:!1,details:"No card elements found with the configured selector.",issues:["No card elements found with the configured selector."],system:"Card3DManager"}}updateAnimation(t){}apply3DMode(t){console.log(`[Card3DManager] Applying 3D mode: ${t}`),t==="disabled"?this.destroy():this.initialize()}get shouldEnable3DEffects(){return!this.performanceMonitor.shouldReduceQuality()}async applyEventListeners(){this.cards.forEach(t=>{if(this.cardEventHandlers.has(t))return;let e=r=>this.handleMouseMove(t,r),i=()=>this.handleMouseLeave(t);this.cardEventHandlers.set(t,{move:e,leave:i}),t.addEventListener("mousemove",e),t.addEventListener("mouseleave",i)})}handleMouseMove(t,e){if(!this.shouldEnable3DEffects)return;let{clientX:i,clientY:r}=e,{top:a,left:n,width:s,height:l}=t.getBoundingClientRect(),c=i-n,m=r-a,d=this.config.maxRotation*(m-l/2)/(l/2),h=-this.config.maxRotation*(c-s/2)/(s/2);t.style.transform=`perspective(${this.config.perspective}px) rotateX(${d}deg) rotateY(${h}deg) scale3d(${this.config.scale}, ${this.config.scale}, ${this.config.scale})`,t.style.transition=`transform ${this.config.transitionSpeed} ease-out`,this.applyGlow(t,c,m,s,l)}handleMouseLeave(t){t.style.transform="perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)",t.style.transition="transform 600ms ease-in-out",this.removeGlow(t)}applyGlow(t,e,i,r,a){let n=t.querySelector(".card-glow");n||(n=document.createElement("div"),n.className="card-glow",t.appendChild(n));let{dynamicAccentRgb:s,musicIntensity:l,beatPhase:c,effectIntensityLevel:m}=this.effectState,d=this.config.glowOpacity,h=1+(l-.5)*this.config.musicResponseStrength,g=1+Math.sin(c)*this.config.beatSyncIntensity*.3,f=1+m*this.config.effectIntensityMultiplier*.4,S=d*h*g*f,C=Math.max(.1,Math.min(1,S)),M=40+Math.sin(c*.5)*8*this.config.beatSyncIntensity;n.style.background=`radial-gradient(circle at ${e}px ${i}px, 
      rgba(${s}, ${C}) 0%, 
      rgba(${s}, ${C*.6}) 20%, 
      transparent ${M}%)`}removeGlow(t){let e=t.querySelector(".card-glow");e&&(e.style.background="transparent")}destroy(){this.cards.forEach(t=>{let e=this.cardEventHandlers.get(t);e&&(t.removeEventListener("mousemove",e.move),t.removeEventListener("mouseleave",e.leave),this.cardEventHandlers.delete(t)),this.removeGlow(t),t.style.transform="",t.style.transition=""}),this.initialized=!1,document.removeEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange)}handleSettingsChange(t){let{key:e,value:i}=t.detail||{}}async initializeMusicIntegration(){try{p.subscribe("colors:extracted",t=>{this.onColorsExtracted(t)},"Card3DManager"),p.subscribe("colors:harmonized",t=>{this.onColorsHarmonized(t)},"Card3DManager"),p.subscribe("music:beat",t=>{this.onMusicBeat(t)},"Card3DManager"),p.subscribe("music:dramatic-peak-detected",t=>{this.onIntensityEvent(t)},"Card3DManager"),this.updateDynamicAccentColor(),console.log("[Card3DManager] \u2705 Year 3000 music integration initialized")}catch(t){console.error("[Card3DManager] Failed to initialize music integration:",t)}}onColorsExtracted(t){let{rawColors:e,musicData:i}=t;if(i){let r=this.musicTemperatureMapper.mapMusicToEmotionalTemperature(i);this.updateMusicState(r)}}onColorsHarmonized(t){let{processedColors:e,coordinationMetrics:i}=t;if(e.VIBRANT){let r=this.oklabProcessor.processColor(e.VIBRANT,this.effectPreset);this.effectState.dynamicAccentHex=r.enhancedHex,this.effectState.dynamicAccentRgb=`${r.enhancedRgb.r},${r.enhancedRgb.g},${r.enhancedRgb.b}`}i?.overallIntensityLevel!==void 0&&(this.effectState.overallIntensityLevel=i.overallIntensityLevel)}onMusicBeat(t){let{beat:e,intensity:i,timestamp:r}=t;this.effectState.beatPhase+=Math.PI*2*this.config.beatSyncIntensity,this.effectState.lastBeatTime=r||Date.now(),i>.7&&this.applyBeatSyncDepthPulse(i)}onIntensityEvent(t){let{intensity:e,type:i}=t;this.effectState.effectIntensityLevel=e,e>.8&&this.applyEnhancedDepthDistortion(e)}updateMusicState(t){switch(this.effectState.currentMusicMood=t.primaryEmotion,this.effectState.musicIntensity=t.intensity,t.primaryEmotion){case"energetic":case"aggressive":this.effectPreset=T.getPreset("COSMIC");break;case"calm":case"ambient":this.effectPreset=T.getPreset("SUBTLE");break;default:this.effectPreset=T.getPreset("VIBRANT")}}applyBeatSyncDepthPulse(t){let e=1+t*.15*this.config.beatSyncIntensity;this.cards.forEach(i=>{if(i instanceof HTMLElement){let a=(i.style.transform||"").replace(/scale3d\([^)]*\)/,`scale3d(${e}, ${e}, ${e})`);i.style.transform=a||`scale3d(${e}, ${e}, ${e})`,i.style.transition="transform 100ms ease-out",setTimeout(()=>{i.style.transform.includes(`scale3d(${e}`)&&(i.style.transform=i.style.transform.replace(/scale3d\([^)]*\)/,"scale3d(1, 1, 1)"))},200)}})}applyEnhancedDepthDistortion(t){let e=this.config.perspective*(1+t*this.config.effectIntensityMultiplier),i=this.config.maxRotation*(1+t*.8);this.cards.forEach(r=>{if(r instanceof HTMLElement){let a=`perspective(${e}px) rotateX(${i*.3}deg) rotateY(${i*.2}deg)`;r.style.transform=a,r.style.transition="transform 800ms ease-out",setTimeout(()=>{r.style.transform="perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)",r.style.transition="transform 1200ms ease-in-out"},1500)}})}updateDynamicAccentColor(){let t=document.documentElement,e=getComputedStyle(t),i=e.getPropertyValue("--sn-dynamic-accent-hex").trim()||e.getPropertyValue("--sn-color-accent-hex").trim()||e.getPropertyValue("--spice-accent").trim(),r=e.getPropertyValue("--sn-dynamic-accent-rgb").trim()||e.getPropertyValue("--sn-color-accent-rgb").trim()||e.getPropertyValue("--spice-rgb-accent").trim();i&&i!==""&&(this.effectState.dynamicAccentHex=i),r&&r!==""&&(this.effectState.dynamicAccentRgb=r)}setMusicSyncService(t){this.musicSyncService=t}getEffectState(){return{...this.effectState}}setQualityLevel(t){switch(this.currentQualityLevel=t,t){case"low":this.config.perspective=900,this.config.maxRotation=3,this.config.depthMultiplier=1.2,this.config.musicResponseStrength=.5,this.config.beatSyncIntensity=.4,this.config.effectIntensityMultiplier=.8;break;case"medium":this.config.perspective=1e3,this.config.maxRotation=5,this.config.depthMultiplier=1.5,this.config.musicResponseStrength=.8,this.config.beatSyncIntensity=.6,this.config.effectIntensityMultiplier=1.2;break;case"high":this.config.perspective=1200,this.config.maxRotation=7,this.config.depthMultiplier=1.8,this.config.musicResponseStrength=1,this.config.beatSyncIntensity=.8,this.config.effectIntensityMultiplier=1.5;break;default:this.config.perspective=1e3,this.config.maxRotation=5,this.config.depthMultiplier=1.5,this.config.musicResponseStrength=.8,this.config.beatSyncIntensity=.6,this.config.effectIntensityMultiplier=1.2;break}console.log(`[Card3DManager] Quality level set to: ${t}`)}adjustQuality(t){this.setQualityLevel(t)}getPerformanceImpact(){let t=this.cards.length,e=t*.1,i=this.config.depthMultiplier*.2,r=this.config.musicResponseStrength*.15,a=this.config.effectIntensityMultiplier*.1;return{fps:60,frameTime:e+i+r+a,memoryUsage:t*.05,cpuUsage:(e+i)*100}}reduceQuality(t){this.currentQualityLevel&&(this.config.depthMultiplier=Math.max(.5,this.config.depthMultiplier-t),this.config.musicResponseStrength=Math.max(.1,this.config.musicResponseStrength-t),this.config.beatSyncIntensity=Math.max(.1,this.config.beatSyncIntensity-t),this.config.effectIntensityMultiplier=Math.max(.5,this.config.effectIntensityMultiplier-t),console.log(`[Card3DManager] Quality reduced by ${t}`))}increaseQuality(t){this.currentQualityLevel&&(this.config.depthMultiplier=Math.min(2,this.config.depthMultiplier+t),this.config.musicResponseStrength=Math.min(1.5,this.config.musicResponseStrength+t),this.config.beatSyncIntensity=Math.min(1,this.config.beatSyncIntensity+t),this.config.effectIntensityMultiplier=Math.min(2,this.config.effectIntensityMultiplier+t),console.log(`[Card3DManager] Quality increased by ${t}`))}getQualityCapabilities(){return this.qualityCapabilities.length===0&&(this.qualityCapabilities=[{name:"3D Perspective",enabled:!0,qualityLevel:"medium"},{name:"Music-Reactive Glow",enabled:!0,qualityLevel:"low"},{name:"Beat Sync Effects",enabled:!0,qualityLevel:"low"},{name:"Intensity Distortion",enabled:!0,qualityLevel:"medium"},{name:"Music Modulation",enabled:!0,qualityLevel:"low"}]),this.qualityCapabilities}async refreshColorState(t){try{if(this.updateDynamicAccentColor(),this.effectState.dynamicAccentHex){let e=this.oklabProcessor.processColor(this.effectState.dynamicAccentHex,this.effectPreset);this.effectState.dynamicAccentHex=e.enhancedHex,this.effectState.dynamicAccentRgb=`${e.enhancedRgb.r},${e.enhancedRgb.g},${e.enhancedRgb.b}`}console.log(`[Card3DManager] Color state refreshed for trigger: ${t}`)}catch(e){console.error("[Card3DManager] Error refreshing color state:",e)}}onEffectCoordination(t){return this.effectCoordinationCallbacks.add(t),()=>{this.effectCoordinationCallbacks.delete(t)}}synchronizeEffectState(t){t.currentMusicMood&&(this.effectState.currentMusicMood=t.currentMusicMood),t.musicIntensity!==void 0&&(this.effectState.musicIntensity=t.musicIntensity),t.beatPhase!==void 0&&(this.effectState.beatPhase=t.beatPhase),t.effectIntensityLevel!==void 0&&(this.effectState.effectIntensityLevel=t.effectIntensityLevel),t.overallIntensityLevel!==void 0&&(this.effectState.overallIntensityLevel=t.overallIntensityLevel),t.dynamicAccentHex&&(this.effectState.dynamicAccentHex=t.dynamicAccentHex),t.dynamicAccentRgb&&(this.effectState.dynamicAccentRgb=t.dynamicAccentRgb),this.broadcastEffectState()}broadcastEffectState(){this.effectCoordinationCallbacks.forEach(t=>{try{t(this.effectState)}catch(e){console.error("[Card3DManager] Error in effect coordination callback:",e)}})}updateMusicStateWithCoordination(t){this.updateMusicState(t),this.broadcastEffectState(),p.emit("visual-effects:coordination",{source:"Card3DManager",state:this.convertToVisualEffectsState(this.effectState),timestamp:Date.now()})}onMusicBeatWithCoordination(t){this.onMusicBeat(t),this.broadcastEffectState(),p.emit("music:beat-sync",{source:"Card3DManager",beatPhase:this.effectState.beatPhase,lastBeatTime:this.effectState.lastBeatTime,timestamp:Date.now()})}onIntensityEventWithCoordination(t){this.onIntensityEvent(t),this.broadcastEffectState(),p.emit("music:dramatic-sync",{source:"Card3DManager",dramaticLevel:this.effectState.effectIntensityLevel,type:t.type,timestamp:Date.now()})}initializeCrossSystemCoordination(){try{p.subscribe("visual-effects:coordination",t=>{t.source!=="Card3DManager"&&this.synchronizeEffectState(this.convertFromVisualEffectsState(t.state))},"Card3DManager"),p.subscribe("music:beat-sync",t=>{t.source!=="Card3DManager"&&(this.effectState.beatPhase=t.beatPhase,this.effectState.lastBeatTime=t.lastBeatTime)},"Card3DManager"),p.subscribe("music:dramatic-sync",t=>{t.source!=="Card3DManager"&&(this.effectState.effectIntensityLevel=t.dramaticLevel)},"Card3DManager"),console.log("[Card3DManager] \u2705 Cross-system effect coordination initialized")}catch(t){console.error("[Card3DManager] Failed to initialize cross-system coordination:",t)}}convertToVisualEffectsState(t){return{intensity:t.effectIntensityLevel,colorTemperature:6500,animationScale:t.musicIntensity,dominantEmotion:t.currentMusicMood,resonance:t.musicIntensity,symbioticResonance:t.musicIntensity,surfaceFluidityIndex:t.musicIntensity,animationScaleRate:t.effectIntensityLevel,emotionalTemperature:6500,pulsingCycle:t.beatPhase,cinematicIntensity:t.effectIntensityLevel}}convertFromVisualEffectsState(t){return{currentMusicMood:t.dominantEmotion,musicIntensity:t.intensity,effectIntensityLevel:t.intensity,overallIntensityLevel:t.intensity}}}});var Ca,Ea,Ss=v(()=>{"use strict";Ca=class o{constructor(){this.observers=new Map;this.trackedElements=new Map;this.isSupported=typeof IntersectionObserver<"u",this.isSupported||console.warn("[ViewportController] IntersectionObserver not supported, falling back to always-visible behavior")}static getInstance(){return o.instance||(o.instance=new o),o.instance}trackElement(t,e,i={}){if(!this.isSupported){let l={isVisible:!0,intersectionRatio:1,lastVisibilityChange:Date.now(),element:t};return e(l),()=>{}}let r={visibilityThreshold:.1,rootMargin:"50px",trackRootElement:!1,...i},a=this.getObserverKey(r),n=this.observers.get(a);n||(n=new IntersectionObserver(l=>this.handleIntersectionChanges(l),{threshold:r.visibilityThreshold,rootMargin:r.rootMargin,root:r.rootSelector?document.querySelector(r.rootSelector):null}),this.observers.set(a,n));let s={isVisible:!1,intersectionRatio:0,lastVisibilityChange:Date.now(),element:t};return this.trackedElements.set(t,{callback:e,options:r,state:s}),n.observe(t),()=>this.untrackElement(t)}isElementVisible(t){return this.trackedElements.get(t)?.state.isVisible??!0}getVisibilityState(t){return this.trackedElements.get(t)?.state??null}untrackElement(t){let e=this.trackedElements.get(t);if(!e)return;let i=this.getObserverKey(e.options),r=this.observers.get(i);r&&r.unobserve(t),this.trackedElements.delete(t)}trackSpotifyContainer(t){let e=[".Root__main-view",'[data-testid="topbar"]',".main-view-container","#main"],i=null;for(let r of e)if(i=document.querySelector(r),i)break;return i||(console.warn("[ViewportController] Could not find Spotify main container, using document.body"),i=document.body),this.trackElement(i,t,{visibilityThreshold:.1,rootMargin:"0px",trackRootElement:!0})}checkBulkVisibility(t){let e=new Map;for(let i of t)e.set(i,this.isElementVisible(i));return e}destroy(){for(let t of this.observers.values())t.disconnect();this.observers.clear(),this.trackedElements.clear()}handleIntersectionChanges(t){for(let e of t){let i=this.trackedElements.get(e.target);if(!i)continue;let r=i.state.isVisible,a=e.isIntersecting;if(i.state={isVisible:a,intersectionRatio:e.intersectionRatio,lastVisibilityChange:r!==a?Date.now():i.state.lastVisibilityChange,element:e.target},r!==a)try{i.callback(i.state)}catch(n){console.error("[ViewportController] Error in visibility callback:",n)}}}getObserverKey(t){return`${t.visibilityThreshold}-${t.rootMargin}-${t.rootSelector||"viewport"}`}},Ea=Ca.getInstance()});var Fi,Cs=v(()=>{"use strict";Ss();_();Fi=class{constructor(t={}){this.initialized=!1;this.isVisible=!0;this.visibilityState=null;this.animationsPaused=!1;this.settingsUpdatesPaused=!1;this.viewportOptions={visibilityThreshold:.1,rootMargin:"50px",pauseAnimationsWhenHidden:!0,pauseSettingsUpdatesWhenHidden:!0,resumeDelay:100,...t}}async initialize(){await this.initializeViewportTracking(),await this.initializeEventSubscriptions(),await this.initializeSystem(),this.initialized=!0}async healthCheck(){let t=await this.performHealthCheck();return{...t,details:`${t.details} | Viewport: ${this.isVisible?"visible":"hidden"}`}}updateAnimation(t){this.shouldSkipAnimationUpdate()||this.performAnimationUpdate(t)}destroy(){this.cleanupViewportTracking(),this.cleanupEventSubscriptions(),this.performDestroy()}handleSettingsChange(t){this.shouldSkipSettingsUpdate()||this.performSettingsUpdate(t)}forceRepaint(t){this.performForceRepaint?.(t)}onVisibilityChanged(t){}onBecomingVisible(){}onBecomingHidden(){}async initializeViewportTracking(){let t=null;this.viewportOptions.trackingSelector&&(t=document.querySelector(this.viewportOptions.trackingSelector)),t?this.untrackViewport=Ea.trackElement(t,e=>this.handleVisibilityChange(e),this.viewportOptions):this.untrackViewport=Ea.trackSpotifyContainer(e=>this.handleVisibilityChange(e))}async initializeEventSubscriptions(){this.settingsSubscriptionId=p.subscribe("settings:changed",t=>this.handleUnifiedSettingsChange(t),`ViewportAwareSystem-${this.constructor.name}`)}cleanupEventSubscriptions(){this.settingsSubscriptionId&&(p.unsubscribe(this.settingsSubscriptionId),delete this.settingsSubscriptionId)}handleUnifiedSettingsChange(t){if(this.shouldSkipSettingsUpdate())return;let e=new CustomEvent("year3000SystemSettingsChanged",{detail:{key:t.settingKey,value:t.newValue}});this.performSettingsUpdate(e)}handleVisibilityChange(t){let e=this.isVisible;this.isVisible=t.isVisible,this.visibilityState=t,!e&&this.isVisible?this.handleBecomingVisible():e&&!this.isVisible&&this.handleBecomingHidden(),this.onVisibilityChanged(t)}handleBecomingVisible(){this.resumeTimeoutId&&clearTimeout(this.resumeTimeoutId),this.resumeTimeoutId=window.setTimeout(()=>{this.animationsPaused=!1,this.settingsUpdatesPaused=!1,this.onBecomingVisible()},this.viewportOptions.resumeDelay||100)}handleBecomingHidden(){this.viewportOptions.pauseAnimationsWhenHidden&&(this.animationsPaused=!0),this.viewportOptions.pauseSettingsUpdatesWhenHidden&&(this.settingsUpdatesPaused=!0),this.onBecomingHidden()}shouldSkipAnimationUpdate(){return this.animationsPaused||!this.isVisible&&(this.viewportOptions.pauseAnimationsWhenHidden??!0)}shouldSkipSettingsUpdate(){return this.settingsUpdatesPaused||!this.isVisible&&(this.viewportOptions.pauseSettingsUpdatesWhenHidden??!0)}cleanupViewportTracking(){this.untrackViewport&&(this.untrackViewport(),delete this.untrackViewport),this.resumeTimeoutId&&(clearTimeout(this.resumeTimeoutId),delete this.resumeTimeoutId)}getVisibilityInfo(){return{isVisible:this.isVisible,animationsPaused:this.animationsPaused,settingsUpdatesPaused:this.settingsUpdatesPaused,...this.visibilityState?.intersectionRatio!==void 0&&{intersectionRatio:this.visibilityState.intersectionRatio}}}}});var Gi,Es=v(()=>{"use strict";B();Xt();$();ee();Cs();te();Xe();ue();_();Gi=class o extends Fi{constructor(e=w,i=k,r=null,a=null,n={}){super({visibilityThreshold:.2,pauseAnimationsWhenHidden:!1,pauseSettingsUpdatesWhenHidden:!0,resumeDelay:50,...n});this.cssBatcher=null;this.performanceAnalyzer=null;this.observers=[];this.musicSyncService=null;this.currentQualityLevel=null;this.qualityCapabilities=[];this.effectCoordinationCallbacks=new Set;this.config=e,this.utils=i,this.cssBatcher=r,this.performanceAnalyzer=a,this.isSupported=this.detectBackdropFilterSupport(),this.currentIntensity="balanced",this.musicTemperatureMapper=new se(!0),this.oklabProcessor=new T(!0),this.effectPreset=T.getPreset("STANDARD"),this.effectState={currentMusicMood:"neutral",musicIntensity:.5,beatPhase:0,lastBeatTime:0,effectIntensityLevel:0,dynamicAccentHex:"#cba6f7",dynamicAccentRgb:"203,166,247",overallIntensityLevel:.5,genreStyle:"standard",animationRate:1}}static getInstance(){if(!o.instance)throw new Error("GlassmorphismManager instance not initialized");return o.instance}async initializeSystem(){let e=globalThis.year3000System;this.cssController=e?.cssController||A();let i=E.get("sn-glassmorphism-level");this.applyGlassmorphismSettings(i),await this.initializeMusicIntegration()}async performHealthCheck(){return{healthy:!0,ok:!0,details:"GlassmorphismManager is operational.",issues:[],system:"GlassmorphismManager"}}performAnimationUpdate(e){}performDestroy(){this.observers.forEach(e=>e.disconnect()),this.observers=[]}performSettingsUpdate(e){let i=e,{key:r,value:a}=i.detail||{};r===Ja&&(this.applyGlassmorphismSettings(a),this.updateGlassVariables(this.currentIntensity))}onBecomingVisible(){if(this.currentIntensity!=="disabled"){let e=document.documentElement,r=getComputedStyle(e).getPropertyValue("--spice-rgb-accent").trim();r&&r!==""&&this.updateGlassColors(`rgb(${r})`,`rgb(${r})`)}}onBecomingHidden(){}detectBackdropFilterSupport(){try{return CSS.supports("backdrop-filter","blur(1px)")||CSS.supports("-webkit-backdrop-filter","blur(1px)")}catch(e){return console.warn("StarryNight: CSS.supports not available, assuming no backdrop-filter support",e),!1}}applyGlassmorphismSettings(e){let i=document.body;i.classList.remove("sn-glass-disabled","sn-glass-minimal","sn-glass-balanced","sn-glass-intense"),i.classList.add(`sn-glass-${e}`),this.currentIntensity=e,this.updateGlassVariables(e)}updateGlassVariables(e){let i=document.documentElement,r=this.performanceAnalyzer?.shouldReduceQuality()||!1,a,n,s;switch(e){case"disabled":i.style.removeProperty("--glass-blur"),i.style.removeProperty("--glass-opacity"),i.style.removeProperty("--glass-saturation");return;case"minimal":a=r?"2px":"3px",n="0.05",s="1.05";break;case"moderate":a=r?"3px":"5px",n="0.08",s="1.15";break;case"intense":a=r?"6px":"8px",n="0.15",s="1.4";break;case"balanced":default:a=r?"4px":"6px",n="0.1",s="1.2";break}let l=this.calculateMusicModulations(),c=this.modulateBlurValue(a,l),m=this.modulateOpacityValue(n,l),d=this.modulateSaturationValue(s,l),h={"--glass-blur":c,"--glass-opacity":m,"--glass-saturation":d,"--glass-animation-rate":`${this.effectState.animationRate}s`,"--glass-visual-effects-level":this.effectState.overallIntensityLevel.toString()};this.cssController.batchSetVariables("GlassmorphismManager",h,"high","glass-properties-update")}updateGlassColors(e,i){if(this.currentIntensity==="disabled")return;let r=this.convertToGlassColor(e,.1),a=this.convertToGlassColor(i,.08),n={"--glass-background":r,"--glass-border":a};this.cssController.batchSetVariables("GlassmorphismManager",n,"high","glass-color-update")}convertToGlassColor(e,i){try{if(typeof e!="string")return this.getThemeAwareFallback(i);if(e.startsWith("rgb")){let r=e.match(/\d+/g);if(r&&r.length>=3)return`rgba(${r[0]}, ${r[1]}, ${r[2]}, ${i})`}if(e.startsWith("#")){let r=e.slice(1),a=parseInt(r.substring(0,2),16),n=parseInt(r.substring(2,4),16),s=parseInt(r.substring(4,6),16);if(!isNaN(a)&&!isNaN(n)&&!isNaN(s))return`rgba(${a}, ${n}, ${s}, ${i})`}return this.getThemeAwareFallback(i)}catch{return this.getThemeAwareFallback(i)}}getThemeAwareFallback(e){let i=document.documentElement,r=getComputedStyle(i);if(this.effectState.dynamicAccentRgb&&this.effectState.dynamicAccentRgb!=="203,166,247")return`rgba(${this.effectState.dynamicAccentRgb}, ${e})`;let a=r.getPropertyValue("--sn-dynamic-accent-rgb").trim()||r.getPropertyValue("--sn-color-accent-rgb").trim()||r.getPropertyValue("--spice-rgb-accent").trim();if(a&&a!==""&&!a.includes("undefined"))return`rgba(${a}, ${e})`;let n=r.getPropertyValue("--spice-rgb-text").trim();return n&&n!==""&&!n.includes("undefined")?`rgba(${n}, ${e})`:`rgba(203, 166, 247, ${e})`}async initializeMusicIntegration(){try{p.subscribe("colors:extracted",e=>{this.onColorsExtracted(e)},"GlassmorphismManager"),p.subscribe("colors:harmonized",e=>{this.onColorsHarmonized(e)},"GlassmorphismManager"),p.subscribe("music:beat",e=>{this.onMusicBeat(e)},"GlassmorphismManager"),p.subscribe("music:dramatic-peak-detected",e=>{this.onCinematicDramaEvent(e)},"GlassmorphismManager"),this.updateDynamicAccentColor(),this.initializeCrossSystemCoordination(),console.log("[GlassmorphismManager] \u2705 Year 3000 visual-effects integration initialized")}catch(e){console.error("[GlassmorphismManager] Failed to initialize visual-effects integration:",e)}}calculateMusicModulations(){let{musicIntensity:e,beatPhase:i,effectIntensityLevel:r,overallIntensityLevel:a}=this.effectState,n=1+(e-.5)*.4,s=1+Math.sin(i)*a*.15,l=1+r*.3,c=1+Math.sin(Date.now()*this.effectState.animationRate*.001)*.08;return{musicModulation:n,beatModulation:s,cinematicModulation:l,animationModulation:c}}modulateBlurValue(e,i){let r=parseFloat(e.replace("px","")),{musicModulation:a,beatModulation:n,animationModulation:s}=i,l=r*a*n*s;return`${Math.max(1,Math.round(l))}px`}modulateOpacityValue(e,i){let r=parseFloat(e),{musicModulation:a,cinematicModulation:n,animationModulation:s}=i,l=r*(1+(a-1)*.5)*n*s;return Math.max(.01,Math.min(1,l)).toFixed(3)}modulateSaturationValue(e,i){let r=parseFloat(e),{musicModulation:a,beatModulation:n,cinematicModulation:s}=i,l=r*a*n*s;return Math.max(1,Math.min(3,l)).toFixed(2)}onColorsExtracted(e){let{rawColors:i,musicData:r}=e;if(r){let a=this.musicTemperatureMapper.mapMusicToEmotionalTemperature(r);this.updateMusicState(a)}}onColorsHarmonized(e){let{processedColors:i,coordinationMetrics:r}=e;if(i.VIBRANT){let a=this.oklabProcessor.processColor(i.VIBRANT,this.effectPreset);this.effectState.dynamicAccentHex=a.enhancedHex,this.effectState.dynamicAccentRgb=`${a.enhancedRgb.r},${a.enhancedRgb.g},${a.enhancedRgb.b}`,this.updateGlassColors(a.enhancedHex,a.enhancedHex)}r?.overallIntensityLevel!==void 0&&(this.effectState.overallIntensityLevel=r.overallIntensityLevel)}onMusicBeat(e){let{beat:i,intensity:r,timestamp:a}=e;this.effectState.beatPhase+=Math.PI*2*.5,this.effectState.lastBeatTime=a||Date.now(),r>.8&&this.currentIntensity!=="disabled"&&this.applyBeatSyncGlassPulse(r)}onCinematicDramaEvent(e){let{intensity:i,type:r}=e;this.effectState.effectIntensityLevel=i,i>.7&&this.currentIntensity!=="disabled"&&this.applyDramaticGlassDistortion(i)}updateMusicState(e){switch(this.effectState.currentMusicMood=e.primaryEmotion,this.effectState.musicIntensity=e.intensity,e.primaryEmotion){case"energetic":case"aggressive":this.effectState.animationRate=1.5,this.effectPreset=T.getPreset("COSMIC");break;case"calm":case"ambient":this.effectState.animationRate=.7,this.effectPreset=T.getPreset("SUBTLE");break;default:this.effectState.animationRate=1,this.effectPreset=T.getPreset("STANDARD")}}applyBeatSyncGlassPulse(e){if(!this.cssBatcher||!!1)return;let r=this.getIntensityValue(this.currentIntensity),a=e*2*(r.opacity*10),n=e*.05*r.opacity;this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-blur",`${a}px`),this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-opacity",n.toString()),setTimeout(()=>{this.cssBatcher&&(this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-blur","0px"),this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-opacity","0"))},150)}applyDramaticGlassDistortion(e){if(!this.cssBatcher)return;let i=e*4,r=1+e*.5;this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-blur",`${i}px`),this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-saturation",r.toString()),setTimeout(()=>{this.cssBatcher&&(this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-blur","0px"),this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-saturation","1"))},1200)}updateDynamicAccentColor(){let e=document.documentElement,i=getComputedStyle(e),r=i.getPropertyValue("--sn-dynamic-accent-hex").trim()||i.getPropertyValue("--sn-color-accent-hex").trim()||i.getPropertyValue("--spice-accent").trim(),a=i.getPropertyValue("--sn-dynamic-accent-rgb").trim()||i.getPropertyValue("--sn-color-accent-rgb").trim()||i.getPropertyValue("--spice-rgb-accent").trim();r&&r!==""&&(this.effectState.dynamicAccentHex=r),a&&a!==""&&(this.effectState.dynamicAccentRgb=a)}getConsciousnessState(){return{...this.effectState}}setQualityLevel(e){this.adjustQuality(e)}adjustQuality(e){this.currentQualityLevel=e;let i;switch(e){case"low":i="minimal";break;case"medium":i="balanced";break;case"high":i="intense";break;default:i="balanced";break}this.applyGlassmorphismSettings(i),console.log(`[GlassmorphismManager] Quality level set to: ${e} (intensity: ${i})`)}getPerformanceImpact(){let e=this.currentIntensity==="disabled"?0:this.currentIntensity==="minimal"?.1:this.currentIntensity==="balanced"?.3:this.currentIntensity==="intense"?.5:.2,i=this.effectState.overallIntensityLevel*.1,r=this.effectState.animationRate>1?.05:0;return{fps:60,frameTime:e+i+r,memoryUsage:e*2,cpuUsage:(e+i)*50}}reduceQuality(e){if(this.currentQualityLevel){if(this.effectState.overallIntensityLevel=Math.max(.1,this.effectState.overallIntensityLevel-e),this.effectState.animationRate=Math.max(.5,this.effectState.animationRate-e*.5),e>.5)switch(this.currentIntensity){case"intense":this.applyGlassmorphismSettings("balanced");break;case"balanced":this.applyGlassmorphismSettings("minimal");break;case"minimal":this.applyGlassmorphismSettings("disabled");break}console.log(`[GlassmorphismManager] Quality reduced by ${e}`)}}increaseQuality(e){if(this.currentQualityLevel){if(this.effectState.overallIntensityLevel=Math.min(1,this.effectState.overallIntensityLevel+e),this.effectState.animationRate=Math.min(2,this.effectState.animationRate+e*.5),e>.5)switch(this.currentIntensity){case"disabled":this.applyGlassmorphismSettings("minimal");break;case"minimal":this.applyGlassmorphismSettings("balanced");break;case"balanced":this.applyGlassmorphismSettings("intense");break}console.log(`[GlassmorphismManager] Quality increased by ${e}`)}}getQualityCapabilities(){return this.qualityCapabilities.length===0&&(this.qualityCapabilities=[{name:"Backdrop Filter Blur",enabled:this.isSupported&&this.currentIntensity!=="disabled",qualityLevel:"high"},{name:"Glass Saturation",enabled:this.currentIntensity!=="disabled",qualityLevel:"low"},{name:"Consciousness Breathing",enabled:!0,qualityLevel:"low"},{name:"Beat Sync Pulse",enabled:!0,qualityLevel:"low"},{name:"Dramatic Distortion",enabled:!0,qualityLevel:"medium"}]),this.qualityCapabilities}async refreshColorState(e){try{if(this.updateDynamicAccentColor(),this.effectState.dynamicAccentHex){let i=this.oklabProcessor.processColor(this.effectState.dynamicAccentHex,this.effectPreset);this.effectState.dynamicAccentHex=i.enhancedHex,this.effectState.dynamicAccentRgb=`${i.enhancedRgb.r},${i.enhancedRgb.g},${i.enhancedRgb.b}`,this.updateGlassColors(i.enhancedHex,i.enhancedHex)}console.log(`[GlassmorphismManager] Color state refreshed for trigger: ${e}`)}catch(i){console.error("[GlassmorphismManager] Error refreshing color state:",i)}}onConsciousnessCoordination(e){return this.effectCoordinationCallbacks.add(e),()=>{this.effectCoordinationCallbacks.delete(e)}}synchronizeConsciousnessState(e){e.currentMusicMood&&(this.effectState.currentMusicMood=e.currentMusicMood),e.musicIntensity!==void 0&&(this.effectState.musicIntensity=e.musicIntensity),e.beatPhase!==void 0&&(this.effectState.beatPhase=e.beatPhase),e.effectIntensityLevel!==void 0&&(this.effectState.effectIntensityLevel=e.effectIntensityLevel),e.overallIntensityLevel!==void 0&&(this.effectState.overallIntensityLevel=e.overallIntensityLevel),e.dynamicAccentHex&&(this.effectState.dynamicAccentHex=e.dynamicAccentHex),e.dynamicAccentRgb&&(this.effectState.dynamicAccentRgb=e.dynamicAccentRgb),e.genreStyle&&(this.effectState.genreStyle=e.genreStyle),e.animationRate!==void 0&&(this.effectState.animationRate=e.animationRate),this.updateGlassVariables(this.currentIntensity),this.broadcastConsciousnessState()}broadcastConsciousnessState(){this.effectCoordinationCallbacks.forEach(e=>{try{e(this.effectState)}catch(i){console.error("[GlassmorphismManager] Error in visual-effects coordination callback:",i)}})}updateMusicStateWithCoordination(e){this.updateMusicState(e),this.broadcastConsciousnessState(),p.emit("visual-effects:coordination",{source:"GlassmorphismManager",state:this.convertToVisualEffectsState(this.effectState),timestamp:Date.now()})}onMusicBeatWithCoordination(e){this.onMusicBeat(e),this.broadcastConsciousnessState(),p.subscribe("music:beat-sync",i=>{i.source!=="GlassmorphismManager"&&(this.effectState.beatPhase=i.beatPhase,this.effectState.lastBeatTime=i.lastBeatTime)},"GlassmorphismManager")}onCinematicDramaEventWithCoordination(e){this.onCinematicDramaEvent(e),this.broadcastConsciousnessState(),p.subscribe("music:dramatic-sync",i=>{i.source!=="GlassmorphismManager"&&(this.effectState.effectIntensityLevel=i.dramaticLevel,i.dramaticLevel>.7&&this.applyDramaticGlassDistortion(i.dramaticLevel))},"GlassmorphismManager")}initializeCrossSystemCoordination(){try{p.subscribe("visual-effects:coordination",e=>{e.source!=="GlassmorphismManager"&&this.synchronizeConsciousnessState(this.convertFromVisualEffectsState(e.state))},"GlassmorphismManager"),p.subscribe("music:beat-sync",e=>{e.source!=="GlassmorphismManager"&&(this.effectState.beatPhase=e.beatPhase,this.effectState.lastBeatTime=e.lastBeatTime,this.applyCoordinatedBeatPulse(e.beatPhase))},"GlassmorphismManager"),p.subscribe("music:dramatic-sync",e=>{e.source!=="GlassmorphismManager"&&(this.effectState.effectIntensityLevel=e.dramaticLevel,this.applyCoordinatedDramaticEffects(e.dramaticLevel,e.type||"unknown"))},"GlassmorphismManager"),console.log("[GlassmorphismManager] \u2705 Cross-system visual-effects coordination initialized")}catch(e){console.error("[GlassmorphismManager] Failed to initialize cross-system coordination:",e)}}checkPerformanceAndAdjust(){this.performanceAnalyzer?.shouldReduceQuality()&&(this.currentIntensity==="intense"?this.applyGlassmorphismSettings("balanced"):(this.currentIntensity==="balanced"||this.currentIntensity==="moderate")&&this.applyGlassmorphismSettings("minimal"))}applyGlassmorphism(e){let i=this.config.glassmorphism[e];this.cssBatcher&&(this.cssBatcher.queueCSSVariableUpdate("--sn-glass-display",e==="disabled"?"none":"block"),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-blur",`${i.blur}px`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-saturation",`${i.saturation}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-brightness",`${i.brightness}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-noise-opacity",`${i.noiseOpacity}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-border-opacity",`${i.borderOpacity}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-shadow-opacity",`${i.shadowOpacity}`),this.cssBatcher.flushCSSVariableBatch(),this.config.enableDebug&&console.log(`\u{1F48E} [GlassmorphismManager] Applied level: ${e}`))}applyUpdatedSettings(e,i){e==="sn-glassmorphism-level"&&(this.applyGlassmorphismSettings(i),this.updateGlassVariables(this.currentIntensity))}applyCoordinatedBeatPulse(e){let i=this.calculateMusicModulations(),r=this.getIntensityValue(this.currentIntensity),a=1+Math.sin(e)*.15*i.beatModulation,n=r.opacity*a;this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-opacity",n.toString()),this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-accent-opacity",(n*.8).toString()),this.cssBatcher?.flushCSSVariableBatch()}applyCoordinatedDramaticEffects(e,i){let r=this.calculateMusicModulations(),a=this.getIntensityValue(this.currentIntensity),n=1+e*.4,s=Math.min(1,a.opacity*n),l=Math.min(20,a.blur*(1+e*.3));this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-opacity",s.toString()),this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-blur",`${l}px`),this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-accent-opacity",(s*.9).toString()),this.cssBatcher?.flushCSSVariableBatch(),setTimeout(()=>{this.updateGlassVariables(this.currentIntensity)},1500)}getIntensityValue(e){switch(e){case"disabled":return{opacity:0,blur:0,saturation:1};case"minimal":return{opacity:.05,blur:3,saturation:1.05};case"balanced":return{opacity:.1,blur:6,saturation:1.2};case"intense":return{opacity:.15,blur:8,saturation:1.4};case"moderate":return{opacity:.08,blur:5,saturation:1.15};default:return{opacity:.1,blur:6,saturation:1.2}}}convertToVisualEffectsState(e){return{intensity:e.effectIntensityLevel,colorTemperature:6500,animationScale:e.musicIntensity,dominantEmotion:e.currentMusicMood,resonance:e.musicIntensity,symbioticResonance:e.musicIntensity,surfaceFluidityIndex:e.musicIntensity,animationScaleRate:e.effectIntensityLevel,emotionalTemperature:6500,pulsingCycle:e.beatPhase,cinematicIntensity:e.effectIntensityLevel}}convertFromVisualEffectsState(e){return{currentMusicMood:e.dominantEmotion,musicIntensity:e.intensity,effectIntensityLevel:e.intensity,overallIntensityLevel:e.intensity}}}});var _i,ws=v(()=>{"use strict";_();B();_i=class{constructor(t,e,i){this.initialized=!1;this.musicSyncService=null;this.currentGenre=null;this.lastUpdateTime=0;this.throttleMs=300;this.genreAwareSelectors=[".Root__main-view",".Root__now-playing-bar",".Root__nav-bar",".main-playButton-PlayButton",".player-controls",".main-card",".card",".artist-card",".playlist-card"];this.genreProfileManager=t,this.musicSyncService=e||null,this.config=i||w}async initialize(){if(!this.initialized)try{p.subscribe("music:track-changed",this.handleTrackChange.bind(this),"GenreUIBridge"),this.initialized=!0,this.config.enableDebug&&console.log("\u{1F3A8} [GenreUIBridge] Initialized - bridging genre detection to UI")}catch(t){throw console.error("[GenreUIBridge] Initialization failed:",t),t}}updateAnimation(t){}async healthCheck(){return{healthy:this.initialized&&this.genreProfileManager!==null,metrics:{lastCheck:Date.now(),initialized:this.initialized,hasGenreManager:this.genreProfileManager!==null,currentGenre:this.currentGenre||"none"}}}destroy(){this.removeGenreAttributes(),p.unsubscribeAll("GenreUIBridge"),this.initialized=!1,this.config.enableDebug&&console.log("\u{1F3A8} [GenreUIBridge] Destroyed")}handleTrackChange(t){let e=t.audioFeatures;if(e){let i=this.genreProfileManager.detectGenre(e);this.updateGenreUI(i)}}updateGenreUI(t){let e=Date.now();if(!(e-this.lastUpdateTime<this.throttleMs)&&(this.lastUpdateTime=e,t!==this.currentGenre&&(this.currentGenre=t,this.applyGenreAttributes(t),this.updateGenreVisualVariables(t),this.config.enableDebug))){let i=this.genreProfileManager.getGenreConfidence();console.log(`\u{1F3A8} [GenreUIBridge] Applied genre '${t}' to UI (confidence: ${(i*100).toFixed(0)}%)`)}}applyGenreAttributes(t){this.genreAwareSelectors.forEach(e=>{document.querySelectorAll(e).forEach(r=>{r.setAttribute("data-genre-active",t)})}),document.body.classList.add("genre-switching"),setTimeout(()=>{document.body.classList.remove("genre-switching")},600)}removeGenreAttributes(){this.genreAwareSelectors.forEach(t=>{document.querySelectorAll(t).forEach(i=>{i.removeAttribute("data-genre-active")})})}updateGenreVisualVariables(t){let e=this.genreProfileManager.getVisualStyle(t),i=this.genreProfileManager.getCharacteristics(t),r=document.documentElement;r.style.setProperty("--genre-primary-hue-min",`${e.primaryHueRange[0]}`),r.style.setProperty("--genre-primary-hue-max",`${e.primaryHueRange[1]}`),r.style.setProperty("--genre-saturation-base",`${e.saturationProfile[0]}`),r.style.setProperty("--genre-saturation-variation",`${e.saturationProfile[1]}`),r.style.setProperty("--genre-brightness-base",`${e.brightnessProfile[0]}`),r.style.setProperty("--genre-brightness-variation",`${e.brightnessProfile[1]}`),r.style.setProperty("--genre-contrast-level",`${e.contrastLevel}`),r.style.setProperty("--genre-gradient-complexity",`${e.gradientComplexity}`),r.style.setProperty("--genre-animation-style",e.animationStyle),r.style.setProperty("--genre-pulse-behavior",e.pulseBehavior),r.style.setProperty("--genre-bass-emphasis",`${i.bassEmphasis}`),r.style.setProperty("--genre-energy-level",`${i.dynamicRange}`)}forceGenreUpdate(t){this.updateGenreUI(t)}getCurrentGenre(){return this.currentGenre}}});function Oe(o,t={}){if(!Rl)return Array.from(document.querySelectorAll(o));let e=wa.get(o),i=e?.ref?.deref();return(t.force||!i)&&(i=Array.from(document.querySelectorAll(o)),e={ref:new WeakRef(i),lastUpdate:Date.now()},wa.set(o,e),Vl?.register(i,o)),i}var wa,Rl,kl,Vl,Ms=v(()=>{"use strict";wa=new Map,Rl=typeof WeakRef<"u",kl=typeof FinalizationRegistry<"u",Vl=kl?new FinalizationRegistry(o=>{wa.delete(o)}):null});function Bt(o){return Oe(o).length>0}function Gl(o,t,e){let i=Oe(o,e);return i.length===0&&t&&(i=Oe(t,e),i.length>0&&console.warn(`\u{1F30C} [SpotifyDOMSelectors] Using legacy selector: ${t}. Consider updating to: ${o}`)),i}function _l(){console.group("\u{1F30C} [SpotifyDOMSelectors] DOM Validation");let o={found:0,missing:0,details:{}};return Object.entries(D).forEach(([t,e])=>{let i=Bt(e);o.details[t]={selector:e,exists:i,element:i&&Oe(e)[0]||null},i?(o.found++,console.log(`\u2705 ${t}: ${e}`)):(o.missing++,console.warn(`\u274C ${t}: ${e}`))}),console.log(`\u{1F4CA} Summary: ${o.found} found, ${o.missing} missing`),console.groupEnd(),o}function Bl(){console.group("\u{1F30C} [Phase 1] Testing Gravity System Selectors"),console.log("\u{1F3AF} Primary gravity well targets:"),_t.primary&&_t.primary.forEach(o=>{let t=Oe(o)[0]||null;console.log(`${t?"\u2705":"\u274C"} ${o}`,t)}),console.log("\u{1F3AF} Secondary gravity well targets:"),_t.secondary&&_t.secondary.forEach(o=>{let t=Oe(o)[0]||null;console.log(`${t?"\u2705":"\u274C"} ${o}`,t)}),console.log("\u{1F6F8} Orbital elements:"),Object.entries(Ue).forEach(([o,t])=>{let e=Oe(t);console.log(`${e.length>0?"\u2705":"\u274C"} ${o} (${t}): ${e.length} found`)}),console.groupEnd()}function Ts(){console.group("\u{1F52E} [SpotifyDOMSelectors] Phase 2 - Prediction Target Validation");let o=[{name:"Track Rows",selector:Ue.trackRows},{name:"Progress Bar",selector:D.progressBar},{name:"Play Button",selector:D.playButton},{name:"Heart Button",selector:D.heartButton},{name:"Album Cover",selector:D.albumCover},{name:"Now Playing Widget",selector:D.nowPlayingWidget},{name:"Now Playing Left",selector:D.nowPlayingLeft},{name:"Left Sidebar",selector:D.leftSidebar},{name:"Library Items",selector:Ue.libraryItems}],t={found:0,missing:0,details:{}};return o.forEach(({name:e,selector:i})=>{if(!i)return;let a=Gl(i).length;t.details[e]={selector:i,count:a,exists:a>0},a>0?(t.found++,console.log(`\u2705 ${e}: ${a} elements found (${i})`)):(t.missing++,console.warn(`\u274C ${e}: No elements found (${i})`))}),console.log(`\u{1F4CA} Prediction Targets Summary: ${t.found} types found, ${t.missing} missing`),console.groupEnd(),t}function Hl(){console.group("\u{1F30C} [SpotifyDOMSelectors] Phase 2 - System Integration Test");let o={behavioralPrediction:Ts(),dimensionalNexus:{sidebarElement:D.leftSidebar?Bt(D.leftSidebar):!1},dataGlyph:{navLinks:D.navBarLink?Bt(D.navBarLink):!1,trackRows:Ue.trackRows?Bt(Ue.trackRows):!1,cards:Ue.cards?Bt(Ue.cards):!1}},t=0;return Object.values(o).forEach(e=>{typeof e=="object"&&e.missing&&(t+=e.missing)}),console.log(`\u{1F3AF} Phase 2 Integration Health: ${t===0?"\u2705 All systems operational":`\u26A0\uFE0F ${t} issues detected`}`),console.groupEnd(),o}var D,wp,Ue,_t,Fl,Ma=v(()=>{"use strict";Ms();D={nowPlayingBar:".Root__now-playing-bar",leftSidebar:".Root__nav-bar",mainView:".Root__main-view",rightSidebar:".Root__right-sidebar",nowPlayingWidget:"[data-testid='now-playing-widget']",nowPlayingLeft:".main-nowPlayingBar-left",nowPlayingCenter:".main-nowPlayingBar-center",nowPlayingRight:".main-nowPlayingBar-right",coverArt:".main-coverSlotCollapsed-container",trackInfo:".main-trackInfo-container",navMain:"nav[aria-label='Main']",yourLibrary:".main-yourLibraryX-libraryContainer",libraryItems:".main-yourLibraryX-listItem",libraryHeader:".main-yourLibraryX-header",playlistList:".main-rootlist-wrapper",trackListContainer:"[role='grid'][aria-label*='tracks']",trackRow:".main-trackList-trackListRow",trackListHeader:".main-trackList-trackListHeaderRow",trackNumber:".main-trackList-rowSectionIndex",trackTitle:".main-trackList-rowTitle",trackArtist:".main-trackList-rowSubTitle",entityHeader:".main-entityHeader-container",entityTitle:".main-entityHeader-title",entityMetadata:".main-entityHeader-metaData",entityImage:".main-entityHeader-imageContainer",actionBar:".main-actionBar-ActionBarRow",actionBarInner:".main-actionBar-ActionBar",playButton:"[data-testid='play-button']",pauseButton:"[data-testid='pause-button']",shuffleButton:"[data-testid='shuffle-button']",likeButton:".control-button-heart",queue:".main-queue-trackList",queueContainer:"[aria-label='Next in queue']",aboutArtist:"[aria-label='About the artist']",credits:"[aria-label='Credits']",searchInput:"[data-testid='search-input']",searchPage:"[data-testid='search-container']",filterPills:".main-genre-chip",sortButton:"[data-testid='sort-button']",card:".sn-card, .main-card-card",cardImage:".main-cardImage-image",albumArt:".main-trackList-albumArt",modal:".main-modal-container",overlay:".main-overlay-container"},wp=Object.entries({".main-nowPlayingWidget-nowPlaying":D.nowPlayingBar,".main-navBar-navBar":D.leftSidebar,".main-search-searchBar":D.searchInput,".main-topBar-topBar":D.actionBar,".main-queue-queue":D.queue,".main-trackList-trackList":D.trackListContainer}).reduce((o,[t,e])=>(typeof e=="string"&&(o[t]=e),o),{}),Ue={trackRows:D.trackRow??"",libraryItems:D.libraryItems??"",cards:D.card??"",navLinks:".main-navBar-navBarLink"},_t={primary:[D.nowPlayingBar,D.leftSidebar,D.entityHeader].filter(o=>!!o),secondary:[D.actionBar,D.queue,D.searchInput].filter(o=>!!o),tertiary:[D.playButton,D.trackListHeader].filter(o=>!!o)},Fl={searchAreas:[D.searchInput,D.searchPage].filter(o=>!!o),notifications:["[data-testid='notification-bar']",".main-topBar-notifications"],dropdowns:[".main-dropdown-menu","[role='menu']","[role='listbox']"]};typeof window<"u"&&(window.SpotifyDOMSelectors={validate:_l,testGravity:Bl,validatePredictionTargets:Ts,testPhase2Systems:Hl,selectors:D,targets:_t,orbital:Ue,antiGravity:Fl},console.log("\u{1F3AF} [SpotifyDOMSelectors] Debug functions available:"),console.log("  window.SpotifyDOMSelectors.validate() - Test all selectors"),console.log("  window.SpotifyDOMSelectors.testGravity() - Test gravity selectors"))});var xs={};ne(xs,{SidebarPerformanceCoordinator:()=>Ul,SidebarPerformanceManager:()=>Ne,getSidebarPerformanceCoordinator:()=>Ol,getSidebarPerformanceManager:()=>zl});function zl(o){return Ne.getInstance(o)}function Ol(o){return Ne.getInstance(o)}var De,Ne,Ul,Ta=v(()=>{"use strict";_();$();ra();Ma();De=class De{constructor(t={}){this.pendingUpdates=new Map;this.isFlushScheduled=!1;this.rafId=null;this.performanceAnalyzer=null;this.harmonicVariableMap=new Map([["--sn-rs-beat-intensity","--sn-beat-pulse-intensity"],["--sn-rs-glow-alpha","--sn-rhythm-phase"],["--sn-rs-hue-shift","--sn-spectrum-phase"]]);this.flushCount=0;this.totalFlushTime=0;this.lastFlushTimestamp=0;this.budgetManager=null;this.domObserver=null;this.sidebarElement=null;this.visibilityObserver=null;this.observationThrottleTimer=null;this.lastObservationTime=0;this.OBSERVATION_THROTTLE_MS=200;this.isFirstOpen=!0;this.lastScrollUpdate=0;this.activeTimeouts=new Set;this.domObservationRetryTimeout=null;this.musicChangeUnsubscribe=null;this.config={enableDebug:t.enableDebug??!1,maxBatchSize:t.maxBatchSize??50,...t},this.performanceAnalyzer=t.performanceAnalyzer||null;let e=globalThis.year3000System;this.cssController=e.getGlobalOptimizedCSSController(),this.performanceAnalyzer&&(this.budgetManager=gt.getInstance(void 0,this.performanceAnalyzer)),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceManager] Initialized with RAF-based batching")}static getInstance(t){return De.instance||(De.instance=new De(t)),De.instance}queueUpdate(t,e){if(["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift"].includes(t)){this.applyCriticalUpdate(t,e);return}try{A().queueCSSVariableUpdate(t,e,this.getSidebarElement())}catch{this.pendingUpdates.set(t,{property:t,value:e,timestamp:performance.now()}),this.config.enableDebug&&this.pendingUpdates.size===1&&console.log(`\u{1F30C} [SidebarPerformanceManager] Queuing first update (fallback): ${t}`),this.scheduleFlush()}}applyCriticalUpdate(t,e){try{this.cssController.queueCSSVariableUpdate(t,e,null,"critical","sidebar-critical-update")}catch(i){console.error(`\u{1F30C} [SidebarPerformanceManager] Failed to apply critical ${t}:`,i)}}getSidebarElement(){return this.sidebarElement||(this.sidebarElement=document.querySelector(D.rightSidebar)),this.sidebarElement||document.documentElement}scheduleFlush(){this.isFlushScheduled||(this.isFlushScheduled=!0,this.rafId=requestAnimationFrame(()=>{this.flushUpdates()}))}flushUpdates(){if(this.pendingUpdates.size===0){this.isFlushScheduled=!1;return}let t=performance.now(),e=this.getSidebarElement(),i=this.pendingUpdates.size;this.config.enableDebug&&console.log(`\u{1F30C} [SidebarPerformanceManager] Flushing ${i} updates atomically`),i>(this.config.maxBatchSize||50)&&console.warn(`\u{1F30C} [SidebarPerformanceManager] Large batch detected (${i} updates), may impact performance`);try{let s={},l={};for(let c of this.pendingUpdates.values()){s[c.property]=c.value;let m=this.harmonicVariableMap.get(c.property);m&&(l[m]=c.value,this.config.enableDebug&&console.log(`\u{1F30C} [SidebarPerformanceManager] Mapped ${c.property} \u2192 ${m} = ${c.value}`))}if(Object.keys(s).length>0){let c=e;for(let[m,d]of Object.entries(s))c.style.setProperty(m,d)}Object.keys(l).length>0&&this.cssController.batchSetVariables("SidebarPerformanceManager",l,"high","harmonic-variable-mapping")}catch(s){console.error("\u{1F30C} [SidebarPerformanceManager] Failed to apply batched updates:",s)}if(this.pendingUpdates.clear(),this.isFlushScheduled=!1,this.rafId=null,this.config.onFlushComplete)try{this.config.onFlushComplete()}catch(s){console.error("\u{1F30C} [SidebarPerformanceManager] Error in flush completion callback:",s)}let r=performance.now(),a=r-t;this.flushCount++,this.totalFlushTime+=a,this.lastFlushTimestamp=r,this.performanceAnalyzer&&this.performanceAnalyzer.emitTrace?.(`[SidebarPerformanceManager] Flushed ${i} updates in ${a.toFixed(2)}ms`);let n=this.flushCount>0?this.totalFlushTime/this.flushCount:0;n>3&&console.warn(`\u{1F30C} [SidebarPerformanceManager] Performance threshold exceeded: average ${n.toFixed(2)}ms per flush (target: <3ms)`),this.config.enableDebug&&a>4&&console.warn(`\u{1F30C} [SidebarPerformanceManager] Slow flush detected: ${a.toFixed(2)}ms for ${i} updates`)}setupMusicChangeCoordination(){this.musicChangeUnsubscribe||(this.musicChangeUnsubscribe=()=>{p.unsubscribeAll("SidebarPerformanceManager")},p.subscribe("music:track-changed",t=>{this.handleMusicChange({timestamp:t.timestamp,source:"track-changed",reason:"music:track-changed event"})},"SidebarPerformanceManager"),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceManager] Event-driven music coordination active"))}handleMusicChange(t){this.sidebarElement&&(this.handleVisibilityChange(),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceManager] Music change coordinated via event",{source:t.source,reason:t.reason,timestamp:t.timestamp}))}setupDOMObservation(){if(!this.domObserver){if(this.setupMusicChangeCoordination(),this.sidebarElement=document.querySelector(D.rightSidebar),!this.sidebarElement){this.config.enableDebug&&console.warn("\u{1F30C} [SidebarPerformanceManager] Sidebar not found, deferring DOM observation"),this.domObservationRetryTimeout&&(clearTimeout(this.domObservationRetryTimeout),this.activeTimeouts.delete(this.domObservationRetryTimeout)),this.domObservationRetryTimeout=setTimeout(()=>{this.setupDOMObservation(),this.domObservationRetryTimeout=null},1e3),this.activeTimeouts.add(this.domObservationRetryTimeout);return}this.domObserver=new MutationObserver(t=>{let e=t.filter(i=>this.isRelevantMutation(i));e.length!==0&&this.throttleObservationUpdate(()=>{for(let i of e)i.type==="attributes"&&(i.attributeName==="aria-hidden"||i.attributeName==="style")&&this.handleVisibilityChange();this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceManager] Relevant DOM change detected - visibility/structure only",{mutationCount:e.length,types:e.map(i=>i.type)})})}),this.domObserver.observe(this.sidebarElement,{childList:!0,subtree:!1,attributes:!0,attributeFilter:["aria-hidden","style","class"],attributeOldValue:!1,characterData:!1}),this.setupVisibilityObserver(),this.setupScrollObservation(),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceManager] DOM observation active on sidebar")}}setupVisibilityObserver(){!this.sidebarElement||this.visibilityObserver||(this.visibilityObserver=new IntersectionObserver(t=>{let e=t[0];e&&e.isIntersecting&&this.isFirstOpen&&(window.requestIdleCallback?window.requestIdleCallback(()=>{this.triggerTemporalEcho(),this.isFirstOpen=!1}):setTimeout(()=>{this.triggerTemporalEcho(),this.isFirstOpen=!1},0))},{threshold:.1}),this.visibilityObserver.observe(this.sidebarElement))}setupScrollObservation(){if(!this.sidebarElement)return;let t=this.sidebarElement.querySelector(".main-nowPlayingView-queue");t&&t.addEventListener("scroll",this.throttledScrollHandler.bind(this),{passive:!0})}throttledScrollHandler(){let t=performance.now();t-this.lastScrollUpdate<33||(this.lastScrollUpdate=t,window.requestIdleCallback?window.requestIdleCallback(()=>{this.queueUpdate("--sn-rs-scroll-ratio",Math.random().toString())},{timeout:100}):this.queueUpdate("--sn-rs-scroll-ratio",Math.random().toString()))}isRelevantMutation(t){if(t.type==="attributes"){let e=t.attributeName;return e==="aria-hidden"||e==="style"||e==="class"?!0:(e?.startsWith("--")||e==="data-style",!1)}return t.type==="childList"?t.addedNodes&&Array.from(t.addedNodes).some(i=>i.nodeType===Node.ELEMENT_NODE)||t.removedNodes&&Array.from(t.removedNodes).some(i=>i.nodeType===Node.ELEMENT_NODE):!1}throttleObservationUpdate(t){let e=performance.now();e-this.lastObservationTime<this.OBSERVATION_THROTTLE_MS?(this.observationThrottleTimer&&clearTimeout(this.observationThrottleTimer),this.observationThrottleTimer=window.setTimeout(()=>{t(),this.lastObservationTime=performance.now(),this.observationThrottleTimer=null},this.OBSERVATION_THROTTLE_MS)):(t(),this.lastObservationTime=e)}handleVisibilityChange(){if(!this.sidebarElement)return;let t=!this.sidebarElement.hasAttribute("aria-hidden")&&!this.sidebarElement.style.display?.includes("none");t&&this.isFirstOpen&&(this.triggerTemporalEcho(),this.isFirstOpen=!1),this.config.enableDebug&&console.log(`\u{1F30C} [SidebarPerformanceManager] Visibility changed: ${t?"visible":"hidden"}`)}triggerTemporalEcho(){if(!this.sidebarElement)return;this.sidebarElement.classList.add("sn-future-preview"),this.queueUpdate("--sn-kinetic-intensity","1"),this.queueUpdate("--sn-echo-hue-shift","15deg"),this.queueUpdate("--sn-echo-radius-multiplier","1.2"),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceManager] Triggering temporal echo effect");let t=setTimeout(()=>{this.sidebarElement?.classList.remove("sn-future-preview"),this.queueUpdate("--sn-kinetic-intensity","0"),this.activeTimeouts.delete(t)},2e3);this.activeTimeouts.add(t)}getPerformanceMetrics(){return{flushCount:this.flushCount,averageFlushTime:this.flushCount>0?this.totalFlushTime/this.flushCount:0,lastFlushTimestamp:this.lastFlushTimestamp,pendingUpdates:this.pendingUpdates.size}}forceFlush(){this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.flushUpdates()}destroy(){if(this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.activeTimeouts.forEach(t=>{clearTimeout(t)}),this.activeTimeouts.clear(),this.domObservationRetryTimeout&&(clearTimeout(this.domObservationRetryTimeout),this.domObservationRetryTimeout=null),this.observationThrottleTimer&&(clearTimeout(this.observationThrottleTimer),this.observationThrottleTimer=null),this.domObserver&&(this.domObserver.disconnect(),this.domObserver=null),this.visibilityObserver&&(this.visibilityObserver.disconnect(),this.visibilityObserver=null),this.musicChangeUnsubscribe&&(this.musicChangeUnsubscribe(),this.musicChangeUnsubscribe=null),this.pendingUpdates.clear(),this.isFlushScheduled=!1,this.sidebarElement=null,De.instance===this&&(De.instance=null),this.config.enableDebug){let t=this.flushCount>0?this.totalFlushTime/this.flushCount:0;console.log(`\u{1F30C} [SidebarPerformanceManager] Destroyed. Performance: ${this.flushCount} flushes, ${t.toFixed(2)}ms avg`)}}};De.instance=null;Ne=De;Ul=Ne});var Ht,Ps=v(()=>{"use strict";fa();Ta();B();Ht=class extends Gt{constructor(e=w){super(e);this.sidebarSystems=new Map;this.integrationEnabled=!1;this.lastFrameTime=0;this.sharedCoordinator=Ne.getInstance({enableDebug:e.enableDebug,performanceAnalyzer:null,onFlushComplete:()=>this.handlePerformanceFlush()}),this.performanceMetrics={totalSystems:4,activeSystems:0,bilateralSyncEnabled:!1,averageFrameTime:0,totalMemoryUsage:0,healthStatus:"healthy"},e.enableDebug&&console.log(`[${this.systemName}] Initialized sidebar systems integration`)}async _performSystemSpecificInitialization(){this.config.enableDebug&&console.log(`[${this.systemName}] Initializing sidebar systems integration`);try{this.registerSidebarSystems(),await this.registerWithUnifiedRegistry(),await this.initializeSystemsInOrder(),this.setupBilateralCoordination(),this.connectToEventBus(),this.integrateWithPerformanceSystems(),this.integrationEnabled=!0,this.updatePerformanceMetrics(),this.publishEvent("sidebar:integration-ready",{systemName:this.systemName,totalSystems:this.sidebarSystems.size,activeSystems:this.performanceMetrics.activeSystems,bilateralSync:this.performanceMetrics.bilateralSyncEnabled,timestamp:Date.now()})}catch(e){throw console.error(`[${this.systemName}] Integration initialization failed:`,e),e}}registerSidebarSystems(){this.consolidatedSidebarSystem&&this.sidebarSystems.set("consolidatedSidebarSystem",{name:"consolidatedSidebarSystem",system:this.consolidatedSidebarSystem,priority:"critical",enabled:!0,dependencies:[]})}async initializeSystemsInOrder(){let e=this.calculateInitializationOrder();for(let i of e){let r=this.sidebarSystems.get(i);if(r&&r.enabled)try{await r.system.initialize(),this.performanceMetrics.activeSystems++,this.config.enableDebug&&console.log(`[${this.systemName}] Initialized ${i}`)}catch(a){console.error(`[${this.systemName}] Failed to initialize ${i}:`,a)}}}calculateInitializationOrder(){let e=new Set,i=new Set,r=[],a=n=>{if(i.has(n))throw new Error(`Circular dependency detected: ${n}`);if(e.has(n))return;i.add(n);let s=this.sidebarSystems.get(n);if(s&&s.dependencies)for(let l of s.dependencies)a(l);i.delete(n),e.add(n),r.push(n)};for(let n of this.sidebarSystems.keys())a(n);return r}setupBilateralCoordination(){this.performanceMetrics.bilateralSyncEnabled=!0,this.subscribeToEvent("sidebar:bilateral-sync",e=>{this.handleBilateralSync(e)}),this.subscribeToEvent("sidebar:visual-level-changed",e=>{this.handleVisualLevelChange(e)})}handleBilateralSync(e){e.source==="orchestrator"&&this.updatePerformanceMetrics()}handleVisualLevelChange(e){let r={dormant:.5,aware:.7,focused:.9,advanced:1}[e.newLevel]||.7;this.adjustPerformanceBudgets(r)}adjustPerformanceBudgets(e){let r=Math.floor(16*e);this.config.enableDebug&&console.log(`[${this.systemName}] Adjusted performance budget to ${r} based on visual intensity level`)}handlePerformanceFlush(){let e=performance.now();if(this.lastFrameTime>0){let i=e-this.lastFrameTime;this.performanceMetrics.averageFrameTime=(this.performanceMetrics.averageFrameTime+i)/2}this.lastFrameTime=e,this.updateHealthStatus()}updatePerformanceMetrics(){this.performanceMetrics.totalSystems=this.sidebarSystems.size;let e=0;for(let[,i]of this.sidebarSystems)i.enabled&&i.system.initialized&&e++;this.performanceMetrics.activeSystems=e}updateHealthStatus(){this.performanceMetrics.averageFrameTime>20?this.performanceMetrics.healthStatus="critical":this.performanceMetrics.averageFrameTime>16.67?this.performanceMetrics.healthStatus="degraded":this.performanceMetrics.healthStatus="healthy"}updateAnimation(e){if(!this.integrationEnabled)return;this.updatePerformanceMetrics(),this.updateHealthStatus(),performance.now()-this.lastFrameTime>1e3&&this.publishEvent("sidebar:integration-metrics",{metrics:this.performanceMetrics,timestamp:Date.now()})}onAnimate(e){this.updateAnimation(e)}registerWithAnimationCoordinator(e){if(!e){console.warn(`[${this.systemName}] Animation coordinator not available`);return}for(let[i,r]of this.sidebarSystems)if(r.enabled&&r.system.initialized)try{e.registerAnimationSystem(i,r.system,r.priority,60),this.config.enableDebug&&console.log(`[${this.systemName}] Registered ${i} with animation coordinator`)}catch(a){console.error(`[${this.systemName}] Failed to register ${i}:`,a)}}getSidebarSystems(){return new Map(this.sidebarSystems)}getPerformanceMetrics(){return{...this.performanceMetrics}}setSidebarSystemEnabled(e,i){let r=this.sidebarSystems.get(e);r&&(r.enabled=i,!i&&r.system.initialized?(r.system.destroy(),this.performanceMetrics.activeSystems--):i&&!r.system.initialized&&r.system.initialize().catch(a=>{console.error(`[${this.systemName}] Failed to re-enable ${e}:`,a)}),this.publishEvent("sidebar:system-toggled",{systemName:e,enabled:i,timestamp:Date.now()}))}async performSystemHealthCheck(){let e={};for(let[a,n]of this.sidebarSystems)if(n.enabled&&n.system.initialized)try{e[a]=await n.system.healthCheck()}catch(s){e[a]={healthy:!1,ok:!1,details:`Health check failed: ${s.message}`,issues:[`Health check failed: ${s.message}`],system:a}}let i=Object.values(e).filter(a=>!a.ok),r=i.length===0;return{healthy:r,details:`Sidebar integration ${r?"healthy":"degraded"} - ${this.performanceMetrics.activeSystems}/${this.performanceMetrics.totalSystems} systems active, bilateral sync: ${this.performanceMetrics.bilateralSyncEnabled}`,issues:i.map(a=>a.details||"Unknown issue"),metrics:{activeSystems:this.performanceMetrics.activeSystems,totalSystems:this.performanceMetrics.totalSystems,bilateralSyncEnabled:this.performanceMetrics.bilateralSyncEnabled,healthStatus:this.performanceMetrics.healthStatus}}}async registerWithUnifiedRegistry(){this.config.enableDebug&&console.log(`[${this.systemName}] Sidebar systems are now managed by VisualSystemFacade`)}connectToEventBus(){this.subscribeToEvent("music:beat",e=>{this.handleMusicBeat(e)}),this.subscribeToEvent("music:energy",e=>{this.handleMusicEnergy(e)}),this.subscribeToEvent("performance:threshold-exceeded",e=>{this.handlePerformanceThreshold(e)}),this.subscribeToEvent("user:navigation",e=>{this.handleUserNavigation(e)}),this.config.enableDebug&&console.log(`[${this.systemName}] Connected to EventBus for system-wide communication`)}integrateWithPerformanceSystems(){let e=globalThis.year3000System;if(!e){this.config.enableDebug&&console.log(`[${this.systemName}] Year3000System not available, skipping performance integration`);return}try{let i=e.timerConsolidationSystem;i&&(i.registerTimer("sidebar-performance-monitor",1e3,()=>{this.updatePerformanceMetrics()}),this.config.enableDebug&&console.log(`[${this.systemName}] Integrated with TimerConsolidationSystem`));let r=e.enhancedMasterAnimationCoordinator;r&&(r.registerFrameCallback((a,n)=>{this.bilateralVisualEffectsFrameUpdate(a,n)},"critical","sidebar-bilateral-visual-effects"),this.config.enableDebug&&console.log(`[${this.systemName}] Integrated with AnimationFrameCoordinator`))}catch(i){console.error(`[${this.systemName}] Failed to integrate with performance systems:`,i)}}handleMusicBeat(e){if(!this.integrationEnabled)return;let i={intensity:e.intensity||.5,timestamp:e.timestamp||Date.now(),bpm:e.bpm||120};this.config.enableDebug&&console.log(`[${this.systemName}] Processed music beat:`,i)}handleMusicEnergy(e){if(!this.integrationEnabled)return;let i=e.energy||.5;this.adjustPerformanceBudgets(.5+i*.5),this.consolidatedSidebarSystem?.initialized&&this.config.enableDebug&&console.log(`[${this.systemName}] Adapted visual effects to energy level: ${i}`)}handlePerformanceThreshold(e){this.integrationEnabled&&(e.severity==="critical"?(this.performanceMetrics.healthStatus="critical",this.config.enableDebug&&console.warn(`[${this.systemName}] Activated emergency performance mode`)):e.severity==="warning"&&this.performanceMetrics.healthStatus==="critical"&&(this.performanceMetrics.healthStatus="degraded"))}handleUserNavigation(e){if(!this.integrationEnabled)return;let i={action:e.action||"navigate",target:e.target||"unknown",timestamp:e.timestamp||Date.now()};this.config.enableDebug&&console.log(`[${this.systemName}] Processing navigation context:`,i)}bilateralVisualEffectsFrameUpdate(e,i){if(!this.integrationEnabled)return;let r={frameTime:e,timestamp:i};e>16.67&&this.publishEvent("sidebar:frame-time-warning",{frameTime:e,timestamp:i})}_performSystemSpecificCleanup(){this.config.enableDebug&&console.log(`[${this.systemName}] Destroying sidebar systems integration`),this.integrationEnabled=!1;let e=globalThis.year3000System;e?.timerConsolidationSystem&&e.timerConsolidationSystem.unregisterTimer("sidebar-performance-monitor");let i=this.calculateInitializationOrder().reverse();for(let r of i){let a=this.sidebarSystems.get(r);if(a&&a.system.initialized)try{a.system.destroy(),this.config.enableDebug&&console.log(`[${this.systemName}] Destroyed ${r}`)}catch(n){console.error(`[${this.systemName}] Failed to destroy ${r}:`,n)}}this.sidebarSystems.clear(),this.performanceMetrics={totalSystems:0,activeSystems:0,bilateralSyncEnabled:!1,averageFrameTime:0,totalMemoryUsage:0,healthStatus:"healthy"},this.publishEvent("sidebar:integration-destroyed",{timestamp:Date.now()})}}});var zt,As=v(()=>{"use strict";R();wr();$();Yn();ta();jn();fi();ia();pe();ea();ra();Zr();Jr();R();Qn();ba();Qr();Sa();vs();Es();ws();Ps();zt=class{constructor(t,e,i){this.cssVariableManager=null;this.musicSyncService=null;this.loadingStateService=null;this.simplePerformanceCoordinator=null;this.webglSystemsIntegration=null;this.enhancedDeviceTierDetector=null;this.performanceAnalyzer=null;this.performanceCoordinator=null;this.performanceOrchestrator=null;this.isInitialized=!1;this.lastHealthCheck=null;this.healthCheckInterval=null;this.metricsUpdateInterval=null;this.onSystemCreated=null;this.onSystemFailed=null;this.onHealthChange=null;this.config=t,this.utils=e,this.year3000System=i,i&&typeof i=="object"&&"performanceAnalyzer"in i&&(this.performanceAnalyzer=i.performanceAnalyzer||null,this.cssVariableManager=i.unifiedCSSConsciousnessController||null,this.performanceCoordinator=i.unifiedPerformanceCoordinator||null,this.performanceOrchestrator=i.performanceOrchestrator||null,this.musicSyncService=i.musicSyncService||null,u?.debug?.log("InfrastructureSystemCoordinator","Shared dependencies injected from SystemCoordinator",{performanceAnalyzer:!!this.performanceAnalyzer,cssVariableManager:!!this.cssVariableManager,performanceOrchestrator:!!this.performanceOrchestrator,musicSyncService:!!this.musicSyncService})),this.systemRegistry=new Map,this.systemCache=new Map,this.systemDependencies=new Map,this.facadeConfig={mode:"progressive",enablePerformanceMonitoring:!0,enableDependencyInjection:!0,enableSystemHealthMonitoring:!0,performanceThresholds:{maxInitTime:5e3,maxMemoryMB:100,maxCPUPercent:15},systemPreferences:{lazyInitialization:!0,aggressiveCaching:!0,performanceOptimization:!0}},this.currentMetrics=this.createInitialMetrics(),this.registerNonVisualSystems(),u?.debug?.log("InfrastructureSystemCoordinator","Non-visual systems facade initialized")}registerNonVisualSystems(){this.systemRegistry.set("AnimationFrameCoordinator",ut),this.systemDependencies.set("AnimationFrameCoordinator",["performanceAnalyzer","cssVariableManager"]),this.systemRegistry.set("TimerConsolidationSystem",pi),this.systemDependencies.set("TimerConsolidationSystem",["performanceAnalyzer"]),this.systemRegistry.set("CSSVariableWriter",Pe),this.systemDependencies.set("CSSVariableWriter",["performanceCoordinator"]),this.systemRegistry.set("OptimizedCSSVariableManager",Pe),this.systemDependencies.set("OptimizedCSSVariableManager",["performanceCoordinator"]),this.systemRegistry.set("PerformanceAnalyzer",et),this.systemDependencies.set("PerformanceAnalyzer",[]),this.systemRegistry.set("DeviceCapabilityDetector",W),this.systemDependencies.set("DeviceCapabilityDetector",[]),this.systemRegistry.set("PerformanceAnalyzer",Se),this.systemDependencies.set("PerformanceAnalyzer",[]),this.systemRegistry.set("CSSVariableBatcher",Pe),this.systemDependencies.set("CSSVariableBatcher",[]),this.systemRegistry.set("SystemHealthMonitor",Se),this.systemDependencies.set("SystemHealthMonitor",[]),this.systemRegistry.set("UnifiedSystemIntegration",Ht),this.systemDependencies.set("UnifiedSystemIntegration",[]),this.systemRegistry.set("PerformanceBudgetManager",gt),this.systemDependencies.set("PerformanceBudgetManager",["performanceAnalyzer"]),this.systemRegistry.set("SimplePerformanceCoordinator",Se),this.systemDependencies.set("SimplePerformanceCoordinator",["performanceAnalyzer","performanceCoordinator","deviceCapabilityDetector","performanceBudgetManager"]),this.systemRegistry.set("SimplePerformanceCoordinator",Se),this.systemDependencies.set("SimplePerformanceCoordinator",["enhancedDeviceTierDetector","webglSystemsIntegration"]),this.systemRegistry.set("SimpleTierBasedPerformanceSystem",bi),this.systemDependencies.set("SimpleTierBasedPerformanceSystem",["enhancedDeviceTierDetector"]),this.systemRegistry.set("EnhancedDeviceTierDetector",fe),this.systemDependencies.set("EnhancedDeviceTierDetector",[]),this.systemRegistry.set("WebGLSystemsIntegration",tt),this.systemDependencies.set("WebGLSystemsIntegration",["deviceCapabilityDetector"]),this.systemDependencies.set("UnifiedDebugManager",[]),this.systemRegistry.set("ColorHarmonyEngine",gi),this.systemDependencies.set("ColorHarmonyEngine",["musicSyncService"]),this.systemRegistry.set("MusicSyncService",Je),this.systemDependencies.set("MusicSyncService",[]),this.systemRegistry.set("LoadingStateService",vi),this.systemDependencies.set("LoadingStateService",["performanceAnalyzer"]),this.systemRegistry.set("ColorProcessor",st),this.systemDependencies.set("ColorProcessor",["performanceAnalyzer"]),this.systemRegistry.set("UnifiedColorProcessingEngine",st),this.systemDependencies.set("UnifiedColorProcessingEngine",["performanceAnalyzer"]),this.systemDependencies.set("ColorOrchestrator",[]),this.systemRegistry.set("MusicEmotionAnalyzer",dt),this.systemDependencies.set("MusicEmotionAnalyzer",["musicSyncService","settingsManager"]),this.systemRegistry.set("VisualEffectsCoordinator",rt),this.systemDependencies.set("VisualEffectsCoordinator",["settingsManager"]),this.systemRegistry.set("GlassmorphismManager",Gi),this.systemDependencies.set("GlassmorphismManager",["cssVariableManager","performanceAnalyzer","settingsManager"]),this.systemRegistry.set("Card3DManager",Vi),this.systemDependencies.set("Card3DManager",["performanceAnalyzer","settingsManager"]),this.systemRegistry.set("GenreUIBridge",_i),this.systemDependencies.set("GenreUIBridge",["GenreProfileManager","MusicSyncService"]),this.systemRegistry.set("SidebarSystemsIntegration",Ht),this.systemDependencies.set("SidebarSystemsIntegration",["cssVariableManager"])}async initialize(t){if(this.isInitialized){u?.debug?.warn("InfrastructureSystemCoordinator","Already initialized");return}try{let e=performance.now();this.facadeConfig={...this.facadeConfig,...t},await this.initializeSharedDependencies(),await this.applyConfiguration(),this.startMonitoring(),await this.performHealthCheck();let i=performance.now();this.currentMetrics.systemInitializationTime=i-e,this.isInitialized=!0,u?.debug?.log("InfrastructureSystemCoordinator","Non-visual systems facade fully initialized",{mode:this.facadeConfig.mode,systemsRegistered:this.systemRegistry.size,initTime:this.currentMetrics.systemInitializationTime})}catch(e){throw u?.debug?.error("InfrastructureSystemCoordinator","Initialization failed:",e),await this.cleanup(),e}}async initializeSharedDependencies(){let t=["DeviceCapabilityDetector","EnhancedDeviceTierDetector","WebGLSystemsIntegration","SimplePerformanceCoordinator","PerformanceAnalyzer","OptimizedCSSVariableManager","UnifiedDebugManager","MusicSyncService","LoadingStateService"];for(let e of t)try{let i=await this.getSystem(e);switch(i&&typeof i.initialize=="function"&&await i.initialize(),e){case"DeviceCapabilityDetector":this.year3000System&&(this.year3000System.deviceCapabilityDetector=i);break;case"EnhancedDeviceTierDetector":this.enhancedDeviceTierDetector=i;break;case"WebGLSystemsIntegration":this.webglSystemsIntegration=i;break;case"SimplePerformanceCoordinator":this.simplePerformanceCoordinator=i,this.performanceOrchestrator=i;break;case"PerformanceAnalyzer":this.performanceAnalyzer=i,this.performanceCoordinator=i;break;case"OptimizedCSSVariableManager":this.cssVariableManager=i;break;case"UnifiedDebugManager":break;case"MusicSyncService":this.musicSyncService=i;break;case"LoadingStateService":this.loadingStateService=i;break}}catch(i){u?.debug?.error("InfrastructureSystemCoordinator",`Failed to initialize ${e}:`,i)}}getCachedSystemSync(t){return this.systemCache.get(t)||null}async getSystem(t,e){let i=e?.cacheOnly??!1;if(this.systemCache.has(t))return this.systemCache.get(t);if(t==="DeviceCapabilityDetector"&&this.year3000System?.deviceCapabilityDetector){let a=this.year3000System.deviceCapabilityDetector;return this.systemCache.set(t,a),u?.debug?.log("InfrastructureSystemCoordinator","Using shared DeviceCapabilityDetector instance from SystemCoordinator"),a}if(t==="EnhancedDeviceTierDetector"&&this.enhancedDeviceTierDetector)return this.systemCache.set(t,this.enhancedDeviceTierDetector),u?.debug?.log("InfrastructureSystemCoordinator","Using shared EnhancedDeviceTierDetector instance from SystemCoordinator"),this.enhancedDeviceTierDetector;if(t==="WebGLSystemsIntegration"&&this.webglSystemsIntegration)return this.systemCache.set(t,this.webglSystemsIntegration),u?.debug?.log("InfrastructureSystemCoordinator","Using shared WebGLSystemsIntegration instance from SystemCoordinator"),this.webglSystemsIntegration;if(t==="SimplePerformanceCoordinator"&&this.simplePerformanceCoordinator)return this.systemCache.set(t,this.simplePerformanceCoordinator),u?.debug?.log("InfrastructureSystemCoordinator","Using shared SimplePerformanceCoordinator instance from SystemCoordinator"),this.simplePerformanceCoordinator;if(t==="PerformanceAnalyzer"&&this.performanceAnalyzer)return this.systemCache.set(t,this.performanceAnalyzer),u?.debug?.log("InfrastructureSystemCoordinator","Using shared PerformanceAnalyzer instance from SystemCoordinator"),this.performanceAnalyzer;if((t==="OptimizedCSSVariableManager"||t==="CSSVariableWriter")&&this.cssVariableManager)return this.systemCache.set(t,this.cssVariableManager),u?.debug?.log("InfrastructureSystemCoordinator",`Using shared CSSVariableWriter instance from SystemCoordinator (requested as ${t})`),this.cssVariableManager;if(t==="SimplePerformanceCoordinator"&&this.performanceOrchestrator)return this.systemCache.set(t,this.performanceOrchestrator),u?.debug?.log("InfrastructureSystemCoordinator","Using shared SimplePerformanceCoordinator instance from SystemCoordinator"),this.performanceOrchestrator;if(t==="MusicSyncService"&&this.musicSyncService)return this.systemCache.set(t,this.musicSyncService),u?.debug?.log("InfrastructureSystemCoordinator","Using shared MusicSyncService instance from SystemCoordinator"),this.musicSyncService;if(t==="LoadingStateService"&&this.loadingStateService)return this.systemCache.set(t,this.loadingStateService),u?.debug?.log("InfrastructureSystemCoordinator","Using shared LoadingStateService instance"),this.loadingStateService;if(i)return null;let r=await this.createSystem(t);return this.systemCache.set(t,r),this.currentMetrics.activeSystems.push(t),this.currentMetrics.initializedSystems++,this.onSystemCreated&&this.onSystemCreated(t,r),r}async createSystem(t){let e=performance.now();try{if(t==="UnifiedDebugManager"){let s=rn.getInstance();this.injectDependencies(s,t),this.integratePerformanceMonitoring(s,t);let l=performance.now();return this.currentMetrics.dependencyResolutionTime+=l-e,s}if(t==="ColorOrchestrator"){let s=ki;this.injectDependencies(s,t),this.integratePerformanceMonitoring(s,t);let l=performance.now();return this.currentMetrics.dependencyResolutionTime+=l-e,s}let i=this.systemRegistry.get(t);if(!i)throw new Error(`Non-visual system '${t}' not found in registry`);let r=this.buildSharedDependencies(),a=this.createSystemDirectly(t,i,r);this.injectDependencies(a,t),this.integratePerformanceMonitoring(a,t);let n=performance.now();return this.currentMetrics.dependencyResolutionTime+=n-e,u?.debug?.log("InfrastructureSystemCoordinator",`Created ${t} via direct construction`,{totalTime:n-e}),a}catch(i){throw this.currentMetrics.failedSystems++,this.currentMetrics.failedSystemsList.push(t),this.currentMetrics.systemErrors++,this.onSystemFailed&&this.onSystemFailed(t,i),u?.debug?.error("InfrastructureSystemCoordinator",`Failed to create system ${t}:`,i),i}}buildSharedDependencies(){let t={year3000System:this.year3000System};if(this.year3000System&&typeof this.year3000System.getSharedDependency=="function"){let e=this.year3000System,i=e.getSharedDependency("performanceCoordinator");i&&(t.performanceCoordinator=i,t.performanceAnalyzer=i,t.simplePerformanceCoordinator=i,t.performanceOrchestrator=i);let r=e.getSharedDependency("cssVariableManager");r&&(t.cssVariableManager=r,t.cssVariableController=r,t.cssConsciousnessController=r);let a=e.getSharedDependency("deviceCapabilityDetector");a&&(t.deviceCapabilityDetector=a);let n=e.getSharedDependency("enhancedDeviceTierDetector");n&&(t.enhancedDeviceTierDetector=n);let s=e.getSharedDependency("webglSystemsIntegration");s&&(t.webglSystemsIntegration=s);let l=e.getSharedDependency("musicSyncService");l&&(t.musicSyncService=l)}else this.performanceCoordinator&&(t.performanceCoordinator=this.performanceCoordinator),this.performanceAnalyzer&&(t.performanceAnalyzer=this.performanceAnalyzer),this.simplePerformanceCoordinator&&(t.simplePerformanceCoordinator=this.simplePerformanceCoordinator),this.performanceOrchestrator&&(t.performanceOrchestrator=this.performanceOrchestrator),this.year3000System?.deviceCapabilityDetector&&(t.deviceCapabilityDetector=this.year3000System.deviceCapabilityDetector),this.enhancedDeviceTierDetector&&(t.enhancedDeviceTierDetector=this.enhancedDeviceTierDetector),this.webglSystemsIntegration&&(t.webglSystemsIntegration=this.webglSystemsIntegration),this.cssVariableManager&&(t.cssVariableManager=this.cssVariableManager,t.cssVariableController=this.cssVariableManager,t.cssConsciousnessController=this.cssVariableManager),this.musicSyncService&&(t.musicSyncService=this.musicSyncService);return t}createSystemDirectly(t,e,i){switch(t){case"DeviceCapabilityDetector":case"PerformanceAnalyzer":case"TimerConsolidationSystem":return new e;case"SidebarSystemsIntegration":return new e(i.cssConsciousnessController||i.cssVariableManager);case"CSSVariableWriter":case"OptimizedCSSVariableManager":return new e(this.config,i.performanceCoordinator||i.performanceAnalyzer);case"ColorHarmonyEngine":return new e(this.config,this.utils,i.performanceAnalyzer||i.performanceCoordinator,void 0);case"AnimationFrameCoordinator":return new e(this.config,i.performanceCoordinator||i.performanceAnalyzer);case"UnifiedPerformanceCoordinator":return new e(this.config,i.performanceAnalyzer||i.performanceCoordinator);case"GlassmorphismManager":return new e(this.config,this.utils,i.cssConsciousnessController||i.cssVariableManager,i.performanceAnalyzer||i.performanceCoordinator,void 0);case"Card3DManager":return new e(i.performanceAnalyzer||i.performanceCoordinator,void 0,this.utils);case"MusicSyncService":return new e({ADVANCED_SYSTEM_CONFIG:this.config,ThemeUtilities:this.utils,settingsManager:void 0,year3000System:this.year3000System});case"EnhancedDeviceTierDetector":return e;case"WebGLSystemsIntegration":if(!i.deviceCapabilityDetector)throw new Error("WebGLSystemsIntegration requires DeviceCapabilityDetector");return new e(i.deviceCapabilityDetector);case"SimplePerformanceCoordinator":if(!i.enhancedDeviceTierDetector||!i.webglSystemsIntegration)throw new Error("SimplePerformanceCoordinator requires EnhancedDeviceTierDetector and WebGLSystemsIntegration");return new e(i.enhancedDeviceTierDetector,i.webglSystemsIntegration);case"SimpleTierBasedPerformanceSystem":if(!i.enhancedDeviceTierDetector)throw new Error("SimpleTierBasedPerformanceSystem requires EnhancedDeviceTierDetector");return new e(i.enhancedDeviceTierDetector);default:try{return new e}catch{return u?.debug?.warn("InfrastructureSystemCoordinator",`Using fallback constructor pattern for ${t}`),new e(this.config,this.utils,i.performanceAnalyzer||i.performanceCoordinator,void 0)}}}injectDependencies(t,e){if(!this.facadeConfig.enableDependencyInjection)return;let i=this.systemDependencies.get(e)||[];i.includes("performanceAnalyzer")&&this.performanceAnalyzer&&t.setPerformanceAnalyzer&&t.setPerformanceAnalyzer(this.performanceAnalyzer),i.includes("cssVariableManager")&&this.cssVariableManager&&t.setCSSVariableManager&&t.setCSSVariableManager(this.cssVariableManager),i.includes("cssConsciousnessController")&&this.cssVariableManager&&t.setCSSConsciousnessController&&t.setCSSConsciousnessController(this.cssVariableManager),i.includes("musicSyncService")&&this.musicSyncService&&t.setMusicSyncService&&t.setMusicSyncService(this.musicSyncService),i.includes("year3000System")&&t.setYear3000System&&t.setYear3000System(this.year3000System),i.includes("performanceOrchestrator")&&this.performanceOrchestrator&&t.setSimplePerformanceCoordinator&&t.setSimplePerformanceCoordinator(this.performanceOrchestrator)}integratePerformanceMonitoring(t,e){if(!this.facadeConfig.enablePerformanceMonitoring||!this.performanceAnalyzer||!t.enablePerformanceMonitoring)return;let i=t.initialize;typeof i=="function"&&(t.initialize=async(...a)=>{let n=performance.now(),s=await i.call(t,...a),l=performance.now();return this.performanceAnalyzer?.recordMetric(`NonVisual_${e}_Initialize`,l-n),s});let r=t.updateAnimation;typeof r=="function"&&(t.updateAnimation=a=>{let n=performance.now();r.call(t,a);let s=performance.now();this.performanceAnalyzer?.recordMetric(`NonVisual_${e}_Animation`,s-n)})}async initializeAllSystems(){let t=Array.from(this.systemCache.entries()).map(async([r,a])=>{try{return a&&typeof a.initialize=="function"&&await a.initialize(),u?.debug?.log("InfrastructureSystemCoordinator",`Initialized system: ${r}`),{key:r,success:!0}}catch(n){return u?.debug?.error("InfrastructureSystemCoordinator",`Failed to initialize ${r}:`,n),{key:r,success:!1,error:n}}}),e=await Promise.allSettled(t),i=e.filter(r=>r.status==="fulfilled"&&r.value.success).length;u?.debug?.log("InfrastructureSystemCoordinator",`Non-visual systems initialized: ${i}/${e.length}`)}async performHealthCheck(){let t={overall:"good",systems:new Map,recommendations:[],timestamp:performance.now(),metrics:{...this.currentMetrics}},e=0,i=0;for(let[a,n]of this.systemCache){i++;try{let s=n.healthCheck?await n.healthCheck():{status:"unknown",message:"No health check available"},l=s.status==="healthy"||s.status==="good";l&&e++,t.systems.set(a,{ok:l,details:s.message||s.details||"System operational"})}catch(s){t.systems.set(a,{ok:!1,details:`Health check failed: ${s}`})}}let r=i>0?e/i:1;return r>=.9?t.overall="excellent":r>=.7?t.overall="good":r>=.5?(t.overall="degraded",t.recommendations.push("Some non-visual systems are experiencing issues")):(t.overall="critical",t.recommendations.push("Multiple non-visual system failures detected")),this.currentMetrics.systemInitializationTime>3e3&&t.recommendations.push("High initialization time - consider optimizing system startup"),this.currentMetrics.memoryUsageMB>80&&t.recommendations.push("High memory usage - consider optimizing system memory usage"),this.lastHealthCheck=t,this.currentMetrics.lastHealthCheckTime=performance.now(),this.onHealthChange&&this.onHealthChange(t),t}createInitialMetrics(){return{systemCount:this.systemRegistry.size,initializedSystems:0,failedSystems:0,totalInitTime:0,averageInitTime:0,memoryUsageMB:0,systemHealth:"good",activeSystems:[],failedSystemsList:[],dependencyInjection:this.facadeConfig.enableDependencyInjection,performanceMonitoring:this.facadeConfig.enablePerformanceMonitoring,healthMonitoring:this.facadeConfig.enableSystemHealthMonitoring,systemInitializationTime:0,dependencyResolutionTime:0,lastHealthCheckTime:0,systemErrors:0}}async applyConfiguration(){switch(this.facadeConfig.mode){case"performance-first":this.facadeConfig.systemPreferences.lazyInitialization=!0,this.facadeConfig.systemPreferences.aggressiveCaching=!0;break;case"quality-first":this.facadeConfig.systemPreferences.lazyInitialization=!1,this.facadeConfig.systemPreferences.performanceOptimization=!0;break;case"battery-optimized":this.facadeConfig.performanceThresholds.maxCPUPercent=5,this.facadeConfig.systemPreferences.lazyInitialization=!0;break}}startMonitoring(){this.facadeConfig.enableSystemHealthMonitoring&&(this.healthCheckInterval=window.setInterval(async()=>{await this.performHealthCheck()},3e4),this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},5e3))}updateMetrics(){this.currentMetrics.systemCount=this.systemRegistry.size,this.currentMetrics.initializedSystems=this.systemCache.size,this.currentMetrics.averageInitTime=this.currentMetrics.totalInitTime/Math.max(1,this.currentMetrics.initializedSystems);let t=performance.memory;t&&(this.currentMetrics.memoryUsageMB=t.usedJSHeapSize/(1024*1024));let e=this.currentMetrics.failedSystems/Math.max(1,this.currentMetrics.systemCount);e===0?this.currentMetrics.systemHealth="excellent":e<.1?this.currentMetrics.systemHealth="good":e<.3?this.currentMetrics.systemHealth="degraded":this.currentMetrics.systemHealth="critical"}async cleanup(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this.cssVariableManager=null,this.performanceAnalyzer=null,this.performanceOrchestrator=null,this.musicSyncService=null}getMetrics(){return{...this.currentMetrics}}getLastHealthCheck(){return this.lastHealthCheck}getConfiguration(){return{...this.facadeConfig}}async setConfiguration(t){this.facadeConfig={...this.facadeConfig,...t},await this.applyConfiguration()}setOnSystemCreated(t){this.onSystemCreated=t}setOnSystemFailed(t){this.onSystemFailed=t}setOnHealthChange(t){this.onHealthChange=t}getSystemStatus(){return{initialized:this.isInitialized,systemsActive:this.systemCache.size,healthy:this.currentMetrics.systemHealth==="excellent"||this.currentMetrics.systemHealth==="good"}}async destroy(){await this.cleanup(),this.isInitialized=!1,this.systemCache.clear(),u?.debug?.log("InfrastructureSystemCoordinator","Non-visual systems facade destroyed")}}});var Ot,Is=v(()=>{"use strict";Zr();Jr();$();As();ta();fi();ia();pe();R();$r();ba();Ot=class{constructor(t,e,i){this.visualSystemCoordinator=null;this.infrastructureSystemFacade=null;this.sharedCSSVariableWriter=null;this.performanceCoordinator=null;this.sharedWebGLSystemsIntegration=null;this.sharedEnhancedDeviceTierDetector=null;this.deviceDetector=null;this.sharedMusicSyncService=null;this.sharedColorHarmonyEngine=null;this.sharedColorProcessor=null;this.sharedSpicetifyColorBridge=null;this.isInitialized=!1;this.lastHealthCheck=null;this.colorDependentSystems=new Set;this.colorSystemRefreshCallbacks=new Map;this.currentPhase="core";this.systemStates=new Map;this.phaseCompletionPromises=new Map;this.systemDependencies=new Map;this.initializationOrder=new Map;this.eventBus=null;this.crossFacadeEventListeners=new Map;this.healthCheckInterval=null;this.metricsUpdateInterval=null;this.onSystemCreated=null;this.onHealthChange=null;this.onPerformanceChange=null;this.config=t,this.utils=e,this.year3000System=i,this.coordinationConfig={mode:"unified",enableSharedDependencies:!0,enableCrossFacadeCommunication:!0,enableUnifiedPerformanceMonitoring:!0,enableResourceOptimization:!0,coordination:{enforceSequentialInitialization:!0,dependencyValidation:!0,enableInitializationGates:!0,systemReadinessTimeout:1e4,phaseTransitionTimeout:15e3},performanceThresholds:{maxTotalMemoryMB:150,maxTotalInitTime:8e3,maxCrossCommLatency:10},coordinationPreferences:{preferSharedResources:!0,enableEventPropagation:!0,enableHealthCoordination:!0}},this.setupCoordinationPhases(),this.currentMetrics=this.createInitialMetrics(),u?.debug?.log("SystemIntegrationCoordinator","System coordinator initialized")}async initialize(t){if(this.isInitialized){u?.debug?.warn("SystemIntegrationCoordinator","Already initialized");return}try{let e=performance.now();this.coordinationConfig={...this.coordinationConfig,...t},this.coordinationConfig.coordination.enforceSequentialInitialization?(u?.debug?.log("SystemIntegrationCoordinator","Starting coordinated initialization"),await this.executeCoordinatedInitialization()):(u?.debug?.log("SystemIntegrationCoordinator","Starting legacy initialization"),await this.executeLegacyInitialization());let i=performance.now();this.currentMetrics.totalInitTime=i-e,this.isInitialized=!0,u?.debug?.log("SystemIntegrationCoordinator","System coordination fully initialized",{mode:this.coordinationConfig.mode,coordinationEnabled:this.coordinationConfig.coordination.enforceSequentialInitialization,currentPhase:this.currentPhase,visualSystems:this.currentMetrics.visualSystems,nonVisualSystems:this.currentMetrics.nonVisualSystems,initTime:this.currentMetrics.totalInitTime})}catch(e){throw u?.debug?.error("SystemIntegrationCoordinator","Initialization failed:",e),await this.cleanup(),e}}async initializeSharedDependencies(){if(this.coordinationConfig.enableSharedDependencies){u?.debug?.log("SystemIntegrationCoordinator","Initializing simplified shared dependencies");try{this.deviceDetector=new W({enableDebug:this.config.enableDebug||!1,runStressTests:!1}),await this.deviceDetector.initialize(),this.sharedEnhancedDeviceTierDetector=new fe,this.sharedWebGLSystemsIntegration=new tt(this.deviceDetector),await this.sharedWebGLSystemsIntegration.initialize(),this.performanceCoordinator=new Se(this.sharedEnhancedDeviceTierDetector,this.sharedWebGLSystemsIntegration),await this.performanceCoordinator.initialize();try{let t=this.performanceCoordinator;this.sharedCSSVariableWriter=new Pe(this.config,t),Rr(this.sharedCSSVariableWriter),await this.sharedCSSVariableWriter.initialize()}catch(t){u?.debug?.warn("SystemIntegrationCoordinator","Failed to initialize CSSVariableWriter:",t),this.sharedCSSVariableWriter=null}this.sharedMusicSyncService=new Je,await this.sharedMusicSyncService.initialize(),u?.debug?.log("SystemIntegrationCoordinator","Shared dependencies initialized successfully")}catch(t){throw u?.debug?.error("SystemIntegrationCoordinator","Failed to initialize shared dependencies:",t),t}}}async initializeFacades(){u?.debug?.log("SystemIntegrationCoordinator","Initializing facades");try{let t=await this.infrastructureSystemFacade?.getSystem("AnimationFrameCoordinator",{cacheOnly:!0})||null;this.visualSystemCoordinator=new rt(this.config,this.sharedCSSVariableWriter,this.performanceCoordinator,this.sharedMusicSyncService,this.sharedColorHarmonyEngine,this.utils,this.year3000System,t),await this.visualSystemCoordinator.initialize({mode:this.coordinationConfig.mode==="performance-optimized"?"performance-first":"progressive",enablePerformanceMonitoring:this.coordinationConfig.enableUnifiedPerformanceMonitoring,enableEventCoordination:this.coordinationConfig.enableCrossFacadeCommunication}),this.sharedWebGLSystemsIntegration&&this.sharedWebGLSystemsIntegration.setVisualSystemCoordinator(this.visualSystemCoordinator),this.visualSystemCoordinator.setOnSystemCreated((e,i)=>{this.handleSystemCreated("visual",e,i)}),this.infrastructureSystemFacade=new zt(this.config,this.utils,this.year3000System),await this.infrastructureSystemFacade.initialize({mode:this.coordinationConfig.mode==="performance-optimized"?"performance-first":"progressive",enablePerformanceMonitoring:this.coordinationConfig.enableUnifiedPerformanceMonitoring,enableDependencyInjection:this.coordinationConfig.enableSharedDependencies}),this.infrastructureSystemFacade.setOnSystemCreated((e,i)=>{this.handleSystemCreated("non-visual",e,i)}),this.injectSharedDependencies(),u?.debug?.log("SystemIntegrationCoordinator","Facades initialized successfully")}catch(t){throw u?.debug?.error("SystemIntegrationCoordinator","Failed to initialize facades:",t),t}}injectSharedDependencies(){!this.coordinationConfig.enableSharedDependencies||!this.infrastructureSystemFacade||(this.performanceCoordinator&&(this.infrastructureSystemFacade.simplePerformanceCoordinator=this.performanceCoordinator),this.sharedWebGLSystemsIntegration&&(this.infrastructureSystemFacade.webglSystemsIntegration=this.sharedWebGLSystemsIntegration),this.sharedEnhancedDeviceTierDetector&&(this.infrastructureSystemFacade.enhancedDeviceTierDetector=this.sharedEnhancedDeviceTierDetector),this.performanceCoordinator&&(this.infrastructureSystemFacade.performanceAnalyzer=this.performanceCoordinator),this.sharedCSSVariableWriter&&(this.infrastructureSystemFacade.cssVariableController=this.sharedCSSVariableWriter),this.sharedMusicSyncService&&(this.infrastructureSystemFacade.musicSyncService=this.sharedMusicSyncService),this.sharedColorHarmonyEngine&&(this.infrastructureSystemFacade.colorHarmonyEngine=this.sharedColorHarmonyEngine),this.sharedSpicetifyColorBridge&&(this.infrastructureSystemFacade.semanticColorManager=this.sharedSpicetifyColorBridge))}setupSystemEventBus(){this.coordinationConfig.enableCrossFacadeCommunication&&(u?.debug?.log("SystemIntegrationCoordinator","Setting up cross-facade communication"),this.addEventListener("visual-event",t=>{this.visualSystemCoordinator&&this.visualSystemCoordinator.propagateVisualEvent(t)}),this.addEventListener("performance-event",t=>{this.visualSystemCoordinator&&this.visualSystemCoordinator.handleAdaptationEvent(t)}),this.coordinationConfig.coordinationPreferences.enableHealthCoordination&&this.addEventListener("health-degradation",t=>{this.handleHealthDegradation(t)}))}async handleSystemCreated(t,e,i){if(t==="visual"?this.currentMetrics.visualSystems++:this.currentMetrics.nonVisualSystems++,this.currentMetrics.activeSystems++,t==="visual"&&i&&typeof i.updateAnimation=="function"){let r=await this.infrastructureSystemFacade?.getSystem("AnimationFrameCoordinator",{cacheOnly:!0});if(r){let a="normal";e==="WebGLGradientBackground"||e.includes("WebGL")?a="critical":(e.includes("Interaction")||e.includes("Tracking"))&&(a="background");try{r.registerAnimation(e,i,a),u?.debug?.log("SystemIntegrationCoordinator",`Registered ${e} with AnimationFrameCoordinator (priority: ${a})`)}catch(n){u?.debug?.warn("SystemIntegrationCoordinator",`Failed to register ${e} with animation coordinator:`,n)}}else u?.debug?.warn("SystemIntegrationCoordinator",`Animation coordinator not available for ${e} registration`)}this.onSystemCreated&&this.onSystemCreated(t,e,i),u?.debug?.log("SystemIntegrationCoordinator",`System created: ${t}/${e}`)}handleHealthDegradation(t){u?.debug?.warn("SystemIntegrationCoordinator","Health degradation detected:",t),this.coordinationConfig.mode==="performance-optimized"&&this.applyPerformanceOptimizations()}applyPerformanceOptimizations(){this.visualSystemCoordinator&&this.visualSystemCoordinator.setConfiguration({mode:"performance-first",enableAdaptiveQuality:!0,qualityPreferences:{preferHighQuality:!1,allowDynamicScaling:!0,batteryConservation:!0}}),this.infrastructureSystemFacade&&this.infrastructureSystemFacade.setConfiguration({mode:"performance-first",systemPreferences:{lazyInitialization:!0,aggressiveCaching:!0,performanceOptimization:!0}})}getVisualSystem(t){return this.visualSystemCoordinator?this.visualSystemCoordinator.getCachedVisualSystem(t):null}getCachedNonVisualSystem(t){return this.infrastructureSystemFacade?this.infrastructureSystemFacade.getCachedSystemSync(t):null}async getNonVisualSystem(t){return this.infrastructureSystemFacade?await this.infrastructureSystemFacade.getSystem(t):null}async getSystem(t){if(this.visualSystemCoordinator)try{return await this.visualSystemCoordinator.getVisualSystem(t)}catch{}if(this.infrastructureSystemFacade)try{return await this.infrastructureSystemFacade.getSystem(t)}catch{}return null}addEventListener(t,e){this.crossFacadeEventListeners.has(t)||this.crossFacadeEventListeners.set(t,[]),this.crossFacadeEventListeners.get(t).push(e)}removeEventListener(t,e){let i=this.crossFacadeEventListeners.get(t);if(i){let r=i.indexOf(e);r!==-1&&i.splice(r,1)}}emitEvent(t,e){let i=this.crossFacadeEventListeners.get(t);i&&i.forEach(r=>{try{r(e)}catch(a){u?.debug?.error("SystemIntegrationCoordinator",`Error in event listener for ${t}:`,a)}}),this.currentMetrics.crossFacadeEvents++}async performHealthCheck(){let t={overall:"good",facades:{visual:{ok:!0,details:"Visual systems operational",systemCount:0},nonVisual:{ok:!0,details:"Non-visual systems operational",systemCount:0}},sharedResources:{simplePerformanceCoordinator:{ok:!0,details:"Simple performance coordinator operational"},cssVariableController:{ok:!0,details:"CSS variable batcher operational"},musicSyncService:{ok:!0,details:"Music sync service operational"},performanceAnalyzer:{ok:!0,details:"Legacy performance analyzer operational"}},recommendations:[],timestamp:performance.now()};if(this.visualSystemCoordinator)try{let r=await this.visualSystemCoordinator.performVisualHealthCheck();t.facades.visual.ok=r.overall==="excellent"||r.overall==="good",t.facades.visual.details=`Visual systems: ${r.overall}`,t.facades.visual.systemCount=r.systems.size}catch(r){t.facades.visual.ok=!1,t.facades.visual.details=`Visual facade error: ${r}`}if(this.infrastructureSystemFacade)try{let r=await this.infrastructureSystemFacade.performHealthCheck();t.facades.nonVisual.ok=r.overall==="excellent"||r.overall==="good",t.facades.nonVisual.details=`Non-visual systems: ${r.overall}`,t.facades.nonVisual.systemCount=r.systems.size}catch(r){t.facades.nonVisual.ok=!1,t.facades.nonVisual.details=`Non-visual facade error: ${r}`}if(this.performanceCoordinator)try{let r=await this.performanceCoordinator.healthCheck();t.sharedResources.simplePerformanceCoordinator.ok=r.healthy,t.sharedResources.simplePerformanceCoordinator.details=r.details||"Simple performance coordinator operational"}catch(r){t.sharedResources.simplePerformanceCoordinator.ok=!1,t.sharedResources.simplePerformanceCoordinator.details=`Simple performance coordinator error: ${r}`}if(this.performanceCoordinator)try{let r=await this.performanceCoordinator.healthCheck();t.sharedResources.performanceAnalyzer={ok:r.healthy,details:r.details||"Simple performance coordinator operational"}}catch(r){t.sharedResources.performanceAnalyzer={ok:!1,details:`Simple performance coordinator error: ${r}`}}if(this.sharedCSSVariableWriter)try{let r=await this.sharedCSSVariableWriter.healthCheck();t.sharedResources.cssVariableController.ok=r.healthy||r.ok||!1,t.sharedResources.cssVariableController.details=r.details||"CSS variable controller operational"}catch(r){t.sharedResources.cssVariableController.ok=!1,t.sharedResources.cssVariableController.details=`CSS variable controller error: ${r}`}if(this.sharedMusicSyncService)try{let r=await this.sharedMusicSyncService.healthCheck();t.sharedResources.musicSyncService.ok=r.status==="healthy",t.sharedResources.musicSyncService.details=r.message||"Music sync service operational"}catch(r){t.sharedResources.musicSyncService.ok=!1,t.sharedResources.musicSyncService.details=`Music sync service error: ${r}`}if(this.sharedSpicetifyColorBridge)try{let r=await this.sharedSpicetifyColorBridge.healthCheck(),a=r.healthy;t.sharedResources.semanticColorManager={ok:a,details:r.details||"Semantic color manager operational"}}catch(r){t.sharedResources.semanticColorManager={ok:!1,details:`Semantic color manager error: ${r}`}}let e=t.facades.visual.ok&&t.facades.nonVisual.ok,i=t.sharedResources.simplePerformanceCoordinator.ok&&t.sharedResources.cssVariableController.ok&&t.sharedResources.musicSyncService.ok&&t.sharedResources.semanticColorManager?.ok!==!1&&t.sharedResources.performanceAnalyzer?.ok!==!1;return e&&i?t.overall="excellent":e||i?t.overall="good":(t.overall="critical",t.recommendations.push("Multiple system failures detected - consider system restart")),this.currentMetrics.totalMemoryMB>120&&t.recommendations.push("High memory usage - consider optimizing system memory"),this.currentMetrics.totalInitTime>6e3&&t.recommendations.push("High initialization time - consider optimizing system startup"),this.lastHealthCheck=t,this.onHealthChange&&this.onHealthChange(t),t}createInitialMetrics(){return{totalSystems:0,visualSystems:0,nonVisualSystems:0,activeSystems:0,failedSystems:0,totalMemoryMB:0,totalInitTime:0,averageSystemInitTime:0,crossFacadeLatency:0,overallHealth:"good",visualHealth:"good",nonVisualHealth:"good",sharedDependencies:6,crossFacadeEvents:0,resourceOptimization:0}}startMonitoring(){this.coordinationConfig.enableUnifiedPerformanceMonitoring&&(this.healthCheckInterval=window.setInterval(async()=>{await this.performHealthCheck()},2e4),this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},2e3))}updateMetrics(){if(this.visualSystemCoordinator){let e=this.visualSystemCoordinator.getMetrics();this.currentMetrics.visualHealth=e.systemHealth}if(this.infrastructureSystemFacade){let e=this.infrastructureSystemFacade.getMetrics();this.currentMetrics.nonVisualHealth=e.systemHealth}let t=performance.memory;t&&(this.currentMetrics.totalMemoryMB=t.usedJSHeapSize/(1024*1024)),this.currentMetrics.visualHealth==="excellent"&&this.currentMetrics.nonVisualHealth==="excellent"?this.currentMetrics.overallHealth="excellent":this.currentMetrics.visualHealth==="critical"||this.currentMetrics.nonVisualHealth==="critical"?this.currentMetrics.overallHealth="critical":this.currentMetrics.visualHealth==="degraded"||this.currentMetrics.nonVisualHealth==="degraded"?this.currentMetrics.overallHealth="degraded":this.currentMetrics.overallHealth="good",this.onPerformanceChange&&this.onPerformanceChange(this.currentMetrics)}setupCoordinationPhases(){this.systemDependencies.set("MusicSyncService",[]),this.systemDependencies.set("ColorProcessor",[]),this.systemDependencies.set("ColorHarmonyEngine",["MusicSyncService","SpicetifyColorBridge"]),this.systemDependencies.set("PerformanceAnalyzer",[]),this.systemDependencies.set("CSSVariableWriter",["PerformanceAnalyzer"]),this.systemDependencies.set("SpicetifyColorBridge",["CSSVariableWriter"]),this.initializationOrder.set("core",["PerformanceAnalyzer","CSSVariableWriter"]),this.initializationOrder.set("services",["ColorProcessor","MusicSyncService","SpicetifyColorBridge"]),this.initializationOrder.set("visual-systems",["ColorHarmonyEngine"]),this.initializationOrder.set("integration",["VisualSystemCoordinator","InfrastructureSystemCoordinator"]);for(let[t,e]of this.initializationOrder.entries())for(let i of e)this.systemStates.set(i,"uninitialized");u?.debug?.log("SystemIntegrationCoordinator","Coordination phases configured",{phases:Array.from(this.initializationOrder.keys()),totalSystems:this.systemStates.size,dependencies:Object.fromEntries(this.systemDependencies)})}async executeCoordinatedInitialization(){let t=["core","services","visual-systems","integration"];for(let e of t){u?.debug?.log("SystemIntegrationCoordinator",`Starting phase: ${e}`),this.currentPhase=e;try{await this.executePhase(e),u?.debug?.log("SystemIntegrationCoordinator",`Phase ${e} completed successfully`)}catch(i){throw u?.debug?.error("SystemIntegrationCoordinator",`Phase ${e} failed:`,i),new Error(`Orchestration failed at phase ${e}: ${i}`)}}this.currentPhase="completed",this.setupSystemEventBus(),await this.setupGradientSystemCoordination(),this.setupDefaultColorDependentSystems(),this.startMonitoring(),await this.performHealthCheck()}async executePhase(t){let e=this.initializationOrder.get(t);if(!e)throw new Error(`Unknown phase: ${t}`);let i=[];for(let r of e)i.push(this.initializeSystemWithDependencies(r));await Promise.all(i);for(let r of e){let a=this.systemStates.get(r);if(a!=="ready")throw new Error(`System ${r} not ready after phase ${t} (state: ${a})`)}}async initializeSystemWithDependencies(t){if(this.systemStates.get(t)!=="ready"){this.systemStates.set(t,"initializing");try{let e=this.systemDependencies.get(t)||[];for(let i of e)await this.waitForSystemReady(i);switch(t){case"PerformanceAnalyzer":await this.initializePerformanceAnalyzer();break;case"CSSVariableWriter":await this.initializeUnifiedCSSController();break;case"ColorProcessor":await this.initializeColorProcessor();break;case"MusicSyncService":await this.initializeMusicSyncService();break;case"ColorHarmonyEngine":await this.initializeColorHarmonyEngine();break;case"SpicetifyColorBridge":await this.initializeSpicetifyColorBridge();break;case"VisualSystemCoordinator":await this.initializeVisualFacade();break;case"InfrastructureSystemCoordinator":await this.initializeNonVisualFacade();break;default:throw new Error(`Unknown system: ${t}`)}this.systemStates.set(t,"ready"),u?.debug?.log("SystemIntegrationCoordinator",`System ${t} initialized successfully`)}catch(e){throw this.systemStates.set(t,"failed"),u?.debug?.error("SystemIntegrationCoordinator",`System ${t} initialization failed:`,e),e}}}async waitForSystemReady(t){let e=this.coordinationConfig.coordination.systemReadinessTimeout,i=Date.now();for(;Date.now()-i<e;){let r=this.systemStates.get(t);if(r==="ready")return;if(r==="failed")throw new Error(`Dependency ${t} failed to initialize`);await new Promise(a=>setTimeout(a,50))}throw new Error(`Timeout waiting for dependency ${t} to be ready`)}async initializePerformanceAnalyzer(){this.deviceDetector||(this.deviceDetector=new W({enableDebug:!0,spicetifyContext:!0}),await this.deviceDetector.initialize()),this.sharedEnhancedDeviceTierDetector=new fe,this.sharedWebGLSystemsIntegration=new tt(this.deviceDetector),await this.sharedWebGLSystemsIntegration.initialize(),this.performanceCoordinator=new Se(this.sharedEnhancedDeviceTierDetector,this.sharedWebGLSystemsIntegration),await this.performanceCoordinator.initialize()}async initializeUnifiedCSSController(){if(!this.performanceCoordinator)throw new Error("SimplePerformanceCoordinator dependency not available");try{this.sharedCSSVariableWriter=new Pe(this.config,this.performanceCoordinator),Rr(this.sharedCSSVariableWriter),await this.sharedCSSVariableWriter.initialize(),u?.debug?.log("SystemIntegrationCoordinator","CSSVariableWriter initialized successfully with SimplePerformanceCoordinator")}catch(t){throw u?.debug?.warn("SystemIntegrationCoordinator","Failed to initialize CSSVariableWriter:",t),this.sharedCSSVariableWriter=null,t}}async initializeColorProcessor(){try{let{globalColorProcessor:t}=await Promise.resolve().then(()=>(Sa(),ys));console.log("\u{1F3A8} [SystemIntegrationCoordinator] Initializing ColorProcessor..."),await t.initialize(),this.sharedColorProcessor=t,console.log("\u{1F3A8} [SystemIntegrationCoordinator] \u2705 ColorProcessor initialized successfully"),u?.debug?.log("SystemIntegrationCoordinator","ColorProcessor initialized and ready to receive colors:extracted events")}catch(t){throw u?.debug?.error("SystemIntegrationCoordinator","Failed to initialize ColorProcessor:",t),t}}async initializeMusicSyncService(){this.sharedMusicSyncService=new Je({ADVANCED_SYSTEM_CONFIG:this.config,ThemeUtilities:this.utils,performanceMonitor:this.performanceCoordinator,year3000System:this.year3000System}),await this.sharedMusicSyncService.initialize()}async initializeSpicetifyColorBridge(){if(!this.sharedCSSVariableWriter)throw new Error("CSSVariableWriter dependency not available");this.sharedSpicetifyColorBridge=new mt({enableDebug:this.config.enableDebug||!1,fallbackToSpiceColors:!0,cacheDuration:5e3}),await this.sharedSpicetifyColorBridge.initialize(this.sharedCSSVariableWriter),u?.debug?.log("SystemIntegrationCoordinator","SpicetifyColorBridge initialized successfully",{systemMetrics:this.sharedSpicetifyColorBridge.getSystemMetrics()})}async initializeColorHarmonyEngine(){if(!this.sharedMusicSyncService)throw new Error("MusicSyncService dependency not available");if(!this.sharedSpicetifyColorBridge)throw new Error("SpicetifyColorBridge dependency not available");this.sharedColorHarmonyEngine=new gi(this.config,this.utils,this.performanceCoordinator||void 0,this.sharedSpicetifyColorBridge),await this.sharedColorHarmonyEngine.initialize()}async initializeVisualFacade(){this.visualSystemCoordinator=new rt(this.config,this.sharedCSSVariableWriter,this.performanceCoordinator,this.sharedMusicSyncService,this.sharedColorHarmonyEngine||void 0,this.sharedColorProcessor||void 0,this.utils,this,void 0),await this.visualSystemCoordinator.initialize(),this.sharedWebGLSystemsIntegration&&this.sharedWebGLSystemsIntegration.setVisualSystemCoordinator(this.visualSystemCoordinator)}async initializeNonVisualFacade(){this.infrastructureSystemFacade=new zt(this.config,this.utils,{performanceAnalyzer:this.performanceCoordinator,unifiedCSSConsciousnessController:this.sharedCSSVariableWriter,musicSyncService:this.sharedMusicSyncService,colorHarmonyEngine:this.sharedColorHarmonyEngine,performanceOrchestrator:this.performanceCoordinator,semanticColorManager:this.sharedSpicetifyColorBridge}),await this.infrastructureSystemFacade.initialize()}async executeLegacyInitialization(){await this.initializeSharedDependencies(),await this.initializeFacades(),this.setupSystemEventBus(),await this.setupGradientSystemCoordination(),this.setupDefaultColorDependentSystems(),this.startMonitoring(),await this.performHealthCheck()}getCurrentPhase(){return this.currentPhase}getSystemState(t){return this.systemStates.get(t)}getAllSystemStates(){return new Map(this.systemStates)}isOrchestrationEnabled(){return this.coordinationConfig.coordination.enforceSequentialInitialization}async cleanup(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this.visualSystemCoordinator&&(await this.visualSystemCoordinator.destroy(),this.visualSystemCoordinator=null),this.infrastructureSystemFacade&&(await this.infrastructureSystemFacade.destroy(),this.infrastructureSystemFacade=null),this.performanceCoordinator&&(this.performanceCoordinator.destroy(),this.performanceCoordinator=null),this.sharedWebGLSystemsIntegration&&(this.sharedWebGLSystemsIntegration.destroy(),this.sharedWebGLSystemsIntegration=null),this.sharedEnhancedDeviceTierDetector&&(this.sharedEnhancedDeviceTierDetector=null),this.sharedSpicetifyColorBridge&&(this.sharedSpicetifyColorBridge.destroy(),this.sharedSpicetifyColorBridge=null),this.sharedColorHarmonyEngine&&(this.sharedColorHarmonyEngine.destroy(),this.sharedColorHarmonyEngine=null),this.sharedMusicSyncService&&(this.sharedMusicSyncService.destroy(),this.sharedMusicSyncService=null),this.sharedCSSVariableWriter&&(this.sharedCSSVariableWriter.destroy(),this.sharedCSSVariableWriter=null),this.performanceCoordinator&&(this.performanceCoordinator.destroy(),this.performanceCoordinator=null),this.deviceDetector&&(this.deviceDetector.destroy(),this.deviceDetector=null),this.crossFacadeEventListeners.clear()}getMetrics(){return{...this.currentMetrics}}getLastHealthCheck(){return this.lastHealthCheck}getConfiguration(){return{...this.coordinationConfig}}async setConfiguration(t){this.coordinationConfig={...this.coordinationConfig,...t}}setOnSystemCreated(t){this.onSystemCreated=t}setOnHealthChange(t){this.onHealthChange=t}setOnPerformanceChange(t){this.onPerformanceChange=t}getSystemStatus(){return{initialized:this.isInitialized,visualSystems:this.visualSystemCoordinator?.getSystemStatus()?.systemsActive||0,nonVisualSystems:this.infrastructureSystemFacade?.getSystemStatus()?.systemsActive||0,healthy:this.currentMetrics.overallHealth==="excellent"||this.currentMetrics.overallHealth==="good"}}async setupGradientSystemCoordination(){if(!this.visualSystemCoordinator){u?.debug?.warn("SystemIntegrationCoordinator","VisualSystemCoordinator not available - skipping gradient system coordination");return}u?.debug?.log("SystemIntegrationCoordinator","Setting up gradient system coordination");let t=performance.now(),e=0;try{await this.coordinateGradientConductor(),e++,await this.coordinateWebGLGradientSystem(),e++,this.setupGradientSystemRefreshCallbacks(),this.setupGradientSystemCommunication();let i=performance.now()-t;u?.debug?.log("SystemIntegrationCoordinator","Gradient system coordination completed",{coordinatedSystems:e,duration:`${i.toFixed(2)}ms`,systems:["GradientConductor","WebGLGradientBackgroundSystem","GradientTransitionOrchestrator"]})}catch(i){throw u?.debug?.error("SystemIntegrationCoordinator","Failed to setup gradient system coordination:",i),i}}async coordinateGradientConductor(){try{let t=await this.visualSystemCoordinator.getVisualSystem("GradientConductor");if(!t){u?.debug?.warn("SystemIntegrationCoordinator","GradientConductor not available via VisualEffectsCoordinator");return}this.addEventListener("gradient-conductor-event",e=>{t&&typeof t.handleSystemEvent=="function"&&t.handleSystemEvent(e)}),this.registerColorDependentSystem("GradientConductor",async e=>{if(t&&typeof t.refreshColorState=="function")await t.refreshColorState(e);else if(t&&typeof t.setPalette=="function"){let i=this.sharedColorHarmonyEngine;if(i)try{let r=await i.getCurrentGradient();r&&t.setPalette(r)}catch(r){u?.debug?.warn("SystemIntegrationCoordinator","Failed to refresh GradientConductor colors:",r)}}}),u?.debug?.log("SystemIntegrationCoordinator","GradientConductor coordination established")}catch(t){u?.debug?.error("SystemIntegrationCoordinator","Failed to coordinate GradientConductor:",t)}}async coordinateWebGLGradientSystem(){try{let t=await this.visualSystemCoordinator.getVisualSystem("WebGLBackground");if(!t){u?.debug?.warn("SystemIntegrationCoordinator","WebGLGradientBackgroundSystem not available via VisualEffectsCoordinator");return}this.addEventListener("webgl-gradient-event",e=>{t&&typeof t.handleSystemEvent=="function"&&t.handleSystemEvent(e)}),this.registerColorDependentSystem("WebGLGradientBackgroundSystem",async e=>{t&&typeof t.refreshColorState=="function"?await t.refreshColorState(e):t&&typeof t.updateGradientTexture=="function"&&await t.updateGradientTexture()}),u?.debug?.log("SystemIntegrationCoordinator","WebGLGradientBackgroundSystem coordination established")}catch(t){u?.debug?.error("SystemIntegrationCoordinator","Failed to coordinate WebGLGradientBackgroundSystem:",t)}}setupGradientSystemRefreshCallbacks(){try{this.registerColorDependentSystem("GradientTransitionOrchestrator"),u?.debug?.log("SystemIntegrationCoordinator","GradientTransitionOrchestrator registered for color updates")}catch(t){u?.debug?.warn("SystemIntegrationCoordinator","Failed to register GradientTransitionOrchestrator:",t)}}setupGradientSystemCommunication(){this.addEventListener("color-harmony-updated",async t=>{try{await this.refreshColorDependentSystems("color-harmony-update"),this.emitEvent("gradient-systems-updated",{trigger:"color-harmony-update",timestamp:Date.now(),systems:["GradientConductor","WebGLGradientBackgroundSystem","GradientTransitionOrchestrator"]})}catch(e){u?.debug?.error("SystemIntegrationCoordinator","Failed to propagate color harmony update to gradient systems:",e)}}),this.addEventListener("performance-event",t=>{try{this.emitEvent("gradient-performance-event",{...t,timestamp:Date.now()})}catch(e){u?.debug?.error("SystemIntegrationCoordinator","Failed to propagate performance event to gradient systems:",e)}}),u?.debug?.log("SystemIntegrationCoordinator","Gradient system communication established")}getGradientSystemStatus(){let t=["GradientConductor","WebGLGradientBackgroundSystem","GradientTransitionOrchestrator"],e=t.filter(i=>this.colorDependentSystems.has(i));return{coordinatedSystems:t,colorDependentGradientSystems:e,communicationActive:this.crossFacadeEventListeners.size>0}}registerColorDependentSystem(t,e){this.colorDependentSystems.add(t),e&&this.colorSystemRefreshCallbacks.set(t,e),u?.debug?.log("SystemIntegrationCoordinator",`Registered color-dependent system: ${t}`)}unregisterColorDependentSystem(t){this.colorDependentSystems.delete(t),this.colorSystemRefreshCallbacks.delete(t),u?.debug?.log("SystemIntegrationCoordinator",`Unregistered color-dependent system: ${t}`)}getColorDependentSystems(){return Array.from(this.colorDependentSystems)}async refreshColorDependentSystems(t){if(this.colorDependentSystems.size===0){u?.debug?.log("SystemIntegrationCoordinator","No color-dependent systems to refresh");return}let e=performance.now(),i=[],r=0,a=0;u?.debug?.log("SystemIntegrationCoordinator",`Refreshing ${this.colorDependentSystems.size} color-dependent systems for trigger: ${t}`);for(let l of this.colorDependentSystems){let c=this.colorSystemRefreshCallbacks.get(l);c?i.push(c(t).then(()=>{r++,u?.debug?.log("SystemIntegrationCoordinator",`Successfully refreshed color system: ${l}`)}).catch(m=>{a++,u?.debug?.warn("SystemIntegrationCoordinator",`Failed to refresh color system ${l}:`,m)})):i.push(this.getSystemAndRefresh(l,t).then(()=>{r++}).catch(m=>{a++,u?.debug?.warn("SystemIntegrationCoordinator",`Failed to refresh color system ${l}:`,m)}))}await Promise.all(i);let s=performance.now()-e;u?.debug?.log("SystemIntegrationCoordinator","Color system refresh completed",{trigger:t,duration:`${s.toFixed(2)}ms`,success:r,failures:a,totalSystems:this.colorDependentSystems.size}),this.emitEvent("color-systems-refreshed",{trigger:t,duration:s,successCount:r,failureCount:a,totalSystems:this.colorDependentSystems.size,timestamp:Date.now()})}async getSystemAndRefresh(t,e){if(this.visualSystemCoordinator)try{let i=await this.visualSystemCoordinator.getVisualSystem(t);if(i&&typeof i.refreshColorState=="function"){await i.refreshColorState(e);return}}catch{}if(this.infrastructureSystemFacade)try{let i=await this.infrastructureSystemFacade.getSystem(t);if(i&&typeof i.refreshColorState=="function"){await i.refreshColorState(e);return}}catch{}u?.debug?.warn("SystemIntegrationCoordinator",`System ${t} not found or doesn't support color refresh`)}setupDefaultColorDependentSystems(){let t=["CinematicDrama","EtherealBeauty","NaturalHarmony","FluidGradientBackgroundSystem","WebGLGradientBackgroundSystem","IridescentShimmerEffectsSystem","ColorHarmonyEngine","GradientTransitionOrchestrator","GradientConductor","SpicetifyColorBridge","Card3DManager","GlassmorphismManager"];for(let e of t)this.registerColorDependentSystem(e);u?.debug?.log("SystemIntegrationCoordinator",`Auto-registered ${t.length} default color-dependent systems`)}async destroy(){await this.cleanup(),this.isInitialized=!1,u?.debug?.log("SystemIntegrationCoordinator","System coordinator destroyed")}getSharedMusicSyncService(){return this.sharedMusicSyncService||void 0}getSharedColorHarmonyEngine(){return this.sharedColorHarmonyEngine||void 0}getSharedColorProcessor(){return this.sharedColorProcessor||void 0}getSharedSpicetifyColorBridge(){return this.sharedSpicetifyColorBridge||void 0}getSharedSimplePerformanceCoordinator(){return this.performanceCoordinator||void 0}getSharedWebGLSystemsIntegration(){return this.sharedWebGLSystemsIntegration||void 0}getSharedEnhancedDeviceTierDetector(){return this.sharedEnhancedDeviceTierDetector||void 0}getDeviceDetector(){return this.deviceDetector||void 0}getSharedDependency(t){switch(t){case"performanceCoordinator":case"performanceAnalyzer":case"simplePerformanceCoordinator":return this.performanceCoordinator||null;case"cssVariableManager":case"cssVariableController":case"cssConsciousnessController":return this.sharedCSSVariableWriter||null;case"musicSyncService":return this.sharedMusicSyncService||null;case"colorHarmonyEngine":return this.sharedColorHarmonyEngine||null;case"deviceDetector":case"deviceCapabilityDetector":return this.deviceDetector||null;case"webglSystemsIntegration":return this.sharedWebGLSystemsIntegration||null;case"enhancedDeviceTierDetector":return this.sharedEnhancedDeviceTierDetector||null;case"spicetifyColorBridge":return this.sharedSpicetifyColorBridge||null;default:return null}}}});async function Et(o,t=5e3){let e=Date.now(),i=null,r=0;for(;Date.now()-e<t;){r++;try{let s=o.split(".").reduce((l,c)=>l?.[c],window);if(s)return console.log(`\u2705 [ProgressiveAPILoader] API ${o} available after ${r} attempts (${Date.now()-e}ms)`),s}catch(s){i=s}await new Promise(s=>setTimeout(s,100))}console.warn(`\u274C [ProgressiveAPILoader] API ${o} timeout after ${t}ms (${r} attempts)`),i&&console.warn(`\u274C [ProgressiveAPILoader] Last error for ${o}:`,i.message);let a=o.split("."),n=window;for(let s=0;s<a.length;s++){let l=a[s];if(!l||!n||typeof n!="object"||n[l]===void 0){console.warn(`\u274C [ProgressiveAPILoader] API path ${o} breaks at '${l}' (step ${s+1}/${a.length})`);break}n=n[l]}return null}async function Ds(o,t=5e3){let e=Date.now(),i=0;for(;Date.now()-e<t;){i++;try{let r=document.querySelector(o);if(r)return console.log(`\u2705 [ProgressiveAPILoader] DOM element '${o}' found after ${i} attempts (${Date.now()-e}ms)`),r}catch(r){console.warn(`\u274C [ProgressiveAPILoader] DOM query error for '${o}':`,r)}await new Promise(r=>setTimeout(r,200))}return console.warn(`\u274C [ProgressiveAPILoader] DOM element '${o}' not found after ${t}ms (${i} attempts)`),null}async function Ls(o=5e3){let t=Date.now();for(;Date.now()-t<o;){try{let i=getComputedStyle(document.documentElement).getPropertyValue("--ctp-base");if(i&&i.trim()!=="")return console.log(`\u2705 [ProgressiveAPILoader] Catppuccin theme loaded (${Date.now()-t}ms)`),!0}catch(e){console.warn("\u274C [ProgressiveAPILoader] Error checking Catppuccin theme:",e)}await new Promise(e=>setTimeout(e,100))}return console.warn(`\u274C [ProgressiveAPILoader] Catppuccin theme not detected after ${o}ms`),!1}function Nl(){let o=!!window.Spicetify?.Player,t=!!window.Spicetify?.Platform;return!(o&&t)}function Rs(){let o={player:window.Spicetify?.Player,platform:window.Spicetify?.Platform,menu:window.Spicetify?.Menu,react:window.Spicetify?.React,reactDOM:window.Spicetify?.ReactDOM,config:window.Spicetify?.Config},t=Nl();return{available:o,degradedMode:t}}var xa=v(()=>{"use strict"});var Bi,ks=v(()=>{"use strict";xa();Bi=class{constructor(t={}){this.upgradeInterval=null;this.upgradeAttempts=0;this.songChangeHandler=null;this.config={maxUpgradeAttempts:t.maxUpgradeAttempts??30,upgradeCheckInterval:t.upgradeCheckInterval??1e4,enableDebug:t.enableDebug??!1,onAPIsAvailable:t.onAPIsAvailable??(async()=>{}),onStatusUpdate:t.onStatusUpdate??(()=>{})}}startMonitoring(){this.config.enableDebug&&console.log("\u{1F504} [DegradedModeCoordinator] Starting progressive enhancement monitoring..."),this.checkForUpgrade(),this.upgradeInterval=window.setInterval(()=>this.checkForUpgrade(),this.config.upgradeCheckInterval),this.setupSpicetifyEventListeners(),setTimeout(()=>this.stopMonitoring(),this.config.maxUpgradeAttempts*this.config.upgradeCheckInterval)}stopMonitoring(){this.upgradeInterval!==null&&(clearInterval(this.upgradeInterval),this.upgradeInterval=null,this.config.enableDebug&&console.log(`\u23F0 [DegradedModeCoordinator] Monitoring ended after ${this.upgradeAttempts} attempts (${this.upgradeAttempts*this.config.upgradeCheckInterval/1e3}s)`)),this.cleanupSpicetifyEventListeners()}checkForUpgrade(){this.upgradeAttempts++;let{available:t,degradedMode:e}=Rs();if(this.config.onStatusUpdate(this.upgradeAttempts,t),t.player&&t.platform&&!e){this.config.enableDebug&&console.log("\u2705 [DegradedModeCoordinator] Required APIs now available - upgrading to full mode!"),this.stopMonitoring(),this.triggerUpgrade(t).then(()=>{this.config.enableDebug&&console.log("\u{1F31F} [DegradedModeCoordinator] Successfully upgraded to full mode!"),window.Y3K&&(window.Y3K.mode="full",window.Y3K.availableAPIs=t)}).catch(r=>{console.error("\u274C [DegradedModeCoordinator] Failed to upgrade to full mode:",r)});return}if(this.upgradeAttempts>=this.config.maxUpgradeAttempts){this.stopMonitoring();return}this.upgradeAttempts%5===0&&this.config.enableDebug&&(console.log(`\u{1F504} [DegradedModeCoordinator] Still monitoring... (attempt ${this.upgradeAttempts}/${this.config.maxUpgradeAttempts})`),console.log("\u{1F504} [DegradedModeCoordinator] Current API status:",{player:!!t.player,platform:!!t.platform,menu:!!t.menu,react:!!t.react,reactDOM:!!t.reactDOM}))}async triggerUpgrade(t){this.config.enableDebug&&console.log("\u{1F680} [DegradedModeCoordinator] Beginning upgrade to full mode..."),await this.config.onAPIsAvailable(t)}setupSpicetifyEventListeners(){this.songChangeHandler=()=>{this.config.enableDebug&&console.log("\u{1F3B5} [DegradedModeCoordinator] Spicetify ready event detected - checking for upgrade..."),this.checkForUpgrade()},window.Spicetify?.Player&&window.Spicetify.Player.addEventListener?.("songchange",this.songChangeHandler)}cleanupSpicetifyEventListeners(){this.songChangeHandler&&window.Spicetify?.Player&&(window.Spicetify.Player.removeEventListener?.("songchange",this.songChangeHandler),this.songChangeHandler=null)}getMonitoringStatus(){return{isMonitoring:this.upgradeInterval!==null,attempts:this.upgradeAttempts,maxAttempts:this.config.maxUpgradeAttempts}}}});var Hi,Vs=v(()=>{"use strict";_();Hi=class{constructor(t={}){this.subscriptionId=null;this.config={maxChainLength:t.maxChainLength??10,processingTimeout:t.processingTimeout??5e3,colorEventCacheTTL:t.colorEventCacheTTL??2e3,enableDebug:t.enableDebug??!1,onApplyColors:t.onApplyColors??(()=>{})},this.colorEventState={processedEvents:new Map,isProcessingColorEvent:!1,eventTimeout:null},this.processingState={isProcessingSongChange:!1,lastProcessedTrackUri:null,lastProcessingTime:0,processingChain:[],eventLoopDetected:!1}}startListening(){try{p.subscribe("colors:harmonized",t=>{this.handleColorHarmonizedEvent(t)},"ColorEventCoordinator"),this.subscriptionId="ColorEventCoordinator",this.config.enableDebug&&console.log("\u{1F3A8} [ColorEventCoordinator] Subscribed to colors:harmonized events")}catch(t){console.error("[ColorEventCoordinator] Failed to subscribe to colors:harmonized events:",t)}}stopListening(){if(this.subscriptionId)try{p.unsubscribe(this.subscriptionId),this.subscriptionId=null,this.config.enableDebug&&console.log("\u{1F3A8} [ColorEventCoordinator] Unsubscribed from colors:harmonized events")}catch(t){console.error("[ColorEventCoordinator] Failed to unsubscribe from colors:harmonized events:",t)}this.resetColorEventState(),this.resetProcessingState()}handleColorHarmonizedEvent(t){if(this.colorEventState.isProcessingColorEvent){this.config.enableDebug&&console.warn("\u{1F504} [ColorEventCoordinator] Already processing color event - skipping to prevent recursion");return}let e=JSON.stringify(t).substring(0,100),i=this.generateEventHash(e),r=Date.now();if(this.colorEventState.processedEvents.has(i)){let a=this.colorEventState.processedEvents.get(i);if(r-a<this.config.colorEventCacheTTL){this.config.enableDebug&&console.warn("\u{1F504} [ColorEventCoordinator] Event recently processed - skipping duplicate");return}}this.colorEventState.isProcessingColorEvent=!0,this.colorEventState.processedEvents.set(i,r),this.colorEventState.eventTimeout=window.setTimeout(()=>{this.config.enableDebug&&console.warn("\u{1F504} [ColorEventCoordinator] Color event processing timeout - resetting state"),this.resetColorEventState()},this.config.processingTimeout);try{if(this.processingState.processingChain.push("handleColorHarmonizedEvent"),this.processingState.processingChain.length>this.config.maxChainLength){this.processingState.eventLoopDetected=!0,console.error("\u{1F504} [ColorEventCoordinator] CRITICAL: Event loop detected - chain length exceeded",this.processingState.processingChain),this.resetProcessingState();return}let a={},n="#37416b",s="166,173,200",l=[],c=0;if(t.eventType==="colors/harmonized"&&t.payload)a=t.payload.colors||{},n=t.payload.accent?.hex||n,s=t.payload.accent?.rgb||s,l=t.payload.metadata?.strategies||[],c=t.payload.metadata?.processingTime||0;else{if(t.type==="colors/harmonized")return;this.config.enableDebug&&console.warn("\u{1F3A8} [ColorEventCoordinator] Unrecognized colors:harmonized event format:",t);return}this.config.enableDebug&&console.log("\u{1F3A8} [ColorEventCoordinator] Processing colors:harmonized event:",{strategies:l,processingTime:c,colorsCount:Object.keys(a).length,accentHex:n,accentRgb:s,chainLength:this.processingState.processingChain.length}),this.config.onApplyColors(a,n,s)}catch(a){console.error("[ColorEventCoordinator] Failed to handle colors:harmonized event:",a)}finally{this.resetColorEventState();let a=this.processingState.processingChain.indexOf("handleColorHarmonizedEvent");a>-1&&this.processingState.processingChain.splice(a,1)}}generateEventHash(t){let e=0;for(let i=0;i<t.length;i++){let r=t.charCodeAt(i);e=(e<<5)-e+r,e=e&e}return e.toString()}resetColorEventState(){this.colorEventState.isProcessingColorEvent=!1,this.colorEventState.eventTimeout&&(clearTimeout(this.colorEventState.eventTimeout),this.colorEventState.eventTimeout=null);let t=Date.now();for(let[e,i]of this.colorEventState.processedEvents.entries())t-i>this.config.colorEventCacheTTL&&this.colorEventState.processedEvents.delete(e)}resetProcessingState(){this.processingState.isProcessingSongChange=!1,this.processingState.processingChain=[],this.processingState.eventLoopDetected=!1,this.processingState.lastProcessingTime=Date.now(),this.config.enableDebug&&console.log("\u{1F504} [ColorEventCoordinator] Processing state reset")}getProcessingState(){return{...this.processingState}}getColorEventState(){return{isProcessing:this.colorEventState.isProcessingColorEvent,cachedEventsCount:this.colorEventState.processedEvents.size,chainLength:this.processingState.processingChain.length}}updateConfig(t){this.config={...this.config,...t}}}});var Pa,Fs,Gs=v(()=>{"use strict";ee();_();$();Lt();Pa=class{constructor(){this.initialized=!1;this.currentState=null;this.isUpdating=!1;this.updateCount=0;this.lastUpdateTime=0}async initialize(){if(this.initialized)return;let t=globalThis.year3000System;this.cssController=t?.cssController||A(),p.subscribe("settings:changed",this.handleSettingsChange.bind(this),"ColorStateManager"),p.subscribe("colors:harmonized",this.handleProcessedColors.bind(this),"ColorStateManager"),p.subscribe("colors:extracted",this.handleExtractedColors.bind(this),"ColorStateManager"),p.subscribe("visual-effects:state-updated",this.handleVisualEffectsUpdate.bind(this),"ColorStateManager"),p.subscribe("music:energy",this.handleMusicEnergyUpdate.bind(this),"ColorStateManager"),p.subscribe("system:css-variables",this.handleSystemCSSVariables.bind(this),"ColorStateManager"),await this.applyInitialColorState(),this.initialized=!0,console.log("\u{1F3A8} [ColorStateManager] Initialized successfully")}async healthCheck(){let t=[];this.currentState||t.push("No current color state"),this.updateCount===0&&t.push("No color updates performed yet");let e=Date.now()-this.lastUpdateTime;return e>3e5&&t.push(`Last update was ${Math.round(e/1e3)}s ago`),{healthy:t.length===0,ok:t.length===0,details:`Color state manager - ${this.updateCount} updates performed`,issues:t,system:"ColorStateManager"}}updateAnimation(t){}destroy(){p.unsubscribeAll("ColorStateManager"),this.currentState=null,this.initialized=!1}getCurrentConfig(){return{paletteSystemFlavor:E.get("catppuccin-flavor")||Z.getCurrentDefaultFlavor(),brightnessMode:E.get("sn-brightness-mode"),accentColor:E.get("catppuccin-accentColor"),preserveAlbumArt:!0,enableTransitions:!0}}calculateColorState(t){let{paletteSystemFlavor:e,brightnessMode:i,accentColor:r,dynamicAlbumColors:a}=t,n=Ln(e,i),s=Rn(e,i),l;r==="dynamic"&&a?l=a.accent:r==="dynamic"?l=Lr(e):l=kn(r,e);let m=Z.getCurrentPalette()[e];if(!m)throw new Error(`Flavor '${e}' not found in current palette system`);let d=m.text;return{baseColor:n,surfaceColor:s,accentColor:l,textColor:d,effectiveConfig:t,timestamp:Date.now()}}async applyColorStateToCSSVariables(t){let e=performance.now(),i={"--sn-cosmic-base-hex":t.baseColor.hex,"--sn-cosmic-accent-hex":t.accentColor.hex,"--spice-accent":t.accentColor.hex,"--spice-base":t.baseColor.hex,"--sn-color-base-hex":t.baseColor.hex,"--sn-color-base-rgb":t.baseColor.rgb,"--sn-color-surface-hex":t.surfaceColor.hex,"--sn-color-surface-rgb":t.surfaceColor.rgb,"--sn-color-accent-hex":t.accentColor.hex,"--sn-color-accent-rgb":t.accentColor.rgb,"--sn-dynamic-accent-hex":t.accentColor.hex,"--sn-dynamic-accent-rgb":t.accentColor.rgb,"--sn-cosmic-base-rgb":t.baseColor.rgb,"--sn-cosmic-surface-hex":t.surfaceColor.hex,"--sn-cosmic-surface-rgb":t.surfaceColor.rgb,"--sn-cosmic-accent-rgb":t.accentColor.rgb,"--sn-color-text-hex":t.textColor.hex,"--sn-color-text-rgb":t.textColor.rgb,"--sn-cosmic-text-hex":t.textColor.hex,"--sn-cosmic-text-rgb":t.textColor.rgb,"--spice-surface1":t.surfaceColor.hex,"--spice-text":t.textColor.hex,"--spice-rgb-base":t.baseColor.rgb,"--spice-rgb-surface1":t.surfaceColor.rgb,"--spice-rgb-accent":t.accentColor.rgb,"--spice-rgb-text":t.textColor.rgb,"--sn-bg-gradient-primary-rgb":t.accentColor.rgb,"--sn-bg-gradient-secondary-rgb":t.surfaceColor.rgb,"--sn-bg-gradient-accent-rgb":t.accentColor.rgb,"--sn-brightness-mode":`"${t.effectiveConfig.brightnessMode}"`,"--sn-brightness-data-attr":t.effectiveConfig.brightnessMode,"--sn-color-state-flavor":`"${t.effectiveConfig.paletteSystemFlavor}"`,"--sn-color-state-brightness":`"${t.effectiveConfig.brightnessMode}"`,"--sn-color-state-accent":`"${t.effectiveConfig.accentColor}"`,"--sn-color-state-palette-system":`"${Z.getCurrentPaletteSystem()}"`,"--sn-color-state-timestamp":t.timestamp.toString()};await this.applyColorVariablesWithPriorities(i);let a=performance.now()-e;console.log(`\u{1F3A8} [ColorStateManager] Applied ${Object.keys(i).length} CSS variables in ${a.toFixed(2)}ms (via CSSVariableWriter)`)}async applyColorVariablesWithPriorities(t){let e=["--sn-cosmic-base-hex","--sn-cosmic-accent-hex","--spice-accent","--spice-base"],i=["--sn-color-","--sn-dynamic-accent-","--sn-brightness-mode","--sn-brightness-data-attr"],r={},a={},n={},s={};Object.entries(t).forEach(([l,c])=>{e.some(m=>l.includes(m))?r[l]=c:i.some(m=>l.includes(m))?a[l]=c:l.includes("state-")||l.includes("timestamp")?s[l]=c:n[l]=c}),Object.keys(r).length>0&&this.cssController.batchSetVariables("ColorStateManager",r,"critical","color-state-critical"),Object.keys(a).length>0&&this.cssController.batchSetVariables("ColorStateManager",a,"high","color-state-high"),Object.keys(n).length>0&&this.cssController.batchSetVariables("ColorStateManager",n,"normal","color-state-normal"),Object.keys(s).length>0&&this.cssController.batchSetVariables("ColorStateManager",s,"low","color-state-meta")}queueCSSVariableUpdate(t,e,i="normal"){let r=i==="critical"?"critical":i==="high"?"high":i==="low"?"low":"normal";this.cssController.setVariable("ColorStateManager",t,e,r,"color-state-queue")}async verifyCSSVariablesApplied(t){let e=["--sn-cosmic-base-hex","--sn-cosmic-accent-hex","--spice-base"];for(let i of e)if(t[i]){let r=getComputedStyle(document.documentElement).getPropertyValue(i).trim(),a=t[i];if(r!==a)return console.warn(`\u{1F3A8} [ColorStateManager] Variable verification failed: ${i} = "${r}" (expected "${a}")`),!1}return!0}async updateColorState(t="settings"){if(!this.isUpdating){this.isUpdating=!0;try{let e=this.getCurrentConfig(),i=this.calculateColorState(e);if(!this.currentState||this.currentState.baseColor.hex!==i.baseColor.hex||this.currentState.surfaceColor.hex!==i.surfaceColor.hex||this.currentState.accentColor.hex!==i.accentColor.hex||this.currentState.effectiveConfig.paletteSystemFlavor!==i.effectiveConfig.paletteSystemFlavor||this.currentState.effectiveConfig.brightnessMode!==i.effectiveConfig.brightnessMode){let a=this.currentState;await this.applyColorStateToCSSVariables(i),await this.applyBrightnessModeOverrides(i.effectiveConfig.brightnessMode),this.currentState=i,this.updateCount++,this.lastUpdateTime=Date.now(),p.emit("colors:applied",{oldState:a,newState:i,trigger:t,cssVariables:{"--sn-cosmic-base-hex":i.baseColor.hex,"--sn-cosmic-accent-hex":i.accentColor.hex},accentHex:i.accentColor.hex,accentRgb:i.accentColor.rgb,appliedAt:Date.now()}),console.log(`\u{1F3A8} [ColorStateManager] Color state updated (${t}):`,{flavor:i.effectiveConfig.paletteSystemFlavor,brightness:i.effectiveConfig.brightnessMode,accent:i.effectiveConfig.accentColor,paletteSystem:Z.getCurrentPaletteSystem(),base:i.baseColor.hex,surface:i.surfaceColor.hex,accentHex:i.accentColor.hex})}}finally{this.isUpdating=!1}}}async applyBrightnessModeOverrides(t){let e=this.getCurrentConfig(),i=Lr(e.paletteSystemFlavor),r=i;if(t==="dark"){let n=i.rgb.split(", ").map(Number);if(n.length===3&&n.every(s=>!isNaN(s)&&s!==void 0)){let s=n[0],l=n[1],c=n[2],m=Math.floor(s*.85),d=Math.floor(l*.85),h=Math.floor(c*.85);r={...i,rgb:`${m}, ${d}, ${h}`,hex:`#${m.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}${h.toString(16).padStart(2,"0")}`}}}else if(t==="bright"){let n=i.rgb.split(", ").map(Number);if(n.length===3&&n.every(s=>!isNaN(s)&&s!==void 0)){let s=n[0],l=n[1],c=n[2],m=Math.min(255,Math.floor(s*1.1)),d=Math.min(255,Math.floor(l*1.1)),h=Math.min(255,Math.floor(c*1.1));r={...i,rgb:`${m}, ${d}, ${h}`,hex:`#${m.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}${h.toString(16).padStart(2,"0")}`}}}let a={"--sn-brightness-mode":`"${t}"`,"--sn-brightness-data-attr":t,"--sn-brightness-adjusted-accent-hex":r.hex,"--sn-brightness-adjusted-accent-rgb":r.rgb,"--sn-bg-gradient-saturation":`var(--sn-brightness-${t}-saturation)`,"--sn-bg-gradient-brightness":`var(--sn-brightness-${t}-brightness)`,"--sn-bg-gradient-contrast":`var(--sn-brightness-${t}-contrast)`,"--sn-bg-gradient-opacity":`var(--sn-brightness-${t}-opacity)`};this.cssController.batchSetVariables("ColorStateManager",a,"critical","brightness-mode-overrides"),console.log(`\u{1F3A8} [ColorStateManager] Applied brightness mode overrides: ${t}`)}async applyInitialColorState(){await this.updateColorState("initialization")}async handleSettingsChange(t){let{settingKey:e,newValue:i,oldValue:r}=t;if(["catppuccin-flavor","sn-brightness-mode","catppuccin-accentColor"].includes(e)){let a="settings";e==="catppuccin-flavor"?a="flavor":e==="sn-brightness-mode"?a="brightness":e==="catppuccin-accentColor"&&(a="accent"),p.emit(`colorState:${a}Changed`,{settingKey:e,newValue:i,oldValue:r,timestamp:Date.now()}),await this.updateColorState(a)}}async handleProcessedColors(t){let{processedColors:e,cssVariables:i,accentHex:r,accentRgb:a,strategies:n,coordinationMetrics:s,timestamp:l}=t,c={};i&&typeof i=="object"?Object.assign(c,i):Object.entries(e).forEach(([m,d])=>{if(d){let h=m.startsWith("--")?m:`--sn-${m.toLowerCase().replace(/_/g,"-")}`;c[h]=d}}),r&&(c["--sn-accent-hex"]=r,c["--sn-processed-accent-hex"]=r,c["--sn-color-accent-hex"]=r),a&&(c["--sn-accent-rgb"]=a,c["--sn-processed-accent-rgb"]=a,c["--sn-color-accent-rgb"]=a),s&&(s.emotionalState&&(c["--sn-emotional-state"]=`"${s.emotionalState}"`),s.musicInfluenceStrength!==void 0&&(c["--sn-music-influence"]=s.musicInfluenceStrength.toFixed(3))),Object.entries(c).forEach(([m,d])=>{let h="normal";m.includes("accent-hex")||m.includes("accent-rgb")?h="high":(m.includes("debug")||m.includes("state")||m.includes("influence"))&&(h="low"),this.queueCSSVariableUpdate(m,d,h)}),p.emitSync("colors:applied",{cssVariables:c,accentHex:r||c["--sn-accent-hex"],accentRgb:a||c["--sn-accent-rgb"],strategies:n||["OKLABColorProcessor"],appliedAt:l||Date.now()}),console.log(`\u{1F3A8} [ColorStateManager] Applied ${Object.keys(c).length} processed color variables from ${n?.join(", ")||"OKLABColorProcessor"}`)}async handleExtractedColors(t){let{rawColors:e,trackUri:i,musicData:r}=t,a={};Object.entries(e).forEach(([n,s])=>{s&&(a[`--sn-extracted-${n.toLowerCase()}`]=s)}),i&&(a["--sn-current-track-id"]=`"${i}"`),Object.entries(a).forEach(([n,s])=>{this.queueCSSVariableUpdate(n,s,"low")})}async handleVisualEffectsUpdate(t){let{payload:e}=t;if(!e)return;let i={"--sn-visual-effects-level":(e.visualEffectsLevel||0).toFixed(3),"--sn-emotional-temperature":(e.emotionalTemperature||6500).toString(),"--sn-transcendence-level":(e.transcendenceLevel||0).toFixed(3),"--sn-volumetric-depth":(e.volumetricDepth||0).toFixed(3),"--sn-data-stream-intensity":(e.dataStreamIntensity||0).toFixed(3),"--sn-cosmic-resonance":(e.cosmicResonance||0).toFixed(3)};Object.entries(i).forEach(([r,a])=>{this.queueCSSVariableUpdate(r,a,"normal")})}async handleMusicEnergyUpdate(t){let{energy:e,valence:i,tempo:r}=t,a={};e!==void 0&&(a["--sn-music-energy"]=e.toFixed(3)),i!==void 0&&(a["--sn-music-valence"]=i.toFixed(3)),r!==void 0&&(a["--sn-music-tempo"]=r.toString()),Object.entries(a).forEach(([n,s])=>{this.queueCSSVariableUpdate(n,s,"high")})}async handleSystemCSSVariables(t){let{source:e,variables:i,timestamp:r}=t;!i||typeof i!="object"||(Object.entries(i).forEach(([a,n])=>{let s="normal";a.includes("harmony")||a.includes("glow")||a.includes("pulse")?s="high":(a.includes("debug")||a.includes("animation"))&&(s="low"),this.queueCSSVariableUpdate(a,n,s)}),console.log(`\u{1F3A8} [ColorStateManager] Applied ${Object.keys(i).length} CSS variables from ${e}`))}getCurrentState(){return this.currentState?{...this.currentState}:null}async refresh(){await this.updateColorState("settings")}},Fs=new Pa});function _s(o,t=!1){let e=document.querySelector(D.nowPlayingBar);if(!e)return t&&console.warn("\u{1F3B5} [NowPlayingDomWatcher] nowPlayingBar element not found \u2013 watcher inactive"),()=>{};let i=new MutationObserver(()=>{o(),t&&console.log("\u{1F3B5} [NowPlayingDomWatcher] DOM mutation detected \u2192 onChange dispatched")});return i.observe(e,{childList:!0,subtree:!0}),t&&console.log("\u{1F3B5} [NowPlayingDomWatcher] watcher active"),()=>{i.disconnect(),t&&console.log("\u{1F3B5} [NowPlayingDomWatcher] watcher disposed")}}var Bs=v(()=>{"use strict";Ma()});function $l(){let o=document.querySelector(".sn-stars-container");if(o)return o;let t=document.createElement("div");t.className="sn-stars-container";for(let e=1;e<=10;e++){let i=document.createElement("div");i.className="star",Math.random()>.7&&i.classList.add("twinkle"),t.appendChild(i)}return document.body.appendChild(t),t}function Ut(o,t){w.enableDebug&&console.log("[StarryNightEffects] Applying consolidated effect settings:",{effectIntensity:o});let e=document.body,i=["sn-gradient-disabled","sn-gradient-minimal","sn-gradient-balanced","sn-gradient-intense"],r=["sn-stars-disabled","sn-stars-minimal","sn-stars-balanced","sn-stars-intense"];e.classList.remove(...i,...r),o!=="balanced"&&(e.classList.add(`sn-gradient-${o}`),e.classList.add(`sn-stars-${o}`));let a=document.querySelector(".sn-stars-container");o==="disabled"?a?.remove():a||$l()}var Aa=v(()=>{"use strict";ee();B()});var Nt,zi,Hs,Ia=v(()=>{"use strict";Is();ks();Vs();ee();Gs();_();B();te();Bs();Aa();Nt=class{constructor(t=w){this.healthCheckInterval=null;this.facadeCoordinator=null;this.colorStateManager=null;this._initializationResults=null;this._dynamicCatppuccinBridge=null;this.PROCESSING_TIMEOUT=5e3;this.MAX_CHAIN_LENGTH=10;this.COLOR_EVENT_CACHE_TTL=2e3;this.availableAPIs=null;this._songChangeHandler=null;this.degradedModeCoordinator=null;this.colorEventCoordinator=null;this._lastInitializationTime=null;this._initializationRetryHistory=[];this._systemStartTime=null;this._disposeNowPlayingWatcher=null;this.allowHarmonicEvolution=!0;this.performanceGuardActive=!1;this.ADVANCED_SYSTEM_CONFIG=this._deepCloneConfig(t),typeof this.ADVANCED_SYSTEM_CONFIG.init=="function"&&this.ADVANCED_SYSTEM_CONFIG.init(),this.utils=k,this.initialized=!1,this._systemStartTime=Date.now(),this._initializationResults=null,this.ADVANCED_SYSTEM_CONFIG?.enableDebug&&console.log("\u{1F31F} [Year3000System] Constructor: Instance created with Enhanced Master Animation Coordinator"),this._boundExternalSettingsHandler=this._handleExternalSettingsChange.bind(this),document.addEventListener("year3000SystemSettingsChanged",this._boundExternalSettingsHandler),this._boundArtisticModeHandler=this._onArtisticModeChanged.bind(this),document.addEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),this._boundVisibilityChangeHandler=this._handleVisibilityChange.bind(this),document.addEventListener("visibilitychange",this._boundVisibilityChangeHandler),this._disposeNowPlayingWatcher=_s(()=>{let e=Date.now().toString();this.queueCSSVariableUpdate("--sn-force-refresh",e),p.emit("music:track-changed",{timestamp:parseInt(e),trackUri:"unknown",artist:"unknown",title:"unknown"})},this.ADVANCED_SYSTEM_CONFIG.enableDebug),this.allowHarmonicEvolution=this.ADVANCED_SYSTEM_CONFIG.colorHarmonyEvolution??!0,setTimeout(()=>{this._applyPerformanceProfile()},0)}get enhancedMasterAnimationCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("AnimationFrameCoordinator")||null}get timerConsolidationSystem(){return this.facadeCoordinator?.getCachedNonVisualSystem("TimerConsolidationSystem")||null}get cssVariableController(){return this.facadeCoordinator?.getCachedNonVisualSystem("CSSVariableWriter")||null}get simplePerformanceCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimplePerformanceCoordinator")||null}get simpleTierBasedPerformanceSystem(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimpleTierBasedPerformanceSystem")||null}get enhancedDeviceTierDetector(){return this.facadeCoordinator?.getCachedNonVisualSystem("EnhancedDeviceTierDetector")||null}get webglSystemsIntegration(){return this.facadeCoordinator?.getCachedNonVisualSystem("WebGLSystemsIntegration")||null}get unifiedCSSManager(){return this.cssVariableController||null}get performanceCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedPerformanceCoordinator")||null}get deviceCapabilityDetector(){return this.facadeCoordinator?.getCachedNonVisualSystem("DeviceCapabilityDetector")||null}get performanceAnalyzer(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimplePerformanceCoordinator")||null}get unifiedPerformanceCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedPerformanceCoordinator")||null}get performanceCSSIntegration(){return this.cssVariableController||null}get performanceOrchestrator(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimplePerformanceCoordinator")||null}get performanceBudgetManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("PerformanceBudgetManager")||null}get systemHealthMonitor(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedDebugManager")||null}get colorHarmonyEngine(){return this.facadeCoordinator?.getCachedNonVisualSystem("ColorHarmonyEngine")||null}get unifiedColorProcessingEngine(){return this.facadeCoordinator?.getCachedNonVisualSystem("ColorProcessor")||null}get musicColorIntegrationBridge(){return null}get colorEventOrchestrator(){let t=this.unifiedColorProcessingEngine;return t||null}get colorOrchestrator(){let t=this.unifiedColorProcessingEngine;return t||null}get enhancedColorOrchestrator(){let t=this.unifiedColorProcessingEngine;return t||null}get colorEffectsState(){return this.visualEffectsCoordinator||null}get musicSyncService(){return this.facadeCoordinator?.getCachedNonVisualSystem("MusicSyncService")||null}get glassmorphismManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("GlassmorphismManager")||null}get card3DManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("Card3DManager")||null}get musicEmotionAnalyzer(){return this.facadeCoordinator?.getCachedNonVisualSystem("MusicEmotionAnalyzer")||null}get visualEffectsCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("VisualEffectsCoordinator")||null}get colorEffectsManager(){return this.visualEffectsCoordinator||null}get dynamicCatppuccinBridge(){return this._dynamicCatppuccinBridge||this.visualEffectsCoordinator||null}set dynamicCatppuccinBridge(t){this._dynamicCatppuccinBridge=t}get particleVisualEffectsModule(){return this.facadeCoordinator?.getVisualSystem("Particle")||null}get sidebarVisualEffectsController(){return this.facadeCoordinator?.getVisualSystem("SidebarVisualEffects")||null}get uiVisualEffectsController(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get headerVisualEffectsController(){return this.facadeCoordinator?.getVisualSystem("HeaderVisualEffects")||null}get lightweightParticleSystem(){return this.facadeCoordinator?.getVisualSystem("Particle")||null}get iridescentShimmerEffectsSystem(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get interactionTrackingSystem(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get whiteLayerDiagnosticSystem(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get audioVisualController(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get prismaticScrollSheenSystem(){return this.facadeCoordinator?.getVisualSystem("UIVisualEffects")||null}get beatSyncVisualSystem(){return this.facadeCoordinator?.getVisualSystem("MusicBeatSync")||null}get webGLGradientBackgroundSystem(){return this.facadeCoordinator?.getVisualSystem("WebGLBackground")||null}get particleFieldSystem(){return this.facadeCoordinator?.getVisualSystem("Particle")||null}get animationCoordinator(){return this.enhancedMasterAnimationCoordinator||null}get emergentChoreographyEngine(){return this.animationCoordinator}get spotifyUIApplicationSystem(){return this.facadeCoordinator?.getVisualSystem("SpotifyUIApplication")||null}get musicBeatSyncVisualEffects(){return this.facadeCoordinator?.getVisualSystem("MusicBeatSync")||this.beatSyncVisualSystem}get sidebarSystemsIntegration(){return this.facadeCoordinator?.getCachedNonVisualSystem("SidebarSystemsIntegration")||null}_deepCloneConfig(t){return t}updateConfiguration(t,e){if(!this.ADVANCED_SYSTEM_CONFIG){console.warn("[Year3000System] Cannot update configuration - config not initialized");return}let i=t.split(".").filter(Boolean);if(!i.length)return;let r=this.ADVANCED_SYSTEM_CONFIG,a=i.pop();if(!a)return;for(let s of i)(typeof r[s]!="object"||r[s]===null)&&(r[s]={}),r=r[s];let n=r[a];r[a]=e,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`[Year3000System] Configuration updated: ${t} = ${e} (was: ${n})`),this._notifyConfigurationChange(t,e,n)}_notifyConfigurationChange(t,e,i){}async initializeAllSystems(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] initializeAllSystems(): Starting full system initialization..."),this._systemStartTime=Date.now();let t=performance.now(),e={success:[],failed:[],skipped:[]};this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing Facade Coordination System...");try{this.facadeCoordinator=new Ot(this.ADVANCED_SYSTEM_CONFIG,this.utils,this),await this.facadeCoordinator.initialize({mode:"unified",enableSharedDependencies:!0,enableCrossFacadeCommunication:!0,enableUnifiedPerformanceMonitoring:!0,enableResourceOptimization:!0,coordination:{enforceSequentialInitialization:!0,dependencyValidation:!0,enableInitializationGates:!0,systemReadinessTimeout:5e3,phaseTransitionTimeout:1e4},performanceThresholds:{maxTotalMemoryMB:100,maxTotalInitTime:5e3,maxCrossCommLatency:50},coordinationPreferences:{preferSharedResources:!0,enableEventPropagation:!0,enableHealthCoordination:!0}}),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Facade Coordination System initialized successfully"),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing ColorStateManager...");try{this.colorStateManager=Fs,this.colorStateManager.initialized||await this.colorStateManager.initialize(),e.success.push("ColorStateManager"),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] ColorStateManager initialized successfully")}catch(r){console.error("\u{1F30C} [Year3000System] Failed to initialize ColorStateManager:",r),e.failed.push("ColorStateManager")}await this._initializeFacadeSystems()}catch(r){throw console.error("\u{1F30C} [Year3000System] Failed to initialize Facade Coordination System:",r),r}e.success.push("FacadeCoordinationSystem"),this.performanceAnalyzer&&(this.performanceAnalyzer.startMonitoring(),this.performanceGuardActive=!0),this.enhancedMasterAnimationCoordinator?(await this._registerEnhancedAnimationSystems(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3AC} [Year3000System] Enhanced animation system registration phase complete")):console.warn("[Year3000System] AnimationFrameCoordinator not available for enhanced registration phase"),this._initializationResults=e,this.initialized=!0;let i=performance.now();this._lastInitializationTime=i-t,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&(console.log(`[Year3000System] System initialization complete in ${this._lastInitializationTime.toFixed(2)}ms.`),console.log(`[Year3000System] Results: ${e.success.length} success, ${e.failed.length} failed.`),e.failed.length>0&&console.warn(`[Year3000System] Failed systems: ${e.failed.join(", ")}`),e.skipped&&e.skipped.length>0&&console.info(`[Year3000System] Skipped systems: ${e.skipped.join(", ")}`),e.success.length>0&&console.info(`[Year3000System] Successful systems: ${e.success.join(", ")}`),this.systemHealthMonitor&&this.systemHealthMonitor.logHealthReport())}async _initializeEssentialFacadeSystems(){if(!this.facadeCoordinator)throw new Error("Facade coordinator not available for essential system initialization");this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing essential systems for degraded mode...");try{let t=["SimplePerformanceCoordinator","CSSVariableWriter","UnifiedDebugManager","DeviceCapabilityDetector","TimerConsolidationSystem"];for(let e of t)try{let i=await this.facadeCoordinator.getNonVisualSystem(e);i&&typeof i.initialize=="function"&&(await i.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] Essential: Initialized ${e} via facade`))}catch(i){console.error(`\u{1F30C} [Year3000System] Failed to initialize essential ${e}:`,i)}this.performanceAnalyzer&&(this.performanceAnalyzer.startMonitoring(),this.performanceGuardActive=!0,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Essential: Performance monitoring started"))}catch(t){throw console.error("\u{1F30C} [Year3000System] Essential facade system initialization failed:",t),t}}async _initializeFacadeSystems(){if(!this.facadeCoordinator)throw new Error("Facade coordinator not available for system initialization");this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing essential systems through facades...");try{let t=["SimplePerformanceCoordinator","UnifiedDebugManager","SettingsManager","DeviceCapabilityDetector","TimerConsolidationSystem"],e=["CSSVariableWriter","UnifiedPerformanceCoordinator"],i=["MusicSyncService","ColorHarmonyEngine","MusicEmotionAnalyzer"],r=["GlassmorphismManager","Card3DManager"];this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing foundation systems in parallel...");let a=t.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(a),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing dependent systems in parallel...");let n=e.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(n),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing event-driven systems in parallel...");let s=i.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(s),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing UI systems in parallel...");let l=r.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(l),this.performanceAnalyzer&&(this.performanceAnalyzer.startMonitoring(),this.performanceGuardActive=!0,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Performance monitoring started"));let c=["Particle","WebGLBackground","SpotifyUIApplication","OrganicBeatSync","HeaderVisualEffects","InteractionTracking"];this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing visual systems in parallel...");let m=c.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=this.facadeCoordinator.getVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 Visual ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize visual ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(m),await this._linkSystemDependencies(),await this._validateFacadeIntegration(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Facade system initialization complete")}catch(t){throw console.error("\u{1F30C} [Year3000System] Facade system initialization failed:",t),t}}async _validateFacadeIntegration(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F50D} [Year3000System] Performing facade integration validation...");let t={cssControllerAlias:!1,strategyPatternSystems:!1,parallelInitialization:!1,facadeHealthCheck:!1,errors:[]};try{if(this.facadeCoordinator){try{await this.facadeCoordinator.getNonVisualSystem("CSSVariableWriter")?(t.cssControllerAlias=!0,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u2713 [Validation] CSS Controller registration working")):t.errors.push("CSS Controller registration failed")}catch(s){t.errors.push(`CSS Controller validation error: ${s}`)}let r=["ColorHarmonyEngine","MusicEmotionAnalyzer"],a=0;for(let s of r)try{await this.facadeCoordinator.getNonVisualSystem(s)&&a++}catch(l){t.errors.push(`Strategy system ${s} not found: ${l}`)}t.strategyPatternSystems=a===r.length,t.strategyPatternSystems&&this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u2713 [Validation] Strategy pattern systems registration working");let n=performance.now();try{let s=await this.facadeCoordinator.getNonVisualSystem("PerformanceAnalyzer"),c=performance.now()-n;t.parallelInitialization=c<100,t.parallelInitialization&&this.ADVANCED_SYSTEM_CONFIG.enableDebug?console.log(`\u2713 [Validation] Parallel initialization optimization working (${c.toFixed(2)}ms)`):this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.warn(`\u26A0 [Validation] Initialization may be slow (${c.toFixed(2)}ms)`)}catch(s){t.errors.push(`Parallel initialization test failed: ${s}`)}try{let s=await this.facadeCoordinator.performHealthCheck();t.facadeHealthCheck=s.overall==="excellent"||s.overall==="good",t.facadeHealthCheck&&this.ADVANCED_SYSTEM_CONFIG.enableDebug?console.log(`\u2713 [Validation] Facade health check passed (${s.overall})`):(t.errors.push(`Facade health check failed: ${s.overall}`),s.recommendations?.length>0&&console.warn("\u{1F527} [Validation] Health recommendations:",s.recommendations))}catch(s){t.errors.push(`Facade health check error: ${s}`)}}else t.errors.push("Facade coordinator not available for validation");let e=4,i=[t.cssControllerAlias,t.strategyPatternSystems,t.parallelInitialization,t.facadeHealthCheck].filter(Boolean).length;this.ADVANCED_SYSTEM_CONFIG.enableDebug&&(console.log(`\u{1F50D} [Year3000System] Facade validation complete: ${i}/${e} tests passed`),t.errors.length>0&&console.warn("\u26A0 [Year3000System] Validation errors:",t.errors),i===e&&console.log("\u{1F389} [Year3000System] All facade integration fixes validated successfully!")),window.Y3K_FACADE_VALIDATION=t}catch(e){console.error("\u{1F50D} [Year3000System] Facade validation failed:",e),t.errors.push(`Validation process error: ${e}`)}}async _linkSystemDependencies(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Linking system dependencies...");try{if(this.musicSyncService&&this.colorHarmonyEngine&&(this.musicSyncService.setColorHarmonyEngine(this.colorHarmonyEngine),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] ColorHarmonyEngine linked to MusicSyncService")),this.colorHarmonyEngine&&this.enhancedMasterAnimationCoordinator&&(this.colorHarmonyEngine.setEmergentEngine(this.enhancedMasterAnimationCoordinator),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] AnimationFrameCoordinator (with adaptive functionality) linked to ColorHarmonyEngine")),this.systemHealthMonitor){let t=[{name:"MusicSyncService",system:this.musicSyncService},{name:"ColorHarmonyEngine",system:this.colorHarmonyEngine}];for(let{name:e,system:i}of t)i&&this.systemHealthMonitor.registerSystem(e,i);this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Systems registered with health monitor")}}catch(t){console.error("\u{1F30C} [Year3000System] Failed to link system dependencies:",t)}}_shouldSkipPredictionSystem(t){return!1}async _initializeVisualSystems(t){if(!this.performanceAnalyzer||!this.musicSyncService){console.error("[Year3000System] Cannot initialize visual systems due to missing core dependencies (SimplePerformanceCoordinator, MusicSyncService)."),["InteractionTrackingSystem","BeatSyncVisualSystem","SidebarSystemsIntegration"].forEach(i=>t.skipped.push(i));return}this.colorHarmonyEngine&&this.enhancedMasterAnimationCoordinator&&(this.colorHarmonyEngine.setEmergentEngine(this.enhancedMasterAnimationCoordinator),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F517} [Year3000System] AnimationFrameCoordinator (adaptive functionality) linked to ColorHarmonyEngine."))}async destroyAllSystems(){this.facadeCoordinator&&(await this.facadeCoordinator.destroy(),this.facadeCoordinator=null),this._initializationResults=null,Spicetify.Player&&this._songChangeHandler&&Spicetify.Player.removeEventListener("songchange",this._songChangeHandler),this.initialized=!1,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F525} [Year3000System] All systems have been destroyed."),document.removeEventListener("year3000SystemSettingsChanged",this._boundExternalSettingsHandler),document.removeEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),document.removeEventListener("visibilitychange",this._boundVisibilityChangeHandler),this._disposeNowPlayingWatcher&&(this._disposeNowPlayingWatcher(),this._disposeNowPlayingWatcher=null)}async applyInitialSettings(t){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F3A8} [Year3000System] Inside applyInitialSettings. Trigger: ${t||"full"}`);try{if(t==="flavor"||t==="brightness"||t==="accent"){console.log(`\u{1F3A8} [Year3000System] Selective update for trigger: ${t}`),await this.updateColorStateOnly(t),await this.refreshColorDependentSystems(t);return}if(console.log("\u{1F3A8} [Year3000System] applyInitialSettings: Getting initial settings..."),this.colorStateManager&&!this.colorStateManager.initialized&&(console.log("\u{1F3A8} [Year3000System] Initializing ColorStateManager..."),await this.colorStateManager.initialize()),this.colorStateManager?.initialized)console.log("\u{1F3A8} [Year3000System] Applying initial color state via ColorStateManager..."),await this.colorStateManager.applyInitialColorState();else{console.warn("\u{1F3A8} [Year3000System] ColorStateManager not available, using legacy color application");let s=E.get("catppuccin-accentColor");s!=="dynamic"&&await this._applyCatppuccinAccent(s)}let e=E.get("sn-gradient-intensity"),i=e,r=E.get("sn-harmonic-intensity"),a=E.get("sn-harmonic-evolution"),n=E.get("sn-current-harmonic-mode");n&&(this.ADVANCED_SYSTEM_CONFIG.currentColorHarmonyMode=String(n)),console.log(`\u{1F3A8} [Year3000System] applyInitialSettings: Gradient=${e}, Stars=${i}, ColorState=${!!this.colorStateManager?.initialized}`),await this._applyStarryNightSettings(e,i),Number.isNaN(r)||(this.colorHarmonyEngine&&this.colorHarmonyEngine.setIntensity?.(r),this.ADVANCED_SYSTEM_CONFIG.colorHarmonyIntensity=r),this.allowHarmonicEvolution=a,this.ADVANCED_SYSTEM_CONFIG.colorHarmonyEvolution=a,console.log("\u{1F3A8} [Year3000System] applyInitialSettings: Successfully applied initial settings.")}catch(e){console.error("[Year3000System] Error applying initial settings:",e)}}async updateColorStateOnly(t){if(!this.colorStateManager?.initialized){console.warn(`\u{1F3A8} [Year3000System] ColorStateManager not available for ${t} update`);return}console.log(`\u{1F3A8} [Year3000System] Updating color state for trigger: ${t}`),await this.colorStateManager.updateColorState(t)}async refreshColorDependentSystems(t){if(!this.facadeCoordinator){console.warn(`\u{1F3A8} [Year3000System] No facade coordinator available for ${t} refresh`);return}console.log(`\u{1F3A8} [Year3000System] Refreshing color-dependent systems for trigger: ${t}`),await this.facadeCoordinator.refreshColorDependentSystems(t)}async _applyCatppuccinAccent(t){if(t==="dynamic"){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] _applyCatppuccinAccent: 'dynamic' accent selected \u2013 skipping static accent overrides.");return}console.log(`\u{1F3A8} [Year3000System] _applyCatppuccinAccent: Applying accent color '${t}'`);let e=t==="none"?"text":t,i=Spicetify.Config.color_scheme||"mocha",r=document.querySelector("body > script.marketplaceScript")?`url('https://github.com/catppuccin/spicetify/blob/main/catppuccin/assets/${i}/equalizer-animated-${e}.gif?raw=true')`:`url('${i}/equalizer-animated-${e}.gif')`;this.cssVariableController?.queueCSSVariableUpdate("--spice-text",`var(--spice-${e})`),this.cssVariableController?.queueCSSVariableUpdate("--spice-button-active",`var(--spice-${e})`),this.cssVariableController?.queueCSSVariableUpdate("--spice-equalizer",r),this.cssVariableController?.flushCSSVariableBatch(),console.log("\u{1F3A8} [Year3000System] _applyCatppuccinAccent: Flushed CSS variables for accent color.")}async _applyStarryNightSettings(t,e){try{Ut(t,e)}catch{console.error("[Year3000System] Failed to apply starry night settings")}}applyColorsToTheme(t={}){let e=t;if(this.colorHarmonyEngine)try{e=this.colorHarmonyEngine.blendWithCatppuccin(t)}catch(a){console.error("[Year3000System] ColorHarmonyEngine blend failed:",a)}let i=e.accentHex||e.VIBRANT||e.PROMINENT||Object.values(e)[0]||"#37416b",r=e.accentRgb||(()=>{let a=this.utils.hexToRgb(i);return a?`${a.r},${a.g},${a.b}`:"166,173,200"})();this._applyColorsViaFacadeSystem(e,i,r)}handleColorHarmonizedEvent(t){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.warn("\u26A0\uFE0F [ThemeLifecycleCoordinator] handleColorHarmonizedEvent called directly - this is deprecated")}_handleColorHarmonizedEvent_DEPRECATED(t){}_generateEventHash(t){return""}_resetColorEventState(){}_resetProcessingState(){}_applyColorsViaFacadeSystem(t,e,i){try{let r={};Object.entries(t).forEach(([n,s])=>{if(this.utils.isValidHexColor(s)){let l=this.utils.hexToRgb(s);l&&(r[`--sn-processed-${n.toLowerCase()}-hex`]=s,r[`--sn-processed-${n.toLowerCase()}-rgb`]=`${l.r},${l.g},${l.b}`)}else this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.debug(`[Year3000System] Skipping non-hex processedColor: ${n}=${s}`)});let a={"--sn-musical-harmony-primary-rgb":t.VIBRANT||t.PRIMARY||i,"--sn-musical-harmony-secondary-rgb":t.DARK_VIBRANT||t.SECONDARY||i,"--sn-musical-harmony-tertiary-rgb":t.VIBRANT_NON_ALARMING||t.LIGHT_VIBRANT||i,"--sn-musical-harmony-quaternary-rgb":t.DESATURATED||t.EMOTIONAL_BLEND||i,"--sn-musical-harmony-primary-hex":t.VIBRANT||t.PRIMARY||e,"--sn-musical-harmony-secondary-hex":t.DARK_VIBRANT||t.SECONDARY||e,"--sn-musical-harmony-tertiary-hex":t.VIBRANT_NON_ALARMING||t.LIGHT_VIBRANT||e,"--sn-musical-harmony-quaternary-hex":t.DESATURATED||t.EMOTIONAL_BLEND||e,"--sn-musical-oklab-primary-rgb":t.VIBRANT||t.PRIMARY||t.PROMINENT||i,"--sn-musical-oklab-accent-rgb":t.DARK_VIBRANT||t.DESATURATED||i,"--sn-musical-oklab-highlight-rgb":t.VIBRANT_NON_ALARMING||t.LIGHT_VIBRANT||i,"--sn-musical-oklab-shadow-rgb":t.DARK_VIBRANT||t.DESATURATED||i,"--sn-musical-oklab-complementary-rgb":t.SECONDARY||t.EMOTIONAL_BLEND||i,"--sn-musical-oklab-triadic-rgb":t.LIGHT_VIBRANT||t.VIBRANT_NON_ALARMING||i};Object.entries(a).forEach(([n,s])=>{if(!(!s||typeof s!="string")){if(n.includes("-hex"))r[n]=s;else if(n.includes("-rgb"))if(this.utils.isValidHexColor(s)){let l=this.utils.hexToRgb(s);l&&(r[n]=`${l.r},${l.g},${l.b}`)}else s.includes(",")&&(r[n]=s)}}),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Musical Harmony Color Processing:",{colorHarmonyKeys:Object.keys(t),colorHarmonyValues:t,musicalHarmonyVariables:a,expectedCSSChain:["--sn-musical-oklab-primary-rgb","--sn-musical-harmony-primary-rgb","--sn-gradient-primary-rgb"],totalVariablesSet:Object.keys(r).length,cssAuthorityDelegation:"ColorStateManager + DynamicCatppuccinBridge"}),this.cssVariableController&&typeof this.cssVariableController.batchSetVariables=="function"?this.cssVariableController.batchSetVariables("Year3000System-ColorHarmonized",r,"high","color-harmony-event-application"):this._applyCSSVariables(r),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F527} [Year3000System] Applied musical harmony variables via CSS coordination:",{totalVariables:Object.keys(r).length,accentColor:e,cssControllerUsed:!!this.cssVariableController,spicetifyDelegation:"ColorStateManager + DynamicCatppuccinBridge handle --spice-* variables"})}catch(r){console.error("[Year3000System] Failed to apply musical harmony variables:",r);let a={"--sn-musical-harmony-primary-hex":e,"--sn-musical-harmony-primary-rgb":i};this._applyCSSVariables(a)}}_applyCSSVariables(t){try{let e=document.documentElement;for(let[i,r]of Object.entries(t))i&&r&&e.style.setProperty(i,r);this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Applied CSS variables directly",{variablesCount:Object.keys(t).length,variables:Object.keys(t)})}catch(e){console.error("[Year3000System] Failed to apply CSS variables:",e)}}queueCSSVariableUpdate(t,e,i=null){this.unifiedCSSManager?this.unifiedCSSManager.queueUpdate(t,e,"normal","Year3000System"):this.cssVariableController?this.cssVariableController.queueCSSVariableUpdate(t,e,i||void 0):(i||document.documentElement).style.setProperty(t,e)}setGradientParameters(){this.colorHarmonyEngine}async updateColorsFromCurrentTrack(){this.musicSyncService&&await this.musicSyncService.processSongUpdate()}evolveHarmonicSignature(t,e){if(this.colorHarmonyEngine){let i=this.utils.hexToRgb(e);if(i){let r=this.colorHarmonyEngine.generateHarmonicVariations(i);return{derivedDarkVibrantHex:r.darkVibrantHex,derivedLightVibrantHex:r.lightVibrantHex}}}return null}async waitForTrackData(t=10,e=100){for(let i=0;i<t;i++){if(Spicetify.Player.data?.track?.uri)return Spicetify.Player.data;await this.utils.sleep(e)}return null}updateHarmonicBaseColor(t){if(this.colorHarmonyEngine&&this.cssVariableController){let e=this.utils.hexToRgb(t);if(e){let i=this.colorHarmonyEngine.generateHarmonicVariations(e);this.cssVariableController.queueCSSVariableUpdate("--sn-harmonic-base-dark-vibrant",i.darkVibrantHex),this.cssVariableController.queueCSSVariableUpdate("--sn-harmonic-base-light-vibrant",i.lightVibrantHex),this.cssVariableController.flushCSSVariableBatch()}}}async processColorsViaFacade(t){try{let e=await this.facadeCoordinator?.getNonVisualSystem("ColorOrchestrator");e&&typeof e.handleColorExtraction=="function"?(await e.handleColorExtraction(t),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Color processing routed through facade pattern - ColorOrchestrator",{context:t?.trackUri||"unknown",rawColorsCount:t?.rawColors?Object.keys(t.rawColors).length:0})):this.colorHarmonyEngine&&typeof this.colorHarmonyEngine.processColors=="function"?(await this.colorHarmonyEngine.processColors(t),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Color processing fallback to direct ColorHarmonyEngine")):console.warn("[Year3000System] No color processing system available via facade pattern")}catch(e){console.error("[Year3000System] Failed to process colors via facade pattern:",e),t?.rawColors&&this.applyColorsToTheme(t.rawColors)}}setupMusicAnalysisAndColorExtraction(){if(console.log("\u{1F3B5} [Year3000System] setupMusicAnalysisAndColorExtraction called"),!this.musicSyncService){console.error("[Year3000System] MusicSyncService is not available to set up song change handler.");return}if(console.log("\u{1F3B5} [Year3000System] MusicSyncService available, checking Spicetify Player..."),!window.Spicetify?.Player){console.warn("[Year3000System] Spicetify.Player not available - music analysis disabled");return}this.colorEventCoordinator=new Hi({maxChainLength:this.MAX_CHAIN_LENGTH,processingTimeout:this.PROCESSING_TIMEOUT,colorEventCacheTTL:this.COLOR_EVENT_CACHE_TTL,enableDebug:this.ADVANCED_SYSTEM_CONFIG.enableDebug,onApplyColors:(e,i,r)=>{this._applyColorsViaFacadeSystem(e,i,r)}}),this.colorEventCoordinator.startListening();let t=async()=>{console.log("\u{1F3B5} [Year3000System] processSongUpdate triggered - checking MusicSyncService..."),this.musicSyncService?(console.log("\u{1F3B5} [Year3000System] Calling musicSyncService.processSongUpdate()"),await this.musicSyncService.processSongUpdate(),console.log("\u2705 [Year3000System] musicSyncService.processSongUpdate() completed")):console.error("\u274C [Year3000System] MusicSyncService not available in processSongUpdate")};this._songChangeHandler=t;try{console.log("\u{1F3B5} [Year3000System] Adding songchange event listener..."),window.Spicetify.Player.addEventListener("songchange",this._songChangeHandler),console.log("\u2705 [Year3000System] Music analysis and color extraction set up successfully - song change listener active"),console.log("\u{1F3B5} [Year3000System] Triggering initial song processing..."),setTimeout(t,1e3)}catch(e){console.error("[Year3000System] Failed to set up music analysis:",e),this._songChangeHandler=null}}updateFromMusicAnalysis(t,e,i){t&&this._updateGlobalKinetics(t)}_updateGlobalKinetics(t){let e=this.utils.getRootStyle();if(!e)return;let i=(c,m=0)=>Number.isFinite(c)?c:m,r=i(t.processedEnergy),a=i(t.valence),n=i(t.enhancedBPM),s=i(t.beatInterval),l=i(t.animationSpeedFactor,1);e.style.setProperty("--sn-kinetic-energy",r.toFixed(3)),e.style.setProperty("--sn-kinetic-valence",a.toFixed(3)),e.style.setProperty("--sn-kinetic-bpm",n.toFixed(2)),e.style.setProperty("--sn-kinetic-beat-interval",`${s.toFixed(0)}ms`),e.style.setProperty("--sn-kinetic-animation-speed",l.toFixed(3))}registerAnimationSystem(t,e,i="normal",r=60){return this.enhancedMasterAnimationCoordinator?(this.enhancedMasterAnimationCoordinator.registerAnimationSystem(t,e,i,r),!0):(console.warn(`[Year3000System] Cannot register ${t} - AnimationFrameCoordinator not ready`),!1)}unregisterAnimationSystem(t){return this.enhancedMasterAnimationCoordinator?(this.enhancedMasterAnimationCoordinator.unregisterAnimationSystem(t),!0):!1}getSystem(t){if(!t)return null;if(this.facadeCoordinator){let i=this.facadeCoordinator.getVisualSystem(t);if(i)return i;let r=this.facadeCoordinator.getCachedNonVisualSystem(t);if(r)return r}let e=t.charAt(0).toLowerCase()+t.slice(1);if(this[e])return this[e];for(let i of Object.keys(this)){let r=this[i];if(r&&r.constructor?.name===t)return r}return null}async getFacadeSystemHealthStatus(){return this.facadeCoordinator?await this.facadeCoordinator.performHealthCheck():null}async _registerAnimationSystems(){if(!this.enhancedMasterAnimationCoordinator){console.warn("[Year3000System] AnimationFrameCoordinator not available for visual system registration");return}let t=[{name:"BeatSyncVisualSystem",system:this.beatSyncVisualSystem,priority:"critical"},{name:"SidebarSystemsIntegration",system:this.sidebarSystemsIntegration,priority:"normal"},{name:"ParticleConsciousnessModule",system:this.particleVisualEffectsModule,priority:"background"},{name:"InteractionTrackingSystem",system:this.interactionTrackingSystem,priority:"background"},{name:"SpotifyUIApplicationSystem",system:this.spotifyUIApplicationSystem,priority:"normal"}];for(let{name:e,system:i,priority:r}of t)if(i&&(typeof i.onAnimate=="function"||typeof i.updateAnimation=="function")){let a=r,n=60,s=i.currentPerformanceProfile;if(s?.frameRate)n=s.frameRate;else if(s?.quality){let l=s.quality;n=l==="high"?60:l==="low"?30:45}e.includes("BeatSync")?a="critical":(e.includes("Particle")||e.includes("DataGlyph"))&&(a="background",n=Math.min(n,30)),this.enhancedMasterAnimationCoordinator.registerAnimationSystem(e,i,a,n),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log(`\u{1F3AC} [Year3000System] Registered ${e} with Enhanced Master Animation Coordinator (${a} priority, ${n}fps) - using ${typeof i.onAnimate=="function"?"onAnimate":"updateAnimation"} hook`)}}async _registerEnhancedAnimationSystems(){if(!this.enhancedMasterAnimationCoordinator){console.warn("[Year3000System] AnimationFrameCoordinator not available for enhanced visual system registration");return}let t=[{name:"BeatSyncVisualSystem",system:this.beatSyncVisualSystem,priority:"critical",type:"animation"},{name:"SidebarSystemsIntegration",system:this.sidebarSystemsIntegration,priority:"normal",type:"animation"},{name:"ParticleConsciousnessModule",system:this.particleVisualEffectsModule,priority:"background",type:"animation"},{name:"InteractionTrackingSystem",system:this.interactionTrackingSystem,priority:"background",type:"animation"},{name:"SpotifyUIApplicationSystem",system:this.spotifyUIApplicationSystem,priority:"normal",type:"animation"}];for(let{name:e,system:i,priority:r,type:a}of t)if(i)try{let n=!1;a==="animation"&&(typeof i.onAnimate=="function"||typeof i.updateAnimation=="function")&&(n=this.enhancedMasterAnimationCoordinator.registerAnimationSystem(e,i,r,60)),n&&this.ADVANCED_SYSTEM_CONFIG.enableDebug?console.log(`\u{1F3AC} [Year3000System] Enhanced registration: ${e} (${r} priority, ${a} type)`):n||console.warn(`[Year3000System] Failed to register ${e} with AnimationFrameCoordinator`)}catch(n){console.error(`[Year3000System] Error registering ${e} with AnimationFrameCoordinator:`,n)}}async initializeWithAvailableAPIs(t){this.availableAPIs=t,this.ADVANCED_SYSTEM_CONFIG.enableDebug&&(console.log(`\u{1F31F} [Year3000System] Progressive initialization mode: ${t.degradedMode?"DEGRADED":"FULL"}`),console.log("\u{1F31F} [Year3000System] Available APIs:",{player:!!t.player,platform:!!t.platform,config:!!t.config})),t.degradedMode?(console.log("\u{1F31F} [Year3000System] Initializing in degraded mode (visual-only systems)"),await this.initializeVisualOnlySystems()):(console.log("\u{1F31F} [Year3000System] Initializing in full mode (all systems)"),await this.initializeAllSystems()),t.degradedMode&&this.setupProgressiveEnhancement()}async initializeVisualOnlySystems(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Starting visual-only system initialization...");let t=performance.now(),e={success:[],failed:[],skipped:[]};try{this.facadeCoordinator=new Ot(this.ADVANCED_SYSTEM_CONFIG,this.utils,this),await this.facadeCoordinator.initialize({mode:"performance-optimized",enableSharedDependencies:!0,enableCrossFacadeCommunication:!1,enableUnifiedPerformanceMonitoring:!0,enableResourceOptimization:!0,performanceThresholds:{maxTotalMemoryMB:50,maxTotalInitTime:3e3,maxCrossCommLatency:100},coordinationPreferences:{preferSharedResources:!0,enableEventPropagation:!1,enableHealthCoordination:!0}}),await this._initializeEssentialFacadeSystems(),e.success.push("FacadeCoordinationSystem")}catch(n){console.error("\u{1F30C} [Year3000System] Failed to initialize degraded facade system:",n),e.failed.push("FacadeCoordinationSystem")}let i=["SettingsManager","MusicSyncService","ColorHarmonyEngine","GlassmorphismManager","Card3DManager","All Visual Systems"];e.skipped.push(...i),this._initializationResults=e,this.initialized=!0;let a=performance.now()-t;this.ADVANCED_SYSTEM_CONFIG.enableDebug&&(console.log(`\u{1F31F} [Year3000System] Visual-only initialization complete in ${a.toFixed(2)}ms`),console.log(`\u{1F31F} [Year3000System] Results: ${e.success.length} success, ${e.failed.length} failed, ${e.skipped.length} skipped`))}setupProgressiveEnhancement(){this.degradedModeCoordinator=new Bi({maxUpgradeAttempts:30,upgradeCheckInterval:1e4,enableDebug:this.ADVANCED_SYSTEM_CONFIG.enableDebug,onAPIsAvailable:async t=>{await this.upgradeToFullMode()},onStatusUpdate:(t,e)=>{}}),this.degradedModeCoordinator.startMonitoring()}async upgradeToFullMode(){this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Upgrading from degraded mode to full mode..."),this.availableAPIs={player:window.Spicetify?.Player,platform:window.Spicetify?.Platform,config:window.Spicetify?.Config,degradedMode:!1};try{let t={success:[],failed:[],skipped:[]};if(this.performanceAnalyzer){try{}catch{}this.enhancedMasterAnimationCoordinator&&await this._registerAnimationSystems()}this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("[Year3000System] Checking music analysis setup conditions:",{musicSyncService:!!this.musicSyncService,playerAPI:!!this.availableAPIs.player,musicSyncInitialized:this.musicSyncService?.initialized}),this.musicSyncService&&this.availableAPIs.player?(console.log("\u{1F3B5} [Year3000System] Setting up music analysis and color extraction..."),this.setupMusicAnalysisAndColorExtraction()):console.warn("\u26A0\uFE0F [Year3000System] Music analysis setup skipped - missing dependencies:",{musicSyncService:!!this.musicSyncService,playerAPI:!!this.availableAPIs.player}),await this.applyInitialSettings(),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&(console.log(`\u{1F31F} [Year3000System] Upgrade complete: ${t.success.length} success, ${t.failed.length} failed`),t.failed.length>0&&console.warn(`\u{1F31F} [Year3000System] Upgrade failed systems: ${t.failed.join(", ")}`),t.skipped&&t.skipped.length>0&&console.info(`\u{1F31F} [Year3000System] Upgrade skipped systems: ${t.skipped.join(", ")}`),t.success.length>0&&console.info(`\u{1F31F} [Year3000System] Upgrade successful systems: ${t.success.join(", ")}`))}catch(t){console.error("[Year3000System] Error during upgrade to full mode:",t)}}_handleExternalSettingsChange(t){let{key:e,value:i}=t.detail||{};if(e){switch(e){case"artisticMode":{try{typeof this.ADVANCED_SYSTEM_CONFIG.safeSetArtisticMode=="function"&&this.ADVANCED_SYSTEM_CONFIG.safeSetArtisticMode(i)}catch(r){console.warn("[Year3000System] Failed to apply artistic mode",r)}break}case"harmonicIntensity":{let r=parseFloat(i);Number.isNaN(r)||(this.ADVANCED_SYSTEM_CONFIG.colorHarmonyIntensity=r,this.colorHarmonyEngine&&(this.colorHarmonyEngine.setIntensity?.(r),this.updateColorsFromCurrentTrack?.()));break}case"harmonicEvolution":{let r=i==="true"||i===!0;this.allowHarmonicEvolution=r,this.ADVANCED_SYSTEM_CONFIG.colorHarmonyEvolution=r;break}case"manualBaseColor":{typeof i=="string"&&i.trim()!==""&&i.startsWith("#")?(this.updateHarmonicBaseColor(i),this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Manual base color applied:",i)):this.ADVANCED_SYSTEM_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Manual base color cleared - using album art colors");break}case"harmonicMode":{i!=null&&(this.ADVANCED_SYSTEM_CONFIG.currentColorHarmonyMode=String(i),this.updateColorsFromCurrentTrack?.());break}default:break}this._broadcastSettingChange(e,i),this._refreshConditionalSystems()}}_broadcastSettingChange(t,e){[this.colorHarmonyEngine,this.glassmorphismManager,this.card3DManager,this.lightweightParticleSystem,this.interactionTrackingSystem,this.beatSyncVisualSystem,this.sidebarSystemsIntegration,this.particleFieldSystem].forEach(r=>{if(r&&typeof r.applyUpdatedSettings=="function")try{r.applyUpdatedSettings(t,e)}catch(a){console.warn(`[Year3000System] ${r.systemName||r.constructor?.name||"UnknownSystem"} failed to applyUpdatedSettings`,a)}})}_applyPerformanceProfile(){}_refreshConditionalSystems(){}_onArtisticModeChanged(){try{this.updateColorsFromCurrentTrack?.()}catch(t){console.warn("[Year3000System] _onArtisticModeChanged stub error",t)}}_handleVisibilityChange(){if(document.visibilityState==="hidden")try{this.cssVariableController?.flushCSSVariableBatch?.();try{}catch{}this.ADVANCED_SYSTEM_CONFIG?.enableDebug&&console.log("\u{1F31F} [Year3000System] Visibility hidden \u2192 forced flush of pending style updates")}catch(t){this.ADVANCED_SYSTEM_CONFIG?.enableDebug&&console.warn("[Year3000System] VisibilityChange flush error",t)}}async destroy(){try{this.degradedModeCoordinator&&(this.degradedModeCoordinator.stopMonitoring(),this.degradedModeCoordinator=null),this.colorEventCoordinator&&(this.colorEventCoordinator.stopListening(),this.colorEventCoordinator=null),await this.destroyAllSystems(),document.removeEventListener("visibilitychange",this._handleVisibilityChange.bind(this)),this.initialized=!1,console.log("\u{1F31F} [AdvancedThemeSystem] System destroyed successfully")}catch(t){console.error("\u274C [AdvancedThemeSystem] Error during destroy:",t)}}},zi=new Nt;typeof window<"u"&&(window.themeLifecycleCoordinator=zi,window.year3000System=zi,window.advancedThemeSystem=zi);Hs=zi});var js={};ne(js,{enableDragCartography:()=>Ql,getDragMap:()=>Xl});function Ql(){let o=globalThis;o.__SN_dragCartographer||(o.__SN_dragCartographer=new Yi,console.info("\u{1F6F0}\uFE0F  DragCartographer enabled \u2013 logging dragstart events"))}function Xl(){return Yi.getDragMap()}var $e,Yi,Ks=v(()=>{"use strict";$e=class $e{constructor(){this.seen=new WeakSet;this.handleDragStart=t=>{let e=t.target;if(!e||this.seen.has(e))return;this.seen.add(e);let i=$e.buildSelectorPath(e),r={time:new Date().toLocaleTimeString(),selector:i};try{let s=t.dataTransfer;if(s){let l=s.getData("text/spotify")||s.getData("text/uri-list");l&&(r.uris=l.split(/\n|,/).filter(Boolean));let c=s.getData("text/plain");c&&(r.label=c)}}catch{}let a=$e.aggregate,n=a.get(i);n?(n.count+=1,n.samples.length<3&&n.samples.push(r)):a.set(i,{selector:i,count:1,samples:[r]}),console.groupCollapsed(`%c[DragCartographer] dragstart \u2192 ${i}`,"color:#7dd3fc;font-weight:600"),console.table(r),console.log("Event:",t),console.log("Target element snapshot:",e),console.groupEnd()};document.addEventListener("dragstart",this.handleDragStart,!0)}static buildSelectorPath(t){let e=[],i=t,r=0;for(;i&&r<$e.MAX_PATH_DEPTH;){let a=i.tagName.toLowerCase(),n=i.id?`#${i.id}`:"",s=i.className&&typeof i.className=="string"?"."+i.className.split(/\s+/).slice(0,2).join("."):"";e.push(`${a}${n}${s}`),i=i.parentElement,r+=1}return e.join(" > ")}static getDragMap(){return Array.from($e.aggregate.values()).sort((t,e)=>e.count-t.count)}};$e.MAX_PATH_DEPTH=4,$e.aggregate=new Map;Yi=$e});function Xs(o,t,e={}){let i=`${o}|${t}|${e.size}|${e.dpr}`,r=Qs.get(i);if(r)return r;let a=e.size??72,n=e.dpr??(window.devicePixelRatio||1),s=e.borderRadius??8,l=document.createElement("canvas");l.width=a*n,l.height=a*n,l.style.width=`${a}px`,l.style.height=`${a}px`;let c=l.getContext("2d");c.scale(n,n),c.fillStyle="rgba(32,32,35,0.9)",c.roundRect(0,0,a,a,s),c.fill(),e.shadow!==!1&&(c.shadowColor="rgba(0,0,0,0.4)",c.shadowBlur=6);let m=a-16;if(t){let h=new Image;h.src=t;let g=()=>{c.save(),c.beginPath(),c.roundRect(8,8,m,m,s-2),c.clip(),c.drawImage(h,8,8,m,m),c.restore(),d()};h.complete?g():(h.onload=g,h.onerror=d)}else d();function d(){c.fillStyle="#fff",c.font="500 12px Inter, sans-serif",c.textAlign="center",c.textBaseline="middle";let h=a-10,g=o;for(;c.measureText(g).width>h&&g.length>4;)g=g.slice(0,-2);g!==o&&(g=g.slice(0,-1)+"\u2026"),c.fillText(g,a/2,a-10)}return Qs.set(i,l),l}var Qs,Zs=v(()=>{"use strict";Qs=new Map});var eo={};ne(eo,{enableEnhancedDragPreview:()=>rc});function Jl(o,t){try{return Xs(o,t)}catch{let e=document.createElement("div");return e.textContent=o,e.style.padding="4px 6px",e.style.fontSize="12px",e.style.background="rgba(32,32,35,0.9)",e.style.color="#fff",e}}function Js(o){let t=o.querySelector("img[src]");if(t?.src)return t.src;let e=getComputedStyle(o).backgroundImage,i=e&&/url\("?([^\"]+)"?\)/.exec(e);return i?i[1]:void 0}function ec(o){let t=o.getAttribute("aria-label")||o.getAttribute("title");return t||(document.createTreeWalker(o,NodeFilter.SHOW_TEXT,{acceptNode(r){return r.textContent?.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}}).nextNode()?.textContent?.trim()||"").slice(0,60)}function tc(o){if(Ra.has(o))return Ra.get(o);let t=ec(o);if(!t)return null;let e=Js(o),i=e?{label:t,img:e}:{label:t};return Ra.set(o,i),i}function ic(o){try{if(!o.dataTransfer||typeof o.dataTransfer.setDragImage!="function")return;let t=o.target;if(!t)return;let e=o.dataTransfer.getData("text/plain"),i;if(e)i=Js(t);else{let s=tc(t);if(!s)return;e=s.label,i=s.img}let r=Jl(e,i);document.body.appendChild(r);let a=r.offsetWidth/2;o.dataTransfer.setDragImage(r,a,a);let n=()=>{r.remove(),window.removeEventListener("dragend",n,!0)};window.addEventListener("dragend",n,!0)}catch(t){console.debug("[StarryNight] DragPreviewManager failed:",t)}}function rc(o={}){let t=globalThis;t.__SN_enhancedDragPreview||(t.__SN_enhancedDragPreview=!0,Object.assign(Zl,o),document.addEventListener("dragstart",ic,!0),console.info("\u{1F320} Enhanced drag preview enabled"))}var Zl,Ra,to=v(()=>{"use strict";Zs();Zl={size:72,borderRadius:8,fontSize:12},Ra=new WeakMap});function ji(o){let t=o.stiffness??260,e=o.damping??24,i=o.mass??1,r={},a={},n={},s=null;function l(){let c=!0,m=1/60;for(let d in n){let h=r[d]??0,g=a[d]??0,f=n[d]??0,S=-t*(h-f),C=-e*g,x=(S+C)/i,M=g+x*m,V=h+M*m;a[d]=M,r[d]=V,(Math.abs(M)>.1||Math.abs(V-f)>.1)&&(c=!1)}o.onUpdate(r),c||(s=requestAnimationFrame(l))}return{to(c){n=c,s||(s=requestAnimationFrame(l))}}}var ka=v(()=>{"use strict";window.snFlipSpringLoaded=!0});function Va(){let o=document.querySelector(ac);if(!o)return null;let t=o.getBoundingClientRect();return{node:o,rect:t}}function Fa(){let o=!!Va(),t=typeof Element.prototype.cloneNode=="function",e=!!window.snFlipSpringLoaded;return o&&t&&e}var ac,Ga=v(()=>{"use strict";ac='[data-testid="rootlist-container"]'});var ao={};ne(ao,{destroySidebarClone:()=>Ki,launchSidebarClone:()=>nc});function nc(o){qe&&(qe.abort(),qe=null),We&&Ki(),qe=new AbortController;let{signal:t}=qe;if(We)return;let e=Va();if(!e)return;let i=e.node.cloneNode(!0);i.id="",i.setAttribute("aria-hidden","true"),i.classList.add("sn-clone-overlay"),i.style.position="fixed",i.style.top=`${e.rect.top}px`,i.style.left=`${e.rect.left}px`,i.style.width=`${e.rect.width}px`,i.style.height=`${e.rect.height}px`,i.style.zIndex="9999",i.style.willChange="transform, opacity",i.style.contain="paint",function(f){let S=document.createTreeWalker(f,NodeFilter.SHOW_ELEMENT);for(;S.nextNode();){let C=S.currentNode;C.hasAttribute("aria-label")&&C.removeAttribute("aria-label"),C.tabIndex>=0&&(C.tabIndex=-1)}}(i),document.body.appendChild(i),We=i;let r=0,a=0,n=1,s=o.cursorX-e.rect.left-e.rect.width*.2,l=o.cursorY-e.rect.top-e.rect.height*.2,c=.6;if(window.matchMedia("(prefers-reduced-motion: reduce)").matches){i.style.transform=`translate(${s}px, ${l}px) scale(${c})`,ro(i,o);return}let d=ji({stiffness:220,damping:20,onUpdate:g=>{t.aborted||(i.style.transform=`translate(${g.x}px, ${g.y}px) scale(${g.s})`)}});i.style.transformOrigin="top left",i.style.transform=`translate(${r}px, ${a}px) scale(${n})`,requestAnimationFrame(()=>d.to({x:s,y:l,s:c}));let h=setTimeout(()=>{!t.aborted&&We&&ro(We,o)},400);t.addEventListener("abort",()=>clearTimeout(h)),t.addEventListener("abort",()=>Ki())}function Ki(){_a.forEach(o=>o()),_a.length=0,We&&(We.remove(),We=null),qe&&(qe.abort(),qe=null)}function sc(o,t){try{let e=window.Spicetify?.CosmosAsync;if(!e)return;let i=`/v1/playlists/${o.split(":").pop()}/tracks`;e.post(i,{uris:t})}catch{}}function ro(o,t){let e=Array.from(o.querySelectorAll('[data-uri^="spotify:playlist:"]'));if(!e.length)return;let i=e.slice(0,5);e.slice(5).forEach(a=>{a.classList.add("sn-prune-out"),setTimeout(()=>a.remove(),180)}),i.forEach((a,n)=>{a.setAttribute("data-index",String(n+1)),a.setAttribute("role","button"),a.tabIndex=0,a.style.setProperty("--sn-glow-level","0"),a.style.backgroundImage="paint(sn-aura)",a.addEventListener("mouseenter",()=>a.style.setProperty("--sn-glow-level","1")),a.addEventListener("mouseleave",()=>a.style.setProperty("--sn-glow-level","0"));let s=a.getAttribute("data-uri");if(!s)return;let l=t.uris,c=m=>{m.preventDefault(),m.stopPropagation();let d=a.querySelector("img");oc(s,d?.src||"",a.textContent?.trim()||"Playlist"),sc(s,l),lc("Track added to "+(a.textContent?.trim()||"playlist")),Ki()};a.addEventListener("click",c),a.addEventListener("keydown",m=>{(m.key==="Enter"||m.key===" ")&&c(m)})});let r=a=>{let n=parseInt(a.key,10);n>=1&&n<=i.length&&i[n-1]?.click()};window.addEventListener("keydown",r,{capture:!0}),_a.push(()=>window.removeEventListener("keydown",r,{capture:!0}))}function oc(o,t,e){try{let i=localStorage.getItem(io),r=i?JSON.parse(i):[],a=r.findIndex(n=>n.uri===o);a!==-1&&r.splice(a,1),r.unshift({uri:o,image:t,name:e}),localStorage.setItem(io,JSON.stringify(r.slice(0,10)))}catch{}}function lc(o){let t=document.getElementById("sn-live");t&&(t.textContent=o)}var We,_a,qe,io,no=v(()=>{"use strict";ka();Ga();We=null,_a=[],qe=null,io="sn-recent-playlists"});var oo={};ne(oo,{enableQuickAddRadialMenu:()=>Ec});function mc(){let o=document.getElementById(Oa);return o||(o=document.createElement("div"),o.id=Oa,o.setAttribute("aria-live","polite"),o.style.position="absolute",o.style.width="1px",o.style.height="1px",o.style.overflow="hidden",o.style.clipPath="inset(100%)",o.style.clip="rect(1px,1px,1px,1px)",o.style.whiteSpace="nowrap",document.body.appendChild(o)),o}function dc(o,t,e,i){let r=o-e,a=t-i;return Math.sqrt(r*r+a*a)}function so(){try{let o=localStorage.getItem("sn-recent-playlists");if(!o)return[];let t=JSON.parse(o);return Array.isArray(t)?t.slice(0,Qi):[]}catch{return[]}}function hc(o,t){try{let e=`/v1/playlists/${o.split(":").pop()}/tracks`;window.Spicetify?.CosmosAsync.post(e,{uris:t})}catch(e){console.warn("[StarryNight] QuickAddRadial failed to add tracks:",e)}}function gc(o){try{let t=so(),e=t.findIndex(r=>r.uri===o.uri);e!==-1&&t.splice(e,1),t.unshift(o);let i=t.slice(0,10);localStorage.setItem("sn-recent-playlists",JSON.stringify(i))}catch{}}function pc(o,t,e){if(!e.length)return;Ua(),de=document.createElement("div"),de.className="sn-quick-add-overlay",de.style.position="fixed",de.style.inset="0",de.style.pointerEvents="none",de.style.zIndex="9999";let i=document.createElement("div");i.className="sn-quick-add-center",i.style.position="absolute",i.style.left=`${o}px`,i.style.top=`${t}px`,i.style.width="0",i.style.height="0",de.appendChild(i),document.body.appendChild(de);let r=90,a=Math.PI*2/e.length;e.forEach((s,l)=>{let c=a*l-Math.PI/2,m=document.createElement("button");m.className="sn-quick-add-btn",m.style.position="absolute",m.style.width="64px",m.style.height="64px",m.style.borderRadius="50%",m.style.border="2px solid rgba(255,255,255,0.4)",m.style.background=`url('${s.image}') center/cover no-repeat`,m.style.cursor="pointer",m.style.pointerEvents="auto";let d=r*Math.cos(c),h=r*Math.sin(c);m.style.transform=`translate(${d-32}px, ${h-32}px)`,m.style.transformOrigin="center center";let g=0,f=0;m.style.transform=`translate(${g}px, ${f}px) scale(0.1)`,requestAnimationFrame(()=>{ji({stiffness:220,damping:20,onUpdate:C=>{m.style.transform=`translate(${C.x}px, ${C.y}px) scale(${C.s})`}}).to({x:d-32,y:h-32,s:1})}),m.title=`Add to ${s.name}`,m.addEventListener("click",S=>{S.preventDefault(),S.stopPropagation(),qt&&hc(s.uri,qt),gc(s),Ua()}),i.appendChild(m)});let n=mc();n.textContent="Quick-add menu open. Press number keys 1 to 5 to pick a playlist or continue dragging."}function Ua(){de?.remove(),de=null;let o=document.getElementById(Oa);o&&(o.textContent="")}function Na(){Wt&&(clearTimeout(Wt),Wt=null)}function fc(o){Ba=o.clientX,Ha=o.clientY,qt=(o.dataTransfer?.getData("text/spotify")||"").split(/[\n,]/).filter(Boolean);let t=Fa();Na(),Wt=window.setTimeout(async()=>{if(t)(await Promise.resolve().then(()=>(no(),ao))).launchSidebarClone({cursorX:za.x,cursorY:za.y,uris:qt??[]});else{let e=await Cc();pc(Ba,Ha,e)}},cc)}function bc(){Na(),Ua(),qt=null}function yc(o){za={x:o.clientX,y:o.clientY},Wt&&dc(Ba,Ha,o.clientX,o.clientY)>uc&&Na()}async function vc(){try{let o=window.Spicetify?.CosmosAsync;if(!o)return[];let t=await o.get("https://api.spotify.com/v1/me/playlists?limit=10");return t?.items?t.items.slice(0,Qi).map(e=>({uri:e.uri,name:e.name,image:e.images?.[0]?.url||""})):[]}catch{return[]}}function Sc(){try{let o=Array.from(document.querySelectorAll('[data-testid="rootlist-card"]')),t=[];for(let e of o){let i=e.getAttribute("data-uri")||e.querySelector("a")?.getAttribute("href")?.replace("/playlist/","spotify:playlist:");if(!i)continue;let r=e.querySelector("img"),a=r?.src||"",n=r?.alt||e.textContent?.trim()||"Playlist";if(t.push({uri:i,image:a,name:n}),t.length>=Qi)break}return t}catch{return[]}}async function Cc(){let o=so();if(o.length)return o;let t=Sc();return t.length?t:await vc()}function Ec(){let o=globalThis;o.__SN_quickAddRadial||(o.__SN_quickAddRadial=!0,window.addEventListener("dragstart",fc,!0),window.addEventListener("dragend",bc,!0),window.addEventListener("pointermove",yc,!0),console.info("\u{1F30C} Quick-Add radial menu enabled"),console.info(`[StarryNight] Sidebar clone capability: ${Fa()}`))}var cc,uc,Qi,Wt,Ba,Ha,de,qt,za,Oa,lo=v(()=>{"use strict";ka();Ga();cc=250,uc=8,Qi=5,Wt=null,Ba=0,Ha=0,de=null,qt=null,za={x:0,y:0},Oa="sn-live";document.addEventListener("keydown",o=>{if(!de)return;let t=parseInt(o.key,10);t>=1&&t<=Qi&&de.querySelectorAll(".sn-quick-add-btn")[t-1]?.click()})});var uo={};ne(uo,{PrismaticScrollSheenSystem:()=>Xi,initializePrismaticScrollSheen:()=>co});function co(){try{let o=new Xi;Hs?.registerVisualSystem?.(o,"background")}catch(o){console.error("[PrismaticScrollSheen] Failed to init:",o)}}var wc,Xi,mo=v(()=>{"use strict";Ia();$();wc=6e3,Xi=class{constructor(t=wc){this.cyclePx=t;this.systemName="PrismaticScrollSheen";this._lastRatio=-1;let e=globalThis.year3000System;this.cssController=e?.cssController||A(),this.cssController.setVariable("PrismaticScrollSheenSystem","--sn-scroll-cycle-px",String(t),"normal","scroll-cycle-init")}onAnimate(t,e){let i=e.scrollRatio??0;if(Math.abs(i-this._lastRatio)<.001)return;this._lastRatio=i;let r={"--sn-cdf-scroll-ratio":i.toFixed(4),"--sn-scroll-ratio":i.toFixed(4)};this.cssController.batchSetVariables("PrismaticScrollSheenSystem",r,"high","scroll-ratio-update")}onPerformanceModeChange(){}destroy(){}};window.Y3K?.system?.registerVisualSystem&&co()});var Y,ho,Zi,go=v(()=>{"use strict";Y=ja(Ya("react")),ho=ja(Ya("react-dom")),Zi=class{constructor(t,e,i={}){this.name=t;this.settingsId=e;this.initialSettingsFields=i;this.settingsFields=this.initialSettingsFields;this.setRerender=null;this.pushSettings=async()=>{for(Object.entries(this.settingsFields).forEach(([t,e])=>{e.type!=="button"&&this.getFieldValue(t)===void 0&&this.setFieldValue(t,e.defaultValue)});!window.Spicetify?.Platform?.History?.listen;)await new Promise(t=>setTimeout(t,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=window.Spicetify.Platform.History.listen(t=>{t.pathname==="/preferences"&&this.render()}),window.Spicetify.Platform.History.location.pathname==="/preferences"&&await this.render()};this.rerender=()=>{this.setRerender?.(Math.random())};this.addDropDown=(t,e,i,r,a,n)=>{this.settingsFields[t]={type:"dropdown",description:e,defaultValue:i[r],options:i,events:n}};this.addToggle=(t,e,i,r)=>{this.settingsFields[t]={type:"toggle",description:e,defaultValue:i,events:r}};this.addInput=(t,e,i,r="text",a)=>{this.settingsFields[t]={type:"input",description:e,defaultValue:i,inputType:r,events:a}};this.getFieldValue=t=>{let e=window.Spicetify?.LocalStorage.get(t);if(e==null){let i=`${this.settingsId}.${t}`,r=window.Spicetify?.LocalStorage.get(i);if(r)try{let n=JSON.parse(r)?.value??r;return window.Spicetify?.LocalStorage.set(t,n),window.Spicetify?.LocalStorage.remove(i),n}catch{return r}return}return e};this.FieldsContainer=()=>{let[t,e]=(0,Y.useState)(0);return this.setRerender=e,Y.default.createElement("div",{className:"x-settings-section",key:t},Y.default.createElement("h2",{className:"TypeElement-cello-textBase-type"},this.name),Object.entries(this.settingsFields).map(([i,r])=>Y.default.createElement(this.Field,{key:i,nameId:i,field:r})))};this.Field=({nameId:t,field:e})=>{let i=`${this.settingsId}.${t}`,r=e.type==="button"?e.value:this.getFieldValue(t)??e.defaultValue,[a,n]=(0,Y.useState)(r),s=m=>{n(m),this.setFieldValue(t,m);try{let d=new CustomEvent("year3000SystemSettingsChanged",{detail:{key:t,value:m}});document.dispatchEvent(d)}catch(d){console.warn(`[SettingsSection] Failed to emit settings change event for ${t}:`,d)}};if(e.type==="hidden")return Y.default.createElement(Y.default.Fragment,null);let l=Y.default.createElement("label",{className:"TypeElement-viola-textSubdued-type",htmlFor:i},e.description||""),c=null;switch(e.type){case"dropdown":c=Y.default.createElement("select",{className:"main-dropDown-dropDown",id:i,...e.events,onChange:m=>{let d=m.currentTarget.selectedIndex,h=e.options[d];s(h),e.events?.onChange?.(m)}},e.options.map((m,d)=>Y.default.createElement("option",{key:m,value:m,selected:m===a},m)));break;case"toggle":c=Y.default.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},Y.default.createElement("input",{id:i,className:"x-toggle-input",type:"checkbox",checked:!!a,...e.events,onClick:m=>{let d=m.currentTarget.checked;s(d),e.events?.onClick?.(m)}}),Y.default.createElement("span",{className:"x-toggle-indicatorWrapper"},Y.default.createElement("span",{className:"x-toggle-indicator"})));break;case"input":c=Y.default.createElement("input",{className:"x-settings-input",id:i,dir:"ltr",value:a,type:e.inputType||"text",...e.events,onChange:m=>{s(m.currentTarget.value),e.events?.onChange?.(m)}});break;case"button":c=Y.default.createElement("button",{id:i,className:"Button-sc-y0gtbx-0 Button-small-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button",...e.events,onClick:m=>{e.events?.onClick?.(m)},type:"button"},a);break;default:c=null}return Y.default.createElement("div",{className:"x-settings-row"},Y.default.createElement("div",{className:"x-settings-firstColumn"},l),Y.default.createElement("div",{className:"x-settings-secondColumn"},c))}}async render(){for(;!document.getElementById("desktop.settings.selectLanguage");){if(window.Spicetify.Platform.History.location.pathname!=="/preferences")return;await new Promise(i=>setTimeout(i,100))}let t=document.querySelector(".main-view-container__scroll-node-child main div");if(!t)return console.error("[StarryNight] settings container not found");let e=Array.from(t.children).find(i=>i.id===this.settingsId);e||(e=document.createElement("div"),e.id=this.settingsId,t.appendChild(e)),ho.default.render(Y.default.createElement(this.FieldsContainer,null),e)}setFieldValue(t,e){window.Spicetify?.LocalStorage.set(t,e)}}});var fo={};ne(fo,{initializeStarryNightSettings:()=>Mc});function po(){return globalThis.year3000System?.cssController||A()}async function Mc(){let o=new Zi("StarryNight Theme","starrynight-settings"),t=["dynamic","rosewater","flamingo","pink","mauve","red","maroon","peach","yellow","green","teal","sky","sapphire","blue","lavender"],e=E.get("catppuccin-accentColor");o.addDropDown("catppuccin-accentColor","Accent colour (primary theme color)",t,Math.max(0,t.indexOf(e)),void 0,{onChange:L=>{try{let H=L?.currentTarget?.selectedIndex??0,U=t[H]??"mauve";E.set("catppuccin-accentColor",U);let Yt=E.get("sn-gradient-intensity");Ut(Yt,Yt);try{globalThis.Y3K?.system?.applyInitialSettings?.("accent")}catch(Ji){console.warn("[StarryNight] Unable to trigger Year3000System colour refresh",Ji)}}catch(H){console.error("[StarryNight] Failed to update accent colour",H)}}});let i=["disabled","minimal","balanced","intense"],r=E.get("sn-gradient-intensity");o.addDropDown("sn-gradient-intensity","Background effects intensity (stars, nebula, flow gradients)",i,Math.max(0,i.indexOf(r)),void 0,{onChange:L=>{let H=L?.currentTarget?.selectedIndex??0,U=i[H]??"balanced";E.set("sn-gradient-intensity",U),Ut(U,U)}});let a=["bright","balanced","dark"],n=E.get("sn-brightness-mode")||"balanced";o.addDropDown("sn-brightness-mode","Brightness mode",a,Math.max(0,a.indexOf(n)),void 0,{onChange:L=>{let H=L?.currentTarget?.selectedIndex??0,U=a[H]??"bright";E.set("sn-brightness-mode",U);let Yt=po(),Ji={"--sn-brightness-mode":`"${U}"`,"--sn-brightness-data-attr":U};Yt.batchSetVariables("StarryNightSettings",Ji,"high","brightness-mode-change"),document.documentElement.setAttribute("data-sn-brightness",U);try{globalThis.Y3K?.system?.applyInitialSettings?.("brightness"),console.log(`[StarryNight] Brightness mode changed to: ${U}`)}catch(Mo){console.warn("[StarryNight] Unable to trigger Year3000System brightness refresh",Mo)}}});let s=["latte","frappe","macchiato","mocha"],l=E.get("catppuccin-flavor");o.addDropDown("catppuccin-flavor","Catppuccin flavour (light/dark theme base)",s,Math.max(0,s.indexOf(l)),void 0,{onChange:L=>{let H=L?.currentTarget?.selectedIndex??0;E.set("catppuccin-flavor",s[H]);try{globalThis.Y3K?.system?.applyInitialSettings?.("flavor")}catch(U){console.warn("[StarryNight] Unable to trigger flavor refresh",U)}}});let c=["catppuccin","year3000"],m=["Catppuccin Classic","Year 3000 Cinematic"],d=E.get("sn-palette-system");o.addDropDown("sn-palette-system","Palette system (color foundation vs enhancement)",m,Math.max(0,c.indexOf(d)),void 0,{onChange:L=>{let H=L?.currentTarget?.selectedIndex??0;E.set("sn-palette-system",c[H]);try{globalThis.Y3K?.system?.applyInitialSettings?.("palette")}catch(U){console.warn("[StarryNight] Unable to trigger palette system refresh",U)}}});let h=["disabled","minimal","moderate","intense"],g=E.get("sn-glassmorphism-level");o.addDropDown("sn-glassmorphism-level","Glassmorphism",h,Math.max(0,h.indexOf(g)),void 0,{onChange:L=>{let H=L?.currentTarget?.selectedIndex??0;E.set("sn-glassmorphism-level",h[H])}});let f=["corporate-safe","artist-vision","cosmic-maximum"],S=E.get("sn-artistic-mode");o.addDropDown("sn-artistic-mode","Artistic mode",f,Math.max(0,f.indexOf(S)),void 0,{onChange:L=>{let H=L?.currentTarget?.selectedIndex??0,U=f[H];E.set("sn-artistic-mode",U),globalThis.year3000System?.ADVANCED_SYSTEM_CONFIG?.safeSetArtisticMode?.(U)}});let C=Object.keys(ri),x=E.get("sn-current-harmonic-mode");C.length&&o.addDropDown("sn-current-harmonic-mode","Harmonic colour mode",C,Math.max(0,C.indexOf(x)),void 0,{onChange:L=>{let H=L?.currentTarget?.selectedIndex??0,U=C[H];E.set("sn-current-harmonic-mode",U),globalThis.Y3K?.system?.evolveHarmonicSignature?.(U)}});let M=E.get("sn-harmonic-intensity")||"0.7";o.addInput("sn-harmonic-intensity","Harmonic intensity (music-color sync strength 0-1)",M,"number",{onChange:L=>{let H=L.currentTarget.value;E.set("sn-harmonic-intensity",H)}});let V=E.get("sn-harmonic-evolution");o.addToggle("sn-harmonic-evolution","Allow harmonic evolution",V,{onClick:L=>{let H=L.currentTarget.checked;E.set("sn-harmonic-evolution",H)}});let z=E.get("sn-webgl-enabled");o.addToggle("sn-webgl-enabled","WebGL effects (master toggle for all WebGL backgrounds)",z,{onClick:L=>{let H=L.currentTarget.checked;E.set("sn-webgl-enabled",H)}});let G=["low","medium","high"],I=E.get("sn-webgl-quality")||"medium";o.addDropDown("sn-webgl-quality","WebGL quality (performance vs visual quality)",G,Math.max(0,G.indexOf(I)),void 0,{onChange:L=>{let H=L?.currentTarget?.selectedIndex??1,U=G[H]??"medium";E.set("sn-webgl-quality",U)}});let N=["auto","low","high"],F=E.get("sn-animation-quality")||"auto";o.addDropDown("sn-animation-quality","Animation quality (auto/low/high performance)",N,Math.max(0,N.indexOf(F)),void 0,{onChange:L=>{let H=L?.currentTarget?.selectedIndex??0,U=N[H]??"auto";E.set("sn-animation-quality",U)}}),await o.pushSettings(),console.log("\u2728 [StarryNight] spcr-settings panel initialised");let P=E.get("sn-brightness-mode")||"balanced",J=po(),we={"--sn-brightness-mode":`"${P}"`,"--sn-brightness-data-attr":P};J.batchSetVariables("StarryNightSettings",we,"high","brightness-mode-init"),document.documentElement.setAttribute("data-sn-brightness",P),console.log(`[StarryNight] Initial brightness mode set to: ${P}`);let ae=()=>o.rerender(),oe=globalThis.Spicetify?.Platform?.History;try{oe?.listen&&oe.listen(({location:L})=>{L?.pathname==="/settings"&&setTimeout(ae,100)})}catch(L){console.warn("[StarryNight] Could not hook navigation for settings",L)}window.location.pathname==="/settings"&&setTimeout(ae,300)}var bo=v(()=>{"use strict";B();$();go();ee();Aa()});var yo={};ne(yo,{DepthVisualEffectsController:()=>$a});var $a,vo=v(()=>{"use strict";B();$();R();te();ge();$a=class extends q{constructor(e=w,i=k,r=null,a=null){super(e,i,r,a);this.contentAreas=new Map;this.chromeAreas=new Set;this.userState={isScrolling:!1,isHovering:!1,lastInteractionTime:0,readingModeActive:!1,interactionTarget:null,currentMode:"browsing",focusDepth:.3,scrollVelocity:0,dwellTime:0,interactionPattern:"casual",contentEngagement:.5};this.musicalState={energy:.5,valence:.5,instrumental:!1,tempo:120,emotionalTemperature:.5,musicSyncStrength:.7,genreVisualEffectsProfile:{ambientLevel:.5,energyResponse:.6,visualComplexity:.5},musicalMemoryPatterns:.4};this.readingModeTimer=0;this.interactionTimer=0;this.visualEffectsUpdateInterval=0;this.lastUpdate=0;this.updateThreshold=100;this.visualEffectsIntensity=.7;this.adaptiveProtectionMap=new Map;this.scrollVelocityHistory=[];this.dwellTimeTracker=new Map}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{let e=globalThis.year3000System;this.cssController=e?.cssVisualEffectsController||A(),this.detectContentAndChromeAreas(),this.setupInteractionListeners(),this.initializeVisualEffectsVariables(),this.startVisualEffectsUpdate(),u?.debug?.log("DepthVisualEffectsController","VisualEffects system awakened")}catch(e){u?.debug?.error("DepthVisualEffectsController","Failed to initialize visualEffects:",e)}}detectContentAndChromeAreas(){let e={text:[".main-view-container__scroll-node",".main-trackList-trackListRow",'[data-testid*="tracklist"]','[data-testid*="playlist"]',".main-entityHeader-titleText",".main-entityHeader-subtitle",".main-trackList-rowTitle",".main-trackList-rowSubTitle","h1, h2, h3, h4, h5, h6","p",".lyrics-lyricsContainer-container",".main-cardSubHeader-root",".main-trackList-indexNumber",".main-trackInfo-name",".main-trackInfo-artists"],interactive:["button","a[role='button']","[tabindex='0']",".main-playButton-button",".main-addButton-button",".main-moreButton-button",".main-trackList-rowPlayPause",".control-button","input","select"],visual:[".main-image-container",".main-entityHeader-image",".cover-art",".main-coverSlot-container",".main-image-image"],media:["video","audio",".main-nowPlayingWidget-trackInfo",".main-coverSlot-container",".main-nowPlayingView-coverArt"],navigation:[".main-navBar-navBarLink",".main-rootlist-rootlistItem",".main-collectionLinkText-text"]},i=[".Root__nav-bar",".Root__top-bar",".Root__now-playing-bar",".main-topBar-container",".main-navBar-navBar",".main-entityHeader-container",".main-actionBar-container",".main-view-container",".Root__main-view",".main-rootlist-wrapper"];Object.entries(e).forEach(([a,n])=>{n.forEach(s=>{document.querySelectorAll(s).forEach(l=>{let c={element:l,type:a,protectionLevel:this.calculateAdvancedProtectionLevel(l,a),lastInteraction:0,visualEffectsLevel:this.calculateVisualEffectsLevel(l),readingIntensity:0,contextualImportance:this.calculateContextualImportance(l),adaptiveProtection:this.calculateProtectionLevel(l)};this.contentAreas.set(l,c),l.classList.add("content-sanctuary"),l.classList.add(`content-${a}`),l.setAttribute("data-visualEffects-protected","true"),l.setAttribute("data-content-type",c.type),l.setAttribute("data-visualEffects-level",c.visualEffectsLevel.toString()),l.setAttribute("data-contextual-importance",c.contextualImportance.toString()),this.adaptiveProtectionMap.set(l,c.adaptiveProtection),this.dwellTimeTracker.set(l,0)})})}),i.forEach(a=>{document.querySelectorAll(a).forEach(n=>{this.chromeAreas.add(n),n.classList.add("ui-chrome-area"),n.setAttribute("data-visualEffects-enhanced","true")})});let r=this.analyzeContentDistribution();u?.debug?.log("DepthVisualEffectsController",`Enhanced detection: ${this.contentAreas.size} content areas, ${this.chromeAreas.size} chrome areas`,r)}determineContentType(e){return e.matches("h1, h2, h3, h4, h5, h6, .main-entityHeader-titleText")?"text":e.matches('button, a, [role="button"], [tabindex], input, select')?"interactive":e.matches(".main-image-container, .main-entityHeader-image, .cover-art")?"visual":e.matches(".Root__nav-bar, .Root__top-bar, .main-topBar-container")?"chrome":"text"}calculateProtectionLevel(e){switch(this.determineContentType(e)){case"text":return .95;case"interactive":return .9;case"visual":return .6;case"chrome":return .3;case"media":return .5;case"navigation":return .7;default:return .85}}calculateAdvancedProtectionLevel(e,i){let r=this.calculateProtectionLevel(e),a=0;i==="text"&&e.textContent&&e.textContent.length>50&&(a+=.05);let n=e.getBoundingClientRect();return n.top>=0&&n.left>=0&&n.bottom<=window.innerHeight&&n.right<=window.innerWidth&&(a+=.02),e.matches('h1, h2, .main-entityHeader-titleText, [data-testid*="title"]')&&(a+=.03),Math.min(r+a,.98)}calculateVisualEffectsLevel(e){let i=e.getBoundingClientRect(),r=i.width*i.height,a=window.innerWidth*window.innerHeight,n=r/a,s=Math.min(n*2,.8);return e.matches(".Root__main-view, .main-view-container")&&(s+=.3),e.matches(".main-nowPlayingBar-container")&&(s+=.4),Math.min(s,1)}calculateContextualImportance(e){let i=.5;return e.matches('button, a, [role="button"], [tabindex="0"]')&&(i+=.2),e.matches(".main-view-container, .main-entityHeader, .main-trackList")&&(i+=.3),e.matches(".main-nowPlayingWidget, .main-nowPlayingBar")&&(i+=.4),e.matches(":focus, :focus-within, :hover")&&(i+=.2),Math.min(i,1)}analyzeContentDistribution(){let e={totalAreas:this.contentAreas.size,textAreas:0,interactiveAreas:0,visualAreas:0,mediaAreas:0,navigationAreas:0,chromeAreas:this.chromeAreas.size,averageProtection:0,highProtectionAreas:0},i=0;return this.contentAreas.forEach(r=>{switch(r.type){case"text":e.textAreas++;break;case"interactive":e.interactiveAreas++;break;case"visual":e.visualAreas++;break;case"media":e.mediaAreas++;break;case"navigation":e.navigationAreas++;break}i+=r.protectionLevel,r.protectionLevel>.8&&e.highProtectionAreas++}),e.averageProtection=i/this.contentAreas.size||0,e}analyzeScrollingBehavior(){if(this.scrollVelocityHistory.length<3)return;let e=this.scrollVelocityHistory.reduce((r,a)=>r+a,0)/this.scrollVelocityHistory.length,i=this.scrollVelocityHistory.reduce((r,a)=>r+Math.pow(a-e,2),0)/this.scrollVelocityHistory.length;i<100&&e<300?(this.userState.contentEngagement=Math.min(this.userState.contentEngagement+.05,1),this.userState.interactionPattern="contemplative"):e>1500&&i>500?(this.userState.contentEngagement=Math.max(this.userState.contentEngagement-.1,.1),this.userState.interactionPattern="rapid"):this.userState.interactionPattern="casual",this.userState.contentEngagement>.7?this.visualEffectsIntensity=Math.min(this.visualEffectsIntensity+.05,.9):this.userState.contentEngagement<.3&&(this.visualEffectsIntensity=Math.max(this.visualEffectsIntensity-.1,.3))}calculateInteractionModifier(){let e=0;if(this.userState.readingModeActive&&(e-=.6),this.userState.isHovering){let i=this.contentAreas.get(this.userState.interactionTarget);if(i){let r=i.type==="text"?.4:i.type==="interactive"?.3:i.type==="chrome"?.1:.2;e-=r}}return this.userState.scrollVelocity>1e3&&(e-=.2),this.userState.focusDepth>.7&&!this.userState.readingModeActive&&(e+=.2),e}calculateContextualModifier(){let e=0;return this.userState.interactionTarget?.matches(".main-nowPlayingBar, .main-nowPlayingWidget")&&(e+=.3),this.userState.interactionTarget?.matches(".main-trackList, .main-entityHeader-subtitle")&&(e-=this.userState.currentMode==="exploring"?.1:.3),this.userState.currentMode==="ambient"&&(e+=.4),this.userState.currentMode==="navigating"&&(e-=.2),e}getModeNumericValue(e){return{reading:0,browsing:1,exploring:2,navigating:3,ambient:4}[e]/4}getPatternNumericValue(e){return{contemplative:0,casual:1,deliberate:2,rapid:3}[e]/3}calculateSurfaceFluidityIndex(){let e=.5;return e+=this.musicalState.energy*.3,e+=this.userState.contentEngagement*.2,e+=this.musicalState.emotionalTemperature*.2,this.userState.interactionPattern==="contemplative"?e-=.2:this.userState.interactionPattern==="rapid"&&(e+=.3),Math.max(.1,Math.min(1,e))}calculateGenreVisualEffectsShift(){if(!this.musicalState.genre)return .5;let i={ambient:.8,electronic:.7,classical:.6,jazz:.5,rock:.4,pop:.3,"hip-hop":.2}[this.musicalState.genre.toLowerCase()]||.5,r=0;return this.musicalState.valence>.7&&(r+=.1),this.musicalState.energy>.8&&(r+=.1),Math.max(.1,Math.min(1,i+r))}setupInteractionListeners(){let e,i=window.scrollY,r=Date.now();document.addEventListener("scroll",()=>{let s=Date.now(),l=window.scrollY,c=s-r,m=Math.abs(l-i);this.userState.scrollVelocity=c>0?m/c*1e3:0,this.scrollVelocityHistory.push(this.userState.scrollVelocity),this.scrollVelocityHistory.length>10&&this.scrollVelocityHistory.shift();let d=this.scrollVelocityHistory.reduce((h,g)=>h+g,0)/this.scrollVelocityHistory.length;d>2e3?(this.userState.interactionPattern="rapid",this.userState.currentMode="browsing"):d>500?(this.userState.interactionPattern="deliberate",this.userState.currentMode="exploring"):this.userState.interactionPattern="contemplative",this.userState.isScrolling=!0,this.userState.lastInteractionTime=s,i=l,r=s,clearTimeout(e),e=window.setTimeout(()=>{this.userState.isScrolling=!1,this.analyzeScrollingBehavior()},150),this.updateUserInteractionState()},{passive:!0}),this.contentAreas.forEach((s,l)=>{let c=0;l.addEventListener("mouseenter",()=>{c=Date.now(),this.userState.isHovering=!0,this.userState.interactionTarget=l,this.userState.lastInteractionTime=c,s.lastInteraction=c,this.dwellTimeTracker.set(l,c),this.userState.focusDepth=Math.min(this.userState.focusDepth+.1,1),s.type==="text"&&(this.userState.focusDepth=Math.min(this.userState.focusDepth+.2,1)),this.updateUserInteractionState()}),l.addEventListener("mouseleave",()=>{let d=Date.now()-c;if(this.userState.dwellTime=d,s.readingIntensity=Math.min(d/5e3,1),s.type==="text"&&d>1e3&&(this.userState.contentEngagement=Math.min(this.userState.contentEngagement+.1,1),s.contextualImportance=Math.min(s.contextualImportance+.05,1)),d>3e3){let h=this.adaptiveProtectionMap.get(l)||s.protectionLevel;this.adaptiveProtectionMap.set(l,Math.min(h+.05,.98))}this.userState.isHovering=!1,this.userState.interactionTarget=null,this.userState.focusDepth=Math.max(this.userState.focusDepth-.05,.1),this.updateUserInteractionState()})}),document.addEventListener("mousemove",()=>{clearTimeout(this.readingModeTimer),this.userState.readingModeActive=!1,this.userState.focusDepth>.7?this.userState.currentMode="reading":this.userState.scrollVelocity>1e3?this.userState.currentMode="browsing":this.userState.currentMode="exploring";let s=this.userState.currentMode==="reading"?1500:2e3;this.readingModeTimer=window.setTimeout(()=>{if(this.userState.interactionTarget&&this.contentAreas.has(this.userState.interactionTarget)){this.userState.readingModeActive=!0,this.userState.currentMode="reading",this.userState.focusDepth=Math.min(this.userState.focusDepth+.3,1);let l=this.contentAreas.get(this.userState.interactionTarget);if(l&&l.type==="text"){let c=this.adaptiveProtectionMap.get(this.userState.interactionTarget)||l.protectionLevel;this.adaptiveProtectionMap.set(this.userState.interactionTarget,Math.min(c+.1,.98))}this.updateUserInteractionState()}},s)});let a,n=()=>{clearTimeout(a),a=window.setTimeout(()=>{this.userState.currentMode="ambient",this.userState.focusDepth=Math.max(this.userState.focusDepth-.5,.1),this.updateUserInteractionState()},3e4)};["mousedown","mousemove","keydown","scroll","touchstart"].forEach(s=>{document.addEventListener(s,n,{passive:!0})}),n(),document.addEventListener("music-state-change",s=>{let l=s;l.detail&&this.syncWithMusic(l.detail)}),document.addEventListener("beat-detected",()=>{this.handleBeatPulse()})}initializeVisualEffectsVariables(){let e={"--sn-visual-effects-system-active":"1","--sn-visual-effects-content-protection-level":"0.95","--sn-visual-effects-chrome-enhancement-level":"2.0","--sn-visual-effects-field-animation-rate":"4s","--sn-music-energy-level":"0.5","--sn-feature-reading-mode-active":"0","--sn-visual-effects-user-interaction-detected":"0"};this.cssController.batchSetVariables("DepthVisualEffectsController",e,"normal","visualEffects-initialization")}startVisualEffectsUpdate(){let e=()=>{if(!this.isActive)return;let i=performance.now();i-this.lastUpdate>=this.updateThreshold&&(this.updateVisualEffectsState(),this.lastUpdate=i),requestAnimationFrame(e)};e()}updateVisualEffectsState(){let e=document.documentElement,i=this.visualEffectsIntensity,r=this.musicalState.energy*this.musicalState.musicSyncStrength*.3,a=this.calculateInteractionModifier(),n=this.calculateContextualModifier(),s=this.musicalState.emotionalTemperature*.2,c={"--sn-visual-effects-field-intensity":Math.max(.05,Math.min(1,i+r+a+n+s)).toString(),"--sn-visual-effects-level":this.visualEffectsIntensity.toString(),"--sn-visual-effects-awareness-level":this.userState.focusDepth.toString(),"--sn-music-energy-level":this.musicalState.energy.toString(),"--sn-visual-effects-music-sync-strength":this.musicalState.musicSyncStrength.toString(),"--sn-color-shift-temperature":this.musicalState.emotionalTemperature.toString(),"--sn-feature-reading-mode-active":this.userState.readingModeActive?"1":"0","--sn-visual-effects-user-interaction-detected":this.userState.isScrolling||this.userState.isHovering?"1":"0","--sn-visual-effects-interaction-mode":this.getModeNumericValue(this.userState.currentMode).toString(),"--sn-visual-effects-focus-depth":this.userState.focusDepth.toString(),"--sn-visual-effects-content-engagement":this.userState.contentEngagement.toString(),"--sn-visual-effects-scroll-velocity":Math.min(this.userState.scrollVelocity/2e3,1).toString(),"--sn-visual-effects-dwell-time-factor":Math.min(this.userState.dwellTime/5e3,1).toString(),"--sn-visual-effects-interaction-pattern":this.getPatternNumericValue(this.userState.interactionPattern).toString(),"--sn-visual-effects-temporal-flow-direction-x":(Math.sin(Date.now()*1e-4)*.5+.5).toString(),"--sn-visual-effects-temporal-flow-direction-y":(Math.cos(Date.now()*1e-4)*.5+.5).toString(),"--sn-visual-effects-memory-intensity":this.musicalState.musicalMemoryPatterns.toString(),"--sn-visual-effects-fluidity-index":this.calculateSurfaceFluidityIndex().toString(),"--sn-visual-effects-genre-shift":this.calculateGenreVisualEffectsShift().toString()};this.cssController.batchSetVariables("DepthVisualEffectsController",c,"normal","visualEffects-state-update"),e.classList.remove("music-energy-high","music-energy-calm"),this.musicalState.energy>.7?e.classList.add("music-energy-high"):this.musicalState.energy<.3&&e.classList.add("music-energy-calm"),e.setAttribute("data-user-interacting",(this.userState.isScrolling||this.userState.isHovering).toString()),e.setAttribute("data-reading-mode",this.userState.readingModeActive.toString())}updateUserInteractionState(){this.updateVisualEffectsState()}syncWithMusic(e){if(Object.assign(this.musicalState,e),e.tempo){let i=Math.max(2,Math.min(8,60/(e.tempo/60)*4));this.cssController.setVariable("DepthVisualEffectsController","--sn-visual-effects-field-animation-rate",`${i}s`,"high","musical-tempo-sync")}this.updateVisualEffectsState(),u?.debug?.log("DepthVisualEffectsController",`Musical visualEffects sync: energy=${e.energy}, tempo=${e.tempo}`)}handleBeatPulse(){if(this.userState.readingModeActive)return;let e=document.documentElement,i=parseFloat(e.style.getPropertyValue("--sn-visual-effects-field-intensity")||"0.5"),r=Math.min(1,i+.1);this.cssController.setVariable("DepthVisualEffectsController","--sn-visual-effects-field-intensity",r.toString(),"high","beat-pulse"),setTimeout(()=>{this.isActive&&this.updateVisualEffectsState()},100)}protectNewContent(e){if(this.contentAreas.has(e))return;let i={element:e,type:this.determineContentType(e),protectionLevel:this.calculateProtectionLevel(e),lastInteraction:0,visualEffectsLevel:.5,readingIntensity:0,contextualImportance:this.calculateProtectionLevel(e),adaptiveProtection:.5};this.contentAreas.set(e,i),e.classList.add("content-sanctuary"),e.setAttribute("data-visualEffects-protected","true"),e.setAttribute("data-content-type",i.type),u?.debug?.log("DepthVisualEffectsController",`Protected new content element: ${e.tagName}.${e.className}`)}enhanceNewChrome(e){this.chromeAreas.has(e)||(this.chromeAreas.add(e),e.classList.add("ui-chrome-area"),e.setAttribute("data-visualEffects-enhanced","true"),u?.debug?.log("DepthVisualEffectsController",`Enhanced new chrome element: ${e.tagName}.${e.className}`))}forceReadingMode(e){this.userState.readingModeActive=e,this.updateUserInteractionState(),u?.debug?.log("DepthVisualEffectsController",`Reading mode ${e?"activated":"deactivated"}`)}getVisualEffectsMetrics(){return{contentAreas:this.contentAreas.size,chromeAreas:this.chromeAreas.size,visualEffectsIntensity:parseFloat(document.documentElement.style.getPropertyValue("--sn-visual-effects-field-intensity")||"0.5"),readingModeActive:this.userState.readingModeActive,userInteracting:this.userState.isScrolling||this.userState.isHovering,musicalEnergy:this.musicalState.energy}}async healthCheck(){let e=this.getVisualEffectsMetrics(),i=e.contentAreas>0&&e.chromeAreas>0;return{healthy:i,issues:i?[]:["VisualEffects system not properly initialized"],metrics:{visualEffectsLevel:e.contentAreas>0?1:0,protectedAreas:e.contentAreas,enhancedAreas:e.chromeAreas,musicalEnergy:e.musicalEnergy}}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),clearTimeout(this.readingModeTimer),clearTimeout(this.interactionTimer),this.contentAreas.forEach((r,a)=>{a.classList.remove("content-sanctuary"),a.removeAttribute("data-visualEffects-protected"),a.removeAttribute("data-content-type")}),this.chromeAreas.forEach(r=>{r.classList.remove("ui-chrome-area"),r.removeAttribute("data-visualEffects-enhanced")});let e={"--sn-visual-effects-system-active":"","--sn-visual-effects-field-intensity":"","--sn-feature-reading-mode-active":"","--sn-visual-effects-user-interaction-detected":"","--sn-visual-effects-field-animation-rate":"","--sn-music-energy-level":"","--sn-visual-effects-content-protection-level":"","--sn-visual-effects-chrome-enhancement-level":""};this.cssController.batchSetVariables("DepthVisualEffectsController",e,"critical","system-cleanup");let i=document.documentElement;i.classList.remove("music-energy-high","music-energy-calm"),i.removeAttribute("data-user-interacting"),i.removeAttribute("data-reading-mode"),u?.debug?.log("DepthVisualEffectsController","VisualEffects system deactivated")}}});var So={};ne(So,{AtmosphericCrystalsSystem:()=>Wa});var Wa,Co=v(()=>{"use strict";Wa=class{constructor(){this.initialized=!1;this.overlayContainer=null;this.crystalElements=[];this.reducedMotion=!1}async initialize(){if(this.initialized)return;this.reducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.overlayContainer=document.createElement("div"),this.overlayContainer.className="sn-crystalline-overlay";let t=["a","b","c"];for(let e of t){let i=document.createElement("div");i.className=`sn-atmospheric-crystal sn-atmospheric-crystal--${e}`,this.reducedMotion&&(i.style.animation="none"),this.overlayContainer.appendChild(i),this.crystalElements.push(i)}document.body.appendChild(this.overlayContainer),this.initialized=!0}updateAnimation(t){}async healthCheck(){if(!this.initialized)return{healthy:!1,details:"AtmosphericCrystalsSystem not initialized"};let t=document.body.contains(this.overlayContainer),e=this.crystalElements.length===3&&this.crystalElements.every(i=>this.overlayContainer?.contains(i));return!t||!e?{healthy:!1,details:`Crystal elements missing (overlay: ${t}, crystals: ${e})`}:{healthy:!0,details:"AtmosphericCrystalsSystem operational - 3 crystals rendering"}}destroy(){this.overlayContainer&&document.body.contains(this.overlayContainer)&&document.body.removeChild(this.overlayContainer),this.crystalElements=[],this.overlayContainer=null,this.initialized=!1}forceRepaint(){}}});var Eo={};ne(Eo,{CDFVariableBridge:()=>qa});var qa,wo=v(()=>{"use strict";_();qa=class{constructor(t){this.batcher=t;this.reduceMotionMQ=null;this._mqHandler=null;let e=p.subscribe("performance:frame",i=>{let r={deltaMs:i.deltaTime||16.67,timestamp:i.timestamp||Date.now(),performanceMode:"performance",frameBudget:16.67};this._handleFrame(r)},"CDFVariableBridge");if(this.unsubscribe=()=>p.unsubscribe(e),typeof window<"u"&&window.matchMedia){this.reduceMotionMQ=window.matchMedia("(prefers-reduced-motion: reduce)"),this._syncReducedMotion(this.reduceMotionMQ.matches),this._mqHandler=i=>{this._syncReducedMotion(i.matches)};try{this.reduceMotionMQ.addEventListener("change",this._mqHandler)}catch{this.reduceMotionMQ.addListener(this._mqHandler)}}}destroy(){if(this.unsubscribe?.(),this.reduceMotionMQ&&this._mqHandler)try{this.reduceMotionMQ.removeEventListener("change",this._mqHandler)}catch{this.reduceMotionMQ.removeListener(this._mqHandler)}}_handleFrame(t){if(typeof t.scrollRatio=="number"&&(this.batcher.queueCSSVariableUpdate("--sn-cdf-scroll-ratio",t.scrollRatio.toFixed(3)),this.batcher.queueCSSVariableUpdate("--sn-scroll-ratio",t.scrollRatio.toFixed(3))),typeof t.beatIntensity=="number"){let e=t.beatIntensity.toFixed(3);this.batcher.queueCSSVariableUpdate("--sn-cdf-energy",e),this.batcher.queueCSSVariableUpdate("--sn-beat-intensity",e)}}_syncReducedMotion(t){this.batcher.queueCSSVariableUpdate("--sn-cdf-enabled",t?"0":"1")}}});B();ee();Ia();R();te();async function zs(o=1e4,t=100){let e=Date.now();for(;Date.now()-e<o;){let i=window.Spicetify;if(i?.showNotification&&i?.Platform)return!0;await new Promise(r=>setTimeout(r,t))}return!1}$();var Oi=class{constructor(t,e=null){this.parent=t;this.y3k=e;this.gl=null;this.program=null;this.tex=null;this.strength=.4;this.rafId=null;this.frameStart=0;this._defaultSize=256;this._boundContextLost=t=>this._handleContextLost(t);this._boundContextRestored=()=>this._handleContextRestored();this.canvas=document.createElement("canvas"),this.canvas.width=this._defaultSize,this.canvas.height=this._defaultSize,this.canvas.style.width="100%",this.canvas.style.height="100%",Object.assign(this.canvas.style,{position:"absolute",inset:"0",pointerEvents:"none",mixBlendMode:"overlay",zIndex:"-1",opacity:"0.6"}),this.parent.appendChild(this.canvas),this.perf=e?.performanceAnalyzer??null,this.canvas.addEventListener("webglcontextlost",this._boundContextLost,!1),this.canvas.addEventListener("webglcontextrestored",this._boundContextRestored,!1),this._initGL()}_initGL(){let t=this.canvas.getContext("webgl",{premultipliedAlpha:!1,alpha:!0,antialias:!1});if(!t){console.warn("[AberrationCanvas] WebGL not available \u2013 effect disabled");return}this.gl=t;let e="attribute vec2 aPos; varying vec2 vUv; void main(){ vUv = (aPos+1.0)*0.5; gl_Position = vec4(aPos,0.0,1.0); }",i="precision mediump float; uniform sampler2D uTex; uniform float uStrength; uniform float uTime; varying vec2 vUv; void main(){ float freq = 8.0; vec2 offset = vec2(sin(vUv.y*freq+uTime)*uStrength, 0.0); vec4 c; c.r = texture2D(uTex, vUv + offset).r; c.g = texture2D(uTex, vUv).g; c.b = texture2D(uTex, vUv - offset).b; c.a = clamp(uStrength * 1.5, 0.0, 0.6); gl_FragColor = c; }",r=(h,g)=>{let f=t.createShader(h);return t.shaderSource(f,g),t.compileShader(f),f},a=r(t.VERTEX_SHADER,e),n=r(t.FRAGMENT_SHADER,i),s=t.createProgram();if(t.attachShader(s,a),t.attachShader(s,n),t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS)){console.error("[AberrationCanvas] Shader link failed");return}this.program=s,t.useProgram(s);let l=new Float32Array([-1,-1,1,-1,-1,1,1,1]),c=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,c),t.bufferData(t.ARRAY_BUFFER,l,t.STATIC_DRAW);let m=t.getAttribLocation(s,"aPos");t.enableVertexAttribArray(m),t.vertexAttribPointer(m,2,t.FLOAT,!1,0,0);let d=t.createTexture();t.bindTexture(t.TEXTURE_2D,d),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,0,0])),this.tex=d}setStrength(t){this.strength=t}updateSourceBitmap(t){if(!this.gl||!this.tex)return;let e=this.gl;e.bindTexture(e.TEXTURE_2D,this.tex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t)}render(t){if(!this.gl||!this.program)return;let e=this.gl;this.perf&&(this.frameStart=performance.now()),e.viewport(0,0,this.canvas.width,this.canvas.height),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT),e.useProgram(this.program);let i=e.getUniformLocation(this.program,"uTex"),r=e.getUniformLocation(this.program,"uStrength"),a=e.getUniformLocation(this.program,"uTime");if(e.uniform1i(i,0),e.uniform1f(r,this.strength),e.uniform1f(a,t*.001),e.drawArrays(e.TRIANGLE_STRIP,0,4),this.perf){let n=performance.now()-this.frameStart;n>.5&&console.warn(`[AberrationCanvas] Frame ${n.toFixed(2)} ms exceeds 0.5 ms budget`)}}destroy(){this.rafId&&cancelAnimationFrame(this.rafId),this.gl&&this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.canvas.removeEventListener("webglcontextlost",this._boundContextLost),this.canvas.removeEventListener("webglcontextrestored",this._boundContextRestored),this.canvas.remove()}setPixelSize(t){t!==this.canvas.width&&(this.canvas.width=t,this.canvas.height=t)}_handleContextLost(t){t.preventDefault(),console.warn("[AberrationCanvas] WebGL context lost \u2013 waiting for restore"),this.gl=null,this.program=null}_handleContextRestored(){console.info("[AberrationCanvas] WebGL context restored \u2013 re-initializing GL"),this._initGL()}};var Ui=class{constructor(t,e){this.systemName="AberrationCanvas";this._elapsed=0;this._canvas=t,this._perf=e}onAnimate(t,e){this._elapsed+=t;let i=0;this._perf&&(i=this._perf.startTiming("AberrationVisualSystem")),this._canvas.render(this._elapsed),this._perf&&i&&this._perf.endTiming("AberrationVisualSystem",i)}onPerformanceModeChange(t){t==="performance"?(this._canvas.setPixelSize(128),this._canvas.setStrength(.25)):(this._canvas.setPixelSize(256),this._canvas.setStrength(.4))}destroy(){this._canvas.destroy()}};var Wl=[".main-view-container__scroll-node",".main-viewContainer-scrollNode",".main-viewContainer__scrollNode"].join(", ");function Os(){return document.querySelector(Wl)}var Le=null,Us=null;function Ns(o){return(o||globalThis.year3000System)?.cssController||A()}function ql(){return!1}function Ni(o){if(!ql()){$i(!1,o),Wi(!1,o);return}let t=Os();t&&(Le&&Le.parent===t||(Le?.destroy(),Le=new Oi(t,o),window.__SN_DEBUG_ABERRATION&&console.log("[AberrationManager] canvas attached",t),$i(!0,o),Wi(!0,o),o&&Le&&(Us=new Ui(Le,o.performanceAnalyzer||void 0),o?.registerVisualSystem?.(Us,"critical"),console.log("[AberrationManager] AberrationCanvas attached"))))}function $i(o,t){Ns(t).setVariable("AberrationManager","--sn-nebula-noise-opacity",o?"0.03":"0","normal","nebula-noise-toggle")}function Wi(o,t){let e={"--aberration-webgl-active":o?"1":"0","--aberration-css-enabled":o?"1":"0","--aberration-hybrid-mode":o?"1":"0"};Ns(t).batchSetVariables("AberrationManager",e,"normal","css-aberration-toggle")}function $s(o=null){Ni(o),Le||($i(!1,o),Wi(!1,o));let t=window.Spicetify?.Platform?.History;t?.listen&&t.listen(()=>setTimeout(()=>Ni(o),0)),document.addEventListener("spicetify:appchange",()=>Ni(o));let e=new MutationObserver(()=>{Le?e.disconnect():(Ni(o),Le||($i(!1,o),Wi(!1,o)))});e.observe(document.documentElement,{childList:!0,subtree:!0})}$();ee();_();var Ws="sn_seen_genres_v1",qi=class{constructor(){let t=typeof localStorage<"u"?localStorage.getItem(Ws):null;this.seen=new Set(t?JSON.parse(t):[])}hasSeen(t){return this.seen.has(t.toLowerCase())}markSeen(t){let e=t.toLowerCase();this.seen.has(e)||(this.seen.add(e),this._persist())}_persist(){try{typeof localStorage<"u"&&localStorage.setItem(Ws,JSON.stringify([...this.seen]))}catch{}}};function Yl(o){if(!o.length)return 0;let t=[...o].sort((a,n)=>a-n),e=Math.floor(t.length/2);if(t.length%2!==0)return t[e]??0;let i=t[e-1]??0,r=t[e]??0;return(i+r)/2}var $t=class $t{constructor(t=null,e,i){this.perf=null;this.unsubscribers=[];this.frameDurations=[];this.enabled=!0;this.intensitySetting="balanced";this.intensityFactor=1;this.genreHistory=new qi;this.activeGlowTimeout=null;this.interactionOffHandler=null;this.year3000System=t,this.cssController=e??t?.cssVariableController??A(),this.perf=i||(t?.performanceAnalyzer??null);let r=window.matchMedia("(prefers-reduced-motion: reduce)").matches,a=t?.deviceCapabilityDetector?.deviceCapabilities?.overall;switch(this.intensitySetting=E.get("sn-gradient-intensity")??"balanced",this.intensitySetting){case"disabled":this.enabled=!1;break;case"minimal":this.intensityFactor=.6;break;case"balanced":this.intensityFactor=1;break;case"intense":this.intensityFactor=1.4;break}(r||a==="low")&&(this.enabled=!1),this.enabled?this._subscribe():this.cssController.setVariable("AudioVisualController","--sn-nebula-beat-intensity","0","low","disabled-initialization")}_subscribe(){let t=[p.subscribe("music:beat",e=>{this._handleBeat({energy:e.intensity,bpm:e.bpm})},"AudioVisualController"),p.subscribe("music:track-changed",e=>{this._handleGenreChange({genre:"unknown"})},"AudioVisualController"),p.subscribe("user:scroll",e=>{this._handleScroll({velocity:e.velocity?.x||e.velocity?.y||0,direction:e.direction==="up"?"up":"down"})},"AudioVisualController")];this.unsubscribers=t.map(e=>()=>p.unsubscribe(e))}_handleBeat(t){let e=performance.now(),i=typeof t.energy=="number"?t.energy:.5,r=(.8+Math.min(Math.max(i,0),1)*.6)*this.intensityFactor;this._queueVar("--sn-nebula-beat-intensity",r.toFixed(3),"high","beat-sync");let a=(i*.6).toFixed(3);this._queueVar("--sn-nebula-aberration-strength",a,"normal","beat-aberration"),this._recordDuration(e)}_handleGenreChange(t){let e=performance.now();if(this.genreHistory.hasSeen(t.genre))return;this.genreHistory.markSeen(t.genre);let i=.18*this.intensityFactor;this._queueVar("--sn-nebula-layer-0-opacity",i.toFixed(3),"high","genre-discovery");let r=()=>{this.year3000System?.timerConsolidationSystem?this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer("AudioVisualController-glowTimeout"):this.activeGlowTimeout&&(clearTimeout(this.activeGlowTimeout),this.activeGlowTimeout=null),this._queueVar("--sn-nebula-layer-0-opacity","0.05","normal","genre-clear"),this.interactionOffHandler&&(document.removeEventListener("pointerdown",this.interactionOffHandler),document.removeEventListener("keydown",this.interactionOffHandler),this.interactionOffHandler=null)};this.year3000System?.timerConsolidationSystem?(this.year3000System.timerConsolidationSystem.registerConsolidatedTimer("AudioVisualController-glowTimeout",r,4e3,"normal"),this.activeGlowTimeout=null):this.activeGlowTimeout=setTimeout(r,4e3),this.interactionOffHandler=()=>r(),document.addEventListener("pointerdown",this.interactionOffHandler,{once:!0}),document.addEventListener("keydown",this.interactionOffHandler,{once:!0}),this._queueVar("--sn-nebula-ease-t","1","normal","ease-trigger"),this._recordDuration(e)}_handleScroll(t){let e=performance.now(),i=typeof t.velocity=="number"?t.velocity:0,a=Math.min(Math.abs(i),50)/50*2*this.intensityFactor;this._queueVar("--sn-nebula-layer-3-blur",`calc(var(--sn-depth-layer-3-blur) + ${a.toFixed(2)}px)`,"normal","scroll-blur");let n=150,l=Math.max(Math.min(t.velocity??0,50),-50)/50*50,c=Math.max(140,Math.min(200,n+l));this._queueVar("--sn-nebula-noise-scale-y",`${c.toFixed(1)}%`,"normal","scroll-noise"),this._recordDuration(e)}_queueVar(t,e,i="normal",r="audio-visual"){this.enabled&&this.cssController.setVariable("AudioVisualController",t,e,i,r)}_recordDuration(t){let e=performance.now()-t;if(this.frameDurations.push(e),this.frameDurations.length>$t.FRAME_HISTORY&&this.frameDurations.shift(),this.frameDurations.length===$t.FRAME_HISTORY){let i=Yl(this.frameDurations);i>2&&(console.warn(`[AudioVisualController] Median scripting cost ${i.toFixed(2)} ms exceeds 2 ms budget.`),this._queueVar("--sn-nebula-blend-mode","screen","critical","performance-fallback"))}}destroy(){this.year3000System?.timerConsolidationSystem&&this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer("AudioVisualController-glowTimeout"),this.activeGlowTimeout&&(clearTimeout(this.activeGlowTimeout),this.activeGlowTimeout=null),this.interactionOffHandler&&(document.removeEventListener("pointerdown",this.interactionOffHandler),document.removeEventListener("keydown",this.interactionOffHandler),this.interactionOffHandler=null),this.unsubscribers.forEach(t=>t()),this.unsubscribers=[]}};$t.FRAME_HISTORY=120;var Da=$t;function qs(o=null){let t=globalThis;if(t.__SN_audioVisualController)return t.__SN_audioVisualController;let e=new Da(o);return t.__SN_audioVisualController=e,e}var La=[".main-card-card",".main-card-cardContainer",'.Card[class*="card"]'];function Ys(o={}){let{enableDebug:t=!1,unifiedClass:e="sn-card",onCardDiscovered:i}=o;jl(e,t,i);let r=new MutationObserver(n=>{n.forEach(s=>{s.addedNodes.forEach(l=>{l instanceof Element&&Kl(l,e,t,i)})})}),a=document.querySelector(".main-view-container")||document.body;return r.observe(a,{childList:!0,subtree:!0}),t&&console.log("[CardDOMWatcher] Started watching for card elements"),()=>{r.disconnect(),t&&console.log("[CardDOMWatcher] Stopped watching")}}function jl(o,t,e){let i=0;La.forEach(r=>{document.querySelectorAll(r).forEach(a=>{a.classList.contains(o)||(a.classList.add(o),i++,e?.(a))})}),t&&i>0&&console.log(`[CardDOMWatcher] Normalized ${i} existing cards`)}function Kl(o,t,e,i){La.some(a=>o.matches(a))&&!o.classList.contains(t)&&(o.classList.add(t),i?.(o),e&&console.log("[CardDOMWatcher] Normalized new card:",o.className)),La.forEach(a=>{o.querySelectorAll(a).forEach(n=>{n.classList.contains(t)||(n.classList.add(t),i?.(n),e&&console.log("[CardDOMWatcher] Normalized child card:",n.className))})})}xa();function Tc(){let o=globalThis;if(o.__STARLIGHT_REACT_SHIM__)return;let t=e=>{if(e==="react")return o.Spicetify?.React;if(e==="react-dom")return o.Spicetify?.ReactDOM;throw new Error(`[StarryNight shim] Module '${e}' not available`)};if(typeof o.require=="function"){let e=o.require.bind(o);o.require=i=>i==="react"||i==="react-dom"?t(i):e(i)}else o.require=t;o.__STARLIGHT_REACT_SHIM__=!0}Tc();(async function(){let t=Date.now();if(console.log("\u{1F31F} [Catppuccin StarryNight] Theme entry point starting..."),await zs(1e4)?console.log("\u2705 [StarryNight] Spicetify platform fully ready"):(console.error("\u274C [StarryNight] CRITICAL: Spicetify not fully ready after 10s \u2013 proceeding with degraded visual-only mode."),console.error("\u274C [StarryNight] Available Spicetify objects:",{Spicetify:!!window.Spicetify,showNotification:!!window.Spicetify?.showNotification,Platform:!!window.Spicetify?.Platform})),await Ls(8e3))console.log("\u2705 [StarryNight] Catppuccin theme fully loaded");else{console.error("\u274C [StarryNight] CRITICAL: Catppuccin theme not fully loaded after 8s \u2013 may experience color issues");let h=getComputedStyle(document.documentElement);console.error("\u274C [StarryNight] Current CSS variables:",{base:h.getPropertyValue("--spice-base").trim(),accent:h.getPropertyValue("--spice-accent").trim(),text:h.getPropertyValue("--spice-text").trim()})}let r={player:await Et("Spicetify.Player",3e3),platform:await Et("Spicetify.Platform",3e3),menu:await Et("Spicetify.Menu",2e3),react:await Et("Spicetify.React",2e3),reactDOM:await Et("Spicetify.ReactDOM",2e3)},a=[".main-viewContainer-scrollNode",".main-view-container__scroll-node-child",".main-view-container",".main-container","#main","[data-testid='main-container']"],n=null;for(let h of a)if(n=await Ds(h,1e3),n){console.log(`\u2705 [StarryNight] Found main container using selector: ${h}`);break}n?console.log("\u2705 [StarryNight] Enhanced UI features initialized with DOM container"):(console.warn("\u26A0\uFE0F [StarryNight] No suitable main container found - enhanced UI features disabled"),console.warn("\u26A0\uFE0F [StarryNight] Tried selectors:",a.join(", ")),console.warn("\u26A0\uFE0F [StarryNight] Core functionality (music sync, color extraction) will still work"));let l=!(r.player&&r.platform);l?(console.error("\u274C [StarryNight] DEGRADED MODE: Initializing with limited functionality due to missing APIs"),console.error("\u274C [StarryNight] API availability status:",{player:!!r.player,platform:!!r.platform,menu:!!r.menu,react:!!r.react,reactDOM:!!r.reactDOM,mainContainer:!!n+" (optional)"}),console.error("\u274C [StarryNight] DEGRADED MODE limitations:"),console.error("  - Music synchronization disabled"),console.error("  - Advanced visual effects may not function"),console.error("  - UI integration features disabled"),console.error("  - Color extraction from album art disabled")):console.log("\u2705 [StarryNight] FULL MODE: All required APIs available - initializing complete functionality"),!0&&(w.enableDebug=!0,Promise.resolve().then(()=>(Ks(),js)).then(h=>{h.enableDragCartography?.(),window.getDragMap=h.getDragMap}));let m=new Nt(w);try{if(l)await m.initializeWithAvailableAPIs({player:r.player,platform:r.platform,config:window.Spicetify?.Config,degradedMode:!0}),console.log("\u{1F31F} [StarryNight] Initialized in degraded mode - visual systems only");else{await m.initializeAllSystems(),m.setupMusicAnalysisAndColorExtraction(),console.log("\u{1F31F} [StarryNight] Full initialization complete"),document.body.setAttribute("data-layout","navigation"),console.log("\u{1F30C} [StarryNight] Stellar Navigation Mode activated - grid breathing enabled");let h=Ys({enableDebug:w.enableDebug,onCardDiscovered:g=>{w.enableDebug&&console.log("[CardDOMWatcher] New card discovered and normalized:",g.className)}});m.disposeCardWatcher=h,console.log("\u{1F0CF} [StarryNight] CardDOMWatcher active - normalizing Spotify card variants");try{qs(m),$s(m),Promise.resolve().then(()=>(to(),eo)).then(g=>g.enableEnhancedDragPreview?.()),Promise.resolve().then(()=>(lo(),oo)).then(g=>g.enableQuickAddRadialMenu?.()),n&&Promise.resolve().then(()=>(mo(),uo)).then(g=>g.initializePrismaticScrollSheen?.()),console.log("\u{1F31F} [StarryNight] UI controllers initialized successfully")}catch(g){console.error("[StarryNight] UI controller initialization failed:",g)}}}catch(h){console.error("[StarryNight] System initialization failed:",h)}try{r.react&&r.reactDOM?(await(await Promise.resolve().then(()=>(bo(),fo))).initializeStarryNightSettings?.(),console.log("\u{1F31F} [StarryNight] Spicetify native settings with Year3000System integration initialized")):console.warn("\u{1F31F} [StarryNight] React APIs not available - continuing with CSS-only theme")}catch(h){console.error("[StarryNight] Failed to initialize native settings:",h),console.warn("\u{1F31F} [StarryNight] Continuing with CSS-only theme (no settings UI)")}w.enableDebug&&(window.Y3K={system:m,music:m.musicSyncService,settings:E,debug:u.debug,health:m.systemHealthMonitor,mode:l?"degraded":"full",availableAPIs:r});try{let{SidebarVisualEffectsSystem:h}=await Promise.resolve().then(()=>(ua(),ls)),{SidebarPerformanceCoordinator:g}=await Promise.resolve().then(()=>(Ta(),xs));if(m.performanceAnalyzer){let f=g.getInstance({enableDebug:w.enableDebug,performanceAnalyzer:m.performanceAnalyzer,onFlushComplete:()=>{m.performanceAnalyzer?.emitTrace?.("[SidebarPerformanceCoordinator] Flush completed")}}),S=new h(w,k,m.performanceAnalyzer,m.musicSyncService,m);await S.initialize(),m.sidebarVisualEffectsSystem=S,m.sidebarCoordinator=f}}catch(h){console.error("[StarryNight] Failed to initialize Consolidated Sidebar System",h)}try{let{DepthVisualEffectsController:h}=await Promise.resolve().then(()=>(vo(),yo)),g=new h(w,k,m.performanceAnalyzer,m.musicSyncService);await g.initialize(),m.depthController=g,m.depthConsciousnessController=g,console.log("\u{1F30A} [StarryNight] Depth Visual Effects Controller initialized")}catch(h){console.error("[StarryNight] Failed to initialize DepthVisualEffectsController",h)}try{let{AtmosphericCrystalsSystem:h}=await Promise.resolve().then(()=>(Co(),So)),g=new h;await g.initialize(),m.atmosphericCrystals=g,console.log("\u{1F48E} [StarryNight] Atmospheric Crystals System activated - Year3000 depth rendering")}catch(h){console.error("[StarryNight] Failed to initialize AtmosphericCrystalsSystem",h)}try{let{DynamicGradientStrategy:h}=await Promise.resolve().then(()=>(Li(),ps)),g=new h(w,k,m.performanceAnalyzer,m.musicSyncService);await g.initialize(),m.depthController&&console.log("\u{1F30A} [StarryNight] Consolidated Dynamic Gradient System linked with Depth Controller"),m.dynamicGradientSystem=g,m.livingGradientStrategy=g,console.log("\u{1F30A} [StarryNight] Consolidated Dynamic Gradient Strategy System awakened - unified color processing and visual system lifecycle with performance optimizations")}catch(h){console.error("[StarryNight] Failed to initialize Consolidated Dynamic Gradient Strategy System",h)}try{let{CDFVariableBridge:h}=await Promise.resolve().then(()=>(wo(),Eo));m.cssVariableController&&new h(m.cssVariableController)}catch(h){console.error("[StarryNight] Failed to initialize CDFVariableBridge",h)}let d=Date.now()-t;console.log(`\u{1F30C} Catppuccin StarryNight Theme initialized in ${d}ms (${l?"degraded":"full"} mode). Welcome to the future of sound!`)})();})();
