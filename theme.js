"use strict";(()=>{var Io=Object.create;var _t=Object.defineProperty;var Ro=Object.getOwnPropertyDescriptor;var Do=Object.getOwnPropertyNames;var ko=Object.getPrototypeOf,Lo=Object.prototype.hasOwnProperty;var Wr=(c=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(c,{get:(t,e)=>(typeof require<"u"?require:t)[e]}):c)(function(c){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+c+'" is not supported')});var y=(c,t)=>()=>(c&&(t=c(c=0)),t);var ie=(c,t)=>{for(var e in t)_t(c,e,{get:t[e],enumerable:!0})},qr=(c,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Do(t))!Lo.call(c,n)&&n!==e&&_t(c,n,{get:()=>t[n],enumerable:!(i=Ro(t,n))||i.enumerable});return c};var Yr=(c,t,e)=>(e=c!=null?Io(ko(c)):{},qr(t||!c||!c.__esModule?_t(e,"default",{value:c,enumerable:!0}):e,c)),Bo=c=>qr(_t({},"__esModule",{value:!0}),c);var Kr,jr,et,en=y(()=>{"use strict";Kr={latte:{name:"Latte",base:"#eff1f5",text:"#4c4f69",isDark:!1},frappe:{name:"Frapp\xE9",base:"#303446",text:"#c6d0f5",isDark:!0},macchiato:{name:"Macchiato",base:"#24273a",text:"#cad3f5",isDark:!0},mocha:{name:"Mocha",base:"#1e1e2e",text:"#cdd6f4",isDark:!0}},jr=["rosewater","flamingo","pink","mauve","red","maroon","peach","yellow","green","teal","sky","sapphire","blue","lavender","text","none"],et={flavor:c=>typeof c=="string"&&c in Kr,accentColor:c=>typeof c=="string"&&jr.includes(c),brightnessMode:c=>typeof c=="string"&&["bright","balanced","dark"].includes(c),paletteSystem:c=>typeof c=="string"&&["catppuccin","year3000"].includes(c),gradientIntensity:c=>typeof c=="string"&&["disabled","minimal","balanced","intense"].includes(c),glassmorphismLevel:c=>typeof c=="string"&&["disabled","minimal","moderate","intense"].includes(c),webglEnabled:c=>typeof c=="boolean"||typeof c=="string"&&["true","false"].includes(c),animationQuality:c=>typeof c=="string"&&["auto","low","high"].includes(c),webglQuality:c=>typeof c=="string"&&["low","medium","high"].includes(c)}});var tt,tn,nn,Nt=y(()=>{"use strict";tt={"analogous-flow":{rule:"analogous",angle:30,description:"Flowing cinematic gradients with adjacent hues"},"triadic-trinity":{rule:"triadic",angle:120,description:"Dramatic three-color gradient dynamics"},"complementary-yin-yang":{rule:"complementary",angle:180,description:"Electric contrast gradients with opposing forces"},"tetradic-cosmic-cross":{rule:"tetradic",angle:90,description:"Complex four-color gradient matrix"},"split-complementary-aurora":{rule:"split-complementary",angle:150,description:"Aurora-like gradient flows with polar contrasts"},"monochromatic-meditation":{rule:"monochromatic",angle:0,description:"Intense single-hue gradient depth"}},tn={energyScaling:{low:.8,medium:1.2,high:1.8},valenceScaling:{sad:1,neutral:1.2,happy:1.6},danceabilityEffects:{enable:!0,animationSpeedMultiplier:1.5,blurVariation:.3}},nn={enable:!0,useSmartCalculation:!0,useRealisticData:!0,danceabilityEstimation:{highDance:{min:120,max:140,value:.8},mediumDance:{min:100,max:160,value:.6},lowMediumDance:{min:80,max:180,value:.4},lowDance:{value:.2}},energyEstimation:{tempoWeight:.6,loudnessWeight:.4,tempoRange:{min:60,max:180},loudnessRange:{min:-60,max:0}},danceabilityThresholds:{high:.7,low:.3},energyMultiplierRange:{min:.8,max:1.4},tempoMultipliers:{highDance:1,mediumDance:.75,lowDance:.5},fallbacks:{tempo:120,loudness:-10,danceability:.5,energy:.5,key:0,timeSignature:4}}});var it,$t=y(()=>{"use strict";it={"corporate-safe":{displayName:"Corporate Safe",description:"Subtle gradient elegance with professional restraint and refined color transitions",philosophy:"Gentle gradient flows that maintain workspace harmony while providing sophisticated visual depth",multipliers:{opacity:.2,saturation:1.15,brightness:1.08,contrast:1.05,musicEnergyBoost:.4,kineticIntensity:.3,temporalPlayFactor:.2,aestheticGravityStrength:.2,emergentChoreography:!1,visualIntensityBase:.9},features:{rippleEffects:!1,temporalEcho:!1,particleStreams:!1,predictiveHighlights:!0,glassEffects:!0,beatSync:!1,colorHarmony:!1,aestheticGravity:!1},performance:{maxParticles:0,animationThrottle:32,enableGPUAcceleration:!1,reducedMotion:!0}},"artist-vision":{displayName:"Artist Vision",description:"Cinematic gradient expression with vibrant, flowing color transitions",philosophy:"Dramatic gradient harmonies that create depth and emotional resonance through bold color interactions",multipliers:{opacity:.35,saturation:1.45,brightness:1.25,contrast:1.3,musicEnergyBoost:1.2,kineticIntensity:.8,temporalPlayFactor:.7,aestheticGravityStrength:.6,emergentChoreography:!0,visualIntensityBase:1.2},features:{rippleEffects:!0,temporalEcho:!0,particleStreams:!0,predictiveHighlights:!0,glassEffects:!0,beatSync:!0,colorHarmony:!0,aestheticGravity:!0},performance:{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1}},"cosmic-maximum":{displayName:"Cosmic Maximum",description:"Ultra-intense cinematic gradients with maximum color saturation and fluid dynamics",philosophy:"Maximum gradient intensity through electric color combinations that create immersive visual landscapes",multipliers:{opacity:.55,saturation:1.65,brightness:1.35,contrast:1.5,musicEnergyBoost:2.5,kineticIntensity:2,temporalPlayFactor:3,aestheticGravityStrength:2,emergentChoreography:!0,visualIntensityBase:1.8},features:{rippleEffects:!0,temporalEcho:!0,particleStreams:!0,predictiveHighlights:!0,glassEffects:!0,beatSync:!0,colorHarmony:!0,aestheticGravity:!0},performance:{maxParticles:50,animationThrottle:30,enableGPUAcceleration:!0,reducedMotion:!1}}}});var Wt,rn,an=y(()=>{"use strict";Wt={low:{maxParticles:15,animationThrottle:32,enableGPUAcceleration:!1,enableAdvancedShaders:!1,textureResolution:.5},balanced:{maxParticles:40,animationThrottle:16,enableGPUAcceleration:!0,enableAdvancedShaders:!1,textureResolution:1},high:{maxParticles:75,animationThrottle:16,enableGPUAcceleration:!0,enableAdvancedShaders:!0,textureResolution:1},ultra:{maxParticles:150,animationThrottle:8,enableGPUAcceleration:!0,enableAdvancedShaders:!0,textureResolution:2}},rn={level:"info",performance:{enableFrameBudgetWarnings:!0,throttleWarnings:!0,throttleInterval:5e3,enableAdaptiveDegradation:!0}}});var Qr,Xr,Zr,qt=y(()=>{"use strict";Qr="sn-harmonic-intensity",Xr="sn-harmonic-evolution",Zr="sn-glassmorphism-level"});function Yt(c,t){return be[c].validator(t)}function Kt(c,t){let e=be[c];return e.parser?e.parser(t):e.validator(t)?t:null}function sn(c,t){let e=be[c];return e.serializer?e.serializer(t):String(t)}function jt(c){return be[c].defaultValue}function ht(){return Object.keys(be)}function Qt(c){return c in be}var be,on=y(()=>{"use strict";Nt();$t();en();be={"catppuccin-flavor":{defaultValue:"mocha",validator:et.flavor,description:"Catppuccin color theme variant",category:"core"},"catppuccin-accentColor":{defaultValue:"mauve",validator:et.accentColor,description:"Primary accent color for UI elements",category:"core"},"sn-brightness-mode":{defaultValue:"bright",validator:et.brightnessMode,description:"Overall theme brightness level",category:"core"},"sn-palette-system":{defaultValue:"catppuccin",validator:et.paletteSystem,description:"Color palette system (Catppuccin or Year 3000)",category:"advanced"},"sn-artistic-mode":{defaultValue:"artist-vision",validator:c=>typeof c=="string"&&c in it,description:"Visual intensity and behavior preset",category:"advanced"},"sn-current-harmonic-mode":{defaultValue:"analogous-flow",validator:c=>typeof c=="string"&&c in tt,description:"Color harmony rule for music synchronization",category:"advanced"},"sn-harmonic-intensity":{defaultValue:.7,validator:c=>typeof c=="number"&&c>=0&&c<=1,parser:c=>{let t=parseFloat(c);return!isNaN(t)&&t>=0&&t<=1?t:null},serializer:c=>c.toString(),description:"Intensity of color harmony effects (0-1)",category:"advanced"},"sn-harmonic-evolution":{defaultValue:!0,validator:c=>typeof c=="boolean",parser:c=>c==="true"?!0:c==="false"?!1:null,serializer:c=>c.toString(),description:"Enable dynamic color harmony evolution",category:"advanced"},"sn-gradient-intensity":{defaultValue:"balanced",validator:c=>typeof c=="string"&&["disabled","minimal","balanced","intense"].includes(c),description:"Master control for all gradient background effects",category:"visual"},"sn-glassmorphism-level":{defaultValue:"balanced",validator:c=>typeof c=="string"&&["disabled","minimal","balanced","intense"].includes(c),description:"Glass-like transparency effects intensity",category:"visual"},"sn-webgl-enabled":{defaultValue:!0,validator:c=>typeof c=="boolean",parser:c=>c==="true"?!0:c==="false"?!1:null,serializer:c=>c.toString(),description:"Enable WebGL-accelerated visual effects",category:"performance"},"sn-animation-quality":{defaultValue:"auto",validator:c=>typeof c=="string"&&["auto","low","high"].includes(c),description:"Animation performance vs quality balance",category:"performance"},"sn-webgl-quality":{defaultValue:"medium",validator:c=>typeof c=="string"&&["low","medium","high"].includes(c),description:"WebGL rendering quality level",category:"performance"}}});var gt,cn=y(()=>{"use strict";on();gt=class{constructor(t){this.changeListeners=new Set;this.cache=new Map;this.storage=t}get(t){if(this.cache.has(t))return this.cache.get(t);let e=be[t],i=this.storage.get(t);if(i==null){let r=e.defaultValue;return this.cache.set(t,r),r}let n=Kt(t,i);if(n===null){console.warn(`[TypedSettingsManager] Invalid stored value for ${t}: "${i}", using default`);let r=e.defaultValue;return this.cache.set(t,r),r}return this.cache.set(t,n),n}set(t,e){if(!Yt(t,e))return console.error(`[TypedSettingsManager] Invalid value for ${t}:`,e),!1;let i=this.cache.get(t)??this.get(t),n=sn(t,e),r=this.storage.set(t,n);if(r){this.cache.set(t,e);let a={settingKey:t,oldValue:i,newValue:e,timestamp:Date.now()};this.notifyChangeListeners(a)}return r}getMultiple(t){let e={};for(let i of t)e[i]=this.get(i);return e}setMultiple(t){let e={};for(let[i,n]of Object.entries(t))Qt(i)&&(e[i]=this.set(i,n));return e}getAllSettings(){let t={};for(let e of ht())t[e]=this.get(e);return t}reset(t){let e=jt(t);return this.set(t,e)}resetAll(){let t={};for(let e of ht())t[e]=this.reset(e);return t}exists(t){return this.storage.get(t)!==null}remove(t){let e=this.storage.remove(t);return e&&this.cache.delete(t),e}clearCache(){this.cache.clear()}onChange(t){this.changeListeners.add(t)}offChange(t){this.changeListeners.delete(t)}notifyChangeListeners(t){for(let e of this.changeListeners)try{e(t)}catch(i){console.error("[TypedSettingsManager] Error in change listener:",i)}}validateAllSettings(){let t={valid:0,invalid:[],missing:[]};for(let e of ht()){let i=this.storage.get(e);if(i===null){t.missing.push({key:e,usingDefault:jt(e)});continue}Kt(e,i)===null?t.invalid.push({key:e,value:i,error:"Failed to parse or validate value"}):t.valid++}return t}export(){return this.getAllSettings()}import(t){let e={imported:0,failed:[]};for(let[i,n]of Object.entries(t)){if(!Qt(i)){e.failed.push({key:i,error:"Unknown setting key"});continue}if(!Yt(i,n)){e.failed.push({key:i,error:"Invalid value for setting"});continue}this.set(i,n)?e.imported++:e.failed.push({key:i,error:"Failed to store setting"})}return e}}});function ln(){return new We}var We,un=y(()=>{"use strict";We=class{constructor(){this._available=null}isAvailable(){if(this._available!==null)return this._available;try{return this._available=typeof Spicetify<"u"&&typeof Spicetify.LocalStorage?.get=="function"&&typeof Spicetify.LocalStorage?.set=="function",this._available&&Spicetify.LocalStorage.get("__test__"),this._available}catch(t){return console.warn("[SpicetifyStorageAdapter] Spicetify.LocalStorage not available:",t),this._available=!1,!1}}get(t){if(!this.isAvailable())return console.warn(`[SpicetifyStorageAdapter] Cannot get ${t}: Spicetify not available`),null;try{return Spicetify.LocalStorage.get(t)}catch(e){return console.error(`[SpicetifyStorageAdapter] Error reading key ${t}:`,e),null}}set(t,e){if(!this.isAvailable())return console.warn(`[SpicetifyStorageAdapter] Cannot set ${t}: Spicetify not available`),!1;try{return Spicetify.LocalStorage.set(t,e),!0}catch(i){return console.error(`[SpicetifyStorageAdapter] Error setting key ${t}:`,i),!1}}remove(t){if(!this.isAvailable())return console.warn(`[SpicetifyStorageAdapter] Cannot remove ${t}: Spicetify not available`),!1;try{return typeof Spicetify.LocalStorage.remove=="function"?Spicetify.LocalStorage.remove(t):Spicetify.LocalStorage.set(t,null),!0}catch(e){return console.error(`[SpicetifyStorageAdapter] Error removing key ${t}:`,e),!1}}healthCheck(){let t={available:!1,readable:!1,writable:!1,issues:[]};if(t.available=this.isAvailable(),!t.available)return t.issues.push("Spicetify.LocalStorage not available"),t;try{this.get("__health_check_read__"),t.readable=!0}catch(e){t.issues.push(`Read test failed: ${e}`)}try{let e="__health_check_write__",i="test_"+Date.now();this.set(e,i)?this.get(e)===i?(t.writable=!0,this.remove(e)):t.issues.push("Write-read consistency test failed"):t.issues.push("Write operation failed")}catch(e){t.issues.push(`Write test failed: ${e}`)}return t}getDiagnostics(){let t=[];return typeof Spicetify<"u"&&Spicetify.LocalStorage&&t.push(...Object.getOwnPropertyNames(Spicetify.LocalStorage)),{spicetifyVersion:typeof Spicetify<"u"?Spicetify.version:void 0,apiMethods:t,testResults:this.healthCheck()}}}});function mn(c){return new nt(c)}var nt,dn=y(()=>{"use strict";nt=class{constructor(t="sn-"){this.prefix=t}getPrefixedKey(t){return t.startsWith(this.prefix)?t:`${this.prefix}${t}`}isAvailable(){try{return typeof localStorage<"u"&&localStorage!==null}catch{return!1}}get(t){if(!this.isAvailable())return console.warn(`[BrowserStorageAdapter] localStorage not available for key: ${t}`),null;try{return localStorage.getItem(this.getPrefixedKey(t))}catch(e){return console.error(`[BrowserStorageAdapter] Error reading key ${t}:`,e),null}}set(t,e){if(!this.isAvailable())return console.warn(`[BrowserStorageAdapter] localStorage not available for key: ${t}`),!1;try{return localStorage.setItem(this.getPrefixedKey(t),e),!0}catch(i){return console.error(`[BrowserStorageAdapter] Error setting key ${t}:`,i),!1}}remove(t){if(!this.isAvailable())return console.warn(`[BrowserStorageAdapter] localStorage not available for key: ${t}`),!1;try{return localStorage.removeItem(this.getPrefixedKey(t)),!0}catch(e){return console.error(`[BrowserStorageAdapter] Error removing key ${t}:`,e),!1}}getAllKeys(){if(!this.isAvailable())return[];let t=[];try{for(let e=0;e<localStorage.length;e++){let i=localStorage.key(e);i&&i.startsWith(this.prefix)&&t.push(i.substring(this.prefix.length))}}catch(e){console.error("[BrowserStorageAdapter] Error enumerating keys:",e)}return t}clear(){if(!this.isAvailable())return!1;try{let t=this.getAllKeys();for(let e of t)localStorage.removeItem(this.getPrefixedKey(e));return!0}catch(t){return console.error("[BrowserStorageAdapter] Error clearing storage:",t),!1}}getUsageStats(){let t={totalKeys:0,totalSize:0,avgKeySize:0};if(!this.isAvailable())return t;try{let e=this.getAllKeys();t.totalKeys=e.length;for(let i of e){let n=this.get(i);n!==null&&(t.totalSize+=i.length+n.length)}t.avgKeySize=t.totalKeys>0?t.totalSize/t.totalKeys:0,typeof navigator<"u"&&"storage"in navigator&&"estimate"in navigator.storage&&navigator.storage.estimate().then(i=>{i.quota!==void 0&&(t.availableQuota=i.quota)}).catch(()=>{})}catch(e){console.error("[BrowserStorageAdapter] Error calculating usage stats:",e)}return t}}});function Jr(){return hn||(hn=new Xt),hn}function qe(){return Jr().getSettings()}var Xt,hn,x,ea=y(()=>{"use strict";cn();un();dn();Xt=class{constructor(t){this.storageAdapter=t||this.detectBestStorage(),this.settingsManager=new gt(this.storageAdapter)}detectBestStorage(){let t=ln(),e=t.healthCheck();if(e.available&&e.readable&&e.writable)return console.log("[SettingsProvider] Using Spicetify storage adapter"),t;let i=mn();return console.log("[SettingsProvider] Using browser storage adapter (localStorage)"),i}getSettings(){return this.settingsManager}getStorage(){return this.storageAdapter}getDiagnostics(){let t=this.storageAdapter instanceof We?"spicetify":this.storageAdapter instanceof nt?"browser":"unknown",e=null;return this.storageAdapter instanceof We&&(e=this.storageAdapter.healthCheck()),{storageType:t,storageHealth:e,settingsValidation:this.settingsManager.validateAllSettings(),totalSettings:Object.keys(this.settingsManager.getAllSettings()).length}}async migrateFromLegacyStorage(t){console.log("[SettingsProvider] Starting legacy settings migration...");let e=this.settingsManager.import(t);return e.imported>0&&console.log(`[SettingsProvider] Successfully migrated ${e.imported} settings`),e.failed.length>0&&console.warn(`[SettingsProvider] Failed to migrate ${e.failed.length} settings:`,e.failed),{migrated:e.imported,failed:e.failed}}healthCheck(){let t=this.getDiagnostics(),e=t.settingsValidation,i={overall:"healthy",storage:{type:t.storageType,available:!0,issues:[]},settings:{valid:e.valid,invalid:e.invalid.length,missing:e.missing.length},recommendations:[]};return t.storageHealth&&(i.storage.available=t.storageHealth.available,t.storageHealth.issues&&(i.storage.issues=t.storageHealth.issues)),!i.storage.available||i.storage.issues.length>0?(i.overall="unhealthy",i.recommendations.push("Storage system needs attention")):i.settings.invalid>0?(i.overall="degraded",i.recommendations.push("Some settings have invalid values")):i.settings.missing>5&&(i.overall="degraded",i.recommendations.push("Many settings are using defaults")),i.settings.invalid>0&&i.recommendations.push("Run settings validation and repair"),t.storageType==="browser"&&i.recommendations.push("Consider using in Spicetify environment for better integration"),i}},hn=null;x={get:c=>qe().get(c),set:(c,t)=>qe().set(c,t),reset:c=>qe().reset(c),onChange:c=>qe().onChange(c),export:()=>qe().export(),import:c=>qe().import(c)}});var ye=y(()=>{"use strict";en();Nt();$t();an();qt();cn();on();ea();un();dn();ye()});var se,Ye,w,U=y(()=>{"use strict";ye();Nt();$t();an();se=tt,Ye=it,w={enableDebug:!0,enableContextualIntelligence:!0,paletteSystem:"catppuccin",performanceProfiles:Wt,logging:rn,healthCheckInterval:1e4,visual:{lightweightParticleSystem:{mode:"artist-vision"},dimensionalNexusSystem:{mode:"artist-vision"},dataGlyphSystem:{mode:"artist-vision"},beatSyncVisualSystem:{mode:"artist-vision"},behavioralPredictionEngine:{mode:"artist-vision"},predictiveMaterializationSystem:{mode:"artist-vision"},sidebarConsciousnessSystem:{mode:"artist-vision"}},enableColorExtraction:!0,enableMusicAnalysis:!0,enableCosmicSync:!0,musicModulationIntensity:.4,artisticMode:"artist-vision",boundGetCurrentMultipliers:null,boundGetCurrentFeatures:null,boundGetCurrentPerformanceSettings:null,_pendingArtisticMode:null,init(){return this.boundGetCurrentMultipliers=this.getCurrentMultipliers.bind(this),this.boundGetCurrentFeatures=this.getCurrentFeatures.bind(this),this.boundGetCurrentPerformanceSettings=this.getCurrentPerformanceSettings.bind(this),!this.artisticMode||!this.paletteSystem?(this.enableDebug&&console.log(`\u{1F3A8} [YEAR3000_CONFIG] Loading preferences (current: artistic=${this.artisticMode}, palette=${this.paletteSystem})`),this.loadArtisticPreference()):this.enableDebug&&console.log(`\u{1F3A8} [YEAR3000_CONFIG] Skipping preference load (current: artistic=${this.artisticMode}, palette=${this.paletteSystem})`),this._pendingArtisticMode&&this.isFullyInitialized()&&(this.enableDebug&&console.log(`\u{1F3A8} [YEAR3000_CONFIG] Applying pending artistic mode: ${this._pendingArtisticMode}`),this.setArtisticMode(this._pendingArtisticMode),this._pendingArtisticMode=null),this.enableDebug&&console.log("\u{1F527} [YEAR3000_CONFIG] Initialized with context-bound methods"),this},currentHarmonicMode:"analogous-flow",harmonicBaseColor:null,harmonicIntensity:.85,harmonicEvolution:!0,musicVisualSync:{...tn,enhancedBPM:nn},getCurrentModeProfile(){let c=this.artisticMode||"artist-vision";return Ye[c]||Ye["artist-vision"]},getCurrentMultipliers(){try{if(typeof this.getCurrentModeProfile!="function")return console.warn("[YEAR3000_CONFIG] getCurrentModeProfile method not available, using fallback multipliers"),this.artisticMultipliers;let c=this.getCurrentModeProfile();return!c||!c.multipliers?(console.warn("[YEAR3000_CONFIG] Invalid profile or missing multipliers, using fallback"),this.artisticMultipliers):c.multipliers}catch(c){return console.error("[YEAR3000_CONFIG] Error in getCurrentMultipliers:",c),this.artisticMultipliers}},getCurrentFeatures(){try{if(typeof this.getCurrentModeProfile!="function")return console.warn("[YEAR3000_CONFIG] getCurrentModeProfile method not available, using fallback features"),{enableAdvancedEffects:!0,enableHarmony:!0,beatSync:!0,colorHarmony:!0};let c=this.getCurrentModeProfile();return!c||!c.features?(console.warn("[YEAR3000_CONFIG] Invalid profile or missing features, using fallback"),{enableAdvancedEffects:!0,enableHarmony:!0,beatSync:!0,colorHarmony:!0}):c.features}catch(c){return console.error("[YEAR3000_CONFIG] Error in getCurrentFeatures:",c),{enableAdvancedEffects:!0,enableHarmony:!0,beatSync:!0,colorHarmony:!0}}},getCurrentPerformanceSettings(){try{if(typeof this.getCurrentModeProfile!="function")return console.warn("[YEAR3000_CONFIG] getCurrentModeProfile method not available, using fallback performance settings"),{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1};let c=this.getCurrentModeProfile();return!c||!c.performance?(console.warn("[YEAR3000_CONFIG] Invalid profile or missing performance settings, using fallback"),{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1}):c.performance}catch(c){return console.error("[YEAR3000_CONFIG] Error in getCurrentPerformanceSettings:",c),{maxParticles:20,animationThrottle:16,enableGPUAcceleration:!0,reducedMotion:!1}}},isFullyInitialized(){return["setArtisticMode","getCurrentModeProfile","getCurrentMultipliers","getCurrentFeatures","getCurrentPerformanceSettings"].every(t=>typeof this[t]=="function")},safeSetArtisticMode(c){return this.isFullyInitialized()?this.setArtisticMode(c):(console.warn("[YEAR3000_CONFIG] Not fully initialized, deferring artistic mode change"),this._pendingArtisticMode=c,!1)},setArtisticMode(c){let t=Object.keys(Ye);if(t.includes(c)){let e=this.artisticMode;return this.artisticMode=c,this.enableDebug&&(console.log(`\u{1F3A8} [YEAR3000_CONFIG] Artistic mode changed: ${e} \u2192 ${c}`),console.log("\u{1F3A8} [YEAR3000_CONFIG] New profile:",this.getCurrentModeProfile())),typeof document<"u"&&document.dispatchEvent(new CustomEvent("year3000ArtisticModeChanged",{detail:{previousMode:e,newMode:c,profile:this.getCurrentModeProfile()}})),typeof globalThis.year3000System<"u"&&globalThis.year3000System.setGradientParameters&&globalThis.year3000System.setGradientParameters(document.documentElement),!0}return console.warn(`[YEAR3000_CONFIG] Invalid artistic mode: ${c}. Valid modes:`,t),!1},setLoggingLevel(c){let t=["off","error","warn","info","debug","verbose"];return t.includes(c)?(this.logging.level=c,c!=="off"&&console.log(`\u{1F527} [YEAR3000_CONFIG] Logging level set to: ${c}`),!0):(console.warn(`[YEAR3000_CONFIG] Invalid logging level: ${c}. Valid levels:`,t),!1)},disablePerformanceWarnings(){this.logging.performance.enableFrameBudgetWarnings=!1,console.log("\u{1F527} [YEAR3000_CONFIG] Performance warnings disabled")},enablePerformanceWarnings(){this.logging.performance.enableFrameBudgetWarnings=!0,console.log("\u{1F527} [YEAR3000_CONFIG] Performance warnings enabled")},setPerformanceWarningThrottle(c){return typeof c=="number"&&c>=0?(this.logging.performance.throttleInterval=c,this.logging.performance.throttleWarnings=c>0,console.log(`\u{1F527} [YEAR3000_CONFIG] Performance warning throttle set to: ${c}ms`),!0):(console.warn("[YEAR3000_CONFIG] Invalid throttle interval. Must be a non-negative number."),!1)},setupForProduction(){this.setLoggingLevel("warn"),this.disablePerformanceWarnings(),this.logging.performance.enableAdaptiveDegradation=!0,console.log("\u{1F527} [YEAR3000_CONFIG] Configured for production environment")},setupForDevelopment(){this.setLoggingLevel("debug"),this.enablePerformanceWarnings(),this.setPerformanceWarningThrottle(2e3),this.logging.performance.enableAdaptiveDegradation=!0,console.log("\u{1F527} [YEAR3000_CONFIG] Configured for development environment")},setupForDebugging(){this.setLoggingLevel("verbose"),this.enablePerformanceWarnings(),this.setPerformanceWarningThrottle(500),this.logging.performance.enableAdaptiveDegradation=!1,console.log("\u{1F527} [YEAR3000_CONFIG] Configured for debugging environment")},validateConfigHealth(){let c={overallStatus:"healthy",issues:[],dynamicChecks:{}},e=Object.keys(this).filter(n=>typeof n=="string").filter(n=>typeof this[n]=="function");for(let n of e)this.hasOwnProperty(n)||c.issues.push({key:String(n),severity:"warning",message:`Method ${n} is not an own property, may indicate prototype chain issues.`});let i=n=>{if(!Ye[n]){c.issues.push({key:`artisticMode:${n}`,severity:"critical",message:`Artistic mode profile for '${n}' is missing.`});return}c.dynamicChecks[`${n}Profile`]="ok"};return i(this.artisticMode),i("artist-vision"),i("corporate-safe"),c.issues.length>0&&(c.overallStatus=c.issues.some(n=>n.severity==="critical")?"critical":"unhealthy"),this.enableDebug&&console.log("[YEAR3000_CONFIG] Health Check Report:",c),c},loadArtisticPreference(){try{let c=x.get("sn-artistic-mode"),t=Object.keys(Ye);c&&t.includes(String(c))&&this.artisticMode!==c?(this.artisticMode=String(c),this.enableDebug&&console.log(`\u{1F3A8} [YEAR3000_CONFIG] Updated artistic mode from storage: ${c}`)):!c&&this.artisticMode!=="artist-vision"&&(this.artisticMode="artist-vision",this.enableDebug&&console.log("\u{1F3A8} [YEAR3000_CONFIG] Reset artistic mode to default: artist-vision"));let e=x.get("sn-palette-system");e&&["catppuccin","year3000"].includes(String(e))&&this.paletteSystem!==e?(this.paletteSystem=String(e),this.enableDebug&&console.log(`\u{1F3A8} [YEAR3000_CONFIG] Updated palette system from storage: ${e}`)):!e&&this.paletteSystem!=="catppuccin"&&(this.paletteSystem="catppuccin",this.enableDebug&&console.log("\u{1F3A8} [YEAR3000_CONFIG] Reset palette system to default: catppuccin")),this.enableDebug&&(console.log(`\u{1F3A8} [YEAR3000_CONFIG] Current artistic preference: ${this.artisticMode}`),console.log(`\u{1F3A8} [YEAR3000_CONFIG] Current palette system: ${this.paletteSystem}`))}catch(c){this.enableDebug&&console.warn("\u{1F3A8} [YEAR3000_CONFIG] Failed to load preferences:",c),this.artisticMode="artist-vision",this.paletteSystem="catppuccin"}}};typeof w.init=="function"&&w.init()});var me,u,ta,A=y(()=>{"use strict";U();me=class c{constructor(t={}){this.registeredSystems=new Map;this.reportHistory=[];this.monitoring=!1;this.monitoringInterval=null;this.performanceMetrics=new Map;this.config={enableConsoleReporting:w.enableDebug,reportingInterval:3e4,enablePerformanceTracking:!0,enableSystemHealthMonitoring:!0,maxHistoryEntries:50,verboseLogging:w.enableDebug,...t},this.config.enableConsoleReporting&&console.log("\u{1F527} [UnifiedDebugManager] Debug system initialized")}static getInstance(t){return c.instance||(c.instance=new c(t)),c.instance}registerSystem(t,e,i="unified"){let n={name:t,type:i,initialized:e.initialized||!1,healthy:!0,lastUpdate:Date.now(),issues:[],metrics:{}};this.registeredSystems.set(t,n),this.config.verboseLogging&&console.log(`\u{1F527} [UnifiedDebugManager] Registered system: ${t} (${i})`),this.registeredSystems.size===1&&!this.monitoring&&this.startMonitoring()}unregisterSystem(t){this.registeredSystems.delete(t),this.performanceMetrics.delete(t),this.config.verboseLogging&&console.log(`\u{1F527} [UnifiedDebugManager] Unregistered system: ${t}`),this.registeredSystems.size===0&&this.stopMonitoring()}updateSystem(t,e){let i=this.registeredSystems.get(t);i&&(Object.assign(i,e,{lastUpdate:Date.now()}),this.registeredSystems.set(t,i))}recordMetric(t,e,i){if(!this.config.enablePerformanceTracking)return;let n=this.registeredSystems.get(t);n&&(n.metrics[e]=i,n.lastUpdate=Date.now());let r=`${t}_${e}`,a=this.performanceMetrics.get(r)||[];a.push(i),a.length>100&&a.splice(0,a.length-100),this.performanceMetrics.set(r,a)}recordIssue(t,e){let i=this.registeredSystems.get(t);i&&(i.issues.push(e),i.healthy=!1,i.lastUpdate=Date.now(),this.config.verboseLogging&&console.warn(`\u26A0\uFE0F [${t}] ${e}`))}async performHealthCheck(){let t=Date.now(),e=[],i=0,n=0,r=0,a=0,s=0;for(let[h,p]of this.registeredSystems)try{let b=null,v=p.initialized,C=globalThis.year3000System;if(C){if(C.facadeCoordinator){try{b=C.facadeCoordinator.getCachedNonVisualSystem?.(h)||await C.facadeCoordinator.getNonVisualSystem?.(h)}catch{}if(!b)try{b=C.facadeCoordinator.getVisualSystem?.(h)}catch{}}if(!b){let E=h.charAt(0).toLowerCase()+h.slice(1);b=C[E]||C[h]}}if(b||(b=globalThis[h]),b){if(typeof b.initialized=="boolean")v=b.initialized;else if(typeof b.isInitialized=="function")try{v=await b.isInitialized()}catch{}else if(typeof b.getInitializationStatus=="function")try{let E=await b.getInitializationStatus();v=E?.initialized??E?.ready??!1}catch{}}let P=p.initialized;if(p.initialized=v,p.lastUpdate=t,this.config.verboseLogging&&P!==v&&console.log(`\u{1F527} [UnifiedDebugManager] ${h} initialization status updated: ${P} \u2192 ${v}`),b&&typeof b.healthCheck=="function"){let E=await b.healthCheck();p.healthy=E.healthy??E.ok,E.ok?p.issues=[]:p.issues=[E.details||"Health check failed"]}else p.healthy=v,v?p.issues=[]:p.issues=["System not initialized"];p.frameTime&&(r+=p.frameTime,s++),p.memoryUsage&&(a+=p.memoryUsage),p.healthy?i++:n+=p.issues.length,e.push({...p})}catch(b){p.healthy=!1,p.issues=[`Health check error: ${b}`],n++,this.config.verboseLogging&&console.error(`\u274C [${h}] Health check failed:`,b)}let o=this.registeredSystems.size>0?i/this.registeredSystems.size:1,l;if(o>=.9?l="excellent":o>=.7?l="good":o>=.5?l="degraded":l="critical",this.config.verboseLogging){console.log("\u{1F527} [UnifiedDebugManager] System initialization status for recommendations:");for(let h of e)console.log(`   ${h.name}: ${h.initialized?"\u2705":"\u274C"} initialized`)}let m=this.generateRecommendations(e,l),d={timestamp:t,overallHealth:l,systemCount:this.registeredSystems.size,healthySystems:i,totalIssues:n,systemDetails:e,performance:{avgFrameTime:s>0?r/s:0,totalMemoryMB:a,cpuUsageEstimate:this.estimateCPUUsage()},recommendations:m};return this.reportHistory.push(d),this.reportHistory.length>this.config.maxHistoryEntries&&this.reportHistory.splice(0,this.reportHistory.length-this.config.maxHistoryEntries),d}generateRecommendations(t,e){let i=[];e==="critical"&&i.push("\u{1F6A8} Critical: Multiple systems failing - check console for errors");let n=t.filter(s=>!s.initialized);n.length>0&&i.push(`\u26A0\uFE0F ${n.length} systems not initialized: ${n.map(s=>s.name).join(", ")}`);let r=t.filter(s=>s.frameTime&&s.frameTime>16.67);r.length>0&&i.push(`\u{1F40C} Performance: ${r.length} systems exceeding 16.67ms frame time`);let a=t.filter(s=>s.memoryUsage&&s.memoryUsage>50);return a.length>0&&i.push(`\u{1F4BE} Memory: ${a.length} systems using >50MB`),i.length===0&&i.push("\u2705 All systems operating within normal parameters"),i}estimateCPUUsage(){let t=0,e=0;for(let n of this.registeredSystems.values())n.frameTime&&(t+=n.frameTime,e++);if(e===0)return 0;let i=t/e;return Math.min(100,i/16.67*5)}startMonitoring(){this.monitoring||(this.monitoring=!0,this.monitoringInterval=window.setInterval(()=>{this.performHealthCheck().then(t=>{this.config.enableConsoleReporting&&this.logHealthReport(t)})},this.config.reportingInterval),this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] Monitoring started"))}stopMonitoring(){this.monitoring&&(this.monitoring=!1,this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] Monitoring stopped"))}logHealthReport(t){if(!t){this.performHealthCheck().then(i=>this.logHealthReport(i));return}let e={excellent:"\u{1F31F}",good:"\u2705",degraded:"\u26A0\uFE0F",critical:"\u{1F6A8}"}[t.overallHealth];console.group(`${e} Year 3000 System Health Report - ${new Date().toLocaleTimeString()}`),console.log(`\u{1F4CA} Overall: ${t.overallHealth.toUpperCase()} (${t.healthySystems}/${t.systemCount} healthy)`),t.totalIssues>0&&console.log(`\u{1F6A8} Issues: ${t.totalIssues} total`),console.log(`\u26A1 Performance: ${t.performance.avgFrameTime.toFixed(2)}ms avg frame, ${t.performance.totalMemoryMB.toFixed(1)}MB memory, ~${t.performance.cpuUsageEstimate.toFixed(1)}% CPU`),t.systemDetails.length>0&&(console.group("\u{1F527} System Details"),t.systemDetails.forEach(i=>{let n=i.healthy?"\u2705":"\u274C",r=i.frameTime?` (${i.frameTime.toFixed(2)}ms)`:"";console.log(`${n} ${i.name} [${i.type}]${r}`),i.issues.length>0&&i.issues.forEach(a=>{console.log(`    \u26A0\uFE0F ${a}`)})}),console.groupEnd()),t.recommendations.length>0&&(console.group("\u{1F4A1} Recommendations"),t.recommendations.forEach(i=>console.log(`  ${i}`)),console.groupEnd()),console.groupEnd()}getLatestReport(){return this.reportHistory[this.reportHistory.length-1]||null}getReportHistory(){return[...this.reportHistory]}getSystemInfo(t){return this.registeredSystems.get(t)||null}getAllSystems(){return Array.from(this.registeredSystems.values())}async checkHealth(){let t=await this.performHealthCheck();this.logHealthReport(t)}updateConfig(t){this.config={...this.config,...t},this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] Configuration updated:",t)}reset(){this.stopMonitoring(),this.registeredSystems.clear(),this.reportHistory=[],this.performanceMetrics.clear(),this.config.verboseLogging&&console.log("\u{1F527} [UnifiedDebugManager] System reset")}destroy(){this.reset(),c.instance=null}},u={debug:{log:(c,t,...e)=>{w?.enableDebug&&console.log(`[${c}] ${t}`,...e)},error:(c,t,e)=>{console.error(`[${c}] ${t}`,e),me.getInstance().recordIssue(c,`${t}${e?`: ${e}`:""}`)},warn:(c,t,...e)=>{console.warn(`[${c}] ${t}`,...e),me.getInstance().recordIssue(c,t)},metric:(c,t,e)=>{me.getInstance().recordMetric(c,t,e)},register:(c,t,e)=>{me.getInstance().registerSystem(c,t,e)},unregister:c=>{me.getInstance().unregisterSystem(c)},checkHealth:()=>me.getInstance().checkHealth(),getReport:()=>me.getInstance().getLatestReport()}};typeof window<"u"&&(window.UnifiedDebugManager=me,window.Y3K=u,console.log("\u{1F527} [UnifiedDebugManager] Global debug interface available:"),console.log("  Y3K.debug.checkHealth() - Check system health"),console.log("  Y3K.debug.getReport() - Get latest debug report"),console.log("  UnifiedDebugManager.getInstance() - Get debug manager"));ta=me});var rt,gn=y(()=>{"use strict";A();rt=class{constructor(t,e=null,i=null,n=null){this.musicSyncService=null;this.emotionalGradientMapper=null;this.settingsManager=null;this.currentGenre="unknown";this.genreConfidence=0;this.genreHistory=[];this.maxHistorySize=30;this.genreAnalysisBuffer=[];this.bufferSize=10;this.isActive=!1;this.boundSpectralHandler=null;this.boundEmotionalHandler=null;this.genreProfiles={electronic:{bassEmphasis:.8,midFrequencyPattern:.6,trebleSharpness:.9,dynamicRange:.7,rhythmComplexity:.6,syncopation:.4,grooveWeight:.7,tempoVariability:.3,harmonicComplexity:.5,dissonanceTolerance:.6,modalInfluence:.4,microtonal:.2,compression:.8,saturation:.6,stereoWidth:.8,artificialProcessing:.9,organicness:.2,accessibility:.6,experimentalFactor:.7,emotionalRange:.6},rock:{bassEmphasis:.7,midFrequencyPattern:.8,trebleSharpness:.7,dynamicRange:.8,rhythmComplexity:.6,syncopation:.3,grooveWeight:.8,tempoVariability:.4,harmonicComplexity:.6,dissonanceTolerance:.5,modalInfluence:.3,microtonal:.1,compression:.6,saturation:.7,stereoWidth:.7,artificialProcessing:.4,organicness:.6,accessibility:.8,experimentalFactor:.4,emotionalRange:.8},classical:{bassEmphasis:.5,midFrequencyPattern:.7,trebleSharpness:.6,dynamicRange:.9,rhythmComplexity:.8,syncopation:.2,grooveWeight:.4,tempoVariability:.7,harmonicComplexity:.9,dissonanceTolerance:.4,modalInfluence:.6,microtonal:.3,compression:.3,saturation:.2,stereoWidth:.8,artificialProcessing:.1,organicness:.9,accessibility:.4,experimentalFactor:.6,emotionalRange:.9},jazz:{bassEmphasis:.6,midFrequencyPattern:.8,trebleSharpness:.5,dynamicRange:.8,rhythmComplexity:.9,syncopation:.8,grooveWeight:.9,tempoVariability:.6,harmonicComplexity:.9,dissonanceTolerance:.7,modalInfluence:.8,microtonal:.4,compression:.4,saturation:.3,stereoWidth:.7,artificialProcessing:.2,organicness:.8,accessibility:.5,experimentalFactor:.8,emotionalRange:.8},"hip-hop":{bassEmphasis:.9,midFrequencyPattern:.7,trebleSharpness:.8,dynamicRange:.6,rhythmComplexity:.7,syncopation:.6,grooveWeight:.9,tempoVariability:.3,harmonicComplexity:.4,dissonanceTolerance:.5,modalInfluence:.3,microtonal:.1,compression:.8,saturation:.6,stereoWidth:.6,artificialProcessing:.7,organicness:.4,accessibility:.8,experimentalFactor:.5,emotionalRange:.7},ambient:{bassEmphasis:.4,midFrequencyPattern:.5,trebleSharpness:.3,dynamicRange:.9,rhythmComplexity:.2,syncopation:.1,grooveWeight:.2,tempoVariability:.8,harmonicComplexity:.6,dissonanceTolerance:.6,modalInfluence:.7,microtonal:.5,compression:.5,saturation:.4,stereoWidth:.9,artificialProcessing:.6,organicness:.7,accessibility:.3,experimentalFactor:.8,emotionalRange:.6},pop:{bassEmphasis:.6,midFrequencyPattern:.8,trebleSharpness:.7,dynamicRange:.6,rhythmComplexity:.4,syncopation:.3,grooveWeight:.7,tempoVariability:.2,harmonicComplexity:.5,dissonanceTolerance:.3,modalInfluence:.2,microtonal:.1,compression:.8,saturation:.5,stereoWidth:.6,artificialProcessing:.5,organicness:.5,accessibility:.9,experimentalFactor:.2,emotionalRange:.7},metal:{bassEmphasis:.8,midFrequencyPattern:.7,trebleSharpness:.9,dynamicRange:.7,rhythmComplexity:.7,syncopation:.4,grooveWeight:.8,tempoVariability:.3,harmonicComplexity:.6,dissonanceTolerance:.8,modalInfluence:.5,microtonal:.2,compression:.7,saturation:.9,stereoWidth:.7,artificialProcessing:.6,organicness:.4,accessibility:.6,experimentalFactor:.5,emotionalRange:.8},folk:{bassEmphasis:.4,midFrequencyPattern:.7,trebleSharpness:.5,dynamicRange:.7,rhythmComplexity:.4,syncopation:.2,grooveWeight:.6,tempoVariability:.5,harmonicComplexity:.5,dissonanceTolerance:.3,modalInfluence:.6,microtonal:.2,compression:.3,saturation:.2,stereoWidth:.5,artificialProcessing:.1,organicness:.9,accessibility:.7,experimentalFactor:.3,emotionalRange:.7},funk:{bassEmphasis:.9,midFrequencyPattern:.8,trebleSharpness:.6,dynamicRange:.7,rhythmComplexity:.8,syncopation:.9,grooveWeight:1,tempoVariability:.4,harmonicComplexity:.6,dissonanceTolerance:.5,modalInfluence:.4,microtonal:.2,compression:.6,saturation:.5,stereoWidth:.6,artificialProcessing:.3,organicness:.7,accessibility:.7,experimentalFactor:.4,emotionalRange:.6},indie:{bassEmphasis:.5,midFrequencyPattern:.7,trebleSharpness:.6,dynamicRange:.7,rhythmComplexity:.6,syncopation:.4,grooveWeight:.6,tempoVariability:.5,harmonicComplexity:.6,dissonanceTolerance:.5,modalInfluence:.5,microtonal:.3,compression:.5,saturation:.4,stereoWidth:.7,artificialProcessing:.3,organicness:.7,accessibility:.6,experimentalFactor:.6,emotionalRange:.7},reggae:{bassEmphasis:.8,midFrequencyPattern:.6,trebleSharpness:.5,dynamicRange:.6,rhythmComplexity:.5,syncopation:.7,grooveWeight:.8,tempoVariability:.3,harmonicComplexity:.4,dissonanceTolerance:.3,modalInfluence:.4,microtonal:.2,compression:.6,saturation:.4,stereoWidth:.6,artificialProcessing:.3,organicness:.6,accessibility:.7,experimentalFactor:.3,emotionalRange:.6},blues:{bassEmphasis:.6,midFrequencyPattern:.8,trebleSharpness:.6,dynamicRange:.8,rhythmComplexity:.5,syncopation:.4,grooveWeight:.8,tempoVariability:.6,harmonicComplexity:.6,dissonanceTolerance:.4,modalInfluence:.7,microtonal:.3,compression:.4,saturation:.5,stereoWidth:.5,artificialProcessing:.2,organicness:.8,accessibility:.7,experimentalFactor:.4,emotionalRange:.8},country:{bassEmphasis:.5,midFrequencyPattern:.7,trebleSharpness:.6,dynamicRange:.7,rhythmComplexity:.4,syncopation:.3,grooveWeight:.6,tempoVariability:.4,harmonicComplexity:.4,dissonanceTolerance:.2,modalInfluence:.3,microtonal:.1,compression:.5,saturation:.3,stereoWidth:.6,artificialProcessing:.2,organicness:.8,accessibility:.8,experimentalFactor:.2,emotionalRange:.7},techno:{bassEmphasis:.9,midFrequencyPattern:.5,trebleSharpness:.8,dynamicRange:.5,rhythmComplexity:.6,syncopation:.3,grooveWeight:.8,tempoVariability:.2,harmonicComplexity:.4,dissonanceTolerance:.6,modalInfluence:.3,microtonal:.3,compression:.9,saturation:.7,stereoWidth:.8,artificialProcessing:1,organicness:.1,accessibility:.5,experimentalFactor:.6,emotionalRange:.5},house:{bassEmphasis:.8,midFrequencyPattern:.6,trebleSharpness:.7,dynamicRange:.6,rhythmComplexity:.5,syncopation:.4,grooveWeight:.9,tempoVariability:.2,harmonicComplexity:.5,dissonanceTolerance:.4,modalInfluence:.3,microtonal:.2,compression:.8,saturation:.6,stereoWidth:.7,artificialProcessing:.8,organicness:.3,accessibility:.8,experimentalFactor:.4,emotionalRange:.6},trance:{bassEmphasis:.7,midFrequencyPattern:.7,trebleSharpness:.8,dynamicRange:.8,rhythmComplexity:.5,syncopation:.2,grooveWeight:.7,tempoVariability:.3,harmonicComplexity:.6,dissonanceTolerance:.5,modalInfluence:.4,microtonal:.3,compression:.7,saturation:.5,stereoWidth:.9,artificialProcessing:.8,organicness:.2,accessibility:.6,experimentalFactor:.5,emotionalRange:.8},dubstep:{bassEmphasis:1,midFrequencyPattern:.5,trebleSharpness:.9,dynamicRange:.9,rhythmComplexity:.7,syncopation:.6,grooveWeight:.8,tempoVariability:.4,harmonicComplexity:.4,dissonanceTolerance:.8,modalInfluence:.3,microtonal:.4,compression:.8,saturation:.8,stereoWidth:.8,artificialProcessing:.9,organicness:.1,accessibility:.4,experimentalFactor:.7,emotionalRange:.6},unknown:{bassEmphasis:.5,midFrequencyPattern:.5,trebleSharpness:.5,dynamicRange:.5,rhythmComplexity:.5,syncopation:.5,grooveWeight:.5,tempoVariability:.5,harmonicComplexity:.5,dissonanceTolerance:.5,modalInfluence:.5,microtonal:.5,compression:.5,saturation:.5,stereoWidth:.5,artificialProcessing:.5,organicness:.5,accessibility:.5,experimentalFactor:.5,emotionalRange:.5}};this.genreVisualStyles={electronic:{primaryHueRange:[180,270],saturationProfile:[.8,.3],brightnessProfile:[1.1,.4],contrastLevel:.8,gradientComplexity:.8,shapeGeometry:"geometric",edgeSharpness:.9,symmetryLevel:.7,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"linear",transitionCharacter:"mechanical",layerBlending:"contrasting",depthIllusion:.6,particleInfluence:.8,nebulaCharacter:"structured",memoryInfluence:.3,adaptationSpeed:.8,stabilityPreference:.6,emergencePattern:"sudden"},rock:{primaryHueRange:[330,30],saturationProfile:[1.2,.5],brightnessProfile:[1.2,.3],contrastLevel:.9,gradientComplexity:.7,shapeGeometry:"hybrid",edgeSharpness:.7,symmetryLevel:.5,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"sharp",layerBlending:"harmonious",depthIllusion:.7,particleInfluence:.6,nebulaCharacter:"dense",memoryInfluence:.4,adaptationSpeed:.7,stabilityPreference:.7,emergencePattern:"gradual"},classical:{primaryHueRange:[45,135],saturationProfile:[.6,.4],brightnessProfile:[1,.5],contrastLevel:.6,gradientComplexity:.9,shapeGeometry:"organic",edgeSharpness:.3,symmetryLevel:.8,animationStyle:"smooth",pulseBehavior:"subtle",flowDirection:"spiral",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.9,particleInfluence:.4,nebulaCharacter:"ethereal",memoryInfluence:.8,adaptationSpeed:.3,stabilityPreference:.9,emergencePattern:"progressive"},jazz:{primaryHueRange:[30,90],saturationProfile:[.7,.6],brightnessProfile:[.9,.6],contrastLevel:.7,gradientComplexity:.8,shapeGeometry:"abstract",edgeSharpness:.5,symmetryLevel:.3,animationStyle:"chaotic",pulseBehavior:"syncopated",flowDirection:"random",transitionCharacter:"organic",layerBlending:"complementary",depthIllusion:.8,particleInfluence:.7,nebulaCharacter:"wispy",memoryInfluence:.6,adaptationSpeed:.6,stabilityPreference:.4,emergencePattern:"cyclical"},"hip-hop":{primaryHueRange:[270,330],saturationProfile:[1,.4],brightnessProfile:[1.1,.3],contrastLevel:.8,gradientComplexity:.6,shapeGeometry:"geometric",edgeSharpness:.8,symmetryLevel:.6,animationStyle:"rhythmic",pulseBehavior:"syncopated",flowDirection:"linear",transitionCharacter:"sharp",layerBlending:"contrasting",depthIllusion:.5,particleInfluence:.9,nebulaCharacter:"structured",memoryInfluence:.2,adaptationSpeed:.9,stabilityPreference:.5,emergencePattern:"sudden"},ambient:{primaryHueRange:[180,240],saturationProfile:[.4,.3],brightnessProfile:[.8,.4],contrastLevel:.3,gradientComplexity:.9,shapeGeometry:"organic",edgeSharpness:.2,symmetryLevel:.4,animationStyle:"minimal",pulseBehavior:"subtle",flowDirection:"spiral",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.9,particleInfluence:.3,nebulaCharacter:"ethereal",memoryInfluence:.9,adaptationSpeed:.1,stabilityPreference:.9,emergencePattern:"gradual"},pop:{primaryHueRange:[300,60],saturationProfile:[1.1,.3],brightnessProfile:[1.2,.2],contrastLevel:.7,gradientComplexity:.6,shapeGeometry:"hybrid",edgeSharpness:.6,symmetryLevel:.7,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.6,particleInfluence:.5,nebulaCharacter:"dense",memoryInfluence:.5,adaptationSpeed:.7,stabilityPreference:.8,emergencePattern:"gradual"},metal:{primaryHueRange:[0,30],saturationProfile:[.9,.4],brightnessProfile:[.7,.4],contrastLevel:1,gradientComplexity:.7,shapeGeometry:"geometric",edgeSharpness:.9,symmetryLevel:.6,animationStyle:"chaotic",pulseBehavior:"irregular",flowDirection:"radial",transitionCharacter:"sharp",layerBlending:"clashing",depthIllusion:.8,particleInfluence:.7,nebulaCharacter:"dense",memoryInfluence:.3,adaptationSpeed:.8,stabilityPreference:.3,emergencePattern:"sudden"},folk:{primaryHueRange:[60,120],saturationProfile:[.6,.3],brightnessProfile:[.9,.3],contrastLevel:.5,gradientComplexity:.5,shapeGeometry:"organic",edgeSharpness:.3,symmetryLevel:.5,animationStyle:"smooth",pulseBehavior:"subtle",flowDirection:"spiral",transitionCharacter:"organic",layerBlending:"harmonious",depthIllusion:.6,particleInfluence:.3,nebulaCharacter:"wispy",memoryInfluence:.7,adaptationSpeed:.4,stabilityPreference:.8,emergencePattern:"progressive"},funk:{primaryHueRange:[30,90],saturationProfile:[1,.5],brightnessProfile:[1,.4],contrastLevel:.8,gradientComplexity:.7,shapeGeometry:"abstract",edgeSharpness:.6,symmetryLevel:.4,animationStyle:"rhythmic",pulseBehavior:"syncopated",flowDirection:"random",transitionCharacter:"organic",layerBlending:"complementary",depthIllusion:.7,particleInfluence:.8,nebulaCharacter:"wispy",memoryInfluence:.4,adaptationSpeed:.8,stabilityPreference:.5,emergencePattern:"cyclical"},indie:{primaryHueRange:[120,240],saturationProfile:[.7,.4],brightnessProfile:[.9,.4],contrastLevel:.6,gradientComplexity:.7,shapeGeometry:"hybrid",edgeSharpness:.4,symmetryLevel:.5,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"spiral",transitionCharacter:"fluid",layerBlending:"complementary",depthIllusion:.7,particleInfluence:.5,nebulaCharacter:"wispy",memoryInfluence:.6,adaptationSpeed:.5,stabilityPreference:.7,emergencePattern:"progressive"},reggae:{primaryHueRange:[90,150],saturationProfile:[.8,.3],brightnessProfile:[1,.3],contrastLevel:.6,gradientComplexity:.5,shapeGeometry:"organic",edgeSharpness:.4,symmetryLevel:.6,animationStyle:"rhythmic",pulseBehavior:"syncopated",flowDirection:"linear",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.5,particleInfluence:.4,nebulaCharacter:"wispy",memoryInfluence:.6,adaptationSpeed:.5,stabilityPreference:.7,emergencePattern:"cyclical"},blues:{primaryHueRange:[200,260],saturationProfile:[.6,.4],brightnessProfile:[.8,.4],contrastLevel:.6,gradientComplexity:.6,shapeGeometry:"organic",edgeSharpness:.4,symmetryLevel:.4,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.7,particleInfluence:.4,nebulaCharacter:"ethereal",memoryInfluence:.7,adaptationSpeed:.4,stabilityPreference:.8,emergencePattern:"progressive"},country:{primaryHueRange:[30,90],saturationProfile:[.7,.3],brightnessProfile:[1,.3],contrastLevel:.5,gradientComplexity:.5,shapeGeometry:"organic",edgeSharpness:.3,symmetryLevel:.6,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"organic",layerBlending:"harmonious",depthIllusion:.5,particleInfluence:.3,nebulaCharacter:"wispy",memoryInfluence:.7,adaptationSpeed:.4,stabilityPreference:.8,emergencePattern:"gradual"},techno:{primaryHueRange:[240,300],saturationProfile:[1,.4],brightnessProfile:[1.1,.3],contrastLevel:.9,gradientComplexity:.6,shapeGeometry:"geometric",edgeSharpness:1,symmetryLevel:.8,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"linear",transitionCharacter:"mechanical",layerBlending:"contrasting",depthIllusion:.5,particleInfluence:.9,nebulaCharacter:"structured",memoryInfluence:.2,adaptationSpeed:.9,stabilityPreference:.4,emergencePattern:"sudden"},house:{primaryHueRange:[300,360],saturationProfile:[.9,.3],brightnessProfile:[1.1,.3],contrastLevel:.7,gradientComplexity:.6,shapeGeometry:"hybrid",edgeSharpness:.7,symmetryLevel:.7,animationStyle:"rhythmic",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.6,particleInfluence:.7,nebulaCharacter:"dense",memoryInfluence:.4,adaptationSpeed:.7,stabilityPreference:.6,emergencePattern:"gradual"},trance:{primaryHueRange:[180,270],saturationProfile:[.8,.5],brightnessProfile:[1,.5],contrastLevel:.7,gradientComplexity:.8,shapeGeometry:"abstract",edgeSharpness:.5,symmetryLevel:.6,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"spiral",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.8,particleInfluence:.6,nebulaCharacter:"ethereal",memoryInfluence:.6,adaptationSpeed:.5,stabilityPreference:.7,emergencePattern:"progressive"},dubstep:{primaryHueRange:[120,180],saturationProfile:[1.2,.6],brightnessProfile:[1.1,.6],contrastLevel:1,gradientComplexity:.8,shapeGeometry:"geometric",edgeSharpness:.9,symmetryLevel:.5,animationStyle:"chaotic",pulseBehavior:"irregular",flowDirection:"random",transitionCharacter:"sharp",layerBlending:"clashing",depthIllusion:.7,particleInfluence:1,nebulaCharacter:"structured",memoryInfluence:.2,adaptationSpeed:1,stabilityPreference:.2,emergencePattern:"sudden"},unknown:{primaryHueRange:[0,360],saturationProfile:[.7,.3],brightnessProfile:[1,.3],contrastLevel:.6,gradientComplexity:.6,shapeGeometry:"hybrid",edgeSharpness:.5,symmetryLevel:.5,animationStyle:"smooth",pulseBehavior:"steady",flowDirection:"radial",transitionCharacter:"fluid",layerBlending:"harmonious",depthIllusion:.6,particleInfluence:.5,nebulaCharacter:"wispy",memoryInfluence:.5,adaptationSpeed:.5,stabilityPreference:.6,emergencePattern:"gradual"}};this.cssConsciousnessController=t,this.musicSyncService=e,this.emotionalGradientMapper=i,this.settingsManager=n,this.boundSpectralHandler=this.handleSpectralData.bind(this),this.boundEmotionalHandler=this.handleEmotionalData.bind(this)}async initialize(){this.boundSpectralHandler&&document.addEventListener("music-sync:spectral-data",this.boundSpectralHandler),this.boundEmotionalHandler&&document.addEventListener("emotional-gradient:profile-updated",this.boundEmotionalHandler),this.isActive=!0,u?.debug?.log("GenreGradientEvolution","Genre-responsive gradient evolution system initialized")}handleSpectralData(t){if(!this.isActive)return;let i=t.detail;i&&(this.genreAnalysisBuffer.push(i),this.genreAnalysisBuffer.length>this.bufferSize&&this.genreAnalysisBuffer.shift(),this.genreAnalysisBuffer.length>=this.bufferSize&&this.analyzeGenre())}handleEmotionalData(t){this.isActive&&this.updateVisualEvolution()}analyzeGenre(){if(this.genreAnalysisBuffer.length===0)return;let t=this.calculateAverageMusicData(),e={};for(let r of Object.keys(this.genreProfiles))e[r]=this.calculateGenreSimilarity(t,this.genreProfiles[r]);let n=Object.entries(e).sort(([,r],[,a])=>a-r)[0];if(n){let[r,a]=n;this.updateGenreDetection(r,a)}}calculateAverageMusicData(){let t=this.genreAnalysisBuffer.reduce((i,n)=>({energy:(i.energy||0)+(n.energy||0),valence:(i.valence||0)+(n.valence||0),danceability:(i.danceability||0)+(n.danceability||0),tempo:(i.tempo||0)+(n.tempo||0),loudness:(i.loudness||0)+(n.loudness||0),acousticness:(i.acousticness||0)+(n.acousticness||0),instrumentalness:(i.instrumentalness||0)+(n.instrumentalness||0),speechiness:(i.speechiness||0)+(n.speechiness||0),mode:n.mode!==void 0?n.mode:i.mode||0,key:(i.key||0)+(n.key||0),genre:n.genre||i.genre||"unknown"}),{energy:0,valence:0,danceability:0,tempo:0,loudness:0,acousticness:0,instrumentalness:0,speechiness:0,mode:0,key:0,genre:"unknown"}),e=this.genreAnalysisBuffer.length;return{energy:(t.energy||0)/e,valence:(t.valence||0)/e,danceability:(t.danceability||0)/e,tempo:(t.tempo||0)/e,loudness:(t.loudness||0)/e,acousticness:(t.acousticness||0)/e,instrumentalness:(t.instrumentalness||0)/e,speechiness:(t.speechiness||0)/e,mode:t.mode||0,key:(t.key||0)/e,genre:t.genre||"unknown"}}calculateGenreSimilarity(t,e){let i={energy:.25,valence:.2,danceability:.2,acousticness:.15,tempo:.1,speechiness:.05,instrumentalness:.05},n=1-Math.abs((t.energy||.5)-(e.dynamicRange*.5+e.rhythmComplexity*.5)),r=1-Math.abs((t.valence||.5)-(e.accessibility*.6+e.emotionalRange*.4)),a=1-Math.abs((t.danceability||.5)-(e.grooveWeight*.7+(1-e.syncopation)*.3)),s=1-Math.abs((t.acousticness||.5)-(e.organicness*.8+(1-e.artificialProcessing)*.2)),o=60+e.rhythmComplexity*80+e.grooveWeight*60,l=1-Math.min(1,Math.abs((t.tempo||120)-o)/100),m=1-Math.abs((t.speechiness||.1)-(e.artificialProcessing*.3+e.accessibility*.1)),d=1-Math.abs((t.instrumentalness||.5)-(e.experimentalFactor*.6+e.harmonicComplexity*.4));return n*i.energy+r*i.valence+a*i.danceability+s*i.acousticness+l*i.tempo+m*i.speechiness+d*i.instrumentalness}updateGenreDetection(t,e){let i=performance.now();this.genreHistory.push({genre:t,confidence:e,timestamp:i}),this.genreHistory.length>this.maxHistorySize&&this.genreHistory.shift();let n=this.genreHistory.slice(-10),r=this.calculateGenreConsensus(n);r.confidence>.6&&(r.genre!==this.currentGenre||r.confidence>this.genreConfidence)&&(this.currentGenre=r.genre,this.genreConfidence=r.confidence,u?.debug?.log("GenreGradientEvolution",`Genre detected: ${this.currentGenre} (confidence: ${this.genreConfidence.toFixed(2)})`),this.updateVisualEvolution(),document.dispatchEvent(new CustomEvent("genre-gradient:genre-detected",{detail:{genre:this.currentGenre,confidence:this.genreConfidence}})))}calculateGenreConsensus(t){let e={};t.forEach((r,a)=>{let s=(a+1)/t.length,o=r.confidence*s;e[r.genre]=(e[r.genre]||0)+o});let i="unknown",n=0;for(let[r,a]of Object.entries(e))a!==void 0&&a>n&&(n=a,i=r);return{genre:i,confidence:n/t.length}}updateVisualEvolution(){if(this.currentGenre==="unknown")return;let t=this.genreVisualStyles[this.currentGenre],e=this.emotionalGradientMapper?.getCurrentEmotionalProfile()||null;this.applyGenreVisualStyle(t,e)}applyGenreVisualStyle(t,e){let i=t.primaryHueRange[1]-t.primaryHueRange[0],n=t.primaryHueRange[0]+i*.5,r=e?(e.valence-.5)*i*.3:0;this.cssConsciousnessController.setProperty("--sn-genre-base-hue",`${n+r}deg`),this.cssConsciousnessController.setProperty("--sn-genre-hue-range",`${i}deg`);let a=e?e.arousal*.3:0,s=e?e.energy*.2:0;this.cssConsciousnessController.setProperty("--sn-genre-saturation-base",(t.saturationProfile[0]+a).toString()),this.cssConsciousnessController.setProperty("--sn-genre-saturation-variation",t.saturationProfile[1].toString()),this.cssConsciousnessController.setProperty("--sn-genre-brightness-base",(t.brightnessProfile[0]+s).toString()),this.cssConsciousnessController.setProperty("--sn-genre-brightness-variation",t.brightnessProfile[1].toString()),this.cssConsciousnessController.setProperty("--sn-genre-contrast-level",t.contrastLevel.toString()),this.cssConsciousnessController.setProperty("--sn-genre-edge-sharpness",t.edgeSharpness.toString()),this.cssConsciousnessController.setProperty("--sn-genre-gradient-complexity",t.gradientComplexity.toString());let o=e?.5+e.energy:1;this.cssConsciousnessController.setProperty("--sn-genre-animation-speed",o.toString()),this.cssConsciousnessController.setProperty("--sn-genre-pulse-intensity",t.depthIllusion.toString());let l=this.mapLayerBlending(t.layerBlending);this.cssConsciousnessController.setProperty("--sn-genre-layer-harmony",l.toString()),this.cssConsciousnessController.setProperty("--sn-genre-depth-illusion",t.depthIllusion.toString()),this.cssConsciousnessController.setProperty("--sn-genre-particle-influence",t.particleInfluence.toString()),this.cssConsciousnessController.setProperty("--sn-genre-memory-influence",t.memoryInfluence.toString()),this.cssConsciousnessController.setProperty("--sn-genre-adaptation-speed",t.adaptationSpeed.toString()),this.cssConsciousnessController.setProperty("--sn-genre-stability-preference",t.stabilityPreference.toString()),this.cssConsciousnessController.setProperty("--sn-current-genre",this.currentGenre),this.cssConsciousnessController.setProperty("--sn-genre-confidence",this.genreConfidence.toString()),this.updateGenreGradientCoordination(t,e)}updateGenreGradientCoordination(t,e){let i=getComputedStyle(document.documentElement),n=i.getPropertyValue("--sn-bg-gradient-primary").trim(),r=i.getPropertyValue("--sn-bg-gradient-secondary").trim(),a=i.getPropertyValue("--sn-bg-gradient-accent").trim();if(n||r||a){let s=e?.5+e.energy:1,o=this.calculateGenreAngle(t);this.cssConsciousnessController.setProperty("--sn-bg-gradient-angle",`${o}deg`);let l=this.calculateGenreOpacity(t,e);this.cssConsciousnessController.setProperty("--sn-bg-gradient-opacity",l.toString());let m=Math.max(60,120*(1-t.edgeSharpness));this.cssConsciousnessController.setProperty("--sn-bg-gradient-blur",`${m}px`);let d=e?e.arousal*.3:0,h=e?e.energy*.2:0;this.cssConsciousnessController.setProperty("--sn-bg-gradient-saturation",(t.saturationProfile[0]+d).toString()),this.cssConsciousnessController.setProperty("--sn-bg-gradient-brightness",(t.brightnessProfile[0]+h).toString()),this.cssConsciousnessController.setProperty("--sn-bg-gradient-contrast",t.contrastLevel.toString()),u?.debug?.log("GenreGradientEvolution",`Coordinated genre "${this.currentGenre}" modifications with gradient system: angle=${o}\xB0, opacity=${l}`)}}calculateGenreAngle(t){return{electronic:135,rock:45,classical:90,jazz:120,"hip-hop":0,ambient:180,pop:315,metal:225,folk:60,funk:30,indie:150,reggae:210,blues:270,country:45,techno:135,house:315,trance:90,dubstep:180,unknown:45}[this.currentGenre]||45}calculateGenreOpacity(t,e){let i=.8;switch(this.currentGenre){case"ambient":case"classical":i=.6;break;case"metal":case"rock":case"dubstep":i=.9;break;case"jazz":case"blues":i=.75;break;default:i=.8}return e&&(i*=.7+e.energy*.3),Math.max(.3,Math.min(1,i))}mapLayerBlending(t){switch(t){case"harmonious":return .9;case"complementary":return .7;case"contrasting":return .5;case"clashing":return .3;default:return .7}}getCurrentGenre(){return this.currentGenre}getGenreConfidence(){return this.genreConfidence}getGenreHistory(){return[...this.genreHistory]}setGenreOverride(t,e=1e4){this.currentGenre=t,this.genreConfidence=1,this.updateVisualEvolution(),u?.debug?.log("GenreGradientEvolution",`Genre override: ${t} for ${e}ms`),setTimeout(()=>{this.genreConfidence=0,u?.debug?.log("GenreGradientEvolution","Genre override expired, returning to automatic detection")},e)}getGenreCharacteristics(t){return this.genreProfiles[t||this.currentGenre]}getGenreVisualStyle(t){return this.genreVisualStyles[t||this.currentGenre]}destroy(){this.isActive=!1,this.boundSpectralHandler&&document.removeEventListener("music-sync:data-updated",this.boundSpectralHandler),this.boundEmotionalHandler&&document.removeEventListener("emotional-gradient:profile-updated",this.boundEmotionalHandler),this.genreAnalysisBuffer=[],this.genreHistory=[],u?.debug?.log("GenreGradientEvolution","Genre evolution system destroyed")}}});var Te,pn,g,D=y(()=>{"use strict";A();Te=class Te{constructor(){this.subscriptions=new Map;this.eventMetrics={totalEvents:0,totalSubscriptions:0,activeSubscriptions:0,eventsPerSecond:0,topEvents:[],memoryUsage:0};this.eventQueue=[];this.processingQueue=!1;this.maxQueueSize=1e3;this.subscriptionCleanupInterval=null;this.metricsUpdateInterval=null;this.startMetricsMonitoring(),this.startSubscriptionCleanup(),u?.debug?.log("UnifiedEventBus","Unified event bus initialized")}static getInstance(){return Te.instance||(Te.instance=new Te),Te.instance}subscribe(t,e,i="anonymous",n={}){let r=this.generateSubscriptionId();this.subscriptions.has(t)||this.subscriptions.set(t,new Map);let a={id:r,eventName:t,handler:e,subscriberName:i,once:n.once||!1,createdAt:Date.now(),triggerCount:0};return this.subscriptions.get(t).set(r,a),this.eventMetrics.totalSubscriptions++,this.eventMetrics.activeSubscriptions++,u?.debug?.log("UnifiedEventBus",`Subscription added: ${i} -> ${t}`,{subscriptionId:r,totalSubscriptions:this.eventMetrics.activeSubscriptions}),r}once(t,e,i="anonymous"){return this.subscribe(t,e,i,{once:!0})}unsubscribe(t){for(let[e,i]of this.subscriptions.entries())if(i.has(t)){let n=i.get(t);return i.delete(t),i.size===0&&this.subscriptions.delete(e),this.eventMetrics.activeSubscriptions--,u?.debug?.log("UnifiedEventBus",`Subscription removed: ${n.subscriberName} -> ${e}`,{subscriptionId:t,remainingSubscriptions:this.eventMetrics.activeSubscriptions}),!0}return!1}unsubscribeAll(t){let e=0;for(let[i,n]of this.subscriptions.entries()){let r=Array.from(n.values()).filter(a=>a.subscriberName===t);for(let a of r)n.delete(a.id),e++,this.eventMetrics.activeSubscriptions--;n.size===0&&this.subscriptions.delete(i)}return e>0&&u?.debug?.log("UnifiedEventBus",`Removed ${e} subscriptions for: ${t}`),e}async emit(t,e){let i=Date.now();if(this.processingQueue||this.eventQueue.length>0){if(this.eventQueue.length>=this.maxQueueSize){u?.debug?.warn("UnifiedEventBus",`Event queue full, dropping event: ${t}`);return}this.eventQueue.push({eventName:t,data:e,timestamp:i}),this.processEventQueue();return}await this.processEvent(t,e,i)}emitSync(t,e){let i=Date.now();this.processEventSync(t,e,i)}async processEvent(t,e,i){let n=this.subscriptions.get(t);if(!n||n.size===0)return;this.eventMetrics.totalEvents++;let r=[],a=[];for(let[o,l]of n.entries())r.push({subscription:l,handler:l.handler}),l.once&&a.push(o),l.lastTriggered=i,l.triggerCount++;let s=r.map(async({subscription:o,handler:l})=>{try{await l(e)}catch(m){u?.debug?.error("UnifiedEventBus",`Handler error in ${o.subscriberName} for ${t}:`,m),this.emitSync("system:error",{systemName:o.subscriberName,error:m instanceof Error?m.message:"Unknown error",severity:"error",timestamp:Date.now()})}});await Promise.all(s);for(let o of a)n.delete(o),this.eventMetrics.activeSubscriptions--;n.size===0&&this.subscriptions.delete(t),u?.debug?.log("UnifiedEventBus",`Event processed: ${t}`,{handlerCount:r.length,processingTime:Date.now()-i})}processEventSync(t,e,i){let n=this.subscriptions.get(t);if(!n||n.size===0)return;this.eventMetrics.totalEvents++;let r=[];for(let[a,s]of n.entries())try{s.handler(e),s.lastTriggered=i,s.triggerCount++,s.once&&r.push(a)}catch(o){u?.debug?.error("UnifiedEventBus",`Sync handler error in ${s.subscriberName} for ${t}:`,o)}for(let a of r)n.delete(a),this.eventMetrics.activeSubscriptions--;n.size===0&&this.subscriptions.delete(t)}async processEventQueue(){if(!this.processingQueue){for(this.processingQueue=!0;this.eventQueue.length>0;){let t=this.eventQueue.shift();await this.processEvent(t.eventName,t.data,t.timestamp)}this.processingQueue=!1}}getMetrics(){return{...this.eventMetrics}}getActiveSubscriptions(){let t=[];for(let[e,i]of this.subscriptions.entries())for(let[n,r]of i.entries())t.push({eventName:e,subscriberName:r.subscriberName,subscriptionId:n,createdAt:r.createdAt,triggerCount:r.triggerCount});return t.sort((e,i)=>i.createdAt-e.createdAt)}startMetricsMonitoring(){this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},5e3)}startSubscriptionCleanup(){this.subscriptionCleanupInterval=window.setInterval(()=>{this.cleanupAbandonedSubscriptions()},6e4)}updateMetrics(){let t=Date.now(),e=this.eventMetrics.totalEvents,i=new Map;for(let[n,r]of this.subscriptions.entries()){let a=0;for(let s of r.values())a+=s.triggerCount;i.set(n,a)}this.eventMetrics.topEvents=Array.from(i.entries()).sort((n,r)=>r[1]-n[1]).slice(0,10).map(([n,r])=>({eventName:n,count:r})),this.eventMetrics.memoryUsage=this.eventMetrics.activeSubscriptions*256}cleanupAbandonedSubscriptions(){let t=Date.now()-3e5,e=0;for(let[i,n]of this.subscriptions.entries()){let r=Array.from(n.values()).filter(a=>!a.lastTriggered&&a.createdAt<t);for(let a of r)n.delete(a.id),e++,this.eventMetrics.activeSubscriptions--;n.size===0&&this.subscriptions.delete(i)}e>0&&u?.debug?.log("UnifiedEventBus",`Cleaned up ${e} abandoned subscriptions`)}generateSubscriptionId(){return`sub_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}destroy(){this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this.subscriptionCleanupInterval&&(clearInterval(this.subscriptionCleanupInterval),this.subscriptionCleanupInterval=null),this.subscriptions.clear(),this.eventQueue=[],this.eventMetrics={totalEvents:0,totalSubscriptions:0,activeSubscriptions:0,eventsPerSecond:0,topEvents:[],memoryUsage:0},u?.debug?.log("UnifiedEventBus","Unified event bus destroyed"),Te.instance=null}};Te.instance=null;pn=Te,g=pn.getInstance()});var ia={};ie(ia,{MusicalLerpOrchestrator:()=>Zt,musicalLerpOrchestrator:()=>bn});var Zt,bn,yn=y(()=>{"use strict";Zt=class{constructor(t=!1){this.baseHalfLifeValues={pulse:.08,flow:.15,emotional:.25,organic:.12,crystalline:.06};this.beatPhaseConfig={attack:{start:0,end:.15,baseMultiplier:.3},sustain:{start:.15,end:.5,baseMultiplier:1},decay:{start:.5,end:.85,baseMultiplier:1.4},rest:{start:.85,end:1,baseMultiplier:.8}};this.modulationConfig={tempo:{reference:120,minFactor:.6,maxFactor:1.8,curve:.3},energy:{attackRange:.7,decayRange:.5,baseline:1},danceability:{fluidityMin:.5,fluidityMax:1,organicThreshold:.6},temperature:{neutral:4e3,range:16e3,warmthInfluence:.3,coolPrecision:.4}};this.debugMode=!1;this.debugMode=t}calculateMusicalLerp(t,e="flow",i){return this.calculateMusicalLerpWithPerformance(t,e,i,null)}calculateMusicalLerpWithPerformance(t,e="flow",i,n,r){let a=performance.now(),s=i||this.baseHalfLifeValues[e],o=r&&n,l=!1,m=1,d=1,h=1,p=1,b=1;o&&r?(l=!0,r.useSimplifiedCalculations?(m=Math.max(.7,Math.min(1.5,t.tempo/120)),r.enableEnergyModulation&&(d=1+t.energy*.2),h=.8+t.danceability*.4):(m=this.calculateTempoFactor(t.tempo),r.enableEnergyModulation&&(d=this.calculateEnergyFactor(t.energy)),h=this.calculateDanceabilityFactor(t.danceability),r.enableTemperatureMapping&&(p=this.calculateTemperatureFactor(t.emotionalTemperature)),r.enableBeatPhase&&(b=this.calculateBeatPhaseFactor(t.beatPhase,t.timeSinceLastBeat,t.beatInterval)))):(m=this.calculateTempoFactor(t.tempo),d=this.calculateEnergyFactor(t.energy),h=this.calculateDanceabilityFactor(t.danceability),p=this.calculateTemperatureFactor(t.emotionalTemperature),b=this.calculateBeatPhaseFactor(t.beatPhase,t.timeSinceLastBeat,t.beatInterval));let v=m*d*h*p*b;if(r?.performanceMultiplier&&(v*=r.performanceMultiplier),r?.complexityReduction&&r.complexityReduction>0){let W=1-r.complexityReduction;v=1+(v-1)*W}let C=s*v,P,E;o&&r?.useSimplifiedCalculations?(P=t.energy<.5?1.2:.8,E=t.valence>.5?1.3:1):(P=this.calculateAttackMultiplier(t.energy,t.beatPhase),E=this.calculateDecayMultiplier(t.energy,t.valence));let L=this.calculateFluidityFactor(t.danceability,t.emotionalTemperature),$=this.calculateConsciousnessLevel(t),G={halfLife:Math.max(.01,Math.min(2,C)),attackMultiplier:P,decayMultiplier:E,fluidityFactor:L,consciousnessLevel:$,performanceOptimized:l};if(this.debugMode){G.debugInfo={tempoFactor:m,energyFactor:d,danceabilityFactor:h,temperatureFactor:p,beatPhaseFactor:b},r?.performanceMultiplier!==void 0&&(G.debugInfo.performanceMultiplier=r.performanceMultiplier),r?.complexityReduction!==void 0&&(G.debugInfo.complexityReduction=r.complexityReduction);let B=performance.now()-a;B>.5&&console.log(`\u{1F3B5} [MusicalLerpOrchestrator] Calculation time: ${B.toFixed(3)}ms (performance-optimized: ${l})`)}return G}calculateTempoFactor(t){let{reference:e,minFactor:i,maxFactor:n,curve:r}=this.modulationConfig.tempo,a=t/e,s=Math.pow(a,r);return Math.max(i,Math.min(n,s))}calculateEnergyFactor(t){let{baseline:e}=this.modulationConfig.energy;return e+t*.3}calculateDanceabilityFactor(t){let{fluidityMin:e,fluidityMax:i}=this.modulationConfig.danceability;return e+t*(i-e)}calculateTemperatureFactor(t){let{neutral:e,range:i,warmthInfluence:n}=this.modulationConfig.temperature;return 1+(t-e)/i*n}calculateBeatPhaseFactor(t,e,i){let n=this.beatPhaseConfig[t],r=Math.min(1,e/i),a=n.baseMultiplier;if(t==="attack"&&r>.1){let s=(.15-r)/.05;a=n.baseMultiplier+(1-n.baseMultiplier)*(1-s)}return a}calculateAttackMultiplier(t,e){let{attackRange:i,baseline:n}=this.modulationConfig.energy,r=n-t*i;return e==="attack"&&(r*=.5),Math.max(.1,r)}calculateDecayMultiplier(t,e){let{decayRange:i,baseline:n}=this.modulationConfig.energy,r=n+t*i;return r+=e*.3,Math.max(.8,Math.min(2,r))}calculateFluidityFactor(t,e){let{fluidityMin:i,fluidityMax:n,organicThreshold:r}=this.modulationConfig.danceability,{neutral:a,range:s}=this.modulationConfig.temperature,o=i+t*(n-i),l=(e-a)/s;return o+=l*.2,Math.max(.3,Math.min(1.2,o))}calculateConsciousnessLevel(t){let{energy:e,valence:i,danceability:n,beatConfidence:r}=t,a=e*.3,s=i*.2,o=n*.25,l=r*.25;return Math.max(.1,Math.min(1,a+s+o+l))}getCurrentBeatPhase(t,e){let i=Math.min(1,t/e);return i<=.15?"attack":i<=.5?"sustain":i<=.85?"decay":"rest"}createMusicalContext(t,e=0){let i=t.getCurrentMusicState();if(!i)return null;let{emotion:n,beat:r,intensity:a}=i,o=Date.now()-e,l=r?.tempo?6e4/r.tempo:500;return{tempo:r?.tempo||120,energy:r?.energy||a||.5,valence:n?.valence||.5,danceability:n?.danceability||.5,emotionalTemperature:n?.temperature||4e3,beatPhase:this.getCurrentBeatPhase(o,l),beatConfidence:r?.confidence||.5,beatInterval:l,timeSinceLastBeat:o}}setDebugMode(t){this.debugMode=t}getConfiguration(){return{baseHalfLifeValues:{...this.baseHalfLifeValues},beatPhaseConfig:{...this.beatPhaseConfig},modulationConfig:{...this.modulationConfig}}}},bn=new Zt(!1)});var I={};ie(I,{adjustColor:()=>rc,bpmToAnimationFrameRate:()=>_o,bpmToInterval:()=>pt,calculateBreathingScale:()=>Ko,calculateContrastRatio:()=>Oo,calculateNavigationScale:()=>jo,calculateOklabDerivedProperties:()=>Qo,calculateRhythmPhase:()=>Yo,colorDifference:()=>Jo,debounce:()=>Go,easeBeatAnimation:()=>qo,findRequiredLuminance:()=>ic,generateHarmonicOklabColors:()=>Xo,getBeatPhase:()=>$o,getCanonicalAccent:()=>ac,getHealthMonitor:()=>tc,getNextBeatTime:()=>Wo,getRootStyle:()=>na,hexToRgb:()=>oe,hslToRgb:()=>aa,intervalToBpm:()=>Vo,isOnBeat:()=>No,isValidHexColor:()=>ra,lerp:()=>Zo,lerpSmooth:()=>O,lerpSmoothMusical:()=>sa,lerpSmoothMusicalPerformance:()=>zo,lerpSmoothSimpleMusical:()=>Uo,oklabToRgb:()=>Cn,processOklabColor:()=>Mn,rgbToHex:()=>fe,rgbToHsl:()=>vn,rgbToOklab:()=>fn,sanitizeColorMap:()=>Ho,sleep:()=>nc,throttle:()=>Fo});function na(){return document.documentElement}function Fo(c,t){let e;return function(...n){e||(c(...n),e=!0,setTimeout(()=>e=!1,t))}}function Go(c,t){let e;return function(...n){clearTimeout(e),e=window.setTimeout(()=>c(...n),t)}}function ra(c){if(typeof c!="string")return!1;let t=c.trim(),e=t.startsWith("#")?t:`#${t}`;return/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/.test(e)}function oe(c){if(typeof c!="string")return{r:0,g:0,b:0};if(!ra(c))return{r:0,g:0,b:0};let t=c.trim(),e=t.startsWith("#")?t:`#${t}`;e=e.replace(/##+/g,"#"),e.length===4&&(e=`#${e[1]}${e[1]}${e[2]}${e[2]}${e[3]}${e[3]}`);let i=/^#([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(i)try{return{r:parseInt(i[1]||"0",16),g:parseInt(i[2]||"0",16),b:parseInt(i[3]||"0",16)}}catch{return{r:0,g:0,b:0}}else return{r:0,g:0,b:0}}function Ho(c){console.log("\u{1F3A8} [Year3000Utilities] sanitizeColorMap input:",{input:c,inputKeys:c?Object.keys(c):[],inputEntries:c?Object.entries(c):[]});let t=/^#?[0-9a-fA-F]{3}(?:[0-9a-fA-F]{3})?$/,e={};if(!c||typeof c!="object")return console.warn("\u{1F3A8} [Year3000Utilities] sanitizeColorMap: Invalid input type"),e;let i=[];return Object.entries(c).forEach(([n,r])=>{if(typeof r!="string"){i.push([n,r]),console.warn(`\u{1F3A8} [Year3000Utilities] Dropped non-string color: ${n} = ${r} (type: ${typeof r})`);return}let a=r.trim();if(!a||a==="undefined"){i.push([n,r]),console.warn(`\u{1F3A8} [Year3000Utilities] Dropped empty/undefined color: ${n} = "${r}"`);return}if(!t.test(a)){i.push([n,r]),console.warn(`\u{1F3A8} [Year3000Utilities] Dropped invalid hex color: ${n} = "${r}"`);return}let s=a.startsWith("#")?a:`#${a}`;e[n]=s}),console.log("\u{1F3A8} [Year3000Utilities] sanitizeColorMap output:",{sanitized:e,sanitizedKeys:Object.keys(e),sanitizedEntries:Object.entries(e),droppedCount:i.length,droppedEntries:i}),w?.enableDebug&&Object.keys(c).length!==Object.keys(e).length&&console.warn(`[StarryNight sanitizeColorMap] Dropped ${Object.keys(c).length-Object.keys(e).length} invalid colour entries.`),e}function vn(c,t,e){c/=255,t/=255,e/=255;let i=Math.max(c,t,e),n=Math.min(c,t,e),r=0,a=0,s=(i+n)/2;if(i!==n){let o=i-n;switch(a=s>.5?o/(2-i-n):o/(i+n),i){case c:r=(t-e)/o+(t<e?6:0);break;case t:r=(e-c)/o+2;break;case e:r=(c-t)/o+4;break}r/=6}return{h:r*360,s:a*100,l:s*100}}function aa(c,t,e){c/=360,t/=100,e/=100;let i=(s,o,l)=>(l<0&&(l+=1),l>1&&(l-=1),l<1/6?s+(o-s)*6*l:l<1/2?o:l<2/3?s+(o-s)*(2/3-l)*6:s),n,r,a;if(t===0)n=r=a=e;else{let s=e<.5?e*(1+t):e+t-e*t,o=2*e-s;n=i(o,s,c+1/3),r=i(o,s,c),a=i(o,s,c-1/3)}return{r:Math.round(n*255),g:Math.round(r*255),b:Math.round(a*255)}}function fe(c,t,e){let i=s=>{if(!Number.isFinite(s))return 0;let o=s<=1?s*255:s;return Math.min(255,Math.max(0,Math.round(o)))},[n,r,a]=[i(c),i(t),i(e)];return"#"+[n,r,a].map(s=>s.toString(16).padStart(2,"0")).join("")}function Oo(c,t){let e=l=>{let[m=0,d=0,h=0]=[l.r,l.g,l.b].map(p=>(p=p/255,p<=.03928?p/12.92:Math.pow((p+.055)/1.055,2.4)));return .2126*m+.7152*d+.0722*h},i=oe(c),n=oe(t);if(!i||!n)return 1;let r=e(i),a=e(n),s=Math.max(r,a),o=Math.min(r,a);return(s+.05)/(o+.05)}function O(c,t,e,i){return i<=1e-5||e<=0?(w?.enableDebug&&i<=1e-5,t):t+(c-t)*Math.pow(2,-e/i)}function sa(c,t,e,i,n="flow",r){let{musicalLerpOrchestrator:a}=(yn(),Bo(ia)),s=a.calculateMusicalLerp(i,n,r);return O(c,t,e,s.halfLife)}function zo(c,t,e,i,n,r="flow",a){return n?.calculatePerformanceAwareMusicalLerp?n.calculatePerformanceAwareMusicalLerp(c,t,e,i,r,a):sa(c,t,e,i,r,a)}function Uo(c,t,e,i=120,n=.5,r=.15){let a=Math.pow(i/120,.3),s=1+n*.3,o=r/a*s;return O(c,t,e,o)}function pt(c){return!c||c<=0?500:6e4/c}function Vo(c){return!c||c<=0?120:6e4/c}function _o(c,t=4){return pt(c)/t}function No(c,t,e,i=50){let n=pt(e),a=(c-t)%n;return a<=i||a>=n-i}function $o(c,t,e){let i=pt(e);return(c-t)%i/i}function Wo(c,t,e){let i=pt(e),n=c-t,r=Math.floor(n/i);return t+(r+1)*i}function qo(c,t="ease-out"){switch(t){case"ease-in":return c*c;case"linear":return c;case"ease-out":default:return c*(2-c)}}function Yo(c,t=1){let e=.001*t;return c*e%(2*Math.PI)}function Ko(c,t=.5){let i=.02*t;return 1+Math.sin(c)*i}function jo(c=.5,t="neutral"){let i=t==="energetic"?1.2:t==="calm"?.8:1;return 1+.05*c*i}function fn(c,t,e){let i=c/255,n=t/255,r=e/255,a=.4122214708*i+.5363325363*n+.0514459929*r,s=.2119034982*i+.6806995451*n+.1073969566*r,o=.0883024619*i+.2817188376*n+.6299787005*r,l=Math.cbrt(a),m=Math.cbrt(s),d=Math.cbrt(o);return{L:.2104542553*l+.793617785*m-.0040720468*d,a:1.9779984951*l-2.428592205*m+.4505937099*d,b:.0259040371*l+.7827717662*m-.808675766*d}}function Cn(c,t,e){let i=c+.3963377774*t+.2158037573*e,n=c-.1055613458*t-.0638541728*e,r=c-.0894841775*t-1.291485548*e,a=i*i*i,s=n*n*n,o=r*r*r,l=4.0767416621*a-3.3077115913*s+.2309699292*o,m=-1.2684380046*a+2.6097574011*s-.3413193965*o,d=-.0041960863*a-.7034186147*s+1.707614701*o;return l=Math.round(Math.max(0,Math.min(1,l))*255),m=Math.round(Math.max(0,Math.min(1,m))*255),d=Math.round(Math.max(0,Math.min(1,d))*255),{r:l,g:m,b:d}}function Mn(c,t={}){let{L:e,a:i,b:n}=c,r=Math.sqrt(i*i+n*n),a=Math.atan2(n,i);a<0&&(a+=2*Math.PI);let s=a*(180/Math.PI),{energy:o=.5,valence:l=.5,artisticMode:m="artist-vision"}=t,d=w.getCurrentMultipliers(),h=e*(1+(l-.5)*.1),p=r*(1+(o-.5)*.2)*(d?.saturation||1);return h=Math.max(0,Math.min(1,h*(d?.brightness||1))),{L:h,C:p,h:r>.001?s:null}}function Qo(c){let{L:t,C:e,h:i}=Mn(c),n=i!==null?i>=0&&i<90||i>=270&&i<=360:!1,r=i!==null?i>=90&&i<270:!1,a="neutral";return t>.7&&e>.1?a="bright":t<.4?a="dark":n&&e>.1?a="warm":r&&e>.1&&(a="cool"),{lightness:t,chroma:e,hue:i,isWarm:n,isCool:r,mood:a}}function Xo(c,t="analogous",e=30){let i=Mn(c);if(i.h===null)return[c];let n=(l,m,d)=>{let h=d*(Math.PI/180),p=m*Math.cos(h),b=m*Math.sin(h);return{L:l,a:p,b}},r=[c],{L:a,C:s,h:o}=i;switch(t){case"complementary":r.push(n(a,s,(o+180)%360));break;case"analogous":r.push(n(a,s,(o+e)%360)),r.push(n(a,s,(o-e+360)%360));break;case"triadic":r.push(n(a,s,(o+120)%360)),r.push(n(a,s,(o+240)%360));break;case"tetradic":r.push(n(a,s,(o+90)%360)),r.push(n(a,s,(o+180)%360)),r.push(n(a,s,(o+270)%360));break;case"split-complementary":r.push(n(a,s,(o+180-e)%360)),r.push(n(a,s,(o+180+e)%360));break;case"monochromatic":r.push({L:Math.max(0,a-.2),a:c.a,b:c.b}),r.push({L:Math.min(1,a+.2),a:c.a,b:c.b});break}return r}function Zo(c,t,e){return(1-e)*c+e*t}function Jo(c,t){let e=fn(c.r,c.g,c.b),i=fn(t.r,t.g,t.b),n=e.L-i.L,r=e.a-i.a,a=e.b-i.b;return Math.sqrt(n*n+r*r+a*a)}function tc(){return ec}function ic(c,t,e){let i=l=>{let[m=0,d=0,h=0]=[l.r,l.g,l.b].map(p=>(p=p/255,p<=.03928?p/12.92:Math.pow((p+.055)/1.055,2.4)));return .2126*m+.7152*d+.0722*h},n=i(t),r;r=e*(n+.05)-.05;let a=vn(c.r,c.g,c.b),s=i(c),o=r/s;return a.l}function nc(c){return new Promise(t=>setTimeout(t,c))}function rc(c,{brightness:t=1,saturation:e=1,hue:i=0}){let n=vn(c.r,c.g,c.b);return n.h=(n.h+i)%360,n.s=Math.max(0,Math.min(100,n.s*e)),n.l=Math.max(0,Math.min(100,n.l*t)),aa(n.h,n.s,n.l)}function ac(){let c=na(),t=getComputedStyle(c),e=t.getPropertyValue("--sn-accent-hex").trim(),i=t.getPropertyValue("--sn-accent-rgb").trim();if(!e&&i){let[n="0",r="0",a="0"]=i.split(/\s*,\s*/),s=parseInt(n,10)||0,o=parseInt(r,10)||0,l=parseInt(a,10)||0;e=fe(s,o,l)}if(!i&&e){let n=oe(e);n&&(i=`${n.r},${n.g},${n.b}`)}return{hex:e,rgb:i}}var Sn,ec,K=y(()=>{"use strict";U();Sn=class{registerSystem(t,e){}updateSystemMetrics(t,e){}},ec=new Sn});var Se,M,ne=y(()=>{"use strict";A();K();Se=class Se{constructor(t=!1){this.utils=I;this.debugEnabled=t}processColor(t,e=Se.PRESETS.STANDARD){let i=performance.now(),n=null;try{if(n=this.utils.hexToRgb(t),!n)throw new Error(`Invalid hex color: ${t}`);let r=this.utils.rgbToOklab(n.r,n.g,n.b),a=this.enhanceOKLABColor(r,e),s=this.generateShadowColor(r,e),o=this.utils.oklabToRgb(a.L,a.a,a.b),l=this.utils.oklabToRgb(s.L,s.a,s.b),m=this.utils.rgbToHex(o.r,o.g,o.b),d=this.utils.rgbToHex(l.r,l.g,l.b),h=this.convertOklabToOklch(a),p=performance.now()-i,b={originalHex:t,originalRgb:n,enhancedHex:m,enhancedRgb:o,shadowHex:d,shadowRgb:l,oklabOriginal:r,oklabEnhanced:a,oklabShadow:s,oklchEnhanced:h,processingTime:p};return this.debugEnabled&&u?.debug?.log("OKLABColorProcessor","Color processed:",{input:t,enhanced:m,shadow:d,preset:e.name,processingTime:`${p.toFixed(2)}ms`}),b}catch(r){this.debugEnabled&&u?.debug?.error("OKLABColorProcessor","Color processing failed:",r);let a=n||{r:124,g:58,b:237};return this.createFallbackResult(t,a)}}processColorPalette(t,e=Se.PRESETS.STANDARD){let i={};return Object.entries(t).forEach(([n,r])=>{r&&this.utils.hexToRgb(r)&&(i[n]=this.processColor(r,e))}),i}generateCSSVariables(t,e="sn-oklab"){let i={};return i[`--${e}-enhanced-hex`]=t.enhancedHex,i[`--${e}-enhanced-rgb`]=`${t.enhancedRgb.r},${t.enhancedRgb.g},${t.enhancedRgb.b}`,i[`--${e}-enhanced-r`]=Math.round(t.enhancedRgb.r).toString(),i[`--${e}-enhanced-g`]=Math.round(t.enhancedRgb.g).toString(),i[`--${e}-enhanced-b`]=Math.round(t.enhancedRgb.b).toString(),i[`--${e}-shadow-hex`]=t.shadowHex,i[`--${e}-shadow-rgb`]=`${t.shadowRgb.r},${t.shadowRgb.g},${t.shadowRgb.b}`,i[`--${e}-lightness`]=t.oklabEnhanced.L.toFixed(3),i[`--${e}-chroma-a`]=t.oklabEnhanced.a.toFixed(3),i[`--${e}-chroma-b`]=t.oklabEnhanced.b.toFixed(3),i[`--${e}-oklch-l`]=t.oklchEnhanced.L.toFixed(3),i[`--${e}-oklch-c`]=t.oklchEnhanced.C.toFixed(3),i[`--${e}-oklch-h`]=t.oklchEnhanced.H.toFixed(1),i}interpolateOKLAB(t,e,i,n=Se.PRESETS.STANDARD){let r=this.utils.hexToRgb(t),a=this.utils.hexToRgb(e);if(!r||!a)throw new Error("Invalid hex colors for interpolation");let s=this.utils.rgbToOklab(r.r,r.g,r.b),o=this.utils.rgbToOklab(a.r,a.g,a.b),l={L:s.L+(o.L-s.L)*i,a:s.a+(o.a-s.a)*i,b:s.b+(o.b-s.b)*i},m=this.utils.oklabToRgb(l.L,l.a,l.b),d=this.utils.rgbToHex(m.r,m.g,m.b);return this.processColor(d,n)}generateOKLABGradient(t,e,i=5,n=Se.PRESETS.STANDARD){let r=[];for(let a=0;a<i;a++){let s=a/(i-1),o=this.interpolateOKLAB(t,e,s,n);r.push(o)}return r}enhanceOKLABColor(t,e){let i=Math.sqrt(t.a*t.a+t.b*t.b),n=Math.min(1,Math.max(0,t.L*e.lightnessBoost)),r=i>e.vibrantThreshold?e.chromaBoost:1,a=t.a*r,s=t.b*r;return{L:n,a,b:s}}generateShadowColor(t,e){return{L:Math.max(.02,t.L*e.shadowReduction),a:t.a*.8,b:t.b*.8}}convertOklabToOklch(t){let e=t.L,i=Math.sqrt(t.a*t.a+t.b*t.b),n=Math.atan2(t.b,t.a)*(180/Math.PI);return n<0&&(n+=360),{L:e,C:i,H:n}}createFallbackResult(t,e){let i=this.utils.rgbToOklab(e.r,e.g,e.b);return{originalHex:t,originalRgb:e,enhancedHex:t,enhancedRgb:e,shadowHex:"#000000",shadowRgb:{r:0,g:0,b:0},oklabOriginal:i,oklabEnhanced:i,oklabShadow:{L:.05,a:0,b:0},oklchEnhanced:this.convertOklabToOklch(i),processingTime:0}}static getPreset(t){return Se.PRESETS[t.toUpperCase()]||Se.PRESETS.STANDARD}static createCustomPreset(t,e,i,n,r=.3,a=.1){return{name:t,description:e,lightnessBoost:Math.max(.5,Math.min(1.5,i)),chromaBoost:Math.max(.5,Math.min(2,n)),shadowReduction:Math.max(.1,Math.min(.5,r)),vibrantThreshold:Math.max(.05,Math.min(.2,a))}}};Se.PRESETS={SUBTLE:{name:"Subtle Enhancement",description:"Minimal color enhancement for conservative aesthetics",lightnessBoost:1.05,chromaBoost:1.1,shadowReduction:.4,vibrantThreshold:.08},STANDARD:{name:"Standard Enhancement",description:"Balanced color enhancement for general use",lightnessBoost:1.1,chromaBoost:1.15,shadowReduction:.3,vibrantThreshold:.1},VIBRANT:{name:"Vibrant Enhancement",description:"Enhanced vibrancy for dynamic color experiences",lightnessBoost:1.15,chromaBoost:1.25,shadowReduction:.25,vibrantThreshold:.12},COSMIC:{name:"Cosmic Enhancement",description:"Maximum enhancement for Year 3000 consciousness experiences",lightnessBoost:1.2,chromaBoost:1.35,shadowReduction:.2,vibrantThreshold:.15}};M=Se});var Jt,J,xe=y(()=>{"use strict";ne();Jt={calm:{temperatureRange:[2700,4e3],baseTemperature:3200,characteristics:{energy:[0,.3],valence:[.4,.8],intensity:.6},cssClass:"organic-emotion-calm",description:"Warm, soothing, meditative states",oklabBaseColor:"#89b4fa",oklabPreset:"SUBTLE",perceptualCharacteristics:{lightness:[.6,.8],chromaBoost:.9,hueShift:15}},melancholy:{temperatureRange:[2200,3500],baseTemperature:2800,characteristics:{energy:[0,.4],valence:[0,.4],intensity:.8},cssClass:"organic-emotion-melancholy",description:"Deep, introspective, amber-golden tones",oklabBaseColor:"#f9e2af",oklabPreset:"STANDARD",perceptualCharacteristics:{lightness:[.4,.6],chromaBoost:1.1,hueShift:-10}},energetic:{temperatureRange:[5500,7500],baseTemperature:6500,characteristics:{energy:[.6,1],valence:[.5,1],intensity:1},cssClass:"organic-emotion-energetic",description:"Bright, vibrant, high-energy states",oklabBaseColor:"#a6e3a1",oklabPreset:"VIBRANT",perceptualCharacteristics:{lightness:[.7,.9],chromaBoost:1.3,hueShift:5}},aggressive:{temperatureRange:[8e3,12e3],baseTemperature:1e4,characteristics:{energy:[.7,1],valence:[0,.6],intensity:1.2},cssClass:"organic-emotion-aggressive",description:"Cool, intense, high-energy negative valence",oklabBaseColor:"#f38ba8",oklabPreset:"COSMIC",perceptualCharacteristics:{lightness:[.5,.7],chromaBoost:1.4,hueShift:-5}},happy:{temperatureRange:[4500,6500],baseTemperature:5500,characteristics:{energy:[.4,.8],valence:[.6,1],intensity:.9},cssClass:"organic-emotion-happy",description:"Balanced, joyful, warm-white tones",oklabBaseColor:"#fab387",oklabPreset:"STANDARD",perceptualCharacteristics:{lightness:[.75,.85],chromaBoost:1.15,hueShift:8}},romantic:{temperatureRange:[2500,3500],baseTemperature:3e3,characteristics:{energy:[.2,.6],valence:[.5,.9],intensity:.7},cssClass:"organic-emotion-romantic",description:"Soft, intimate, warm tones with pink accent",oklabBaseColor:"#f5c2e7",oklabPreset:"SUBTLE",perceptualCharacteristics:{lightness:[.65,.8],chromaBoost:1,hueShift:12}},mysterious:{temperatureRange:[1800,2800],baseTemperature:2300,characteristics:{energy:[.1,.5],valence:[.1,.5],intensity:.9},cssClass:"organic-emotion-mysterious",description:"Deep, enigmatic, low temperature with purple accent",oklabBaseColor:"#cba6f7",oklabPreset:"VIBRANT",perceptualCharacteristics:{lightness:[.3,.5],chromaBoost:1.2,hueShift:-15}},epic:{temperatureRange:[7e3,15e3],baseTemperature:11e3,characteristics:{energy:[.6,1],valence:[.3,.8],intensity:1.3},cssClass:"organic-emotion-epic",description:"Grand, cinematic, high contrast blue-gold",oklabBaseColor:"#74c7ec",oklabPreset:"COSMIC",perceptualCharacteristics:{lightness:[.6,.9],chromaBoost:1.35,hueShift:20}},ambient:{temperatureRange:[3e3,5e3],baseTemperature:4e3,characteristics:{energy:[.1,.4],valence:[.3,.7],intensity:.5},cssClass:"organic-emotion-ambient",description:"Atmospheric, floating, neutral temperature",oklabBaseColor:"#94e2d5",oklabPreset:"SUBTLE",perceptualCharacteristics:{lightness:[.5,.7],chromaBoost:.8,hueShift:0}}},J=class{constructor(t=!1){this.enableDebug=t,this.oklabProcessor=new M(t)}mapMusicToEmotionalTemperature(t){let{energy:e=.5,valence:i=.5,danceability:n=.5,tempo:r=120,mode:a=1}=t,s,o,l=1;if(e>=.6&&i>=.6?(s=n>.7?"energetic":"happy",e>.8&&i>.8&&(o="epic",l=.7)):e>=.6&&i<.5?(s=e>.8?"aggressive":"epic",i<.3&&(o="mysterious",l=.8)):e<.4&&i>=.5?(s=i>.7?"calm":"romantic",e<.2&&(o="ambient",l=.6)):(s=i<.3?"melancholy":"mysterious",e<.2&&i<.2&&(o="ambient",l=.8)),t.genre){let R=this.getGenreEmotionalAdjustment(t.genre,s);R&&(R.override&&(s=R.override),R.secondary&&(o=R.secondary,l=R.blendRatio||.7))}let m=Jt[s].characteristics.intensity,d=e*.3,h=Math.abs(i-.5)*.2,p=r>140?.1:r<80?-.1:0,b=Math.max(.1,Math.min(1.5,m+d+h+p)),v=Jt[s],[C,P]=v.temperatureRange,E=e*.6+i*.4,L=C+(P-C)*E,$=M.getPreset(v.oklabPreset),G,B;try{let R=this.createContextualOKLABPreset(v,b,e,i);G=this.oklabProcessor.processColor(v.oklabBaseColor,R),B=G.enhancedHex,this.enableDebug&&console.log("\u{1F321}\uFE0F [EmotionalTemperatureMapper] OKLAB processing:",{emotion:s,baseColor:v.oklabBaseColor,preset:R.name,enhanced:B,oklabCoords:G.oklabEnhanced})}catch(R){this.enableDebug&&console.warn("\u{1F321}\uFE0F [EmotionalTemperatureMapper] OKLAB processing failed:",R),B=v.oklabBaseColor}let W=this.generateEmotionalCSSVariables(s,o,b,L,l,G,B),V={primaryEmotion:s,...o&&{secondaryEmotion:o},intensity:b,temperature:Math.round(L),blendRatio:l,cssClass:v.cssClass,cssVariables:W,oklabPreset:$,...G&&{oklabResult:G},...B&&{perceptualColorHex:B}};return this.enableDebug&&console.log("\u{1F321}\uFE0F [EmotionalTemperatureMapper] Music analysis result:",{input:{energy:e,valence:i,genre:t.genre},output:V,reasoning:{energyValenceQuadrant:this.getEnergyValenceQuadrant(e,i),genreInfluence:t.genre,intensityFactors:{baseIntensity:m,energyBoost:d,valenceInfluence:h,tempoInfluence:p}}}),V}createContextualOKLABPreset(t,e,i,n){let r=M.getPreset(t.oklabPreset),a=t.perceptualCharacteristics,s=i*.5+n*.3+.2,o=a.lightness[0]+(a.lightness[1]-a.lightness[0])*s,l=a.chromaBoost*e*(.8+i*.4);return M.createCustomPreset(`${t.cssClass}-contextual`,`Contextual ${r.description} for ${t.description}`,o/.5,l,r.shadowReduction,r.vibrantThreshold)}getGenreEmotionalAdjustment(t,e){let i={edm:{secondary:"energetic",blendRatio:.8},house:{secondary:"energetic",blendRatio:.7},ambient:{override:"ambient"},downtempo:{override:"calm",secondary:"ambient",blendRatio:.6},metal:{override:"aggressive"},"hard-rock":{secondary:"aggressive",blendRatio:.8},alternative:{secondary:"epic",blendRatio:.7},classical:{override:"epic",secondary:"calm",blendRatio:.6},soundtrack:{override:"epic"},orchestral:{override:"epic"},jazz:{override:"mysterious",secondary:"romantic",blendRatio:.7},blues:{override:"melancholy"},soul:{secondary:"romantic",blendRatio:.6},folk:{override:"calm",secondary:"melancholy",blendRatio:.6},acoustic:{override:"romantic",secondary:"calm",blendRatio:.7},"hip-hop":{secondary:"aggressive",blendRatio:.8},trap:{secondary:"aggressive",blendRatio:.9},pop:{secondary:"happy",blendRatio:.7},"indie-pop":{secondary:"happy",blendRatio:.6}},n=t.toLowerCase().replace(/[\s-_]/g,"-");return i[n]||null}getEnergyValenceQuadrant(t,e){return t>=.5&&e>=.5?"High Energy + Positive":t>=.5&&e<.5?"High Energy + Negative":t<.5&&e>=.5?"Low Energy + Positive":"Low Energy + Negative"}generateEmotionalCSSVariables(t,e,i,n,r,a,s){let o={};o["--organic-current-emotion"]=t,o["--organic-emotional-intensity"]=i.toString(),o["--organic-current-temperature"]=n.toString(),o["--organic-emotion-primary"]=t,e&&(o["--organic-emotion-secondary"]=e,o["--organic-emotion-blend-ratio"]=r.toString()),o["--organic-emotional-saturation"]=Math.max(.5,i).toString(),o["--organic-cinematic-contrast"]=Math.max(.8,i*1.2).toString(),o["--organic-warmth"]=this.calculateWarmth(n).toString();let l=this.calculateBreathingSpeed(t,i);o["--organic-breathing-cycle"]=`${l}s`;let m=this.calculateTemperatureFilters(n,i);return Object.assign(o,m),a&&s&&(o["--organic-emotion-oklab-hex"]=s,o["--organic-emotion-oklab-rgb"]=`${a.enhancedRgb.r},${a.enhancedRgb.g},${a.enhancedRgb.b}`,o["--organic-emotion-oklab-l"]=a.oklabEnhanced.L.toFixed(3),o["--organic-emotion-oklab-a"]=a.oklabEnhanced.a.toFixed(3),o["--organic-emotion-oklab-b"]=a.oklabEnhanced.b.toFixed(3),o["--organic-emotion-oklch-l"]=a.oklchEnhanced.L.toFixed(3),o["--organic-emotion-oklch-c"]=a.oklchEnhanced.C.toFixed(3),o["--organic-emotion-oklch-h"]=a.oklchEnhanced.H.toFixed(1),o["--organic-emotion-oklab-shadow-hex"]=a.shadowHex,o["--organic-emotion-oklab-shadow-rgb"]=`${a.shadowRgb.r},${a.shadowRgb.g},${a.shadowRgb.b}`,o["--organic-perceptual-emotion-color"]=s,o["--organic-perceptual-emotion-rgb"]=`${a.enhancedRgb.r},${a.enhancedRgb.g},${a.enhancedRgb.b}`,this.enableDebug&&console.log("\u{1F3A8} [EmotionalTemperatureMapper] Generated OKLAB CSS variables:",{emotion:t,perceptualColor:s,oklabCoords:a.oklabEnhanced,oklchCoords:a.oklchEnhanced})),o}calculateWarmth(t){return t<=4e3?.7+(4e3-t)/2200*.3:t>=7e3?Math.max(.2,.7-(t-7e3)/8e3*.5):.5+(7e3-t)/3e3*.2}calculateBreathingSpeed(t,e){let n={calm:6,melancholy:8,energetic:2,aggressive:1.5,happy:3,romantic:5,mysterious:7,epic:2.5,ambient:10}[t],r=Math.max(.5,Math.min(2,2-e));return n*r}calculateTemperatureFilters(t,e){let i={},n=this.mapTemperatureToHue(t);i["--organic-temperature-hue-shift"]=`${n}deg`;let r=Math.max(.8,Math.min(1.5,1+(e-.5)*.4));i["--organic-temperature-saturation"]=r.toString();let a=this.mapTemperatureToBrightness(t);return i["--organic-temperature-brightness"]=a.toString(),i}mapTemperatureToHue(t){return t<=4e3?-15+(4e3-t)/2e3*-15:t>=8e3?10+(t-8e3)/7e3*20:-5+(t-4e3)/4e3*15}mapTemperatureToBrightness(t){return .9+(t-2e3)/13e3*.3}applyEmotionalTemperature(t,e){let i=Array.from(t.classList).filter(n=>n.startsWith("organic-emotion-"));t.classList.remove(...i),t.classList.add(e.cssClass),e.secondaryEmotion&&t.classList.add(`organic-emotion-blend-${e.secondaryEmotion}`),Object.entries(e.cssVariables).forEach(([n,r])=>{t.style.setProperty(n,r)}),this.enableDebug&&console.log("\u{1F3A8} [EmotionalTemperatureMapper] Applied emotional temperature:",{element:t.tagName,emotion:e.primaryEmotion,secondary:e.secondaryEmotion,intensity:e.intensity,temperature:e.temperature})}static getAvailableEmotions(){return Object.keys(Jt)}static getEmotionCharacteristics(t){return Jt[t]}}});function f(c,t,e,i){let n=parseInt(c.slice(1,3),16),r=parseInt(c.slice(3,5),16),a=parseInt(c.slice(5,7),16),s=(.299*n+.587*r+.114*a)/255;return{hex:c,rgb:`${n}, ${r}, ${a}`,hsl:[t,e,i],brightness:s}}function oa(c,t){let e=Ae[c],i=sc[t];switch(t){case"bright":return c==="latte"?e.surface1:e.surface0;case"balanced":return c==="latte"?e.base:e.surface0;case"dark":return c==="latte"?e.mantle:e.base;default:return e.base}}function ca(c,t){let e=Ae[c];switch(t){case"bright":return c==="latte"?e.surface2:e.surface1;case"balanced":return c==="latte"?e.surface0:e.surface1;case"dark":return e.surface0;default:return e.surface1}}function la(c,t){return Ae[c][t]}function ua(c){let t=Ae[c];return c==="latte"?t.blue:t.mauve}var Ae,sc,wn=y(()=>{"use strict";Ae={mocha:{rosewater:f("#f5e0dc",10,56,91),flamingo:f("#f2cdcd",0,59,88),pink:f("#f5c2e7",316,72,86),mauve:f("#cba6f7",267,84,81),red:f("#f38ba8",343,81,75),maroon:f("#eba0ac",350,65,77),peach:f("#fab387",23,92,75),yellow:f("#f9e2af",41,86,83),green:f("#a6e3a1",115,54,76),teal:f("#94e2d5",174,57,73),sky:f("#89dceb",189,71,73),sapphire:f("#74c7ec",199,76,69),blue:f("#89b4fa",217,92,76),lavender:f("#b4befe",232,97,85),text:f("#cdd6f4",226,64,88),subtext1:f("#bac2de",227,35,80),subtext0:f("#a6adc8",228,24,72),overlay2:f("#9399b2",228,17,64),overlay1:f("#7f849c",230,13,55),overlay0:f("#6c7086",231,11,47),surface2:f("#585b70",233,12,39),surface1:f("#45475a",234,13,31),surface0:f("#313244",237,16,23),base:f("#1e1e2e",240,21,15),mantle:f("#181825",240,18,13),crust:f("#11111b",240,23,9)},latte:{rosewater:f("#dc8a78",11,59,67),flamingo:f("#dd7878",0,60,67),pink:f("#ea76cb",316,73,69),mauve:f("#8839ef",266,85,58),red:f("#d20f39",347,87,44),maroon:f("#e64553",355,76,59),peach:f("#fe640b",22,99,52),yellow:f("#df8e1d",35,77,49),green:f("#40a02b",109,58,40),teal:f("#179299",183,74,35),sky:f("#04a5e5",197,97,46),sapphire:f("#209fb5",189,70,42),blue:f("#1e66f5",220,91,54),lavender:f("#7287fd",231,97,72),text:f("#4c4f69",234,16,35),subtext1:f("#5c5f77",233,13,41),subtext0:f("#6c6f85",233,10,47),overlay2:f("#7c7f93",232,10,53),overlay1:f("#8c8fa1",231,10,59),overlay0:f("#9ca0b0",228,11,65),surface2:f("#acb0be",227,12,71),surface1:f("#bcc0cc",226,14,77),surface0:f("#ccd0da",225,16,83),base:f("#eff1f5",220,23,95),mantle:f("#e6e9ef",220,22,92),crust:f("#dce0e8",220,21,89)},frappe:{rosewater:f("#f2d5cf",10,57,88),flamingo:f("#eebebe",0,58,84),pink:f("#f4b8e4",316,73,84),mauve:f("#ca9ee6",277,59,76),red:f("#e78284",359,68,71),maroon:f("#ea999c",358,56,76),peach:f("#ef9f76",20,79,70),yellow:f("#e5c890",40,62,73),green:f("#a6d189",96,44,68),teal:f("#81c8be",172,39,65),sky:f("#99d1db",189,48,73),sapphire:f("#85c1dc",199,55,69),blue:f("#8caaee",222,74,74),lavender:f("#babbf1",239,66,84),text:f("#c6d0f5",227,70,87),subtext1:f("#b5bfe2",229,44,80),subtext0:f("#a5adce",230,34,72),overlay2:f("#949cbb",231,19,64),overlay1:f("#838ba7",232,16,56),overlay0:f("#737994",232,13,49),surface2:f("#626880",233,16,42),surface1:f("#51576d",234,16,35),surface0:f("#414559",235,16,30),base:f("#303446",229,19,23),mantle:f("#292c3c",231,19,20),crust:f("#232634",229,20,17)},macchiato:{rosewater:f("#f4dbd6",10,58,90),flamingo:f("#f0c6c6",0,58,86),pink:f("#f5bde6",316,74,85),mauve:f("#c6a0f6",267,83,79),red:f("#ed8796",351,74,73),maroon:f("#ee99a0",357,70,77),peach:f("#f5a97f",21,86,73),yellow:f("#eed49f",42,79,78),green:f("#a6da95",105,48,72),teal:f("#8bd5ca",172,47,69),sky:f("#91d7e3",189,59,73),sapphire:f("#7dc4e4",199,66,69),blue:f("#8aadf4",220,83,75),lavender:f("#b7bdf8",238,82,84),text:f("#cad3f5",227,68,88),subtext1:f("#b8c0e0",228,39,81),subtext0:f("#a5adcb",227,27,72),overlay2:f("#939ab7",228,20,64),overlay1:f("#8087a2",230,15,56),overlay0:f("#6e738d",230,12,48),surface2:f("#5b6078",233,16,40),surface1:f("#494d64",234,15,33),surface0:f("#363a4f",235,16,26),base:f("#24273a",232,23,19),mantle:f("#1e2030",233,23,16),crust:f("#181926",236,23,13)}},sc={bright:{baseColorTarget:.25,surfaceColorTarget:.35,textContrastMin:4.5},balanced:{baseColorTarget:.15,surfaceColorTarget:.25,textContrastMin:4.5},dark:{baseColorTarget:.08,surfaceColorTarget:.15,textContrastMin:3}}});function S(c,t,e,i){let n=parseInt(c.slice(1,3),16),r=parseInt(c.slice(3,5),16),a=parseInt(c.slice(5,7),16),s=(.299*n+.587*r+.114*a)/255;return{hex:c,rgb:`${n}, ${r}, ${a}`,hsl:[t,e,i],brightness:s}}function ma(c,t){let e=Ie[c],i=cc[t];switch(t){case"bright":return e.surface1;case"balanced":return e.surface0;case"dark":return e.base;default:return e.base}}function da(c,t){let e=Ie[c];switch(t){case"bright":return e.surface2;case"balanced":return e.surface1;case"dark":return e.surface0;default:return e.surface1}}function ha(c,t){return Ie[c][t]}function ga(c){return Ie[c].mauve}function pa(c,t="medium"){let e=Ie[c];switch(t){case"low":return[e.mauve,e.blue];case"medium":return[e.pink,e.peach];case"high":return[e.red,e.teal];default:return[e.mauve,e.pink]}}function ba(c){let t=Ie[c];return{primary:t.mauve,secondary:t.pink,tertiary:t.sky,atmosphere:t.base}}var Ie,cc,En=y(()=>{"use strict";Ie={subtle:{rosewater:S("#e8d5d1",15,45,85),flamingo:S("#e5c3c3",0,45,82),pink:S("#d8a8cc",316,40,75),mauve:S("#9d7bc7",267,45,65),red:S("#c85a7a",343,45,60),maroon:S("#c27882",350,35,65),peach:S("#d18a5f",23,50,60),yellow:S("#d4c285",41,45,70),green:S("#8cc98a",115,35,65),teal:S("#7bc5b8",174,35,65),sky:S("#7ab5c7",189,40,65),sapphire:S("#6baac7",199,45,60),blue:S("#7d9dd4",217,50,65),lavender:S("#a8aed9",232,45,75),text:S("#c2c8d4",226,25,80),subtext1:S("#b2b8c8",227,20,72),subtext0:S("#9ca4b8",228,15,65),overlay2:S("#868ea8",228,12,58),overlay1:S("#757d95",230,10,52),overlay0:S("#656c82",231,8,45),surface2:S("#555c70",233,8,38),surface1:S("#454c5a",234,8,32),surface0:S("#353a46",237,10,25),base:S("#252832",240,12,17),mantle:S("#1f222a",240,10,15),crust:S("#181b22",240,15,12)},balanced:{rosewater:S("#f2d8d3",15,60,88),flamingo:S("#eec6c6",0,60,85),pink:S("#e8b3d8",316,55,80),mauve:S("#b388d6",267,55,70),red:S("#d16b8a",343,55,65),maroon:S("#d08692",350,45,70),peach:S("#e59a6f",23,65,65),yellow:S("#e0d295",41,55,75),green:S("#9cd49a",115,40,70),teal:S("#8bd0c3",174,40,70),sky:S("#8ac0d2",189,50,70),sapphire:S("#7bb5d2",199,55,65),blue:S("#8da8e0",217,60,70),lavender:S("#b8bee5",232,55,80),text:S("#ced4e0",226,35,85),subtext1:S("#bec4d3",227,25,77),subtext0:S("#a8b0c3",228,20,70),overlay2:S("#929ab3",228,15,63),overlay1:S("#8289a0",230,12,57),overlay0:S("#72798f",231,10,50),surface2:S("#62697d",233,10,43),surface1:S("#525968",234,10,37),surface0:S("#424954",237,12,30),base:S("#2f323e",240,15,22),mantle:S("#282b36",240,12,19),crust:S("#21242e",240,18,16)},cinematic:{rosewater:S("#fce0db",15,85,92),flamingo:S("#f5c9c9",0,85,88),pink:S("#ff6b9d",316,100,70),mauve:S("#6c5ce7",267,85,65),red:S("#ff4757",343,100,65),maroon:S("#e84393",350,80,70),peach:S("#fd7f28",23,95,58),yellow:S("#f39c12",41,88,52),green:S("#a6e3a1",115,54,76),teal:S("#00cec9",174,100,40),sky:S("#74b9ff",189,100,72),sapphire:S("#0984e3",199,100,46),blue:S("#a29bfe",217,95,80),lavender:S("#c77dff",232,100,75),text:S("#e8f0ff",226,100,95),subtext1:S("#d0d8f0",227,65,88),subtext0:S("#b8c0d8",228,45,80),overlay2:S("#a0a8c0",228,30,70),overlay1:S("#8890a8",230,20,60),overlay0:S("#707890",231,15,50),surface2:S("#586078",233,15,42),surface1:S("#485060",234,15,35),surface0:S("#384048",237,18,28),base:S("#202030",240,25,16),mantle:S("#181828",240,22,13),crust:S("#101020",240,30,9)},maximum:{rosewater:S("#ffe5e0",15,100,95),flamingo:S("#ffcccc",0,100,90),pink:S("#ff3d7f",316,100,62),mauve:S("#5a4fcf",267,100,55),red:S("#ff2942",343,100,58),maroon:S("#e6337a",350,90,65),peach:S("#ff6500",23,100,50),yellow:S("#f1c40f",48,89,50),green:S("#00ff88",150,100,50),teal:S("#00ffff",180,100,50),sky:S("#4da6ff",189,100,65),sapphire:S("#0066ff",199,100,50),blue:S("#8a7fff",217,100,75),lavender:S("#b347ff",232,100,65),text:S("#ffffff",0,0,100),subtext1:S("#e8e8ff",240,100,95),subtext0:S("#d0d0ff",240,100,90),overlay2:S("#b8b8ff",240,100,85),overlay1:S("#a0a0ff",240,100,80),overlay0:S("#8888ff",240,100,75),surface2:S("#4040aa",240,60,45),surface1:S("#303088",240,65,35),surface0:S("#202066",240,70,25),base:S("#0f0f33",240,70,13),mantle:S("#0a0a22",240,75,10),crust:S("#050511",240,80,5)}},cc={bright:{baseColorTarget:.25,surfaceColorTarget:.35,textContrastMin:4.5},balanced:{baseColorTarget:.15,surfaceColorTarget:.25,textContrastMin:4.5},dark:{baseColorTarget:.08,surfaceColorTarget:.15,textContrastMin:3}}});function ya(c,t="balanced"){return j.getBrightnessAdjustedBaseColor(c,t)}function fa(c,t="balanced"){return j.getBrightnessAdjustedSurfaceColor(c,t)}function Sa(c){return j.getDefaultAccentColor(c)}function va(c,t){return j.getAccentColor(c,t)}var Pn,j,bt=y(()=>{"use strict";U();wn();En();wn();En();Pn=class c{constructor(){}static getInstance(){return c.instance||(c.instance=new c),c.instance}getCurrentPaletteSystem(){return w.paletteSystem||"catppuccin"}getCurrentPalette(){return this.getCurrentPaletteSystem()==="year3000"?Ie:Ae}getCurrentDefaultFlavor(){return this.getCurrentPaletteSystem()==="year3000"?"balanced":"mocha"}getBrightnessAdjustedBaseColor(t,e="balanced"){let i=this.getCurrentPaletteSystem(),n=t||this.getCurrentDefaultFlavor();return i==="year3000"?ma(n,e):oa(n,e)}getBrightnessAdjustedSurfaceColor(t,e="balanced"){let i=this.getCurrentPaletteSystem(),n=t||this.getCurrentDefaultFlavor();return i==="year3000"?da(n,e):ca(n,e)}getDefaultAccentColor(t){let e=this.getCurrentPaletteSystem(),i=t||this.getCurrentDefaultFlavor();return e==="year3000"?ga(i):ua(i)}getAccentColor(t,e){let i=this.getCurrentPaletteSystem(),n=e||this.getCurrentDefaultFlavor();return i==="year3000"?ha(n,t):la(n,t)}getCinematicGradientPair(t,e="medium"){let i=this.getCurrentPaletteSystem(),n=t||this.getCurrentDefaultFlavor();if(i==="year3000")return pa(n,e);{let r=Ae[n];switch(e){case"low":return[r.mauve,r.blue];case"medium":return[r.pink,r.peach];case"high":return[r.red,r.teal];default:return[r.mauve,r.pink]}}}getAnimatedFlowColors(t){let e=this.getCurrentPaletteSystem(),i=t||this.getCurrentDefaultFlavor();if(e==="year3000")return ba(i);{let n=Ae[i];return{primary:n.mauve,secondary:n.pink,tertiary:n.blue,atmosphere:n.base}}}supportsCinematicFeatures(){return this.getCurrentPaletteSystem()==="year3000"}getPaletteSystemDisplayName(){return this.getCurrentPaletteSystem()==="year3000"?"Year 3000 Cinematic":"Catppuccin Classic"}},j=Pn.getInstance()});var ei,ti,Ca=y(()=>{"use strict";ei={jazz:{temperatureShift:15,saturationBoost:1.1,warmth:.8},electronic:{temperatureShift:-10,saturationBoost:1.2,warmth:.2},classical:{temperatureShift:5,saturationBoost:.9,warmth:.6},rock:{temperatureShift:0,saturationBoost:1.15,warmth:.5},ambient:{temperatureShift:-5,saturationBoost:.8,warmth:.3},hiphop:{temperatureShift:8,saturationBoost:1.25,warmth:.7},pop:{temperatureShift:0,saturationBoost:1,warmth:.5},metal:{temperatureShift:-15,saturationBoost:1.3,warmth:.1},indie:{temperatureShift:10,saturationBoost:.95,warmth:.6},default:{temperatureShift:0,saturationBoost:1,warmth:.5}},ti=class{constructor(t,e){this.paletteCache={};this.cacheTTL=3e5;this.maxCacheSize=50;this.config=t,this.utils=e}async loadCustomPalette(t,e){let i=this.paletteCache[t];if(i&&Date.now()-i.timestamp<this.cacheTTL&&i.isValid)return this.config.enableDebug&&console.log(`[PaletteExtensionManager] Cache hit for palette: ${t}`),i.palette;try{let n=this.generateFallbackPalette(t);if(this.validatePalette(n))return this.cachePalette(t,n,!0),n}catch(n){this.config.enableDebug&&console.warn(`[PaletteExtensionManager] Failed to load palette ${t}:`,n)}return null}generateFallbackPalette(t){let e=this.utils.getRootStyle(),i=getComputedStyle(e),n=i.getPropertyValue("--spice-main").trim()||i.getPropertyValue("--spice-base").trim()||"#1e1e2e",r=i.getPropertyValue("--sn-gradient-accent").trim()||i.getPropertyValue("--spice-button").trim()||i.getPropertyValue("--sn-dynamic-accent").trim()||i.getPropertyValue("--spice-accent").trim()||"#8caaee",a=this.utils.hexToRgb(n.startsWith("#")?n:`#${n}`),s=this.utils.hexToRgb(r.startsWith("#")?r:`#${r}`);if(!a||!s){let m=i.getPropertyValue("--sn-dynamic-accent").trim(),d=i.getPropertyValue("--spice-base").trim();return{name:t,version:"1.0.0",accents:{mauve:m||"#ca9ee6",pink:"#f4b8e4",blue:m||"#8caaee",sapphire:"#85c1dc",sky:"#99d1db",teal:"#81c8be",green:"#a6d189",yellow:"#e5c890",peach:"#ef9f76",red:"#e78284",lavender:"#babbf1"},neutrals:{base:d||"#1e1e2e",surface0:"#313244",surface1:"#45475a",surface2:"#585b70",overlay0:"#6c7086",overlay1:"#7f849c",overlay2:"#9399b2",text:"#cdd6f4"},metadata:{author:"PaletteExtensionManager",description:`Generated fallback for ${t}`,temperature:"neutral"}}}let o=this.utils.rgbToHsl(a.r,a.g,a.b),l=this.utils.rgbToHsl(s.r,s.g,s.b);return{name:t,version:"1.0.0",accents:this.generateAccentVariations(l),neutrals:this.generateNeutralVariations(o),metadata:{author:"PaletteExtensionManager",description:`Generated palette for ${t}`,temperature:this.detectTemperature(o,l)}}}applyGenreAwareModifications(t,e){let i=ei[e]||ei.default;this.config.enableDebug&&console.log(`[PaletteExtensionManager] Applying ${e} hints to palette:`,i);let n={...t,accents:{},neutrals:{},metadata:{...t.metadata,genre:[...t.metadata?.genre||[],e]}};for(let[r,a]of Object.entries(t.accents))n.accents[r]=this.applyGenreColorModification(a,i.temperatureShift,i.saturationBoost);for(let[r,a]of Object.entries(t.neutrals))n.neutrals[r]=this.applyGenreColorModification(a,i.temperatureShift*.3,i.saturationBoost*.7);return n}validatePalette(t){if(!t||typeof t!="object"||!t.name||typeof t.name!="string"||!t.version||typeof t.version!="string"||!t.accents||typeof t.accents!="object"||!t.neutrals||typeof t.neutrals!="object")return!1;let e=[...Object.values(t.accents),...Object.values(t.neutrals)];for(let i of e)if(typeof i!="string"||!this.isValidHexColor(i))return!1;return!0}cachePalette(t,e,i){if(Object.keys(this.paletteCache).length>=this.maxCacheSize){let r=Object.entries(this.paletteCache).sort(([,a],[,s])=>a.timestamp-s.timestamp)[0]?.[0];r&&this.paletteCache[r]&&delete this.paletteCache[r]}this.paletteCache[t]={palette:e,timestamp:Date.now(),isValid:i}}generateAccentVariations(t){let e={},i=[0,30,60,120,180,210,240,300,330,45,90],n=["primary","secondary","tertiary","complement","opposite","warm1","cool1","accent1","accent2","highlight","emphasis"];return i.forEach((r,a)=>{let s=n[a]||`variant${a}`,o=(t.h+r)%360,l=this.utils.hslToRgb(o,t.s,t.l);l&&(e[s]=this.utils.rgbToHex(l.r,l.g,l.b))}),e}generateNeutralVariations(t){let e={};return[{name:"base",l:t.l},{name:"surface0",l:Math.min(95,t.l+10)},{name:"surface1",l:Math.min(90,t.l+20)},{name:"surface2",l:Math.min(85,t.l+30)},{name:"overlay0",l:Math.min(80,t.l+40)},{name:"overlay1",l:Math.min(75,t.l+50)},{name:"text",l:Math.min(95,t.l+60)}].forEach(n=>{let r=this.utils.hslToRgb(t.h,Math.max(0,t.s-20),n.l);r&&(e[n.name]=this.utils.rgbToHex(r.r,r.g,r.b))}),e}detectTemperature(t,e){let i=(t.h+e.h)/2;return i>=0&&i<=60||i>=300&&i<=360?"warm":i>=120&&i<=240?"cool":"neutral"}applyGenreColorModification(t,e,i){let n=this.utils.hexToRgb(t);if(!n)return t;let r=this.utils.rgbToHsl(n.r,n.g,n.b),a=(r.h+e+360)%360,s=Math.max(0,Math.min(100,r.s*i)),o=this.utils.hslToRgb(a,s,r.l);return o?this.utils.rgbToHex(o.r,o.g,o.b):t}isValidHexColor(t){return/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(t)}getGenreHints(t){return ei[t]||ei.default}clearCache(){this.paletteCache={},this.config.enableDebug&&console.log("[PaletteExtensionManager] Palette cache cleared")}}});var yt,ce,ii,Ma=y(()=>{"use strict";D();yt=new Set(["--sn-beat-pulse-intensity","--sn-breathing-scale","--sn-accent-hex","--sn-accent-rgb","--sn.music.beat.pulse.intensity","--sn.music.breathing.scale","--sn.music.rhythm.phase","--sn.music.spectrum.phase","--sn.color.accent.hex","--sn.color.accent.rgb","--sn.bg.webgl.ready","--sn.bg.active-backend"]),ce=class ce{constructor(t,e){this.initialized=!1;this.cssVariableQueue=new Map;this.batchUpdateTimer=null;this.rafHandle=null;this.microtaskScheduled=!1;this.pendingTransactions=new Map;this.transactionCounter=0;this.updateQueue=new Map;this.flushTimer=null;this.currentDeviceCapabilities=null;this.currentPerformanceMode=null;this.lastCSSUpdate=0;this.cssUpdateThrottle=100;this.appliedClasses=new Set;this.consciousnessState=null;this.consciousnessUpdateTimer=null;this.lastConsciousnessUpdate=0;this.performanceMetrics={totalBatches:0,totalUpdates:0,totalBatchTime:0,maxBatchTime:0,averageBatchSize:0,overBudgetBatches:0,conflictResolutions:0,transactionCount:0,consciousnessUpdates:0};this.PRIORITY_WEIGHTS={low:1,normal:2,high:3,critical:4};this.config=t,this.performanceCoordinator=e,this.eventBus=g,this.cssConfig={batchIntervalMs:0,maxBatchSize:50,enableDebug:t.enableDebug,useCssTextFastPath:!1,autoHijack:!0,enableAdaptiveOptimization:!0,enableThermalThrottling:!0,enableBatteryOptimization:!0,enableDeviceTierOptimization:!0,debugPerformanceClasses:t.enableDebug,enableConsciousnessIntegration:!0,consciousnessUpdateInterval:16,enableMusicConsciousness:!0,enableAestheticConsciousness:!0},this.currentDeviceCapabilities=this.performanceCoordinator.getDeviceCapabilities(),this.currentPerformanceMode=this.performanceCoordinator.getCurrentPerformanceMode(),this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Created with consciousness-driven CSS management")}async initialize(){this.initialized||(this.subscribeToEvents(),this.applyInitialOptimizations(),this.cssConfig.enableConsciousnessIntegration&&this.startConsciousnessIntegration(),this.cssConfig.autoHijack&&this.enableGlobalHijack(),this.initialized=!0,this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Initialized with device tier:",this.currentDeviceCapabilities?.performanceTier))}updateAnimation(t){}async healthCheck(){let t=this.cssVariableQueue.size+this.updateQueue.size,e=this.pendingTransactions.size,i=t<=1e3&&e<=100;return{system:"UnifiedCSSVariableManager",healthy:i,ok:i,details:i?"CSS consciousness controller operating normally":"High queue size or pending transactions",metrics:{queueSize:t,pendingTransactions:e,performanceMetrics:this.performanceMetrics,consciousnessActive:this.consciousnessState!==null,deviceTier:this.currentDeviceCapabilities?.performanceTier,performanceMode:this.currentPerformanceMode?.name}}}destroy(){this.consciousnessUpdateTimer&&(clearTimeout(this.consciousnessUpdateTimer),this.consciousnessUpdateTimer=null),this.flushTimer&&(clearTimeout(this.flushTimer),this.flushTimer=null),this.rafHandle!==null&&(cancelAnimationFrame(this.rafHandle),this.rafHandle=null),this.flushCSSVariableBatch();for(let t of this.appliedClasses)document.body.classList.remove(t);this.appliedClasses.clear(),this.cssVariableQueue.clear(),this.updateQueue.clear(),this.pendingTransactions.clear(),this.initialized=!1,this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Destroyed")}forceRepaint(t){this.flushCSSVariableBatch(),this.config.enableDebug&&t&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Force repaint: ${t}`)}queueCSSVariableUpdate(t,e,i=null,n="normal",r="unknown"){if(yt.has(t)){let d=(i||document.documentElement).style;ce.nativeSetProperty?ce.nativeSetProperty.call(d,t,e):d.setProperty(t,e);return}let a=i||document.documentElement,o=`${i?`element_${i.id||i.className||"unnamed"}`:"root"}:${t}`,l={element:a,property:t,value:e,timestamp:performance.now(),priority:n,source:r},m=this.cssVariableQueue.get(o);m?this.shouldReplaceUpdate(m,l)&&(this.cssVariableQueue.set(o,l),this.performanceMetrics.conflictResolutions++):this.cssVariableQueue.set(o,l),this.performanceMetrics.totalUpdates++,this.scheduleFlush(n),(n==="critical"||this.cssVariableQueue.size>=this.cssConfig.maxBatchSize)&&this.flushCSSVariableBatch()}updateVariables(t,e="normal",i="unknown"){let n=`tx_${++this.transactionCounter}`,r=new Map(Object.entries(t)),a={id:n,variables:r,timestamp:performance.now(),priority:e,completed:!1};this.pendingTransactions.set(n,a);for(let[s,o]of r)this.queueCSSVariableUpdate(s,o,null,e,`${i}:${n}`);this.performanceMetrics.transactionCount++,this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Transaction ${n} queued with ${r.size} variables`)}updateConsciousnessVariables(t){if(!this.cssConfig.enableConsciousnessIntegration)return;this.consciousnessState=t,this.performanceMetrics.consciousnessUpdates++;let e={};t.musicState&&this.cssConfig.enableMusicConsciousness&&(e["--sn.music.beat.pulse.intensity"]=t.musicState.intensity.toString(),e["--sn.music.tempo.bpm"]=t.musicState.bpm.toString(),e["--sn.music.rhythm.phase"]=`${t.musicState.rhythmPhase}deg`,e["--sn.music.breathing.scale"]=t.musicState.breathingScale.toString(),e["--sn.music.energy.level"]=t.musicState.energy.toString(),e["--sn.music.valence"]=t.musicState.valence.toString()),t.aestheticState&&this.cssConfig.enableAestheticConsciousness&&(e["--sn.aesthetic.harmony.level"]=t.aestheticState.harmonyLevel.toString(),e["--sn.aesthetic.evolution.factor"]=t.aestheticState.evolutionFactor.toString(),e["--sn.color.temperature"]=t.aestheticState.colorTemperature.toString()),t.performanceState&&(e["--sn.performance.mode"]=t.performanceState.mode,e["--sn.device.tier"]=t.performanceState.deviceTier,e["--sn.performance.optimization.level"]=t.performanceState.optimizationLevel.toString()),this.updateVariables(e,"high","consciousness-system"),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Consciousness state updated with ${Object.keys(e).length} variables`)}applyPerformanceOptimizations(t){if(!this.cssConfig.enableAdaptiveOptimization)return;this.currentPerformanceMode=t;let e={"--sn.performance.mode":t.name,"--sn.performance.quality.level":t.qualityLevel.toString(),"--sn.performance.fps.target":t.frameRate.toString(),"--sn.performance.frame.budget":(1e3/t.frameRate).toString(),"--sn.performance.optimization.level":t.optimizationLevel.toString(),"--sn.performance.blur.quality":t.blurQuality.toString(),"--sn.performance.shadow.quality":t.shadowQuality.toString(),"--sn.performance.animation.quality":t.animationQuality.toString(),"--sn.performance.effect.quality":t.effectQuality.toString()};this.updateVariables(e,"high","performance-coordinator"),this.applyPerformanceModeOptimizations(),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Performance optimizations applied for mode: ${t.name}`)}getVariable(t){return getComputedStyle(document.documentElement).getPropertyValue(t).trim()||null}flushUpdates(){this.flushCSSVariableBatch()}flushCSSVariableBatch(){if(this.cssVariableQueue.size===0)return;let t=performance.now(),e=8,i=Array.from(this.cssVariableQueue.values());this.cssVariableQueue.clear(),this.rafHandle!==null&&(cancelAnimationFrame(this.rafHandle),this.rafHandle=null),this.microtaskScheduled=!1;try{let n=new Map;for(let a of i)n.has(a.element)||n.set(a.element,[]),n.get(a.element).push(a);for(let[a,s]of n.entries()){if(performance.now()-t>e){for(let o of s){let l=`${o.element.id||"root"}:${o.property}`;this.cssVariableQueue.set(l,o)}this.scheduleFlush("high");break}if(s.length>=3)this.applyCSSTextBatch(a,s);else for(let o of s)ce.nativeSetProperty?ce.nativeSetProperty.call(a.style,o.property,o.value):a.style.setProperty(o.property,o.value)}let r=performance.now()-t;this.updatePerformanceMetrics(r,i.length),r>e&&this.config.enableDebug?console.warn(`\u{1F30C} [UnifiedCSSVariableManager] CSS batch exceeded frame budget: ${r.toFixed(2)}ms (${i.length} updates)`):this.config.enableDebug&&Math.random()<.05&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Efficient CSS batch: ${i.length} updates in ${r.toFixed(2)}ms`)}catch(n){console.error("[UnifiedCSSVariableManager] Error in optimized CSS batch processing:",n),this.applyUpdatesWithFallback(i)}}applyCSSTextBatch(t,e){try{let i=t.style.cssText,n=new Map;if(i){let a=i.split(";");for(let s of a){let o=s.indexOf(":");if(o>0){let l=s.slice(0,o).trim(),m=s.slice(o+1).trim();l&&m&&n.set(l,m)}}}for(let a of e)n.set(a.property,a.value);let r=[];for(let[a,s]of n)r.push(`${a}:${s}`);t.style.cssText=r.join(";")}catch{for(let n of e)try{t.style.setProperty(n.property,n.value)}catch(r){console.warn(`Failed to apply ${n.property}:`,r)}}}applyUpdatesWithFallback(t){for(let e of t)try{ce.nativeSetProperty?ce.nativeSetProperty.call(e.element.style,e.property,e.value):e.element.style.setProperty(e.property,e.value)}catch(i){console.warn(`[UnifiedCSSVariableManager] Failed to apply CSS property ${e.property}:`,i)}}setMusicMetrics(t){let e={};t.beatIntensity!==void 0&&(e["--sn.music.beat.pulse.intensity"]=t.beatIntensity.toString()),t.rhythmPhase!==void 0&&(e["--sn.music.rhythm.phase"]=`${t.rhythmPhase}deg`),t.breathingScale!==void 0&&(e["--sn.music.breathing.scale"]=t.breathingScale.toString()),t.spectrumPhase!==void 0&&(e["--sn.music.spectrum.phase"]=`${t.spectrumPhase}deg`),t.energy!==void 0&&(e["--sn.music.energy.level"]=t.energy.toString()),t.valence!==void 0&&(e["--sn.music.valence"]=t.valence.toString()),t.bpm!==void 0&&(e["--sn.music.tempo.bpm"]=t.bpm.toString()),this.updateVariables(e,"critical","music-system")}setColorTokens(t){let e={};t.accentHex&&(e["--sn.color.accent.hex"]=t.accentHex),t.accentRgb&&(e["--sn.color.accent.rgb"]=t.accentRgb),t.primaryRgb&&(e["--sn.bg.gradient.primary.rgb"]=t.primaryRgb),t.secondaryRgb&&(e["--sn.bg.gradient.secondary.rgb"]=t.secondaryRgb),t.gradientOpacity!==void 0&&(e["--sn.bg.gradient.opacity"]=t.gradientOpacity.toString()),t.gradientBlur&&(e["--sn.bg.gradient.blur"]=t.gradientBlur),this.updateVariables(e,"high","color-system")}setPerformanceTokens(t){let e={};t.webglReady!==void 0&&(e["--sn.bg.webgl.ready"]=t.webglReady?"1":"0"),t.activeBackend&&(e["--sn.bg.active-backend"]=t.activeBackend),t.qualityLevel&&(e["--sn.perf.quality.level"]=t.qualityLevel),t.reducedMotion!==void 0&&(e["--sn.anim.motion.reduced"]=t.reducedMotion?"1":"0"),t.gpuAcceleration!==void 0&&(e["--sn.perf.gpu.acceleration.enabled"]=t.gpuAcceleration?"1":"0"),this.updateVariables(e,"high","performance-system")}setProperty(t,e,i=null){if(t.startsWith("--spice-")&&this.config.enableSpiceVariableDebug){let n=new Error().stack?.split(`
`)[2]?.trim().replace(/^\s*at\s+/,"")||"unknown";console.log(`\u{1F527} [CSS Debug] Setting ${t} = ${e} (from: ${n})`)}this.queueCSSVariableUpdate(t,e,i)}applyDeviceOptimizations(){if(!this.cssConfig.enableDeviceTierOptimization||!this.currentDeviceCapabilities)return;this.removeClassesByPrefix("device-tier-"),this.removeClassesByPrefix("device-mobile-"),this.removeClassesByPrefix("device-gpu-");let t=`device-tier-${this.currentDeviceCapabilities.performanceTier}`;this.addCSSClass(t),this.currentDeviceCapabilities.isMobile&&this.addCSSClass("device-mobile-optimized"),this.currentDeviceCapabilities.gpuAcceleration?this.addCSSClass("device-gpu-accelerated"):this.addCSSClass("device-gpu-fallback");let e=this.getMemoryTier(this.currentDeviceCapabilities.memoryGB);this.addCSSClass(`device-memory-${e}`)}applyPerformanceModeOptimizations(){if(!this.currentPerformanceMode)return;this.removeClassesByPrefix("performance-mode-");let t=`performance-mode-${this.currentPerformanceMode.name}`;this.addCSSClass(t);let e=`optimization-level-${this.currentPerformanceMode.optimizationLevel}`;this.addCSSClass(e)}getPerformanceReport(){let t=this.performanceMetrics.totalBatches>0?this.performanceMetrics.totalBatchTime/this.performanceMetrics.totalBatches:0;return{enabled:!0,pendingUpdates:this.cssVariableQueue.size+this.updateQueue.size,totalUpdates:this.performanceMetrics.totalUpdates,totalBatches:this.performanceMetrics.totalBatches,averageBatchSize:Math.round(this.performanceMetrics.averageBatchSize*10)/10,averageBatchTime:Math.round(t*100)/100,maxBatchTime:Math.round(this.performanceMetrics.maxBatchTime*100)/100,overBudgetBatches:this.performanceMetrics.overBudgetBatches,conflictResolutions:this.performanceMetrics.conflictResolutions,transactionCount:this.performanceMetrics.transactionCount,consciousnessUpdates:this.performanceMetrics.consciousnessUpdates,consciousnessActive:this.consciousnessState!==null,deviceTier:this.currentDeviceCapabilities?.performanceTier,performanceMode:this.currentPerformanceMode?.name}}subscribeToEvents(){this.eventBus.subscribe("performance:tier-changed",t=>{this.currentPerformanceMode=this.performanceCoordinator.getCurrentPerformanceMode(),this.applyPerformanceModeOptimizations(),this.updateCSSPerformanceVariables()},"UnifiedCSSVariableManager"),this.eventBus.subscribe("performance:frame",t=>{t.temperature&&t.temperature>80&&this.applyThermalOptimizations(t.temperature)},"UnifiedCSSVariableManager")}applyInitialOptimizations(){try{this.applyDeviceOptimizations(),this.applyPerformanceModeOptimizations(),this.updateCSSPerformanceVariables(),this.cssConfig.debugPerformanceClasses&&this.addCSSClass("debug-performance")}catch(t){this.config.enableDebug&&console.warn("[UnifiedCSSVariableManager] Error applying initial optimizations:",t)}}applyCurrentOptimizations(){this.applyDeviceOptimizations(),this.applyPerformanceModeOptimizations();let t=this.performanceCoordinator.getBatteryState(),e=this.performanceCoordinator.getThermalState();t&&this.applyBatteryOptimizations(t.level,t.charging);let i=e.temperature||"normal";this.applyThermalOptimizations(i)}updateCSSPerformanceVariables(){let t=Date.now();if(!(t-this.lastCSSUpdate<this.cssUpdateThrottle)&&(this.lastCSSUpdate=t,!(!this.currentPerformanceMode||!this.currentDeviceCapabilities)))try{let e={"--sn.performance.mode":this.currentPerformanceMode.name||"balanced","--sn.performance.quality.level":(this.currentPerformanceMode.qualityLevel??.8).toString(),"--sn.performance.fps.target":(this.currentPerformanceMode.frameRate??60).toString(),"--sn.performance.frame.budget":(1e3/(this.currentPerformanceMode.frameRate??60)).toString(),"--sn.performance.optimization.level":(this.currentPerformanceMode.optimizationLevel??1).toString(),"--sn.device.tier":this.currentDeviceCapabilities.performanceTier??"mid","--sn.device.memory":(this.currentDeviceCapabilities.memoryGB??8).toString(),"--sn.device.gpu":this.currentDeviceCapabilities.gpuAcceleration??!0?"1":"0","--sn.device.mobile":this.currentDeviceCapabilities.isMobile??!1?"1":"0","--sn.performance.blur.quality":(this.currentPerformanceMode.blurQuality??.8).toString(),"--sn.performance.shadow.quality":(this.currentPerformanceMode.shadowQuality??.8).toString(),"--sn.performance.animation.quality":(this.currentPerformanceMode.animationQuality??.8).toString(),"--sn.performance.effect.quality":(this.currentPerformanceMode.effectQuality??.8).toString()};this.updateVariables(e,"high","performance-coordinator")}catch(e){this.config.enableDebug&&console.warn("[UnifiedCSSVariableManager] Error updating CSS performance variables:",e)}}startConsciousnessIntegration(){if(this.consciousnessUpdateTimer)return;let t=()=>{let e=performance.now();e-this.lastConsciousnessUpdate>=this.cssConfig.consciousnessUpdateInterval&&(this.lastConsciousnessUpdate=e,this.consciousnessState&&this.updateConsciousnessVariables(this.consciousnessState)),this.consciousnessUpdateTimer=setTimeout(t,this.cssConfig.consciousnessUpdateInterval)};t()}shouldReplaceUpdate(t,e){let i=this.PRIORITY_WEIGHTS[t.priority],n=this.PRIORITY_WEIGHTS[e.priority];return n>i?!0:n===i?e.timestamp>t.timestamp:!1}scheduleFlush(t){if(this.rafHandle!==null||this.microtaskScheduled)return;let e=()=>{this.rafHandle=null,this.microtaskScheduled=!1,this.flushCSSVariableBatch()};typeof document<"u"&&document.visibilityState==="hidden"?(this.microtaskScheduled=!0,queueMicrotask(e)):typeof requestAnimationFrame=="function"?this.rafHandle=requestAnimationFrame(e):setTimeout(e,0)}updatePerformanceMetrics(t,e){this.performanceMetrics.totalBatches++,this.performanceMetrics.totalBatchTime+=t,this.performanceMetrics.maxBatchTime=Math.max(this.performanceMetrics.maxBatchTime,t),this.performanceMetrics.averageBatchSize=(this.performanceMetrics.averageBatchSize*(this.performanceMetrics.totalBatches-1)+e)/this.performanceMetrics.totalBatches,t>8&&(this.performanceMetrics.overBudgetBatches++,this.config.enableDebug&&console.warn(`[UnifiedCSSVariableManager] CSS batch took ${t.toFixed(2)}ms for ${e} updates`))}enableGlobalHijack(){if(ce.hijackEnabled)return;let t=CSSStyleDeclaration.prototype.setProperty;ce.nativeSetProperty=t;let e=this;CSSStyleDeclaration.prototype.setProperty=function(i,n,r){i&&(i.startsWith("--sn-")||i.startsWith("--sn."))&&e?e.queueCSSVariableUpdate(i,String(n??"")):t.call(this,i,n,r)},ce.hijackEnabled=!0,this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Global setProperty hijack enabled (--sn- and --sn. namespaces)")}addCSSClass(t){this.appliedClasses.has(t)||(document.body.classList.add(t),this.appliedClasses.add(t))}removeCSSClass(t){this.appliedClasses.has(t)&&(document.body.classList.remove(t),this.appliedClasses.delete(t))}removeClassesByPrefix(t){let e=Array.from(this.appliedClasses).filter(i=>i.startsWith(t));for(let i of e)this.removeCSSClass(i)}getMemoryTier(t){return t>=16?"high":t>=8?"medium":t>=4?"low":"minimal"}applyThermalOptimizations(t){if(!this.cssConfig.enableThermalThrottling)return;this.removeClassesByPrefix("thermal-");let e=`thermal-${t}`;this.addCSSClass(e)}applyBatteryOptimizations(t,e){this.cssConfig.enableBatteryOptimization&&(this.removeClassesByPrefix("battery-"),t<.2?this.addCSSClass("battery-low"):t<.5?this.addCSSClass("battery-medium"):this.addCSSClass("battery-high"),e&&this.addCSSClass("battery-charging"))}updateMusicVariables(t){let e={};for(let[i,n]of Object.entries(t))if(n!==void 0){let r=`--sn-music-${i.replace(/\./g,"-")}`;e[r]=String(n)}this.updateVariables(e,"critical","music-system")}updateColorVariables(t){let e={};for(let[i,n]of Object.entries(t))if(n!==void 0){let r=`--sn-color-${i.replace(/\./g,"-")}`;e[r]=String(n)}this.updateVariables(e,"high","color-system")}updateAnimationVariables(t){let e={};for(let[i,n]of Object.entries(t))if(n!==void 0){let r=`--sn-anim-${i.replace(/\./g,"-")}`;e[r]=typeof n=="boolean"?n?"1":"0":String(n)}this.updateVariables(e,"normal","animation-system")}updatePerformanceVariables(t){let e={};for(let[i,n]of Object.entries(t))if(n!==void 0){let r=`--sn-performance-${i.replace(/\./g,"-")}`;e[r]=typeof n=="boolean"?n?"1":"0":String(n)}this.updateVariables(e,"high","performance-system")}updateUtilityVariables(t){let e={};for(let[i,n]of Object.entries(t))if(n!==void 0){let r=`--sn-${i.replace(/\./g,"-")}`;e[r]=typeof n=="boolean"?n?"1":"0":String(n)}this.updateVariables(e,"low","utility-system")}queueUpdate(t,e,i="normal",n="unknown"){this.queueCSSVariableUpdate(t,e,null,i,n)}queueTransaction(t,e="normal",i="unknown"){let n=`tx_${++this.transactionCounter}`,r=new Map(Object.entries(t)),a={id:n,variables:r,timestamp:performance.now(),priority:e,completed:!1};this.pendingTransactions.set(n,a);for(let[s,o]of r)this.queueUpdate(s,o,e,`${i}:${n}`);return this.performanceMetrics.transactionCount++,this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Transaction ${n} queued with ${r.size} variables`),n}forceFlush(){this.flushCSSVariableBatch()}registerVariableGroup(t,e="normal",i=50,n=16){this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Variable group registration: ${t} (handled internally)`)}updateVariableGroup(t,e,i="unknown"){this.updateVariables(e,"normal",`group:${t}:${i}`)}updateConfig(t){this.cssConfig={...this.cssConfig,...t},this.config.enableDebug&&console.log("\u{1F30C} [UnifiedCSSVariableManager] Configuration updated:",t)}flushNow(){this.flushCSSVariableBatch()}setBatchingEnabled(t){this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Batching ${t?"enabled":"disabled"}`)}addCriticalVariable(t){yt.add(t),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Added critical variable: ${t}`)}removeCriticalVariable(t){yt.delete(t),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Removed critical variable: ${t}`)}isCriticalVariable(t){return yt.has(t)}getCriticalVariables(){return Array.from(yt)}updateConsciousnessIntensity(t,e,i){let n=Math.max(0,Math.min(1,t));this.queueCSSVariableUpdate("--consciousness-intensity",n.toString(),null,"high",`consciousness-${e}`),this.eventBus&&this.eventBus.emitSync("consciousness:intensity-changed",{intensity:n,userEngagement:.5,timestamp:Date.now(),sourceStrategy:e,musicEnergy:i??0}),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Consciousness intensity updated by ${e}: ${n}`)}updateCrossfadeOpacity(t,e,i){let n=Math.max(0,Math.min(1,t));i||(n=0),this.queueCSSVariableUpdate("--sn-gradient-crossfade-opacity",n.toString(),null,"high",`crossfade-${e}`),this.eventBus&&this.eventBus.emitSync("gradient:crossfade-changed",{opacity:n,sourceStrategy:e,webglEnabled:i,timestamp:Date.now()}),this.config.enableDebug&&console.log(`\u{1F30C} [UnifiedCSSVariableManager] Crossfade opacity updated by ${e}: ${n} (WebGL: ${i})`)}subscribeToConsciousnessChanges(t){if(!this.eventBus)return console.warn("[UnifiedCSSVariableManager] No UnifiedEventBus available for consciousness subscriptions"),()=>{};let e=this.eventBus.subscribe("consciousness:intensity-changed",t,"UnifiedCSSVariableManager");return()=>this.eventBus?.unsubscribe(e)}subscribeToCrossfadeChanges(t){if(!this.eventBus)return console.warn("[UnifiedCSSVariableManager] No UnifiedEventBus available for crossfade subscriptions"),()=>{};let e=this.eventBus.subscribe("gradient:crossfade-changed",t,"UnifiedCSSVariableManager");return()=>this.eventBus?.unsubscribe(e)}};ce.hijackEnabled=!1;ii=ce});function xn(c){Tn=c}function T(){if(!Tn)throw console.warn("[OptimizedCSSVariableManager] Global instance not initialized yet. This may indicate an initialization order issue."),new Error("Global OptimizedCSSVariableManager not initialized. Call setGlobalOptimizedCSSController() first.");return Tn}var Re,Tn,N=y(()=>{"use strict";Ma();Re=class extends ii{constructor(e,i,n={}){super(e,i);this.lastFPSCheck=0;this.currentPerformanceLevel="good";this.adaptiveThrottleLevel=1;this.priorityQueues=new Map;this.optimizedConfig={batchIntervalMs:16,maxBatchSize:50,enableDebug:e.enableDebug,enableAdaptiveThrottling:!0,priorityMappings:{critical:["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift"],high:["--sn-gradient-primary","--sn-gradient-secondary","--sn-gradient-accent"],normal:["--sn-gradient-","--sn-rs-"],low:["--sn-debug-","--sn-dev-"]},thresholds:{excellentFPS:55,goodFPS:45,poorFPS:30},...n},n.performanceAnalyzer&&(this.performanceAnalyzer=n.performanceAnalyzer),n.budgetManager&&(this.budgetManager=n.budgetManager),this.initializePriorityQueues(),this.optimizedConfig.enableAdaptiveThrottling&&this.startAdaptiveMonitoring()}initializePriorityQueues(){this.priorityQueues.set("critical",new Map),this.priorityQueues.set("high",new Map),this.priorityQueues.set("normal",new Map),this.priorityQueues.set("low",new Map)}startAdaptiveMonitoring(){setInterval(()=>{this.updatePerformanceLevel(),this.adjustBatchingStrategy()},1e3)}updatePerformanceLevel(){if(!this.performanceAnalyzer)return;let e=this.performanceAnalyzer.getMedianFPS(),{excellentFPS:i,goodFPS:n,poorFPS:r}=this.optimizedConfig.thresholds,a=this.currentPerformanceLevel;e>=i?this.currentPerformanceLevel="excellent":e>=n?this.currentPerformanceLevel="good":e<r&&(this.currentPerformanceLevel="poor"),a!==this.currentPerformanceLevel&&this.optimizedConfig.enableDebug&&console.log(`\u{1F3A8} [OptimizedCSSVariableManager] Performance level changed: ${a} \u2192 ${this.currentPerformanceLevel} (${e} FPS)`)}adjustBatchingStrategy(){let e,i;switch(this.currentPerformanceLevel){case"excellent":e=Math.max(8,this.optimizedConfig.batchIntervalMs/2),i=Math.min(100,this.optimizedConfig.maxBatchSize*2),this.adaptiveThrottleLevel=.5;break;case"good":e=this.optimizedConfig.batchIntervalMs,i=this.optimizedConfig.maxBatchSize,this.adaptiveThrottleLevel=1;break;case"poor":e=this.optimizedConfig.batchIntervalMs*2,i=Math.max(10,this.optimizedConfig.maxBatchSize/2),this.adaptiveThrottleLevel=2;break}this.updateConfig({batchIntervalMs:e,maxBatchSize:i})}queueCSSVariableUpdate(e,i,n=null,r="normal",a="unknown"){let s=n||document.documentElement,o=r||this.determineVariablePriority(e);if(o==="critical"){this.applyCriticalUpdate(e,i,s);return}let l=this.priorityQueues.get(o);if(l){let m=`${e}:${s.tagName||"ROOT"}`;l.set(m,{property:e,value:i,timestamp:performance.now()})}this.scheduleOptimizedFlush(o)}determineVariablePriority(e){let{priorityMappings:i}=this.optimizedConfig;for(let[n,r]of Object.entries(i))if(r.includes(e))return n;for(let[n,r]of Object.entries(i))for(let a of r)if(e.startsWith(a))return n;return"normal"}applyCriticalUpdate(e,i,n){try{n.style.setProperty(e,i)}catch(r){console.error(`\u{1F3A8} [OptimizedCSSVariableManager] Critical update failed for ${e}:`,r)}}scheduleOptimizedFlush(e){let i=this.getFlushDelay(e);setTimeout(()=>{this.flushPriorityQueue(e)},i)}getFlushDelay(e){let i=this.optimizedConfig.batchIntervalMs,n=this.adaptiveThrottleLevel;switch(e){case"critical":return 0;case"high":return Math.max(4,i*.5*n);case"normal":return i*n;case"low":return i*2*n;default:return i*n}}flushPriorityQueue(e){let i=this.priorityQueues.get(e);if(!i||i.size===0)return;let n=Array.from(i.values());i.clear();for(let r of n)super.queueCSSVariableUpdate(r.property,r.value,null,"normal",r.timestamp.toString())}getOptimizationMetrics(){let e={};for(let[n,r]of this.priorityQueues)e[n]=r.size;let i={performanceLevel:this.currentPerformanceLevel,adaptiveThrottleLevel:this.adaptiveThrottleLevel,queueSizes:e};return i.budgetViolations=[],i}flushAllQueues(){for(let e of["critical","high","normal","low"])this.flushPriorityQueue(e);this.flushUpdates()}updatePriorityMappings(e){this.optimizedConfig.priorityMappings={...this.optimizedConfig.priorityMappings,...e}}async batchSetVariables(e,i,n="normal",r="unknown"){this.updateVariables(i,n,`${e}:${r}`)}async setVariable(e,i,n,r="normal",a="unknown"){this.updateVariables({[i]:n},r,`${e}:${a}`)}applyDirect(e){let i=document.documentElement;for(let[n,r]of Object.entries(e))i.style.setProperty(n,r)}static getGlobalInstance(){return T()}destroy(){for(let e of this.priorityQueues.values())e.clear();this.priorityQueues.clear(),super.destroy()}},Tn=null});var De,at,An=y(()=>{"use strict";N();D();K();De=class De{constructor(t={}){this.colorCache=new Map;this.lastCacheUpdate=0;this.initialized=!1;this.eventSubscriptionIds=[];this.lastColorUpdate=0;this.colorUpdateCount=0;this.config={enableDebug:!1,fallbackToSpiceColors:!0,cacheDuration:5e3,...t}}async initialize(t){if(this.initialized){console.warn("[SemanticColorManager] Already initialized, skipping");return}try{this.cssController=t||T(),this.setupEventSubscriptions(),this.initialized=!0,this.lastColorUpdate=Date.now(),this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Initialized as IManagedSystem with",{mappings:De.SEMANTIC_MAPPINGS.length,batcherAvailable:!!this.cssController,spicetifyAvailable:this.isSpicetifyAvailable(),eventSubscriptions:this.eventSubscriptionIds.length}),g.emitSync("system:initialized",{systemName:"SemanticColorManager",timestamp:Date.now(),metadata:{mappings:De.SEMANTIC_MAPPINGS.length,spicetifyAvailable:this.isSpicetifyAvailable()}})}catch(e){throw console.error("[SemanticColorManager] Initialization failed:",e),g.emitSync("system:error",{systemName:"SemanticColorManager",error:e instanceof Error?e.message:"Initialization failed",severity:"critical",timestamp:Date.now()}),e}}async updateSemanticColors(){if(!this.initialized){console.warn("[SemanticColorManager] Not initialized, cannot update colors");return}let t=Date.now();if(!(t-this.lastCacheUpdate<(this.config.cacheDuration||5e3))){console.log("\u{1F3A8} [SemanticColorManager] Starting semantic color update...");try{let e={},i={},n={};for(let r of De.SEMANTIC_MAPPINGS){let a=await this.getSemanticColor(r.semanticColor);e[r.cssVariable]={semanticColor:r.semanticColor,retrievedColor:a,fallbackColor:r.fallbackColor,description:r.description},i[r.cssVariable]=a;let s=oe(a);if(s){let o=r.cssVariable.replace("--spice-","--spice-rgb-");n[o]=`${s.r},${s.g},${s.b}`,e[o]=`${s.r},${s.g},${s.b}`}}this.cssController.batchSetVariables("SemanticColorManager",i,"high","semantic-color-update"),this.cssController.batchSetVariables("SemanticColorManager",n,"high","semantic-rgb-update"),console.log("\u{1F3A8} [SemanticColorManager] Color update complete:",e),this.lastCacheUpdate=t,this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Updated all semantic colors")}catch(e){console.error("[SemanticColorManager] Failed to update semantic colors:",e)}}}async getSemanticColor(t){let e=this.colorCache.get(t);if(e&&Date.now()-this.lastCacheUpdate<(this.config.cacheDuration||5e3))return e;let i;try{this.isSpicetifyAvailable()&&Spicetify.Platform?.getSemanticColors?(i=(await Spicetify.Platform.getSemanticColors())[t],console.log(`\u{1F3A8} [SemanticColorManager] Spicetify returned for ${t}:`,{rawValue:i,type:typeof i,isWhite:i==="#ffffff"||i==="#fff"||i==="white",isInvalid:!i||i==="undefined"||i==="null"})):(console.warn(`\u{1F3A8} [SemanticColorManager] Spicetify not available, using fallback for ${t}`),i=this.getFallbackColor(t))}catch(n){this.config.enableDebug&&console.warn(`[SemanticColorManager] Failed to get semantic color ${t}:`,n),i=this.getFallbackColor(t)}return i=this.validateColor(i,t),this.colorCache.set(t,i),i}validateColor(t,e){let i=t?.toLowerCase().trim();if(!i||["#ffffff","#fff","white","#000000","#000","black","","undefined","null","transparent"].includes(i)){let r=this.getFallbackColor(e);return this.config.enableDebug&&console.warn(`\u{1F527} [SemanticColorManager] Invalid color "${t}" for ${e}, using fallback: ${r}`),r}if(!i.match(/^#[0-9a-f]{6}$/i)&&!i.match(/^#[0-9a-f]{3}$/i)){let r=this.getFallbackColor(e);return this.config.enableDebug&&console.warn(`\u{1F527} [SemanticColorManager] Malformed color "${t}" for ${e}, using fallback: ${r}`),r}return t}getFallbackColor(t){let e=De.SEMANTIC_MAPPINGS.find(i=>i.semanticColor===t);return e?e.fallbackColor:t.startsWith("text")?"#cad3f5":t.startsWith("background")?"#24273a":t.startsWith("essential")?"#c6a0f6":t.startsWith("decorative")?"#939ab7":"#cad3f5"}applyColorToCSS(t,e,i="normal",n="semantic-color-manager"){this.cssController.setVariable("SemanticColorManager",t,e,i,n)}isSpicetifyAvailable(){return typeof Spicetify<"u"&&Spicetify.Platform&&typeof Spicetify.Platform.getSemanticColors=="function"}flushUpdates(){this.cssController&&this.cssController.flushUpdates()}clearCache(){this.colorCache.clear(),this.lastCacheUpdate=0}updateWithAlbumColors(t){if(!this.initialized){console.warn("[SemanticColorManager] Not initialized, cannot update with album colors");return}try{let e=t.OKLAB_PRIMARY||t.VIBRANT||t.PRIMARY,i=t.OKLAB_ACCENT||t.LIGHT_VIBRANT||t.SECONDARY,n=t.OKLAB_SHADOW||t.DARK_VIBRANT||t.DARK,r=t.OKLAB_HIGHLIGHT||t.VIBRANT_NON_ALARMING||t.LIGHT;if(!e){console.warn("[SemanticColorManager] No primary color found in OKLAB result, skipping update");return}let a=this.generateIntelligentColorDistribution(e,i,n,r),s=this.convertColorsToRgb(a),o={"--spice-accent":a.primary,"--spice-rgb-accent":s.primary,"--spice-surface1":a.surface1,"--spice-rgb-surface1":s.surface1,"--spice-button-active":a.primary,"--spice-rgb-button-active":s.primary,"--spice-highlight":a.highlight,"--spice-rgb-highlight":s.highlight,"--spice-press":a.shadow,"--spice-rgb-press":s.shadow},l={"--spice-surface0":a.surface0,"--spice-rgb-surface0":s.surface0,"--spice-surface2":a.surface2,"--spice-rgb-surface2":s.surface2,"--spice-base":a.base,"--spice-rgb-base":s.base},m={"--spice-main":a.base,"--spice-rgb-main":s.base,"--spice-main-elevated":a.surface0,"--spice-rgb-main-elevated":s.surface0,"--spice-sidebar":a.surface1,"--spice-rgb-sidebar":s.surface1,"--spice-text":this.generateTextColor(a.base),"--spice-rgb-text":this.hexToRgb(this.generateTextColor(a.base)),"--spice-subtext":this.generateSubtextColor(a.base),"--spice-rgb-subtext":this.hexToRgb(this.generateSubtextColor(a.base)),"--spice-highlight-elevated":a.surface2,"--spice-rgb-highlight-elevated":s.surface2,"--spice-overlay0":this.generateOverlayColor(a.base,.04),"--spice-rgb-overlay0":this.hexToRgb(this.generateOverlayColor(a.base,.04)),"--spice-overlay1":this.generateOverlayColor(a.base,.08),"--spice-rgb-overlay1":this.hexToRgb(this.generateOverlayColor(a.base,.08)),"--spice-overlay2":this.generateOverlayColor(a.base,.12),"--spice-rgb-overlay2":this.hexToRgb(this.generateOverlayColor(a.base,.12)),"--spice-crust":this.generateCrustColor(a.base),"--spice-rgb-crust":this.hexToRgb(this.generateCrustColor(a.base)),"--spice-mantle":this.generateMantleColor(a.base),"--spice-rgb-mantle":this.hexToRgb(this.generateMantleColor(a.base))},d={"--spice-blue":a.neuralPrimary,"--spice-rgb-blue":s.neuralPrimary,"--spice-mauve":a.neuralSecondary,"--spice-rgb-mauve":s.neuralSecondary,"--spice-teal":a.neuralTertiary,"--spice-rgb-teal":s.neuralTertiary,"--spice-flamingo":this.generateZoneColor(a.primary,"flamingo"),"--spice-rgb-flamingo":this.hexToRgb(this.generateZoneColor(a.primary,"flamingo")),"--spice-lavender":this.generateZoneColor(a.highlight,"lavender"),"--spice-rgb-lavender":this.hexToRgb(this.generateZoneColor(a.highlight,"lavender")),"--spice-peach":this.generateZoneColor(a.surface2,"peach"),"--spice-rgb-peach":this.hexToRgb(this.generateZoneColor(a.surface2,"peach")),"--spice-rosewater":this.generateZoneColor(a.surface1,"rosewater"),"--spice-rgb-rosewater":this.hexToRgb(this.generateZoneColor(a.surface1,"rosewater")),"--spice-sapphire":this.generateZoneColor(a.neuralPrimary,"sapphire"),"--spice-rgb-sapphire":this.hexToRgb(this.generateZoneColor(a.neuralPrimary,"sapphire"))},h={"--spice-pink":this.generatePaletteColor(a.primary,"pink"),"--spice-rgb-pink":this.hexToRgb(this.generatePaletteColor(a.primary,"pink")),"--spice-sky":this.generatePaletteColor(a.neuralPrimary,"sky"),"--spice-rgb-sky":this.hexToRgb(this.generatePaletteColor(a.neuralPrimary,"sky")),"--spice-red":this.generatePaletteColor(a.highlight,"red"),"--spice-rgb-red":this.hexToRgb(this.generatePaletteColor(a.highlight,"red")),"--spice-maroon":this.generatePaletteColor(a.shadow,"maroon"),"--spice-rgb-maroon":this.hexToRgb(this.generatePaletteColor(a.shadow,"maroon")),"--spice-yellow":this.generatePaletteColor(a.surface2,"yellow"),"--spice-rgb-yellow":this.hexToRgb(this.generatePaletteColor(a.surface2,"yellow")),"--spice-green":this.generatePaletteColor(a.neuralTertiary,"green"),"--spice-rgb-green":this.hexToRgb(this.generatePaletteColor(a.neuralTertiary,"green")),"--spice-misc":a.surface1,"--spice-rgb-misc":s.surface1},p={"--spice-shimmer-primary":a.neuralPrimary,"--spice-rgb-shimmer-primary":s.neuralPrimary,"--spice-shimmer-secondary":a.neuralSecondary,"--spice-rgb-shimmer-secondary":s.neuralSecondary,"--spice-shimmer-tertiary":a.neuralTertiary,"--spice-rgb-shimmer-tertiary":s.neuralTertiary,"--spice-shimmer-quaternary":a.primary,"--spice-rgb-shimmer-quaternary":s.primary,"--spice-particle-glow":a.highlight,"--spice-rgb-particle-glow":s.highlight,"--spice-particle-core":a.primary,"--spice-rgb-particle-core":s.primary,"--spice-particle-trail":a.shadow,"--spice-rgb-particle-trail":s.shadow,"--spice-cinematic-red":this.generateCinematicRed(a.primary),"--spice-rgb-cinematic-red":this.hexToRgb(this.generateCinematicRed(a.primary)),"--spice-cinematic-cyan":this.generateCinematicCyan(a.primary),"--spice-rgb-cinematic-cyan":this.hexToRgb(this.generateCinematicCyan(a.primary)),"--spice-cinematic-yellow":this.generateCinematicYellow(a.highlight),"--spice-rgb-cinematic-yellow":this.hexToRgb(this.generateCinematicYellow(a.highlight)),"--spice-holographic-primary":this.generateHolographicPrimary(a.primary),"--spice-rgb-holographic-primary":this.hexToRgb(this.generateHolographicPrimary(a.primary)),"--spice-holographic-accent":this.generateHolographicAccent(a.neuralPrimary),"--spice-rgb-holographic-accent":this.hexToRgb(this.generateHolographicAccent(a.neuralPrimary)),"--spice-holographic-glow":this.generateHolographicGlow(a.highlight),"--spice-rgb-holographic-glow":this.hexToRgb(this.generateHolographicGlow(a.highlight))},b={...o,...l,...m,...d,...h,...p};this.cssController.batchSetVariables("SemanticColorManager",b,"critical","album-spicetify-update");let v={"--sn-bg-gradient-accent":a.primary,"--sn-bg-gradient-accent-rgb":s.primary,"--sn-bg-gradient-primary":a.primary,"--sn-bg-gradient-primary-rgb":s.primary,"--sn-bg-gradient-secondary":a.surface1,"--sn-bg-gradient-secondary-rgb":s.surface1};this.cssController.batchSetVariables("SemanticColorManager",v,"critical","album-starrynight-update");let C={"--sn-color-accent-hex":a.primary,"--sn-color-accent-rgb":s.primary,"--sn-accent-hex":a.primary,"--sn-accent-rgb":s.primary,"--sn-color-extracted-primary-rgb":s.primary,"--sn-color-extracted-secondary-rgb":s.surface1,"--sn-color-harmony-complementary-rgb":s.shadow,"--sn-color-harmony-analogous-rgb":s.highlight,"--sn-color-harmony-triadic-rgb":s.neuralPrimary};this.cssController.batchSetVariables("SemanticColorManager",C,"critical","album-y3k-integration-update"),this.clearCache(),this.lastColorUpdate=Date.now(),this.colorUpdateCount++;let P=Object.keys(b).length+Object.keys(v).length+Object.keys(C).length;g.emitSync("colors:applied",{cssVariables:{...b,...v,...C},accentHex:a.primary,accentRgb:s.primary,appliedAt:this.lastColorUpdate}),this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Comprehensive Spicetify variable update with OKLAB album colors:",{primaryColor:a.primary,accentColor:a.surface1,shadowColor:a.shadow,highlightColor:a.highlight,surfaceProgression:[a.base,a.surface0,a.surface1,a.surface2],neuralColors:[a.neuralPrimary,a.neuralSecondary,a.neuralTertiary],effectColors:{shimmerColors:4,particleColors:3,cinematicColors:3,holographicColors:3},totalSpicetifyVariablesUpdated:Object.keys(b).length,coreLayoutVariablesUpdated:Object.keys(m).length,starryNightVariablesUpdated:Object.keys(v).length,snColorVariablesUpdated:Object.keys(C).length,effectVariablesAdded:Object.keys(p).length,eventEmitted:!0,totalVariablesUpdated:P})}catch(e){console.error("[SemanticColorManager] Failed to update with album colors:",e)}}generateIntelligentColorDistribution(t,e,i,n){let r=t,a=e||t,s=i||this.generateDarkerVariant(t,.3),o=n||this.generateLighterVariant(t,.2),l=this.generateDarkerVariant(t,.6),m=this.generateDarkerVariant(t,.4),d=a,h=this.generateLighterVariant(a,.15),p=this.generateHueRotatedColor(t,120),b=this.generateHueRotatedColor(t,-60),v=this.generateHueRotatedColor(t,180);return{primary:r,surface0:m,surface1:d,surface2:h,base:l,shadow:s,highlight:o,neuralPrimary:p,neuralSecondary:b,neuralTertiary:v}}convertColorsToRgb(t){let e={};return Object.entries(t).forEach(([i,n])=>{e[i]=this.hexToRgb(n)}),e}generateDarkerVariant(t,e){try{let i=this.hexToRgbObject(t);if(!i)return t;let n=Math.max(0,Math.round(i.r*(1-e))),r=Math.max(0,Math.round(i.g*(1-e))),a=Math.max(0,Math.round(i.b*(1-e)));return this.rgbToHex(n,r,a)}catch(i){return console.warn("[SemanticColorManager] Failed to generate darker variant:",i),t}}generateLighterVariant(t,e){try{let i=this.hexToRgbObject(t);if(!i)return t;let n=Math.min(255,Math.round(i.r+(255-i.r)*e)),r=Math.min(255,Math.round(i.g+(255-i.g)*e)),a=Math.min(255,Math.round(i.b+(255-i.b)*e));return this.rgbToHex(n,r,a)}catch(i){return console.warn("[SemanticColorManager] Failed to generate lighter variant:",i),t}}generateHueRotatedColor(t,e){try{let i=this.hexToRgbObject(t);if(!i)return t;let n=this.rgbToHsl(i.r,i.g,i.b);n.h=(n.h+e)%360,n.h<0&&(n.h+=360);let r=this.hslToRgb(n.h,n.s,n.l);return this.rgbToHex(r.r,r.g,r.b)}catch(i){return console.warn("[SemanticColorManager] Failed to generate hue-rotated color:",i),t}}hexToRgbObject(t){let e=t.replace("#","");if(e.length!==6)return null;let i=parseInt(e.substring(0,2),16),n=parseInt(e.substring(2,4),16),r=parseInt(e.substring(4,6),16);return{r:i,g:n,b:r}}rgbToHex(t,e,i){let n=r=>{let a=Math.round(Math.max(0,Math.min(255,r))).toString(16);return a.length===1?"0"+a:a};return`#${n(t)}${n(e)}${n(i)}`}rgbToHsl(t,e,i){t/=255,e/=255,i/=255;let n=Math.max(t,e,i),r=Math.min(t,e,i),a=0,s=0,o=(n+r)/2;if(n===r)a=s=0;else{let l=n-r;switch(s=o>.5?l/(2-n-r):l/(n+r),n){case t:a=(e-i)/l+(e<i?6:0);break;case e:a=(i-t)/l+2;break;case i:a=(t-e)/l+4;break}a/=6}return{h:a*360,s:s*100,l:o*100}}hslToRgb(t,e,i){t/=360,e/=100,i/=100;let n=(o,l,m)=>(m<0&&(m+=1),m>1&&(m-=1),m<1/6?o+(l-o)*6*m:m<1/2?l:m<2/3?o+(l-o)*(2/3-m)*6:o),r,a,s;if(e===0)r=a=s=i;else{let o=i<.5?i*(1+e):i+e-i*e,l=2*i-o;r=n(l,o,t+1/3),a=n(l,o,t),s=n(l,o,t-1/3)}return{r:Math.round(r*255),g:Math.round(a*255),b:Math.round(s*255)}}hexToRgb(t){let e=t.replace("#",""),i=parseInt(e.substring(0,2),16),n=parseInt(e.substring(2,4),16),r=parseInt(e.substring(4,6),16);return`${i}, ${n}, ${r}`}getColorMappings(){return De.SEMANTIC_MAPPINGS}generateCinematicRed(t){try{let e=this.hexToRgbObject(t);if(!e)return"#FF0000";let i=Math.min(255,e.r+100),n=Math.max(0,Math.min(e.g*.3,100)),r=Math.max(0,Math.min(e.b*.2,80));return this.rgbToHex(i,n,r)}catch(e){return console.warn("[SemanticColorManager] Failed to generate cinematic red:",e),"#FF0000"}}generateCinematicCyan(t){try{let e=this.hexToRgbObject(t);if(!e)return"#00FFFF";let i=Math.min(255,e.g+120),n=Math.min(255,e.b+140),r=Math.max(0,Math.min(e.r*.2,60));return this.rgbToHex(r,i,n)}catch(e){return console.warn("[SemanticColorManager] Failed to generate cinematic cyan:",e),"#00FFFF"}}generateCinematicYellow(t){try{let e=this.hexToRgbObject(t);if(!e)return"#FFFF00";let i=Math.min(255,e.r+80),n=Math.min(255,e.g+100),r=Math.max(0,Math.min(e.b*.3,120));return this.rgbToHex(i,n,r)}catch(e){return console.warn("[SemanticColorManager] Failed to generate cinematic yellow:",e),"#FFFF00"}}generateHolographicPrimary(t){try{let e=this.hexToRgbObject(t);if(!e)return"#8A2BE2";let i=this.rgbToHsl(e.r,e.g,e.b),n=Math.min(1,i.s+.3),r=Math.min(.8,Math.max(.4,i.l+.1)),a=this.hslToRgb(i.h,n,r);return this.rgbToHex(a.r,a.g,a.b)}catch(e){return console.warn("[SemanticColorManager] Failed to generate holographic primary:",e),"#8A2BE2"}}generateHolographicAccent(t){try{return this.generateHueRotatedColor(t,45)}catch(e){return console.warn("[SemanticColorManager] Failed to generate holographic accent:",e),"#FF00FF"}}generateHolographicGlow(t){try{let e=this.hexToRgbObject(t);if(!e)return"#E0E0FF";let i=.7,n=Math.min(255,e.r+(255-e.r)*i),r=Math.min(255,e.g+(255-e.g)*i),a=Math.min(255,e.b+(255-e.b)*i);return this.rgbToHex(n,r,a)}catch(e){return console.warn("[SemanticColorManager] Failed to generate holographic glow:",e),"#E0E0FF"}}generateTextColor(t){try{let e=this.hexToRgbObject(t);return e&&(.299*e.r+.587*e.g+.114*e.b)/255>.5?"#24273A":"#CAD3F5"}catch(e){return console.warn("[SemanticColorManager] Failed to generate text color:",e),"#CAD3F5"}}generateSubtextColor(t){try{let e=this.hexToRgbObject(t);return e&&(.299*e.r+.587*e.g+.114*e.b)/255>.5?"#5B6078":"#A5ADCB"}catch(e){return console.warn("[SemanticColorManager] Failed to generate subtext color:",e),"#A5ADCB"}}generateOverlayColor(t,e){try{let i=this.hexToRgbObject(t);if(!i)return`rgba(88,91,112,${e})`;if((.299*i.r+.587*i.g+.114*i.b)/255>.5){let r=1-e*2,a=Math.max(0,Math.round(i.r*r)),s=Math.max(0,Math.round(i.g*r)),o=Math.max(0,Math.round(i.b*r));return this.rgbToHex(a,s,o)}else{let r=e*255,a=Math.min(255,Math.round(i.r+r)),s=Math.min(255,Math.round(i.g+r)),o=Math.min(255,Math.round(i.b+r));return this.rgbToHex(a,s,o)}}catch(i){return console.warn("[SemanticColorManager] Failed to generate overlay color:",i),`rgba(88,91,112,${e})`}}generateCrustColor(t){try{let e=this.hexToRgbObject(t);if(!e)return"#232634";if((.299*e.r+.587*e.g+.114*e.b)/255>.5){let n=Math.max(0,Math.round(e.r*.8)),r=Math.max(0,Math.round(e.g*.8)),a=Math.max(0,Math.round(e.b*.8));return this.rgbToHex(n,r,a)}else{let n=Math.min(255,Math.round(e.r+20)),r=Math.min(255,Math.round(e.g+20)),a=Math.min(255,Math.round(e.b+20));return this.rgbToHex(n,r,a)}}catch(e){return console.warn("[SemanticColorManager] Failed to generate crust color:",e),"#232634"}}generateMantleColor(t){try{let e=this.hexToRgbObject(t);if(!e)return"#1e2030";if((.299*e.r+.587*e.g+.114*e.b)/255>.5){let n=Math.max(0,Math.round(e.r*.95)),r=Math.max(0,Math.round(e.g*.95)),a=Math.max(0,Math.round(e.b*.95));return this.rgbToHex(n,r,a)}else{let n=Math.min(255,Math.round(e.r+10)),r=Math.min(255,Math.round(e.g+10)),a=Math.min(255,Math.round(e.b+10));return this.rgbToHex(n,r,a)}}catch(e){return console.warn("[SemanticColorManager] Failed to generate mantle color:",e),"#1e2030"}}generateZoneColor(t,e){try{let i=oe(t);if(!i)return console.warn(`\u{1F527} [SemanticColorManager] Failed to parse RGB from ${t}`),t;let r={flamingo:{rAdjust:20,gAdjust:-10,bAdjust:-5},lavender:{rAdjust:10,gAdjust:-5,bAdjust:15},peach:{rAdjust:25,gAdjust:10,bAdjust:-15},rosewater:{rAdjust:15,gAdjust:-8,bAdjust:0},sapphire:{rAdjust:-20,gAdjust:-10,bAdjust:25}}[e],a=Math.max(0,Math.min(255,i.r+r.rAdjust)),s=Math.max(0,Math.min(255,i.g+r.gAdjust)),o=Math.max(0,Math.min(255,i.b+r.bAdjust)),l=fe(a,s,o);return this.config.enableDebug&&console.log(`\u{1F3A8} [SemanticColorManager] Generated ${e} color: ${t} \u2192 ${l} (RGB: ${i.r},${i.g},${i.b} \u2192 ${a},${s},${o})`),l}catch(i){return console.warn(`\u{1F527} [SemanticColorManager] Failed to generate ${e} color for "${t}":`,i),t}}generatePaletteColor(t,e){try{let i=oe(t);if(!i)return console.warn(`\u{1F527} [SemanticColorManager] Failed to parse RGB from ${t}`),t;let r={pink:{rAdjust:30,gAdjust:-20,bAdjust:-10},sky:{rAdjust:-30,gAdjust:10,bAdjust:30},red:{rAdjust:35,gAdjust:-25,bAdjust:-15},maroon:{rAdjust:25,gAdjust:-15,bAdjust:-10},yellow:{rAdjust:30,gAdjust:25,bAdjust:-30},green:{rAdjust:-25,gAdjust:30,bAdjust:-20}}[e],a=Math.max(0,Math.min(255,i.r+r.rAdjust)),s=Math.max(0,Math.min(255,i.g+r.gAdjust)),o=Math.max(0,Math.min(255,i.b+r.bAdjust)),l=fe(a,s,o);return this.config.enableDebug&&console.log(`\u{1F3A8} [SemanticColorManager] Generated ${e} color: ${t} \u2192 ${l} (RGB: ${i.r},${i.g},${i.b} \u2192 ${a},${s},${o})`),l}catch(i){return console.warn(`\u{1F527} [SemanticColorManager] Failed to generate ${e} color for "${t}":`,i),t}}destroy(){try{this.cleanupEventSubscriptions(),this.clearCache(),this.cssController=null,this.initialized=!1,this.lastColorUpdate=0,this.colorUpdateCount=0,g.emitSync("system:destroyed",{systemName:"SemanticColorManager",timestamp:Date.now(),reason:"Manual destruction"}),this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] System destroyed and cleaned up")}catch(t){console.error("[SemanticColorManager] Error during destruction:",t)}}updateAnimation(t){}async healthCheck(){let t={system:"SemanticColorManager",healthy:!0,details:"SemanticColorManager operational",issues:[],metrics:{initialized:this.initialized,spicetifyAvailable:this.isSpicetifyAvailable(),cssConsciousnessAvailable:!!this.cssController,lastColorUpdate:this.lastColorUpdate,colorUpdateCount:this.colorUpdateCount,eventSubscriptions:this.eventSubscriptionIds.length,cacheSize:this.colorCache.size,lastCacheUpdate:this.lastCacheUpdate}};return this.initialized||(t.healthy=!1,t.issues.push("System not initialized")),this.isSpicetifyAvailable()||(t.healthy=!1,t.issues.push("Spicetify API not available")),this.colorUpdateCount===0&&this.initialized&&t.issues.push("No color updates performed since initialization"),this.eventSubscriptionIds.length===0&&this.initialized&&t.issues.push("No event subscriptions active"),t.issues.length>0&&(t.details=`Issues detected: ${t.issues.join(", ")}`,t.issues.length>=2&&(t.healthy=!1)),t}setupEventSubscriptions(){let t=g.subscribe("music:track-changed",async i=>{this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Track changed, preparing for color refresh:",i.trackUri),this.clearCache()},"SemanticColorManager"),e=g.subscribe("settings:changed",async i=>{(i.settingKey.includes("color")||i.settingKey.includes("theme"))&&(this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Color-related setting changed:",i.settingKey),this.clearCache())},"SemanticColorManager");this.eventSubscriptionIds=[t,e],this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Event subscriptions established:",this.eventSubscriptionIds.length)}cleanupEventSubscriptions(){for(let t of this.eventSubscriptionIds)g.unsubscribe(t);this.eventSubscriptionIds=[],this.config.enableDebug&&console.log("\u{1F3A8} [SemanticColorManager] Event subscriptions cleaned up")}getSystemMetrics(){return{initialized:this.initialized,lastColorUpdate:this.lastColorUpdate,colorUpdateCount:this.colorUpdateCount,eventSubscriptions:this.eventSubscriptionIds.length,cacheSize:this.colorCache.size,spicetifyAvailable:this.isSpicetifyAvailable()}}};De.SEMANTIC_MAPPINGS=[{semanticColor:"textBase",cssVariable:"--spice-text",fallbackColor:"#cad3f5",description:"Primary text color"},{semanticColor:"textSubdued",cssVariable:"--spice-subtext",fallbackColor:"#a5adcb",description:"Secondary text color"},{semanticColor:"textBrightAccent",cssVariable:"--spice-accent",fallbackColor:"#c6a0f6",description:"Accent text color"},{semanticColor:"textNegative",cssVariable:"--spice-red",fallbackColor:"#ed8796",description:"Error text color"},{semanticColor:"textWarning",cssVariable:"--spice-yellow",fallbackColor:"#eed49f",description:"Warning text color"},{semanticColor:"textPositive",cssVariable:"--spice-green",fallbackColor:"#a6da95",description:"Success text color"},{semanticColor:"textAnnouncement",cssVariable:"--spice-blue",fallbackColor:"#8aadf4",description:"Info text color"},{semanticColor:"essentialBase",cssVariable:"--spice-button",fallbackColor:"#cad3f5",description:"Primary button color"},{semanticColor:"essentialSubdued",cssVariable:"--spice-button-disabled",fallbackColor:"#6e738d",description:"Disabled button color"},{semanticColor:"essentialBrightAccent",cssVariable:"--spice-button-active",fallbackColor:"#c6a0f6",description:"Active button color"},{semanticColor:"essentialNegative",cssVariable:"--spice-notification-error",fallbackColor:"#ed8796",description:"Error button color"},{semanticColor:"essentialWarning",cssVariable:"--spice-notification-warning",fallbackColor:"#eed49f",description:"Warning button color"},{semanticColor:"essentialPositive",cssVariable:"--spice-notification-success",fallbackColor:"#a6da95",description:"Success button color"},{semanticColor:"backgroundBase",cssVariable:"--spice-main",fallbackColor:"#24273a",description:"Main background color"},{semanticColor:"backgroundHighlight",cssVariable:"--spice-highlight",fallbackColor:"#363a4f",description:"Highlight background color"},{semanticColor:"backgroundPress",cssVariable:"--spice-press",fallbackColor:"#494d64",description:"Press state background color"},{semanticColor:"backgroundElevatedBase",cssVariable:"--spice-card",fallbackColor:"#1e2030",description:"Card background color"},{semanticColor:"backgroundElevatedHighlight",cssVariable:"--spice-card-highlight",fallbackColor:"#363a4f",description:"Card highlight background"},{semanticColor:"backgroundTintedBase",cssVariable:"--spice-sidebar",fallbackColor:"#363a4f",description:"Sidebar background color"},{semanticColor:"backgroundTintedHighlight",cssVariable:"--spice-sidebar-highlight",fallbackColor:"#494d64",description:"Sidebar highlight background"},{semanticColor:"decorativeBase",cssVariable:"--spice-decorative",fallbackColor:"#cad3f5",description:"Decorative element color"},{semanticColor:"decorativeSubdued",cssVariable:"--spice-decorative-subdued",fallbackColor:"#939ab7",description:"Subdued decorative color"}];at=De});function Ea(){try{let t=document.createElement("canvas").getContext("webgl2");if(!t)return!1;let e=t.getExtension("EXT_color_buffer_float")!==null;return!0}catch{return!1}}function uc(c,t){try{let e={alpha:t.alpha??!0,antialias:t.antialias??!0,preserveDrawingBuffer:t.preserveDrawingBuffer??!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1},i=c.getContext("webgl2",e);if(!i)return null;let n=i.getParameter(i.MAX_TEXTURE_SIZE);return{canvas:c,ctx:i,type:"webgl2",capabilities:{supportsGPUAcceleration:!0,supports3D:!0,maxTextureSize:n}}}catch(e){return console.warn("[VisualCanvasFactory] WebGL2 context creation failed:",e),null}}function wa(c,t){let e={alpha:t.alpha??!0,desynchronized:!0},i=c.getContext("2d",e);return{canvas:c,ctx:i,type:"2d",capabilities:{supportsGPUAcceleration:!1,supports3D:!1}}}async function Pa(c){let t=document.createElement("canvas");t.id=c.id,t.width=c.width??window.innerWidth,t.height=c.height??window.innerHeight;let e=c.fallbackChain??["webgl2","2d"];if(c.preferredType){let i=[c.preferredType,...e.filter(n=>n!==c.preferredType)];e.splice(0,e.length,...i)}for(let i of e){let n=null;switch(i){case"webgl2":Ea()&&(n=uc(t,c));break;case"2d":n=wa(t,c);break}if(n)return n}return wa(t,c)}function Ta(){let c=Ea(),t="2d";return c&&(t="webgl2"),{webgl2:c,recommendedType:t}}var xa=y(()=>{"use strict"});function Aa(c,t,e={}){let{trace:i}=e;if(!t||typeof t!="object")return i?.("[visualPerformance] No performanceProfiles provided \u2013 skipping selection"),null;let n=t[c];if(n||(i?.(`[visualPerformance] Profile '${c}' not found, falling back to 'balanced'`),n=t.balanced),!n){let r=Object.keys(t)[0];n=t[r],i?.(`[visualPerformance] Using first available profile '${r}' as fallback`)}return n}var Ia=y(()=>{"use strict"});var Q,ge=y(()=>{"use strict";U();xa();K();Ia();Q=class{constructor(t=w,e=I,i,n,r){this.canvasCapabilities=null;this.activeCanvasResults=new Map;this.config=t,this.utils=e,this.performanceMonitor=i,this.musicSyncService=n,this.settingsManager=r,this.systemName=this.constructor.name,this.initialized=!1,this.isActive=!1,this.currentPerformanceProfile={},this.metrics={initializationTime:0,updates:0,errors:0},this._resizeHandler=null,this.boundHandleSettingsChange=this.handleSettingsChange.bind(this),this.config.enableDebug&&console.log(`[${this.systemName}] Constructor`)}async initialize(){let t=this.config.enableDebug?performance.now():0;if(this.config.enableDebug&&console.log(`[${this.systemName}] Initializing...`),this.settingsManager){document.addEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange);try{let e=globalThis.year3000System?.deviceCapabilityDetector,i="balanced";e?.isInitialized&&(i=e.recommendPerformanceQuality()),this.config.enableDebug&&console.log(`[${this.systemName}] Auto-selected performance quality '${i}' based on device capability.`),this._applyPerformanceProfile(i)}catch(e){this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Device capability detection failed; defaulting to 'balanced'.`,e),this._applyPerformanceProfile("balanced")}}if(await this._performSystemSpecificInitialization(),this.initialized=!0,this.isActive=!0,this.musicSyncService&&(this._validateDependenciesForSubscription()?(this.musicSyncService.subscribe(this,this.systemName),this.config.enableDebug&&console.log(`[${this.systemName}] Subscribed to MusicSyncService.`)):console.warn(`[${this.systemName}] Dependency validation failed; subscription skipped.`)),this.config.enableDebug){let e=performance.now()-t;console.log(`[${this.systemName}] Initialization complete in ${e.toFixed(2)}ms`)}}async _performSystemSpecificInitialization(){this.canvasCapabilities=Ta(),this.canvasCapabilities&&this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Canvas capabilities detected: WebGL2=${this.canvasCapabilities.webgl2}, Recommended=${this.canvasCapabilities.recommendedType}`)}_validateDependenciesForSubscription(){return typeof this.updateFromMusicAnalysis!="function"?(console.error(`[${this.systemName}] Missing updateFromMusicAnalysis method.`),!1):this.initialized?this._performAdditionalDependencyValidation():(console.warn(`[${this.systemName}] System not initialized.`),!1)}_performAdditionalDependencyValidation(){return!0}destroy(){this.config.enableDebug&&console.log(`[${this.systemName}] Destroying...`);try{this.initialized=!1,this.isActive=!1,this.musicSyncService&&this.musicSyncService.unsubscribe(this.systemName),this.settingsManager&&this.boundHandleSettingsChange&&document.removeEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange),this._resizeHandler&&(window.removeEventListener("resize",this._resizeHandler),this._resizeHandler=null),this._performSystemSpecificCleanup()}catch(t){console.error(`[${this.systemName}] Error during destruction:`,t),this.metrics.errors++}}_performSystemSpecificCleanup(){for(let[t,e]of this.activeCanvasResults){let i=e.canvas;i.parentNode&&i.parentNode.removeChild(i),this.config.enableDebug&&console.log(`[${this.systemName}] Cleaned up canvas: ${t} (type: ${e.type})`)}this.activeCanvasResults.clear()}updateFromMusicAnalysis(t,...e){}onAnimate(t){typeof this.updateAnimation=="function"&&this.updateAnimation(performance.now(),t)}updateModeConfiguration(t){}handleSettingsChange(t){}_applyPerformanceProfile(t){if(!this.config?.performanceProfiles){this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Performance profiles not found in config.`);return}let e=Aa(t,this.config.performanceProfiles,{trace:i=>this.performanceMonitor?.emitTrace(i)});e?(this.currentPerformanceProfile=e,this.performanceMonitor?.emitTrace?.(`[BaseVisualSystem (${this.systemName})] Applied performance profile '${t}'`,e)):this.performanceMonitor?.emitTrace?.(`[${this.systemName}] Performance profile '${t}' not found.`)}getCosmicState(){if(typeof document>"u")return{};let t=document.documentElement,e=getComputedStyle(t);return{energy:parseFloat(e.getPropertyValue("--sn-kinetic-energy"))||.5,valence:parseFloat(e.getPropertyValue("--sn-kinetic-valence"))||.5,bpm:parseFloat(e.getPropertyValue("--sn-kinetic-bpm"))||120,tempoMultiplier:parseFloat(e.getPropertyValue("--sn-kinetic-tempo-multiplier"))||1,beatPhase:parseFloat(e.getPropertyValue("--sn-kinetic-beat-phase"))||0,beatPulse:parseFloat(e.getPropertyValue("--sn-kinetic-beat-pulse"))||0}}async _createOptimizedKineticCanvas(t,e=5,i="screen",n="pulse"){let r=document.getElementById(t);r&&r.remove();let a="2d";this.canvasCapabilities&&this.currentPerformanceProfile&&(this.currentPerformanceProfile.quality||"balanced")!=="low"&&this.canvasCapabilities.webgl2&&(a="webgl2");let s=await Pa({id:t,width:window.innerWidth,height:window.innerHeight,alpha:!0,antialias:!0,preferredType:a}),o=s.canvas;o.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: ${e};
      pointer-events: none;
      mix-blend-mode: ${i};
    `,o.classList.add("year3000-kinetic-canvas"),o.dataset.kineticMode=n,o.dataset.systemName=this.systemName,o.dataset.canvasType=s.type;let l=this._getKineticStyles(n);return Object.assign(o.style,l),document.body.appendChild(o),this.activeCanvasResults.set(t,s),this._resizeHandler=()=>{o.width=window.innerWidth,o.height=window.innerHeight,typeof this.handleResize=="function"&&this.handleResize()},window.addEventListener("resize",this._resizeHandler),this._resizeHandler(),this.config.enableDebug&&console.log(`[BaseVisualSystem (${this.systemName})] Created optimized kinetic canvas: ${s.type} (mode: ${n})`),s}getCanvasCapabilities(){return this.canvasCapabilities}hasGPUAcceleration(){return this.canvasCapabilities?.webgl2||!1}_createKineticCanvas(t,e=5,i="screen",n="pulse"){let r=this._createCanvasElement(t,e,i);r.classList.add("year3000-kinetic-canvas"),r.dataset.kineticMode=n,r.dataset.systemName=this.systemName;let a=this._getKineticStyles(n);return Object.assign(r.style,a),this.config.enableDebug&&console.log(`[BaseVisualSystem (${this.systemName})] Created kinetic canvas with mode: ${n}`),r}_getKineticStyles(t){let e={transition:"all 150ms cubic-bezier(0.25, 0.46, 0.45, 0.94)"};switch(t){case"pulse":return{...e,animation:"year3000-pulse calc(var(--sn-kinetic-tempo-multiplier, 1) * 1s) ease-in-out infinite"};case"breathe":return{...e,animation:"year3000-breathe calc(var(--sn-kinetic-tempo-multiplier, 1) * 4s) ease-in-out infinite"};case"flow":return{...e,animation:"year3000-flow calc(var(--sn-kinetic-tempo-multiplier, 1) * 8s) linear infinite"};default:return e}}_createCanvasElement(t,e,i){let n=document.getElementById(t);n&&n.remove();let r=document.createElement("canvas");return r.id=t,r.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: ${e};
      pointer-events: none;
      mix-blend-mode: ${i};
    `,document.body.appendChild(r),this._resizeHandler=()=>{r.width=window.innerWidth,r.height=window.innerHeight,typeof this.handleResize=="function"&&this.handleResize()},window.addEventListener("resize",this._resizeHandler),this._resizeHandler(),r}applyPerformanceSettings(t){this.currentPerformanceProfile=t,t.quality&&typeof this._applyPerformanceProfile=="function"&&this._applyPerformanceProfile?.(t.quality),this.config.enableDebug&&this.performanceMonitor?.emitTrace?.(`[BaseVisualSystem (${this.systemName})] Performance settings applied`,t)}applyUpdatedSettings(t,e){let i=new CustomEvent("year3000SystemSettingsChanged",{detail:{key:t,value:e}});try{this.handleSettingsChange(i)}catch(n){this.config.enableDebug&&console.warn(`[BaseVisualSystem] ${this.systemName} applyUpdatedSettings error`,n)}}forceRepaint(t="generic"){}}});var _,de=y(()=>{"use strict";_=class{constructor(t={}){this.deviceCapabilities=null;this.isInitialized=!1;this.benchmarkCache=new Map;this.detectionStartTime=0;this.config={enableDebug:t.enableDebug||!1,runStressTests:t.runStressTests!==!1,spicetifyContext:t.spicetifyContext||this._detectSpicetifyContext(),...t},this.config.enableDebug&&console.log("\u{1F50D} [DeviceCapabilityDetector] Initialized",this.config.spicetifyContext?"(Spicetify-optimized)":"(Standard)")}_detectSpicetifyContext(){return!!window.Spicetify}async initialize(){if(this.isInitialized)return this.deviceCapabilities;this.detectionStartTime=performance.now(),this.config.enableDebug&&console.log("\u{1F50D} [DeviceCapabilityDetector] Starting enhanced capability detection...",this.config.spicetifyContext?"(Spicetify mode)":"(Standard mode)");let t=await this._analyzeMemoryCapabilities(),e=await this._analyzeCPUCapabilities(),i=await this._analyzeGPUCapabilities();this.deviceCapabilities={memory:t,cpu:e,gpu:i,browser:{supportsOffscreenCanvas:this._detectOffscreenCanvasSupport(),supportsWorkers:this._detectWorkerSupport(),supportsSharedArrayBuffer:this._detectSharedArrayBufferSupport(),supportsWASM:this._detectWASMSupport(),supportsCSSHoudini:this._detectCSSHoudiniSupport()},display:{pixelRatio:window.devicePixelRatio||1,refreshRate:await this._detectRefreshRate(),colorGamut:this._detectColorGamut(),contrastRatio:this._detectContrastCapability(),reducedMotion:this._detectReducedMotion()},network:{effectiveType:navigator.connection?.effectiveType||"unknown",downlink:navigator.connection?.downlink||0,rtt:navigator.connection?.rtt||0,saveData:navigator.connection?.saveData||!1},overall:"detecting",spicetifyProfile:await this._createSpicetifyProfile(t,e,i)},this.config.runStressTests&&(await this._runCapabilityTests(),this.deviceCapabilities.spicetifyProfile=await this._createSpicetifyProfile(this.deviceCapabilities.memory,this.deviceCapabilities.cpu,this.deviceCapabilities.gpu)),this.deviceCapabilities.overall=this._calculateOverallPerformanceLevel(),this.isInitialized=!0;let n=performance.now()-this.detectionStartTime;return this.config.enableDebug&&console.log("\u{1F4CA} [DeviceCapabilityDetector] Enhanced detection completed in",`${n.toFixed(1)}ms`,`
Spicetify Profile:`,this.deviceCapabilities.spicetifyProfile),this.config.enableDebug&&console.log("\u{1F4CA} [DeviceCapabilityDetector] Capabilities detected:",this.deviceCapabilities),this.deviceCapabilities}getSpicetifyProfile(){return this.deviceCapabilities?.spicetifyProfile||null}getRecommendedQualityLevel(){return this.deviceCapabilities?.spicetifyProfile?.recommendedQualityLevel||50}async _analyzeMemoryCapabilities(){let t=navigator.deviceMemory,e=typeof t=="number",i=t||this._estimateMemoryFromOtherSources(),n=performance.memory?.jsHeapSizeLimit||0,r=this._estimateAvailableMemory(),a=this.config.spicetifyContext?this._estimateSpicetifyOverhead():0,s=this._calculateMemoryScore(i,n,r);return{total:i,score:s,level:s>=7?"high":s>=4?"medium":"low",jsHeapSizeLimit:n,estimatedAvailable:r,spicetifyOverhead:a,confidenceLevel:e?.9:.6}}_detectMemoryLevel(){let t=navigator.deviceMemory||6;return t>=8?"high":t>=4?"medium":"low"}_estimateAvailableMemory(){return performance.memory?performance.memory.jsHeapSizeLimit-performance.memory.usedJSHeapSize:(navigator.deviceMemory||4)*1024*1024*1024*.7}async _analyzeCPUCapabilities(){let t=navigator.hardwareConcurrency||4,e=await this._benchmarkSingleThreadPerformance(),i=this._estimateThermalThrottlingRisk(t),n=this._calculateCPUScore(t,e);return{cores:t,score:n,level:n>=7?"high":n>=4?"medium":"low",singleThreadPerformance:e,thermalThrottlingRisk:i,confidenceLevel:t>1?.8:.5}}_detectCPULevel(){let t=navigator.hardwareConcurrency||4;return t>=8?"high":t>=4?"medium":"low"}_detectWebGLSupport(){try{let t=document.createElement("canvas");return!!(t.getContext("webgl")||t.getContext("experimental-webgl"))}catch{return!1}}_detectWebGL2Support(){try{return!!document.createElement("canvas").getContext("webgl2")}catch{return!1}}_getMaxTextureSize(){try{let t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");return e?e.getParameter(e.MAX_TEXTURE_SIZE):0}catch{return 0}}_getGPUVendor(){try{let t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");if(!e)return"unknown";let i=e.getExtension("WEBGL_debug_renderer_info");return i?e.getParameter(i.UNMASKED_VENDOR_WEBGL):"unknown"}catch{return"unknown"}}_getGPURenderer(){try{let t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");if(!e)return"unknown";let i=e.getExtension("WEBGL_debug_renderer_info");return i?e.getParameter(i.UNMASKED_RENDERER_WEBGL):"unknown"}catch{return"unknown"}}async _analyzeGPUCapabilities(){let t=this._detectWebGLSupport(),e=this._detectWebGL2Support(),i=this._getMaxTextureSize(),n=this._getGPUVendor(),r=this._getGPURenderer(),a=await this._benchmarkWebGLCapabilities(),s=this._calculateGPUScore(r,a,e,i);return{supportsWebGL:t,supportsWebGL2:e,maxTextureSize:i,score:s,level:s>=7?"high":s>=4?"medium":"low",vendor:n,renderer:r,webglCapabilityScore:a,confidenceLevel:t?.8:.3}}_detectGPULevel(){let t=this._getGPURenderer().toLowerCase();return/rtx|radeon rx|gtx 16|gtx 20|apple m[1-9]|iris xe/.test(t)?"high":/gtx|radeon|intel iris|intel uhd|vega|ryzen/.test(t)?"medium":"low"}_detectOffscreenCanvasSupport(){return typeof OffscreenCanvas<"u"}_detectWorkerSupport(){return typeof Worker<"u"}_detectSharedArrayBufferSupport(){return typeof SharedArrayBuffer<"u"}_detectWASMSupport(){return typeof WebAssembly<"u"}_detectCSSHoudiniSupport(){return typeof CSS<"u"&&CSS.paintWorklet!==void 0}async _detectRefreshRate(){return new Promise(t=>{let e=performance.now(),i=0,n=[],r=()=>{let a=performance.now(),s=a-e;if(n.push(1e3/s),e=a,i++,i<10)requestAnimationFrame(r);else{let o=n.reduce((l,m)=>l+m,0)/n.length;t(Math.round(o))}};requestAnimationFrame(r)})}_detectColorGamut(){return window.matchMedia("(color-gamut: p3)").matches?"p3":window.matchMedia("(color-gamut: srgb)").matches?"srgb":"limited"}_detectContrastCapability(){return window.matchMedia("(dynamic-range: high)").matches||window.matchMedia("(contrast: high)").matches?"high":"standard"}_detectReducedMotion(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}async _runCapabilityTests(){this.deviceCapabilities&&(this.deviceCapabilities.gpu.stressTestScore=await this._runGPUStressTest(),this.deviceCapabilities.memory.stressTestScore=await this._runMemoryStressTest()),this.config.enableDebug&&console.log("\u26A1 [DeviceCapabilityDetector] Capability tests completed")}async _runGPUStressTest(){return 0}async _runMemoryStressTest(){return 0}_estimateMemoryFromOtherSources(){let t=navigator.hardwareConcurrency||4,e=window.screen,i=4;return t>=8?i=16:t>=6?i=12:t>=4?i=8:t>=2&&(i=6),e.width*e.height>2073600&&(i*=1.5),Math.round(i)}_estimateSpicetifyOverhead(){return this.config.spicetifyContext?.15:0}_calculateMemoryScore(t,e,i){let n=Math.min(t/2,10);if(e>0){let r=e/1073741824;n=Math.max(n,Math.min(r,10))}return this.config.spicetifyContext&&(n*=.85),Math.min(Math.max(n,1),10)}async _benchmarkSingleThreadPerformance(){let t="singleThreadPerf";return this.benchmarkCache.has(t)?this.benchmarkCache.get(t):new Promise(e=>{let i=performance.now(),n=0;for(let s=0;s<5e5;s++)n+=Math.sin(s)*Math.cos(s);let r=performance.now()-i,a=Math.max(1,Math.min(10,50/r));this.benchmarkCache.set(t,a),e(a)})}_estimateThermalThrottlingRisk(t){let e=/Mobi|Android/i.test(navigator.userAgent),i=.1;return t>=8&&(i+=.2),e&&(i+=.3),Math.min(i,1)}_calculateCPUScore(t,e){let i=Math.min(t/2,10),n=.7;return Math.min(i*(1-n)+e*n,10)}async _benchmarkWebGLCapabilities(){let t="webglCapability";if(this.benchmarkCache.has(t))return this.benchmarkCache.get(t);if(!this._detectWebGLSupport())return this.benchmarkCache.set(t,0),0;let e=document.createElement("canvas"),i=e.getContext("webgl2")||e.getContext("webgl");if(!i)return this.benchmarkCache.set(t,0),0;let n=2;i.getExtension("OES_texture_float")&&(n+=1),i.getExtension("WEBGL_depth_texture")&&(n+=1),i.getExtension("OES_element_index_uint")&&(n+=1);let r=i.getParameter(i.MAX_TEXTURE_SIZE);return r>=4096?n+=2:r>=2048&&(n+=1),i.getParameter(i.MAX_VERTEX_ATTRIBS)>=16&&(n+=1),i instanceof WebGL2RenderingContext&&(n+=2),this.benchmarkCache.set(t,Math.min(n,10)),Math.min(n,10)}_calculateGPUScore(t,e,i,n){let r=e,a=t.toLowerCase();return/rtx|radeon rx|apple m[1-9]|arc a/.test(a)?r+=2:/gtx|radeon|vega|iris xe|ryzen/.test(a)?r+=1:/intel|qualcomm|mali|adreno/.test(a)&&(r+=.5),Math.min(Math.max(r,1),10)}async _createSpicetifyProfile(t,e,i){let n=t.score,r=e.score,a=i.score,s=Math.round((n*.3+r*.4+a*.3)*10),o=Math.min(s,100);this.config.spicetifyContext&&(o*=1-t.spicetifyOverhead),o=Math.max(o,20);let l=(t.confidenceLevel+e.confidenceLevel+i.confidenceLevel)/3;return{memoryScore:n,cpuScore:r,gpuScore:a,compositeScore:s,spicetifyOverhead:t.spicetifyOverhead,userQualityPreference:"auto",confidenceLevel:l,recommendedQualityLevel:Math.round(o)}}_calculateOverallPerformanceLevel(){if(!this.deviceCapabilities)return"low";let t=this.deviceCapabilities.spicetifyProfile.compositeScore,e=this.deviceCapabilities.spicetifyProfile.confidenceLevel,i=t*(.7+e*.3);return i>=70?"high":i>=40?"medium":"low"}getCapabilities(){return this.isInitialized?this.deviceCapabilities:(console.warn("[DeviceCapabilityDetector] Not initialized - call initialize() first"),null)}hasWebGLSupport(){return this.isInitialized&&this.deviceCapabilities?this.deviceCapabilities.gpu.supportsWebGL:this._detectWebGLSupport()}hasWebGL2Support(){return this.isInitialized&&this.deviceCapabilities?this.deviceCapabilities.gpu.supportsWebGL2:this._detectWebGL2Support()}destroy(){this.deviceCapabilities=null,this.isInitialized=!1,this.config.enableDebug&&console.log("\u{1F50D} [DeviceCapabilityDetector] Destroyed")}recommendPerformanceQuality(){if(!this.isInitialized||!this.deviceCapabilities)return"balanced";switch(this.deviceCapabilities.overall){case"high":return"high";case"medium":return"balanced";case"low":default:return"low"}}}});var ee,ke=y(()=>{"use strict";U();K();ye();ee=class{constructor(t=w,e=se,i=I){this.initialized=!1;this.initialized=!0,t?.enableDebug&&console.log("[SettingsManager] Initialized with new type-safe backend")}forceRepaint(t){typeof document<"u"&&(document.documentElement.style.display="none",document.documentElement.offsetHeight,document.documentElement.style.display="")}async initialize(){this.initialized=!0}async healthCheck(){return{healthy:this.initialized,system:"SettingsManager",details:this.initialized?"Settings manager operational":"Settings manager not initialized"}}updateAnimation(){}destroy(){this.initialized=!1}get(t){try{switch(t){case"artisticMode":return x.get("sn-artistic-mode");case"paletteSystem":return x.get("sn-palette-system");case"gradientIntensity":return x.get("sn-gradient-intensity");case"webglEnabled":return x.get("sn-webgl-enabled");case"animationQuality":return x.get("sn-animation-quality");default:return typeof t=="string"&&t.startsWith("sn-")?x.get(t):void 0}}catch(e){console.warn(`[SettingsManager] Failed to get setting ${String(t)}:`,e);return}}getAllowedValues(t){switch(t){case"artisticMode":return Object.keys(Ye);case"paletteSystem":return["catppuccin","year3000"];case"gradientIntensity":return["disabled","minimal","balanced","intense"];case"webglEnabled":return[!0,!1];case"animationQuality":return["auto","low","high"];default:return}}set(t,e){try{switch(t){case"artisticMode":return x.set("sn-artistic-mode",e);case"paletteSystem":return x.set("sn-palette-system",e);case"gradientIntensity":return x.set("sn-gradient-intensity",e);case"webglEnabled":return x.set("sn-webgl-enabled",!!e);case"animationQuality":return x.set("sn-animation-quality",e);default:return typeof t=="string"&&t.startsWith("sn-")?x.set(t,e):(console.warn(`[SettingsManager] Unknown setting key: ${String(t)}`),!1)}}catch(i){return console.warn(`[SettingsManager] Failed to set setting ${String(t)}:`,i),!1}}getAllSettings(){return{artisticMode:this.get("artisticMode")||"artist-vision",paletteSystem:this.get("paletteSystem")||"catppuccin",gradientIntensity:this.get("gradientIntensity")||"balanced",webglEnabled:this.get("webglEnabled")??!0,animationQuality:this.get("animationQuality")||"auto"}}validateAndRepair(){console.log("[SettingsManager] Settings validation handled by typed system")}resetAllToDefaults(){try{x.set("sn-artistic-mode","artist-vision"),x.set("sn-palette-system","catppuccin"),x.set("sn-gradient-intensity","balanced"),x.set("sn-webgl-enabled",!0),x.set("sn-animation-quality","auto"),console.log("[SettingsManager] Reset all settings to defaults")}catch(t){console.warn("[SettingsManager] Failed to reset settings:",t)}}getCurrentHarmonicMode(){let t=x.get("sn-artistic-mode")||"artist-vision",i={"artist-vision":"analogous-flow","cosmic-maximum":"triadic-balance","corporate-safe":"monochromatic-smooth"}[String(t)]||"analogous-flow";return se[i]||se["analogous-flow"]}getHarmonicMode(t){return se[t]}}});var ni,Ra=y(()=>{"use strict";U();N();de();A();ye();K();ni=class{constructor(){this.utils=I;this.config=w;this.cssController=null;this.depthState={containerElement:null,backgroundContainer:null,depthLayers:new Map,animationFrameId:null,lastAnimationTime:0,scrollY:0,scrollX:0,lastUpdateTime:0,isInitialized:!1,stylesInjected:!1};this.depthSettings={enabled:!0,layerCount:6,maxDepth:1e3,parallaxStrength:.5,depthFogIntensity:.7,infiniteScrolling:!0,qualityLevel:"medium",performanceMode:!1,musicResponsiveness:1};this.performanceMetrics={totalLayers:0,visibleLayers:0,averageDepth:0,parallaxRange:0,renderTime:0,memoryUsage:0};this.layerTemplates={cosmic:{animation:"cosmic-drift",duration:"120s",baseGradient:"radial-gradient(ellipse at center, {primary} 0%, {secondary} 50%, {base} 100%)"},nebula:{animation:"nebula-flow",duration:"180s",baseGradient:"conic-gradient(from 45deg, {primary} 0%, {secondary} 25%, {tertiary} 50%, {quaternary} 75%, {primary} 100%)"},stellar:{animation:"stellar-motion",duration:"240s",baseGradient:"linear-gradient(45deg, {primary} 0%, {secondary} 25%, {tertiary} 50%, {quaternary} 75%, {primary} 100%)"},quantum:{animation:"quantum-field",duration:"300s",baseGradient:"radial-gradient(circle at 30% 70%, {primary} 0%, transparent 50%), radial-gradient(circle at 70% 30%, {secondary} 0%, transparent 50%)"},dimensional:{animation:"dimensional-shift",duration:"360s",baseGradient:"linear-gradient(135deg, {primary} 0%, {secondary} 20%, {tertiary} 40%, {quaternary} 60%, {primary} 80%, {secondary} 100%)"},void:{animation:"void-expansion",duration:"480s",baseGradient:"radial-gradient(ellipse at center, {base} 0%, {secondary} 30%, {primary} 60%, transparent 100%)"}};this.boundScrollHandler=null;this.boundResizeHandler=null;this.deviceDetector=new _,this.cssController=T(),this.loadDepthSettings(),this.adaptToDeviceCapabilities(),this.boundScrollHandler=this.handleScroll.bind(this),this.boundResizeHandler=this.handleResize.bind(this),u?.debug?.log("DepthLayeredStrategy","Depth layered strategy initialized",{layerCount:this.depthSettings.layerCount,qualityLevel:this.depthSettings.qualityLevel,deviceCapability:this.deviceDetector.recommendPerformanceQuality()})}getStrategyName(){return"depth-layered"}canProcess(t){return this.depthSettings.enabled}getEstimatedProcessingTime(t){let i=this.depthSettings.layerCount/6,n=this.depthSettings.qualityLevel==="high"?1.3:this.depthSettings.qualityLevel==="low"?.7:1;return Math.round(15*i*n)}async processColors(t){let e=performance.now();try{this.depthState.isInitialized||await this.initializeDepthSystem();let i=this.extractDepthColors(t.rawColors);await this.updateDepthLayers(i),this.depthState.animationFrameId||this.startDepthAnimation(),t.musicData?.energy!==void 0&&this.updateDepthWithMusicEnergy(t.musicData.energy),this.depthState.lastUpdateTime=Date.now(),this.updatePerformanceMetrics();let n=performance.now()-e,r={processedColors:{depthLayers:this.depthState.depthLayers.size.toString(),depthEnabled:this.depthSettings.enabled.toString(),qualityLevel:this.depthSettings.qualityLevel,...t.rawColors},accentHex:this.selectPrimaryColor(t.rawColors)||"#cba6f7",accentRgb:this.convertToRgbString(this.selectPrimaryColor(t.rawColors)||"#cba6f7"),metadata:{strategy:this.getStrategyName(),processingTime:n,cacheKey:`depth-layered-${t.trackUri}`,harmonicIntensity:this.depthSettings.parallaxStrength,layerCount:this.depthState.depthLayers.size},context:t};return u?.debug?.log("DepthLayeredStrategy","Depth layered processing completed",{layerCount:this.depthState.depthLayers.size,processingTime:n,trackUri:t.trackUri}),r}catch(i){let n=performance.now()-e;return u?.debug?.error("DepthLayeredStrategy","Depth layered processing failed:",i),{processedColors:t.rawColors,accentHex:this.selectPrimaryColor(t.rawColors)||"#cba6f7",accentRgb:this.convertToRgbString(this.selectPrimaryColor(t.rawColors)||"#cba6f7"),metadata:{strategy:this.getStrategyName(),processingTime:n,error:i instanceof Error?i.message:"Unknown error"},context:t}}}loadDepthSettings(){try{let t=x.get("sn-gradient-intensity");if(t){let i=t==="intense"?"high":t==="balanced"?"medium":t==="minimal"?"low":"medium";this.depthSettings.qualityLevel=i,this.adjustQualitySettings()}let e=t!=="disabled";e!==void 0&&(this.depthSettings.enabled=e)}catch(t){u?.debug?.warn("DepthLayeredStrategy","Failed to load settings:",t)}}adaptToDeviceCapabilities(){switch(this.deviceDetector.recommendPerformanceQuality()){case"low":this.depthSettings.qualityLevel="low",this.depthSettings.layerCount=3,this.depthSettings.performanceMode=!0,this.depthSettings.parallaxStrength=.3,this.depthSettings.depthFogIntensity=.5;break;case"balanced":this.depthSettings.qualityLevel="medium",this.depthSettings.layerCount=6,this.depthSettings.performanceMode=!1,this.depthSettings.parallaxStrength=.5,this.depthSettings.depthFogIntensity=.7;break;case"high":this.depthSettings.qualityLevel="high",this.depthSettings.layerCount=9,this.depthSettings.performanceMode=!1,this.depthSettings.parallaxStrength=.8,this.depthSettings.depthFogIntensity=.9;break}}adjustQualitySettings(){switch(this.depthSettings.qualityLevel){case"low":this.depthSettings.layerCount=3,this.depthSettings.parallaxStrength=.3,this.depthSettings.depthFogIntensity=.5;break;case"medium":this.depthSettings.layerCount=6,this.depthSettings.parallaxStrength=.5,this.depthSettings.depthFogIntensity=.7;break;case"high":this.depthSettings.layerCount=9,this.depthSettings.parallaxStrength=.8,this.depthSettings.depthFogIntensity=.9;break}}async initializeDepthSystem(){this.createContainerElements(),this.injectDepthAnimations(),this.setupEventListeners(),this.depthState.isInitialized=!0,u?.debug?.log("DepthLayeredStrategy","Depth system initialized successfully")}createContainerElements(){this.depthState.containerElement=document.querySelector(".Root__main-view")||document.querySelector(".main-view-container")||document.body,this.depthState.backgroundContainer=document.createElement("div"),this.depthState.backgroundContainer.className="sn-depth-background-container",this.depthState.backgroundContainer.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -20;
      pointer-events: none;
      overflow: hidden;
      perspective: 1000px;
      transform-style: preserve-3d;
    `,this.depthState.containerElement.insertBefore(this.depthState.backgroundContainer,this.depthState.containerElement.firstChild)}injectDepthAnimations(){if(this.depthState.stylesInjected)return;let t=document.createElement("style");t.textContent=`
      .sn-depth-layer {
        position: absolute;
        width: 120%;
        height: 120%;
        top: -10%;
        left: -10%;
        pointer-events: none;
        transform-style: preserve-3d;
        will-change: transform, opacity;
      }

      @keyframes cosmic-drift {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        25% { transform: translate3d(-2%, 1%, 0) rotate(0.5deg) scale(1.02); }
        50% { transform: translate3d(0, -1%, 0) rotate(0deg) scale(0.98); }
        75% { transform: translate3d(2%, 0.5%, 0) rotate(-0.5deg) scale(1.01); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes nebula-flow {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        33% { transform: translate3d(1%, -1%, 0) rotate(1deg) scale(1.03); }
        66% { transform: translate3d(-1%, 1%, 0) rotate(-1deg) scale(0.97); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes stellar-motion {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        20% { transform: translate3d(-1%, 0.5%, 0) rotate(0.3deg) scale(1.01); }
        40% { transform: translate3d(0.5%, -0.5%, 0) rotate(-0.3deg) scale(0.99); }
        60% { transform: translate3d(1%, 0.5%, 0) rotate(0.2deg) scale(1.02); }
        80% { transform: translate3d(-0.5%, 1%, 0) rotate(-0.2deg) scale(0.98); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes quantum-field {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); filter: blur(0px); }
        25% { transform: translate3d(0.5%, -0.5%, 0) rotate(0.1deg) scale(1.01); filter: blur(0.5px); }
        50% { transform: translate3d(-0.5%, 0.5%, 0) rotate(-0.1deg) scale(0.99); filter: blur(1px); }
        75% { transform: translate3d(0.3%, 0.3%, 0) rotate(0.05deg) scale(1.005); filter: blur(0.3px); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); filter: blur(0px); }
      }

      @keyframes dimensional-shift {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
        16% { transform: translate3d(0.2%, -0.2%, 0) rotate(0.1deg) scale(1.005); }
        32% { transform: translate3d(-0.2%, 0.2%, 0) rotate(-0.1deg) scale(0.995); }
        48% { transform: translate3d(0.1%, 0.1%, 0) rotate(0.05deg) scale(1.002); }
        64% { transform: translate3d(-0.1%, -0.1%, 0) rotate(-0.05deg) scale(0.998); }
        80% { transform: translate3d(0.15%, 0%, 0) rotate(0.02deg) scale(1.001); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); }
      }

      @keyframes void-expansion {
        0% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.9; }
        50% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1.1); opacity: 0.6; }
        100% { transform: translate3d(0, 0, 0) rotate(0deg) scale(1); opacity: 0.9; }
      }

      @media (prefers-reduced-motion: reduce) {
        .sn-depth-layer {
          animation: none !important;
        }
      }
    `,document.head.appendChild(t),this.depthState.stylesInjected=!0}setupEventListeners(){this.boundScrollHandler&&window.addEventListener("scroll",this.boundScrollHandler,{passive:!0}),this.boundResizeHandler&&window.addEventListener("resize",this.boundResizeHandler,{passive:!0})}extractDepthColors(t){let e=["PRIMARY","VIBRANT","LIGHT_VIBRANT","DARK_VIBRANT","VIBRANT_NON_ALARMING","PROMINENT","SECONDARY","DESATURATED"],i=[],n=new Set;for(let r of e){let a=t[r];if(a&&!n.has(a)&&this.utils.hexToRgb(a)&&(i.push(a),n.add(a),i.length>=this.depthSettings.layerCount))break}for(;i.length<this.depthSettings.layerCount;){let r=i[0]||"#cba6f7",a=this.createColorVariation(r,i.length);i.push(a)}return i}createColorVariation(t,e){let i=this.utils.hexToRgb(t);if(!i)return t;let n=.8-e*.1,r=Math.round(i.r*n),a=Math.round(i.g*n),s=Math.round(i.b*n);return this.utils.rgbToHex(r,a,s)}async updateDepthLayers(t){if(!this.depthState.backgroundContainer)return;this.depthState.depthLayers.forEach(i=>{i.element.parentNode&&i.element.parentNode.removeChild(i.element)}),this.depthState.depthLayers.clear();let e=Object.keys(this.layerTemplates);for(let i=0;i<this.depthSettings.layerCount;i++){let n=(i+1)*(this.depthSettings.maxDepth/this.depthSettings.layerCount),r=e[i%e.length],a=this.layerTemplates[r],s=document.createElement("div");s.className="sn-depth-layer",s.id=`sn-depth-layer-${i}`;let o=n/this.depthSettings.maxDepth,l=1-o*this.depthSettings.parallaxStrength,m=1-o*this.depthSettings.depthFogIntensity,d=1+o*.2,h=o*3,p=this.createDepthGradient(a.baseGradient,t,i);s.style.cssText=`
        background: ${p};
        transform: translate3d(0, 0, ${-n}px) scale(${d});
        opacity: ${m};
        filter: blur(${h}px);
        animation: ${a.animation} ${a.duration} ease-in-out infinite;
        animation-delay: ${i*.5}s;
      `;let b={id:`depth-layer-${i}`,element:s,depth:n,parallaxFactor:l,opacityRange:[m*.5,m],scaleRange:[d*.95,d*1.05],rotationSpeed:.01+i*.001,colorShift:i*30,blurAmount:h,animationPhase:i*Math.PI/4,enabled:!0,gradientColors:t.slice(i,i+4)};this.depthState.depthLayers.set(b.id,b),this.depthState.backgroundContainer.appendChild(s)}u?.debug?.log("DepthLayeredStrategy",`Updated ${this.depthState.depthLayers.size} depth layers with new colors`)}createDepthGradient(t,e,i){let n=e.length,r=i%n,a=(i+1)%n,s=(i+2)%n,o=(i+3)%n,m=.8-i/this.depthSettings.layerCount*.6,d=this.convertToRgba(e[r]||"#cba6f7",m),h=this.convertToRgba(e[a]||"#f5c2e7",m*.7),p=this.convertToRgba(e[s]||"#fab387",m*.5),b=this.convertToRgba(e[o]||"#a6e3a1",m*.3),v=this.convertToRgba("#1e1e2e",m*.9);return t.replace(/\{primary\}/g,d).replace(/\{secondary\}/g,h).replace(/\{tertiary\}/g,p).replace(/\{quaternary\}/g,b).replace(/\{base\}/g,v)}convertToRgba(t,e){let i=this.utils.hexToRgb(t);return i?`rgba(${i.r}, ${i.g}, ${i.b}, ${e})`:`rgba(203, 166, 247, ${e})`}startDepthAnimation(){this.depthState.lastAnimationTime=performance.now();let t=()=>{if(!this.depthState.isInitialized)return;let e=performance.now(),i=e-this.depthState.lastAnimationTime;if(i<33){this.depthState.animationFrameId=requestAnimationFrame(t);return}this.depthState.lastAnimationTime=e,this.updateDepthAnimations(i),this.updatePerformanceMetrics(),this.depthState.animationFrameId=requestAnimationFrame(t)};this.depthState.animationFrameId=requestAnimationFrame(t)}updateDepthAnimations(t){this.depthState.depthLayers.forEach(e=>{e.animationPhase+=e.rotationSpeed*t*.001;let i=Math.sin(e.animationPhase)*.05,r=parseFloat(e.element.style.opacity)+i;e.element.style.opacity=Math.max(0,Math.min(1,r)).toString()})}updateDepthWithMusicEnergy(t){let e=t*this.depthSettings.musicResponsiveness*.3;this.depthState.depthLayers.forEach(i=>{let n=i.opacityRange[0],r=i.opacityRange[1],a=n+e*(r-n);i.element.style.opacity=Math.max(0,Math.min(1,a)).toString()})}handleScroll(t){this.depthSettings.infiniteScrolling&&(this.depthState.scrollY=window.scrollY,this.depthState.scrollX=window.scrollX,this.updateParallaxEffects())}handleResize(t){this.updateLayerDimensions()}updateParallaxEffects(){this.depthState.depthLayers.forEach(t=>{let e=this.depthState.scrollY*t.parallaxFactor,i=this.depthState.scrollX*t.parallaxFactor*.5,r=t.element.style.transform.replace(/translate3d\([^)]*\)/,`translate3d(${i}px, ${e}px, ${-t.depth}px)`);t.element.style.transform=r})}updateLayerDimensions(){this.depthState.depthLayers.forEach(t=>{let i=1+t.depth/this.depthSettings.maxDepth*.2,r=t.element.style.transform.replace(/scale\([^)]*\)/,`scale(${i})`);t.element.style.transform=r})}updatePerformanceMetrics(){this.performanceMetrics.totalLayers=this.depthState.depthLayers.size,this.performanceMetrics.visibleLayers=Array.from(this.depthState.depthLayers.values()).filter(t=>parseFloat(t.element.style.opacity)>.01).length,this.performanceMetrics.averageDepth=Array.from(this.depthState.depthLayers.values()).reduce((t,e)=>t+e.depth,0)/this.depthState.depthLayers.size,this.performanceMetrics.parallaxRange=this.depthSettings.parallaxStrength,this.performanceMetrics.renderTime=performance.now()-this.depthState.lastAnimationTime,this.cssController&&(this.cssController.queueCSSVariableUpdate("--sn-depth-layers-total",this.performanceMetrics.totalLayers.toString()),this.cssController.queueCSSVariableUpdate("--sn-depth-layers-visible",this.performanceMetrics.visibleLayers.toString()))}selectPrimaryColor(t){let e=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let i of e){let n=t[i];if(n&&this.utils.hexToRgb(n))return n}return null}convertToRgbString(t){let e=this.utils.hexToRgb(t);return e?`${e.r},${e.g},${e.b}`:"203,166,247"}updateConfig(t){this.depthSettings={...this.depthSettings,...t},t.qualityLevel&&this.adjustQualitySettings(),u?.debug?.log("DepthLayeredStrategy","Configuration updated:",t)}async healthCheck(){let t=Date.now()-this.depthState.lastUpdateTime<3e4;return{healthy:this.depthState.isInitialized&&this.depthSettings.enabled,canProcess:this.canProcess({}),issues:this.depthState.isInitialized?this.depthSettings.enabled?[]:["Depth layers disabled in settings"]:["Depth system not initialized"],metrics:{isInitialized:this.depthState.isInitialized,depthEnabled:this.depthSettings.enabled,layerCount:this.depthState.depthLayers.size,qualityLevel:this.depthSettings.qualityLevel,parallaxStrength:this.depthSettings.parallaxStrength,hasRecentUpdate:t,animationActive:this.depthState.animationFrameId!==null,performanceMetrics:this.performanceMetrics}}}destroy(){this.depthState.animationFrameId&&(cancelAnimationFrame(this.depthState.animationFrameId),this.depthState.animationFrameId=null),this.boundScrollHandler&&(window.removeEventListener("scroll",this.boundScrollHandler),this.boundScrollHandler=null),this.boundResizeHandler&&(window.removeEventListener("resize",this.boundResizeHandler),this.boundResizeHandler=null),this.depthState.depthLayers.forEach(t=>{t.element.parentNode&&t.element.parentNode.removeChild(t.element)}),this.depthState.depthLayers.clear(),this.depthState.backgroundContainer&&this.depthState.backgroundContainer.parentNode&&(this.depthState.backgroundContainer.parentNode.removeChild(this.depthState.backgroundContainer),this.depthState.backgroundContainer=null),this.depthState.isInitialized=!1,this.depthState.containerElement=null,u?.debug?.log("DepthLayeredStrategy","Depth layered strategy destroyed")}}});var ri,Da=y(()=>{"use strict";U();N();A();ye();ne();bt();K();ri=class{constructor(t){this.utils=I;this.config=w;this.dynamicColorState=this.getInitialColorState();this.integrationConfig={accentUpdateEnabled:!0,baseTransformationEnabled:!0,consciousnessIntegrationEnabled:!0,oklabEnhancementEnabled:!0,smoothTransitionDuration:800,energyResponseMultiplier:1.2,oklabPreset:"VIBRANT"};this.transitionTimer=0;this.lastTransitionStartTime=0;this.transitionFromAccent="";this.transitionToAccent="";this.cssController=t||T(),this.oklabProcessor=new M(this.config.enableDebug),this.initializeCurrentState(),u?.debug?.log("DynamicCatppuccinStrategy","Color strategy initialized with CSS coordinator and OKLAB processing")}getInitialColorState(){try{let t=j.getDefaultAccentColor(),e=j.getBrightnessAdjustedBaseColor();return{currentAccentHex:t.hex,currentAccentRgb:t.rgb,baseBackgroundHex:e.hex,baseBackgroundRgb:e.rgb,lastUpdateTime:0,musicEnergy:.5,transitionInProgress:!1}}catch(t){return console.warn("[DynamicCatppuccinStrategy] Failed to get initial colors, using fallback:",t),{currentAccentHex:"#7c3aed",currentAccentRgb:"124,58,237",baseBackgroundHex:"#0d1117",baseBackgroundRgb:"13,17,23",lastUpdateTime:0,musicEnergy:.5,transitionInProgress:!1}}}getStrategyName(){return"dynamic-catppuccin"}canProcess(t){return this.checkDynamicAccentEnabled()}getEstimatedProcessingTime(t){return 5}async processColors(t){let e=performance.now();try{let i=this.selectBestAccentColor(t.rawColors);if(!i)throw new Error("No suitable accent color found in extracted colors");let n=i,r=this.utils.hexToRgb(i),a=null;if(this.integrationConfig.oklabEnhancementEnabled){let l=M.getPreset(this.integrationConfig.oklabPreset);a=this.oklabProcessor.processColor(i,l),n=a.enhancedHex,r=a.enhancedRgb,u?.debug?.log("DynamicCatppuccinStrategy","OKLAB color enhancement applied:",{original:i,enhanced:n,preset:l.name,processingTime:`${a.processingTime.toFixed(2)}ms`})}await this.applyColorFacade(n,t.rawColors,a),this.dynamicColorState.currentAccentHex=n,r&&(this.dynamicColorState.currentAccentRgb=`${r.r},${r.g},${r.b}`),this.dynamicColorState.lastUpdateTime=Date.now(),t.musicData?.energy!==void 0&&(this.dynamicColorState.musicEnergy=t.musicData.energy,await this.updateConsciousnessWithMusicEnergy(t.musicData.energy));let s=performance.now()-e,o={processedColors:{accent:n,primary:n,originalAccent:i,...t.rawColors},accentHex:n,accentRgb:this.dynamicColorState.currentAccentRgb,metadata:{strategy:this.getStrategyName(),processingTime:s,cacheKey:`dynamic-catppuccin-${t.trackUri}`,harmonicIntensity:this.integrationConfig.energyResponseMultiplier,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,oklabPreset:this.integrationConfig.oklabPreset,...a&&{oklabMetadata:{originalHex:a.originalHex,enhancedHex:a.enhancedHex,shadowHex:a.shadowHex,oklabProcessingTime:a.processingTime}}},context:t};return u?.debug?.log("DynamicCatppuccinStrategy","Color processing completed",{originalAccent:i,processedAccent:n,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,processingTime:s,trackUri:t.trackUri}),o}catch(i){let n=performance.now()-e;return u?.debug?.error("DynamicCatppuccinStrategy","Color processing failed:",i),{processedColors:t.rawColors,accentHex:this.dynamicColorState.currentAccentHex,accentRgb:this.dynamicColorState.currentAccentRgb,metadata:{strategy:this.getStrategyName(),processingTime:n,error:i instanceof Error?i.message:"Unknown error"},context:t}}}checkDynamicAccentEnabled(){try{let t=x.get("catppuccin-accentColor"),e=String(t)==="dynamic";return this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinStrategy",`Accent setting: ${t}, Dynamic: ${e}`),e}catch(t){return u?.debug?.error("DynamicCatppuccinStrategy","Error checking dynamic accent setting:",t),!1}}initializeCurrentState(){let t=document.documentElement,e=getComputedStyle(t),i=e.getPropertyValue("--spice-accent").trim()||e.getPropertyValue("--sn-color-accent-hex").trim();if(i){this.dynamicColorState.currentAccentHex=i;let a=this.utils.hexToRgb(i);a&&(this.dynamicColorState.currentAccentRgb=`${a.r},${a.g},${a.b}`)}let n=e.getPropertyValue("--spice-base").trim()||"#1e1e2e";this.dynamicColorState.baseBackgroundHex=n;let r=this.utils.hexToRgb(n);r&&(this.dynamicColorState.baseBackgroundRgb=`${r.r},${r.g},${r.b}`),this.dynamicColorState.lastUpdateTime=Date.now(),u?.debug?.log("DynamicCatppuccinStrategy","Current state initialized:",{accent:this.dynamicColorState.currentAccentHex,base:this.dynamicColorState.baseBackgroundHex})}selectBestAccentColor(t){let e=["VIBRANT_NON_ALARMING","VIBRANT","LIGHT_VIBRANT","PROMINENT","PRIMARY","DARK_VIBRANT"];for(let i of e){let n=t[i];if(n&&this.utils.hexToRgb(n))return n}return null}async applyColorFacade(t,e,i){let n=this.utils.hexToRgb(t);if(!n)return;let r=`${n.r},${n.g},${n.b}`,a={"--sn-dynamic-accent-hex":t,"--sn-dynamic-accent-rgb":r,"--sn-dynamic-primary-hex":t,"--sn-dynamic-primary-rgb":r,"--spice-accent":t,"--spice-button":t,"--spice-button-active":t,"--spice-rgb-accent":r,"--spice-rgb-button":r,"--sn-color-extracted-primary-rgb":r,"--sn-color-extracted-vibrant-rgb":r,"--sn-color-extracted-dominant-rgb":r};if(i&&this.integrationConfig.oklabEnhancementEnabled){let o=this.oklabProcessor.generateCSSVariables(i,"sn-oklab-accent");Object.assign(a,{...o,"--sn-dynamic-shadow-hex":i.shadowHex,"--sn-dynamic-shadow-rgb":`${i.shadowRgb.r},${i.shadowRgb.g},${i.shadowRgb.b}`,"--sn-accent-oklch-l":i.oklchEnhanced.L.toFixed(3),"--sn-accent-oklch-c":i.oklchEnhanced.C.toFixed(3),"--sn-accent-oklch-h":i.oklchEnhanced.H.toFixed(1)}),u?.debug?.log("DynamicCatppuccinStrategy","Added OKLAB-enhanced CSS variables:",{oklabVarsCount:Object.keys(o).length,enhancedHex:i.enhancedHex,shadowHex:i.shadowHex})}this.cssController&&this.cssController.updateVariables(a,"high","core-spicetify-facade");let s=e.PRIMARY||e.VIBRANT;s&&await this.updateLivingBaseBackground(s),this.integrationConfig.consciousnessIntegrationEnabled&&await this.updateConsciousnessWithAccent(t,r),u?.debug?.log("DynamicCatppuccinStrategy",`Applied coordinated color facade - Spicetify: ${t}, Consciousness extensions updated`,{oklabProcessing:!!i,variableCount:Object.keys(a).length})}async updateLivingBaseBackground(t){let e=this.utils.hexToRgb(t);if(!e)return;let i=`${e.r},${e.g},${e.b}`,n=`
      linear-gradient(135deg,
        var(--spice-base) 0%,
        rgba(${i}, 0.08) 30%,
        var(--spice-base) 70%
      ),
      var(--spice-base)
    `,r={"--sn-dynamic-secondary-hex":t,"--sn-dynamic-secondary-rgb":i,"--sn-color-extracted-secondary-rgb":i,"--sn-color-harmony-complementary-rgb":i,"--living-base-gradient":n,"--consciousness-base-gradient":n};this.cssController&&this.cssController.updateVariables(r,"normal","living-base-background"),u?.debug?.log("DynamicCatppuccinStrategy",`Coordinated living base facade updated - Primary: ${t}, preserving --spice-base`)}async updateConsciousnessWithAccent(t,e){let i={"--organic-holographic-rgb":e,"--holographic-scanline-rgb":e,"--consciousness-intensity":`calc(0.5 + var(--musical-sync-intensity) * ${this.integrationConfig.energyResponseMultiplier})`};this.cssController&&this.cssController.updateVariables(i,"normal","consciousness-accent-integration")}async updateConsciousnessWithMusicEnergy(t){let e=t*this.integrationConfig.energyResponseMultiplier,n=Math.max(.1,Math.min(1,.5+e*.3)),r={"--musical-sync-intensity":e.toString(),"--holographic-music-flicker-intensity":e.toString(),"--consciousness-intensity":n.toString()};this.cssController&&(this.cssController.updateVariables(r,"high","consciousness-music-energy"),this.cssController.updateConsciousnessIntensity(parseFloat(n.toString()),"DynamicCatppuccinStrategy",e))}getDynamicColorState(){return{...this.dynamicColorState}}updateConfig(t){this.integrationConfig={...this.integrationConfig,...t},("oklabEnhancementEnabled"in t||"oklabPreset"in t)&&(this.oklabProcessor=new M(this.config.enableDebug)),u?.debug?.log("DynamicCatppuccinStrategy","Configuration updated:",{...t,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,oklabPreset:this.integrationConfig.oklabPreset})}async healthCheck(){let t=this.checkDynamicAccentEnabled(),e=Date.now()-this.dynamicColorState.lastUpdateTime<3e4;return{healthy:t,canProcess:t,issues:t?[]:["Dynamic accent not enabled in settings"],metrics:{dynamicAccentEnabled:t,currentAccent:this.dynamicColorState.currentAccentHex,lastUpdateAge:Date.now()-this.dynamicColorState.lastUpdateTime,hasRecentUpdate:e,transitionInProgress:this.dynamicColorState.transitionInProgress,musicEnergy:this.dynamicColorState.musicEnergy,oklabProcessing:this.integrationConfig.oklabEnhancementEnabled,oklabPreset:this.integrationConfig.oklabPreset,consciousnessIntegration:this.integrationConfig.consciousnessIntegrationEnabled}}}destroy(){this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=0),this.dynamicColorState.transitionInProgress=!1,u?.debug?.log("DynamicCatppuccinStrategy","Dynamic Catppuccin strategy destroyed")}}});var ka={};ie(ka,{LivingGradientStrategy:()=>ft});var ft,In=y(()=>{"use strict";U();N();D();de();A();ne();K();ge();ft=class extends Q{constructor(e=w,i=I,n=null,r=null,a,s){super(e,i,n,r,null);this.utils=I;this.config=w;this.livingBaseState={currentBaseHex:"#1e1e2e",currentBaseRgb:"30,30,46",currentPrimaryHex:"#cba6f7",currentPrimaryRgb:"203,166,247",consciousnessIntensity:.5,musicEnergy:.5,lastUpdateTime:0,webglIntegrationActive:!1,oklabGradientStops:[]};this.gradientConfig={baseTransformationEnabled:!0,webglIntegrationEnabled:!0,breathingAnimationEnabled:!0,consciousnessLayerOpacity:.08,organicFlowIntensity:1.2,musicResponsiveness:1,oklabInterpolationEnabled:!0,oklabPreset:"STANDARD",gradientSmoothness:.8,animationThrottleFps:30,enablePerformanceBudget:!0,maxFrameTimeMs:16};this.cssAnimationManager=null;this.oklabCache=new Map;this.gradientCache=new Map;this.cacheValidityMs=5e3;this.lastCacheCleanup=0;this.musicEventDebounceTimers={musicState:0,harmonizedColors:0,webglState:0,consciousnessIntensity:0};this.eventDebounceMs=100;this.cssController=a||T(),this.oklabProcessor=new M(this.config.enableDebug),this.deviceDetector=new _,this.cssAnimationManager=s,this.initializeBaseState(),this.applyDeviceAwareSettings().catch(o=>{u?.debug?.warn("LivingGradientStrategy","Failed to apply device-aware settings:",o)}),u?.debug?.log("LivingGradientStrategy","Living gradient strategy initialized with OKLAB interpolation and device-aware performance")}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{this.setupConsciousnessListeners(),this.setupWebGLIntegrationListeners(),this.initializeBaseState(),this.initializeConsciousnessBreathing(),await this.applyLivingConsciousnessBase(),u?.debug?.log("LivingGradientStrategy","Living gradient system awakened with visual system lifecycle")}catch(e){u?.debug?.error("LivingGradientStrategy","Failed to initialize living gradient system:",e)}}setupConsciousnessListeners(){typeof g<"u"&&g.subscribe("colors:harmonized",e=>{e&&e.processedColors&&this.handleHarmonizedColorUpdate(e.processedColors)},"LivingGradientStrategy"),document.addEventListener("music-state-change",e=>{let i=e;i.detail&&this.handleMusicStateChange(i.detail)}),document.addEventListener("consciousness-intensity-change",e=>{let i=e;i.detail&&typeof i.detail.intensity=="number"&&this.updateConsciousnessIntensity(i.detail.intensity)}),u?.debug?.log("LivingGradientStrategy","Consciousness listeners established")}setupWebGLIntegrationListeners(){document.addEventListener("webgl-state-change",e=>{let i=e;i.detail&&this.handleWebGLStateChange(i.detail)}),document.addEventListener("webgl-gradient-update",e=>{let i=e;i.detail&&this.coordinateWithWebGLGradient(i.detail)}),u?.debug?.log("LivingGradientStrategy","WebGL integration listeners established")}handleHarmonizedColorUpdate(e){this.debouncedEventHandler("harmonizedColors",()=>{let i=e.VIBRANT||e.PRIMARY||e.PROMINENT;if(i&&i!==this.livingBaseState.currentPrimaryHex){this.livingBaseState.currentPrimaryHex=i;let n=this.utils.hexToRgb(i);n&&(this.livingBaseState.currentPrimaryRgb=`${n.r},${n.g},${n.b}`),this.updateLivingConsciousnessBase(),this.triggerConsciousnessBreathing(),u?.debug?.log("LivingGradientStrategy","Living base updated with harmonized colors:",i)}})}handleMusicStateChange(e){this.debouncedEventHandler("musicState",()=>{if(e.energy!==void 0){this.livingBaseState.musicEnergy=e.energy;let i=.5,n=e.energy*this.gradientConfig.musicResponsiveness;this.livingBaseState.consciousnessIntensity=Math.max(.1,Math.min(1,i+n*.3)),this.updateMusicResponsiveVariables()}})}handleWebGLStateChange(e){this.debouncedEventHandler("webglState",()=>{e.enabled!==void 0&&(this.livingBaseState.webglIntegrationActive=e.enabled,this.coordinateWithWebGLSystem(e.enabled),u?.debug?.log("LivingGradientStrategy",`WebGL integration ${e.enabled?"activated":"deactivated"}`))})}updateConsciousnessIntensity(e){this.debouncedEventHandler("consciousnessIntensity",()=>{this.livingBaseState.consciousnessIntensity=Math.max(0,Math.min(1,e)),this.updateConsciousnessVariables()})}debouncedEventHandler(e,i){let n=performance.now();n-this.musicEventDebounceTimers[e]>=this.eventDebounceMs&&(i(),this.musicEventDebounceTimers[e]=n)}initializeConsciousnessBreathing(){if(this.gradientConfig.breathingAnimationEnabled){if(!this.cssAnimationManager){u?.debug?.warn("LivingGradientStrategy","CSSAnimationManager not available, falling back to basic consciousness");return}this.triggerConsciousnessBreathing(),u?.debug?.log("LivingGradientStrategy","CSS-first consciousness breathing initialized")}}triggerConsciousnessBreathing(){if(!this.cssAnimationManager||!this.gradientConfig.breathingAnimationEnabled)return;let e=document.querySelectorAll(".Root__main-view::before, .Root__main-view, [data-consciousness-breathing]");if(e.length===0){let i=document.querySelector(".Root__main-view")||document.body;i&&(i.setAttribute("data-consciousness-breathing","true"),this.cssAnimationManager.triggerConsciousnessBreathing([i],this.livingBaseState.musicEnergy,120))}else this.cssAnimationManager.triggerConsciousnessBreathing(e,this.livingBaseState.musicEnergy,120);u?.debug?.log("LivingGradientStrategy",`CSS-first consciousness breathing triggered for ${e.length} elements`)}async applyDeviceAwareSettings(){if(!this.deviceDetector.isInitialized)try{await this.deviceDetector.initialize()}catch(n){u?.debug?.warn("LivingGradientStrategy","Device detection failed, using default settings:",n);return}let e=this.deviceDetector.getCapabilities();if(!e){u?.debug?.warn("LivingGradientStrategy","No device capabilities available, using default settings");return}let i=e.overall;switch(i){case"high":this.gradientConfig.animationThrottleFps=30,this.gradientConfig.maxFrameTimeMs=16,this.gradientConfig.enablePerformanceBudget=!0;break;case"medium":this.gradientConfig.animationThrottleFps=20,this.gradientConfig.maxFrameTimeMs=20,this.gradientConfig.enablePerformanceBudget=!0;break;case"low":this.gradientConfig.animationThrottleFps=15,this.gradientConfig.maxFrameTimeMs=33,this.gradientConfig.enablePerformanceBudget=!0,this.gradientConfig.consciousnessLayerOpacity*=.7,this.gradientConfig.organicFlowIntensity*=.8,this.gradientConfig.oklabInterpolationEnabled=!1;break;default:this.gradientConfig.animationThrottleFps=20,this.gradientConfig.maxFrameTimeMs=20;break}e.gpu.supportsWebGL||(this.gradientConfig.webglIntegrationEnabled=!1),e.memory.level==="low"&&(this.cacheValidityMs=2e3),e.cpu.cores<=2&&(this.gradientConfig.animationThrottleFps=Math.min(this.gradientConfig.animationThrottleFps,15)),e.display.reducedMotion&&(this.gradientConfig.breathingAnimationEnabled=!1,u?.debug?.log("LivingGradientStrategy","Breathing animation disabled due to reduced motion preference")),u?.debug?.log("LivingGradientStrategy",`Device-aware settings applied for ${i}: ${this.gradientConfig.animationThrottleFps}fps, CSS-first breathing coordination`)}getStrategyName(){return"living-gradient"}canProcess(e){return this.gradientConfig.baseTransformationEnabled}getEstimatedProcessingTime(e){return 8}async processColors(e){let i=performance.now();try{let n=this.selectPrimaryColor(e.rawColors),r=this.selectSecondaryColor(e.rawColors);if(!n)throw new Error("No suitable primary color found for living gradient");let a=n,s=r,o=[];if(this.gradientConfig.oklabInterpolationEnabled&&n){let d=M.getPreset(this.gradientConfig.oklabPreset);if(a=this.oklabProcessor.processColor(n,d).enhancedHex,r){s=this.oklabProcessor.processColor(r,d).enhancedHex;let b=Math.ceil(5*this.gradientConfig.gradientSmoothness)+3;o=this.oklabProcessor.generateOKLABGradient(a,s,b,d)}else{let p=this.livingBaseState.currentBaseHex;o=this.oklabProcessor.generateOKLABGradient(a,p,5,d),s=o[o.length-1]?.enhancedHex||a}u?.debug?.log("LivingGradientStrategy","OKLAB gradient processing applied:",{originalPrimary:n,processedPrimary:a,originalSecondary:r,processedSecondary:s,gradientStops:o.length,preset:d.name})}await this.updateLivingBaseState(a,s,e,o),await this.applyLivingConsciousnessBase(),this.triggerConsciousnessBreathing(),await this.updateWebGLIntegration();let l=performance.now()-i,m={processedColors:{primary:a,secondary:s||a,originalPrimary:n,...r&&{originalSecondary:r},livingBase:this.livingBaseState.currentBaseHex,...e.rawColors},accentHex:a,accentRgb:this.livingBaseState.currentPrimaryRgb,metadata:{strategy:this.getStrategyName(),processingTime:l,cacheKey:`living-gradient-${e.trackUri}`,harmonicIntensity:this.gradientConfig.organicFlowIntensity,oklabInterpolation:this.gradientConfig.oklabInterpolationEnabled,oklabPreset:this.gradientConfig.oklabPreset,gradientStopCount:o.length,gradientSmoothness:this.gradientConfig.gradientSmoothness},context:e};return u?.debug?.log("LivingGradientStrategy","Living gradient processing completed",{originalPrimary:n,processedPrimary:a,originalSecondary:r,processedSecondary:s,oklabProcessing:this.gradientConfig.oklabInterpolationEnabled,gradientStops:o.length,processingTime:l,trackUri:e.trackUri}),m}catch(n){let r=performance.now()-i;return u?.debug?.error("LivingGradientStrategy","Living gradient processing failed:",n),{processedColors:e.rawColors,accentHex:this.livingBaseState.currentPrimaryHex,accentRgb:this.livingBaseState.currentPrimaryRgb,metadata:{strategy:this.getStrategyName(),processingTime:r,error:n instanceof Error?n.message:"Unknown error"},context:e}}}initializeBaseState(){let e=document.documentElement,i=getComputedStyle(e),n=i.getPropertyValue("--spice-base").trim()||"#1e1e2e";this.livingBaseState.currentBaseHex=n;let r=this.utils.hexToRgb(n);r&&(this.livingBaseState.currentBaseRgb=`${r.r},${r.g},${r.b}`);let a=i.getPropertyValue("--sn-bg-gradient-primary-rgb").trim();if(a){let s=a.split(",").map(o=>parseInt(o.trim()));s.length===3&&(this.livingBaseState.currentPrimaryRgb=a,this.livingBaseState.currentPrimaryHex=this.utils.rgbToHex(s[0],s[1],s[2]))}this.livingBaseState.lastUpdateTime=Date.now(),u?.debug?.log("LivingGradientStrategy","Base state initialized:",{base:this.livingBaseState.currentBaseHex,primary:this.livingBaseState.currentPrimaryHex})}selectPrimaryColor(e){let i=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let n of i){let r=e[n];if(r&&this.utils.hexToRgb(r))return r}return null}selectSecondaryColor(e){let i=["SECONDARY","DARK_VIBRANT","DESATURATED","LIGHT_VIBRANT"];for(let n of i){let r=e[n];if(r&&this.utils.hexToRgb(r))return r}return null}async updateLivingBaseState(e,i,n,r=[]){let a=this.utils.hexToRgb(e);if(a){if(this.livingBaseState.currentPrimaryHex=e,this.livingBaseState.currentPrimaryRgb=`${a.r},${a.g},${a.b}`,this.livingBaseState.oklabGradientStops=r,n.musicData?.energy!==void 0){this.livingBaseState.musicEnergy=n.musicData.energy;let s=this.gradientConfig.consciousnessLayerOpacity,o=1+n.musicData.energy*this.gradientConfig.musicResponsiveness;this.livingBaseState.consciousnessIntensity=Math.max(.05,Math.min(1,s*o))}this.livingBaseState.lastUpdateTime=Date.now()}}async applyLivingConsciousnessBase(){let e=this.createLivingGradient(this.livingBaseState.oklabGradientStops),n=performance.now()/4e3*Math.PI*2,r=1+Math.sin(n)*.2,a=this.livingBaseState.consciousnessIntensity*r,s=Math.sin(n*.7)*this.gradientConfig.organicFlowIntensity,o=Math.cos(n*.5)*this.gradientConfig.organicFlowIntensity,l=4e3,m=.5+this.livingBaseState.musicEnergy*1.5,d=l/m,h={"--living-base-gradient":e,"--consciousness-base-gradient":e,"--consciousness-layer-opacity":a.toString(),"--consciousness-flow-x":`${s}%`,"--consciousness-flow-y":`${o}%`,"--consciousness-breathing-duration":`${d}ms`};await this.cssController.batchSetVariables("LivingGradientStrategy",h,"high","living-consciousness-base"),u?.debug?.log("LivingGradientStrategy","Applied coordinated living consciousness base gradient")}createGradientCacheKey(e,i,n,r){let a=n.map((s,o)=>`${s.enhancedHex}-${o}`).join("|");return`${e}-${i}-${a}-${Math.floor(r*10)}`}cleanupCache(){let e=Date.now();e-this.lastCacheCleanup<1e4||(this.lastCacheCleanup=e,this.gradientCache.clear(),this.config.enableDebug&&u?.debug?.log("LivingGradientStrategy","Cache cleanup completed"))}createLivingGradient(e=[]){let i=this.livingBaseState.currentPrimaryRgb,n=this.livingBaseState.currentBaseRgb,a=performance.now()/4e3*Math.PI*2,s=this.createGradientCacheKey(i,n,e,a),o=this.gradientCache.get(s);if(o)return this.cleanupCache(),o;let l=this.generateLivingGradient(i,n,e);return this.gradientCache.set(s,l),l}generateLivingGradient(e,i,n){return this.gradientConfig.oklabInterpolationEnabled&&n.length>0?`
        radial-gradient(
          ellipse at calc(50% + var(--consciousness-flow-x)) calc(50% + var(--consciousness-flow-y)),
          ${n.map((a,s)=>{let o=s/(n.length-1)*100,l=`${a.enhancedRgb.r},${a.enhancedRgb.g},${a.enhancedRgb.b}`,m=.6*(1-s/n.length)+.1;return`rgba(${l}, calc(var(--consciousness-layer-opacity) * ${m})) ${o}%`}).join(", ")}
        ),
        linear-gradient(
          135deg,
          rgba(${n[0]?.enhancedRgb.r||e.split(",")[0]},${n[0]?.enhancedRgb.g||e.split(",")[1]},${n[0]?.enhancedRgb.b||e.split(",")[2]}, calc(var(--consciousness-layer-opacity) * 0.4)) 0%,
          var(--spice-base) 50%,
          rgba(${n[n.length-1]?.enhancedRgb.r||e.split(",")[0]},${n[n.length-1]?.enhancedRgb.g||e.split(",")[1]},${n[n.length-1]?.enhancedRgb.b||e.split(",")[2]}, calc(var(--consciousness-layer-opacity) * 0.2)) 100%
        ),
        var(--spice-base)
      `:`
      radial-gradient(
        ellipse at calc(50% + var(--consciousness-flow-x)) calc(50% + var(--consciousness-flow-y)),
        rgba(${e}, calc(var(--consciousness-layer-opacity) * 0.6)) 0%,
        rgba(${e}, calc(var(--consciousness-layer-opacity) * 0.3)) 30%,
        rgba(${i}, calc(var(--consciousness-layer-opacity) * 0.1)) 60%,
        var(--spice-base) 100%
      ),
      linear-gradient(
        135deg,
        rgba(${e}, calc(var(--consciousness-layer-opacity) * 0.4)) 0%,
        var(--spice-base) 50%,
        rgba(${e}, calc(var(--consciousness-layer-opacity) * 0.2)) 100%
      ),
      var(--spice-base)
    `}updateBreathingAnimation(){this.triggerConsciousnessBreathing()}startBreathingAnimation(){this.triggerConsciousnessBreathing(),u?.debug?.log("LivingGradientStrategy","CSS-first consciousness breathing started - 90%+ JavaScript overhead eliminated")}scheduleDebouncedCssUpdate(){u?.debug?.log("LivingGradientStrategy","Debounced CSS updates eliminated - using CSS-first breathing")}async updateWebGLIntegration(){if(!this.gradientConfig.webglIntegrationEnabled)return;let e={"--sn-bg-gradient-primary-rgb":this.livingBaseState.currentPrimaryRgb,"--sn-webgl-living-gradient-sync":"1","--sn-gradient-consciousness-level":this.livingBaseState.consciousnessIntensity.toString()};await this.cssController.batchSetVariables("LivingGradientStrategy",e,"high","webgl-living-gradient-integration"),this.livingBaseState.webglIntegrationActive=!0,u?.debug?.log("LivingGradientStrategy","WebGL integration updated")}getLivingBaseState(){return{...this.livingBaseState}}updateLivingConsciousnessBase(){this.applyLivingConsciousnessBase().catch(i=>{u?.debug?.error("LivingGradientStrategy","Failed to update living consciousness base:",i)});let e=new CustomEvent("living-base-update",{detail:{baseHex:this.livingBaseState.currentBaseHex,primaryHex:this.livingBaseState.currentPrimaryHex,consciousnessIntensity:this.livingBaseState.consciousnessIntensity,timestamp:Date.now()}});document.dispatchEvent(e)}updateMusicResponsiveVariables(){let e={"--consciousness-music-energy":this.livingBaseState.musicEnergy.toString(),"--consciousness-music-intensity":this.livingBaseState.consciousnessIntensity.toString()};this.cssController.batchSetVariables("LivingGradientStrategy",e,3,"music-responsive").catch(i=>{u?.debug?.error("LivingGradientStrategy","Failed to update music responsive variables:",i)})}updateConsciousnessVariables(){let e={"--consciousness-intensity-global":this.livingBaseState.consciousnessIntensity.toString(),"--consciousness-layer-opacity":(this.gradientConfig.consciousnessLayerOpacity*this.livingBaseState.consciousnessIntensity).toString()};this.cssController.batchSetVariables("LivingGradientStrategy",e,3,"consciousness-vars").catch(i=>{u?.debug?.error("LivingGradientStrategy","Failed to update consciousness variables:",i)})}coordinateWithWebGLSystem(e){let i=e?{"--consciousness-webgl-coordination":"0.7","--consciousness-css-fallback":"0.3"}:{"--consciousness-webgl-coordination":"0","--consciousness-css-fallback":"1.0"};this.cssController.batchSetVariables("LivingGradientStrategy",i,"high","webgl-coordination").catch(n=>{u?.debug?.error("LivingGradientStrategy","Failed to coordinate with WebGL system:",n)}),u?.debug?.log("LivingGradientStrategy",`WebGL coordination ${e?"enabled":"disabled"}`)}coordinateWithWebGLGradient(e){this.gradientConfig.webglIntegrationEnabled&&(e.flowState&&this.updateFlowStateFromWebGL(e.flowState),e.colorState&&this.updateColorStateFromWebGL(e.colorState))}updateFlowStateFromWebGL(e){let i={};e.flowX!==void 0&&(i["--consciousness-webgl-flow-x"]=`${e.flowX}%`),e.flowY!==void 0&&(i["--consciousness-webgl-flow-y"]=`${e.flowY}%`),e.flowScale!==void 0&&(i["--consciousness-webgl-scale"]=e.flowScale.toString()),Object.keys(i).length>0&&this.cssController.batchSetVariables("LivingGradientStrategy",i,3,"webgl-flow").catch(n=>{u?.debug?.error("LivingGradientStrategy","Failed to update WebGL flow state:",n)})}updateColorStateFromWebGL(e){e.primaryColor&&(this.livingBaseState.currentPrimaryRgb=e.primaryColor,this.updateLivingConsciousnessBase())}async healthCheck(){let e=await this.getStrategyHealthCheck();return{healthy:e.healthy&&this.isActive,canProcess:e.canProcess,issues:e.issues||[],metrics:{...e.metrics,systemType:"consolidated-living-gradient",isVisualSystem:!0,isColorProcessor:!0,isActive:this.isActive,initialized:this.initialized}}}async getStrategyHealthCheck(){let e=Date.now()-this.livingBaseState.lastUpdateTime<3e4;return{healthy:this.gradientConfig.baseTransformationEnabled,canProcess:this.gradientConfig.baseTransformationEnabled,issues:this.gradientConfig.baseTransformationEnabled?[]:["Base transformation disabled in configuration"],metrics:{baseTransformationEnabled:this.gradientConfig.baseTransformationEnabled,breathingAnimationEnabled:this.gradientConfig.breathingAnimationEnabled,webglIntegrationActive:this.livingBaseState.webglIntegrationActive,consciousnessIntensity:this.livingBaseState.consciousnessIntensity,musicEnergy:this.livingBaseState.musicEnergy,hasRecentUpdate:e,cssFirstBreathing:!0,oklabInterpolation:this.gradientConfig.oklabInterpolationEnabled,oklabPreset:this.gradientConfig.oklabPreset,gradientSmoothness:this.gradientConfig.gradientSmoothness,oklabGradientStops:this.livingBaseState.oklabGradientStops.length}}}destroy(){this.cssAnimationManager&&this.cssAnimationManager.stopConsciousnessBreathing(),this.oklabCache.clear(),this.gradientCache.clear(),super.destroy(),u?.debug?.log("LivingGradientStrategy","Consolidated living gradient system destroyed with complete cleanup")}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),u?.debug?.log("LivingGradientStrategy","Living gradient system cleaned up")}updateConfig(e){this.gradientConfig={...this.gradientConfig,...e},("oklabInterpolationEnabled"in e||"oklabPreset"in e)&&(this.oklabProcessor=new M(this.config.enableDebug)),u?.debug?.log("LivingGradientStrategy","Configuration updated:",{...e,oklabInterpolation:this.gradientConfig.oklabInterpolationEnabled,oklabPreset:this.gradientConfig.oklabPreset,gradientSmoothness:this.gradientConfig.gradientSmoothness})}stopBreathingAnimation(){this.cssAnimationManager&&this.cssAnimationManager.stopConsciousnessBreathing(),u?.debug?.log("LivingGradientStrategy","CSS-first consciousness breathing stopped")}}});var Rn={};ie(Rn,{DEFAULT_VERTEX_SHADER:()=>St,ShaderLoader:()=>te,createGradientTexture:()=>le});function le(c,t,e=256){try{if(!c)return u?.debug?.error("ShaderLoader","WebGL context is null or undefined"),null;if(!t||t.length===0)return u?.debug?.error("ShaderLoader","Invalid or empty color stops array"),null;if(e<=0||e>8192)return u?.debug?.error("ShaderLoader",`Invalid texture width: ${e}`),null;let i=c.getError();if(i!==c.NO_ERROR&&u?.debug?.warn("ShaderLoader",`WebGL context has pending error: ${i}`),c.isContextLost())return u?.debug?.error("ShaderLoader","WebGL context is lost"),null;let n=document.createElement("canvas");if(!n)return u?.debug?.error("ShaderLoader","Failed to create canvas element"),null;n.width=e,n.height=1;let r=n.getContext("2d",{willReadFrequently:!1});if(!r)return u?.debug?.error("ShaderLoader","Failed to get 2D canvas context"),null;let a=t.filter(l=>typeof l.r!="number"||typeof l.g!="number"||typeof l.b!="number"||typeof l.a!="number"||typeof l.position!="number"?(u?.debug?.warn("ShaderLoader","Invalid color stop found, skipping"),!1):((l.position<0||l.position>1)&&(u?.debug?.warn("ShaderLoader",`Invalid color stop position: ${l.position}, clamping`),l.position=Math.max(0,Math.min(1,l.position))),!0));if(a.length===0)return u?.debug?.error("ShaderLoader","No valid color stops after validation"),null;a.sort((l,m)=>l.position-m.position);let s=r.createLinearGradient(0,0,e,0);if(!s)return u?.debug?.error("ShaderLoader","Failed to create linear gradient"),null;try{a.forEach((l,m)=>{let d=Math.max(0,Math.min(255,Math.round(l.r*255))),h=Math.max(0,Math.min(255,Math.round(l.g*255))),p=Math.max(0,Math.min(255,Math.round(l.b*255))),b=Math.max(0,Math.min(1,l.a)),v=`rgba(${d}, ${h}, ${p}, ${b})`;s.addColorStop(l.position,v)})}catch(l){return u?.debug?.error("ShaderLoader","Failed to add color stops to gradient:",l),null}try{r.fillStyle=s,r.fillRect(0,0,e,1)}catch(l){return u?.debug?.error("ShaderLoader","Failed to fill canvas with gradient:",l),null}let o=c.createTexture();if(!o)return u?.debug?.error("ShaderLoader","Failed to create WebGL texture - gl.createTexture() returned null"),null;try{c.bindTexture(c.TEXTURE_2D,o);let l=c.getError();if(l!==c.NO_ERROR)return u?.debug?.error("ShaderLoader",`WebGL error after texture binding: ${l}`),c.deleteTexture(o),null;c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,n);let m=c.getError();if(m!==c.NO_ERROR)return u?.debug?.error("ShaderLoader",`WebGL error after texture upload: ${m}`),c.deleteTexture(o),null;c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);let d=c.getError();return d!==c.NO_ERROR?(u?.debug?.error("ShaderLoader",`WebGL error after setting texture parameters: ${d}`),c.deleteTexture(o),null):(c.bindTexture(c.TEXTURE_2D,null),u?.debug?.log("ShaderLoader",`Gradient texture created successfully: ${e}x1, ${a.length} stops`),o)}catch(l){return u?.debug?.error("ShaderLoader","Exception during WebGL texture operations:",l),o&&c.deleteTexture(o),null}}catch(i){return u?.debug?.error("ShaderLoader",`Gradient texture creation failed: ${i instanceof Error?i.message:"Unknown error"}`),null}}var te,St,vt=y(()=>{"use strict";A();te=class{static loadFragment(t,e,i){let n=i||this.hashSource(e),r=this.getContextCache(t);if(r[n])return r[n];try{let a=this.compileShader(t,t.FRAGMENT_SHADER,e);return a&&(r[n]=a,u?.debug?.log("ShaderLoader",`Fragment shader compiled: ${n.substring(0,8)}...`)),a}catch(a){return u?.debug?.error("ShaderLoader",`Fragment shader compilation failed: ${a}`),null}}static loadVertex(t,e,i){let n=i||this.hashSource(e),r=this.getContextCache(t);if(r[n])return r[n];try{let a=this.compileShader(t,t.VERTEX_SHADER,e);return a&&(r[n]=a,u?.debug?.log("ShaderLoader",`Vertex shader compiled: ${n.substring(0,8)}...`)),a}catch(a){return u?.debug?.error("ShaderLoader",`Vertex shader compilation failed: ${a}`),null}}static createProgram(t,e,i){try{let n=t.createProgram();if(!n)return null;if(t.attachShader(n,e),t.attachShader(n,i),t.linkProgram(n),!t.getProgramParameter(n,t.LINK_STATUS)){let r=t.getProgramInfoLog(n);throw t.deleteProgram(n),new Error(`Program linking failed: ${r}`)}return n}catch(n){return u?.debug?.error("ShaderLoader",`Program creation failed: ${n}`),null}}static clearCache(t){let e=this.cache.get(t);e&&(Object.values(e).forEach(i=>{t.deleteShader(i)}),this.cache.delete(t))}static clearAllCaches(){this.cache.clear()}static compileShader(t,e,i){let n=t.createShader(e);if(!n)return null;if(t.shaderSource(n,i),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){let r=t.getShaderInfoLog(n);throw t.deleteShader(n),new Error(`Shader compilation failed: ${r}`)}return n}static clearContextCache(t){if(this.cache.has(t)){let e=this.cache.get(t);Object.values(e).forEach(i=>{if(i&&t&&!t.isContextLost())try{t.deleteShader(i)}catch{}}),this.cache.set(t,{}),u?.debug?.log("ShaderLoader","Context cache cleared due to WebGL context loss/restore")}}static getContextCache(t){return this.cache.has(t)||this.cache.set(t,{}),this.cache.get(t)}static hashSource(t){let e=0;for(let i=0;i<t.length;i++){let n=t.charCodeAt(i);e=(e<<5)-e+n,e=e&e}return e.toString(16)}};te.cache=new Map;St=`#version 300 es
precision mediump float;

in vec2 a_position;
out vec2 v_uv;

void main() {
  v_uv = a_position * 0.5 + 0.5;
  gl_Position = vec4(a_position, 0.0, 1.0);
}`});var mc,Ct,La=y(()=>{"use strict";U();N();de();A();ye();ne();bt();K();vt();mc=`#version 300 es
precision mediump float;

uniform float u_time;
uniform sampler2D u_gradientTex;
uniform vec2 u_resolution;
uniform float u_flowStrength;
uniform float u_noiseScale;

// Wave stack uniforms
uniform float u_waveY[2];
uniform float u_waveHeight[2];
uniform float u_waveOffset[2];
uniform float u_blurExp;
uniform float u_blurMax;

out vec4 fragColor;

// Simplex noise implementation
vec3 mod289(vec3 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec2 mod289(vec2 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec3 permute(vec3 x) {
  return mod289(((x*34.0)+1.0)*x);
}

float snoise(vec2 v) {
  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0
                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)
                     -0.577350269189626,  // -1.0 + 2.0 * C.x
                      0.024390243902439); // 1.0 / 41.0
  vec2 i  = floor(v + dot(v, C.yy) );
  vec2 x0 = v -   i + dot(i, C.xx);

  vec2 i1;
  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
  vec4 x12 = x0.xyxy + C.xxzz;
  x12.xy -= i1;

  i = mod289(i);
  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))
    + i.x + vec3(0.0, i1.x, 1.0 ));

  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
  m = m*m ;
  m = m*m ;

  vec3 x = 2.0 * fract(p * C.www) - 1.0;
  vec3 h = abs(x) - 0.5;
  vec3 ox = floor(x + 0.5);
  vec3 a0 = x - ox;

  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );

  vec3 g;
  g.x  = a0.x  * x0.x  + h.x  * x0.y;
  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
  return 130.0 * dot(m, g);
}

// Octave noise for richer detail
float octaveNoise(vec2 uv, float octaves, float persistence, float scale) {
  float value = 0.0;
  float amplitude = 1.0;
  float frequency = scale;
  float maxValue = 0.0;

  for(float i = 0.0; i < octaves; i++) {
    value += snoise(uv * frequency) * amplitude;
    maxValue += amplitude;
    amplitude *= persistence;
    frequency *= 2.0;
  }

  return value / maxValue;
}

// Wave alpha calculation with smooth transitions
float wave_alpha(vec2 uv, int waveIndex) {
  float y = uv.y;
  float waveCenter = u_waveY[waveIndex];
  float waveHeight = u_waveHeight[waveIndex];

  float distance = abs(y - waveCenter);
  float alpha = 1.0 - smoothstep(0.0, waveHeight * 0.5, distance);

  return alpha;
}

// Dynamic blur calculation using power function
float calc_blur(vec2 uv) {
  vec2 center = vec2(0.5, 0.5);
  float distance = length(uv - center);

  float blur = pow(distance, u_blurExp);
  blur = clamp(blur, 0.0, u_blurMax);

  return blur;
}

// Background noise generator with time offset
float background_noise(vec2 uv, float timeOffset) {
  vec2 flowUV = uv;
  float adjustedTime = u_time + timeOffset;

  flowUV.x += adjustedTime * 0.02 * u_flowStrength;
  flowUV.y += sin(adjustedTime * 0.03 + uv.x * 3.14159) * 0.01 * u_flowStrength;

  float noise1 = octaveNoise(flowUV * u_noiseScale, 4.0, 0.5, 1.0);
  float noise2 = octaveNoise(flowUV * u_noiseScale * 2.0 + vec2(100.0), 3.0, 0.4, 1.0);

  return (noise1 + noise2 * 0.3) * 0.5 + 0.5;
}

void main() {
  vec2 uv = gl_FragCoord.xy / u_resolution.xy;

  // Generate three distinct background noise fields with time offsets
  float noise1 = background_noise(uv, u_waveOffset[0]);
  float noise2 = background_noise(uv, u_waveOffset[1]);
  float noise3 = background_noise(uv, 0.0); // Base noise without offset

  // Calculate wave alphas for blending
  float alpha1 = wave_alpha(uv, 0);
  float alpha2 = wave_alpha(uv, 1);
  float alpha3 = 1.0 - alpha1 - alpha2; // Remaining area
  alpha3 = max(alpha3, 0.0); // Ensure non-negative

  // Normalize alphas to ensure they sum to 1.0
  float totalAlpha = alpha1 + alpha2 + alpha3;
  if (totalAlpha > 0.0) {
    alpha1 /= totalAlpha;
    alpha2 /= totalAlpha;
    alpha3 /= totalAlpha;
  }

  // Blend the three noise fields based on wave alphas
  float t = noise1 * alpha1 + noise2 * alpha2 + noise3 * alpha3;
  t = clamp(t, 0.0, 1.0);

  // Sample gradient texture
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));

  // Apply dynamic blur based on position
  float blurAmount = calc_blur(uv);

  // Apply subtle vignette with blur modulation
  vec2 center = uv - 0.5;
  float vignette = 1.0 - dot(center, center) * (0.3 + blurAmount * 0.2);
  color.rgb *= vignette;

  // Apply blur effect to alpha channel for depth
  color.a *= (1.0 - blurAmount * 0.3);

  fragColor = color;
}`,Ct=class{constructor(t){this.utils=I;this.config=w;this.webglState={canvas:null,wrapper:null,gl:null,shaderProgram:null,gradientTexture:null,vertexBuffer:null,vao:null,isWebGLAvailable:!1,webglReady:!1,animationId:null,startTime:0,lastFrameTime:0,lastUpdateTime:0,currentFlowStrength:.3,targetFlowStrength:.3,currentNoiseScale:1,targetNoiseScale:1,currentBlurExp:1.2,targetBlurExp:1.2,currentBlurMax:.5,targetBlurMax:.5,currentWaveY:[.3,.7],targetWaveY:[.3,.7],currentWaveHeight:[.4,.3],targetWaveHeight:[.4,.3],currentWaveOffset:[.1,.6],targetWaveOffset:[.1,.6]};this.uniforms={u_time:null,u_gradientTex:null,u_resolution:null,u_flowStrength:null,u_noiseScale:null,u_waveY:null,u_waveHeight:null,u_waveOffset:null,u_blurExp:null,u_blurMax:null};this.flowSettings={enabled:!0,intensity:"balanced",flowStrength:.7,noiseScale:1.2,waveY:[.25,.75],waveHeight:[.4,.3],waveOffset:[2.5,-1.8],blurExp:1.2,blurMax:.6,frameThrottleInterval:1e3/45,oklabProcessingEnabled:!0,oklabPreset:"VIBRANT",gradientTextureSize:512};this.prefersReducedMotion=!1;this.animateWebGL=()=>{if(!this.webglState.webglReady||!this.webglState.gl||!this.webglState.canvas)return;let t=performance.now();if(t-this.webglState.lastFrameTime<this.flowSettings.frameThrottleInterval){this.webglState.animationId=requestAnimationFrame(this.animateWebGL);return}this.webglState.lastFrameTime=t,this.renderWebGLFrame(t),this.webglState.animationId=requestAnimationFrame(this.animateWebGL)};this.lerpHalfLifeValues={flowStrength:.25,noiseScale:.3,blur:.2,wave:.35};this.resizeWebGLCanvas=()=>{if(!this.webglState.canvas)return;let t=window.devicePixelRatio||1,e=window.innerWidth,i=window.innerHeight;this.webglState.canvas.width=e*t,this.webglState.canvas.height=i*t,this.webglState.canvas.style.width=e+"px",this.webglState.canvas.style.height=i+"px"};this.deviceDetector=new _,this.cssController=t||T(),this.oklabProcessor=new M(this.config.enableDebug),this.cssController=T(),this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.webglState.isWebGLAvailable=this.checkWebGL2Support(),this.loadFlowSettings(),u?.debug?.log("WebGLGradientStrategy","\u{1F30A} WebGL gradient strategy initialized - Flow Gradient Recovery Debug",{webglAvailable:this.webglState.isWebGLAvailable,deviceCapability:this.deviceDetector.recommendPerformanceQuality(),oklabProcessing:this.flowSettings.oklabProcessingEnabled,flowSettings:{enabled:this.flowSettings.enabled,intensity:this.flowSettings.intensity,flowStrength:this.flowSettings.flowStrength,noiseScale:this.flowSettings.noiseScale},prefersReducedMotion:this.prefersReducedMotion,webgl2ContextTest:this.checkWebGL2Support()})}getStrategyName(){return"webgl-gradient"}canProcess(t){return u?.debug?.log("WebGLGradientStrategy","\u{1F50D} canProcess() - WebGL Gradient Capability Check",{isWebGLAvailable:this.webglState.isWebGLAvailable,flowSettingsEnabled:this.flowSettings.enabled,webglReady:this.webglState.webglReady,contextTrackUri:t.trackUri,contextColorCount:Object.keys(t.rawColors).length}),this.webglState.isWebGLAvailable?this.flowSettings.enabled?x.get("sn-webgl-enabled")?(u?.debug?.log("WebGLGradientStrategy","canProcess: WebGL force enabled - bypassing device restrictions"),!0):(this.deviceDetector.recommendPerformanceQuality()==="low"&&u?.debug?.log("WebGLGradientStrategy","canProcess: Low performance device detected, allowing based on strategy selection (not force mode)"),!0):(u?.debug?.warn("WebGLGradientStrategy","\u274C canProcess: WebGL strategy disabled in settings"),!1):(u?.debug?.warn("WebGLGradientStrategy","\u274C canProcess: WebGL not available - failed WebGL2 context check"),!1)}getEstimatedProcessingTime(t){let i=this.flowSettings.intensity==="intense"?1.3:1;return Math.round(12*i)}async processColors(t){let e=performance.now(),i={};try{this.webglState.webglReady||await this.initializeWebGLGradient();let n=t.rawColors;if(this.flowSettings.oklabProcessingEnabled){let l=M.getPreset(this.flowSettings.oklabPreset);i=this.oklabProcessor.processColorPalette(t.rawColors,l),n=Object.fromEntries(Object.entries(i).map(([m,d])=>[m,d.enhancedHex])),u?.debug?.log("WebGLGradientStrategy","OKLAB color enhancement applied:",{originalColors:Object.keys(t.rawColors).length,processedColors:Object.keys(n).length,preset:l.name})}let r=this.createGradientStops(n,i);await this.updateGradientTexture(r),await this.enableHybridCoordination(),this.webglState.animationId||this.startWebGLAnimation(),t.musicData?.energy!==void 0&&await this.updateFlowWithMusicEnergy(t.musicData.energy),this.webglState.lastUpdateTime=Date.now();let a=performance.now()-e,s=this.selectPrimaryColor(n)||j.getDefaultAccentColor().hex,o={processedColors:{webgl:"active",gradientStops:r.length.toString(),...n,...Object.keys(t.rawColors).length>0&&{originalColors:JSON.stringify(t.rawColors)}},accentHex:s,accentRgb:this.convertToRgbString(s),metadata:{strategy:this.getStrategyName(),processingTime:a,cacheKey:`webgl-gradient-${t.trackUri}`,harmonicIntensity:this.flowSettings.flowStrength,webglReady:this.webglState.webglReady,oklabProcessing:this.flowSettings.oklabProcessingEnabled,oklabPreset:this.flowSettings.oklabPreset,gradientTextureSize:this.flowSettings.gradientTextureSize,oklabResultsCount:Object.keys(i).length},context:t};return u?.debug?.log("WebGLGradientStrategy","WebGL gradient processing completed",{gradientStops:r.length,processingTime:a,trackUri:t.trackUri}),o}catch(n){let r=performance.now()-e;u?.debug?.error("WebGLGradientStrategy","WebGL gradient processing failed:",n);let a=await this.executeProgressiveFallback(t,n);return{...a,metadata:{...a.metadata,strategy:this.getStrategyName(),processingTime:r,error:n instanceof Error?n.message:"Unknown error"},context:t}}}checkWebGL2Support(){return document.createElement("canvas").getContext("webgl2")!==null}loadFlowSettings(){try{let t=x.get("sn-gradient-intensity");if(t==="disabled"){this.flowSettings.enabled=!1;return}switch(this.flowSettings.intensity=t||"balanced",this.flowSettings.intensity){case"minimal":this.flowSettings.flowStrength=.4,this.flowSettings.noiseScale=.8,this.flowSettings.waveHeight=[.3,.2],this.flowSettings.waveOffset=[1.5,-1],this.flowSettings.blurExp=1,this.flowSettings.blurMax=.4;break;case"balanced":this.flowSettings.flowStrength=.7,this.flowSettings.noiseScale=1.2,this.flowSettings.waveHeight=[.4,.3],this.flowSettings.waveOffset=[2.5,-1.8],this.flowSettings.blurExp=1.2,this.flowSettings.blurMax=.6;break;case"intense":this.flowSettings.flowStrength=1,this.flowSettings.noiseScale=1.6,this.flowSettings.waveHeight=[.5,.4],this.flowSettings.waveOffset=[3.5,-2.5],this.flowSettings.blurExp=1.4,this.flowSettings.blurMax=.8;break}}catch(t){u?.debug?.warn("WebGLGradientStrategy","Failed to load settings, using defaults:",t)}}async initializeWebGLGradient(){if(!this.webglState.isWebGLAvailable)throw new Error("WebGL2 not available");await this.createWebGLCanvas(),await this.initializeWebGLContext(),await this.compileWebGLShaders(),this.createWebGLGeometry(),this.setupWebGLUniforms(),this.resizeWebGLCanvas(),this.attachWebGLToDom(),window.addEventListener("resize",this.resizeWebGLCanvas.bind(this)),this.webglState.webglReady=!0;try{let t=T();t.setPerformanceTokens({webglReady:!0,activeBackend:"webgl-strategy",qualityLevel:"high",gpuAcceleration:!0}),u?.debug?.log("WebGLGradientStrategy","\u{1F3A8} WebGL readiness announced to CSS consciousness system - CSS Variables Set",{webglReady:!0,activeBackend:"webgl-strategy",qualityLevel:"high",gpuAcceleration:!0,cssControllerReady:!!t})}catch(t){u?.debug?.warn("WebGLGradientStrategy","\u274C Failed to announce WebGL readiness - CSS Variables NOT Set:",t)}u?.debug?.log("WebGLGradientStrategy","WebGL gradient system initialized successfully")}async createWebGLCanvas(){u?.debug?.log("WebGLGradientStrategy","\u{1F3A8} Creating WebGL canvas and wrapper elements"),this.webglState.wrapper=document.createElement("div"),this.webglState.wrapper.className="sn-webgl-gradient-wrapper",this.webglState.wrapper.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -11;
      pointer-events: none;
      overflow: hidden;
    `,this.webglState.canvas=document.createElement("canvas"),this.webglState.canvas.id="sn-webgl-gradient-strategy",this.webglState.canvas.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    `,this.webglState.wrapper.appendChild(this.webglState.canvas),u?.debug?.log("WebGLGradientStrategy","\u2705 WebGL canvas and wrapper created successfully",{wrapperId:this.webglState.wrapper.className,canvasId:this.webglState.canvas.id,wrapperStyle:this.webglState.wrapper.style.cssText.replace(/\s+/g," ").trim()})}async initializeWebGLContext(){if(!this.webglState.canvas)throw new Error("Canvas not created");if(this.webglState.gl=this.webglState.canvas.getContext("webgl2",{alpha:!0,antialias:!1,depth:!1,stencil:!1,powerPreference:"default"}),!this.webglState.gl)throw new Error("Failed to get WebGL2 context")}async compileWebGLShaders(){if(!this.webglState.gl)throw new Error("WebGL context not available");let t=te.loadVertex(this.webglState.gl,St),e=te.loadFragment(this.webglState.gl,mc);if(!t||!e)throw new Error("Failed to compile shaders");if(this.webglState.shaderProgram=te.createProgram(this.webglState.gl,t,e),!this.webglState.shaderProgram)throw new Error("Failed to create shader program")}createWebGLGeometry(){if(!this.webglState.gl||!this.webglState.shaderProgram)return;let t=new Float32Array([-1,-1,3,-1,-1,3]);this.webglState.vertexBuffer=this.webglState.gl.createBuffer(),this.webglState.gl.bindBuffer(this.webglState.gl.ARRAY_BUFFER,this.webglState.vertexBuffer),this.webglState.gl.bufferData(this.webglState.gl.ARRAY_BUFFER,t,this.webglState.gl.STATIC_DRAW),this.webglState.vao=this.webglState.gl.createVertexArray(),this.webglState.gl.bindVertexArray(this.webglState.vao);let e=this.webglState.gl.getAttribLocation(this.webglState.shaderProgram,"a_position");this.webglState.gl.enableVertexAttribArray(e),this.webglState.gl.vertexAttribPointer(e,2,this.webglState.gl.FLOAT,!1,0,0),this.webglState.gl.bindVertexArray(null)}setupWebGLUniforms(){!this.webglState.gl||!this.webglState.shaderProgram||(this.uniforms.u_time=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_time"),this.uniforms.u_gradientTex=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_gradientTex"),this.uniforms.u_resolution=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_resolution"),this.uniforms.u_flowStrength=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_flowStrength"),this.uniforms.u_noiseScale=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_noiseScale"),this.uniforms.u_waveY=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_waveY"),this.uniforms.u_waveHeight=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_waveHeight"),this.uniforms.u_waveOffset=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_waveOffset"),this.uniforms.u_blurExp=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_blurExp"),this.uniforms.u_blurMax=this.webglState.gl.getUniformLocation(this.webglState.shaderProgram,"u_blurMax"))}createGradientStops(t,e={}){let i=["PRIMARY","VIBRANT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT","DARK_VIBRANT","PROMINENT"],n=[],r=new Set,a=0;for(let s of i){let o=t[s];if(o&&!r.has(o)){let l=e[s],m=l?l.enhancedHex:o,d=this.utils.hexToRgb(m);if(d&&(n.push({r:d.r/255,g:d.g/255,b:d.b/255,a:1,position:a/(Math.min(i.length,4)-1),...l&&{oklabOriginal:l.originalHex,oklabEnhanced:l.enhancedHex}}),r.add(o),a++,n.length>=4))break}}return n.length===0?this.getDefaultGradientStops():n}getDefaultGradientStops(){return[{r:.196,g:.165,b:.282,a:1,position:0},{r:.549,g:.408,b:.878,a:1,position:.3},{r:.788,g:.557,b:.902,a:1,position:.6},{r:.957,g:.761,b:.494,a:1,position:1}]}async updateGradientTexture(t){if(this.webglState.gl){if(this.webglState.gradientTexture&&this.webglState.gl.deleteTexture(this.webglState.gradientTexture),this.webglState.gradientTexture=le(this.webglState.gl,t),!this.webglState.gradientTexture)throw new Error("Failed to create gradient texture");await this.updateCSSFallbackVariables(t)}}async updateCSSFallbackVariables(t){let e=Math.min(8,t.length),i={"--sn-grad-stop-count":String(e)};for(let n=0;n<e;n++){let r=t[n];r&&(i[`--sn-grad-stop-${n}-rgb`]=`${Math.round(r.r*255)},${Math.round(r.g*255)},${Math.round(r.b*255)}`)}await this.cssController.batchSetVariables("WebGLGradientStrategy",i,"normal","gradient-stops-configuration")}async enableHybridCoordination(){let t={"--sn-webgl-ready":"1","--sn-webgl-enabled":"1","--sn-current-backend":"hybrid","--sn-gradient-crossfade-opacity":"0.5"};u?.debug?.log("WebGLGradientStrategy","\u{1F517} Setting hybrid coordination CSS variables - WebGL Gradient Activation",{variables:t,cssControllerReady:!!this.cssController}),await this.cssController.batchSetVariables("WebGLGradientStrategy",t,"high","hybrid-coordination-enable"),u?.debug?.log("WebGLGradientStrategy","\u2705 Hybrid coordination CSS variables set successfully")}startWebGLAnimation(){this.webglState.startTime=performance.now(),this.webglState.lastFrameTime=this.webglState.startTime,this.animateWebGL()}updateUniformsWithLERP(t){this.webglState.targetFlowStrength=this.flowSettings.flowStrength,this.webglState.targetNoiseScale=this.flowSettings.noiseScale,this.webglState.targetBlurExp=this.flowSettings.blurExp,this.webglState.targetBlurMax=this.flowSettings.blurMax,this.webglState.targetWaveY=[this.flowSettings.waveY[0],this.flowSettings.waveY[1]],this.webglState.targetWaveHeight=[this.flowSettings.waveHeight[0],this.flowSettings.waveHeight[1]],this.webglState.targetWaveOffset=[this.flowSettings.waveOffset[0],this.flowSettings.waveOffset[1]],this.webglState.currentFlowStrength=O(this.webglState.currentFlowStrength,this.webglState.targetFlowStrength,t,this.lerpHalfLifeValues.flowStrength),this.webglState.currentNoiseScale=O(this.webglState.currentNoiseScale,this.webglState.targetNoiseScale,t,this.lerpHalfLifeValues.noiseScale),this.webglState.currentBlurExp=O(this.webglState.currentBlurExp,this.webglState.targetBlurExp,t,this.lerpHalfLifeValues.blur),this.webglState.currentBlurMax=O(this.webglState.currentBlurMax,this.webglState.targetBlurMax,t,this.lerpHalfLifeValues.blur);let e=0,i=1;this.webglState.currentWaveY[e]=O(this.webglState.currentWaveY[e],this.webglState.targetWaveY[e],t,this.lerpHalfLifeValues.wave),this.webglState.currentWaveY[i]=O(this.webglState.currentWaveY[i],this.webglState.targetWaveY[i],t,this.lerpHalfLifeValues.wave),this.webglState.currentWaveHeight[e]=O(this.webglState.currentWaveHeight[e],this.webglState.targetWaveHeight[e],t,this.lerpHalfLifeValues.wave),this.webglState.currentWaveHeight[i]=O(this.webglState.currentWaveHeight[i],this.webglState.targetWaveHeight[i],t,this.lerpHalfLifeValues.wave),this.webglState.currentWaveOffset[e]=O(this.webglState.currentWaveOffset[e],this.webglState.targetWaveOffset[e],t,this.lerpHalfLifeValues.wave),this.webglState.currentWaveOffset[i]=O(this.webglState.currentWaveOffset[i],this.webglState.targetWaveOffset[i],t,this.lerpHalfLifeValues.wave)}renderWebGLFrame(t){if(!this.webglState.gl||!this.webglState.shaderProgram||!this.webglState.vao||!this.webglState.gradientTexture)return;let e=(t-this.webglState.lastFrameTime)/1e3;this.updateUniformsWithLERP(e),this.webglState.gl.viewport(0,0,this.webglState.canvas.width,this.webglState.canvas.height),this.webglState.gl.clearColor(0,0,0,0),this.webglState.gl.clear(this.webglState.gl.COLOR_BUFFER_BIT),this.webglState.gl.useProgram(this.webglState.shaderProgram),this.webglState.gl.bindVertexArray(this.webglState.vao);let i=this.prefersReducedMotion?0:(t-this.webglState.startTime)/1e3;this.uniforms.u_time&&this.webglState.gl.uniform1f(this.uniforms.u_time,i),this.uniforms.u_resolution&&this.webglState.gl.uniform2f(this.uniforms.u_resolution,this.webglState.canvas.width,this.webglState.canvas.height),this.uniforms.u_flowStrength&&this.webglState.gl.uniform1f(this.uniforms.u_flowStrength,this.webglState.currentFlowStrength),this.uniforms.u_noiseScale&&this.webglState.gl.uniform1f(this.uniforms.u_noiseScale,this.webglState.currentNoiseScale),this.uniforms.u_waveY&&this.webglState.gl.uniform1fv(this.uniforms.u_waveY,this.webglState.currentWaveY),this.uniforms.u_waveHeight&&this.webglState.gl.uniform1fv(this.uniforms.u_waveHeight,this.webglState.currentWaveHeight),this.uniforms.u_waveOffset&&this.webglState.gl.uniform1fv(this.uniforms.u_waveOffset,this.webglState.currentWaveOffset),this.uniforms.u_blurExp&&this.webglState.gl.uniform1f(this.uniforms.u_blurExp,this.webglState.currentBlurExp),this.uniforms.u_blurMax&&this.webglState.gl.uniform1f(this.uniforms.u_blurMax,this.webglState.currentBlurMax),this.webglState.gl.activeTexture(this.webglState.gl.TEXTURE0),this.webglState.gl.bindTexture(this.webglState.gl.TEXTURE_2D,this.webglState.gradientTexture),this.uniforms.u_gradientTex&&this.webglState.gl.uniform1i(this.uniforms.u_gradientTex,0),this.webglState.gl.drawArrays(this.webglState.gl.TRIANGLES,0,3),this.webglState.gl.bindVertexArray(null)}async updateFlowWithMusicEnergy(t){let e=this.flowSettings.flowStrength,i=1+t*.5,n=e*i;await this.cssController.setVariable("WebGLGradientStrategy","--sn-flow-strength",n.toString(),"high","music-energy-flow-strength")}attachWebGLToDom(){if(!this.webglState.wrapper){u?.debug?.error("WebGLGradientStrategy","\u274C Cannot attach to DOM - wrapper element not created");return}u?.debug?.log("WebGLGradientStrategy","\u{1F517} Attaching WebGL canvas to DOM - Searching for container");let t=[".Root__main-view",".main-view-container",".main-gridContainer-gridContainer",".Root__top-container","body"],e=null,i=[];for(let n of t)if(e=document.querySelector(n),i.push({selector:n,found:!!e}),e)break;e||(e=document.body),e.appendChild(this.webglState.wrapper),u?.debug?.log("WebGLGradientStrategy","\u2705 WebGL canvas attached to DOM successfully",{containerSearch:i,selectedContainer:e?.tagName||"unknown",containerClass:e?.className||"none",wrapperId:this.webglState.wrapper.className,canvasId:this.webglState.canvas?.id||"not-created"})}async executeProgressiveFallback(t,e){let i=this.selectPrimaryColor(t.rawColors)||j.getDefaultAccentColor().hex;try{return u?.debug?.warn("WebGLGradientStrategy","Attempting CSS gradient fallback"),await this.fallbackToCSSGradient(),{processedColors:{...t.rawColors,fallbackMethod:"css-gradient"},accentHex:i,accentRgb:this.convertToRgbString(i),metadata:{strategy:this.getStrategyName(),processingTime:0,fallbackMode:"css-gradient",fallbackReason:"webgl-failed",gradientStops:Object.keys(t.rawColors).length},context:t}}catch(n){return u?.debug?.error("WebGLGradientStrategy","CSS gradient fallback failed, using solid color:",n),await this.fallbackToSolidColor(t,i,e,n)}}async fallbackToSolidColor(t,e,i,n){try{return await this.cssController?.queueUpdate("--sn-accent-color",e,"critical","solid-color-fallback"),{processedColors:{accentColor:e,fallbackMethod:"solid-color",originalColors:JSON.stringify(t.rawColors)},accentHex:e,accentRgb:this.convertToRgbString(e),metadata:{strategy:this.getStrategyName(),processingTime:0,fallbackMode:"solid-color",fallbackReason:"all-gradients-failed",webglError:i instanceof Error?i.message:"Unknown WebGL error",cssError:n instanceof Error?n.message:"Unknown CSS error",emergencyMode:!0},context:t}}catch(r){return u?.debug?.error("WebGLGradientStrategy","All fallback methods failed, using emergency mode:",r),{processedColors:{emergencyMode:"true"},accentHex:"#ff6b9d",accentRgb:"rgb(255, 107, 157)",metadata:{strategy:this.getStrategyName(),processingTime:0,fallbackMode:"emergency",fallbackReason:"complete-system-failure",criticalError:!0},context:t}}}async fallbackToCSSGradient(){let t={"--sn-webgl-ready":"0","--sn-webgl-enabled":"0","--sn-current-backend":"css","--sn-gradient-crossfade-opacity":"0"};await this.cssController.batchSetVariables("WebGLGradientStrategy",t,"critical","css-gradient-fallback"),this.cssController&&this.startCSSFallbackAnimation(),u?.debug?.log("WebGLGradientStrategy","Using CSS gradient fallback")}startCSSFallbackAnimation(){if(!this.cssController)return;let t=()=>{if(!this.webglState.webglReady)return;let e=performance.now()/1e3,i=Math.sin(e*.04)*20+Math.sin(e*.07)*8,n=Math.cos(e*.05)*20+Math.cos(e*.09)*6,r=1.15+Math.sin(e*.03)*.2;this.cssController.queueCSSVariableUpdate("--sn-gradient-flow-x",`${i}%`),this.cssController.queueCSSVariableUpdate("--sn-gradient-flow-y",`${n}%`),this.cssController.queueCSSVariableUpdate("--sn-gradient-flow-scale",r.toString()),setTimeout(t,this.flowSettings.frameThrottleInterval)};t()}selectPrimaryColor(t){let e=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let i of e){let n=t[i];if(n&&this.utils.hexToRgb(n))return n}return null}convertToRgbString(t){let e=this.utils.hexToRgb(t);return e?`${e.r},${e.g},${e.b}`:"203,166,247"}updateConfig(t){this.flowSettings={...this.flowSettings,...t},("oklabProcessingEnabled"in t||"oklabPreset"in t)&&(this.oklabProcessor=new M(this.config.enableDebug)),u?.debug?.log("WebGLGradientStrategy","Configuration updated:",{...t,oklabProcessing:this.flowSettings.oklabProcessingEnabled,oklabPreset:this.flowSettings.oklabPreset,gradientTextureSize:this.flowSettings.gradientTextureSize})}async healthCheck(){let t=Date.now()-this.webglState.lastUpdateTime<3e4;return{healthy:this.webglState.webglReady&&this.flowSettings.enabled,canProcess:this.canProcess({}),issues:this.webglState.webglReady?this.flowSettings.enabled?[]:["WebGL gradient disabled in settings"]:["WebGL system not ready"],metrics:{webglAvailable:this.webglState.isWebGLAvailable,webglReady:this.webglState.webglReady,flowEnabled:this.flowSettings.enabled,intensity:this.flowSettings.intensity,deviceCapability:this.deviceDetector.recommendPerformanceQuality(),hasRecentUpdate:t,animationActive:this.webglState.animationId!==null,oklabProcessing:this.flowSettings.oklabProcessingEnabled,oklabPreset:this.flowSettings.oklabPreset,gradientTextureSize:this.flowSettings.gradientTextureSize,canvasSize:this.webglState.canvas?{width:this.webglState.canvas.width,height:this.webglState.canvas.height}:null}}}destroy(){this.webglState.animationId&&(cancelAnimationFrame(this.webglState.animationId),this.webglState.animationId=null),this.webglState.gl&&(this.webglState.gradientTexture&&(this.webglState.gl.deleteTexture(this.webglState.gradientTexture),this.webglState.gradientTexture=null),this.webglState.vertexBuffer&&(this.webglState.gl.deleteBuffer(this.webglState.vertexBuffer),this.webglState.vertexBuffer=null),this.webglState.vao&&(this.webglState.gl.deleteVertexArray(this.webglState.vao),this.webglState.vao=null),this.webglState.shaderProgram&&(this.webglState.gl.deleteProgram(this.webglState.shaderProgram),this.webglState.shaderProgram=null),te.clearCache(this.webglState.gl)),this.webglState.wrapper&&this.webglState.wrapper.parentNode&&(this.webglState.wrapper.parentNode.removeChild(this.webglState.wrapper),this.webglState.wrapper=null),this.webglState.canvas=null,this.webglState.gl=null,this.webglState.webglReady=!1,window.removeEventListener("resize",this.resizeWebGLCanvas);let t={"--sn-webgl-ready":"0","--sn-webgl-enabled":"0","--sn-current-backend":"css","--sn-gradient-crossfade-opacity":"0"};this.cssController.batchSetVariables("WebGLGradientStrategy",t,"critical","strategy-destroy-cleanup").catch(e=>{u?.debug?.error("WebGLGradientStrategy","Error during destroy cleanup:",e)}),u?.debug?.log("WebGLGradientStrategy","WebGL gradient strategy destroyed")}}});var st,Dn=y(()=>{"use strict";de();A();ye();Ra();Da();In();La();st=class{constructor(){this.strategyInstances=new Map;this.strategyMetadata=new Map;this.deviceDetector=new _,this.initializeStrategyMetadata(),u?.debug?.log("BackgroundStrategySelector","Strategy selector initialized")}initializeStrategyMetadata(){this.strategyMetadata.set("dynamic-catppuccin",{name:"dynamic-catppuccin",priority:10,estimatedProcessingTime:5,memoryImpact:2,qualityScore:9,compatibilityScore:10}),this.strategyMetadata.set("living-gradient",{name:"living-gradient",priority:8,estimatedProcessingTime:8,memoryImpact:3,qualityScore:8,compatibilityScore:9}),this.strategyMetadata.set("webgl-gradient",{name:"webgl-gradient",priority:6,estimatedProcessingTime:12,memoryImpact:7,qualityScore:10,compatibilityScore:6}),this.strategyMetadata.set("webgl-gradient-degraded",{name:"webgl-gradient-degraded",priority:5,estimatedProcessingTime:8,memoryImpact:4,qualityScore:6,compatibilityScore:8}),this.strategyMetadata.set("depth-layered",{name:"depth-layered",priority:7,estimatedProcessingTime:15,memoryImpact:5,qualityScore:9,compatibilityScore:7})}selectStrategies(t,e){let i=performance.now(),n=[];try{let r=e.deviceContext||this.buildDeviceContext(),a=e.settingsContext||this.buildSettingsContext();u?.debug?.log("BackgroundStrategySelector","\u{1F3AF} Strategy Selection Debug - WebGL Gradient Analysis",{trackUri:t.trackUri,colorCount:Object.keys(t.rawColors).length,deviceContext:{supportsWebGL:r.supportsWebGL,performanceLevel:r.performanceLevel,memoryCapacity:r.memoryCapacity,isMobile:r.isMobile},settingsContext:{webglEnabled:a.webglEnabled,webglForceEnabled:a.webglForceEnabled,gradientIntensity:a.gradientIntensity,consciousnessLevel:a.consciousnessLevel}});let s=this.analyzeStrategyCompatibility(t,{...e,deviceContext:r,settingsContext:a});for(let l of s)if(u?.debug?.log("BackgroundStrategySelector",`Strategy decision: ${l.strategyName}`,{shouldInclude:l.shouldInclude,reason:l.reason,score:l.score}),l.shouldInclude){let m=this.getOrCreateStrategy(l.strategyName);if(m){let d=m.canProcess(t);u?.debug?.log("BackgroundStrategySelector",`Strategy ${l.strategyName} canProcess check`,{canProcess:d,strategyName:l.strategyName,contextColors:Object.keys(t.rawColors).length}),d?(n.push(m),u?.debug?.log("BackgroundStrategySelector",`\u2705 Selected strategy: ${l.strategyName}`)):u?.debug?.warn("BackgroundStrategySelector",`\u274C Strategy rejected by canProcess(): ${l.strategyName}`)}else u?.debug?.error("BackgroundStrategySelector",`Failed to create strategy: ${l.strategyName}`)}if(n.length===0){let l=this.getOrCreateStrategy("living-gradient");l?.canProcess(t)&&n.push(l)}let o=performance.now()-i;return u?.debug?.log("BackgroundStrategySelector","\u{1F3AF} Strategy selection completed",{selectedCount:n.length,strategies:n.map(l=>l.getStrategyName()),processingTime:o,deviceLevel:r.performanceLevel,visualGuideMode:a.visualGuideMode,webglEnabled:a.webglEnabled,webglForceEnabled:a.webglForceEnabled,supportsWebGL:r.supportsWebGL,totalDecisions:s.length,includedDecisions:s.filter(l=>l.shouldInclude).length}),n}catch(r){u?.debug?.error("BackgroundStrategySelector","Strategy selection failed:",r);let a=this.getOrCreateStrategy("living-gradient");return a?[a]:[]}}analyzeStrategyCompatibility(t,e){let i=[],n=this.scoreDynamicCatppuccinStrategy(e);i.push({strategyName:"dynamic-catppuccin",shouldInclude:e.settingsContext.dynamicAccentEnabled&&n>.5,reason:e.settingsContext.dynamicAccentEnabled?`Dynamic accent enabled (score: ${n.toFixed(2)})`:"Dynamic accent disabled in settings",score:n});let r=this.scoreLivingGradientStrategy(e);i.push({strategyName:"living-gradient",shouldInclude:r>.3,reason:`Living gradient foundation (score: ${r.toFixed(2)})`,score:r});let a=this.scoreWebGLGradientStrategy(e),s=this.scoreWebGLDegradedStrategy(e),o=e.settingsContext.webglEnabled&&e.deviceContext.supportsWebGL&&(e.deviceContext.performanceLevel!=="low"||e.settingsContext.webglForceEnabled)&&a>.6;i.push({strategyName:"webgl-gradient",shouldInclude:o,reason:`WebGL full quality (score: ${a.toFixed(2)}, device: ${e.deviceContext.performanceLevel}${e.settingsContext.webglForceEnabled?", FORCED":""})`,score:a}),i.push({strategyName:"webgl-gradient-degraded",shouldInclude:e.settingsContext.webglEnabled&&e.deviceContext.supportsWebGL&&e.deviceContext.performanceLevel==="low"&&!e.settingsContext.webglForceEnabled&&s>.4,reason:`WebGL degraded mode (score: ${s.toFixed(2)}, device: low${e.settingsContext.webglForceEnabled?", skipped due to force":""})`,score:s});let l=this.scoreDepthLayeredStrategy(e);return i.push({strategyName:"depth-layered",shouldInclude:e.settingsContext.depthLayersEnabled&&e.settingsContext.consciousnessLevel>.4&&e.deviceContext.performanceLevel!=="low"&&l>.5,reason:`Depth consciousness (score: ${l.toFixed(2)}, consciousness: ${e.settingsContext.consciousnessLevel})`,score:l}),i}scoreDynamicCatppuccinStrategy(t){let e=.8;return t.settingsContext.dynamicAccentEnabled&&(e+=.2),t.musicContext?.energy&&t.musicContext.energy>.7&&(e+=.1),["cosmic","cinematic","ethereal","natural"].includes(t.settingsContext.visualGuideMode)&&(e+=.1),e+=.1,Math.min(1,e)}scoreLivingGradientStrategy(t){let e=.9;return t.settingsContext.breathingAnimationEnabled&&(e+=.1),e+=t.settingsContext.consciousnessLevel*.2,t.musicContext?.valence!==void 0&&(e+=.05),t.deviceContext.performanceLevel==="high"&&(e+=.05),Math.min(1,e)}scoreWebGLGradientStrategy(t){let e=0;if(!t.deviceContext.supportsWebGL||!t.settingsContext.webglEnabled)return 0;switch(e=.6,t.settingsContext.webglForceEnabled&&(e+=.4,u?.debug?.log("BackgroundStrategySelector","WebGL force enabled - boosting score by 0.4")),t.deviceContext.performanceLevel){case"high":e+=.3;break;case"medium":e+=.2;break;case"low":if(!t.settingsContext.webglForceEnabled)return 0;e+=.1;break}return t.deviceContext.memoryCapacity>4e3&&(e+=.1),t.deviceContext.memoryCapacity>8e3&&(e+=.1),t.settingsContext.consciousnessLevel>.7&&(e+=.1),t.musicContext?.energy&&t.musicContext.energy>.8&&(e+=.1),t.deviceContext.isMobile&&(e-=.2),Math.min(1,Math.max(0,e))}scoreWebGLDegradedStrategy(t){let e=0;return!t.deviceContext.supportsWebGL||!t.settingsContext.webglEnabled||t.deviceContext.performanceLevel!=="low"?0:(e=.5,e+=.3,t.settingsContext.consciousnessLevel>.5&&(e+=.1),t.musicContext?.energy&&t.musicContext.energy>.6&&(e+=.05),t.deviceContext.isMobile&&(e-=.1),t.deviceContext.memoryCapacity>2e3&&(e+=.05),Math.min(1,Math.max(0,e)))}scoreDepthLayeredStrategy(t){let e=0;if(!t.settingsContext.depthLayersEnabled)return 0;switch(e=.5,e+=t.settingsContext.consciousnessLevel*.4,t.deviceContext.performanceLevel){case"high":e+=.2;break;case"medium":e+=.1;break;case"low":return e=0,0}return["cosmic","cinematic"].includes(t.settingsContext.visualGuideMode)&&(e+=.2),t.musicContext?.tempo&&t.musicContext.tempo<100&&(e+=.1),t.deviceContext.memoryCapacity>6e3&&(e+=.1),t.deviceContext.isMobile&&(e-=.15),Math.min(1,Math.max(0,e))}buildDeviceContext(){let t=window.navigator.deviceMemory?window.navigator.deviceMemory*1024:4096,e=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);return{supportsWebGL:this.deviceDetector.hasWebGLSupport(),performanceLevel:this.deviceDetector.recommendPerformanceQuality(),memoryCapacity:t,isMobile:e}}buildSettingsContext(){try{return{dynamicAccentEnabled:!0,gradientIntensity:x.get("sn-gradient-intensity"),webglEnabled:x.get("sn-webgl-enabled"),webglForceEnabled:x.get("sn-webgl-enabled"),visualGuideMode:x.get("sn-artistic-mode"),depthLayersEnabled:x.get("sn-gradient-intensity")!=="disabled",consciousnessLevel:.8,breathingAnimationEnabled:!0}}catch(t){return u?.debug?.warn("BackgroundStrategySelector","Failed to load settings, using defaults:",t),{dynamicAccentEnabled:!0,gradientIntensity:"balanced",webglEnabled:!0,webglForceEnabled:!1,visualGuideMode:"cosmic",depthLayersEnabled:!0,consciousnessLevel:.8,breathingAnimationEnabled:!0}}}getOrCreateStrategy(t){if(this.strategyInstances.has(t))return this.strategyInstances.get(t);let e=null;try{switch(t){case"dynamic-catppuccin":e=new ri;break;case"living-gradient":e=new ft;break;case"webgl-gradient":e=new Ct;break;case"webgl-gradient-degraded":e=new Ct;break;case"depth-layered":e=new ni;break;default:return u?.debug?.warn("BackgroundStrategySelector",`Unknown strategy: ${t}`),null}e&&(this.strategyInstances.set(t,e),u?.debug?.log("BackgroundStrategySelector",`Created strategy instance: ${t}`))}catch(i){return u?.debug?.error("BackgroundStrategySelector",`Failed to create strategy ${t}:`,i),null}return e}getEstimatedProcessingTime(t,e){return t.reduce((i,n)=>i+n.getEstimatedProcessingTime(e),0)}getStrategyMetadata(t){return this.strategyMetadata.get(t)||null}getAvailableStrategyNames(){return Array.from(this.strategyMetadata.keys())}updateSelectionCriteria(t){u?.debug?.log("BackgroundStrategySelector","Strategy selection criteria updated:",t)}destroy(){this.strategyInstances.forEach((t,e)=>{if("destroy"in t&&typeof t.destroy=="function")try{t.destroy()}catch(i){u?.debug?.warn("BackgroundStrategySelector",`Error destroying strategy ${e}:`,i)}}),this.strategyInstances.clear(),this.strategyMetadata.clear(),u?.debug?.log("BackgroundStrategySelector","Strategy selector destroyed")}}});var kn,Ln,ot,ai=y(()=>{"use strict";U();D();de();A();ke();ne();K();Dn();kn=class{constructor(){this.strategies=new Map;this.defaultStrategy=null}register(t){let e=t.getStrategyName();this.strategies.set(e,t),this.defaultStrategy||(this.defaultStrategy=t),u?.debug?.log("ColorStrategyRegistry",`Registered strategy: ${e}`)}selectStrategy(t){if(t.performance==="high"&&t.quality==="basic")for(let e of this.strategies.values()){let i=e.getStrategyName().toLowerCase();if(i.includes("lightweight")||i.includes("fast"))return e}if(t.quality==="premium"&&t.performance==="low")for(let e of this.strategies.values()){let i=e.getStrategyName().toLowerCase();if(i.includes("harmony")||i.includes("advanced"))return e}if(t.deviceCapabilities?.isMobile)for(let e of this.strategies.values()){let i=e.getStrategyName().toLowerCase();if(i.includes("mobile")||i.includes("optimized"))return e}return this.defaultStrategy}getStrategies(){return Array.from(this.strategies.values())}getStrategy(t){return this.strategies.get(t)||null}setDefaultStrategy(t){this.defaultStrategy=t}getStatus(){return{strategyCount:this.strategies.size,strategies:Array.from(this.strategies.keys()),defaultStrategy:this.defaultStrategy?.getStrategyName()||null}}},Ln=class{constructor(){this.isInitialized=!1;this.processingQueue=[];this.isProcessing=!1;this.currentStrategy=null;this.oklabCoordinationEnabled=!0;this.processedContexts=new Map;this.CONTEXT_CACHE_TTL=2e3;this.MAX_QUEUE_SIZE=10;this.resultCache=new Map;this.cacheMaxSize=50;this.cacheTimeoutMs=3e5;this.orchestrationMetrics={totalProcessingTime:0,strategiesProcessed:0,strategiesSucceeded:0,strategiesFailed:0,cacheHits:0,averageStrategyTime:0,memoryUsage:0,oklabCoordinations:0,oklabProcessingTime:0};this.processedCount=0;this.totalProcessingTime=0;this.lastProcessingTime=0;this.registry=new kn,this.settingsManager=new ee;let t=globalThis.year3000System;this.performanceAnalyzer=t?.performanceAnalyzer||t?.facadeCoordinator?.getCachedNonVisualSystem?.("SimplePerformanceCoordinator")||null,this.deviceDetector=new _,this.strategySelector=new st,this.oklabProcessor=new M(w.enableDebug),this.selectionCriteria={performance:"medium",quality:"enhanced",deviceCapabilities:{hasWebGL:!!window.WebGLRenderingContext,memoryMB:this.estimateMemoryMB(),isMobile:this.detectMobile()},userPreferences:{harmonicMode:"cosmic",intensity:.8,enableAdvancedBlending:!0}},this.updateDeviceCapabilities(),u?.debug?.log("ColorOrchestrator","Enhanced color orchestrator created with multi-strategy coordination")}async initialize(){if(this.isInitialized){u?.debug?.warn("ColorOrchestrator","Already initialized");return}try{g.subscribe("colors:extracted",this.handleColorExtractionEvent.bind(this),"ColorOrchestrator"),this.updateDeviceCapabilities(),this.loadUserPreferences(),await this.registerDefaultStrategies(),this.isInitialized=!0,u?.debug?.log("ColorOrchestrator","Enhanced color orchestrator initialized",{strategies:this.registry.getStatus().strategyCount,criteria:this.selectionCriteria,oklabEnabled:this.oklabCoordinationEnabled,deviceLevel:this.deviceDetector.recommendPerformanceQuality()})}catch(t){throw u?.debug?.error("ColorOrchestrator","Enhanced initialization failed:",t),t}}async handleColorExtractionEvent(t){let e=t;await this.handleColorExtraction(e)}async handleColorExtraction(t){let e=Date.now(),i=t.trackUri||"unknown";u?.debug?.log("ColorOrchestrator","\u{1F3B5} Color Extraction Event Received - WebGL Gradient Entry Point",{trackUri:i,rawColors:t.rawColors,colorCount:Object.keys(t.rawColors).length,isProcessing:this.isProcessing,queueLength:this.processingQueue.length,entryPoint:"handleColorExtraction"});let n=this.processedContexts.get(i);if(n&&e-n<this.CONTEXT_CACHE_TTL){u?.debug?.warn("ColorOrchestrator",`Skipping recent context to prevent recursion: ${i}`,{lastProcessed:new Date(n).toISOString(),timeDiff:e-n});return}let r=this.generateCacheKey(t),a=this.getCachedResult(r);if(a){this.orchestrationMetrics.cacheHits++,await this.applyColorResult(a),u?.debug?.log("ColorOrchestrator","Using cached color result",{cacheKey:r});return}this.processingQueue.length>=this.MAX_QUEUE_SIZE&&(u?.debug?.warn("ColorOrchestrator",`Queue overflow protection: dropping context ${i}`,{queueSize:this.processingQueue.length,maxSize:this.MAX_QUEUE_SIZE}),this.processingQueue.shift()),this.cleanupProcessedContexts(e),this.processingQueue.push(t),this.isProcessing||await this.processQueue()}async processQueue(){if(!(this.isProcessing||this.processingQueue.length===0)){this.isProcessing=!0;try{for(;this.processingQueue.length>0;){let t=this.processingQueue.shift();await this.processColorContext(t)}}catch(t){u?.debug?.error("ColorOrchestrator","Queue processing failed:",t)}finally{this.isProcessing=!1,this.currentStrategy=null}}}cleanupProcessedContexts(t){for(let[e,i]of this.processedContexts.entries())t-i>this.CONTEXT_CACHE_TTL&&this.processedContexts.delete(e)}async processColorContext(t){let e=performance.now(),i=t.trackUri||"unknown";u?.debug?.log("ColorOrchestrator","\u{1F3A8} Processing Color Context - WebGL Gradient Recovery Debug",{trackUri:i,rawColors:t.rawColors,colorCount:Object.keys(t.rawColors).length,musicData:t.musicData,timestamp:new Date().toISOString()});try{let n=this.strategySelector.selectStrategies(t,this.buildStrategySelectionCriteria(t));if(n.length===0){let l=this.selectStrategy(t);if(l)n.push(l);else throw new Error("No suitable strategies selected for color processing")}let r=await this.processWithStrategies(t,n);this.oklabCoordinationEnabled&&r.filter(l=>l.success).length>1&&await this.coordinateOKLABProcessing(r,t);let a=this.mergeStrategyResults(r,t),s=this.generateCacheKey(t);this.cacheResult(s,a),await this.applyColorResult(a),this.processedContexts.set(i,Date.now());let o=performance.now()-e;this.updateOrchestrationMetrics(r,o),this.lastProcessingTime=o,this.totalProcessingTime+=o,this.processedCount++,u?.debug?.log("ColorOrchestrator","Enhanced color processing completed",{strategies:n.map(l=>l.getStrategyName()),processingTime:o,trackUri:t.trackUri,oklabCoordination:this.oklabCoordinationEnabled,successfulStrategies:r.filter(l=>l.success).length})}catch(n){let r=performance.now();this.lastProcessingTime=r-e,u?.debug?.error("ColorOrchestrator","Enhanced color processing failed:",{error:n,strategy:this.currentStrategy,trackUri:t.trackUri}),await this.applyFallbackColors(t)}}selectStrategy(t){let e={...this.selectionCriteria};return t.performanceHints&&(t.performanceHints.preferLightweight&&(e.performance="high",e.quality="basic"),t.performanceHints.enableAdvancedBlending&&(e.quality="premium")),t.musicData&&t.musicData.energy&&t.musicData.energy>.8&&(e.quality="premium"),this.registry.selectStrategy(e)}async registerDefaultStrategies(){u?.debug?.log("ColorOrchestrator","Default strategies registration completed")}async processWithStrategies(t,e){let i=[],n=e.map(async a=>{let s=performance.now();this.currentStrategy=a.getStrategyName();try{let o=await a.processColors(t),l=performance.now()-s;return{strategy:a,result:o,processingTime:l,success:!0}}catch(o){let l=performance.now()-s;return u?.debug?.error("ColorOrchestrator",`Strategy ${a.getStrategyName()} failed:`,o),{strategy:a,result:this.createErrorResult(t,a,o),processingTime:l,success:!1,error:o instanceof Error?o.message:"Unknown error"}}});return await Promise.all(n)}mergeStrategyResults(t,e){let i=t.filter(r=>r.success);if(i.length===0)return this.createFallbackResult(e);if(i.length===1)return i[0].result;let n={priorityWeighting:!0,conflictResolution:"merge",preserveMetadata:!0,consciousnessBlending:!0,oklabCoordination:this.oklabCoordinationEnabled};return this.performResultMerge(i,e,n)}performResultMerge(t,e,i){let n=t.sort((s,o)=>{let l=this.strategySelector.getStrategyMetadata(s.strategy.getStrategyName())?.priority||0;return(this.strategySelector.getStrategyMetadata(o.strategy.getStrategyName())?.priority||0)-l}),r=n[0].result,a={processedColors:{...r.processedColors},accentHex:r.accentHex,accentRgb:r.accentRgb,metadata:{...r.metadata,strategy:"enhanced-orchestrator",mergedStrategies:n.map(s=>s.strategy.getStrategyName()),totalProcessingTime:n.reduce((s,o)=>s+o.processingTime,0)},context:e};for(let s=1;s<n.length;s++){let o=n[s].result;if(Object.entries(o.processedColors).forEach(([l,m])=>{if(i.conflictResolution==="override")s===1&&(a.processedColors[l]=m);else if(i.conflictResolution==="merge"){let d=o.metadata.strategy;a.processedColors[`${d}-${l}`]=m}}),i.preserveMetadata){let l=o.metadata.strategy;a.metadata[`${l}-metadata`]=o.metadata}}return i.consciousnessBlending&&this.applyConsciousnessBlending(a,n),i.oklabCoordination&&this.applyOKLABCoordination(a,n),a}applyConsciousnessBlending(t,e){let i=0,n=0,r=0,a=0;if(e.forEach(s=>{let l=(this.strategySelector.getStrategyMetadata(s.strategy.getStrategyName())?.qualityScore||5)/10,m=this.hexToRgb(s.result.accentHex);m&&(n+=m.r*l,r+=m.g*l,a+=m.b*l,i+=l)}),i>0){let s=Math.round(n/i),o=Math.round(r/i),l=Math.round(a/i);t.accentHex=this.rgbToHex(s,o,l),t.accentRgb=`${s},${o},${l}`,t.metadata.consciousnessBlending={strategyCount:e.length,totalWeight:i,blendedAccent:t.accentHex}}}async coordinateOKLABProcessing(t,e){let i=performance.now();try{let n=t.filter(l=>l.success),r={};n.forEach(l=>{Object.entries(l.result.processedColors).forEach(([m,d])=>{d&&d.startsWith("#")&&(r[`${l.strategy.getStrategyName()}-${m}`]=d)})});let a=this.getOptimalOKLABPreset(e),s=this.oklabProcessor.processColorPalette(r,a);n.forEach(l=>{let m=l.strategy.getStrategyName();l.oklabData=Object.values(s).filter(d=>d.originalHex in r&&Object.keys(r).find(h=>h.startsWith(m)&&r[h]===d.originalHex))});let o=performance.now()-i;this.orchestrationMetrics.oklabCoordinations++,this.orchestrationMetrics.oklabProcessingTime+=o,u?.debug?.log("ColorOrchestrator","OKLAB coordination completed",{strategiesCoordinated:n.length,colorsProcessed:Object.keys(r).length,preset:a.name,processingTime:o})}catch(n){u?.debug?.error("ColorOrchestrator","OKLAB coordination failed:",n)}}applyOKLABCoordination(t,e){try{let i=[];if(e.forEach(r=>{r.oklabData&&i.push(...r.oklabData)}),i.length===0)return;let n=this.calculatePerceptuallyUniformAccent(i);if(n){t.accentHex=n.enhancedHex,t.accentRgb=`${n.enhancedRgb.r},${n.enhancedRgb.g},${n.enhancedRgb.b}`;let r=this.oklabProcessor.generateCSSVariables(n,"sn-oklab-unified");Object.entries(r).forEach(([a,s])=>{t.processedColors[a]=s}),t.metadata.oklabCoordination={enabled:!0,strategiesCoordinated:e.length,colorsProcessed:i.length,perceptualAccent:n.enhancedHex,lightness:n.oklabEnhanced.L,chroma:n.oklchEnhanced.C,hue:n.oklchEnhanced.H}}}catch(i){u?.debug?.error("ColorOrchestrator","OKLAB coordination application failed:",i)}}calculatePerceptuallyUniformAccent(t){if(t.length===0)return null;if(t.length===1)return t[0]||null;let e=0,i=0,n=0,r=0;if(t.forEach(m=>{let d=Math.sqrt(m.oklabEnhanced.a**2+m.oklabEnhanced.b**2),h=Math.max(.1,d);i+=m.oklabEnhanced.L*h,n+=m.oklabEnhanced.a*h,r+=m.oklabEnhanced.b*h,e+=h}),e===0)return t[0]||null;let a={L:i/e,a:n/e,b:r/e},s=Cn(a.L,a.a,a.b),o=fe(s.r,s.g,s.b),l=M.getPreset("STANDARD");return this.oklabProcessor.processColor(o,l)}getStatus(){return{isProcessing:this.isProcessing,...this.currentStrategy?{currentStrategy:this.currentStrategy}:{},queueSize:this.processingQueue.length,processedContextsCount:this.processedContexts.size,maxQueueSize:this.MAX_QUEUE_SIZE,contextCacheTTL:this.CONTEXT_CACHE_TTL,orchestrationMetrics:{...this.orchestrationMetrics},oklabCoordinationEnabled:this.oklabCoordinationEnabled}}setSelectionCriteria(t){this.selectionCriteria={...this.selectionCriteria,...t},u?.debug?.log("ColorOrchestrator","Selection criteria updated",t)}getPerformanceMetrics(){return{processedCount:this.processedCount,averageProcessingTime:this.processedCount>0?this.totalProcessingTime/this.processedCount:0,lastProcessingTime:this.lastProcessingTime,totalProcessingTime:this.totalProcessingTime}}registerStrategy(t){this.registry.register(t)}getRegistry(){return this.registry}estimateMemoryMB(){let t=performance.memory;return t&&t.usedJSHeapSize&&t.jsHeapSizeLimit?(t.jsHeapSizeLimit-t.usedJSHeapSize)/(1024*1024):this.detectMobile()?256:1024}detectMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}buildStrategySelectionCriteria(t){return{...this.selectionCriteria,settingsContext:{dynamicAccentEnabled:this.settingsManager.get("sn-dynamic-accent-enabled")??!0,gradientIntensity:this.settingsManager.get("sn-gradient-intensity")??"balanced",webglEnabled:this.settingsManager.get("sn-webgl-enabled")??!0,visualGuideMode:this.settingsManager.get("sn-visual-guide-mode")??"cosmic",depthLayersEnabled:this.settingsManager.get("sn-depth-enabled")??!0,consciousnessLevel:this.settingsManager.get("sn-consciousness-level")??.8,breathingAnimationEnabled:this.settingsManager.get("sn-breathing-enabled")??!0},musicContext:t.musicData,deviceContext:{supportsWebGL:this.deviceDetector.hasWebGLSupport?this.deviceDetector.hasWebGLSupport():!1,performanceLevel:this.deviceDetector.recommendPerformanceQuality(),memoryCapacity:window.navigator.deviceMemory?window.navigator.deviceMemory*1024:4096,isMobile:/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}}}getOptimalOKLABPreset(t){let e=this.selectionCriteria.userPreferences?.intensity||.8,i=t.musicData?.energy||.5,n=(e+i)/2;return n>=.8?M.getPreset("COSMIC"):n>=.6?M.getPreset("VIBRANT"):n>=.4?M.getPreset("STANDARD"):M.getPreset("SUBTLE")}async applyColorResult(t){try{g.emit("colors:harmonized",{processedColors:t.processedColors,accentHex:t.accentHex||"#cba6f7",accentRgb:t.accentRgb||"203,166,247",strategies:[t.metadata.strategy],processingTime:t.metadata.processingTime,trackUri:t.metadata.trackUri,coordinationMetrics:{detectedGenre:t.metadata.genre||"unknown",emotionalState:t.metadata.emotion||"neutral",oklabPreset:t.metadata.oklabPreset||"default",coordinationStrategy:t.metadata.strategy,musicInfluenceStrength:t.metadata.intensity||.5},processingMode:"orchestrated"});let e=new CustomEvent("colors/harmonized",{detail:{type:"colors/harmonized",payload:{...t,cssVariables:t.processedColors}}});document.dispatchEvent(e)}catch(e){u?.debug?.error("ColorOrchestrator","Failed to apply color result:",e)}}generateCacheKey(t){return`${t.trackUri}-${t.timestamp}-${JSON.stringify(t.musicData||{})}`}getCachedResult(t){return this.resultCache.get(t)||null}cacheResult(t,e){if(this.resultCache.size>=this.cacheMaxSize){let i=this.resultCache.keys().next().value;i&&this.resultCache.delete(i)}this.resultCache.set(t,e),setTimeout(()=>{this.resultCache.delete(t)},this.cacheTimeoutMs)}updateDeviceCapabilities(){this.selectionCriteria.deviceCapabilities={hasWebGL:this.deviceDetector.hasWebGLSupport?this.deviceDetector.hasWebGLSupport():!1,memoryMB:window.navigator.deviceMemory?window.navigator.deviceMemory*1024:4096,isMobile:/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}}loadUserPreferences(){try{this.selectionCriteria.userPreferences={harmonicMode:this.settingsManager.get("sn-visual-guide-mode")??"cosmic",intensity:this.settingsManager.get("sn-consciousness-level")??.8,enableAdvancedBlending:this.settingsManager.get("sn-advanced-blending")??!0}}catch(t){u?.debug?.warn("ColorOrchestrator","Failed to load user preferences:",t)}}createErrorResult(t,e,i){return{processedColors:t.rawColors,accentHex:"#cba6f7",accentRgb:"203,166,247",metadata:{strategy:e.getStrategyName(),processingTime:0,error:i instanceof Error?i.message:"Unknown error"},context:t}}createFallbackResult(t){return{processedColors:t.rawColors,accentHex:"#cba6f7",accentRgb:"203,166,247",metadata:{strategy:"fallback",processingTime:0,error:"All strategies failed"},context:t}}async applyFallbackColors(t){let e=this.createFallbackResult(t);await this.applyColorResult(e)}updateOrchestrationMetrics(t,e){this.orchestrationMetrics.totalProcessingTime+=e,this.orchestrationMetrics.strategiesProcessed+=t.length,this.orchestrationMetrics.strategiesSucceeded+=t.filter(n=>n.success).length,this.orchestrationMetrics.strategiesFailed+=t.filter(n=>!n.success).length;let i=t.filter(n=>n.success).map(n=>n.processingTime);i.length>0&&(this.orchestrationMetrics.averageStrategyTime=i.reduce((n,r)=>n+r,0)/i.length)}hexToRgb(t){let e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}rgbToHex(t,e,i){return"#"+((1<<24)+(t<<16)+(e<<8)+i).toString(16).slice(1)}getOrchestrationMetrics(){return{...this.orchestrationMetrics}}clearCache(){this.resultCache.clear(),u?.debug?.log("ColorOrchestrator","Result cache cleared")}setOKLABCoordinationEnabled(t){this.oklabCoordinationEnabled=t,u?.debug?.log("ColorOrchestrator",`OKLAB coordination ${t?"enabled":"disabled"}`)}isOKLABCoordinationEnabled(){return this.oklabCoordinationEnabled}getOKLABProcessor(){return this.oklabProcessor}async destroy(){g.unsubscribeAll("ColorOrchestrator"),this.clearCache(),this.processingQueue=[],this.isProcessing=!1,this.isInitialized=!1,this.processedContexts.clear(),this.strategySelector.destroy(),u?.debug?.log("ColorOrchestrator","Enhanced color orchestrator destroyed")}},ot=new Ln});var ct,Bn,Fn,Gn,Hn,On=y(()=>{"use strict";ct=class{constructor(t={}){this.initialized=!1;this.emotionHistory=[];this.currentEmotion=null;this.emotionCache=new Map;this.emotionSubscribers=new Set;this.config={emotionSensitivity:.7,confidenceThreshold:.6,smoothingFactor:.3,memoryDecay:.1,consciousnessAwareness:!0,organicFlowDetection:!0,cinematicAnalysis:!0,analysisInterval:500,cacheSize:100,...t},this.valenceEnergyMapper=new Bn,this.audioFeatureAnalyzer=new Fn,this.temperatureCalculator=new Gn,this.consciousnessDetector=new Hn}async initialize(){if(!this.initialized)try{await this.valenceEnergyMapper.initialize(),await this.audioFeatureAnalyzer.initialize(),await this.temperatureCalculator.initialize(),this.config.consciousnessAwareness&&await this.consciousnessDetector.initialize(),this.initialized=!0,console.log("\u{1F3B5} MusicEmotionAnalyzer initialized with consciousness awareness")}catch(t){throw console.error("\u274C Failed to initialize MusicEmotionAnalyzer:",t),t}}updateAnimation(t){}async healthCheck(){let t=[];return this.initialized||t.push("MusicEmotionAnalyzer not initialized"),this.emotionHistory.length===0&&t.push("No emotion analysis history available"),this.currentEmotion&&this.currentEmotion.confidence<this.config.confidenceThreshold&&t.push(`Low emotion confidence: ${this.currentEmotion.confidence.toFixed(2)}`),{healthy:t.length===0,issues:t,metrics:{emotionHistorySize:this.emotionHistory.length,currentConfidence:this.currentEmotion?.confidence??0,subscriberCount:this.emotionSubscribers.size,cacheSize:this.emotionCache.size}}}destroy(){this.emotionSubscribers.clear(),this.emotionHistory=[],this.emotionCache.clear(),this.currentEmotion=null,this.initialized=!1}async analyzeEmotion(t,e){if(!this.initialized)throw new Error("MusicEmotionAnalyzer must be initialized before analysis");try{let i=this.createCacheKey(t);if(this.emotionCache.has(i)){let r=this.emotionCache.get(i);if(r)return this.updateCurrentEmotion(r),r}let n=await this.performEmotionAnalysis(t,e);return this.cacheEmotion(i,n),this.updateCurrentEmotion(n),this.notifyEmotionUpdate(n),n}catch(i){return console.error("\u274C Error analyzing emotion:",i),this.createNeutralEmotion(t)}}getCurrentEmotion(){return this.currentEmotion}getEmotionHistory(t){return t?this.emotionHistory.slice(-t):[...this.emotionHistory]}onEmotionUpdate(t){return this.emotionSubscribers.add(t),()=>{this.emotionSubscribers.delete(t)}}updateConfig(t){this.config={...this.config,...t}}async performEmotionAnalysis(t,e){let i=this.audioFeatureAnalyzer.extractCharacteristics(t),n=this.valenceEnergyMapper.mapToEmotion(t.valence,t.energy,i),r=this.temperatureCalculator.calculateTemperature(n,i),a={};this.config.consciousnessAwareness&&(a=await this.consciousnessDetector.analyze(t,i,e));let s=this.applyTemporalSmoothing(n,i);return{primary:s.primary,secondary:s.secondary,intensity:s.intensity,confidence:s.confidence,valence:t.valence,arousal:t.energy,dominance:this.calculateDominance(t,i),colorTemperature:r,timestamp:Date.now(),duration:this.calculateEmotionDuration(s,i),musicalCharacteristics:{...i,organicFlow:a.organicFlow??i.organicFlow,cinematicDepth:a.cinematicDepth??i.cinematicDepth,consciousnessResonance:a.consciousnessResonance??.5}}}applyTemporalSmoothing(t,e){if(!this.currentEmotion||this.config.smoothingFactor===0)return t;let i=this.config.smoothingFactor,n=t.intensity*(1-i)+this.currentEmotion.intensity*i,r=t.confidence*(1-i)+this.currentEmotion.confidence*i;return{primary:t.confidence>this.config.confidenceThreshold?t.primary:this.currentEmotion.primary,secondary:t.secondary,intensity:n,confidence:r}}calculateDominance(t,e){let i=Math.min(e.tempo/140,1),n=t.energy,r=Math.min((t.loudness+60)/60,1);return i*.3+n*.4+r*.3}calculateEmotionDuration(t,e){let n=6e4/e.tempo,r=t.confidence*2;return Math.min(2e3*n*r,1e4)}createCacheKey(t){return[Math.round(t.valence*100),Math.round(t.energy*100),Math.round(t.danceability*100),Math.round(t.acousticness*100),t.key,t.mode].join("-")}cacheEmotion(t,e){if(this.emotionCache.size>=this.config.cacheSize){let i=this.emotionCache.keys().next().value;i!==void 0&&this.emotionCache.delete(i)}this.emotionCache.set(t,e)}updateCurrentEmotion(t){this.currentEmotion=t,this.emotionHistory.push(t),this.emotionHistory.length>1e3&&(this.emotionHistory=this.emotionHistory.slice(-500))}notifyEmotionUpdate(t){this.emotionSubscribers.forEach(e=>{try{e(t)}catch(i){console.error("\u274C Error in emotion subscriber callback:",i)}})}createNeutralEmotion(t){return{primary:"serenity",secondary:[],intensity:.5,confidence:.3,valence:t.valence??.5,arousal:t.energy??.5,dominance:.5,colorTemperature:6500,timestamp:Date.now(),duration:3e3,musicalCharacteristics:this.audioFeatureAnalyzer.extractCharacteristics(t)}}},Bn=class{async initialize(){}mapToEmotion(t,e,i){let n,r=[],a,s=.8;return t>=.6&&e>=.6?(n=i.danceability>.7?"excitement":"joy",r=["joy","excitement"],a=Math.min(t+e-.2,1)):t>=.6&&e<.4?(n=i.acousticness>.6?"serenity":"love",r=["serenity","love"],a=t*.8):t<.4&&e>=.6?(n=i.mode===0?"anger":"fear",r=["anger","fear"],a=e):t<.4&&e<.4?(n=i.acousticness>.5?"melancholy":"sadness",r=["sadness","melancholy"],a=(1-t)*.8):(i.instrumentalness>.8?(n="transcendence",r=["transcendence","consciousness"]):(n="nostalgia",r=["nostalgia"]),a=Math.abs(t-.5)+Math.abs(e-.5),s=.6),i.organicFlow>.8&&r.push("organic-flow"),i.consciousnessResonance>.7&&r.push("consciousness"),{primary:n,secondary:r,intensity:a,confidence:s}}},Fn=class{async initialize(){}extractCharacteristics(t){return{tempo:t.tempo,key:t.key,mode:t.mode,timeSignature:t.timeSignature,energy:t.energy,danceability:t.danceability,acousticness:t.acousticness,instrumentalness:t.instrumentalness,liveness:t.liveness,speechiness:t.speechiness,organicFlow:this.calculateOrganicFlow(t),cinematicDepth:this.calculateCinematicDepth(t),consciousnessResonance:this.calculateConsciousnessResonance(t)}}calculateOrganicFlow(t){let e=t.acousticness*.4,i=(1-Math.min(t.tempo/140,1))*.3,n=(1-t.energy)*.2,r=t.danceability*.1;return Math.min(e+i+n+r,1)}calculateCinematicDepth(t){let e=t.instrumentalness*.4,i=(1-t.liveness)*.2,n=(1-t.speechiness)*.2,r=Math.abs(t.energy-.5)*.2;return Math.min(e+i+n+r,1)}calculateConsciousnessResonance(t){let e=1-Math.abs(t.valence-.5)*2,i=1-Math.abs(t.energy-.4)*2,n=t.instrumentalness*.3,r=t.acousticness*.2;return Math.max(0,(e+i)*.5+n+r)}},Gn=class{async initialize(){}calculateTemperature(t,e){let i;switch(t.primary){case"joy":case"excitement":i=8e3;break;case"love":case"serenity":i=3e3;break;case"anger":i=15e3;break;case"fear":i=12e3;break;case"sadness":case"melancholy":i=2e3;break;case"nostalgia":i=2500;break;case"transcendence":case"consciousness":i=6500;break;case"organic-flow":i=4e3;break;default:i=6500}let n=(t.intensity-.5)*2e3,r=(e.tempo-120)*10,a=(e.energy-.5)*1e3,s=i+n+r+a;return Math.max(1e3,Math.min(2e4,s))}},Hn=class{async initialize(){}async analyze(t,e,i){let n=e.organicFlow,r=e.cinematicDepth,a=e.consciousnessResonance;if(i?.waveform){let s=this.analyzeWaveformPatterns(i.waveform);n=Math.min(1,n+s.smoothness*.2),r=Math.min(1,r+s.dynamicRange*.3),a=Math.min(1,a+s.harmonicComplexity*.2)}return{organicFlow:n,cinematicDepth:r,consciousnessResonance:a}}analyzeWaveformPatterns(t){let e=0,i=0,n=0;if(t.length>1){let r=0;for(let o=1;o<t.length;o++){let l=t[o],m=t[o-1];l!==void 0&&m!==void 0&&(r+=Math.abs(l-m))}e=1-Math.min(r/t.length,1);let a=Math.max(...t),s=Math.min(...t);i=a-s,n=Math.min(this.estimateHarmonicContent(t),1)}return{smoothness:e,dynamicRange:i,harmonicComplexity:n}}estimateHarmonicContent(t){let e=0;for(let i=1;i<t.length;i++){let n=t[i],r=t[i-1];n!==void 0&&r!==void 0&&n>=0!=r>=0&&e++}return Math.min(e/(t.length*.1),1)}}});var Le,Ke,zn=y(()=>{"use strict";qt();gn();D();A();xe();ne();bt();Ca();K();An();ge();ai();On();Le=class Le extends Q{constructor(e,i,n,r){super(e,i||I,n,null,r||null);this.emergentEngine=null;this.userIntensity=.7;this.evolutionEnabled=!0;this._evolutionTimer=null;this._pendingPaletteRefresh=null;this._lastGenre=null;if(this.systemName="ColorHarmonyEngine",this.paletteExtensionManager=new ti(this.config,this.utils),this.semanticColorManager=new at({enableDebug:this.config.enableDebug,fallbackToSpiceColors:!0,cacheDuration:5e3}),this.currentTheme=this.detectCurrentTheme(),e&&typeof e.harmonicIntensity=="number"&&Number.isFinite(e.harmonicIntensity)){let a=Math.max(0,Math.min(1,e.harmonicIntensity));this.userIntensity=a}this.harmonyMetrics={totalHarmonyCalculations:0,musicInfluencedAdjustments:0,temporalMemoryEvents:0,performance:[]},this.musicalMemory={recentTracks:[],userColorPreferences:new Map,energyHistory:[],maxMemorySize:50},this.kineticState={currentPulse:0,breathingPhase:0,lastBeatTime:0,visualMomentum:0},this.catppuccinPalettes={frappe:{accents:{rosewater:"#f2d5cf",flamingo:"#eebebe",pink:"#ff6b9d",mauve:"#c77dff",red:"#ff4757",maroon:"#ea999c",peach:"#ff7675",yellow:"#fdcb6e",green:"#6c5ce7",teal:"#00cec9",sky:"#74b9ff",sapphire:"#0984e3",blue:"#a29bfe",lavender:"#fd79a8"},neutrals:{base:"#303446",surface0:"#414559",surface1:"#51576d",surface2:"#626880"}},latte:{accents:{rosewater:"#dc8a78",flamingo:"#dd7878",pink:"#e84393",mauve:"#a55eea",red:"#fd79a8",maroon:"#e64553",peach:"#fd7f28",yellow:"#f39c12",green:"#00b894",teal:"#00cec9",sky:"#0984e3",sapphire:"#6c5ce7",blue:"#74b9ff",lavender:"#a29bfe"},neutrals:{base:"#eff1f5",surface0:"#e6e9ef",surface1:"#dce0e8",surface2:"#c5c9d1"}},macchiato:{accents:{rosewater:"#f4dbd6",flamingo:"#f0c6c6",pink:"#ff6b9d",mauve:"#c77dff",red:"#ff4757",maroon:"#ee99a0",peach:"#ff7675",yellow:"#fdcb6e",green:"#6c5ce7",teal:"#00cec9",sky:"#74b9ff",sapphire:"#0984e3",blue:"#a29bfe",lavender:"#fd79a8"},neutrals:{base:"#24273a",surface0:"#363a4f",surface1:"#494d64",surface2:"#5b6078"}},mocha:{accents:{rosewater:"#f5e0dc",flamingo:"#f2cdcd",pink:"#ff6b9d",mauve:"#c77dff",red:"#ff4757",maroon:"#eba0ac",peach:"#ff7675",yellow:"#fdcb6e",green:"#6c5ce7",teal:"#00cec9",sky:"#74b9ff",sapphire:"#0984e3",blue:"#a29bfe",lavender:"#fd79a8"},neutrals:{base:"#1e1e2e",surface0:"#313244",surface1:"#45475a",surface2:"#585b70"}}},this.vibrancyConfig={defaultBlendRatio:.75,minimumSaturation:.6,maximumDesaturation:.1,contrastBoostIntensity:1.4,harmonyTolerance:.3,artisticSaturationBoost:1.35,cosmicLuminanceBoost:1.25,energyResponsiveness:.8,getBlendRatio(a="artist-vision"){return{"corporate-safe":.6,"artist-vision":.75,"cosmic-maximum":.85}[a]||this.defaultBlendRatio}},this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Initialized with Year 3000 Quantum Empathy"),e&&typeof e.harmonicEvolution=="boolean"&&(this.evolutionEnabled=e.harmonicEvolution),this.emotionalTemperatureMapper=new J(this.config.enableDebug),this.oklabProcessor=new M(this.config.enableDebug),this.musicEmotionAnalyzer=new ct({emotionSensitivity:.7,confidenceThreshold:.6,consciousnessAwareness:!0,organicFlowDetection:!0,cinematicAnalysis:!0,analysisInterval:500}),this.genreGradientEvolution=new rt(void 0,null,null,this.settingsManager),this.oklabState={currentPreset:M.PRESETS.STANDARD,processedPalette:{},perceptualGradientCache:new Map,colorHarmonyCache:new Map,lastProcessingTime:0},this.emotionalState={currentEmotion:null,emotionHistory:[],lastEmotionUpdate:0,emotionInfluenceIntensity:.8},this.genreState={currentGenre:"unknown",genreConfidence:0,genreHistory:[],lastGenreUpdate:0,genreInfluenceIntensity:.7},this._boundSettingsChangeHandler=this._handleSettingsChange.bind(this),this._boundArtisticModeHandler=this._handleArtisticModeChanged.bind(this),document.addEventListener("year3000SystemSettingsChanged",this._boundSettingsChangeHandler),document.addEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),this.evolutionEnabled&&this._startEvolutionLoop()}getCurrentActivePalette(){try{if(j.getCurrentPaletteSystem()==="year3000"){let i=j.getCurrentPalette(),n=j.getCurrentDefaultFlavor(),r=i[n];if(!r)throw new Error(`No palette found for flavor: ${n}`);let a={},s={};return Object.entries(r).forEach(([o,l])=>{["base","surface0","surface1","surface2","mantle","crust"].includes(o)?s[o]=l.hex:a[o]=l.hex}),{accents:a,neutrals:s}}else return this.catppuccinPalettes[this.currentTheme]}catch(e){return console.warn("[ColorHarmonyEngine] Failed to get active palette, using fallback:",e),this.catppuccinPalettes[this.currentTheme]}}updateAnimation(e,i){let n=i??e;this.onAnimate(n)}onAnimate(e){this._updateCSSVariables(e),this._calculateBeatPulse(e),g.emitSync("performance:frame",{deltaTime:e,fps:60,memoryUsage:performance.memory?.usedJSHeapSize||0,timestamp:performance.now()})}_updateCSSVariables(e){let i={"--sn-harmony-energy":this.kineticState.visualMomentum.toFixed(3),"--sn-harmony-pulse":this.kineticState.currentPulse.toFixed(3),"--sn-harmony-breathing-phase":(Math.sin(this.kineticState.breathingPhase)*.5+.5).toFixed(3)};this.kineticState.musicIntensityMultiplier!==void 0&&(i["--sn-harmony-intensity"]=this.kineticState.musicIntensityMultiplier.toFixed(3)),this.kineticState.valenceGravity!==void 0&&(i["--sn-harmony-valence"]=this.kineticState.valenceGravity.toFixed(3)),this.kineticState.beatPhase!==void 0&&(i["--sn-harmony-beat-phase"]=this.kineticState.beatPhase.toFixed(3)),this.kineticState.hueShift!==void 0&&(i["--sn-harmony-hue-shift"]=`${this.kineticState.hueShift.toFixed(1)}deg`);let n=Math.max(0,Math.min(1,this.kineticState.currentPulse*1.2));i["--sn-text-glow-intensity"]=n.toFixed(3),g.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:i,timestamp:Date.now()})}_calculateBeatPulse(e){this.kineticState.currentPulse*=Math.pow(.95,e/16.67),this.kineticState.breathingPhase+=e/1e3*.5,this.kineticState.breathingPhase>2*Math.PI&&(this.kineticState.breathingPhase-=2*Math.PI),this._emitGradientBreathingEvents(e)}_emitGradientBreathingEvents(e){let i=this._calculateCurrentEnergyLevel(),n=this._detectBeatFromAudioAnalysis();Math.random()<.1&&g.emit("music:energy",{energy:i.energy,valence:i.valence,tempo:120,timestamp:performance.now()}),n.detected&&g.emit("music:beat",{intensity:n.intensity,confidence:n.confidence,timestamp:performance.now(),bpm:120})}_calculateCurrentEnergyLevel(){let e=.5+Math.sin(this.kineticState.breathingPhase)*.3;return{energy:Math.max(.2,e),valence:.5+this.kineticState.currentPulse*.3,arousal:.4+this.kineticState.currentPulse*.4}}_detectBeatFromAudioAnalysis(){let i=this.kineticState.currentPulse;return i>.3?{detected:!0,intensity:Math.min(1,i*1.5),confidence:Math.min(1,(i-.3)/(1-.3))}:Math.sin(this.kineticState.breathingPhase)>.8?{detected:!0,intensity:.4,confidence:.6}:{detected:!1,intensity:0,confidence:0}}async initialize(){await super.initialize();let e=this.performanceMonitor?this.performanceMonitor.cssConsciousnessController:void 0;this.semanticColorManager.initialize(e),g.subscribe("colors:extracted",this.handleColorExtraction.bind(this),"ColorHarmonyEngine");try{ot.registerStrategy(this),this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Registered with ColorOrchestrator as strategy processor.")}catch(i){console.warn("\u{1F3A8} [ColorHarmonyEngine] Failed to register with ColorOrchestrator:",i)}try{await this.musicEmotionAnalyzer.initialize(),this.musicEmotionAnalyzer.onEmotionUpdate(i=>{this.handleEmotionUpdate(i)}),this.config.enableDebug&&console.log("\u{1F3AD} [ColorHarmonyEngine] MusicEmotionAnalyzer initialized with consciousness awareness")}catch(i){console.warn("\u{1F3AD} [ColorHarmonyEngine] Failed to initialize MusicEmotionAnalyzer:",i)}try{await this.genreGradientEvolution.initialize(),this.config.enableDebug&&console.log("\u{1F3B6} [ColorHarmonyEngine] GenreGradientEvolution initialized with aesthetic intelligence")}catch(i){console.warn("\u{1F3B6} [ColorHarmonyEngine] Failed to initialize GenreGradientEvolution:",i)}this.config.enableDebug&&(console.log("\u{1F3A8} [ColorHarmonyEngine] Initialized with Year 3000 Quantum Empathy via BaseVisualSystem and SemanticColorManager."),console.log("\u{1F3A8} [ColorHarmonyEngine] Subscribed to 'colors/extracted' events for strategy pattern processing.")),this.initialized=!0}handleEmotionUpdate(e){if(this.initialized)try{this.emotionalState.currentEmotion=e,this.emotionalState.emotionHistory.push(e),this.emotionalState.lastEmotionUpdate=Date.now(),this.emotionalState.emotionHistory.length>50&&(this.emotionalState.emotionHistory=this.emotionalState.emotionHistory.slice(-25)),g.emit("emotion:analyzed",{emotion:e,colorTemperature:e.colorTemperature,consciousnessLevel:e.musicalCharacteristics.consciousnessResonance,organicFlow:e.musicalCharacteristics.organicFlow,cinematicDepth:e.musicalCharacteristics.cinematicDepth,timestamp:e.timestamp}),this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Emotion updated: ${e.primary} (intensity: ${e.intensity.toFixed(2)}, confidence: ${e.confidence.toFixed(2)})`),this.triggerEmotionalColorUpdate(e)}catch(i){console.error("\u{1F3AD} [ColorHarmonyEngine] Error handling emotion update:",i)}}triggerEmotionalColorUpdate(e){this.emotionalState.emotionInfluenceIntensity>0&&e.confidence>.6&&(this._pendingPaletteRefresh&&clearTimeout(this._pendingPaletteRefresh),this._pendingPaletteRefresh=setTimeout(()=>{this.refreshPaletteWithEmotion(e),this._pendingPaletteRefresh=null},100))}async refreshPaletteWithEmotion(e){try{let i={primaryEmotion:e.primary,emotionIntensity:e.intensity,colorTemperature:e.colorTemperature,valence:e.valence,arousal:e.arousal,dominance:e.dominance,organicFlow:e.musicalCharacteristics.organicFlow,cinematicDepth:e.musicalCharacteristics.cinematicDepth,consciousnessResonance:e.musicalCharacteristics.consciousnessResonance};g.emit("emotionalColorContext:updated",i),this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Refreshing colors with ${e.primary} emotion influence`)}catch(i){console.error("\u{1F3AD} [ColorHarmonyEngine] Error refreshing palette with emotion:",i)}}async healthCheck(){return this.getCurrentActivePalette()?{healthy:!0,ok:!0,details:"Palettes are loaded correctly.",issues:[],system:"ColorHarmonyEngine"}:{healthy:!1,ok:!1,details:`Current theme '${this.currentTheme}' not found in palettes.`,issues:[`Current theme '${this.currentTheme}' not found in palettes.`],system:"ColorHarmonyEngine"}}async processColors(e){let i=performance.now();try{let{rawColors:n,trackUri:r,musicData:a}=e,s=this.determineOptimalOKLABPreset(e);this.oklabState.currentPreset=s;let o=await this.analyzeGenreAesthetics(a,n),l=await this.getAdvancedEmotionalTemperature(a,n),m=await this.blendWithAdvancedOKLAB(n,a,l,o||void 0),d=m.VIBRANT||m.PROMINENT||Object.values(m)[0]||"#a6adc8",h=this.utils.hexToRgb(d),p=h?`${h.r},${h.g},${h.b}`:"166,173,200";try{let P={processedColors:m,accentHex:d,accentRgb:p,originalColors:n,trackUri:r,musicData:a,timestamp:Date.now(),strategies:["ColorHarmonyEngine"],processingTime:performance.now()-i,coordinationMetrics:{detectedGenre:o?.genre||"unknown",genreConfidence:o?.confidence||0,emotionalState:this.emotionalState.currentEmotion?.primary||"neutral",oklabPreset:s?.name||"standard",coordinationStrategy:"genre-emotion-color-unified",musicInfluenceStrength:this.genreState.genreInfluenceIntensity}};g.emitSync("colors:harmonized",P),this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Emitted colors:harmonized via UnifiedEventBus (facade pattern):",{processedColors:Object.keys(m),accentHex:d,noDomEvents:"correct architecture"})}catch(P){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Failed to emit colors:harmonized event:",P)}let b=performance.now()-i;this.harmonyMetrics.totalHarmonyCalculations++,this.harmonyMetrics.performance.push(b);let v={processedColors:m,accentHex:d,accentRgb:p,metadata:{strategy:"CatppuccinHarmony",processingTime:b,cacheKey:`catppuccin-${r}-${this.currentTheme}`,harmonicIntensity:this.userIntensity},context:e},C=this.generateAdvancedOKLABCSSVariables(v);return this.applyCSSVariablesToDOM(C),this.generatePerceptualGradientData(v),this.updateAdvancedHarmonyMetrics(v,b),g.emitSync("colors:harmonized",{processedColors:v.processedColors,accentHex:v.accentHex,accentRgb:v.accentRgb,strategies:v.metadata?.strategy?[v.metadata.strategy]:["ColorHarmonyEngine"],processingTime:b,trackUri:v.context.trackUri}),this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Processed colors via strategy pattern in ${b.toFixed(2)}ms`,{accentHex:d,strategy:"CatppuccinHarmony",cssVariablesCount:Object.keys(C).length}),v}catch(n){return console.error("[ColorHarmonyEngine] Strategy processing failed:",n),{processedColors:{VIBRANT:"#a6adc8"},accentHex:"#a6adc8",accentRgb:"166,173,200",metadata:{strategy:"CatppuccinHarmony",processingTime:performance.now()-i,error:String(n)},context:e}}}getStrategyName(){return"CatppuccinHarmony"}canProcess(e){return e&&e.rawColors&&Object.keys(e.rawColors).length>0}getEstimatedProcessingTime(e){let n=Object.keys(e.rawColors||{}).length;return 5*Math.max(1,n/5)}async handleColorExtraction(e){try{if(!this.initialized){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Received color extraction event but not initialized");return}let i={rawColors:e.rawColors,trackUri:e.trackUri,timestamp:e.timestamp,harmonicMode:this.currentTheme,musicData:e.musicData,performanceHints:{preferLightweight:!1,enableAdvancedBlending:!0,maxProcessingTime:100}};this.canProcess(i)?await this.processColors(i):this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Cannot process color context:",i)}catch(i){console.error("[ColorHarmonyEngine] Error handling color extraction event:",i)}}generateCSSVariables(e){let i={};i["--sn-accent-hex"]=e.accentHex,i["--sn-accent-rgb"]=e.accentRgb,i[Le.CANONICAL_HEX_VAR]=e.accentHex,i[Le.CANONICAL_RGB_VAR]=e.accentRgb;let n=e.processedColors,r=n.VIBRANT||n.PROMINENT||e.accentHex,a=n.DARK_VIBRANT||n.DESATURATED||r,s=n.VIBRANT_NON_ALARMING||n.LIGHT_VIBRANT||r;i["--sn-bg-gradient-primary"]=r,i["--sn-bg-gradient-secondary"]=a,i["--sn-bg-gradient-accent"]=s;let o=this.utils.hexToRgb(r),l=this.utils.hexToRgb(a),m=this.utils.hexToRgb(s);return o&&(i["--sn-bg-gradient-primary-rgb"]=`${o.r},${o.g},${o.b}`),l&&(i["--sn-bg-gradient-secondary-rgb"]=`${l.r},${l.g},${l.b}`),m&&(i["--sn-bg-gradient-accent-rgb"]=`${m.r},${m.g},${m.b}`),this.generateOKLABVariables(i,e),this.config.enableDebug&&console.log("\u{1F527} [ColorHarmonyEngine] Generated background gradient CSS variables:",{primary:`${r} -> ${i["--sn-bg-gradient-primary-rgb"]}`,secondary:`${a} -> ${i["--sn-bg-gradient-secondary-rgb"]}`,accent:`${s} -> ${i["--sn-bg-gradient-accent-rgb"]}`,totalVariables:Object.keys(i).length,note:"CSS mapping automatically updates --sn-gradient-* variables"}),i}generateOKLABVariables(e,i){try{let n=i.accentHex,r=i.processedColors,a=r.DARK_VIBRANT||r.DESATURATED||n,s=this.utils.hexToRgb(n),o=this.utils.hexToRgb(a);if(s){let l=this.utils.rgbToOklab(s.r,s.g,s.b),m={L:Math.min(1,l.L*1.1),a:l.a*1.15,b:l.b*1.15},d=this.utils.oklabToRgb(m.L,m.a,m.b);e["--sn-color-oklab-bright-highlight-rgb"]=`${d.r},${d.g},${d.b}`,e["--sn-color-oklab-primary-r"]=Math.round(d.r).toString(),e["--sn-color-oklab-primary-g"]=Math.round(d.g).toString(),e["--sn-color-oklab-primary-b"]=Math.round(d.b).toString(),e["--sn-color-oklab-accent-r"]=Math.round(d.r).toString(),e["--sn-color-oklab-accent-g"]=Math.round(d.g).toString(),e["--sn-color-oklab-accent-b"]=Math.round(d.b).toString(),e["--sn-color-oklab-accent-luminance"]=m.L.toFixed(3);let h=this.convertOklabToOklch(m);e["--sn-color-oklch-accent-l"]=h.L.toFixed(3),e["--sn-color-oklch-accent-c"]=h.C.toFixed(3),e["--sn-color-oklch-accent-h"]=h.H.toFixed(1),e["--sn-color-oklch-primary-l"]=h.L.toFixed(3),e["--sn-color-oklch-primary-c"]=h.C.toFixed(3),e["--sn-color-oklch-primary-h"]=h.H.toFixed(1)}if(o){let l=this.utils.rgbToOklab(o.r,o.g,o.b),m={L:Math.max(.05,l.L*.3),a:l.a*.8,b:l.b*.8},d=this.utils.oklabToRgb(m.L,m.a,m.b);e["--sn-color-oklab-dynamic-shadow-rgb"]=`${d.r},${d.g},${d.b}`,e["--sn-color-oklab-base-luminance"]=m.L.toFixed(3)}this.config.enableDebug&&console.log("\u{1F52C} [ColorHarmonyEngine] Generated OKLAB-processed variables:",{primaryColor:n,secondaryColor:a,oklabVariablesCount:Object.keys(e).filter(l=>l.includes("oklab")).length,oklchVariablesCount:Object.keys(e).filter(l=>l.includes("oklch")).length})}catch(n){this.config.enableDebug&&console.warn("\u{1F52C} [ColorHarmonyEngine] OKLAB processing failed, using fallbacks:",n);let r=this.utils.hexToRgb(i.accentHex);r&&(e["--sn-color-oklab-bright-highlight-rgb"]=`${r.r},${r.g},${r.b}`,e["--sn-color-oklab-dynamic-shadow-rgb"]=`${Math.round(r.r*.3)},${Math.round(r.g*.3)},${Math.round(r.b*.3)}`)}}convertOklabToOklch(e){let i=e.L,n=Math.sqrt(e.a*e.a+e.b*e.b),r=Math.atan2(e.b,e.a)*(180/Math.PI);return r<0&&(r+=360),{L:i,C:n,H:r}}detectCurrentTheme(){let e=this.utils.getRootStyle();if(!e)return console.warn("[ColorHarmonyEngine detectCurrentTheme] Root element not found. Defaulting to mocha."),"mocha";let n=getComputedStyle(e).getPropertyValue("--spice-main").trim(),r=n.startsWith("#")?n.substring(1).toUpperCase():n.toUpperCase(),s={303446:"frappe",EFF1F5:"latte","24273A":"macchiato","1E1E2E":"mocha"}[r];if(s)return this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Detected Catppuccin theme: ${s}`),s;this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Unknown theme detected (${r}), attempting to generate fallback`);let o=`custom-${r.toLowerCase()}`;try{let l=this.paletteExtensionManager.generateFallbackPalette(o);this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Generated fallback palette for theme: ${o}`,l)}catch(l){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Failed to generate fallback palette:",l)}return this.config.enableDebug&&console.log(`[ColorHarmonyEngine] Falling back to mocha theme for unknown base color: ${r}`),"mocha"}async _getGenreAwarePalette(e){let i=this.getCurrentActivePalette();if(!e||!i)return i;try{let n={name:this.currentTheme,version:"1.0.0",accents:i.accents,neutrals:i.neutrals,metadata:{author:"Catppuccin",description:`${this.currentTheme} flavor`,temperature:"neutral"}},r=this.paletteExtensionManager.applyGenreAwareModifications(n,e);return{accents:r.accents,neutrals:r.neutrals}}catch(n){return this.config.enableDebug&&console.warn(`[ColorHarmonyEngine] Failed to apply genre modifications for ${e}:`,n),i}}getMusicIntensityMultiplier(e=.5,i=.5){let n=this.config.getCurrentMultipliers().musicEnergyBoost,r=e>.7?1.3:e>.4?1:.8,a=i>.6?1.2:i<.4?.9:1;return n*r*a}validateColorHarmony(e,i="general"){let n=performance.now();this.harmonyMetrics.totalHarmonyCalculations++;let r={general:{minContrast:1.8,minHarmony:this.vibrancyConfig.harmonyTolerance},search:{minContrast:2.8,minHarmony:.4},navigation:{minContrast:2.5,minHarmony:.45},text:{minContrast:4.5,minHarmony:.6},accent:{minContrast:1.5,minHarmony:.3}},a=r[i]||r.general,s=this.getCurrentActivePalette();if(!s?.neutrals?.base){let P=`[StarryNight] Catppuccin palette or base neutral not found for theme: ${this.currentTheme}`;return console.error(P),{isValid:!1,error:"Palette configuration error.",contrastRatio:0,harmonyScore:0,meetsContrast:!1,isHarmonious:!1,artisticMode:this.config.artisticMode,adjustedRequirements:a,recommendations:[]}}let o=s.neutrals.base,l=this.utils.rgbToHex(e.r,e.g,e.b),m=this.utils.calculateContrastRatio(l,o),d=this.calculateHarmonyScore(e,s),h=this.config.artisticMode,p={...a};h==="cosmic-maximum"?(p.minContrast*=.7,p.minHarmony*=.6):h==="artist-vision"&&(p.minContrast*=.85,p.minHarmony*=.8);let b=m>=p.minContrast,v=d>=p.minHarmony,C=performance.now();return this.harmonyMetrics.performance.push(C-n),{isValid:b&&v,contrastRatio:m,harmonyScore:d,meetsContrast:b,isHarmonious:v,artisticMode:h,adjustedRequirements:p,recommendations:this.generateRecommendations(e,m,d,p)}}calculateHarmonyScore(e,i){let n=this.utils.rgbToHsl(e.r,e.g,e.b),r=0,a=Object.values(i.accents);for(let s of a){let o=this.utils.hexToRgb(s);if(!o)continue;let l=this.utils.rgbToHsl(o.r,o.g,o.b),m=Math.abs(n.h-l.h),d=Math.min(m,360-m),h=[0,30,60,90,120,150,180,210,240,270,300,330];if(h.some(b=>Math.abs(d-b)<20)){let b=1-Math.min(...h.map(v=>Math.abs(d-v)))/20;r=Math.max(r,b)}}return r}findBestHarmoniousAccent(e,i){let n={name:"mauve",hex:this.utils.getRootStyle()?.style.getPropertyValue("--sn-dynamic-accent")?.trim()||this.utils.getRootStyle()?.style.getPropertyValue("--spice-accent")?.trim()||"#cba6f7",rgb:{r:203,g:166,b:247}},r=["mauve","lavender","blue","sapphire","sky","pink","peach","teal"],a=-1,s=this.utils.rgbToHsl(e.r,e.g,e.b);for(let o of r){let l=i.accents[o];if(l){let m=this.utils.hexToRgb(l);if(!m)continue;let d=this.utils.rgbToHsl(m.r,m.g,m.b),h=Math.abs(s.h-d.h),b=1-Math.min(h,360-h)/180,v=d.s*.3,C=b+v;C>a&&(a=C,n={name:o,hex:l,rgb:m})}}return n}blendColors(e,i,n=this.vibrancyConfig.defaultBlendRatio){let r=Math.max(0,Math.min(1,n)),a=this.utils.rgbToOklab(e.r,e.g,e.b),s=this.utils.rgbToOklab(i.r,i.g,i.b),o=(L,$)=>L*r+$*(1-r),l={L:o(a.L,s.L),a:o(a.a,s.a),b:o(a.b,s.b)},m=this.utils.oklabToRgb(l.L,l.a,l.b),d=this.utils.rgbToHsl(m.r,m.g,m.b),h=this.config?.artisticMode??"artist-vision",p=this.emergentEngine?.getCurrentMultipliers?.()||void 0,b=h==="cosmic-maximum"&&!!p,v=p||{},C=b?(v.visualIntensityBase||1)*1.25:this.vibrancyConfig.artisticSaturationBoost,P=b?(v.aestheticGravityStrength||1)*1.15:this.vibrancyConfig.cosmicLuminanceBoost;d.s=Math.max(d.s,this.vibrancyConfig.minimumSaturation*100),d.s=Math.min(100,d.s*C),h!=="corporate-safe"&&(d.l=Math.min(95,d.l*P));let E=this.utils.hslToRgb(d.h,d.s,d.l);return{r:E.r,g:E.g,b:E.b}}blendWithCatppuccin(e,i=null){this.performanceMonitor?.emitTrace?.("[ColorHarmonyEngine] Starting blendWithCatppuccin");let n=null;if(i)try{let s={energy:i.energy||.5,valence:i.valence||.5,danceability:i.danceability,tempo:i.enhancedBPM||i.tempo,loudness:i.loudness,acousticness:i.acousticness,instrumentalness:i.instrumentalness,speechiness:i.speechiness,mode:i.mode,key:i.key,genre:i.genre};n=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(s),n&&(g.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:n.cssVariables,timestamp:Date.now()}),document.body.classList.remove(...Array.from(document.body.classList).filter(o=>o.startsWith("organic-emotion-"))),document.body.classList.add(n.cssClass),n.secondaryEmotion&&document.body.classList.add(`organic-emotion-blend-${n.secondaryEmotion}`)),this.config.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Applied emotional temperature:",n)}catch(s){this.config.enableDebug&&console.warn("\u{1F321}\uFE0F [ColorHarmonyEngine] Failed to apply emotional temperature:",s)}this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] blendWithCatppuccin debug:",{extractedColors:e,musicContext:i,emotionalTemperature:n,currentTheme:this.currentTheme,vibrancyConfig:this.vibrancyConfig,userIntensity:this.userIntensity});let r=this.getCurrentActivePalette();if(!r)return console.error(`[StarryNight] Catppuccin palette not found for theme: ${this.currentTheme}`),e;let a={};for(let[s,o]of Object.entries(e)){if(!o)continue;let l=this.utils.hexToRgb(o);if(!l){this.config.enableDebug&&console.warn(`\u{1F3A8} [ColorHarmonyEngine] Failed to parse color for role ${s}: ${o}`),a[s]=o;continue}let m=this.utils.rgbToHsl(l.r,l.g,l.b),d=m.s>=this.vibrancyConfig.minimumSaturation*100;this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Processing color ${s}:`,{originalColor:o,rgb:l,hsl:m,saturationCheck:d,minimumSaturationRequired:this.vibrancyConfig.minimumSaturation*100,actualSaturation:m.s});let h=this.findBestHarmoniousAccent(l,r);if(!h?.rgb){console.warn(`[StarryNight] Could not find a valid harmonious accent for role: ${s}. Using original color.`),a[s]=o;continue}let p=this.vibrancyConfig.getBlendRatio(this.config.artisticMode);if(n){let C=n.intensity;p*=C*this.userIntensity;let P=this.calculateTemperatureBlendInfluence(n.temperature);p*=P,p=Math.max(0,Math.min(1,p)),this.config.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Emotional temperature blend adjustment:",{originalRatio:this.vibrancyConfig.getBlendRatio(this.config.artisticMode),emotionalIntensity:C,temperatureInfluence:P,finalBlendRatio:p,temperature:n.temperature})}else if(i){let C=this.getMusicIntensityMultiplier(i.energy,i.valence);p*=C*this.userIntensity,p=Math.max(0,Math.min(1,p))}this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Blending ${s}:`,{extractedRgb:l,bestAccent:h.hex,blendRatio:p,artisticMode:this.config.artisticMode});let b=this.blendColors(l,h.rgb,p),v=this.utils.rgbToHex(b.r,b.g,b.b);a[s]=v,this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Final color for ${s}: ${o} \u2192 ${v}`)}return this.harmonyMetrics.musicInfluencedAdjustments++,this.performanceMonitor?.emitTrace?.("[ColorHarmonyEngine] Completed blendWithCatppuccin"),this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Final harmonized result:",{inputColors:e,outputColors:a,colorCount:Object.keys(a).length}),this.updateSemanticColorsWithHarmonizedPalette(a),a}updateSemanticColorsWithHarmonizedPalette(e){if(this.semanticColorManager)try{this.semanticColorManager.updateWithAlbumColors(e);let i=e.VIBRANT||e.PRIMARY,n=e.DARK_VIBRANT||e.SECONDARY,r=e.VIBRANT_NON_ALARMING||e.LIGHT_VIBRANT;i&&this.semanticColorManager.getSemanticColor("essentialBrightAccent").then(a=>{let s=this.blendWithSemanticColor(i,a,.7);this.applyCSSVariable("--spice-accent",s),this.applyCSSVariable("--spice-button-active",s)}),n&&this.semanticColorManager.getSemanticColor("backgroundElevatedHighlight").then(a=>{let s=this.blendWithSemanticColor(n,a,.5);this.applyCSSVariable("--spice-highlight",s)}),r&&this.semanticColorManager.getSemanticColor("textBrightAccent").then(a=>{let s=this.blendWithSemanticColor(r,a,.6);this.applyCSSVariable("--spice-text-accent",s)}),this.semanticColorManager.flushUpdates()}catch(i){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] Failed to update semantic colors:",i)}}blendWithSemanticColor(e,i,n){let r=this.utils.hexToRgb(e),a=this.utils.hexToRgb(i);if(!r||!a)return e;let s=this.blendColors(r,a,n);return this.utils.rgbToHex(s.r,s.g,s.b)}applyCSSVariable(e,i){g.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:{[e]:i},timestamp:Date.now()})}applyCSSVariablesToDOM(e){let i=globalThis.year3000System,n=i?.cssConsciousnessController||this.performanceMonitor?.cssConsciousnessController||i?.facadeCoordinator?.getCachedNonVisualSystem?.("UnifiedCSSVariableManager"),r=this.enhanceCSSVariablesForUIComponents(e);if(n&&typeof n.batchSetVariables=="function")try{n.batchSetVariables("ColorHarmonyEngine",r,"high","color-harmony-oklab-processing"),this.config.enableDebug&&console.log("\u{1F527} [ColorHarmonyEngine] Applied CSS variables via cssConsciousnessController batcher")}catch(a){this.config.enableDebug&&console.warn("\u{1F527} [ColorHarmonyEngine] cssConsciousnessController.batchSetVariables failed, using direct application:",a),this.applyVariablesDirectly(r)}else this.config.enableDebug&&console.log("\u{1F527} [ColorHarmonyEngine] cssConsciousnessController not available, using direct DOM application"),this.applyVariablesDirectly(r);g.emitSync("colors:applied",{cssVariables:r,accentHex:r["--sn-accent-hex"]||"#a6adc8",accentRgb:r["--sn-accent-rgb"]||"166,173,200",appliedAt:Date.now()}),this.config.enableDebug&&console.log("\u{1F52C} [ColorHarmonyEngine] Applied enhanced CSS variables to DOM:",{totalVariables:Object.keys(r).length,oklabVariables:Object.keys(r).filter(a=>a.includes("oklab")).length,oklchVariables:Object.keys(r).filter(a=>a.includes("oklch")).length,gradientVariables:Object.keys(r).filter(a=>a.includes("gradient")).length,spiceVariables:Object.keys(r).filter(a=>a.includes("spice")).length,sidebarVariables:Object.keys(r).filter(a=>a.includes("sidebar")).length,cssConsciousnessControllerUsed:!!n})}enhanceCSSVariablesForUIComponents(e){let i={...e},n=i["--sn-accent-hex"]||i[Le.CANONICAL_HEX_VAR],r=i["--sn-accent-rgb"]||i[Le.CANONICAL_RGB_VAR],a=i["--sn-bg-gradient-primary"],s=i["--sn-bg-gradient-primary-rgb"],o=i["--sn-bg-gradient-secondary"],l=i["--sn-bg-gradient-secondary-rgb"];n&&r&&(i["--spice-accent"]=n,i["--spice-button"]=n,i["--spice-button-active"]=n,i["--spice-rgb-accent"]=r,i["--spice-rgb-button"]=r,i["--spice-text-accent"]=n,i["--sn-sidebar-entanglement-color-rgb"]=r,i["--sn-sidebar-accent-color"]=n,i["--sn-sidebar-accent-rgb"]=r,i["--sn-sidebar-dynamic-accent"]=n,i["--sn-nowplaying-accent-color"]=n,i["--sn-nowplaying-accent-rgb"]=r,i["--sn-nowplaying-primary-color"]=n,i["--sn-nowplaying-primary-rgb"]=r,i["--sn-main-feed-accent-color"]=n,i["--sn-main-feed-accent-rgb"]=r,i["--sn-content-accent-color"]=n,i["--sn-content-accent-rgb"]=r),a&&s&&(i["--sn-primary-gradient-color"]=a,i["--sn-primary-gradient-rgb"]=s,i["--sn-main-feed-primary-color"]=a,i["--sn-main-feed-primary-rgb"]=s),o&&l&&(i["--sn-secondary-gradient-color"]=o,i["--sn-secondary-gradient-rgb"]=l,i["--sn-main-feed-secondary-color"]=o,i["--sn-main-feed-secondary-rgb"]=l);let m=i["--sn-color-oklab-bright-highlight-rgb"];m&&(i["--sn-consciousness-bright-accent-rgb"]=m,i["--sn-holographic-accent-rgb"]=m,i["--organic-holographic-rgb"]=m);let d=i["--sn-color-oklab-dynamic-shadow-rgb"];return d&&(i["--sn-consciousness-shadow-rgb"]=d,i["--sn-depth-shadow-rgb"]=d),i}applyVariablesDirectly(e){g.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:e,timestamp:Date.now()})}generateRecommendations(e,i,n,r){let a=[],s=this.getCurrentActivePalette(),o=this.utils.hexToRgb(s?.neutrals?.base||"#1e1e2e");if(!o)return[];if(i<r.minContrast){let l=this.utils.findRequiredLuminance(e,o,r.minContrast),m=this.utils.rgbToHsl(e.r,e.g,e.b),d=this.utils.hslToRgb(m.h,m.s,l),h={r:d.r,g:d.g,b:d.b};a.push({type:"contrast",suggestion:`Adjust luminance to meet contrast of ${r.minContrast}`,recommendedColor:this.utils.rgbToHex(h.r,h.g,h.b)})}if(n<r.minHarmony){let l=this.findBestHarmoniousAccent(e,s),m=this.blendColors(e,l.rgb,.5);a.push({type:"harmony",suggestion:`Blend with harmonious accent color to improve score to at least ${r.minHarmony}`,recommendedColor:this.utils.rgbToHex(m.r,m.g,m.b)})}return a}getPerformanceReport(){return{system:this.systemName,metrics:this.harmonyMetrics,kineticState:this.kineticState,musicalMemorySize:this.musicalMemory.recentTracks.length,currentTheme:this.currentTheme}}updateFromMusicAnalysis(e,i,n){if(!e)return;let r=e.genre;r&&r!==this._lastGenre&&this._applyGenrePalette(r).then(()=>{this._lastGenre=r,this._forcePaletteRepaint()}),this._updateMusicalMemory(e,n),this._updateKineticState(e),this._applyAestheticGravity(e),this._calculateMusicAwareDynamics(e)}_calculateMusicAwareDynamics(e){let{energy:i=.5,valence:n=.5,enhancedBPM:r=120,beatOccurred:a=!1}=e,s=this._calculateMusicIntensityMultiplier(i,n),o=this._calculateBeatPhase(r),l=(n-.5)*2,m=this._calculateHueShift(a,i,o);this.kineticState={...this.kineticState,musicIntensityMultiplier:s,beatPhase:o,valenceGravity:l,hueShift:m}}_calculateMusicIntensityMultiplier(e,i){let n=e*.7+i*.3,r=Math.abs(i-.5)*.4;return Math.max(.1,Math.min(2,n+r))}_calculateBeatPhase(e){let i=performance.now(),n=6e4/e;return i%n/n}_calculateHueShift(e,i,n){if(window.matchMedia("(prefers-reduced-motion: reduce)").matches)return 0;let r=this.config.artisticMode,a=r==="cosmic-maximum"?8:5,s=Math.sin(n*2*Math.PI)*a;e&&(s+=i*(r==="cosmic-maximum"?12:10));let o=r==="cosmic-maximum"?25:15;return Math.max(-o,Math.min(o,s))}_updateMusicalMemory(e,i){this.musicalMemory.recentTracks.unshift({trackUri:i,...e,timestamp:Date.now()}),this.musicalMemory.recentTracks.length>this.musicalMemory.maxMemorySize&&this.musicalMemory.recentTracks.pop(),this.musicalMemory.energyHistory.unshift(e.energy),this.musicalMemory.energyHistory.length>20&&this.musicalMemory.energyHistory.pop(),this.harmonyMetrics.temporalMemoryEvents++}_updateKineticState(e){let{energy:i,enhancedBPM:n,beatOccurred:r}=e,a=performance.now();r?(this.kineticState.lastBeatTime=a,this.kineticState.currentPulse=1):this.kineticState.currentPulse*=.95;let s=a-this.kineticState.lastBeatTime,o=6e4/(n||120);this.kineticState.breathingPhase=s%o/o*2*Math.PI,this.kineticState.visualMomentum=this.utils.lerp(this.kineticState.visualMomentum,i,.1)}_applyAestheticGravity(e){let{visualIntensity:i,valence:n,energy:r}=e,a=(n-.5)*2,s=(r-.5)*2,o=i;g.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:{"--sn-gravity-x":a.toFixed(3),"--sn-gravity-y":s.toFixed(3),"--sn-gravity-strength":o.toFixed(3)},timestamp:Date.now()})}generateHarmonicVariations(e){let i=this.utils.rgbToOklab(e.r,e.g,e.b),n=Math.max(0,Math.min(1,i.L*.75)),r=this.utils.oklabToRgb(n,i.a,i.b),a=Math.max(0,Math.min(1,i.L*1.25)),s=this.utils.oklabToRgb(a,i.a,i.b);return{darkVibrantHex:this.utils.rgbToHex(r.r,r.g,r.b),lightVibrantHex:this.utils.rgbToHex(s.r,s.g,s.b)}}getCurrentGradient(e=5){try{if(!this.getCurrentActivePalette())return null;let n=this.utils.getRootStyle();if(!n)return this.generateFallbackGradient(e);let r=getComputedStyle(n),a=this.getInheritedGradientColors(r);if(!a)return u?.debug?.warn("ColorHarmonyEngine","Failed to inherit processed gradient variables, using fallback"),this.generateFallbackGradient(e);let s=[],o=this.kineticState.musicIntensityMultiplier||1,l=this.kineticState.hueShift||0,m=this.kineticState.valenceGravity||.5,d=this.emotionalState?.currentEmotion?.colorTemperature||.5,{primary:h,secondary:p,accent:b,emotional:v,tertiary:C}=a,P=[h,p,b,v,C];for(let E=0;E<e;E++){let L=E/(e-1),$;if(e===1)$=b;else{let B=L*(P.length-1),W=Math.floor(B),V=Math.min(W+1,P.length-1),R=B-W,ae=Math.sin(d*Math.PI)*.3,Pe=Math.max(0,Math.min(1,R+ae)),pe=P[W],Je=P[V];pe&&Je?$={r:pe.r+(Je.r-pe.r)*Pe,g:pe.g+(Je.g-pe.g)*Pe,b:pe.b+(Je.b-pe.b)*Pe}:$=b}let G=this._applyConsciousnessModulation($,{musicInfluence:o,valenceGravity:m,hueShift:l,emotionalTemperature:d,position:L});s.push({r:Math.round(Math.max(0,Math.min(255,G.r))),g:Math.round(Math.max(0,Math.min(255,G.g))),b:Math.round(Math.max(0,Math.min(255,G.b)))})}return this.config?.enableDebug&&console.log(`[ColorHarmonyEngine] Generated gradient with ${e} stops:`,s),s}catch(i){let n=i instanceof Error?i.message:"Unknown error",r={method:"getCurrentGradient",stopCount:e,currentTheme:this.currentTheme,kineticState:this.kineticState,timestamp:Date.now(),error:n};u?.debug?.error("ColorHarmonyEngine","Failed to generate gradient colors",r),g.emit("system:error",{systemName:"ColorHarmonyEngine",error:`Gradient generation failed: ${n}`,severity:"error",timestamp:Date.now()});try{let a=this.generateFallbackGradient(e);if(a&&a.length>0)return u?.debug?.warn("ColorHarmonyEngine","Using fallback gradient after error",{fallbackColorCount:a.length}),a}catch(a){u?.debug?.error("ColorHarmonyEngine","Fallback gradient generation also failed",a)}return null}}getInheritedGradientColors(e){try{let i=this.parseRGBVariable(e,"--sn-oklab-processed-primary-rgb")||this.parseRGBVariable(e,"--sn-bg-gradient-primary-rgb")||this.parseRGBVariable(e,"--sn-musical-harmony-primary-rgb"),n=this.parseRGBVariable(e,"--sn-oklab-processed-secondary-rgb")||this.parseRGBVariable(e,"--sn-bg-gradient-secondary-rgb")||this.parseRGBVariable(e,"--sn-musical-harmony-secondary-rgb"),r=this.parseRGBVariable(e,"--sn-oklab-processed-accent-rgb")||this.parseRGBVariable(e,"--sn-bg-gradient-accent-rgb")||this.parseRGBVariable(e,"--sn-color-accent-rgb"),a=this.parseRGBVariable(e,"--sn-oklab-emotional-temperature-rgb")||this.parseRGBVariable(e,"--sn-emotional-temperature-warm-rgb")||r,s=this.parseRGBVariable(e,"--sn-oklab-processed-bright-highlight-rgb")||this.parseRGBVariable(e,"--sn-consciousness-flow-rgb")||this.parseRGBVariable(e,"--sn-musical-harmony-tertiary-rgb");return!i||!r?(u?.debug?.warn("ColorHarmonyEngine","Missing essential inherited colors",{hasPrimary:!!i,hasAccent:!!r}),null):{primary:i,secondary:n||i,accent:r,emotional:a||r,tertiary:s||r}}catch(i){return u?.debug?.error("ColorHarmonyEngine","Failed to inherit gradient colors:",i),null}}parseRGBVariable(e,i){try{let n=e.getPropertyValue(i).trim();if(!n)return null;let r=n.match(/(\d+),\s*(\d+),\s*(\d+)/);return r&&r[1]&&r[2]&&r[3]?{r:parseInt(r[1],10),g:parseInt(r[2],10),b:parseInt(r[3],10)}:null}catch{return null}}interpolateOKLABColors(e,i,n){let a=Math.pow(e.r/255,2.2),s=Math.pow(e.g/255,2.2),o=Math.pow(e.b/255,2.2),l=Math.pow(i.r/255,2.2),m=Math.pow(i.g/255,2.2),d=Math.pow(i.b/255,2.2),h=a+(l-a)*n,p=s+(m-s)*n,b=o+(d-o)*n;return{r:Math.round(Math.pow(h,1/2.2)*255),g:Math.round(Math.pow(p,1/2.2)*255),b:Math.round(Math.pow(b,1/2.2)*255)}}_applyConsciousnessModulation(e,i){try{let n=this.utils.rgbToHsl(e.r,e.g,e.b),{h:r,s:a,l:s}=n;a=Math.max(0,Math.min(1,a*(.7+i.musicInfluence*.6))),r=(r+i.hueShift+(i.emotionalTemperature-.5)*60)%360;let o=i.valenceGravity*.2*Math.sin(i.position*Math.PI);s=Math.max(.1,Math.min(.9,s+o));let l=this.utils.hslToRgb(r,a,s);return{r:l.r,g:l.g,b:l.b}}catch{return e}}generateFallbackGradient(e){try{let i=["#1e1e2e","#313244","#45475a","#585b70","#cba6f7","#f5c2e7","#fab387"];(e<2||e>i.length)&&(u?.debug?.warn("ColorHarmonyEngine",`Invalid fallback stopCount: ${e}, using default`),e=Math.min(Math.max(e,2),i.length));let n=[];for(let r=0;r<e;r++){let a=Math.floor(r/(e-1)*(i.length-1)),s=i[a],o=s?this.utils.hexToRgb(s):null;o?n.push(o):n.push({r:203,g:166,b:247})}return n.length<2&&n.push({r:30,g:30,b:46},{r:203,g:166,b:247}),u?.debug?.log("ColorHarmonyEngine",`Generated fallback gradient with ${n.length} colors`,n),n}catch(i){return u?.debug?.error("ColorHarmonyEngine","Critical error in fallback gradient generation",i),null}}async analyzeMusicEmotion(e,i){if(!this.initialized||!this.musicEmotionAnalyzer)return this.config.enableDebug&&console.warn("\u{1F3AD} [ColorHarmonyEngine] Cannot analyze music emotion: not initialized"),null;try{let n=await this.musicEmotionAnalyzer.analyzeEmotion(e,i);return this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Analyzed music emotion: ${n.primary} (${n.intensity.toFixed(2)} intensity, ${n.confidence.toFixed(2)} confidence)`),n}catch(n){return console.error("\u{1F3AD} [ColorHarmonyEngine] Error analyzing music emotion:",n),null}}getCurrentEmotion(){return this.emotionalState?.currentEmotion||null}getEmotionHistory(e=10){return this.emotionalState?.emotionHistory?this.emotionalState.emotionHistory.slice(-e):[]}setEmotionInfluenceIntensity(e){this.emotionalState&&(this.emotionalState.emotionInfluenceIntensity=Math.max(0,Math.min(1,e)),this.config.enableDebug&&console.log(`\u{1F3AD} [ColorHarmonyEngine] Emotion influence intensity set to ${this.emotionalState.emotionInfluenceIntensity}`))}_createVariant(e,i,n,r){let a=this.utils.rgbToOklab(e.r,e.g,e.b),s=Math.max(0,Math.min(1,a.L+i*.2)),o=.8+n*.4,l=a.a*o,m=a.b*o,d=r*.1,h=l*Math.cos(d)-m*Math.sin(d),p=l*Math.sin(d)+m*Math.cos(d);return this.utils.oklabToRgb(s,h,p)}_applyMusicInfluence(e,i,n){let r=1+Math.sin(n*Math.PI)*.2,a=Math.max(.7,Math.min(1.3,i*r));return{r:e.r*a,g:e.g*a,b:e.b*a}}setIntensity(e){let i=Math.max(0,Math.min(1,e));this.userIntensity=i,this.config?.enableDebug&&console.log(`[ColorHarmonyEngine] User harmonic intensity set to ${i}`)}updatePalette(e){e?.length&&(this.config?.enableDebug&&console.log("[ColorHarmonyEngine] updatePalette invoked",{count:e.length}),this.forceRepaint("external-palette"))}_handleSettingsChange(e){let{key:i,value:n}=e.detail||{};switch(i){case Qr:{let r=parseFloat(n);Number.isNaN(r)||this.setIntensity(r);break}case Xr:{let r=n==="true"||n===!0;this._setEvolutionEnabled(r);break}}}_handleArtisticModeChanged(){this.currentTheme=this.detectCurrentTheme(),this._pendingPaletteRefresh||(this._pendingPaletteRefresh=setTimeout(()=>{this._pendingPaletteRefresh=null,this.refreshPalette()},80))}_forcePaletteRepaint(){this.kineticState.hueShift=(this.kineticState.hueShift||0)+.01}_startEvolutionLoop(){if(this._evolutionTimer)return;let i=3e4/Math.max(.1,this.userIntensity);this._evolutionTimer=setInterval(()=>{let n=2*this.userIntensity,r=this.kineticState.hueShift??0;this.kineticState.hueShift=(r+n+360)%360-180},i)}_stopEvolutionLoop(){this._evolutionTimer&&(clearInterval(this._evolutionTimer),this._evolutionTimer=null)}_setEvolutionEnabled(e){this.evolutionEnabled!==e&&(this.evolutionEnabled=e,e?this._startEvolutionLoop():this._stopEvolutionLoop())}destroy(){this._stopEvolutionLoop(),document.removeEventListener("year3000SystemSettingsChanged",this._boundSettingsChangeHandler),document.removeEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),this.semanticColorManager&&this.semanticColorManager.destroy(),this.musicEmotionAnalyzer&&this.musicEmotionAnalyzer.destroy(),this.emotionalState&&(this.emotionalState.currentEmotion=null,this.emotionalState.emotionHistory=[]),super.destroy?.()}async refreshPalette(){try{let e=globalThis.year3000System;if(e?.updateColorsFromCurrentTrack){await e.updateColorsFromCurrentTrack();return}let i=this.utils.getRootStyle();if(!i)return;let r=getComputedStyle(i).getPropertyValue("--sn-gradient-primary").trim();if(r){let a=this.utils.hexToRgb(r),s={"--sn-bg-gradient-primary":r};a&&(s["--sn-bg-gradient-primary-rgb"]=`${a.r},${a.g},${a.b}`),g.emit("system:css-variables",{source:"ColorHarmonyEngine",variables:s,timestamp:Date.now()})}}catch(e){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] refreshPalette failed",e)}}async _applyGenrePalette(e){try{let i=await this._getGenreAwarePalette(e);if(!i)return;this.catppuccinPalettes[this.currentTheme]=i,await this.refreshPalette(),this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Genre changed to: ${e}`)}catch(i){this.config.enableDebug&&console.warn("[ColorHarmonyEngine] _applyGenrePalette failed",i)}}setEmergentEngine(e){this.emergentEngine=e}calculateTemperatureBlendInfluence(e){let i=Math.max(0,Math.min(1,(e-1e3)/19e3));return e<=4e3?1+(4e3-e)/3e3*.3:e>=8e3?1.1+(e-8e3)/12e3*.2:.9+Math.abs(e-6e3)/2e3*.2}forceRepaint(e="settings-change"){this.refreshPalette?.()}determineOptimalOKLABPreset(e){let i=e.musicData,n=M.PRESETS.STANDARD;if(i){let{energy:r=.5,valence:a=.5}=i;r>.8&&a>.7?n=M.PRESETS.COSMIC:r>.7&&a<.4?n=M.PRESETS.VIBRANT:r<.3&&(n=M.PRESETS.SUBTLE)}return e.performanceHints?.preferLightweight&&(n=M.PRESETS.SUBTLE),this.config?.enableDebug&&console.log("\u{1F52C} [ColorHarmonyEngine] OKLAB preset selection:",{energy:i?.energy,valence:i?.valence,selectedPreset:n.name,reason:this.getPresetSelectionReason(i,e)}),n}async getAdvancedEmotionalTemperature(e,i){if(!this.emotionalTemperatureMapper||!e)return null;try{let n={energy:e.energy||.5,valence:e.valence||.5,danceability:e.danceability,tempo:e.tempo,loudness:e.loudness,acousticness:e.acousticness,instrumentalness:e.instrumentalness,speechiness:e.speechiness,mode:e.mode,key:e.key,genre:e.genre},r=await this.enhanceWithAlbumArtPsychology(n,i),a=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(r);return this.config?.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Advanced emotional temperature with album art enhancement:",{input:n,enhanced:r,albumArtInfluence:i?Object.keys(i).length+" colors":"None",emotion:a.primaryEmotion,secondaryEmotion:a.secondaryEmotion,intensity:a.intensity,temperature:a.temperature,oklabPreset:a.oklabPreset.name,perceptualColor:a.perceptualColorHex}),a}catch(n){return console.warn("[ColorHarmonyEngine] Advanced emotional temperature analysis failed:",n),null}}async enhanceWithAlbumArtPsychology(e,i){if(!i||Object.keys(i).length===0)return e;try{let n=this.analyzeAlbumArtPsychology(i),r={...e},a=r.energy||.5,s=r.valence||.5;if(n.warmth>.6&&(r.energy=Math.min(1,a*(1+n.warmth*.3)),r.valence=Math.min(1,s+n.warmth*.2)),n.coolness>.6&&(r.energy=Math.max(0,a*(1-n.coolness*.2)),n.saturation>.5&&(r.valence=Math.min(1,s+n.coolness*.15))),n.saturation>.7&&(r.energy=Math.min(1,a+n.saturation*.2)),n.saturation<.3&&(r.valence=Math.max(0,s-.15),r.energy=Math.max(0,a-.1)),n.darkness>.7){let o=r.energy||a;o>.6?r.energy=Math.min(1,o+.1):r.valence=Math.max(0,(r.valence||s)-.2)}return n.brightness>.8&&(r.valence=Math.min(1,(r.valence||s)+n.brightness*.2)),n.harmony>.8?r.valence=Math.min(1,(r.valence||s)+.1):n.harmony<.3&&(r.energy=Math.min(1,(r.energy||a)+.15)),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Album art psychology enhancement:",{original:{energy:e.energy||.5,valence:e.valence||.5},enhanced:{energy:r.energy||.5,valence:r.valence||.5},colorPsychology:n,adjustments:{energyChange:(r.energy||.5)-(e.energy||.5),valenceChange:(r.valence||.5)-(e.valence||.5)}}),r}catch(n){return console.warn("[ColorHarmonyEngine] Album art psychology enhancement failed:",n),e}}analyzeAlbumArtPsychology(e){try{let i=Object.values(e);if(i.length===0)return{warmth:.5,coolness:.5,saturation:.5,brightness:.5,darkness:.5,harmony:.5,dominantHue:180,emotionalIntensity:.5,genreIndicators:{electronicLikelihood:.5,organicLikelihood:.5,metalHardcoreLikelihood:.5,popCommercialLikelihood:.5,jazzClassicalLikelihood:.5,folkAcousticLikelihood:.5},artistConsciousness:{visualSophistication:.5,artisticIntention:.5,culturalIndicators:[],emotionalDepth:.5}};let n=0,r=0,a=0,s=0,o=0,l=[];for(let G of i){let B=this.utils.hexToRgb(G);if(!B)continue;let W=this.utils.rgbToHsl(B.r,B.g,B.b),{h:V,s:R,l:ae}=W;l.push(V),V>=0&&V<=60||V>=300&&V<=360?n+=R*ae:V>=120&&V<=240&&(r+=R*ae),a+=R,s+=ae,o+=1-ae}let m=i.length,d=n/m,h=r/m,p=a/m,b=s/m,v=o/m,C=this.calculateColorHarmony(l),P=this.calculateDominantHue(l),E=Math.min(1,(p+this.calculateContrast(i))/2),L=this._analyzeGenreIndicatorsFromColors({warmth:Math.min(1,d),coolness:Math.min(1,h),saturation:p,brightness:b,darkness:v,harmony:C,dominantHue:P,emotionalIntensity:E}),$=this._analyzeArtistConsciousness(i,{avgSaturation:p,avgBrightness:b,harmony:C,emotionalIntensity:E,colorCount:i.length});return{warmth:Math.min(1,d),coolness:Math.min(1,h),saturation:p,brightness:b,darkness:v,harmony:C,dominantHue:P,emotionalIntensity:E,genreIndicators:L,artistConsciousness:$}}catch(i){return console.warn("[ColorHarmonyEngine] Album art psychology analysis failed:",i),{warmth:.5,coolness:.5,saturation:.5,brightness:.5,darkness:.5,harmony:.5,dominantHue:180,emotionalIntensity:.5,genreIndicators:{electronicLikelihood:.5,organicLikelihood:.5,metalHardcoreLikelihood:.5,popCommercialLikelihood:.5,jazzClassicalLikelihood:.5,folkAcousticLikelihood:.5},artistConsciousness:{visualSophistication:.5,artisticIntention:.5,culturalIndicators:[],emotionalDepth:.5}}}}calculateColorHarmony(e){if(e.length<=1)return 1;let i=0,n=[60,120,30,90];for(let a=0;a<e.length;a++)for(let s=a+1;s<e.length;s++){let o=e[a],l=e[s];if(o===void 0||l===void 0)continue;let m=Math.abs(o-l),d=Math.min(m,360-m);for(let h of n)Math.abs(d-h)<=15&&(i+=1)}let r=e.length*(e.length-1)/2;return Math.min(1,i/r)}calculateDominantHue(e){if(e.length===0)return 180;let i=new Array(12).fill(0);for(let r of e){let a=Math.floor(r/30);i[a]++}return i.indexOf(Math.max(...i))*30+15}calculateContrast(e){if(e.length<=1)return 0;let i=0,n=0;for(let r=0;r<e.length;r++)for(let a=r+1;a<e.length;a++){let s=e[r],o=e[a];if(!s||!o)continue;let l=this.utils.hexToRgb(s),m=this.utils.hexToRgb(o);if(l&&m){let d=(l.r*.299+l.g*.587+l.b*.114)/255,h=(m.r*.299+m.g*.587+m.b*.114)/255;i+=Math.abs(d-h),n++}}return n>0?i/n:0}async blendWithAdvancedOKLAB(e,i,n,r){let a={...e};try{let s=n?.oklabPreset||this.oklabState.currentPreset,o=s;r&&r.confidence>.5&&this.genreState.genreInfluenceIntensity>0&&(o=this.applyGenreColorAesthetics(s,r));let l=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING","LIGHT_VIBRANT"];for(let d of l){let h=e[d];if(h&&this.isValidHex(h))try{let p=r?`-${r.genre}`:"",b=`${h}-${o.name}${p}`;if(this.oklabState.processedPalette[b]){a[d]=this.oklabState.processedPalette[b].enhancedHex;continue}let v=this.oklabProcessor.processColor(h,o);a[d]=v.enhancedHex,this.oklabState.processedPalette[b]=v,this.config?.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] OKLAB enhanced ${d}:`,{original:h,enhanced:v.enhancedHex,preset:s.name,processingTime:v.processingTime})}catch(p){console.warn(`[ColorHarmonyEngine] OKLAB processing failed for ${d}:`,p)}}if(n?.perceptualColorHex&&a.PRIMARY)try{let d=this.oklabProcessor.interpolateOKLAB(a.PRIMARY,n.perceptualColorHex,n.intensity*.3,s);a.EMOTIONAL_BLEND=d.enhancedHex,this.config?.enableDebug&&console.log("\u{1F321}\uFE0F [ColorHarmonyEngine] Emotional color blending:",{primary:a.PRIMARY,emotionalColor:n.perceptualColorHex,blendFactor:n.intensity*.3,result:d.enhancedHex})}catch(d){console.warn("[ColorHarmonyEngine] Emotional color blending failed:",d)}this.oklabState.lastProcessingTime=Date.now();let m=this.getAlbumArtInfluenceSetting();if(m>0&&e&&Object.keys(e).length>0)try{let d=await this._applyDirectAlbumColorBlending(a,e,m,o);Object.assign(a,d),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Applied direct album color blending:",{albumInfluence:(m*100).toFixed(1)+"%",blendedKeys:Object.keys(d),note:"album colors now directly influence final UI colors"})}catch(d){console.warn("[ColorHarmonyEngine] Direct album color blending failed:",d)}if(this.semanticColorManager)try{this.semanticColorManager.updateWithAlbumColors(a),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Applied comprehensive Spicetify variable updates via strategy pattern:",{processedColorCount:Object.keys(a).length,methodUsed:"blendWithAdvancedOKLAB"})}catch(d){console.warn("[ColorHarmonyEngine] Failed to update Spicetify variables via strategy pattern:",d)}}catch(s){console.error("[ColorHarmonyEngine] Advanced OKLAB blending failed:",s)}return a}generateAdvancedOKLABCSSVariables(e){let i={};try{if(Object.entries(e.processedColors).forEach(([n,r])=>{r&&typeof r=="string"&&(i[`--sn-processed-${n.toLowerCase()}`]=r)}),Object.entries(this.oklabState.processedPalette).forEach(([n,r])=>{let[a,s]=n.split("-");if(a&&s){let o=`sn-oklab-${s.toLowerCase()}`,l=this.oklabProcessor.generateCSSVariables(r,o);Object.assign(i,l)}}),this.oklabState.perceptualGradientCache.size>0){let n=Array.from(this.oklabState.perceptualGradientCache.entries()),[r,a]=n[0]||[];if(a&&a.length>0){a.forEach((o,l)=>{let m=l/(a.length-1)*100;i[`--sn-oklab-gradient-stop-${l}`]=o.enhancedHex,i[`--sn-oklab-gradient-stop-${l}-rgb`]=`${o.enhancedRgb.r},${o.enhancedRgb.g},${o.enhancedRgb.b}`,i[`--sn-oklab-gradient-stop-${l}-pos`]=`${m}%`});let s=a.map((o,l)=>{let m=l/(a.length-1)*100;return`${o.enhancedHex} ${m}%`}).join(", ");i["--sn-oklab-perceptual-gradient"]=`linear-gradient(135deg, ${s})`,i["--sn-oklab-gradient-stop-count"]=a.length.toString()}}if(e.processedColors.EMOTIONAL_BLEND){i["--sn-consciousness-emotional-color"]=e.processedColors.EMOTIONAL_BLEND;let n=oe(e.processedColors.EMOTIONAL_BLEND);n&&(i["--sn-consciousness-emotional-rgb"]=`${n.r},${n.g},${n.b}`)}i["--sn-oklab-preset-active"]=this.oklabState.currentPreset.name,i["--sn-oklab-cache-size"]=Object.keys(this.oklabState.processedPalette).length.toString(),i["--sn-oklab-last-processing"]=this.oklabState.lastProcessingTime.toString(),this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Generated advanced OKLAB CSS variables:",{totalVariables:Object.keys(i).length,gradientStops:this.oklabState.perceptualGradientCache.size,oklabProcessedColors:Object.keys(this.oklabState.processedPalette).length})}catch(n){console.error("[ColorHarmonyEngine] Advanced OKLAB CSS variable generation failed:",n)}return i}generatePerceptualGradientData(e){try{let i=e.processedColors.PRIMARY,n=e.processedColors.SECONDARY||e.processedColors.EMOTIONAL_BLEND;if(!i||!this.isValidHex(i))return;let r=i,a=n&&this.isValidHex(n)?n:this.generateComplementaryColor(i),s=`${r}-${a}-${this.oklabState.currentPreset.name}`;if(this.oklabState.perceptualGradientCache.has(s))return;let o=7,l=this.oklabProcessor.generateOKLABGradient(r,a,o,this.oklabState.currentPreset);if(this.oklabState.perceptualGradientCache.set(s,l),this.oklabState.perceptualGradientCache.size>10){let m=this.oklabState.perceptualGradientCache.keys().next().value;m&&this.oklabState.perceptualGradientCache.delete(m)}this.config?.enableDebug&&console.log("\u{1F308} [ColorHarmonyEngine] Generated perceptual gradient data:",{startColor:r,endColor:a,stopCount:o,preset:this.oklabState.currentPreset.name,cacheKey:s,cacheSize:this.oklabState.perceptualGradientCache.size})}catch(i){console.error("[ColorHarmonyEngine] Perceptual gradient generation failed:",i)}}updateAdvancedHarmonyMetrics(e,i){try{let n=e.processedColors.PRIMARY,r=e.processedColors.SECONDARY,a=.5;if(n&&this.isValidHex(n)){let o=oe(n);if(o){let l=this.calculateColorVibrancy(o);a=Math.min(1,l*.8+.2)}}let s={processingTime:i,harmonyScore:a,oklabProcessedColors:Object.keys(this.oklabState.processedPalette).length,perceptualGradientsCached:this.oklabState.perceptualGradientCache.size,currentPreset:this.oklabState.currentPreset.name,lastUpdate:Date.now()};e.metadata&&(e.metadata.advancedHarmonyMetrics=s),this.config?.enableDebug&&console.log("\u{1F4CA} [ColorHarmonyEngine] Advanced harmony metrics updated:",s)}catch(n){console.error("[ColorHarmonyEngine] Advanced harmony metrics update failed:",n)}}getPresetSelectionReason(e,i){if(!e)return"No music data available";let{energy:n=.5,valence:r=.5}=e;return i.performanceHints?.preferLightweight?"Performance optimization requested":n>.8&&r>.7?"High energy + positive valence":n>.7&&r<.4?"High energy + negative valence":n<.3?"Low energy music":"Standard balanced processing"}generateComplementaryColor(e){try{let i=oe(e);if(!i)return e;let n=this.rgbToHsl(i.r,i.g,i.b),r=(n.h+180)%360,a=this.hslToRgb(r,n.s,n.l);return fe(a.r,a.g,a.b)}catch(i){return console.warn("[ColorHarmonyEngine] Complementary color generation failed:",i),e}}calculateColorVibrancy(e){let i=Math.max(e.r,e.g,e.b),n=Math.min(e.r,e.g,e.b),r=i-n;if(i===0)return 0;let a=r/i,s=i/255,o=1-Math.abs(s-.5)*2;return a*o}isValidHex(e){return/^#[0-9A-Fa-f]{6}$/.test(e)}rgbToHsl(e,i,n){e/=255,i/=255,n/=255;let r=Math.max(e,i,n),a=Math.min(e,i,n),s=r-a,o=0,l=0,m=(r+a)/2;if(s!==0){switch(l=m>.5?s/(2-r-a):s/(r+a),r){case e:o=(i-n)/s+(i<n?6:0);break;case i:o=(n-e)/s+2;break;case n:o=(e-i)/s+4;break}o/=6}return{h:o*360,s:l,l:m}}hslToRgb(e,i,n){e/=360;let r=(l,m,d)=>(d<0&&(d+=1),d>1&&(d-=1),d<1/6?l+(m-l)*6*d:d<1/2?m:d<2/3?l+(m-l)*(2/3-d)*6:l),a,s,o;if(i===0)a=s=o=n;else{let l=n<.5?n*(1+i):n+i-n*i,m=2*n-l;a=r(m,l,e+1/3),s=r(m,l,e),o=r(m,l,e-1/3)}return{r:Math.round(a*255),g:Math.round(s*255),b:Math.round(o*255)}}async analyzeGenreAesthetics(e,i){try{if(!this.genreGradientEvolution)return null;let n=this.genreGradientEvolution.getCurrentGenre(),r=this.genreGradientEvolution.getGenreConfidence();if(r<.3)return null;let a=this.genreGradientEvolution.getGenreCharacteristics(n),s=this.genreGradientEvolution.getGenreVisualStyle(n),o=1,l=r;if(i&&Object.keys(i).length>0)try{o=this._analyzeAlbumGenreHarmony(i,n,a).harmonyScore,l=r*o,this.config.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Album-Genre harmony analysis:",{genre:n,originalConfidence:(r*100).toFixed(1)+"%",harmonyScore:(o*100).toFixed(1)+"%",validatedConfidence:(l*100).toFixed(1)+"%",albumColorCount:Object.keys(i).length})}catch(m){console.warn("[ColorHarmonyEngine] Album-genre harmony analysis failed:",m)}return this.genreState.currentGenre=n,this.genreState.genreConfidence=l,this.genreState.lastGenreUpdate=Date.now(),this.genreState.genreHistory.unshift({genre:n,confidence:l,timestamp:Date.now()}),this.genreState.genreHistory.length>10&&(this.genreState.genreHistory=this.genreState.genreHistory.slice(0,10)),this.config.enableDebug&&console.log(`\u{1F3B6} [ColorHarmonyEngine] Genre aesthetic analysis: ${n} (${(l*100).toFixed(1)}% album-validated confidence)`),{genre:n,confidence:l,characteristics:a,visualStyle:s}}catch(n){return console.warn("[ColorHarmonyEngine] Error analyzing genre aesthetics:",n),null}}applyGenreColorAesthetics(e,i){let{characteristics:n,visualStyle:r,confidence:a}=i,s={...e,name:`${e.name}-${i.genre}`,description:`${e.description} with ${i.genre} aesthetic characteristics`},o=a*this.genreState.genreInfluenceIntensity;return n.saturation>.7?s.chromaBoost=Math.min(2,e.chromaBoost+.3*o):n.saturation<.3&&(s.chromaBoost=Math.max(.8,e.chromaBoost-.2*o)),n.harmonicComplexity>.7?s.vibrantThreshold=Math.max(.05,e.vibrantThreshold-.05*o):n.harmonicComplexity<.3&&(s.vibrantThreshold=Math.min(.2,e.vibrantThreshold+.03*o)),n.emotionalRange>.7&&n.organicness>.6?s.lightnessBoost=Math.max(.9,e.lightnessBoost-.1*o):n.artificialProcessing>.7&&(s.lightnessBoost=Math.min(1.4,e.lightnessBoost+.2*o)),r.contrastLevel>.7?s.shadowReduction=Math.max(.1,e.shadowReduction-.1*o):n.organicness>.6&&(s.shadowReduction=Math.min(.5,e.shadowReduction+.1*o)),this.config.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Applied ${i.genre} aesthetics to ${e.name} preset:`,{chromaBoost:`${e.chromaBoost} \u2192 ${s.chromaBoost}`,lightnessBoost:`${e.lightnessBoost} \u2192 ${s.lightnessBoost}`,vibrantThreshold:`${e.vibrantThreshold} \u2192 ${s.vibrantThreshold}`,genreInfluence:`${(o*100).toFixed(1)}%`}),s}_analyzeAlbumGenreHarmony(e,i,n){try{let r=1,a=[],s=Object.entries(e).map(([V,R])=>{let ae=this.utils.hexToRgb(R);return ae?this.utils.rgbToHsl(ae.r,ae.g,ae.b):null}).filter(V=>V!==null);if(s.length===0)return{harmonyScore:1,explanation:"No valid album colors found"};let o=s.reduce((V,R)=>V+R.s,0)/s.length,l=n.saturation||.5,m=Math.abs(o/100-l);m<.2?(r*=1.1,a.push(`album saturation matches genre (\xB1${(m*100).toFixed(1)}%)`)):m>.4&&(r*=.85,a.push(`album saturation differs from genre expectations (${(m*100).toFixed(1)}% diff)`));let d=s.reduce((V,R)=>V+R.h,0)/s.length,h=d>=15&&d<=45||d>=315&&d<=345,p=d>=180&&d<=270,b=n.energyLevel||.5;b>.6&&h?(r*=1.15,a.push("warm album colors match high-energy genre")):b<.4&&p?(r*=1.1,a.push("cool album colors match low-energy genre")):(b>.6&&p||b<.4&&h)&&(r*=.9,a.push("album color temperature differs from genre energy"));let v=s.reduce((V,R)=>V+R.l,0)/s.length,C=v<40,P=v>70;i.includes("metal")||i.includes("goth")||i.includes("dark")?C?(r*=1.2,a.push("dark album aesthetic matches genre")):P&&(r*=.8,a.push("bright album conflicts with dark genre aesthetic")):(i.includes("pop")||i.includes("dance")||i.includes("electronic"))&&P&&(r*=1.15,a.push("bright album aesthetic matches energetic genre"));let E=s.map(V=>V.h),L=Math.max(...E)-Math.min(...E),$=L<30,G=L>120,B=n.harmonicComplexity||.5;B>.7&&G?(r*=1.1,a.push("diverse album colors match complex genre")):B<.3&&$&&(r*=1.1,a.push("unified album colors match simple genre")),r=Math.max(.7,Math.min(1.3,r));let W=a.length>0?a.join("; "):"album colors analyzed for genre harmony";return{harmonyScore:r,explanation:W}}catch(r){return console.warn("[ColorHarmonyEngine] Album-genre harmony analysis error:",r),{harmonyScore:1,explanation:"harmony analysis failed, using default confidence"}}}getAlbumArtInfluenceSetting(){return .5}async _applyDirectAlbumColorBlending(e,i,n,r){let a={};try{let s=this._extractDominantAlbumColors(i);if(s.length===0)return{};let o=["PRIMARY","VIBRANT","PROMINENT","VIBRANT_NON_ALARMING"];for(let l of o){let m=e[l];if(!(!m||!this.isValidHex(m)))try{let d=this._selectHarmoniousAlbumColor(m,s);if(d){let h=this.oklabProcessor.interpolateOKLAB(m,d,n*.6,r);a[l]=h.enhancedHex,this.config?.enableDebug&&console.log(`\u{1F3A8} [ColorHarmonyEngine] Album-blended ${l}:`,{original:m,albumColor:d,blended:h.enhancedHex,blendFactor:(n*.6).toFixed(2)})}}catch(d){console.warn(`[ColorHarmonyEngine] Album blending failed for ${l}:`,d)}}if(s.length>0&&n>.3)try{let l=this._selectMostVibrantColor(s);if(l){let m=this.oklabProcessor.processColor(l,r);a.ALBUM_ACCENT=m.enhancedHex,this.config?.enableDebug&&console.log("\u{1F3A8} [ColorHarmonyEngine] Created ALBUM_ACCENT:",{source:l,enhanced:m.enhancedHex})}}catch(l){console.warn("[ColorHarmonyEngine] Album accent creation failed:",l)}return a}catch(s){return console.error("[ColorHarmonyEngine] Direct album color blending error:",s),{}}}_extractDominantAlbumColors(e){let i=[],n=["VIBRANT","DOMINANT","PRIMARY","PROMINENT","LIGHT_VIBRANT","DARK_VIBRANT"];for(let r of n){let a=e[r];a&&this.isValidHex(a)&&i.push(a)}return i.length<3&&Object.values(e).forEach(r=>{r&&this.isValidHex(r)&&!i.includes(r)&&i.push(r)}),i.slice(0,5)}_selectHarmoniousAlbumColor(e,i){if(i.length===0)return null;try{let n=this.utils.hexToRgb(e);if(!n)return i[0]||null;let r=this.utils.rgbToHsl(n.r,n.g,n.b),a=i[0]||null,s=0;for(let o of i){let l=this.utils.hexToRgb(o);if(!l)continue;let m=this.utils.rgbToHsl(l.r,l.g,l.b),d=Math.abs(r.h-m.h),h=Math.min(d,360-d),p=0;h<30?p=.9:h>150&&h<210?p=.8:h>90&&h<150?p=.6:p=.4,Math.abs(r.s-m.s)<20&&(p+=.1),p>s&&(s=p,a=o)}return a}catch(n){return console.warn("[ColorHarmonyEngine] Harmonious color selection failed:",n),i[0]||null}}_selectMostVibrantColor(e){if(e.length===0)return null;try{let i=e[0]||null,n=0;for(let r of e){let a=this.utils.hexToRgb(r);if(!a)continue;let s=this.utils.rgbToHsl(a.r,a.g,a.b),o=s.s/100*(1-Math.abs(s.l-50)/50);o>n&&(n=o,i=r)}return i}catch(i){return console.warn("[ColorHarmonyEngine] Most vibrant color selection failed:",i),e[0]||null}}_analyzeGenreIndicatorsFromColors(e){let{warmth:i,coolness:n,saturation:r,brightness:a,darkness:s,harmony:o,dominantHue:l,emotionalIntensity:m}=e,d=Math.min(1,r*.4+n*.3+(a>.7||s<.3?.2:0)+(l>=180&&l<=270?.1:0)),h=Math.min(1,(i>n?i:0)*.3+(r>=.3&&r<=.7?.3:0)+(a>=.4&&a<=.7?.2:0)+o*.2),p=Math.min(1,s*.4+m*.3+(l>=0&&l<=30||l>=330?.2:0)+(r>.6||r<.2?.1:0)),b=Math.min(1,(a>.6?a*.3:0)+r*.3+(i>.5?i*.2:0)+(m>.5?.2:0)),v=Math.min(1,o*.4+(r>=.4&&r<=.8?.3:0)+(a>=.3&&a<=.8?.2:0)+(i+n)/2*.1),C=Math.min(1,i*.4+(r>=.2&&r<=.6?.3:0)+o*.2+(l>=15&&l<=60?.1:0));return{electronicLikelihood:d,organicLikelihood:h,metalHardcoreLikelihood:p,popCommercialLikelihood:b,jazzClassicalLikelihood:v,folkAcousticLikelihood:C}}_analyzeArtistConsciousness(e,i){let{avgSaturation:n,avgBrightness:r,harmony:a,emotionalIntensity:s,colorCount:o}=i,l=Math.min(1,a*.4+(o>2&&o<=5?.3:.1)+(n>=.3&&n<=.8?.2:0)+(r>=.2&&r<=.8?.1:0)),m=Math.min(1,a*.5+s*.3+(o>=2&&o<=4?.2:0)),d=[];n>.8&&s>.7&&d.push("high-energy-culture"),a>.7&&n<.6&&d.push("minimalist-aesthetic"),r<.3&&s>.6&&d.push("dark-artistic"),r>.7&&n>.6&&d.push("commercial-pop");let h=Math.min(1,s*.5+(n>.4?.2:0)+(a>.5?.2:0)+(o>=3?.1:0));return{visualSophistication:l,artisticIntention:m,culturalIndicators:d,emotionalDepth:h}}};Le.CANONICAL_HEX_VAR="--sn-accent-hex",Le.CANONICAL_RGB_VAR="--sn-accent-rgb";Ke=Le});var lt,Ba=y(()=>{"use strict";lt=class{static async getAudioData(){try{return typeof Spicetify<"u"&&Spicetify.getAudioData?await Spicetify.getAudioData():(console.warn("[SpicetifyCompat] Spicetify.getAudioData not available"),null)}catch(t){return console.error("[SpicetifyCompat] Error fetching audio data:",t),null}}static isAvailable(){return typeof Spicetify<"u"&&!!Spicetify.getAudioData}static async getAudioDataWithRetry(t=200,e=10){for(let i=0;i<e;i++)try{let n=await this.getAudioData();if(n)return n}catch(n){i<e-1?(console.log(`[SpicetifyCompat] Retrying audio data fetch (${i+1}/${e})...`),await new Promise(r=>setTimeout(r,t))):console.warn(`[SpicetifyCompat] Audio data fetch failed after ${e} attempts:`,n)}return null}}});var je,Be,si=y(()=>{"use strict";U();ne();je={electronic:{energyBoost:1.1,beatEmphasis:1.2,precision:.9,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"dynamic"}},dance:{energyBoost:1.2,beatEmphasis:1.25,precision:.95,oklabPreset:"COSMIC",colorCharacteristics:{vibrancyLevel:"cosmic",emotionalRange:"extreme",colorTemperature:"dynamic"}},house:{energyBoost:1.2,beatEmphasis:1.25,precision:.95,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"warm"}},techno:{energyBoost:1.15,beatEmphasis:1.3,precision:1,oklabPreset:"COSMIC",colorCharacteristics:{vibrancyLevel:"cosmic",emotionalRange:"extreme",colorTemperature:"cool"}},trance:{energyBoost:1.15,beatEmphasis:1.1,precision:.85,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"dynamic"}},rock:{energyBoost:1.05,intensityMultiplier:1.1,dynamicRange:1.1,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"warm"}},metal:{energyBoost:1.15,intensityMultiplier:1.2,dynamicRange:1.2,oklabPreset:"COSMIC",colorCharacteristics:{vibrancyLevel:"cosmic",emotionalRange:"extreme",colorTemperature:"cool"}},punk:{energyBoost:1.2,intensityMultiplier:1.1,precision:.8,oklabPreset:"VIBRANT",colorCharacteristics:{vibrancyLevel:"vibrant",emotionalRange:"wide",colorTemperature:"dynamic"}},hiphop:{beatEmphasis:1.3,grooveFactor:1.2,tempoMultiplier:.95,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"warm"}},rap:{beatEmphasis:1.3,grooveFactor:1.2,tempoMultiplier:.95,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"}},jazz:{adaptiveVariation:!0,complexity:1.2,smoothingFactor:1.3,oklabPreset:"SUBTLE",colorCharacteristics:{vibrancyLevel:"subtle",emotionalRange:"wide",colorTemperature:"warm"}},classical:{gentleMode:!0,dynamicRange:1.4,tempoVariationHandling:"adaptive",oklabPreset:"SUBTLE",colorCharacteristics:{vibrancyLevel:"subtle",emotionalRange:"extreme",colorTemperature:"neutral"}},ambient:{subtleMode:!0,intensityReduction:.7,smoothingFactor:1.5,oklabPreset:"SUBTLE",colorCharacteristics:{vibrancyLevel:"subtle",emotionalRange:"narrow",colorTemperature:"cool"}},pop:{energyBoost:1.05,beatEmphasis:1.1,precision:.85,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"warm"}},rnb:{grooveFactor:1.25,smoothingFactor:1.1,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"warm"}},soul:{grooveFactor:1.3,smoothingFactor:1.15,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"wide",colorTemperature:"warm"}},default:{balanced:!0,energyBoost:1,beatEmphasis:1,precision:1,oklabPreset:"STANDARD",colorCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"}}},Be=class{constructor(t={}){this.config=t.YEAR3000_CONFIG||w,this.config.enableDebug&&console.log("\u{1F9EC} [GenreProfileManager] Initialized")}_getGenreFromAudioFeatures(t){if(!t)return"default";let{danceability:e=.5,energy:i=.5,acousticness:n=.5,instrumentalness:r=.5,tempo:a=120}=t;return r>.6&&n<.2&&i>.6?a>120?"techno":"electronic":e>.7&&i>.7?"dance":n>.7&&i<.4?"classical":n>.5&&r<.1?"jazz":i>.7&&r<.1&&e>.5?"rock":e>.7&&r<.2&&i>.5&&a<110?"hiphop":"default"}getProfileForTrack(t){let e=this._getGenreFromAudioFeatures(t),i=je[e];if(this.config.enableDebug&&console.log(`[GenreProfileManager] Detected genre: '${e}'. Applying profile.`),i)return i;let n=je.default;if(n)return n;throw new Error("[GenreProfileManager] Critical: Default genre profile is missing.")}detectGenre(t){return this._getGenreFromAudioFeatures(t)}getOKLABPresetForGenre(t){let e=je[t]||je.default,i=e.oklabPreset||"STANDARD";try{let n=M.getPreset(i);return this.config.enableDebug&&console.log(`\u{1F9EC} [GenreProfileManager] OKLAB preset for genre '${t}':`,{genre:t,preset:i,colorCharacteristics:e.colorCharacteristics}),n}catch(n){return this.config.enableDebug&&console.warn(`\u{1F9EC} [GenreProfileManager] Failed to get OKLAB preset '${i}' for genre '${t}', using STANDARD:`,n),M.getPreset("STANDARD")}}getOKLABPresetForTrack(t){let e=this.detectGenre(t);return this.getOKLABPresetForGenre(e)}getColorCharacteristicsForGenre(t){let i=(je[t]||je.default).colorCharacteristics||{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"};return this.config.enableDebug&&console.log(`\u{1F9EC} [GenreProfileManager] Color characteristics for genre '${t}':`,i),i}getColorCharacteristicsForTrack(t){let e=this.detectGenre(t);return this.getColorCharacteristicsForGenre(e)}createContextualOKLABPreset(t,e=1,i="contextual"){let n=this.detectGenre(t),r=this.getOKLABPresetForGenre(n),a=this.getColorCharacteristicsForGenre(n),s=t.energy||.5,o=t.danceability||.5,l=(s+o)/2*e,m=r.chromaBoost*(.8+l*.4),d=r.lightnessBoost*(.9+l*.2),h=M.createCustomPreset(`${n}-${i}`,`Contextual ${r.description} for ${n}`,d,m,r.shadowReduction,r.vibrantThreshold);return this.config.enableDebug&&console.log("\u{1F9EC} [GenreProfileManager] Created contextual OKLAB preset:",{genre:n,basePreset:r.name,contextualPreset:h.name,adjustments:{chromaBoost:`${r.chromaBoost} \u2192 ${m}`,lightnessBoost:`${r.lightnessBoost} \u2192 ${d}`,intensityMultiplier:e,combinedIntensity:l}}),h}getAllGenreOKLABMappings(){let t={};return Object.entries(je).forEach(([e,i])=>{t[e]={preset:i.oklabPreset||"STANDARD",characteristics:i.colorCharacteristics}}),this.config.enableDebug&&console.log("\u{1F9EC} [GenreProfileManager] All genre-OKLAB mappings:",t),t}}});var Y,ve,oi=y(()=>{"use strict";U();D();K();Ba();ye();si();ne();xe();Y={enableDebug:!0,enableBeatSynchronization:!0,enableGenreAnalysis:!0,enableMoodAdaptation:!0,bpmCalculation:{useEnhancedAlgorithm:!0,danceabilityWeight:.9,energyWeight:.6,bpmWeight:.6,energyThreshold:.5,danceabilityThreshold:.5,bpmThreshold:.8,maxBPM:180,minBPM:60},performance:{cacheSize:100,cacheTTL:3e5,maxRetries:10,retryDelay:200,enableMetrics:!0,processingTimeTarget:50},synchronization:{beatAccuracyTarget:50,maxSyncDelay:1e3,adaptiveQuality:!0,predictiveCaching:!0,debounceRapidChanges:200},genreProfiles:{electronic:{intensityMultiplier:1.2,precisionBoost:1.1},jazz:{smoothingFactor:1.3,adaptiveVariation:!0},classical:{gentleMode:!0,tempoVariationHandling:"adaptive"},rock:{energyBoost:1.15,consistentTiming:!0},ambient:{subtleMode:!0,intensityReduction:.7},hiphop:{beatEmphasis:1.25,rhythmPrecision:"high"},default:{balanced:!0}},musicVisualSync:{enhancedBPM:{fallbacks:{tempo:120,loudness:-5,key:0,timeSignature:4},danceabilityEstimation:{highDance:{min:125,max:145,value:.8},mediumDance:{min:100,max:124,value:.7},lowMediumDance:{min:80,max:99,value:.6},lowDance:{value:.5}},energyEstimation:{tempoRange:{min:80,max:160},loudnessRange:{min:-15,max:0},tempoWeight:.6,loudnessWeight:.4}}}},ve=class{constructor(t={}){this.isInitialized=!1;this.currentTrack=null;this.audioData=null;this.currentTrackUri=null;this.latestProcessedData=null;this.beatSchedulerTimer=null;this.songChangeDebounceTimer=null;this.nextBeatIndex=0;this.currentSongBeats=[];this.songStartTimestamp=0;this.metrics={bpmCalculations:0,beatSyncs:0,cacheHits:0,cacheMisses:0,avgProcessingTime:0,performance:[],errors:0,updates:0};this.unifiedCache=new Map;this.subscribers=new Map;this.beatSync={lastBeatTime:0,nextBeatTime:0,beatInterval:0,confidence:0,isActive:!1};this.performanceInterval=null;this.cacheCleanupInterval=null;this.CACHE_KEY_VERSION_PREFIX="v3";this.eventProcessingState={isProcessingEvent:!1,eventChain:[],lastEventTime:0,consecutiveEvents:0};this.MAX_CONSECUTIVE_EVENTS=5;this.EVENT_RESET_TIMEOUT=3e3;this.currentBeatVector={x:0,y:0};this.config=t.YEAR3000_CONFIG||w,this.utils=t.Year3000Utilities||I,this.settingsManager=t.settingsManager,this.year3000System=t.year3000System,this.genreProfileManager=t.genreProfileManager||new Be({YEAR3000_CONFIG:this.config}),this.oklabProcessor=new M(this.config.enableDebug),this.emotionalTemperatureMapper=new J(this.config.enableDebug),this.cacheTTL=Y.performance.cacheTTL,this.userPreferences=this.loadUserPreferences(),this.config.enableDebug&&(console.log("\u{1F3B5} MusicSyncService constructor called"),console.log("\u{1F3B5} [MusicSyncService] Initialized with GenreProfileManager support"))}get initialized(){return this.isInitialized}async initialize(){try{this.config.enableDebug&&console.log("\u{1F3B5} Initializing unified MusicSyncService..."),lt.isAvailable()||console.warn("[MusicSyncService] Spicetify audio data API not available at initialization. Some features may be limited."),this.setupCacheManagement(),Y.performance.enableMetrics&&this.setupPerformanceMonitoring(),this.isInitialized=!0,this.config.enableDebug&&console.log("\u{1F31F} MusicSyncService initialized successfully!")}catch(t){console.error("\u274C MusicSyncService initialization failed:",t),this.metrics.errors++}}subscribe(t,e){if(!t||typeof t.updateFromMusicAnalysis!="function"){console.warn(`[MusicSyncService] Invalid system or missing updateFromMusicAnalysis method: ${e}`);return}if(this.subscribers.has(e)){this.config.enableDebug&&console.warn(`[MusicSyncService] System ${e} already subscribed.`);return}if(this.subscribers.set(e,t),this.config.enableDebug&&console.log(`[MusicSyncService] System subscribed: ${e}`),this.latestProcessedData&&t.initialized)try{t.updateFromMusicAnalysis(this.latestProcessedData,null,this.currentTrackUri)}catch(i){console.error(`[MusicSyncService] Error notifying new subscriber ${e}:`,i)}}unsubscribe(t){this.subscribers.has(t)&&(this.subscribers.delete(t),this.config.enableDebug&&console.log(`[MusicSyncService] System unsubscribed: ${t}`))}notifySubscribers(t,e,i){if(!this.isInitialized){console.warn("[MusicSyncService] Not initialized, cannot notify subscribers.");return}this.latestProcessedData=t;for(let[n,r]of this.subscribers)try{r.initialized&&typeof r.updateFromMusicAnalysis=="function"&&r.updateFromMusicAnalysis(t,e,i)}catch(a){console.error(`[MusicSyncService] Error notifying subscriber ${n}:`,a),this.metrics.errors++}}async fetchAudioData(t={}){let{retryDelay:e=Y.performance.retryDelay,maxRetries:i=Y.performance.maxRetries}=t,n=Spicetify.Player.data?.item?.uri;if(!n)return this.config.enableDebug&&console.warn("[MusicSyncService] No current track URI to fetch audio data."),null;let r=this.generateCacheKey(n,"audioData"),a=this.getFromCache(r);if(a?.audioData){if(this.isValidAudioData(a.audioData))return this.metrics.cacheHits++,this.config.enableDebug&&console.log(`[MusicSyncService] Cache hit for audioData: ${r}`),a.audioData;this.unifiedCache.delete(r)}this.metrics.cacheMisses++;for(let s=0;s<i;s++){try{let o=await lt.getAudioData();if(this.isValidAudioData(o))return this.setInCache(r,{audioData:o}),o;this.config.enableDebug&&console.log(`[MusicSyncService] Audio analysis unavailable (attempt ${s+1}/${i}). Retrying\u2026`)}catch(o){if(s===i-1){this.config.enableDebug&&console.warn("[MusicSyncService] Audio data fetch error on final attempt:",o),this.metrics.errors++;let l={tempo:120,energy:.5,valence:.5,loudness:-10,key:0,time_signature:4,danceability:.5,acousticness:.5,instrumentalness:0,speechiness:.05,liveness:.2,mode:1};return this.config.enableDebug&&console.warn("[MusicSyncService] All audio-data attempts failed \u2013 using fallback defaults"),l}}await new Promise(o=>setTimeout(o,e))}return null}async getAudioFeatures(){try{let t=Spicetify.Player.data?.item;if(!t?.uri)return null;let e=t.uri.split(":")[2]||"fallback",i=this.generateCacheKey(e,"features"),n=this.getFromCache(i);if(n?.audioFeatures)return this.metrics.cacheHits++,this.config.enableDebug&&console.log(`[MusicSyncService] Cache hit for audioFeatures: ${i}`),n.audioFeatures;this.metrics.cacheMisses++;let r=await Spicetify.CosmosAsync.get(`https://api.spotify.com/v1/audio-features/${e}`),a={danceability:r.danceability,energy:r.energy,valence:r.valence,acousticness:r.acousticness,instrumentalness:r.instrumentalness,tempo:r.tempo};return this.setInCache(i,{audioFeatures:a}),a}catch(t){return this.config.enableDebug&&console.warn("[MusicSyncService] Could not fetch audio features:",t),null}}generateCacheKey(t,e="default"){return`${this.CACHE_KEY_VERSION_PREFIX}-${t}-${e}`}getFromCache(t){let e=this.unifiedCache.get(t);return e&&Date.now()-e.timestamp<this.cacheTTL?e.data:(e&&this.unifiedCache.delete(t),null)}setInCache(t,e){this.unifiedCache.set(t,{data:e,timestamp:Date.now()})}async calculateEnhancedBPM(t,e={}){let i=performance.now();try{if(!t?.tempo)return this.config.enableDebug&&console.warn("[MusicSyncService] No BPM data available for track"),this.getFallbackBPM();let n=t.tempo,r={...Y.bpmCalculation,...e},a=await this.getAudioFeatures();if(!a)return this.config.enableDebug&&console.log("[MusicSyncService] Using basic BPM calculation"),this.validateBPM(n);let{danceability:s,energy:o,valence:l=.5}=a;this.config.enableDebug&&console.log(`[MusicSyncService] Audio features - Danceability: ${s}, Energy: ${o}, Valence: ${l}`);let m=this.genreProfileManager.getProfileForTrack(a||void 0),d=this.genreProfileManager.detectGenre(a||void 0),h=this.computeAdvancedBPM({trackBPM:n,danceability:s,energy:o,valence:l,config:r,profile:m}),b=(Spicetify.Player.data?.item||Spicetify.Player.data)?.uri?.split(":")??[],v=b.length>2&&b[2]?b[2]:"fallback",C=this.generateCacheKey(v,"bpm");return this.setInCache(C,{bpm:h,audioFeatures:a}),this.metrics.bpmCalculations++,this.config.enableDebug&&console.log(`[MusicSyncService] Enhanced BPM: ${h} (original: ${n})`),h}catch(n){return console.error("[MusicSyncService] BPM calculation failed:",n),this.metrics.errors++,this.getFallbackBPM()}}computeAdvancedBPM(t){let{trackBPM:e,danceability:i,energy:n,valence:r,config:a,profile:s}=t,{danceabilityWeight:o,energyWeight:l,bpmWeight:m,energyThreshold:d,danceabilityThreshold:h,bpmThreshold:p,maxBPM:b,minBPM:v}=a,C=Math.min(e/120,2),P=o,E=l,L=m;i<h&&(P*=i),n<d&&(E*=n),C<p&&(L=.9);let $=1;r>.6?$=1.05:r<.4&&n<.5&&($=.95);let G=P+E+L,W=(i*P+n*E+C*L)/G*120*$;return s.beatEmphasis&&(W*=s.beatEmphasis),W=Math.max(v,Math.min(b,W)),Math.round(W*100)/100}validateBPM(t){let{minBPM:e,maxBPM:i}=Y.bpmCalculation;return Math.max(e,Math.min(i*2,Math.round(t*100)/100))}getFallbackBPM(){return 75}estimateDanceabilityFromTempo(t){let e=Y.musicVisualSync.enhancedBPM.danceabilityEstimation;return t>=e.highDance.min&&t<=e.highDance.max?e.highDance.value:t>=e.mediumDance.min&&t<=e.mediumDance.max?e.mediumDance.value:t>=e.lowMediumDance.min&&t<=e.lowMediumDance.max?e.lowMediumDance.value:e.lowDance.value}estimateEnergyFromTempoLoudness(t,e){let i=Y.musicVisualSync.enhancedBPM.energyEstimation,n=Math.max(0,Math.min(1,(t-i.tempoRange.min)/(i.tempoRange.max-i.tempoRange.min))),r=Math.max(0,Math.min(1,(e-i.loudnessRange.min)/(i.loudnessRange.max-i.loudnessRange.min)));return n*i.tempoWeight+r*i.loudnessWeight}estimateValenceFromKey(t){return[0,2,4,5,7,9,11].includes(t)?.6:.4}getFallbackProcessedData(t){let e=Y.musicVisualSync.enhancedBPM.fallbacks,i=6e4/e.tempo;return{trackUri:t,timestamp:Date.now(),tempo:e.tempo,loudness:e.loudness,key:e.key,timeSignature:e.timeSignature,estimatedDanceability:this.estimateDanceabilityFromTempo(e.tempo),estimatedEnergy:this.estimateEnergyFromTempoLoudness(e.tempo,e.loudness),estimatedValence:.5,energy:.5,valence:.5,processedEnergy:.5,visualIntensity:.5,moodIdentifier:"neutral",baseBPM:e.tempo,enhancedBPM:e.tempo,beatInterval:i,bmpCalculationMethod:"fallback",dataSource:"fallback"}}async createOKLABEnhancedFallbackColors(t){let e={VIBRANT:"#f2cdcd",DARK_VIBRANT:"#cba6f7",LIGHT_VIBRANT:"#f5c2e7",PROMINENT:"#cba6f7",VIBRANT_NON_ALARMING:"#f2cdcd",DESATURATED:"#9399b2"};if(!t||typeof t.energy!="number"||typeof t.valence!="number"){let s=M.getPreset("STANDARD"),o={};for(let[l,m]of Object.entries(e))try{let d=this.oklabProcessor.processColor(m,s);o[l]=d.enhancedHex}catch(d){this.config.enableDebug&&console.warn(`\u{1F3A8} [MusicSyncService] OKLAB processing failed for ${l}:`,d),o[l]=m}return o}let i={energy:t.energy,valence:t.valence,danceability:t.danceability,tempo:t.tempo,mode:t.mode,genre:this.genreProfileManager.detectGenre(t)},n=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(i),r;n.intensity>=1?r=M.getPreset("COSMIC"):n.intensity>=.7?r=M.getPreset("VIBRANT"):n.intensity>=.5?r=M.getPreset("STANDARD"):r=M.getPreset("SUBTLE");let a={};for(let[s,o]of Object.entries(e))try{let l=this.oklabProcessor.processColor(o,r);a[s]=l.enhancedHex}catch(l){this.config.enableDebug&&console.warn(`\u{1F3A8} [MusicSyncService] OKLAB processing failed for ${s}:`,l),a[s]=o}return a["--sn-emotional-primary"]=n.perceptualColorHex||n.primaryEmotion,a["--sn-emotional-intensity"]=n.intensity.toString(),a["--sn-emotional-preset"]=r.name,this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Created OKLAB-enhanced fallback colors:",{emotion:n.primaryEmotion,intensity:n.intensity,preset:r.name,oklabCoordination:a,musicContext:{energy:t.energy,valence:t.valence}}),a}async enhanceExtractedColorsWithOKLAB(t,e){let i={},n=M.getPreset("STANDARD");if(e&&typeof e.energy=="number"&&typeof e.valence=="number"){let r={energy:e.energy,valence:e.valence,danceability:e.danceability,tempo:e.tempo,mode:e.mode,genre:this.genreProfileManager.detectGenre(e)},a=this.emotionalTemperatureMapper.mapMusicToEmotionalTemperature(r);a.intensity>=1?n=M.getPreset("COSMIC"):a.intensity>=.7?n=M.getPreset("VIBRANT"):a.intensity>=.5?n=M.getPreset("STANDARD"):n=M.getPreset("SUBTLE"),i["--sn-emotional-primary"]=a.perceptualColorHex||`oklabColorProcessor-${a.primaryEmotion}`,i["--sn-emotional-intensity"]=a.intensity.toString(),i["--sn-emotional-temperature"]=a.temperature.toString(),this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Applying OKLAB enhancement with emotional context:",{emotion:a.primaryEmotion,intensity:a.intensity,preset:n.name,colorCount:Object.keys(t).length})}for(let[r,a]of Object.entries(t)){if(!a||typeof a!="string"||!a.startsWith("#")){i[r]=a;continue}try{let s=this.oklabProcessor.processColor(a,n);i[r]=s.enhancedHex,i[`${r}-oklab-l`]=s.oklabEnhanced.L.toFixed(3),i[`${r}-oklab-a`]=s.oklabEnhanced.a.toFixed(3),i[`${r}-oklab-b`]=s.oklabEnhanced.b.toFixed(3),i[`${r}-oklch-c`]=s.oklchEnhanced.C.toFixed(3),i[`${r}-oklch-h`]=s.oklchEnhanced.H.toFixed(1)}catch(s){this.config.enableDebug&&console.warn(`\u{1F3A8} [MusicSyncService] OKLAB processing failed for ${r} (${a}):`,s),i[r]=a}}return i["--sn-oklab-preset"]=n.name,i["--sn-oklab-enhanced"]="true",this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] OKLAB color enhancement completed:",{originalCount:Object.keys(t).length,enhancedCount:Object.keys(i).length,preset:n.name,sampleEnhanced:{original:t.VIBRANT||t[Object.keys(t)[0]||""],enhanced:i.VIBRANT||i[Object.keys(i)[0]||""]}}),i}async processAudioFeatures(t,e,i){if(!this.isInitialized){console.warn("[MusicSyncService] Not initialized, skipping processing.");return}this.stopBeatScheduler(),this.currentTrackUri=e;let n=this.generateCacheKey(e,"processed"),r=this.getFromCache(n);if(r?.processedData){this.notifySubscribers(r.processedData,null,e);return}try{let a=t;if(a||(a=await this.fetchAudioData()),!a)throw new Error("Failed to fetch or receive audio data.");a.beats&&a.beats.length>0&&(this.currentSongBeats=a.beats,this.songStartTimestamp=Date.now(),this.nextBeatIndex=0,this.scheduleNextBeatEvent());let s=await this.calculateEnhancedBPM(a),o=s>0?6e4/s:0,l=a,{tempo:m=Y.musicVisualSync.enhancedBPM.fallbacks.tempo,loudness:d=Y.musicVisualSync.enhancedBPM.fallbacks.loudness,key:h=Y.musicVisualSync.enhancedBPM.fallbacks.key,time_signature:p=Y.musicVisualSync.enhancedBPM.fallbacks.timeSignature}=l,b=await this.getAudioFeatures(),v=b?.danceability??this.estimateDanceabilityFromTempo(m),C=b?.energy??this.estimateEnergyFromTempoLoudness(m,d),P=b?.valence??this.estimateValenceFromKey(h),E=this.config.getCurrentMultipliers?.()||{musicEnergyBoost:1,visualIntensityBase:1},L=Math.max(.1,Math.min(1,C*(E.musicEnergyBoost||1))),G=(C*.6+v*.4)*(E.visualIntensityBase||1),B="neutral";P>.6&&C>.6?B="energetic-happy":P>.6&&C<=.6?B="calm-happy":P<=.4&&C>.6?B="intense-moody":P<=.4&&C<=.4&&(B="calm-melancholy");let W=Math.max(.5,.8+G*.4),V=this.genreProfileManager.detectGenre(b||void 0),R={trackUri:e,timestamp:Date.now(),tempo:m,loudness:d,key:h,timeSignature:p,duration:i,estimatedDanceability:v,estimatedEnergy:C,estimatedValence:P,energy:C,valence:P,processedEnergy:L,visualIntensity:G,moodIdentifier:B,baseBPM:m,enhancedBPM:s,beatInterval:o,bmpCalculationMethod:"unified-service",dataSource:"unified-music-sync-service",beatOccurred:!1,animationSpeedFactor:W,genre:V};this.setInCache(n,{processedData:R}),this.latestProcessedData=R,this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] Processed music data:",{baseTempo:m,enhancedBPM:s,mood:B,energy:C.toFixed(2),visualIntensity:G.toFixed(2)}),this.notifySubscribers(R,t,e),g.emitSync("music:beat",{bpm:R.enhancedBPM,intensity:R.visualIntensity,timestamp:performance.now(),confidence:.8}),g.emitSync("music:energy",{energy:R.energy||.5,valence:R.valence||.5,tempo:R.enhancedBPM,timestamp:performance.now()}),g.emitSync("performance:frame",{deltaTime:16,fps:60,memoryUsage:performance.memory?.usedJSHeapSize||0,timestamp:performance.now()}),this.config.enableDebug&&console.log("[MusicSyncService] Successfully processed audio features.",{baseTempo:m,enhancedBPM:s,mood:B,energy:C.toFixed(2),visualIntensity:G.toFixed(2)})}catch(a){console.error("[MusicSyncService] Processing failed:",a),this.metrics.errors++;let s=this.getFallbackProcessedData(e);this.latestProcessedData=s,this.notifySubscribers(s,null,e)}}async processSongUpdate(t=!1){let e=Spicetify.Player?.data?.item?.uri;if(e&&!(!t&&e===this.currentTrackUri)){if(this.songChangeDebounceTimer&&clearTimeout(this.songChangeDebounceTimer),t){await this._processSongUpdateInternal(e);return}this.songChangeDebounceTimer=setTimeout(async()=>{this.songChangeDebounceTimer=null,await this._processSongUpdateInternal(e)},Y.synchronization.debounceRapidChanges)}}async _processSongUpdateInternal(t){if(this.eventProcessingState.isProcessingEvent){this.config.enableDebug&&console.warn("\u{1F504} [MusicSyncService] Already processing song update - skipping to prevent recursion");return}if(this.eventProcessingState.isProcessingEvent=!0,this.eventProcessingState.lastEventTime=Date.now(),this.eventProcessingState.consecutiveEvents++,this.eventProcessingState.eventChain.push("_processSongUpdateInternal"),this.eventProcessingState.consecutiveEvents>this.MAX_CONSECUTIVE_EVENTS){console.error("\u{1F504} [MusicSyncService] CRITICAL: Too many consecutive events - circuit breaker activated",{consecutiveEvents:this.eventProcessingState.consecutiveEvents,eventChain:this.eventProcessingState.eventChain}),this._resetEventProcessingState();return}let e=setTimeout(()=>{this.config.enableDebug&&console.warn("\u{1F504} [MusicSyncService] Event processing timeout - resetting state"),this._resetEventProcessingState()},this.EVENT_RESET_TIMEOUT);try{this.invalidateTrackCaches(t);let i=Spicetify.Player.data?.item?.duration?.milliseconds||0,n=await Promise.allSettled([this.getAudioFeatures(),this.robustColorExtraction(t)]),r=n[0].status==="fulfilled"?n[0].value:null,a=n[1].status==="fulfilled"?n[1].value:null;if(n[0].status==="rejected"&&this.config.enableDebug&&console.warn("[MusicSyncService] Audio features retrieval failed, continuing without music analysis:",n[0].reason),n[1].status==="rejected"&&this.config.enableDebug&&console.warn("[MusicSyncService] Color extraction failed, continuing without color processing:",n[1].reason),this.config.enableDebug){let h=(r?1:0)+(a?1:0);h===1?console.log(`[MusicSyncService] Graceful degradation: Continuing with ${r?"audio features only":"color extraction only"}`):h===2?console.log("[MusicSyncService] Full feature extraction successful"):console.warn("[MusicSyncService] Both strategies failed, will use fallback data")}console.log("\u{1F3A8} [MusicSyncService] Raw colors BEFORE sanitization:",{rawColors:a,rawColorType:typeof a,rawColorKeys:a?Object.keys(a):[],rawColorEntries:a?Object.entries(a):[]});let s=this.utils.sanitizeColorMap(a||{});console.log("\u{1F3A8} [MusicSyncService] Colors AFTER sanitization:",{sanitizedColors:s,sanitizedColorType:typeof s,sanitizedColorKeys:Object.keys(s),sanitizedColorEntries:Object.entries(s),colorCount:Object.keys(s).length,droppedCount:a?Object.keys(a).length-Object.keys(s).length:0}),this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Color extraction debug:",{trackUri:t,rawColorsReceived:a,sanitizedColors:s,colorCount:Object.keys(s).length,colorExtractorFailed:n[1].status==="rejected"});let o=s,l=!1;if(Object.keys(s).length>0)try{o=await this.enhanceExtractedColorsWithOKLAB(s,r),this.config.enableDebug&&console.log("\u{1F3A8} [MusicSyncService] Successfully enhanced extracted colors with OKLAB processing")}catch(h){this.config.enableDebug&&console.warn("\u{1F3A8} [MusicSyncService] OKLAB enhancement failed, using original extracted colors:",h),o=s}if(Object.keys(s).length===0)try{o=await this.createOKLABEnhancedFallbackColors(r),l=!0,this.config.enableDebug&&console.warn("\u{1F3A8} [MusicSyncService] Color extraction failed, using OKLAB-enhanced Catppuccin fallback colors with emotional context")}catch(h){this.config.enableDebug&&console.warn("\u{1F3A8} [MusicSyncService] OKLAB fallback processing failed, using static fallback colors:",h),o={VIBRANT:"#f2cdcd",DARK_VIBRANT:"#cba6f7",LIGHT_VIBRANT:"#f5c2e7",PROMINENT:"#cba6f7",VIBRANT_NON_ALARMING:"#f2cdcd",DESATURATED:"#9399b2"},l=!0}let m={rawColors:o,trackUri:t,timestamp:Date.now(),harmonicMode:this.config.currentHarmonicMode||"catppuccin",musicData:r?{energy:r.energy,valence:r.valence,tempo:r.tempo,genre:this.genreProfileManager.detectGenre(r)}:void 0,performanceHints:{preferLightweight:!1,enableAdvancedBlending:!0,maxProcessingTime:100}};console.log("\u{1F3A8} [MusicSyncService] FINAL colors before event emission:",{finalColors:o,finalColorKeys:Object.keys(o),finalColorEntries:Object.entries(o),usingFallback:l,extractionFailed:Object.keys(s).length===0});let d={rawColors:m.rawColors,trackUri:m.trackUri,timestamp:Date.now()};if(m.musicData&&(d.musicData=m.musicData),console.log("\u{1F3A8} [MusicSyncService] Emitting colors:extracted event with data:",{eventData:d,rawColorKeys:d.rawColors?Object.keys(d.rawColors):[],rawColorEntries:d.rawColors?Object.entries(d.rawColors):[]}),g.emitSync("colors:extracted",d),this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] Emitted colors:extracted event for strategy processing",{trackUri:t,colorCount:Object.keys(o).length,usingFallback:l,extractionFailed:Object.keys(s).length===0}),r){let h=this.convertFeaturesToAudioData(r);await this.processAudioFeatures(h,t,i)}(async()=>{let h=await this.fetchAudioData();this.isValidAudioData(h)&&await this.processAudioFeatures(h,t,i)})()}catch(i){console.error(`[MusicSyncService] Error processing song update for ${t}:`,i),this.metrics.errors++}finally{clearTimeout(e),this._resetEventProcessingState();let i=this.eventProcessingState.eventChain.indexOf("_processSongUpdateInternal");i>-1&&this.eventProcessingState.eventChain.splice(i,1)}}_resetEventProcessingState(){this.eventProcessingState.isProcessingEvent=!1,this.eventProcessingState.eventChain=[];let e=Date.now()-this.eventProcessingState.lastEventTime;if(e>this.EVENT_RESET_TIMEOUT)this.eventProcessingState.consecutiveEvents=0;else{let i=Math.min(1,e/this.EVENT_RESET_TIMEOUT);this.eventProcessingState.consecutiveEvents=Math.floor(this.eventProcessingState.consecutiveEvents*(1-i))}this.config.enableDebug&&this.eventProcessingState.consecutiveEvents>0&&console.log("\u{1F504} [MusicSyncService] Event processing state reset",{consecutiveEvents:this.eventProcessingState.consecutiveEvents,timeSinceLastEvent:e})}setupCacheManagement(){this.cacheCleanupInterval=setInterval(()=>{let t=Date.now();for(let[e,i]of this.unifiedCache.entries())t-i.timestamp>this.cacheTTL&&this.unifiedCache.delete(e)},this.cacheTTL)}setupPerformanceMonitoring(){this.performanceInterval=setInterval(()=>{if(this.metrics.performance.length>0){let t=this.metrics.performance.reduce((e,i)=>e+i,0)/this.metrics.performance.length;this.metrics.avgProcessingTime=t,this.metrics.performance=[]}},6e4)}loadUserPreferences(){try{return{enableMusicSync:!0,audioAnalysisQuality:x.get("sn-webgl-quality")||"medium",gradientIntensity:x.get("sn-gradient-intensity")||"balanced",artisticMode:x.get("sn-artistic-mode")||"artist-vision"}}catch{return{enableMusicSync:!0,audioAnalysisQuality:"medium",gradientIntensity:"balanced",artisticMode:"artist-vision"}}}saveUserPreferences(){try{this.config.enableDebug&&console.log("[MusicSyncService] User preferences updated via settings system")}catch(t){this.config.enableDebug&&console.warn("[MusicSyncService] Could not save user preferences:",t)}}updateConfiguration(t){let e={...Y};Object.assign(Y,t),this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] Configuration updated",{from:e,to:Y}),this.cacheTTL=Y.performance.cacheTTL,e.performance.enableMetrics!==Y.performance.enableMetrics&&(Y.performance.enableMetrics?this.setupPerformanceMonitoring():this.performanceInterval&&(clearInterval(this.performanceInterval),this.performanceInterval=null))}destroy(){this.songChangeDebounceTimer&&(clearTimeout(this.songChangeDebounceTimer),this.songChangeDebounceTimer=null),this.stopBeatScheduler(),this.performanceInterval&&clearInterval(this.performanceInterval),this.cacheCleanupInterval&&clearInterval(this.cacheCleanupInterval),this.subscribers.clear(),this.unifiedCache.clear(),this.isInitialized=!1,this.latestProcessedData=null,this.metrics={bpmCalculations:0,beatSyncs:0,cacheHits:0,cacheMisses:0,avgProcessingTime:0,performance:[],errors:0,updates:0},this.cacheCleanupInterval=null}setColorHarmonyEngine(t){this.config.enableDebug&&console.log("\u{1F3B5} [MusicSyncService] setColorHarmonyEngine called - now using event-driven pattern instead of direct dependency.")}getLatestProcessedData(){return this.latestProcessedData}getCurrentBeatVector(){return{...this.currentBeatVector}}stopBeatScheduler(){this.beatSchedulerTimer&&(clearTimeout(this.beatSchedulerTimer),this.beatSchedulerTimer=null)}triggerBeatEvent(){let e=this.nextBeatIndex*.61803398875%1*Math.PI*2;if(this.currentBeatVector={x:Math.cos(e),y:Math.sin(e)},this.latestProcessedData){let i={...this.latestProcessedData,beatOccurred:!0,beatVector:this.currentBeatVector};this.notifySubscribers(i,null,this.currentTrackUri)}this.nextBeatIndex++,this.scheduleNextBeatEvent()}scheduleNextBeatEvent(){if(this.nextBeatIndex>=this.currentSongBeats.length)return;let t=this.currentSongBeats[this.nextBeatIndex],e=Date.now()-this.songStartTimestamp,i=t.start*1e3-e;i>=0?this.beatSchedulerTimer=setTimeout(()=>this.triggerBeatEvent(),i):(this.nextBeatIndex++,this.scheduleNextBeatEvent())}isValidAudioData(t){return!!t&&typeof t.tempo=="number"&&t.tempo>0}invalidateTrackCaches(t){if(t)for(let e of this.unifiedCache.keys())e.includes(t)&&this.unifiedCache.delete(e)}convertFeaturesToAudioData(t){let e=Y.musicVisualSync.enhancedBPM.fallbacks;return{tempo:t.tempo,energy:t.energy,valence:t.valence,loudness:e.loudness,key:e.key,time_signature:e.timeSignature,danceability:t.danceability,acousticness:t.acousticness,instrumentalness:t.instrumentalness,speechiness:0,liveness:0,mode:0}}async robustColorExtraction(t,e=3){console.log("\u{1F3A8} [MusicSyncService] Starting robust color extraction:",{trackUri:t,maxRetries:e,timestamp:Date.now()});for(let i=1;i<=e;i++)try{if(!t)return console.warn("\u{1F3A8} [MusicSyncService] Empty trackUri provided to color extraction"),null;console.log(`\u{1F3A8} [MusicSyncService] Calling Spicetify.colorExtractor (attempt ${i})...`);let n=await Spicetify.colorExtractor(t);if(console.log(`\u{1F3A8} [MusicSyncService] Raw color extraction result (attempt ${i}):`,{trackUri:t,success:!!n,colorsType:typeof n,colorsIsNull:n===null,colorsIsUndefined:n===void 0,colorCount:n?Object.keys(n).length:0,rawColors:n,colorKeys:n?Object.keys(n):[],colorValues:n?Object.values(n):[]}),n&&typeof n=="object"&&Object.keys(n).length>0)return Object.entries(n).forEach(([r,a])=>{console.log(`\u{1F3A8} [MusicSyncService] Extracted color: ${r} = ${a}`)}),n;console.warn(`\u{1F3A8} [MusicSyncService] Color extraction returned empty/invalid data on attempt ${i}`)}catch(n){if(console.error(`\u{1F3A8} [MusicSyncService] Color extraction attempt ${i} failed with error:`,n,{errorMessage:n instanceof Error?n.message:String(n),errorStack:n instanceof Error?n.stack:void 0}),i<e){let r=100*i;console.log(`\u{1F3A8} [MusicSyncService] Waiting ${r}ms before retry...`),await new Promise(a=>setTimeout(a,r))}}return console.error(`\u{1F3A8} [MusicSyncService] CRITICAL: All color extraction attempts failed for ${t}`),null}updateMetrics(t){this.latestProcessedData=t}getCurrentMusicState(){return!this.latestProcessedData||!this.audioData?null:{emotion:this.latestProcessedData.emotion||null,beat:{tempo:this.latestProcessedData.bpm||this.audioData.tempo||120,energy:this.latestProcessedData.energy||this.audioData.energy||.5,timestamp:Date.now()},intensity:this.latestProcessedData.intensity||this.audioData.energy||.5}}async healthCheck(){try{let t=lt.isAvailable(),e=this.subscribers.size>0,i=this.latestProcessedData!==null,n=this.metrics.bpmCalculations+this.metrics.beatSyncs+this.metrics.cacheHits+this.metrics.cacheMisses,r=n>0?this.metrics.errors/n:0;return this.isInitialized?t?r>.5?{status:"degraded",message:`High error rate detected: ${(r*100).toFixed(1)}%`,details:{initialized:this.isInitialized,spicetifyAvailable:t,subscribers:e,recentData:i,errorRate:r,errors:this.metrics.errors,totalOperations:n}}:{status:"healthy",message:"Music sync service operational",details:{initialized:this.isInitialized,spicetifyAvailable:t,subscribers:e,subscriberCount:this.subscribers.size,recentData:i,errorRate:r,bpmCalculations:this.metrics.bpmCalculations,beatSyncs:this.metrics.beatSyncs,cacheHits:this.metrics.cacheHits,cacheMisses:this.metrics.cacheMisses,avgProcessingTime:this.metrics.avgProcessingTime,errors:this.metrics.errors,updates:this.metrics.updates}}:{status:"degraded",message:"Spicetify audio data API not available - running in limited mode",details:{initialized:this.isInitialized,spicetifyAvailable:t,subscribers:e,recentData:i,errorRate:r}}:{status:"critical",message:"System not initialized",details:{initialized:this.isInitialized,spicetifyAvailable:t}}}catch(t){return{status:"critical",message:`Health check failed: ${t instanceof Error?t.message:"Unknown error"}`,details:{error:t instanceof Error?t.message:"Unknown error"}}}}}});var ci,Fa=y(()=>{"use strict";ci=c=>({version:"1.0.0",userId:c,createdAt:Date.now(),lastModified:Date.now(),colorMemories:new Map,rhythmicPreferences:new Map,emotionalResonanceProfile:{},evolutionaryTrajectory:{adaptability:.5,explorationFactor:.5,lastUpdate:Date.now()}})});function dc(){return Ga||(Ga=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function hc(){return Ha||(Ha=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}function gc(c){let t=new Promise((e,i)=>{let n=()=>{c.removeEventListener("success",r),c.removeEventListener("error",a)},r=()=>{e(Qe(c.result)),n()},a=()=>{i(c.error),n()};c.addEventListener("success",r),c.addEventListener("error",a)});return li.set(t,c),t}function pc(c){if(Nn.has(c))return;let t=new Promise((e,i)=>{let n=()=>{c.removeEventListener("complete",r),c.removeEventListener("error",a),c.removeEventListener("abort",a)},r=()=>{e(),n()},a=()=>{i(c.error||new DOMException("AbortError","AbortError")),n()};c.addEventListener("complete",r),c.addEventListener("error",a),c.addEventListener("abort",a)});Nn.set(c,t)}function Va(c){$n=c($n)}function bc(c){return hc().includes(c)?function(...t){return c.apply(Wn(this),t),Qe(this.request)}:function(...t){return Qe(c.apply(Wn(this),t))}}function yc(c){return typeof c=="function"?bc(c):(c instanceof IDBTransaction&&pc(c),_n(c,dc())?new Proxy(c,$n):c)}function Qe(c){if(c instanceof IDBRequest)return gc(c);if(Un.has(c))return Un.get(c);let t=yc(c);return t!==c&&(Un.set(c,t),li.set(t,c)),t}function _a(c,t,{blocked:e,upgrade:i,blocking:n,terminated:r}={}){let a=indexedDB.open(c,t),s=Qe(a);return i&&a.addEventListener("upgradeneeded",o=>{i(Qe(a.result),o.oldVersion,o.newVersion,Qe(a.transaction),o)}),e&&a.addEventListener("blocked",o=>e(o.oldVersion,o.newVersion,o)),s.then(o=>{r&&o.addEventListener("close",()=>r()),n&&o.addEventListener("versionchange",l=>n(l.oldVersion,l.newVersion,l))}).catch(()=>{}),s}function Oa(c,t){if(!(c instanceof IDBDatabase&&!(t in c)&&typeof t=="string"))return;if(Vn.get(t))return Vn.get(t);let e=t.replace(/FromIndex$/,""),i=t!==e,n=Sc.includes(e);if(!(e in(i?IDBIndex:IDBObjectStore).prototype)||!(n||fc.includes(e)))return;let r=async function(a,...s){let o=this.transaction(a,n?"readwrite":"readonly"),l=o.store;return i&&(l=l.index(s.shift())),(await Promise.all([l[e](...s),n&&o.done]))[0]};return Vn.set(t,r),r}async function*Mc(...c){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...c)),!t)return;t=t;let e=new Proxy(t,Cc);for(Na.set(e,t),li.set(e,Wn(t));t;)yield e,t=await(qn.get(e)||t.continue()),qn.delete(e)}function Ua(c,t){return t===Symbol.asyncIterator&&_n(c,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&_n(c,[IDBIndex,IDBObjectStore])}var _n,Ga,Ha,Nn,Un,li,$n,Wn,fc,Sc,Vn,vc,za,qn,Na,Cc,$a=y(()=>{_n=(c,t)=>t.some(e=>c instanceof e);Nn=new WeakMap,Un=new WeakMap,li=new WeakMap;$n={get(c,t,e){if(c instanceof IDBTransaction){if(t==="done")return Nn.get(c);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return Qe(c[t])},set(c,t,e){return c[t]=e,!0},has(c,t){return c instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in c}};Wn=c=>li.get(c);fc=["get","getKey","getAll","getAllKeys","count"],Sc=["put","add","delete","clear"],Vn=new Map;Va(c=>({...c,get:(t,e,i)=>Oa(t,e)||c.get(t,e,i),has:(t,e)=>!!Oa(t,e)||c.has(t,e)}));vc=["continue","continuePrimaryKey","advance"],za={},qn=new WeakMap,Na=new WeakMap,Cc={get(c,t){if(!vc.includes(t))return c[t];let e=za[t];return e||(e=za[t]=function(...i){qn.set(this,Na.get(this)[t](...i))}),e}};Va(c=>({...c,get(t,e,i){return Ua(t,e)?Mc:c.get(t,e,i)},has(t,e){return Ua(t,e)||c.has(t,e)}}))});var wc,Ec,ui,Wa,Yn,Mt,qa=y(()=>{"use strict";Fa();$a();wc="Year3000-TemporalMemory",Ec=1,ui="aestheticSignatures",Wa="currentUser",Yn=class{constructor(){this.dbPromise=_a(wc,Ec,{upgrade(t){t.objectStoreNames.contains(ui)||t.createObjectStore(ui)}})}async getSignature(t="defaultUser"){try{let i=await(await this.dbPromise).get(ui,Wa);if(i)return i;{let n=ci(t);return await this.saveSignature(n),n}}catch(e){return console.error("[TemporalMemoryService] Failed to get signature from IndexedDB. Returning default.",e),ci(t)}}async saveSignature(t){try{let e=await this.dbPromise;t.lastModified=Date.now(),await e.put(ui,t,Wa)}catch(e){console.error("[TemporalMemoryService] Failed to save signature to IndexedDB.",e)}}async resetSignature(t="defaultUser"){let e=ci(t);return await this.saveSignature(e),console.log("[TemporalMemoryService] Aesthetic signature has been reset."),e}async getSignatureTrends(t){if(!t)return null;let e={dominantColor:null,dominantRhythm:null,avgEnergy:0,avgValence:0},i=null;t.colorMemories.forEach((s,o)=>{(!i||s.count>i.count)&&(i={hex:o,count:s.count}),e.avgValence+=s.emotionalValence*s.count});let n=0;t.colorMemories.forEach(s=>n+=s.count),n>0&&(e.avgValence/=n),e.dominantColor=i;let r=null;t.rhythmicPreferences.forEach((s,o)=>{(!r||s.count>r.count)&&(r={id:o,count:s.count}),e.avgEnergy+=s.associatedEnergy*s.count});let a=0;return t.rhythmicPreferences.forEach(s=>a+=s.count),a>0&&(e.avgEnergy/=a),e.dominantRhythm=r,e}},Mt=new Yn});var Ce,Fe,Kn=y(()=>{"use strict";D();qa();Ce=class Ce{constructor(t,e,i){this.performanceCoordinator=null;this.cssAnimationManager=null;this.animations=new Map;this.frameCallbacks=new Map;this.callbackCounter=0;this.animationFrameId=null;this.isRunning=!1;this.isPaused=!1;this.lastTimestamp=0;this.frameCount=0;this.startTime=0;this.frameTimeBudget=16;this.metrics={totalFrames:0,droppedFrames:0,averageFrameTime:0,maxFrameTime:0,performanceMode:"quality",activeAnimations:0,activeCallbacks:0,frameRate:60,lastOptimization:0};this.frameContext={timestamp:0,deltaMs:0,performanceMode:"quality",frameBudget:16,beatIntensity:0,scrollRatio:0,tiltXY:{x:0,y:0}};this.performanceHistory=[];this.MAX_HISTORY_SIZE=60;this.signature=null;this.saveInterval=null;this.currentBpm=120;this.currentIntensity=.5;this.emergentEventSubscriptions=[];this.animate=()=>{if(!this.isRunning)return;let t=performance.now(),e=t-this.lastTimestamp;if(this.isPaused){this.animationFrameId=requestAnimationFrame(this.animate);return}this.frameContext.timestamp=t,this.frameContext.deltaMs=e;let i=performance.now(),n=this.frameTimeBudget,r=performance.now();this.executeFrameCallbacks(e,t);let a=performance.now()-r,s=n-a;s>2?this.executeAnimationSystemsWithBudget(e,t,s):(this.metrics.droppedFrames++,this.config.enableDebug&&Math.random()<.1&&console.warn(`[EnhancedMasterAnimationCoordinator] Skipped animation systems - budget exceeded: ${a.toFixed(2)}ms`)),performance.now()-i<n*.8&&this.processEmergentTick(e);let l=performance.now()-i;this.updatePerformanceMetrics(l),this.performanceCoordinator&&this.performanceCoordinator.trackSubsystem("MasterAnimationCoordinator",{frameTime:l,fps:this.metrics.frameRate,memoryUsage:performance.memory?.usedJSHeapSize||0,cpuUsage:l>this.frameTimeBudget?l/this.frameTimeBudget*10:0}),this.lastTimestamp=t,this.frameCount++,l>n*1.5?setTimeout(()=>{this.animationFrameId=requestAnimationFrame(this.animate)},4):this.animationFrameId=requestAnimationFrame(this.animate)};this.config=t,this.eventBus=g,this.performanceCoordinator=e||null,this.cssAnimationManager=i||null,this.startTime=performance.now(),this.lastTimestamp=this.startTime,this.currentMultipliers=this.config.cosmicMultipliers,this.subscribeToEvents(),this.initializeEmergentChoreography(),this.updateFrameBudget(),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Initialized with unified animation coordination and emergent choreography")}coordinateConsciousnessBreathing(t){if(!this.cssAnimationManager)return;let e=t.energy||t.intensity||.5,i=t.bpm||this.currentBpm||120;if(Math.abs(e-this.currentIntensity)<.1&&Math.abs(i-this.currentBpm)<5)return;let r=document.querySelectorAll(".Root__main-view::before, .Root__main-view, [data-consciousness-breathing]");r.length>0&&(this.cssAnimationManager.triggerConsciousnessBreathing(r,e,i),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Consciousness breathing coordinated - Energy: ${e.toFixed(2)}, Tempo: ${i} BPM`)),this.currentIntensity=e,this.currentBpm=i}static getInstance(t,e,i){if(!Ce.instance){if(!t)throw new Error("EnhancedMasterAnimationCoordinator requires config for first initialization");Ce.instance=new Ce(t,e,i)}return Ce.instance}registerCSSAnimationManager(t){this.cssAnimationManager=t,this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] CSSAnimationManager registered for breathing coordination")}registerAnimationSystem(t,e,i="normal",n=60){if(this.animations.has(t))return this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] Animation system ${t} already registered`),!1;let r={name:t,system:e,priority:i,targetFPS:n,type:"animation",enabled:!0,frameInterval:1e3/n,lastUpdate:0,frameCount:0,totalTime:0,averageFrameTime:0,maxFrameTime:0,skippedFrames:0};return this.animations.set(t,r),this.isRunning||this.startMasterAnimationLoop(),this.updateMetrics(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Registered animation system: ${t} (priority: ${i}, fps: ${n})`),!0}registerVisualSystem(t,e="normal"){if(this.animations.has(t.systemName))return this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] Visual system ${t.systemName} already registered`),!1;let i={name:t.systemName,system:t,priority:e,targetFPS:60,type:"visual",enabled:!0,frameInterval:16.67,lastUpdate:0,frameCount:0,totalTime:0,averageFrameTime:0,maxFrameTime:0,skippedFrames:0};return this.animations.set(t.systemName,i),this.isRunning||this.startMasterAnimationLoop(),this.updateMetrics(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Registered visual system: ${t.systemName} (priority: ${e})`),!0}registerFrameCallback(t,e="normal",i){let n=`callback_${++this.callbackCounter}`,r={id:n,callback:t,priority:e,system:i||void 0,enabled:!0,frameCount:0,totalTime:0,lastExecution:0};return this.frameCallbacks.set(n,r),this.isRunning||this.startMasterAnimationLoop(),this.updateMetrics(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Registered frame callback: ${n} (priority: ${e})`),n}unregisterAnimationSystem(t){let e=this.animations.delete(t);return e&&(this.updateMetrics(),this.animations.size===0&&this.frameCallbacks.size===0&&this.stopMasterAnimationLoop(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Unregistered animation system: ${t}`)),e}unregisterFrameCallback(t){let e=this.frameCallbacks.delete(t);return e&&(this.updateMetrics(),this.animations.size===0&&this.frameCallbacks.size===0&&this.stopMasterAnimationLoop(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Unregistered frame callback: ${t}`)),e}startMasterAnimationLoop(){this.isRunning||(this.isRunning=!0,this.isPaused=!1,this.lastTimestamp=performance.now(),this.frameCount=0,this.animate(),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Master animation loop started"))}stopMasterAnimationLoop(){this.isRunning&&(this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Master animation loop stopped"))}pauseAnimationLoop(){this.isPaused=!0,this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Animation loop paused")}resumeAnimationLoop(){this.isPaused&&(this.isPaused=!1,this.lastTimestamp=performance.now(),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Animation loop resumed"))}setPerformanceMode(t){this.metrics.performanceMode=t,this.frameContext.performanceMode=t,this.frameTimeBudget=t==="performance"?8:16,this.frameContext.frameBudget=this.frameTimeBudget;for(let e of this.animations.values())e.system.onPerformanceModeChange&&e.system.onPerformanceModeChange(t);this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] Performance mode set to: ${t}`)}getPerformanceMetrics(){return{...this.metrics}}getRegisteredSystems(){return{animations:new Map(this.animations),callbacks:new Map(this.frameCallbacks)}}setSystemEnabled(t,e){let i=this.animations.get(t);return i?(i.enabled=e,this.updateMetrics(),this.config.enableDebug&&console.log(`[EnhancedMasterAnimationCoordinator] System ${t} ${e?"enabled":"disabled"}`),!0):!1}getCurrentMultipliers(){return this.currentMultipliers}async updateEvolutionaryTrajectory(){await this._updateEvolutionaryTrajectory()}destroy(){this.stopMasterAnimationLoop(),this.destroyEmergentChoreography();for(let t of this.animations.values())if(t.type==="visual"&&"destroy"in t.system)try{t.system.destroy()}catch(e){console.error(`[EnhancedMasterAnimationCoordinator] Error destroying system ${t.name}:`,e)}this.animations.clear(),this.frameCallbacks.clear(),Ce.instance===this&&(Ce.instance=null),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Destroyed")}executeFrameCallbacks(t,e){let i=Array.from(this.frameCallbacks.values()).filter(n=>n.enabled).sort((n,r)=>{let a={critical:0,normal:1,background:2};return a[n.priority]-a[r.priority]});for(let n of i){let r=performance.now();try{n.callback(t,e);let a=performance.now()-r;n.totalTime+=a,n.frameCount++,n.lastExecution=e,a>this.frameTimeBudget*.5&&this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] Callback ${n.id} exceeded budget: ${a.toFixed(2)}ms`)}catch(a){console.error(`[EnhancedMasterAnimationCoordinator] Error in callback ${n.id}:`,a)}}}executeAnimationSystems(t,e){let i=Array.from(this.animations.values()).filter(n=>n.enabled).sort((n,r)=>{let a={critical:0,normal:1,background:2};return a[n.priority]-a[r.priority]});for(let n of i){if(e-n.lastUpdate<n.frameInterval){n.skippedFrames++;continue}let r=performance.now();try{if(n.type==="visual")n.system.onAnimate(t,this.frameContext);else{let s=n.system;s.onAnimate&&s.onAnimate(t),s.updateAnimation&&s.updateAnimation(e,t)}let a=performance.now()-r;n.totalTime+=a,n.frameCount++,n.lastUpdate=e,n.averageFrameTime=n.totalTime/n.frameCount,n.maxFrameTime=Math.max(n.maxFrameTime,a),a>this.frameTimeBudget*.8&&this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] System ${n.name} exceeded budget: ${a.toFixed(2)}ms`)}catch(a){console.error(`[EnhancedMasterAnimationCoordinator] Error in system ${n.name}:`,a)}}}executeAnimationSystemsWithBudget(t,e,i){let n=performance.now(),r=Array.from(this.animations.values()).filter(l=>l.enabled).sort((l,m)=>{let d={critical:0,normal:1,background:2};return d[l.priority]-d[m.priority]}),a=0,s=0;for(let l of r){if(performance.now()-n>=i*.9){s=r.length-a,this.config.enableDebug&&s>0&&console.warn(`[EnhancedMasterAnimationCoordinator] Budget exhausted: skipped ${s} systems`);break}if(e-l.lastUpdate<l.frameInterval){l.skippedFrames++;continue}let d=performance.now();try{if(l.type==="visual")l.system.onAnimate(t,this.frameContext);else{let p=l.system;p.onAnimate&&p.onAnimate(t),p.updateAnimation&&p.updateAnimation(e,t)}let h=performance.now()-d;l.totalTime+=h,l.frameCount++,l.lastUpdate=e,l.averageFrameTime=l.totalTime/l.frameCount,l.maxFrameTime=Math.max(l.maxFrameTime,h),a++,h>i*.3&&this.config.enableDebug&&console.warn(`[EnhancedMasterAnimationCoordinator] System ${l.name} consuming excessive budget: ${h.toFixed(2)}ms`)}catch(h){console.error(`[EnhancedMasterAnimationCoordinator] Error in system ${l.name}:`,h),a++}}let o=performance.now()-n;s>0&&(this.metrics.droppedFrames+=s),this.config.enableDebug&&Math.random()<.02&&console.log(`[EnhancedMasterAnimationCoordinator] Budget usage: ${o.toFixed(2)}ms/${i.toFixed(2)}ms, processed: ${a}/${r.length}`)}updatePerformanceMetrics(t){this.metrics.totalFrames++,this.metrics.maxFrameTime=Math.max(this.metrics.maxFrameTime,t),this.performanceHistory.push(t),this.performanceHistory.length>this.MAX_HISTORY_SIZE&&this.performanceHistory.shift(),this.metrics.averageFrameTime=this.performanceHistory.reduce((e,i)=>e+i,0)/this.performanceHistory.length,this.metrics.frameRate=this.performanceHistory.length>0?1e3/this.metrics.averageFrameTime:60,t>this.frameTimeBudget*1.5&&this.metrics.droppedFrames++,this.metrics.averageFrameTime>this.frameTimeBudget*1.2&&this.metrics.performanceMode==="quality"?(this.setPerformanceMode("performance"),this.metrics.lastOptimization=Date.now()):this.metrics.averageFrameTime<this.frameTimeBudget*.8&&this.metrics.performanceMode==="performance"&&Date.now()-this.metrics.lastOptimization>5e3&&this.setPerformanceMode("quality")}updateFrameBudget(){this.frameTimeBudget=this.metrics.performanceMode==="performance"?8:16,this.frameContext.frameBudget=this.frameTimeBudget}updateMetrics(){this.metrics.activeAnimations=Array.from(this.animations.values()).filter(t=>t.enabled).length,this.metrics.activeCallbacks=Array.from(this.frameCallbacks.values()).filter(t=>t.enabled).length}subscribeToEvents(){this.eventBus.subscribe("music:beat",t=>{this.frameContext.beatIntensity=t.intensity||0,this.coordinateConsciousnessBreathing(t)},"EnhancedMasterAnimationCoordinator"),this.eventBus.subscribe("performance:frame",t=>{if(t.fps<45){for(let e of this.animations.values())e.frameInterval=Math.min(e.frameInterval*1.5,33.33);this.setPerformanceMode("performance")}else t.fps>55&&this.setPerformanceMode("quality")},"EnhancedMasterAnimationCoordinator")}async initializeEmergentChoreography(){try{this.signature=await Mt.getSignature(),this.registerEmergentEventListeners(),this.saveInterval=setInterval(()=>{this.signature&&Mt.saveSignature(this.signature)},3e4),this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Emergent choreography initialized")}catch(t){console.error("[EnhancedMasterAnimationCoordinator] Failed to initialize emergent choreography:",t)}}registerEmergentEventListeners(){let t=this.eventBus.subscribe("music:beat",r=>this.handleBeatFrame(r),"EnhancedMasterAnimationCoordinator"),e=this.eventBus.subscribe("colors:harmonized",r=>this.handleHarmonyFrame(r),"EnhancedMasterAnimationCoordinator"),i=this.eventBus.subscribe("music:energy",r=>{this.currentBpm=r.tempo},"EnhancedMasterAnimationCoordinator"),n=this.eventBus.subscribe("music:beat",r=>{this.currentIntensity=r.intensity},"EnhancedMasterAnimationCoordinator");this.emergentEventSubscriptions.push(t,e,i,n)}handleBeatFrame(t){this.signature&&(this.signature.lastModified=Date.now(),this.coordinateConsciousnessBreathing({intensity:t.intensity||this.currentIntensity,energy:t.energy||this.currentIntensity,bpm:this.currentBpm}))}handleHarmonyFrame(t){if(!this.signature)return;let{kineticState:e}=t;this.signature.lastModified=Date.now()}async _updateEvolutionaryTrajectory(){if(!this.signature)return;let t=await Mt.getSignatureTrends(this.signature);if(!t)return;let{avgEnergy:e,avgValence:i}=t,n=.5+(e-.5)*.2;this.signature.evolutionaryTrajectory.explorationFactor=Math.max(.1,Math.min(.9,n));let r=.5+(Math.abs(i)-.2)*.3;this.signature.evolutionaryTrajectory.adaptability=Math.max(.1,Math.min(.9,r)),this.signature.evolutionaryTrajectory.lastUpdate=Date.now()}_calculateVisualPulse(t){let e=6e4/this.currentBpm,i=performance.now()%e/e,n=Math.sin(i*2*Math.PI+Math.PI/2)*15*this.currentIntensity;return{timestamp:performance.now(),bpm:this.currentBpm,intensity:this.currentIntensity,phase:i,hueShift:n}}_calculateAdaptiveCoefficients(){if(!this.signature)return;let{adaptability:t,explorationFactor:e}=this.signature.evolutionaryTrajectory,i=.5+t*.5,n=.8+e*.4;this.currentMultipliers={...this.config.cosmicMultipliers,kineticIntensity:i,visualIntensityBase:n}}processEmergentTick(t){if(!this.signature)return;this._calculateAdaptiveCoefficients(),this.signature&&Date.now()-this.signature.evolutionaryTrajectory.lastUpdate>6e4&&this._updateEvolutionaryTrajectory();let e=this._calculateVisualPulse(t),i={timestamp:performance.now(),deltaMs:t}}destroyEmergentChoreography(){this.signature&&Mt.saveSignature(this.signature),this.saveInterval&&(clearInterval(this.saveInterval),this.saveInterval=null),this.emergentEventSubscriptions.forEach(t=>this.eventBus.unsubscribe(t)),this.emergentEventSubscriptions=[],this.config.enableDebug&&console.log("[EnhancedMasterAnimationCoordinator] Emergent choreography destroyed")}};Ce.instance=null;Fe=Ce});var mi,Ya=y(()=>{"use strict";mi=class{constructor(t={}){this._timerRegistry=new Map;this._timerMasterInterval=null;this.config={timerIntervalMs:t.timerIntervalMs||50,maxTimerBudget:t.maxTimerBudget||10,enableDebug:t.enableDebug||!1,...t},this._timerPerformanceMetrics={totalExecutions:0,totalTime:0,maxExecutionTime:0,averageExecutionTime:0,skippedTimers:0,timerCallbacks:new Map},this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Initialized")}initialize(){this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Timer consolidation initialized")}registerConsolidatedTimer(t,e,i,n="normal"){if(this._timerRegistry.has(t)){console.warn(`[TimerConsolidationSystem] Timer ${t} already registered`);return}let r={callback:e,intervalMs:i,priority:n,lastExecution:0,enabled:!0,executionCount:0,totalExecutionTime:0,maxExecutionTime:0,skippedExecutions:0};this._timerRegistry.set(t,r),this._timerPerformanceMetrics.timerCallbacks.set(t,{calls:0,totalTime:0,maxTime:0}),this.config.enableDebug&&console.log(`\u23F1\uFE0F [TimerConsolidationSystem] Registered timer: ${t} (${i}ms, ${n} priority)`),this._timerRegistry.size===1&&!this._timerMasterInterval&&this._startMasterTimer()}unregisterConsolidatedTimer(t){this._timerRegistry.has(t)&&(this._timerRegistry.delete(t),this._timerPerformanceMetrics.timerCallbacks.delete(t),this.config.enableDebug&&console.log(`\u23F1\uFE0F [TimerConsolidationSystem] Unregistered timer: ${t}`),this._timerRegistry.size===0&&this._stopMasterTimer())}_startMasterTimer(){this._timerMasterInterval||(this._timerMasterInterval=setInterval(()=>{this._executeMasterTimerFrame()},this.config.timerIntervalMs),this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Master timer started"))}_stopMasterTimer(){this._timerMasterInterval&&(clearInterval(this._timerMasterInterval),this._timerMasterInterval=null),this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Master timer stopped")}_executeMasterTimerFrame(){let t=performance.now(),e=this.config.maxTimerBudget,i=Array.from(this._timerRegistry.entries()).sort(([,r],[,a])=>{let s={critical:0,normal:1,background:2};return s[r.priority]-s[a.priority]});for(let[r,a]of i){if(!a.enabled||e<=0&&a.priority==="background"){e<=0&&a.skippedExecutions++;continue}if(t-a.lastExecution<a.intervalMs)continue;let o=performance.now();try{a.callback();let l=performance.now()-o;a.executionCount++,a.totalExecutionTime+=l,a.maxExecutionTime=Math.max(a.maxExecutionTime,l),a.lastExecution=t;let m=this._timerPerformanceMetrics.timerCallbacks.get(r);m&&(m.calls++,m.totalTime+=l,m.maxTime=Math.max(m.maxTime,l)),e-=l}catch(l){console.error(`[TimerConsolidationSystem] Error in timer ${r}:`,l),a.enabled=!1}}let n=performance.now()-t;this._updateTimerPerformanceMetrics(n)}_updateTimerPerformanceMetrics(t){let e=this._timerPerformanceMetrics;e.totalExecutions++,e.totalTime+=t,e.maxExecutionTime=Math.max(e.maxExecutionTime,t),e.averageExecutionTime=e.totalTime/e.totalExecutions,t>this.config.maxTimerBudget&&e.skippedTimers++}destroy(){this._stopMasterTimer(),this._timerRegistry.clear(),this.config.enableDebug&&console.log("\u23F1\uFE0F [TimerConsolidationSystem] Destroyed")}}});var di,Ka=y(()=>{"use strict";U();D();A();di=class{constructor(){this.initialized=!1;this.performanceOrchestrator=null;this.performanceThresholds={excellent:{minFPS:58,maxFrameTime:17,maxCPU:.15},good:{minFPS:50,maxFrameTime:20,maxCPU:.25},degraded:{minFPS:40,maxFrameTime:25,maxCPU:.35},critical:{minFPS:30,maxFrameTime:33,maxCPU:.5}};this.qualityTierConfigs=new Map([["minimal",{halfLife:.2,performanceMultiplier:.3,complexityReduction:.8,updateFrequency:.5,enableBeatPhase:!1,enableEnergyModulation:!1,enableTemperatureMapping:!1,useSimplifiedCalculations:!0,skipNonCriticalUpdates:!0,batchUpdates:!0}],["low",{halfLife:.15,performanceMultiplier:.5,complexityReduction:.6,updateFrequency:.7,enableBeatPhase:!1,enableEnergyModulation:!0,enableTemperatureMapping:!1,useSimplifiedCalculations:!0,skipNonCriticalUpdates:!0,batchUpdates:!0}],["medium",{halfLife:.1,performanceMultiplier:.8,complexityReduction:.4,updateFrequency:.8,enableBeatPhase:!0,enableEnergyModulation:!0,enableTemperatureMapping:!0,useSimplifiedCalculations:!1,skipNonCriticalUpdates:!1,batchUpdates:!1}],["high",{halfLife:.08,performanceMultiplier:1,complexityReduction:.2,updateFrequency:.9,enableBeatPhase:!0,enableEnergyModulation:!0,enableTemperatureMapping:!0,useSimplifiedCalculations:!1,skipNonCriticalUpdates:!1,batchUpdates:!1}],["ultra",{halfLife:.05,performanceMultiplier:1.2,complexityReduction:0,updateFrequency:1,enableBeatPhase:!0,enableEnergyModulation:!0,enableTemperatureMapping:!0,useSimplifiedCalculations:!1,skipNonCriticalUpdates:!1,batchUpdates:!1}]]);this.lastPerformanceCheck=0;this.performanceCheckInterval=1e3;this.lastQualityAdjustment=0;this.qualityAdjustmentCooldown=3e3;this.eventBus=g,this.currentPerformanceContext=this.createDefaultPerformanceContext(),this.currentLerpParams=this.qualityTierConfigs.get("medium"),this.performanceMetrics=this.createDefaultMetrics(),w.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Performance-aware LERP coordinator initialized")}async initialize(){if(!this.initialized)try{this.subscribeToPerformanceEvents(),this.startPerformanceMonitoring(),this.initialized=!0,w.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Performance-aware LERP coordination fully initialized")}catch(t){throw u?.debug?.error("PerformanceAwareLerpCoordinator","Initialization failed:",t),t}}updateAnimation(t){this.updatePerformanceMetrics(t),this.shouldAdaptPerformance()&&this.adaptLerpPerformance()}async healthCheck(){let t=this.performanceMetrics,e=t.frameTimeImpact,i=t.averageCalculationTime,n=e<1&&i<.1&&t.musicalAccuracy>.7;return{system:"PerformanceAwareLerpCoordinator",healthy:n,ok:n,details:n?"Performance-aware LERP coordination operating efficiently":`Performance issues: impact=${e.toFixed(2)}ms, calc=${i.toFixed(3)}ms`,metrics:{frameTimeImpact:e,averageCalculationTime:i,musicalAccuracy:t.musicalAccuracy,qualityLevel:this.currentPerformanceContext.qualityLevel,thermalState:this.currentPerformanceContext.thermalState,calculationsPerSecond:t.calculationsPerSecond}}}destroy(){this.stopPerformanceMonitoring(),this.unsubscribeFromPerformanceEvents(),this.initialized=!1,w.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Performance-aware LERP coordinator destroyed")}calculatePerformanceAwareMusicalLerp(t,e,i,n,r="flow",a){let s=performance.now(),o=this.getCurrentLerpParams(),l=this.calculateEffectiveHalfLife(n,r,a,o),m;o.useSimplifiedCalculations||!n?m=this.calculateSimplifiedLerp(t,e,i,l):m=this.calculateFullMusicalLerp(t,e,i,n,r,l,o);let d=performance.now()-s;return this.updateCalculationMetrics(d),m}getCurrentPerformanceContext(){return{...this.currentPerformanceContext}}getCurrentLerpParams(){return{...this.currentLerpParams}}getPerformanceMetrics(){return{...this.performanceMetrics}}setSimplePerformanceCoordinator(t){this.performanceOrchestrator=t,w.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Integrated with consolidated SimplePerformanceCoordinator")}syncWithOrchestrator(){if(this.performanceOrchestrator)try{let t=this.performanceOrchestrator.getCurrentPerformanceState?.();if(t){let e={currentFPS:t.currentFPS||this.currentPerformanceContext.currentFPS,frameTimeMs:t.frameTimeMs||this.currentPerformanceContext.frameTimeMs,qualityLevel:t.qualityLevel||this.currentPerformanceContext.qualityLevel,thermalState:t.thermalState||this.currentPerformanceContext.thermalState,memoryPressure:t.memoryPressure||this.currentPerformanceContext.memoryPressure,cpuUtilization:t.cpuUtilization||this.currentPerformanceContext.cpuUtilization};this.updatePerformanceState(e)}}catch(t){w.enableDebug&&u?.debug?.warn("PerformanceAwareLerpCoordinator","Failed to sync with orchestrator:",t)}}updatePerformanceState(t){this.currentPerformanceContext={...this.currentPerformanceContext,...t},this.adaptLerpParameters(),w.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Performance state updated",{qualityLevel:this.currentPerformanceContext.qualityLevel,currentFPS:this.currentPerformanceContext.currentFPS,thermalState:this.currentPerformanceContext.thermalState})}createDefaultPerformanceContext(){return{currentFPS:60,targetFPS:60,frameTimeMs:16.67,frameBudgetMs:16.67,qualityLevel:"medium",qualityScore:.5,deviceTier:"medium",thermalState:"nominal",powerLevel:"balanced",memoryPressure:"low",cpuUtilization:.2,memoryUtilization:.3,gpuUtilization:.2}}createDefaultMetrics(){return{averageCalculationTime:0,calculationsPerSecond:0,frameTimeImpact:0,cpuImpact:0,memoryImpact:0,musicalAccuracy:1,smoothnessQuality:1,responsiveness:1,qualityReductions:0,performanceRecoveries:0}}subscribeToPerformanceEvents(){}unsubscribeFromPerformanceEvents(){}startPerformanceMonitoring(){}stopPerformanceMonitoring(){}shouldAdaptPerformance(){let t=performance.now();if(t-this.lastPerformanceCheck<this.performanceCheckInterval)return!1;this.lastPerformanceCheck=t;let e=this.currentPerformanceContext,i=e.currentFPS<e.targetFPS*.9||e.frameTimeMs>e.frameBudgetMs*1.2||e.thermalState!=="nominal"||e.memoryPressure==="high",n=e.currentFPS>e.targetFPS*1.1&&e.frameTimeMs<e.frameBudgetMs*.8&&e.thermalState==="nominal"&&t-this.lastQualityAdjustment>this.qualityAdjustmentCooldown;return i||n}adaptLerpPerformance(){let t=this.currentPerformanceContext,e=t.currentFPS<t.targetFPS*.8||t.frameTimeMs>t.frameBudgetMs*1.3||t.thermalState==="hot"||t.thermalState==="critical"||t.memoryPressure==="high",i=t.currentFPS>t.targetFPS*1.1&&t.frameTimeMs<t.frameBudgetMs*.7&&t.thermalState==="nominal"&&t.memoryPressure==="low";e?this.reducePerformanceQuality():i&&this.increasePerformanceQuality()}reducePerformanceQuality(){let t=this.currentLerpParams;t.performanceMultiplier=Math.min(2,t.performanceMultiplier*1.2),t.complexityReduction=Math.min(.9,t.complexityReduction+.1),t.updateFrequency=Math.max(.3,t.updateFrequency*.9),t.enableTemperatureMapping?t.enableTemperatureMapping=!1:t.enableEnergyModulation?t.enableEnergyModulation=!1:t.enableBeatPhase&&(t.enableBeatPhase=!1),t.useSimplifiedCalculations=!0,t.skipNonCriticalUpdates=!0,t.batchUpdates=!0,this.performanceMetrics.qualityReductions++,this.lastQualityAdjustment=performance.now(),w.enableDebug&&u?.debug?.warn("PerformanceAwareLerpCoordinator","Reduced LERP quality for performance",{performanceMultiplier:t.performanceMultiplier,complexityReduction:t.complexityReduction})}increasePerformanceQuality(){let t=this.currentLerpParams;t.performanceMultiplier=Math.max(.5,t.performanceMultiplier*.9),t.complexityReduction=Math.max(0,t.complexityReduction-.1),t.updateFrequency=Math.min(1,t.updateFrequency*1.1),!t.enableBeatPhase&&t.complexityReduction<.3?t.enableBeatPhase=!0:!t.enableEnergyModulation&&t.complexityReduction<.2?t.enableEnergyModulation=!0:!t.enableTemperatureMapping&&t.complexityReduction<.1&&(t.enableTemperatureMapping=!0),this.performanceMetrics.performanceRecoveries++,this.lastQualityAdjustment=performance.now(),w.enableDebug&&u?.debug?.log("PerformanceAwareLerpCoordinator","Increased LERP quality",{performanceMultiplier:t.performanceMultiplier,complexityReduction:t.complexityReduction})}adaptLerpParameters(){let t=this.currentPerformanceContext,e=this.qualityTierConfigs.get(t.qualityLevel);e&&(this.currentLerpParams={...e},t.thermalState==="warm"?this.currentLerpParams.performanceMultiplier*=1.2:t.thermalState==="hot"?(this.currentLerpParams.performanceMultiplier*=1.5,this.currentLerpParams.enableTemperatureMapping=!1):t.thermalState==="critical"&&(this.currentLerpParams.performanceMultiplier*=2,this.currentLerpParams.enableTemperatureMapping=!1,this.currentLerpParams.enableEnergyModulation=!1,this.currentLerpParams.useSimplifiedCalculations=!0),t.powerLevel==="battery-saver"&&(this.currentLerpParams.performanceMultiplier*=1.5,this.currentLerpParams.enableTemperatureMapping=!1,this.currentLerpParams.updateFrequency*=.7),t.memoryPressure==="high"&&(this.currentLerpParams.batchUpdates=!0,this.currentLerpParams.skipNonCriticalUpdates=!0,this.currentLerpParams.updateFrequency*=.8))}calculateEffectiveHalfLife(t,e,i,n){let r=i||n.halfLife;if(r*=n.performanceMultiplier,t&&n.enableEnergyModulation){let a=Math.max(.5,Math.min(2,t.tempo/120));if(r/=a,n.enableEnergyModulation){let s=.7+t.energy*.6;r/=s}}return Math.max(.01,Math.min(1,r))}calculateSimplifiedLerp(t,e,i,n){let r=Math.pow(2,-(i/1e3)/n);return t+(e-t)*(1-r)}calculateFullMusicalLerp(t,e,i,n,r,a,s){let o=this.calculateSimplifiedLerp(t,e,i,a);if(s.enableBeatPhase&&n.beatPhase){let l=this.calculateBeatPhaseModifier(n.beatPhase,n.timeSinceLastBeat,n.beatInterval,r),m=s.complexityReduction>.5?.1:.2;o+=(e-t)*l*m}if(s.enableEnergyModulation&&n.danceability>0){let l=.9+n.danceability*.2;o=t+(o-t)*l}return o}calculateBeatPhaseModifier(t,e,i,n){switch(t){case"attack":return n==="pulse"?.3:.1;case"sustain":return n==="flow"?.1:.05;case"decay":return n==="pulse"?-.1:-.05;case"rest":return 0;default:return 0}}updatePerformanceMetrics(t){let e=this.performanceMetrics.frameTimeImpact;this.performanceMetrics.frameTimeImpact=e*.9+0*.1;let i=1;this.performanceMetrics.calculationsPerSecond=this.performanceMetrics.calculationsPerSecond*.95+i/(t/1e3)*.05}updateCalculationMetrics(t){let e=this.performanceMetrics.averageCalculationTime;this.performanceMetrics.averageCalculationTime=e*.9+t*.1;let i=this.performanceMetrics.frameTimeImpact;this.performanceMetrics.frameTimeImpact=i*.9+t*.1;let n=this.currentLerpParams,r=1;n.enableBeatPhase||(r-=.2),n.enableEnergyModulation||(r-=.15),n.enableTemperatureMapping||(r-=.1),n.useSimplifiedCalculations&&(r-=.1),this.performanceMetrics.musicalAccuracy=Math.max(.3,r),this.performanceMetrics.smoothnessQuality=Math.max(.5,1-(n.performanceMultiplier-1)*.3),this.performanceMetrics.responsiveness=n.updateFrequency}handleQualityChange(t){let{newLevel:e}=t;e&&e.level&&(this.currentPerformanceContext.qualityLevel=e.level,this.adaptLerpParameters())}handleThermalWarning(t){this.currentPerformanceContext.thermalState="hot",this.adaptLerpParameters(),w.enableDebug&&u?.debug?.warn("PerformanceAwareLerpCoordinator","Thermal warning - adapting LERP performance")}handleQualityLevelChange(t){let{newLevel:e}=t;e&&typeof e.level=="string"&&(this.currentPerformanceContext.qualityLevel=e.level,this.adaptLerpParameters())}}});var he,hi=y(()=>{"use strict";A();he=class{static detectTier(){let t=this._analyzeDeviceCapabilities(),e=[],i="medium",n=.8;this._isHighTierDevice(t,e)?(i="high",n=.9):this._isLowTierDevice(t,e)?(i="low",n=.85):(e.push("Standard modern device - full experience enabled"),e.push(`${t.memory}GB RAM, ${t.cores} cores, WebGL2: ${t.webgl2}`));let r={tier:i,confidence:n,reasoning:e,capabilities:t};return u?.debug?.log("EnhancedDeviceTierDetector","Tier detection complete",r),r}static _analyzeDeviceCapabilities(){let t=navigator.deviceMemory||this._estimateMemory(),e=navigator.hardwareConcurrency||this._estimateCores(),i=this._checkWebGLSupport(),n=this._checkWebGL2Support(),r=navigator.userAgent,a=navigator.platform||"unknown";return{memory:t,cores:e,webgl:i,webgl2:n,userAgent:r,platform:a,hardwareInfo:{isHighEnd:this._detectHighEndHardware(t,e,r),isMobile:this._isMobileDevice(r,a),isOldDevice:this._isOldDevice(r),hasPerformanceIndicators:this._hasPerformanceIndicators(r)}}}static _isHighTierDevice(t,e){let{memory:i,cores:n,webgl2:r,hardwareInfo:a}=t;if(!(i>=8&&n>=6&&r))return!1;let o=[];return i>=16&&o.push("16+GB RAM"),n>=8&&o.push("8+ CPU cores"),a.hasPerformanceIndicators&&o.push("Performance GPU detected"),a.isHighEnd&&o.push("High-end hardware signatures"),o.length>=2?(e.push("High-end device detected"),e.push(`Specs: ${i}GB RAM, ${n} cores, WebGL2: ${r}`),e.push(`Indicators: ${o.join(", ")}`),!0):this._isGamingOrWorkstation(t)?(e.push("Gaming/workstation device detected"),e.push("High-performance device indicators found"),!0):!1}static _isLowTierDevice(t,e){let{memory:i,cores:n,webgl2:r,hardwareInfo:a}=t,s=[];return i<4&&s.push(`Low memory: ${i}GB`),n<4&&s.push(`Few CPU cores: ${n}`),r||s.push("No WebGL2 support"),a.isOldDevice&&s.push("Legacy device detected"),a.isMobile&&i<=4&&n<=4&&s.push("Resource-constrained mobile device"),s.length>=2?(e.push("Budget/legacy device detected - enabling performance optimizations"),e.push(...s),!0):!1}static _estimateMemory(){let t=navigator.userAgent.toLowerCase();return t.includes("mobile")||t.includes("android")?4:t.includes("ipad")||t.includes("tablet")?6:8}static _estimateCores(){return navigator.userAgent.toLowerCase().includes("mobile"),4}static _checkWebGLSupport(){try{let t=document.createElement("canvas"),i=(t.getContext("webgl")||t.getContext("experimental-webgl"))!==null;return t.remove(),i}catch{return!1}}static _checkWebGL2Support(){try{let t=document.createElement("canvas"),i=t.getContext("webgl2")!==null;return t.remove(),i}catch{return!1}}static _detectHighEndHardware(t,e,i){let n=i.toLowerCase();return[n.includes("gaming"),n.includes("nvidia"),n.includes("amd"),n.includes("geforce"),n.includes("radeon"),t>=16,e>=8].filter(Boolean).length>=2}static _isMobileDevice(t,e){let i=t.toLowerCase(),n=e.toLowerCase();return i.includes("mobile")||i.includes("android")||i.includes("iphone")||i.includes("ipad")||n.includes("arm")||"ontouchstart"in window}static _isOldDevice(t){let e=t.toLowerCase();return[/chrome\/[1-6]\d\./,/firefox\/[1-5]\d\./,/safari\/[1-9]\./,/msie|trident/].some(n=>n.test(e))}static _hasPerformanceIndicators(t){let e=t.toLowerCase();return["nvidia","amd","geforce","radeon","quadro","gaming","performance"].some(n=>e.includes(n))}static _isGamingOrWorkstation(t){let{userAgent:e,memory:i,cores:n}=t,r=e.toLowerCase();return[r.includes("gaming"),r.includes("rog"),r.includes("msi"),r.includes("alienware"),r.includes("predator"),i>=16&&n>=8].some(Boolean)}static getDeviceDescription(t){let{memory:e,cores:i,webgl2:n,hardwareInfo:r}=t,a=`${e}GB RAM, ${i} CPU cores`;return n&&(a+=", WebGL2"),r.isHighEnd&&(a+=", High-end hardware"),r.isMobile&&(a+=", Mobile device"),r.hasPerformanceIndicators&&(a+=", Performance GPU"),a}}});var ut,jn=y(()=>{"use strict";hi();D();A();ut=class{constructor(t){this.initialized=!1;this.webglIntegration=null;this.deviceTier="medium";this.tierDetectionResult=null;this.energyBoostActive=!1;this.energyBoostTimeout=null;this.tierSettings={low:{webglQuality:"low",animationDensity:.6,updateFrequency:45,particleMultiplier:.4,corridorEffects:!1,advancedFeatures:!1,experimentalFeatures:!1},medium:{webglQuality:"high",animationDensity:.9,updateFrequency:60,particleMultiplier:1,corridorEffects:!0,advancedFeatures:!0,experimentalFeatures:!1},high:{webglQuality:"high",animationDensity:1,updateFrequency:60,particleMultiplier:1.2,corridorEffects:!0,advancedFeatures:!0,experimentalFeatures:!0}};this.energyBoostSettings={animationBoost:1.3,particleBoost:1.5,duration:1e4};this.enhancedDeviceTierDetector=t,this.currentSettings=this.tierSettings.medium,u?.debug?.log("SimpleTierBasedPerformanceSystem","Initialized with tier-based performance management")}async initialize(){this.initialized||(this.tierDetectionResult=he.detectTier(),this.deviceTier=this.tierDetectionResult.tier,this.currentSettings=this.tierSettings[this.deviceTier],this._setupMusicAnalysisListener(),this._applyTierSettings(),this.initialized=!0,u?.debug?.log("SimpleTierBasedPerformanceSystem","Initialization complete",{deviceTier:this.deviceTier,confidence:this.tierDetectionResult.confidence,reasoning:this.tierDetectionResult.reasoning,deviceDescription:he.getDeviceDescription(this.tierDetectionResult.capabilities),settings:this.currentSettings}))}async healthCheck(){return this.initialized?{healthy:!0,details:`Performance tier: ${this.deviceTier}, Energy boost: ${this.energyBoostActive?"active":"inactive"}`,system:"SimpleTierBasedPerformanceSystem"}:{healthy:!1,details:"Not initialized",system:"SimpleTierBasedPerformanceSystem"}}destroy(){this.energyBoostTimeout&&(clearTimeout(this.energyBoostTimeout),this.energyBoostTimeout=null),g.unsubscribe("colors:extracted"),g.unsubscribe("music:track-changed"),this.initialized=!1,u?.debug?.log("SimpleTierBasedPerformanceSystem","Destroyed")}updateAnimation(t){}registerWebGLIntegration(t){this.webglIntegration=t,this.initialized&&this._applyWebGLSettings(),u?.debug?.log("SimpleTierBasedPerformanceSystem","WebGL integration registered")}getDeviceTier(){return this.deviceTier}getTierDetectionResult(){return this.tierDetectionResult}getDeviceDescription(){return this.tierDetectionResult?he.getDeviceDescription(this.tierDetectionResult.capabilities):"Unknown device"}getCurrentSettings(){return{...this.currentSettings}}hasEnergyBoost(){return this.energyBoostActive}getEffectiveSettings(){let t={...this.currentSettings};return this.energyBoostActive?{...t,animationDensity:Math.min(1,t.animationDensity*this.energyBoostSettings.animationBoost),particleMultiplier:t.particleMultiplier*this.energyBoostSettings.particleBoost,energyBoosted:!0}:{...t,energyBoosted:!1}}setTier(t){this.deviceTier=t,this.currentSettings=this.tierSettings[t],this._applyTierSettings(),u?.debug?.log("SimpleTierBasedPerformanceSystem",`Tier manually set to ${t}`)}_setupMusicAnalysisListener(){g.subscribe("colors:extracted",t=>{t.musicData&&this._handleMusicAnalysis({energy:t.musicData.energy||.5,valence:t.musicData.valence||.5,bpm:t.musicData.tempo||120,genre:t.musicData.genre||"unknown"})}),g.subscribe("music:track-changed",t=>{this._handleSongChange(t)})}_handleSongChange(t){t.analysis&&this._checkEnergyBoost(t.analysis)}_handleMusicAnalysis(t){this._checkEnergyBoost(t)}_checkEnergyBoost(t){let e=t.energy>.7&&t.bpm>130&&(t.danceability||0)>.6,i=e&&!this.energyBoostActive,n=!e&&this.energyBoostActive;i?this._activateEnergyBoost(t):n&&this._deactivateEnergyBoost()}_activateEnergyBoost(t){this.energyBoostActive=!0,this.energyBoostTimeout&&clearTimeout(this.energyBoostTimeout),this._applyTierSettings(),this.energyBoostTimeout=window.setTimeout(()=>{this._deactivateEnergyBoost()},this.energyBoostSettings.duration),g.emit("performance:tier-changed",{tier:this.deviceTier,previousTier:this.deviceTier,timestamp:Date.now()}),u?.debug?.log("SimpleTierBasedPerformanceSystem","Energy boost activated",{bpm:t.bpm,energy:t.energy,danceability:t.danceability})}_deactivateEnergyBoost(){this.energyBoostActive&&(this.energyBoostActive=!1,this.energyBoostTimeout&&(clearTimeout(this.energyBoostTimeout),this.energyBoostTimeout=null),this._applyTierSettings(),g.emit("performance:tier-changed",{tier:this.deviceTier,previousTier:this.deviceTier,timestamp:Date.now()}),u?.debug?.log("SimpleTierBasedPerformanceSystem","Energy boost deactivated"))}_applyTierSettings(){this._applyWebGLSettings(),this._applySystemSettings();let t=this.getEffectiveSettings();g.emit("performance:tier-changed",{tier:this.deviceTier,previousTier:this.deviceTier,timestamp:Date.now()})}_applyWebGLSettings(){if(!this.webglIntegration)return;let t=this.getEffectiveSettings();this.webglIntegration.setQuality(t.webglQuality),u?.debug?.log("SimpleTierBasedPerformanceSystem","WebGL settings applied",{tier:this.deviceTier,quality:t.webglQuality,energyBoosted:t.energyBoosted})}_applySystemSettings(){let t=this.getEffectiveSettings();g.emit("performance:frame",{deltaTime:16,fps:t.updateFrequency,memoryUsage:.5,timestamp:Date.now()})}}});var Ge,Qn=y(()=>{"use strict";jn();A();Ge=class{constructor(t,e){this.initialized=!1;this.enhancedDeviceTierDetector=t,this.webglIntegration=e,this.performanceSystem=new ut(t),u?.debug?.log("SimplePerformanceCoordinator","Created simple performance coordination")}async initialize(){if(this.initialized)return;await this.performanceSystem.initialize(),this.performanceSystem.registerWebGLIntegration(this.webglIntegration),this.initialized=!0;let t=this.performanceSystem.getTierDetectionResult();u?.debug?.log("SimplePerformanceCoordinator","Coordination established",{deviceTier:this.performanceSystem.getDeviceTier(),deviceDescription:this.performanceSystem.getDeviceDescription(),confidence:t?.confidence,webglState:this.webglIntegration?.getWebGLState()||"disabled"})}async healthCheck(){if(!this.initialized)return{healthy:!1,details:"Not initialized",system:"SimplePerformanceCoordinator"};let t=await this.performanceSystem.healthCheck(),e=this.webglIntegration?await this.webglIntegration.healthCheck():{healthy:!1,details:"WebGL integration not available"},i=[];return t.healthy||i.push(`Performance: ${t.details}`),e.healthy||i.push(`WebGL: ${e.details}`),{healthy:i.length===0,details:i.length>0?`Issues: ${i.join(", ")}`:`Coordinating ${this.performanceSystem.getDeviceTier()} tier performance with ${this.webglIntegration?.getWebGLState()||"disabled"} WebGL`,issues:i,system:"SimplePerformanceCoordinator"}}destroy(){this.performanceSystem.destroy(),this.initialized=!1,u?.debug?.log("SimplePerformanceCoordinator","Coordination destroyed")}updateAnimation(t){this.performanceSystem.updateAnimation(t)}getPerformanceSystem(){return this.performanceSystem}getDeviceTier(){return this.performanceSystem.getDeviceTier()}getDeviceDescription(){return this.performanceSystem.getDeviceDescription()}hasEnergyBoost(){return this.performanceSystem.hasEnergyBoost()}getCurrentSettings(){return this.performanceSystem.getEffectiveSettings()}getWebGLStatus(){return this.webglIntegration?{state:this.webglIntegration.getWebGLState(),quality:this.webglIntegration.getQuality(),enabled:this.webglIntegration.isWebGLActive()}:{state:"disabled",quality:"low",enabled:!1}}getPerformanceSummary(){let t=this.performanceSystem.getTierDetectionResult();return{deviceTier:this.getDeviceTier(),deviceDescription:this.getDeviceDescription(),confidence:t?.confidence||0,reasoning:t?.reasoning||[],webglStatus:this.getWebGLStatus(),energyBoost:this.hasEnergyBoost(),settings:this.getCurrentSettings()}}startMonitoring(){u?.debug?.log("SimplePerformanceCoordinator","Monitoring started (tier-based system)")}emitTrace(t,e){u?.debug?.log("SimplePerformanceCoordinator",`${t}`,e)}recordMetric(t,e){u?.debug?.log("SimplePerformanceCoordinator",`Metric ${t}: ${e}`)}getMedianFPS(){switch(this.getDeviceTier()){case"high":return 60;case"medium":return 50;case"low":return 30;default:return 30}}calculateHealthScore(){switch(this.getDeviceTier()){case"high":return .95;case"medium":return .75;case"low":return .5;default:return .5}}shouldReduceQuality(){return this.getDeviceTier()==="low"}timeOperation(t,e){let i=performance.now(),n=e(),r=performance.now()-i;return u?.debug?.log("SimplePerformanceCoordinator",`Operation ${t}: ${r.toFixed(2)}ms`),n}async timeOperationAsync(t,e){let i=performance.now(),n=await e(),r=performance.now()-i;return u?.debug?.log("SimplePerformanceCoordinator",`Async operation ${t}: ${r.toFixed(2)}ms`),n}getAverageTime(t){switch(this.getDeviceTier()){case"high":return 5;case"medium":return 15;case"low":return 30;default:return 15}}updateBudget(t,e){u?.debug?.log("SimplePerformanceCoordinator",`Budget update ignored: ${t}=${e} (tier-based system)`)}startTiming(t){let e=`${t}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return u?.debug?.log("SimplePerformanceCoordinator",`Timing started: ${t} (${e})`),e}endTiming(t,e){u?.debug?.log("SimplePerformanceCoordinator",`Timing ended: ${t}`,e)}}});var gi,ja=y(()=>{"use strict";A();D();gi=class{constructor(t){this.initialized=!1;this.currentState="disabled";this.webglSystems=new Map;this.lastStateChange=0;this.stateChangeHistory=[];this.userExplicitlyDisabled=!1;this.userExplicitQuality=null;this.deviceCapabilities=t,this.config={enabled:!0,quality:"medium",forceEnabled:!1,allowPerformanceAdjustment:!0},u?.debug?.log("UnifiedWebGLController","Initialized with unified WebGL management")}async initialize(){this.initialized||(this.deviceCapabilities.isInitialized||await this.deviceCapabilities.initialize(),await this._loadSettings(),await this._determineInitialState(),this._setupEventListeners(),this._applyStateToAllSystems(),this.initialized=!0,u?.debug?.log("UnifiedWebGLController","Initialization complete",{state:this.currentState,quality:this.config.quality,systemCount:this.webglSystems.size}))}async healthCheck(){if(!this.initialized)return{healthy:!1,details:"Not initialized",system:"UnifiedWebGLController"};let t=[];for(let[i,n]of this.webglSystems)if(n.system.healthCheck)try{let r=await n.system.healthCheck();r.healthy||t.push(`${i}: ${r.details||"unhealthy"}`)}catch{t.push(`${i}: health check failed`)}let e=this.stateChangeHistory.filter(i=>Date.now()-i.timestamp<3e4).length;return t.length>0||e>3?{healthy:!0,details:`Issues detected: ${t.join(", ")}`,issues:t,system:"UnifiedWebGLController"}:{healthy:!0,details:"All WebGL systems operating normally",system:"UnifiedWebGLController"}}destroy(){this._setState("disabled"),this.webglSystems.clear(),g.unsubscribe("settings:changed"),g.unsubscribe("system:state-changed"),this.initialized=!1,u?.debug?.log("UnifiedWebGLController","Destroyed - all WebGL systems disabled")}updateAnimation(t){if(this.currentState==="webgl-active"){for(let[e,i]of this.webglSystems)if(i.system.updateAnimation)try{i.system.updateAnimation(t)}catch(n){u?.debug?.warn("UnifiedWebGLController",`Animation update failed for ${e}:`,n)}}}enable(){this.userExplicitlyDisabled=!1,this.config.enabled=!0,this._determineAndApplyState(),this._saveSettings(),u?.debug?.log("UnifiedWebGLController","WebGL enabled by user")}disable(){this.userExplicitlyDisabled=!0,this.config.enabled=!1,this._setState("css-fallback"),this._saveSettings(),u?.debug?.log("UnifiedWebGLController","WebGL disabled by user")}setQuality(t){this.userExplicitQuality=t,this.config.quality=t,this._applyQualityToAllSystems(),this._saveSettings(),u?.debug?.log("UnifiedWebGLController",`Quality set to ${t} by user`)}isEnabled(){return this.currentState==="webgl-active"}isAvailable(){return this.deviceCapabilities.getSpicetifyProfile()?.webglCapabilities?.available||!1}getState(){return this.currentState}getQuality(){return this.config.quality}forceEnable(t=!0){this.config.forceEnabled=t,this._determineAndApplyState(),this._saveSettings(),u?.debug?.log("UnifiedWebGLController",`Force enable set to ${t}`)}registerSystem(t,e,i=0){this.webglSystems.set(t,{system:e,name:t,priority:i}),this.initialized&&this._applyStateToSystem(t,e),u?.debug?.log("UnifiedWebGLController",`System registered: ${t} (priority: ${i})`)}unregisterSystem(t){let e=this.webglSystems.get(t);e&&(e.system.setEnabled&&e.system.setEnabled(!1),this.webglSystems.delete(t),u?.debug?.log("UnifiedWebGLController",`System unregistered: ${t}`))}suggestQualityAdjustment(t,e){if(!this.config.allowPerformanceAdjustment){u?.debug?.log("UnifiedWebGLController",`Performance adjustment ignored (not allowed): ${e}`);return}if(this.userExplicitQuality!==null){u?.debug?.log("UnifiedWebGLController",`Performance adjustment ignored (user set explicit quality): ${e}`);return}if(this.config.quality!==t){let i=this.config.quality;this.config.quality=t,this._applyQualityToAllSystems(),u?.debug?.log("UnifiedWebGLController",`Quality adjusted by performance system: ${i} \u2192 ${t} (${e})`)}}performanceDisable(t){!this.config.allowPerformanceAdjustment||this.userExplicitlyDisabled===!1||this.currentState==="webgl-active"&&(this._setState("css-fallback"),u?.debug?.log("UnifiedWebGLController",`WebGL disabled by performance system: ${t}`))}performanceEnable(t){!this.config.allowPerformanceAdjustment||this.userExplicitlyDisabled||this.currentState==="css-fallback"&&this.config.enabled&&(this._determineAndApplyState(),u?.debug?.log("UnifiedWebGLController",`WebGL re-enabled by performance system: ${t}`))}async _loadSettings(){try{let t=localStorage.getItem("sn-webgl-enabled"),e=localStorage.getItem("sn-webgl-quality"),i=localStorage.getItem("sn-webgl-force-enabled");t!==null&&(this.config.enabled=t==="true",t==="false"&&(this.userExplicitlyDisabled=!0)),e&&["low","medium","high"].includes(e)&&(this.config.quality=e,this.userExplicitQuality=e),i!==null&&(this.config.forceEnabled=i==="true"),u?.debug?.log("UnifiedWebGLController","Settings loaded",this.config)}catch(t){u?.debug?.warn("UnifiedWebGLController","Failed to load settings:",t)}}_saveSettings(){try{localStorage.setItem("sn-webgl-enabled",this.config.enabled.toString()),localStorage.setItem("sn-webgl-quality",this.config.quality),localStorage.setItem("sn-webgl-force-enabled",this.config.forceEnabled.toString())}catch(t){u?.debug?.warn("UnifiedWebGLController","Failed to save settings:",t)}}async _determineInitialState(){if(!this.config.enabled||this.userExplicitlyDisabled){this._setState("css-fallback");return}this.config.forceEnabled||this.isAvailable()?this._setState("webgl-active"):this._setState("css-fallback")}_determineAndApplyState(){!this.config.enabled||this.userExplicitlyDisabled?this._setState("css-fallback"):this.config.forceEnabled||this.isAvailable()?this._setState("webgl-active"):this._setState("css-fallback")}_setState(t){if(this.currentState===t)return;let e=this.currentState;this.currentState=t,this.lastStateChange=Date.now(),this.stateChangeHistory.push({state:t,quality:this.config.quality,timestamp:this.lastStateChange}),this.stateChangeHistory.length>20&&(this.stateChangeHistory=this.stateChangeHistory.slice(-20)),this._applyStateToAllSystems(),g.emit("performance:tier-changed",{tier:t,previousTier:e,timestamp:this.lastStateChange}),u?.debug?.log("UnifiedWebGLController",`State changed: ${e} \u2192 ${t}`)}_applyStateToAllSystems(){let t=Array.from(this.webglSystems.entries()).sort(([,e],[,i])=>i.priority-e.priority);for(let[e,i]of t)this._applyStateToSystem(e,i.system)}_applyStateToSystem(t,e){try{let i=this.currentState==="webgl-active";if(e.setEnabled&&e.setEnabled(i),i&&e.setQuality&&e.setQuality(this.config.quality),t==="corridor-effects"&&e.setEnabled){let n=i&&(this.config.quality==="medium"||this.config.quality==="high");e.setEnabled(n)}}catch(i){u?.debug?.warn("UnifiedWebGLController",`Failed to apply state to ${t}:`,i)}}_applyQualityToAllSystems(){if(this.currentState==="webgl-active"){for(let[t,e]of this.webglSystems)try{if(e.system.setQuality&&e.system.setQuality(this.config.quality),t==="corridor-effects"){let i=this.config.quality==="medium"||this.config.quality==="high";e.system.setEnabled&&e.system.setEnabled(i)}}catch(i){u?.debug?.warn("UnifiedWebGLController",`Failed to apply quality to ${t}:`,i)}g.emit("performance:tier-changed",{tier:this.config.quality,previousTier:this.config.quality,timestamp:Date.now()})}}_setupEventListeners(){g.subscribe("settings:changed",t=>{t.settingKey==="sn-webgl-enabled"?(this.config.enabled=t.newValue==="true",this.userExplicitlyDisabled=t.newValue==="false",this._determineAndApplyState()):t.settingKey==="sn-webgl-quality"?this.setQuality(t.newValue):t.settingKey==="sn-webgl-force-enabled"&&(this.config.forceEnabled=t.newValue==="true",this._determineAndApplyState())}),g.subscribe("performance:tier-changed",t=>{let e=t.tier==="excellent"?"high":t.tier==="good"?"medium":"low";e!==this.config.quality&&this.setQuality(e)})}}});var pi,Qa=y(()=>{"use strict";pi=class{static getAnimationDensity(t){switch(t){case"low":return .3;case"medium":return .7;case"high":return 1}}static getUpdateFrequency(t){switch(t){case"low":return 30;case"medium":return 45;case"high":return 60}}static getShaderComplexity(t){switch(t){case"low":return .4;case"medium":return .7;case"high":return 1}}static getParticleMultiplier(t){switch(t){case"low":return .3;case"medium":return .6;case"high":return 1}}static shouldEnableCorridorEffects(t){return t==="medium"||t==="high"}static shouldEnableAdvancedFeatures(t){return t==="high"}static getBlendMode(t){switch(t){case"low":return"normal";case"medium":return"screen";case"high":return"screen"}}static getFrameThrottling(t){switch(t){case"low":return 33;case"medium":return 22;case"high":return 16}}}});var bi,Xa=y(()=>{"use strict";Qa();A();bi=class{constructor(t){this.enabled=!1;this.quality="medium";this.system=t,u?.debug?.log("WebGLGradientAdapter","Created adapter for WebGL gradient system")}setEnabled(t){this.enabled!==t&&(this.enabled=t,t?this._enableSystem():this._disableSystem(),u?.debug?.log("WebGLGradientAdapter",`WebGL gradient ${t?"enabled":"disabled"}`))}setQuality(t){this.quality!==t&&(this.quality=t,this.enabled&&this._applyQualitySettings(),u?.debug?.log("WebGLGradientAdapter",`Quality set to ${t}`))}isEnabled(){return this.enabled}isCapable(){return this._checkWebGLCapability()}getQuality(){return this.quality}getSystemName(){return"WebGL Gradient Background"}_enableSystem(){try{let t=this._mapQualityToIntensity(this.quality);this.system.settingsManager&&(this.system.settingsManager.set("sn-gradient-intensity",t),this.system.settingsManager.set("sn-webgl-enabled","true")),this.system.initialized||this.system.initialize(),this._applyQualitySettings()}catch(t){u?.debug?.warn("WebGLGradientAdapter","Failed to enable system:",t)}}_disableSystem(){try{this.system.settingsManager&&this.system.settingsManager.set("sn-gradient-intensity","disabled"),typeof this.system.disable=="function"?this.system.disable():typeof this.system.destroy=="function"&&this.system.destroy()}catch(t){u?.debug?.warn("WebGLGradientAdapter","Failed to disable system:",t)}}_applyQualitySettings(){try{let t=this.system.settings;if(!t)return;t.flowStrength=this._getFlowStrength(this.quality),t.noiseScale=this._getNoiseScale(this.quality),t.corridorIntensity=this._getColorIntensity(this.quality);let e=pi.getUpdateFrequency(this.quality);this.system.updateFrequency!==void 0&&(this.system.updateFrequency=e),typeof this.system.forceRepaint=="function"&&this.system.forceRepaint(`quality-change-${this.quality}`)}catch(t){u?.debug?.warn("WebGLGradientAdapter","Failed to apply quality settings:",t)}}_mapQualityToIntensity(t){switch(t){case"low":return"minimal";case"medium":return"balanced";case"high":return"intense";default:return"balanced"}}_getFlowStrength(t){switch(t){case"low":return .3;case"medium":return .7;case"high":return 1;default:return .7}}_getAnimationSpeed(t){switch(t){case"low":return .5;case"medium":return .8;case"high":return 1.2;default:return .8}}_getNoiseScale(t){switch(t){case"low":return 1.5;case"medium":return 2;case"high":return 2.8;default:return 2}}_getColorIntensity(t){switch(t){case"low":return .6;case"medium":return .8;case"high":return 1;default:return .8}}_checkWebGLCapability(){try{let t=document.createElement("canvas"),e=t.getContext("webgl2")||t.getContext("webgl");return t.remove(),e!==null}catch{return!1}}}});var Xe,Xn=y(()=>{"use strict";ja();Xa();A();Xe=class{constructor(t){this.initialized=!1;this.webglGradientSystem=null;this.webglGradientAdapter=null;this.controller=new gi(t),u?.debug?.log("WebGLSystemsIntegration","Created WebGL systems integration")}async initialize(){this.initialized||(await this.controller.initialize(),await this._registerWebGLSystems(),this.initialized=!0,u?.debug?.log("WebGLSystemsIntegration","Integration initialized",{controllerState:this.controller.getState(),quality:this.controller.getQuality(),registeredSystems:this._getRegisteredSystemNames()}))}async healthCheck(){if(!this.initialized)return{healthy:!1,details:"Not initialized",system:"WebGLSystemsIntegration"};let t=await this.controller.healthCheck();if(!t.healthy)return{healthy:!1,details:`Controller unhealthy: ${t.details}`,system:"WebGLSystemsIntegration"};let e=[];if(this.webglGradientSystem)try{let i=await this.webglGradientSystem.healthCheck();i.ok||e.push(`WebGL Gradient: ${i.details}`)}catch{e.push("WebGL Gradient: health check failed")}return{healthy:!0,details:e.length>0?`Some system issues: ${e.join(", ")}`:"All WebGL systems healthy",issues:e,system:"WebGLSystemsIntegration"}}destroy(){this.webglGradientSystem&&this.webglGradientSystem.destroy(),this.controller.destroy(),this.initialized=!1,u?.debug?.log("WebGLSystemsIntegration","Integration destroyed")}updateAnimation(t){this.initialized&&this.controller.updateAnimation(t)}getController(){return this.controller}enableWebGL(){this.controller.enable()}disableWebGL(){this.controller.disable()}setQuality(t){this.controller.setQuality(t)}isWebGLActive(){return this.controller.isEnabled()}getWebGLState(){return this.controller.getState()}getQuality(){return this.controller.getQuality()}handlePerformanceQualityAdjustment(t,e){this.controller.suggestQualityAdjustment(t,e)}handlePerformanceDisable(t){this.controller.performanceDisable(t)}handlePerformanceEnable(t){this.controller.performanceEnable(t)}setQualityFromTier(t){this.controller.setQuality(t),u?.debug?.log("WebGLSystemsIntegration",`Quality set from device tier: ${t}`)}async _registerWebGLSystems(){try{await this._registerWebGLGradientSystem(),u?.debug?.log("WebGLSystemsIntegration","All WebGL systems registered successfully")}catch(t){u?.debug?.warn("WebGLSystemsIntegration","Failed to register some WebGL systems:",t)}}async _registerWebGLGradientSystem(){try{let t=globalThis.year3000System;if(!t){u?.debug?.warn("WebGLSystemsIntegration","Year3000System not available");return}let e=["webglGradientBackgroundSystem","flowingLiquidConsciousnessSystem","webglBackgroundSystem"],i=null;for(let n of e)if(t[n]){i=t[n];break}if(!i){u?.debug?.warn("WebGLSystemsIntegration","WebGL gradient system not found in Year3000System");return}this.webglGradientSystem=i,this.webglGradientAdapter=new bi(this.webglGradientSystem),this.controller.registerSystem("webgl-gradient-background",this.webglGradientAdapter,100),u?.debug?.log("WebGLSystemsIntegration","WebGL gradient system registered")}catch(t){u?.debug?.warn("WebGLSystemsIntegration","Failed to register WebGL gradient system:",t)}}_getRegisteredSystemNames(){let t=[];return this.webglGradientAdapter&&t.push("WebGL Gradient Background"),t}}});var Me,Ze,Zn=y(()=>{"use strict";D();Me=class Me{constructor(t,e){this.subsystemMetrics=new Map;this.optimizationStrategies=new Map;this.adaptiveOptimizationEnabled=!1;this.optimizationInterval=null;this.activeIssues=new Map;this.issueHistory=[];this.lastHealthCheck=0;this.healthCheckInterval=null;this.HEALTH_CHECK_INTERVAL=5e3;this.batteryState=null;this.frameTimeHistory=[];this.memoryUsageHistory=[];this.lastOptimizationTime=0;this.optimizationCooldown=5e3;this.PERFORMANCE_THRESHOLDS={frameTime:{warning:16.67,critical:33.33},memoryUsage:{warning:50*1024*1024,critical:100*1024*1024},cpuUsage:{warning:15,critical:30},fps:{warning:50,critical:30}};this.PERFORMANCE_MODES={battery:{name:"battery",qualityLevel:.4,animationQuality:.3,effectQuality:.2,blurQuality:.3,shadowQuality:.2,frameRate:30,optimizationLevel:3},balanced:{name:"balanced",qualityLevel:.8,animationQuality:.8,effectQuality:.7,blurQuality:.8,shadowQuality:.7,frameRate:60,optimizationLevel:1},performance:{name:"performance",qualityLevel:1,animationQuality:1,effectQuality:1,blurQuality:1,shadowQuality:1,frameRate:60,optimizationLevel:0},auto:{name:"auto",qualityLevel:.8,animationQuality:.8,effectQuality:.8,blurQuality:.8,shadowQuality:.8,frameRate:60,optimizationLevel:1}};this.config=t,this.performanceAnalyzer=e,this.eventBus=g,this.initializeDeviceCapabilities(),this.initializeThermalMonitoring(),this.initializeBatteryMonitoring(),this.currentPerformanceMode=this.PERFORMANCE_MODES.auto,this.initializeDefaultStrategies(),this.startHealthMonitoring(),this.subscribeToEvents(),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Initialized with enhanced device capabilities, thermal monitoring, and battery optimization")}static getInstance(t,e){if(!Me.instance){if(!t||!e)throw new Error("UnifiedPerformanceCoordinator requires config and performanceAnalyzer for first initialization");Me.instance=new Me(t,e)}return Me.instance}trackSubsystem(t,e){let i=performance.now(),r={...this.subsystemMetrics.get(t)||{name:t,frameTime:0,memoryUsage:0,cpuUsage:0,fps:60,lastUpdate:i,status:"healthy",issues:[]},...e,lastUpdate:i};r.status=this.calculateHealthStatus(r),this.updateSubsystemIssues(r),this.subsystemMetrics.set(t,r),this.performanceAnalyzer&&(this.performanceAnalyzer.recordMetric(`subsystem_${t}_frame_time`,r.frameTime),this.performanceAnalyzer.recordMetric(`subsystem_${t}_memory`,r.memoryUsage),this.performanceAnalyzer.recordMetric(`subsystem_${t}_fps`,r.fps)),this.adaptiveOptimizationEnabled&&r.status!=="healthy"&&this.checkAndTriggerOptimization(r),this.config.enableDebug&&r.status!=="healthy"&&console.warn(`[UnifiedPerformanceCoordinator] Subsystem ${t} status: ${r.status}`,r)}getSystemHealth(){let t=performance.now(),e=new Map(this.subsystemMetrics),i=0,n=0,r=0;for(let d of e.values())switch(d.status){case"healthy":i++;break;case"warning":n++;break;case"critical":r++;break}let a=e.size,s="healthy";r>0?s="critical":n>0&&(s="warning");let o=this.calculatePerformanceScore(e),l=this.generateRecommendations(e),m={overall:s,totalSubsystems:a,healthySubsystems:i,warningSubsystems:n,criticalSubsystems:r,subsystems:e,recommendations:l,performanceScore:o,lastUpdate:t};return this.lastHealthCheck=t,m}startMonitoring(){this.enableAdaptiveOptimization(),this.healthCheckInterval||this.startHealthMonitoring(),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Monitoring started")}enableAdaptiveOptimization(){this.adaptiveOptimizationEnabled||(this.adaptiveOptimizationEnabled=!0,this.optimizationInterval=setInterval(()=>{this.performOptimizationCheck()},2e3),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Adaptive optimization enabled"))}disableAdaptiveOptimization(){this.adaptiveOptimizationEnabled&&(this.adaptiveOptimizationEnabled=!1,this.optimizationInterval&&(clearInterval(this.optimizationInterval),this.optimizationInterval=null),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Adaptive optimization disabled"))}registerOptimizationStrategy(t){this.optimizationStrategies.set(t.name,t),this.config.enableDebug&&console.log(`[UnifiedPerformanceCoordinator] Registered optimization strategy: ${t.name}`)}triggerOptimization(t){this.activeIssues.set(`${t.subsystem}:${t.type}`,t),this.issueHistory.push(t),this.issueHistory.length>100&&this.issueHistory.shift();let e=Array.from(this.optimizationStrategies.values()).filter(i=>i.subsystem===t.subsystem||i.subsystem==="*").sort((i,n)=>n.priority-i.priority);for(let i of e){let n=this.subsystemMetrics.get(t.subsystem);if(n&&i.condition(n))try{i.action(n),this.config.enableDebug&&console.log(`[UnifiedPerformanceCoordinator] Applied optimization strategy: ${i.name} for ${t.subsystem}`);break}catch(r){console.error(`[UnifiedPerformanceCoordinator] Error applying optimization strategy ${i.name}:`,r)}}}getMetrics(){return{subsystems:new Map(this.subsystemMetrics),issues:new Map(this.activeIssues),strategies:new Map(this.optimizationStrategies),adaptiveOptimizationEnabled:this.adaptiveOptimizationEnabled}}destroy(){this.disableAdaptiveOptimization(),this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.subsystemMetrics.clear(),this.optimizationStrategies.clear(),this.activeIssues.clear(),this.issueHistory=[],Me.instance===this&&(Me.instance=null),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Destroyed")}initializeDefaultStrategies(){this.registerOptimizationStrategy({name:"memory-cleanup",type:"memory_cleanup",priority:100,subsystem:"*",description:"Trigger garbage collection and memory cleanup",condition:t=>t.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.warning,action:t=>{}}),this.registerOptimizationStrategy({name:"fps-optimization",type:"reduce_quality",priority:80,subsystem:"*",description:"Reduce quality settings to improve FPS",condition:t=>t.fps<this.PERFORMANCE_THRESHOLDS.fps.warning,action:t=>{}}),this.registerOptimizationStrategy({name:"cpu-throttling",type:"throttle_updates",priority:70,subsystem:"*",description:"Throttle update frequency to reduce CPU usage",condition:t=>t.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.warning,action:t=>{}})}calculateHealthStatus(t){let e=[];return t.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.critical?e.push("critical-frame-time"):t.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.warning&&e.push("warning-frame-time"),t.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.critical?e.push("critical-memory"):t.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.warning&&e.push("warning-memory"),t.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.critical?e.push("critical-cpu"):t.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.warning&&e.push("warning-cpu"),t.fps<this.PERFORMANCE_THRESHOLDS.fps.critical?e.push("critical-fps"):t.fps<this.PERFORMANCE_THRESHOLDS.fps.warning&&e.push("warning-fps"),t.issues=e,e.some(i=>i.startsWith("critical"))?"critical":e.some(i=>i.startsWith("warning"))?"warning":"healthy"}updateSubsystemIssues(t){let e=`${t.name}:performance`;if(t.status==="healthy"){if(this.activeIssues.has(e)){let i=this.activeIssues.get(e);i.resolved=!0,this.activeIssues.delete(e)}}else{let i={type:"render",severity:t.status==="critical"?"critical":"medium",subsystem:t.name,message:`Performance degradation detected: ${t.issues.join(", ")}`,timestamp:Date.now(),resolved:!1};this.activeIssues.set(e,i)}}checkAndTriggerOptimization(t){let e=`${t.name}:performance`,i=this.activeIssues.get(e);i&&!i.resolved&&this.triggerOptimization(i)}performOptimizationCheck(){let t=performance.now();for(let[e,i]of this.subsystemMetrics)t-i.lastUpdate>1e4||i.status!=="healthy"&&this.checkAndTriggerOptimization(i)}calculatePerformanceScore(t){if(t.size===0)return 100;let e=0;for(let i of t.values()){let n=100;i.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.warning&&(n-=20),i.frameTime>this.PERFORMANCE_THRESHOLDS.frameTime.critical&&(n-=30),i.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.warning&&(n-=15),i.memoryUsage>this.PERFORMANCE_THRESHOLDS.memoryUsage.critical&&(n-=25),i.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.warning&&(n-=10),i.cpuUsage>this.PERFORMANCE_THRESHOLDS.cpuUsage.critical&&(n-=20),i.fps<this.PERFORMANCE_THRESHOLDS.fps.warning&&(n-=15),i.fps<this.PERFORMANCE_THRESHOLDS.fps.critical&&(n-=25),e+=Math.max(0,n)}return Math.round(e/t.size)}generateRecommendations(t){let e=[],i=Array.from(t.values()).flatMap(r=>r.issues),n=new Map;for(let r of i)n.set(r,(n.get(r)||0)+1);for(let[r,a]of n)if(a>=2)switch(r){case"critical-frame-time":case"warning-frame-time":e.push("Consider reducing animation quality or frequency");break;case"critical-memory":case"warning-memory":e.push("Memory cleanup needed - consider reducing cache sizes");break;case"critical-cpu":case"warning-cpu":e.push("High CPU usage detected - consider throttling updates");break;case"critical-fps":case"warning-fps":e.push("Low FPS detected - consider disabling non-essential effects");break}return e.length===0&&e.push("System performance is optimal"),e}startHealthMonitoring(){this.healthCheckInterval=setInterval(()=>{this.getSystemHealth()},this.HEALTH_CHECK_INTERVAL)}subscribeToEvents(){}initializeDeviceCapabilities(){let t=navigator,e=performance.memory,i=document.createElement("canvas"),n=i.getContext("webgl2")||i.getContext("webgl"),r=2048;n&&(r=n.getParameter(n.MAX_TEXTURE_SIZE)||2048);let a=e?Math.round(e.jsHeapSizeLimit/(1024*1024*1024)):4,s="medium";a>=8&&t.hardwareConcurrency>=8&&r>=4096?s="premium":a>=4&&t.hardwareConcurrency>=4?s="high":a>=2&&t.hardwareConcurrency>=2?s="medium":s="low",this.deviceCapabilities={performanceTier:s,memoryGB:a,cpuCores:t.hardwareConcurrency||4,gpuAcceleration:!!n,isMobile:/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(t.userAgent),supportsWebGL:!!n,supportsBackdropFilter:CSS.supports("backdrop-filter","blur(10px)"),maxTextureSize:r,devicePixelRatio:window.devicePixelRatio||1},this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Device capabilities detected:",this.deviceCapabilities)}initializeThermalMonitoring(){this.thermalState={temperature:"normal",throttleLevel:0,cpuUsage:0,gpuUsage:0,memoryUsage:0},setInterval(()=>{this.updateThermalState()},1e4)}async initializeBatteryMonitoring(){try{let t=navigator;if("getBattery"in t){let e=await t.getBattery();this.batteryState={level:e.level,charging:e.charging,chargingTime:e.chargingTime,dischargingTime:e.dischargingTime},e.addEventListener("levelchange",()=>{this.batteryState&&(this.batteryState.level=e.level,this.adjustPerformanceModeForBattery())}),e.addEventListener("chargingchange",()=>{this.batteryState&&(this.batteryState.charging=e.charging,this.adjustPerformanceModeForBattery())}),this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Battery monitoring initialized")}}catch{this.config.enableDebug&&console.log("[UnifiedPerformanceCoordinator] Battery API not available")}}updateThermalState(){let t=this.performanceAnalyzer.getMedianFPS()||60,e=performance.memory,i=e?e.usedJSHeapSize/e.jsHeapSizeLimit:0,n="normal",r=0;t<30||i>.9?(n="critical",r=.8):t<45||i>.7?(n="hot",r=.4):(t<55||i>.5)&&(n="warm",r=.2),this.thermalState={temperature:n,throttleLevel:r,cpuUsage:Math.min(1-t/60,1),gpuUsage:0,memoryUsage:i},n==="critical"&&this.currentPerformanceMode.name!=="battery"?this.setPerformanceMode("battery"):n==="normal"&&this.currentPerformanceMode.name==="battery"&&this.setPerformanceMode("auto")}adjustPerformanceModeForBattery(){this.batteryState&&(!this.batteryState.charging&&this.batteryState.level<.2?this.setPerformanceMode("battery"):this.batteryState.charging&&this.currentPerformanceMode.name==="battery"&&this.setPerformanceMode("auto"))}setPerformanceMode(t){let e=this.PERFORMANCE_MODES[t];e&&(this.currentPerformanceMode=e,this.config.enableDebug&&console.log(`[UnifiedPerformanceCoordinator] Performance mode changed to: ${t}`))}getDeviceCapabilities(){return{...this.deviceCapabilities}}getThermalState(){return{...this.thermalState}}getBatteryState(){return this.batteryState?{...this.batteryState}:null}getCurrentPerformanceMode(){return{...this.currentPerformanceMode}}};Me.instance=null;Ze=Me});var He,we,yi=y(()=>{"use strict";He=class He{constructor(t={},e){this.cssVariableManager=null;this.optimizationLevel="none";this.disabledFeatures=new Set;this.config={budgets:{animationFrame:16.67,cssVariableUpdate:2,domObservation:5,audioAnalysis:10,visualEffects:8,userInteraction:100},autoOptimize:{enabled:!0,violationThreshold:5,recoveryThreshold:80},enableDebug:!1,...t},this.performanceAnalyzer=e,this.setupBudgetMonitoring()}static getInstance(t,e){return!He.instance&&e&&(He.instance=new He(t,e)),He.instance}registerUnifiedCSSVariableManager(t){this.cssVariableManager=t}setupBudgetMonitoring(){this.config.autoOptimize.enabled&&setInterval(()=>{this.checkBudgets()},5e3)}checkBudgets(){this.performanceAnalyzer.calculateHealthScore()>=this.config.autoOptimize.recoveryThreshold&&this.recoverOptimizations()}optimizeOperation(t){if(!this.disabledFeatures.has(t)){switch(t){case"cssVariableUpdate":this.optimizeCSSVariableUpdates();break;case"domObservation":this.optimizeDOMObservation();break;case"visualEffects":this.optimizeVisualEffects();break;case"audioAnalysis":this.optimizeAudioAnalysis();break}this.disabledFeatures.add(t),this.config.enableDebug&&console.log(`\u{1F3AF} [PerformanceBudgetManager] Optimized ${t} due to budget violations`)}}optimizeCSSVariableUpdates(){this.cssVariableManager&&this.cssVariableManager.updateConfig({batchIntervalMs:32,maxBatchSize:25})}optimizeDOMObservation(){document.dispatchEvent(new CustomEvent("year3000:optimize-dom-observation",{detail:{level:this.optimizationLevel}}))}optimizeVisualEffects(){document.dispatchEvent(new CustomEvent("year3000:optimize-visual-effects",{detail:{level:this.optimizationLevel}}))}optimizeAudioAnalysis(){document.dispatchEvent(new CustomEvent("year3000:optimize-audio-analysis",{detail:{level:this.optimizationLevel}}))}escalateOptimization(){this.optimizationLevel==="none"?this.optimizationLevel="conservative":this.optimizationLevel==="conservative"&&(this.optimizationLevel="aggressive"),this.config.enableDebug&&console.log(`\u{1F3AF} [PerformanceBudgetManager] Escalated to ${this.optimizationLevel} optimization`)}recoverOptimizations(){this.optimizationLevel!=="none"&&(this.disabledFeatures.clear(),this.cssVariableManager&&this.cssVariableManager.updateConfig({batchIntervalMs:16,maxBatchSize:50}),document.dispatchEvent(new CustomEvent("year3000:recover-optimizations",{detail:{previousLevel:this.optimizationLevel}})),this.optimizationLevel="none",this.config.enableDebug&&console.log("\u{1F3AF} [PerformanceBudgetManager] Recovered from optimizations"))}getOptimizationStatus(){return{level:this.optimizationLevel,disabledFeatures:Array.from(this.disabledFeatures),budgetViolations:[],healthScore:this.performanceAnalyzer.calculateHealthScore()}}manualOptimize(t){this.optimizeOperation(t)}manualRecover(){this.recoverOptimizations()}updateBudgets(t){this.config.budgets={...this.config.budgets,...t};for(let[e,i]of Object.entries(t))this.performanceAnalyzer.updateBudget(e,i)}destroy(){this.disabledFeatures.clear(),this.cssVariableManager=null,He.instance=null}};He.instance=null;we=He});var wt,Eh,Za=y(()=>{"use strict";D();A();K();wt=class{constructor(t=I,e=null){this.initialized=!1;this.transitionTimer=0;this.lastTransitionStartTime=0;this.transitionFromAccent="";this.transitionToAccent="";this.settingsManager=null;this.utils=t,this.settingsManager=e,this.consciousnessState={consciousnessResonance:.7,multidimensionalAwareness:.8,transcendenceLevel:.6,dominantEmotionalTemperature:6500,emotionalDepth:.7,emotionalComplexity:.5,totalIntensity:.5,activeLayerCount:3,volumetricDepth:.4,cinematicPerspective:.6,holographicInfluence:.2,dataStreamIntensity:.3,interferencePatterns:.1,projectionStability:.9,temporalMemoryDepth:.5,consciousnessEvolution:0,futureProjection:.2,catppuccinPreservationLevel:.8,currentPalette:[],paletteEvolution:{currentGeneration:0,totalEvolutions:0,evolutionVelocity:.1,adaptationRate:.3,previousGenerations:[],futureProjections:[],temporalPatterns:[],consciousnessGrowth:0,transcendenceProgress:0,cosmicAlignment:.5},atmosphericDensity:.3,cosmicResonance:.5,quantumFluctuation:.2,lastBlendTime:Date.now(),consciousnessFrameRate:60,systemHealthConsciousness:1},this.dynamicColorState={currentAccentHex:"#4b19a1",currentAccentRgb:"75,25,161",baseBackgroundHex:"#0d1117",baseBackgroundRgb:"13,17,23",lastUpdateTime:0,musicEnergy:.5,transitionInProgress:!1},this.integrationConfig={accentUpdateEnabled:!0,baseTransformationEnabled:!0,consciousnessIntegrationEnabled:!0,smoothTransitionDuration:800,energyResponseMultiplier:1.2}}async initialize(){if(!this.initialized)try{this.setupUnifiedEventSubscriptions(),this.setupSettingsListeners(),this.initializeCurrentDynamicState();let t=this.checkDynamicAccentEnabled();this.integrationConfig.accentUpdateEnabled=t,this.initialized=!0,u?.debug?.log("VisualEffectsCoordinator","\u{1F3A8} Unified consciousness coordinator initialized successfully",{consciousnessLevel:this.consciousnessState.consciousnessResonance,dynamicAccentEnabled:t,accentHex:this.dynamicColorState.currentAccentHex})}catch(t){throw u?.debug?.error("VisualEffectsCoordinator","Failed to initialize:",t),t}}async healthCheck(){let t=[];return this.initialized||t.push("Coordinator not initialized"),this.dynamicColorState.transitionInProgress&&Date.now()-this.lastTransitionStartTime>1e4&&t.push("Dynamic color transition appears stuck"),this.consciousnessState.systemHealthConsciousness<.5&&t.push(`Low consciousness health: ${(this.consciousnessState.systemHealthConsciousness*100).toFixed(1)}%`),{healthy:t.length===0,ok:t.length===0,details:`Unified consciousness coordination - consciousness level: ${this.consciousnessState.consciousnessResonance.toFixed(2)}, dynamic accent: ${this.integrationConfig.accentUpdateEnabled}`,issues:t,system:"VisualEffectsCoordinator"}}updateAnimation(t){this.consciousnessState.consciousnessFrameRate=1e3/t,this.consciousnessState.consciousnessEvolution+=t*1e-4,this.consciousnessState.consciousnessEvolution>1&&(this.consciousnessState.consciousnessEvolution=0),this.consciousnessState.quantumFluctuation=.2+Math.sin(Date.now()*.002)*.1}destroy(){this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=0),g.unsubscribeAll("VisualEffectsCoordinator"),this.dynamicColorState.transitionInProgress=!1,this.initialized=!1,u?.debug?.log("VisualEffectsCoordinator","Unified consciousness coordinator destroyed")}setupUnifiedEventSubscriptions(){g.subscribe("colors:harmonized",t=>{this.handleUnifiedColorUpdate(t)},"VisualEffectsCoordinator"),g.subscribe("colors:extracted",t=>{t.rawColors&&this.handleExtractedColors(t.rawColors)},"VisualEffectsCoordinator"),g.subscribe("colors:applied",t=>{t.cssVariables&&this.integrationConfig.accentUpdateEnabled&&this.handleCSSVariablesApplied(t.cssVariables,t.accentHex,t.accentRgb)},"VisualEffectsCoordinator"),g.subscribe("settings:changed",t=>{this.handleSettingsChange(t)},"VisualEffectsCoordinator"),typeof document<"u"&&document.addEventListener("music-state-change",t=>{let e=t;e.detail&&this.handleMusicStateChange(e.detail)}),u?.debug?.log("VisualEffectsCoordinator","Unified event subscriptions setup complete")}handleUnifiedColorUpdate(t){let{processedColors:e,accentHex:i,accentRgb:n,coordinationMetrics:r}=t,a=r?.emotionalState||"neutral",s=r?.musicInfluenceStrength||.5;this.updateConsciousnessFromMusic(a,s),this.updatePaletteFromUnifiedColors(e,i,n),this.integrationConfig.accentUpdateEnabled&&i&&i!==this.dynamicColorState.currentAccentHex&&this.scheduleSmoothAccentTransition(i),this.publishConsciousnessUpdate()}handleExtractedColors(t){if(this.integrationConfig.accentUpdateEnabled)try{let e=this.selectBestAccentColor(t);e&&e!==this.dynamicColorState.currentAccentHex&&this.scheduleSmoothAccentTransition(e),u?.debug?.log("VisualEffectsCoordinator","Processed extracted colors:",{input:Object.keys(t),selectedAccent:e})}catch(e){u?.debug?.error("VisualEffectsCoordinator","Error handling extracted colors:",e)}}handleCSSVariablesApplied(t,e,i){if(this.integrationConfig.accentUpdateEnabled)try{e&&e!==this.dynamicColorState.currentAccentHex&&(this.dynamicColorState.currentAccentHex=e,this.dynamicColorState.currentAccentRgb=i,this.dynamicColorState.lastUpdateTime=Date.now());let n={},r=t["--sn-accent-hex"]||t["--spice-accent"]||e,a=t["--sn-accent-rgb"]||t["--spice-rgb-accent"]||i;if(r&&a&&(n["--sn-dynamic-accent-hex"]=r,n["--sn-dynamic-accent-rgb"]=a,n["--sn-dynamic-primary-hex"]=r,n["--sn-dynamic-primary-rgb"]=a,typeof document<"u")){let s=document.documentElement;Object.entries(n).forEach(([o,l])=>{s.style.setProperty(o,l)})}u?.debug?.log("VisualEffectsCoordinator","Processed colors:applied event:",{accentHex:r,accentRgb:a,variablesProcessed:Object.keys(t).length,enhancedVariables:Object.keys(n).length})}catch(n){u?.debug?.error("VisualEffectsCoordinator","Error handling CSS variables applied:",n)}}handleMusicStateChange(t){t.energy!==void 0&&(this.dynamicColorState.musicEnergy=t.energy,this.integrationConfig.consciousnessIntegrationEnabled&&this.updateConsciousnessWithMusicEnergy(t.energy))}handleSettingsChange(t){if(["catppuccin-flavor","catppuccin-accentColor","sn-dynamic-color-intensity"].includes(t.settingKey)&&(this.consciousnessState.consciousnessEvolution=0,u?.debug?.log("VisualEffectsCoordinator","Consciousness state reset due to settings change:",t.settingKey)),t.settingKey==="catppuccin-accentColor"){let e=String(t.value)==="dynamic";this.integrationConfig.accentUpdateEnabled=e,u?.debug?.log("VisualEffectsCoordinator",`Accent setting changed to: ${t.value}, Dynamic enabled: ${e}`)}}updateConsciousnessFromMusic(t,e){t&&(this.consciousnessState.consciousnessResonance=(t.valence+t.intensity)*.5,this.consciousnessState.dominantEmotionalTemperature=4e3+t.valence*4e3,this.consciousnessState.totalIntensity=t.intensity||.5,this.consciousnessState.multidimensionalAwareness=Math.min(1,(t.valence+t.arousal)*.6),this.consciousnessState.emotionalDepth=Math.abs(t.valence-.5)*2,this.consciousnessState.dataStreamIntensity=t.intensity*.7),e&&(this.consciousnessState.holographicInfluence=Math.min(.8,e.strength*.6),e.strength>.7&&this.updateTemporalMemory(e),this.consciousnessState.volumetricDepth=Math.min(1,e.strength*.8))}updatePaletteFromUnifiedColors(t,e,i){let n=[{hex:e,rgb:this.hexToRgb(e)},{hex:t.primary||e,rgb:this.hexToRgb(t.primary||e)},{hex:t.secondary||e,rgb:this.hexToRgb(t.secondary||e)}].filter(r=>r.hex);this.updatePaletteFromHarmony(n)}updatePaletteFromHarmony(t){this.consciousnessState.currentPalette.length>0&&(this.consciousnessState.paletteEvolution.previousGenerations.push([...this.consciousnessState.currentPalette]),this.consciousnessState.paletteEvolution.previousGenerations.length>5&&this.consciousnessState.paletteEvolution.previousGenerations.shift()),this.consciousnessState.currentPalette=t.map((e,i)=>({rgb:e.rgb||{r:e.r||0,g:e.g||0,b:e.b||0},oklab:e.oklab,hsl:e.hsl,xyz:e.xyz,consciousnessLevel:this.consciousnessState.consciousnessResonance,emotionalResonance:this.consciousnessState.emotionalDepth,transcendenceIndex:this.consciousnessState.transcendenceLevel,temporalStability:Math.max(.1,1-i*.1),evolutionRate:this.consciousnessState.paletteEvolution.evolutionVelocity,memoryImprint:this.consciousnessState.temporalMemoryDepth,volumetricPresence:this.consciousnessState.volumetricDepth*(1-i*.15),holographicReflectance:this.consciousnessState.holographicInfluence,cosmicFrequency:432+i*111,colorSpace:e.oklab?"oklab":"rgb",generationMethod:"harmony",timestamp:Date.now()})),this.consciousnessState.activeLayerCount=t.length,this.consciousnessState.lastBlendTime=Date.now(),this.consciousnessState.paletteEvolution.currentGeneration++,this.consciousnessState.paletteEvolution.totalEvolutions++}updateTemporalMemory(t){let i={patternId:`pattern-${Date.now()}`,frequency:t.tempo||120,strength:t.strength,colorSequence:[...this.consciousnessState.currentPalette],musicalCorrelation:t.strength,consciousnessSignature:this.consciousnessState.consciousnessResonance};this.consciousnessState.paletteEvolution.temporalPatterns.push(i),this.consciousnessState.paletteEvolution.temporalPatterns.length>10&&this.consciousnessState.paletteEvolution.temporalPatterns.shift(),this.consciousnessState.temporalMemoryDepth=Math.min(1,this.consciousnessState.temporalMemoryDepth+.1)}publishConsciousnessUpdate(){g.emit("consciousness:updated",{type:"colorConsciousnessUpdate",payload:{palette:this.consciousnessState.currentPalette,consciousnessLevel:this.consciousnessState.consciousnessResonance,emotionalTemperature:this.consciousnessState.dominantEmotionalTemperature,multidimensionalAwareness:this.consciousnessState.multidimensionalAwareness,transcendenceLevel:this.consciousnessState.transcendenceLevel,volumetricDepth:this.consciousnessState.volumetricDepth,dataStreamIntensity:this.consciousnessState.dataStreamIntensity,temporalMemoryDepth:this.consciousnessState.temporalMemoryDepth,cosmicResonance:this.consciousnessState.cosmicResonance,paletteGeneration:this.consciousnessState.paletteEvolution.currentGeneration,temporalPatternCount:this.consciousnessState.paletteEvolution.temporalPatterns.length,fullConsciousnessState:this.consciousnessState}}),this.consciousnessState.dataStreamIntensity>.5&&g.emit("consciousness:holographic-stream",{type:"holographicStreamUpdate",payload:{intensity:this.consciousnessState.dataStreamIntensity,interferencePatterns:this.consciousnessState.interferencePatterns,projectionStability:this.consciousnessState.projectionStability}}),this.consciousnessState.paletteEvolution.temporalPatterns.length>3&&g.emit("consciousness:temporal-pattern",{type:"temporalPatternDetected",payload:{patterns:this.consciousnessState.paletteEvolution.temporalPatterns,memoryDepth:this.consciousnessState.temporalMemoryDepth}}),this.consciousnessState.transcendenceLevel>.8&&g.emit("consciousness:transcendence-high",{type:"transcendenceLevelHigh",payload:{level:this.consciousnessState.transcendenceLevel,cosmicAlignment:this.consciousnessState.paletteEvolution.cosmicAlignment}})}scheduleSmoothAccentTransition(t){if(this.dynamicColorState.transitionInProgress){this.transitionToAccent=t;return}this.transitionFromAccent=this.dynamicColorState.currentAccentHex,this.transitionToAccent=t,this.dynamicColorState.transitionInProgress=!0,this.lastTransitionStartTime=Date.now(),this.animateAccentTransition(),u?.debug?.log("VisualEffectsCoordinator",`Accent transition scheduled: ${this.transitionFromAccent} \u2192 ${t}`)}animateAccentTransition(){let t=()=>{if(!this.dynamicColorState.transitionInProgress)return;let e=Date.now()-this.lastTransitionStartTime,i=Math.min(e/this.integrationConfig.smoothTransitionDuration,1),n=1-Math.pow(1-i,3),r=this.interpolateColors(this.transitionFromAccent,this.transitionToAccent,n);if(r&&this.applyDynamicAccent(r),i>=1){this.dynamicColorState.transitionInProgress=!1,this.dynamicColorState.currentAccentHex=this.transitionToAccent,this.dynamicColorState.lastUpdateTime=Date.now();let a=this.utils.hexToRgb(this.transitionToAccent);a&&(this.dynamicColorState.currentAccentRgb=`${a.r},${a.g},${a.b}`),u?.debug?.log("VisualEffectsCoordinator",`Accent transition complete: ${this.transitionToAccent}`)}else requestAnimationFrame(t)};requestAnimationFrame(t)}applyDynamicAccent(t){if(typeof document>"u")return;let e=document.documentElement,i=this.utils.hexToRgb(t);if(!i)return;let n=`${i.r},${i.g},${i.b}`;e.style.setProperty("--sn-dynamic-accent-hex",t),e.style.setProperty("--sn-dynamic-accent-rgb",n),e.style.setProperty("--sn-dynamic-primary-hex",t),e.style.setProperty("--sn-dynamic-primary-rgb",n),e.style.setProperty("--spice-accent",t),e.style.setProperty("--spice-button",t),e.style.setProperty("--spice-button-active",t),e.style.setProperty("--spice-rgb-accent",n),e.style.setProperty("--spice-rgb-button",n),e.style.setProperty("--sn-color-extracted-primary-rgb",n),e.style.setProperty("--sn-color-extracted-vibrant-rgb",n),e.style.setProperty("--sn-color-extracted-dominant-rgb",n),this.integrationConfig.consciousnessIntegrationEnabled&&this.updateConsciousnessWithAccent(t,n)}updateConsciousnessWithAccent(t,e){if(typeof document>"u")return;let i=document.documentElement;i.style.setProperty("--organic-holographic-rgb",e),i.style.setProperty("--holographic-scanline-rgb",e),i.style.setProperty("--consciousness-intensity",`calc(0.5 + var(--musical-sync-intensity) * ${this.integrationConfig.energyResponseMultiplier})`)}updateConsciousnessWithMusicEnergy(t){if(typeof document>"u")return;let e=document.documentElement,i=t*this.integrationConfig.energyResponseMultiplier;e.style.setProperty("--musical-sync-intensity",i.toString()),e.style.setProperty("--holographic-music-flicker-intensity",i.toString());let r=Math.max(.1,Math.min(1,.5+i*.3));e.style.setProperty("--consciousness-intensity",r.toString())}hexToRgb(t){t=t.replace("#","");let e=parseInt(t.substring(0,2),16),i=parseInt(t.substring(2,4),16),n=parseInt(t.substring(4,6),16);return{r:e,g:i,b:n}}interpolateColors(t,e,i){let n=this.utils.hexToRgb(t),r=this.utils.hexToRgb(e);if(!n||!r)return null;let a=Math.round(n.r+(r.r-n.r)*i),s=Math.round(n.g+(r.g-n.g)*i),o=Math.round(n.b+(r.b-n.b)*i);return this.utils.rgbToHex(a,s,o)}selectBestAccentColor(t){let e=["VIBRANT_NON_ALARMING","VIBRANT","LIGHT_VIBRANT","PROMINENT","PRIMARY","DARK_VIBRANT"];for(let i of e){let n=t[i];if(n&&this.utils.hexToRgb(n))return n}return null}checkDynamicAccentEnabled(){try{if(!this.settingsManager)return!1;let t=this.settingsManager.get("catppuccin-accentColor");return String(t)==="dynamic"}catch(t){return u?.debug?.error("VisualEffectsCoordinator","Error checking dynamic accent setting:",t),!1}}initializeCurrentDynamicState(){if(typeof document>"u")return;let t=document.documentElement,e=getComputedStyle(t),i=e.getPropertyValue("--sn-dynamic-accent-hex").trim()||e.getPropertyValue("--sn-cosmic-accent-hex").trim()||e.getPropertyValue("--spice-accent").trim();if(i){this.dynamicColorState.currentAccentHex=i;let n=this.utils.hexToRgb(i);n&&(this.dynamicColorState.currentAccentRgb=`${n.r},${n.g},${n.b}`)}this.dynamicColorState.lastUpdateTime=Date.now()}setupSettingsListeners(){typeof document>"u"||document.addEventListener("year3000SystemSettingsChanged",t=>{let e=t,{key:i,value:n}=e.detail||{};if(i==="catppuccin-accentColor"){let r=String(n)==="dynamic";this.integrationConfig.accentUpdateEnabled=r,u?.debug?.log("VisualEffectsCoordinator",`Accent setting changed to: ${n}, Coordinator active: ${this.initialized}`)}})}getConsciousnessState(){return{...this.consciousnessState}}setConsciousness(t,e=6500){this.consciousnessState.consciousnessResonance=Math.max(0,Math.min(1,t)),this.consciousnessState.dominantEmotionalTemperature=Math.max(1e3,Math.min(1e4,e)),this.consciousnessState.transcendenceLevel=Math.min(1,t*1.2),this.consciousnessState.multidimensionalAwareness=t*.9,this.publishConsciousnessUpdate()}getTranscendentPalette(){return[...this.consciousnessState.currentPalette]}getTemporalPatterns(){return[...this.consciousnessState.paletteEvolution.temporalPatterns]}getDynamicColorState(){return{...this.dynamicColorState}}updateConfig(t){this.integrationConfig={...this.integrationConfig,...t},u?.debug?.log("VisualEffectsCoordinator","Configuration updated:",t)}setTranscendence(t){this.consciousnessState.transcendenceLevel=Math.max(0,Math.min(1,t)),this.consciousnessState.cosmicResonance=t*.8,this.consciousnessState.paletteEvolution.transcendenceProgress=t,this.publishConsciousnessUpdate()}setDataStreamIntensity(t){this.consciousnessState.dataStreamIntensity=Math.max(0,Math.min(1,t)),this.publishConsciousnessUpdate()}},Eh=new wt});var fi,Ja=y(()=>{"use strict";si();U();A();xe();ne();fi=class{constructor(t=w.enableDebug){this.coordinationCache=new Map;this.cacheMaxSize=20;this.cacheTimeoutMs=3e5;this.enableDebug=t,this.oklabProcessor=new M(t),this.emotionalMapper=new J(t),this.genreManager=new Be({YEAR3000_CONFIG:w}),this.enableDebug&&u?.debug?.log("MusicalOKLABCoordinator","Unified music-to-OKLAB coordinator initialized")}async coordinateMusicalColors(t,e={}){let i=performance.now(),n=this.generateCacheKey(t),r=this.coordinationCache.get(n);if(r)return this.enableDebug&&u?.debug?.log("MusicalOKLABCoordinator","Using cached coordination result",{cacheKey:n}),r;try{let a=this.determineCoordinationStrategy(t,e),s=await this.getOptimalOKLABPreset(t,a,e),o=await this.processColorsWithMusicalContext(t.rawColors,t.musicData,s),l=this.emotionalMapper.mapMusicToEmotionalTemperature(t.musicData),m=this.genreManager.detectGenre(t.musicData),d=this.genreManager.getColorCharacteristicsForGenre(m),h=this.calculateMusicInfluenceStrength(t.musicData,l),p=this.generateUnifiedCSSVariables(o,l,d,s),{accentHex:b,accentRgb:v}=this.selectOptimalAccentColor(o),C=performance.now()-i,P={enhancedColors:Object.fromEntries(Object.entries(o).map(([E,L])=>[E,L.enhancedHex])),accentHex:b,accentRgb:v,oklabPreset:s,oklabResults:o,detectedGenre:m,emotionalResult:l,genreCharacteristics:d,processingTime:C,musicInfluenceStrength:h,coordinationStrategy:a,cssVariables:p};return this.cacheResult(n,P),this.enableDebug&&u?.debug?.log("MusicalOKLABCoordinator","Musical OKLAB coordination completed",{genre:m,emotion:l.primaryEmotion,strategy:a,preset:s.name,processingTime:C,colorCount:Object.keys(o).length}),P}catch(a){return this.enableDebug&&u?.debug?.error("MusicalOKLABCoordinator","Musical coordination failed:",a),this.createFallbackResult(t,performance.now()-i)}}determineCoordinationStrategy(t,e){let{musicData:i}=t;if(!i||typeof i.energy!="number"||typeof i.valence!="number")return"fallback";if(e.preferGenreOverEmotion===!0)return"genre-primary";if(e.preferGenreOverEmotion===!1)return"emotion-primary";let n=Math.abs(i.energy-.5)*2,r=Math.abs(i.valence-.5)*2;return(n+r)/2>.6?"emotion-primary":this.genreManager.detectGenre(i)!=="default"?"genre-primary":"balanced"}async getOptimalOKLABPreset(t,e,i){let{musicData:n}=t;try{let r;switch(e){case"genre-primary":r=this.genreManager.getOKLABPresetForTrack(n);break;case"emotion-primary":r=this.emotionalMapper.mapMusicToEmotionalTemperature(n).oklabPreset;break;case"balanced":let s=this.genreManager.getOKLABPresetForTrack(n),o=this.emotionalMapper.mapMusicToEmotionalTemperature(n);r=this.blendPresets(s,o.oklabPreset,i.intensityMultiplier||1);break;default:r=M.getPreset("STANDARD")}return r}catch(r){return this.enableDebug&&u?.debug?.warn("MusicalOKLABCoordinator","Failed to get optimal preset, using STANDARD:",r),M.getPreset("STANDARD")}}blendPresets(t,e,i){let n=(t.chromaBoost+e.chromaBoost)/2*i,r=(t.lightnessBoost+e.lightnessBoost)/2,a=(t.shadowReduction+e.shadowReduction)/2,s=(t.vibrantThreshold+e.vibrantThreshold)/2;return M.createCustomPreset("blended-genre-emotion",`Blended ${t.name} + ${e.name}`,r,n,a,s)}async processColorsWithMusicalContext(t,e,i){let n={};for(let[r,a]of Object.entries(t))if(!(!a||typeof a!="string"||!a.startsWith("#")))try{let s=this.oklabProcessor.processColor(a,i);n[r]=s}catch(s){this.enableDebug&&u?.debug?.warn("MusicalOKLABCoordinator",`Failed to process color ${r}:`,s)}return n}calculateMusicInfluenceStrength(t,e){let i=t.energy||.5,n=Math.abs((t.valence||.5)-.5)*2,r=e.intensity,a=(i+n+r)/3,s=1;return t.tempo&&t.tempo>0&&(s+=.1),t.danceability&&t.danceability>.7&&(s+=.1),t.genre&&t.genre!=="default"&&(s+=.1),Math.min(1,a*s)}generateUnifiedCSSVariables(t,e,i,n){let r={};return Object.entries(t).forEach(([a,s])=>{r[`--sn-${a.toLowerCase()}-enhanced`]=s.enhancedHex,r[`--sn-${a.toLowerCase()}-oklab-l`]=s.oklabEnhanced.L.toFixed(3),r[`--sn-${a.toLowerCase()}-oklab-a`]=s.oklabEnhanced.a.toFixed(3),r[`--sn-${a.toLowerCase()}-oklab-b`]=s.oklabEnhanced.b.toFixed(3),r[`--sn-${a.toLowerCase()}-oklch-c`]=s.oklchEnhanced.C.toFixed(3),r[`--sn-${a.toLowerCase()}-oklch-h`]=s.oklchEnhanced.H.toFixed(1),r[`--sn-${a.toLowerCase()}-shadow`]=s.shadowHex}),Object.entries(e.cssVariables).forEach(([a,s])=>{r[a]=s}),r["--sn-detected-genre"]=i?i.vibrancyLevel:"standard",r["--sn-color-temperature"]=i?i.colorTemperature:"neutral",r["--sn-emotional-range"]=i?i.emotionalRange:"moderate",r["--sn-oklab-preset-name"]=n.name,r["--sn-oklab-chroma-boost"]=n.chromaBoost.toString(),r["--sn-oklab-lightness-boost"]=n.lightnessBoost.toString(),r["--sn-musical-oklab-coordination"]="enabled",r["--sn-color-processing-mode"]="unified-musical-oklab",r}selectOptimalAccentColor(t){let e=["VIBRANT","PROMINENT","DARK_VIBRANT","LIGHT_VIBRANT"];for(let n of e)if(t[n]){let r=t[n];return{accentHex:r.enhancedHex,accentRgb:`${r.enhancedRgb.r},${r.enhancedRgb.g},${r.enhancedRgb.b}`}}let i=Object.values(t)[0];return i?{accentHex:i.enhancedHex,accentRgb:`${i.enhancedRgb.r},${i.enhancedRgb.g},${i.enhancedRgb.b}`}:{accentHex:"#cba6f7",accentRgb:"203,166,247"}}createFallbackResult(t,e){let i=M.getPreset("STANDARD");return{enhancedColors:t.rawColors,accentHex:"#cba6f7",accentRgb:"203,166,247",oklabPreset:i,oklabResults:{},detectedGenre:"default",emotionalResult:{primaryEmotion:"calm",intensity:.5,temperature:3500,blendRatio:1,cssClass:"organic-emotion-calm",cssVariables:{},oklabPreset:i},genreCharacteristics:{vibrancyLevel:"standard",emotionalRange:"moderate",colorTemperature:"neutral"},processingTime:e,musicInfluenceStrength:.5,coordinationStrategy:"fallback",cssVariables:{"--sn-musical-oklab-coordination":"fallback","--sn-oklab-preset-name":"STANDARD"}}}generateCacheKey(t){return`${t.trackUri}-${t.timestamp}-${JSON.stringify(t.musicData)}`}cacheResult(t,e){if(this.coordinationCache.size>=this.cacheMaxSize){let i=this.coordinationCache.keys().next().value;i&&this.coordinationCache.delete(i)}this.coordinationCache.set(t,e),setTimeout(()=>{this.coordinationCache.delete(t)},this.cacheTimeoutMs)}convertToColorResult(t,e){return{processedColors:{...t.enhancedColors,...t.cssVariables},accentHex:t.accentHex,accentRgb:t.accentRgb,metadata:{strategy:"musical-oklab-coordinator",processingTime:t.processingTime,detectedGenre:t.detectedGenre,emotionalState:t.emotionalResult.primaryEmotion,oklabPreset:t.oklabPreset.name,coordinationStrategy:t.coordinationStrategy,musicInfluenceStrength:t.musicInfluenceStrength},context:{rawColors:e.rawColors,trackUri:e.trackUri,timestamp:e.timestamp,harmonicMode:e.harmonicMode||"musical-oklab",musicData:e.musicData}}}clearCache(){this.coordinationCache.clear(),this.enableDebug&&u?.debug?.log("MusicalOKLABCoordinator","Coordination cache cleared")}getCoordinationMetrics(){return{cacheSize:this.coordinationCache.size,maxCacheSize:this.cacheMaxSize,cacheTimeoutMs:this.cacheTimeoutMs,enableDebug:this.enableDebug}}}});var Si,es=y(()=>{"use strict";A();Si=class{constructor(){this.strategiesMap=new Map;this.metrics={totalStrategies:0,healthyStrategies:0,averageResponseTime:0,totalUsageCount:0,cacheHitRate:0,memoryUsage:0};this.healthCheckInterval=null;this.HEALTH_CHECK_INTERVAL_MS=3e4;this.startHealthMonitoring(),u?.debug?.log("BackgroundStrategyRegistry","Strategy registry initialized")}register(t){let e=t.getStrategyName();this.strategiesMap.has(e)&&u?.debug?.warn("BackgroundStrategyRegistry",`Strategy ${e} is already registered, replacing...`);try{let i={strategy:t,registrationTime:Date.now(),lastUsed:0,usageCount:0,errorCount:0,averageProcessingTime:0,isHealthy:!0,metadata:this.inferStrategyMetadata(t)};this.strategiesMap.set(e,i),this.updateMetrics(),u?.debug?.log("BackgroundStrategyRegistry",`Registered strategy: ${e}`,{category:i.metadata.category,priority:i.metadata.priority,memoryImpact:i.metadata.memoryImpact})}catch(i){u?.debug?.error("BackgroundStrategyRegistry",`Failed to register strategy ${e}:`,i)}}selectStrategy(t){let e=Array.from(this.strategiesMap.values()).filter(n=>n.isHealthy).sort((n,r)=>this.scoreStrategy(r,t)-this.scoreStrategy(n,t));if(e.length===0)return u?.debug?.warn("BackgroundStrategyRegistry","No healthy strategies available"),null;let i=e[0];return i?(this.recordStrategyUsage(i.strategy.getStrategyName()),u?.debug?.log("BackgroundStrategyRegistry",`Selected strategy: ${i.strategy.getStrategyName()}`,{score:this.scoreStrategy(i,t),totalAvailable:e.length}),i.strategy):(u?.debug?.warn("BackgroundStrategyRegistry","No strategies available after filtering"),null)}getStrategies(){return Array.from(this.strategiesMap.values()).filter(t=>t.isHealthy).map(t=>t.strategy)}getStrategy(t){let e=this.strategiesMap.get(t);return e&&e.isHealthy?e.strategy:null}selectMultipleStrategies(t,e=4){let i=Array.from(this.strategiesMap.values()).filter(r=>r.isHealthy).map(r=>({registration:r,score:this.scoreStrategy(r,t)})).sort((r,a)=>a.score-r.score).slice(0,e);i.forEach(r=>{this.recordStrategyUsage(r.registration.strategy.getStrategyName())});let n=i.map(r=>r.registration.strategy);return u?.debug?.log("BackgroundStrategyRegistry",`Selected ${n.length} strategies`,{strategies:n.map(r=>r.getStrategyName()),scores:i.map(r=>r.score)}),n}scoreStrategy(t,e){let i=0;switch(i+=t.metadata.priority*10,e.performance){case"high":t.metadata.memoryImpact==="low"&&(i+=20),t.averageProcessingTime<10&&(i+=15);break;case"medium":t.metadata.memoryImpact!=="high"&&(i+=10),t.averageProcessingTime<20&&(i+=10);break;case"low":break}switch(e.quality){case"premium":t.metadata.category==="enhancement"&&(i+=15),t.metadata.tags.includes("webgl")&&(i+=10);break;case"enhanced":t.metadata.category!=="effects"&&(i+=10);break;case"basic":t.metadata.category==="foundation"&&(i+=15);break}if(e.deviceCapabilities&&(e.deviceCapabilities.hasWebGL&&t.metadata.tags.includes("webgl")&&(i+=15),e.deviceCapabilities.isMobile&&t.metadata.memoryImpact==="low"&&(i+=10),e.deviceCapabilities.memoryMB&&e.deviceCapabilities.memoryMB<4e3&&t.metadata.memoryImpact==="high"&&(i-=20)),e.userPreferences&&(e.userPreferences.enableAdvancedBlending&&t.metadata.tags.includes("advanced-blending")&&(i+=12),e.userPreferences.harmonicMode)){let a=e.userPreferences.harmonicMode;t.metadata.tags.includes(a)&&(i+=8)}let n=t.usageCount>0?t.errorCount/t.usageCount:0;return i-=n*30,Date.now()-t.lastUsed<3e5&&(i+=5),Math.max(0,i)}inferStrategyMetadata(t){let e=t.getStrategyName(),i=[],n="enhancement",r=5,a="medium",s=[];switch(e){case"dynamic-catppuccin":n="accent",r=10,a="low",i.push("catppuccin","dynamic","accent","spicetify");break;case"living-gradient":n="foundation",r=8,a="low",i.push("gradient","breathing","foundation","css");break;case"webgl-gradient":n="enhancement",r=6,a="high",s.push("webgl"),i.push("webgl","gradient","performance","advanced-blending");break;case"depth-layered":n="effects",r=7,a="medium",i.push("depth","layers","parallax","consciousness","cosmic","cinematic");break;default:break}return{category:n,priority:r,memoryImpact:a,deviceRequirements:s,tags:i}}recordStrategyUsage(t){let e=this.strategiesMap.get(t);e&&(e.usageCount++,e.lastUsed=Date.now())}recordStrategyError(t,e){let i=this.strategiesMap.get(t);if(i){i.errorCount++;let n=i.errorCount/Math.max(1,i.usageCount);n>.5&&i.usageCount>5&&(i.isHealthy=!1,u?.debug?.warn("BackgroundStrategyRegistry",`Strategy ${t} marked as unhealthy`,{errorRate:n,errorCount:i.errorCount,usageCount:i.usageCount}))}}recordStrategyProcessingTime(t,e){let i=this.strategiesMap.get(t);if(i){let n=i.averageProcessingTime*(i.usageCount-1)+e;i.averageProcessingTime=n/i.usageCount}}startHealthMonitoring(){this.healthCheckInterval=window.setInterval(()=>{this.performHealthChecks()},this.HEALTH_CHECK_INTERVAL_MS)}async performHealthChecks(){try{for(let[t,e]of this.strategiesMap.entries())try{if("healthCheck"in e.strategy&&typeof e.strategy.healthCheck=="function"){let i=await e.strategy.healthCheck();e.isHealthy=i?.healthy??!0,e.isHealthy||u?.debug?.warn("BackgroundStrategyRegistry",`Strategy ${t} failed health check:`,i)}}catch(i){e.isHealthy=!1,u?.debug?.error("BackgroundStrategyRegistry",`Health check failed for strategy ${t}:`,i)}this.updateMetrics()}catch(t){u?.debug?.error("BackgroundStrategyRegistry","Health check monitoring failed:",t)}}updateMetrics(){let t=Array.from(this.strategiesMap.values());this.metrics.totalStrategies=t.length,this.metrics.healthyStrategies=t.filter(i=>i.isHealthy).length,this.metrics.totalUsageCount=t.reduce((i,n)=>i+n.usageCount,0);let e=t.filter(i=>i.averageProcessingTime>0).map(i=>i.averageProcessingTime);e.length>0&&(this.metrics.averageResponseTime=e.reduce((i,n)=>i+n,0)/e.length),this.metrics.memoryUsage=t.reduce((i,n)=>{let r=n.metadata.memoryImpact==="high"?3:n.metadata.memoryImpact==="medium"?2:1;return i+r},0)}getRegistryMetrics(){return{...this.metrics}}getStrategyInfo(t){let e=this.strategiesMap.get(t);return e?{...e}:null}getAllStrategyInfo(){return Array.from(this.strategiesMap.entries()).map(([t,e])=>({name:t,registration:{...e}}))}unregister(t){let e=this.strategiesMap.delete(t);return e&&(this.updateMetrics(),u?.debug?.log("BackgroundStrategyRegistry",`Unregistered strategy: ${t}`)),e}clear(){this.strategiesMap.clear(),this.updateMetrics(),u?.debug?.log("BackgroundStrategyRegistry","All strategies cleared from registry")}destroy(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null);for(let[t,e]of this.strategiesMap.entries())if("destroy"in e.strategy&&typeof e.strategy.destroy=="function")try{e.strategy.destroy()}catch(i){u?.debug?.warn("BackgroundStrategyRegistry",`Error destroying strategy ${t}:`,i)}this.clear(),u?.debug?.log("BackgroundStrategyRegistry","Strategy registry destroyed")}}});var Et,Pc,Tc,xc,_h,ts=y(()=>{"use strict";D();de();A();ke();Ja();ne();es();Dn();Et=class{constructor(t,e){this.initialized=!1;this.processingState={isProcessing:!1,currentTrackUri:null,lastExtractedColors:null,lastProcessedResult:null,lastProcessingTime:0,processingQueue:[],queueSize:0};this.metrics={totalExtractions:0,totalProcessed:0,totalApplied:0,averageProcessingTime:0,successRate:0,errorCount:0,lastProcessingTime:0,oklabCoordinations:0,strategySelections:0,cacheHits:0};this.processingTimeout=null;this.PROCESSING_TIMEOUT_MS=1e4;this.MAX_QUEUE_SIZE=10;this.processingCache=new Map;this.CACHE_TTL_MS=3e4;this.settingsManager=t||new ee,this.performanceAnalyzer=e||null,this.deviceCapabilityDetector=new _,this.strategyRegistry=new Si,this.strategySelector=new st,this.oklabProcessor=new M,this.musicalOKLABCoordinator=new fi(!0)}async initialize(){if(!this.initialized)try{await this.deviceCapabilityDetector.initialize(),this.setupEventSubscriptions(),this.registerDefaultStrategies(),this.initialized=!0,u?.debug?.log("UnifiedColorProcessingEngine","\u{1F3A8} Unified color processing engine initialized")}catch(t){throw u?.debug?.error("UnifiedColorProcessingEngine","Failed to initialize:",t),t}}async healthCheck(){let t=[];return this.initialized||t.push("Engine not initialized"),this.processingState.isProcessing&&Date.now()-this.processingState.lastProcessingTime>this.PROCESSING_TIMEOUT_MS&&t.push("Processing appears stuck"),this.metrics.errorCount>0&&this.metrics.successRate<.8&&t.push(`Low success rate: ${(this.metrics.successRate*100).toFixed(1)}%`),this.processingState.queueSize>this.MAX_QUEUE_SIZE&&t.push(`Queue overflow: ${this.processingState.queueSize} items`),{healthy:t.length===0,ok:t.length===0,details:`Unified color processing - ${this.metrics.totalProcessed} processed, ${this.metrics.successRate.toFixed(2)} success rate`,issues:t,system:"UnifiedColorProcessingEngine"}}updateAnimation(t){this.processingCache.size>50&&this.cleanupCache()}destroy(){this.processingTimeout&&(clearTimeout(this.processingTimeout),this.processingTimeout=null),this.processingState.processingQueue=[],this.processingCache.clear(),g.unsubscribeAll("UnifiedColorProcessingEngine"),this.initialized=!1}setupEventSubscriptions(){g.subscribe("colors:extracted",t=>{this.handleColorExtraction(t)},"UnifiedColorProcessingEngine"),g.subscribe("settings:changed",t=>{this.handleSettingsChange(t)},"UnifiedColorProcessingEngine")}async processColors(t){let e=performance.now();try{let i=this.generateCacheKey(t),n=this.getCachedResult(i);if(n)return this.metrics.cacheHits++,n;let r=await this.selectOptimalStrategy(t);this.metrics.strategySelections++;let a=await this.processWithOKLAB(t,r),s=performance.now()-e;this.updateMetrics(s,!0);let o={...a,processingTime:s,strategy:r,success:!0,timestamp:Date.now(),coordinationMetrics:{detectedGenre:t.musicData?.genre||"unknown",emotionalState:t.musicData?.energy?this.classifyEmotionalState(t.musicData.energy):"neutral",oklabPreset:this.determineOKLABPreset(t),coordinationStrategy:r.getStrategyName(),musicInfluenceStrength:t.musicData?.energy||.5}};return this.cacheResult(i,o),g.emit("colors:harmonized",{processedColors:a.processedColors,accentHex:a.accentHex||"#cba6f7",accentRgb:a.accentRgb||"203,166,247",strategies:[r.getStrategyName()],coordinationMetrics:o.coordinationMetrics,oklabData:o.oklabData,processingTime:s,timestamp:Date.now()}),o}catch(i){let n=performance.now()-e;return this.updateMetrics(n,!1),u?.debug?.error("UnifiedColorProcessingEngine","Processing failed:",i),this.createFallbackResult(t,i)}}async handleColorExtraction(t){return"rawColors"in t&&"trackUri"in t?this.processColorContext(t):this.handleColorExtractionEvent(t)}async processColorContext(t){this.metrics.totalExtractions++;try{if(this.processingState.isProcessing){this.addToQueue(t);return}await this.processWithTimeout(t)}catch(e){this.metrics.errorCount++,u?.debug?.error("UnifiedColorProcessingEngine","Color context processing failed:",e)}}async handleColorExtractionEvent(t){this.metrics.totalExtractions++;try{let e={rawColors:t.rawColors,trackUri:t.trackUri,musicData:t.musicData,timestamp:t.timestamp||Date.now()};if(this.processingState.isProcessing){this.addToQueue(e);return}await this.processWithTimeout(e)}catch(e){this.metrics.errorCount++,u?.debug?.error("UnifiedColorProcessingEngine","Color extraction handling failed:",e)}}async processWithOKLAB(t,e){let i={rawColors:t.rawColors,musicData:t.musicData,trackUri:t.trackUri,timestamp:t.timestamp},n=await this.musicalOKLABCoordinator.coordinateMusicalColors(i);this.metrics.oklabCoordinations++;let r=await e.processColors(t),a=await this.enhanceWithOKLAB(r.processedColors,n);return{...r,processedColors:a,metadata:{...r.metadata,oklabPreset:this.determineOKLABPreset(t),oklabCoordination:n}}}async selectOptimalStrategy(t){try{let i=this.deviceCapabilityDetector.getCapabilities(),n={performance:"medium",quality:"enhanced",deviceCapabilities:{hasWebGL:i?.gpu?.supportsWebGL||!0,memoryMB:i?.memory?.total||4096,isMobile:!1},userPreferences:{harmonicMode:"cosmic",intensity:.8,enableAdvancedBlending:!0},settingsContext:{dynamicAccentEnabled:!0,gradientIntensity:"medium",webglEnabled:i?.gpu?.supportsWebGL||!0,webglForceEnabled:!1,visualGuideMode:"enhanced",depthLayersEnabled:!0,consciousnessLevel:.8,breathingAnimationEnabled:!0},deviceContext:{supportsWebGL:i?.gpu?.supportsWebGL||!0,performanceLevel:"medium",memoryCapacity:i?.memory?.total||4096,isMobile:!1}},r=this.strategySelector.selectStrategies(t,n);if(r&&r.length>0&&r[0])return r[0]}catch(i){u?.debug?.warn("UnifiedColorProcessingEngine","Strategy selection failed, using fallback:",i)}return{getStrategyName:()=>"fallback",canProcess:i=>!0,getEstimatedProcessingTime:i=>50,processColors:async i=>({processedColors:i.rawColors,accentHex:"#cba6f7",accentRgb:"203,166,247",context:i,metadata:{strategy:"fallback",timestamp:Date.now(),processingTime:0}})}}addToQueue(t){this.processingState.queueSize>=this.MAX_QUEUE_SIZE&&this.processingState.processingQueue.shift(),this.processingState.processingQueue.push(t),this.processingState.queueSize=this.processingState.processingQueue.length}async processQueue(){for(;this.processingState.processingQueue.length>0&&!this.processingState.isProcessing;){let t=this.processingState.processingQueue.shift();this.processingState.queueSize=this.processingState.processingQueue.length,await this.processWithTimeout(t)}}async processWithTimeout(t){this.processingState.isProcessing=!0,this.processingState.lastProcessingTime=Date.now(),this.processingTimeout=window.setTimeout(()=>{u?.debug?.warn("UnifiedColorProcessingEngine","Processing timeout - forcing reset"),this.processingState.isProcessing=!1,this.metrics.errorCount++},this.PROCESSING_TIMEOUT_MS);try{await this.processColors(t),this.metrics.totalProcessed++}finally{this.processingTimeout&&(clearTimeout(this.processingTimeout),this.processingTimeout=null),this.processingState.isProcessing=!1,this.processingState.processingQueue.length>0&&setTimeout(()=>this.processQueue(),0)}}generateCacheKey(t){let e={colors:Object.keys(t.rawColors).sort().join(","),music:t.musicData?.energy||0};return JSON.stringify(e)}getCachedResult(t){let e=this.processingCache.get(t);return e&&Date.now()-e.timestamp<this.CACHE_TTL_MS?e:null}cacheResult(t,e){this.processingCache.set(t,{...e,timestamp:Date.now()})}cleanupCache(){let t=Date.now();for(let[e,i]of this.processingCache.entries())t-i.timestamp>this.CACHE_TTL_MS&&this.processingCache.delete(e)}updateMetrics(t,e){this.metrics.averageProcessingTime=(this.metrics.averageProcessingTime*this.metrics.totalProcessed+t)/(this.metrics.totalProcessed+1),e?this.metrics.successRate=(this.metrics.successRate*this.metrics.totalProcessed+1)/(this.metrics.totalProcessed+1):this.metrics.successRate=this.metrics.successRate*this.metrics.totalProcessed/(this.metrics.totalProcessed+1),this.metrics.lastProcessingTime=Date.now()}async enhanceWithOKLAB(t,e){let i={...t};return e.enhancedColors&&Object.entries(e.enhancedColors).forEach(([n,r])=>{i[`oklab-${n}`]=r}),i}classifyEmotionalState(t){return t>.8?"energetic":t>.6?"upbeat":t>.4?"moderate":t>.2?"calm":"peaceful"}determineOKLABPreset(t){let e=t.musicData?.energy||.5;return e>.8?"high-energy":e>.6?"dynamic":e>.4?"balanced":"ambient"}createFallbackResult(t,e){return{processedColors:{fallback:"#cba6f7"},accentHex:"#cba6f7",accentRgb:"203,166,247",context:t,metadata:{strategy:"fallback",error:e.message,timestamp:Date.now(),processingTime:0}}}registerDefaultStrategies(){}async handleSettingsChange(t){["catppuccin-flavor","catppuccin-accentColor","sn-dynamic-color-intensity"].includes(t.settingKey)&&(this.processingCache.clear(),u?.debug?.log("UnifiedColorProcessingEngine","Cache cleared due to settings change:",t.settingKey))}async handlePerformanceWarning(t){t.memoryUsage>50&&(this.processingCache.clear(),u?.debug?.log("UnifiedColorProcessingEngine","Cache cleared due to memory pressure"))}getMetrics(){return{...this.metrics}}async forceReprocessColors(){if(this.processingCache.clear(),this.processingState.lastExtractedColors){let t={rawColors:this.processingState.lastExtractedColors,trackUri:this.processingState.currentTrackUri||"",timestamp:Date.now()};await this.processColors(t)}}getProcessingState(){return{...this.processingState}}getStatus(){return{isProcessing:this.processingState.isProcessing,queueSize:this.processingState.queueSize}}setSelectionCriteria(t){u?.debug?.log("UnifiedColorProcessingEngine","Strategy selection criteria updated:",t)}},Pc=()=>{let c=globalThis.year3000System;return{settingsManager:c?.settingsManager,performanceAnalyzer:c?.performanceAnalyzer||c?.facadeCoordinator?.getCachedNonVisualSystem?.("PerformanceAnalyzer")}},{settingsManager:Tc,performanceAnalyzer:xc}=Pc(),_h=new Et(Tc,xc)});var vi,is=y(()=>{"use strict";xe();ne();D();vi=class c{constructor(t,e,i){this.initialized=!1;this.cardQuerySelector=".main-card-card, .main-gridContainer-gridContainer.main-gridContainer-fixedWidth";this.cardEventHandlers=new WeakMap;this.musicSyncService=null;this.currentQualityLevel=null;this.qualityCapabilities=[];this.consciousnessCoordinationCallbacks=new Set;this.config={perspective:1e3,maxRotation:5,scale:1.02,transitionSpeed:"200ms",glowOpacity:.8,selector:".main-card-card, .main-grid-grid > *, .main-shelf-shelf > * > *",consciousnessDepthMultiplier:1.5,emotionalResponseStrength:.8,beatSyncIntensity:.6,cinematicDramaMultiplier:1.2},this.performanceMonitor=t,this.settingsManager=e,this.utils=i,this.cards=document.querySelectorAll(this.config.selector),this.emotionalMapper=new J(!0),this.oklabProcessor=new M(!0),this.cinematicPreset=M.getPreset("VIBRANT"),this.consciousnessState={currentEmotion:"neutral",emotionalIntensity:.5,beatPhase:0,lastBeatTime:0,cinematicDramaLevel:0,dynamicAccentHex:"#cba6f7",dynamicAccentRgb:"203,166,247",consciousnessLevel:.5},this.boundHandleSettingsChange=this.handleSettingsChange.bind(this)}static getInstance(t,e,i){return c.instance||(c.instance=new c(t,e,i)),c.instance}async initialize(){if(this.initialized)return;let t=this.performanceMonitor.shouldReduceQuality();this.cards=document.querySelectorAll(this.config.selector),await this.applyEventListeners(),await this.initializeConsciousnessIntegration(),this.initializeCrossSystemCoordination(),document.addEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange),this.initialized=!0}async healthCheck(){let t=document.querySelectorAll(this.cardQuerySelector);return t.length>0?{healthy:!0,ok:!0,details:`Found ${t.length} cards to manage.`,issues:[],system:"Card3DManager"}:{healthy:!1,ok:!1,details:"No card elements found with the configured selector.",issues:["No card elements found with the configured selector."],system:"Card3DManager"}}updateAnimation(t){}apply3DMode(t){console.log(`[Card3DManager] Applying 3D mode: ${t}`),t==="disabled"?this.destroy():this.initialize()}get shouldEnable3DEffects(){let t=this.performanceMonitor.shouldReduceQuality(),e=this.settingsManager.get("sn-enable3dCards");return!t&&e!=="disabled"}async applyEventListeners(){this.cards.forEach(t=>{if(this.cardEventHandlers.has(t))return;let e=n=>this.handleMouseMove(t,n),i=()=>this.handleMouseLeave(t);this.cardEventHandlers.set(t,{move:e,leave:i}),t.addEventListener("mousemove",e),t.addEventListener("mouseleave",i)})}handleMouseMove(t,e){if(!this.shouldEnable3DEffects)return;let{clientX:i,clientY:n}=e,{top:r,left:a,width:s,height:o}=t.getBoundingClientRect(),l=i-a,m=n-r,d=this.config.maxRotation*(m-o/2)/(o/2),h=-this.config.maxRotation*(l-s/2)/(s/2);t.style.transform=`perspective(${this.config.perspective}px) rotateX(${d}deg) rotateY(${h}deg) scale3d(${this.config.scale}, ${this.config.scale}, ${this.config.scale})`,t.style.transition=`transform ${this.config.transitionSpeed} ease-out`,this.applyGlow(t,l,m,s,o)}handleMouseLeave(t){t.style.transform="perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)",t.style.transition="transform 600ms ease-in-out",this.removeGlow(t)}applyGlow(t,e,i,n,r){let a=t.querySelector(".card-glow");a||(a=document.createElement("div"),a.className="card-glow",t.appendChild(a));let{dynamicAccentRgb:s,emotionalIntensity:o,beatPhase:l,cinematicDramaLevel:m}=this.consciousnessState,d=this.config.glowOpacity,h=1+(o-.5)*this.config.emotionalResponseStrength,p=1+Math.sin(l)*this.config.beatSyncIntensity*.3,b=1+m*this.config.cinematicDramaMultiplier*.4,v=d*h*p*b,C=Math.max(.1,Math.min(1,v)),E=40+Math.sin(l*.5)*8*this.config.beatSyncIntensity;a.style.background=`radial-gradient(circle at ${e}px ${i}px, 
      rgba(${s}, ${C}) 0%, 
      rgba(${s}, ${C*.6}) 20%, 
      transparent ${E}%)`}removeGlow(t){let e=t.querySelector(".card-glow");e&&(e.style.background="transparent")}destroy(){this.cards.forEach(t=>{let e=this.cardEventHandlers.get(t);e&&(t.removeEventListener("mousemove",e.move),t.removeEventListener("mouseleave",e.leave),this.cardEventHandlers.delete(t)),this.removeGlow(t),t.style.transform="",t.style.transition=""}),this.initialized=!1,document.removeEventListener("year3000SystemSettingsChanged",this.boundHandleSettingsChange)}handleSettingsChange(t){let{key:e,value:i}=t.detail||{}}async initializeConsciousnessIntegration(){try{g.subscribe("colors:extracted",t=>{this.onColorsExtracted(t)},"Card3DManager"),g.subscribe("colors:harmonized",t=>{this.onColorsHarmonized(t)},"Card3DManager"),g.subscribe("music:beat",t=>{this.onMusicBeat(t)},"Card3DManager"),g.subscribe("consciousness:dramatic-moment",t=>{this.onCinematicDramaEvent(t)},"Card3DManager"),this.updateDynamicAccentColor(),console.log("[Card3DManager] \u2705 Year 3000 consciousness integration initialized")}catch(t){console.error("[Card3DManager] Failed to initialize consciousness integration:",t)}}onColorsExtracted(t){let{rawColors:e,musicData:i}=t;if(i){let n=this.emotionalMapper.mapMusicToEmotionalTemperature(i);this.updateEmotionalState(n)}}onColorsHarmonized(t){let{processedColors:e,coordinationMetrics:i}=t;if(e.VIBRANT){let n=this.oklabProcessor.processColor(e.VIBRANT,this.cinematicPreset);this.consciousnessState.dynamicAccentHex=n.enhancedHex,this.consciousnessState.dynamicAccentRgb=`${n.enhancedRgb.r},${n.enhancedRgb.g},${n.enhancedRgb.b}`}i?.consciousnessLevel!==void 0&&(this.consciousnessState.consciousnessLevel=i.consciousnessLevel)}onMusicBeat(t){let{beat:e,intensity:i,timestamp:n}=t;this.consciousnessState.beatPhase+=Math.PI*2*this.config.beatSyncIntensity,this.consciousnessState.lastBeatTime=n||Date.now(),i>.7&&this.applyBeatSyncDepthPulse(i)}onCinematicDramaEvent(t){let{intensity:e,type:i}=t;this.consciousnessState.cinematicDramaLevel=e,e>.8&&this.applyDramaticDepthDistortion(e)}updateEmotionalState(t){switch(this.consciousnessState.currentEmotion=t.primaryEmotion,this.consciousnessState.emotionalIntensity=t.intensity,t.primaryEmotion){case"energetic":case"aggressive":this.cinematicPreset=M.getPreset("COSMIC");break;case"calm":case"ambient":this.cinematicPreset=M.getPreset("SUBTLE");break;default:this.cinematicPreset=M.getPreset("VIBRANT")}}applyBeatSyncDepthPulse(t){let e=1+t*.15*this.config.beatSyncIntensity;this.cards.forEach(i=>{if(i instanceof HTMLElement){let r=(i.style.transform||"").replace(/scale3d\([^)]*\)/,`scale3d(${e}, ${e}, ${e})`);i.style.transform=r||`scale3d(${e}, ${e}, ${e})`,i.style.transition="transform 100ms ease-out",setTimeout(()=>{i.style.transform.includes(`scale3d(${e}`)&&(i.style.transform=i.style.transform.replace(/scale3d\([^)]*\)/,"scale3d(1, 1, 1)"))},200)}})}applyDramaticDepthDistortion(t){let e=this.config.perspective*(1+t*this.config.cinematicDramaMultiplier),i=this.config.maxRotation*(1+t*.8);this.cards.forEach(n=>{if(n instanceof HTMLElement){let r=`perspective(${e}px) rotateX(${i*.3}deg) rotateY(${i*.2}deg)`;n.style.transform=r,n.style.transition="transform 800ms ease-out",setTimeout(()=>{n.style.transform="perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)",n.style.transition="transform 1200ms ease-in-out"},1500)}})}updateDynamicAccentColor(){let t=document.documentElement,e=getComputedStyle(t),i=e.getPropertyValue("--sn-dynamic-accent-hex").trim()||e.getPropertyValue("--sn-color-accent-hex").trim()||e.getPropertyValue("--spice-accent").trim(),n=e.getPropertyValue("--sn-dynamic-accent-rgb").trim()||e.getPropertyValue("--sn-color-accent-rgb").trim()||e.getPropertyValue("--spice-rgb-accent").trim();i&&i!==""&&(this.consciousnessState.dynamicAccentHex=i),n&&n!==""&&(this.consciousnessState.dynamicAccentRgb=n)}setMusicSyncService(t){this.musicSyncService=t}getConsciousnessState(){return{...this.consciousnessState}}setQualityLevel(t){switch(this.currentQualityLevel=t,t){case"low":this.config.perspective=900,this.config.maxRotation=3,this.config.consciousnessDepthMultiplier=1.2,this.config.emotionalResponseStrength=.5,this.config.beatSyncIntensity=.4,this.config.cinematicDramaMultiplier=.8;break;case"medium":this.config.perspective=1e3,this.config.maxRotation=5,this.config.consciousnessDepthMultiplier=1.5,this.config.emotionalResponseStrength=.8,this.config.beatSyncIntensity=.6,this.config.cinematicDramaMultiplier=1.2;break;case"high":this.config.perspective=1200,this.config.maxRotation=7,this.config.consciousnessDepthMultiplier=1.8,this.config.emotionalResponseStrength=1,this.config.beatSyncIntensity=.8,this.config.cinematicDramaMultiplier=1.5;break;default:this.config.perspective=1e3,this.config.maxRotation=5,this.config.consciousnessDepthMultiplier=1.5,this.config.emotionalResponseStrength=.8,this.config.beatSyncIntensity=.6,this.config.cinematicDramaMultiplier=1.2;break}console.log(`[Card3DManager] Quality level set to: ${t}`)}adjustQuality(t){this.setQualityLevel(t)}getPerformanceImpact(){let t=this.cards.length,e=t*.1,i=this.config.consciousnessDepthMultiplier*.2,n=this.config.emotionalResponseStrength*.15,r=this.config.cinematicDramaMultiplier*.1;return{fps:60,frameTime:e+i+n+r,memoryUsage:t*.05,cpuUsage:(e+i)*100}}reduceQuality(t){this.currentQualityLevel&&(this.config.consciousnessDepthMultiplier=Math.max(.5,this.config.consciousnessDepthMultiplier-t),this.config.emotionalResponseStrength=Math.max(.1,this.config.emotionalResponseStrength-t),this.config.beatSyncIntensity=Math.max(.1,this.config.beatSyncIntensity-t),this.config.cinematicDramaMultiplier=Math.max(.5,this.config.cinematicDramaMultiplier-t),console.log(`[Card3DManager] Quality reduced by ${t}`))}increaseQuality(t){this.currentQualityLevel&&(this.config.consciousnessDepthMultiplier=Math.min(2,this.config.consciousnessDepthMultiplier+t),this.config.emotionalResponseStrength=Math.min(1.5,this.config.emotionalResponseStrength+t),this.config.beatSyncIntensity=Math.min(1,this.config.beatSyncIntensity+t),this.config.cinematicDramaMultiplier=Math.min(2,this.config.cinematicDramaMultiplier+t),console.log(`[Card3DManager] Quality increased by ${t}`))}getQualityCapabilities(){return this.qualityCapabilities.length===0&&(this.qualityCapabilities=[{name:"3D Perspective",enabled:!0,qualityLevel:"medium"},{name:"Consciousness Glow",enabled:!0,qualityLevel:"low"},{name:"Beat Sync Effects",enabled:!0,qualityLevel:"low"},{name:"Dramatic Distortion",enabled:!0,qualityLevel:"medium"},{name:"Emotional Modulation",enabled:!0,qualityLevel:"low"}]),this.qualityCapabilities}async refreshColorState(t){try{if(this.updateDynamicAccentColor(),this.consciousnessState.dynamicAccentHex){let e=this.oklabProcessor.processColor(this.consciousnessState.dynamicAccentHex,this.cinematicPreset);this.consciousnessState.dynamicAccentHex=e.enhancedHex,this.consciousnessState.dynamicAccentRgb=`${e.enhancedRgb.r},${e.enhancedRgb.g},${e.enhancedRgb.b}`}console.log(`[Card3DManager] Color state refreshed for trigger: ${t}`)}catch(e){console.error("[Card3DManager] Error refreshing color state:",e)}}onConsciousnessCoordination(t){return this.consciousnessCoordinationCallbacks.add(t),()=>{this.consciousnessCoordinationCallbacks.delete(t)}}synchronizeConsciousnessState(t){t.currentEmotion&&(this.consciousnessState.currentEmotion=t.currentEmotion),t.emotionalIntensity!==void 0&&(this.consciousnessState.emotionalIntensity=t.emotionalIntensity),t.beatPhase!==void 0&&(this.consciousnessState.beatPhase=t.beatPhase),t.cinematicDramaLevel!==void 0&&(this.consciousnessState.cinematicDramaLevel=t.cinematicDramaLevel),t.consciousnessLevel!==void 0&&(this.consciousnessState.consciousnessLevel=t.consciousnessLevel),t.dynamicAccentHex&&(this.consciousnessState.dynamicAccentHex=t.dynamicAccentHex),t.dynamicAccentRgb&&(this.consciousnessState.dynamicAccentRgb=t.dynamicAccentRgb),this.broadcastConsciousnessState()}broadcastConsciousnessState(){this.consciousnessCoordinationCallbacks.forEach(t=>{try{t(this.consciousnessState)}catch(e){console.error("[Card3DManager] Error in consciousness coordination callback:",e)}})}updateEmotionalStateWithCoordination(t){this.updateEmotionalState(t),this.broadcastConsciousnessState(),g.emit("consciousness:coordination",{source:"Card3DManager",state:this.consciousnessState,timestamp:Date.now()})}onMusicBeatWithCoordination(t){this.onMusicBeat(t),this.broadcastConsciousnessState(),g.emit("consciousness:beat-sync",{source:"Card3DManager",beatPhase:this.consciousnessState.beatPhase,lastBeatTime:this.consciousnessState.lastBeatTime,timestamp:Date.now()})}onCinematicDramaEventWithCoordination(t){this.onCinematicDramaEvent(t),this.broadcastConsciousnessState(),g.emit("consciousness:dramatic-sync",{source:"Card3DManager",dramaticLevel:this.consciousnessState.cinematicDramaLevel,type:t.type,timestamp:Date.now()})}initializeCrossSystemCoordination(){try{g.subscribe("consciousness:coordination",t=>{t.source!=="Card3DManager"&&this.synchronizeConsciousnessState(t.state)},"Card3DManager"),g.subscribe("consciousness:beat-sync",t=>{t.source!=="Card3DManager"&&(this.consciousnessState.beatPhase=t.beatPhase,this.consciousnessState.lastBeatTime=t.lastBeatTime)},"Card3DManager"),g.subscribe("consciousness:dramatic-sync",t=>{t.source!=="Card3DManager"&&(this.consciousnessState.cinematicDramaLevel=t.dramaticLevel)},"Card3DManager"),console.log("[Card3DManager] \u2705 Cross-system consciousness coordination initialized")}catch(t){console.error("[Card3DManager] Failed to initialize cross-system coordination:",t)}}}});var Jn,er,ns=y(()=>{"use strict";Jn=class c{constructor(){this.observers=new Map;this.trackedElements=new Map;this.isSupported=typeof IntersectionObserver<"u",this.isSupported||console.warn("[ViewportAwarenessManager] IntersectionObserver not supported, falling back to always-visible behavior")}static getInstance(){return c.instance||(c.instance=new c),c.instance}trackElement(t,e,i={}){if(!this.isSupported){let o={isVisible:!0,intersectionRatio:1,lastVisibilityChange:Date.now(),element:t};return e(o),()=>{}}let n={visibilityThreshold:.1,rootMargin:"50px",trackRootElement:!1,...i},r=this.getObserverKey(n),a=this.observers.get(r);a||(a=new IntersectionObserver(o=>this.handleIntersectionChanges(o),{threshold:n.visibilityThreshold,rootMargin:n.rootMargin,root:n.rootSelector?document.querySelector(n.rootSelector):null}),this.observers.set(r,a));let s={isVisible:!1,intersectionRatio:0,lastVisibilityChange:Date.now(),element:t};return this.trackedElements.set(t,{callback:e,options:n,state:s}),a.observe(t),()=>this.untrackElement(t)}isElementVisible(t){return this.trackedElements.get(t)?.state.isVisible??!0}getVisibilityState(t){return this.trackedElements.get(t)?.state??null}untrackElement(t){let e=this.trackedElements.get(t);if(!e)return;let i=this.getObserverKey(e.options),n=this.observers.get(i);n&&n.unobserve(t),this.trackedElements.delete(t)}trackSpotifyContainer(t){let e=[".Root__main-view",'[data-testid="topbar"]',".main-view-container","#main"],i=null;for(let n of e)if(i=document.querySelector(n),i)break;return i||(console.warn("[ViewportAwarenessManager] Could not find Spotify main container, using document.body"),i=document.body),this.trackElement(i,t,{visibilityThreshold:.1,rootMargin:"0px",trackRootElement:!0})}checkBulkVisibility(t){let e=new Map;for(let i of t)e.set(i,this.isElementVisible(i));return e}destroy(){for(let t of this.observers.values())t.disconnect();this.observers.clear(),this.trackedElements.clear()}handleIntersectionChanges(t){for(let e of t){let i=this.trackedElements.get(e.target);if(!i)continue;let n=i.state.isVisible,r=e.isIntersecting;if(i.state={isVisible:r,intersectionRatio:e.intersectionRatio,lastVisibilityChange:n!==r?Date.now():i.state.lastVisibilityChange,element:e.target},n!==r)try{i.callback(i.state)}catch(a){console.error("[ViewportAwarenessManager] Error in visibility callback:",a)}}}getObserverKey(t){return`${t.visibilityThreshold}-${t.rootMargin}-${t.rootSelector||"viewport"}`}},er=Jn.getInstance()});var Ci,rs=y(()=>{"use strict";ns();D();Ci=class{constructor(t={}){this.initialized=!1;this.isVisible=!0;this.visibilityState=null;this.animationsPaused=!1;this.settingsUpdatesPaused=!1;this.viewportOptions={visibilityThreshold:.1,rootMargin:"50px",pauseAnimationsWhenHidden:!0,pauseSettingsUpdatesWhenHidden:!0,resumeDelay:100,...t}}async initialize(){await this.initializeViewportTracking(),await this.initializeEventSubscriptions(),await this.initializeSystem(),this.initialized=!0}async healthCheck(){let t=await this.performHealthCheck();return{...t,details:`${t.details} | Viewport: ${this.isVisible?"visible":"hidden"}`}}updateAnimation(t){this.shouldSkipAnimationUpdate()||this.performAnimationUpdate(t)}destroy(){this.cleanupViewportTracking(),this.cleanupEventSubscriptions(),this.performDestroy()}handleSettingsChange(t){this.shouldSkipSettingsUpdate()||this.performSettingsUpdate(t)}forceRepaint(t){this.performForceRepaint?.(t)}onVisibilityChanged(t){}onBecomingVisible(){}onBecomingHidden(){}async initializeViewportTracking(){let t=null;this.viewportOptions.trackingSelector&&(t=document.querySelector(this.viewportOptions.trackingSelector)),t?this.untrackViewport=er.trackElement(t,e=>this.handleVisibilityChange(e),this.viewportOptions):this.untrackViewport=er.trackSpotifyContainer(e=>this.handleVisibilityChange(e))}async initializeEventSubscriptions(){this.settingsSubscriptionId=g.subscribe("settings:changed",t=>this.handleUnifiedSettingsChange(t),`ViewportAwareSystem-${this.constructor.name}`)}cleanupEventSubscriptions(){this.settingsSubscriptionId&&(g.unsubscribe(this.settingsSubscriptionId),delete this.settingsSubscriptionId)}handleUnifiedSettingsChange(t){if(this.shouldSkipSettingsUpdate())return;let e=new CustomEvent("year3000SystemSettingsChanged",{detail:{key:t.settingKey,value:t.newValue}});this.performSettingsUpdate(e)}handleVisibilityChange(t){let e=this.isVisible;this.isVisible=t.isVisible,this.visibilityState=t,!e&&this.isVisible?this.handleBecomingVisible():e&&!this.isVisible&&this.handleBecomingHidden(),this.onVisibilityChanged(t)}handleBecomingVisible(){this.resumeTimeoutId&&clearTimeout(this.resumeTimeoutId),this.resumeTimeoutId=window.setTimeout(()=>{this.animationsPaused=!1,this.settingsUpdatesPaused=!1,this.onBecomingVisible()},this.viewportOptions.resumeDelay||100)}handleBecomingHidden(){this.viewportOptions.pauseAnimationsWhenHidden&&(this.animationsPaused=!0),this.viewportOptions.pauseSettingsUpdatesWhenHidden&&(this.settingsUpdatesPaused=!0),this.onBecomingHidden()}shouldSkipAnimationUpdate(){return this.animationsPaused||!this.isVisible&&(this.viewportOptions.pauseAnimationsWhenHidden??!0)}shouldSkipSettingsUpdate(){return this.settingsUpdatesPaused||!this.isVisible&&(this.viewportOptions.pauseSettingsUpdatesWhenHidden??!0)}cleanupViewportTracking(){this.untrackViewport&&(this.untrackViewport(),delete this.untrackViewport),this.resumeTimeoutId&&(clearTimeout(this.resumeTimeoutId),delete this.resumeTimeoutId)}getVisibilityInfo(){return{isVisible:this.isVisible,animationsPaused:this.animationsPaused,settingsUpdatesPaused:this.settingsUpdatesPaused,...this.visibilityState?.intersectionRatio!==void 0&&{intersectionRatio:this.visibilityState.intersectionRatio}}}}});var Mi,as=y(()=>{"use strict";U();qt();N();rs();K();xe();ne();D();Mi=class c extends Ci{constructor(e=w,i=I,n=null,r=null,a,s={}){super({visibilityThreshold:.2,pauseAnimationsWhenHidden:!1,pauseSettingsUpdatesWhenHidden:!0,resumeDelay:50,...s});this.cssBatcher=null;this.performanceAnalyzer=null;this.observers=[];this.musicSyncService=null;this.currentQualityLevel=null;this.qualityCapabilities=[];this.consciousnessCoordinationCallbacks=new Set;this.config=e,this.utils=i,this.cssBatcher=n,this.performanceAnalyzer=r,this.settingsManager=a,this.isSupported=this.detectBackdropFilterSupport(),this.currentIntensity="balanced",this.emotionalMapper=new J(!0),this.oklabProcessor=new M(!0),this.cinematicPreset=M.getPreset("STANDARD"),this.consciousnessState={currentEmotion:"neutral",emotionalIntensity:.5,beatPhase:0,lastBeatTime:0,cinematicDramaLevel:0,dynamicAccentHex:"#cba6f7",dynamicAccentRgb:"203,166,247",consciousnessLevel:.5,genreStyle:"organic",breathingRate:1}}static getInstance(){if(!c.instance)throw new Error("GlassmorphismManager instance not initialized");return c.instance}async initializeSystem(){let e=globalThis.year3000System;this.cssController=e?.cssConsciousnessController||T();let i=this.settingsManager.get("sn-glassmorphism-level");this.applyGlassmorphismSettings(i),await this.initializeConsciousnessIntegration()}async performHealthCheck(){return{healthy:!0,ok:!0,details:"GlassmorphismManager is operational.",issues:[],system:"GlassmorphismManager"}}performAnimationUpdate(e){}performDestroy(){this.observers.forEach(e=>e.disconnect()),this.observers=[]}performSettingsUpdate(e){let i=e,{key:n,value:r}=i.detail||{};n===Zr&&(this.applyGlassmorphismSettings(r),this.updateGlassVariables(this.currentIntensity))}onBecomingVisible(){if(this.currentIntensity!=="disabled"){let e=document.documentElement,n=getComputedStyle(e).getPropertyValue("--spice-rgb-accent").trim();n&&n!==""&&this.updateGlassColors(`rgb(${n})`,`rgb(${n})`)}}onBecomingHidden(){}detectBackdropFilterSupport(){try{return CSS.supports("backdrop-filter","blur(1px)")||CSS.supports("-webkit-backdrop-filter","blur(1px)")}catch(e){return console.warn("StarryNight: CSS.supports not available, assuming no backdrop-filter support",e),!1}}applyGlassmorphismSettings(e){let i=document.body;i.classList.remove("sn-glass-disabled","sn-glass-minimal","sn-glass-balanced","sn-glass-intense"),i.classList.add(`sn-glass-${e}`),this.currentIntensity=e,this.updateGlassVariables(e)}updateGlassVariables(e){let i=document.documentElement,n=this.performanceAnalyzer?.shouldReduceQuality()||!1,r,a,s;switch(e){case"disabled":i.style.removeProperty("--glass-blur"),i.style.removeProperty("--glass-opacity"),i.style.removeProperty("--glass-saturation");return;case"minimal":r=n?"2px":"3px",a="0.05",s="1.05";break;case"moderate":r=n?"3px":"5px",a="0.08",s="1.15";break;case"intense":r=n?"6px":"8px",a="0.15",s="1.4";break;case"balanced":default:r=n?"4px":"6px",a="0.1",s="1.2";break}let o=this.calculateConsciousnessModulations(),l=this.modulateBlurValue(r,o),m=this.modulateOpacityValue(a,o),d=this.modulateSaturationValue(s,o),h={"--glass-blur":l,"--glass-opacity":m,"--glass-saturation":d,"--glass-breathing-rate":`${this.consciousnessState.breathingRate}s`,"--glass-consciousness-level":this.consciousnessState.consciousnessLevel.toString()};this.cssController.batchSetVariables("GlassmorphismManager",h,"high","glass-properties-update")}updateGlassColors(e,i){if(this.currentIntensity==="disabled")return;let n=this.convertToGlassColor(e,.1),r=this.convertToGlassColor(i,.08),a={"--glass-background":n,"--glass-border":r};this.cssController.batchSetVariables("GlassmorphismManager",a,"high","glass-color-update")}convertToGlassColor(e,i){try{if(typeof e!="string")return this.getThemeAwareFallback(i);if(e.startsWith("rgb")){let n=e.match(/\d+/g);if(n&&n.length>=3)return`rgba(${n[0]}, ${n[1]}, ${n[2]}, ${i})`}if(e.startsWith("#")){let n=e.slice(1),r=parseInt(n.substring(0,2),16),a=parseInt(n.substring(2,4),16),s=parseInt(n.substring(4,6),16);if(!isNaN(r)&&!isNaN(a)&&!isNaN(s))return`rgba(${r}, ${a}, ${s}, ${i})`}return this.getThemeAwareFallback(i)}catch{return this.getThemeAwareFallback(i)}}getThemeAwareFallback(e){let i=document.documentElement,n=getComputedStyle(i);if(this.consciousnessState.dynamicAccentRgb&&this.consciousnessState.dynamicAccentRgb!=="203,166,247")return`rgba(${this.consciousnessState.dynamicAccentRgb}, ${e})`;let r=n.getPropertyValue("--sn-dynamic-accent-rgb").trim()||n.getPropertyValue("--sn-color-accent-rgb").trim()||n.getPropertyValue("--spice-rgb-accent").trim();if(r&&r!==""&&!r.includes("undefined"))return`rgba(${r}, ${e})`;let a=n.getPropertyValue("--spice-rgb-text").trim();return a&&a!==""&&!a.includes("undefined")?`rgba(${a}, ${e})`:`rgba(203, 166, 247, ${e})`}async initializeConsciousnessIntegration(){try{g.subscribe("colors:extracted",e=>{this.onColorsExtracted(e)},"GlassmorphismManager"),g.subscribe("colors:harmonized",e=>{this.onColorsHarmonized(e)},"GlassmorphismManager"),g.subscribe("music:beat",e=>{this.onMusicBeat(e)},"GlassmorphismManager"),g.subscribe("consciousness:dramatic-moment",e=>{this.onCinematicDramaEvent(e)},"GlassmorphismManager"),this.updateDynamicAccentColor(),this.initializeCrossSystemCoordination(),console.log("[GlassmorphismManager] \u2705 Year 3000 consciousness integration initialized")}catch(e){console.error("[GlassmorphismManager] Failed to initialize consciousness integration:",e)}}calculateConsciousnessModulations(){let{emotionalIntensity:e,beatPhase:i,cinematicDramaLevel:n,consciousnessLevel:r}=this.consciousnessState,a=1+(e-.5)*.4,s=1+Math.sin(i)*r*.15,o=1+n*.3,l=1+Math.sin(Date.now()*this.consciousnessState.breathingRate*.001)*.08;return{emotionalModulation:a,beatModulation:s,cinematicModulation:o,breathingModulation:l}}modulateBlurValue(e,i){let n=parseFloat(e.replace("px","")),{emotionalModulation:r,beatModulation:a,breathingModulation:s}=i,o=n*r*a*s;return`${Math.max(1,Math.round(o))}px`}modulateOpacityValue(e,i){let n=parseFloat(e),{emotionalModulation:r,cinematicModulation:a,breathingModulation:s}=i,o=n*(1+(r-1)*.5)*a*s;return Math.max(.01,Math.min(1,o)).toFixed(3)}modulateSaturationValue(e,i){let n=parseFloat(e),{emotionalModulation:r,beatModulation:a,cinematicModulation:s}=i,o=n*r*a*s;return Math.max(1,Math.min(3,o)).toFixed(2)}onColorsExtracted(e){let{rawColors:i,musicData:n}=e;if(n){let r=this.emotionalMapper.mapMusicToEmotionalTemperature(n);this.updateEmotionalState(r)}}onColorsHarmonized(e){let{processedColors:i,coordinationMetrics:n}=e;if(i.VIBRANT){let r=this.oklabProcessor.processColor(i.VIBRANT,this.cinematicPreset);this.consciousnessState.dynamicAccentHex=r.enhancedHex,this.consciousnessState.dynamicAccentRgb=`${r.enhancedRgb.r},${r.enhancedRgb.g},${r.enhancedRgb.b}`,this.updateGlassColors(r.enhancedHex,r.enhancedHex)}n?.consciousnessLevel!==void 0&&(this.consciousnessState.consciousnessLevel=n.consciousnessLevel)}onMusicBeat(e){let{beat:i,intensity:n,timestamp:r}=e;this.consciousnessState.beatPhase+=Math.PI*2*.5,this.consciousnessState.lastBeatTime=r||Date.now(),n>.8&&this.currentIntensity!=="disabled"&&this.applyBeatSyncGlassPulse(n)}onCinematicDramaEvent(e){let{intensity:i,type:n}=e;this.consciousnessState.cinematicDramaLevel=i,i>.7&&this.currentIntensity!=="disabled"&&this.applyDramaticGlassDistortion(i)}updateEmotionalState(e){switch(this.consciousnessState.currentEmotion=e.primaryEmotion,this.consciousnessState.emotionalIntensity=e.intensity,e.primaryEmotion){case"energetic":case"aggressive":this.consciousnessState.breathingRate=1.5,this.cinematicPreset=M.getPreset("COSMIC");break;case"calm":case"ambient":this.consciousnessState.breathingRate=.7,this.cinematicPreset=M.getPreset("SUBTLE");break;default:this.consciousnessState.breathingRate=1,this.cinematicPreset=M.getPreset("STANDARD")}}applyBeatSyncGlassPulse(e){if(!this.cssBatcher||!!1)return;let n=this.getIntensityValue(this.currentIntensity),r=e*2*(n.opacity*10),a=e*.05*n.opacity;this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-blur",`${r}px`),this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-opacity",a.toString()),setTimeout(()=>{this.cssBatcher&&(this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-blur","0px"),this.cssBatcher.queueCSSVariableUpdate("--glass-beat-pulse-opacity","0"))},150)}applyDramaticGlassDistortion(e){if(!this.cssBatcher)return;let i=e*4,n=1+e*.5;this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-blur",`${i}px`),this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-saturation",n.toString()),setTimeout(()=>{this.cssBatcher&&(this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-blur","0px"),this.cssBatcher.queueCSSVariableUpdate("--glass-dramatic-saturation","1"))},1200)}updateDynamicAccentColor(){let e=document.documentElement,i=getComputedStyle(e),n=i.getPropertyValue("--sn-dynamic-accent-hex").trim()||i.getPropertyValue("--sn-color-accent-hex").trim()||i.getPropertyValue("--spice-accent").trim(),r=i.getPropertyValue("--sn-dynamic-accent-rgb").trim()||i.getPropertyValue("--sn-color-accent-rgb").trim()||i.getPropertyValue("--spice-rgb-accent").trim();n&&n!==""&&(this.consciousnessState.dynamicAccentHex=n),r&&r!==""&&(this.consciousnessState.dynamicAccentRgb=r)}getConsciousnessState(){return{...this.consciousnessState}}setQualityLevel(e){this.adjustQuality(e)}adjustQuality(e){this.currentQualityLevel=e;let i;switch(e){case"low":i="minimal";break;case"medium":i="balanced";break;case"high":i="intense";break;default:i="balanced";break}this.applyGlassmorphismSettings(i),console.log(`[GlassmorphismManager] Quality level set to: ${e} (intensity: ${i})`)}getPerformanceImpact(){let e=this.currentIntensity==="disabled"?0:this.currentIntensity==="minimal"?.1:this.currentIntensity==="balanced"?.3:this.currentIntensity==="intense"?.5:.2,i=this.consciousnessState.consciousnessLevel*.1,n=this.consciousnessState.breathingRate>1?.05:0;return{fps:60,frameTime:e+i+n,memoryUsage:e*2,cpuUsage:(e+i)*50}}reduceQuality(e){if(this.currentQualityLevel){if(this.consciousnessState.consciousnessLevel=Math.max(.1,this.consciousnessState.consciousnessLevel-e),this.consciousnessState.breathingRate=Math.max(.5,this.consciousnessState.breathingRate-e*.5),e>.5)switch(this.currentIntensity){case"intense":this.applyGlassmorphismSettings("balanced");break;case"balanced":this.applyGlassmorphismSettings("minimal");break;case"minimal":this.applyGlassmorphismSettings("disabled");break}console.log(`[GlassmorphismManager] Quality reduced by ${e}`)}}increaseQuality(e){if(this.currentQualityLevel){if(this.consciousnessState.consciousnessLevel=Math.min(1,this.consciousnessState.consciousnessLevel+e),this.consciousnessState.breathingRate=Math.min(2,this.consciousnessState.breathingRate+e*.5),e>.5)switch(this.currentIntensity){case"disabled":this.applyGlassmorphismSettings("minimal");break;case"minimal":this.applyGlassmorphismSettings("balanced");break;case"balanced":this.applyGlassmorphismSettings("intense");break}console.log(`[GlassmorphismManager] Quality increased by ${e}`)}}getQualityCapabilities(){return this.qualityCapabilities.length===0&&(this.qualityCapabilities=[{name:"Backdrop Filter Blur",enabled:this.isSupported&&this.currentIntensity!=="disabled",qualityLevel:"high"},{name:"Glass Saturation",enabled:this.currentIntensity!=="disabled",qualityLevel:"low"},{name:"Consciousness Breathing",enabled:!0,qualityLevel:"low"},{name:"Beat Sync Pulse",enabled:!0,qualityLevel:"low"},{name:"Dramatic Distortion",enabled:!0,qualityLevel:"medium"}]),this.qualityCapabilities}async refreshColorState(e){try{if(this.updateDynamicAccentColor(),this.consciousnessState.dynamicAccentHex){let i=this.oklabProcessor.processColor(this.consciousnessState.dynamicAccentHex,this.cinematicPreset);this.consciousnessState.dynamicAccentHex=i.enhancedHex,this.consciousnessState.dynamicAccentRgb=`${i.enhancedRgb.r},${i.enhancedRgb.g},${i.enhancedRgb.b}`,this.updateGlassColors(i.enhancedHex,i.enhancedHex)}console.log(`[GlassmorphismManager] Color state refreshed for trigger: ${e}`)}catch(i){console.error("[GlassmorphismManager] Error refreshing color state:",i)}}onConsciousnessCoordination(e){return this.consciousnessCoordinationCallbacks.add(e),()=>{this.consciousnessCoordinationCallbacks.delete(e)}}synchronizeConsciousnessState(e){e.currentEmotion&&(this.consciousnessState.currentEmotion=e.currentEmotion),e.emotionalIntensity!==void 0&&(this.consciousnessState.emotionalIntensity=e.emotionalIntensity),e.beatPhase!==void 0&&(this.consciousnessState.beatPhase=e.beatPhase),e.cinematicDramaLevel!==void 0&&(this.consciousnessState.cinematicDramaLevel=e.cinematicDramaLevel),e.consciousnessLevel!==void 0&&(this.consciousnessState.consciousnessLevel=e.consciousnessLevel),e.dynamicAccentHex&&(this.consciousnessState.dynamicAccentHex=e.dynamicAccentHex),e.dynamicAccentRgb&&(this.consciousnessState.dynamicAccentRgb=e.dynamicAccentRgb),e.genreStyle&&(this.consciousnessState.genreStyle=e.genreStyle),e.breathingRate!==void 0&&(this.consciousnessState.breathingRate=e.breathingRate),this.updateGlassVariables(this.currentIntensity),this.broadcastConsciousnessState()}broadcastConsciousnessState(){this.consciousnessCoordinationCallbacks.forEach(e=>{try{e(this.consciousnessState)}catch(i){console.error("[GlassmorphismManager] Error in consciousness coordination callback:",i)}})}updateEmotionalStateWithCoordination(e){this.updateEmotionalState(e),this.broadcastConsciousnessState(),g.emit("consciousness:coordination",{source:"GlassmorphismManager",state:this.consciousnessState,timestamp:Date.now()})}onMusicBeatWithCoordination(e){this.onMusicBeat(e),this.broadcastConsciousnessState(),g.subscribe("consciousness:beat-sync",i=>{i.source!=="GlassmorphismManager"&&(this.consciousnessState.beatPhase=i.beatPhase,this.consciousnessState.lastBeatTime=i.lastBeatTime)},"GlassmorphismManager")}onCinematicDramaEventWithCoordination(e){this.onCinematicDramaEvent(e),this.broadcastConsciousnessState(),g.subscribe("consciousness:dramatic-sync",i=>{i.source!=="GlassmorphismManager"&&(this.consciousnessState.cinematicDramaLevel=i.dramaticLevel,i.dramaticLevel>.7&&this.applyDramaticGlassDistortion(i.dramaticLevel))},"GlassmorphismManager")}initializeCrossSystemCoordination(){try{g.subscribe("consciousness:coordination",e=>{e.source!=="GlassmorphismManager"&&this.synchronizeConsciousnessState(e.state)},"GlassmorphismManager"),g.subscribe("consciousness:beat-sync",e=>{e.source!=="GlassmorphismManager"&&(this.consciousnessState.beatPhase=e.beatPhase,this.consciousnessState.lastBeatTime=e.lastBeatTime,this.applyCoordinatedBeatPulse(e.beatPhase))},"GlassmorphismManager"),g.subscribe("consciousness:dramatic-sync",e=>{e.source!=="GlassmorphismManager"&&(this.consciousnessState.cinematicDramaLevel=e.dramaticLevel,this.applyCoordinatedDramaticEffects(e.dramaticLevel,e.type||"unknown"))},"GlassmorphismManager"),console.log("[GlassmorphismManager] \u2705 Cross-system consciousness coordination initialized")}catch(e){console.error("[GlassmorphismManager] Failed to initialize cross-system coordination:",e)}}checkPerformanceAndAdjust(){this.performanceAnalyzer?.shouldReduceQuality()&&(this.currentIntensity==="intense"?this.applyGlassmorphismSettings("balanced"):(this.currentIntensity==="balanced"||this.currentIntensity==="moderate")&&this.applyGlassmorphismSettings("minimal"))}applyGlassmorphism(e){let i=this.config.glassmorphism[e];this.cssBatcher&&(this.cssBatcher.queueCSSVariableUpdate("--sn-glass-display",e==="disabled"?"none":"block"),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-blur",`${i.blur}px`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-saturation",`${i.saturation}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-brightness",`${i.brightness}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-noise-opacity",`${i.noiseOpacity}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-border-opacity",`${i.borderOpacity}`),this.cssBatcher.queueCSSVariableUpdate("--sn-glass-shadow-opacity",`${i.shadowOpacity}`),this.cssBatcher.flushCSSVariableBatch(),this.config.enableDebug&&console.log(`\u{1F48E} [GlassmorphismManager] Applied level: ${e}`))}applyUpdatedSettings(e,i){e==="sn-glassmorphism-level"&&(this.applyGlassmorphismSettings(i),this.updateGlassVariables(this.currentIntensity))}applyCoordinatedBeatPulse(e){let i=this.calculateConsciousnessModulations(),n=this.getIntensityValue(this.currentIntensity),r=1+Math.sin(e)*.15*i.beatModulation,a=n.opacity*r;this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-opacity",a.toString()),this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-accent-opacity",(a*.8).toString()),this.cssBatcher?.flushCSSVariableBatch()}applyCoordinatedDramaticEffects(e,i){let n=this.calculateConsciousnessModulations(),r=this.getIntensityValue(this.currentIntensity),a=1+e*.4,s=Math.min(1,r.opacity*a),o=Math.min(20,r.blur*(1+e*.3));this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-opacity",s.toString()),this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-blur",`${o}px`),this.cssBatcher?.queueCSSVariableUpdate("--sn-glass-accent-opacity",(s*.9).toString()),this.cssBatcher?.flushCSSVariableBatch(),setTimeout(()=>{this.updateGlassVariables(this.currentIntensity)},1500)}getIntensityValue(e){switch(e){case"disabled":return{opacity:0,blur:0,saturation:1};case"minimal":return{opacity:.05,blur:3,saturation:1.05};case"balanced":return{opacity:.1,blur:6,saturation:1.2};case"intense":return{opacity:.15,blur:8,saturation:1.4};case"moderate":return{opacity:.08,blur:5,saturation:1.15};default:return{opacity:.1,blur:6,saturation:1.2}}}}});var re,mt=y(()=>{"use strict";N();D();Kn();Zn();U();re=class{constructor(t=w){this.initialized=!1;this.destroyed=!1;this.eventUnsubscribers=[];this.initializationStartTime=null;this.frameStartTime=0;this.frameCount=0;this.lastFPSCalculation=0;this.currentFPS=60;this.config=t,this.systemName=this.constructor.name,this.config.enableDebug&&console.log(`[${this.systemName}] UnifiedSystemBase constructor`)}async _baseInitialize(){if(this.initialized){this.config.enableDebug&&console.warn(`[${this.systemName}] Already initialized`);return}try{this.initializationStartTime=performance.now(),this.config.enableDebug&&console.log(`[${this.systemName}] Starting unified initialization`);let t=globalThis.year3000System;if(t?(this.performanceAnalyzer=t.performanceAnalyzer||t.facadeCoordinator?.getCachedNonVisualSystem?.("SimplePerformanceCoordinator")||t.facadeCoordinator?.getCachedNonVisualSystem?.("PerformanceAnalyzer"),this.cssConsciousnessController=t.cssConsciousnessController||T(),this.eventBus=g,this.performanceCoordinator=t.performanceCoordinator||(this.performanceAnalyzer?Ze.getInstance(this.config,this.performanceAnalyzer):null),this.animationCoordinator=t.enhancedMasterAnimationCoordinator||(this.performanceCoordinator?Fe.getInstance(this.config,this.performanceCoordinator):null),this.unifiedCSSManager=t.unifiedCSSManager||T()):(this.cssConsciousnessController=T(),this.eventBus=g,this.performanceCoordinator=Ze.getInstance(this.config,this.performanceAnalyzer),this.animationCoordinator=Fe.getInstance(this.config,this.performanceCoordinator),this.unifiedCSSManager=T()),this.unifiedCSSManager&&this.performanceAnalyzer&&this.cssConsciousnessController,this.performanceAnalyzer&&typeof this.performanceAnalyzer.recordMetric=="function"&&this.performanceAnalyzer.recordMetric(`${this.systemName}_registered`,1),await this.trackPerformanceAsync("initialize",async()=>{await this._performSystemSpecificInitialization()}),this.initialized=!0,this.publishEvent("system:initialized",{systemName:this.systemName,timestamp:Date.now(),metadata:{initializationTime:this.initializationStartTime?performance.now()-this.initializationStartTime:0}}),this.config.enableDebug){let e=this.initializationStartTime?performance.now()-this.initializationStartTime:0;console.log(`[${this.systemName}] Unified initialization complete (${e.toFixed(2)}ms)`)}}catch(t){throw console.error(`[${this.systemName}] Initialization failed:`,t),this.publishEvent("system:initialization-failed",{systemName:this.systemName,error:t instanceof Error?t.message:String(t),timestamp:Date.now()}),t}}_baseDestroy(){if(this.destroyed){this.config.enableDebug&&console.warn(`[${this.systemName}] Already destroyed`);return}try{this.config.enableDebug&&console.log(`[${this.systemName}] Starting unified destruction`),this.eventUnsubscribers.forEach(t=>{try{t()}catch(e){console.warn(`[${this.systemName}] Error during event unsubscription:`,e)}}),this.eventUnsubscribers=[],this.performanceAnalyzer&&typeof this.performanceAnalyzer.recordMetric=="function"&&this.performanceAnalyzer.recordMetric(`${this.systemName}_unregistered`,1),this.destroy(),this.destroyed=!0,this.publishEvent("system:destroyed",{systemName:this.systemName,timestamp:Date.now()}),this.config.enableDebug&&console.log(`[${this.systemName}] Unified destruction complete`)}catch(t){console.error(`[${this.systemName}] Destruction failed:`,t)}}updateCSSVariable(t,e,i="normal"){this.unifiedCSSManager?this.unifiedCSSManager.queueUpdate(t,e,i,this.systemName):this.cssConsciousnessController?this.cssConsciousnessController.queueCSSVariableUpdate(t,e):console.warn(`[${this.systemName}] CSS variable management not initialized`)}updateCSSVariables(t,e="normal"){this.unifiedCSSManager?this.unifiedCSSManager.queueTransaction(t,e,this.systemName):this.cssConsciousnessController?Object.entries(t).forEach(([i,n])=>{this.cssConsciousnessController.queueCSSVariableUpdate(i,n)}):console.warn(`[${this.systemName}] CSS variable management not initialized`)}subscribeToEvent(t,e){if(!this.eventBus){console.warn(`[${this.systemName}] Event bus not initialized - attempting to initialize`);try{if(this.eventBus=g,!this.eventBus)return console.error(`[${this.systemName}] Failed to get unified event bus - event subscription deferred`),()=>{}}catch(i){return console.error(`[${this.systemName}] Error accessing unified event bus:`,i),()=>{}}}try{let i=this.eventBus.subscribe(t,e,this.systemName),n=()=>{this.eventBus.unsubscribe(i)};return this.eventUnsubscribers.push(n),n}catch(i){return console.error(`[${this.systemName}] Failed to subscribe to event ${t}:`,i),()=>{}}}publishEvent(t,e){if(!this.eventBus){console.warn(`[${this.systemName}] Event bus not initialized - attempting to initialize`);try{if(this.eventBus=g,!this.eventBus){console.error(`[${this.systemName}] Failed to get unified event bus - event publication skipped`);return}}catch(i){console.error(`[${this.systemName}] Error accessing unified event bus:`,i);return}}try{this.eventBus.emitSync(t,e)}catch(i){console.error(`[${this.systemName}] Failed to publish event ${t}:`,i)}}trackPerformance(t,e){let i=performance.now();try{e()}finally{let r=performance.now()-i;this.trackSystemPerformance(r),this.performanceAnalyzer&&typeof this.performanceAnalyzer.timeOperation=="function"&&this.performanceAnalyzer.recordMetric(`${this.systemName}_${t}`,r)}}async trackPerformanceAsync(t,e){if(!this.performanceAnalyzer||typeof this.performanceAnalyzer.timeOperationAsync!="function"){await e();return}await this.performanceAnalyzer.timeOperationAsync(`${this.systemName}_${t}`,e)}trackSystemPerformance(t){if(!this.performanceCoordinator)return;this.frameCount++;let e=performance.now();e-this.lastFPSCalculation>=1e3&&(this.currentFPS=this.frameCount,this.frameCount=0,this.lastFPSCalculation=e);let i=performance.memory?.usedJSHeapSize||0;this.performanceCoordinator.trackSubsystem(this.systemName,{frameTime:t,memoryUsage:i,fps:this.currentFPS,cpuUsage:t>16.67?Math.min(100,t/16.67*5):0})}registerAnimation(t=60){if(!this.animationCoordinator){console.warn(`[${this.systemName}] Animation coordinator not initialized, attempting lazy initialization`);try{this.animationCoordinator=Fe.getInstance(this.config,this.performanceCoordinator)}catch(e){console.error(`[${this.systemName}] Failed to initialize animation coordinator:`,e);return}}try{this.animationCoordinator.registerAnimationSystem(this.systemName,this,"normal",t),this.config.enableDebug&&console.log(`[${this.systemName}] Successfully registered with animation coordinator`)}catch(e){console.error(`[${this.systemName}] Failed to register with animation coordinator:`,e)}}forceRepaint(t){this.config.enableDebug&&console.log(`[${this.systemName}] Force repaint: ${t||"unknown"}`),this.unifiedCSSManager&&this.unifiedCSSManager.forceFlush(),document.documentElement.style.transform="translateZ(0)",requestAnimationFrame(()=>{document.documentElement.style.transform=""})}get isInitialized(){return this.initialized}get isDestroyed(){return this.destroyed}get name(){return this.systemName}get systemConfig(){return this.config}registerCSSVariableGroup(t,e="normal"){this.unifiedCSSManager&&this.unifiedCSSManager.registerVariableGroup(`${this.systemName}-${t}`,e)}updateCSSVariableGroup(t,e){this.unifiedCSSManager?this.unifiedCSSManager.updateVariableGroup(`${this.systemName}-${t}`,e,this.systemName):this.updateCSSVariables(e)}updateAnimation(t){this.onAnimate(t)}async _performSystemSpecificInitialization(){}_performSystemSpecificCleanup(){this.destroy()}}});var wi,ss=y(()=>{"use strict";mt();U();wi=class extends re{constructor(e=w){super(e);this.interactionPatterns=new Map;this.proximityObserver=null;this.interactionElements=new Map;this.activeDisturbances=[];this.animationPhase=0;this.lastUpdateTime=0;this.localFrameCount=0;this.musicBeatIntensity=0;this.musicEnergyLevel=0;this.cursorPosition={x:0,y:0};this.cursorVelocity={x:0,y:0};this.lastCursorUpdate=0;this.MAX_FLOW_VECTORS=50;this.DISTURBANCE_DECAY_RATE=.05;this.PROXIMITY_THRESHOLD=100;this.INTERACTION_COOLDOWN=16;this.FLOW_LERP=.08;this.VISCOSITY_LERP=.12;this.INTENSITY_LERP=.15;this.flowState={direction:"radial",intensity:.3,velocity:50,viscosity:.7,flowField:[]},this.liquidConsciousnessState={globalFlowIntensity:0,dominantFlowDirection:0,interactionCount:0,lastInteractionTime:0,proximityElements:[]},this.initializeFlowField(),e.enableDebug&&console.log(`[${this.systemName}] Initialized liquid consciousness flow system`)}async initialize(){this.config.enableDebug&&console.log(`[${this.systemName}] Initializing liquid consciousness interactions`),this.initializeInteractionPatterns(),this.setupProximityDetection(),this.setupCursorTracking(),this.subscribeToEvent("music:beat",e=>{this.musicBeatIntensity=e.intensity,this.updateMusicFlowEffects()}),this.subscribeToEvent("music:energy",e=>{this.musicEnergyLevel=e.energy,this.updateMusicFlowEffects()}),this.subscribeToEvent("sidebar:bilateral-beat",e=>{this.handleBilateralFlowSync(e)}),this.subscribeToEvent("sidebar:consciousness-level-changed",e=>{this.handleConsciousnessFlowChange(e)}),this.subscribeToEvent("sidebar:interaction",e=>{this.handleInteractionTrigger(e)}),this.registerAnimation(50),this.initializeFlowCSSVariables(),this.publishEvent("sidebar:interactive-flow-ready",{systemName:this.systemName,flowPatterns:this.interactionPatterns.size,proximityThreshold:this.PROXIMITY_THRESHOLD,timestamp:Date.now()})}initializeFlowField(){this.flowState.flowField=[];let e=8,i=20;for(let n=0;n<e;n++)for(let r=0;r<e;r++){let a={x:n*i,y:r*i,magnitude:.5+Math.random()*.5,direction:Math.random()*Math.PI*2,influence:.3+Math.random()*.4};this.flowState.flowField.push(a)}}initializeInteractionPatterns(){this.interactionPatterns.set("hover",{id:"hover",type:"hover",response:{intensityChange:.2,velocityChange:.1,viscosityChange:-.1,flowFieldDisturbance:[{center:{x:0,y:0},radius:30,strength:.3,decay:.05,type:"wave"}],rippleEffect:!1,glowEffect:!0},duration:300,easing:"liquid",priority:3}),this.interactionPatterns.set("click",{id:"click",type:"click",response:{intensityChange:.5,velocityChange:.3,viscosityChange:-.2,flowFieldDisturbance:[{center:{x:0,y:0},radius:50,strength:.7,decay:.08,type:"pulse"}],rippleEffect:!1,glowEffect:!0},duration:500,easing:"liquid",priority:8}),this.interactionPatterns.set("focus",{id:"focus",type:"focus",response:{intensityChange:.3,velocityChange:.05,viscosityChange:.1,flowFieldDisturbance:[{center:{x:0,y:0},radius:40,strength:.4,decay:.02,type:"spiral"}],rippleEffect:!1,glowEffect:!0},duration:1e3,easing:"liquid",priority:6}),this.interactionPatterns.set("proximity",{id:"proximity",type:"proximity",response:{intensityChange:.1,velocityChange:.05,viscosityChange:-.05,flowFieldDisturbance:[{center:{x:0,y:0},radius:20,strength:.2,decay:.03,type:"wave"}],rippleEffect:!1,glowEffect:!1},duration:200,easing:"liquid",priority:2}),this.interactionPatterns.set("gesture",{id:"gesture",type:"gesture",response:{intensityChange:.4,velocityChange:.2,viscosityChange:-.15,flowFieldDisturbance:[{center:{x:0,y:0},radius:60,strength:.6,decay:.06,type:"vortex"}],rippleEffect:!1,glowEffect:!0},duration:400,easing:"liquid",priority:7})}setupProximityDetection(){typeof IntersectionObserver<"u"&&(this.proximityObserver=new IntersectionObserver(e=>{e.forEach(i=>{let n=i.target,r=n.id||n.className;i.isIntersecting?(this.interactionElements.set(r,n),this.handleProximityEnter(n)):(this.interactionElements.delete(r),this.handleProximityExit(n))})},{threshold:[0,.1,.5,1],rootMargin:`${this.PROXIMITY_THRESHOLD}px`}),this.observeSidebarElements())}setupCursorTracking(){this.config.enableDebug&&setInterval(()=>{this.simulateCursorMovement()},50)}observeSidebarElements(){this.config.enableDebug&&console.log(`[${this.systemName}] Observing sidebar elements for proximity`)}handleInteractionTrigger(e){let i=this.interactionPatterns.get(e.type);if(!i)return;let n=Date.now();n-this.liquidConsciousnessState.lastInteractionTime<this.INTERACTION_COOLDOWN||(this.liquidConsciousnessState.lastInteractionTime=n,this.liquidConsciousnessState.interactionCount++,this.applyFlowResponse(i.response,e.position),this.updateGlobalFlowState(i),this.publishEvent("sidebar:flow-interaction",{type:e.type,position:e.position,pattern:i.id,timestamp:n}),this.config.enableDebug&&console.log(`[${this.systemName}] Flow interaction: ${e.type} at (${e.position.x}, ${e.position.y})`))}applyFlowResponse(e,i){this.flowState.intensity=Math.max(0,Math.min(1,this.flowState.intensity+e.intensityChange)),this.flowState.velocity=Math.max(0,Math.min(200,this.flowState.velocity+e.velocityChange*50)),this.flowState.viscosity=Math.max(0,Math.min(1,this.flowState.viscosity+e.viscosityChange)),e.flowFieldDisturbance.forEach(n=>{let r={...n,center:i};this.activeDisturbances.push(r)}),this.activeDisturbances.length>10&&(this.activeDisturbances=this.activeDisturbances.slice(-10))}updateGlobalFlowState(e){let i=e.priority/10;this.liquidConsciousnessState.dominantFlowDirection=(this.liquidConsciousnessState.dominantFlowDirection+Math.random()*Math.PI*2)*i,this.liquidConsciousnessState.globalFlowIntensity=Math.max(0,Math.min(1,this.liquidConsciousnessState.globalFlowIntensity+e.response.intensityChange*.5))}handleProximityEnter(e){let i=e.getBoundingClientRect(),n={x:i.left+i.width/2,y:i.top+i.height/2},r=Math.sqrt(Math.pow(n.x-this.cursorPosition.x,2)+Math.pow(n.y-this.cursorPosition.y,2));this.liquidConsciousnessState.proximityElements.push({element:e,distance:r,influence:Math.max(0,1-r/this.PROXIMITY_THRESHOLD)}),this.handleInteractionTrigger({type:"proximity",position:n,element:e,timestamp:Date.now(),proximityData:{distance:r,angle:Math.atan2(n.y-this.cursorPosition.y,n.x-this.cursorPosition.x),velocity:this.cursorVelocity,pressure:.5}})}handleProximityExit(e){this.liquidConsciousnessState.proximityElements=this.liquidConsciousnessState.proximityElements.filter(i=>i.element!==e)}updateMusicFlowEffects(){let e=this.musicBeatIntensity*.3;this.flowState.intensity=Math.max(this.flowState.intensity,e);let i=this.musicEnergyLevel*30;this.flowState.velocity=Math.min(200,this.flowState.velocity+i);let n=(1-this.musicEnergyLevel)*.2;this.flowState.viscosity=Math.max(.1,this.flowState.viscosity-n),this.updateFlowFieldWithMusic()}updateFlowFieldWithMusic(){let e=this.musicBeatIntensity*.5;this.flowState.flowField.forEach(i=>{i.direction+=(Math.random()-.5)*e*.1,i.magnitude=Math.max(.1,Math.min(1,i.magnitude+(this.musicEnergyLevel-.5)*.2))})}handleBilateralFlowSync(e){if(e.source==="left"){let i=e.intensity*.2;this.flowState.intensity=Math.max(this.flowState.intensity,i);let n=e.intensity*.3;this.liquidConsciousnessState.dominantFlowDirection+=n}}handleConsciousnessFlowChange(e){let n={dormant:.1,aware:.3,focused:.6,transcendent:1}[e.newLevel]||.3;this.flowState.intensity=this.lerp(this.flowState.intensity,n,.1);let r=.8-n*.3;this.flowState.viscosity=this.lerp(this.flowState.viscosity,r,.05)}simulateCursorMovement(){if(!this.config.enableDebug)return;let e=Date.now(),i=e-this.lastCursorUpdate,n=e*.001,r=200+Math.sin(n*.5)*100,a=300+Math.cos(n*.3)*80;this.lastCursorUpdate>0&&(this.cursorVelocity.x=(r-this.cursorPosition.x)/i*1e3,this.cursorVelocity.y=(a-this.cursorPosition.y)/i*1e3),this.cursorPosition.x=r,this.cursorPosition.y=a,this.lastCursorUpdate=e}updateFlowDisturbances(){this.activeDisturbances=this.activeDisturbances.filter(e=>(e.strength*=1-e.decay,e.strength>.01)),this.activeDisturbances.forEach(e=>{this.flowState.flowField.forEach(i=>{let n=Math.sqrt(Math.pow(i.x-e.center.x,2)+Math.pow(i.y-e.center.y,2));if(n<e.radius){let r=e.strength*(1-n/e.radius);switch(e.type){case"wave":i.magnitude+=r*.3;break;case"spiral":i.direction+=r*.5;break;case"pulse":i.magnitude+=r*.5,i.direction+=r*.2;break;case"vortex":let a=Math.atan2(i.y-e.center.y,i.x-e.center.x);i.direction=a+r*Math.PI*.5;break}}})})}initializeFlowCSSVariables(){this.updateCSSVariables({"--sn-flow-intensity":this.flowState.intensity.toFixed(3),"--sn-flow-velocity":`${this.flowState.velocity}px`,"--sn-flow-viscosity":this.flowState.viscosity.toFixed(3),"--sn-flow-direction":`${this.liquidConsciousnessState.dominantFlowDirection}rad`,"--sn-flow-global-intensity":this.liquidConsciousnessState.globalFlowIntensity.toFixed(3),"--sn-flow-interaction-count":this.liquidConsciousnessState.interactionCount.toString(),"--sn-flow-proximity-elements":this.liquidConsciousnessState.proximityElements.length.toString(),"--sn-flow-disturbances":this.activeDisturbances.length.toString(),"--sn-flow-music-beat":this.musicBeatIntensity.toFixed(3),"--sn-flow-music-energy":this.musicEnergyLevel.toFixed(3)})}updateFlowCSSVariables(){this.updateCSSVariables({"--sn-flow-intensity":this.flowState.intensity.toFixed(3),"--sn-flow-velocity":`${this.flowState.velocity}px`,"--sn-flow-viscosity":this.flowState.viscosity.toFixed(3),"--sn-flow-direction":`${this.liquidConsciousnessState.dominantFlowDirection}rad`,"--sn-flow-global-intensity":this.liquidConsciousnessState.globalFlowIntensity.toFixed(3)})}lerp(e,i,n){return e+(i-e)*n}onAnimate(e){this.lastUpdateTime=performance.now(),this.animationPhase+=e*.001,this.localFrameCount++,this.updateFlowDisturbances(),this.flowState.intensity=this.lerp(this.flowState.intensity,this.liquidConsciousnessState.globalFlowIntensity,this.INTENSITY_LERP),this.flowState.intensity*=.995,this.flowState.velocity*=.98,this.localFrameCount%10===0&&this.updateFlowFieldNaturalTurbulence(),this.updateProximityElements(),this.updateFlowCSSVariables(),this.updateMusicFlowEffects()}updateFlowFieldNaturalTurbulence(){this.flowState.flowField.forEach(e=>{e.direction+=(Math.random()-.5)*.02,e.magnitude+=(Math.random()-.5)*.01,e.magnitude=Math.max(.1,Math.min(1,e.magnitude))})}updateProximityElements(){this.liquidConsciousnessState.proximityElements.forEach(e=>{let i=e.element.getBoundingClientRect(),n={x:i.left+i.width/2,y:i.top+i.height/2};e.distance=Math.sqrt(Math.pow(n.x-this.cursorPosition.x,2)+Math.pow(n.y-this.cursorPosition.y,2)),e.influence=Math.max(0,1-e.distance/this.PROXIMITY_THRESHOLD)})}getFlowState(){return{...this.flowState}}getLiquidConsciousnessState(){return{...this.liquidConsciousnessState}}getActiveDisturbances(){return[...this.activeDisturbances]}async healthCheck(){return{healthy:!0,ok:!0,details:`Interactive flow system healthy - ${this.interactionPatterns.size} patterns, ${this.activeDisturbances.length} disturbances, ${this.liquidConsciousnessState.interactionCount} interactions`,issues:[],system:"SidebarInteractiveFlowSystem"}}destroy(){this.config.enableDebug&&console.log(`[${this.systemName}] Destroying liquid consciousness flow system`),this.proximityObserver&&(this.proximityObserver.disconnect(),this.proximityObserver=null),this.interactionPatterns.clear(),this.interactionElements.clear(),this.activeDisturbances=[],this.flowState={direction:"radial",intensity:0,velocity:0,viscosity:.5,flowField:[]},this.liquidConsciousnessState={globalFlowIntensity:0,dominantFlowDirection:0,interactionCount:0,lastInteractionTime:0,proximityElements:[]},this.publishEvent("sidebar:interactive-flow-destroyed",{timestamp:Date.now()})}}});function Oe(c,t={}){if(!Ac)return Array.from(document.querySelectorAll(c));let e=tr.get(c),i=e?.ref?.deref();return(t.force||!i)&&(i=Array.from(document.querySelectorAll(c)),e={ref:new WeakRef(i),lastUpdate:Date.now()},tr.set(c,e),Rc?.register(i,c)),i}var tr,Ac,Ic,Rc,os=y(()=>{"use strict";tr=new Map,Ac=typeof WeakRef<"u",Ic=typeof FinalizationRegistry<"u",Rc=Ic?new FinalizationRegistry(c=>{tr.delete(c)}):null});function Tt(c){return Oe(c).length>0}function kc(c,t,e){let i=Oe(c,e);return i.length===0&&t&&(i=Oe(t,e),i.length>0&&console.warn(`\u{1F30C} [SpotifyDOMSelectors] Using legacy selector: ${t}. Consider updating to: ${c}`)),i}function Lc(){console.group("\u{1F30C} [SpotifyDOMSelectors] DOM Validation");let c={found:0,missing:0,details:{}};return Object.entries(k).forEach(([t,e])=>{let i=Tt(e);c.details[t]={selector:e,exists:i,element:i&&Oe(e)[0]||null},i?(c.found++,console.log(`\u2705 ${t}: ${e}`)):(c.missing++,console.warn(`\u274C ${t}: ${e}`))}),console.log(`\u{1F4CA} Summary: ${c.found} found, ${c.missing} missing`),console.groupEnd(),c}function Bc(){console.group("\u{1F30C} [Phase 1] Testing Gravity System Selectors"),console.log("\u{1F3AF} Primary gravity well targets:"),Pt.primary&&Pt.primary.forEach(c=>{let t=Oe(c)[0]||null;console.log(`${t?"\u2705":"\u274C"} ${c}`,t)}),console.log("\u{1F3AF} Secondary gravity well targets:"),Pt.secondary&&Pt.secondary.forEach(c=>{let t=Oe(c)[0]||null;console.log(`${t?"\u2705":"\u274C"} ${c}`,t)}),console.log("\u{1F6F8} Orbital elements:"),Object.entries(ze).forEach(([c,t])=>{let e=Oe(t);console.log(`${e.length>0?"\u2705":"\u274C"} ${c} (${t}): ${e.length} found`)}),console.groupEnd()}function cs(){console.group("\u{1F52E} [SpotifyDOMSelectors] Phase 2 - Prediction Target Validation");let c=[{name:"Track Rows",selector:ze.trackRows},{name:"Progress Bar",selector:k.progressBar},{name:"Play Button",selector:k.playButton},{name:"Heart Button",selector:k.heartButton},{name:"Album Cover",selector:k.albumCover},{name:"Now Playing Widget",selector:k.nowPlayingWidget},{name:"Now Playing Left",selector:k.nowPlayingLeft},{name:"Left Sidebar",selector:k.leftSidebar},{name:"Library Items",selector:ze.libraryItems}],t={found:0,missing:0,details:{}};return c.forEach(({name:e,selector:i})=>{if(!i)return;let r=kc(i).length;t.details[e]={selector:i,count:r,exists:r>0},r>0?(t.found++,console.log(`\u2705 ${e}: ${r} elements found (${i})`)):(t.missing++,console.warn(`\u274C ${e}: No elements found (${i})`))}),console.log(`\u{1F4CA} Prediction Targets Summary: ${t.found} types found, ${t.missing} missing`),console.groupEnd(),t}function Fc(){console.group("\u{1F30C} [SpotifyDOMSelectors] Phase 2 - System Integration Test");let c={behavioralPrediction:cs(),dimensionalNexus:{sidebarElement:k.leftSidebar?Tt(k.leftSidebar):!1},dataGlyph:{navLinks:k.navBarLink?Tt(k.navBarLink):!1,trackRows:ze.trackRows?Tt(ze.trackRows):!1,cards:ze.cards?Tt(ze.cards):!1}},t=0;return Object.values(c).forEach(e=>{typeof e=="object"&&e.missing&&(t+=e.missing)}),console.log(`\u{1F3AF} Phase 2 Integration Health: ${t===0?"\u2705 All systems operational":`\u26A0\uFE0F ${t} issues detected`}`),console.groupEnd(),c}var k,Sg,ze,Pt,Dc,ir=y(()=>{"use strict";os();k={nowPlayingBar:".Root__now-playing-bar",leftSidebar:".Root__nav-bar",mainView:".Root__main-view",rightSidebar:".Root__right-sidebar",nowPlayingWidget:"[data-testid='now-playing-widget']",nowPlayingLeft:".main-nowPlayingBar-left",nowPlayingCenter:".main-nowPlayingBar-center",nowPlayingRight:".main-nowPlayingBar-right",coverArt:".main-coverSlotCollapsed-container",trackInfo:".main-trackInfo-container",navMain:"nav[aria-label='Main']",yourLibrary:".main-yourLibraryX-libraryContainer",libraryItems:".main-yourLibraryX-listItem",libraryHeader:".main-yourLibraryX-header",playlistList:".main-rootlist-wrapper",trackListContainer:"[role='grid'][aria-label*='tracks']",trackRow:".main-trackList-trackListRow",trackListHeader:".main-trackList-trackListHeaderRow",trackNumber:".main-trackList-rowSectionIndex",trackTitle:".main-trackList-rowTitle",trackArtist:".main-trackList-rowSubTitle",entityHeader:".main-entityHeader-container",entityTitle:".main-entityHeader-title",entityMetadata:".main-entityHeader-metaData",entityImage:".main-entityHeader-imageContainer",actionBar:".main-actionBar-ActionBarRow",actionBarInner:".main-actionBar-ActionBar",playButton:"[data-testid='play-button']",pauseButton:"[data-testid='pause-button']",shuffleButton:"[data-testid='shuffle-button']",likeButton:".control-button-heart",queue:".main-queue-trackList",queueContainer:"[aria-label='Next in queue']",aboutArtist:"[aria-label='About the artist']",credits:"[aria-label='Credits']",searchInput:"[data-testid='search-input']",searchPage:"[data-testid='search-container']",filterPills:".main-genre-chip",sortButton:"[data-testid='sort-button']",card:".main-card-card",cardImage:".main-cardImage-image",albumArt:".main-trackList-albumArt",modal:".main-modal-container",overlay:".main-overlay-container"},Sg=Object.entries({".main-nowPlayingWidget-nowPlaying":k.nowPlayingBar,".main-navBar-navBar":k.leftSidebar,".main-search-searchBar":k.searchInput,".main-topBar-topBar":k.actionBar,".main-queue-queue":k.queue,".main-trackList-trackList":k.trackListContainer}).reduce((c,[t,e])=>(typeof e=="string"&&(c[t]=e),c),{}),ze={trackRows:k.trackRow??"",libraryItems:k.libraryItems??"",cards:k.card??"",navLinks:".main-navBar-navBarLink"},Pt={primary:[k.nowPlayingBar,k.leftSidebar,k.entityHeader].filter(c=>!!c),secondary:[k.actionBar,k.queue,k.searchInput].filter(c=>!!c),tertiary:[k.playButton,k.trackListHeader].filter(c=>!!c)},Dc={searchAreas:[k.searchInput,k.searchPage].filter(c=>!!c),notifications:["[data-testid='notification-bar']",".main-topBar-notifications"],dropdowns:[".main-dropdown-menu","[role='menu']","[role='listbox']"]};typeof window<"u"&&(window.SpotifyDOMSelectors={validate:Lc,testGravity:Bc,validatePredictionTargets:cs,testPhase2Systems:Fc,selectors:k,targets:Pt,orbital:ze,antiGravity:Dc},console.log("\u{1F3AF} [SpotifyDOMSelectors] Debug functions available:"),console.log("  window.SpotifyDOMSelectors.validate() - Test all selectors"),console.log("  window.SpotifyDOMSelectors.testGravity() - Test gravity selectors"))});var ls={};ie(ls,{SidebarPerformanceCoordinator:()=>Ue,getSidebarPerformanceCoordinator:()=>Gc});function Gc(c){return Ue.getInstance(c)}var Ee,Ue,Ei=y(()=>{"use strict";N();yi();ir();D();Ee=class Ee{constructor(t={}){this.pendingUpdates=new Map;this.isFlushScheduled=!1;this.rafId=null;this.performanceAnalyzer=null;this.harmonicVariableMap=new Map([["--sn-rs-beat-intensity","--sn-beat-pulse-intensity"],["--sn-rs-glow-alpha","--sn-rhythm-phase"],["--sn-rs-hue-shift","--sn-spectrum-phase"]]);this.flushCount=0;this.totalFlushTime=0;this.lastFlushTimestamp=0;this.budgetManager=null;this.domObserver=null;this.sidebarElement=null;this.visibilityObserver=null;this.observationThrottleTimer=null;this.lastObservationTime=0;this.OBSERVATION_THROTTLE_MS=200;this.isFirstOpen=!0;this.lastScrollUpdate=0;this.activeTimeouts=new Set;this.domObservationRetryTimeout=null;this.musicChangeUnsubscribe=null;this.config={enableDebug:t.enableDebug??!1,maxBatchSize:t.maxBatchSize??50,...t},this.performanceAnalyzer=t.performanceAnalyzer||null;let e=globalThis.year3000System;this.cssController=e?.cssConsciousnessController||T(),this.performanceAnalyzer&&(this.budgetManager=we.getInstance(void 0,this.performanceAnalyzer)),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] Initialized with RAF-based batching")}static getInstance(t){return Ee.instance||(Ee.instance=new Ee(t)),Ee.instance}queueUpdate(t,e){if(["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift"].includes(t)){this.applyCriticalUpdate(t,e);return}try{T().queueCSSVariableUpdate(t,e,this.getSidebarElement())}catch{this.pendingUpdates.set(t,{property:t,value:e,timestamp:performance.now()}),this.config.enableDebug&&this.pendingUpdates.size===1&&console.log(`\u{1F30C} [SidebarPerformanceCoordinator] Queuing first update (fallback): ${t}`),this.scheduleFlush()}}applyCriticalUpdate(t,e){try{this.cssController.setVariable("SidebarPerformanceCoordinator",t,e,"critical","sidebar-critical-update")}catch(i){console.error(`\u{1F30C} [SidebarPerformanceCoordinator] Failed to apply critical ${t}:`,i)}}getSidebarElement(){return this.sidebarElement||(this.sidebarElement=document.querySelector(k.rightSidebar)),this.sidebarElement||document.documentElement}scheduleFlush(){this.isFlushScheduled||(this.isFlushScheduled=!0,this.rafId=requestAnimationFrame(()=>{this.flushUpdates()}))}flushUpdates(){if(this.pendingUpdates.size===0){this.isFlushScheduled=!1;return}let t=performance.now(),e=this.getSidebarElement(),i=this.pendingUpdates.size;this.config.enableDebug&&console.log(`\u{1F30C} [SidebarPerformanceCoordinator] Flushing ${i} updates atomically`),i>(this.config.maxBatchSize||50)&&console.warn(`\u{1F30C} [SidebarPerformanceCoordinator] Large batch detected (${i} updates), may impact performance`);try{let s={},o={};for(let l of this.pendingUpdates.values()){s[l.property]=l.value;let m=this.harmonicVariableMap.get(l.property);m&&(o[m]=l.value,this.config.enableDebug&&console.log(`\u{1F30C} [SidebarPerformanceCoordinator] Mapped ${l.property} \u2192 ${m} = ${l.value}`))}if(Object.keys(s).length>0){let l=e;for(let[m,d]of Object.entries(s))l.style.setProperty(m,d)}Object.keys(o).length>0&&this.cssController.batchSetVariables("SidebarPerformanceCoordinator",o,"high","harmonic-variable-mapping")}catch(s){console.error("\u{1F30C} [SidebarPerformanceCoordinator] Failed to apply batched updates:",s)}if(this.pendingUpdates.clear(),this.isFlushScheduled=!1,this.rafId=null,this.config.onFlushComplete)try{this.config.onFlushComplete()}catch(s){console.error("\u{1F30C} [SidebarPerformanceCoordinator] Error in flush completion callback:",s)}let n=performance.now(),r=n-t;this.flushCount++,this.totalFlushTime+=r,this.lastFlushTimestamp=n,this.performanceAnalyzer&&this.performanceAnalyzer.emitTrace?.(`[SidebarPerformanceCoordinator] Flushed ${i} updates in ${r.toFixed(2)}ms`);let a=this.flushCount>0?this.totalFlushTime/this.flushCount:0;a>3&&console.warn(`\u{1F30C} [SidebarPerformanceCoordinator] Performance threshold exceeded: average ${a.toFixed(2)}ms per flush (target: <3ms)`),this.config.enableDebug&&r>4&&console.warn(`\u{1F30C} [SidebarPerformanceCoordinator] Slow flush detected: ${r.toFixed(2)}ms for ${i} updates`)}setupMusicChangeCoordination(){this.musicChangeUnsubscribe||(this.musicChangeUnsubscribe=()=>{g.unsubscribeAll("SidebarPerformanceCoordinator")},g.subscribe("music:track-changed",t=>{this.handleMusicChange({timestamp:t.timestamp,source:"track-changed",reason:"music:track-changed event"})},"SidebarPerformanceCoordinator"),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] Event-driven music coordination active"))}handleMusicChange(t){this.sidebarElement&&(this.handleVisibilityChange(),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] Music change coordinated via event",{source:t.source,reason:t.reason,timestamp:t.timestamp}))}setupDOMObservation(){if(!this.domObserver){if(this.setupMusicChangeCoordination(),this.sidebarElement=document.querySelector(k.rightSidebar),!this.sidebarElement){this.config.enableDebug&&console.warn("\u{1F30C} [SidebarPerformanceCoordinator] Sidebar not found, deferring DOM observation"),this.domObservationRetryTimeout&&(clearTimeout(this.domObservationRetryTimeout),this.activeTimeouts.delete(this.domObservationRetryTimeout)),this.domObservationRetryTimeout=setTimeout(()=>{this.setupDOMObservation(),this.domObservationRetryTimeout=null},1e3),this.activeTimeouts.add(this.domObservationRetryTimeout);return}this.domObserver=new MutationObserver(t=>{let e=t.filter(i=>this.isRelevantMutation(i));e.length!==0&&this.throttleObservationUpdate(()=>{for(let i of e)i.type==="attributes"&&(i.attributeName==="aria-hidden"||i.attributeName==="style")&&this.handleVisibilityChange();this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] Relevant DOM change detected - visibility/structure only",{mutationCount:e.length,types:e.map(i=>i.type)})})}),this.domObserver.observe(this.sidebarElement,{childList:!0,subtree:!1,attributes:!0,attributeFilter:["aria-hidden","style","class"],attributeOldValue:!1,characterData:!1}),this.setupVisibilityObserver(),this.setupScrollObservation(),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] DOM observation active on sidebar")}}setupVisibilityObserver(){!this.sidebarElement||this.visibilityObserver||(this.visibilityObserver=new IntersectionObserver(t=>{let e=t[0];e&&e.isIntersecting&&this.isFirstOpen&&(window.requestIdleCallback?window.requestIdleCallback(()=>{this.triggerTemporalEcho(),this.isFirstOpen=!1}):setTimeout(()=>{this.triggerTemporalEcho(),this.isFirstOpen=!1},0))},{threshold:.1}),this.visibilityObserver.observe(this.sidebarElement))}setupScrollObservation(){if(!this.sidebarElement)return;let t=this.sidebarElement.querySelector(".main-nowPlayingView-queue");t&&t.addEventListener("scroll",this.throttledScrollHandler.bind(this),{passive:!0})}throttledScrollHandler(){let t=performance.now();t-this.lastScrollUpdate<33||(this.lastScrollUpdate=t,window.requestIdleCallback?window.requestIdleCallback(()=>{this.queueUpdate("--sn-rs-scroll-ratio",Math.random().toString())},{timeout:100}):this.queueUpdate("--sn-rs-scroll-ratio",Math.random().toString()))}isRelevantMutation(t){if(t.type==="attributes"){let e=t.attributeName;return e==="aria-hidden"||e==="style"||e==="class"?!0:(e?.startsWith("--")||e==="data-style",!1)}return t.type==="childList"?t.addedNodes&&Array.from(t.addedNodes).some(i=>i.nodeType===Node.ELEMENT_NODE)||t.removedNodes&&Array.from(t.removedNodes).some(i=>i.nodeType===Node.ELEMENT_NODE):!1}throttleObservationUpdate(t){let e=performance.now();e-this.lastObservationTime<this.OBSERVATION_THROTTLE_MS?(this.observationThrottleTimer&&clearTimeout(this.observationThrottleTimer),this.observationThrottleTimer=window.setTimeout(()=>{t(),this.lastObservationTime=performance.now(),this.observationThrottleTimer=null},this.OBSERVATION_THROTTLE_MS)):(t(),this.lastObservationTime=e)}handleVisibilityChange(){if(!this.sidebarElement)return;let t=!this.sidebarElement.hasAttribute("aria-hidden")&&!this.sidebarElement.style.display?.includes("none");t&&this.isFirstOpen&&(this.triggerTemporalEcho(),this.isFirstOpen=!1),this.config.enableDebug&&console.log(`\u{1F30C} [SidebarPerformanceCoordinator] Visibility changed: ${t?"visible":"hidden"}`)}triggerTemporalEcho(){if(!this.sidebarElement)return;this.sidebarElement.classList.add("sn-future-preview"),this.queueUpdate("--sn-kinetic-intensity","1"),this.queueUpdate("--sn-echo-hue-shift","15deg"),this.queueUpdate("--sn-echo-radius-multiplier","1.2"),this.config.enableDebug&&console.log("\u{1F30C} [SidebarPerformanceCoordinator] Triggering temporal echo effect");let t=setTimeout(()=>{this.sidebarElement?.classList.remove("sn-future-preview"),this.queueUpdate("--sn-kinetic-intensity","0"),this.activeTimeouts.delete(t)},2e3);this.activeTimeouts.add(t)}getPerformanceMetrics(){return{flushCount:this.flushCount,averageFlushTime:this.flushCount>0?this.totalFlushTime/this.flushCount:0,lastFlushTimestamp:this.lastFlushTimestamp,pendingUpdates:this.pendingUpdates.size}}forceFlush(){this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.flushUpdates()}destroy(){if(this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.activeTimeouts.forEach(t=>{clearTimeout(t)}),this.activeTimeouts.clear(),this.domObservationRetryTimeout&&(clearTimeout(this.domObservationRetryTimeout),this.domObservationRetryTimeout=null),this.observationThrottleTimer&&(clearTimeout(this.observationThrottleTimer),this.observationThrottleTimer=null),this.domObserver&&(this.domObserver.disconnect(),this.domObserver=null),this.visibilityObserver&&(this.visibilityObserver.disconnect(),this.visibilityObserver=null),this.musicChangeUnsubscribe&&(this.musicChangeUnsubscribe(),this.musicChangeUnsubscribe=null),this.pendingUpdates.clear(),this.isFlushScheduled=!1,this.sidebarElement=null,Ee.instance===this&&(Ee.instance=null),this.config.enableDebug){let t=this.flushCount>0?this.totalFlushTime/this.flushCount:0;console.log(`\u{1F30C} [SidebarPerformanceCoordinator] Destroyed. Performance: ${this.flushCount} flushes, ${t.toFixed(2)}ms avg`)}}};Ee.instance=null;Ue=Ee});var nr,rr,ar,Pi,us=y(()=>{"use strict";mt();ss();Ei();U();nr=class extends re{async initialize(){console.log("[MockLeftSidebarConsciousnessSystem] Initialized")}destroy(){console.log("[MockLeftSidebarConsciousnessSystem] Destroyed")}onAnimate(t){}async healthCheck(){return{healthy:!0,ok:!0,details:"Mock left sidebar consciousness healthy",issues:[],system:"MockLeftSidebarConsciousnessSystem"}}getConsciousnessState(){return{level:"aware",intensity:.5}}getAnimationMetrics(){return{beatIntensity:.5,explorationLevel:.3}}},rr=class extends re{async initialize(){console.log("[MockRightSidebarConsciousnessSystem] Right sidebar now handled by facade pattern")}destroy(){console.log("[MockRightSidebarConsciousnessSystem] Destroyed")}onAnimate(t){}async healthCheck(){return{healthy:!0,ok:!0,details:"Right sidebar consciousness managed by facade pattern",issues:[],system:"MockRightSidebarConsciousnessSystem"}}getConsciousnessState(){let t=globalThis.year3000System;return t?.sidebarConsciousnessController?t.sidebarConsciousnessController.getConsciousnessState():{level:"aware",intensity:.5}}getAnimationMetrics(){return{beatIntensity:.5,explorationLevel:.3}}},ar=class extends re{constructor(){super(...arguments);this.synchronizationEnabled=!0;this.rightSidebarSystem=null}async initialize(){console.log("[MockSidebarSystemsOrchestrator] Initialized")}destroy(){console.log("[MockSidebarSystemsOrchestrator] Destroyed")}onAnimate(e){}async healthCheck(){return{healthy:!0,ok:!0,details:"Mock sidebar orchestrator healthy",issues:[],system:"MockBilateralSidebarOrchestrator"}}getBilateralState(){return{leftSidebar:{active:!0,level:"aware"},rightSidebar:{active:!!this.rightSidebarSystem,level:"aware"},synchronization:{enabled:this.synchronizationEnabled}}}getPerformanceMetrics(){return{bilateralSyncMetrics:{syncEvents:100,avgSyncLatency:5},performanceMetrics:{totalCSSUpdates:200,avgUpdateTime:2}}}setSynchronizationEnabled(e){this.synchronizationEnabled=e}setRightSidebarSystem(e){this.rightSidebarSystem=e}},Pi=class extends re{constructor(e=w){super(e);this.sidebarSystems=new Map;this.integrationEnabled=!1;this.lastFrameTime=0;this.sharedCoordinator=Ue.getInstance({enableDebug:e.enableDebug,performanceAnalyzer:this.performanceAnalyzer,onFlushComplete:()=>this.handlePerformanceFlush()}),this.leftSidebarConsciousness=new nr(e),this.rightSidebarConsciousness=new rr(e),this.sidebarOrchestrator=new ar(e),this.interactiveFlow=new wi(e),this.performanceMetrics={totalSystems:4,activeSystems:0,bilateralSyncEnabled:!1,averageFrameTime:0,totalMemoryUsage:0,healthStatus:"healthy"},e.enableDebug&&console.log(`[${this.systemName}] Initialized sidebar systems integration`)}async initialize(){this.config.enableDebug&&console.log(`[${this.systemName}] Initializing sidebar systems integration`);try{this.registerSidebarSystems(),await this.registerWithUnifiedRegistry(),await this.initializeSystemsInOrder(),this.setupBilateralCoordination(),this.connectToEventBus(),this.integrateWithPerformanceSystems(),this.registerAnimation(70),this.integrationEnabled=!0,this.updatePerformanceMetrics(),this.publishEvent("sidebar:integration-ready",{systemName:this.systemName,totalSystems:this.sidebarSystems.size,activeSystems:this.performanceMetrics.activeSystems,bilateralSync:this.performanceMetrics.bilateralSyncEnabled,timestamp:Date.now()})}catch(e){throw console.error(`[${this.systemName}] Integration initialization failed:`,e),e}}registerSidebarSystems(){this.sidebarSystems.set("leftSidebarConsciousness",{name:"leftSidebarConsciousness",system:this.leftSidebarConsciousness,priority:"normal",enabled:!0,dependencies:[]}),this.sidebarSystems.set("rightSidebarConsciousness",{name:"rightSidebarConsciousness",system:this.rightSidebarConsciousness,priority:"normal",enabled:!0,dependencies:[]}),this.sidebarSystems.set("sidebarOrchestrator",{name:"sidebarOrchestrator",system:this.sidebarOrchestrator,priority:"critical",enabled:!0,dependencies:["leftSidebarConsciousness","rightSidebarConsciousness"]}),this.sidebarSystems.set("interactiveFlow",{name:"interactiveFlow",system:this.interactiveFlow,priority:"background",enabled:!0,dependencies:["sidebarOrchestrator"]})}async initializeSystemsInOrder(){let e=this.calculateInitializationOrder();for(let i of e){let n=this.sidebarSystems.get(i);if(n&&n.enabled)try{await n.system._baseInitialize(),this.performanceMetrics.activeSystems++,this.config.enableDebug&&console.log(`[${this.systemName}] Initialized ${i}`)}catch(r){console.error(`[${this.systemName}] Failed to initialize ${i}:`,r)}}}calculateInitializationOrder(){let e=new Set,i=new Set,n=[],r=a=>{if(i.has(a))throw new Error(`Circular dependency detected: ${a}`);if(e.has(a))return;i.add(a);let s=this.sidebarSystems.get(a);if(s&&s.dependencies)for(let o of s.dependencies)r(o);i.delete(a),e.add(a),n.push(a)};for(let a of this.sidebarSystems.keys())r(a);return n}setupBilateralCoordination(){this.sidebarOrchestrator.setRightSidebarSystem(this.rightSidebarConsciousness),this.sidebarOrchestrator.setSynchronizationEnabled(!0),this.performanceMetrics.bilateralSyncEnabled=!0,this.subscribeToEvent("sidebar:bilateral-sync",e=>{this.handleBilateralSync(e)}),this.subscribeToEvent("sidebar:consciousness-level-changed",e=>{this.handleConsciousnessChange(e)})}handleBilateralSync(e){e.source==="orchestrator"&&this.updatePerformanceMetrics()}handleConsciousnessChange(e){let n={dormant:.5,aware:.7,focused:.9,transcendent:1}[e.newLevel]||.7;this.adjustPerformanceBudgets(n)}adjustPerformanceBudgets(e){let n=Math.floor(16*e);this.config.enableDebug&&console.log(`[${this.systemName}] Adjusted performance budget to ${n} based on consciousness level`)}handlePerformanceFlush(){let e=performance.now();if(this.lastFrameTime>0){let i=e-this.lastFrameTime;this.performanceMetrics.averageFrameTime=(this.performanceMetrics.averageFrameTime+i)/2}this.lastFrameTime=e,this.updateHealthStatus()}updatePerformanceMetrics(){this.performanceMetrics.totalSystems=this.sidebarSystems.size;let e=0;for(let[,i]of this.sidebarSystems)i.enabled&&i.system.isInitialized&&e++;this.performanceMetrics.activeSystems=e,this.performanceMetrics.bilateralSyncEnabled=this.sidebarOrchestrator.getBilateralState().synchronization.enabled}updateHealthStatus(){this.performanceMetrics.averageFrameTime>20?this.performanceMetrics.healthStatus="critical":this.performanceMetrics.averageFrameTime>16.67?this.performanceMetrics.healthStatus="degraded":this.performanceMetrics.healthStatus="healthy"}onAnimate(e){if(!this.integrationEnabled)return;this.updatePerformanceMetrics(),this.updateHealthStatus(),performance.now()-this.lastFrameTime>1e3&&this.publishEvent("sidebar:integration-metrics",{metrics:this.performanceMetrics,timestamp:Date.now()})}registerWithAnimationCoordinator(e){if(!e){console.warn(`[${this.systemName}] Animation coordinator not available`);return}for(let[i,n]of this.sidebarSystems)if(n.enabled&&n.system.isInitialized)try{e.registerAnimationSystem(i,n.system,n.priority,60),this.config.enableDebug&&console.log(`[${this.systemName}] Registered ${i} with animation coordinator`)}catch(r){console.error(`[${this.systemName}] Failed to register ${i}:`,r)}}getSidebarSystems(){return new Map(this.sidebarSystems)}getPerformanceMetrics(){return{...this.performanceMetrics}}setSidebarSystemEnabled(e,i){let n=this.sidebarSystems.get(e);n&&(n.enabled=i,!i&&n.system.isInitialized?(n.system._baseDestroy(),this.performanceMetrics.activeSystems--):i&&!n.system.isInitialized&&n.system._baseInitialize().catch(r=>{console.error(`[${this.systemName}] Failed to re-enable ${e}:`,r)}),this.publishEvent("sidebar:system-toggled",{systemName:e,enabled:i,timestamp:Date.now()}))}async healthCheck(){let e={};for(let[r,a]of this.sidebarSystems)if(a.enabled&&a.system.isInitialized)try{e[r]=await a.system.healthCheck()}catch(s){e[r]={healthy:!1,ok:!1,details:`Health check failed: ${s.message}`,issues:[`Health check failed: ${s.message}`],system:r}}let i=Object.values(e).filter(r=>!r.ok),n=i.length===0;return{healthy:n,ok:n,details:`Sidebar integration ${n?"healthy":"degraded"} - ${this.performanceMetrics.activeSystems}/${this.performanceMetrics.totalSystems} systems active, bilateral sync: ${this.performanceMetrics.bilateralSyncEnabled}`,issues:i.map(r=>r.details||"Unknown issue"),system:"SidebarSystemsIntegration"}}async registerWithUnifiedRegistry(){this.config.enableDebug&&console.log(`[${this.systemName}] Sidebar systems are now managed by VisualSystemFacade`)}connectToEventBus(){this.subscribeToEvent("music:beat",e=>{this.handleMusicBeat(e)}),this.subscribeToEvent("music:energy",e=>{this.handleMusicEnergy(e)}),this.subscribeToEvent("performance:threshold-exceeded",e=>{this.handlePerformanceThreshold(e)}),this.subscribeToEvent("user:navigation",e=>{this.handleUserNavigation(e)}),this.config.enableDebug&&console.log(`[${this.systemName}] Connected to EventBus for system-wide communication`)}integrateWithPerformanceSystems(){let e=globalThis.year3000System;if(!e){this.config.enableDebug&&console.log(`[${this.systemName}] Year3000System not available, skipping performance integration`);return}try{let i=e.timerConsolidationSystem;i&&(i.registerTimer("sidebar-performance-monitor",1e3,()=>{this.updatePerformanceMetrics()}),this.config.enableDebug&&console.log(`[${this.systemName}] Integrated with TimerConsolidationSystem`));let n=e.enhancedMasterAnimationCoordinator;n&&(n.registerFrameCallback((r,a)=>{this.bilateralConsciousnessFrameUpdate(r,a)},"critical","sidebar-bilateral-consciousness"),this.config.enableDebug&&console.log(`[${this.systemName}] Integrated with EnhancedMasterAnimationCoordinator`))}catch(i){console.error(`[${this.systemName}] Failed to integrate with performance systems:`,i)}}handleMusicBeat(e){if(!this.integrationEnabled)return;let i={intensity:e.intensity||.5,timestamp:e.timestamp||Date.now(),bpm:e.bpm||120};this.sidebarOrchestrator.getBilateralState(),this.config.enableDebug&&console.log(`[${this.systemName}] Processed music beat:`,i)}handleMusicEnergy(e){if(!this.integrationEnabled)return;let i=e.energy||.5;this.adjustPerformanceBudgets(.5+i*.5),this.interactiveFlow.isInitialized&&this.config.enableDebug&&console.log(`[${this.systemName}] Adapted consciousness to energy level: ${i}`)}handlePerformanceThreshold(e){this.integrationEnabled&&(e.severity==="critical"?(this.setSidebarSystemEnabled("interactiveFlow",!1),this.performanceMetrics.healthStatus="critical",this.config.enableDebug&&console.warn(`[${this.systemName}] Activated emergency performance mode`)):e.severity==="warning"&&this.performanceMetrics.healthStatus==="critical"&&(setTimeout(()=>{this.setSidebarSystemEnabled("interactiveFlow",!0)},2e3),this.performanceMetrics.healthStatus="degraded"))}handleUserNavigation(e){if(!this.integrationEnabled)return;let i={action:e.action||"navigate",target:e.target||"unknown",timestamp:e.timestamp||Date.now()};this.config.enableDebug&&console.log(`[${this.systemName}] Processing navigation context:`,i)}bilateralConsciousnessFrameUpdate(e,i){if(!this.integrationEnabled)return;let n=this.leftSidebarConsciousness.getConsciousnessState(),r=this.rightSidebarConsciousness.getConsciousnessState(),a=i,s=i,o={leftLevel:n.level,rightLevel:r.level,timingDelta:Math.abs(a-s),frameTime:e};o.timingDelta>16.67&&this.publishEvent("sidebar:bilateral-desync-warning",{delta:o.timingDelta,frameTime:e,timestamp:i})}destroy(){this.config.enableDebug&&console.log(`[${this.systemName}] Destroying sidebar systems integration`),this.integrationEnabled=!1;let e=globalThis.year3000System;e?.timerConsolidationSystem&&e.timerConsolidationSystem.unregisterTimer("sidebar-performance-monitor");let i=this.calculateInitializationOrder().reverse();for(let n of i){let r=this.sidebarSystems.get(n);if(r&&r.system.isInitialized)try{r.system._baseDestroy(),this.config.enableDebug&&console.log(`[${this.systemName}] Destroyed ${n}`)}catch(a){console.error(`[${this.systemName}] Failed to destroy ${n}:`,a)}}this.sidebarSystems.clear(),this.performanceMetrics={totalSystems:0,activeSystems:0,bilateralSyncEnabled:!1,averageFrameTime:0,totalMemoryUsage:0,healthStatus:"healthy"},this.publishEvent("sidebar:integration-destroyed",{timestamp:Date.now()})}}});var sr,xt,Ti,or=y(()=>{"use strict";sr=class extends Error{constructor(e,i,n,r,a){super(e);this.systemKey=i;this.strategy=n;this.context=r;this.cause=a;this.name="SystemCreationError"}},xt=class extends sr{constructor(e,i,n,r){super(`Missing required dependencies for ${e}: ${n.join(", ")}`,e,i,r);this.missingDependencies=n;this.name="DependencyValidationError"}},Ti=class extends Error{constructor(e,i,n=`No suitable creation strategy found for system: ${e}`){super(n);this.systemKey=e;this.criteria=i;this.name="StrategySelectionError"}}});var At,xi,cr,lr,ur,ms,ds=y(()=>{"use strict";D();A();or();At=class{constructor(){this.systemConfigs=new Map}validateDependencies(t){let e=this.getRequiredDependencies(t.systemKey),i=this.getOptionalDependencies(t.systemKey),n=[],r=[];for(let a of e)(!(a in t.dependencies)||!t.dependencies[a])&&n.push(a);for(let a of i)(!(a in t.dependencies)||!t.dependencies[a])&&r.push(`Optional dependency missing: ${a}`);return{valid:n.length===0,missing:n,warnings:r}}getRequiredDependencies(t){return this.systemConfigs.get(t)?.requiredDependencies||[]}getOptionalDependencies(t){return this.systemConfigs.get(t)?.optionalDependencies||[]}registerSystemConfig(t){this.systemConfigs.set(t.systemKey,t)}createBaseResult(t,e,i,n){let a=performance.now()-i;return{system:t,success:!n&&t!==null,creationTime:a,strategy:this.getStrategyName(),injectedDependencies:Object.keys(e.dependencies),warnings:[],error:n||void 0,metadata:{requiresInitialization:!0,pendingDependencies:[],context:e}}}},xi=class extends At{constructor(){super(),this.registerKnownSystems()}getStrategyName(){return"StandardConstructor"}canCreate(t){let e=this.systemConfigs.get(t.systemKey);return e!==void 0&&!e.creationPreferences.eventDriven}getEstimatedCreationTime(t){return 10}async createSystem(t,e){let i=performance.now();try{let n=this.validateDependencies(e);if(!n.valid&&e.preferences.validateDependencies!==!1)throw new xt(e.systemKey,this.getStrategyName(),n.missing,e);let r=this.getConstructorParameters(e),a=new t(...r),s=this.createBaseResult(a,e,i);return s.warnings=n.warnings,u?.debug?.log("StandardConstructorStrategy",`Created ${e.systemKey}`,{creationTime:s.creationTime,parametersUsed:r.length}),s}catch(n){let r=this.createBaseResult(null,e,i,n);return u?.debug?.error("StandardConstructorStrategy",`Failed to create ${e.systemKey}:`,n),r}}getConstructorParameters(t){let e=this.systemConfigs.get(t.systemKey);if(!e?.constructorMapping)return this.getStandardParameters(t);let i=[],{parameterNames:n,dependencyMapping:r}=e.constructorMapping;for(let a of n)switch(r[a]||a){case"config":i.push(t.config);break;case"utils":i.push(t.utils);break;case"performanceAnalyzer":case"simplePerformanceCoordinator":i.push(t.dependencies.simplePerformanceCoordinator||t.dependencies.performanceAnalyzer);break;case"settingsManager":i.push(t.dependencies.settingsManager);break;case"musicSyncService":i.push(t.dependencies.musicSyncService);break;case"year3000System":i.push(t.dependencies.year3000System);break;case"cssConsciousnessController":i.push(t.dependencies.cssConsciousnessController);break;case"performanceCoordinator":i.push(t.dependencies.performanceCoordinator);break;case"enhancedDeviceTierDetector":i.push(t.dependencies.enhancedDeviceTierDetector);break;case"webglSystemsIntegration":i.push(t.dependencies.webglSystemsIntegration);break;case"deviceCapabilityDetector":i.push(t.dependencies.deviceCapabilityDetector);break;default:i.push(void 0)}return i}getStandardParameters(t){return[t.config,t.utils,t.dependencies.simplePerformanceCoordinator||t.dependencies.performanceAnalyzer,t.dependencies.musicSyncService,t.dependencies.settingsManager,t.dependencies.year3000System]}registerKnownSystems(){this.registerSystemConfig({systemKey:"ColorHarmonyEngine",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerSystemConfig({systemKey:"EnhancedMasterAnimationCoordinator",requiredDependencies:["config","performanceCoordinator"],optionalDependencies:[],constructorMapping:{parameterNames:["config","performanceCoordinator"],dependencyMapping:{config:"config",performanceCoordinator:"performanceCoordinator"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"UnifiedPerformanceCoordinator",requiredDependencies:["config"],optionalDependencies:["simplePerformanceCoordinator"],constructorMapping:{parameterNames:["config","simplePerformanceCoordinator"],dependencyMapping:{config:"config",simplePerformanceCoordinator:"simplePerformanceCoordinator"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}});let t=["DeviceCapabilityDetector","SettingsManager"];for(let e of t)this.registerSystemConfig({systemKey:e,requiredDependencies:[],optionalDependencies:[],constructorMapping:{parameterNames:[],dependencyMapping:{}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}});this.registerSystemConfig({systemKey:"TimerConsolidationSystem",requiredDependencies:[],optionalDependencies:[],constructorMapping:{parameterNames:[],dependencyMapping:{}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"GlassmorphismManager",requiredDependencies:["config","utils","cssConsciousnessController","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","cssConsciousnessController","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",cssConsciousnessController:"cssConsciousnessController",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"Card3DManager",requiredDependencies:["simplePerformanceCoordinator","settingsManager","utils"],optionalDependencies:[],constructorMapping:{parameterNames:["simplePerformanceCoordinator","settingsManager","utils"],dependencyMapping:{simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager",utils:"utils"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"UnifiedCSSVariableManager",requiredDependencies:["config","performanceCoordinator"],optionalDependencies:[],constructorMapping:{parameterNames:["config","performanceCoordinator"],dependencyMapping:{config:"config",performanceCoordinator:"performanceCoordinator"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"SidebarSystemsIntegration",requiredDependencies:["cssConsciousnessController"],optionalDependencies:[],constructorMapping:{parameterNames:["cssConsciousnessController"],dependencyMapping:{cssConsciousnessController:"cssConsciousnessController"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"UnifiedSystemIntegration",requiredDependencies:["year3000System"],optionalDependencies:[],constructorMapping:{parameterNames:["year3000System"],dependencyMapping:{year3000System:"year3000System"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"GenreGradientEvolution",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerSystemConfig({systemKey:"MusicEmotionAnalyzer",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerNewSimplifiedSystems()}registerNewSimplifiedSystems(){this.registerSystemConfig({systemKey:"SimplePerformanceCoordinator",requiredDependencies:["enhancedDeviceTierDetector","webglSystemsIntegration"],optionalDependencies:[],constructorMapping:{parameterNames:["enhancedDeviceTierDetector","webglSystemsIntegration"],dependencyMapping:{enhancedDeviceTierDetector:"enhancedDeviceTierDetector",webglSystemsIntegration:"webglSystemsIntegration"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"SimpleTierBasedPerformanceSystem",requiredDependencies:["enhancedDeviceTierDetector"],optionalDependencies:[],constructorMapping:{parameterNames:["enhancedDeviceTierDetector"],dependencyMapping:{enhancedDeviceTierDetector:"enhancedDeviceTierDetector"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"EnhancedDeviceTierDetector",requiredDependencies:[],optionalDependencies:[],constructorMapping:{parameterNames:[],dependencyMapping:{}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}}),this.registerSystemConfig({systemKey:"WebGLSystemsIntegration",requiredDependencies:["deviceCapabilityDetector"],optionalDependencies:[],constructorMapping:{parameterNames:["deviceCapabilityDetector"],dependencyMapping:{deviceCapabilityDetector:"deviceCapabilityDetector"}},creationPreferences:{useSingleton:!0,lazyInit:!1,eventDriven:!1,builderPattern:!1}})}},cr=class extends At{constructor(){super(),this.registerEventDrivenSystems()}getStrategyName(){return"EventDriven"}canCreate(t){return this.systemConfigs.get(t.systemKey)?.creationPreferences.eventDriven===!0}getEstimatedCreationTime(t){return 50}async createSystem(t,e){let i=performance.now();try{let r=await new xi().createSystem(t,e);if(!r.success)return r;this.setupEventSubscriptions(r.system,e);let a=this.createBaseResult(r.system,e,i);return a.warnings=r.warnings,u?.debug?.log("EventDrivenCreationStrategy",`Created ${e.systemKey} with event subscriptions`),a}catch(n){let r=this.createBaseResult(null,e,i,n);return u?.debug?.error("EventDrivenCreationStrategy",`Failed to create ${e.systemKey}:`,n),r}}setupEventSubscriptions(t,e){let i=this.getEventSubscriptions(e.systemKey);for(let n of i){let r=this.mapEventType(n);typeof t.handleEvent=="function"?g.subscribe(r,a=>{t.handleEvent(a)},`SystemCreation-${e.systemKey}`):typeof t.handleColorExtraction=="function"&&(n==="colors/extracted"||r==="colors:extracted")&&g.subscribe(r,t.handleColorExtraction.bind(t),`SystemCreation-${e.systemKey}`)}u?.debug?.log("EventDrivenCreationStrategy",`Setup event subscriptions for ${e.systemKey}:`,i)}mapEventType(t){return{"colors/extracted":"colors:extracted","colors/harmonized":"colors:harmonized","music/beat":"music:beat","music/energy":"music:energy","music/track-changed":"music:track-changed","performance/mode-changed":"performance:tier-changed","performance/thermal-warning":"performance:frame","settings/changed":"settings:changed"}[t]||t}getEventSubscriptions(t){return{ColorHarmonyEngine:["colors:extracted","music:track-changed"],GenreGradientEvolution:["music:beat","music:energy","music:track-changed"],MusicEmotionAnalyzer:["music:beat","music:energy","music:track-changed"]}[t]||[]}registerEventDrivenSystems(){this.registerSystemConfig({systemKey:"ColorHarmonyEngine",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerSystemConfig({systemKey:"GenreGradientEvolution",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}}),this.registerSystemConfig({systemKey:"MusicEmotionAnalyzer",requiredDependencies:["config","utils","simplePerformanceCoordinator","settingsManager"],optionalDependencies:[],constructorMapping:{parameterNames:["config","utils","simplePerformanceCoordinator","settingsManager"],dependencyMapping:{config:"config",utils:"utils",simplePerformanceCoordinator:"simplePerformanceCoordinator",settingsManager:"settingsManager"}},creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}})}},lr=class extends At{constructor(){super(),this.registerObjectDependencySystems()}getStrategyName(){return"ObjectDependencies"}canCreate(t){return t.systemKey==="MusicSyncService"}getEstimatedCreationTime(t){return 30}async createSystem(t,e){let i=performance.now();try{let n=this.validateDependencies(e);if(!n.valid&&e.preferences.validateDependencies!==!1)throw new xt(e.systemKey,this.getStrategyName(),n.missing,e);let r={YEAR3000_CONFIG:e.config,Year3000Utilities:e.utils,settingsManager:e.dependencies.settingsManager,year3000System:e.dependencies.year3000System},a=new t(r),s=this.createBaseResult(a,e,i);return s.warnings=n.warnings,s.metadata.pendingDependencies=[],u?.debug?.log("ObjectDependenciesStrategy",`Created ${e.systemKey} with event-driven dependencies`),s}catch(n){let r=this.createBaseResult(null,e,i,n);return u?.debug?.error("ObjectDependenciesStrategy",`Failed to create ${e.systemKey}:`,n),r}}registerObjectDependencySystems(){this.registerSystemConfig({systemKey:"MusicSyncService",requiredDependencies:["config","utils"],optionalDependencies:["settingsManager","year3000System"],creationPreferences:{useSingleton:!1,lazyInit:!1,eventDriven:!0,builderPattern:!1}})}},ur=class{constructor(){this.strategies=new Map;this.registerDefaultStrategies()}register(t){this.strategies.set(t.getStrategyName(),t),u?.debug?.log("SystemCreationStrategyRegistry",`Registered strategy: ${t.getStrategyName()}`)}selectStrategy(t,e){let i=this.getStrategiesForSystem(t);if(i.length===0)return null;let n=i[0];if(!n)return null;let r=this.scoreStrategy(n,t,e);for(let a=1;a<i.length;a++){let s=i[a];if(!s)continue;let o=this.scoreStrategy(s,t,e);o>r&&(n=s,r=o)}return n}getStrategies(){return Array.from(this.strategies.values())}getStrategy(t){return this.strategies.get(t)||null}getStrategiesForSystem(t){let e={systemKey:t,config:{},utils:{},dependencies:{},preferences:{},metadata:{timestamp:Date.now(),reason:"startup",priority:"medium"}};return this.getStrategies().filter(i=>i.canCreate(e))}scoreStrategy(t,e,i){let n=0;return n+=10,i.dependencyRequirements==="event-driven"?(t.getStrategyName()==="EventDriven"&&(n+=20),t.getStrategyName()==="ObjectDependencies"&&(n+=15)):i.dependencyRequirements==="basic"&&t.getStrategyName()==="StandardConstructor"&&(n+=20),i.performance==="lightweight"?t.getStrategyName()==="StandardConstructor"&&(n+=15):i.performance==="optimized"&&t.getStrategyName()==="EventDriven"&&(n+=10),i.creationContext==="startup"&&t.getStrategyName()==="StandardConstructor"&&(n+=5),n}registerDefaultStrategies(){this.register(new xi),this.register(new cr),this.register(new lr)}getStatus(){return{strategyCount:this.strategies.size,strategies:Array.from(this.strategies.keys())}}},ms=new ur});var mr,hs,gs=y(()=>{"use strict";A();or();ds();mr=class{constructor(t){this.systemConfigs=new Map;this.creationMetrics={totalCreations:0,successfulCreations:0,averageCreationTime:0,strategyUsage:{}};this.strategyRegistry=t||ms,u?.debug?.log("StrategyBasedFactory","Factory initialized with strategy registry")}async createSystem(t,e,i){let n=performance.now();try{this.creationMetrics.totalCreations++;let r=this.getSystemConfig(t),a=this.buildSelectionCriteria(t,r,i),s=this.strategyRegistry.selectStrategy(t,a);if(!s)throw new Ti(t,a);let o=s.getStrategyName();this.creationMetrics.strategyUsage[o]=(this.creationMetrics.strategyUsage[o]||0)+1;let l=await s.createSystem(e,i);l.success&&this.creationMetrics.successfulCreations++;let d=performance.now()-n;return this.updateAverageCreationTime(d),u?.debug?.log("StrategyBasedFactory",`Created ${t} using ${o}`,{success:l.success,creationTime:l.creationTime,totalTime:d}),l}catch(r){let s=performance.now()-n;return u?.debug?.error("StrategyBasedFactory",`Failed to create ${t}:`,r),{system:null,success:!1,creationTime:s,strategy:"unknown",injectedDependencies:[],warnings:[],error:r,metadata:{requiresInitialization:!1,pendingDependencies:[],context:i}}}}registerSystemConfig(t){this.systemConfigs.set(t.systemKey,t),u?.debug?.log("StrategyBasedFactory",`Registered config for ${t.systemKey}`)}getSystemConfig(t){return this.systemConfigs.get(t)||null}setStrategyRegistry(t){this.strategyRegistry=t,u?.debug?.log("StrategyBasedFactory","Strategy registry updated")}getMetrics(){return{...this.creationMetrics}}resetMetrics(){this.creationMetrics={totalCreations:0,successfulCreations:0,averageCreationTime:0,strategyUsage:{}}}buildSelectionCriteria(t,e,i){let n="medium",r=["DeviceCapabilityDetector","PerformanceAnalyzer","UnifiedCSSVariableManager","SettingsManager","TimerConsolidationSystem"],a=["GlassmorphismManager","Card3DManager","UnifiedCSSVariableManager","EnhancedMasterAnimationCoordinator"];r.includes(t)?n="simple":a.includes(t)&&(n="complex");let s="basic";t==="MusicSyncService"||t==="ColorHarmonyEngine"?s="event-driven":r.includes(t)&&(s="none");let o="standard";return i.metadata.priority==="critical"||i.preferences.monitorCreation?o="optimized":n==="simple"&&(o="lightweight"),{complexity:n,dependencyRequirements:s,performance:o,resourceConstraints:{memoryLimited:i.metadata.resourceConstraints?.maxMemoryMB!==void 0,timeLimited:i.metadata.resourceConstraints?.maxInitTimeMs!==void 0,cpuLimited:i.metadata.priority==="low"},creationContext:i.metadata.reason}}updateAverageCreationTime(t){let e=this.creationMetrics.totalCreations,i=this.creationMetrics.averageCreationTime;this.creationMetrics.averageCreationTime=(i*(e-1)+t)/e}registerDefaultSystemConfigs(){}},hs=new mr});var dr,ps,bs=y(()=>{"use strict";gs();A();dr=class{constructor(t){this.adapted=!1;this.originalFacade=null;this.migrationProgress=0;this.systemsUsingStrategy=new Set;this.systemsUsingLegacy=new Set;this.strategyBasedFactory=t||hs,u?.debug?.log("NonVisualSystemFacadeAdapter","Facade adapter initialized")}adaptToStrategyPattern(t){this.strategyBasedFactory=t,this.adapted=!0,this.migrationProgress=1,u?.debug?.log("NonVisualSystemFacadeAdapter","Facade adapted to strategy pattern")}getMigrationStatus(){return{adapted:this.adapted,systemsUsingStrategyPattern:Array.from(this.systemsUsingStrategy),systemsUsingLegacyPattern:Array.from(this.systemsUsingLegacy),migrationProgress:this.migrationProgress}}async completeMigration(){this.adapted||this.adaptToStrategyPattern(this.strategyBasedFactory),this.migrationProgress=1,this.systemsUsingLegacy.clear(),u?.debug?.log("NonVisualSystemFacadeAdapter","Migration to strategy pattern completed")}async createSystemWithStrategy(t,e,i){let n={systemKey:t,config:i.config,utils:i.utils,dependencies:i.dependencies,preferences:{lazyInit:!1,validateDependencies:!0,creationTimeout:5e3,monitorCreation:!0},metadata:{timestamp:Date.now(),reason:"startup",priority:"medium",resourceConstraints:{maxMemoryMB:50,maxInitTimeMs:1e3}}};try{let r=await this.strategyBasedFactory.createSystem(t,e,n);return r.success?(this.systemsUsingStrategy.add(t),this.systemsUsingLegacy.delete(t)):this.systemsUsingLegacy.add(t),this.updateMigrationProgress(),u?.debug?.log("NonVisualSystemFacadeAdapter",`Created ${t} via strategy pattern`,{strategy:r.strategy,success:r.success,creationTime:r.creationTime}),r}catch(r){return this.systemsUsingLegacy.add(t),this.updateMigrationProgress(),u?.debug?.error("NonVisualSystemFacadeAdapter",`Failed to create ${t} via strategy pattern:`,r),{system:null,success:!1,creationTime:0,strategy:"adapter-fallback",injectedDependencies:[],warnings:[`Strategy creation failed: ${r}`],error:r,metadata:{requiresInitialization:!1,pendingDependencies:[],context:n}}}}createSystemLegacy(t,e,i){switch(this.systemsUsingLegacy.add(t),this.updateMigrationProgress(),u?.debug?.warn("NonVisualSystemFacadeAdapter",`Using legacy creation for ${t} - should migrate to strategy pattern`),t){case"DeviceCapabilityDetector":case"PerformanceAnalyzer":case"SettingsManager":case"TimerConsolidationSystem":return new e;case"SidebarSystemsIntegration":return new e(i.dependencies.cssConsciousnessController);case"OptimizedCSSVariableManager":return new e(i.config,i.dependencies.performanceCoordinator);case"ColorHarmonyEngine":return new e(i.config,i.utils,i.dependencies.performanceAnalyzer,i.dependencies.settingsManager);case"EnhancedMasterAnimationCoordinator":return new e(i.config,i.dependencies.performanceCoordinator);case"UnifiedPerformanceCoordinator":return new e(i.config,i.dependencies.performanceAnalyzer);case"GlassmorphismManager":return new e(i.config,i.utils,i.dependencies.cssConsciousnessController,i.dependencies.performanceAnalyzer,i.dependencies.settingsManager);case"Card3DManager":return new e(i.dependencies.performanceAnalyzer,i.dependencies.settingsManager,i.utils);case"MusicSyncService":return new e({YEAR3000_CONFIG:i.config,Year3000Utilities:i.utils,settingsManager:i.dependencies.settingsManager,year3000System:i.year3000System});case"EnhancedDeviceTierDetector":return e;case"WebGLSystemsIntegration":let n=i.dependencies.deviceCapabilityDetector;if(!n)throw new Error("WebGLSystemsIntegration requires DeviceCapabilityDetector");return new e(n);case"SimplePerformanceCoordinator":let r=i.dependencies.enhancedDeviceTierDetector,a=i.dependencies.webglSystemsIntegration;if(!r||!a)throw new Error("SimplePerformanceCoordinator requires EnhancedDeviceTierDetector and WebGLSystemsIntegration");return new e(r,a);case"SimpleTierBasedPerformanceSystem":let s=i.dependencies.enhancedDeviceTierDetector;if(!s)throw new Error("SimpleTierBasedPerformanceSystem requires EnhancedDeviceTierDetector");return new e(s);default:try{return new e}catch{return new e(i.config,i.utils,i.dependencies.performanceAnalyzer,i.dependencies.settingsManager)}}}updateMigrationProgress(){let t=this.systemsUsingStrategy.size+this.systemsUsingLegacy.size;t===0?this.migrationProgress=0:this.migrationProgress=this.systemsUsingStrategy.size/t}getAdapterMetrics(){let t=this.systemsUsingStrategy.size+this.systemsUsingLegacy.size;return{totalSystemsAdapted:this.systemsUsingStrategy.size,strategySuccessRate:t>0?this.systemsUsingStrategy.size/t:0,migrationProgress:this.migrationProgress,systemBreakdown:{strategy:Array.from(this.systemsUsingStrategy),legacy:Array.from(this.systemsUsingLegacy)}}}async migrateSystemToStrategy(t){try{return this.systemsUsingLegacy.delete(t),u?.debug?.log("NonVisualSystemFacadeAdapter",`Migrated ${t} to strategy pattern`),!0}catch(e){return u?.debug?.error("NonVisualSystemFacadeAdapter",`Failed to migrate ${t} to strategy pattern:`,e),!1}}getRecommendedMigrationOrder(){return["PerformanceAnalyzer","OptimizedCSSVariableManager","DeviceCapabilityDetector","SettingsManager","ColorHarmonyEngine","MusicSyncService","UnifiedPerformanceCoordinator","EnhancedMasterAnimationCoordinator","UnifiedSystemIntegration","GlassmorphismManager","Card3DManager"].filter(e=>this.systemsUsingLegacy.has(e))}},ps=new dr});var It,ys=y(()=>{"use strict";A();Kn();N();Ya();Ka();Qn();jn();hi();Xn();de();Zn();yi();zn();oi();A();ke();gn();Za();On();ts();ai();is();as();us();bs();It=class{constructor(t,e,i){this.cssConsciousnessController=null;this.musicSyncService=null;this.settingsManager=null;this.simplePerformanceCoordinator=null;this.webglSystemsIntegration=null;this.enhancedDeviceTierDetector=null;this.performanceAnalyzer=null;this.performanceCoordinator=null;this.performanceOrchestrator=null;this.isInitialized=!1;this.lastHealthCheck=null;this.healthCheckInterval=null;this.metricsUpdateInterval=null;this.onSystemCreated=null;this.onSystemFailed=null;this.onHealthChange=null;this.facadeAdapter=ps;this.config=t,this.utils=e,this.year3000System=i,i&&typeof i=="object"&&"performanceAnalyzer"in i&&(this.performanceAnalyzer=i.performanceAnalyzer||null,this.cssConsciousnessController=i.unifiedCSSConsciousnessController||null,this.performanceCoordinator=i.unifiedPerformanceCoordinator||null,this.performanceOrchestrator=i.performanceOrchestrator||null,this.musicSyncService=i.musicSyncService||null,this.settingsManager=i.settingsManager||null,u?.debug?.log("NonVisualSystemFacade","Shared dependencies injected from SystemCoordinator",{performanceAnalyzer:!!this.performanceAnalyzer,cssConsciousnessController:!!this.cssConsciousnessController,performanceOrchestrator:!!this.performanceOrchestrator,musicSyncService:!!this.musicSyncService,settingsManager:!!this.settingsManager})),this.systemRegistry=new Map,this.systemCache=new Map,this.systemDependencies=new Map,this.facadeConfig={mode:"progressive",enablePerformanceMonitoring:!0,enableDependencyInjection:!0,enableSystemHealthMonitoring:!0,performanceThresholds:{maxInitTime:5e3,maxMemoryMB:100,maxCPUPercent:15},systemPreferences:{lazyInitialization:!0,aggressiveCaching:!0,performanceOptimization:!0}},this.currentMetrics=this.createInitialMetrics(),this.registerNonVisualSystems(),u?.debug?.log("NonVisualSystemFacade","Non-visual systems facade initialized")}registerNonVisualSystems(){this.systemRegistry.set("EnhancedMasterAnimationCoordinator",Fe),this.systemDependencies.set("EnhancedMasterAnimationCoordinator",["performanceAnalyzer","cssConsciousnessController"]),this.systemRegistry.set("TimerConsolidationSystem",mi),this.systemDependencies.set("TimerConsolidationSystem",["performanceAnalyzer"]),this.systemRegistry.set("OptimizedCSSVariableManager",Re),this.systemDependencies.set("OptimizedCSSVariableManager",["performanceCoordinator"]),this.systemRegistry.set("UnifiedCSSVariableManager",Re),this.systemDependencies.set("UnifiedCSSVariableManager",["performanceCoordinator"]),this.systemRegistry.set("UnifiedPerformanceCoordinator",Ze),this.systemDependencies.set("UnifiedPerformanceCoordinator",[]),this.systemRegistry.set("DeviceCapabilityDetector",_),this.systemDependencies.set("DeviceCapabilityDetector",[]),this.systemRegistry.set("PerformanceBudgetManager",we),this.systemDependencies.set("PerformanceBudgetManager",["performanceAnalyzer"]),this.systemRegistry.set("SimplePerformanceCoordinator",Ge),this.systemDependencies.set("SimplePerformanceCoordinator",["performanceAnalyzer","performanceCoordinator","deviceCapabilityDetector","performanceBudgetManager"]),this.systemRegistry.set("PerformanceAwareLerpCoordinator",di),this.systemDependencies.set("PerformanceAwareLerpCoordinator",["performanceOrchestrator"]),this.systemRegistry.set("SimplePerformanceCoordinator",Ge),this.systemDependencies.set("SimplePerformanceCoordinator",["enhancedDeviceTierDetector","webglSystemsIntegration"]),this.systemRegistry.set("SimpleTierBasedPerformanceSystem",ut),this.systemDependencies.set("SimpleTierBasedPerformanceSystem",["enhancedDeviceTierDetector"]),this.systemRegistry.set("EnhancedDeviceTierDetector",he),this.systemDependencies.set("EnhancedDeviceTierDetector",[]),this.systemRegistry.set("WebGLSystemsIntegration",Xe),this.systemDependencies.set("WebGLSystemsIntegration",["deviceCapabilityDetector"]),this.systemDependencies.set("UnifiedDebugManager",[]),this.systemRegistry.set("SettingsManager",ee),this.systemDependencies.set("SettingsManager",[]),this.systemRegistry.set("ColorHarmonyEngine",Ke),this.systemDependencies.set("ColorHarmonyEngine",["musicSyncService"]),this.systemRegistry.set("MusicSyncService",ve),this.systemDependencies.set("MusicSyncService",[]),this.systemDependencies.set("ColorOrchestrator",[]),this.systemRegistry.set("UnifiedColorProcessingEngine",Et),this.systemDependencies.set("UnifiedColorProcessingEngine",["settingsManager","performanceAnalyzer"]),this.systemRegistry.set("GenreGradientEvolution",rt),this.systemDependencies.set("GenreGradientEvolution",["cssConsciousnessController","musicSyncService","settingsManager"]),this.systemRegistry.set("MusicEmotionAnalyzer",ct),this.systemDependencies.set("MusicEmotionAnalyzer",["musicSyncService","settingsManager"]),this.systemRegistry.set("VisualEffectsCoordinator",wt),this.systemDependencies.set("VisualEffectsCoordinator",["settingsManager"]),this.systemRegistry.set("GlassmorphismManager",Mi),this.systemDependencies.set("GlassmorphismManager",["cssConsciousnessController","performanceAnalyzer","settingsManager"]),this.systemRegistry.set("Card3DManager",vi),this.systemDependencies.set("Card3DManager",["performanceAnalyzer","settingsManager"]),this.systemRegistry.set("SidebarSystemsIntegration",Pi),this.systemDependencies.set("SidebarSystemsIntegration",["cssConsciousnessController"])}async initialize(t){if(this.isInitialized){u?.debug?.warn("NonVisualSystemFacade","Already initialized");return}try{let e=performance.now();this.facadeConfig={...this.facadeConfig,...t},await this.initializeSharedDependencies(),await this.applyConfiguration(),this.startMonitoring(),await this.performHealthCheck();let i=performance.now();this.currentMetrics.systemInitializationTime=i-e,this.isInitialized=!0,u?.debug?.log("NonVisualSystemFacade","Non-visual systems facade fully initialized",{mode:this.facadeConfig.mode,systemsRegistered:this.systemRegistry.size,initTime:this.currentMetrics.systemInitializationTime})}catch(e){throw u?.debug?.error("NonVisualSystemFacade","Initialization failed:",e),await this.cleanup(),e}}async initializeSharedDependencies(){let t=["DeviceCapabilityDetector","EnhancedDeviceTierDetector","WebGLSystemsIntegration","SimplePerformanceCoordinator","PerformanceAnalyzer","UnifiedPerformanceCoordinator","SimplePerformanceCoordinator","OptimizedCSSVariableManager","SettingsManager","UnifiedDebugManager","MusicSyncService"];for(let e of t)try{let i=await this.getSystem(e);switch(i&&typeof i.initialize=="function"&&await i.initialize(),e){case"DeviceCapabilityDetector":this.year3000System&&(this.year3000System.deviceCapabilityDetector=i);break;case"EnhancedDeviceTierDetector":this.enhancedDeviceTierDetector=i;break;case"WebGLSystemsIntegration":this.webglSystemsIntegration=i;break;case"SimplePerformanceCoordinator":this.simplePerformanceCoordinator=i,this.performanceOrchestrator=i;break;case"PerformanceAnalyzer":this.performanceAnalyzer=i;break;case"UnifiedPerformanceCoordinator":this.performanceCoordinator=i;break;case"OptimizedCSSVariableManager":this.cssConsciousnessController=i;break;case"SettingsManager":this.settingsManager=i;break;case"UnifiedDebugManager":break;case"MusicSyncService":this.musicSyncService=i;break}}catch(i){u?.debug?.error("NonVisualSystemFacade",`Failed to initialize ${e}:`,i)}}getCachedSystem(t){let e=this.systemCache.get(t);if(e)return e;if(t==="DeviceCapabilityDetector"&&this.year3000System?.deviceCapabilityDetector){let i=this.year3000System.deviceCapabilityDetector;return this.systemCache.set(t,i),i}return t==="EnhancedDeviceTierDetector"&&this.enhancedDeviceTierDetector?(this.systemCache.set(t,this.enhancedDeviceTierDetector),this.enhancedDeviceTierDetector):t==="WebGLSystemsIntegration"&&this.webglSystemsIntegration?(this.systemCache.set(t,this.webglSystemsIntegration),this.webglSystemsIntegration):t==="SimplePerformanceCoordinator"&&this.simplePerformanceCoordinator?(this.systemCache.set(t,this.simplePerformanceCoordinator),this.simplePerformanceCoordinator):t==="PerformanceAnalyzer"&&this.performanceAnalyzer?(this.systemCache.set(t,this.performanceAnalyzer),this.performanceAnalyzer):t==="SimplePerformanceCoordinator"&&this.performanceOrchestrator?(this.systemCache.set(t,this.performanceOrchestrator),this.performanceOrchestrator):(t==="OptimizedCSSVariableManager"||t==="UnifiedCSSVariableManager")&&this.cssConsciousnessController?(this.systemCache.set(t,this.cssConsciousnessController),this.cssConsciousnessController):t==="MusicSyncService"&&this.musicSyncService?(this.systemCache.set(t,this.musicSyncService),this.musicSyncService):t==="SettingsManager"&&this.settingsManager?(this.systemCache.set(t,this.settingsManager),this.settingsManager):null}async getSystem(t){if(this.systemCache.has(t))return this.systemCache.get(t);if(t==="DeviceCapabilityDetector"&&this.year3000System?.deviceCapabilityDetector){let i=this.year3000System.deviceCapabilityDetector;return this.systemCache.set(t,i),u?.debug?.log("NonVisualSystemFacade","Using shared DeviceCapabilityDetector instance from SystemCoordinator"),i}if(t==="EnhancedDeviceTierDetector"&&this.enhancedDeviceTierDetector)return this.systemCache.set(t,this.enhancedDeviceTierDetector),u?.debug?.log("NonVisualSystemFacade","Using shared EnhancedDeviceTierDetector instance from SystemCoordinator"),this.enhancedDeviceTierDetector;if(t==="WebGLSystemsIntegration"&&this.webglSystemsIntegration)return this.systemCache.set(t,this.webglSystemsIntegration),u?.debug?.log("NonVisualSystemFacade","Using shared WebGLSystemsIntegration instance from SystemCoordinator"),this.webglSystemsIntegration;if(t==="SimplePerformanceCoordinator"&&this.simplePerformanceCoordinator)return this.systemCache.set(t,this.simplePerformanceCoordinator),u?.debug?.log("NonVisualSystemFacade","Using shared SimplePerformanceCoordinator instance from SystemCoordinator"),this.simplePerformanceCoordinator;if(t==="PerformanceAnalyzer"&&this.performanceAnalyzer)return this.systemCache.set(t,this.performanceAnalyzer),u?.debug?.log("NonVisualSystemFacade","Using shared PerformanceAnalyzer instance from SystemCoordinator"),this.performanceAnalyzer;if((t==="OptimizedCSSVariableManager"||t==="UnifiedCSSVariableManager")&&this.cssConsciousnessController)return this.systemCache.set(t,this.cssConsciousnessController),u?.debug?.log("NonVisualSystemFacade",`Using shared OptimizedCSSVariableManager instance from SystemCoordinator (requested as ${t})`),this.cssConsciousnessController;if(t==="SimplePerformanceCoordinator"&&this.performanceOrchestrator)return this.systemCache.set(t,this.performanceOrchestrator),u?.debug?.log("NonVisualSystemFacade","Using shared SimplePerformanceCoordinator instance from SystemCoordinator"),this.performanceOrchestrator;if(t==="MusicSyncService"&&this.musicSyncService)return this.systemCache.set(t,this.musicSyncService),u?.debug?.log("NonVisualSystemFacade","Using shared MusicSyncService instance from SystemCoordinator"),this.musicSyncService;if(t==="SettingsManager"&&this.settingsManager)return this.systemCache.set(t,this.settingsManager),u?.debug?.log("NonVisualSystemFacade","Using shared SettingsManager instance from SystemCoordinator"),this.settingsManager;let e=await this.createSystem(t);return this.systemCache.set(t,e),this.currentMetrics.activeSystems.push(t),this.currentMetrics.initializedSystems++,this.onSystemCreated&&this.onSystemCreated(t,e),e}async createSystem(t){let e=performance.now();try{if(t==="UnifiedDebugManager"){let o=ta.getInstance();this.injectDependencies(o,t),this.integratePerformanceMonitoring(o,t);let l=performance.now();return this.currentMetrics.dependencyResolutionTime+=l-e,o}if(t==="ColorOrchestrator"){let o=ot;this.injectDependencies(o,t),this.integratePerformanceMonitoring(o,t);let l=performance.now();return this.currentMetrics.dependencyResolutionTime+=l-e,o}let i=this.systemRegistry.get(t);if(!i)throw new Error(`Non-visual system '${t}' not found in registry`);let n={systemKey:t,config:this.config,utils:this.utils,dependencies:{config:this.config,utils:this.utils,performanceAnalyzer:this.performanceAnalyzer,settingsManager:this.settingsManager,musicSyncService:this.musicSyncService,year3000System:this.year3000System,cssConsciousnessController:this.cssConsciousnessController,performanceCoordinator:this.performanceCoordinator,performanceOrchestrator:this.performanceOrchestrator,enhancedDeviceTierDetector:this.enhancedDeviceTierDetector,webglSystemsIntegration:this.webglSystemsIntegration,simplePerformanceCoordinator:this.simplePerformanceCoordinator,deviceCapabilityDetector:this.year3000System?.deviceCapabilityDetector||null},preferences:{lazyInit:!1,validateDependencies:!0,creationTimeout:5e3,monitorCreation:!0},metadata:{timestamp:Date.now(),reason:"startup",priority:"medium",resourceConstraints:{maxMemoryMB:50,maxInitTimeMs:1e3}},year3000System:this.year3000System},r=await this.facadeAdapter.createSystemWithStrategy(t,i,n);if(!r.success){u?.debug?.warn("NonVisualSystemFacade",`Strategy creation failed for ${t}, falling back to legacy pattern`);let o=this.facadeAdapter.createSystemLegacy(t,i,n);this.injectDependencies(o,t),this.integratePerformanceMonitoring(o,t);let l=performance.now();return this.currentMetrics.dependencyResolutionTime+=l-e,o}let a=r.system;this.injectDependencies(a,t),this.integratePerformanceMonitoring(a,t);let s=performance.now();return this.currentMetrics.dependencyResolutionTime+=s-e,u?.debug?.log("NonVisualSystemFacade",`Created ${t} using strategy: ${r.strategy}`,{creationTime:r.creationTime,totalTime:s-e,injectedDependencies:r.injectedDependencies}),a}catch(i){throw this.currentMetrics.failedSystems++,this.currentMetrics.failedSystemsList.push(t),this.currentMetrics.systemErrors++,this.onSystemFailed&&this.onSystemFailed(t,i),u?.debug?.error("NonVisualSystemFacade",`Failed to create system ${t}:`,i),i}}injectDependencies(t,e){if(!this.facadeConfig.enableDependencyInjection)return;let i=this.systemDependencies.get(e)||[];i.includes("performanceAnalyzer")&&this.performanceAnalyzer&&t.setPerformanceAnalyzer&&t.setPerformanceAnalyzer(this.performanceAnalyzer),i.includes("cssConsciousnessController")&&this.cssConsciousnessController&&t.setCSSConsciousnessController&&t.setCSSConsciousnessController(this.cssConsciousnessController),i.includes("musicSyncService")&&this.musicSyncService&&t.setMusicSyncService&&t.setMusicSyncService(this.musicSyncService),i.includes("settingsManager")&&this.settingsManager&&t.setSettingsManager&&t.setSettingsManager(this.settingsManager),i.includes("year3000System")&&t.setYear3000System&&t.setYear3000System(this.year3000System),i.includes("performanceOrchestrator")&&this.performanceOrchestrator&&t.setSimplePerformanceCoordinator&&t.setSimplePerformanceCoordinator(this.performanceOrchestrator)}integratePerformanceMonitoring(t,e){if(!this.facadeConfig.enablePerformanceMonitoring||!this.performanceAnalyzer)return;let i=t.initialize;typeof i=="function"&&(t.initialize=async(...r)=>{let a=performance.now(),s=await i.call(t,...r),o=performance.now();return this.performanceAnalyzer?.recordMetric(`NonVisual_${e}_Initialize`,o-a),s});let n=t.updateAnimation;typeof n=="function"&&(t.updateAnimation=r=>{let a=performance.now();n.call(t,r);let s=performance.now();this.performanceAnalyzer?.recordMetric(`NonVisual_${e}_Animation`,s-a)})}async initializeAllSystems(){let t=Array.from(this.systemCache.entries()).map(async([n,r])=>{try{return r&&typeof r.initialize=="function"&&await r.initialize(),u?.debug?.log("NonVisualSystemFacade",`Initialized system: ${n}`),{key:n,success:!0}}catch(a){return u?.debug?.error("NonVisualSystemFacade",`Failed to initialize ${n}:`,a),{key:n,success:!1,error:a}}}),e=await Promise.allSettled(t),i=e.filter(n=>n.status==="fulfilled"&&n.value.success).length;u?.debug?.log("NonVisualSystemFacade",`Non-visual systems initialized: ${i}/${e.length}`)}async performHealthCheck(){let t={overall:"good",systems:new Map,recommendations:[],timestamp:performance.now(),metrics:{...this.currentMetrics}},e=0,i=0;for(let[r,a]of this.systemCache){i++;try{let s=a.healthCheck?await a.healthCheck():{status:"unknown",message:"No health check available"},o=s.status==="healthy"||s.status==="good";o&&e++,t.systems.set(r,{ok:o,details:s.message||s.details||"System operational"})}catch(s){t.systems.set(r,{ok:!1,details:`Health check failed: ${s}`})}}let n=i>0?e/i:1;return n>=.9?t.overall="excellent":n>=.7?t.overall="good":n>=.5?(t.overall="degraded",t.recommendations.push("Some non-visual systems are experiencing issues")):(t.overall="critical",t.recommendations.push("Multiple non-visual system failures detected")),this.currentMetrics.systemInitializationTime>3e3&&t.recommendations.push("High initialization time - consider optimizing system startup"),this.currentMetrics.memoryUsageMB>80&&t.recommendations.push("High memory usage - consider optimizing system memory usage"),this.lastHealthCheck=t,this.currentMetrics.lastHealthCheckTime=performance.now(),this.onHealthChange&&this.onHealthChange(t),t}createInitialMetrics(){return{systemCount:this.systemRegistry.size,initializedSystems:0,failedSystems:0,totalInitTime:0,averageInitTime:0,memoryUsageMB:0,systemHealth:"good",activeSystems:[],failedSystemsList:[],dependencyInjection:this.facadeConfig.enableDependencyInjection,performanceMonitoring:this.facadeConfig.enablePerformanceMonitoring,healthMonitoring:this.facadeConfig.enableSystemHealthMonitoring,systemInitializationTime:0,dependencyResolutionTime:0,lastHealthCheckTime:0,systemErrors:0}}async applyConfiguration(){switch(this.facadeConfig.mode){case"performance-first":this.facadeConfig.systemPreferences.lazyInitialization=!0,this.facadeConfig.systemPreferences.aggressiveCaching=!0;break;case"quality-first":this.facadeConfig.systemPreferences.lazyInitialization=!1,this.facadeConfig.systemPreferences.performanceOptimization=!0;break;case"battery-optimized":this.facadeConfig.performanceThresholds.maxCPUPercent=5,this.facadeConfig.systemPreferences.lazyInitialization=!0;break}}startMonitoring(){this.facadeConfig.enableSystemHealthMonitoring&&(this.healthCheckInterval=window.setInterval(async()=>{await this.performHealthCheck()},3e4),this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},5e3))}updateMetrics(){this.currentMetrics.systemCount=this.systemRegistry.size,this.currentMetrics.initializedSystems=this.systemCache.size,this.currentMetrics.averageInitTime=this.currentMetrics.totalInitTime/Math.max(1,this.currentMetrics.initializedSystems);let t=performance.memory;t&&(this.currentMetrics.memoryUsageMB=t.usedJSHeapSize/(1024*1024));let e=this.currentMetrics.failedSystems/Math.max(1,this.currentMetrics.systemCount);e===0?this.currentMetrics.systemHealth="excellent":e<.1?this.currentMetrics.systemHealth="good":e<.3?this.currentMetrics.systemHealth="degraded":this.currentMetrics.systemHealth="critical"}async cleanup(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this.cssConsciousnessController=null,this.performanceAnalyzer=null,this.performanceOrchestrator=null,this.musicSyncService=null,this.settingsManager=null}getMetrics(){return{...this.currentMetrics}}getLastHealthCheck(){return this.lastHealthCheck}getConfiguration(){return{...this.facadeConfig}}async setConfiguration(t){this.facadeConfig={...this.facadeConfig,...t},await this.applyConfiguration()}setOnSystemCreated(t){this.onSystemCreated=t}setOnSystemFailed(t){this.onSystemFailed=t}setOnHealthChange(t){this.onHealthChange=t}getSystemStatus(){return{initialized:this.isInitialized,systemsActive:this.systemCache.size,healthy:this.currentMetrics.systemHealth==="excellent"||this.currentMetrics.systemHealth==="good"}}async destroy(){await this.cleanup(),this.isInitialized=!1,this.systemCache.clear(),u?.debug?.log("NonVisualSystemFacade","Non-visual systems facade destroyed")}}});var Ai,fs=y(()=>{"use strict";D();Ai=class{constructor(t,e,i){this.systemName="CSSAnimationManager";this.animationStates=new Map;this.activeAnimations=new Map;this.animationObservers=new Map;this.frameCount=0;this.lastFrameTime=0;this.avgFrameTime=0;this.performanceMode="quality";this.beatSyncState={intensity:0,tempo:120,phase:0,lastBeatTime:0,avgBeatInterval:500};this.breathingState={currentType:"gentle",activeElements:new Set,currentAnimation:null,lastEnergyLevel:.5,lastTempoChange:0,targetEnergyLevel:.5,smoothedEnergyLevel:.5,targetTempo:120,smoothedTempo:120,lastFrameTime:0,energyHalfLife:.3,tempoHalfLife:.8};this.ANIMATION_CONFIGS={consciousnessGentleBreathing:{name:"consciousness-gentle-breathing",duration:4e3,easing:"ease-in-out",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},consciousnessEnergeticBreathing:{name:"consciousness-energetic-breathing",duration:2500,easing:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},consciousnessMeditativeBreathing:{name:"consciousness-meditative-breathing",duration:6e3,easing:"cubic-bezier(0.4, 0, 0.6, 1)",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},consciousnessCosmicBreathing:{name:"consciousness-cosmic-breathing",duration:3e3,easing:"cubic-bezier(0.25, 0.1, 0.25, 1)",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},bloom:{name:"year3000-bloom",duration:1500,easing:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",iterations:1,fillMode:"forwards",playState:"running",delay:0,direction:"normal"},ripple:{name:"year3000-ripple",duration:1200,easing:"ease-out",iterations:1,fillMode:"forwards",playState:"running",delay:0,direction:"normal"},oscillate:{name:"year3000-oscillate",duration:4e3,easing:"ease-in-out",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},harmonize:{name:"year3000-harmonize-flow",duration:8e3,easing:"linear",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"},refract:{name:"year3000-refract",duration:800,easing:"ease-in-out",iterations:1,fillMode:"forwards",playState:"running",delay:0,direction:"normal"},temporalEcho:{name:"year3000-echo-core",duration:800,easing:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",iterations:1,fillMode:"forwards",playState:"running",delay:0,direction:"normal"},gravity:{name:"year3000-gravity-pull",duration:1e3,easing:"ease-in-out",iterations:"infinite",fillMode:"none",playState:"running",delay:0,direction:"normal"}};this.config=t,this.cssConsciousnessController=e,this.animationCoordinator=i,this.eventBus=g,this.initializeDefaultState(),this.subscribeToEvents(),this.animationCoordinator.registerVisualSystem(this,"normal"),this.breathingState.lastFrameTime=performance.now(),this.config.enableDebug&&console.log("[CSSAnimationManager] Initialized with CSS animation coordination and LERP-smoothed breathing transitions")}onAnimate(t,e){this.frameCount++,this.lastFrameTime=t,this.avgFrameTime=this.avgFrameTime*.9+t*.1,this.updatePerformanceMode(e.performanceMode),e.beatIntensity!==void 0&&this.updateBeatSyncState(e.beatIntensity,e.timestamp);let i=t/1e3;this.updateBreathingLerpValues(i),this.updateAnimationVariables(e),this.updateActiveAnimations(e),this.frameCount%60===0&&this.reportPerformanceMetrics()}onPerformanceModeChange(t){this.performanceMode=t,this.updateAnimationQuality(t),this.config.enableDebug&&console.log(`[CSSAnimationManager] Performance mode changed to: ${t}`)}triggerKineticAnimation(t,e,i){let n={...this.ANIMATION_CONFIGS[e],...i};Array.from(t).forEach((r,a)=>{let s=(n.delay||0)+a*50,o={duration:n.duration||1e3,easing:n.easing||"ease-in-out",iterations:n.iterations==="infinite"?1/0:n.iterations||1,fill:n.fillMode||"forwards",delay:s,direction:n.direction||"normal"},l=r.animate([],o),m=`${e}_${Date.now()}_${a}`;this.activeAnimations.set(m,l),l.addEventListener("finish",()=>{this.activeAnimations.delete(m),r.classList.remove(`sn-${e}-active`)}),r.classList.add(`sn-${e}-active`)}),this.config.enableDebug&&console.log(`[CSSAnimationManager] Triggered ${e} animation on ${t.length} elements`)}enableBeatSync(t=!0){for(let[e,i]of this.animationStates)i.beatSyncEnabled=t,this.animationStates.set(e,i);this.cssConsciousnessController.updateMusicVariables({"beat.pulse.intensity":t?this.beatSyncState.intensity:0}),this.config.enableDebug&&console.log(`[CSSAnimationManager] Beat sync ${t?"enabled":"disabled"}`)}setAnimationIntensity(t){let e=Math.max(0,Math.min(1,t));for(let[i,n]of this.animationStates)n.intensityLevel=e,this.animationStates.set(i,n);this.cssConsciousnessController.updateAnimationVariables({"motion.scale":e}),this.cssConsciousnessController.updateMusicVariables({"beat.pulse.intensity":e}),this.config.enableDebug&&console.log(`[CSSAnimationManager] Animation intensity set to: ${e}`)}pauseAllAnimations(){for(let t of this.activeAnimations.values())t.pause();this.cssConsciousnessController.updateAnimationVariables({"motion.scale":0}),this.config.enableDebug&&console.log("[CSSAnimationManager] All animations paused")}resumeAllAnimations(){for(let t of this.activeAnimations.values())t.play();this.cssConsciousnessController.updateAnimationVariables({"motion.scale":1}),this.config.enableDebug&&console.log("[CSSAnimationManager] All animations resumed")}lerpSmooth(t,e,i,n){return n<=1e-5||i<=0?e:e+(t-e)*Math.pow(2,-i/n)}updateBreathingLerpValues(t){this.breathingState.smoothedEnergyLevel=this.lerpSmooth(this.breathingState.smoothedEnergyLevel,this.breathingState.targetEnergyLevel,t,this.breathingState.energyHalfLife),this.breathingState.smoothedTempo=this.lerpSmooth(this.breathingState.smoothedTempo,this.breathingState.targetTempo,t,this.breathingState.tempoHalfLife)}triggerConsciousnessBreathing(t,e=.5,i=120){this.breathingState.targetEnergyLevel=e,this.breathingState.targetTempo=i;let n=this.breathingState.smoothedEnergyLevel,r=this.breathingState.smoothedTempo,a=this.selectBreathingType(n,r);this.breathingState.currentAnimation&&this.breathingState.currentAnimation.cancel(),this.breathingState.activeElements.forEach(s=>{s.classList.remove("consciousness-gentle-breathing","consciousness-energetic-breathing","consciousness-meditative-breathing","consciousness-cosmic-breathing")}),this.breathingState.currentType=a,this.breathingState.lastEnergyLevel=n,this.breathingState.lastTempoChange=Date.now(),this.breathingState.activeElements.clear(),Array.from(t).forEach(s=>{this.breathingState.activeElements.add(s),s.classList.add(`consciousness-${a}-breathing`)}),this.updateBreathingVariables(a,n,r),this.config.enableDebug&&console.log(`[CSSAnimationManager] LERP-smoothed breathing: ${a} (raw: ${e.toFixed(2)}\u2192${n.toFixed(2)}, tempo: ${i}\u2192${r.toFixed(1)})`)}selectBreathingType(t,e){return this.performanceMode==="performance"&&t>.7?t>.8?"gentle":"meditative":t<.3?"meditative":t>.7&&e>140?"cosmic":t>.6?"energetic":"gentle"}updateBreathingVariables(t,e,i){let n=this.calculateBreathingDuration(t,i),r=Math.max(.05,Math.min(1,e));this.cssConsciousnessController.updateConsciousnessVariables({"breathing.type":t,"breathing.duration":`${n}ms`,"breathing.intensity":r,"breathing.energy":e}),this.cssConsciousnessController.updateMusicVariables({"tempo.bpm":i,"energy.level":e,"breathing.sync":1})}calculateBreathingDuration(t,e){let n={gentle:4e3,energetic:2500,meditative:6e3,cosmic:3e3}[t]||4e3,r=Math.max(.5,Math.min(2,120/e));return Math.round(n*r)}stopConsciousnessBreathing(){this.breathingState.currentAnimation&&(this.breathingState.currentAnimation.cancel(),this.breathingState.currentAnimation=null),this.breathingState.activeElements.forEach(t=>{t.classList.remove("consciousness-gentle-breathing","consciousness-energetic-breathing","consciousness-meditative-breathing","consciousness-cosmic-breathing")}),this.breathingState.activeElements.clear(),this.cssConsciousnessController.updateConsciousnessVariables({"breathing.sync":0}),this.config.enableDebug&&console.log("[CSSAnimationManager] Consciousness breathing stopped")}getPerformanceMetrics(){return{frameCount:this.frameCount,avgFrameTime:this.avgFrameTime,activeAnimations:this.activeAnimations.size,performanceMode:this.performanceMode}}destroy(){for(let t of this.activeAnimations.values())t.cancel();this.activeAnimations.clear(),this.animationStates.clear(),this.animationObservers.clear(),this.config.enableDebug&&console.log("[CSSAnimationManager] Destroyed")}initializeDefaultState(){let t={rippleActive:!1,bloomActive:!1,refractActive:!1,oscillateActive:!1,harmonizeActive:!1,temporalEchoActive:!1,gravityActive:!1,beatSyncEnabled:!0,intensityLevel:1,tempoMultiplier:1};this.animationStates.set("default",t)}subscribeToEvents(){this.eventBus.subscribe("music:beat",t=>{this.handleBeatEvent(t)},"CSSAnimationManager"),this.eventBus.subscribe("music:energy",t=>{this.handleTempoChange({bpm:t.tempo})},"CSSAnimationManager"),this.eventBus.subscribe("settings:changed",t=>{t.settingKey==="sn-animation-quality"&&this.handleAnimationQualityChange(t.newValue)},"CSSAnimationManager"),this.eventBus.subscribe("performance:frame",t=>{let e=t.fps<45?"performance":"quality";this.onPerformanceModeChange(e)},"CSSAnimationManager")}handleBeatEvent(t){let e=performance.now(),i=e-this.beatSyncState.lastBeatTime;if(this.beatSyncState.intensity=t.intensity||0,this.beatSyncState.phase=t.phase||0,this.beatSyncState.lastBeatTime=e,i>0&&i<2e3&&(this.beatSyncState.avgBeatInterval=this.beatSyncState.avgBeatInterval*.9+i*.1),this.cssConsciousnessController.updateMusicVariables({"beat.pulse.intensity":this.beatSyncState.intensity,"beat.phase":this.beatSyncState.phase}),t.energy!==void 0){let n=t.energy,r=this.beatSyncState.tempo,a=Math.abs(n-this.breathingState.lastEnergyLevel),s=e-this.breathingState.lastTempoChange;if(a>.15||s>5e3){let o=document.querySelectorAll(".Root__main-view::before, .Root__main-view, [data-consciousness-breathing]");o.length>0&&this.triggerConsciousnessBreathing(o,n,r)}}}handleTempoChange(t){let e=t.bpm||120;this.beatSyncState.tempo=e;let i=e/120;this.cssConsciousnessController.updateMusicVariables({"tempo.bpm":e}),this.cssConsciousnessController.updateAnimationVariables({"motion.scale":i});for(let[n,r]of this.animationStates)r.tempoMultiplier=i,this.animationStates.set(n,r)}updateBeatSyncState(t,e){this.beatSyncState.intensity=t,this.beatSyncState.lastBeatTime=e,this.cssConsciousnessController.updateMusicVariables({"beat.pulse.intensity":t})}updateAnimationVariables(t){this.cssConsciousnessController.updateAnimationVariables({"frame.fps":Math.round(1e3/t.deltaMs),"frame.budget":`${t.frameBudget}ms`}),t.tiltXY&&this.cssConsciousnessController.updateConsciousnessVariables({"hover.pull":`${Math.abs(t.tiltXY.x)+Math.abs(t.tiltXY.y)}px`})}updateActiveAnimations(t){if(t.timestamp-this.lastFrameTime<16)return;let e=this.performanceMode==="performance"?.7:1;for(let i of this.activeAnimations.values())i.playbackRate!==e&&(i.playbackRate=e)}handleAnimationQualityChange(t){let e;switch(t){case"low":e=.4;break;case"high":e=1;break;case"auto":default:e=this.performanceMode==="performance"?.6:1;break}this.applyQualityLevel(e),this.config.enableDebug&&console.log(`[CSSAnimationManager] Animation quality set to: ${t} (level: ${e})`)}updateAnimationQuality(t){let e=t==="performance"?.6:1;this.applyQualityLevel(e)}applyQualityLevel(t){let e=t<.5?"performance":"quality";this.cssConsciousnessController.updatePerformanceVariables({"quality.level":t,mode:e}),this.cssConsciousnessController.updateAnimationVariables({"motion.scale":t}),t<.5?this.cssConsciousnessController.updateUtilityVariables({"feature.animations.enabled":!1}):this.cssConsciousnessController.updateUtilityVariables({"feature.animations.enabled":!0})}updatePerformanceMode(t){this.performanceMode!==t&&(this.performanceMode=t,this.updateAnimationQuality(t))}reportPerformanceMetrics(){let t=this.getPerformanceMetrics();this.eventBus.emit("performance:frame",{deltaTime:t.avgFrameTime,fps:Math.round(1e3/t.avgFrameTime),memoryUsage:0,timestamp:Date.now()}),this.config.enableDebug&&console.log(`[CSSAnimationManager] Performance - FPS: ${Math.round(1e3/t.avgFrameTime)}, Active: ${t.activeAnimations}`)}}});var Ii,hr,gr,Ss=y(()=>{"use strict";Ii=class{constructor(){this.breathingEngine=new hr,this.symbioticCore=new gr}getConsciousnessState(){return{cellularGrowthRate:1,breathingCycle:2,emotionalTemperature:6e3,membraneFluidityIndex:.5,symbioticResonance:.5,cinematicIntensity:.5}}},hr=class{updateBreathing(t){}getBreathingPhase(){return .5}initialize(){}updateBreathingCycle(t){}calculateBreathingCycle(t){return 2}adjustRhythm(t){}synchronizeWithBeat(t){}},gr=class{processAudioData(t){}getEmotionalState(){return{intensity:.5,valence:.5,arousal:.5,energy:.5}}initialize(){}updateSymbioticResonance(t){}calculateResonance(t){return .5}updateSymbioticEffects(t){}}});var Hc,vs,Cs,Ms,ws,Ve,X,pr,br,yr,Es=y(()=>{"use strict";Hc=`#version 300 es
in vec2 a_position;
void main() {
  gl_Position = vec4(a_position, 0.0, 1.0);
}`,vs=`
// Shared simplex noise implementation for consciousness effects
vec3 mod289(vec3 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec2 mod289(vec2 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec3 permute(vec3 x) {
  return mod289(((x*34.0)+1.0)*x);
}

float snoise(vec2 v) {
  const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);
  vec2 i = floor(v + dot(v, C.yy));
  vec2 x0 = v - i + dot(i, C.xx);
  vec2 i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
  vec4 x12 = x0.xyxy + C.xxzz;
  x12.xy -= i1;
  i = mod289(i);
  vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));
  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
  m = m*m;
  m = m*m;
  vec3 x = 2.0 * fract(p * C.www) - 1.0;
  vec3 h = abs(x) - 0.5;
  vec3 ox = floor(x + 0.5);
  vec3 a0 = x - ox;
  m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);
  vec3 g;
  g.x = a0.x * x0.x + h.x * x0.y;
  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
  return 130.0 * dot(m, g);
}`,Cs=`
// Enhanced consciousness-aware breathing effect with multi-phase patterns
float consciousnessBreathing(float time, float phase, float intensity) {
  return sin(time * 0.05 + phase) * intensity;
}

// Deep consciousness breathing with emotional resonance
float deepConsciousnessBreathing(float time, float phase, float emotionalIntensity) {
  float primaryBreath = sin(time * 0.04 + phase) * 0.6;
  float secondaryBreath = sin(time * 0.07 + phase * 1.3) * 0.3;
  float emotionalBreath = sin(time * 0.02 + phase * 0.7) * 0.2;
  return (primaryBreath + secondaryBreath + emotionalBreath) * emotionalIntensity;
}

// Rhythmic pulse modulation from consciousness field
float rhythmicPulseModulation(float baseValue, float rhythmicPulse, float intensity) {
  return baseValue * (1.0 + rhythmicPulse * intensity);
}

// Musical flow direction calculation
vec2 calculateMusicalFlow(vec2 baseDirection, vec2 musicFlow, float sensitivity) {
  return baseDirection + musicFlow * sensitivity;
}

// Energy resonance modulation
float energyResonanceModulation(float baseValue, float energyResonance, float minMult, float maxMult) {
  return baseValue * (minMult + energyResonance * (maxMult - minMult));
}

// Membrane fluidity effect
float membraneFluidityEffect(float value, float fluidityIndex) {
  return mix(value, value * 1.2, fluidityIndex);
}

// === ADVANCED CONSCIOUSNESS FIELD PATTERNS ===

// Multi-dimensional consciousness field intensity calculation
float consciousnessFieldIntensity(vec2 position, float time, float musicEnergy) {
  // Primary consciousness wave
  float primaryField = snoise(position * 2.0 + time * 0.1) * 0.6;
  
  // Secondary awareness resonance
  float secondaryField = snoise(position * 4.0 + time * 0.05) * 0.3;
  
  // Musical consciousness enhancement
  float musicalField = snoise(position * 6.0 + time * 0.15) * 0.2;
  
  // Combine consciousness layers
  float combinedField = primaryField + secondaryField + (musicalField * musicEnergy);
  return clamp(combinedField * 0.5 + 0.5, 0.0, 1.0);
}

// Multi-dimensional awareness patterns for color modulation
vec3 awarenessResonance(vec3 baseColor, float consciousnessLevel, float musicIntensity) {
  // Consciousness-aware color temperature shift
  float temperatureShift = consciousnessLevel * 0.3;
  vec3 warmShift = vec3(1.0 + temperatureShift, 1.0 + temperatureShift * 0.5, 1.0);
  vec3 coolShift = vec3(1.0, 1.0 + temperatureShift * 0.3, 1.0 + temperatureShift);
  
  // Musical intensity affects color saturation
  float saturationBoost = 1.0 + musicIntensity * 0.4;
  
  // Apply consciousness-aware color modulation
  vec3 temperatureColor = mix(coolShift, warmShift, consciousnessLevel);
  return baseColor * temperatureColor * saturationBoost;
}

// Temporal flow patterns for Year 3000 streaming effects
vec2 temporalFlowDirection(vec2 position, float time, vec2 musicFlow) {
  // Primary temporal stream
  vec2 primaryFlow = vec2(
    sin(time * 0.08 + position.x * 3.0),
    cos(time * 0.06 + position.y * 2.5)
  ) * 0.02;
  
  // Secondary consciousness flow
  vec2 consciousnessFlow = vec2(
    sin(time * 0.05 + position.y * 4.0),
    cos(time * 0.04 + position.x * 3.5)
  ) * 0.015;
  
  // Musical synchronization flow
  vec2 musicalSync = musicFlow * 0.01;
  
  return primaryFlow + consciousnessFlow + musicalSync;
}

// Membrane consciousness dynamics for organic boundaries
float membraneConsciousnessFlow(vec2 position, float fluidityIndex, float awarenessLevel) {
  // Base membrane oscillation
  float membraneBase = sin(position.x * 8.0 + position.y * 6.0) * 0.1;
  
  // Consciousness-driven membrane flexibility
  float consciousnessFlex = awarenessLevel * fluidityIndex * 0.2;
  
  // Organic membrane breathing
  float membraneBreath = sin(position.x * 3.0 + position.y * 4.0) * 0.05;
  
  return membraneBase + consciousnessFlex + membraneBreath;
}

// Advanced consciousness breathing patterns
float consciousnessMemoryBreathing(float time, float phase, float memoryIntensity) {
  // Primary consciousness rhythm
  float primaryRhythm = sin(time * 0.03 + phase) * 0.5;
  
  // Memory echo patterns
  float memoryEcho = sin(time * 0.08 + phase * 1.7) * 0.3 * memoryIntensity;
  
  // Deep awareness pulse
  float awarenessePulse = sin(time * 0.015 + phase * 0.5) * 0.2;
  
  return primaryRhythm + memoryEcho + awarenessePulse;
}`,Ms=`
// Convert screen coordinates to polar coordinates for radial flow
vec2 toPolar(vec2 uv) {
  vec2 centered = uv - 0.5;
  float angle = atan(centered.y, centered.x);
  float radius = length(centered);
  return vec2(angle, radius);
}

// Convert polar coordinates back to cartesian
vec2 fromPolar(vec2 polar) {
  float angle = polar.x;
  float radius = polar.y;
  return vec2(cos(angle) * radius, sin(angle) * radius) + 0.5;
}

// Signed distance field for a circle
float circleSDF(vec2 uv, vec2 center, float radius) {
  return length(uv - center) - radius;
}

// Smooth minimum for blending SDFs
float smin(float a, float b, float k) {
  float h = clamp(0.5 + 0.5 * (b - a) / k, 0.0, 1.0);
  return mix(b, a, h) - k * h * (1.0 - h);
}

// Enhanced multiple bubble corridors with organic consciousness-aware animations
float bubbleCorridors(vec2 uv, float time, float intensity) {
  // ===== ENHANCED PRIMARY BUBBLE APERTURES =====
  // Create 6 main circular apertures arranged in a ring with dynamic bubble count
  float baseBubbleCount = 6.0;
  float dynamicBubbleCount = baseBubbleCount + floor(intensity * 2.0); // 6-8 bubbles based on intensity
  float ringRadius = 0.28 + sin(time * 0.15) * 0.08; // Breathing ring radius (0.20-0.36)
  
  float minBubbleDistance = 2.0; // Track closest bubble distance
  
  // Calculate distance to each bubble position with enhanced organic movement
  for(float i = 0.0; i < dynamicBubbleCount; i += 1.0) {
    // Enhanced organic rotation with breathing rhythm
    float bubbleAngle = (i / dynamicBubbleCount) * 2.0 * 3.14159 + time * 0.08;
    
    // Add organic spiral motion for consciousness effect
    float spiralOffset = sin(time * 0.25 + i * 0.6) * 0.15;
    float dynamicRingRadius = ringRadius + spiralOffset;
    
    // Bubble center position with enhanced organic movement
    vec2 bubbleCenter = vec2(0.5) + vec2(
      cos(bubbleAngle) * dynamicRingRadius,
      sin(bubbleAngle) * dynamicRingRadius
    );
    
    // Enhanced breathing/pulsing animation with multi-frequency modulation
    float breathingPhase = sin(time * 0.6 + i * 0.8) * 0.04;
    float organicPhase = sin(time * 0.35 + i * 1.2) * 0.03;
    float consciousnessPhase = sin(time * 0.18 + i * 0.5) * 0.025;
    
    vec2 organicMovement = vec2(
      sin(time * 0.3 + i * 0.7) * (breathingPhase + organicPhase),
      cos(time * 0.4 + i * 0.9) * (breathingPhase + consciousnessPhase)
    );
    
    vec2 animatedCenter = bubbleCenter + organicMovement;
    
    // Calculate distance from current pixel to this bubble center
    float distanceToBubble = length(uv - animatedCenter);
    minBubbleDistance = min(minBubbleDistance, distanceToBubble);
  }
  
  // ===== ENHANCED BUBBLE APERTURE SIZING =====
  // Enhanced bubble size with multi-wave expansion patterns
  float baseBubbleSize = 0.08 * intensity;
  float primaryPulse = sin(time * 1.5) * 0.35;
  float organicPulse = sin(time * 0.8) * 0.25;
  float consciousnessPulse = sin(time * 2.2) * 0.15;
  
  float expandedBubbleSize = baseBubbleSize * (1.0 + primaryPulse + organicPulse + consciousnessPulse);
  
  // Create clean circular apertures with enhanced soft edges
  float primaryBubbleMask = 1.0 - smoothstep(expandedBubbleSize * 0.6, expandedBubbleSize * 1.1, minBubbleDistance);
  
  // ===== ENHANCED SECONDARY BUBBLE LAYER =====
  // Add smaller secondary bubbles with organic movement
  float secondaryBubbleCount = 4.0 + floor(intensity * 1.0); // 4-5 secondary bubbles
  float baseSecondaryRadius = 0.15;
  float secondaryRingRadius = baseSecondaryRadius * (1.0 + sin(time * 0.12) * 0.3);
  float minSecondaryDistance = 2.0;
  
  for(float i = 0.0; i < secondaryBubbleCount; i += 1.0) {
    // Counter-rotating secondary bubbles with organic offset
    float secondaryAngle = (i / secondaryBubbleCount) * 2.0 * 3.14159 - time * 0.15 + 1.57;
    
    // Add organic wobble to secondary bubble positions
    float wobbleX = sin(time * 0.45 + i * 1.1) * 0.02;
    float wobbleY = cos(time * 0.55 + i * 0.8) * 0.02;
    
    vec2 secondaryCenter = vec2(0.5) + vec2(
      cos(secondaryAngle) * secondaryRingRadius + wobbleX,
      sin(secondaryAngle) * secondaryRingRadius + wobbleY
    );
    
    float distanceToSecondary = length(uv - secondaryCenter);
    minSecondaryDistance = min(minSecondaryDistance, distanceToSecondary);
  }
  
  float secondaryBubbleSize = baseBubbleSize * 0.5 * (1.0 + sin(time * 1.8) * 0.3);
  float secondaryBubbleMask = 1.0 - smoothstep(secondaryBubbleSize * 0.6, secondaryBubbleSize * 1.0, minSecondaryDistance);
  secondaryBubbleMask *= 0.75; // Make secondary bubbles dimmer for depth
  
  // ===== ENHANCED CENTER SPOTLIGHT BUBBLE =====
  // Enhanced central bubble with complex pulsing patterns
  float centerDistance = length(uv - vec2(0.5));
  float centerPrimaryPulse = sin(time * 2.0) * 0.4;
  float centerSecondaryPulse = sin(time * 3.5) * 0.2;
  float centerBreathingPulse = sin(time * 0.6) * 0.3;
  
  float centerBubbleSize = 0.06 * intensity * (1.0 + centerPrimaryPulse + centerSecondaryPulse + centerBreathingPulse);
  float centerBubbleMask = 1.0 - smoothstep(centerBubbleSize * 0.4, centerBubbleSize * 0.9, centerDistance);
  
  // ===== ENHANCED COMBINATION AND BLENDING =====
  // Use smooth maximum for organic blending instead of hard max
  float corridorMask = primaryBubbleMask;
  corridorMask = max(corridorMask, secondaryBubbleMask * 0.9);
  corridorMask = max(corridorMask, centerBubbleMask * 1.1); // Center bubble slightly stronger
  
  // Enhanced radial falloff with organic variation
  vec2 center = uv - vec2(0.5);
  float radialDistance = length(center);
  float organicVariation = sin(time * 0.3 + radialDistance * 8.0) * 0.05;
  float radialFalloff = 1.0 - smoothstep(0.0, 0.65 + organicVariation, radialDistance);
  corridorMask *= radialFalloff;
  
  // Enhanced organic breathing pattern with consciousness harmonics
  float primaryBreathing = sin(time * 0.4) * 0.15;
  float secondaryBreathing = sin(time * 0.25) * 0.08;
  float consciousnessBreathing = sin(time * 0.6) * 0.05;
  float breathingCycle = 0.85 + primaryBreathing + secondaryBreathing + consciousnessBreathing;
  corridorMask *= breathingCycle;
  
  // Add subtle noise variation for organic consciousness texture
  float noisePattern = sin(radialDistance * 12.0 + time * 0.5) * cos(radialDistance * 8.0 - time * 0.3) * 0.03;
  corridorMask += noisePattern * intensity * 0.5;
  
  return clamp(corridorMask, 0.0, 1.0);
}

// Perspective depth calculation for inward flow
float calculatePerspectiveDepth(vec2 uv, float time, float flowStrength) {
  vec2 polar = toPolar(uv);
  float radius = polar.y;
  
  // Create perspective tunnel effect
  float depth = 1.0 - radius;
  depth = pow(depth, 2.2); // Gamma correction for natural falloff
  
  // Add inward flow animation
  float flowPhase = time * flowStrength + radius * 8.0;
  depth += sin(flowPhase) * 0.05 * (1.0 - radius);
  
  return clamp(depth, 0.0, 1.0);
}

// Dynamic aperture sizing based on music response
float musicResponsiveAperture(float baseMask, float beatIntensity, float bassResponse) {
  // Beat response expands apertures
  float beatExpansion = 1.0 + beatIntensity * 0.3;
  
  // Bass response adds pulsing
  float bassPulse = sin(bassResponse * 10.0) * 0.1;
  
  // Apply modulations
  float responsiveMask = baseMask * beatExpansion + bassPulse;
  
  return clamp(responsiveMask, 0.0, 1.0);
}

// ===================================================================
// DUNGEON CORRIDOR TUNNEL FUNCTIONS
// ===================================================================

// Signed distance field for rounded rectangle (corridor tunnel shape)
float roundedRectangleSDF(vec2 uv, vec2 center, vec2 size, float radius) {
  vec2 d = abs(uv - center) - size;
  return length(max(d, 0.0)) + min(max(d.x, d.y), 0.0) - radius;
}

// Apply perspective transformation for 3D tunnel illusion
vec2 perspectiveTunnelTransform(vec2 uv, float depth, float focalLength) {
  // Transform to centered coordinates
  vec2 centered = uv - 0.5;
  
  // Apply perspective projection with vanishing point at center
  float perspectiveFactor = focalLength / (focalLength + depth);
  vec2 perspective = centered * perspectiveFactor;
  
  // Return to UV space
  return perspective + 0.5;
}

// Calculate surface normal from SDF for lighting
vec2 tunnelNormalFromSDF(vec2 uv, vec2 center, vec2 size, float radius) {
  const float epsilon = 0.001;
  
  float centerSDF = roundedRectangleSDF(uv, center, size, radius);
  float rightSDF = roundedRectangleSDF(uv + vec2(epsilon, 0.0), center, size, radius);
  float upSDF = roundedRectangleSDF(uv + vec2(0.0, epsilon), center, size, radius);
  
  return normalize(vec2(rightSDF - centerSDF, upSDF - centerSDF));
}

// Advanced lighting system for dungeon corridors
vec3 calculateTunnelLighting(vec2 uv, float tunnelMask, vec2 normal, float depth, float time, float intensity) {
  // ===== AMBIENT SHADOW LAYER =====
  // Create dark base for corridor walls
  float ambientShadow = 0.15; // Base darkness level
  vec3 shadowColor = vec3(0.05, 0.08, 0.12); // Cool blue-gray shadows
  
  // ===== EDGE HIGHLIGHT LAYER =====
  // Bright rim lighting along corridor edges using surface normals
  float edgeIntensity = 1.0 - smoothstep(0.0, 0.3, tunnelMask);
  float edgeHighlight = pow(edgeIntensity, 2.0) * 0.8;
  
  // Edge lighting color shifts with music (warmer for high energy)
  vec3 edgeLightColor = mix(
    vec3(0.4, 0.5, 0.8), // Cool blue edge light
    vec3(0.8, 0.6, 0.3), // Warm orange edge light
    intensity * 0.7
  );
  
  // ===== END LIGHT SOURCE =====
  // Dynamic light at tunnel end that pulses with music
  float distanceFromCenter = length(uv - vec2(0.5));
  float endLightFalloff = 1.0 / (1.0 + distanceFromCenter * 4.0); // Inverse square falloff
  
  // Music-responsive light intensity with breathing effect
  float lightPulse = sin(time * 2.0) * 0.3 + 0.7;
  float endLightIntensity = intensity * lightPulse * endLightFalloff;
  
  // End light color temperature (cooler when distant, warmer when close)
  vec3 endLightColor = mix(
    vec3(0.3, 0.4, 0.9), // Cool distant light
    vec3(0.9, 0.7, 0.4), // Warm close light  
    endLightIntensity
  );
  
  // ===== FRESNEL EFFECT =====
  // Edge lighting intensity based on viewing angle
  vec2 viewDirection = normalize(uv - vec2(0.5));
  float fresnel = pow(1.0 - abs(dot(normal, viewDirection)), 2.0);
  
  // ===== COMBINE LIGHTING LAYERS =====
  vec3 ambientLayer = shadowColor * ambientShadow;
  vec3 edgeLayer = edgeLightColor * edgeHighlight * fresnel;
  vec3 endLayer = endLightColor * endLightIntensity * tunnelMask;
  
  // Apply depth-based attenuation
  float depthAttenuation = 1.0 - smoothstep(0.0, 1.0, depth);
  
  return (ambientLayer + edgeLayer + endLayer) * depthAttenuation;
}

// Create multiple dungeon corridor tunnels with realistic lighting
float dungeonCorridorTunnels(vec2 uv, float time, float intensity) {
  // ===== MAIN CORRIDOR TUNNELS =====
  float corridorCount = 4.0;
  float minCorridorDistance = 2.0;
  
  for(float i = 0.0; i < corridorCount; i += 1.0) {
    float corridorAngle = (i / corridorCount) * 2.0 * 3.14159 + time * 0.05;
    
    // Corridor center position with slight offset for organic feel
    vec2 corridorOffset = vec2(
      cos(corridorAngle) * 0.25,
      sin(corridorAngle) * 0.25
    );
    vec2 corridorCenter = vec2(0.5) + corridorOffset;
    
    // Apply perspective transformation for depth illusion
    float depth = 0.3 + sin(time * 0.3 + i) * 0.1;
    vec2 perspectiveUV = perspectiveTunnelTransform(uv, depth, 2.0);
    
    // Create elongated corridor tunnel shape
    vec2 corridorSize = vec2(0.15, 0.04) * (1.0 + intensity * 0.3); // Width varies with music
    float cornerRadius = 0.01;
    
    // Calculate distance to this corridor tunnel
    float corridorDistance = roundedRectangleSDF(perspectiveUV, corridorCenter, corridorSize, cornerRadius);
    minCorridorDistance = min(minCorridorDistance, corridorDistance);
  }
  
  // ===== SECONDARY TUNNEL LAYER =====
  // Add smaller secondary tunnels for depth complexity
  float secondaryCount = 2.0;
  float minSecondaryDistance = 2.0;
  
  for(float i = 0.0; i < secondaryCount; i += 1.0) {
    float secondaryAngle = (i / secondaryCount) * 2.0 * 3.14159 + time * 0.08 + 1.57;
    
    vec2 secondaryOffset = vec2(
      cos(secondaryAngle) * 0.15,
      sin(secondaryAngle) * 0.15  
    );
    vec2 secondaryCenter = vec2(0.5) + secondaryOffset;
    
    // Deeper perspective for secondary tunnels
    float secondaryDepth = 0.5 + sin(time * 0.2 + i) * 0.1;
    vec2 secondaryPerspectiveUV = perspectiveTunnelTransform(uv, secondaryDepth, 2.5);
    
    vec2 secondarySize = vec2(0.08, 0.025) * (1.0 + intensity * 0.2);
    float secondaryDistance = roundedRectangleSDF(secondaryPerspectiveUV, secondaryCenter, secondarySize, 0.005);
    minSecondaryDistance = min(minSecondaryDistance, secondaryDistance);
  }
  
  // ===== COMBINE TUNNEL LAYERS =====
  float primaryMask = 1.0 - smoothstep(0.0, 0.02, minCorridorDistance);
  float secondaryMask = 1.0 - smoothstep(0.0, 0.015, minSecondaryDistance);
  secondaryMask *= 0.7; // Dimmer secondary tunnels
  
  float combinedMask = max(primaryMask, secondaryMask);
  
  // ===== RADIAL FALLOFF FOR FOCUS =====
  vec2 center = uv - vec2(0.5);
  float radialDistance = length(center);
  float radialFalloff = 1.0 - smoothstep(0.2, 0.8, radialDistance);
  
  // ===== ORGANIC BREATHING PATTERN =====
  float breathingCycle = 0.9 + sin(time * 0.4) * 0.1;
  
  return clamp(combinedMask * radialFalloff * breathingCycle, 0.0, 1.0);
}

// Enhanced corridor gradient reveal with advanced dual-layer blending
vec4 corridorGradientReveal(vec2 uv, sampler2D gradientTex, float corridorMask, float time, float intensity) {
  // ===== ENHANCED BASE LAYER: Musical flow with consciousness awareness =====
  vec2 baseFlowUV = uv;
  vec2 flowDirection = normalize(vec2(1.0, 0.0));
  
  // Enhanced musical flow with multi-frequency modulation
  #ifdef HAS_FLOW_UNIFORMS
    flowDirection = normalize(u_musicalFlow.xy + vec2(0.001, 0.0));
  #endif
  
  // Multi-layered flow animation with consciousness patterns
  float primaryFlow = sin(time * 0.1) * 0.02;
  float organicFlow = sin(time * 0.07) * 0.015;
  float consciousnessFlow = sin(time * 0.13) * 0.008;
  
  baseFlowUV += flowDirection * (primaryFlow + organicFlow + consciousnessFlow);
  vec4 baseGradient = texture(gradientTex, vec2(baseFlowUV.x, 0.5));
  
  // Enhanced base layer with depth awareness
  vec2 polar = toPolar(uv);
  float baseDepthModulation = 1.0 + polar.y * 0.2; // Subtle depth variation
  baseGradient.rgb *= baseDepthModulation;
  
  // ===== ENHANCED CORRIDOR LAYER: Multi-dimensional inward flow =====
  float angle = polar.x;
  float radius = polar.y;
  
  // Advanced inward flow with multi-phase animation
  float primaryInwardPhase = time * 0.15 + radius * 6.0;
  float secondaryInwardPhase = time * 0.08 + radius * 4.5;
  float consciousnessInwardPhase = time * 0.22 + radius * 8.0;
  
  // Multi-layered inward flow combining multiple patterns
  float primaryInwardFlow = radius - (sin(primaryInwardPhase) * 0.1);
  float secondaryInwardFlow = radius - (cos(secondaryInwardPhase) * 0.06);
  float consciousnessInwardFlow = radius - (sin(consciousnessInwardPhase) * 0.04);
  
  float combinedInwardFlow = mix(
    mix(primaryInwardFlow, secondaryInwardFlow, 0.3),
    consciousnessInwardFlow, 0.2
  );
  
  // Enhanced gradient sampling with dual-layer coordination
  vec2 corridorFlowUV = vec2(
    fract(angle / (2.0 * 3.14159) + time * 0.02), // Slow rotation for organic feel
    clamp(combinedInwardFlow, 0.0, 1.0)
  );
  vec4 corridorGradient = texture(gradientTex, corridorFlowUV);
  
  // ===== ADVANCED DEPTH AND PERSPECTIVE =====
  float depth = calculatePerspectiveDepth(uv, time, intensity);
  
  // Enhanced tunnel brightness with organic variation
  float organicBrightnessVariation = sin(angle * 3.0 + time * 0.3) * 0.1;
  float tunnelBrightness = 1.0 + depth * 0.9 + organicBrightnessVariation;
  corridorGradient.rgb *= tunnelBrightness;
  
  // Advanced color shift with consciousness-aware color temperature
  vec3 warmShift = vec3(1.15, 1.05, 0.85); // Warm center
  vec3 coolShift = vec3(0.9, 1.0, 1.1);    // Cool edges
  vec3 colorTemperature = mix(coolShift, warmShift, depth);
  corridorGradient.rgb = mix(corridorGradient.rgb, corridorGradient.rgb * colorTemperature, depth * 0.4);
  
  // ===== ENHANCED DUAL-LAYER BLENDING =====
  // Multi-stage aperture masking for organic blending
  float softApertureMask = smoothstep(0.2, 0.8, corridorMask);
  float sharpApertureMask = smoothstep(0.4, 0.6, corridorMask);
  float organicApertureMask = mix(softApertureMask, sharpApertureMask, 0.6);
  
  // Enhanced blending with consciousness-aware mixing
  float consciousnessBlendFactor = 0.7 + sin(time * 0.4 + radius * 4.0) * 0.2;
  float dynamicIntensity = intensity * consciousnessBlendFactor;
  
  // Primary blend: base and corridor layers
  vec4 primaryBlend = mix(baseGradient, corridorGradient, organicApertureMask * dynamicIntensity);
  
  // ===== ADVANCED APERTURE EFFECTS =====
  // Enhanced rim lighting with organic variation 
  float rimLightBase = corridorMask * (1.0 - organicApertureMask);
  float rimLightVariation = sin(angle * 4.0 + time * 0.5) * 0.3 + 0.7;
  float enhancedRimLight = rimLightBase * rimLightVariation * 0.6;
  
  // Aperture glow effect for depth illusion
  float apertureGlow = softApertureMask * (1.0 - sharpApertureMask) * 0.4;
  vec3 glowColor = corridorGradient.rgb * 1.2;
  
  // ===== CONSCIOUSNESS-AWARE COLOR HARMONIZATION =====
  // Harmonize colors between layers for organic consciousness effect
  vec3 harmonizedColor = mix(
    primaryBlend.rgb,
    (primaryBlend.rgb + corridorGradient.rgb) * 0.5,
    organicApertureMask * 0.3
  );
  
  // Final composition with enhanced rim and glow effects
  vec4 finalColor = vec4(harmonizedColor, primaryBlend.a);
  finalColor.rgb += vec3(enhancedRimLight) * dynamicIntensity;
  finalColor.rgb += glowColor * apertureGlow * dynamicIntensity;
  
  // Organic breathing effect for consciousness integration
  float breathingCycle = 0.95 + sin(time * 0.3) * 0.05;
  finalColor.rgb *= breathingCycle;
  
  return finalColor;
}

// Advanced dungeon corridor gradient reveal with realistic lighting
vec4 dungeonCorridorGradientReveal(vec2 uv, sampler2D gradientTex, float corridorMask, float time, float intensity) {
  // ===== BASE LAYER: Dark stone/metal corridor walls =====
  vec4 baseWallColor = vec4(0.1, 0.12, 0.15, 1.0); // Dark stone base
  
  // ===== CORRIDOR TUNNEL CALCULATION =====
  // Use dungeon corridor tunnels instead of simple bubbles
  float tunnelMask = dungeonCorridorTunnels(uv, time, intensity);
  
  // ===== LIGHTING CALCULATION =====
  // Calculate lighting for tunnel areas
  vec2 tunnelCenter = vec2(0.5); // Simplified center for normal calculation
  vec2 tunnelSize = vec2(0.15, 0.04);
  vec2 surfaceNormal = tunnelNormalFromSDF(uv, tunnelCenter, tunnelSize, 0.01);
  
  float depth = length(uv - vec2(0.5)) * 0.5; // Distance-based depth
  vec3 tunnelLighting = calculateTunnelLighting(uv, tunnelMask, surfaceNormal, depth, time, intensity);
  
  // ===== CORRIDOR LAYER: Inward flowing magical light =====
  // Convert to polar coordinates for inward flow calculation
  vec2 polar = toPolar(uv);
  float angle = polar.x;
  float radius = polar.y;
  
  // Create magical inward flow animation - light streams toward center
  float magicalFlowPhase = time * 0.2 + radius * 8.0; // Faster flow for magical effect
  float inwardFlow = radius - (sin(magicalFlowPhase) * 0.15); // More dramatic flow
  
  // Sample gradient using inward flow for magical light colors
  vec2 corridorFlowUV = vec2(
    angle / (2.0 * 3.14159), // Normalize angle for gradient sampling
    clamp(inwardFlow, 0.0, 1.0) // Use inward flow for magical color variation
  );
  vec4 magicalLightGradient = texture(gradientTex, corridorFlowUV);
  
  // ===== ENHANCE MAGICAL LIGHT WITH MUSIC RESPONSIVENESS =====
  // Enhance magical light colors based on music intensity
  magicalLightGradient.rgb *= 1.5 + intensity * 0.8; // Brighter with music
  
  // Add magical shimmer effect
  float shimmerPhase = time * 4.0 + uv.x * 10.0 + uv.y * 8.0;
  float shimmer = sin(shimmerPhase) * 0.1 + 0.9;
  magicalLightGradient.rgb *= shimmer;
  
  // ===== DEPTH AND PERSPECTIVE EFFECTS =====
  float perspectiveDepth = calculatePerspectiveDepth(uv, time, intensity * 1.2);
  
  // Enhance magical light with depth - brighter toward tunnel end
  float tunnelEndBrightness = 1.0 + perspectiveDepth * 1.5;
  magicalLightGradient.rgb *= tunnelEndBrightness;
  
  // ===== CORRIDOR WALL TEXTURING =====
  // Add stone/metal texture to walls using noise-like patterns
  float wallTexturePhase = uv.x * 20.0 + uv.y * 15.0;
  float wallTexture = sin(wallTexturePhase) * 0.1 + 0.9;
  baseWallColor.rgb *= wallTexture;
  
  // ===== ADVANCED APERTURE BLENDING =====
  // Smooth tunnel aperture with realistic falloff
  float apertureMask = smoothstep(0.1, 0.8, tunnelMask);
  
  // ===== LIGHTING INTEGRATION =====
  // Apply calculated lighting to both wall and magical light
  vec4 litWallColor = baseWallColor;
  litWallColor.rgb += tunnelLighting; // Add ambient shadows, edge highlights, end illumination
  
  // Blend wall color with magical light streaming through tunnels
  vec4 finalColor = mix(litWallColor, magicalLightGradient, apertureMask * intensity);
  
  // ===== RIM LIGHTING FOR DEPTH ILLUSION =====
  // Enhanced rim lighting around tunnel apertures
  float rimIntensity = tunnelMask * (1.0 - apertureMask) * 0.8;
  vec3 rimColor = mix(
    vec3(0.3, 0.4, 0.8), // Cool rim light
    vec3(0.8, 0.5, 0.2), // Warm rim light
    intensity
  );
  finalColor.rgb += rimColor * rimIntensity;
  
  // ===== ATMOSPHERIC PERSPECTIVE =====
  // Add slight fog/haze effect for distance illusion
  float atmosphericHaze = depth * 0.2;
  vec3 hazeColor = vec3(0.15, 0.18, 0.25);
  finalColor.rgb = mix(finalColor.rgb, hazeColor, atmosphericHaze);
  
  return finalColor;
}`,ws=`
// Time and resolution (universal)
uniform float u_time;
uniform vec2 u_resolution;

// Enhanced consciousness field uniforms
uniform float u_rhythmicPulse;
uniform vec2 u_musicalFlow;
uniform float u_energyResonance;
uniform float u_breathingCycle;
uniform float u_membraneFluidityIndex;

// Advanced consciousness control uniforms
uniform float u_consciousnessLevel;        // 0-1 current consciousness intensity
uniform float u_awarenessLevel;           // 0-1 current awareness depth
uniform float u_emotionalIntensity;       // 0-1 emotional resonance strength
uniform float u_memoryIntensity;          // 0-1 consciousness memory patterns
uniform vec2 u_temporalFlowDirection;     // Year 3000 temporal stream direction
uniform float u_consciousnessTemperature; // Color temperature shift from consciousness

// Enhanced music sync uniforms
uniform float u_musicEnergy;
uniform float u_musicValence;
uniform float u_beatIntensity;
uniform float u_bassResponse;
uniform float u_musicalConsciousnessSync; // Music-consciousness synchronization level
uniform float u_genreConsciousnessShift;  // Genre-specific consciousness adjustments

// Corridor-specific uniforms
uniform float u_corridorIntensity;
uniform float u_corridorFlowStrength;
uniform float u_corridorDepthEffect;
uniform float u_corridorBubbleScale;

// Dungeon corridor uniforms
uniform float u_dungeonEnabled;
uniform float u_tunnelWidth;
uniform float u_lightingIntensity;
uniform float u_atmosphericHaze;
uniform vec3 u_wallColor;`,Ve=class{static buildFragmentShader(t){let{precision:e="precision mediump float;",additionalUniforms:i="",additionalFunctions:n="",mainShaderLogic:r,includeNoiseFunctions:a=!0,includeConsciousnessFunctions:s=!0,includeCorridorFunctions:o=!1}=t,l=`#version 300 es
${e}

`;return l+=ws+`

`,i&&(l+=i+`

`),l+=`out vec4 fragColor;

`,a&&(l+=vs+`

`),s&&(l+=Cs+`

`),o&&(l+=Ms+`

`),n&&(l+=n+`

`),l+=`void main() {
`,l+=`  vec2 uv = gl_FragCoord.xy / u_resolution.xy;

`,l+=r,l+=`
}`,l}static getStandardUniformNames(){return["u_time","u_resolution","u_rhythmicPulse","u_musicalFlow","u_energyResonance","u_breathingCycle","u_membraneFluidityIndex","u_consciousnessLevel","u_awarenessLevel","u_emotionalIntensity","u_memoryIntensity","u_temporalFlowDirection","u_consciousnessTemperature","u_musicEnergy","u_musicValence","u_beatIntensity","u_bassResponse","u_musicalConsciousnessSync","u_genreConsciousnessShift"]}static getWebGLUniformNames(){return[...this.getStandardUniformNames(),"u_gradientTex","u_flowStrength","u_noiseScale","u_colorIntensity","u_patternScale","u_animationSpeed"]}static getLiquidUniformNames(){return[...this.getStandardUniformNames(),"u_gradientTex","u_flowStrength","u_noiseScale","u_liquidPhase","u_breathingIntensity","u_auroraFlow","u_flowDirection","u_liquidTurbulence","u_consciousnessDepth","u_waveY","u_waveHeight","u_waveOffset","u_blurExp","u_blurMax"]}static getCorridorUniformNames(){return["u_time","u_resolution","u_gradientTex","u_rhythmicPulse","u_musicalFlow","u_energyResonance","u_breathingCycle","u_membraneFluidityIndex","u_musicEnergy","u_musicValence","u_beatIntensity","u_bassResponse","u_corridorIntensity","u_corridorFlowStrength","u_corridorDepthEffect","u_corridorBubbleScale"]}static getDungeonCorridorUniformNames(){return[...this.getCorridorUniformNames(),"u_dungeonEnabled","u_tunnelWidth","u_lightingIntensity","u_atmosphericHaze","u_wallColor"]}},X=class{static consciousnessFlowLogic(){return`
  // Calculate enhanced consciousness-driven flow
  vec2 flowDirection = calculateMusicalFlow(vec2(1.0, 0.5), u_musicalFlow, 0.5);
  float flowStrength = rhythmicPulseModulation(0.5, u_rhythmicPulse, 0.3);
  
  // Add temporal flow patterns for Year 3000 effects
  vec2 temporalFlow = temporalFlowDirection(uv, u_time, u_temporalFlowDirection);
  flowDirection += temporalFlow;
  
  // Apply enhanced breathing modulation with emotional resonance
  float breathingMod = deepConsciousnessBreathing(u_time, 0.0, u_emotionalIntensity);
  flowStrength *= (1.0 + breathingMod);
  
  // Apply consciousness field intensity
  float fieldIntensity = consciousnessFieldIntensity(uv, u_time, u_musicEnergy);
  flowStrength *= (0.5 + fieldIntensity * 0.5);`}static consciousnessNoiseSampling(){return`
  // Generate enhanced consciousness-modulated noise
  vec2 noiseUV = uv + flowDirection * u_time * 0.03;
  
  // Multi-layered consciousness noise patterns
  float noise1 = snoise(noiseUV * 2.0);
  float noise2 = snoise(noiseUV * 4.0) * 0.5;
  float memoryNoise = snoise(noiseUV * 1.5 + u_time * 0.01) * u_memoryIntensity * 0.3;
  
  // Apply consciousness field modulation
  float consciousnessModulation = consciousnessFieldIntensity(noiseUV, u_time, u_musicEnergy);
  
  // Combine noise with enhanced consciousness influence
  float t = (noise1 + noise2 + memoryNoise) * energyResonanceModulation(1.0, u_energyResonance, 0.5, 1.5);
  t *= consciousnessModulation;
  t = clamp(t * 0.5 + 0.5, 0.0, 1.0);`}static consciousnessVignette(){return`
  // Apply enhanced consciousness-aware vignette
  vec2 center = uv - 0.5;
  float breathing = deepConsciousnessBreathing(u_time, u_breathingCycle, u_emotionalIntensity);
  
  // Add membrane consciousness flow for organic boundaries
  float membraneFlow = membraneConsciousnessFlow(uv, u_membraneFluidityIndex, u_awarenessLevel);
  
  // Calculate consciousness-aware vignette with membrane dynamics
  float vignette = (0.9 + breathing + membraneFlow) - dot(center, center) * 0.3;
  
  // Apply awareness resonance to color
  color.rgb = awarenessResonance(color.rgb, u_consciousnessLevel, u_musicEnergy);
  color.rgb *= vignette;`}static musicResponsiveAlpha(){return`
  // Music-responsive alpha modulation
  float musicAlpha = 0.8 + u_beatIntensity * 0.2 + u_bassResponse * 0.1;
  color.a *= musicAlpha;`}static auroraShimmerEffect(){return`
  // Aurora shimmer overlay
  float shimmerPhase = u_time * 3.0 + uv.x * 15.0 + uv.y * 10.0;
  float shimmer = sin(shimmerPhase) * 0.03 + 0.97;
  color.rgb *= shimmer;`}},pr=class{static webglGradientFragment(){return`
  ${X.consciousnessFlowLogic()}
  
  // WebGL-specific gradient sampling
  ${X.consciousnessNoiseSampling()}
  
  // Sample gradient texture
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  
  // Apply consciousness effects
  ${X.consciousnessVignette()}
  ${X.musicResponsiveAlpha()}
  
  fragColor = color;`}static liquidConsciousnessFragment(){return`
  ${X.consciousnessFlowLogic()}
  
  // Liquid-specific turbulence and phase
  float liquidPhase = u_liquidPhase + u_rhythmicPulse * 0.5;
  vec2 turbulenceUV = uv * u_liquidTurbulence;
  float turbulence = snoise(turbulenceUV + u_time * 0.01);
  
  // Liquid consciousness noise
  vec2 liquidUV = uv + flowDirection * u_time * 0.03;
  liquidUV += vec2(sin(u_time * 0.04 + liquidPhase), cos(u_time * 0.03 + liquidPhase)) * 0.02;
  float liquidNoise = snoise(liquidUV * 2.0 + turbulence * 0.1);
  
  float t = clamp(liquidNoise * 0.5 + 0.5, 0.0, 1.0);
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  
  ${X.consciousnessVignette()}
  ${X.auroraShimmerEffect()}
  ${X.musicResponsiveAlpha()}
  
  fragColor = color;`}static corridorBubbleFragment(){return`
  ${X.consciousnessFlowLogic()}
  
  // Calculate corridor bubble mask
  float corridorMask = bubbleCorridors(uv, u_time, u_corridorIntensity * u_corridorBubbleScale);
  
  // Apply music-responsive aperture modulation
  corridorMask = musicResponsiveAperture(corridorMask, u_beatIntensity, u_bassResponse);
  
  // Generate corridor gradient reveal effect
  vec4 color = corridorGradientReveal(uv, u_gradientTex, corridorMask, u_time, u_corridorIntensity);
  
  // Apply consciousness effects
  ${X.consciousnessVignette()}
  
  // Enhanced music responsiveness for corridor effects
  float corridorMusicAlpha = 0.85 + u_beatIntensity * 0.15 + u_bassResponse * 0.05;
  color.a *= corridorMusicAlpha;
  
  // Apply corridor depth effect for enhanced dimensionality
  float depth = calculatePerspectiveDepth(uv, u_time, u_corridorFlowStrength);
  color.rgb = mix(color.rgb, color.rgb * (1.0 + depth * 0.3), u_corridorDepthEffect);
  
  fragColor = color;`}static dungeonCorridorFragment(){return`
  ${X.consciousnessFlowLogic()}
  
  // Calculate dungeon corridor tunnel mask
  float corridorMask = dungeonCorridorTunnels(uv, u_time, u_corridorIntensity * u_corridorBubbleScale);
  
  // Apply music-responsive corridor modulation  
  corridorMask = musicResponsiveAperture(corridorMask, u_beatIntensity, u_bassResponse);
  
  // Generate advanced dungeon corridor gradient reveal effect with realistic lighting
  vec4 color = dungeonCorridorGradientReveal(uv, u_gradientTex, corridorMask, u_time, u_corridorIntensity);
  
  // Apply consciousness effects for organic integration
  ${X.consciousnessVignette()}
  
  // Enhanced music responsiveness for dungeon atmosphere
  float dungeonMusicAlpha = 0.9 + u_beatIntensity * 0.1 + u_bassResponse * 0.05;
  color.a *= dungeonMusicAlpha;
  
  // Apply corridor depth effect for enhanced dimensionality
  float depth = calculatePerspectiveDepth(uv, u_time, u_corridorFlowStrength);
  color.rgb = mix(color.rgb, color.rgb * (1.0 + depth * 0.4), u_corridorDepthEffect);
  
  // Add subtle magical shimmer for mystical atmosphere
  float magicalShimmer = sin(u_time * 5.0 + uv.x * 12.0 + uv.y * 8.0) * 0.05 + 0.95;
  color.rgb *= magicalShimmer;
  
  fragColor = color;`}static advancedConsciousnessFieldFragment(){return`
  ${X.consciousnessFlowLogic()}
  
  // Calculate multi-dimensional consciousness field
  float consciousnessField = consciousnessFieldIntensity(uv, u_time, u_musicEnergy);
  
  // Apply temporal flow effects for Year 3000 streaming
  vec2 temporalUV = uv + temporalFlowDirection(uv, u_time, u_temporalFlowDirection);
  
  // Enhanced consciousness noise sampling with memory patterns
  ${X.consciousnessNoiseSampling()}
  
  // Sample gradient with consciousness field modulation
  vec4 color = texture(u_gradientTex, vec2(t * consciousnessField, 0.5));
  
  // Apply awareness resonance for consciousness-aware color
  color.rgb = awarenessResonance(color.rgb, u_consciousnessLevel, u_musicEnergy);
  
  // Enhanced membrane consciousness effects
  float membraneEffect = membraneConsciousnessFlow(temporalUV, u_membraneFluidityIndex, u_awarenessLevel);
  color.rgb *= (1.0 + membraneEffect * 0.3);
  
  // Apply consciousness memory breathing
  float memoryBreathing = consciousnessMemoryBreathing(u_time, u_breathingCycle, u_memoryIntensity);
  color.a *= (0.8 + memoryBreathing * 0.2 + u_beatIntensity * 0.1);
  
  // Enhanced consciousness vignette
  ${X.consciousnessVignette()}
  
  fragColor = color;`}static membraneConsciousnessDynamicsFragment(){return`
  ${X.consciousnessFlowLogic()}
  
  // Calculate membrane consciousness position with flow
  vec2 membraneUV = uv;
  membraneUV += temporalFlowDirection(uv, u_time, u_temporalFlowDirection);
  
  // Apply membrane consciousness flow for organic boundaries
  float membraneFlow = membraneConsciousnessFlow(membraneUV, u_membraneFluidityIndex, u_awarenessLevel);
  membraneUV += vec2(membraneFlow * 0.02);
  
  // Enhanced noise sampling with membrane distortion
  vec2 noiseUV = membraneUV + flowDirection * u_time * 0.03;
  float membraneNoise = snoise(noiseUV * 3.0 + membraneFlow);
  float consciousnessNoise = snoise(noiseUV * 1.5) * u_consciousnessLevel;
  
  // Combine membrane and consciousness noise
  float t = (membraneNoise * 0.6 + consciousnessNoise * 0.4) * 0.5 + 0.5;
  t = clamp(t, 0.0, 1.0);
  
  // Sample gradient with membrane consciousness modulation
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  
  // Apply consciousness field influence to membrane
  float fieldInfluence = consciousnessFieldIntensity(membraneUV, u_time, u_musicEnergy);
  color.rgb = awarenessResonance(color.rgb, fieldInfluence, u_musicEnergy);
  
  // Enhanced membrane breathing with emotional resonance
  float membraneBreathing = deepConsciousnessBreathing(u_time, u_breathingCycle, u_emotionalIntensity);
  color.rgb *= (0.9 + membraneBreathing * 0.2 + membraneFlow * 0.1);
  
  // Musical consciousness synchronization
  color.a *= (0.85 + u_musicalConsciousnessSync * 0.15 + u_beatIntensity * 0.1);
  
  // Apply enhanced vignette with membrane dynamics
  ${X.consciousnessVignette()}
  
  fragColor = color;`}},br=class{static generateOptimizedShader(t,e){switch(e){case"high":return t;case"medium":return t.replace(/snoise\(.*?\)/g,"snoise($1)").replace(/\* 0\.0[1-9]/g,"* 0.02");case"low":return t.replace(/snoise\(.*?\) \* 0\.[0-9]+/g,"0.5").replace(/sin\(.*?\) \* 0\.[0-9]+/g,"0.0");default:return t}}static calculateShaderComplexity(t){let e=0;return e+=(t.match(/snoise/g)||[]).length*10,e+=(t.match(/sin|cos|tan/g)||[]).length*2,e+=(t.match(/texture/g)||[]).length*3,e+=(t.match(/mix|smoothstep/g)||[]).length*1,e}static generateFallbackShader(){return Ve.buildFragmentShader({includeNoiseFunctions:!1,includeConsciousnessFunctions:!1,additionalUniforms:"uniform sampler2D u_gradientTex;",mainShaderLogic:`
  // Minimal fallback consciousness shader
  float t = uv.x + sin(u_time * 0.5 + u_rhythmicPulse) * 0.1;
  t = clamp(t, 0.0, 1.0);
  
  vec4 color = texture(u_gradientTex, vec2(t, 0.5));
  color.a *= 0.8 + u_beatIntensity * 0.2;
  
  fragColor = color;`})}},yr={Template:Ve,VERTEX_SHADER:Hc,NOISE_FUNCTIONS:vs,CONSCIOUSNESS_FUNCTIONS:Cs,CORRIDOR_FUNCTIONS:Ms,STANDARD_UNIFORMS:ws,LogicPatterns:X,Fragments:pr,Optimization:br,AdvancedEffects:{CONSCIOUSNESS_FIELD_PATTERNS:["consciousnessFieldIntensity","awarenessResonance","temporalFlowDirection","membraneConsciousnessFlow","consciousnessMemoryBreathing"],YEAR_3000_PATTERNS:["temporalFlowDirection","consciousnessMemoryBreathing","deepConsciousnessBreathing"],MEMBRANE_DYNAMICS:["membraneConsciousnessFlow","membraneFluidityEffect"]}}});var Oc,zc,Ri,Ps=y(()=>{"use strict";U();N();D();de();A();vt();ge();Es();Oc=Ve.buildFragmentShader({additionalUniforms:`
// WebGL-specific uniforms
uniform sampler2D u_gradientTex;
uniform float u_flowStrength;
uniform float u_noiseScale;
uniform float u_colorIntensity;
uniform float u_patternScale;
uniform float u_animationSpeed;

// Wave stack uniforms
uniform float u_waveY[2];
uniform float u_waveHeight[2];
uniform float u_waveOffset[2];
uniform float u_blurExp;
uniform float u_blurMax;`,additionalFunctions:`
// Octave noise for richer detail
float octaveNoise(vec2 uv, float octaves, float persistence, float scale) {
  float value = 0.0;
  float amplitude = 1.0;
  float frequency = scale;
  float maxValue = 0.0;

  for(float i = 0.0; i < octaves; i++) {
    value += snoise(uv * frequency) * amplitude;
    maxValue += amplitude;
    amplitude *= persistence;
    frequency *= 2.0;
  }

  return value / maxValue;
}

// Wave alpha calculation
float waveAlpha(vec2 uv, int waveIndex) {
  float y = uv.y;
  float waveCenter = u_waveY[waveIndex];
  float waveHeight = u_waveHeight[waveIndex];

  float distance = abs(y - waveCenter);
  return 1.0 - smoothstep(0.0, waveHeight * 0.5, distance);
}

// Dynamic blur calculation
float calculateBlur(vec2 uv) {
  vec2 center = vec2(0.5, 0.5);
  float distance = length(uv - center);
  float blur = pow(distance, u_blurExp);
  return clamp(blur, 0.0, u_blurMax);
}`,mainShaderLogic:yr.Fragments.webglGradientFragment()}),zc=Ve.buildFragmentShader({additionalUniforms:`
// WebGL-specific uniforms
uniform sampler2D u_gradientTex;
uniform float u_flowStrength;
uniform float u_noiseScale;`,includeCorridorFunctions:!0,mainShaderLogic:yr.Fragments.corridorBubbleFragment()}),Ri=class extends Q{constructor(e=w,i,n,r=null,a=null,s=null){super(e,i,n,r,a);this.canvas=null;this.wrapper=null;this.gl=null;this.shaderProgram=null;this.corridorShaderProgram=null;this.uniforms={};this.corridorUniforms={};this.gradientTexture=null;this.vertexBuffer=null;this.vao=null;this.settings={enabled:!0,intensity:"balanced",webglPersistenceMode:"adaptive",flowStrength:.7,noiseScale:1.2,waveY:[.25,.75],waveHeight:[.4,.3],waveOffset:[2.5,-1.8],blurExp:1.2,blurMax:.6,corridorEnabled:!1,corridorIntensity:.8,corridorFlowStrength:1.2,corridorDepthEffect:.6,corridorBubbleScale:1};this.isWebGLAvailable=!1;this.animationId=null;this.startTime=0;this.lastFrameTime=0;this.frameThrottleInterval=1e3/45;this.colorHarmonyEngine=null;this.cssConsciousnessController=null;this.eventSubscriptionIds=[];this.prefersReducedMotion=!1;this.consciousnessChoreographer=null;this.currentConsciousnessField=null;this.webglReady=!1;this.textureUpdatePending=!1;this.lastTextureUpdate=0;this.textureUpdateDebounceTimer=null;this.textureUpdateThrottleMs=50;this.textureUpdateDebounceMs=300;this.textureCreationInProgress=!1;this.contextLost=!1;this.pendingContextRestore=!1;this.contextLossCount=0;this.maxContextLossRetries=10;this.lastSuccessfulRender=0;this.contextRecoveryTimeouts=[100,200,400,800,1600,3200,5e3,5e3,5e3,5e3];this.currentRecoveryAttempt=0;this.currentQualityLevel=null;this.qualityCapabilities=[{name:"webgl-rendering",enabled:!0,qualityLevel:"high"},{name:"shader-complexity",enabled:!0,qualityLevel:"high"},{name:"noise-octaves",enabled:!0,qualityLevel:"medium"},{name:"wave-layers",enabled:!0,qualityLevel:"medium"},{name:"blur-effects",enabled:!0,qualityLevel:"low"},{name:"flow-strength",enabled:!0,qualityLevel:"low"},{name:"corridor-effects",enabled:!0,qualityLevel:"high"},{name:"corridor-sdf-complexity",enabled:!0,qualityLevel:"medium"},{name:"corridor-bubble-layers",enabled:!0,qualityLevel:"medium"},{name:"corridor-depth-effects",enabled:!0,qualityLevel:"low"}];this.qualityAdjustments={};this.systemName="WebGLGradientBackgroundSystem";this.lastColorHarmonizedData=null;this.lastColorHarmonizedTime=0;this.animate=()=>{if(!this.isActive||!this.gl||!this.canvas)return;let e=performance.now();if(e-this.lastFrameTime<this.frameThrottleInterval){this.animationId=requestAnimationFrame(this.animate);return}this.lastFrameTime=e,this.render(e),this.animationId=requestAnimationFrame(this.animate)};this.resize=()=>{if(!this.canvas)return;let e=window.devicePixelRatio||1,i=window.innerWidth,n=window.innerHeight;this.canvas.width=i*e,this.canvas.height=n*e,this.canvas.style.width=i+"px",this.canvas.style.height=n+"px"};this.colorHarmonyEngine=s?.colorHarmonyEngine||null,this.consciousnessChoreographer=s?.backgroundConsciousnessChoreographer||null,this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches}get systemPriority(){return"high"}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();let e=globalThis.year3000System;if(this.cssController=e?.cssConsciousnessController||T(),this.isWebGLAvailable=this.checkWebGL2Support(),!this.isWebGLAvailable)if(this.shouldAttemptWebGLRecovery()){if(u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL2 not available but persistence mode enabled - attempting WebGL1 compatibility mode"),this.isWebGLAvailable=this.checkWebGL1Support(),!this.isWebGLAvailable){u?.debug?.error("WebGLGradientBackgroundSystem","Neither WebGL2 nor WebGL1 available despite persistence mode"),this.fallbackToCSSGradient();return}}else{this.fallbackToCSSGradient();return}let i=new _;await i.initialize();let n=i.recommendPerformanceQuality(),r=i.getCapabilities();if(n==="low"?(u?.debug?.log("WebGLGradientBackgroundSystem","Low performance device detected - trying minimal WebGL quality",{performanceQuality:n,deviceCapabilities:r?.overall,memoryLevel:r?.memory.level,gpuLevel:r?.gpu.level}),this.frameThrottleInterval=1e3/20,this.textureUpdateThrottleMs=1e3,this.settings.corridorEnabled=!1,this.settings.intensity="minimal",this.settings.flowStrength=.3):u?.debug?.log("WebGLGradientBackgroundSystem","Device capabilities acceptable for WebGL",{performanceQuality:n,deviceCapabilities:r?.overall}),this.loadSettings(),!this.settings.enabled){this.fallbackToCSSGradient();return}try{await this.initializeWebGL(),this.subscribeToEvents(),this.registerWithConsciousnessChoreographer(),this.startAnimation();let a={"--sn.bg.webgl.ready":"1","--sn.bg.webgl.enabled":"1","--sn.bg.active-backend":"hybrid","--sn-gradient-crossfade-opacity":"0.5"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",a,"high","webgl-initialization"),u?.debug?.log("WebGLGradientBackgroundSystem","WebGL gradient system initialized successfully")}catch(a){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to initialize WebGL gradient:",a),this.fallbackToCSSGradient()}}checkWebGL2Support(){try{let i=document.createElement("canvas").getContext("webgl2");if(!i)return u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL2 context creation failed"),!1;let n=["EXT_color_buffer_float"],r=[];for(let o of n)i.getExtension(o)||r.push(o);r.length>0&&u?.debug?.warn("WebGLGradientBackgroundSystem","Missing WebGL2 extensions:",r);let a=i.getParameter(i.MAX_TEXTURE_SIZE),s=i.getParameter(i.MAX_RENDERBUFFER_SIZE);return u?.debug?.log("WebGLGradientBackgroundSystem","WebGL2 capability check:",{maxTextureSize:a,maxRenderbufferSize:s,missingExtensions:r.length>0?r:"none"}),!0}catch(e){return u?.debug?.error("WebGLGradientBackgroundSystem","WebGL2 support check failed:",e),!1}}checkWebGL1Support(){try{let e=document.createElement("canvas"),i=e.getContext("webgl")||e.getContext("experimental-webgl");if(!i)return u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL1 context creation failed"),!1;let n=i.getParameter(i.MAX_TEXTURE_SIZE),r=i.getParameter(i.MAX_RENDERBUFFER_SIZE);return u?.debug?.log("WebGLGradientBackgroundSystem","WebGL1 fallback capability check:",{maxTextureSize:n,maxRenderbufferSize:r}),!0}catch(e){return u?.debug?.error("WebGLGradientBackgroundSystem","WebGL1 support check failed:",e),!1}}findSpotifyContainer(){let e=[".Root__main-view",".main-view-container",".main-gridContainer-gridContainer",".Root__top-container","body"];for(let i of e){let n=document.querySelector(i);if(n)return u?.debug?.log("WebGLGradientBackgroundSystem",`Found container: ${i}`),n}return u?.debug?.warn("WebGLGradientBackgroundSystem","No Spotify container found, falling back to body"),document.body}loadSettings(){if(this.settingsManager)try{let e=this.settingsManager.get("sn-webgl-enabled"),i=this.settingsManager.get("sn-webgl-force-enabled"),n=this.settingsManager.get("sn-webgl-persistence-mode"),r=this.settingsManager.get("sn-gradient-intensity");if(e==="false"&&i!=="true"){this.settings.enabled=!1,u?.debug?.log("WebGLGradientBackgroundSystem","WebGL disabled by user setting");return}if(this.settings.webglPersistenceMode=n||"adaptive",r==="disabled"){this.settings.enabled=!1;return}switch(this.settings.intensity=r||"balanced",this.settings.intensity){case"minimal":this.settings.flowStrength=.4,this.settings.noiseScale=.8,this.settings.waveHeight=[.3,.2],this.settings.waveOffset=[1.5,-1],this.settings.blurExp=1,this.settings.blurMax=.4;break;case"balanced":this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.waveOffset=[2.5,-1.8],this.settings.blurExp=1.2,this.settings.blurMax=.6;break;case"intense":this.settings.flowStrength=1,this.settings.noiseScale=1.6,this.settings.waveHeight=[.5,.4],this.settings.waveOffset=[3.5,-2.5],this.settings.blurExp=1.4,this.settings.blurMax=.8;break}u?.debug?.log("WebGLGradientBackgroundSystem","Settings loaded:",{webglEnabled:e,webglForceEnabled:i,persistenceMode:this.settings.webglPersistenceMode,intensity:this.settings.intensity,enabled:this.settings.enabled})}catch(e){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to load settings, using defaults:",e)}}applyUpdatedSettings(e,i){if(this.settingsManager){u?.debug?.log("WebGLGradientBackgroundSystem",`Runtime setting changed: ${e} = ${i}`);try{switch(e){case"sn-webgl-enabled":i==="false"?(this.settings.enabled=!1,this.destroy()):i==="true"&&!this.settings.enabled&&(this.settings.enabled=!0,!this.gl&&this.canvas&&this.initialize());break;case"sn-webgl-force-enabled":this.settingsManager.get("sn-webgl-enabled")==="false"&&i!=="true"&&(this.settings.enabled=!1,this.destroy());break;case"sn-webgl-persistence-mode":this.settings.webglPersistenceMode=i||"adaptive",u?.debug?.log("WebGLGradientBackgroundSystem",`Persistence mode changed to: ${this.settings.webglPersistenceMode}`);break;case"sn-gradient-intensity":if(i==="disabled")this.settings.enabled=!1;else switch(this.settings.enabled=!0,this.settings.intensity=i||"balanced",this.settings.intensity){case"minimal":this.settings.flowStrength=.4,this.settings.noiseScale=.8,this.settings.waveHeight=[.3,.2],this.settings.waveOffset=[1.5,-1],this.settings.blurExp=1,this.settings.blurMax=.4;break;case"balanced":this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.waveOffset=[2.5,-1.8],this.settings.blurExp=1.2,this.settings.blurMax=.6;break;case"intense":this.settings.flowStrength=1,this.settings.noiseScale=1.6,this.settings.waveHeight=[.5,.4],this.settings.waveOffset=[3.5,-2.5],this.settings.blurExp=1.4,this.settings.blurMax=.8;break}break;default:return}this.forceRepaint?.(`setting-change:${e}`)}catch(n){u?.debug?.error("WebGLGradientBackgroundSystem",`Failed to apply runtime setting ${e}:`,n)}}}async initializeWebGL(){this.wrapper=document.createElement("div"),this.wrapper.className="sn-gradient-effects-wrapper",this.wrapper.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -11;
      pointer-events: none;
      overflow: hidden;
    `,this.canvas=document.createElement("canvas"),this.canvas.id="sn-webgl-gradient",this.canvas.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    `,this.wrapper.appendChild(this.canvas);try{if(this.gl=this.canvas.getContext("webgl2",{alpha:!0,antialias:!1,depth:!1,stencil:!1,powerPreference:"default"}),!this.gl)throw new Error("WebGL2 context creation returned null - likely unsupported");this.setupContextLossHandlers();let i=this.gl.getParameter(this.gl.VERSION);if(!i)throw new Error("WebGL2 context appears non-functional - getParameter failed");u?.debug?.log("WebGLGradientBackgroundSystem","WebGL2 context created successfully:",{version:i,renderer:this.gl.getParameter(this.gl.RENDERER),vendor:this.gl.getParameter(this.gl.VENDOR)})}catch(i){throw u?.debug?.error("WebGLGradientBackgroundSystem","WebGL2 context creation failed:",i),new Error(`Failed to create WebGL2 context: ${i instanceof Error?i.message:"Unknown error"}`)}await this.compileShaders(),this.createGeometry(),await this.updateGradientTexture(),this.setupUniforms(),this.resize(),this.findSpotifyContainer().appendChild(this.wrapper),window.addEventListener("resize",this.resize.bind(this))}async compileShaders(){if(!this.gl)throw new Error("WebGL context not available");let e=null,i=null,n="full";if(e=te.loadVertex(this.gl,St),!e)throw new Error("Failed to compile vertex shader - even basic vertex shader failed");let r=[{name:"full",shader:Oc,description:"Full consciousness shader with all features"},{name:"simplified",shader:this.getSimplifiedFragmentShader(),description:"Simplified shader without complex noise functions"},{name:"basic",shader:this.getBasicFragmentShader(),description:"Basic gradient shader with minimal features"},{name:"emergency",shader:this.getEmergencyFragmentShader(),description:"Emergency shader for maximum hardware compatibility"}];for(let s of r)try{if(i=te.loadFragment(this.gl,s.shader),i){n=s.name,u?.debug?.log("WebGLGradientBackgroundSystem",`Successfully compiled shader variant: ${s.name}`,{description:s.description});break}}catch(o){u?.debug?.warn("WebGLGradientBackgroundSystem",`Failed to compile ${s.name} shader variant:`,o);continue}if(!i)throw new Error("Failed to compile any fragment shader variant");if(this.shaderProgram=te.createProgram(this.gl,e,i),!this.shaderProgram)throw new Error("Failed to create shader program");let a=te.loadFragment(this.gl,zc);if(!a){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to compile corridor shader - corridor effects disabled"),this.settings.corridorEnabled=!1;return}this.corridorShaderProgram=te.createProgram(this.gl,e,a),this.corridorShaderProgram||(u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to create corridor shader program - corridor effects disabled"),this.settings.corridorEnabled=!1)}createGeometry(){if(!this.gl||!this.shaderProgram)return;let e=new Float32Array([-1,-1,3,-1,-1,3]);this.vertexBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.STATIC_DRAW),this.vao=this.gl.createVertexArray(),this.gl.bindVertexArray(this.vao);let i=this.gl.getAttribLocation(this.shaderProgram,"a_position");this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,0,0),this.gl.bindVertexArray(null)}setupUniforms(){!this.gl||!this.shaderProgram||(this.uniforms.u_time=this.gl.getUniformLocation(this.shaderProgram,"u_time"),this.uniforms.u_gradientTex=this.gl.getUniformLocation(this.shaderProgram,"u_gradientTex"),this.uniforms.u_resolution=this.gl.getUniformLocation(this.shaderProgram,"u_resolution"),this.uniforms.u_flowStrength=this.gl.getUniformLocation(this.shaderProgram,"u_flowStrength"),this.uniforms.u_noiseScale=this.gl.getUniformLocation(this.shaderProgram,"u_noiseScale"),this.uniforms.u_waveY=this.gl.getUniformLocation(this.shaderProgram,"u_waveY"),this.uniforms.u_waveHeight=this.gl.getUniformLocation(this.shaderProgram,"u_waveHeight"),this.uniforms.u_waveOffset=this.gl.getUniformLocation(this.shaderProgram,"u_waveOffset"),this.uniforms.u_blurExp=this.gl.getUniformLocation(this.shaderProgram,"u_blurExp"),this.uniforms.u_blurMax=this.gl.getUniformLocation(this.shaderProgram,"u_blurMax"),this.corridorShaderProgram&&this.setupCorridorUniforms())}setupCorridorUniforms(){if(!this.gl||!this.corridorShaderProgram)return;let e=Ve.getCorridorUniformNames();for(let i of e)this.corridorUniforms[i]=this.gl.getUniformLocation(this.corridorShaderProgram,i)}updateConsciousnessUniforms(e,i){if(!this.gl)return;let n=this.currentConsciousnessField,r=n?.rhythmicPulse??.5;e.u_rhythmicPulse&&this.gl.uniform1f(e.u_rhythmicPulse,r);let a=n?.musicalFlow??[0,0];if(e.u_musicalFlow&&Array.isArray(a)){let m=a;this.gl.uniform2f(e.u_musicalFlow,m[0]??0,m[1]??0)}let s=n?.energyResonance??.5;e.u_energyResonance&&this.gl.uniform1f(e.u_energyResonance,s);let o=Math.sin(i*.05)*.5+.5;e.u_breathingCycle&&this.gl.uniform1f(e.u_breathingCycle,o);let l=n?.membraneFluidityIndex??.3;if(e.u_membraneFluidityIndex&&this.gl.uniform1f(e.u_membraneFluidityIndex,l),this.musicSyncService){let m=this.musicSyncService.getCurrentMusicState();if(m){let d=m.beat?.energy??.5,h=m.emotion?.valence??.5,p=m.intensity??0,b=m.beat?.energy??0;e.u_musicEnergy&&this.gl.uniform1f(e.u_musicEnergy,d),e.u_musicValence&&this.gl.uniform1f(e.u_musicValence,h),e.u_beatIntensity&&this.gl.uniform1f(e.u_beatIntensity,p),e.u_bassResponse&&this.gl.uniform1f(e.u_bassResponse,b)}}}async updateGradientTexture(){if(!this.gl){u?.debug?.warn("WebGLGradientBackgroundSystem","No WebGL context available");return}if(!this.isContextValid()){u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL context invalid, attempting recovery"),this.contextLost&&!this.pendingContextRestore&&(u?.debug?.log("WebGLGradientBackgroundSystem","Attempting WebGL context recovery"),this.fallbackToCSSGradient());return}let e=this.gl.getError();if(e!==this.gl.NO_ERROR)for(u?.debug?.warn("WebGLGradientBackgroundSystem",`WebGL error detected before texture update: ${e}`);this.gl.getError()!==this.gl.NO_ERROR;);if(this.textureCreationInProgress){u?.debug?.log("WebGLGradientBackgroundSystem","Texture creation already in progress, skipping update");return}this.textureCreationInProgress=!0;try{let i=this.getDefaultGradientStops(),n="default";if(this.colorHarmonyEngine)try{let o=this.colorHarmonyEngine.getCurrentGradient(5);if(o&&o.length>0)i=o.map((l,m)=>({r:l.r/255,g:l.g/255,b:l.b/255,a:1,position:m/(o.length-1)})),n="ColorHarmonyEngine",u?.debug?.log("WebGLGradientBackgroundSystem",`Updated gradient texture with ${i.length} stops from ColorHarmonyEngine`);else{let l=this.getCSSGradientStops();l&&l.length>0&&(i=l,n="CSS variables",u?.debug?.log("WebGLGradientBackgroundSystem",`ColorHarmonyEngine returned empty, using CSS gradient fallback with ${i.length} stops`))}}catch(o){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to get gradient from ColorHarmonyEngine, trying CSS fallback:",o);let l=this.getCSSGradientStops();l&&l.length>0&&(i=l,n="CSS variables (engine failed)",u?.debug?.log("WebGLGradientBackgroundSystem",`Using CSS gradient fallback after ColorHarmonyEngine error with ${i.length} stops`))}else{let o=this.getCSSGradientStops();o&&o.length>0&&(i=o,n="CSS variables (no engine)",u?.debug?.log("WebGLGradientBackgroundSystem",`No ColorHarmonyEngine available, using CSS gradient fallback with ${i.length} stops`))}if(u?.debug?.log("WebGLGradientBackgroundSystem",`Final color source: ${n}, stops: ${i.length}`),this.gl.isContextLost())throw new Error("WebGL context was lost during gradient preparation");if(this.gradientTexture){try{this.gl.deleteTexture(this.gradientTexture)}catch(o){u?.debug?.warn("WebGLGradientBackgroundSystem","Error deleting old texture:",o)}this.gradientTexture=null}(!i||i.length===0)&&(u?.debug?.warn("WebGLGradientBackgroundSystem","No valid color stops, using defaults"),i=this.getDefaultGradientStops());let r=null,a=0,s=3;for(;!r&&a<s;){a++;try{if(this.gl.isContextLost())throw new Error("WebGL context lost during texture creation attempt");if(r=le(this.gl,i),r){u?.debug?.log("WebGLGradientBackgroundSystem",`Gradient texture created successfully on attempt ${a}`);break}}catch(o){u?.debug?.warn("WebGLGradientBackgroundSystem",`Texture creation attempt ${a} failed:`,o),a<s&&await new Promise(l=>setTimeout(l,a*10))}}if(r)this.gradientTexture=r;else{u?.debug?.error("WebGLGradientBackgroundSystem","Failed to create gradient texture after all attempts - trying default colors");try{let o=this.getDefaultGradientStops(),l=le(this.gl,o);if(!l)throw new Error("Failed to create gradient texture even with default colors");this.gradientTexture=l,i=o,u?.debug?.log("WebGLGradientBackgroundSystem","Using default gradient fallback after all attempts failed")}catch(o){u?.debug?.error("WebGLGradientBackgroundSystem","Default gradient fallback failed, attempting emergency solid color:",o);try{let l=[{r:.196,g:.165,b:.282,a:1,position:0},{r:.196,g:.165,b:.282,a:1,position:1}],m=le(this.gl,l);if(m)this.gradientTexture=m,i=l,u?.debug?.warn("WebGLGradientBackgroundSystem","Using emergency solid color texture as final fallback");else throw new Error("Emergency solid color texture creation failed")}catch(l){throw u?.debug?.error("WebGLGradientBackgroundSystem","Emergency solid color texture failed:",l),new Error(`All gradient texture creation methods failed: ${l}`)}}}this.lastTextureUpdate=performance.now(),u?.debug?.log("WebGLGradientBackgroundSystem",`Gradient texture updated successfully using ${n}`,{colorStops:i.length,source:n,firstColor:i[0]?`rgb(${Math.round(i[0].r*255)},${Math.round(i[0].g*255)},${Math.round(i[0].b*255)})`:"none"})}catch(i){if(u?.debug?.error("WebGLGradientBackgroundSystem","Critical error in updateGradientTexture:",i),i instanceof Error&&i.message.includes("context"))u?.debug?.log("WebGLGradientBackgroundSystem","WebGL context-related error detected, switching to CSS fallback"),this.fallbackToCSSGradient();else{u?.debug?.log("WebGLGradientBackgroundSystem","Attempting simple texture recovery with default colors");try{this.gradientTexture=null;let n=this.getDefaultGradientStops();if(this.gl&&!this.gl.isContextLost())if(this.gradientTexture=le(this.gl,n),this.gradientTexture)u?.debug?.log("WebGLGradientBackgroundSystem","Successfully recovered with default gradient");else throw new Error("Recovery attempt failed");else throw new Error("WebGL context unavailable for recovery")}catch(n){u?.debug?.error("WebGLGradientBackgroundSystem","Recovery attempt failed, falling back to CSS:",n),this.fallbackToCSSGradient()}}}finally{this.textureCreationInProgress=!1}}async updateGradientTextureThrottled(){let e=performance.now();if(e-this.lastTextureUpdate<this.textureUpdateThrottleMs){if(!this.textureUpdatePending){this.textureUpdatePending=!0;let i=this.textureUpdateThrottleMs-(e-this.lastTextureUpdate);setTimeout(()=>{this.textureUpdatePending=!1,this.updateGradientTexture().catch(n=>{u?.debug?.error("WebGLGradientBackgroundSystem","Throttled texture update failed:",n)})},i)}return}await this.updateGradientTexture()}debouncedUpdateGradientTexture(){this.textureUpdateDebounceTimer&&clearTimeout(this.textureUpdateDebounceTimer),this.textureUpdateDebounceTimer=window.setTimeout(()=>{this.textureUpdateDebounceTimer=null,this.updateGradientTextureThrottled().catch(e=>{u?.debug?.error("WebGLGradientBackgroundSystem","Debounced texture update failed:",e)})},this.textureUpdateDebounceMs)}setupContextLossHandlers(){if(!this.canvas)return;this.canvas.addEventListener("webglcontextlost",async i=>{if(this.contextLossCount++,u?.debug?.warn("WebGLGradientBackgroundSystem","WebGL context lost - Enhanced Recovery",{lossCount:this.contextLossCount,maxRetries:this.maxContextLossRetries}),i.preventDefault(),this.contextLost=!0,this.textureCreationInProgress=!1,this.contextLossCount<=this.maxContextLossRetries){let n=Math.min(this.contextLossCount-1,this.contextRecoveryTimeouts.length-1),r=this.contextRecoveryTimeouts[n]||5e3;if(u?.debug?.log("WebGLGradientBackgroundSystem",`Preparing for context recovery attempt ${this.contextLossCount}/${this.maxContextLossRetries} with ${r}ms backoff`,{shouldPersist:this.shouldPersistWebGL()}),this.gl)try{let{ShaderLoader:a}=await Promise.resolve().then(()=>(vt(),Rn));a.clearContextCache(this.gl)}catch{}this.textureUpdateDebounceTimer&&(clearTimeout(this.textureUpdateDebounceTimer),this.textureUpdateDebounceTimer=null),this.textureUpdatePending=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}else this.shouldPersistWebGL()?(u?.debug?.warn("WebGLGradientBackgroundSystem",`Context lost ${this.contextLossCount} times but persistence mode enabled - resetting retry count and continuing`),this.contextLossCount=Math.max(1,this.maxContextLossRetries-3),this.currentRecoveryAttempt=0):(u?.debug?.error("WebGLGradientBackgroundSystem",`Context lost ${this.contextLossCount} times - falling back to CSS gradient`),this.fallbackToCSSGradient())},!1);let e=async()=>{if(!this.contextLost||this.pendingContextRestore)return;let i=Math.min(this.currentRecoveryAttempt,this.contextRecoveryTimeouts.length-1),n=this.contextRecoveryTimeouts[i]||5e3;u?.debug?.log("WebGLGradientBackgroundSystem",`Attempting context recovery in ${n}ms (attempt ${this.currentRecoveryAttempt+1})`),setTimeout(async()=>{if(this.contextLost){this.currentRecoveryAttempt++;try{this.gl&&this.gl.isContextLost()&&this.gl.getError()}catch(r){u?.debug?.warn("WebGLGradientBackgroundSystem","Error during context recovery attempt:",r)}this.contextLost&&this.currentRecoveryAttempt<this.maxContextLossRetries&&e()}},n)};this.canvas.addEventListener("webglcontextlost",()=>{this.currentRecoveryAttempt=0,e()}),this.canvas.addEventListener("webglcontextrestored",async()=>{u?.debug?.log("WebGLGradientBackgroundSystem","WebGL context restored - Enhanced Recovery",{lossCount:this.contextLossCount,maxRetries:this.maxContextLossRetries}),this.contextLost=!1,this.pendingContextRestore=!0;try{if(!this.gl||this.gl.isContextLost())throw new Error("Context is still lost after restore event");await this.reinitializeWebGLResources(),this.contextLossCount>=2?(u?.debug?.log("WebGLGradientBackgroundSystem","Reducing quality after multiple context losses"),this.adjustQualityForTier("low")):this.contextLossCount>=1&&(u?.debug?.log("WebGLGradientBackgroundSystem","Reducing quality after context loss"),this.adjustQualityForTier("medium")),this.startAnimation(),this.pendingContextRestore=!1,u?.debug?.log("WebGLGradientBackgroundSystem","WebGL context restore completed successfully",{lossCount:this.contextLossCount,qualityReduced:this.contextLossCount>0})}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to restore WebGL context:",i),this.pendingContextRestore=!1,this.contextLossCount++,this.contextLossCount>this.maxContextLossRetries&&(u?.debug?.error("WebGLGradientBackgroundSystem","Context restoration failed too many times - falling back to CSS"),this.fallbackToCSSGradient())}},!1)}async reinitializeWebGLResources(){if(!this.gl)throw new Error("WebGL context not available");this.shaderProgram=null,this.vertexBuffer=null,this.vao=null,this.gradientTexture=null;let{ShaderLoader:e}=await Promise.resolve().then(()=>(vt(),Rn));e.clearContextCache(this.gl),await this.compileShaders(),this.createGeometry(),await this.updateGradientTexture(),this.setupUniforms(),u?.debug?.log("WebGLGradientBackgroundSystem","WebGL resources reinitialized after context restore")}isContextValid(){return!this.gl||this.contextLost?!1:this.gl.isContextLost()?(this.contextLost=!0,!1):!0}getDefaultGradientStops(){return[{r:.196,g:.165,b:.282,a:1,position:0},{r:.549,g:.408,b:.878,a:1,position:.3},{r:.788,g:.557,b:.902,a:1,position:.6},{r:.957,g:.761,b:.494,a:1,position:1}]}getCSSGradientStops(){try{let e=document.documentElement,i=getComputedStyle(e),n=["--sn-bg-gradient-primary-rgb","--sn-bg-gradient-secondary-rgb","--sn-bg-gradient-tertiary-rgb"],r=[];for(let o=0;o<n.length;o++){let l=n[o]||"--sn-bg-gradient-primary-rgb",m=i.getPropertyValue(l).trim();if(!m){u?.debug?.log("WebGLGradientBackgroundSystem",`CSS variable ${l} not set, trying without CSS fallback`);continue}let d=m.split(",").map(h=>parseInt(h.trim(),10));if(d.length!==3||d.some(h=>isNaN(h)||h<0||h>255)){u?.debug?.warn("WebGLGradientBackgroundSystem",`Invalid RGB values in ${l}: ${m}, skipping this color`);continue}r.push({r:(d[0]??0)/255,g:(d[1]??0)/255,b:(d[2]??0)/255,a:1,position:o/(n.length-1)})}if(r.length<2)return u?.debug?.log("WebGLGradientBackgroundSystem",`Only ${r.length} valid CSS colors found, need at least 2 for gradient`),null;let a=i.getPropertyValue("--sn-bg-gradient-opacity").trim(),s=a?parseFloat(a):1;return s!==1&&s>0&&s<=1&&r.forEach(o=>{o.a=s}),u?.debug?.log("WebGLGradientBackgroundSystem",`Successfully parsed ${r.length} CSS background gradient stops from OKLAB inheritance`,{colors:r.map(o=>`rgba(${Math.round(o.r*255)},${Math.round(o.g*255)},${Math.round(o.b*255)},${o.a})`),opacity:s!==1?s:"default"}),r}catch(e){return u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to parse CSS background gradient variables:",e),null}}subscribeToEvents(){let e=g.subscribe("colors:harmonized",this.handleColorHarmonized.bind(this),"WebGLGradientBackgroundSystem");this.eventSubscriptionIds.push(e);let i=g.subscribe("colors:applied",this.handleColorApplied.bind(this),"WebGLGradientBackgroundSystem");this.eventSubscriptionIds.push(i);let n=g.subscribe("performance:tier-changed",this.handlePerformanceTierChanged.bind(this),"WebGLGradientBackgroundSystem");this.eventSubscriptionIds.push(n),u?.debug?.log("WebGLGradientBackgroundSystem","Subscribed to unified events",{subscriptionCount:this.eventSubscriptionIds.length,events:["colors:harmonized","colors:applied","performance:tier-changed"]})}handleColorHarmonized(e){let i=performance.now(),n=`${e.accentHex}-${e.processingTime}-${e.strategies.join(",")}`;if(this.lastColorHarmonizedData===n&&i-this.lastColorHarmonizedTime<100){u?.debug?.log("WebGLGradientBackgroundSystem","Duplicate color harmonization event detected, skipping");return}this.lastColorHarmonizedData=n,this.lastColorHarmonizedTime=i,this.debouncedUpdateGradientTexture(),u?.debug?.log("WebGLGradientBackgroundSystem","Color harmonization processed",{strategies:e.strategies,processingTime:e.processingTime,accentHex:e.accentHex,deduplicationHash:n.substring(0,16)+"..."})}handleColorApplied(e){u?.debug?.log("WebGLGradientBackgroundSystem","Color application coordinated",{accentHex:e.accentHex,appliedAt:e.appliedAt})}handlePerformanceTierChanged(e){if(!(!this.isActive||!this.gl))switch(u?.debug?.log("WebGLGradientBackgroundSystem","Performance tier changed",{previousTier:e.previousTier,newTier:e.tier,timestamp:e.timestamp}),e.tier){case"excellent":this.adjustQualityForTier("high");break;case"good":this.adjustQualityForTier("medium");break;case"degraded":this.adjustQualityForTier("low"),u?.debug?.warn("WebGLGradientBackgroundSystem","Performance degraded - reducing WebGL quality instead of fallback");break;case"critical":e.previousTier==="degraded"?this.shouldPersistWebGL()?(u?.debug?.warn("WebGLGradientBackgroundSystem","Critical performance but persistence mode enabled - reducing to absolute minimum WebGL quality"),this.adjustQualityForTier("emergency")):(u?.debug?.warn("WebGLGradientBackgroundSystem","Critical performance detected - falling back to CSS gradient"),this.fallbackToCSSGradient()):(this.adjustQualityForTier("minimal"),u?.debug?.warn("WebGLGradientBackgroundSystem","Critical performance - using minimal WebGL quality"));break}}adjustQualityForTier(e){if(!this.gl||!this.canvas)return;switch(e){case"high":this.frameThrottleInterval=1e3/60;break;case"medium":this.frameThrottleInterval=1e3/45;break;case"low":this.frameThrottleInterval=1e3/30;break;case"minimal":this.frameThrottleInterval=1e3/15;break;case"emergency":this.frameThrottleInterval=1e3/10;break}switch(e){case"high":this.textureUpdateThrottleMs=100;break;case"medium":this.textureUpdateThrottleMs=200;break;case"low":this.textureUpdateThrottleMs=500;break;case"minimal":this.textureUpdateThrottleMs=1e3;break;case"emergency":this.textureUpdateThrottleMs=2e3;break}let i=this.findSpotifyContainer();if(i){let r=i.getBoundingClientRect(),a=1;switch(e){case"high":a=1;break;case"medium":a=.8;break;case"low":a=.6;break;case"minimal":a=.4;break;case"emergency":a=.1;break}let s=Math.floor(r.width*a),o=Math.floor(r.height*a);this.canvas.width=s,this.canvas.height=o,this.gl&&this.gl.viewport(0,0,s,o)}let n=this.settings.corridorEnabled;switch(e){case"high":this.settings.intensity="intense",this.settings.flowStrength=Math.max(this.settings.flowStrength,.7);break;case"medium":this.settings.intensity="balanced",this.settings.flowStrength=Math.min(this.settings.flowStrength,.6);break;case"low":this.settings.corridorEnabled=!1,this.settings.intensity="minimal",this.settings.flowStrength=Math.min(this.settings.flowStrength,.4);break;case"minimal":this.settings.corridorEnabled=!1,this.settings.intensity="minimal",this.settings.flowStrength=.2;break}n!==this.settings.corridorEnabled&&u?.debug?.log("WebGLGradientBackgroundSystem",`Corridor shader ${this.settings.corridorEnabled?"enabled":"disabled"} for ${e} quality`),u?.debug?.log("WebGLGradientBackgroundSystem",`Quality adjusted for ${e} performance tier`,{frameFPS:Math.round(1e3/this.frameThrottleInterval),textureFPS:Math.round(1e3/this.textureUpdateThrottleMs),canvasResolution:`${this.canvas.width}x${this.canvas.height}`,corridorEnabled:this.settings.corridorEnabled})}startAnimation(){this.startTime=performance.now(),this.lastFrameTime=this.startTime,this.animate()}render(e){if(!this.gl||!this.vao)return;if(!this.gradientTexture){u?.debug?.warn("WebGLGradientBackgroundSystem","No gradient texture during render - creating emergency texture");try{let s=[()=>{let o=this.getCSSGradientStops();return o?le(this.gl,o):null},()=>{let o=this.getDefaultGradientStops();return le(this.gl,o)},()=>{let o=[{r:.196,g:.165,b:.282,a:1,position:0},{r:.196,g:.165,b:.282,a:1,position:1}];return le(this.gl,o)}];for(let o=0;o<s.length;o++)try{if(this.gradientTexture=s[o](),this.gradientTexture){u?.debug?.log("WebGLGradientBackgroundSystem",`Emergency texture created using method ${o+1}`);break}}catch(l){u?.debug?.warn("WebGLGradientBackgroundSystem",`Emergency texture method ${o+1} failed:`,l)}if(!this.gradientTexture){u?.debug?.error("WebGLGradientBackgroundSystem","All emergency texture creation methods failed - skipping render");return}}catch(s){u?.debug?.error("WebGLGradientBackgroundSystem","Emergency texture creation failed completely:",s);return}}if(this.lastSuccessfulRender=e,this.contextLossCount>0&&e-this.lastSuccessfulRender>3e4){let s=this.contextLossCount;this.contextLossCount=Math.max(0,this.contextLossCount-1),s!==this.contextLossCount&&u?.debug?.log("WebGLGradientBackgroundSystem","Context loss count reduced due to successful renders",{oldCount:s,newCount:this.contextLossCount})}let i=this.settings.corridorEnabled&&this.corridorShaderProgram&&this.currentQualityLevel!=="low",n=i?this.corridorShaderProgram:this.shaderProgram,r=i?this.corridorUniforms:this.uniforms;if(!n)return;if(this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.useProgram(n),this.gl.bindVertexArray(this.vao),!this.webglReady){this.webglReady=!0;let s={"--sn.bg.webgl.ready":"1","--sn.bg.webgl.enabled":"1","--sn.bg.active-backend":"hybrid","--sn-gradient-crossfade-opacity":"0.5"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",s,"critical","webgl-first-draw")}let a=this.prefersReducedMotion?0:(e-this.startTime)/1e3;if(r.u_time&&this.gl.uniform1f(r.u_time,a),r.u_resolution&&this.gl.uniform2f(r.u_resolution,this.canvas.width,this.canvas.height),r.u_flowStrength){let s=this.settings.flowStrength;try{let l=getComputedStyle(document.documentElement).getPropertyValue("--sn-flow-strength").trim();l&&(s=parseFloat(l))}catch{u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to read flow strength CSS variable, using settings value")}this.gl.uniform1f(r.u_flowStrength,s)}r.u_noiseScale&&this.gl.uniform1f(r.u_noiseScale,this.settings.noiseScale),i||(r.u_waveY&&this.gl.uniform1fv(r.u_waveY,this.settings.waveY),r.u_waveHeight&&this.gl.uniform1fv(r.u_waveHeight,this.settings.waveHeight),r.u_waveOffset&&this.gl.uniform1fv(r.u_waveOffset,this.settings.waveOffset),r.u_blurExp&&this.gl.uniform1f(r.u_blurExp,this.settings.blurExp),r.u_blurMax&&this.gl.uniform1f(r.u_blurMax,this.settings.blurMax)),i&&(r.u_corridorIntensity&&this.gl.uniform1f(r.u_corridorIntensity,this.settings.corridorIntensity),r.u_corridorFlowStrength&&this.gl.uniform1f(r.u_corridorFlowStrength,this.settings.corridorFlowStrength),r.u_corridorDepthEffect&&this.gl.uniform1f(r.u_corridorDepthEffect,this.settings.corridorDepthEffect),r.u_corridorBubbleScale&&this.gl.uniform1f(r.u_corridorBubbleScale,this.settings.corridorBubbleScale),this.updateConsciousnessUniforms(r,a)),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.gradientTexture),r.u_gradientTex&&this.gl.uniform1i(r.u_gradientTex,0),this.gl.drawArrays(this.gl.TRIANGLES,0,3),this.gl.bindVertexArray(null)}fallbackToCSSGradient(){let e={"--sn.bg.webgl.ready":"0","--sn.bg.webgl.enabled":"0","--sn.bg.active-backend":"css","--sn-gradient-crossfade-opacity":"0"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",e,"critical","webgl-css-fallback"),this.cssConsciousnessController&&this.startCSSFallbackAnimation(),u?.debug?.log("WebGLGradientBackgroundSystem","Using CSS gradient fallback")}startCSSFallbackAnimation(){if(!this.cssConsciousnessController)return;let e=()=>{if(!this.isActive)return;let i=performance.now()/1e3,n=Math.sin(i*.04)*20+Math.sin(i*.07)*8,r=Math.cos(i*.05)*20+Math.cos(i*.09)*6,a=1.15+Math.sin(i*.03)*.2,s={"--sn-gradient-flow-x":`${n}%`,"--sn-gradient-flow-y":`${r}%`,"--sn-gradient-flow-scale":a.toString()};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",s,"normal","css-fallback-animation"),setTimeout(e,this.frameThrottleInterval)};e()}handleSettingsChange(e){super.handleSettingsChange(e);let i=e,{key:n,value:r}=i.detail;if(n==="sn-gradient-intensity"){let a=this.settings.enabled;this.settings.intensity=r,this.loadSettings(),r==="disabled"&&a?(this.settings.enabled=!1,this.destroy(),this.fallbackToCSSGradient()):this.settings.enabled&&!a&&this.isWebGLAvailable&&this.initialize()}}_performSystemSpecificCleanup(){if(super._performSystemSpecificCleanup(),this.consciousnessChoreographer)try{this.consciousnessChoreographer.unregisterConsciousnessParticipant("WebGLGradientBackgroundSystem"),u?.debug?.log("WebGLGradientBackgroundSystem","Unregistered from consciousness choreographer")}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Error unregistering from consciousness choreographer:",i)}this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.textureUpdateDebounceTimer&&(clearTimeout(this.textureUpdateDebounceTimer),this.textureUpdateDebounceTimer=null),this.textureUpdatePending=!1,this.textureCreationInProgress=!1,this.lastColorHarmonizedData=null,this.gl&&(this.gradientTexture&&(this.gl.deleteTexture(this.gradientTexture),this.gradientTexture=null),this.vertexBuffer&&(this.gl.deleteBuffer(this.vertexBuffer),this.vertexBuffer=null),this.vao&&(this.gl.deleteVertexArray(this.vao),this.vao=null),this.shaderProgram&&(this.gl.deleteProgram(this.shaderProgram),this.shaderProgram=null),te.clearCache(this.gl)),this.wrapper&&this.wrapper.parentNode&&(this.wrapper.parentNode.removeChild(this.wrapper),this.wrapper=null),this.canvas=null,this.eventSubscriptionIds.forEach(i=>{g.unsubscribe(i)}),this.eventSubscriptionIds=[],u?.debug?.log("WebGLGradientBackgroundSystem","Unified event subscriptions cleaned up"),window.removeEventListener("resize",this.resize),this.gl=null;let e={"--sn.bg.webgl.ready":"0","--sn.bg.webgl.enabled":"0","--sn.bg.active-backend":"css","--sn-gradient-crossfade-opacity":"0"};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",e,"critical","webgl-system-cleanup")}forceRepaint(e="settings-change"){this.isActive&&this.gradientTexture&&this.updateGradientTexture().catch(i=>{u?.debug?.error("WebGLGradientBackgroundSystem","Failed to repaint gradient:",i)})}setWaveY(e){this.settings.waveY=e}setWaveHeight(e){this.settings.waveHeight=e}setWaveOffset(e){this.settings.waveOffset=e}setBlurSettings(e,i){this.settings.blurExp=e,this.settings.blurMax=i}getMetrics(){return{fps:this.performanceMonitor?.getMedianFPS?.()||0,compileErrors:0,isActive:this.isActive,settings:{...this.settings}}}stopAnimation(){this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)}updateAnimation(e,i){!this.isActive||!this.gl||!this.isWebGLAvailable||this.shouldSkipFrame(e)||(this.shouldUpdateTexture()&&this.currentQualityLevel!=="low"&&this.updateGradientTextureThrottled(),this.webglReady?this.render(e):this.ensureBasicResources())}shouldSkipFrame(e){if(!this.frameThrottleInterval)return!1;let n=e-(this.lastFrameTime||0)<this.frameThrottleInterval;return n||(this.lastFrameTime=e),n}shouldUpdateTexture(){return performance.now()-this.lastTextureUpdate>=this.textureUpdateThrottleMs}ensureBasicResources(){if(!(!this.gl||this.contextLost)&&!this.gradientTexture)try{let e=this.getDefaultGradientStops();this.gradientTexture=le(this.gl,e),this.gradientTexture&&u?.debug?.log("WebGLGradientBackgroundSystem","Emergency gradient texture created during animation update")}catch(e){u?.debug?.warn("WebGLGradientBackgroundSystem","Failed to create emergency gradient texture:",e)}}async healthCheck(){return{ok:this.webglReady,details:this.webglReady?"WebGL system nominal":"WebGL not initialized"}}resizeTo(e,i){this.canvas&&(this.canvas.width=e,this.canvas.height=i,this.resize?.())}registerWithConsciousnessChoreographer(){if(!this.consciousnessChoreographer){u?.debug?.log("WebGLGradientBackgroundSystem","Consciousness choreographer not available, skipping registration");return}try{this.consciousnessChoreographer.registerConsciousnessParticipant(this),u?.debug?.log("WebGLGradientBackgroundSystem","Successfully registered with consciousness choreographer")}catch(e){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to register with consciousness choreographer:",e)}}getConsciousnessContribution(){return{webglLuminosity:this.settings.flowStrength||.5,shaderComplexity:this.isWebGLAvailable?.8:0,gpuUtilization:this.isWebGLAvailable?.6:0,renderingPipeline:"forward",textureResolution:1}}onConsciousnessFieldUpdate(e){if(!(!this.isWebGLAvailable||!this.webglReady))try{this.currentConsciousnessField=e,this.updateShaderFromConsciousness(e),u?.debug?.log("WebGLGradientBackgroundSystem","Updated from consciousness field:",{rhythmicPulse:e.rhythmicPulse,webglLuminosity:e.webglLuminosity,emotionalTemperature:e.emotionalTemperature})}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Error updating from consciousness field:",i)}}onChoreographyEvent(e,i){if(!(!this.isWebGLAvailable||!this.webglReady))try{switch(e){case"choreography:rhythm-shift":this.frameThrottleInterval=1e3/Math.max(30,Math.min(60,i.newRhythm?.bpm/2||45));break;case"choreography:energy-surge":let n=i.intensity||1;this.cssController.setVariable("WebGLGradientBackgroundSystem","--sn-webgl-energy-surge",n.toString(),"high","choreography-energy-surge");break;case"consciousness:breathing-cycle":let r=i.phase||0;this.cssController.setVariable("WebGLGradientBackgroundSystem","--sn-webgl-breathing-sync",r.toString(),"normal","consciousness-breathing-cycle");break}u?.debug?.log("WebGLGradientBackgroundSystem",`Handled choreography event: ${e}`,i)}catch(n){u?.debug?.error("WebGLGradientBackgroundSystem",`Error handling choreography event ${e}:`,n)}}updateShaderFromConsciousness(e){if(!this.gl||!this.shaderProgram)return;let i=this.settings.flowStrength*(.5+e.rhythmicPulse*.5),n=this.gl.getUniformLocation(this.shaderProgram,"u_flowStrength");n&&this.gl.uniform1f(n,i);let r=this.settings.noiseScale*(.8+e.musicalFlow.x*.4),a=this.gl.getUniformLocation(this.shaderProgram,"u_noiseScale");a&&this.gl.uniform1f(a,r);let s=Math.sin(Date.now()*.001*e.breathingCycle)*.1,o=this.gl.getUniformLocation(this.shaderProgram,"u_waveY");if(o){let m=[this.settings.waveY[0]+s,this.settings.waveY[1]-s];this.gl.uniform1fv(o,m)}let l={"--sn-webgl-consciousness-flow":i.toString(),"--sn-webgl-consciousness-noise":r.toString(),"--sn-webgl-breathing-phase":s.toString()};this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",l,"normal","consciousness-shader-update")}adjustQuality(e){this.setQualityLevel(e)}setQualityLevel(e){switch(this.currentQualityLevel=e,e){case"low":this.settings.flowStrength=.5,this.settings.noiseScale=1,this.settings.waveHeight=[.3,.2],this.settings.blurExp=1,this.settings.blurMax=.4,this.frameThrottleInterval=1e3/30;break;case"medium":this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.blurExp=1.2,this.settings.blurMax=.6,this.frameThrottleInterval=1e3/45;break;case"high":this.settings.flowStrength=.9,this.settings.noiseScale=1.4,this.settings.waveHeight=[.5,.4],this.settings.blurExp=1.3,this.settings.blurMax=.7,this.frameThrottleInterval=1e3/60;break;default:this.settings.flowStrength=.7,this.settings.noiseScale=1.2,this.settings.waveHeight=[.4,.3],this.settings.blurExp=1.2,this.settings.blurMax=.6,this.frameThrottleInterval=1e3/45;break}this.updateQualityCapabilities(e),u?.debug?.log("WebGLGradientBackgroundSystem",`Quality level set to: ${e}`,{flowStrength:this.settings.flowStrength,frameRate:1e3/this.frameThrottleInterval})}getPerformanceImpact(){let e=this.lastFrameTime>0?1e3/this.lastFrameTime:60,i=this.estimateMemoryUsage();return{fps:e,frameTime:this.lastFrameTime,memoryUsage:i,cpuUsage:this.estimateCPUUsage()}}reduceQuality(e){this.qualityAdjustments["flow-reduction"]=(this.qualityAdjustments["flow-reduction"]||0)+e,this.qualityAdjustments["noise-reduction"]=(this.qualityAdjustments["noise-reduction"]||0)+e*.8,this.qualityAdjustments["wave-reduction"]=(this.qualityAdjustments["wave-reduction"]||0)+e*.6,this.settings.flowStrength=Math.max(.1,this.settings.flowStrength*(1-e)),this.settings.noiseScale=Math.max(.5,this.settings.noiseScale*(1-e*.8)),this.settings.waveHeight=[Math.max(.1,this.settings.waveHeight[0]*(1-e*.6)),Math.max(.1,this.settings.waveHeight[1]*(1-e*.6))],e>.5&&(this.frameThrottleInterval=Math.min(1e3/15,this.frameThrottleInterval*(1+e))),u?.debug?.log("WebGLGradientBackgroundSystem",`Quality reduced by ${e}`,this.settings)}increaseQuality(e){if(Object.keys(this.qualityAdjustments).forEach(i=>{this.qualityAdjustments[i]=Math.max(0,(this.qualityAdjustments[i]||0)-e)}),this.currentQualityLevel){let i=this.getBaseSettingsForLevel(this.currentQualityLevel)||this.settings;this.settings.flowStrength=Math.min(i.flowStrength,this.settings.flowStrength*(1+e*.5)),this.settings.noiseScale=Math.min(i.noiseScale,this.settings.noiseScale*(1+e*.3));let n=this.currentQualityLevel==="high"?60:this.currentQualityLevel==="medium"?45:30;this.frameThrottleInterval=Math.max(1e3/n,this.frameThrottleInterval*(1-e*.3))}u?.debug?.log("WebGLGradientBackgroundSystem",`Quality increased by ${e}`,this.settings)}getQualityCapabilities(){return[...this.qualityCapabilities]}updateQualityCapabilities(e){this.qualityCapabilities.forEach(i=>{switch(i.name){case"webgl-rendering":i.enabled=!0;break;case"shader-complexity":i.enabled=e==="high"||e==="medium";break;case"blur-effects":i.enabled=e!=="low";break;case"corridor-effects":i.enabled=e!=="low",e==="low"&&this.settings.corridorEnabled&&(this.settings.corridorEnabled=!1);break;case"corridor-sdf-complexity":let n=e==="high"?1:e==="medium"?.8:.6;this.settings.corridorBubbleScale=Math.max(.5,1*n),i.enabled=e!=="low";break;case"corridor-bubble-layers":let r=e==="high"?1:e==="medium"?.8:.6;this.settings.corridorIntensity=Math.max(.3,.8*r),i.enabled=e==="high"||e==="medium";break;case"corridor-depth-effects":let a=e==="high"?1:e==="medium"?.7:.4;this.settings.corridorDepthEffect=Math.max(.1,.6*a),i.enabled=e!=="low";break;default:i.enabled=e!=="low"}})}getBaseSettingsForLevel(e){let i={...this.settings};switch(e){case"minimal":return{...i,flowStrength:.3,noiseScale:.8,corridorEnabled:!1,corridorIntensity:.3,corridorFlowStrength:.5,corridorDepthEffect:.2,corridorBubbleScale:.5};case"low":return{...i,flowStrength:.5,noiseScale:1,corridorEnabled:!1,corridorIntensity:.4,corridorFlowStrength:.8,corridorDepthEffect:.3,corridorBubbleScale:.6};case"medium":return{...i,flowStrength:.7,noiseScale:1.2,corridorEnabled:!0,corridorIntensity:.6,corridorFlowStrength:1,corridorDepthEffect:.5,corridorBubbleScale:.8};case"high":return{...i,flowStrength:.9,noiseScale:1.4,corridorEnabled:!0,corridorIntensity:.8,corridorFlowStrength:1.2,corridorDepthEffect:.6,corridorBubbleScale:1};case"ultra":return{...i,flowStrength:1,noiseScale:1.6,corridorEnabled:!0,corridorIntensity:1,corridorFlowStrength:1.4,corridorDepthEffect:.8,corridorBubbleScale:1.2};default:return i}}setCorridorEffectsEnabled(e){this.settings.corridorEnabled=e&&this.corridorShaderProgram!==null,this.cssController.setVariable("WebGLGradientBackgroundSystem","--sn-corridor-enabled",e?"1":"0","normal","corridor-settings-update"),u?.debug?.log("WebGLGradientBackgroundSystem",`Corridor effects ${e?"enabled":"disabled"}`)}updateCorridorSettings(e){e.corridorIntensity!==void 0&&(this.settings.corridorIntensity=Math.max(0,Math.min(1,e.corridorIntensity))),e.corridorFlowStrength!==void 0&&(this.settings.corridorFlowStrength=Math.max(0,Math.min(2,e.corridorFlowStrength))),e.corridorDepthEffect!==void 0&&(this.settings.corridorDepthEffect=Math.max(0,Math.min(1,e.corridorDepthEffect))),e.corridorBubbleScale!==void 0&&(this.settings.corridorBubbleScale=Math.max(.1,Math.min(2,e.corridorBubbleScale))),u?.debug?.log("WebGLGradientBackgroundSystem","Corridor settings updated",e)}estimateMemoryUsage(){let e=5;if(this.canvas&&this.gl){let i=this.canvas.width*this.canvas.height;e+=i*4/(1024*1024),this.gradientTexture&&(e+=1),this.vertexBuffer&&(e+=.1)}return e}estimateCPUUsage(){let e=this.isWebGLAvailable?5:15,i=this.settings.flowStrength+this.settings.noiseScale/2;return Math.min(50,e*i)}getSimplifiedFragmentShader(){return`#version 300 es
      precision highp float;

      in vec2 vTextureCoords;
      out vec4 fragColor;

      uniform sampler2D u_gradientTexture;
      uniform float u_time;
      uniform float u_intensity;
      uniform float u_flowStrength;
      uniform vec2 u_resolution;

      // Simplified noise function - uses basic sin/cos instead of complex noise
      float simpleNoise(vec2 st) {
        return sin(st.x * 12.9898 + st.y * 78.233) * 43758.5453;
      }

      void main() {
        vec2 uv = vTextureCoords;
        
        // Simple flow effect without complex noise
        vec2 flow = vec2(
          sin(u_time * 0.5 + uv.y * 3.0) * 0.1,
          cos(u_time * 0.3 + uv.x * 2.0) * 0.1
        ) * u_flowStrength;
        
        // Apply flow offset
        vec2 flowUV = uv + flow;
        
        // Simple gradient lookup with basic distortion
        vec4 gradientColor = texture(u_gradientTexture, flowUV);
        
        // Simple intensity modulation
        float intensity = u_intensity * (0.8 + 0.2 * sin(u_time + uv.x + uv.y));
        
        fragColor = vec4(gradientColor.rgb * intensity, gradientColor.a);
      }`}getBasicFragmentShader(){return`#version 300 es
      precision mediump float;

      in vec2 vTextureCoords;
      out vec4 fragColor;

      uniform sampler2D u_gradientTexture;
      uniform float u_intensity;

      void main() {
        vec2 uv = vTextureCoords;
        
        // Basic gradient lookup without any effects
        vec4 gradientColor = texture(u_gradientTexture, uv);
        
        // Simple intensity scaling
        fragColor = vec4(gradientColor.rgb * u_intensity, gradientColor.a);
      }`}getEmergencyFragmentShader(){return`#version 300 es
      precision lowp float;

      in vec2 vTextureCoords;
      out vec4 fragColor;

      uniform sampler2D u_gradientTexture;

      void main() {
        // Ultra-simple gradient lookup with minimal processing
        // Use lowp precision for maximum compatibility
        vec2 uv = vTextureCoords;
        
        // Simple gradient sample - no effects, no animations
        vec4 color = texture(u_gradientTexture, uv);
        
        // Emergency mode: ensure we always output something visible
        // Fallback to magenta if texture fails (indicates shader compilation success)
        if (color.a < 0.01) {
          fragColor = vec4(0.2, 0.1, 0.3, 1.0); // Dark purple fallback
        } else {
          fragColor = color;
        }
      }`}shouldPersistWebGL(){return this.settings.webglPersistenceMode==="persistent"?!0:this.settings.webglPersistenceMode==="fallback"?!1:this.settings.webglPersistenceMode==="adaptive"&&this.settings.enabled&&this.isWebGLAvailable}shouldAttemptWebGLRecovery(){return this.shouldPersistWebGL()}applyContinuousQuality(e){try{let i=e;u?.debug?.log("WebGLGradientBackgroundSystem",`Applying simplified quality level: ${i}`),this.setQualityLevel(i),this.cssController.batchSetVariables("WebGLGradientBackgroundSystem",{"--sn-webgl-quality-level":i,"--sn-webgl-corridor-enabled":this.settings.corridorEnabled?"1":"0"},"high","continuous-quality-update"),this.initialized&&this.gl&&this.forceRepaint("quality-level-changed")}catch(i){u?.debug?.error("WebGLGradientBackgroundSystem","Failed to apply continuous quality:",i)}}getCurrentQualityImpact(){let e=this.gl!==null&&this.isWebGLAvailable,i=this.settings.corridorEnabled&&this.corridorShaderProgram!==null,n=e?.15:.05,r=e?.1:.03,a=e?.2:0,s=i?.1:0,o=i?.05:0,l=i?.15:0,m=Math.max(.5,this.settings.flowStrength/2),d=60;return i&&(d-=10),this.settings.intensity==="intense"&&(d-=5),d=Math.max(30,d),{cpu:Math.min(1,(n+s)*m),memory:Math.min(1,(r+o)*m),gpu:Math.min(1,(a+l)*m),estimatedFPS:d}}}});var Di,Ts=y(()=>{"use strict";U();A();ge();Di=class extends Q{constructor(e=w,i,n,r=null,a=null){super(e,i,n,r,a);this.systemName="CSSBlobFallbackSystem";this.blobContainer=null;this.blobElements=[];this.isActive=!1;this.settings={enabled:!0,blobCount:6,musicResponsive:!0,performanceMode:!1,debugMode:!1,organicFlow:!0,membraneElasticity:.7,musicSync:!0,emotionalTemperature:.5,cellularGrowth:!0,organicBreathing:!0,fluidDynamics:!0};this.handleBeatEvent=e=>{if(!this.isActive||!this.settings.musicResponsive)return;let i=e,{intensity:n=.5}=i.detail||{};this.blobElements.forEach(a=>{a.classList.add("sn-beat-active")}),setTimeout(()=>{this.blobElements.forEach(a=>{a.classList.remove("sn-beat-active")})},500);let r=1+n*.15;document.documentElement.style.setProperty("--css-blob-beat-scale",r.toString())};this.handleEnergyChange=e=>{if(!this.isActive||!this.settings.musicResponsive)return;let i=e,{energy:n=.5}=i.detail||{};document.documentElement.style.setProperty("--css-blob-music-response",n.toString()),document.documentElement.style.setProperty("--css-blob-energy-opacity",(.4+n*.4).toString());let r=.8+n*.4,a=Math.round(8e3/r),s=Math.round(4e3/r);document.documentElement.style.setProperty("--css-blob-movement-speed",`${a}ms`),document.documentElement.style.setProperty("--css-blob-breathing-speed",`${s}ms`)};this.handleGenreChange=e=>{if(!this.isActive||!this.settings.musicResponsive)return;let i=e,{genre:n="unknown"}=i.detail||{};this.blobElements.forEach((r,a)=>{r.classList.remove("genre-electronic","genre-ambient","genre-classical");let s="genre-electronic";n.includes("ambient")||n.includes("chill")?s="genre-ambient":n.includes("classical")||n.includes("orchestral")?s="genre-classical":(n.includes("electronic")||n.includes("techno")||n.includes("house"))&&(s="genre-electronic");let o=["genre-electronic","genre-ambient","genre-classical"],l=(a+o.indexOf(s))%o.length,m=o[l];m&&r.classList.add(m)}),u?.debug?.log("CSSBlobFallbackSystem",`Updated blob genres for: ${n}`)}}async _performSystemSpecificInitialization(){if(await super._performSystemSpecificInitialization(),this.loadSettings(),this.checkWebGLAvailability()&&!this.settings.debugMode){u?.debug?.log("CSSBlobFallbackSystem","WebGL available - CSS blob fallback not needed");return}if(!this.settings.enabled){u?.debug?.log("CSSBlobFallbackSystem","CSS blob fallback disabled in settings");return}(this.performanceMonitor?.shouldReduceQuality?.()||!1)&&(this.settings.performanceMode=!0,this.settings.blobCount=Math.min(this.settings.blobCount,3));try{this.createBlobContainer(),this.createBlobElements(),this.settings.musicResponsive&&this.subscribeToEvents(),this.updateCSSVariables(),this.isActive=!0,u?.debug?.log("CSSBlobFallbackSystem",`CSS blob fallback activated with ${this.settings.blobCount} blobs`,{performanceMode:this.settings.performanceMode,musicResponsive:this.settings.musicResponsive})}catch(n){u?.debug?.error("CSSBlobFallbackSystem","Failed to initialize:",n)}}loadSettings(){if(this.settingsManager)try{let e=this.settingsManager?.get("sn-gradient-intensity"),i=this.settingsManager?.get("sn-performance-mode");switch(e){case"disabled":this.settings.enabled=!1;break;case"minimal":this.settings.blobCount=3,this.settings.musicResponsive=!1;break;case"balanced":this.settings.blobCount=6,this.settings.musicResponsive=!0;break;case"intense":this.settings.blobCount=8,this.settings.musicResponsive=!0;break}i==="enabled"&&(this.settings.performanceMode=!0,this.settings.blobCount=Math.min(this.settings.blobCount,4))}catch(e){u?.debug?.warn("CSSBlobFallbackSystem","Failed to load settings:",e)}}checkWebGLAvailability(){try{let e=document.createElement("canvas");return!!(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch{return!1}}createBlobContainer(){let e=this.findTargetContainer();this.blobContainer=document.createElement("div"),this.blobContainer.className="sn-css-blob-container",this.settings.debugMode&&this.blobContainer.classList.add("css-blob-debug"),this.settings.performanceMode&&this.blobContainer.classList.add("css-blob-performance"),e.appendChild(this.blobContainer),u?.debug?.log("CSSBlobFallbackSystem","Blob container created and inserted")}createBlobElements(){if(this.blobContainer){this.blobElements.forEach(e=>e.remove()),this.blobElements=[];for(let e=0;e<this.settings.blobCount;e++){let i=document.createElement("div");i.className="sn-css-blob",i.setAttribute("data-blob-index",e.toString());let n=["genre-electronic","genre-ambient","genre-classical"],r=n[e%n.length];r&&i.classList.add(r),this.blobContainer.appendChild(i),this.blobElements.push(i)}u?.debug?.log("CSSBlobFallbackSystem",`Created ${this.settings.blobCount} blob elements`)}}findTargetContainer(){let e=[".Root__main-view",".main-view-container",".Root__top-container","body"];for(let i of e){let n=document.querySelector(i);if(n)return n}return document.body}updateCSSVariables(){document.documentElement.style.setProperty("--css-blob-enabled","1"),document.documentElement.style.setProperty("--css-blob-count",this.settings.blobCount.toString()),this.settings.performanceMode&&(document.documentElement.style.setProperty("--css-blob-quality","0"),document.documentElement.style.setProperty("--css-blob-filter-quality","0")),document.documentElement.style.setProperty("--sn-consciousness-organic-mode",this.settings.organicFlow?"1":"0"),document.documentElement.style.setProperty("--sn-consciousness-membrane-elasticity",this.settings.membraneElasticity.toString()),document.documentElement.style.setProperty("--sn-consciousness-musical-emotion",this.settings.emotionalTemperature.toString()),document.documentElement.style.setProperty("--sn-consciousness-cellular-growth",this.settings.cellularGrowth?"1":"0"),document.documentElement.style.setProperty("--sn-consciousness-breathing-intensity",this.settings.organicBreathing?"1":"0"),document.documentElement.style.setProperty("--sn-consciousness-viscosity",this.settings.fluidDynamics?"0.4":"0"),document.documentElement.style.setProperty("--sn-consciousness-css-fallback","1.0"),document.documentElement.style.setProperty("--sn-consciousness-webgl-coordination","0")}subscribeToEvents(){this.settings.musicResponsive&&(document.addEventListener("music-sync:beat-detected",this.handleBeatEvent),document.addEventListener("music-sync:energy-changed",this.handleEnergyChange),document.addEventListener("music-sync:genre-changed",this.handleGenreChange),document.addEventListener("year3000SystemSettingsChanged",this.handleSettingsChange.bind(this)),u?.debug?.log("CSSBlobFallbackSystem","Subscribed to music and settings events"))}handleSettingsChange(e){let i=e,{key:n}=i.detail||{};(n.startsWith("sn-gradient-")||n.startsWith("sn-performance-"))&&(this.loadSettings(),this.isActive&&this.blobContainer&&(this.createBlobElements(),this.updateCSSVariables()))}updateAnimation(e){}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),this.settings.musicResponsive&&(document.removeEventListener("music-sync:beat-detected",this.handleBeatEvent),document.removeEventListener("music-sync:energy-changed",this.handleEnergyChange),document.removeEventListener("music-sync:genre-changed",this.handleGenreChange),document.removeEventListener("year3000SystemSettingsChanged",this.handleSettingsChange.bind(this))),this.blobElements.forEach(e=>e.remove()),this.blobElements=[],this.blobContainer&&this.blobContainer.parentNode&&this.blobContainer.parentNode.removeChild(this.blobContainer),this.blobContainer=null,document.documentElement.style.removeProperty("--css-blob-enabled"),document.documentElement.style.removeProperty("--css-blob-count"),document.documentElement.style.removeProperty("--css-blob-quality"),this.isActive=!1,u?.debug?.log("CSSBlobFallbackSystem","CSS blob fallback system cleanup completed")}setEnabled(e){this.settings.enabled=e,this.blobContainer&&(this.blobContainer.style.display=e?"":"none"),document.documentElement.style.setProperty("--css-blob-enabled",e?"1":"0")}setPerformanceMode(e){this.settings.performanceMode=e,this.blobContainer&&this.blobContainer.classList.toggle("css-blob-performance",e),document.documentElement.style.setProperty("--css-blob-quality",e?"0":"1"),document.documentElement.style.setProperty("--css-blob-filter-quality",e?"0":"1")}setOrganicFlow(e){this.settings.organicFlow=e,document.documentElement.style.setProperty("--sn-consciousness-organic-mode",e?"1":"0")}setMembraneElasticity(e){this.settings.membraneElasticity=Math.max(0,Math.min(1,e)),document.documentElement.style.setProperty("--sn-consciousness-membrane-elasticity",this.settings.membraneElasticity.toString())}setConsciousnessSync(e){this.settings.musicSync=e}setEmotionalTemperature(e){this.settings.emotionalTemperature=Math.max(0,Math.min(1,e)),document.documentElement.style.setProperty("--sn-consciousness-musical-emotion",this.settings.emotionalTemperature.toString())}setCellularGrowth(e){this.settings.cellularGrowth=e,document.documentElement.style.setProperty("--sn-consciousness-cellular-growth",e?"1":"0")}setOrganicBreathing(e){this.settings.organicBreathing=e,document.documentElement.style.setProperty("--sn-consciousness-breathing-intensity",e?"1":"0")}setFluidDynamics(e){this.settings.fluidDynamics=e,document.documentElement.style.setProperty("--sn-consciousness-viscosity",e?"0.4":"0")}getStatus(){return{isActive:this.isActive,settings:{...this.settings},blobCount:this.blobElements.length,hasContainer:!!this.blobContainer}}}});var ki,xs=y(()=>{"use strict";N();D();A();ge();ki=class extends Q{constructor(e,i,n,r,a){super(e,i,n,r,a);this.systemName="ConsciousnessUIEffectsController";this.consciousnessChoreographer=null;this.currentConsciousnessField=null;this.shimmerElements=new Map;this.mutationObserver=null;this.intersectionObserver=null;this.animationFrameId=null;this.lastFrameTime=0;this.frameTimeHistory=[];this.eventUnsubscribeFunctions=[];this.customPerformanceMonitor={frameCount:0,totalFrameTime:0,lastPerformanceCheck:0,adaptiveQualityLevel:1};this.diagnosticTimerId=null;this.lastDiagnosticRun=0;this.uiEffectsConfig={enabled:!0,consciousnessThreshold:.3,shimmerEnabled:!0,shimmerIntensity:.6,shimmerType:"mixed",shimmerPerformanceLevel:"balanced",interactionTrackingEnabled:!0,digitalMeditationThreshold:3e4,scrollVelocityTracking:!0,diagnosticEnabled:!0,autoFixWhiteLayer:!0,diagnosticInterval:5e3,audioVisualEnabled:!0,beatSynchronization:!0,nebulaEffectIntensity:this.getNebulaIntensityFromSettings(),scrollEffectsEnabled:!0,prismaticSheenIntensity:.5,maxFrameTime:1,adaptiveQuality:!0,debugMode:e.enableDebug||!1},this.consciousnessState=this.createInitialConsciousnessState(),u?.debug?.log("ConsciousnessUIEffectsController","Unified UI effects consciousness controller created")}get systemPriority(){return"normal"}getNebulaIntensityFromSettings(){if(!this.settingsManager)return .7;switch(this.settingsManager.get("sn-gradient-intensity")){case"disabled":return 0;case"minimal":return .3;case"balanced":return .7;case"intense":return 1;default:return .7}}createInitialConsciousnessState(){return{consciousnessLevel:"dormant",shimmer:{intensity:0,effectType:"mixed",activeElements:new Set,performanceLevel:this.uiEffectsConfig.shimmerPerformanceLevel},interaction:{isActive:!1,lastInteractionTime:0,digitalMeditationDetected:!1,scrollVelocity:{x:0,y:0,direction:"none"},nexusState:"idle"},diagnostic:{whiteLayerIssues:[],webglContextHealthy:!0,lastDiagnosticTime:0,autoFixEnabled:this.uiEffectsConfig.autoFixWhiteLayer,criticalIssuesDetected:0},audioVisual:{beatIntensity:0,genreChangeDetected:!1,nebulaEffectIntensity:0,lastBeatTime:0,performanceAdaptive:this.uiEffectsConfig.adaptiveQuality},scroll:{sheenIntensity:0,scrollRatio:0,prismaticEffectActive:!1,lastScrollTime:0},performance:{frameTime:0,avgFrameTime:0,maxFrameTime:0,healthStatus:"excellent",adaptiveQualityEnabled:this.uiEffectsConfig.adaptiveQuality}}}async initialize(){try{u?.debug?.log("ConsciousnessUIEffectsController","Starting unified UI effects initialization..."),await this.initializeCSSConsciousness(),await this.initializeConsciousnessIntegration(),this.subscribeToUnifiedEvents(),this.uiEffectsConfig.shimmerEnabled&&await this.initializeShimmerEffects(),this.uiEffectsConfig.interactionTrackingEnabled&&await this.initializeInteractionTracking(),this.uiEffectsConfig.diagnosticEnabled&&await this.initializeDiagnosticSystem(),this.uiEffectsConfig.audioVisualEnabled&&await this.initializeAudioVisualEffects(),this.uiEffectsConfig.scrollEffectsEnabled&&await this.initializeScrollEffects(),this.startUnifiedAnimationLoop(),this.initialized=!0,u?.debug?.log("ConsciousnessUIEffectsController","Unified UI effects consciousness initialized")}catch(e){throw u?.debug?.error("ConsciousnessUIEffectsController","Failed to initialize:",e),e}}async initializeCSSConsciousness(){try{this.cssController=globalThis.unifiedCSSConsciousnessController||null,this.cssController=T(),this.cssController?u?.debug?.log("ConsciousnessUIEffectsController","Connected to unified CSS consciousness"):u?.debug?.warn("ConsciousnessUIEffectsController","CSS consciousness not available, using coordinator fallback")}catch(e){u?.debug?.warn("ConsciousnessUIEffectsController","CSS consciousness initialization failed:",e)}}async initializeConsciousnessIntegration(){try{this.consciousnessChoreographer=globalThis.backgroundConsciousnessChoreographer||null,this.consciousnessChoreographer?(this.consciousnessChoreographer.registerConsciousnessParticipant(this),u?.debug?.log("ConsciousnessUIEffectsController","Registered with consciousness choreographer")):u?.debug?.log("ConsciousnessUIEffectsController","Operating without consciousness choreographer integration")}catch(e){u?.debug?.warn("ConsciousnessUIEffectsController","Consciousness integration failed:",e)}}subscribeToUnifiedEvents(){let e=g.subscribe("music:beat",this.handleMusicBeat.bind(this),"ConsciousnessUIEffectsController");this.eventUnsubscribeFunctions.push(()=>g.unsubscribe(e));let i=g.subscribe("music:energy",this.handleMusicEnergy.bind(this),"ConsciousnessUIEffectsController");this.eventUnsubscribeFunctions.push(()=>g.unsubscribe(i));let n=g.subscribe("settings:changed",this.handleSettingsChange.bind(this),"ConsciousnessUIEffectsController");this.eventUnsubscribeFunctions.push(()=>g.unsubscribe(n)),u?.debug?.log("ConsciousnessUIEffectsController",`Subscribed to ${this.eventUnsubscribeFunctions.length} unified events`)}async initializeShimmerEffects(){try{this.setupElementObservers(),await this.discoverShimmerElements(),u?.debug?.log("ConsciousnessUIEffectsController",`Shimmer effects initialized with ${this.shimmerElements.size} elements`)}catch(e){u?.debug?.error("ConsciousnessUIEffectsController","Shimmer effects initialization failed:",e)}}async initializeInteractionTracking(){try{this.setupInteractionListeners(),u?.debug?.log("ConsciousnessUIEffectsController","Interaction tracking initialized")}catch(e){u?.debug?.error("ConsciousnessUIEffectsController","Interaction tracking initialization failed:",e)}}async initializeDiagnosticSystem(){try{this.startDiagnosticMonitoring(),u?.debug?.log("ConsciousnessUIEffectsController","Diagnostic system initialized")}catch(e){u?.debug?.error("ConsciousnessUIEffectsController","Diagnostic system initialization failed:",e)}}async initializeAudioVisualEffects(){try{u?.debug?.log("ConsciousnessUIEffectsController","Audio-visual effects initialized")}catch(e){u?.debug?.error("ConsciousnessUIEffectsController","Audio-visual effects initialization failed:",e)}}async initializeScrollEffects(){try{u?.debug?.log("ConsciousnessUIEffectsController","Scroll effects initialized")}catch(e){u?.debug?.error("ConsciousnessUIEffectsController","Scroll effects initialization failed:",e)}}setupElementObservers(){typeof MutationObserver<"u"&&(this.mutationObserver=new MutationObserver(e=>{let i=!1;e.forEach(n=>{n.type==="childList"&&n.addedNodes.forEach(r=>{r.nodeType===Node.ELEMENT_NODE&&(i=!0)})}),i&&this.discoverShimmerElements()}),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0})),typeof IntersectionObserver<"u"&&(this.intersectionObserver=new IntersectionObserver(e=>{e.forEach(i=>{let n=i.target.getAttribute("data-shimmer-id");n&&(i.isIntersecting?this.consciousnessState.shimmer.activeElements.add(n):this.consciousnessState.shimmer.activeElements.delete(n))})},{threshold:[0,.1,.5,1]}))}async discoverShimmerElements(){let e=[".main-card-card",".main-trackList-trackListRow",".main-button-primary",".main-playButton-button",'[data-testid="card-click-handler"]'],i=0;e.forEach(n=>{document.querySelectorAll(n).forEach((a,s)=>{let o=`shimmer-${n.replace(/[^\w]/g,"_")}-${s}`,l=a;l.setAttribute("data-shimmer-id",o),this.shimmerElements.set(o,l),this.intersectionObserver&&this.intersectionObserver.observe(l),i++})}),this.uiEffectsConfig.debugMode&&i>0&&u?.debug?.log("ConsciousnessUIEffectsController",`Discovered ${i} shimmer elements`)}setupInteractionListeners(){["click","keydown","mousemove","scroll","touchstart"].forEach(i=>{document.addEventListener(i,()=>{this.consciousnessState.interaction.isActive=!0,this.consciousnessState.interaction.lastInteractionTime=Date.now(),this.consciousnessState.interaction.digitalMeditationDetected=!1,this.updateNexusState()},{passive:!0})})}startDiagnosticMonitoring(){this.diagnosticTimerId=window.setInterval(()=>{this.runDiagnosticCheck()},this.uiEffectsConfig.diagnosticInterval)}startUnifiedAnimationLoop(){let e=i=>{if(!this.initialized)return;let n=i-this.lastFrameTime;this.lastFrameTime=i;let r=performance.now();try{this.updateConsciousnessState(n),this.uiEffectsConfig.shimmerEnabled&&this.updateShimmerEffects(n),this.uiEffectsConfig.interactionTrackingEnabled&&this.updateInteractionTracking(n),this.uiEffectsConfig.audioVisualEnabled&&this.updateAudioVisualEffects(n),this.uiEffectsConfig.scrollEffectsEnabled&&this.updateScrollEffects(n),this.applyCSSUpdates();let a=performance.now()-r;this.updatePerformanceMetrics(a),a>this.uiEffectsConfig.maxFrameTime&&this.handlePerformanceIssue(a)}catch(a){u?.debug?.error("ConsciousnessUIEffectsController","Animation loop error:",a)}this.animationFrameId=requestAnimationFrame(e)};this.animationFrameId=requestAnimationFrame(e)}updateConsciousnessState(e){let i=this.consciousnessState,n=i.shimmer.intensity*.2+(i.interaction.isActive?.3:0)+i.audioVisual.beatIntensity*.3+i.scroll.sheenIntensity*.2;n>.8?i.consciousnessLevel="transcendent":n>.5?i.consciousnessLevel="focused":n>.2?i.consciousnessLevel="aware":i.consciousnessLevel="dormant"}updateShimmerEffects(e){let i=this.consciousnessState.shimmer,n=this.consciousnessState.audioVisual.beatIntensity*.3,r=this.consciousnessState.interaction.isActive?.2:0;i.intensity=Math.min(this.uiEffectsConfig.shimmerIntensity+n+r,1),this.consciousnessState.performance.healthStatus==="degraded"?i.intensity*=.7:this.consciousnessState.performance.healthStatus==="critical"&&(i.intensity*=.3)}updateInteractionTracking(e){let i=this.consciousnessState.interaction,r=Date.now()-i.lastInteractionTime;r>this.uiEffectsConfig.digitalMeditationThreshold&&(i.digitalMeditationDetected||(i.digitalMeditationDetected=!0,u?.debug?.log("ConsciousnessUIEffectsController","Digital meditation detected",{inactiveTime:r}))),this.updateNexusState()}updateNexusState(){let e=this.consciousnessState.interaction,n=Date.now()-e.lastInteractionTime;e.digitalMeditationDetected?e.nexusState="meditation":n<1e3?e.nexusState="active":n<1e4?e.nexusState="flow":e.nexusState="idle"}updateAudioVisualEffects(e){let i=this.consciousnessState.audioVisual,n=this.consciousnessState.consciousnessLevel==="transcendent"?.2:0;i.nebulaEffectIntensity=Math.min(this.uiEffectsConfig.nebulaEffectIntensity+i.beatIntensity*.3+n,1)}updateScrollEffects(e){let i=this.consciousnessState.scroll;Date.now()-i.lastScrollTime<1e3?(i.prismaticEffectActive=!0,i.sheenIntensity=Math.min(i.scrollRatio*this.uiEffectsConfig.prismaticSheenIntensity,1)):(i.prismaticEffectActive=!1,i.sheenIntensity*=.95)}applyCSSUpdates(){let e=this.consciousnessState,i={"--sn-ui-consciousness-level":e.consciousnessLevel,"--sn-shimmer-intensity":e.shimmer.intensity.toFixed(3),"--sn-shimmer-effect-type":e.shimmer.effectType,"--sn-shimmer-performance":e.shimmer.performanceLevel,"--sn-interaction-nexus-state":e.interaction.nexusState,"--sn-interaction-meditation":e.interaction.digitalMeditationDetected?"1":"0","--sn-scroll-velocity-x":e.interaction.scrollVelocity.x.toFixed(2),"--sn-scroll-velocity-y":e.interaction.scrollVelocity.y.toFixed(2),"--sn-beat-intensity":e.audioVisual.beatIntensity.toFixed(3),"--sn-nebula-intensity":e.audioVisual.nebulaEffectIntensity.toFixed(3),"--sn-genre-change":e.audioVisual.genreChangeDetected?"1":"0","--sn-scroll-sheen-intensity":e.scroll.sheenIntensity.toFixed(3),"--sn-scroll-ratio":e.scroll.scrollRatio.toFixed(3),"--sn-prismatic-active":e.scroll.prismaticEffectActive?"1":"0","--sn-white-layer-issues":e.diagnostic.whiteLayerIssues.length.toString(),"--sn-webgl-healthy":e.diagnostic.webglContextHealthy?"1":"0"};try{this.cssController.batchSetVariables("ConsciousnessUIEffectsController",i,"normal","ui-consciousness-update")}catch(n){u?.debug?.warn("ConsciousnessUIEffectsController","CSS coordination error:",n)}}updatePerformanceMetrics(e){let i=this.consciousnessState.performance;i.frameTime=e,this.frameTimeHistory.push(e),this.frameTimeHistory.length>60&&this.frameTimeHistory.shift(),i.avgFrameTime=this.frameTimeHistory.reduce((n,r)=>n+r,0)/this.frameTimeHistory.length,i.maxFrameTime=Math.max(...this.frameTimeHistory),i.avgFrameTime>2?i.healthStatus="critical":i.avgFrameTime>1.5?i.healthStatus="degraded":i.avgFrameTime>1?i.healthStatus="good":i.healthStatus="excellent"}handlePerformanceIssue(e){this.uiEffectsConfig.adaptiveQuality&&(this.customPerformanceMonitor.adaptiveQualityLevel*=.9,this.customPerformanceMonitor.adaptiveQualityLevel<.5&&(this.consciousnessState.shimmer.performanceLevel="minimal"),this.uiEffectsConfig.debugMode&&u?.debug?.warn("ConsciousnessUIEffectsController",`Performance issue: ${e.toFixed(2)}ms, reduced quality to ${this.customPerformanceMonitor.adaptiveQualityLevel.toFixed(2)}`))}runDiagnosticCheck(){let e=this.consciousnessState.diagnostic,i=Date.now();e.lastDiagnosticTime=i,e.whiteLayerIssues=[];try{let n=document.createElement("canvas"),r=n.getContext("webgl")||n.getContext("experimental-webgl");e.webglContextHealthy=!!r;let a=document.querySelectorAll('[style*="background"], [style*="color"]'),s=0;a.forEach(o=>{let l=window.getComputedStyle(o);(l.backgroundColor==="rgb(255, 255, 255)"||l.color==="rgb(255, 255, 255)")&&s++}),s>10&&(e.whiteLayerIssues.push(`Excessive white layers detected: ${s}`),e.autoFixEnabled&&this.autoFixWhiteLayerIssues()),e.criticalIssuesDetected=e.whiteLayerIssues.length}catch(n){u?.debug?.error("ConsciousnessUIEffectsController","Diagnostic check failed:",n)}}autoFixWhiteLayerIssues(){try{this.cssController.batchSetVariables("ConsciousnessUIEffectsController",{"--spice-text":"var(--spice-main)","--spice-subtext":"var(--catppuccin-text)"},"critical","white-layer-autofix"),this.uiEffectsConfig.debugMode&&u?.debug?.log("ConsciousnessUIEffectsController","Applied white layer auto-fix")}catch(e){u?.debug?.error("ConsciousnessUIEffectsController","Auto-fix failed:",e)}}handleMusicBeat(e){let i=this.consciousnessState.audioVisual;if(i.beatIntensity=e.intensity||.5,i.lastBeatTime=Date.now(),this.uiEffectsConfig.shimmerEnabled){let n=i.beatIntensity*.2;this.consciousnessState.shimmer.intensity=Math.min(this.consciousnessState.shimmer.intensity+n,1)}}handleMusicEnergy(e){let i=this.consciousnessState.audioVisual;e.energy!==void 0&&(i.beatIntensity=Math.max(i.beatIntensity,e.energy*.8))}handleGenreChange(e){let i=this.consciousnessState.audioVisual;i.genreChangeDetected=!0,setTimeout(()=>{i.genreChangeDetected=!1},2e3)}handleUserScroll(e){let i=this.consciousnessState.scroll,n=this.consciousnessState.interaction;i.lastScrollTime=Date.now(),i.scrollRatio=e.scrollRatio||0,e.velocity&&(n.scrollVelocity={x:e.velocity.x||0,y:e.velocity.y||0,direction:e.direction||"none"}),this.handleUserInteraction({type:"scroll",timestamp:Date.now()})}handleUserInteraction(e){let i=this.consciousnessState.interaction;i.isActive=!0,i.lastInteractionTime=e.timestamp||Date.now(),i.digitalMeditationDetected=!1,this.updateNexusState()}handleSettingsChange(e){let{key:i,value:n}=e;i.startsWith("sn-ui-effects-")?this.updateConfigFromSettings(i,n):i==="sn-gradient-intensity"&&(this.uiEffectsConfig.nebulaEffectIntensity=this.getNebulaIntensityFromSettings(),u?.debug?.log("ConsciousnessUIEffectsController",`Updated nebula intensity to: ${this.uiEffectsConfig.nebulaEffectIntensity} from consolidated gradient setting: ${n}`))}updateConfigFromSettings(e,i){switch(e){case"sn-ui-effects-shimmer-intensity":this.uiEffectsConfig.shimmerIntensity=parseFloat(i)||.6;break;case"sn-ui-effects-diagnostic-enabled":this.uiEffectsConfig.diagnosticEnabled=i==="true"||i===!0;break;case"sn-ui-effects-adaptive-quality":this.uiEffectsConfig.adaptiveQuality=i==="true"||i===!0;break}}getConsciousnessContribution(){return{systemName:this.systemName,consciousnessLevel:this.consciousnessState.consciousnessLevel,shimmerIntensity:this.consciousnessState.shimmer.intensity,interactionState:this.consciousnessState.interaction.nexusState,audioVisualIntensity:this.consciousnessState.audioVisual.nebulaEffectIntensity,scrollActivity:this.consciousnessState.scroll.sheenIntensity,timestamp:Date.now()}}onConsciousnessFieldUpdate(e){try{this.currentConsciousnessField=e;let i=e.rhythmicPulse*.2;this.consciousnessState.shimmer.intensity=Math.min(this.consciousnessState.shimmer.intensity+i,1),this.consciousnessState.audioVisual.nebulaEffectIntensity=Math.min(this.consciousnessState.audioVisual.nebulaEffectIntensity+i*.3,1)}catch(i){u?.debug?.error("ConsciousnessUIEffectsController","Error updating from consciousness field:",i)}}onChoreographyEvent(e,i){e==="transition:start"&&(this.consciousnessState.shimmer.intensity=Math.min(this.consciousnessState.shimmer.intensity+.2,1),this.consciousnessState.audioVisual.nebulaEffectIntensity=Math.min(this.consciousnessState.audioVisual.nebulaEffectIntensity+.15,1)),this.uiEffectsConfig.debugMode&&u?.debug?.log("ConsciousnessUIEffectsController",`Choreography event: ${e}`,i)}async healthCheck(){let e=this.consciousnessState,i=this.initialized&&e.performance.healthStatus!=="critical"&&e.diagnostic.criticalIssuesDetected===0;return{healthy:i,ok:i,details:`UI Effects Consciousness: ${e.consciousnessLevel}, Shimmer: ${e.shimmer.activeElements.size} elements, Interaction: ${e.interaction.nexusState}, Performance: ${e.performance.healthStatus}, Diagnostics: ${e.diagnostic.criticalIssuesDetected} issues`,system:"ConsciousnessUIEffectsController"}}updateConfiguration(e){Object.assign(this.uiEffectsConfig,e),e.shimmerEnabled!==void 0&&e.shimmerEnabled&&!this.consciousnessState.shimmer.activeElements.size&&this.discoverShimmerElements(),e.diagnosticEnabled!==void 0&&(e.diagnosticEnabled&&!this.diagnosticTimerId?this.startDiagnosticMonitoring():!e.diagnosticEnabled&&this.diagnosticTimerId&&(clearInterval(this.diagnosticTimerId),this.diagnosticTimerId=null)),u?.debug?.log("ConsciousnessUIEffectsController","Configuration updated:",e)}getConfiguration(){return{...this.uiEffectsConfig}}getConsciousnessState(){return{...this.consciousnessState}}getShimmerElements(){return new Map(this.shimmerElements)}getInteractionState(){return this.consciousnessState.interaction}getDiagnosticState(){return this.consciousnessState.diagnostic}async destroy(){u?.debug?.log("ConsciousnessUIEffectsController","Destroying unified UI effects controller..."),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.diagnosticTimerId&&(clearInterval(this.diagnosticTimerId),this.diagnosticTimerId=null),this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.intersectionObserver=null);for(let e of this.eventUnsubscribeFunctions)e();this.eventUnsubscribeFunctions=[],this.shimmerElements.clear(),this.consciousnessChoreographer,this.initialized=!1,u?.debug?.log("ConsciousnessUIEffectsController","Unified UI effects controller destroyed")}}});var Li,As=y(()=>{"use strict";mt();N();D();A();Li=class extends re{constructor(e){super(e);this.consciousnessState={energy:.5,valence:.5,tempo:120,harmonyHue:0,intensity:.8,lastUpdateTime:0,animationActive:!0,preferredMotion:!0,frameRate:60,lastFrameTime:0};this.animationFrameId=0;this.updateInterval=0;this.eventDebounceTimers={musicEnergy:0,colorHarmony:0,beatSync:0,cssUpdate:0};this.eventDebounceMs=100;this.frameThrottleMs=16;this.lastCSSUpdateTime=0;this.previousCSSValues={energy:0,valence:0,harmonyHue:0,intensity:0,depth:0};this.cssChangeThreshold=.01}debouncedEventHandler(e,i){let n=performance.now();n-this.eventDebounceTimers[e]>=this.eventDebounceMs&&(i(),this.eventDebounceTimers[e]=n)}hasSignificantCSSChange(){let e=this.consciousnessState,i=1+e.energy*.5,n={energy:e.energy,valence:e.valence,harmonyHue:e.harmonyHue,intensity:e.intensity,depth:i};for(let[r,a]of Object.entries(n)){let s=this.previousCSSValues[r];if(Math.abs(a-s)>=this.cssChangeThreshold)return!0}return!1}updatePreviousCSSValues(){let e=this.consciousnessState,i=1+e.energy*.5;this.previousCSSValues.energy=e.energy,this.previousCSSValues.valence=e.valence,this.previousCSSValues.harmonyHue=e.harmonyHue,this.previousCSSValues.intensity=e.intensity,this.previousCSSValues.depth=i}batchApplyCSSUpdates(e,i="normal",n="header-consciousness"){let r={};for(let[a,s]of e)r[a]=s;this.cssController.batchSetVariables("HeaderConsciousnessController",r,i,n)}scheduleConsciousnessUpdate(){this.debouncedEventHandler("cssUpdate",()=>{this.hasSignificantCSSChange()&&(this.updateHeaderConsciousnessVariables(),this.updatePreviousCSSValues())})}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{let e=globalThis.year3000System;this.cssController=e?.cssConsciousnessController||T(),this.consciousnessState.preferredMotion=!window.matchMedia("(prefers-reduced-motion: reduce)").matches,this.setupMusicEventListeners(),this.setupColorHarmonyListeners(),this.updateHeaderConsciousnessVariables(),this.consciousnessState.preferredMotion&&this.startAnimationLoop(),this.setupPerformanceMonitoring(),u?.debug?.log("HeaderConsciousnessController","Header consciousness initialization complete")}catch(e){u?.debug?.error("HeaderConsciousnessController","Initialization failed:",e)}}setupMusicEventListeners(){g.subscribe("music:energy",e=>{this.debouncedEventHandler("musicEnergy",()=>{typeof e.energy=="number"&&(this.consciousnessState.energy=Math.max(0,Math.min(1,e.energy)),this.scheduleConsciousnessUpdate()),typeof e.tempo=="number"&&(this.consciousnessState.tempo=Math.max(60,Math.min(200,e.tempo)),this.updateAnimationSpeed()),typeof e.valence=="number"&&(this.consciousnessState.valence=Math.max(0,Math.min(1,e.valence)),this.scheduleConsciousnessUpdate())})},"HeaderConsciousnessController"),g.subscribe("consciousness:beat-sync",e=>{this.debouncedEventHandler("beatSync",()=>{if(this.consciousnessState.animationActive){let i=e.beatPhase||.8;this.onBeatDetected(i)}})},"HeaderConsciousnessController"),g.subscribe("music:energy-changed",e=>{this.debouncedEventHandler("musicEnergy",()=>{typeof e.energy=="number"&&(this.consciousnessState.energy=Math.max(0,Math.min(1,e.energy)),this.scheduleConsciousnessUpdate())})},"HeaderConsciousnessController")}setupColorHarmonyListeners(){g.subscribe("colors:harmonized",e=>{this.debouncedEventHandler("colorHarmony",()=>{e.coordinationMetrics?.coordinationStrategy&&this.updateHarmonyHue(e.coordinationMetrics.coordinationStrategy)})},"HeaderConsciousnessController"),g.subscribe("colors:extracted",e=>{this.debouncedEventHandler("colorHarmony",()=>{if(e.musicData&&typeof e.musicData.energy=="number"){let i=e.musicData.energy*360;this.consciousnessState.harmonyHue=i,this.scheduleConsciousnessUpdate()}})},"HeaderConsciousnessController")}updateHarmonyHue(e){let n={monochromatic:0,complementary:180,triadic:120,analogous:30,tetradic:90,"split-complementary":150}[e]||0;this.consciousnessState.harmonyHue=n,this.scheduleConsciousnessUpdate()}onBeatDetected(e){let i=Math.min(1,this.consciousnessState.energy+e*.3);this.batchApplyCSSUpdates([["--header-consciousness-energy",i.toString()]],"high","beat-sync");let n=performance.now()+150,r=()=>{performance.now()>=n&&this.initialized?this.batchApplyCSSUpdates([["--header-consciousness-energy",this.consciousnessState.energy.toString()]],"normal","beat-reset"):this.initialized&&requestAnimationFrame(r)};requestAnimationFrame(r)}updateAnimationSpeed(){let n=8/(this.consciousnessState.tempo/120);this.batchApplyCSSUpdates([["--header-consciousness-flow-speed",`${Math.max(2,Math.min(16,n))}s`]],"high","tempo-sync")}updateHeaderConsciousnessVariables(){if(!this.initialized)return;let e=this.consciousnessState,i=e.intensity*(.6+e.valence*.4)*(.8+e.energy*.2),n=1+e.energy*.5;this.batchApplyCSSUpdates([["--header-consciousness-energy",e.energy.toString()],["--header-consciousness-harmony",`${e.harmonyHue}deg`],["--header-soul-intensity",i.toString()],["--header-consciousness-depth",n.toString()]],"normal","consciousness-update"),this.consciousnessState.lastUpdateTime=Date.now()}startAnimationLoop(){let e=i=>{if(!this.initialized||!this.consciousnessState.animationActive)return;if(i-this.lastCSSUpdateTime<this.frameThrottleMs){this.animationFrameId=requestAnimationFrame(e);return}let n=i-this.consciousnessState.lastFrameTime;this.consciousnessState.frameRate=1e3/n,this.consciousnessState.lastFrameTime=i,i-this.consciousnessState.lastUpdateTime>100&&this.hasSignificantCSSChange()&&(this.updateHeaderConsciousnessVariables(),this.updatePreviousCSSValues()),this.lastCSSUpdateTime=i,this.animationFrameId=requestAnimationFrame(e)};this.animationFrameId=requestAnimationFrame(e)}setupPerformanceMonitoring(){this.updateInterval=window.setInterval(()=>{this.initialized&&(this.consciousnessState.frameRate<30&&u?.debug?.warn("HeaderConsciousnessController","Performance degradation detected, reducing update frequency"),this.cssController.setVariable("HeaderConsciousnessController","--header-consciousness-performance",this.consciousnessState.frameRate>50?"1":"0.5","low","performance-monitor"))},2e3)}setConsciousnessIntensity(e){this.consciousnessState.intensity=Math.max(0,Math.min(1,e)),this.updateHeaderConsciousnessVariables()}setAnimationActive(e){this.consciousnessState.animationActive=e,!e&&this.animationFrameId?(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=0):e&&this.consciousnessState.preferredMotion&&this.startAnimationLoop()}getConsciousnessState(){return{...this.consciousnessState}}async healthCheck(){let e=this.initialized&&this.consciousnessState.frameRate>20&&Date.now()-this.consciousnessState.lastUpdateTime<5e3;return{healthy:e,issues:e?[]:[this.consciousnessState.frameRate<=20?"Low frame rate detected":"",Date.now()-this.consciousnessState.lastUpdateTime>=5e3?"No recent updates":""].filter(i=>i),metrics:{frameRate:this.consciousnessState.frameRate,energy:this.consciousnessState.energy,intensity:this.consciousnessState.intensity,animationActive:this.consciousnessState.animationActive,lastUpdate:this.consciousnessState.lastUpdateTime}}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=0),this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=0),g.unsubscribeAll("HeaderConsciousnessController"),u?.debug?.log("HeaderConsciousnessController","Header consciousness system cleaned up")}async initialize(){await this._baseInitialize()}async destroy(){this._performSystemSpecificCleanup()}onAnimate(e){this.consciousnessState.animationActive&&this.updateHeaderConsciousnessVariables()}}});function fr(c,t){let e=Math.max(0,Math.min(.9999,c))*63,i=Math.max(0,Math.min(.9999,t))*63,n=Math.floor(e),r=Math.floor(i),a=n+1,s=r+1,o=e-n,l=i-r,m=dt[r*64+n],d=dt[r*64+a%64],h=dt[s%64*64+n],p=dt[s%64*64+a%64],b=(L,$,G)=>L+($-L)*G,v=b(m.x,d.x,o),C=b(m.y,d.y,o),P=b(h.x,p.x,o),E=b(h.y,p.y,o);return{x:b(v,P,l),y:b(C,E,l)}}var dt,Is=y(()=>{"use strict";dt=new Array(4096);(function(){for(let t=0;t<dt.length;t++){let e=Math.random()*Math.PI*2;dt[t]={x:Math.cos(e),y:Math.sin(e)}}})()});var Bi,Rs=y(()=>{"use strict";U();mt();N();D();A();Is();Bi=class extends re{constructor(e){super(e);this.systemName="UnifiedSidebarConsciousnessController";this.sidebarPerformanceCoordinator=null;this.consciousnessChoreographer=null;this.currentConsciousnessField=null;this.animationFrameId=null;this.lastFrameTime=0;this.frameTimeHistory=[];this.eventUnsubscribeFunctions=[];this.bilateralState=null;this.rootNavBar=null;this.overlayContainer=null;this.consciousnessVisualizer=null;this.harmonicModeIndicator=null;this.resizeObserver=null;this.masterAnimationRegistered=!1;this.isUsingMasterAnimation=!1;this._lastMotionDisabled=!1;this._navInteractionHandler=null;this.sidebarConfig={enabled:!0,bilateralMode:!1,consciousnessThreshold:.3,musicResponsiveness:.8,beatSensitivity:.7,energySmoothing:.85,animationIntensity:.6,smoothingFactor:.85,maxFrameTime:1,bilateralOffset:150,crossChannelBleed:.15,enablePerformanceMonitoring:!0,adaptiveQuality:!0,debugMode:e.enableDebug||!1,echoIntensity:2,enableTemporalEcho:!0,enableHarmonicModes:!0,enableDeviceDetection:!0},this.consciousnessState=this.createInitialConsciousnessState(),u?.debug?.log("UnifiedSidebarConsciousnessController","Enhanced unified sidebar consciousness controller created (Phase 2.5)")}get systemPriority(){return"normal"}createInitialConsciousnessState(){return{consciousnessLevel:"dormant",bilateralCoordination:!1,musicSync:{energy:0,valence:.5,beat:!1,tempo:120,lastBeatTime:0},animation:{intensity:0,phase:0,lastFrameTime:0,targetIntensity:0,smoothingFactor:this.sidebarConfig.smoothingFactor,currentScale:1,baseOpacity:.7,pulseDirection:1,lastPulse:0},performance:{frameTime:0,avgFrameTime:0,maxFrameTime:0,healthStatus:"excellent"},deviceCapabilities:{supportsCSSFilter:this._detectCSSFilterSupport(),supportsTransforms:this._detectTransformSupport(),performanceLevel:this._detectPerformanceLevel(),reducedMotion:this._detectReducedMotion(),memory:navigator.deviceMemory||4,cores:navigator.hardwareConcurrency||4},temporalEcho:{echoPool:[],currentEchoCount:0,maxEchoes:this._getMaxEchoes(),echoTimerCounter:0,activeEchoElements:new Set},harmonicMode:{currentModeKey:"artist-vision",currentModeClass:"",currentEnergyClass:"",modeConfig:null}}}async initialize(){return this._baseInitialize()}onAnimate(e){}async _baseInitialize(){try{u?.debug?.log("UnifiedSidebarConsciousnessController","Starting enhanced unified initialization...");let e=globalThis.year3000System;this.cssController=e?.cssConsciousnessController||T(),await this.initializeDOMElements(),await this.initializePerformanceCoordinator(),await this.initializeConsciousnessIntegration(),this.sidebarConfig.enableHarmonicModes&&(this.createOverlayContainer(),this.createConsciousnessVisualizer(),this.createHarmonicModeDisplay(),this.updateColors()),this.sidebarConfig.enableTemporalEcho&&this.setupInteractionHandling(),this.setupResizeObserver(),this.subscribeToUnifiedEvents(),this.sidebarConfig.bilateralMode&&this.initializeBilateralCoordination(),this.startUnifiedAnimationLoop(),this.initialized=!0,u?.debug?.log("UnifiedSidebarConsciousnessController",`Enhanced unified sidebar consciousness initialized (bilateral: ${this.sidebarConfig.bilateralMode}, echo: ${this.sidebarConfig.enableTemporalEcho}, harmonic: ${this.sidebarConfig.enableHarmonicModes})`)}catch(e){throw u?.debug?.error("UnifiedSidebarConsciousnessController","Failed to initialize:",e),e}}async initializePerformanceCoordinator(){try{this.sidebarPerformanceCoordinator=globalThis.sidebarPerformanceCoordinator||null,this.sidebarPerformanceCoordinator?u?.debug?.log("UnifiedSidebarConsciousnessController","Connected to shared SidebarPerformanceCoordinator"):u?.debug?.warn("UnifiedSidebarConsciousnessController","SidebarPerformanceCoordinator not available, CSS updates may be less efficient")}catch(e){u?.debug?.warn("UnifiedSidebarConsciousnessController","Performance coordinator initialization failed:",e)}}async initializeConsciousnessIntegration(){try{this.consciousnessChoreographer=globalThis.backgroundConsciousnessChoreographer||null,this.consciousnessChoreographer?(this.consciousnessChoreographer.registerConsciousnessParticipant(this),u?.debug?.log("UnifiedSidebarConsciousnessController","Registered with consciousness choreographer")):u?.debug?.log("UnifiedSidebarConsciousnessController","Operating without consciousness choreographer integration")}catch(e){u?.debug?.warn("UnifiedSidebarConsciousnessController","Consciousness integration failed:",e)}}subscribeToUnifiedEvents(){let e=g.subscribe("music:beat",this.handleMusicBeat.bind(this),"UnifiedSidebarConsciousnessController");this.eventUnsubscribeFunctions.push(()=>g.unsubscribe(e));let i=g.subscribe("music:energy",this.handleMusicEnergy.bind(this),"UnifiedSidebarConsciousnessController");this.eventUnsubscribeFunctions.push(()=>g.unsubscribe(i));let n=g.subscribe("settings:visual-guide-changed",this.handleSettingsChange.bind(this),"UnifiedSidebarConsciousnessController");this.eventUnsubscribeFunctions.push(()=>g.unsubscribe(n));let r=g.subscribe("colors:harmonized",this.handleColorsHarmonized.bind(this),"UnifiedSidebarConsciousnessController");this.eventUnsubscribeFunctions.push(()=>g.unsubscribe(r));let a=g.subscribe("colors:extracted",this.handleColorsExtracted.bind(this),"UnifiedSidebarConsciousnessController");this.eventUnsubscribeFunctions.push(()=>g.unsubscribe(a));let s=g.subscribe("emotionalColorContext:updated",this.handleColorConsciousnessUpdate.bind(this),"UnifiedSidebarConsciousnessController");this.eventUnsubscribeFunctions.push(()=>g.unsubscribe(s)),u?.debug?.log("UnifiedSidebarConsciousnessController",`Subscribed to ${this.eventUnsubscribeFunctions.length} unified events (including color consciousness)`)}initializeBilateralCoordination(){this.bilateralState={leftSide:this.createInitialConsciousnessState(),rightSide:this.createInitialConsciousnessState(),coordinationOffset:this.sidebarConfig.bilateralOffset,lastCoordinationTime:0},this.consciousnessState.bilateralCoordination=!0,u?.debug?.log("UnifiedSidebarConsciousnessController",`Bilateral coordination initialized with ${this.sidebarConfig.bilateralOffset}ms offset`)}startUnifiedAnimationLoop(){let e=i=>{if(!this.initialized)return;let n=i-this.lastFrameTime;this.lastFrameTime=i;let r=performance.now();try{this.updateConsciousnessState(n),this.sidebarConfig.bilateralMode&&this.bilateralState&&this.updateBilateralCoordination(n),this.applyCSSUpdates();let a=performance.now()-r;this.updatePerformanceMetrics(a),a>this.sidebarConfig.maxFrameTime&&u?.debug?.warn("UnifiedSidebarConsciousnessController",`Frame time exceeded budget: ${a.toFixed(2)}ms`)}catch(a){u?.debug?.error("UnifiedSidebarConsciousnessController","Animation loop error:",a)}this.animationFrameId=requestAnimationFrame(e)};this.animationFrameId=requestAnimationFrame(e)}updateConsciousnessState(e){let i=this.consciousnessState,n=i.musicSync.energy*this.sidebarConfig.musicResponsiveness;i.animation.targetIntensity=Math.min(n,1),i.animation.intensity=this.lerp(i.animation.intensity,i.animation.targetIntensity,i.animation.smoothingFactor),i.animation.phase+=e*.001,i.animation.phase>Math.PI*2&&(i.animation.phase-=Math.PI*2),this.updateConsciousnessLevel()}updateConsciousnessLevel(){let e=this.consciousnessState,i=e.animation.intensity+(e.musicSync.beat?.3:0);i>.8?e.consciousnessLevel="transcendent":i>.5?e.consciousnessLevel="focused":i>.2?e.consciousnessLevel="aware":e.consciousnessLevel="dormant",this.sidebarConfig.bilateralMode&&g.emit("consciousness:coordination",{source:"UnifiedSidebarConsciousnessController",state:{type:"bilateral-consciousness-level",level:e.consciousnessLevel,intensity:e.animation.intensity},timestamp:Date.now()})}updateBilateralCoordination(e){if(!this.bilateralState)return;let i=Date.now();if(i-this.bilateralState.lastCoordinationTime>this.bilateralState.coordinationOffset){let n=this.bilateralState.leftSide.animation.intensity,r=this.bilateralState.rightSide.animation.intensity;this.bilateralState.rightSide.animation.targetIntensity=n*(1-this.sidebarConfig.crossChannelBleed)+r*this.sidebarConfig.crossChannelBleed,this.bilateralState.lastCoordinationTime=i,g.emit("consciousness:coordination",{source:"UnifiedSidebarConsciousnessController",state:{type:"bilateral-coordination",leftIntensity:n,rightIntensity:r,offset:this.bilateralState.coordinationOffset},timestamp:Date.now()})}}applyCSSUpdates(){if(!this.sidebarPerformanceCoordinator){this.applyDirectCSSUpdates();return}let e=this.consciousnessState,i={"--sn-sidebar-consciousness-level":e.consciousnessLevel,"--sn-sidebar-intensity":e.animation.intensity.toFixed(3),"--sn-sidebar-phase":e.animation.phase.toFixed(3),"--sn-sidebar-energy":e.musicSync.energy.toFixed(3),"--sn-sidebar-valence":e.musicSync.valence.toFixed(3)};this.sidebarConfig.bilateralMode&&this.bilateralState&&(i["--sn-sidebar-bilateral-left"]=this.bilateralState.leftSide.animation.intensity.toFixed(3),i["--sn-sidebar-bilateral-right"]=this.bilateralState.rightSide.animation.intensity.toFixed(3));try{for(let[n,r]of Object.entries(i))this.sidebarPerformanceCoordinator.queueUpdate(n,r)}catch(n){u?.debug?.warn("UnifiedSidebarConsciousnessController","CSS update error:",n),this.applyDirectCSSUpdates()}}applyDirectCSSUpdates(){let e=this.consciousnessState,i={"--sn-sidebar-consciousness-level":e.consciousnessLevel,"--sn-sidebar-intensity":e.animation.intensity.toFixed(3),"--sn-sidebar-phase":e.animation.phase.toFixed(3),"--sn-sidebar-energy":e.musicSync.energy.toFixed(3),"--sn-sidebar-valence":e.musicSync.valence.toFixed(3)};this.cssController.batchSetVariables("UnifiedSidebarConsciousnessController",i,"high","sidebar-consciousness-fallback-update")}updatePerformanceMetrics(e){let i=this.consciousnessState.performance;i.frameTime=e,this.frameTimeHistory.push(e),this.frameTimeHistory.length>60&&this.frameTimeHistory.shift(),i.avgFrameTime=this.frameTimeHistory.reduce((n,r)=>n+r,0)/this.frameTimeHistory.length,i.maxFrameTime=Math.max(...this.frameTimeHistory),i.avgFrameTime>2?i.healthStatus="critical":i.avgFrameTime>1.5?i.healthStatus="degraded":i.avgFrameTime>1?i.healthStatus="good":i.healthStatus="excellent"}handleMusicBeat(e){let i=this.consciousnessState.musicSync;i.beat=!0,i.lastBeatTime=Date.now(),setTimeout(()=>{i.beat=!1},100),this.sidebarConfig.debugMode&&u?.debug?.log("UnifiedSidebarConsciousnessController","Music beat received")}handleMusicEnergy(e){let i=this.consciousnessState.musicSync;e.energy!==void 0&&(i.energy=this.lerp(i.energy,e.energy,1-this.sidebarConfig.energySmoothing)),e.valence!==void 0&&(i.valence=this.lerp(i.valence,e.valence,1-this.sidebarConfig.energySmoothing)),e.tempo!==void 0&&(i.tempo=e.tempo)}handleSettingsChange(e){let{key:i,value:n}=e;i.startsWith("sn-sidebar-")&&this.updateConfigFromSettings(i,n)}updateConfigFromSettings(e,i){switch(e){case"sn-sidebar-intensity":this.sidebarConfig.animationIntensity=parseFloat(i)||.6;break;case"sn-sidebar-bilateral":let n=i==="true"||i===!0;n!==this.sidebarConfig.bilateralMode&&(this.sidebarConfig.bilateralMode=n,n?this.initializeBilateralCoordination():(this.bilateralState=null,this.consciousnessState.bilateralCoordination=!1));break;case"sn-sidebar-responsiveness":this.sidebarConfig.musicResponsiveness=parseFloat(i)||.8;break}}handleColorsHarmonized(e){let{processedColors:i,coordinationMetrics:n}=e;try{this.updateSidebarColorsFromOKLAB(i),n?.emotionalState&&this.adjustConsciousnessForColorState(n),u?.debug?.log("UnifiedSidebarConsciousnessController","\u{1F3A8} Updated sidebar colors from harmonized OKLAB data",{colorCount:Object.keys(i).length,emotionalState:n?.emotionalState})}catch(r){u?.debug?.error("UnifiedSidebarConsciousnessController","Failed to handle colors:harmonized event:",r)}}handleColorsExtracted(e){let{rawColors:i,musicData:n}=e;try{i?.DOMINANT&&this.updateSidebarAccentColor(i.DOMINANT),n&&this.adjustMusicResponsivenessForColors(n),u?.debug?.log("UnifiedSidebarConsciousnessController","\u{1F3A8} Applied immediate color feedback from extracted colors")}catch(r){u?.debug?.error("UnifiedSidebarConsciousnessController","Failed to handle colors:extracted event:",r)}}handleColorConsciousnessUpdate(e){let{palette:i,consciousnessLevel:n,emotionalTemperature:r}=e;try{let a=n*.4;if(a>.8?this.consciousnessState.consciousnessLevel="transcendent":a>.5?this.consciousnessState.consciousnessLevel="focused":a>.2?this.consciousnessState.consciousnessLevel="aware":this.consciousnessState.consciousnessLevel="dormant",r!==void 0){let s=typeof r=="string"?parseFloat(r):r;isNaN(s)||this.updateSidebarTemperature(s)}u?.debug?.log("UnifiedSidebarConsciousnessController","\u{1F3A8} Synchronized sidebar consciousness with color state",{consciousnessLevel:a,emotionalTemperature:r})}catch(a){u?.debug?.error("UnifiedSidebarConsciousnessController","Failed to handle colorConsciousnessUpdate event:",a)}}getConsciousnessContribution(){return{systemName:this.systemName,consciousnessLevel:this.consciousnessState.consciousnessLevel,intensity:this.consciousnessState.animation.intensity,musicSync:this.consciousnessState.musicSync,bilateral:this.sidebarConfig.bilateralMode?this.bilateralState:null,timestamp:Date.now()}}onConsciousnessFieldUpdate(e){try{this.currentConsciousnessField=e;let i=e.rhythmicPulse*.3;this.consciousnessState.animation.targetIntensity=Math.min(this.consciousnessState.animation.targetIntensity+i,1),this.sidebarConfig.debugMode&&u?.debug?.log("UnifiedSidebarConsciousnessController","Updated from consciousness field:",{rhythmicPulse:e.rhythmicPulse,sidebarIntensity:this.consciousnessState.animation.intensity})}catch(i){u?.debug?.error("UnifiedSidebarConsciousnessController","Error updating from consciousness field:",i)}}onChoreographyEvent(e,i){e==="transition:start"&&(this.consciousnessState.animation.targetIntensity=Math.min(this.consciousnessState.animation.targetIntensity+.2,1)),this.sidebarConfig.debugMode&&u?.debug?.log("UnifiedSidebarConsciousnessController",`Choreography event: ${e}`,i)}lerp(e,i,n){return e+(i-e)*n}async healthCheck(){let e=this.consciousnessState,i=this.initialized&&e.performance.healthStatus!=="critical"&&e.performance.avgFrameTime<2;return{healthy:i,ok:i,details:`Consciousness: ${e.consciousnessLevel}, Intensity: ${e.animation.intensity.toFixed(2)}, Avg Frame: ${e.performance.avgFrameTime.toFixed(2)}ms, Status: ${e.performance.healthStatus}`+(this.sidebarConfig.bilateralMode?", Bilateral: enabled":""),system:"UnifiedSidebarConsciousnessController"}}_detectCSSFilterSupport(){try{let e=document.createElement("div");return e.style.filter="blur(1px)",e.style.filter==="blur(1px)"}catch{return!1}}_detectTransformSupport(){try{let e=document.createElement("div");return e.style.transform="translateX(1px)",e.style.transform==="translateX(1px)"}catch{return!1}}_detectPerformanceLevel(){let e=navigator.deviceMemory||4,i=navigator.hardwareConcurrency||4;return e>=8&&i>=8?"high":e>=4&&i>=4?"medium":"low"}_detectReducedMotion(){return typeof window<"u"&&window.matchMedia?window.matchMedia("(prefers-reduced-motion: reduce)").matches:!1}_getMaxEchoes(){let e={memory:navigator.deviceMemory||4,cores:navigator.hardwareConcurrency||4};return e.memory>=8&&e.cores>=8?12:e.memory>=4&&e.cores>=4?8:4}async initializeDOMElements(){try{if(this.rootNavBar=document.querySelector(".Root__nav-bar")||document.querySelector('[data-testid="rootlist-container"]')||document.querySelector(".main-navBar-navBar"),!this.rootNavBar){u?.debug?.warn("UnifiedSidebarConsciousnessController","Root navigation bar not found");return}u?.debug?.log("UnifiedSidebarConsciousnessController","DOM elements initialized")}catch(e){throw u?.debug?.error("UnifiedSidebarConsciousnessController","DOM initialization error:",e),e}}createOverlayContainer(){!this.rootNavBar||this.overlayContainer||(this.overlayContainer=document.createElement("div"),this.overlayContainer.className="sn-consciousness-overlay",this.overlayContainer.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 1;
      overflow: hidden;
    `,this.rootNavBar.style.position="relative",this.rootNavBar.appendChild(this.overlayContainer))}createConsciousnessVisualizer(){!this.overlayContainer||this.consciousnessVisualizer||(this.consciousnessVisualizer=document.createElement("div"),this.consciousnessVisualizer.className="sn-consciousness-visualizer",this.consciousnessVisualizer.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at var(--sn-consciousness-x, 50%) var(--sn-consciousness-y, 50%),
                                  hsla(var(--sn-consciousness-hue, 280), 70%, 60%, var(--sn-consciousness-alpha, 0.1)) 0%,
                                  hsla(var(--sn-consciousness-hue, 280), 50%, 40%, var(--sn-consciousness-alpha, 0.05)) 30%,
                                  transparent 70%);
      mix-blend-mode: overlay;
      transition: all 0.3s ease;
      opacity: var(--sn-consciousness-intensity, 0);
    `,this.overlayContainer.appendChild(this.consciousnessVisualizer))}createHarmonicModeDisplay(){!this.overlayContainer||this.harmonicModeIndicator||(this.harmonicModeIndicator=document.createElement("div"),this.harmonicModeIndicator.className="sn-harmonic-mode-indicator",this.harmonicModeIndicator.style.cssText=`
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--sn-harmonic-color, #a855f7);
      opacity: var(--sn-harmonic-intensity, 0);
      transition: all 0.3s ease;
      pointer-events: none;
    `,this.overlayContainer.appendChild(this.harmonicModeIndicator))}updateColors(){if(!this.sidebarPerformanceCoordinator){this.applyDirectColorUpdates();return}let e=this.consciousnessState,i=e.harmonicMode;try{let n=se[i.currentModeKey]||se["artist-vision"];this.sidebarPerformanceCoordinator.queueUpdate("--sn-consciousness-hue","280"),this.sidebarPerformanceCoordinator.queueUpdate("--sn-harmonic-color","#a855f7"),this.sidebarPerformanceCoordinator.queueUpdate("--sn-consciousness-intensity",e.animation.intensity.toFixed(3))}catch(n){u?.debug?.warn("UnifiedSidebarConsciousnessController","Color update error:",n),this.applyDirectColorUpdates()}}applyDirectColorUpdates(){let i={"--sn-consciousness-hue":"280","--sn-harmonic-color":"#a855f7","--sn-consciousness-intensity":this.consciousnessState.animation.intensity.toFixed(3)};this.cssController.batchSetVariables("UnifiedSidebarConsciousnessController",i,"high","sidebar-color-fallback-update")}setupInteractionHandling(){this.rootNavBar&&(this._navInteractionHandler=e=>{this.sidebarConfig.enableTemporalEcho&&this._spawnNavEcho(e)},this.rootNavBar.addEventListener("click",this._navInteractionHandler,{passive:!0}),this.rootNavBar.addEventListener("mouseover",this._navInteractionHandler,{passive:!0}))}setupResizeObserver(){typeof ResizeObserver>"u"||!this.rootNavBar||(this.resizeObserver=new ResizeObserver(e=>{for(let i of e)this.updateConsciousnessVisualizerSize(i.contentRect)}),this.resizeObserver.observe(this.rootNavBar))}updateConsciousnessVisualizerSize(e){if(!this.consciousnessVisualizer)return;let i={"--sn-sidebar-width":`${e.width}px`,"--sn-sidebar-height":`${e.height}px`};if(this.sidebarPerformanceCoordinator)for(let[n,r]of Object.entries(i))this.sidebarPerformanceCoordinator.queueUpdate(n,r);else this.cssController.batchSetVariables("UnifiedSidebarConsciousnessController",i,"normal","sidebar-size-fallback-update")}_spawnNavEcho(e){let i=this.consciousnessState;if(i.deviceCapabilities.reducedMotion||i.temporalEcho.currentEchoCount>=i.temporalEcho.maxEchoes)return;let n=e.target;if(!n)return;let r=this._acquireEchoElement();if(!r)return;let a=n.getBoundingClientRect(),s=this.rootNavBar?.getBoundingClientRect();if(s){let l=a.left-s.left+a.width/2,m=a.top-s.top+a.height/2,d=fr(l*.01,Date.now()*.001),h=fr(m*.01,Date.now()*.001+100),p=d.x*10,b=h.y*10;r.style.left=`${l+p}px`,r.style.top=`${m+b}px`}let o=this.sidebarConfig.echoIntensity/3;r.style.opacity=o.toString(),r.classList.add("sn-echo-active"),setTimeout(()=>{this._releaseEchoElement(r)},1500+Math.random()*1e3),i.temporalEcho.currentEchoCount++,i.temporalEcho.echoTimerCounter++}_acquireEchoElement(){let e=this.consciousnessState;return e.temporalEcho.echoPool.length>0?e.temporalEcho.echoPool.pop()||null:e.temporalEcho.currentEchoCount<e.temporalEcho.maxEchoes?this._createEchoElement():null}_createEchoElement(){let e=document.createElement("div");return e.className="sn-temporal-echo",e.style.cssText=`
      position: absolute;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: radial-gradient(circle, var(--sn-harmonic-color, #a855f7) 0%, transparent 70%);
      pointer-events: none;
      transform: translate(-50%, -50%);
      transition: all 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      opacity: 0;
    `,this.overlayContainer&&this.overlayContainer.appendChild(e),this.consciousnessState.temporalEcho.activeEchoElements.add(e),e}_releaseEchoElement(e){let i=this.consciousnessState;i.temporalEcho.activeEchoElements.delete(e),e.classList.remove("sn-echo-active"),e.style.opacity="0",i.temporalEcho.echoPool.length<i.temporalEcho.maxEchoes?i.temporalEcho.echoPool.push(e):e.remove(),i.temporalEcho.currentEchoCount=Math.max(0,i.temporalEcho.currentEchoCount-1)}updateHarmonicModeDisplay(){let i=this.consciousnessState.harmonicMode,n=se[i.currentModeKey]||se["artist-vision"];if(i.modeConfig=n,this.rootNavBar){i.currentModeClass&&this.rootNavBar.classList.remove(i.currentModeClass);let r=`sn-harmonic-${i.currentModeKey}`;this.rootNavBar.classList.add(r),i.currentModeClass=r}this.updateColors(),u?.debug?.log("UnifiedSidebarConsciousnessController",`Harmonic mode updated to: ${i.currentModeKey}`)}updateConfiguration(e){Object.assign(this.sidebarConfig,e),e.bilateralMode!==void 0&&(e.bilateralMode&&!this.bilateralState?this.initializeBilateralCoordination():!e.bilateralMode&&this.bilateralState&&(this.bilateralState=null,this.consciousnessState.bilateralCoordination=!1)),e.enableHarmonicModes!==void 0&&e.enableHarmonicModes&&this.overlayContainer&&this.updateHarmonicModeDisplay(),e.enableTemporalEcho!==void 0&&e.enableTemporalEcho&&this.rootNavBar&&!this._navInteractionHandler&&this.setupInteractionHandling(),u?.debug?.log("UnifiedSidebarConsciousnessController","Configuration updated:",e)}getConfiguration(){return{...this.sidebarConfig}}getConsciousnessState(){return{...this.consciousnessState}}getBilateralState(){return this.bilateralState}async destroy(){u?.debug?.log("UnifiedSidebarConsciousnessController","Destroying enhanced unified consciousness controller..."),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.rootNavBar&&this._navInteractionHandler&&(this.rootNavBar.removeEventListener("click",this._navInteractionHandler),this.rootNavBar.removeEventListener("mouseover",this._navInteractionHandler),this._navInteractionHandler=null);let e=this.consciousnessState;if(e.temporalEcho){e.temporalEcho.activeEchoElements.forEach(i=>{i.remove()}),e.temporalEcho.activeEchoElements.clear();for(let i of e.temporalEcho.echoPool)i.remove();e.temporalEcho.echoPool=[],e.temporalEcho.currentEchoCount=0}this.overlayContainer&&(this.overlayContainer.remove(),this.overlayContainer=null),this.consciousnessVisualizer=null,this.harmonicModeIndicator=null,this.rootNavBar=null;for(let i of this.eventUnsubscribeFunctions)i();this.eventUnsubscribeFunctions=[],this.consciousnessChoreographer,this.bilateralState=null,this.initialized=!1,u?.debug?.log("UnifiedSidebarConsciousnessController","Enhanced unified consciousness controller destroyed")}updateSidebarColorsFromOKLAB(e){if(this.sidebarPerformanceCoordinator)try{let i=e.VIBRANT||e.PROMINENT||e.DOMINANT,n=e.LIGHT_VIBRANT||e.LIGHT_MUTED||i,r=e.DARK_VIBRANT||e.DARK_MUTED||i;if(i){this.sidebarPerformanceCoordinator.queueUpdate("--sn-sidebar-accent-color",i),this.sidebarPerformanceCoordinator.queueUpdate("--sn-sidebar-dynamic-accent",i);let a=this.hexToRgb(i);a!==null&&(this.sidebarPerformanceCoordinator.queueUpdate("--sn-sidebar-accent-rgb",a),this.sidebarPerformanceCoordinator.queueUpdate("--sn-sidebar-entanglement-color-rgb",a))}if(n){this.sidebarPerformanceCoordinator.queueUpdate("--sn-sidebar-secondary-color",n);let a=this.hexToRgb(n);a!==null&&this.sidebarPerformanceCoordinator.queueUpdate("--sn-sidebar-secondary-rgb",a)}r&&this.sidebarPerformanceCoordinator.queueUpdate("--sn-sidebar-shadow-color",r)}catch(i){u?.debug?.error("UnifiedSidebarConsciousnessController","Failed to update sidebar colors from OKLAB:",i)}}updateSidebarAccentColor(e){if(this.sidebarPerformanceCoordinator)try{this.sidebarPerformanceCoordinator.queueUpdate("--sn-sidebar-accent-color",e),this.sidebarPerformanceCoordinator.queueUpdate("--sn-sidebar-dynamic-accent",e);let i=this.hexToRgb(e);i!==null&&this.sidebarPerformanceCoordinator.queueUpdate("--sn-sidebar-accent-rgb",i)}catch(i){u?.debug?.error("UnifiedSidebarConsciousnessController","Failed to update sidebar accent color:",i)}}adjustConsciousnessForColorState(e){let{emotionalState:i,detectedGenre:n,oklabPreset:r}=e;try{if(i)switch(i){case"energetic":case"aggressive":this.consciousnessState.animation.intensity=Math.min(1,this.consciousnessState.animation.intensity*1.3);break;case"calm":case"ambient":this.consciousnessState.animation.intensity=Math.max(.2,this.consciousnessState.animation.intensity*.7);break;case"mysterious":this.consciousnessState.animation.intensity=Math.min(.8,this.consciousnessState.animation.intensity*1.1);break}if(n)switch(n){case"electronic":case"dance":this.sidebarConfig.musicResponsiveness=Math.min(1,this.sidebarConfig.musicResponsiveness*1.2);break;case"classical":case"ambient":this.sidebarConfig.musicResponsiveness=Math.max(.3,this.sidebarConfig.musicResponsiveness*.8);break}}catch(a){u?.debug?.error("UnifiedSidebarConsciousnessController","Failed to adjust consciousness for color state:",a)}}adjustMusicResponsivenessForColors(e){try{if(e.tempo){let i=Math.max(.5,Math.min(1.5,e.tempo/120));this.sidebarConfig.musicResponsiveness=Math.min(1,this.sidebarConfig.musicResponsiveness*i)}if(e.energy!==void 0){let i=e.energy*.3;this.consciousnessState.animation.intensity=Math.max(.1,Math.min(1,this.consciousnessState.animation.intensity+i))}}catch(i){u?.debug?.error("UnifiedSidebarConsciousnessController","Failed to adjust music responsiveness for colors:",i)}}updateSidebarTemperature(e){if(!(!this.sidebarPerformanceCoordinator||!e))try{let i=0;e<3e3?i=180+(3e3-e)/100:e>6e3?i=(e-6e3)/100:i=(e-4500)/50,this.sidebarPerformanceCoordinator.queueUpdate("--sn-sidebar-hue-shift",`${i}deg`)}catch(i){u?.debug?.error("UnifiedSidebarConsciousnessController","Failed to update sidebar temperature:",i)}}hexToRgb(e){try{let i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(!i||i.length<4)return null;let n=parseInt(i[1],16),r=parseInt(i[2],16),a=parseInt(i[3],16);return`${n}, ${r}, ${a}`}catch{return null}}}});var Sr,Fi,Ds=y(()=>{"use strict";D();Sr=class{static selectOptimalBackend(t){let e=t.filter(i=>i.backend.isReady&&i.backend.capabilities).sort((i,n)=>n.priority-i.priority);for(let i of e){let n=i.capabilities;if(n.webgl2&&n.maxTextureSize>=2048||n.webgl&&n.maxTextureSize>=1024||i.backend.backendId==="css")return i.backend}return null}},Fi=class{constructor(t,e,i,n,r,a={}){this.initialized=!1;this.registeredBackends=new Map;this.activeBackend=null;this.rootElement=null;this.currentPalette=[];this.currentMusicMetrics=null;this.lastFrameTime=0;this.frameCount=0;this.performanceCheckInterval=null;this.eventBus=t||g,this.cssConsciousnessController=e,this.colorHarmonyEngine=i,this.musicSyncService=n,this.performanceAnalyzer=r,this.config={enabledBackends:["webgl","css"],defaultQuality:"high",transitionDuration:500,performanceMonitoring:!0,autoQualityScaling:!0,...a},this.currentConstraints={targetFPS:60,maxMemoryMB:50,cpuBudgetPercent:10,gpuBudgetPercent:25,qualityLevel:this.config.defaultQuality}}async initialize(){try{this.setupEventListeners(),this.setupCSSVariableUpdates(),this.config.performanceMonitoring&&this.startPerformanceMonitoring(),this.updateGlobalStatus(),this.initialized=!0,console.log("[GradientConductor] Initialized successfully",{enabledBackends:this.config.enabledBackends,registeredBackends:Array.from(this.registeredBackends.keys())})}catch(t){throw console.error("[GradientConductor] Initialization failed:",t),t}}registerBackend(t,e=0){let i={backend:t,priority:e,capabilities:t.capabilities,lastHealthCheck:new Date,isActive:!1};this.registeredBackends.set(t.backendId,i),console.log(`[GradientConductor] Registered backend: ${t.backendId}`,{priority:e,capabilities:t.capabilities}),this.evaluateActiveBackend()}unregisterBackend(t){let e=this.registeredBackends.get(t);e&&(e.backend.setEnabled(!1),this.registeredBackends.delete(t),this.activeBackend?.backendId===t&&(this.activeBackend=null,this.evaluateActiveBackend()),console.log(`[GradientConductor] Unregistered backend: ${t}`))}async initializeBackends(t){this.rootElement=t;let e=Array.from(this.registeredBackends.values()).map(async i=>{try{await i.backend.init(t,this.currentConstraints),console.log(`[GradientConductor] Backend ${i.backend.backendId} initialized`)}catch(n){console.error(`[GradientConductor] Failed to initialize backend ${i.backend.backendId}:`,n)}});await Promise.allSettled(e),this.evaluateActiveBackend(),this.activeBackend&&(this.currentPalette.length>0&&this.activeBackend.setPalette(this.currentPalette),this.currentMusicMetrics&&this.activeBackend.setMusicMetrics(this.currentMusicMetrics))}setPalette(t,e=this.config.transitionDuration){this.currentPalette=[...t],this.updateCSSGradientVariables(t),this.activeBackend&&this.activeBackend.setPalette(t,e),this.updateGlobalStatus(),console.log("[GradientConductor] Palette updated",{stops:t.length,activeBackend:this.activeBackend?.backendId,transition:e})}setMusicMetrics(t){this.currentMusicMetrics=t,this.updateCSSMusicVariables(t),this.activeBackend&&this.activeBackend.setMusicMetrics(t),this.eventBus.emit("music:energy",{energy:t.energy,valence:t.valence,tempo:t.bpm,timestamp:Date.now()})}setPerformanceConstraints(t){this.currentConstraints={...t};for(let e of this.registeredBackends.values())e.backend.setPerformanceConstraints(t);t.qualityLevel!==this.currentConstraints.qualityLevel&&this.evaluateActiveBackend(),console.log("[GradientConductor] Performance constraints updated",t)}getActiveBackend(){return this.activeBackend}async triggerMusicEmotionAnalysis(t,e){try{if(this.colorHarmonyEngine&&typeof this.colorHarmonyEngine.analyzeMusicEmotion=="function"){let i=await this.colorHarmonyEngine.analyzeMusicEmotion(t,e);i&&this.config.performanceMonitoring&&console.log(`[GradientConductor] Music emotion analysis triggered: ${i.primary} (${i.intensity.toFixed(2)} intensity)`)}else console.warn("[GradientConductor] ColorHarmonyEngine not available for music emotion analysis")}catch(i){console.error("[GradientConductor] Error triggering music emotion analysis:",i)}}getRegisteredBackends(){return Array.from(this.registeredBackends.values())}setActiveBackend(t){let e=this.registeredBackends.get(t);if(!e||!e.backend.isReady)return!1;if(this.activeBackend){this.activeBackend.setEnabled(!1);let i=this.registeredBackends.get(this.activeBackend.backendId);i&&(i.isActive=!1)}return this.activeBackend=e.backend,e.isActive=!0,e.backend.setEnabled(!0,this.config.transitionDuration),this.updateGlobalStatus(),console.log(`[GradientConductor] Forced backend switch to: ${t}`),!0}async healthCheck(){let t=[];for(let[e,i]of this.registeredBackends)try{let n=await i.backend.healthCheck();i.lastHealthCheck=new Date,n.ok||t.push(`Backend ${e}: ${n.details||"Health check failed"}`)}catch(n){t.push(`Backend ${e}: Health check error - ${n}`)}return{healthy:t.length===0,ok:t.length===0,details:t.length>0?`${t.length} backend issues detected`:"All backends healthy",issues:t,system:"GradientConductor"}}updateAnimation(t){this.frameCount++,this.lastFrameTime=t,this.activeBackend&&this.activeBackend.updateAnimation(t)}destroy(){this.performanceCheckInterval&&(clearInterval(this.performanceCheckInterval),this.performanceCheckInterval=null);for(let t of this.registeredBackends.values())t.backend.destroy();this.registeredBackends.clear(),this.activeBackend=null,this.initialized=!1,console.log("[GradientConductor] Destroyed")}setupEventListeners(){this.eventBus.subscribe("colors:harmonized",t=>{if(t&&t.processedColors){let e=Object.entries(t.processedColors).map(([i,n],r,a)=>{let s=n,o=128,l=128,m=128;if(s.startsWith("#")){let d=s.slice(1);o=parseInt(d.slice(0,2),16),l=parseInt(d.slice(2,4),16),m=parseInt(d.slice(4,6),16)}return{r:o,g:l,b:m,position:r/(a.length-1)}});this.setPalette(e)}},"GradientConductor"),this.eventBus.subscribe("music:energy",t=>{let e={energy:t.energy,valence:t.valence,bpm:t.tempo,beatIntensity:t.energy,rhythmPhase:0,breathingScale:1+t.energy*.2};this.setMusicMetrics(e)},"GradientConductor"),this.eventBus.subscribe("music:beat",t=>{let e={energy:t.intensity,valence:.5,bpm:t.bpm,beatIntensity:t.intensity,rhythmPhase:Date.now()/16.67%360,breathingScale:1+t.intensity*.1};this.setMusicMetrics(e)},"GradientConductor"),this.eventBus.subscribe("performance:tier-changed",t=>{let e={targetFPS:60,maxMemoryMB:50,cpuBudgetPercent:10,gpuBudgetPercent:25,qualityLevel:t.tier==="excellent"?"ultra":t.tier==="good"?"high":t.tier==="degraded"?"medium":"low"};this.setPerformanceConstraints(e)},"GradientConductor"),this.eventBus.subscribe("settings:changed",t=>{if(t.settingKey.includes("accessibility")||t.settingKey.includes("motion")){let e={reducedMotion:t.settingKey.includes("motion")&&t.newValue==="reduce",highContrast:t.settingKey.includes("contrast")&&t.newValue==="high",prefersTransparency:t.settingKey.includes("transparency")&&t.newValue==="reduce"};for(let i of this.registeredBackends.values())i.backend.applyAccessibilityPreferences?.(e)}},"GradientConductor"),this.eventBus.subscribe("emotion:analyzed",t=>{this.handleEmotionUpdate(t)},"GradientConductor"),this.eventBus.subscribe("emotionalColorContext:updated",t=>{this.handleEmotionalColorContext(t)},"GradientConductor")}setupCSSVariableUpdates(){["--sn.music.beat.pulse.intensity","--sn.music.rhythm.phase","--sn.music.breathing.scale","--sn.bg.webgl.ready","--sn.bg.active-backend","--sn-emotion-primary","--sn-emotion-intensity","--sn-color-temperature","--sn-consciousness-level","--sn-organic-flow","--sn-cinematic-depth"].forEach(e=>{this.cssConsciousnessController.addCriticalVariable(e)})}handleEmotionUpdate(t){try{let{emotion:e,colorTemperature:i,consciousnessLevel:n,organicFlow:r,cinematicDepth:a}=t;this.cssConsciousnessController.setProperty("--sn-emotion-primary",e.primary||"neutral"),this.cssConsciousnessController.setProperty("--sn-emotion-intensity",(e.intensity||.5).toString()),this.cssConsciousnessController.setProperty("--sn-emotion-confidence",(e.confidence||.5).toString()),this.cssConsciousnessController.setProperty("--sn-color-temperature",(i||6500).toString()),this.cssConsciousnessController.setProperty("--sn-consciousness-level",(n||.5).toString()),this.cssConsciousnessController.setProperty("--sn-organic-flow",(r||.5).toString()),this.cssConsciousnessController.setProperty("--sn-cinematic-depth",(a||.5).toString());for(let s of this.registeredBackends.values())s.backend.setEmotionalState&&s.backend.setEmotionalState(e);console.log(`[GradientConductor] Emotion updated: ${e.primary} (intensity: ${e.intensity?.toFixed(2)||"N/A"})`)}catch(e){console.error("[GradientConductor] Error handling emotion update:",e)}}handleEmotionalColorContext(t){try{let{primaryEmotion:e,emotionIntensity:i,colorTemperature:n,valence:r,arousal:a,dominance:s,organicFlow:o,cinematicDepth:l,consciousnessResonance:m}=t;this.cssConsciousnessController.setProperty("--sn-emotion-valence",(r||.5).toString()),this.cssConsciousnessController.setProperty("--sn-emotion-arousal",(a||.5).toString()),this.cssConsciousnessController.setProperty("--sn-emotion-dominance",(s||.5).toString()),this.cssConsciousnessController.setProperty("--sn-consciousness-resonance",(m||.5).toString());for(let d of this.registeredBackends.values())d.backend.setEmotionalContext&&d.backend.setEmotionalContext(t);console.log(`[GradientConductor] Emotional context updated: ${e} (temp: ${n}K)`)}catch(e){console.error("[GradientConductor] Error handling emotional color context:",e)}}updateCSSGradientVariables(t){if(t.length===0)return;let e=t[0],i=t[Math.floor(t.length/2)],n=t[t.length-1];this.cssConsciousnessController.setProperty("--sn.bg.gradient.primary.rgb",`${e.r}, ${e.g}, ${e.b}`),this.cssConsciousnessController.setProperty("--sn.bg.gradient.secondary.rgb",`${i.r}, ${i.g}, ${i.b}`),this.cssConsciousnessController.setProperty("--sn.bg.gradient.accent.rgb",`${n.r}, ${n.g}, ${n.b}`),this.cssConsciousnessController.setProperty("--sn.color.accent.rgb",`${n.r}, ${n.g}, ${n.b}`),this.cssConsciousnessController.setProperty("--sn.color.accent.hex",`#${Math.round(n.r).toString(16).padStart(2,"0")}${Math.round(n.g).toString(16).padStart(2,"0")}${Math.round(n.b).toString(16).padStart(2,"0")}`)}updateCSSMusicVariables(t){t.beatIntensity!==void 0&&this.cssConsciousnessController.setProperty("--sn.music.beat.pulse.intensity",t.beatIntensity.toString()),t.rhythmPhase!==void 0&&this.cssConsciousnessController.setProperty("--sn.music.rhythm.phase",`${t.rhythmPhase}deg`),t.breathingScale!==void 0&&this.cssConsciousnessController.setProperty("--sn.music.breathing.scale",t.breathingScale.toString()),this.cssConsciousnessController.setProperty("--sn.music.energy.level",t.energy.toString()),this.cssConsciousnessController.setProperty("--sn.music.valence",t.valence.toString()),this.cssConsciousnessController.setProperty("--sn.music.tempo.bpm",t.bpm.toString())}updateGlobalStatus(){this.cssConsciousnessController.setProperty("--sn.bg.webgl.ready",this.registeredBackends.has("webgl")?"1":"0"),this.cssConsciousnessController.setProperty("--sn.bg.active-backend",this.activeBackend?.backendId||"none"),typeof window<"u"&&(window.snActiveBackend=this.activeBackend?.backendId||"none")}evaluateActiveBackend(){let t=Sr.selectOptimalBackend(Array.from(this.registeredBackends.values()));if(t&&t!==this.activeBackend){if(this.activeBackend){this.activeBackend.setEnabled(!1,this.config.transitionDuration);let i=this.registeredBackends.get(this.activeBackend.backendId);i&&(i.isActive=!1)}this.activeBackend=t;let e=this.registeredBackends.get(t.backendId);e&&(e.isActive=!0,t.setEnabled(!0,this.config.transitionDuration)),this.updateGlobalStatus(),console.log(`[GradientConductor] Switched to backend: ${t.backendId}`),this.eventBus.emit("system:initialized",{systemName:`GradientConductor-${t.backendId}`,timestamp:Date.now(),metadata:{previousBackend:this.activeBackend?.backendId,newBackend:t.backendId,capabilities:t.capabilities}})}}startPerformanceMonitoring(){this.performanceCheckInterval=window.setInterval(()=>{if(this.activeBackend)try{let t=this.activeBackend.getPerformanceMetrics();this.config.autoQualityScaling&&this.evaluateQualityScaling(t),this.performanceAnalyzer.recordMetric("gradientConductor.fps",t.fps),this.performanceAnalyzer.recordMetric("gradientConductor.memory",t.memoryUsageMB)}catch(t){console.warn("[GradientConductor] Performance monitoring error:",t)}},2e3)}evaluateQualityScaling(t){let e=this.currentConstraints;if(t.fps<e.targetFPS*.8||t.memoryUsageMB>e.maxMemoryMB*1.2){let i=e.qualityLevel;switch(e.qualityLevel){case"ultra":i="high";break;case"high":i="medium";break;case"medium":i="low";break;case"low":this.evaluateActiveBackend();return}console.log(`[GradientConductor] Auto-scaling quality: ${e.qualityLevel} \u2192 ${i}`),this.setPerformanceConstraints({...e,qualityLevel:i})}}}});var Gi,ks=y(()=>{"use strict";mt();K();yn();Gi=class extends re{constructor(e){super(e);this.organicIntensity=0;this.cellularGrowth=1;this.breathingPhase=0;this.emotionalTemperature=4e3;this.membraneFluidityLevel=.5;this.targetOrganicIntensity=0;this.targetCellularGrowth=1;this.targetEmotionalTemperature=4e3;this.targetMembraneFluidityLevel=.5;this.lerpHalfLifeValues={intensityAttack:.05,intensityDecay:.15,cellularGrowth:.08,emotionalTemperature:.3,membraneFluidty:.12};this.lastBeatTime=0;this.currentBPM=120;this.breathingCycleDuration=2e3;this.musicSyncService=null;this.currentMusicalContext=null;this.lastBeatPhaseUpdate=0;this.performanceMetrics={organicUpdates:0,cellularGrowthEvents:0,breathingCycles:0,emotionalShifts:0,averageFrameTime:0,memoryUsage:0};this.organicConfig={cellularResponseSensitivity:.7,breathingRhythmIntensity:.8,emotionalTemperatureRange:{min:1e3,max:2e4},membraneFluidityEnabled:!0,atmosphericParticlesEnabled:!0,cinematicEffectsEnabled:!0};this.config.enableDebug&&console.log("[OrganicBeatSyncConsciousness] \u{1F30A} Organic consciousness awakening...")}setMusicSyncService(e){this.musicSyncService=e,this.config.enableDebug&&console.log("[OrganicBeatSyncConsciousness] \u{1F3B5} Musical consciousness integration activated")}async initialize(){this.config.enableDebug&&console.log("[OrganicBeatSyncConsciousness] \u{1F9EC} Initializing organic consciousness..."),this.registerCSSVariableGroup("organic-core","critical"),this.registerCSSVariableGroup("cellular-growth","high"),this.registerCSSVariableGroup("emotional-temperature","normal"),this.registerCSSVariableGroup("membrane-fluidity","normal"),this.subscribeToEvent("music:beat",e=>this.onBeatConsciousness(e)),this.subscribeToEvent("music:energy",e=>this.onEnergyConsciousness(e)),this.subscribeToEvent("music:emotion",e=>this.onEmotionalConsciousness(e)),this.subscribeToEvent("music:bpm-change",e=>this.onTempoConsciousness(e)),this.registerAnimation(60),this.config.enableDebug&&console.log("[OrganicBeatSyncConsciousness] \u{1F31F} Organic consciousness fully awakened")}destroy(){this.config.enableDebug&&console.log("[OrganicBeatSyncConsciousness] \u{1F343} Dissolving organic consciousness..."),this.organicIntensity=0,this.cellularGrowth=1,this.breathingPhase=0,this.emotionalTemperature=4e3,this.config.enableDebug&&console.log("[OrganicBeatSyncConsciousness] \u{1F30C} Organic consciousness peacefully dissolved")}onAnimate(e){let i=performance.now();this.updateMusicalContext(),this.updateOrganicConsciousness(e),this.processCellularGrowth(e),this.updateEmotionalTemperature(e),this.animateMembraneFluidty(e),this.applyOrganicCSSVariables();let n=performance.now()-i;this.performanceMetrics.averageFrameTime=this.performanceMetrics.averageFrameTime*.9+n*.1,this.performanceMetrics.organicUpdates++,n>2&&this.config.enableDebug&&console.warn(`[OrganicBeatSyncConsciousness] \u{1F40C} Organic consciousness frame took ${n.toFixed(2)}ms (target: <2ms)`)}async healthCheck(){let e=[];return this.eventBus||e.push("EventBus not connected for breathing coordination"),this.performanceMetrics.averageFrameTime>2&&e.push(`Average frame time ${this.performanceMetrics.averageFrameTime.toFixed(2)}ms exceeds 2ms target`),this.organicIntensity===0&&Date.now()-this.lastBeatTime>1e4&&e.push("No organic consciousness activity detected in last 10 seconds"),(this.emotionalTemperature<1e3||this.emotionalTemperature>2e4)&&e.push(`Emotional temperature ${this.emotionalTemperature}K outside 1000K-20000K range`),{healthy:e.length===0,ok:e.length===0,details:`Organic consciousness health: ${e.length===0?"thriving":"needs attention"}`,issues:e,system:"OrganicBeatSyncConsciousness"}}onBeatConsciousness(e){let{intensity:i,bpm:n,energy:r,timestamp:a}=e;this.lastBeatTime=a||Date.now(),this.currentBPM=n||this.currentBPM,this.targetOrganicIntensity=Math.min(1,i*this.organicConfig.cellularResponseSensitivity),this.targetCellularGrowth=1+(r||.5)*.3,this.performanceMetrics.cellularGrowthEvents++,this.config.enableDebug&&console.log(`[OrganicBeatSyncConsciousness] \u{1F3B5} Beat consciousness: intensity=${i}, energy=${r}, bpm=${n}`)}onEnergyConsciousness(e){let{energy:i,valence:n}=e;this.targetCellularGrowth=1+i*.3,this.targetMembraneFluidityLevel=.3+n*.4,this.config.enableDebug&&console.log(`[OrganicBeatSyncConsciousness] \u26A1 Energy consciousness: energy=${i}, valence=${n}`)}onEmotionalConsciousness(e){let{valence:i,energy:n}=e,r=4e3,a=(n-.5)*8e3,s=(i-.5)*6e3;this.targetEmotionalTemperature=Math.max(1e3,Math.min(2e4,r+a+s)),this.performanceMetrics.emotionalShifts++,this.config.enableDebug&&console.log(`[OrganicBeatSyncConsciousness] \u{1F308} Emotional consciousness: ${this.emotionalTemperature}K temperature`)}onTempoConsciousness(e){let{bpm:i,tempo:n,enhancedBPM:r}=e;this.currentBPM=r||i||n||120;let a=Math.max(.3,Math.min(3,this.currentBPM/120));this.breathingCycleDuration=2e3/a,this.config.enableDebug&&console.log(`[OrganicBeatSyncConsciousness] \u{1F3B6} Tempo consciousness: ${this.currentBPM} BPM, ${this.breathingCycleDuration.toFixed(0)}ms breathing cycle`)}updateOrganicConsciousness(e){this.breathingPhase+=e/this.breathingCycleDuration*2*Math.PI,this.breathingPhase>2*Math.PI&&(this.breathingPhase-=2*Math.PI);let i=e/1e3,n=this.targetOrganicIntensity>this.organicIntensity?this.lerpHalfLifeValues.intensityAttack:this.lerpHalfLifeValues.intensityDecay;this.organicIntensity=O(this.organicIntensity,this.targetOrganicIntensity,i,n),Date.now()-this.lastBeatTime>2e3&&(this.targetOrganicIntensity=O(this.targetOrganicIntensity,0,i,this.lerpHalfLifeValues.intensityDecay))}processCellularGrowth(e){let i=e/1e3;this.cellularGrowth=O(this.cellularGrowth,this.targetCellularGrowth,i,this.lerpHalfLifeValues.cellularGrowth),this.targetCellularGrowth=O(this.targetCellularGrowth,1,i,this.lerpHalfLifeValues.cellularGrowth*2)}updateEmotionalTemperature(e){let i=e/1e3;this.emotionalTemperature=O(this.emotionalTemperature,this.targetEmotionalTemperature,i,this.lerpHalfLifeValues.emotionalTemperature);let n=4e3;this.targetEmotionalTemperature=O(this.targetEmotionalTemperature,n,i,this.lerpHalfLifeValues.emotionalTemperature*3)}animateMembraneFluidty(e){if(!this.organicConfig.membraneFluidityEnabled)return;let i=e/1e3;this.membraneFluidityLevel=O(this.membraneFluidityLevel,this.targetMembraneFluidityLevel,i,this.lerpHalfLifeValues.membraneFluidty)}applyOrganicCSSVariables(){this.updateCSSVariableGroup("organic-core",{"--organic-intensity":this.organicIntensity.toFixed(3),"--organic-bpm":this.currentBPM.toString(),"--organic-breathing-phase":this.breathingPhase.toFixed(4)}),this.updateCSSVariableGroup("cellular-growth",{"--cellular-growth-scale":this.cellularGrowth.toFixed(3),"--cellular-response-sensitivity":this.organicConfig.cellularResponseSensitivity.toFixed(2)}),this.updateCSSVariableGroup("emotional-temperature",{"--emotional-temperature":`${this.emotionalTemperature.toFixed(0)}K`,"--emotional-temperature-normalized":((this.emotionalTemperature-1e3)/19e3).toFixed(3)}),this.updateCSSVariableGroup("membrane-fluidity",{"--membrane-fluidity-level":this.membraneFluidityLevel.toFixed(3),"--membrane-fluidity-enabled":this.organicConfig.membraneFluidityEnabled?"1":"0"})}getOrganicMetrics(){return{...this.performanceMetrics}}updateOrganicConfig(e){this.organicConfig={...this.organicConfig,...e},this.config.enableDebug&&console.log("[OrganicBeatSyncConsciousness] \u{1F527} Organic configuration updated:",this.organicConfig)}getOrganicState(){return{organicIntensity:this.organicIntensity,cellularGrowth:this.cellularGrowth,breathingPhase:this.breathingPhase,emotionalTemperature:this.emotionalTemperature,membraneFluidityLevel:this.membraneFluidityLevel,lastBeatTime:this.lastBeatTime,currentBPM:this.currentBPM}}forceRepaint(e){super.forceRepaint(e),this.organicIntensity=0,this.cellularGrowth=1,this.breathingPhase=0,this.applyOrganicCSSVariables(),this.config.enableDebug&&console.log(`[OrganicBeatSyncConsciousness] \u{1F504} Organic consciousness repaint: ${e}`)}updateMusicalContext(){if(!this.musicSyncService){this.currentMusicalContext=null;return}let e=Date.now();if(!(e-this.lastBeatPhaseUpdate<16)&&(this.lastBeatPhaseUpdate=e,this.currentMusicalContext=bn.createMusicalContext(this.musicSyncService,this.lastBeatTime),this.config.enableDebug&&this.currentMusicalContext)){let i=this.currentMusicalContext;console.log(`[OrganicBeatSyncConsciousness] \u{1F3B5} Musical context: tempo=${i.tempo}, energy=${i.energy.toFixed(2)}, phase=${i.beatPhase}`)}}}});var Hi,Ls=y(()=>{"use strict";oi();D();A();ke();N();si();xe();ne();Hi=class{constructor(t,e,i){this.holographicElements=new Map;this.interfaceContainer=null;this.isInitialized=!1;this.isEnabled=!0;this.performanceMetrics={elementsProcessed:0,effectsApplied:0,averageProcessingTime:0,memoryUsage:0,lastUpdate:0};this.animationState={lastFrameTime:0,flickerPhase:0,scanlinePhase:0,chromaticPhase:0,dataStreamPhase:0,interferencePhase:0,organicPhase:0,isAnimating:!1};this.holographicPresets={"star-wars":{flickerIntensity:.4,transparency:.8,chromatic:.3,scanlineIntensity:.6,dataStreamFlow:.5,interferenceLevel:.2,energyStability:.7,projectionDistance:.8},"blade-runner":{flickerIntensity:.6,transparency:.7,chromatic:.5,scanlineIntensity:.8,dataStreamFlow:.8,interferenceLevel:.4,energyStability:.6,projectionDistance:.6},"organic-consciousness":{flickerIntensity:.3,transparency:.9,chromatic:.2,scanlineIntensity:.4,dataStreamFlow:.6,interferenceLevel:.3,energyStability:.8,projectionDistance:.9}};this.lastMusicalContext=null;this.eventSubscriptionIds=[];this.lastScrollPosition=0;this.lastMouseMovement=0;this.lastUIClick=0;this.initialized=!1;this.currentQualityLevel=null;this.qualityCapabilities=[{name:"holographic-effects",enabled:!0,qualityLevel:"medium"},{name:"scanline-overlay",enabled:!0,qualityLevel:"low"},{name:"chromatic-aberration",enabled:!0,qualityLevel:"low"},{name:"data-streams",enabled:!0,qualityLevel:"medium"},{name:"interference-patterns",enabled:!0,qualityLevel:"low"},{name:"organic-integration",enabled:!0,qualityLevel:"high"}];this.qualityAdjustments={};this.manager=t,this.settingsManager=e||new ee,this.musicSyncService=i||new ve,this.oklabProcessor=new M(!0),this.emotionalMapper=new J(!0),this.genreManager=new Be,this.holographicPreset=M.getPreset("COSMIC"),this.holographicState={flickerIntensity:.4,transparency:.8,chromatic:.3,scanlineIntensity:.6,dataStreamFlow:.5,interferenceLevel:.2,energyStability:.7,projectionDistance:.8},this.scanlineEffect={frequency:4,opacity:.1,animation:!0,speed:.5,organic:!1},this.chromaticAberration={offsetX:2,offsetY:1,redChannel:.5,greenChannel:0,blueChannel:-.5,intensity:.3},this.dataStream={characters:["0","1","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],speed:.5,density:.3,organic:!1,consciousness:!0,musicalSync:!0},this.interferencePattern={frequency:.1,amplitude:.05,phase:0,organic:!1,type:"wave"}}async initialize(){if(!this.initialized)try{let t=globalThis.year3000System;this.cssController=t?.cssConsciousnessController||T(),await this.createInterfaceContainer(),await this.initializeHolographicElements(),this.setupOKLABEventSubscriptions(),this.setupUserInteractionTracking(),this.startHolographicAnimation(),this.initialized=!0,this.isInitialized=!0,u?.debug?.log("HolographicUISystem","Initialized holographic interface system with OKLAB integration")}catch(t){throw u?.debug?.error("HolographicUISystem","Failed to initialize:",t),t}}async updateFromMusic(t,e,i){if(!this.isInitialized||!this.isEnabled)return;let n=performance.now();try{this.updateHolographicState(t,e),this.updateHolographicEffects(t,e,i),await this.updateElementAppearances();let r=performance.now()-n;this.updatePerformanceMetrics(r)}catch(r){console.error("[HolographicUISystem] Error updating from music:",r)}}updateHolographicState(t,e){let i=.2+t.intensity*.5+e.strength*.3;this.holographicState.flickerIntensity=this.smoothTransition(this.holographicState.flickerIntensity,i,.1);let n=.6+t.valence*.4;this.holographicState.transparency=this.smoothTransition(this.holographicState.transparency,n,.05);let r=.1+(t.arousal||.5)*.4;this.holographicState.chromatic=this.smoothTransition(this.holographicState.chromatic,r,.08);let a=.3+t.intensity*.5;this.holographicState.scanlineIntensity=this.smoothTransition(this.holographicState.scanlineIntensity,a,.06);let s=this.manager.getConsciousnessState(),o=.3+s.symbioticResonance*.7;this.holographicState.dataStreamFlow=this.smoothTransition(this.holographicState.dataStreamFlow,o,.04);let l=.1+s.membraneFluidityIndex*.3;this.holographicState.interferenceLevel=this.smoothTransition(this.holographicState.interferenceLevel,l,.03);let m=1-t.intensity*.4;this.holographicState.energyStability=this.smoothTransition(this.holographicState.energyStability,m,.02)}updateHolographicEffects(t,e,i){this.scanlineEffect.frequency=2+this.holographicState.scanlineIntensity*6,this.scanlineEffect.opacity=this.holographicState.scanlineIntensity*.15,this.scanlineEffect.speed=.3+this.holographicState.dataStreamFlow*.7,this.scanlineEffect.organic=this.holographicState.energyStability>.7,this.chromaticAberration.intensity=this.holographicState.chromatic,this.chromaticAberration.offsetX=this.holographicState.chromatic*3,this.chromaticAberration.offsetY=this.holographicState.chromatic*2,this.dataStream.speed=.2+this.holographicState.dataStreamFlow*.8,this.dataStream.density=.2+this.holographicState.dataStreamFlow*.6,this.dataStream.organic=this.holographicState.energyStability>.6,this.interferencePattern.frequency=.05+this.holographicState.interferenceLevel*.15,this.interferencePattern.amplitude=this.holographicState.interferenceLevel*.1,this.interferencePattern.organic=this.holographicState.energyStability>.5,t.type==="ambient"?this.interferencePattern.type="organic":t.intensity>.7?this.interferencePattern.type="noise":this.interferencePattern.type="wave"}async updateElementAppearances(){let t=[];for(let[e,i]of this.holographicElements)i.isActive&&t.push(this.updateElementAppearance(i));await Promise.allSettled(t)}async updateElementAppearance(t){let{element:e,holographicType:i,intensity:n,consciousnessLevel:r,organicIntegration:a}=t;try{switch(this.applyHolographicBase(e,n),i){case"translucent_panel":this.applyTranslucentPanel(e,n);break;case"data_stream":this.applyDataStream(e,n);break;case"energy_barrier":this.applyEnergyBarrier(e,n);break;case"consciousness_interface":this.applyConsciousnessInterface(e,n,r);break;case"organic_hologram":this.applyOrganicHologram(e,n,a);break;case"musical_visualization":this.applyMusicalVisualization(e,n);break;case"scanline_overlay":this.applyScanlineOverlay(e,n);break;case"chromatic_ghost":this.applyChromaticGhost(e,n);break}r>.5&&this.applyConsciousnessModifiers(e,r),a&&this.applyOrganicModifiers(e,n),t.lastUpdate=performance.now()}catch(s){console.warn(`[HolographicUISystem] Failed to update element ${t.id}:`,s)}}applyHolographicBase(t,e){let i=this.holographicState.transparency*e,n=this.holographicState.flickerIntensity*e,r=this.holographicState.chromatic*e;if(t.style.opacity=i.toString(),n>.3){let s=Math.sin(this.animationState.flickerPhase*10)*n*.3;t.style.opacity=Math.max(.1,i+s).toString()}if(r>.2){let s=r*2;t.style.filter=`
        drop-shadow(${s}px 0 0 rgba(255, 0, 0, 0.5))
        drop-shadow(-${s}px 0 0 rgba(0, 255, 255, 0.5))
      `}let a=e*.3;t.style.boxShadow=`
      0 0 ${a*20}px rgba(var(--spice-rgb-holographic-glow, var(--organic-holographic-rgb, 100, 255, 200)), ${a}),
      inset 0 0 ${a*10}px rgba(var(--spice-rgb-holographic-accent, var(--organic-holographic-rgb, 100, 255, 200)), ${a*.5})
    `}applyTranslucentPanel(t,e){let i=this.holographicState.transparency*e;t.style.background=`
      rgba(var(--spice-rgb-holographic-primary, var(--organic-holographic-rgb, 100, 255, 200)), ${i*.1}),
      linear-gradient(45deg,
        transparent 0%,
        rgba(var(--spice-rgb-holographic-accent, var(--organic-holographic-rgb, 100, 255, 200)), ${i*.05}) 50%,
        transparent 100%)
    `,t.style.backdropFilter=`blur(${Math.min(e*2,3)}px)`,t.style.border=`1px solid rgba(var(--spice-rgb-holographic-glow, var(--organic-holographic-rgb, 100, 255, 200)), ${i*.6})`}applyDataStream(t,e){let i=this.dataStream.speed*e,n=this.dataStream.density*e,r=this.generateDataStreamGradient(i,n);if(t.style.background=r,t.style.backgroundSize="100% 20px",t.style.animation=`dataStream ${2/i}s linear infinite`,!document.getElementById("dataStreamAnimation")){let a=document.createElement("style");a.id="dataStreamAnimation",a.textContent=`
        @keyframes dataStream {
          0% { background-position: 0 0; }
          100% { background-position: 0 20px; }
        }
      `,document.head.appendChild(a)}}applyEnergyBarrier(t,e){let i=this.holographicState.energyStability,n=this.holographicState.interferenceLevel*e,r=(1-i)*e;if(t.style.background=`
      linear-gradient(90deg,
        rgba(var(--organic-neon-glow-rgb, 0, 255, 255), ${r*.3}) 0%,
        rgba(var(--organic-neon-glow-rgb, 0, 255, 255), ${r*.1}) 50%,
        rgba(var(--organic-neon-glow-rgb, 0, 255, 255), ${r*.3}) 100%)
    `,t.style.backgroundSize="200% 100%",t.style.animation=`energyBarrier ${1/r}s ease-in-out infinite`,!document.getElementById("energyBarrierAnimation")){let a=document.createElement("style");a.id="energyBarrierAnimation",a.textContent=`
        @keyframes energyBarrier {
          0% { background-position: 0% 0%; }
          50% { background-position: 100% 0%; }
          100% { background-position: 0% 0%; }
        }
      `,document.head.appendChild(a)}}applyConsciousnessInterface(t,e,i){let r=this.manager.getConsciousnessState().symbioticResonance*i,a=r*e*.5;t.style.boxShadow=`
      0 0 ${a*30}px rgba(var(--organic-accent-rgb, 203, 166, 247), ${a}),
      inset 0 0 ${a*15}px rgba(var(--organic-accent-rgb, 203, 166, 247), ${a*.3})
    `;let s=.7+r*.3;if(t.style.opacity=s.toString(),r>.6){let o=this.animationState.organicPhase*2,l=1+Math.sin(o)*r*.2;t.style.transform=`scale(${l})`}}applyOrganicHologram(t,e,i){if(!i)return;let n=this.animationState.organicPhase,r=this.holographicState.energyStability*e,a=Math.sin(n*1.5)*r*2,s=Math.cos(n*2)*r*1.5;t.style.transform=`translate(${a}px, ${s}px)`;let o=n*.5,l=Math.sin(o)*r*30;t.style.filter=`hue-rotate(${l}deg)`;let m=n*.8,d=1+Math.sin(m)*r*.05;t.style.transform+=` scale(${d})`}applyMusicalVisualization(t,e){let n=this.manager.getConsciousnessState().symbioticResonance*e,r=this.animationState.dataStreamPhase*3,a=n*.8,s=Math.sin(r)*a*20;t.style.background=`
      linear-gradient(0deg,
        rgba(var(--organic-primary-rgb, 205, 214, 244), ${a*.8}) 0%,
        rgba(var(--organic-primary-rgb, 205, 214, 244), ${a*.4}) ${50+s}%,
        transparent ${50+s}%)
    `;let o=1+Math.sin(r*2)*n*.1;t.style.transform=`scaleY(${o})`}applyScanlineOverlay(t,e){let i=this.holographicState.scanlineIntensity*e,n=this.scanlineEffect.frequency;if(t.style.background=`
      repeating-linear-gradient(
        0deg,
        transparent 0px,
        transparent ${n-1}px,
        rgba(var(--spice-rgb-holographic-accent, var(--organic-holographic-rgb, 100, 255, 200)), ${i*.1}) ${n}px,
        rgba(var(--spice-rgb-holographic-accent, var(--organic-holographic-rgb, 100, 255, 200)), ${i*.1}) ${n}px
      )
    `,this.scanlineEffect.animation&&(t.style.animation=`scanlines ${1/this.scanlineEffect.speed}s linear infinite`),!document.getElementById("scanlineAnimation")){let r=document.createElement("style");r.id="scanlineAnimation",r.textContent=`
        @keyframes scanlines {
          0% { background-position: 0 0; }
          100% { background-position: 0 ${n}px; }
        }
      `,document.head.appendChild(r)}}applyChromaticGhost(t,e){let i=this.holographicState.chromatic*e,n=i*3,r=i*1.5,a=i*2;t.style.filter=`
      drop-shadow(${n}px 0 0 rgba(255, 0, 0, 0.4))
      drop-shadow(-${r}px 0 0 rgba(0, 255, 0, 0.4))
      drop-shadow(0 ${a}px 0 rgba(0, 0, 255, 0.4))
    `;let s=this.animationState.chromaticPhase,o=Math.sin(s*5)*i;t.style.transform=`translate(${o}px, 0)`}applyConsciousnessModifiers(t,e){let n=this.manager.getConsciousnessState().symbioticResonance*e,r=1+n*.3;t.style.filter=(t.style.filter||"")+` brightness(${r})`;let a=1+n*.5;t.style.filter=(t.style.filter||"")+` saturate(${a})`}applyOrganicModifiers(t,e){let i=this.animationState.organicPhase,n=this.holographicState.energyStability*e,r=i*1.2,a=Math.sin(r)*n*2,s=t.style.filter||"";!s.includes("blur(")&&a>0&&(t.style.filter=s+` blur(${Math.max(0,a)}px)`);let l=i*.7,m=1+Math.sin(l)*n*.2,d=parseFloat(t.style.opacity)||1;t.style.opacity=Math.max(.1,Math.min(1,d*m)).toString()}generateDataStreamGradient(t,e){let i=this.dataStream.characters,n=Math.floor(e*20),r="linear-gradient(90deg, ";for(let a=0;a<n;a++){let s=a/n*100,o=i[Math.floor(Math.random()*i.length)],l=.1+Math.random()*.3,m=this.getOKLABEnhancedDataStreamColor(l,this.lastMusicalContext);r+=`${m} ${s}%, `}return r=r.slice(0,-2)+")",r}async createInterfaceContainer(){this.interfaceContainer=document.createElement("div"),this.interfaceContainer.id="holographic-interface-container",this.interfaceContainer.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
      mix-blend-mode: normal;
    `,document.body.appendChild(this.interfaceContainer)}async initializeHolographicElements(){let t=[{selector:".main-view-container",type:"translucent_panel"},{selector:".Root__nav-bar",type:"data_stream"},{selector:".Root__now-playing-bar",type:"consciousness_interface"},{selector:".main-view-container__scroll-node",type:"organic_hologram"},{selector:".root-now-playing-view",type:"energy_barrier"},{selector:".main-view-container__scroll-node-child",type:"scanline_overlay"}];for(let e of t){let i=document.querySelectorAll(e.selector);for(let n of i){let r={id:`holographic-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,element:n,originalStyles:getComputedStyle(n),holographicType:e.type,intensity:.7,isActive:!0,lastUpdate:0,animation:null,consciousnessLevel:.8,organicIntegration:!0};this.holographicElements.set(r.id,r)}}}updateHolographicAnimation(t){if(!this.isInitialized||!this.isEnabled)return;let e=t/1e3;this.animationState.flickerPhase+=e*2,this.animationState.scanlinePhase+=e*this.scanlineEffect.speed,this.animationState.chromaticPhase+=e*1.5,this.animationState.dataStreamPhase+=e*this.dataStream.speed,this.animationState.interferencePhase+=e*this.interferencePattern.frequency,this.animationState.organicPhase+=e*.5,this.performanceMetrics.lastUpdate=performance.now()}startHolographicAnimation(){this.animationState.isAnimating=!0,this.animationState.lastFrameTime=performance.now();let t=e=>{if(!this.animationState.isAnimating)return;let i=e-this.animationState.lastFrameTime;this.animationState.lastFrameTime=e,this.updateHolographicAnimation(i),requestAnimationFrame(t)};requestAnimationFrame(t)}smoothTransition(t,e,i){return t+(e-t)*i}updatePerformanceMetrics(t){this.performanceMetrics.averageProcessingTime=this.performanceMetrics.averageProcessingTime*.9+t*.1,this.performanceMetrics.elementsProcessed=this.holographicElements.size,this.performanceMetrics.memoryUsage=this.holographicElements.size*256}getHolographicState(){return{...this.holographicState}}getPerformanceMetrics(){return{...this.performanceMetrics}}getElementCount(){return this.holographicElements.size}setEnabled(t){if(this.isEnabled=t,!t)for(let[e,i]of this.holographicElements)i.element.style.opacity="1",i.element.style.filter="",i.element.style.background="",i.element.style.boxShadow="",i.element.style.transform=""}setHolographicPreset(t){let e=this.holographicPresets[t];e&&(this.holographicState={...e})}setFlickerIntensity(t){this.holographicState.flickerIntensity=Math.max(0,Math.min(1,t))}enableVolumetricDepth(t=.8){let e=800+t*1200;this.interfaceContainer&&(this.interfaceContainer.style.perspective=`${e}px`,this.interfaceContainer.style.transformStyle="preserve-3d");for(let[i,n]of this.holographicElements)this.applyVolumetricLayers(n.element,t,n.intensity);console.log(`[HolographicUISystem] \u{1F30A} Volumetric depth enabled: ${e}px perspective`)}updateVolumetricLayers(t,e){let i=t*.8,n=(e-4e3)/4e3;for(let[r,a]of this.holographicElements)this.applyVolumetricLayers(a.element,i,a.intensity,n)}applyVolumetricLayers(t,e,i,n=.5){let r=e*100,a=n*50,s=r+a,o=t.style.transform||"",l=`translateZ(${s}px)`;o.includes("translateZ")?t.style.transform=o.replace(/translateZ\([^)]*\)/,l):t.style.transform=`${o} ${l}`.trim();let m=Math.abs(s)/100*i,d=m*30,h=s>0?m*5:-m*3,p=t.style.boxShadow||"",b=`0 ${h}px ${d}px rgba(var(--spice-rgb-holographic-glow, var(--organic-holographic-rgb, 100, 255, 200)), ${m*.3})`;p?t.style.boxShadow=`${p}, ${b}`:t.style.boxShadow=b,this.applyVolumetricAtmosphere(t,e,i)}applyVolumetricAtmosphere(t,e,i){let n=e*i,r=Math.max(0,(e-.5)*4),a=1+(e-.5)*.3,s=t.style.filter||"",o=s.includes("blur("),l=[r>0&&!o?`blur(${r}px)`:"",`brightness(${a})`,`saturate(${1+n*.2})`].filter(b=>b).join(" "),m=s.includes("brightness"),d=s.includes("saturate");s&&!m&&!d?t.style.filter=`${s} ${l}`:s||(t.style.filter=l);let h=parseFloat(t.style.opacity||"1"),p=Math.max(.3,h-(1-e)*.3);t.style.opacity=p.toString()}updateConsciousnessScanlines(t,e,i){let n=Math.max(.2,t*1.5),r=this.mapTemperatureToFrequency(e),a=Math.sin(performance.now()*.005*i)*.3+.7,s={"--consciousness-scanline-density":n.toString(),"--consciousness-scanline-frequency":`${r}px`,"--consciousness-scanline-opacity":(t*.15).toString(),"--musical-scanline-pulse":a.toString(),"--temperature-scanline-color-shift":`${(e-5e3)/3e3*30}deg`};this.cssController.batchSetVariables("HolographicUISystem",s,"high","consciousness-scanline-update")}updateAberrationEffects(t,e,i,n=!1){let r=document.documentElement,a=Math.min(1,t*1.2),s=Math.min(1,i*1.5),o=2+s*3,m=(Math.max(3e3,Math.min(8e3,e))-5500)/2500,d=1.5+m*2,h=-1.5-m*2,p=m*.5,b=Math.sin(performance.now()*.003*i)*.4+.6,v=n?1.5:1,C=1e3+t*2e3+i*1e3,P={"--aberration-intensity":(a*v).toString(),"--aberration-color-separation":`${o}px`,"--aberration-musical-sync":s.toString(),"--aberration-emotional-temperature":`${e}K`,"--aberration-consciousness-level":t.toString(),"--aberration-red-shift":`${d}px`,"--aberration-green-shift":`${p}px`,"--aberration-blue-shift":`${h}px`,"--aberration-wave-frequency":`${C}ms`,"--aberration-pulse-intensity":(b*v).toString()};this.cssController.batchSetVariables("HolographicUISystem",P,"high","aberration-effects-update");let E=parseFloat(r.style.getPropertyValue("--reading-mode-active")||"0"),L=Math.min(.8,E*.6);this.cssController.setVariable("HolographicUISystem","--aberration-reading-mode-reduction",L.toString(),"critical","aberration-reading-mode-update")}mapTemperatureToFrequency(t){return 2+(Math.max(3e3,Math.min(8e3,t))-3e3)/5e3*10}updateScanlineCSSVariables(t,e,i){let n={"--consciousness-scanline-density":t.toString(),"--consciousness-scanline-frequency":`${this.scanlineEffect.frequency}px`,"--consciousness-scanline-opacity":this.scanlineEffect.opacity.toString(),"--consciousness-scanline-speed":`${this.scanlineEffect.speed}s`,"--temperature-scanline-color-shift":`${(e-5e3)/2e3*30}deg`,"--musical-scanline-pulse":i.toString()};this.cssController.batchSetVariables("HolographicUISystem",n,"high","scanline-consciousness-update");let r={"--consciousness-scanline-interference":t>.7?"visible":"none","--consciousness-scanline-complexity":t>.7?Math.min(1,(t-.7)*3.33).toString():"0"};this.cssController.batchSetVariables("HolographicUISystem",r,"high","scanline-complexity-update")}detectReadingMode(){let t=document.documentElement,e=(window.getSelection()?.toString()||"").length>0,i=this.isUserCurrentlyScrolling(),n=this.isHoveringTextContent(),r=0;e&&(r+=.6),i&&(r+=.3),n&&(r+=.4),r=Math.min(1,r),this.cssController.setVariable("HolographicUISystem","--reading-mode-active",r.toString(),"critical","reading-mode-detection-update")}trackUserInteraction(){let t=document.documentElement,e=this.isMouseCurrentlyMoving(),i=this.wasRecentUIClick(),n=this.isFocusedOnInputElement(),r=0;e&&(r+=.4),i&&(r+=.5),n&&(r+=.6),r=Math.min(1,r),this.cssController.setVariable("HolographicUISystem","--user-interaction-detected",r.toString(),"high","user-interaction-update")}isUserCurrentlyScrolling(){let t=document.querySelector(".main-view-container__scroll-node");if(!t)return!1;let e=t.scrollTop,i=this.lastScrollPosition||0;return this.lastScrollPosition=e,Math.abs(e-i)>5}isHoveringTextContent(){let t=document.querySelector(":hover");return t?(t.textContent?.trim()||"").length>20:!1}isMouseCurrentlyMoving(){let t=performance.now(),e=this.lastMouseMovement||0;return t-e<2e3}wasRecentUIClick(){let t=performance.now(),e=this.lastUIClick||0;return t-e<1e3}isFocusedOnInputElement(){let t=document.activeElement;return t?["input","textarea","select"].includes(t.tagName.toLowerCase())||t.getAttribute("contenteditable")==="true":!1}setTransparency(t){this.holographicState.transparency=Math.max(0,Math.min(1,t))}setChromaticAberration(t){this.holographicState.chromatic=Math.max(0,Math.min(1,t))}destroy(){console.log("[HolographicUISystem] Destroying holographic UI system..."),this.animationState.isAnimating=!1;for(let[e,i]of this.holographicElements)i.element.style.opacity="1",i.element.style.filter="",i.element.style.background="",i.element.style.boxShadow="",i.element.style.transform="",i.animation&&i.animation.cancel();this.holographicElements.clear(),this.interfaceContainer&&this.interfaceContainer.parentNode&&this.interfaceContainer.parentNode.removeChild(this.interfaceContainer),["dataStreamAnimation","energyBarrierAnimation","scanlineAnimation"].forEach(e=>{let i=document.getElementById(e);i&&i.remove()}),this.isInitialized=!1,this.initialized=!1,this.eventSubscriptionIds.forEach(e=>{g.unsubscribe(e)}),this.eventSubscriptionIds=[]}setQualityLevel(t){switch(this.currentQualityLevel=t,t){case"low":this.holographicState.flickerIntensity=.1,this.holographicState.transparency=.9,this.holographicState.chromatic=.1,this.holographicState.scanlineIntensity=.2,this.holographicState.dataStreamFlow=.2,this.holographicState.interferenceLevel=0,this.scanlineEffect.animation=!1;break;case"low":this.holographicState.flickerIntensity=.2,this.holographicState.transparency=.85,this.holographicState.chromatic=.2,this.holographicState.scanlineIntensity=.3,this.holographicState.dataStreamFlow=.3,this.holographicState.interferenceLevel=.1,this.scanlineEffect.animation=!0,this.scanlineEffect.speed=.3;break;case"medium":this.holographicState.flickerIntensity=.4,this.holographicState.transparency=.8,this.holographicState.chromatic=.3,this.holographicState.scanlineIntensity=.6,this.holographicState.dataStreamFlow=.5,this.holographicState.interferenceLevel=.2,this.scanlineEffect.animation=!0,this.scanlineEffect.speed=.5;break;case"high":this.holographicState.flickerIntensity=.6,this.holographicState.transparency=.7,this.holographicState.chromatic=.5,this.holographicState.scanlineIntensity=.8,this.holographicState.dataStreamFlow=.8,this.holographicState.interferenceLevel=.4,this.scanlineEffect.animation=!0,this.scanlineEffect.speed=.8;break;case"high":this.holographicState.flickerIntensity=.8,this.holographicState.transparency=.6,this.holographicState.chromatic=.7,this.holographicState.scanlineIntensity=1,this.holographicState.dataStreamFlow=1,this.holographicState.interferenceLevel=.6,this.scanlineEffect.animation=!0,this.scanlineEffect.speed=1;break}this.updateQualityCapabilities(t)}getPerformanceImpact(){let t=this.holographicElements.size;return{fps:60,frameTime:this.calculateProcessingTime(),memoryUsage:this.estimateMemoryUsage(),cpuUsage:this.estimateCPUUsage(t)}}reduceQuality(t){this.qualityAdjustments["flicker-reduction"]=(this.qualityAdjustments["flicker-reduction"]||0)+t,this.qualityAdjustments["effect-reduction"]=(this.qualityAdjustments["effect-reduction"]||0)+t*.8,this.holographicState.flickerIntensity=Math.max(.1,this.holographicState.flickerIntensity*(1-t*.8)),this.holographicState.chromatic=Math.max(0,this.holographicState.chromatic*(1-t)),this.holographicState.scanlineIntensity=Math.max(.1,this.holographicState.scanlineIntensity*(1-t*.6)),this.holographicState.dataStreamFlow=Math.max(.1,this.holographicState.dataStreamFlow*(1-t*.4)),this.holographicState.interferenceLevel=Math.max(0,this.holographicState.interferenceLevel*(1-t)),t>.5&&(this.scanlineEffect.animation=!1)}increaseQuality(t){if(Object.keys(this.qualityAdjustments).forEach(e=>{this.qualityAdjustments[e]=Math.max(0,(this.qualityAdjustments[e]||0)-t)}),this.currentQualityLevel){let e=this.getPresetForLevel(this.currentQualityLevel);this.holographicState.flickerIntensity=Math.min(e.flickerIntensity,this.holographicState.flickerIntensity*(1+t*.3)),this.holographicState.chromatic=Math.min(e.chromatic,this.holographicState.chromatic*(1+t*.4)),this.holographicState.scanlineIntensity=Math.min(e.scanlineIntensity,this.holographicState.scanlineIntensity*(1+t*.2)),this.holographicState.dataStreamFlow=Math.min(e.dataStreamFlow,this.holographicState.dataStreamFlow*(1+t*.2)),t>.3&&(this.scanlineEffect.animation=!0)}}getQualityCapabilities(){return[...this.qualityCapabilities]}updateQualityCapabilities(t){this.qualityCapabilities.forEach(e=>{switch(e.name){case"holographic-effects":e.enabled=this.holographicState.flickerIntensity>.2;break;case"scanline-overlay":e.enabled=this.holographicState.scanlineIntensity>.3;break;case"chromatic-aberration":e.enabled=this.holographicState.chromatic>.2;break;case"data-streams":e.enabled=this.holographicState.dataStreamFlow>.3;break;case"interference-patterns":e.enabled=this.holographicState.interferenceLevel>.1;break;case"organic-integration":e.enabled=t!=="low";break}})}getPresetForLevel(t){switch(t){case"low":return this.holographicPresets["organic-consciousness"];case"medium":return this.holographicPresets["star-wars"];case"high":return this.holographicPresets["blade-runner"];default:return this.holographicPresets["star-wars"]}}calculateProcessingTime(){let t=this.holographicElements.size,e=(this.holographicState.flickerIntensity+this.holographicState.chromatic+this.holographicState.scanlineIntensity)/3;return Math.max(2,t*e*.5)}estimateMemoryUsage(){return .3*this.holographicElements.size+0}estimateCPUUsage(t){let i=(this.holographicState.flickerIntensity+this.holographicState.chromatic+this.holographicState.scanlineIntensity)/3,n=this.scanlineEffect.animation?1.5:1;return Math.min(30,2*t*i*n)}hexToRgb(t){try{let e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e&&e[1]&&e[2]&&e[3]?`${parseInt(e[1],16)}, ${parseInt(e[2],16)}, ${parseInt(e[3],16)}`:"100, 255, 200"}catch(e){return u?.debug?.warn("HolographicUISystem","Failed to convert hex to RGB:",e),"100, 255, 200"}}setupOKLABEventSubscriptions(){try{let t=g.subscribe("colors:oklab-enhanced",this.handleOKLABColorEvent.bind(this),"HolographicUISystem");this.eventSubscriptionIds.push(t);let e=g.subscribe("colors:musical-oklab-coordinated",this.handleMusicalOKLABEvent.bind(this),"HolographicUISystem");this.eventSubscriptionIds.push(e);let i=g.subscribe("colors:emotional-temperature-mapped",this.handleEmotionalTemperatureEvent.bind(this),"HolographicUISystem");this.eventSubscriptionIds.push(i);let n=g.subscribe("audio:genre-detected",this.handleGenreDetectionEvent.bind(this),"HolographicUISystem");this.eventSubscriptionIds.push(n),u?.debug?.log("HolographicUISystem","OKLAB event subscriptions established",{subscriptionCount:this.eventSubscriptionIds.length})}catch(t){u?.debug?.error("HolographicUISystem","Failed to setup OKLAB event subscriptions:",t)}}setupUserInteractionTracking(){try{document.addEventListener("mousemove",()=>{this.lastMouseMovement=performance.now()},{passive:!0}),document.addEventListener("click",()=>{this.lastUIClick=performance.now()},{passive:!0}),setInterval(()=>{this.detectReadingMode(),this.trackUserInteraction()},500),u?.debug?.log("HolographicUISystem","User interaction tracking initialized")}catch(t){u?.debug?.error("HolographicUISystem","Failed to setup user interaction tracking:",t)}}async handleOKLABColorEvent(t){try{let{enhancedColors:e,oklabPreset:i,rawColors:n,trackUri:r}=t;i&&(this.holographicPreset=i),e&&await this.updateHolographicColorsFromOKLAB(e),u?.debug?.log("HolographicUISystem","Updated holographic colors from OKLAB event",{preset:i?.name,trackUri:r,colorCount:Object.keys(e||{}).length})}catch(e){u?.debug?.error("HolographicUISystem","Failed to handle OKLAB color event:",e)}}async handleMusicalOKLABEvent(t){try{let{coordinatedColors:e,detectedGenre:i,emotionalResult:n,oklabPreset:r,musicInfluenceStrength:a,coordinationStrategy:s}=t;if(this.lastMusicalContext={genre:i,emotion:n?.primaryEmotion,preset:r,influence:a,strategy:s,timestamp:Date.now()},r&&(this.holographicPreset=r),e&&await this.updateHolographicColorsFromMusicalOKLAB(e,this.lastMusicalContext),n&&a!==void 0){let o=this.holographicState.flickerIntensity||.5,l=n.emotionalTemperature||6e3,m=a,d=n.beatDetected||!1;this.updateAberrationEffects(o,l,m,d)}u?.debug?.log("HolographicUISystem","Updated holographic effects from musical OKLAB coordination",{genre:i,emotion:n?.primaryEmotion,preset:r?.name,influence:a})}catch(e){u?.debug?.error("HolographicUISystem","Failed to handle musical OKLAB event:",e)}}async handleEmotionalTemperatureEvent(t){try{let{emotionalTemperature:e,primaryEmotion:i,perceptualColorHex:n,oklabPreset:r,cssVariables:a}=t;await this.updateHolographicEmotionalTemperature(e,i),n&&await this.updateHolographicColorFromEmotionalOKLAB(n,e);let s=this.holographicState.flickerIntensity||.5,o=this.lastMusicalContext?.influence||.5;this.updateAberrationEffects(s,e,o,!1),u?.debug?.log("HolographicUISystem","Updated holographic emotional temperature",{temperature:e,emotion:i,color:n})}catch(e){u?.debug?.error("HolographicUISystem","Failed to handle emotional temperature event:",e)}}async handleGenreDetectionEvent(t){try{let{detectedGenre:e,confidence:i,audioFeatures:n}=t,r=this.genreManager.getOKLABPresetForGenre(e);r&&(this.holographicPreset=r,await this.adjustHolographicEffectsForGenre(e,n)),u?.debug?.log("HolographicUISystem","Adjusted holographic effects for detected genre",{genre:e,confidence:i,preset:r?.name})}catch(e){u?.debug?.error("HolographicUISystem","Failed to handle genre detection event:",e)}}async updateHolographicColorsFromOKLAB(t){try{let e={};if(Object.entries(t).forEach(([i,n])=>{if(n&&typeof n=="string"){let r=this.oklabProcessor.processColor(n,this.holographicPreset);if(r.enhancedHex&&(e[`--holographic-${i.toLowerCase()}`]=r.enhancedHex,e[`--holographic-${i.toLowerCase()}-rgb`]=this.hexToRgb(r.enhancedHex),r.oklabEnhanced)){let{L:a,a:s,b:o}=r.oklabEnhanced;e[`--holographic-${i.toLowerCase()}-oklab`]=`${a.toFixed(3)} ${s.toFixed(3)} ${o.toFixed(3)}`}}}),t.VIBRANT||t.PRIMARY){let i=t.VIBRANT||t.PRIMARY;if(i){let n=this.oklabProcessor.processColor(i,this.holographicPreset);n.enhancedHex&&(e["--organic-holographic-rgb"]=this.hexToRgb(n.enhancedHex),e["--sn-holographic-primary"]=n.enhancedHex)}}Object.keys(e).length>0&&this.cssController.batchSetVariables("HolographicUISystem",e,"critical","oklab-holographic-colors-update")}catch(e){u?.debug?.error("HolographicUISystem","Failed to update holographic colors from OKLAB:",e)}}async updateHolographicColorsFromMusicalOKLAB(t,e){try{await this.updateHolographicColorsFromOKLAB(t),e.influence&&this.adjustHolographicIntensityFromMusicalInfluence(e.influence),e.genre&&await this.applyGenreSpecificHolographicEffects(e.genre,e.emotion)}catch(i){u?.debug?.error("HolographicUISystem","Failed to update holographic colors from musical OKLAB:",i)}}async updateHolographicColorFromEmotionalOKLAB(t,e){try{let i=document.documentElement,n=this.oklabProcessor.processColor(t,this.holographicPreset);if(n.enhancedHex){let r={"--holographic-emotional-primary":n.enhancedHex,"--holographic-emotional-rgb":this.hexToRgb(n.enhancedHex),"--holographic-emotional-temperature":`${e}K`};this.cssController.batchSetVariables("HolographicUISystem",r,"critical","emotional-oklab-holographic-update"),await this.updateHolographicEmotionalTemperature(e,null)}}catch(i){u?.debug?.error("HolographicUISystem","Failed to update holographic color from emotional OKLAB:",i)}}async updateHolographicEmotionalTemperature(t,e){try{let n=(Math.max(3e3,Math.min(8e3,t))-3e3)/5e3;this.holographicState.flickerIntensity=.2+n*.4,this.holographicState.chromatic=.1+n*.3,this.holographicState.energyStability=1-n*.3,n<.4?(this.holographicState.transparency=.9+n*.1,this.holographicState.dataStreamFlow=.3+n*.2):(this.holographicState.transparency=.8-(n-.4)*.2,this.holographicState.interferenceLevel=.1+(n-.4)*.3),u?.debug?.log("HolographicUISystem","Updated holographic effects from emotional temperature",{temperature:t,tempRatio:n,flicker:this.holographicState.flickerIntensity,chromatic:this.holographicState.chromatic})}catch(i){u?.debug?.error("HolographicUISystem","Failed to update holographic emotional temperature:",i)}}async adjustHolographicEffectsForGenre(t,e){try{switch(t.toLowerCase()){case"electronic":case"techno":case"edm":this.holographicState.dataStreamFlow=.8,this.holographicState.scanlineIntensity=.7,this.holographicState.interferenceLevel=.4,this.scanlineEffect.speed=.8;break;case"classical":case"orchestral":this.holographicState.transparency=.9,this.holographicState.energyStability=.8,this.holographicState.flickerIntensity=.2,this.scanlineEffect.organic=!0;break;case"rock":case"metal":this.holographicState.flickerIntensity=.6,this.holographicState.chromatic=.5,this.holographicState.interferenceLevel=.5,this.scanlineEffect.animation=!0;break;case"ambient":case"atmospheric":this.holographicState.transparency=.95,this.holographicState.dataStreamFlow=.3,this.holographicState.energyStability=.9,this.scanlineEffect.organic=!0,this.scanlineEffect.speed=.2;break;case"jazz":case"blues":this.holographicState.flickerIntensity=.4,this.holographicState.energyStability=.6,this.interferencePattern.type="organic",this.scanlineEffect.organic=!0;break;default:this.holographicState.flickerIntensity=.4,this.holographicState.transparency=.8,this.holographicState.chromatic=.3;break}u?.debug?.log("HolographicUISystem","Adjusted holographic effects for genre",{genre:t,flicker:this.holographicState.flickerIntensity,transparency:this.holographicState.transparency,dataFlow:this.holographicState.dataStreamFlow})}catch(i){u?.debug?.error("HolographicUISystem","Failed to adjust holographic effects for genre:",i)}}adjustHolographicIntensityFromMusicalInfluence(t){try{let e=.5+t*.5;this.holographicState.flickerIntensity*=e,this.holographicState.chromatic*=e,this.holographicState.scanlineIntensity*=e,this.holographicState.dataStreamFlow*=e,this.holographicState.interferenceLevel*=e,u?.debug?.log("HolographicUISystem","Adjusted holographic intensity from musical influence",{influence:t,multiplier:e})}catch(e){u?.debug?.error("HolographicUISystem","Failed to adjust holographic intensity from musical influence:",e)}}async applyGenreSpecificHolographicEffects(t,e){try{let i=`${t.toLowerCase()}-${e||"neutral"}`;t==="electronic"&&e==="energetic"?(this.setHolographicPreset("blade-runner"),this.holographicState.dataStreamFlow=1,this.holographicState.interferenceLevel=.6):t==="classical"&&e==="calm"?(this.setHolographicPreset("organic-consciousness"),this.holographicState.transparency=.95,this.holographicState.energyStability=.9):t==="rock"&&e==="aggressive"&&(this.setHolographicPreset("star-wars"),this.holographicState.flickerIntensity=.8,this.holographicState.chromatic=.6),u?.debug?.log("HolographicUISystem","Applied genre-specific holographic effects",{genre:t,emotion:e,effectKey:i})}catch(i){u?.debug?.error("HolographicUISystem","Failed to apply genre-specific holographic effects:",i)}}updateAnimation(t){this.updateHolographicAnimation(t)}async healthCheck(){try{let t=this.estimateMemoryUsage(),e=this.estimateCPUUsage(this.holographicElements.size),i=this.holographicElements.size,n=this.initialized&&t<10&&e<25&&i<100;return{healthy:n,message:n?"Holographic UI system operating normally":"Holographic UI system performance degraded",details:{initialized:this.initialized,activeElements:i,memoryUsageMB:t,cpuUsagePercent:e,oklabIntegration:this.eventSubscriptionIds.length>0,lastUpdate:this.performanceMetrics.lastUpdate}}}catch(t){return{healthy:!1,message:`Holographic UI system health check failed: ${t}`,details:{error:t instanceof Error?t.message:String(t)}}}}getOKLABEnhancedGlowColor(t){try{let e=getComputedStyle(document.documentElement).getPropertyValue("--sn-holographic-primary")?.trim()||"#64ffcc",i=this.oklabProcessor.processColor(e,this.holographicPreset);return i.enhancedHex?`rgba(${this.hexToRgb(i.enhancedHex)}, ${t})`:`rgba(var(--spice-rgb-holographic-glow, var(--organic-holographic-rgb, 100, 255, 200)), ${t})`}catch(e){return u?.debug?.warn("HolographicUISystem","Failed to get OKLAB enhanced glow color:",e),`rgba(var(--spice-rgb-holographic-glow, var(--organic-holographic-rgb, 100, 255, 200)), ${t})`}}getOKLABEnhancedPanelColor(t){try{let e=getComputedStyle(document.documentElement).getPropertyValue("--sn-holographic-primary")?.trim()||"#64ffcc",i=this.oklabProcessor.processColor(e,this.holographicPreset);if(i.enhancedHex){let n=this.hexToRgb(i.enhancedHex);return{background:`rgba(${n}, ${t*.1})`,gradient:`rgba(${n}, ${t*.05})`,border:`rgba(${n}, ${t*.6})`}}return{background:`rgba(var(--spice-rgb-holographic-primary, var(--organic-holographic-rgb, 100, 255, 200)), ${t*.1})`,gradient:`rgba(var(--spice-rgb-holographic-accent, var(--organic-holographic-rgb, 100, 255, 200)), ${t*.05})`,border:`rgba(var(--spice-rgb-holographic-glow, var(--organic-holographic-rgb, 100, 255, 200)), ${t*.6})`}}catch(e){return u?.debug?.warn("HolographicUISystem","Failed to get OKLAB enhanced panel color:",e),{background:`rgba(var(--spice-rgb-holographic-primary, var(--organic-holographic-rgb, 100, 255, 200)), ${t*.1})`,gradient:`rgba(var(--spice-rgb-holographic-accent, var(--organic-holographic-rgb, 100, 255, 200)), ${t*.05})`,border:`rgba(var(--spice-rgb-holographic-glow, var(--organic-holographic-rgb, 100, 255, 200)), ${t*.6})`}}}getOKLABConsciousnessGlow(t,e){try{let i=getComputedStyle(document.documentElement).getPropertyValue("--sn-accent-hex")?.trim()||"#cba6f7",n={...this.holographicPreset,chromaBoost:this.holographicPreset.chromaBoost*(1+e*.5),lightnessBoost:this.holographicPreset.lightnessBoost*(1+e*.3)},r=this.oklabProcessor.processColor(i,n);if(r.enhancedHex){let a=this.hexToRgb(r.enhancedHex);return{outer:`rgba(${a}, ${t})`,inner:`rgba(${a}, ${t*.3})`}}return{outer:`rgba(var(--organic-accent-rgb, 203, 166, 247), ${t})`,inner:`rgba(var(--organic-accent-rgb, 203, 166, 247), ${t*.3})`}}catch(i){return u?.debug?.warn("HolographicUISystem","Failed to get OKLAB consciousness glow:",i),{outer:`rgba(var(--organic-accent-rgb, 203, 166, 247), ${t})`,inner:`rgba(var(--organic-accent-rgb, 203, 166, 247), ${t*.3})`}}}getOKLABEnhancedDataStreamColor(t,e){try{let i="#64ffcc";if(e?.emotion){let r=this.emotionalMapper.mapMusicToEmotionalTemperature({energy:.5,valence:.5,tempo:120,genre:e.genre||"default"});r.perceptualColorHex&&(i=r.perceptualColorHex)}let n=this.oklabProcessor.processColor(i,this.holographicPreset);return n.enhancedHex?`rgba(${this.hexToRgb(n.enhancedHex)}, ${t})`:`rgba(var(--spice-rgb-holographic-primary, var(--organic-holographic-rgb, 100, 255, 200)), ${t})`}catch(i){return u?.debug?.warn("HolographicUISystem","Failed to get OKLAB enhanced data stream color:",i),`rgba(var(--spice-rgb-holographic-primary, var(--organic-holographic-rgb, 100, 255, 200)), ${t})`}}adjustQuality(t){switch(t){case"low":this.holographicState.energyStability=.3,this.holographicState.scanlineIntensity=.2,this.holographicState.interferenceLevel=.1;break;case"medium":this.holographicState.energyStability=.6,this.holographicState.scanlineIntensity=.5,this.holographicState.interferenceLevel=.3;break;case"high":default:this.holographicState.energyStability=1,this.holographicState.scanlineIntensity=.8,this.holographicState.interferenceLevel=.6;break}}}});var Oi,Bs=y(()=>{"use strict";D();ge();N();Oi=class extends Q{constructor(e,i,n,r,a,s=null){super(e,i,n,r,a);this._scrollContainerElements=[];this._interactionHandler=null;this.year3000System=s,this.nexusState={currentNavigationScale:1,targetNavigationScale:1,userInfluence:0,lastEnergy:.5,lastValence:.5,lastVisualIntensity:.5,lastMoodIdentifier:"neutral"},this.biometricState={isMeditating:!1,lastUserInteractionTime:Date.now(),meditationGracePeriod:5e3,interactionCooldown:1e3,lastMeditationUpdateTime:null,desaturation:0,slowdown:1,targetDesaturation:0,targetSlowdown:1},this.lastHeavyUpdateTime=0,this.heavyUpdateInterval=1e3/10,this.lastBiometricCheckTime=0,this.biometricCheckInterval=1e3,this.lastInteractionRecordTime=0,this.interactionRecordInterval=200,this._animationRegistered=!1,this._performanceMode="auto",this._frameSkipCounter=0,this._maxFrameSkip=2,this.systemIntegrationMetrics={lastSystemsCheck:Date.now(),integrationHealth:"healthy",crossSystemErrors:0,meditationTransitions:0,navigationScaleUpdates:0};let o=this.utils.getHealthMonitor();o&&o.registerSystem("InteractionTrackingSystem",this),this.rootElement=this.utils.getRootStyle(),this.modalObserver=null,this._lastScrollTime=null,this._lastScrollTop=null}onAnimate(e){this.initialized&&this.updateAnimation(performance.now(),e)}async initialize(){await super.initialize();let e=globalThis.year3000System;this.cssController=e?.cssConsciousnessController||T(),this.initializeOptimizedQuantumSpace(),this.setupModalObserver(),this.setupOptimizedInteractionListener(),this._registerWithAnimationCoordinator()}_registerWithAnimationCoordinator(){this.year3000System&&this.year3000System.registerAnimationSystem?(this.year3000System.registerAnimationSystem("InteractionTrackingSystem",this,"normal",30),this._animationRegistered=!0):this._startFallbackAnimationLoops()}initializeOptimizedQuantumSpace(){if(!this.utils.getRootStyle())return;let i={"--sn-nav-item-transform-scale":"1.0","--sn-sidebar-meditation-desaturation":"0","--sn-sidebar-meditation-slowdown":"1"};this.cssController.batchSetVariables("InteractionTrackingSystem",i,"high","quantum-space-initialization")}recordUserInteraction(e){if(e.type==="scroll"){let r=e.target;if(r){let a=r.scrollTop,s=performance.now(),o=this._lastScrollTime?(a-(this._lastScrollTop??0))/(s-this._lastScrollTime):0,l=o<0?"up":"down";g.emit("user:scroll",{velocity:{x:0,y:o*1e3},direction:l,element:r.tagName||"unknown",timestamp:s}),this._lastScrollTop=a,this._lastScrollTime=s}}let n=performance.now();n-this.lastInteractionRecordTime<this.interactionRecordInterval||(this.lastInteractionRecordTime=n,this.nexusState.userInfluence+=.005,this.nexusState.userInfluence=Math.min(.5,this.nexusState.userInfluence),this.biometricState.lastUserInteractionTime=Date.now(),this.biometricState.isMeditating=!1)}setupModalObserver(){let e=document.querySelector(".main-modal-container");if(!e)return;let i=(n,r)=>{for(let a of n)if(a.type==="childList"){let s=e.children.length>0;this.nexusState.targetNavigationScale=s?.95:1}};this.modalObserver=new MutationObserver(i),this.modalObserver.observe(e,{childList:!0})}setupOptimizedInteractionListener(){this._interactionHandler=this.utils.throttle(a=>this.recordUserInteraction(a),100),["click","mousemove","keydown"].forEach(a=>{document.addEventListener(a,this._interactionHandler,{passive:!0})});let i=[".main-view-container__scroll-node",".main-view-container__scroll-node-child","section[data-testid='playlist-page']"],n=[];i.forEach(a=>{document.querySelectorAll(a).forEach(s=>{n.push(s)})}),(n.length?n:[document]).forEach(a=>{a.addEventListener("scroll",this._interactionHandler,{passive:!0})}),this._scrollContainerElements=n}updateFromMusicAnalysis(e,i,n){if(!this.initialized||!this.validateMusicData(e)){this.applySafeDefaults();return}this.updateNexusTargets(e)}updateNexusTargets(e){let{energy:i,valence:n,visualIntensity:r,moodIdentifier:a}=e;this.nexusState.lastEnergy=i,this.nexusState.lastValence=n,this.nexusState.lastVisualIntensity=r,this.nexusState.lastMoodIdentifier=a,this.nexusState.targetNavigationScale=this.calculateOptimizedNavigationScale(r,a)}updateDigitalMeditationState(e){let i=Date.now();if(i-this.lastBiometricCheckTime<this.biometricCheckInterval)return;this.lastBiometricCheckTime=i,i-this.biometricState.lastUserInteractionTime>this.biometricState.meditationGracePeriod&&e.energy<.3&&e.valence>.6?(this.biometricState.isMeditating=!0,this.biometricState.targetDesaturation=.6,this.biometricState.targetSlowdown=.5):(this.biometricState.isMeditating=!1,this.biometricState.targetDesaturation=0,this.biometricState.targetSlowdown=1)}updateAnimation(e,i){if(this.initialized&&(this._frameSkipCounter++,!(this._frameSkipCounter<this._maxFrameSkip)&&(this._frameSkipCounter=0,this.animateOptimizedNexusFrame(i),e-this.lastHeavyUpdateTime>this.heavyUpdateInterval))){let n=this.musicSyncService?.getLatestProcessedData();n&&this.updateDigitalMeditationState(n),this.updateIntegrationMetrics(),this.lastHeavyUpdateTime=e}}onPerformanceModeChange(e){this._performanceMode=e,e==="performance"?(this.heavyUpdateInterval=1e3/5,this._maxFrameSkip=3,this.interactionRecordInterval=500):(this.heavyUpdateInterval=1e3/10,this._maxFrameSkip=2,this.interactionRecordInterval=200)}_startFallbackAnimationLoops(){let e=()=>{this.updateAnimation(performance.now(),16.67),requestAnimationFrame(e)};requestAnimationFrame(e)}animateOptimizedNexusFrame(e){let i=Math.min((e??16.67)/1e3*5,1);this.nexusState.currentNavigationScale=this.utils.lerp(this.nexusState.currentNavigationScale,this.nexusState.targetNavigationScale,i),this.biometricState.desaturation=this.utils.lerp(this.biometricState.desaturation,this.biometricState.targetDesaturation,i),this.biometricState.slowdown=this.utils.lerp(this.biometricState.slowdown,this.biometricState.targetSlowdown,i),this.applyOptimizedStateToCSS()}applyOptimizedStateToCSS(){let e={"--sn-nav-item-transform-scale":this.nexusState.currentNavigationScale.toFixed(3),"--sn-sidebar-meditation-desaturation":this.biometricState.desaturation.toFixed(3),"--sn-sidebar-meditation-slowdown":this.biometricState.slowdown.toFixed(3)};this.cssController.batchSetVariables("InteractionTrackingSystem",e,"high","interaction-state-update")}validateMusicData(e){return e&&typeof e.energy=="number"&&typeof e.valence=="number"&&typeof e.visualIntensity=="number"}applySafeDefaults(){let e={"--sn-nav-item-transform-scale":"1.0","--sn-sidebar-meditation-desaturation":"0","--sn-sidebar-meditation-slowdown":"1"};this.cssController.batchSetVariables("InteractionTrackingSystem",e,"critical","safe-defaults-fallback")}updateIntegrationMetrics(){}calculateIntegrationComplexity(){let e=0;return e+=this.nexusState.userInfluence*10,e+=this.nexusState.lastVisualIntensity*5,this.biometricState.isMeditating&&(e+=5),e}performCleanup(){this.nexusState.userInfluence>0&&(this.nexusState.userInfluence=Math.max(0,this.nexusState.userInfluence-.01))}calculateOptimizedNavigationScale(e=.5,i="neutral"){let n=1;return e>.7&&(n=1.02),i==="energetic"&&(n*=1.01),n}getNavigationScalingReport(){return{target:this.nexusState.targetNavigationScale,current:this.nexusState.currentNavigationScale,intensity:this.nexusState.lastVisualIntensity,mood:this.nexusState.lastMoodIdentifier}}getMeditationReport(){return{isMeditating:this.biometricState.isMeditating,timeSinceInteraction:(Date.now()-this.biometricState.lastUserInteractionTime)/1e3,desaturation:this.biometricState.desaturation,slowdown:this.biometricState.slowdown}}destroy(){this._interactionHandler&&(["click","mousemove","keydown"].forEach(e=>{document.removeEventListener(e,this._interactionHandler)}),this._scrollContainerElements.forEach(e=>{e.removeEventListener("scroll",this._interactionHandler)}),this._interactionHandler=null),super.destroy()}}});var zi,Fs=y(()=>{"use strict";D();zi=class{constructor(t){this.year3000System=t;this.systemName="SpotifyUIApplicationSystem";this.initialized=!1;this.effectLayers=[];this.observerRegistry=new Map;this.lastDiscoveryLogTime=0;this.lastRefreshLogTime=0;this.debounceRefresh=this.debounce(()=>{this.refreshUITargets()},2e3);this.targets=this.initializeEmptyTargets()}updateAnimation(t){}async healthCheck(){try{let t=this.getTargetStats(),e=Object.values(t).reduce((r,a)=>r+a,0),i=this.initialized&&e>0,n=[];return e===0&&n.push("No UI elements discovered"),{healthy:i,ok:i,details:`UI Application System ${this.initialized?"active":"inactive"}, ${e} elements enhanced`,issues:n,system:"SpotifyUIApplicationSystem"}}catch(t){return{healthy:!1,ok:!1,details:"Health check failed",issues:[t instanceof Error?t.message:"Unknown error"],system:"SpotifyUIApplicationSystem"}}}forceRepaint(t){console.log(`\u{1F3A8} Force repaint requested: ${t||"manual trigger"}`),this.forceEffectCascade()}initializeEmptyTargets(){return{nowPlaying:[],sidebar:[],mainContent:[],buttons:[],cards:[],headers:[],textElements:[],iconElements:[],playbackControls:[],trackRows:[]}}async initialize(){if(!this.initialized)try{await this.discoverUITargets(),this.setupEffectLayers(),this.applyUnifiedState(),this.setupDOMObservers(),this.registerSystemCallbacks(),this.initialized=!0,console.log("\u2728 SpotifyUIApplicationSystem initialized successfully")}catch(t){throw console.error("Failed to initialize SpotifyUIApplicationSystem",t),t}}async discoverUITargets(){let t={nowPlaying:['[data-testid="now-playing-widget"]',".main-nowPlayingWidget-nowPlaying",".Root__now-playing-bar"],sidebar:['[data-testid="nav-bar"]',".main-navBar-navBar",".Root__nav-bar"],mainContent:['[data-testid="main"]',".main-view-container",".Root__main-view"],buttons:['button[class*="Button"]','[role="button"]',".main-playButton-PlayButton"],cards:['[data-testid*="card"]',".main-card-card",".main-entityCard-container"],headers:["h1, h2, h3, h4, h5, h6",'[data-testid*="header"]',".main-entityHeader-titleText"],textElements:['[data-testid="track-name"]','[data-testid="artist-name"]',".main-trackList-trackName",".main-trackList-artistName"],iconElements:['svg[class*="Icon"]','[data-testid*="icon"]',".Svg-sc-ytk21e-0"],playbackControls:['[data-testid="control-button"]',".main-playPauseButton-button",".player-controls__buttons"],trackRows:['[data-testid="tracklist-row"]',".main-trackList-trackListRow",".main-rootlist-rootlistItem"]},e={};for(let[n,r]of Object.entries(t))e[n]=r.join(", ");let i=new Map;for(let[n,r]of Object.entries(e))try{let a=document.querySelectorAll(r);for(let s of a)i.has(s)||i.set(s,[]),i.get(s).push(n)}catch{continue}this.targets=this.initializeEmptyTargets();for(let[n,r]of i)for(let a of r)this.targets[a].push(n);performance.now()-this.lastDiscoveryLogTime>=5e3&&(console.log("\u{1F3AF} UI targets discovered",{nowPlaying:this.targets.nowPlaying.length,sidebar:this.targets.sidebar.length,mainContent:this.targets.mainContent.length,buttons:this.targets.buttons.length,cards:this.targets.cards.length,headers:this.targets.headers.length,textElements:this.targets.textElements.length,iconElements:this.targets.iconElements.length,playbackControls:this.targets.playbackControls.length,trackRows:this.targets.trackRows.length}),this.lastDiscoveryLogTime=performance.now())}setupEffectLayers(){this.effectLayers=[{name:"background-containers",elements:[...this.targets.mainContent,...this.targets.sidebar],priority:10,cssVariables:{"--sn-bg-primary":"var(--sn-accent-primary)","--sn-bg-secondary":"var(--sn-accent-secondary)","--sn-gradient-start":"var(--sn-gradient-primary-rgb)","--sn-gradient-end":"var(--sn-gradient-secondary-rgb)"}},{name:"ui-cards",elements:this.targets.cards,priority:20,cssVariables:{"--sn-card-bg":"var(--sn-accent-primary)","--sn-card-border":"var(--sn-accent-secondary)","--sn-card-glow":"var(--sn-accent-tertiary)","--sn-glassmorphism-intensity":"var(--sn-effect-intensity)"},interactionEffects:!0},{name:"interactive-elements",elements:[...this.targets.buttons,...this.targets.playbackControls],priority:30,cssVariables:{"--sn-button-bg":"var(--sn-accent-primary)","--sn-button-hover":"var(--sn-accent-secondary)","--sn-button-active":"var(--sn-accent-tertiary)","--sn-beat-sync-intensity":"var(--sn-music-intensity)"},interactionEffects:!0},{name:"text-icon-effects",elements:[...this.targets.textElements,...this.targets.iconElements,...this.targets.headers],priority:40,cssVariables:{"--sn-text-primary":"var(--sn-accent-primary)","--sn-text-secondary":"var(--sn-accent-secondary)","--sn-text-glow":"var(--sn-accent-tertiary)","--sn-icon-color":"var(--sn-accent-primary)","--sn-icon-glow":"var(--sn-accent-secondary)"}},{name:"now-playing-effects",elements:this.targets.nowPlaying,priority:50,cssVariables:{"--sn-now-playing-bg":"var(--sn-accent-primary)","--sn-now-playing-glow":"var(--sn-accent-secondary)","--sn-beat-pulse":"var(--sn-music-intensity)","--sn-track-progress":"var(--sn-accent-tertiary)"},interactionEffects:!0}]}applyUnifiedState(){this.effectLayers.forEach(t=>{t.elements.forEach(e=>{this.applyEffectToElement(e,t)})})}safeQueueCSSVariableUpdate(t,e,i){this.year3000System?.queueCSSVariableUpdate?this.year3000System.queueCSSVariableUpdate(t,e,i||null):(i||document.documentElement).style.setProperty(t,e)}applyEffectToElement(t,e){t instanceof HTMLElement&&(Object.entries(e.cssVariables).forEach(([i,n])=>{this.safeQueueCSSVariableUpdate(i,n,t)}),t.classList.add(`sn-${e.name}`),t.classList.add("sn-ui-enhanced"),e.interactionEffects&&this.addInteractionEffects(t,e),t.setAttribute("data-sn-layer",e.name),t.setAttribute("data-sn-priority",e.priority.toString()))}addInteractionEffects(t,e){(e.name==="interactive-elements"||e.name==="now-playing-effects")&&(this.safeQueueCSSVariableUpdate("--sn-beat-response","var(--sn-music-intensity)",t),t.classList.add("sn-beat-responsive")),t.addEventListener("mouseenter",()=>{this.safeQueueCSSVariableUpdate("--sn-hover-intensity","1",t),t.classList.add("sn-hover-active")}),t.addEventListener("mouseleave",()=>{this.safeQueueCSSVariableUpdate("--sn-hover-intensity","0",t),t.classList.remove("sn-hover-active")}),t.addEventListener("click",()=>{this.safeQueueCSSVariableUpdate("--sn-click-intensity","1",t),t.classList.add("sn-click-active"),setTimeout(()=>{this.safeQueueCSSVariableUpdate("--sn-click-intensity","0",t),t.classList.remove("sn-click-active")},300)})}setupDOMObservers(){let t={childList:!0,subtree:!1,attributes:!1},e=new MutationObserver(n=>{let r=!1;n.forEach(a=>{a.type==="childList"&&a.addedNodes.length>0&&Array.from(a.addedNodes).some(o=>{if(o.nodeType===Node.ELEMENT_NODE){let l=o;return l.matches('[data-testid*="card"], [data-testid*="track"], [data-testid*="header"], [role="button"]')||l.querySelector('[data-testid*="card"], [data-testid*="track"], [data-testid*="header"], [role="button"]')}return!1})&&(r=!0)}),r&&this.debounceRefresh()}),i=document.querySelector('[data-testid="main"]')||document.body;e.observe(i,t),this.observerRegistry.set("main",e)}debounce(t,e){let i;return function(...r){let a=()=>{clearTimeout(i),t(...r)};clearTimeout(i),i=setTimeout(a,e)}}async refreshUITargets(){try{let t=this.calculateTargetHash();await this.discoverUITargets();let e=this.calculateTargetHash();t!==e&&(this.applyUnifiedState(),performance.now()-this.lastRefreshLogTime>=1e4&&(console.log("\u{1F504} UI targets refreshed"),this.lastRefreshLogTime=performance.now()))}catch(t){console.error("Failed to refresh UI targets",t)}}calculateTargetHash(){return Object.values(this.targets).map(e=>e.length).join("-")}registerSystemCallbacks(){try{g.subscribe("colors:harmonized",t=>{this.handleColorHarmonizedEvent({type:"colors/harmonized",payload:{processedColors:t.processedColors,accentHex:t.accentHex||"#cba6f7",accentRgb:t.accentRgb||"203,166,247",context:{rawColors:t.processedColors,trackUri:"",timestamp:Date.now()},cssVariables:{},metadata:{strategy:t.strategies[0]||"unknown",accentHex:t.accentHex,processingTime:t.processingTime}}})},"SpotifyUIApplicationSystem"),console.log("\u{1F3A8} [SpotifyUIApplicationSystem] Subscribed to colors:harmonized events")}catch(t){if(console.error("[SpotifyUIApplicationSystem] Failed to subscribe to colors:harmonized events:",t),this.year3000System.colorHarmonyEngine){let e=this.year3000System.applyColorsToTheme.bind(this.year3000System);this.year3000System.applyColorsToTheme=(i={})=>{e(i),this.updateColorVariables(i)},console.warn("[SpotifyUIApplicationSystem] Using legacy color application hook as fallback")}}if(this.year3000System.musicSyncService){let t=this.year3000System.updateFromMusicAnalysis.bind(this.year3000System);this.year3000System.updateFromMusicAnalysis=(e,i,n)=>{t(e,i,n),this.updateMusicIntensity(e)}}this.year3000System.beatSyncVisualSystem&&(this.year3000System.timerConsolidationSystem?this.year3000System.timerConsolidationSystem.registerConsolidatedTimer("SpotifyUIApplicationSystem-beatEffects",()=>{let t=this.getCurrentMusicIntensity();t>.5&&this.triggerBeatEffects({intensity:t})},200,"normal"):setInterval(()=>{let t=this.getCurrentMusicIntensity();t>.5&&this.triggerBeatEffects({intensity:t})},200))}getCurrentMusicIntensity(){let t=document.documentElement,e=getComputedStyle(t).getPropertyValue("--sn-kinetic-energy").trim();return parseFloat(e)||0}handleColorHarmonizedEvent(t){if(t.type!=="colors/harmonized")return;let{processedColors:e,cssVariables:i,metadata:n}=t.payload;console.log("\u{1F3A8} [SpotifyUIApplicationSystem] Received harmonized colors via event-driven pattern",{strategy:n.strategy,colorsCount:Object.keys(e).length,cssVariablesCount:Object.keys(i).length});try{this.updateColorVariables(e),i&&Object.keys(i).length>0&&this.applyCSSVariablesToSpotifyUI(i)}catch(r){console.error("[SpotifyUIApplicationSystem] Failed to apply harmonized colors from event:",r),this.updateColorVariables(e)}}applyCSSVariablesToSpotifyUI(t){try{let e=document.documentElement,i=document.querySelectorAll(".sn-ui-enhanced");for(let[n,r]of Object.entries(t))n&&r&&e.style.setProperty(n,r);i.forEach(n=>{if(n instanceof HTMLElement)for(let[r,a]of Object.entries(t))r&&a&&n.style.setProperty(r,a)}),console.log("\u{1F3A8} [SpotifyUIApplicationSystem] Applied CSS variables to Spotify UI",{variablesCount:Object.keys(t).length,enhancedElementsCount:i.length})}catch(e){console.error("[SpotifyUIApplicationSystem] Failed to apply CSS variables to Spotify UI:",e)}}updateColorVariables(t){document.querySelectorAll(".sn-ui-enhanced").forEach(i=>{i instanceof HTMLElement&&(this.safeQueueCSSVariableUpdate("--sn-accent-primary",t.primary||"var(--spice-accent)",i),this.safeQueueCSSVariableUpdate("--sn-accent-secondary",t.secondary||"var(--spice-accent)",i),this.safeQueueCSSVariableUpdate("--sn-accent-tertiary",t.tertiary||"var(--spice-accent)",i))})}updateMusicIntensity(t){let e=t?.processedEnergy||0;document.querySelectorAll(".sn-beat-responsive").forEach(n=>{n instanceof HTMLElement&&this.safeQueueCSSVariableUpdate("--sn-music-intensity",e.toString(),n)})}triggerBeatEffects(t){document.querySelectorAll(".sn-beat-responsive").forEach(i=>{i instanceof HTMLElement&&(this.safeQueueCSSVariableUpdate("--sn-beat-pulse","1",i),i.classList.add("sn-beat-active"),setTimeout(()=>{this.safeQueueCSSVariableUpdate("--sn-beat-pulse","0",i),i.classList.remove("sn-beat-active")},200))})}forceEffectCascade(){this.effectLayers.sort((t,e)=>t.priority-e.priority).forEach(t=>{t.elements.forEach(e=>{this.applyEffectToElement(e,t)})})}async destroy(){this.year3000System?.timerConsolidationSystem&&this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer("SpotifyUIApplicationSystem-beatEffects"),this.observerRegistry.forEach(e=>{e.disconnect()}),this.observerRegistry.clear(),document.querySelectorAll(".sn-ui-enhanced").forEach(e=>{e.classList.remove("sn-ui-enhanced"),e.removeAttribute("data-sn-layer"),e.removeAttribute("data-sn-priority")}),this.initialized=!1}getTargetStats(){return Object.fromEntries(Object.entries(this.targets).map(([t,e])=>[t,e.length]))}}});var Ui,Gs=y(()=>{"use strict";D();xe();ne();Ui=class{constructor(t,e,i){this.initialized=!1;this.dramaticElements=new Map;this.performanceMetrics={energyBurstCount:0,averageProcessingTime:0,lastUpdateTime:0,cpuUsage:0};this.animationState={energyPhase:0,dramaticPhase:0,interferencePhase:0,lastFrameTime:0,isAnimating:!1};this.cinematicPalettes={"blade-runner":{primaryRed:{r:255,g:50,b:50},amberGlow:{r:255,g:140,b:0},deepBlue:{r:0,g:100,b:200},neonCyan:{r:0,g:255,b:255}},cyberpunk:{primaryRed:{r:255,g:0,b:100},amberGlow:{r:255,g:180,b:0},deepBlue:{r:50,g:50,b:255},neonCyan:{r:100,g:255,b:255}},"dramatic-noir":{primaryRed:{r:200,g:0,b:0},amberGlow:{r:255,g:120,b:0},deepBlue:{r:0,g:50,b:150},neonCyan:{r:0,g:200,b:255}}};this.holographicSystem=t,this.cssConsciousnessController=e,this.musicSyncService=i,this.oklabProcessor=new M(!0),this.emotionalMapper=new J(!0),this.cinematicPreset=M.getPreset("COSMIC"),this.energyBurstState={intensity:0,frequency:.5,temperature:2500,interferenceLevel:0,scanlineVelocity:1,holographicDepth:0,dramaticTension:0,energyStability:1},this.cinematicConfig={redEnergyThreshold:.7,holographicIntensityMax:.9,crFilteringStrength:.8,bladeRunnerMode:!0,energyBurstDuration:1500,scanlineFrequency:120}}async initialize(){if(!this.initialized)try{console.log("[RedEnergyBurstSystem] Initializing red energy burst system..."),this.subscribeToColorConsciousness(),this.subscribeToOKLABColorEvents(),await this.initializeDramaticElements(),this.setupCinematicCSSVariables(),this.startCinematicAnimation(),this.initialized=!0,console.log("[RedEnergyBurstSystem] \u2705 Ready for dramatic consciousness moments")}catch(t){throw console.error("[RedEnergyBurstSystem] Failed to initialize:",t),t}}updateAnimation(t){if(!this.initialized)return;let e=t/1e3;this.animationState.energyPhase+=e*this.energyBurstState.frequency*2,this.animationState.dramaticPhase+=e*.8,this.animationState.interferencePhase+=e*3,this.updateEnergyBurstFromMusic(),this.updateHolographicMapping(),this.updateDramaticElements(),this.updatePerformanceMetrics(t)}async healthCheck(){let t=this.initialized&&this.energyBurstState.intensity>=0&&this.performanceMetrics.averageProcessingTime<5;return{system:"RedEnergyBurstSystem",healthy:t,metrics:{energyBurstCount:this.performanceMetrics.energyBurstCount,processingTime:this.performanceMetrics.averageProcessingTime,dramaticElementCount:this.dramaticElements.size,cpuUsage:this.performanceMetrics.cpuUsage},issues:t?[]:["Performance degradation detected"]}}subscribeToColorConsciousness(){g.subscribe("emotionalColorContext:updated",t=>{this.onColorConsciousnessUpdate(t)},"RedEnergyBurstSystem"),g.subscribe("emotion:analyzed",t=>{this.onMusicIntensitySpike(t)},"RedEnergyBurstSystem"),g.subscribe("emotion:analyzed",t=>{this.onDramaticMoment(t)},"RedEnergyBurstSystem")}subscribeToOKLABColorEvents(){g.subscribe("colors:harmonized",t=>{this.onOKLABColorsHarmonized(t)},"RedEnergyBurstSystem"),g.subscribe("colors:extracted",t=>{this.onColorsExtracted(t)},"RedEnergyBurstSystem")}onColorConsciousnessUpdate(t){let{palette:e,consciousnessLevel:i,emotionalTemperature:n}=t;this.energyBurstState.dramaticTension=i*.8,n<3e3?this.energyBurstState.temperature=2200:n>6e3?this.energyBurstState.temperature=2800:this.energyBurstState.temperature=2500;let r=this.extractDominantRedColor(e);this.updateHolographicColors(r)}onMusicIntensitySpike(t){let{intensity:e,beat:i}=t;e>this.cinematicConfig.redEnergyThreshold&&this.triggerEnergyBurst(e,i)}onDramaticMoment(t){let{type:e,intensity:i}=t;this.energyBurstState.dramaticTension=Math.min(1,i*1.2),this.energyBurstState.interferenceLevel=i*.6,this.energyBurstState.energyStability=Math.max(.3,1-i*.7)}onOKLABColorsHarmonized(t){let{processedColors:e,coordinationMetrics:i}=t,n=this.extractCinematicOKLABColors(e);this.updateCinematicPaletteWithOKLAB(n),(i?.detectedGenre||i?.emotionalState)&&this.adjustCinematicPresetForContext(i)}onColorsExtracted(t){let{rawColors:e,musicData:i}=t;if(i){let n=this.emotionalMapper.mapMusicToEmotionalTemperature(i);this.adjustCinematicEffectsForEmotion(n),n.intensity>.7?this.cinematicPreset=M.getPreset("COSMIC"):n.intensity>.4?this.cinematicPreset=M.getPreset("VIBRANT"):this.cinematicPreset=M.getPreset("STANDARD")}}triggerEnergyBurst(t,e){let i=performance.now();this.energyBurstState.intensity=Math.min(1,t*1.1),this.energyBurstState.frequency=1+t*2,this.energyBurstState.holographicDepth=t*.8,this.energyBurstState.scanlineVelocity=1+e.strength*2,setTimeout(()=>{this.decayEnergyBurst()},this.cinematicConfig.energyBurstDuration),this.performanceMetrics.energyBurstCount++,this.performanceMetrics.lastUpdateTime=performance.now()-i,console.log(`[RedEnergyBurstSystem] \u{1F525} Red energy burst triggered! Intensity: ${t.toFixed(2)}`)}decayEnergyBurst(){let e=()=>{this.energyBurstState.intensity*=.95,this.energyBurstState.holographicDepth*=.96,this.energyBurstState.interferenceLevel*=.97,this.energyBurstState.intensity>.05?requestAnimationFrame(e):(this.energyBurstState.intensity=0,this.energyBurstState.holographicDepth=0,this.energyBurstState.interferenceLevel=0)};requestAnimationFrame(e)}updateEnergyBurstFromMusic(){let t=this.musicSyncService.getCurrentMusicState();if(!t)return;let{emotion:e,beat:i,intensity:n}=t;if(i&&i.tempo){let r=Math.max(.5,Math.min(2,i.tempo/120));this.energyBurstState.frequency=this.energyBurstState.frequency*r}e&&e.arousal>.7&&(this.energyBurstState.interferenceLevel=Math.max(this.energyBurstState.interferenceLevel,e.arousal*.5))}updateHolographicMapping(){let t=this.cinematicPalettes["blade-runner"],e={dominantColor:this.blendRedColors(t.primaryRed,t.amberGlow,this.energyBurstState.temperature/3e3),glowIntensity:this.energyBurstState.intensity*this.cinematicConfig.holographicIntensityMax,flickerRate:this.energyBurstState.frequency*2,scanlineColor:t.amberGlow,atmosphericDepth:this.energyBurstState.holographicDepth,interferencePattern:this.getInterferencePattern()};this.updateCinematicCSSVariables(e)}blendRedColors(t,e,i){let n=Math.max(0,Math.min(1,i));try{let r=`#${t.r.toString(16).padStart(2,"0")}${t.g.toString(16).padStart(2,"0")}${t.b.toString(16).padStart(2,"0")}`,a=`#${e.r.toString(16).padStart(2,"0")}${e.g.toString(16).padStart(2,"0")}${e.b.toString(16).padStart(2,"0")}`;return this.oklabProcessor.interpolateOKLAB(r,a,n,this.cinematicPreset).enhancedRgb}catch{return{r:Math.round(t.r*(1-n)+e.r*n),g:Math.round(t.g*(1-n)+e.g*n),b:Math.round(t.b*(1-n)+e.b*n)}}}getInterferencePattern(){return this.energyBurstState.energyStability<.4?"chaos":this.energyBurstState.dramaticTension>.7?"dramatic":this.energyBurstState.interferenceLevel>.5?"noise":"wave"}extractDominantRedColor(t){let e={r:255,g:50,b:50};if(t&&t.length>0){let i=t.filter(n=>n.r>n.g&&n.r>n.b);i.length>0&&(e=i[0])}return e}extractCinematicOKLABColors(t){let i={...this.cinematicPalettes["blade-runner"]};if(t.VIBRANT){let n=this.oklabProcessor.processColor(t.VIBRANT,this.cinematicPreset);i.primaryRed=n.enhancedRgb}if(t.PROMINENT){let n=this.oklabProcessor.processColor(t.PROMINENT,this.cinematicPreset);i.amberGlow=n.enhancedRgb}if(t.DARK_VIBRANT){let n=this.oklabProcessor.processColor(t.DARK_VIBRANT,this.cinematicPreset);i.deepBlue=n.enhancedRgb}return i}updateCinematicPaletteWithOKLAB(t){this.cinematicPalettes["blade-runner"]=t,this.cssConsciousnessController.queueCSSVariableUpdate("--cinematic-red-r",t.primaryRed.r.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--cinematic-red-g",t.primaryRed.g.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--cinematic-red-b",t.primaryRed.b.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--cinematic-amber-r",t.amberGlow.r.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--cinematic-amber-g",t.amberGlow.g.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--cinematic-amber-b",t.amberGlow.b.toString())}adjustCinematicPresetForContext(t){let{detectedGenre:e,emotionalState:i,oklabPreset:n}=t;if(e)switch(e){case"electronic":case"dance":case"techno":this.cinematicPreset=M.getPreset("COSMIC"),this.cinematicConfig.bladeRunnerMode=!0;break;case"rock":case"metal":this.cinematicPreset=M.getPreset("VIBRANT"),this.cinematicConfig.redEnergyThreshold=.6;break;case"ambient":case"classical":this.cinematicPreset=M.getPreset("SUBTLE"),this.cinematicConfig.redEnergyThreshold=.8;break;default:this.cinematicPreset=M.getPreset("STANDARD")}if(i)switch(i){case"aggressive":case"energetic":this.energyBurstState.frequency*=1.5,this.energyBurstState.interferenceLevel=Math.min(1,this.energyBurstState.interferenceLevel+.3);break;case"calm":case"ambient":this.energyBurstState.frequency*=.7,this.energyBurstState.energyStability=Math.min(1,this.energyBurstState.energyStability+.2);break;case"mysterious":this.cinematicConfig.bladeRunnerMode=!0,this.energyBurstState.interferenceLevel=Math.min(1,this.energyBurstState.interferenceLevel+.2);break}}adjustCinematicEffectsForEmotion(t){let{primaryEmotion:e,intensity:i,temperature:n}=t;switch(this.energyBurstState.dramaticTension=i*.9,n<3e3?this.energyBurstState.temperature=2200:n>6e3?this.energyBurstState.temperature=2800:this.energyBurstState.temperature=2500,e){case"aggressive":this.energyBurstState.interferenceLevel=Math.min(1,i*.8),this.energyBurstState.energyStability=Math.max(.2,1-i);break;case"calm":this.energyBurstState.energyStability=Math.min(1,.8+i*.2),this.energyBurstState.interferenceLevel*=.5;break;case"mysterious":this.energyBurstState.interferenceLevel=i*.6,this.cinematicConfig.bladeRunnerMode=!0;break;case"energetic":this.energyBurstState.frequency=Math.min(3,1+i*2);break}}updateHolographicColors(t){this.cssConsciousnessController.queueCSSVariableUpdate("--cinematic-red-r",t.r.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--cinematic-red-g",t.g.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--cinematic-red-b",t.b.toString())}async initializeDramaticElements(){let t=[{selector:".Root__now-playing-bar",type:"energy_barrier"},{selector:".main-view-container",type:"cinematic_overlay"},{selector:".Root__nav-bar",type:"data_stream_red"},{selector:".player-controls",type:"dramatic_interface"}];for(let e of t){let i=document.querySelectorAll(e.selector);for(let n of i){let r={id:`dramatic-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,element:n,originalStyles:getComputedStyle(n),holographicType:e.type,intensity:.8,isActive:!0,lastUpdate:0,animation:null,consciousnessLevel:.9,organicIntegration:!0};this.dramaticElements.set(r.id,r)}}}setupCinematicCSSVariables(){let t={"--cinematic-red-r":"255","--cinematic-red-g":"50","--cinematic-red-b":"50","--cinematic-amber-r":"255","--cinematic-amber-g":"140","--cinematic-amber-b":"0","--cinematic-glow-intensity":"0","--cinematic-flicker-rate":"0.5","--cinematic-scanline-speed":"1.0","--cinematic-interference":"0","--cinematic-depth":"0"};for(let[e,i]of Object.entries(t))this.cssConsciousnessController.queueCSSVariableUpdate(e,i)}updateCinematicCSSVariables(t){this.cssConsciousnessController.queueCSSVariableUpdate("--cinematic-glow-intensity",t.glowIntensity.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--cinematic-flicker-rate",t.flickerRate.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--cinematic-scanline-speed",this.energyBurstState.scanlineVelocity.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--cinematic-interference",this.energyBurstState.interferenceLevel.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--cinematic-depth",t.atmosphericDepth.toString())}updateDramaticElements(){for(let[t,e]of this.dramaticElements)e.isActive&&this.updateDramaticElement(e)}updateDramaticElement(t){let{element:e,intensity:i}=t;this.energyBurstState.intensity>.1&&this.applyRedEnergyBurst(e,i),this.energyBurstState.interferenceLevel>.1&&this.applyCRTInterference(e,i),this.applyDramaticScanlines(e,i)}applyRedEnergyBurst(t,e){let i=this.energyBurstState.intensity*e,n=Math.sin(this.animationState.energyPhase*3)*.5+.5,r=i*n*.8;t.style.boxShadow=`
      0 0 ${r*40}px rgba(var(--cinematic-red-r), var(--cinematic-red-g), var(--cinematic-red-b), ${r}),
      inset 0 0 ${r*20}px rgba(var(--cinematic-amber-r), var(--cinematic-amber-g), var(--cinematic-amber-b), ${r*.5})
    `,i>.3&&(t.style.border=`1px solid rgba(var(--cinematic-red-r), var(--cinematic-red-g), var(--cinematic-red-b), ${i})`)}applyCRTInterference(t,e){let i=this.energyBurstState.interferenceLevel*e,n=this.animationState.interferencePhase,r=i*3,a=Math.sin(n*2)*r,s=Math.cos(n*2.5)*r;if(t.style.filter=`
      drop-shadow(${a}px 0 0 rgba(var(--spice-rgb-cinematic-red, 255, 0, 0), ${i*.6}))
      drop-shadow(${s}px 0 0 rgba(var(--spice-rgb-cinematic-cyan, 0, 255, 255), ${i*.4}))
    `,i>.5){let o=Math.sin(n*10)*i*2;t.style.transform=`translateX(${o}px)`}}applyDramaticScanlines(t,e){let i=this.energyBurstState.intensity*e*.6;if(i>.1){let n=this.cinematicConfig.scanlineFrequency/30;t.style.background=`
        ${t.style.background||""},
        repeating-linear-gradient(
          0deg,
          transparent 0px,
          transparent ${n-1}px,
          rgba(var(--cinematic-amber-r), var(--cinematic-amber-g), var(--cinematic-amber-b), ${i*.15}) ${n}px
        )
      `}}startCinematicAnimation(){this.animationState.isAnimating=!0,this.animationState.lastFrameTime=performance.now();let t=e=>{if(!this.animationState.isAnimating)return;let i=e-this.animationState.lastFrameTime;this.animationState.lastFrameTime=e,this.updateAnimation(i),requestAnimationFrame(t)};requestAnimationFrame(t)}updatePerformanceMetrics(t){this.performanceMetrics.averageProcessingTime=this.performanceMetrics.averageProcessingTime*.9+t*.1,this.performanceMetrics.cpuUsage=Math.min(100,t/16.67*100)}forceRepaint(t){console.log(`[RedEnergyBurstSystem] Force repaint triggered: ${t||"Unknown"}`),this.updateDramaticElements(),this.cssConsciousnessController.flushCSSVariableBatch()}destroy(){console.log("[RedEnergyBurstSystem] Destroying cinematic drama engine..."),this.animationState.isAnimating=!1,this.dramaticElements.clear(),this.energyBurstState={intensity:0,frequency:.5,temperature:2500,interferenceLevel:0,scanlineVelocity:1,holographicDepth:0,dramaticTension:0,energyStability:1},this.initialized=!1}getEnergyBurstState(){return{...this.energyBurstState}}getCinematicConfig(){return{...this.cinematicConfig}}getPerformanceMetrics(){return{...this.performanceMetrics}}setRedEnergyThreshold(t){this.cinematicConfig.redEnergyThreshold=Math.max(0,Math.min(1,t))}setBladeRunnerMode(t){this.cinematicConfig.bladeRunnerMode=t,t&&console.log("[RedEnergyBurstSystem] \u{1F3AC} Blade Runner mode activated")}}});var Vi,Hs=y(()=>{"use strict";D();K();Vi=class{constructor(t,e,i){this.initialized=!1;this.etherealElements=new Map;this.performanceMetrics={emotionalMomentCount:0,averageProcessingTime:0,lastUpdateTime:0,gentleTransitionCount:0};this.animationState={mysticalPhase:0,dreamyPhase:0,flowingPhase:0,emotionalPulsePhase:0,lastFrameTime:0,isAnimating:!1};this.lerpHalfLifeValues={emotionalIntensity:.25,beautyLevel:.35,mysticalShimmer:.2};this.etherealPalettes={"dreamy-pastels":{primarySoft:{r:203,g:166,b:247},mysticalGlow:{r:148,g:226,b:213},dreamyMist:{r:245,g:224,b:220},emotionalHeart:{r:249,g:226,b:175},etherealHighlight:{r:180,g:190,b:254}},"mystical-moonlight":{primarySoft:{r:137,g:180,b:250},mysticalGlow:{r:166,g:227,b:161},dreamyMist:{r:205,g:214,b:244},emotionalHeart:{r:243,g:139,b:168},etherealHighlight:{r:137,g:220,b:235}},"gentle-aurora":{primarySoft:{r:166,g:227,b:161},mysticalGlow:{r:137,g:220,b:235},dreamyMist:{r:186,g:194,b:222},emotionalHeart:{r:250,g:179,b:135},etherealHighlight:{r:203,g:166,b:247}}};this.holographicSystem=t,this.cssConsciousnessController=e,this.musicSyncService=i,this.etherealState={emotionalIntensity:0,beautyLevel:0,gentleness:.8,mysticalShimmer:0,dreamyTranslucency:.9,flowingGradientPhase:0,emotionalResonance:0,softnessFactor:1,targetEmotionalIntensity:0,targetBeautyLevel:0,targetMysticalShimmer:0},this.etherealConfig={emotionalThreshold:.6,maxBeautyIntensity:.8,gentleTransitionDuration:2e3,mysticalParticleCount:15,dreamyBlurRadius:8,flowingGradientSpeed:.3}}async initialize(){if(!this.initialized)try{console.log("[SoftGlowEffectsManager] Awakening ethereal beauty consciousness..."),this.subscribeToEmotionalConsciousness(),await this.initializeEtherealElements(),this.setupEtherealCSSVariables(),this.startEtherealAnimation(),this.initialized=!0,console.log("[SoftGlowEffectsManager] \u2728 Ready for mystical emotional moments")}catch(t){throw console.error("[SoftGlowEffectsManager] Failed to initialize:",t),t}}updateAnimation(t){if(!this.initialized)return;let e=t/1e3;this.animationState.mysticalPhase+=e*.5,this.animationState.dreamyPhase+=e*.3,this.animationState.flowingPhase+=e*this.etherealConfig.flowingGradientSpeed,this.animationState.emotionalPulsePhase+=e*.8,this.updateEtherealFromMusic(),this.updateEtherealStateWithLERP(e),this.updateMysticalEffects(),this.updateEtherealElements(),this.updatePerformanceMetrics(t)}async healthCheck(){let t=this.initialized&&this.etherealState.beautyLevel>=0&&this.performanceMetrics.averageProcessingTime<8;return{system:"SoftGlowEffectsManager",healthy:t,metrics:{emotionalMomentCount:this.performanceMetrics.emotionalMomentCount,processingTime:this.performanceMetrics.averageProcessingTime,etherealElementCount:this.etherealElements.size,gentleTransitionCount:this.performanceMetrics.gentleTransitionCount},issues:t?[]:["Performance degradation detected"]}}subscribeToEmotionalConsciousness(){g.subscribe("emotionalColorContext:updated",t=>{this.onColorConsciousnessUpdate(t)}),g.subscribe("emotion:analyzed",t=>{this.onEmotionalMoment(t)}),g.subscribe("settings:visual-guide-changed",t=>{this.onGentleTransition(t)})}onColorConsciousnessUpdate(t){let{palette:e,consciousnessLevel:i,emotionalTemperature:n}=t;this.etherealState.emotionalResonance=i*.9,n>5e3?this.etherealState.beautyLevel=Math.min(.8,i*1.2):this.etherealState.mysticalShimmer=i*.7;let r=this.generateEtherealColors(e,n);this.updateEtherealColors(r)}onEmotionalMoment(t){let{type:e,intensity:i,valence:n}=t;n>this.etherealConfig.emotionalThreshold&&this.triggerEtherealBeauty(i,n)}onGentleTransition(t){let{fromState:e,toState:i,duration:n}=t;this.createGentleTransition(e,i,n),this.performanceMetrics.gentleTransitionCount++}triggerEtherealBeauty(t,e){let i=performance.now();this.etherealState.dreamyTranslucency=.8+e*.2,this.etherealState.targetEmotionalIntensity=Math.max(this.etherealState.targetEmotionalIntensity,t*.8),this.etherealState.targetBeautyLevel=Math.max(this.etherealState.targetBeautyLevel,e*.9),this.etherealState.targetMysticalShimmer=Math.max(this.etherealState.targetMysticalShimmer,e*.6),this.performanceMetrics.emotionalMomentCount++,this.performanceMetrics.lastUpdateTime=performance.now()-i,console.log(`[SoftGlowEffectsManager] \u2728 Ethereal beauty awakened! Intensity: ${t.toFixed(2)}, Valence: ${e.toFixed(2)}`)}updateEtherealStateWithLERP(t){this.etherealState.emotionalIntensity=O(this.etherealState.emotionalIntensity,this.etherealState.targetEmotionalIntensity,t,this.lerpHalfLifeValues.emotionalIntensity),this.etherealState.beautyLevel=O(this.etherealState.beautyLevel,this.etherealState.targetBeautyLevel,t,this.lerpHalfLifeValues.beautyLevel),this.etherealState.mysticalShimmer=O(this.etherealState.mysticalShimmer,this.etherealState.targetMysticalShimmer,t,this.lerpHalfLifeValues.mysticalShimmer);let e=1.5;this.etherealState.targetEmotionalIntensity=O(this.etherealState.targetEmotionalIntensity,0,t,e),this.etherealState.targetBeautyLevel=O(this.etherealState.targetBeautyLevel,0,t,e*1.2),this.etherealState.targetMysticalShimmer=O(this.etherealState.targetMysticalShimmer,0,t,e*.8)}updateEtherealFromMusic(){let t=this.musicSyncService.getCurrentMusicState();if(!t)return;let{emotion:e,beat:i,intensity:n}=t;if(e&&e.valence>.5&&(this.etherealState.mysticalShimmer=Math.max(this.etherealState.mysticalShimmer,e.valence*n*.5),i&&i.tempo)){let r=Math.min(1.5,i.tempo/100);this.etherealConfig.flowingGradientSpeed=.3*r}}updateMysticalEffects(){let t=this.etherealPalettes["dreamy-pastels"],e={primarySoft:this.blendSoftColors(t.primarySoft,t.mysticalGlow,this.etherealState.mysticalShimmer),mysticalGlow:t.mysticalGlow,dreamyMist:t.dreamyMist,emotionalHeart:t.emotionalHeart,etherealHighlight:t.etherealHighlight,gentleTransparency:this.etherealState.dreamyTranslucency};this.updateEtherealCSSVariables(e)}blendSoftColors(t,e,i){let n=Math.max(0,Math.min(1,i));return{r:Math.round(t.r*(1-n)+e.r*n),g:Math.round(t.g*(1-n)+e.g*n),b:Math.round(t.b*(1-n)+e.b*n)}}generateEtherealColors(t,e){let i=this.etherealPalettes["dreamy-pastels"];return e<4e3?i=this.etherealPalettes["mystical-moonlight"]:e>7e3&&(i=this.etherealPalettes["gentle-aurora"]),{primarySoft:i.primarySoft,mysticalGlow:i.mysticalGlow,dreamyMist:i.dreamyMist,emotionalHeart:i.emotionalHeart,etherealHighlight:i.etherealHighlight,gentleTransparency:this.etherealState.dreamyTranslucency}}updateEtherealColors(t){this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-soft-r",t.primarySoft.r.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-soft-g",t.primarySoft.g.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-soft-b",t.primarySoft.b.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-mystical-r",t.mysticalGlow.r.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-mystical-g",t.mysticalGlow.g.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-mystical-b",t.mysticalGlow.b.toString())}async initializeEtherealElements(){let t=[".main-view-container",".Root__now-playing-bar",".main-trackInfo-container",".cover-art",".player-controls"];for(let e of t){let i=document.querySelectorAll(e);for(let n of i){let r=`ethereal-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;this.etherealElements.set(r,n)}}}setupEtherealCSSVariables(){let t={"--ethereal-soft-r":"203","--ethereal-soft-g":"166","--ethereal-soft-b":"247","--ethereal-mystical-r":"148","--ethereal-mystical-g":"226","--ethereal-mystical-b":"213","--ethereal-dreamy-r":"245","--ethereal-dreamy-g":"224","--ethereal-dreamy-b":"220","--ethereal-beauty-level":"0","--ethereal-mystical-shimmer":"0","--ethereal-gentle-transparency":"0.9","--ethereal-flowing-phase":"0","--ethereal-emotional-pulse":"0"};for(let[e,i]of Object.entries(t))this.cssConsciousnessController.queueCSSVariableUpdate(e,i)}updateEtherealCSSVariables(t){this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-beauty-level",this.etherealState.beautyLevel.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-mystical-shimmer",this.etherealState.mysticalShimmer.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-gentle-transparency",t.gentleTransparency.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-flowing-phase",this.animationState.flowingPhase.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--ethereal-emotional-pulse",Math.sin(this.animationState.emotionalPulsePhase).toString())}updateEtherealElements(){for(let[t,e]of this.etherealElements)this.updateEtherealElement(e)}updateEtherealElement(t){this.etherealState.beautyLevel>.1&&this.applyEtherealBeauty(t),this.etherealState.mysticalShimmer>.1&&this.applyMysticalShimmer(t),this.applyFlowingGradients(t)}applyEtherealBeauty(t){let e=this.etherealState.beautyLevel,i=Math.sin(this.animationState.emotionalPulsePhase)*.5+.5,n=e*i*.6;t.style.boxShadow=`
      0 0 ${n*30}px rgba(var(--ethereal-soft-r), var(--ethereal-soft-g), var(--ethereal-soft-b), ${n*.6}),
      inset 0 0 ${n*20}px rgba(var(--ethereal-mystical-r), var(--ethereal-mystical-g), var(--ethereal-mystical-b), ${n*.3})
    `;let r=.9+e*.1;t.style.opacity=r.toString()}applyMysticalShimmer(t){let e=this.etherealState.mysticalShimmer,i=this.animationState.mysticalPhase,n=Math.sin(i*2)*e*2,r=1+Math.cos(i*1.5)*e*.05;t.style.transform=`translate(${n}px, 0) scale(${r})`;let a=Math.sin(i*.8)*e*15;t.style.filter=`hue-rotate(${a}deg) saturate(${1+e*.3})`}applyFlowingGradients(t){let e=this.animationState.flowingPhase,i=this.etherealState.beautyLevel*.8;if(i>.1){let n=(Math.sin(e)+1)*50;t.style.background=`
        ${t.style.background||""},
        linear-gradient(
          ${n}deg,
          rgba(var(--ethereal-soft-r), var(--ethereal-soft-g), var(--ethereal-soft-b), ${i*.1}) 0%,
          rgba(var(--ethereal-mystical-r), var(--ethereal-mystical-g), var(--ethereal-mystical-b), ${i*.15}) 50%,
          rgba(var(--ethereal-dreamy-r), var(--ethereal-dreamy-g), var(--ethereal-dreamy-b), ${i*.05}) 100%
        )
      `}}createGentleTransition(t,e,i){let n=performance.now(),r=a=>{let s=a-n,o=Math.min(1,s/i),l=1-Math.pow(1-o,3);this.etherealState.beautyLevel=t.beauty+(e.beauty-t.beauty)*l,this.etherealState.mysticalShimmer=t.shimmer+(e.shimmer-t.shimmer)*l,o<1&&requestAnimationFrame(r)};requestAnimationFrame(r)}startEtherealAnimation(){this.animationState.isAnimating=!0,this.animationState.lastFrameTime=performance.now();let t=e=>{if(!this.animationState.isAnimating)return;let i=e-this.animationState.lastFrameTime;this.animationState.lastFrameTime=e,this.updateAnimation(i),requestAnimationFrame(t)};requestAnimationFrame(t)}updatePerformanceMetrics(t){this.performanceMetrics.averageProcessingTime=this.performanceMetrics.averageProcessingTime*.9+t*.1}forceRepaint(t){console.log(`[SoftGlowEffectsManager] Force repaint triggered: ${t||"Unknown"}`),this.updateEtherealElements(),this.cssConsciousnessController.flushCSSVariableBatch()}destroy(){console.log("[SoftGlowEffectsManager] Dissolving ethereal beauty..."),this.animationState.isAnimating=!1,this.etherealElements.clear(),this.etherealState={emotionalIntensity:0,beautyLevel:0,gentleness:.8,mysticalShimmer:0,dreamyTranslucency:.9,flowingGradientPhase:0,emotionalResonance:0,softnessFactor:1,targetEmotionalIntensity:0,targetBeautyLevel:0,targetMysticalShimmer:0},this.initialized=!1}getEtherealState(){return{...this.etherealState}}getEtherealConfig(){return{...this.etherealConfig}}getPerformanceMetrics(){return{...this.performanceMetrics,etherealElementCount:this.etherealElements.size}}setEmotionalThreshold(t){this.etherealConfig.emotionalThreshold=Math.max(0,Math.min(1,t))}setMaxBeautyIntensity(t){this.etherealConfig.maxBeautyIntensity=Math.max(0,Math.min(1,t))}setGentleness(t){this.etherealState.gentleness=Math.max(0,Math.min(1,t))}}});var _i,Os=y(()=>{"use strict";D();_i=class{constructor(t,e,i){this.initialized=!1;this.naturalElements=new Map;this.performanceMetrics={peacefulMomentCount:0,averageProcessingTime:0,lastUpdateTime:0,breathingCycleCount:0};this.animationState={breathingPhase:0,seasonalPhase:0,organicPhase:0,harmonyPhase:0,lastFrameTime:0,isAnimating:!1};this.naturalPalettes={"spring-awakening":{earthyWarm:{r:166,g:227,b:161},forestGreen:{r:64,g:160,b:43},skyBlue:{r:137,g:220,b:235},sunsetGlow:{r:250,g:179,b:135},stoneGray:{r:108,g:112,b:134}},"summer-warmth":{earthyWarm:{r:249,g:226,b:175},forestGreen:{r:166,g:227,b:161},skyBlue:{r:116,g:199,b:236},sunsetGlow:{r:250,g:179,b:135},stoneGray:{r:147,g:153,b:178}},"autumn-grounding":{earthyWarm:{r:250,g:179,b:135},forestGreen:{r:148,g:226,b:213},skyBlue:{r:137,g:180,b:250},sunsetGlow:{r:235,g:160,b:172},stoneGray:{r:127,g:132,b:156}},"winter-peace":{earthyWarm:{r:186,g:194,b:222},forestGreen:{r:148,g:226,b:213},skyBlue:{r:137,g:220,b:235},sunsetGlow:{r:203,g:166,b:247},stoneGray:{r:88,g:91,b:112}}};this.holographicSystem=t,this.cssConsciousnessController=e,this.musicSyncService=i,this.breathingState={serenityLevel:0,breathingFrequency:.4,organicDepth:.8,earthConnection:0,naturalWarmth:.7,forestAtmosphere:0,seasonalShift:0,harmonyResonance:0},this.harmonyConfig={peacefulThreshold:.3,maxBreathingDepth:.9,naturalFrequencyRange:[.2,.8],earthyColorStrength:.6,naturalTransitionDuration:3e3,seasonalCycleSpeed:.1}}async initialize(){if(!this.initialized)try{console.log("[NaturalHarmonyEngine] Awakening natural harmony consciousness..."),this.subscribeToNaturalConsciousness(),await this.initializeNaturalElements(),this.setupNaturalCSSVariables(),this.startNaturalBreathing(),this.initialized=!0,console.log("[NaturalHarmonyEngine] \u{1F33F} Ready for natural harmony breathing")}catch(t){throw console.error("[NaturalHarmonyEngine] Failed to initialize:",t),t}}updateAnimation(t){if(!this.initialized)return;let e=t/1e3;this.animationState.breathingPhase+=e*this.breathingState.breathingFrequency*2*Math.PI,this.animationState.seasonalPhase+=e*this.harmonyConfig.seasonalCycleSpeed,this.animationState.organicPhase+=e*.4,this.animationState.harmonyPhase+=e*.6,this.updateNaturalFromMusic(),this.updateOrganicBreathing(),this.updateNaturalElements(),this.updatePerformanceMetrics(t)}async healthCheck(){let t=this.initialized&&this.breathingState.serenityLevel>=0&&this.performanceMetrics.averageProcessingTime<10;return{system:"NaturalHarmonyEngine",healthy:t,metrics:{peacefulMomentCount:this.performanceMetrics.peacefulMomentCount,processingTime:this.performanceMetrics.averageProcessingTime,naturalElementCount:this.naturalElements.size,breathingCycleCount:this.performanceMetrics.breathingCycleCount},issues:t?[]:["Performance degradation detected"]}}subscribeToNaturalConsciousness(){g.subscribe("emotionalColorContext:updated",t=>{this.onColorConsciousnessUpdate(t)}),g.subscribe("emotion:analyzed",t=>{this.onPeacefulMoment(t)}),g.subscribe("settings:visual-guide-changed",t=>{this.onOrganicTransition(t)})}onColorConsciousnessUpdate(t){let{palette:e,consciousnessLevel:i,emotionalTemperature:n}=t;this.breathingState.harmonyResonance=i*.8,n<5e3?(this.breathingState.earthConnection=i*.6,this.breathingState.forestAtmosphere=i*.4):(this.breathingState.naturalWarmth=i*.8,this.breathingState.seasonalShift=i*.5);let r=this.generateNaturalColors(e,n);this.updateNaturalColors(r)}onPeacefulMoment(t){let{type:e,intensity:i,serenity:n}=t;this.triggerNaturalBreathing(i,n)}onOrganicTransition(t){let{fromSeason:e,toSeason:i,duration:n}=t;this.createSeasonalTransition(e,i,n),this.performanceMetrics.breathingCycleCount++}triggerNaturalBreathing(t,e){let i=performance.now();this.breathingState.serenityLevel=e,this.breathingState.earthConnection=e*.7,this.breathingState.forestAtmosphere=e*.6,this.breathingState.naturalWarmth=.6+e*.3;let n=this.harmonyConfig.naturalFrequencyRange;this.breathingState.breathingFrequency=n[0]+e*(n[1]-n[0]),setTimeout(()=>{this.gentleDecayNaturalBreathing()},this.harmonyConfig.naturalTransitionDuration),this.performanceMetrics.peacefulMomentCount++,this.performanceMetrics.lastUpdateTime=performance.now()-i,console.log(`[NaturalHarmonyEngine] \u{1F33F} Natural breathing awakened! Serenity: ${e.toFixed(2)}, Frequency: ${this.breathingState.breathingFrequency.toFixed(2)}Hz`)}gentleDecayNaturalBreathing(){let e=()=>{this.breathingState.serenityLevel*=.985,this.breathingState.earthConnection*=.988,this.breathingState.forestAtmosphere*=.991,this.breathingState.serenityLevel>.05?requestAnimationFrame(e):(this.breathingState.serenityLevel=0,this.breathingState.earthConnection=0,this.breathingState.forestAtmosphere=0)};requestAnimationFrame(e)}updateNaturalFromMusic(){let t=this.musicSyncService.getCurrentMusicState();if(!t)return;let{emotion:e,beat:i,intensity:n}=t;if(e&&n<this.harmonyConfig.peacefulThreshold&&(this.breathingState.forestAtmosphere=Math.max(this.breathingState.forestAtmosphere,(1-n)*.6),i&&i.tempo)){let r=Math.max(.5,Math.min(1.2,60/i.tempo));this.breathingState.breathingFrequency=.4*r}}updateOrganicBreathing(){let t=this.getCurrentSeason(),e=this.naturalPalettes[t],i={earthyWarm:this.blendNaturalColors(e.earthyWarm,e.sunsetGlow,this.breathingState.naturalWarmth),forestGreen:e.forestGreen,skyBlue:e.skyBlue,sunsetGlow:e.sunsetGlow,stoneGray:e.stoneGray,organicTransparency:.85+this.breathingState.serenityLevel*.15};this.updateNaturalCSSVariables(i)}getCurrentSeason(){let e=this.animationState.seasonalPhase%(2*Math.PI)/(2*Math.PI);return e<.25?"spring-awakening":e<.5?"summer-warmth":e<.75?"autumn-grounding":"winter-peace"}blendNaturalColors(t,e,i){let n=Math.max(0,Math.min(1,i));return{r:Math.round(t.r*(1-n)+e.r*n),g:Math.round(t.g*(1-n)+e.g*n),b:Math.round(t.b*(1-n)+e.b*n)}}generateNaturalColors(t,e){let i=this.naturalPalettes["spring-awakening"];return e<4e3?i=this.naturalPalettes["winter-peace"]:e>7e3?i=this.naturalPalettes["summer-warmth"]:e>5500&&(i=this.naturalPalettes["autumn-grounding"]),{earthyWarm:i.earthyWarm,forestGreen:i.forestGreen,skyBlue:i.skyBlue,sunsetGlow:i.sunsetGlow,stoneGray:i.stoneGray,organicTransparency:this.breathingState.harmonyResonance}}updateNaturalColors(t){this.cssConsciousnessController.queueCSSVariableUpdate("--natural-earthy-r",t.earthyWarm.r.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--natural-earthy-g",t.earthyWarm.g.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--natural-earthy-b",t.earthyWarm.b.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--natural-forest-r",t.forestGreen.r.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--natural-forest-g",t.forestGreen.g.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--natural-forest-b",t.forestGreen.b.toString())}async initializeNaturalElements(){let t=[".main-view-container",".Root__now-playing-bar",".main-trackInfo-container",".progress-bar",".Root__nav-bar"];for(let e of t){let i=document.querySelectorAll(e);for(let n of i){let r=`natural-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;this.naturalElements.set(r,n)}}}setupNaturalCSSVariables(){let t={"--natural-earthy-r":"166","--natural-earthy-g":"227","--natural-earthy-b":"161","--natural-forest-r":"64","--natural-forest-g":"160","--natural-forest-b":"43","--natural-sky-r":"137","--natural-sky-g":"220","--natural-sky-b":"235","--natural-serenity-level":"0","--natural-breathing-frequency":"0.4","--natural-earth-connection":"0","--natural-breathing-depth":"0.8","--natural-seasonal-shift":"0"};for(let[e,i]of Object.entries(t))this.cssConsciousnessController.queueCSSVariableUpdate(e,i)}updateNaturalCSSVariables(t){this.cssConsciousnessController.queueCSSVariableUpdate("--natural-serenity-level",this.breathingState.serenityLevel.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--natural-breathing-frequency",this.breathingState.breathingFrequency.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--natural-earth-connection",this.breathingState.earthConnection.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--natural-breathing-depth",this.breathingState.organicDepth.toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--natural-seasonal-shift",this.breathingState.seasonalShift.toString());let e=Math.sin(this.animationState.breathingPhase)*this.breathingState.organicDepth;this.cssConsciousnessController.queueCSSVariableUpdate("--natural-breathing-phase",e.toString())}updateNaturalElements(){for(let[t,e]of this.naturalElements)this.updateNaturalElement(e)}updateNaturalElement(t){this.breathingState.serenityLevel>.1&&this.applyNaturalBreathing(t),this.breathingState.earthConnection>.1&&this.applyEarthConnection(t),this.breathingState.forestAtmosphere>.1&&this.applyForestAtmosphere(t)}applyNaturalBreathing(t){let e=this.breathingState.serenityLevel,i=Math.sin(this.animationState.breathingPhase),n=1+i*e*.02,r=.9+i*e*.1;t.style.transform=`scale(${n})`,t.style.opacity=r.toString();let a=e*(i*.5+.5)*.3;t.style.boxShadow=`
      0 0 ${a*20}px rgba(var(--natural-earthy-r), var(--natural-earthy-g), var(--natural-earthy-b), ${a*.5}),
      inset 0 0 ${a*10}px rgba(var(--natural-forest-r), var(--natural-forest-g), var(--natural-forest-b), ${a*.3})
    `}applyEarthConnection(t){let e=this.breathingState.earthConnection;t.style.border=`1px solid rgba(var(--natural-earthy-r), var(--natural-earthy-g), var(--natural-earthy-b), ${e*.4})`,t.style.background=`
      ${t.style.background||""},
      linear-gradient(180deg,
        rgba(var(--natural-earthy-r), var(--natural-earthy-g), var(--natural-earthy-b), ${e*.05}) 0%,
        rgba(var(--natural-forest-r), var(--natural-forest-g), var(--natural-forest-b), ${e*.08}) 100%
      )
    `}applyForestAtmosphere(t){let e=this.breathingState.forestAtmosphere,i=this.animationState.organicPhase,n=Math.sin(i*.8)*e*1;t.style.transform+=` translateY(${n}px)`;let r=Math.sin(i*.5)*e*5;t.style.filter=`hue-rotate(${r}deg) saturate(${1+e*.2})`}createSeasonalTransition(t,e,i){let n=performance.now(),r=a=>{let s=a-n,o=Math.min(1,s/i),l=.5*(1-Math.cos(o*Math.PI));this.breathingState.seasonalShift=l,o<1&&requestAnimationFrame(r)};requestAnimationFrame(r)}startNaturalBreathing(){this.animationState.isAnimating=!0,this.animationState.lastFrameTime=performance.now();let t=e=>{if(!this.animationState.isAnimating)return;let i=e-this.animationState.lastFrameTime;this.animationState.lastFrameTime=e,this.updateAnimation(i),requestAnimationFrame(t)};requestAnimationFrame(t)}updatePerformanceMetrics(t){this.performanceMetrics.averageProcessingTime=this.performanceMetrics.averageProcessingTime*.9+t*.1}forceRepaint(t){console.log(`[NaturalHarmonyEngine] Force repaint triggered: ${t||"Unknown"}`),this.updateNaturalElements(),this.cssConsciousnessController.flushCSSVariableBatch()}destroy(){console.log("[NaturalHarmonyEngine] Returning to natural silence..."),this.animationState.isAnimating=!1,this.naturalElements.clear(),this.breathingState={serenityLevel:0,breathingFrequency:.4,organicDepth:.8,earthConnection:0,naturalWarmth:.7,forestAtmosphere:0,seasonalShift:0,harmonyResonance:0},this.initialized=!1}getBreathingState(){return{...this.breathingState}}getNaturalConfig(){return{...this.harmonyConfig}}getPerformanceMetrics(){return{...this.performanceMetrics,naturalElementCount:this.naturalElements.size}}setPeacefulThreshold(t){this.harmonyConfig.peacefulThreshold=Math.max(0,Math.min(1,t))}setBreathingDepth(t){this.breathingState.organicDepth=Math.max(0,Math.min(1,t))}setEarthyColorStrength(t){this.harmonyConfig.earthyColorStrength=Math.max(0,Math.min(1,t))}}});var Rt,zs=y(()=>{"use strict";fs();de();A();Ss();Ps();Ts();xs();As();Rs();Ds();ks();Ls();Bs();Fs();Gs();Hs();Os();Rt=class{constructor(t,e,i,n,r,a,s,o,l,m){this.colorHarmonyEngine=null;this.eventBus=null;this.animationCoordinator=null;this.isInitialized=!1;this.lastHealthCheck=null;this.boundAdaptationHandler=null;this.boundSettingsHandler=null;this.healthCheckInterval=null;this.metricsUpdateInterval=null;this.onSystemAdaptation=null;this.onHealthChange=null;this.onSystemCreated=null;this.config=t,this.utils=e,this.year3000System=i,this.cssConsciousnessController=n,this.performanceAnalyzer=r,this.musicSyncService=a,this.settingsManager=s,this.colorHarmonyEngine=o||null,this.eventBus=l||null,this.animationCoordinator=m||null,this.deviceDetector=new _,this.systemRegistry=new Map,this.systemCache=new Map,this.systemDependencies=new Map,this.bridgeConfig={mode:"progressive",enablePerformanceMonitoring:!0,enableAdaptiveQuality:!0,enableEventCoordination:!0,performanceThresholds:{minFPS:45,maxMemoryMB:50,thermalLimit:70},qualityPreferences:{preferHighQuality:!0,allowDynamicScaling:!0,batteryConservation:!1}},this.currentMetrics=this.createInitialMetrics(),this.boundAdaptationHandler=this.handleAdaptationEvent.bind(this),this.boundSettingsHandler=this.handleSettingsChange.bind(this),this.registerVisualSystems(),u?.debug?.log("VisualSystemFacade","Factory facade initialized with visual systems")}registerVisualSystems(){this.systemRegistry.set("SidebarConsciousness",Bi),this.systemDependencies.set("SidebarConsciousness",["eventBus","musicSyncService"]),this.systemRegistry.set("UIEffectsConsciousness",ki),this.systemDependencies.set("UIEffectsConsciousness",["eventBus","musicSyncService","cssConsciousnessController"]),this.systemRegistry.set("HeaderConsciousness",Li),this.systemDependencies.set("HeaderConsciousness",["eventBus","musicSyncService","colorHarmonyEngine"]),this.systemRegistry.set("WebGLBackground",Ri),this.systemDependencies.set("WebGLBackground",["performanceAnalyzer","eventBus"]),this.systemRegistry.set("CSSBlobFallback",Di),this.systemDependencies.set("CSSBlobFallback",["performanceAnalyzer","musicSyncService","settingsManager"]),this.systemRegistry.set("OrganicBeatSync",Gi),this.systemDependencies.set("OrganicBeatSync",["performanceAnalyzer","cssConsciousnessController","eventBus","musicSyncService","colorHarmonyEngine"]),this.systemRegistry.set("InteractionTracking",Oi),this.systemDependencies.set("InteractionTracking",["performanceAnalyzer","cssConsciousnessController"]),this.systemRegistry.set("SpotifyUIApplication",zi),this.systemDependencies.set("SpotifyUIApplication",["year3000System"]),this.systemRegistry.set("CinematicDrama",Ui),this.systemDependencies.set("CinematicDrama",["performanceAnalyzer","cssConsciousnessController","musicSyncService","colorHarmonyEngine","eventBus"]),this.systemRegistry.set("EtherealBeauty",Vi),this.systemDependencies.set("EtherealBeauty",["performanceAnalyzer","cssConsciousnessController","musicSyncService","colorHarmonyEngine","eventBus"]),this.systemRegistry.set("NaturalHarmony",_i),this.systemDependencies.set("NaturalHarmony",["performanceAnalyzer","cssConsciousnessController","musicSyncService","colorHarmonyEngine","eventBus"]),this.systemRegistry.set("GradientConductor",Fi),this.systemDependencies.set("GradientConductor",["cssConsciousnessController","colorHarmonyEngine","musicSyncService","performanceAnalyzer","eventBus"]),this.systemRegistry.set("CSSAnimationManager",Ai),this.systemDependencies.set("CSSAnimationManager",["cssConsciousnessController","animationCoordinator"])}async initialize(t){if(this.isInitialized){u?.debug?.warn("VisualSystemFacade","Already initialized");return}try{this.bridgeConfig={...this.bridgeConfig,...t},await this.deviceDetector.initialize(),await this.applyConfiguration(),this.subscribeToEvents(),this.startMonitoring(),await this.performVisualHealthCheck(),this.isInitialized=!0,this.cssConsciousnessController.queueCSSVariableUpdate("--sn-visual-bridge-active","1"),this.cssConsciousnessController.queueCSSVariableUpdate("--sn-visual-bridge-mode",this.bridgeConfig.mode),u?.debug?.log("VisualSystemFacade","Facade fully initialized",{mode:this.bridgeConfig.mode,systemsRegistered:this.systemRegistry.size,performanceMonitoring:this.bridgeConfig.enablePerformanceMonitoring})}catch(e){throw u?.debug?.error("VisualSystemFacade","Initialization failed:",e),await this.cleanup(),e}}getVisualSystem(t){if(this.systemCache.has(t))return this.systemCache.get(t);let e=this.createVisualSystem(t);return this.systemCache.set(t,e),this.currentMetrics.activeVisualSystems.push(t),this.onSystemCreated&&this.onSystemCreated(t,e),e}createVisualSystem(t){let e=this.systemRegistry.get(t);if(!e)throw new Error(`Visual system '${t}' not found in registry`);let i=new e(this.config);if(typeof i._baseInitialize=="function"){let r=i;return this.injectUnifiedSystemDependencies(r,t),r}if(t==="SpotifyUIApplication"){let r=new e(this.year3000System);return this.injectDependencies(r,t),r}if(t==="GradientConductor"){let r=new e(this.eventBus,this.cssConsciousnessController,this.colorHarmonyEngine,this.musicSyncService,this.performanceAnalyzer,{});return this.injectDependencies(r,t),r}if(t==="CSSAnimationManager"){let r=new e(this.config,this.cssConsciousnessController,this.animationCoordinator);return this.injectDependencies(r,t),r}if(t==="CinematicDrama"||t==="EtherealBeauty"||t==="NaturalHarmony"){let r=new Ii,a=new Hi(r,this.settingsManager,this.musicSyncService),s=new e(a,this.cssConsciousnessController,this.musicSyncService);return this.injectDependencies(s,t),s}let n=new e(this.config,this.utils,this.performanceAnalyzer,this.musicSyncService,this.settingsManager,this.year3000System);return this.injectDependencies(n,t),n}injectDependencies(t,e){let i=this.systemDependencies.get(e)||[];i.includes("performanceAnalyzer")&&t.setPerformanceAnalyzer&&t.setPerformanceAnalyzer(this.performanceAnalyzer),i.includes("cssConsciousnessController")&&t.setOptimizedCSSVariableManager&&t.setOptimizedCSSVariableManager(this.cssConsciousnessController),i.includes("eventBus")&&this.eventBus&&t.setEventBus&&t.setEventBus(this.eventBus),this.colorHarmonyEngine&&t.setColorHarmonyEngine&&t.setColorHarmonyEngine(this.colorHarmonyEngine),i.includes("musicSyncService")&&t.setMusicSyncService&&t.setMusicSyncService(this.musicSyncService),i.includes("animationCoordinator")&&this.animationCoordinator&&t.setAnimationCoordinator&&t.setAnimationCoordinator(this.animationCoordinator),this.integratePerformanceMonitoring(t,e)}injectUnifiedSystemDependencies(t,e){this.cssConsciousnessController&&(t.cssConsciousnessController=this.cssConsciousnessController),this.performanceAnalyzer&&(t.performanceAnalyzer=this.performanceAnalyzer),this.year3000System&&(globalThis.year3000System=this.year3000System),this.integratePerformanceMonitoring(t,e)}integratePerformanceMonitoring(t,e){if(!this.bridgeConfig.enablePerformanceMonitoring)return;let i=t.updateAnimation;typeof i=="function"&&(t.updateAnimation=r=>{let a=performance.now();i.call(t,r);let s=performance.now();this.performanceAnalyzer.recordMetric(`Visual_${e}`,s-a)});let n=t.onAnimate;typeof n=="function"&&(t.onAnimate=r=>{let a=performance.now();n.call(t,r);let s=performance.now();this.performanceAnalyzer.recordMetric(`Visual_${e}_Animate`,s-a)})}adaptiveQualityControl(t,e){this.eventBus&&(this.eventBus.subscribe("performance:degradation",i=>{t.reduceQuality&&t.reduceQuality(i.reductionLevel)}),this.eventBus.subscribe("performance:improvement",i=>{t.increaseQuality&&t.increaseQuality(i.improvementLevel)}))}handleAdaptationEvent(t){u?.debug?.log("VisualSystemFacade",`Adaptation event: ${t.type}`,t.reason),this.currentMetrics.currentQuality=t.newSettings,this.systemCache.forEach((e,i)=>{e.handleAdaptationEvent&&e.handleAdaptationEvent(t)}),this.onSystemAdaptation&&this.onSystemAdaptation(this.currentMetrics),this.cssConsciousnessController.queueCSSVariableUpdate("--sn-adaptive-quality",(t.newSettings.gradientComplexity||0).toString()),this.cssConsciousnessController.queueCSSVariableUpdate("--sn-adaptive-fps",(t.newSettings.animationFPS||60).toString())}propagateVisualEvent(t){this.bridgeConfig.enableEventCoordination&&(this.systemCache.forEach((e,i)=>{if(e.handleVisualEvent)try{e.handleVisualEvent(t)}catch(n){u?.debug?.warn("VisualSystemFacade",`Error propagating event to ${i}:`,n)}}),this.currentMetrics.eventCount++,this.currentMetrics.lastEventTime=performance.now())}async initializeVisualSystems(){let t=Array.from(this.systemCache.entries()).map(async([n,r])=>{try{return typeof r._baseInitialize=="function"?await r._baseInitialize():await r.initialize(),u?.debug?.log("VisualSystemFacade",`Initialized visual system: ${n}`),{key:n,success:!0}}catch(a){return u?.debug?.error("VisualSystemFacade",`Failed to initialize ${n}:`,a),{key:n,success:!1,error:a}}}),e=await Promise.allSettled(t),i=e.filter(n=>n.status==="fulfilled"&&n.value.success).length;u?.debug?.log("VisualSystemFacade",`Visual systems initialized: ${i}/${e.length}`),await this.registerQualityScalingSystems()}async registerQualityScalingSystems(){try{let t=this.year3000System?.getCachedNonVisualSystem?.("SimplePerformanceCoordinator"),e=this.year3000System?.getCachedNonVisualSystem?.("QualityScalingManager");if(!t){u?.debug?.warn("VisualSystemFacade","SimplePerformanceCoordinator not available for quality scaling registration");return}if(!e){u?.debug?.warn("VisualSystemFacade","QualityScalingManager not available for quality scaling registration");return}for(let[i,n]of this.systemCache.entries())try{let r=n;typeof r.setQualityLevel=="function"&&typeof r.getPerformanceImpact=="function"&&typeof r.getQualityCapabilities=="function"&&(t.registerSystem(i,r),e.registerSystem(i,r),u?.debug?.log("VisualSystemFacade",`Registered ${i} for quality scaling and performance orchestration`))}catch(r){u?.debug?.error("VisualSystemFacade",`Failed to register ${i} for quality scaling:`,r)}await this.initializeConsciousnessAwareAdaptation(e)}catch(t){u?.debug?.error("VisualSystemFacade","Failed to register quality scaling systems:",t)}}async initializeConsciousnessAwareAdaptation(t){try{let e=this.year3000System?.getCachedNonVisualSystem?.("MusicSyncService");if(!e){u?.debug?.warn("VisualSystemFacade","MusicSyncService not available for consciousness-aware adaptation");return}let i=setInterval(()=>{try{let n=e.getOverallIntensity?.()||.5,r=e.getBeatStrength?.()||.5;t.adaptToConsciousnessState(n,r)}catch(n){u?.debug?.error("VisualSystemFacade","Error in consciousness-aware adaptation:",n)}},2e3);this._consciousnessAdaptationInterval=i,u?.debug?.log("VisualSystemFacade","Consciousness-aware quality adaptation initialized")}catch(e){u?.debug?.error("VisualSystemFacade","Failed to initialize consciousness-aware adaptation:",e)}}async performVisualHealthCheck(){let t={overall:"good",systems:new Map,recommendations:[],timestamp:performance.now()},e=0,i=0;for(let[r,a]of this.systemCache){i++;try{let s=a.healthCheck?await a.healthCheck():{status:"unknown",message:"No health check available"},o=s.status==="healthy"||s.status==="good";o&&e++,t.systems.set(r,{ok:o,details:s.message||s.details||"System operational"})}catch(s){t.systems.set(r,{ok:!1,details:`Health check failed: ${s}`})}}let n=i>0?e/i:1;return n>=.9?t.overall="excellent":n>=.7?t.overall="good":n>=.5?(t.overall="degraded",t.recommendations.push("Some visual systems are experiencing issues")):(t.overall="critical",t.recommendations.push("Multiple visual system failures detected")),this.currentMetrics.currentFPS<30&&t.recommendations.push("Low FPS detected - consider reducing visual quality"),this.currentMetrics.memoryUsageMB>40&&t.recommendations.push("High memory usage - consider optimizing visual systems"),this.lastHealthCheck=t,this.cssConsciousnessController.queueCSSVariableUpdate("--sn-visual-health",t.overall),t}createInitialMetrics(){return{currentFPS:0,averageFPS:0,frameTime:0,memoryUsageMB:0,systemHealth:"good",activeVisualSystems:[],currentQuality:{gradientComplexity:.6,particleDensity:.6,shaderPrecision:"medium",textureResolution:1,animationFPS:60,transitionQuality:"smooth",motionBlur:!1,bloomEnabled:!0,shadowQuality:"medium",antiAliasing:"fxaa",postProcessing:!0},adaptiveScaling:!0,performanceMonitoring:!0,eventCoordination:!0,lastEventTime:0,eventCount:0}}async applyConfiguration(){}subscribeToEvents(){this.settingsManager&&this.boundSettingsHandler&&document.addEventListener("year3000SystemSettingsChanged",this.boundSettingsHandler)}startMonitoring(){this.bridgeConfig.enablePerformanceMonitoring&&(this.healthCheckInterval=window.setInterval(async()=>{await this.performVisualHealthCheck()},1e4),this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},1e3))}updateMetrics(){this.currentMetrics.currentFPS=this.performanceAnalyzer.getMedianFPS()||0,this.currentMetrics.frameTime=this.currentMetrics.currentFPS>0?1e3/this.currentMetrics.currentFPS:1e3;let t=performance.memory;t&&(this.currentMetrics.memoryUsageMB=t.usedJSHeapSize/(1024*1024)),this.currentMetrics.currentFPS<20?this.currentMetrics.systemHealth="critical":this.currentMetrics.currentFPS<30?this.currentMetrics.systemHealth="degraded":this.currentMetrics.currentFPS>55?this.currentMetrics.systemHealth="excellent":this.currentMetrics.systemHealth="good"}handleSettingsChange(t){let e=t,{key:i,value:n}=e.detail;i.startsWith("sn-visual-")&&this.updateConfigurationFromSettings(i,n)}updateConfigurationFromSettings(t,e){switch(t){case"sn-visual-quality":this.bridgeConfig.qualityPreferences.preferHighQuality=e==="high";break;case"sn-visual-performance":this.bridgeConfig.enableAdaptiveQuality=e==="adaptive";break}}async cleanup(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this._consciousnessAdaptationInterval&&(clearInterval(this._consciousnessAdaptationInterval),this._consciousnessAdaptationInterval=null),this.boundSettingsHandler&&document.removeEventListener("year3000SystemSettingsChanged",this.boundSettingsHandler),this.cssConsciousnessController.queueCSSVariableUpdate("--sn-visual-bridge-active","0")}getMetrics(){return{...this.currentMetrics}}getLastHealthCheck(){return this.lastHealthCheck}getConfiguration(){return{...this.bridgeConfig}}async setConfiguration(t){this.bridgeConfig={...this.bridgeConfig,...t},await this.applyConfiguration()}setOnSystemAdaptation(t){this.onSystemAdaptation=t}setOnHealthChange(t){this.onHealthChange=t}setOnSystemCreated(t){this.onSystemCreated=t}getSystemStatus(){return{initialized:this.isInitialized,systemsActive:this.systemCache.size,healthy:this.currentMetrics.systemHealth==="excellent"||this.currentMetrics.systemHealth==="good"}}async destroy(){await this.cleanup(),this.isInitialized=!1,this.systemCache.clear(),u?.debug?.log("VisualSystemFacade","Facade destroyed")}}});var Dt,Us=y(()=>{"use strict";zn();oi();N();ys();Qn();hi();Xn();de();yi();A();ke();An();zs();Dt=class{constructor(t,e,i){this.visualBridge=null;this.nonVisualFacade=null;this.sharedUnifiedCSSVariableManager=null;this.sharedSimplePerformanceCoordinator=null;this.sharedWebGLSystemsIntegration=null;this.sharedEnhancedDeviceTierDetector=null;this.sharedDeviceCapabilityDetector=null;this.sharedPerformanceBudgetManager=null;this.sharedMusicSyncService=null;this.sharedSettingsManager=null;this.sharedColorHarmonyEngine=null;this.sharedSemanticColorManager=null;this.isInitialized=!1;this.lastHealthCheck=null;this.colorDependentSystems=new Set;this.colorSystemRefreshCallbacks=new Map;this.currentPhase="core";this.systemStates=new Map;this.phaseCompletionPromises=new Map;this.systemDependencies=new Map;this.initializationOrder=new Map;this.eventBus=null;this.crossFacadeEventListeners=new Map;this.healthCheckInterval=null;this.metricsUpdateInterval=null;this.onSystemCreated=null;this.onHealthChange=null;this.onPerformanceChange=null;this.config=t,this.utils=e,this.year3000System=i,this.coordinationConfig={mode:"unified",enableSharedDependencies:!0,enableCrossFacadeCommunication:!0,enableUnifiedPerformanceMonitoring:!0,enableResourceOptimization:!0,orchestration:{enforceSequentialInitialization:!0,dependencyValidation:!0,enableInitializationGates:!0,systemReadinessTimeout:5e3,phaseTransitionTimeout:1e4},performanceThresholds:{maxTotalMemoryMB:150,maxTotalInitTime:8e3,maxCrossCommLatency:10},coordinationPreferences:{preferSharedResources:!0,enableEventPropagation:!0,enableHealthCoordination:!0}},this.setupOrchestrationPhases(),this.currentMetrics=this.createInitialMetrics(),u?.debug?.log("SystemCoordinator","System coordinator initialized")}async initialize(t){if(this.isInitialized){u?.debug?.warn("SystemCoordinator","Already initialized");return}try{let e=performance.now();this.coordinationConfig={...this.coordinationConfig,...t},this.coordinationConfig.orchestration.enforceSequentialInitialization?(u?.debug?.log("SystemCoordinator","Starting orchestrated initialization"),await this.executeOrchestredInitialization()):(u?.debug?.log("SystemCoordinator","Starting legacy initialization"),await this.executeLegacyInitialization());let i=performance.now();this.currentMetrics.totalInitTime=i-e,this.isInitialized=!0,u?.debug?.log("SystemCoordinator","System coordination fully initialized",{mode:this.coordinationConfig.mode,orchestrationEnabled:this.coordinationConfig.orchestration.enforceSequentialInitialization,currentPhase:this.currentPhase,visualSystems:this.currentMetrics.visualSystems,nonVisualSystems:this.currentMetrics.nonVisualSystems,initTime:this.currentMetrics.totalInitTime})}catch(e){throw u?.debug?.error("SystemCoordinator","Initialization failed:",e),await this.cleanup(),e}}async initializeSharedDependencies(){if(this.coordinationConfig.enableSharedDependencies){u?.debug?.log("SystemCoordinator","Initializing simplified shared dependencies");try{this.sharedDeviceCapabilityDetector=new _({enableDebug:!0,spicetifyContext:!0}),await this.sharedDeviceCapabilityDetector.initialize(),this.sharedEnhancedDeviceTierDetector=new he,this.sharedWebGLSystemsIntegration=new Xe(this.sharedDeviceCapabilityDetector),await this.sharedWebGLSystemsIntegration.initialize(),this.sharedDeviceCapabilityDetector=new _({enableDebug:this.config.enableDebug||!1,runStressTests:!1}),await this.sharedDeviceCapabilityDetector.initialize(),this.sharedPerformanceBudgetManager=new we({budgets:{animationFrame:16,cssVariableUpdate:2,domObservation:1,audioAnalysis:5,visualEffects:8,userInteraction:100},autoOptimize:{enabled:!0,violationThreshold:3,recoveryThreshold:.8},enableDebug:this.config.enableDebug||!1},this.sharedSimplePerformanceCoordinator),this.sharedSimplePerformanceCoordinator=new Ge(this.sharedEnhancedDeviceTierDetector,this.sharedWebGLSystemsIntegration),await this.sharedSimplePerformanceCoordinator.initialize();try{let t=this.sharedSimplePerformanceCoordinator;this.sharedUnifiedCSSVariableManager=new Re(this.config,t,{enableAdaptiveThrottling:!0,batchIntervalMs:16,maxBatchSize:50,priorityMappings:{critical:["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift","--sn-cosmic-base-hex","--sn-cosmic-accent-hex"],high:["--sn-gradient-primary","--sn-gradient-secondary","--sn-gradient-accent","--sn-color-base-hex","--sn-color-accent-hex"],normal:["--sn-gradient-","--sn-rs-","--sn-color-"],low:["--sn-debug-","--sn-dev-","--sn-meta-"]},thresholds:{excellentFPS:55,goodFPS:45,poorFPS:30}}),xn(this.sharedUnifiedCSSVariableManager),await this.sharedUnifiedCSSVariableManager.initialize()}catch(t){u?.debug?.warn("SystemCoordinator","Failed to initialize OptimizedCSSVariableManager:",t),this.sharedUnifiedCSSVariableManager=null}this.sharedSettingsManager=new ee,await this.sharedSettingsManager.initialize(),this.sharedMusicSyncService=new ve,await this.sharedMusicSyncService.initialize(),this.sharedColorHarmonyEngine=new Ke(this.config,this.utils,this.sharedSimplePerformanceCoordinator,this.sharedSettingsManager),await this.sharedColorHarmonyEngine.initialize(),u?.debug?.log("SystemCoordinator","Shared dependencies initialized successfully")}catch(t){throw u?.debug?.error("SystemCoordinator","Failed to initialize shared dependencies:",t),t}}}async initializeFacades(){u?.debug?.log("SystemCoordinator","Initializing facades");try{let t=this.nonVisualFacade?.getCachedSystem("EnhancedMasterAnimationCoordinator")||null;this.visualBridge=new Rt(this.config,this.utils,this.year3000System,this.sharedUnifiedCSSVariableManager,this.sharedSimplePerformanceCoordinator,this.sharedMusicSyncService,this.sharedSettingsManager,this.sharedColorHarmonyEngine,this.eventBus,t),await this.visualBridge.initialize({mode:this.coordinationConfig.mode==="performance-optimized"?"performance-first":"progressive",enablePerformanceMonitoring:this.coordinationConfig.enableUnifiedPerformanceMonitoring,enableEventCoordination:this.coordinationConfig.enableCrossFacadeCommunication}),this.visualBridge.setOnSystemCreated((e,i)=>{this.handleSystemCreated("visual",e,i)}),this.nonVisualFacade=new It(this.config,this.utils,this.year3000System),await this.nonVisualFacade.initialize({mode:this.coordinationConfig.mode==="performance-optimized"?"performance-first":"progressive",enablePerformanceMonitoring:this.coordinationConfig.enableUnifiedPerformanceMonitoring,enableDependencyInjection:this.coordinationConfig.enableSharedDependencies}),this.nonVisualFacade.setOnSystemCreated((e,i)=>{this.handleSystemCreated("non-visual",e,i)}),this.injectSharedDependencies(),u?.debug?.log("SystemCoordinator","Facades initialized successfully")}catch(t){throw u?.debug?.error("SystemCoordinator","Failed to initialize facades:",t),t}}injectSharedDependencies(){!this.coordinationConfig.enableSharedDependencies||!this.nonVisualFacade||(this.sharedSimplePerformanceCoordinator&&(this.nonVisualFacade.simplePerformanceCoordinator=this.sharedSimplePerformanceCoordinator),this.sharedWebGLSystemsIntegration&&(this.nonVisualFacade.webglSystemsIntegration=this.sharedWebGLSystemsIntegration),this.sharedEnhancedDeviceTierDetector&&(this.nonVisualFacade.enhancedDeviceTierDetector=this.sharedEnhancedDeviceTierDetector),this.sharedSimplePerformanceCoordinator&&(this.nonVisualFacade.performanceAnalyzer=this.sharedSimplePerformanceCoordinator),this.sharedUnifiedCSSVariableManager&&(this.nonVisualFacade.cssConsciousnessController=this.sharedUnifiedCSSVariableManager),this.sharedMusicSyncService&&(this.nonVisualFacade.musicSyncService=this.sharedMusicSyncService),this.sharedSettingsManager&&(this.nonVisualFacade.settingsManager=this.sharedSettingsManager),this.sharedColorHarmonyEngine&&(this.nonVisualFacade.colorHarmonyEngine=this.sharedColorHarmonyEngine),this.sharedSemanticColorManager&&(this.nonVisualFacade.semanticColorManager=this.sharedSemanticColorManager))}setupCrossFacadeCommunication(){this.coordinationConfig.enableCrossFacadeCommunication&&(u?.debug?.log("SystemCoordinator","Setting up cross-facade communication"),this.addEventListener("visual-event",t=>{this.visualBridge&&this.visualBridge.propagateVisualEvent(t)}),this.addEventListener("performance-event",t=>{this.visualBridge&&this.visualBridge.handleAdaptationEvent(t)}),this.coordinationConfig.coordinationPreferences.enableHealthCoordination&&this.addEventListener("health-degradation",t=>{this.handleHealthDegradation(t)}))}handleSystemCreated(t,e,i){t==="visual"?this.currentMetrics.visualSystems++:this.currentMetrics.nonVisualSystems++,this.currentMetrics.activeSystems++,this.onSystemCreated&&this.onSystemCreated(t,e,i),u?.debug?.log("SystemCoordinator",`System created: ${t}/${e}`)}handleHealthDegradation(t){u?.debug?.warn("SystemCoordinator","Health degradation detected:",t),this.coordinationConfig.mode==="performance-optimized"&&this.optimizeForPerformance()}optimizeForPerformance(){this.visualBridge&&this.visualBridge.setConfiguration({mode:"performance-first",enableAdaptiveQuality:!0,qualityPreferences:{preferHighQuality:!1,allowDynamicScaling:!0,batteryConservation:!0}}),this.nonVisualFacade&&this.nonVisualFacade.setConfiguration({mode:"performance-first",systemPreferences:{lazyInitialization:!0,aggressiveCaching:!0,performanceOptimization:!0}})}getVisualSystem(t){return this.visualBridge?this.visualBridge.getVisualSystem(t):null}getCachedNonVisualSystem(t){return this.nonVisualFacade?this.nonVisualFacade.getCachedSystem(t):null}async getNonVisualSystem(t){return this.nonVisualFacade?await this.nonVisualFacade.getSystem(t):null}async getSystem(t){if(this.visualBridge)try{return this.visualBridge.getVisualSystem(t)}catch{}if(this.nonVisualFacade)try{return await this.nonVisualFacade.getSystem(t)}catch{}return null}addEventListener(t,e){this.crossFacadeEventListeners.has(t)||this.crossFacadeEventListeners.set(t,[]),this.crossFacadeEventListeners.get(t).push(e)}removeEventListener(t,e){let i=this.crossFacadeEventListeners.get(t);if(i){let n=i.indexOf(e);n!==-1&&i.splice(n,1)}}emitEvent(t,e){let i=this.crossFacadeEventListeners.get(t);i&&i.forEach(n=>{try{n(e)}catch(r){u?.debug?.error("SystemCoordinator",`Error in event listener for ${t}:`,r)}}),this.currentMetrics.crossFacadeEvents++}async performHealthCheck(){let t={overall:"good",facades:{visual:{ok:!0,details:"Visual systems operational",systemCount:0},nonVisual:{ok:!0,details:"Non-visual systems operational",systemCount:0}},sharedResources:{simplePerformanceCoordinator:{ok:!0,details:"Simple performance coordinator operational"},cssConsciousnessController:{ok:!0,details:"CSS variable batcher operational"},musicSyncService:{ok:!0,details:"Music sync service operational"},performanceAnalyzer:{ok:!0,details:"Legacy performance analyzer operational"}},recommendations:[],timestamp:performance.now()};if(this.visualBridge)try{let n=await this.visualBridge.performVisualHealthCheck();t.facades.visual.ok=n.overall==="excellent"||n.overall==="good",t.facades.visual.details=`Visual systems: ${n.overall}`,t.facades.visual.systemCount=n.systems.size}catch(n){t.facades.visual.ok=!1,t.facades.visual.details=`Visual facade error: ${n}`}if(this.nonVisualFacade)try{let n=await this.nonVisualFacade.performHealthCheck();t.facades.nonVisual.ok=n.overall==="excellent"||n.overall==="good",t.facades.nonVisual.details=`Non-visual systems: ${n.overall}`,t.facades.nonVisual.systemCount=n.systems.size}catch(n){t.facades.nonVisual.ok=!1,t.facades.nonVisual.details=`Non-visual facade error: ${n}`}if(this.sharedSimplePerformanceCoordinator)try{let n=await this.sharedSimplePerformanceCoordinator.healthCheck();t.sharedResources.simplePerformanceCoordinator.ok=n.healthy,t.sharedResources.simplePerformanceCoordinator.details=n.details||"Simple performance coordinator operational"}catch(n){t.sharedResources.simplePerformanceCoordinator.ok=!1,t.sharedResources.simplePerformanceCoordinator.details=`Simple performance coordinator error: ${n}`}if(this.sharedSimplePerformanceCoordinator)try{let n=await this.sharedSimplePerformanceCoordinator.healthCheck();t.sharedResources.performanceAnalyzer={ok:n.healthy,details:n.details||"Simple performance coordinator operational"}}catch(n){t.sharedResources.performanceAnalyzer={ok:!1,details:`Simple performance coordinator error: ${n}`}}if(this.sharedUnifiedCSSVariableManager)try{let n=await this.sharedUnifiedCSSVariableManager.healthCheck();t.sharedResources.cssConsciousnessController.ok=n.healthy||n.ok||!1,t.sharedResources.cssConsciousnessController.details=n.details||"CSS consciousness controller operational"}catch(n){t.sharedResources.cssConsciousnessController.ok=!1,t.sharedResources.cssConsciousnessController.details=`CSS consciousness controller error: ${n}`}if(this.sharedMusicSyncService)try{let n=await this.sharedMusicSyncService.healthCheck();t.sharedResources.musicSyncService.ok=n.status==="healthy",t.sharedResources.musicSyncService.details=n.message||"Music sync service operational"}catch(n){t.sharedResources.musicSyncService.ok=!1,t.sharedResources.musicSyncService.details=`Music sync service error: ${n}`}if(this.sharedSemanticColorManager)try{let n=await this.sharedSemanticColorManager.healthCheck(),r=n.healthy;t.sharedResources.semanticColorManager={ok:r,details:n.details||"Semantic color manager operational"}}catch(n){t.sharedResources.semanticColorManager={ok:!1,details:`Semantic color manager error: ${n}`}}let e=t.facades.visual.ok&&t.facades.nonVisual.ok,i=t.sharedResources.simplePerformanceCoordinator.ok&&t.sharedResources.cssConsciousnessController.ok&&t.sharedResources.musicSyncService.ok&&t.sharedResources.semanticColorManager?.ok!==!1&&t.sharedResources.performanceAnalyzer?.ok!==!1;return e&&i?t.overall="excellent":e||i?t.overall="good":(t.overall="critical",t.recommendations.push("Multiple system failures detected - consider system restart")),this.currentMetrics.totalMemoryMB>120&&t.recommendations.push("High memory usage - consider optimizing system memory"),this.currentMetrics.totalInitTime>6e3&&t.recommendations.push("High initialization time - consider optimizing system startup"),this.lastHealthCheck=t,this.onHealthChange&&this.onHealthChange(t),t}createInitialMetrics(){return{totalSystems:0,visualSystems:0,nonVisualSystems:0,activeSystems:0,failedSystems:0,totalMemoryMB:0,totalInitTime:0,averageSystemInitTime:0,crossFacadeLatency:0,overallHealth:"good",visualHealth:"good",nonVisualHealth:"good",sharedDependencies:6,crossFacadeEvents:0,resourceOptimization:0}}startMonitoring(){this.coordinationConfig.enableUnifiedPerformanceMonitoring&&(this.healthCheckInterval=window.setInterval(async()=>{await this.performHealthCheck()},2e4),this.metricsUpdateInterval=window.setInterval(()=>{this.updateMetrics()},2e3))}updateMetrics(){if(this.visualBridge){let e=this.visualBridge.getMetrics();this.currentMetrics.visualHealth=e.systemHealth}if(this.nonVisualFacade){let e=this.nonVisualFacade.getMetrics();this.currentMetrics.nonVisualHealth=e.systemHealth}let t=performance.memory;t&&(this.currentMetrics.totalMemoryMB=t.usedJSHeapSize/(1024*1024)),this.currentMetrics.visualHealth==="excellent"&&this.currentMetrics.nonVisualHealth==="excellent"?this.currentMetrics.overallHealth="excellent":this.currentMetrics.visualHealth==="critical"||this.currentMetrics.nonVisualHealth==="critical"?this.currentMetrics.overallHealth="critical":this.currentMetrics.visualHealth==="degraded"||this.currentMetrics.nonVisualHealth==="degraded"?this.currentMetrics.overallHealth="degraded":this.currentMetrics.overallHealth="good",this.onPerformanceChange&&this.onPerformanceChange(this.currentMetrics)}setupOrchestrationPhases(){this.systemDependencies.set("MusicSyncService",[]),this.systemDependencies.set("ColorHarmonyEngine",["MusicSyncService","SemanticColorManager"]),this.systemDependencies.set("PerformanceAnalyzer",[]),this.systemDependencies.set("UnifiedCSSVariableManager",["PerformanceAnalyzer"]),this.systemDependencies.set("SettingsManager",[]),this.systemDependencies.set("SemanticColorManager",["UnifiedCSSVariableManager"]),this.initializationOrder.set("core",["PerformanceAnalyzer","UnifiedCSSVariableManager"]),this.initializationOrder.set("services",["SettingsManager","MusicSyncService","SemanticColorManager"]),this.initializationOrder.set("visual-systems",["ColorHarmonyEngine"]),this.initializationOrder.set("integration",["VisualSystemFacade","NonVisualSystemFacade"]);for(let[t,e]of this.initializationOrder.entries())for(let i of e)this.systemStates.set(i,"uninitialized");u?.debug?.log("SystemCoordinator","Orchestration phases configured",{phases:Array.from(this.initializationOrder.keys()),totalSystems:this.systemStates.size,dependencies:Object.fromEntries(this.systemDependencies)})}async executeOrchestredInitialization(){let t=["core","services","visual-systems","integration"];for(let e of t){u?.debug?.log("SystemCoordinator",`Starting phase: ${e}`),this.currentPhase=e;try{await this.executePhase(e),u?.debug?.log("SystemCoordinator",`Phase ${e} completed successfully`)}catch(i){throw u?.debug?.error("SystemCoordinator",`Phase ${e} failed:`,i),new Error(`Orchestration failed at phase ${e}: ${i}`)}}this.currentPhase="completed",this.setupCrossFacadeCommunication(),await this.setupGradientSystemCoordination(),this.setupDefaultColorDependentSystems(),this.startMonitoring(),await this.performHealthCheck()}async executePhase(t){let e=this.initializationOrder.get(t);if(!e)throw new Error(`Unknown phase: ${t}`);let i=[];for(let n of e)i.push(this.initializeSystemWithDependencies(n));await Promise.all(i);for(let n of e){let r=this.systemStates.get(n);if(r!=="ready")throw new Error(`System ${n} not ready after phase ${t} (state: ${r})`)}}async initializeSystemWithDependencies(t){if(this.systemStates.get(t)!=="ready"){this.systemStates.set(t,"initializing");try{let e=this.systemDependencies.get(t)||[];for(let i of e)await this.waitForSystemReady(i);switch(t){case"PerformanceAnalyzer":await this.initializePerformanceAnalyzer();break;case"UnifiedCSSVariableManager":await this.initializeUnifiedCSSController();break;case"SettingsManager":await this.initializeSettingsManager();break;case"MusicSyncService":await this.initializeMusicSyncService();break;case"ColorHarmonyEngine":await this.initializeColorHarmonyEngine();break;case"SemanticColorManager":await this.initializeSemanticColorManager();break;case"VisualSystemFacade":await this.initializeVisualFacade();break;case"NonVisualSystemFacade":await this.initializeNonVisualFacade();break;default:throw new Error(`Unknown system: ${t}`)}this.systemStates.set(t,"ready"),u?.debug?.log("SystemCoordinator",`System ${t} initialized successfully`)}catch(e){throw this.systemStates.set(t,"failed"),u?.debug?.error("SystemCoordinator",`System ${t} initialization failed:`,e),e}}}async waitForSystemReady(t){let e=this.coordinationConfig.orchestration.systemReadinessTimeout,i=Date.now();for(;Date.now()-i<e;){let n=this.systemStates.get(t);if(n==="ready")return;if(n==="failed")throw new Error(`Dependency ${t} failed to initialize`);await new Promise(r=>setTimeout(r,50))}throw new Error(`Timeout waiting for dependency ${t} to be ready`)}async initializePerformanceAnalyzer(){this.sharedDeviceCapabilityDetector||(this.sharedDeviceCapabilityDetector=new _({enableDebug:!0,spicetifyContext:!0}),await this.sharedDeviceCapabilityDetector.initialize()),this.sharedEnhancedDeviceTierDetector=new he,this.sharedWebGLSystemsIntegration=new Xe(this.sharedDeviceCapabilityDetector),await this.sharedWebGLSystemsIntegration.initialize(),this.sharedSimplePerformanceCoordinator=new Ge(this.sharedEnhancedDeviceTierDetector,this.sharedWebGLSystemsIntegration),await this.sharedSimplePerformanceCoordinator.initialize()}async initializeUnifiedCSSController(){if(!this.sharedSimplePerformanceCoordinator)throw new Error("SimplePerformanceCoordinator dependency not available");try{this.sharedDeviceCapabilityDetector=new _({enableDebug:this.config.enableDebug||!1,runStressTests:!1}),await this.sharedDeviceCapabilityDetector.initialize(),this.sharedPerformanceBudgetManager=new we({budgets:{animationFrame:16,cssVariableUpdate:2,domObservation:1,audioAnalysis:5,visualEffects:8,userInteraction:100},autoOptimize:{enabled:!0,violationThreshold:3,recoveryThreshold:.8},enableDebug:this.config.enableDebug||!1},this.sharedSimplePerformanceCoordinator);let t=this.sharedDeviceCapabilityDetector.getCapabilities(),e={getCurrentPerformanceMode:()=>({name:"balanced",qualityLevel:.8,animationQuality:.8,effectQuality:.8,blurQuality:.8,shadowQuality:.8,frameRate:60,optimizationLevel:1}),getDeviceCapabilities:()=>t||{performanceTier:"mid",memoryGB:8,isMobile:!1,gpuAcceleration:!0},getBatteryState:()=>({level:1,charging:!1}),getThermalState:()=>({temperature:"normal"})};this.sharedUnifiedCSSVariableManager=new Re(this.config,e,{enableAdaptiveThrottling:!0,batchIntervalMs:16,maxBatchSize:50,priorityMappings:{critical:["--sn-rs-glow-alpha","--sn-rs-beat-intensity","--sn-rs-hue-shift","--sn-cosmic-base-hex","--sn-cosmic-accent-hex"],high:["--sn-gradient-primary","--sn-gradient-secondary","--sn-gradient-accent","--sn-color-base-hex","--sn-color-accent-hex"],normal:["--sn-gradient-","--sn-rs-","--sn-color-"],low:["--sn-debug-","--sn-dev-","--sn-meta-"]},thresholds:{excellentFPS:55,goodFPS:45,poorFPS:30}}),xn(this.sharedUnifiedCSSVariableManager),await this.sharedUnifiedCSSVariableManager.initialize()}catch(t){u?.debug?.warn("SystemCoordinator","Failed to initialize OptimizedCSSVariableManager:",t),this.sharedUnifiedCSSVariableManager=null}}async initializeSettingsManager(){this.sharedSettingsManager=new ee,await this.sharedSettingsManager.initialize()}async initializeMusicSyncService(){this.sharedMusicSyncService=new ve({YEAR3000_CONFIG:this.config,Year3000Utilities:this.utils,performanceMonitor:this.sharedSimplePerformanceCoordinator,settingsManager:this.sharedSettingsManager,year3000System:this.year3000System}),await this.sharedMusicSyncService.initialize()}async initializeSemanticColorManager(){if(!this.sharedUnifiedCSSVariableManager)throw new Error("OptimizedCSSVariableManager dependency not available");this.sharedSemanticColorManager=new at({enableDebug:this.config.enableDebug||!1,fallbackToSpiceColors:!0,cacheDuration:5e3}),await this.sharedSemanticColorManager.initialize(this.sharedUnifiedCSSVariableManager),u?.debug?.log("SystemCoordinator","SemanticColorManager initialized successfully",{systemMetrics:this.sharedSemanticColorManager.getSystemMetrics()})}async initializeColorHarmonyEngine(){if(!this.sharedMusicSyncService)throw new Error("MusicSyncService dependency not available");if(!this.sharedSemanticColorManager)throw new Error("SemanticColorManager dependency not available");this.sharedColorHarmonyEngine=new Ke(this.config,this.utils,this.sharedSimplePerformanceCoordinator||void 0,this.sharedSettingsManager||void 0),await this.sharedColorHarmonyEngine.initialize()}async initializeVisualFacade(){this.visualBridge=new Rt(this.config,this.utils,this,this.sharedUnifiedCSSVariableManager,this.sharedSimplePerformanceCoordinator,this.sharedMusicSyncService,this.sharedSettingsManager,this.sharedColorHarmonyEngine||void 0,this.eventBus),await this.visualBridge.initialize()}async initializeNonVisualFacade(){this.nonVisualFacade=new It(this.config,this.utils,{performanceAnalyzer:this.sharedSimplePerformanceCoordinator,unifiedCSSConsciousnessController:this.sharedUnifiedCSSVariableManager,musicSyncService:this.sharedMusicSyncService,settingsManager:this.sharedSettingsManager,colorHarmonyEngine:this.sharedColorHarmonyEngine,performanceOrchestrator:this.sharedSimplePerformanceCoordinator,semanticColorManager:this.sharedSemanticColorManager}),await this.nonVisualFacade.initialize()}async executeLegacyInitialization(){await this.initializeSharedDependencies(),await this.initializeFacades(),this.setupCrossFacadeCommunication(),await this.setupGradientSystemCoordination(),this.setupDefaultColorDependentSystems(),this.startMonitoring(),await this.performHealthCheck()}getCurrentPhase(){return this.currentPhase}getSystemState(t){return this.systemStates.get(t)}getAllSystemStates(){return new Map(this.systemStates)}isOrchestrationEnabled(){return this.coordinationConfig.orchestration.enforceSequentialInitialization}async cleanup(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.metricsUpdateInterval&&(clearInterval(this.metricsUpdateInterval),this.metricsUpdateInterval=null),this.visualBridge&&(await this.visualBridge.destroy(),this.visualBridge=null),this.nonVisualFacade&&(await this.nonVisualFacade.destroy(),this.nonVisualFacade=null),this.sharedSimplePerformanceCoordinator&&(this.sharedSimplePerformanceCoordinator.destroy(),this.sharedSimplePerformanceCoordinator=null),this.sharedWebGLSystemsIntegration&&(this.sharedWebGLSystemsIntegration.destroy(),this.sharedWebGLSystemsIntegration=null),this.sharedEnhancedDeviceTierDetector&&(this.sharedEnhancedDeviceTierDetector=null),this.sharedSemanticColorManager&&(this.sharedSemanticColorManager.destroy(),this.sharedSemanticColorManager=null),this.sharedColorHarmonyEngine&&(this.sharedColorHarmonyEngine.destroy(),this.sharedColorHarmonyEngine=null),this.sharedMusicSyncService&&(this.sharedMusicSyncService.destroy(),this.sharedMusicSyncService=null),this.sharedSettingsManager&&(this.sharedSettingsManager.destroy(),this.sharedSettingsManager=null),this.sharedUnifiedCSSVariableManager&&(this.sharedUnifiedCSSVariableManager.destroy(),this.sharedUnifiedCSSVariableManager=null),this.sharedSimplePerformanceCoordinator&&(this.sharedSimplePerformanceCoordinator.destroy(),this.sharedSimplePerformanceCoordinator=null),this.sharedPerformanceBudgetManager&&(this.sharedPerformanceBudgetManager.destroy(),this.sharedPerformanceBudgetManager=null),this.sharedDeviceCapabilityDetector&&(this.sharedDeviceCapabilityDetector.destroy(),this.sharedDeviceCapabilityDetector=null),this.crossFacadeEventListeners.clear()}getMetrics(){return{...this.currentMetrics}}getLastHealthCheck(){return this.lastHealthCheck}getConfiguration(){return{...this.coordinationConfig}}async setConfiguration(t){this.coordinationConfig={...this.coordinationConfig,...t}}setOnSystemCreated(t){this.onSystemCreated=t}setOnHealthChange(t){this.onHealthChange=t}setOnPerformanceChange(t){this.onPerformanceChange=t}getSystemStatus(){return{initialized:this.isInitialized,visualSystems:this.visualBridge?.getSystemStatus().systemsActive||0,nonVisualSystems:this.nonVisualFacade?.getSystemStatus().systemsActive||0,healthy:this.currentMetrics.overallHealth==="excellent"||this.currentMetrics.overallHealth==="good"}}async setupGradientSystemCoordination(){if(!this.visualBridge){u?.debug?.warn("SystemCoordinator","VisualSystemFacade not available - skipping gradient system coordination");return}u?.debug?.log("SystemCoordinator","Setting up gradient system coordination");let t=performance.now(),e=0;try{await this.coordinateGradientConductor(),e++,await this.coordinateWebGLGradientSystem(),e++,this.setupGradientSystemRefreshCallbacks(),this.setupGradientSystemCommunication();let i=performance.now()-t;u?.debug?.log("SystemCoordinator","Gradient system coordination completed",{coordinatedSystems:e,duration:`${i.toFixed(2)}ms`,systems:["GradientConductor","WebGLGradientBackgroundSystem","GradientTransitionOrchestrator"]})}catch(i){throw u?.debug?.error("SystemCoordinator","Failed to setup gradient system coordination:",i),i}}async coordinateGradientConductor(){try{let t=this.visualBridge.getVisualSystem("GradientConductor");if(!t){u?.debug?.warn("SystemCoordinator","GradientConductor not available via VisualSystemFacade");return}this.addEventListener("gradient-conductor-event",e=>{t&&typeof t.handleSystemEvent=="function"&&t.handleSystemEvent(e)}),this.registerColorDependentSystem("GradientConductor",async e=>{if(t&&typeof t.refreshColorState=="function")await t.refreshColorState(e);else if(t&&typeof t.setPalette=="function"){let i=this.sharedColorHarmonyEngine;if(i)try{let n=await i.getCurrentGradient();n&&t.setPalette(n)}catch(n){u?.debug?.warn("SystemCoordinator","Failed to refresh GradientConductor colors:",n)}}}),u?.debug?.log("SystemCoordinator","GradientConductor coordination established")}catch(t){u?.debug?.error("SystemCoordinator","Failed to coordinate GradientConductor:",t)}}async coordinateWebGLGradientSystem(){try{let t=this.visualBridge.getVisualSystem("WebGLBackground");if(!t){u?.debug?.warn("SystemCoordinator","WebGLGradientBackgroundSystem not available via VisualSystemFacade");return}this.addEventListener("webgl-gradient-event",e=>{t&&typeof t.handleSystemEvent=="function"&&t.handleSystemEvent(e)}),this.registerColorDependentSystem("WebGLGradientBackgroundSystem",async e=>{t&&typeof t.refreshColorState=="function"?await t.refreshColorState(e):t&&typeof t.updateGradientTexture=="function"&&await t.updateGradientTexture()}),u?.debug?.log("SystemCoordinator","WebGLGradientBackgroundSystem coordination established")}catch(t){u?.debug?.error("SystemCoordinator","Failed to coordinate WebGLGradientBackgroundSystem:",t)}}setupGradientSystemRefreshCallbacks(){try{this.registerColorDependentSystem("GradientTransitionOrchestrator"),u?.debug?.log("SystemCoordinator","GradientTransitionOrchestrator registered for color updates")}catch(t){u?.debug?.warn("SystemCoordinator","Failed to register GradientTransitionOrchestrator:",t)}}setupGradientSystemCommunication(){this.addEventListener("color-harmony-updated",async t=>{try{await this.refreshColorDependentSystems("color-harmony-update"),this.emitEvent("gradient-systems-updated",{trigger:"color-harmony-update",timestamp:Date.now(),systems:["GradientConductor","WebGLGradientBackgroundSystem","GradientTransitionOrchestrator"]})}catch(e){u?.debug?.error("SystemCoordinator","Failed to propagate color harmony update to gradient systems:",e)}}),this.addEventListener("performance-event",t=>{try{this.emitEvent("gradient-performance-event",{...t,timestamp:Date.now()})}catch(e){u?.debug?.error("SystemCoordinator","Failed to propagate performance event to gradient systems:",e)}}),u?.debug?.log("SystemCoordinator","Gradient system communication established")}getGradientSystemStatus(){let t=["GradientConductor","WebGLGradientBackgroundSystem","GradientTransitionOrchestrator"],e=t.filter(i=>this.colorDependentSystems.has(i));return{coordinatedSystems:t,colorDependentGradientSystems:e,communicationActive:this.crossFacadeEventListeners.size>0}}registerColorDependentSystem(t,e){this.colorDependentSystems.add(t),e&&this.colorSystemRefreshCallbacks.set(t,e),u?.debug?.log("SystemCoordinator",`Registered color-dependent system: ${t}`)}unregisterColorDependentSystem(t){this.colorDependentSystems.delete(t),this.colorSystemRefreshCallbacks.delete(t),u?.debug?.log("SystemCoordinator",`Unregistered color-dependent system: ${t}`)}getColorDependentSystems(){return Array.from(this.colorDependentSystems)}async refreshColorDependentSystems(t){if(this.colorDependentSystems.size===0){u?.debug?.log("SystemCoordinator","No color-dependent systems to refresh");return}let e=performance.now(),i=[],n=0,r=0;u?.debug?.log("SystemCoordinator",`Refreshing ${this.colorDependentSystems.size} color-dependent systems for trigger: ${t}`);for(let o of this.colorDependentSystems){let l=this.colorSystemRefreshCallbacks.get(o);l?i.push(l(t).then(()=>{n++,u?.debug?.log("SystemCoordinator",`Successfully refreshed color system: ${o}`)}).catch(m=>{r++,u?.debug?.warn("SystemCoordinator",`Failed to refresh color system ${o}:`,m)})):i.push(this.getSystemAndRefresh(o,t).then(()=>{n++}).catch(m=>{r++,u?.debug?.warn("SystemCoordinator",`Failed to refresh color system ${o}:`,m)}))}await Promise.all(i);let s=performance.now()-e;u?.debug?.log("SystemCoordinator","Color system refresh completed",{trigger:t,duration:`${s.toFixed(2)}ms`,success:n,failures:r,totalSystems:this.colorDependentSystems.size}),this.emitEvent("color-systems-refreshed",{trigger:t,duration:s,successCount:n,failureCount:r,totalSystems:this.colorDependentSystems.size,timestamp:Date.now()})}async getSystemAndRefresh(t,e){if(this.visualBridge)try{let i=this.visualBridge.getVisualSystem(t);if(i&&typeof i.refreshColorState=="function"){await i.refreshColorState(e);return}}catch{}if(this.nonVisualFacade)try{let i=await this.nonVisualFacade.getSystem(t);if(i&&typeof i.refreshColorState=="function"){await i.refreshColorState(e);return}}catch{}u?.debug?.warn("SystemCoordinator",`System ${t} not found or doesn't support color refresh`)}setupDefaultColorDependentSystems(){let t=["CinematicDrama","EtherealBeauty","NaturalHarmony","FluidGradientBackgroundSystem","WebGLGradientBackgroundSystem","IridescentShimmerEffectsSystem","ColorHarmonyEngine","GradientTransitionOrchestrator","GradientConductor","SemanticColorManager","Card3DManager","GlassmorphismManager"];for(let e of t)this.registerColorDependentSystem(e);u?.debug?.log("SystemCoordinator",`Auto-registered ${t.length} default color-dependent systems`)}async destroy(){await this.cleanup(),this.isInitialized=!1,u?.debug?.log("SystemCoordinator","System coordinator destroyed")}getSharedMusicSyncService(){return this.sharedMusicSyncService||void 0}getSharedColorHarmonyEngine(){return this.sharedColorHarmonyEngine||void 0}getSharedSettingsManager(){return this.sharedSettingsManager||void 0}getSharedSemanticColorManager(){return this.sharedSemanticColorManager||void 0}getSharedSimplePerformanceCoordinator(){return this.sharedSimplePerformanceCoordinator||void 0}getSharedWebGLSystemsIntegration(){return this.sharedWebGLSystemsIntegration||void 0}getSharedEnhancedDeviceTierDetector(){return this.sharedEnhancedDeviceTierDetector||void 0}getSharedPerformanceAnalyzer(){return this.sharedSimplePerformanceCoordinator||void 0}getSharedPerformanceOrchestrator(){return this.sharedSimplePerformanceCoordinator||void 0}}});var vr,Vs,_s=y(()=>{"use strict";D();N();bt();vr=class{constructor(t){this.initialized=!1;this.settingsManager=null;this.currentState=null;this.isUpdating=!1;this.updateCount=0;this.lastUpdateTime=0;this.settingsManager=t||null}async initialize(){if(this.initialized)return;let t=globalThis.year3000System;this.cssController=t?.cssConsciousnessController||T(),g.subscribe("settings:changed",this.handleSettingsChange.bind(this),"ColorStateManager"),g.subscribe("colors:harmonized",this.handleProcessedColors.bind(this),"ColorStateManager"),g.subscribe("colors:extracted",this.handleExtractedColors.bind(this),"ColorStateManager"),g.subscribe("consciousness:updated",this.handleConsciousnessUpdate.bind(this),"ColorStateManager"),g.subscribe("music:energy",this.handleMusicEnergyUpdate.bind(this),"ColorStateManager"),g.subscribe("system:css-variables",this.handleSystemCSSVariables.bind(this),"ColorStateManager"),this.settingsManager||(this.settingsManager=globalThis.__SN_settingsManager||globalThis.Y3K?.system?.settingsManager),this.settingsManager&&await this.applyInitialColorState(),this.initialized=!0,console.log("\u{1F3A8} [ColorStateManager] Initialized successfully")}async healthCheck(){let t=[];this.settingsManager||t.push("SettingsManager not available"),this.currentState||t.push("No current color state"),this.updateCount===0&&t.push("No color updates performed yet");let e=Date.now()-this.lastUpdateTime;return e>3e5&&t.push(`Last update was ${Math.round(e/1e3)}s ago`),{healthy:t.length===0,ok:t.length===0,details:`Color state manager - ${this.updateCount} updates performed`,issues:t,system:"ColorStateManager"}}updateAnimation(t){}destroy(){g.unsubscribeAll("ColorStateManager"),this.currentState=null,this.initialized=!1}getCurrentConfig(){return this.settingsManager?{paletteSystemFlavor:this.settingsManager.get("catppuccin-flavor")||j.getCurrentDefaultFlavor(),brightnessMode:this.settingsManager.get("sn-brightness-mode"),accentColor:this.settingsManager.get("catppuccin-accentColor"),preserveAlbumArt:!0,enableTransitions:!0}:{paletteSystemFlavor:j.getCurrentDefaultFlavor(),brightnessMode:"dark",accentColor:"mauve",preserveAlbumArt:!0,enableTransitions:!0}}calculateColorState(t){let{paletteSystemFlavor:e,brightnessMode:i,accentColor:n,dynamicAlbumColors:r}=t,a=ya(e,i),s=fa(e,i),o;n==="dynamic"&&r?o=r.accent:n==="dynamic"?o=Sa(e):o=va(n,e);let m=j.getCurrentPalette()[e];if(!m)throw new Error(`Flavor '${e}' not found in current palette system`);let d=m.text;return{baseColor:a,surfaceColor:s,accentColor:o,textColor:d,effectiveConfig:t,timestamp:Date.now()}}async applyColorStateToCSSVariables(t){let e=performance.now(),i={"--sn-cosmic-base-hex":t.baseColor.hex,"--sn-cosmic-accent-hex":t.accentColor.hex,"--spice-accent":t.accentColor.hex,"--spice-base":t.baseColor.hex,"--sn-color-base-hex":t.baseColor.hex,"--sn-color-base-rgb":t.baseColor.rgb,"--sn-color-surface-hex":t.surfaceColor.hex,"--sn-color-surface-rgb":t.surfaceColor.rgb,"--sn-color-accent-hex":t.accentColor.hex,"--sn-color-accent-rgb":t.accentColor.rgb,"--sn-dynamic-accent-hex":t.accentColor.hex,"--sn-dynamic-accent-rgb":t.accentColor.rgb,"--sn-cosmic-base-rgb":t.baseColor.rgb,"--sn-cosmic-surface-hex":t.surfaceColor.hex,"--sn-cosmic-surface-rgb":t.surfaceColor.rgb,"--sn-cosmic-accent-rgb":t.accentColor.rgb,"--sn-color-text-hex":t.textColor.hex,"--sn-color-text-rgb":t.textColor.rgb,"--sn-cosmic-text-hex":t.textColor.hex,"--sn-cosmic-text-rgb":t.textColor.rgb,"--spice-surface1":t.surfaceColor.hex,"--spice-text":t.textColor.hex,"--spice-rgb-base":t.baseColor.rgb,"--spice-rgb-surface1":t.surfaceColor.rgb,"--spice-rgb-accent":t.accentColor.rgb,"--spice-rgb-text":t.textColor.rgb,"--sn-bg-gradient-primary-rgb":t.accentColor.rgb,"--sn-bg-gradient-secondary-rgb":t.surfaceColor.rgb,"--sn-bg-gradient-accent-rgb":t.accentColor.rgb,"--sn-color-state-flavor":`"${t.effectiveConfig.paletteSystemFlavor}"`,"--sn-color-state-brightness":`"${t.effectiveConfig.brightnessMode}"`,"--sn-color-state-accent":`"${t.effectiveConfig.accentColor}"`,"--sn-color-state-palette-system":`"${j.getCurrentPaletteSystem()}"`,"--sn-color-state-timestamp":t.timestamp.toString()};await this.applyColorVariablesWithPriorities(i);let r=performance.now()-e;console.log(`\u{1F3A8} [ColorStateManager] Applied ${Object.keys(i).length} CSS variables in ${r.toFixed(2)}ms (via OptimizedCSSVariableManager)`)}async applyColorVariablesWithPriorities(t){let e=["--sn-cosmic-base-hex","--sn-cosmic-accent-hex","--spice-accent","--spice-base"],i=["--sn-color-","--sn-dynamic-accent-"],n={},r={},a={},s={};Object.entries(t).forEach(([o,l])=>{e.some(m=>o.includes(m))?n[o]=l:i.some(m=>o.includes(m))?r[o]=l:o.includes("state-")||o.includes("timestamp")?s[o]=l:a[o]=l}),Object.keys(n).length>0&&this.cssController.batchSetVariables("ColorStateManager",n,"critical","color-state-critical"),Object.keys(r).length>0&&this.cssController.batchSetVariables("ColorStateManager",r,"high","color-state-high"),Object.keys(a).length>0&&this.cssController.batchSetVariables("ColorStateManager",a,"normal","color-state-normal"),Object.keys(s).length>0&&this.cssController.batchSetVariables("ColorStateManager",s,"low","color-state-meta")}queueCSSVariableUpdate(t,e,i="normal"){let n=i==="critical"?"critical":i==="high"?"high":i==="low"?"low":"normal";this.cssController.setVariable("ColorStateManager",t,e,n,"color-state-queue")}async verifyCSSVariablesApplied(t){let e=["--sn-cosmic-base-hex","--sn-cosmic-accent-hex","--spice-base"];for(let i of e)if(t[i]){let n=getComputedStyle(document.documentElement).getPropertyValue(i).trim(),r=t[i];if(n!==r)return console.warn(`\u{1F3A8} [ColorStateManager] Variable verification failed: ${i} = "${n}" (expected "${r}")`),!1}return!0}async updateColorState(t="settings"){if(!this.isUpdating){this.isUpdating=!0;try{let e=this.getCurrentConfig(),i=this.calculateColorState(e);if(!this.currentState||this.currentState.baseColor.hex!==i.baseColor.hex||this.currentState.surfaceColor.hex!==i.surfaceColor.hex||this.currentState.accentColor.hex!==i.accentColor.hex||this.currentState.effectiveConfig.paletteSystemFlavor!==i.effectiveConfig.paletteSystemFlavor||this.currentState.effectiveConfig.brightnessMode!==i.effectiveConfig.brightnessMode){let r=this.currentState;await this.applyColorStateToCSSVariables(i),this.currentState=i,this.updateCount++,this.lastUpdateTime=Date.now(),g.emit("colors:applied",{oldState:r,newState:i,trigger:t,cssVariables:{"--sn-cosmic-base-hex":i.baseColor.hex,"--sn-cosmic-accent-hex":i.accentColor.hex},accentHex:i.accentColor.hex,accentRgb:i.accentColor.rgb,appliedAt:Date.now()}),console.log(`\u{1F3A8} [ColorStateManager] Color state updated (${t}):`,{flavor:i.effectiveConfig.paletteSystemFlavor,brightness:i.effectiveConfig.brightnessMode,accent:i.effectiveConfig.accentColor,paletteSystem:j.getCurrentPaletteSystem(),base:i.baseColor.hex,surface:i.surfaceColor.hex,accentHex:i.accentColor.hex})}}finally{this.isUpdating=!1}}}async applyInitialColorState(){await this.updateColorState("initialization")}async handleSettingsChange(t){let{settingKey:e,newValue:i,oldValue:n}=t;if(["catppuccin-flavor","sn-brightness-mode","catppuccin-accentColor"].includes(e)){let r="settings";e==="catppuccin-flavor"?r="flavor":e==="sn-brightness-mode"?r="brightness":e==="catppuccin-accentColor"&&(r="accent"),g.emit(`colorState:${r}Changed`,{settingKey:e,newValue:i,oldValue:n,timestamp:Date.now()}),await this.updateColorState(r)}}async handleProcessedColors(t){let{processedColors:e,accentHex:i,accentRgb:n,strategies:r,coordinationMetrics:a}=t,s={};Object.entries(e).forEach(([o,l])=>{if(l){let m=o.startsWith("--")?o:`--sn-${o.toLowerCase().replace(/_/g,"-")}`;s[m]=l}}),i&&(s["--sn-accent-hex"]=i,s["--sn-processed-accent-hex"]=i),n&&(s["--sn-accent-rgb"]=n,s["--sn-processed-accent-rgb"]=n),a&&(a.emotionalState&&(s["--sn-emotional-state"]=`"${a.emotionalState}"`),a.musicInfluenceStrength!==void 0&&(s["--sn-music-influence"]=a.musicInfluenceStrength.toFixed(3))),Object.entries(s).forEach(([o,l])=>{let m="normal";o.includes("accent-hex")||o.includes("accent-rgb")?m="high":(o.includes("debug")||o.includes("state")||o.includes("influence"))&&(m="low"),this.queueCSSVariableUpdate(o,l,m)}),console.log(`\u{1F3A8} [ColorStateManager] Applied ${Object.keys(s).length} processed color variables`)}async handleExtractedColors(t){let{rawColors:e,trackUri:i,musicData:n}=t,r={};Object.entries(e).forEach(([a,s])=>{s&&(r[`--sn-extracted-${a.toLowerCase()}`]=s)}),i&&(r["--sn-current-track-id"]=`"${i}"`),Object.entries(r).forEach(([a,s])=>{this.queueCSSVariableUpdate(a,s,"low")})}async handleConsciousnessUpdate(t){let{payload:e}=t;if(!e)return;let i={"--sn-consciousness-level":(e.consciousnessLevel||0).toFixed(3),"--sn-emotional-temperature":(e.emotionalTemperature||6500).toString(),"--sn-transcendence-level":(e.transcendenceLevel||0).toFixed(3),"--sn-volumetric-depth":(e.volumetricDepth||0).toFixed(3),"--sn-data-stream-intensity":(e.dataStreamIntensity||0).toFixed(3),"--sn-cosmic-resonance":(e.cosmicResonance||0).toFixed(3)};Object.entries(i).forEach(([n,r])=>{this.queueCSSVariableUpdate(n,r,"normal")})}async handleMusicEnergyUpdate(t){let{energy:e,valence:i,tempo:n}=t,r={};e!==void 0&&(r["--sn-music-energy"]=e.toFixed(3)),i!==void 0&&(r["--sn-music-valence"]=i.toFixed(3)),n!==void 0&&(r["--sn-music-tempo"]=n.toString()),Object.entries(r).forEach(([a,s])=>{this.queueCSSVariableUpdate(a,s,"high")})}async handleSystemCSSVariables(t){let{source:e,variables:i,timestamp:n}=t;!i||typeof i!="object"||(Object.entries(i).forEach(([r,a])=>{let s="normal";r.includes("harmony")||r.includes("glow")||r.includes("pulse")?s="high":(r.includes("debug")||r.includes("breathing"))&&(s="low"),this.queueCSSVariableUpdate(r,a,s)}),console.log(`\u{1F3A8} [ColorStateManager] Applied ${Object.keys(i).length} CSS variables from ${e}`))}getCurrentState(){return this.currentState?{...this.currentState}:null}async refresh(){await this.updateColorState("settings")}},Vs=new vr});function Ns(c,t=!1){let e=document.querySelector(k.nowPlayingBar);if(!e)return t&&console.warn("\u{1F3B5} [NowPlayingDomWatcher] nowPlayingBar element not found \u2013 watcher inactive"),()=>{};let i=new MutationObserver(()=>{c(),t&&console.log("\u{1F3B5} [NowPlayingDomWatcher] DOM mutation detected \u2192 onChange dispatched")});return i.observe(e,{childList:!0,subtree:!0}),t&&console.log("\u{1F3B5} [NowPlayingDomWatcher] watcher active"),()=>{i.disconnect(),t&&console.log("\u{1F3B5} [NowPlayingDomWatcher] watcher disposed")}}var $s=y(()=>{"use strict";ir()});function Uc(){let c=document.querySelector(".sn-stars-container");if(c)return c;let t=document.createElement("div");t.className="sn-stars-container";for(let e=1;e<=5;e++){let i=document.createElement("div");i.className="star",Math.random()>.7&&i.classList.add("twinkle"),t.appendChild(i)}return document.body.appendChild(t),t}function kt(c,t){w.enableDebug&&console.log("[StarryNightEffects] Applying consolidated effect settings:",{effectIntensity:c});let e=document.body,i=["sn-gradient-disabled","sn-gradient-minimal","sn-gradient-balanced","sn-gradient-intense"],n=["sn-stars-disabled","sn-stars-minimal","sn-stars-balanced","sn-stars-intense"];e.classList.remove(...i,...n),c!=="balanced"&&(e.classList.add(`sn-gradient-${c}`),e.classList.add(`sn-stars-${c}`));let r=document.querySelector(".sn-stars-container");c==="disabled"?r?.remove():r||Uc()}var Cr=y(()=>{"use strict";ke();U()});var Lt,Ws,qs,Mr=y(()=>{"use strict";Us();_s();ai();D();U();K();$s();Cr();Lt=class{constructor(t=w){this.healthCheckInterval=null;this.facadeCoordinator=null;this.colorStateManager=null;this._initializationResults=null;this._dynamicCatppuccinBridge=null;this.processingState={isProcessingSongChange:!1,lastProcessedTrackUri:null,lastProcessingTime:0,processingChain:[],eventLoopDetected:!1};this.colorEventState={processedEvents:new Map,isProcessingColorEvent:!1,eventTimeout:null};this.PROCESSING_TIMEOUT=5e3;this.MAX_CHAIN_LENGTH=10;this.COLOR_EVENT_CACHE_TTL=2e3;this.availableAPIs=null;this._songChangeHandler=null;this._lastInitializationTime=null;this._initializationRetryHistory=[];this._systemStartTime=null;this._disposeNowPlayingWatcher=null;this.allowHarmonicEvolution=!0;this.performanceGuardActive=!1;this.YEAR3000_CONFIG=this._deepCloneConfig(t),typeof this.YEAR3000_CONFIG.init=="function"&&this.YEAR3000_CONFIG.init(),this.utils=I,this.initialized=!1,this._systemStartTime=Date.now(),this._initializationResults=null,this.YEAR3000_CONFIG?.enableDebug&&console.log("\u{1F31F} [Year3000System] Constructor: Instance created with Enhanced Master Animation Coordinator"),this._boundExternalSettingsHandler=this._handleExternalSettingsChange.bind(this),document.addEventListener("year3000SystemSettingsChanged",this._boundExternalSettingsHandler),this._boundArtisticModeHandler=this._onArtisticModeChanged.bind(this),document.addEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),this._boundVisibilityChangeHandler=this._handleVisibilityChange.bind(this),document.addEventListener("visibilitychange",this._boundVisibilityChangeHandler),this._disposeNowPlayingWatcher=Ns(()=>{let e=Date.now().toString();this.queueCSSVariableUpdate("--sn-force-refresh",e),g.emit("music:track-changed",{timestamp:parseInt(e),trackUri:"unknown",artist:"unknown",title:"unknown"})},this.YEAR3000_CONFIG.enableDebug),this.allowHarmonicEvolution=this.YEAR3000_CONFIG.harmonicEvolution??!0,setTimeout(()=>{this._applyPerformanceProfile()},0)}get enhancedMasterAnimationCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("EnhancedMasterAnimationCoordinator")||null}get timerConsolidationSystem(){return this.facadeCoordinator?.getCachedNonVisualSystem("TimerConsolidationSystem")||null}get cssConsciousnessController(){return this.facadeCoordinator?.getCachedNonVisualSystem("OptimizedCSSVariableManager")||null}get simplePerformanceCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimplePerformanceCoordinator")||null}get simpleTierBasedPerformanceSystem(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimpleTierBasedPerformanceSystem")||null}get enhancedDeviceTierDetector(){return this.facadeCoordinator?.getCachedNonVisualSystem("EnhancedDeviceTierDetector")||null}get webglSystemsIntegration(){return this.facadeCoordinator?.getCachedNonVisualSystem("WebGLSystemsIntegration")||null}get unifiedCSSManager(){return this.cssConsciousnessController||null}get performanceCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedPerformanceCoordinator")||null}get deviceCapabilityDetector(){return this.facadeCoordinator?.getCachedNonVisualSystem("DeviceCapabilityDetector")||null}get performanceAnalyzer(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimplePerformanceCoordinator")||null}get unifiedPerformanceCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedPerformanceCoordinator")||null}get performanceCSSIntegration(){return this.cssConsciousnessController||null}get performanceOrchestrator(){return this.facadeCoordinator?.getCachedNonVisualSystem("SimplePerformanceCoordinator")||null}get performanceBudgetManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("PerformanceBudgetManager")||null}get systemHealthMonitor(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedDebugManager")||null}get settingsManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("SettingsManager")||null}get colorHarmonyEngine(){return this.facadeCoordinator?.getCachedNonVisualSystem("ColorHarmonyEngine")||null}get unifiedColorProcessingEngine(){return this.facadeCoordinator?.getCachedNonVisualSystem("UnifiedColorProcessingEngine")||null}get musicColorIntegrationBridge(){return null}get colorEventOrchestrator(){let t=this.unifiedColorProcessingEngine;return t||null}get colorOrchestrator(){let t=this.unifiedColorProcessingEngine;return t||null}get enhancedColorOrchestrator(){let t=this.unifiedColorProcessingEngine;return t||null}get colorConsciousnessState(){return this.unifiedConsciousnessCoordinator||null}get musicSyncService(){return this.facadeCoordinator?.getCachedNonVisualSystem("MusicSyncService")||null}get glassmorphismManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("GlassmorphismManager")||null}get card3DManager(){return this.facadeCoordinator?.getCachedNonVisualSystem("Card3DManager")||null}get genreGradientEvolution(){return this.facadeCoordinator?.getCachedNonVisualSystem("GenreGradientEvolution")||null}get musicEmotionAnalyzer(){return this.facadeCoordinator?.getCachedNonVisualSystem("MusicEmotionAnalyzer")||null}get unifiedConsciousnessCoordinator(){return this.facadeCoordinator?.getCachedNonVisualSystem("VisualEffectsCoordinator")||null}get colorConsciousnessManager(){return this.unifiedConsciousnessCoordinator||null}get dynamicCatppuccinBridge(){return this._dynamicCatppuccinBridge||this.unifiedConsciousnessCoordinator||null}set dynamicCatppuccinBridge(t){this._dynamicCatppuccinBridge=t}get particleConsciousnessModule(){return this.facadeCoordinator?.getVisualSystem("Particle")||null}get sidebarConsciousnessController(){return this.facadeCoordinator?.getVisualSystem("SidebarConsciousness")||null}get uiEffectsConsciousnessController(){return this.facadeCoordinator?.getVisualSystem("UIEffectsConsciousness")||null}get headerConsciousnessController(){return this.facadeCoordinator?.getVisualSystem("HeaderConsciousness")||null}get lightweightParticleSystem(){return this.facadeCoordinator?.getVisualSystem("Particle")||null}get iridescentShimmerEffectsSystem(){return this.facadeCoordinator?.getVisualSystem("UIEffectsConsciousness")||null}get interactionTrackingSystem(){return this.facadeCoordinator?.getVisualSystem("UIEffectsConsciousness")||null}get whiteLayerDiagnosticSystem(){return this.facadeCoordinator?.getVisualSystem("UIEffectsConsciousness")||null}get audioVisualController(){return this.facadeCoordinator?.getVisualSystem("UIEffectsConsciousness")||null}get prismaticScrollSheenSystem(){return this.facadeCoordinator?.getVisualSystem("UIEffectsConsciousness")||null}get beatSyncVisualSystem(){return this.facadeCoordinator?.getVisualSystem("OrganicBeatSync")||null}get webGLGradientBackgroundSystem(){return this.facadeCoordinator?.getVisualSystem("WebGLBackground")||null}get particleFieldSystem(){return this.facadeCoordinator?.getVisualSystem("Particle")||null}get emergentChoreographyEngine(){return this.enhancedMasterAnimationCoordinator||null}get spotifyUIApplicationSystem(){return this.facadeCoordinator?.getVisualSystem("SpotifyUIApplication")||null}get organicBeatSyncConsciousness(){return this.facadeCoordinator?.getVisualSystem("OrganicBeatSync")||this.beatSyncVisualSystem}get sidebarSystemsIntegration(){return this.facadeCoordinator?.getCachedNonVisualSystem("SidebarSystemsIntegration")||null}_deepCloneConfig(t){return t}updateConfiguration(t,e){if(!this.YEAR3000_CONFIG){console.warn("[Year3000System] Cannot update configuration - config not initialized");return}let i=t.split(".").filter(Boolean);if(!i.length)return;let n=this.YEAR3000_CONFIG,r=i.pop();if(!r)return;for(let s of i)(typeof n[s]!="object"||n[s]===null)&&(n[s]={}),n=n[s];let a=n[r];n[r]=e,this.YEAR3000_CONFIG.enableDebug&&console.log(`[Year3000System] Configuration updated: ${t} = ${e} (was: ${a})`),this._notifyConfigurationChange(t,e,a)}_notifyConfigurationChange(t,e,i){}async initializeAllSystems(){this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] initializeAllSystems(): Starting full system initialization..."),this._systemStartTime=Date.now();let t=performance.now(),e={success:[],failed:[],skipped:[]};this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing Facade Coordination System...");try{this.facadeCoordinator=new Dt(this.YEAR3000_CONFIG,this.utils,this),await this.facadeCoordinator.initialize({mode:"unified",enableSharedDependencies:!0,enableCrossFacadeCommunication:!0,enableUnifiedPerformanceMonitoring:!0,enableResourceOptimization:!0,orchestration:{enforceSequentialInitialization:!0,dependencyValidation:!0,enableInitializationGates:!0,systemReadinessTimeout:5e3,phaseTransitionTimeout:1e4},performanceThresholds:{maxTotalMemoryMB:100,maxTotalInitTime:5e3,maxCrossCommLatency:50},coordinationPreferences:{preferSharedResources:!0,enableEventPropagation:!0,enableHealthCoordination:!0}}),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Facade Coordination System initialized successfully"),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing ColorStateManager...");try{this.colorStateManager=Vs,this.colorStateManager.initialized||await this.colorStateManager.initialize(),e.success.push("ColorStateManager"),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] ColorStateManager initialized successfully")}catch(n){console.error("\u{1F30C} [Year3000System] Failed to initialize ColorStateManager:",n),e.failed.push("ColorStateManager")}await this._initializeFacadeSystems()}catch(n){throw console.error("\u{1F30C} [Year3000System] Failed to initialize Facade Coordination System:",n),n}e.success.push("FacadeCoordinationSystem"),this.performanceAnalyzer&&(this.performanceAnalyzer.startMonitoring(),this.performanceGuardActive=!0),this.enhancedMasterAnimationCoordinator?(await this._registerEnhancedAnimationSystems(),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3AC} [Year3000System] Enhanced animation system registration phase complete")):console.warn("[Year3000System] EnhancedMasterAnimationCoordinator not available for enhanced registration phase"),this._initializationResults=e,this.initialized=!0;let i=performance.now();this._lastInitializationTime=i-t,this.YEAR3000_CONFIG.enableDebug&&(console.log(`[Year3000System] System initialization complete in ${this._lastInitializationTime.toFixed(2)}ms.`),console.log(`[Year3000System] Results: ${e.success.length} success, ${e.failed.length} failed.`),e.failed.length>0&&console.warn(`[Year3000System] Failed systems: ${e.failed.join(", ")}`),e.skipped&&e.skipped.length>0&&console.info(`[Year3000System] Skipped systems: ${e.skipped.join(", ")}`),e.success.length>0&&console.info(`[Year3000System] Successful systems: ${e.success.join(", ")}`),this.systemHealthMonitor&&this.systemHealthMonitor.logHealthReport())}async _initializeEssentialFacadeSystems(){if(!this.facadeCoordinator)throw new Error("Facade coordinator not available for essential system initialization");this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing essential systems for degraded mode...");try{let t=["SimplePerformanceCoordinator","UnifiedCSSVariableManager","UnifiedDebugManager","DeviceCapabilityDetector","TimerConsolidationSystem"];for(let e of t)try{let i=await this.facadeCoordinator.getNonVisualSystem(e);i&&typeof i.initialize=="function"&&(await i.initialize(),this.YEAR3000_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] Essential: Initialized ${e} via facade`))}catch(i){console.error(`\u{1F30C} [Year3000System] Failed to initialize essential ${e}:`,i)}this.performanceAnalyzer&&(this.performanceAnalyzer.startMonitoring(),this.performanceGuardActive=!0,this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Essential: Performance monitoring started"))}catch(t){throw console.error("\u{1F30C} [Year3000System] Essential facade system initialization failed:",t),t}}async _initializeFacadeSystems(){if(!this.facadeCoordinator)throw new Error("Facade coordinator not available for system initialization");this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing essential systems through facades...");try{let t=["SimplePerformanceCoordinator","UnifiedDebugManager","SettingsManager","DeviceCapabilityDetector","TimerConsolidationSystem"],e=["UnifiedCSSVariableManager","UnifiedPerformanceCoordinator"],i=["MusicSyncService","ColorHarmonyEngine","GenreGradientEvolution","MusicEmotionAnalyzer"],n=["GlassmorphismManager","Card3DManager"];this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing foundation systems in parallel...");let r=t.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.YEAR3000_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(r),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing dependent systems in parallel...");let a=e.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.YEAR3000_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(a),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing event-driven systems in parallel...");let s=i.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.YEAR3000_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(s),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing UI systems in parallel...");let o=n.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=await this.facadeCoordinator.getNonVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.YEAR3000_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(o);try{await ot.initialize(),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] ColorOrchestrator initialized for strategy pattern coordination")}catch(d){console.error("\u{1F3A8} [Year3000System] Failed to initialize ColorOrchestrator:",d)}this.performanceAnalyzer&&(this.performanceAnalyzer.startMonitoring(),this.performanceGuardActive=!0,this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Performance monitoring started"));let l=["Particle","WebGLBackground","SpotifyUIApplication","OrganicBeatSync","HeaderConsciousness","InteractionTracking"];this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Initializing visual systems in parallel...");let m=l.map(async d=>{try{if(!this.facadeCoordinator)throw new Error("Facade coordinator not available");let h=this.facadeCoordinator.getVisualSystem(d);return h&&typeof h.initialize=="function"?(await h.initialize(),this.YEAR3000_CONFIG.enableDebug&&console.log(`\u{1F30C} [Year3000System] \u2713 Visual ${d} initialized`),{systemKey:d,success:!0}):{systemKey:d,success:!1,reason:"No initialize method"}}catch(h){return console.error(`\u{1F30C} [Year3000System] \u2717 Failed to initialize visual ${d}:`,h),{systemKey:d,success:!1,error:h}}});await Promise.all(m),await this._linkSystemDependencies(),await this._validateFacadeIntegration(),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Facade system initialization complete")}catch(t){throw console.error("\u{1F30C} [Year3000System] Facade system initialization failed:",t),t}}async _validateFacadeIntegration(){this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F50D} [Year3000System] Performing facade integration validation...");let t={cssControllerAlias:!1,strategyPatternSystems:!1,parallelInitialization:!1,facadeHealthCheck:!1,errors:[]};try{if(this.facadeCoordinator){try{let s=await this.facadeCoordinator.getNonVisualSystem("UnifiedCSSVariableManager"),o=await this.facadeCoordinator.getNonVisualSystem("OptimizedCSSVariableManager");s&&o?(t.cssControllerAlias=!0,this.YEAR3000_CONFIG.enableDebug&&console.log("\u2713 [Validation] CSS Controller alias registration working")):t.errors.push("CSS Controller alias registration failed")}catch(s){t.errors.push(`CSS Controller validation error: ${s}`)}let n=["ColorHarmonyEngine","GenreGradientEvolution","MusicEmotionAnalyzer"],r=0;for(let s of n)try{await this.facadeCoordinator.getNonVisualSystem(s)&&r++}catch(o){t.errors.push(`Strategy system ${s} not found: ${o}`)}t.strategyPatternSystems=r===n.length,t.strategyPatternSystems&&this.YEAR3000_CONFIG.enableDebug&&console.log("\u2713 [Validation] Strategy pattern systems registration working");let a=performance.now();try{let s=await this.facadeCoordinator.getNonVisualSystem("PerformanceAnalyzer"),l=performance.now()-a;t.parallelInitialization=l<100,t.parallelInitialization&&this.YEAR3000_CONFIG.enableDebug?console.log(`\u2713 [Validation] Parallel initialization optimization working (${l.toFixed(2)}ms)`):this.YEAR3000_CONFIG.enableDebug&&console.warn(`\u26A0 [Validation] Initialization may be slow (${l.toFixed(2)}ms)`)}catch(s){t.errors.push(`Parallel initialization test failed: ${s}`)}try{let s=await this.facadeCoordinator.performHealthCheck();t.facadeHealthCheck=s.overall==="excellent"||s.overall==="good",t.facadeHealthCheck&&this.YEAR3000_CONFIG.enableDebug?console.log(`\u2713 [Validation] Facade health check passed (${s.overall})`):(t.errors.push(`Facade health check failed: ${s.overall}`),s.recommendations?.length>0&&console.warn("\u{1F527} [Validation] Health recommendations:",s.recommendations))}catch(s){t.errors.push(`Facade health check error: ${s}`)}}else t.errors.push("Facade coordinator not available for validation");let e=4,i=[t.cssControllerAlias,t.strategyPatternSystems,t.parallelInitialization,t.facadeHealthCheck].filter(Boolean).length;this.YEAR3000_CONFIG.enableDebug&&(console.log(`\u{1F50D} [Year3000System] Facade validation complete: ${i}/${e} tests passed`),t.errors.length>0&&console.warn("\u26A0 [Year3000System] Validation errors:",t.errors),i===e&&console.log("\u{1F389} [Year3000System] All facade integration fixes validated successfully!")),window.Y3K_FACADE_VALIDATION=t}catch(e){console.error("\u{1F50D} [Year3000System] Facade validation failed:",e),t.errors.push(`Validation process error: ${e}`)}}async _linkSystemDependencies(){this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Linking system dependencies...");try{if(this.musicSyncService&&this.colorHarmonyEngine&&(this.musicSyncService.setColorHarmonyEngine(this.colorHarmonyEngine),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] ColorHarmonyEngine linked to MusicSyncService")),this.colorHarmonyEngine&&this.enhancedMasterAnimationCoordinator&&(this.colorHarmonyEngine.setEmergentEngine(this.enhancedMasterAnimationCoordinator),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] EnhancedMasterAnimationCoordinator (with emergent functionality) linked to ColorHarmonyEngine")),this.systemHealthMonitor){let t=[{name:"MusicSyncService",system:this.musicSyncService},{name:"ColorHarmonyEngine",system:this.colorHarmonyEngine},{name:"SettingsManager",system:this.settingsManager}];for(let{name:e,system:i}of t)i&&this.systemHealthMonitor.registerSystem(e,i);this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F30C} [Year3000System] Systems registered with health monitor")}}catch(t){console.error("\u{1F30C} [Year3000System] Failed to link system dependencies:",t)}}_shouldSkipPredictionSystem(t){return!1}async _initializeVisualSystems(t){if(!this.performanceAnalyzer||!this.musicSyncService||!this.settingsManager){console.error("[Year3000System] Cannot initialize visual systems due to missing core dependencies (SimplePerformanceCoordinator, MusicSyncService, or SettingsManager)."),["InteractionTrackingSystem","BeatSyncVisualSystem","SidebarSystemsIntegration"].forEach(i=>t.skipped.push(i));return}this.colorHarmonyEngine&&this.enhancedMasterAnimationCoordinator&&(this.colorHarmonyEngine.setEmergentEngine(this.enhancedMasterAnimationCoordinator),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F517} [Year3000System] EnhancedMasterAnimationCoordinator (emergent functionality) linked to ColorHarmonyEngine."))}async destroyAllSystems(){this.facadeCoordinator&&(await this.facadeCoordinator.destroy(),this.facadeCoordinator=null),this._initializationResults=null,Spicetify.Player&&this._songChangeHandler&&Spicetify.Player.removeEventListener("songchange",this._songChangeHandler),this.initialized=!1,this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F525} [Year3000System] All systems have been destroyed."),document.removeEventListener("year3000SystemSettingsChanged",this._boundExternalSettingsHandler),document.removeEventListener("year3000ArtisticModeChanged",this._boundArtisticModeHandler),document.removeEventListener("visibilitychange",this._boundVisibilityChangeHandler),this._disposeNowPlayingWatcher&&(this._disposeNowPlayingWatcher(),this._disposeNowPlayingWatcher=null)}async applyInitialSettings(t){if(!this.settingsManager){console.warn("[Year3000System] SettingsManager not ready, cannot apply initial settings.");return}this.YEAR3000_CONFIG.enableDebug&&console.log(`\u{1F3A8} [Year3000System] Inside applyInitialSettings. Trigger: ${t||"full"}, SettingsManager valid:`,!!this.settingsManager);try{if(t==="flavor"||t==="brightness"||t==="accent"){console.log(`\u{1F3A8} [Year3000System] Selective update for trigger: ${t}`),await this.updateColorStateOnly(t),await this.refreshColorDependentSystems(t);return}if(console.log("\u{1F3A8} [Year3000System] applyInitialSettings: Getting initial settings..."),this.colorStateManager&&!this.colorStateManager.initialized&&(console.log("\u{1F3A8} [Year3000System] Initializing ColorStateManager..."),await this.colorStateManager.initialize()),this.colorStateManager?.initialized)console.log("\u{1F3A8} [Year3000System] Applying initial color state via ColorStateManager..."),await this.colorStateManager.applyInitialColorState();else{console.warn("\u{1F3A8} [Year3000System] ColorStateManager not available, using legacy color application");let l=this.settingsManager.get("catppuccin-accentColor");l!=="dynamic"&&await this._applyCatppuccinAccent(l)}let e=this.settingsManager.get("sn-gradient-intensity"),i=e,n=this.settingsManager.get("sn-harmonic-intensity"),r=this.settingsManager.get("sn-harmonic-evolution"),a=this.settingsManager.get("sn-current-harmonic-mode");a&&(this.YEAR3000_CONFIG.currentHarmonicMode=String(a)),console.log(`\u{1F3A8} [Year3000System] applyInitialSettings: Gradient=${e}, Stars=${i}, ColorState=${!!this.colorStateManager?.initialized}`),await this._applyStarryNightSettings(e,i);let s=parseFloat(n);Number.isNaN(s)||(this.colorHarmonyEngine&&this.colorHarmonyEngine.setIntensity?.(s),this.YEAR3000_CONFIG.harmonicIntensity=s);let o=r==="true";this.allowHarmonicEvolution=o,this.YEAR3000_CONFIG.harmonicEvolution=o,console.log("\u{1F3A8} [Year3000System] applyInitialSettings: Successfully applied initial settings.")}catch(e){console.error("[Year3000System] Error applying initial settings:",e)}}async updateColorStateOnly(t){if(!this.colorStateManager?.initialized){console.warn(`\u{1F3A8} [Year3000System] ColorStateManager not available for ${t} update`);return}console.log(`\u{1F3A8} [Year3000System] Updating color state for trigger: ${t}`),await this.colorStateManager.updateColorState(t)}async refreshColorDependentSystems(t){if(!this.facadeCoordinator){console.warn(`\u{1F3A8} [Year3000System] No facade coordinator available for ${t} refresh`);return}console.log(`\u{1F3A8} [Year3000System] Refreshing color-dependent systems for trigger: ${t}`),await this.facadeCoordinator.refreshColorDependentSystems(t)}async _applyCatppuccinAccent(t){if(t==="dynamic"){this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] _applyCatppuccinAccent: 'dynamic' accent selected \u2013 skipping static accent overrides.");return}console.log(`\u{1F3A8} [Year3000System] _applyCatppuccinAccent: Applying accent color '${t}'`);let e=t==="none"?"text":t,i=Spicetify.Config.color_scheme||"mocha",n=document.querySelector("body > script.marketplaceScript")?`url('https://github.com/catppuccin/spicetify/blob/main/catppuccin/assets/${i}/equalizer-animated-${e}.gif?raw=true')`:`url('${i}/equalizer-animated-${e}.gif')`;this.cssConsciousnessController?.queueCSSVariableUpdate("--spice-text",`var(--spice-${e})`),this.cssConsciousnessController?.queueCSSVariableUpdate("--spice-button-active",`var(--spice-${e})`),this.cssConsciousnessController?.queueCSSVariableUpdate("--spice-equalizer",n),this.cssConsciousnessController?.flushCSSVariableBatch(),console.log("\u{1F3A8} [Year3000System] _applyCatppuccinAccent: Flushed CSS variables for accent color.")}async _applyStarryNightSettings(t,e){try{kt(t,e)}catch{console.error("[Year3000System] Failed to apply starry night settings")}}applyColorsToTheme(t={}){let e=t;if(this.colorHarmonyEngine)try{e=this.colorHarmonyEngine.blendWithCatppuccin(t)}catch(r){console.error("[Year3000System] ColorHarmonyEngine blend failed:",r)}let i=e.accentHex||e.VIBRANT||e.PROMINENT||Object.values(e)[0]||"#37416b",n=e.accentRgb||(()=>{let r=this.utils.hexToRgb(i);return r?`${r.r},${r.g},${r.b}`:"166,173,200"})();this._applyColorsViaFacadeSystem(e,i,n)}handleColorHarmonizedEvent(t){if(this.colorEventState.isProcessingColorEvent){this.YEAR3000_CONFIG.enableDebug&&console.warn("\u{1F504} [Year3000System] Already processing color event - skipping to prevent recursion");return}let e=JSON.stringify(t).substring(0,100),i=this._generateEventHash(e),n=Date.now();if(this.colorEventState.processedEvents.has(i)){let r=this.colorEventState.processedEvents.get(i);if(n-r<this.COLOR_EVENT_CACHE_TTL){this.YEAR3000_CONFIG.enableDebug&&console.warn("\u{1F504} [Year3000System] Event recently processed - skipping duplicate");return}}this.colorEventState.isProcessingColorEvent=!0,this.colorEventState.processedEvents.set(i,n),this.colorEventState.eventTimeout=window.setTimeout(()=>{this.YEAR3000_CONFIG.enableDebug&&console.warn("\u{1F504} [Year3000System] Color event processing timeout - resetting state"),this._resetColorEventState()},this.PROCESSING_TIMEOUT);try{if(this.processingState.processingChain.push("handleColorHarmonizedEvent"),this.processingState.processingChain.length>this.MAX_CHAIN_LENGTH){this.processingState.eventLoopDetected=!0,console.error("\u{1F504} [Year3000System] CRITICAL: Event loop detected - chain length exceeded",this.processingState.processingChain),this._resetProcessingState();return}let r,a,s,o,l;if(t.processedColors&&t.accentHex&&t.accentRgb)r=t.processedColors,a=t.accentHex,s=t.accentRgb,o=t.strategies||["ColorHarmonyEngine"],l=t.processingTime||0;else if(t.payload&&t.payload.processedColors)r=t.payload.processedColors,a=t.payload.accentHex||Object.values(r)[0]||"#a6adc8",s=this.utils.hexToRgb(a)?.r+","+this.utils.hexToRgb(a)?.g+","+this.utils.hexToRgb(a)?.b||"166,173,200",o=[t.payload.metadata?.strategy||"Unknown"],l=t.payload.metadata?.processingTime||0;else{if(t.type==="colors/harmonized")return;this.YEAR3000_CONFIG.enableDebug&&console.warn("\u{1F3A8} [Year3000System] Unrecognized colors:harmonized event format:",t);return}this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Processing colors:harmonized event:",{strategies:o,processingTime:l,colorsCount:Object.keys(r).length,accentHex:a,accentRgb:s,chainLength:this.processingState.processingChain.length}),this._applyColorsViaFacadeSystem(r,a,s)}catch(r){console.error("[Year3000System] Failed to handle colors:harmonized event:",r)}finally{this._resetColorEventState();let r=this.processingState.processingChain.indexOf("handleColorHarmonizedEvent");r>-1&&this.processingState.processingChain.splice(r,1)}}_generateEventHash(t){let e=0;for(let i=0;i<t.length;i++){let n=t.charCodeAt(i);e=(e<<5)-e+n,e=e&e}return e.toString()}_resetColorEventState(){this.colorEventState.isProcessingColorEvent=!1,this.colorEventState.eventTimeout&&(clearTimeout(this.colorEventState.eventTimeout),this.colorEventState.eventTimeout=null);let t=Date.now();for(let[e,i]of this.colorEventState.processedEvents.entries())t-i>this.COLOR_EVENT_CACHE_TTL&&this.colorEventState.processedEvents.delete(e)}_resetProcessingState(){this.processingState.isProcessingSongChange=!1,this.processingState.processingChain=[],this.processingState.eventLoopDetected=!1,this.processingState.lastProcessingTime=Date.now(),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F504} [Year3000System] Processing state reset")}_applyColorsViaFacadeSystem(t,e,i){try{let n={};Object.entries(t).forEach(([a,s])=>{if(this.utils.isValidHexColor(s)){let o=this.utils.hexToRgb(s);o&&(n[`--sn-processed-${a.toLowerCase()}-hex`]=s,n[`--sn-processed-${a.toLowerCase()}-rgb`]=`${o.r},${o.g},${o.b}`)}else this.YEAR3000_CONFIG.enableDebug&&console.debug(`[Year3000System] Skipping non-hex processedColor: ${a}=${s}`)});let r={"--sn-musical-harmony-primary-rgb":t.VIBRANT||t.PRIMARY||i,"--sn-musical-harmony-secondary-rgb":t.DARK_VIBRANT||t.SECONDARY||i,"--sn-musical-harmony-tertiary-rgb":t.VIBRANT_NON_ALARMING||t.LIGHT_VIBRANT||i,"--sn-musical-harmony-quaternary-rgb":t.DESATURATED||t.EMOTIONAL_BLEND||i,"--sn-musical-harmony-primary-hex":t.VIBRANT||t.PRIMARY||e,"--sn-musical-harmony-secondary-hex":t.DARK_VIBRANT||t.SECONDARY||e,"--sn-musical-harmony-tertiary-hex":t.VIBRANT_NON_ALARMING||t.LIGHT_VIBRANT||e,"--sn-musical-harmony-quaternary-hex":t.DESATURATED||t.EMOTIONAL_BLEND||e,"--sn-musical-oklab-primary-rgb":t.VIBRANT||t.PRIMARY||t.PROMINENT||i,"--sn-musical-oklab-accent-rgb":t.DARK_VIBRANT||t.DESATURATED||i,"--sn-musical-oklab-highlight-rgb":t.VIBRANT_NON_ALARMING||t.LIGHT_VIBRANT||i,"--sn-musical-oklab-shadow-rgb":t.DARK_VIBRANT||t.DESATURATED||i,"--sn-musical-oklab-complementary-rgb":t.SECONDARY||t.EMOTIONAL_BLEND||i,"--sn-musical-oklab-triadic-rgb":t.LIGHT_VIBRANT||t.VIBRANT_NON_ALARMING||i};Object.entries(r).forEach(([a,s])=>{if(!(!s||typeof s!="string")){if(a.includes("-hex"))n[a]=s;else if(a.includes("-rgb"))if(this.utils.isValidHexColor(s)){let o=this.utils.hexToRgb(s);o&&(n[a]=`${o.r},${o.g},${o.b}`)}else s.includes(",")&&(n[a]=s)}}),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Musical Harmony Color Processing:",{colorHarmonyKeys:Object.keys(t),colorHarmonyValues:t,musicalHarmonyVariables:r,expectedCSSChain:["--sn-musical-oklab-primary-rgb","--sn-musical-harmony-primary-rgb","--sn-gradient-primary-rgb"],totalVariablesSet:Object.keys(n).length,cssAuthorityDelegation:"ColorStateManager + DynamicCatppuccinBridge"}),this.cssConsciousnessController&&typeof this.cssConsciousnessController.batchSetVariables=="function"?this.cssConsciousnessController.batchSetVariables("Year3000System-ColorHarmonized",n,"high","color-harmony-event-application"):this._applyCSSVariables(n),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F527} [Year3000System] Applied musical harmony variables via CSS coordination:",{totalVariables:Object.keys(n).length,accentColor:e,cssControllerUsed:!!this.cssConsciousnessController,spicetifyDelegation:"ColorStateManager + DynamicCatppuccinBridge handle --spice-* variables"})}catch(n){console.error("[Year3000System] Failed to apply musical harmony variables:",n);let r={"--sn-musical-harmony-primary-hex":e,"--sn-musical-harmony-primary-rgb":i};this._applyCSSVariables(r)}}_applyCSSVariables(t){try{let e=document.documentElement;for(let[i,n]of Object.entries(t))i&&n&&e.style.setProperty(i,n);this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Applied CSS variables directly",{variablesCount:Object.keys(t).length,variables:Object.keys(t)})}catch(e){console.error("[Year3000System] Failed to apply CSS variables:",e)}}queueCSSVariableUpdate(t,e,i=null){this.unifiedCSSManager?this.unifiedCSSManager.queueUpdate(t,e,"normal","Year3000System"):this.cssConsciousnessController?this.cssConsciousnessController.queueCSSVariableUpdate(t,e,i||void 0):(i||document.documentElement).style.setProperty(t,e)}setGradientParameters(){this.colorHarmonyEngine}async updateColorsFromCurrentTrack(){this.musicSyncService&&await this.musicSyncService.processSongUpdate()}evolveHarmonicSignature(t,e){if(this.colorHarmonyEngine){let i=this.utils.hexToRgb(e);if(i){let n=this.colorHarmonyEngine.generateHarmonicVariations(i);return{derivedDarkVibrantHex:n.darkVibrantHex,derivedLightVibrantHex:n.lightVibrantHex}}}return null}async waitForTrackData(t=10,e=100){for(let i=0;i<t;i++){if(Spicetify.Player.data?.track?.uri)return Spicetify.Player.data;await this.utils.sleep(e)}return null}updateHarmonicBaseColor(t){if(this.colorHarmonyEngine&&this.cssConsciousnessController){let e=this.utils.hexToRgb(t);if(e){let i=this.colorHarmonyEngine.generateHarmonicVariations(e);this.cssConsciousnessController.queueCSSVariableUpdate("--sn-harmonic-base-dark-vibrant",i.darkVibrantHex),this.cssConsciousnessController.queueCSSVariableUpdate("--sn-harmonic-base-light-vibrant",i.lightVibrantHex),this.cssConsciousnessController.flushCSSVariableBatch()}}}async processColorsViaFacade(t){try{let e=await this.facadeCoordinator?.getNonVisualSystem("ColorOrchestrator");e&&typeof e.handleColorExtraction=="function"?(await e.handleColorExtraction(t),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Color processing routed through facade pattern - ColorOrchestrator",{context:t?.trackUri||"unknown",rawColorsCount:t?.rawColors?Object.keys(t.rawColors).length:0})):this.colorHarmonyEngine&&typeof this.colorHarmonyEngine.processColors=="function"?(await this.colorHarmonyEngine.processColors(t),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Color processing fallback to direct ColorHarmonyEngine")):console.warn("[Year3000System] No color processing system available via facade pattern")}catch(e){console.error("[Year3000System] Failed to process colors via facade pattern:",e),t?.rawColors&&this.applyColorsToTheme(t.rawColors)}}setupMusicAnalysisAndColorExtraction(){if(console.log("\u{1F3B5} [Year3000System] setupMusicAnalysisAndColorExtraction called"),!this.musicSyncService){console.error("[Year3000System] MusicSyncService is not available to set up song change handler.");return}if(console.log("\u{1F3B5} [Year3000System] MusicSyncService available, checking Spicetify Player..."),!window.Spicetify?.Player){console.warn("[Year3000System] Spicetify.Player not available - music analysis disabled");return}try{g.subscribe("colors:harmonized",e=>{this.handleColorHarmonizedEvent(e)},"Year3000System"),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Subscribed to colors:harmonized events for event-driven color application")}catch(e){console.error("[Year3000System] Failed to subscribe to colors:harmonized events:",e)}let t=async()=>{console.log("\u{1F3B5} [Year3000System] processSongUpdate triggered - checking MusicSyncService..."),this.musicSyncService?(console.log("\u{1F3B5} [Year3000System] Calling musicSyncService.processSongUpdate()"),await this.musicSyncService.processSongUpdate(),console.log("\u2705 [Year3000System] musicSyncService.processSongUpdate() completed")):console.error("\u274C [Year3000System] MusicSyncService not available in processSongUpdate")};this._songChangeHandler=t;try{console.log("\u{1F3B5} [Year3000System] Adding songchange event listener..."),window.Spicetify.Player.addEventListener("songchange",this._songChangeHandler),console.log("\u2705 [Year3000System] Music analysis and color extraction set up successfully - song change listener active"),console.log("\u{1F3B5} [Year3000System] Triggering initial song processing..."),setTimeout(t,1e3)}catch(e){console.error("[Year3000System] Failed to set up music analysis:",e),this._songChangeHandler=null}}updateFromMusicAnalysis(t,e,i){t&&this._updateGlobalKinetics(t)}_updateGlobalKinetics(t){let e=this.utils.getRootStyle();if(!e)return;let i=(l,m=0)=>Number.isFinite(l)?l:m,n=i(t.processedEnergy),r=i(t.valence),a=i(t.enhancedBPM),s=i(t.beatInterval),o=i(t.animationSpeedFactor,1);e.style.setProperty("--sn-kinetic-energy",n.toFixed(3)),e.style.setProperty("--sn-kinetic-valence",r.toFixed(3)),e.style.setProperty("--sn-kinetic-bpm",a.toFixed(2)),e.style.setProperty("--sn-kinetic-beat-interval",`${s.toFixed(0)}ms`),e.style.setProperty("--sn-kinetic-animation-speed",o.toFixed(3))}registerAnimationSystem(t,e,i="normal",n=60){return this.enhancedMasterAnimationCoordinator?(this.enhancedMasterAnimationCoordinator.registerAnimationSystem(t,e,i,n),!0):(console.warn(`[Year3000System] Cannot register ${t} - EnhancedMasterAnimationCoordinator not ready`),!1)}unregisterAnimationSystem(t){return this.enhancedMasterAnimationCoordinator?(this.enhancedMasterAnimationCoordinator.unregisterAnimationSystem(t),!0):!1}getSystem(t){if(!t)return null;if(this.facadeCoordinator){let i=this.facadeCoordinator.getVisualSystem(t);if(i)return i;let n=this.facadeCoordinator.getCachedNonVisualSystem(t);if(n)return n}let e=t.charAt(0).toLowerCase()+t.slice(1);if(this[e])return this[e];for(let i of Object.keys(this)){let n=this[i];if(n&&n.constructor?.name===t)return n}return null}async getFacadeSystemHealthStatus(){return this.facadeCoordinator?await this.facadeCoordinator.performHealthCheck():null}async _registerAnimationSystems(){if(!this.enhancedMasterAnimationCoordinator){console.warn("[Year3000System] EnhancedMasterAnimationCoordinator not available for visual system registration");return}let t=[{name:"BeatSyncVisualSystem",system:this.beatSyncVisualSystem,priority:"critical"},{name:"SidebarSystemsIntegration",system:this.sidebarSystemsIntegration,priority:"normal"},{name:"ParticleConsciousnessModule",system:this.particleConsciousnessModule,priority:"background"},{name:"InteractionTrackingSystem",system:this.interactionTrackingSystem,priority:"background"},{name:"SpotifyUIApplicationSystem",system:this.spotifyUIApplicationSystem,priority:"normal"}];for(let{name:e,system:i,priority:n}of t)if(i&&(typeof i.onAnimate=="function"||typeof i.updateAnimation=="function")){let r=n,a=60,s=i.currentPerformanceProfile;if(s?.frameRate)a=s.frameRate;else if(s?.quality){let o=s.quality;a=o==="high"?60:o==="low"?30:45}e.includes("BeatSync")?r="critical":(e.includes("Particle")||e.includes("DataGlyph"))&&(r="background",a=Math.min(a,30)),this.enhancedMasterAnimationCoordinator.registerAnimationSystem(e,i,r,a),this.YEAR3000_CONFIG.enableDebug&&console.log(`\u{1F3AC} [Year3000System] Registered ${e} with Enhanced Master Animation Coordinator (${r} priority, ${a}fps) - using ${typeof i.onAnimate=="function"?"onAnimate":"updateAnimation"} hook`)}}async _registerEnhancedAnimationSystems(){if(!this.enhancedMasterAnimationCoordinator){console.warn("[Year3000System] EnhancedMasterAnimationCoordinator not available for enhanced visual system registration");return}let t=[{name:"BeatSyncVisualSystem",system:this.beatSyncVisualSystem,priority:"critical",type:"animation"},{name:"SidebarSystemsIntegration",system:this.sidebarSystemsIntegration,priority:"normal",type:"animation"},{name:"ParticleConsciousnessModule",system:this.particleConsciousnessModule,priority:"background",type:"animation"},{name:"InteractionTrackingSystem",system:this.interactionTrackingSystem,priority:"background",type:"animation"},{name:"SpotifyUIApplicationSystem",system:this.spotifyUIApplicationSystem,priority:"normal",type:"animation"}];for(let{name:e,system:i,priority:n,type:r}of t)if(i)try{let a=!1;r==="animation"&&(typeof i.onAnimate=="function"||typeof i.updateAnimation=="function")&&(a=this.enhancedMasterAnimationCoordinator.registerAnimationSystem(e,i,n,60)),a&&this.YEAR3000_CONFIG.enableDebug?console.log(`\u{1F3AC} [Year3000System] Enhanced registration: ${e} (${n} priority, ${r} type)`):a||console.warn(`[Year3000System] Failed to register ${e} with EnhancedMasterAnimationCoordinator`)}catch(a){console.error(`[Year3000System] Error registering ${e} with EnhancedMasterAnimationCoordinator:`,a)}}async initializeWithAvailableAPIs(t){this.availableAPIs=t,this.YEAR3000_CONFIG.enableDebug&&(console.log(`\u{1F31F} [Year3000System] Progressive initialization mode: ${t.degradedMode?"DEGRADED":"FULL"}`),console.log("\u{1F31F} [Year3000System] Available APIs:",{player:!!t.player,platform:!!t.platform,config:!!t.config})),t.degradedMode?(console.log("\u{1F31F} [Year3000System] Initializing in degraded mode (visual-only systems)"),await this.initializeVisualOnlySystems()):(console.log("\u{1F31F} [Year3000System] Initializing in full mode (all systems)"),await this.initializeAllSystems()),t.degradedMode&&this.setupProgressiveEnhancement()}async initializeVisualOnlySystems(){this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Starting visual-only system initialization...");let t=performance.now(),e={success:[],failed:[],skipped:[]};try{this.facadeCoordinator=new Dt(this.YEAR3000_CONFIG,this.utils,this),await this.facadeCoordinator.initialize({mode:"performance-optimized",enableSharedDependencies:!0,enableCrossFacadeCommunication:!1,enableUnifiedPerformanceMonitoring:!0,enableResourceOptimization:!0,performanceThresholds:{maxTotalMemoryMB:50,maxTotalInitTime:3e3,maxCrossCommLatency:100},coordinationPreferences:{preferSharedResources:!0,enableEventPropagation:!1,enableHealthCoordination:!0}}),await this._initializeEssentialFacadeSystems(),e.success.push("FacadeCoordinationSystem")}catch(a){console.error("\u{1F30C} [Year3000System] Failed to initialize degraded facade system:",a),e.failed.push("FacadeCoordinationSystem")}let i=["SettingsManager","MusicSyncService","ColorHarmonyEngine","GlassmorphismManager","Card3DManager","All Visual Systems"];e.skipped.push(...i),this._initializationResults=e,this.initialized=!0;let r=performance.now()-t;this.YEAR3000_CONFIG.enableDebug&&(console.log(`\u{1F31F} [Year3000System] Visual-only initialization complete in ${r.toFixed(2)}ms`),console.log(`\u{1F31F} [Year3000System] Results: ${e.success.length} success, ${e.failed.length} failed, ${e.skipped.length} skipped`))}setupProgressiveEnhancement(){this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Setting up progressive enhancement monitoring...");let t=0,e=30,i=setInterval(()=>{t++;let n=!!window.Spicetify?.Player,r=!!window.Spicetify?.Platform;n&&r&&this.availableAPIs?.degradedMode&&(this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] APIs now available! Triggering upgrade to full mode..."),clearInterval(i),this.upgradeToFullMode().catch(a=>{console.error("[Year3000System] Upgrade to full mode failed:",a)})),t>=e&&(this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Progressive enhancement monitoring stopped (timeout)"),clearInterval(i))},2e3)}async upgradeToFullMode(){this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F31F} [Year3000System] Upgrading from degraded mode to full mode..."),this.availableAPIs={player:window.Spicetify?.Player,platform:window.Spicetify?.Platform,config:window.Spicetify?.Config,degradedMode:!1};try{let t={success:[],failed:[],skipped:[]};try{this.systemHealthMonitor&&this.systemHealthMonitor.registerSystem("SettingsManager",this.settingsManager),t.success.push("SettingsManager")}catch(e){t.failed.push("SettingsManager"),console.error("[Year3000System] Failed to upgrade SettingsManager:",e)}if(this.settingsManager)try{}catch{}if(this.performanceAnalyzer&&this.settingsManager){try{}catch{}this.enhancedMasterAnimationCoordinator&&await this._registerAnimationSystems()}this.YEAR3000_CONFIG.enableDebug&&console.log("[Year3000System] Checking music analysis setup conditions:",{musicSyncService:!!this.musicSyncService,playerAPI:!!this.availableAPIs.player,musicSyncInitialized:this.musicSyncService?.initialized}),this.musicSyncService&&this.availableAPIs.player?(console.log("\u{1F3B5} [Year3000System] Setting up music analysis and color extraction..."),this.setupMusicAnalysisAndColorExtraction()):console.warn("\u26A0\uFE0F [Year3000System] Music analysis setup skipped - missing dependencies:",{musicSyncService:!!this.musicSyncService,playerAPI:!!this.availableAPIs.player}),this.settingsManager&&await this.applyInitialSettings(),this.YEAR3000_CONFIG.enableDebug&&(console.log(`\u{1F31F} [Year3000System] Upgrade complete: ${t.success.length} success, ${t.failed.length} failed`),t.failed.length>0&&console.warn(`\u{1F31F} [Year3000System] Upgrade failed systems: ${t.failed.join(", ")}`),t.skipped&&t.skipped.length>0&&console.info(`\u{1F31F} [Year3000System] Upgrade skipped systems: ${t.skipped.join(", ")}`),t.success.length>0&&console.info(`\u{1F31F} [Year3000System] Upgrade successful systems: ${t.success.join(", ")}`))}catch(t){console.error("[Year3000System] Error during upgrade to full mode:",t)}}_handleExternalSettingsChange(t){let{key:e,value:i}=t.detail||{};if(e){switch(e){case"artisticMode":{try{typeof this.YEAR3000_CONFIG.safeSetArtisticMode=="function"&&this.YEAR3000_CONFIG.safeSetArtisticMode(i)}catch(n){console.warn("[Year3000System] Failed to apply artistic mode",n)}break}case"harmonicIntensity":{let n=parseFloat(i);Number.isNaN(n)||(this.YEAR3000_CONFIG.harmonicIntensity=n,this.colorHarmonyEngine&&(this.colorHarmonyEngine.setIntensity?.(n),this.updateColorsFromCurrentTrack?.()));break}case"harmonicEvolution":{let n=i==="true"||i===!0;this.allowHarmonicEvolution=n,this.YEAR3000_CONFIG.harmonicEvolution=n;break}case"manualBaseColor":{typeof i=="string"&&i.trim()!==""&&i.startsWith("#")?(this.updateHarmonicBaseColor(i),this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Manual base color applied:",i)):this.YEAR3000_CONFIG.enableDebug&&console.log("\u{1F3A8} [Year3000System] Manual base color cleared - using album art colors");break}case"harmonicMode":{i!=null&&(this.YEAR3000_CONFIG.currentHarmonicMode=String(i),this.updateColorsFromCurrentTrack?.());break}default:break}this._broadcastSettingChange(e,i),this._refreshConditionalSystems()}}_broadcastSettingChange(t,e){[this.colorHarmonyEngine,this.glassmorphismManager,this.card3DManager,this.lightweightParticleSystem,this.interactionTrackingSystem,this.beatSyncVisualSystem,this.sidebarSystemsIntegration,this.particleFieldSystem].forEach(n=>{if(n&&typeof n.applyUpdatedSettings=="function")try{n.applyUpdatedSettings(t,e)}catch(r){console.warn(`[Year3000System] ${n.systemName||n.constructor?.name||"UnknownSystem"} failed to applyUpdatedSettings`,r)}})}_applyPerformanceProfile(){}_refreshConditionalSystems(){}_onArtisticModeChanged(){try{this.updateColorsFromCurrentTrack?.()}catch(t){console.warn("[Year3000System] _onArtisticModeChanged stub error",t)}}_handleVisibilityChange(){if(document.visibilityState==="hidden")try{this.cssConsciousnessController?.flushCSSVariableBatch?.();try{}catch{}this.YEAR3000_CONFIG?.enableDebug&&console.log("\u{1F31F} [Year3000System] Visibility hidden \u2192 forced flush of pending style updates")}catch(t){this.YEAR3000_CONFIG?.enableDebug&&console.warn("[Year3000System] VisibilityChange flush error",t)}}async destroy(){try{await this.destroyAllSystems(),document.removeEventListener("visibilitychange",this._handleVisibilityChange.bind(this)),this.initialized=!1,console.log("\u{1F31F} [Year3000System] System destroyed successfully")}catch(t){console.error("\u274C [Year3000System] Error during destroy:",t)}}},Ws=new Lt;typeof window<"u"&&(window.year3000System=Ws);qs=Ws});var Zs={};ie(Zs,{enableDragCartography:()=>$c,getDragMap:()=>Wc});function $c(){let c=globalThis;c.__SN_dragCartographer||(c.__SN_dragCartographer=new Yi,console.info("\u{1F6F0}\uFE0F  DragCartographer enabled \u2013 logging dragstart events"))}function Wc(){return Yi.getDragMap()}var _e,Yi,Js=y(()=>{"use strict";_e=class _e{constructor(){this.seen=new WeakSet;this.handleDragStart=t=>{let e=t.target;if(!e||this.seen.has(e))return;this.seen.add(e);let i=_e.buildSelectorPath(e),n={time:new Date().toLocaleTimeString(),selector:i};try{let s=t.dataTransfer;if(s){let o=s.getData("text/spotify")||s.getData("text/uri-list");o&&(n.uris=o.split(/\n|,/).filter(Boolean));let l=s.getData("text/plain");l&&(n.label=l)}}catch{}let r=_e.aggregate,a=r.get(i);a?(a.count+=1,a.samples.length<3&&a.samples.push(n)):r.set(i,{selector:i,count:1,samples:[n]}),console.groupCollapsed(`%c[DragCartographer] dragstart \u2192 ${i}`,"color:#7dd3fc;font-weight:600"),console.table(n),console.log("Event:",t),console.log("Target element snapshot:",e),console.groupEnd()};document.addEventListener("dragstart",this.handleDragStart,!0)}static buildSelectorPath(t){let e=[],i=t,n=0;for(;i&&n<_e.MAX_PATH_DEPTH;){let r=i.tagName.toLowerCase(),a=i.id?`#${i.id}`:"",s=i.className&&typeof i.className=="string"?"."+i.className.split(/\s+/).slice(0,2).join("."):"";e.push(`${r}${a}${s}`),i=i.parentElement,n+=1}return e.join(" > ")}static getDragMap(){return Array.from(_e.aggregate.values()).sort((t,e)=>e.count-t.count)}};_e.MAX_PATH_DEPTH=4,_e.aggregate=new Map;Yi=_e});function to(c,t,e={}){let i=`${c}|${t}|${e.size}|${e.dpr}`,n=eo.get(i);if(n)return n;let r=e.size??72,a=e.dpr??(window.devicePixelRatio||1),s=e.borderRadius??8,o=document.createElement("canvas");o.width=r*a,o.height=r*a,o.style.width=`${r}px`,o.style.height=`${r}px`;let l=o.getContext("2d");l.scale(a,a),l.fillStyle="rgba(32,32,35,0.9)",l.roundRect(0,0,r,r,s),l.fill(),e.shadow!==!1&&(l.shadowColor="rgba(0,0,0,0.4)",l.shadowBlur=6);let m=r-16;if(t){let h=new Image;h.src=t;let p=()=>{l.save(),l.beginPath(),l.roundRect(8,8,m,m,s-2),l.clip(),l.drawImage(h,8,8,m,m),l.restore(),d()};h.complete?p():(h.onload=p,h.onerror=d)}else d();function d(){l.fillStyle="#fff",l.font="500 12px Inter, sans-serif",l.textAlign="center",l.textBaseline="middle";let h=r-10,p=c;for(;l.measureText(p).width>h&&p.length>4;)p=p.slice(0,-2);p!==c&&(p=p.slice(0,-1)+"\u2026"),l.fillText(p,r/2,r-10)}return eo.set(i,o),o}var eo,io=y(()=>{"use strict";eo=new Map});var ro={};ie(ro,{enableEnhancedDragPreview:()=>Xc});function Yc(c,t){try{return to(c,t)}catch{let e=document.createElement("div");return e.textContent=c,e.style.padding="4px 6px",e.style.fontSize="12px",e.style.background="rgba(32,32,35,0.9)",e.style.color="#fff",e}}function no(c){let t=c.querySelector("img[src]");if(t?.src)return t.src;let e=getComputedStyle(c).backgroundImage,i=e&&/url\("?([^\"]+)"?\)/.exec(e);return i?i[1]:void 0}function Kc(c){let t=c.getAttribute("aria-label")||c.getAttribute("title");return t||(document.createTreeWalker(c,NodeFilter.SHOW_TEXT,{acceptNode(n){return n.textContent?.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}}).nextNode()?.textContent?.trim()||"").slice(0,60)}function jc(c){if(Pr.has(c))return Pr.get(c);let t=Kc(c);if(!t)return null;let e=no(c),i=e?{label:t,img:e}:{label:t};return Pr.set(c,i),i}function Qc(c){try{if(!c.dataTransfer||typeof c.dataTransfer.setDragImage!="function")return;let t=c.target;if(!t)return;let e=c.dataTransfer.getData("text/plain"),i;if(e)i=no(t);else{let s=jc(t);if(!s)return;e=s.label,i=s.img}let n=Yc(e,i);document.body.appendChild(n);let r=n.offsetWidth/2;c.dataTransfer.setDragImage(n,r,r);let a=()=>{n.remove(),window.removeEventListener("dragend",a,!0)};window.addEventListener("dragend",a,!0)}catch(t){console.debug("[StarryNight] EnhancedDragPreview failed:",t)}}function Xc(c={}){let t=globalThis;t.__SN_enhancedDragPreview||(t.__SN_enhancedDragPreview=!0,Object.assign(qc,c),document.addEventListener("dragstart",Qc,!0),console.info("\u{1F320} Enhanced drag preview enabled"))}var qc,Pr,ao=y(()=>{"use strict";io();qc={size:72,borderRadius:8,fontSize:12},Pr=new WeakMap});function Ki(c){let t=c.stiffness??260,e=c.damping??24,i=c.mass??1,n={},r={},a={},s=null;function o(){let l=!0,m=1/60;for(let d in a){let h=n[d]??0,p=r[d]??0,b=a[d]??0,v=-t*(h-b),C=-e*p,P=(v+C)/i,E=p+P*m,L=h+E*m;r[d]=E,n[d]=L,(Math.abs(E)>.1||Math.abs(L-b)>.1)&&(l=!1)}c.onUpdate(n),l||(s=requestAnimationFrame(o))}return{to(l){a=l,s||(s=requestAnimationFrame(o))}}}var Tr=y(()=>{"use strict";window.snFlipSpringLoaded=!0});function xr(){let c=document.querySelector(Zc);if(!c)return null;let t=c.getBoundingClientRect();return{node:c,rect:t}}function Ar(){let c=!!xr(),t=typeof Element.prototype.cloneNode=="function",e=!!window.snFlipSpringLoaded;return c&&t&&e}var Zc,Ir=y(()=>{"use strict";Zc='[data-testid="rootlist-container"]'});var co={};ie(co,{destroySidebarClone:()=>ji,launchSidebarClone:()=>Jc});function Jc(c){$e&&($e.abort(),$e=null),Ne&&ji(),$e=new AbortController;let{signal:t}=$e;if(Ne)return;let e=xr();if(!e)return;let i=e.node.cloneNode(!0);i.id="",i.setAttribute("aria-hidden","true"),i.classList.add("sn-clone-overlay"),i.style.position="fixed",i.style.top=`${e.rect.top}px`,i.style.left=`${e.rect.left}px`,i.style.width=`${e.rect.width}px`,i.style.height=`${e.rect.height}px`,i.style.zIndex="9999",i.style.willChange="transform, opacity",i.style.contain="paint",function(b){let v=document.createTreeWalker(b,NodeFilter.SHOW_ELEMENT);for(;v.nextNode();){let C=v.currentNode;C.hasAttribute("aria-label")&&C.removeAttribute("aria-label"),C.tabIndex>=0&&(C.tabIndex=-1)}}(i),document.body.appendChild(i),Ne=i;let n=0,r=0,a=1,s=c.cursorX-e.rect.left-e.rect.width*.2,o=c.cursorY-e.rect.top-e.rect.height*.2,l=.6;if(window.matchMedia("(prefers-reduced-motion: reduce)").matches){i.style.transform=`translate(${s}px, ${o}px) scale(${l})`,oo(i,c);return}let d=Ki({stiffness:220,damping:20,onUpdate:p=>{t.aborted||(i.style.transform=`translate(${p.x}px, ${p.y}px) scale(${p.s})`)}});i.style.transformOrigin="top left",i.style.transform=`translate(${n}px, ${r}px) scale(${a})`,requestAnimationFrame(()=>d.to({x:s,y:o,s:l}));let h=setTimeout(()=>{!t.aborted&&Ne&&oo(Ne,c)},400);t.addEventListener("abort",()=>clearTimeout(h)),t.addEventListener("abort",()=>ji())}function ji(){Rr.forEach(c=>c()),Rr.length=0,Ne&&(Ne.remove(),Ne=null),$e&&($e.abort(),$e=null)}function el(c,t){try{let e=window.Spicetify?.CosmosAsync;if(!e)return;let i=`/v1/playlists/${c.split(":").pop()}/tracks`;e.post(i,{uris:t})}catch{}}function oo(c,t){let e=Array.from(c.querySelectorAll('[data-uri^="spotify:playlist:"]'));if(!e.length)return;let i=e.slice(0,5);e.slice(5).forEach(r=>{r.classList.add("sn-prune-out"),setTimeout(()=>r.remove(),180)}),i.forEach((r,a)=>{r.setAttribute("data-index",String(a+1)),r.setAttribute("role","button"),r.tabIndex=0,r.style.setProperty("--sn-glow-level","0"),r.style.backgroundImage="paint(sn-aura)",r.addEventListener("mouseenter",()=>r.style.setProperty("--sn-glow-level","1")),r.addEventListener("mouseleave",()=>r.style.setProperty("--sn-glow-level","0"));let s=r.getAttribute("data-uri");if(!s)return;let o=t.uris,l=m=>{m.preventDefault(),m.stopPropagation();let d=r.querySelector("img");tl(s,d?.src||"",r.textContent?.trim()||"Playlist"),el(s,o),il("Track added to "+(r.textContent?.trim()||"playlist")),ji()};r.addEventListener("click",l),r.addEventListener("keydown",m=>{(m.key==="Enter"||m.key===" ")&&l(m)})});let n=r=>{let a=parseInt(r.key,10);a>=1&&a<=i.length&&i[a-1]?.click()};window.addEventListener("keydown",n,{capture:!0}),Rr.push(()=>window.removeEventListener("keydown",n,{capture:!0}))}function tl(c,t,e){try{let i=localStorage.getItem(so),n=i?JSON.parse(i):[],r=n.findIndex(a=>a.uri===c);r!==-1&&n.splice(r,1),n.unshift({uri:c,image:t,name:e}),localStorage.setItem(so,JSON.stringify(n.slice(0,10)))}catch{}}function il(c){let t=document.getElementById("sn-live");t&&(t.textContent=c)}var Ne,Rr,$e,so,lo=y(()=>{"use strict";Tr();Ir();Ne=null,Rr=[],$e=null,so="sn-recent-playlists"});var mo={};ie(mo,{enableQuickAddRadialMenu:()=>bl});function al(){let c=document.getElementById(Br);return c||(c=document.createElement("div"),c.id=Br,c.setAttribute("aria-live","polite"),c.style.position="absolute",c.style.width="1px",c.style.height="1px",c.style.overflow="hidden",c.style.clipPath="inset(100%)",c.style.clip="rect(1px,1px,1px,1px)",c.style.whiteSpace="nowrap",document.body.appendChild(c)),c}function sl(c,t,e,i){let n=c-e,r=t-i;return Math.sqrt(n*n+r*r)}function uo(){try{let c=localStorage.getItem("sn-recent-playlists");if(!c)return[];let t=JSON.parse(c);return Array.isArray(t)?t.slice(0,Qi):[]}catch{return[]}}function ol(c,t){try{let e=`/v1/playlists/${c.split(":").pop()}/tracks`;window.Spicetify?.CosmosAsync.post(e,{uris:t})}catch(e){console.warn("[StarryNight] QuickAddRadial failed to add tracks:",e)}}function cl(c){try{let t=uo(),e=t.findIndex(n=>n.uri===c.uri);e!==-1&&t.splice(e,1),t.unshift(c);let i=t.slice(0,10);localStorage.setItem("sn-recent-playlists",JSON.stringify(i))}catch{}}function ll(c,t,e){if(!e.length)return;Fr(),ue=document.createElement("div"),ue.className="sn-quick-add-overlay",ue.style.position="fixed",ue.style.inset="0",ue.style.pointerEvents="none",ue.style.zIndex="9999";let i=document.createElement("div");i.className="sn-quick-add-center",i.style.position="absolute",i.style.left=`${c}px`,i.style.top=`${t}px`,i.style.width="0",i.style.height="0",ue.appendChild(i),document.body.appendChild(ue);let n=90,r=Math.PI*2/e.length;e.forEach((s,o)=>{let l=r*o-Math.PI/2,m=document.createElement("button");m.className="sn-quick-add-btn",m.style.position="absolute",m.style.width="64px",m.style.height="64px",m.style.borderRadius="50%",m.style.border="2px solid rgba(255,255,255,0.4)",m.style.background=`url('${s.image}') center/cover no-repeat`,m.style.cursor="pointer",m.style.pointerEvents="auto";let d=n*Math.cos(l),h=n*Math.sin(l);m.style.transform=`translate(${d-32}px, ${h-32}px)`,m.style.transformOrigin="center center";let p=0,b=0;m.style.transform=`translate(${p}px, ${b}px) scale(0.1)`,requestAnimationFrame(()=>{Ki({stiffness:220,damping:20,onUpdate:C=>{m.style.transform=`translate(${C.x}px, ${C.y}px) scale(${C.s})`}}).to({x:d-32,y:h-32,s:1})}),m.title=`Add to ${s.name}`,m.addEventListener("click",v=>{v.preventDefault(),v.stopPropagation(),zt&&ol(s.uri,zt),cl(s),Fr()}),i.appendChild(m)});let a=al();a.textContent="Quick-add menu open. Press number keys 1 to 5 to pick a playlist or continue dragging."}function Fr(){ue?.remove(),ue=null;let c=document.getElementById(Br);c&&(c.textContent="")}function Gr(){Ot&&(clearTimeout(Ot),Ot=null)}function ul(c){Dr=c.clientX,kr=c.clientY,zt=(c.dataTransfer?.getData("text/spotify")||"").split(/[\n,]/).filter(Boolean);let t=Ar();Gr(),Ot=window.setTimeout(async()=>{if(t)(await Promise.resolve().then(()=>(lo(),co))).launchSidebarClone({cursorX:Lr.x,cursorY:Lr.y,uris:zt??[]});else{let e=await pl();ll(Dr,kr,e)}},nl)}function ml(){Gr(),Fr(),zt=null}function dl(c){Lr={x:c.clientX,y:c.clientY},Ot&&sl(Dr,kr,c.clientX,c.clientY)>rl&&Gr()}async function hl(){try{let c=window.Spicetify?.CosmosAsync;if(!c)return[];let t=await c.get("https://api.spotify.com/v1/me/playlists?limit=10");return t?.items?t.items.slice(0,Qi).map(e=>({uri:e.uri,name:e.name,image:e.images?.[0]?.url||""})):[]}catch{return[]}}function gl(){try{let c=Array.from(document.querySelectorAll('[data-testid="rootlist-card"]')),t=[];for(let e of c){let i=e.getAttribute("data-uri")||e.querySelector("a")?.getAttribute("href")?.replace("/playlist/","spotify:playlist:");if(!i)continue;let n=e.querySelector("img"),r=n?.src||"",a=n?.alt||e.textContent?.trim()||"Playlist";if(t.push({uri:i,image:r,name:a}),t.length>=Qi)break}return t}catch{return[]}}async function pl(){let c=uo();if(c.length)return c;let t=gl();return t.length?t:await hl()}function bl(){let c=globalThis;c.__SN_quickAddRadial||(c.__SN_quickAddRadial=!0,window.addEventListener("dragstart",ul,!0),window.addEventListener("dragend",ml,!0),window.addEventListener("pointermove",dl,!0),console.info("\u{1F30C} Quick-Add radial menu enabled"),console.info(`[StarryNight] Sidebar clone capability: ${Ar()}`))}var nl,rl,Qi,Ot,Dr,kr,ue,zt,Lr,Br,ho=y(()=>{"use strict";Tr();Ir();nl=250,rl=8,Qi=5,Ot=null,Dr=0,kr=0,ue=null,zt=null,Lr={x:0,y:0},Br="sn-live";document.addEventListener("keydown",c=>{if(!ue)return;let t=parseInt(c.key,10);t>=1&&t<=Qi&&ue.querySelectorAll(".sn-quick-add-btn")[t-1]?.click()})});var po={};ie(po,{PrismaticScrollSheenSystem:()=>Xi,initializePrismaticScrollSheen:()=>go});function go(){try{let c=new Xi;qs?.registerVisualSystem?.(c,"background")}catch(c){console.error("[PrismaticScrollSheen] Failed to init:",c)}}var yl,Xi,bo=y(()=>{"use strict";Mr();N();yl=6e3,Xi=class{constructor(t=yl){this.cyclePx=t;this.systemName="PrismaticScrollSheen";this._lastRatio=-1;let e=globalThis.year3000System;this.cssController=e?.cssConsciousnessController||T(),this.cssController.setVariable("PrismaticScrollSheenSystem","--sn-scroll-cycle-px",String(t),"normal","scroll-cycle-init")}onAnimate(t,e){let i=e.scrollRatio??0;if(Math.abs(i-this._lastRatio)<.001)return;this._lastRatio=i;let n={"--sn-cdf-scroll-ratio":i.toFixed(4),"--sn-scroll-ratio":i.toFixed(4)};this.cssController.batchSetVariables("PrismaticScrollSheenSystem",n,"high","scroll-ratio-update")}onPerformanceModeChange(){}destroy(){}};window.Y3K?.system?.registerVisualSystem&&go()});var q,yo,Zi,fo=y(()=>{"use strict";q=Yr(Wr("react")),yo=Yr(Wr("react-dom")),Zi=class{constructor(t,e,i={}){this.name=t;this.settingsId=e;this.initialSettingsFields=i;this.settingsFields=this.initialSettingsFields;this.setRerender=null;this.pushSettings=async()=>{for(Object.entries(this.settingsFields).forEach(([t,e])=>{e.type!=="button"&&this.getFieldValue(t)===void 0&&this.setFieldValue(t,e.defaultValue)});!window.Spicetify?.Platform?.History?.listen;)await new Promise(t=>setTimeout(t,100));this.stopHistoryListener&&this.stopHistoryListener(),this.stopHistoryListener=window.Spicetify.Platform.History.listen(t=>{t.pathname==="/preferences"&&this.render()}),window.Spicetify.Platform.History.location.pathname==="/preferences"&&await this.render()};this.rerender=()=>{this.setRerender?.(Math.random())};this.addDropDown=(t,e,i,n,r,a)=>{this.settingsFields[t]={type:"dropdown",description:e,defaultValue:i[n],options:i,events:a}};this.addToggle=(t,e,i,n)=>{this.settingsFields[t]={type:"toggle",description:e,defaultValue:i,events:n}};this.addInput=(t,e,i,n="text",r)=>{this.settingsFields[t]={type:"input",description:e,defaultValue:i,inputType:n,events:r}};this.getFieldValue=t=>{let e=window.Spicetify?.LocalStorage.get(t);if(e==null){let i=`${this.settingsId}.${t}`,n=window.Spicetify?.LocalStorage.get(i);if(n)try{let a=JSON.parse(n)?.value??n;return window.Spicetify?.LocalStorage.set(t,a),window.Spicetify?.LocalStorage.remove(i),a}catch{return n}return}return e};this.FieldsContainer=()=>{let[t,e]=(0,q.useState)(0);return this.setRerender=e,q.default.createElement("div",{className:"x-settings-section",key:t},q.default.createElement("h2",{className:"TypeElement-cello-textBase-type"},this.name),Object.entries(this.settingsFields).map(([i,n])=>q.default.createElement(this.Field,{key:i,nameId:i,field:n})))};this.Field=({nameId:t,field:e})=>{let i=`${this.settingsId}.${t}`,n=e.type==="button"?e.value:this.getFieldValue(t)??e.defaultValue,[r,a]=(0,q.useState)(n),s=m=>{a(m),this.setFieldValue(t,m);try{let d=new CustomEvent("year3000SystemSettingsChanged",{detail:{key:t,value:m}});document.dispatchEvent(d)}catch(d){console.warn(`[SettingsSection] Failed to emit settings change event for ${t}:`,d)}};if(e.type==="hidden")return q.default.createElement(q.default.Fragment,null);let o=q.default.createElement("label",{className:"TypeElement-viola-textSubdued-type",htmlFor:i},e.description||""),l=null;switch(e.type){case"dropdown":l=q.default.createElement("select",{className:"main-dropDown-dropDown",id:i,...e.events,onChange:m=>{let d=m.currentTarget.selectedIndex,h=e.options[d];s(h),e.events?.onChange?.(m)}},e.options.map((m,d)=>q.default.createElement("option",{key:m,value:m,selected:m===r},m)));break;case"toggle":l=q.default.createElement("label",{className:"x-settings-secondColumn x-toggle-wrapper"},q.default.createElement("input",{id:i,className:"x-toggle-input",type:"checkbox",checked:!!r,...e.events,onClick:m=>{let d=m.currentTarget.checked;s(d),e.events?.onClick?.(m)}}),q.default.createElement("span",{className:"x-toggle-indicatorWrapper"},q.default.createElement("span",{className:"x-toggle-indicator"})));break;case"input":l=q.default.createElement("input",{className:"x-settings-input",id:i,dir:"ltr",value:r,type:e.inputType||"text",...e.events,onChange:m=>{s(m.currentTarget.value),e.events?.onChange?.(m)}});break;case"button":l=q.default.createElement("button",{id:i,className:"Button-sc-y0gtbx-0 Button-small-buttonSecondary-useBrowserDefaultFocusStyle x-settings-button",...e.events,onClick:m=>{e.events?.onClick?.(m)},type:"button"},r);break;default:l=null}return q.default.createElement("div",{className:"x-settings-row"},q.default.createElement("div",{className:"x-settings-firstColumn"},o),q.default.createElement("div",{className:"x-settings-secondColumn"},l))}}async render(){for(;!document.getElementById("desktop.settings.selectLanguage");){if(window.Spicetify.Platform.History.location.pathname!=="/preferences")return;await new Promise(i=>setTimeout(i,100))}let t=document.querySelector(".main-view-container__scroll-node-child main div");if(!t)return console.error("[StarryNight] settings container not found");let e=Array.from(t.children).find(i=>i.id===this.settingsId);e||(e=document.createElement("div"),e.id=this.settingsId,t.appendChild(e)),yo.default.render(q.default.createElement(this.FieldsContainer,null),e)}setFieldValue(t,e){window.Spicetify?.LocalStorage.set(t,e)}}});var Hr={};ie(Hr,{initializeStarryNightSettings:()=>fl});function So(){return globalThis.year3000System?.cssConsciousnessController||T()}async function fl(){let c=new Zi("StarryNight Theme","starrynight-settings"),t=["dynamic","rosewater","flamingo","pink","mauve","red","maroon","peach","yellow","green","teal","sky","sapphire","blue","lavender"];function e(){let F=window.Y3K?.system?.settingsManager;if(F)return F;let H=globalThis.__SN_settingsManager;if(H)return H;let z=new ee;return globalThis.__SN_settingsManager=z,z}let i=e(),n=i.get("catppuccin-accentColor");c.addDropDown("catppuccin-accentColor","Accent colour (primary theme color)",t,Math.max(0,t.indexOf(n)),void 0,{onChange:F=>{try{let H=F?.currentTarget?.selectedIndex??0,z=t[H]??"mauve";i.set("catppuccin-accentColor",z);let Vt=i.get("sn-gradient-intensity");kt(Vt,Vt);try{globalThis.Y3K?.system?.applyInitialSettings?.("accent")}catch(Ji){console.warn("[StarryNight] Unable to trigger Year3000System colour refresh",Ji)}}catch(H){console.error("[StarryNight] Failed to update accent colour",H)}}});let r=["disabled","minimal","balanced","intense"],a=i.get("sn-gradient-intensity");c.addDropDown("sn-gradient-intensity","Background effects intensity (stars, nebula, flow gradients)",r,Math.max(0,r.indexOf(a)),void 0,{onChange:F=>{let H=F?.currentTarget?.selectedIndex??0,z=r[H]??"balanced";i.set("sn-gradient-intensity",z),kt(z,z)}});let s=["bright","balanced","dark"],o=i.get("sn-brightness-mode")||"dark";c.addDropDown("sn-brightness-mode","Brightness mode",s,Math.max(0,s.indexOf(o)),void 0,{onChange:F=>{let H=F?.currentTarget?.selectedIndex??0,z=s[H]??"bright";i.set("sn-brightness-mode",z);let Vt=So(),Ji={"--sn-brightness-mode":`"${z}"`,"--sn-brightness-data-attr":z};Vt.batchSetVariables("StarryNightSettings",Ji,"high","brightness-mode-change"),document.documentElement.setAttribute("data-sn-brightness",z);try{globalThis.Y3K?.system?.applyInitialSettings?.("brightness"),console.log(`[StarryNight] Brightness mode changed to: ${z}`)}catch(Ao){console.warn("[StarryNight] Unable to trigger Year3000System brightness refresh",Ao)}}});let l=["latte","frappe","macchiato","mocha"],m=i.get("catppuccin-flavor");c.addDropDown("catppuccin-flavor","Catppuccin flavour (light/dark theme base)",l,Math.max(0,l.indexOf(m)),void 0,{onChange:F=>{let H=F?.currentTarget?.selectedIndex??0;i.set("catppuccin-flavor",l[H]);try{globalThis.Y3K?.system?.applyInitialSettings?.("flavor")}catch(z){console.warn("[StarryNight] Unable to trigger flavor refresh",z)}}});let d=["catppuccin","year3000"],h=["Catppuccin Classic","Year 3000 Cinematic"],p=i.get("sn-palette-system");c.addDropDown("sn-palette-system","Palette system (color foundation vs enhancement)",h,Math.max(0,d.indexOf(p)),void 0,{onChange:F=>{let H=F?.currentTarget?.selectedIndex??0;i.set("sn-palette-system",d[H]);try{globalThis.Y3K?.system?.applyInitialSettings?.("palette")}catch(z){console.warn("[StarryNight] Unable to trigger palette system refresh",z)}}});let b=["disabled","minimal","moderate","intense"],v=i.get("sn-glassmorphism-level");c.addDropDown("sn-glassmorphism-level","Glassmorphism",b,Math.max(0,b.indexOf(v)),void 0,{onChange:F=>{let H=F?.currentTarget?.selectedIndex??0;i.set("sn-glassmorphism-level",b[H])}});let C=["corporate-safe","artist-vision","cosmic-maximum"],P=i.get("sn-artistic-mode");c.addDropDown("sn-artistic-mode","Artistic mode",C,Math.max(0,C.indexOf(P)),void 0,{onChange:F=>{let H=F?.currentTarget?.selectedIndex??0,z=C[H];i.set("sn-artistic-mode",z),globalThis.year3000System?.YEAR3000_CONFIG?.safeSetArtisticMode?.(z)}});let E=Object.keys(se),L=i.get("sn-current-harmonic-mode");E.length&&c.addDropDown("sn-current-harmonic-mode","Harmonic colour mode",E,Math.max(0,E.indexOf(L)),void 0,{onChange:F=>{let H=F?.currentTarget?.selectedIndex??0,z=E[H];i.set("sn-current-harmonic-mode",z),globalThis.Y3K?.system?.evolveHarmonicSignature?.(z)}});let $=i.get("sn-harmonic-intensity")||"0.7";c.addInput("sn-harmonic-intensity","Harmonic intensity (music-color sync strength 0-1)",$,"number",{onChange:F=>{let H=F.currentTarget.value;i.set("sn-harmonic-intensity",H)}});let G=i.get("sn-harmonic-evolution")==="true";c.addToggle("sn-harmonic-evolution","Allow harmonic evolution",G,{onClick:F=>{let H=F.currentTarget.checked;i.set("sn-harmonic-evolution",H?"true":"false")}});let B=i.get("sn-webgl-enabled")==="true";c.addToggle("sn-webgl-enabled","WebGL effects (master toggle for all WebGL backgrounds)",B,{onClick:F=>{let H=F.currentTarget.checked;i.set("sn-webgl-enabled",H?"true":"false")}});let W=["low","medium","high"],V=i.get("sn-webgl-quality")||"medium";c.addDropDown("sn-webgl-quality","WebGL quality (performance vs visual quality)",W,Math.max(0,W.indexOf(V)),void 0,{onChange:F=>{let H=F?.currentTarget?.selectedIndex??1,z=W[H]??"medium";i.set("sn-webgl-quality",z)}});let R=["auto","low","high"],ae=i.get("sn-animation-quality")||"auto";c.addDropDown("sn-animation-quality","Animation quality (auto/low/high performance)",R,Math.max(0,R.indexOf(ae)),void 0,{onChange:F=>{let H=F?.currentTarget?.selectedIndex??0,z=R[H]??"auto";i.set("sn-animation-quality",z)}}),await c.pushSettings(),console.log("\u2728 [StarryNight] spcr-settings panel initialised");let Pe=i.get("sn-brightness-mode")||"dark",pe=So(),Je={"--sn-brightness-mode":`"${Pe}"`,"--sn-brightness-data-attr":Pe};pe.batchSetVariables("StarryNightSettings",Je,"high","brightness-mode-init"),document.documentElement.setAttribute("data-sn-brightness",Pe),console.log(`[StarryNight] Initial brightness mode set to: ${Pe}`);let Nr=()=>c.rerender(),$r=globalThis.Spicetify?.Platform?.History;try{$r?.listen&&$r.listen(({location:F})=>{F?.pathname==="/settings"&&setTimeout(Nr,100)})}catch(F){console.warn("[StarryNight] Could not hook navigation for settings",F)}window.location.pathname==="/settings"&&setTimeout(Nr,300)}var Or=y(()=>{"use strict";U();N();fo();ke();Cr()});var vo={};ie(vo,{RightSidebarConsciousnessSystem:()=>zr});var zr,Co=y(()=>{"use strict";D();ge();Ei();zr=class extends Q{constructor(e,i,n,r,a,s=null,o){super(e,i,n,r,a);this.currentBeatIntensity=0;this.targetBeatIntensity=0;this.currentHueShift=0;this.targetHueShift=0;this.INTENSITY_LERP=.25;this.HUE_LERP=.05;this.fallbackRafId=null;this.lastTimestamp=performance.now();this.unsubBeat=null;this.unsubEnergy=null;this.year3000System=s,this.coordinator=o||Ue.getInstance({enableDebug:e.enableDebug,performanceAnalyzer:n,onFlushComplete:()=>{n?.emitTrace?.("[RightSidebarConsciousnessSystem] Coordinator flush completed")}})}async _performSystemSpecificInitialization(){let e=g.subscribe("music:beat",n=>this._handleBeat({intensity:n.intensity,timestamp:n.timestamp}),"RightSidebarConsciousnessSystem");this.unsubBeat=()=>g.unsubscribe(e);let i=g.subscribe("music:energy",n=>this._handleEnergy({energy:n.energy,timestamp:n.timestamp}),"RightSidebarConsciousnessSystem");this.unsubEnergy=()=>g.unsubscribe(i),this._tryRegisterWithMasterAnimation()}_tryRegisterWithMasterAnimation(){this.year3000System?.registerAnimationSystem&&this.year3000System.enhancedMasterAnimationCoordinator&&this.year3000System.registerAnimationSystem("RightSidebarConsciousnessSystem",this,"background",60)||this._startFallbackLoop()}_handleBeat({intensity:e}){this.targetBeatIntensity=Math.min(Math.max(e,0),1)}_handleEnergy({energy:e}){let i=Math.round(e*120);this.targetHueShift=i}onAnimate(e){this._tick(e)}_startFallbackLoop(){let e=i=>{let n=i-this.lastTimestamp;this.lastTimestamp=i,this._tick(n),this.fallbackRafId=requestAnimationFrame(e)};this.fallbackRafId=requestAnimationFrame(e)}_tick(e){this.currentBeatIntensity=this._lerp(this.currentBeatIntensity,this.targetBeatIntensity,this.INTENSITY_LERP),this.currentHueShift=this._lerp(this.currentHueShift,this.targetHueShift,this.HUE_LERP),this._queueCssVar("--sn-rs-beat-intensity",this.currentBeatIntensity);let i=(.15+this.currentBeatIntensity*.45).toFixed(3);this._queueCssVar("--sn-rs-glow-alpha",i),this._queueCssVar("--sn-rs-hue-shift",`${this.currentHueShift}deg`)}_queueCssVar(e,i){this.coordinator.queueUpdate(e,String(i))}_lerp(e,i,n){return e+(i-e)*n}destroy(){super.destroy(),this.unsubBeat?.(),this.unsubEnergy?.(),this.fallbackRafId&&cancelAnimationFrame(this.fallbackRafId)}}});var Mo={};ie(Mo,{DepthConsciousnessController:()=>Ur});var Ur,wo=y(()=>{"use strict";U();N();A();K();ge();Ur=class extends Q{constructor(e=w,i=I,n=null,r=null,a=null){super(e,i,n,r,a);this.contentAreas=new Map;this.chromeAreas=new Set;this.userState={isScrolling:!1,isHovering:!1,lastInteractionTime:0,readingModeActive:!1,interactionTarget:null,currentMode:"browsing",focusDepth:.3,scrollVelocity:0,dwellTime:0,interactionPattern:"casual",contentEngagement:.5};this.musicalState={energy:.5,valence:.5,instrumental:!1,tempo:120,emotionalTemperature:.5,musicSyncStrength:.7,genreConsciousnessProfile:{ambientLevel:.5,energyResponse:.6,visualComplexity:.5},musicalMemoryPatterns:.4};this.readingModeTimer=0;this.interactionTimer=0;this.consciousnessUpdateInterval=0;this.lastUpdate=0;this.updateThreshold=100;this.consciousnessIntensity=.7;this.adaptiveProtectionMap=new Map;this.scrollVelocityHistory=[];this.dwellTimeTracker=new Map}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{let e=globalThis.year3000System;this.cssController=e?.cssConsciousnessController||T(),this.detectContentAndChromeAreas(),this.setupInteractionListeners(),this.initializeConsciousnessVariables(),this.startConsciousnessUpdate(),u?.debug?.log("DepthConsciousnessController","Consciousness system awakened")}catch(e){u?.debug?.error("DepthConsciousnessController","Failed to initialize consciousness:",e)}}detectContentAndChromeAreas(){let e={text:[".main-view-container__scroll-node",".main-trackList-trackListRow",'[data-testid*="tracklist"]','[data-testid*="playlist"]',".main-entityHeader-titleText",".main-entityHeader-subtitle",".main-trackList-rowTitle",".main-trackList-rowSubTitle","h1, h2, h3, h4, h5, h6","p",".lyrics-lyricsContainer-container",".main-cardSubHeader-root",".main-trackList-indexNumber",".main-trackInfo-name",".main-trackInfo-artists"],interactive:["button","a[role='button']","[tabindex='0']",".main-playButton-button",".main-addButton-button",".main-moreButton-button",".main-trackList-rowPlayPause",".control-button","input","select"],visual:[".main-image-container",".main-entityHeader-image",".cover-art",".main-coverSlot-container",".main-image-image"],media:["video","audio",".main-nowPlayingWidget-trackInfo",".main-coverSlot-container",".main-nowPlayingView-coverArt"],navigation:[".main-navBar-navBarLink",".main-rootlist-rootlistItem",".main-collectionLinkText-text"]},i=[".Root__nav-bar",".Root__top-bar",".Root__now-playing-bar",".main-topBar-container",".main-navBar-navBar",".main-entityHeader-container",".main-actionBar-container",".main-view-container",".Root__main-view",".main-rootlist-wrapper"];Object.entries(e).forEach(([r,a])=>{a.forEach(s=>{document.querySelectorAll(s).forEach(o=>{let l={element:o,type:r,protectionLevel:this.calculateAdvancedProtectionLevel(o,r),lastInteraction:0,consciousnessLevel:this.calculateConsciousnessLevel(o),readingIntensity:0,contextualImportance:this.calculateContextualImportance(o),adaptiveProtection:this.calculateProtectionLevel(o)};this.contentAreas.set(o,l),o.classList.add("content-sanctuary"),o.classList.add(`content-${r}`),o.setAttribute("data-consciousness-protected","true"),o.setAttribute("data-content-type",l.type),o.setAttribute("data-consciousness-level",l.consciousnessLevel.toString()),o.setAttribute("data-contextual-importance",l.contextualImportance.toString()),this.adaptiveProtectionMap.set(o,l.adaptiveProtection),this.dwellTimeTracker.set(o,0)})})}),i.forEach(r=>{document.querySelectorAll(r).forEach(a=>{this.chromeAreas.add(a),a.classList.add("ui-chrome-area"),a.setAttribute("data-consciousness-enhanced","true")})});let n=this.analyzeContentDistribution();u?.debug?.log("DepthConsciousnessController",`Enhanced detection: ${this.contentAreas.size} content areas, ${this.chromeAreas.size} chrome areas`,n)}determineContentType(e){return e.matches("h1, h2, h3, h4, h5, h6, .main-entityHeader-titleText")?"text":e.matches('button, a, [role="button"], [tabindex], input, select')?"interactive":e.matches(".main-image-container, .main-entityHeader-image, .cover-art")?"visual":e.matches(".Root__nav-bar, .Root__top-bar, .main-topBar-container")?"chrome":"text"}calculateProtectionLevel(e){switch(this.determineContentType(e)){case"text":return .95;case"interactive":return .9;case"visual":return .6;case"chrome":return .3;case"media":return .5;case"navigation":return .7;default:return .85}}calculateAdvancedProtectionLevel(e,i){let n=this.calculateProtectionLevel(e),r=0;i==="text"&&e.textContent&&e.textContent.length>50&&(r+=.05);let a=e.getBoundingClientRect();return a.top>=0&&a.left>=0&&a.bottom<=window.innerHeight&&a.right<=window.innerWidth&&(r+=.02),e.matches('h1, h2, .main-entityHeader-titleText, [data-testid*="title"]')&&(r+=.03),Math.min(n+r,.98)}calculateConsciousnessLevel(e){let i=e.getBoundingClientRect(),n=i.width*i.height,r=window.innerWidth*window.innerHeight,a=n/r,s=Math.min(a*2,.8);return e.matches(".Root__main-view, .main-view-container")&&(s+=.3),e.matches(".main-nowPlayingBar-container")&&(s+=.4),Math.min(s,1)}calculateContextualImportance(e){let i=.5;return e.matches('button, a, [role="button"], [tabindex="0"]')&&(i+=.2),e.matches(".main-view-container, .main-entityHeader, .main-trackList")&&(i+=.3),e.matches(".main-nowPlayingWidget, .main-nowPlayingBar")&&(i+=.4),e.matches(":focus, :focus-within, :hover")&&(i+=.2),Math.min(i,1)}analyzeContentDistribution(){let e={totalAreas:this.contentAreas.size,textAreas:0,interactiveAreas:0,visualAreas:0,mediaAreas:0,navigationAreas:0,chromeAreas:this.chromeAreas.size,averageProtection:0,highProtectionAreas:0},i=0;return this.contentAreas.forEach(n=>{switch(n.type){case"text":e.textAreas++;break;case"interactive":e.interactiveAreas++;break;case"visual":e.visualAreas++;break;case"media":e.mediaAreas++;break;case"navigation":e.navigationAreas++;break}i+=n.protectionLevel,n.protectionLevel>.8&&e.highProtectionAreas++}),e.averageProtection=i/this.contentAreas.size||0,e}analyzeScrollingBehavior(){if(this.scrollVelocityHistory.length<3)return;let e=this.scrollVelocityHistory.reduce((n,r)=>n+r,0)/this.scrollVelocityHistory.length,i=this.scrollVelocityHistory.reduce((n,r)=>n+Math.pow(r-e,2),0)/this.scrollVelocityHistory.length;i<100&&e<300?(this.userState.contentEngagement=Math.min(this.userState.contentEngagement+.05,1),this.userState.interactionPattern="contemplative"):e>1500&&i>500?(this.userState.contentEngagement=Math.max(this.userState.contentEngagement-.1,.1),this.userState.interactionPattern="rapid"):this.userState.interactionPattern="casual",this.userState.contentEngagement>.7?this.consciousnessIntensity=Math.min(this.consciousnessIntensity+.05,.9):this.userState.contentEngagement<.3&&(this.consciousnessIntensity=Math.max(this.consciousnessIntensity-.1,.3))}calculateInteractionModifier(){let e=0;if(this.userState.readingModeActive&&(e-=.6),this.userState.isHovering){let i=this.contentAreas.get(this.userState.interactionTarget);if(i){let n=i.type==="text"?.4:i.type==="interactive"?.3:i.type==="chrome"?.1:.2;e-=n}}return this.userState.scrollVelocity>1e3&&(e-=.2),this.userState.focusDepth>.7&&!this.userState.readingModeActive&&(e+=.2),e}calculateContextualModifier(){let e=0;return this.userState.interactionTarget?.matches(".main-nowPlayingBar, .main-nowPlayingWidget")&&(e+=.3),this.userState.interactionTarget?.matches(".main-trackList, .main-entityHeader-subtitle")&&(e-=this.userState.currentMode==="exploring"?.1:.3),this.userState.currentMode==="ambient"&&(e+=.4),this.userState.currentMode==="navigating"&&(e-=.2),e}getModeNumericValue(e){return{reading:0,browsing:1,exploring:2,navigating:3,ambient:4}[e]/4}getPatternNumericValue(e){return{contemplative:0,casual:1,deliberate:2,rapid:3}[e]/3}calculateMembraneFluidityIndex(){let e=.5;return e+=this.musicalState.energy*.3,e+=this.userState.contentEngagement*.2,e+=this.musicalState.emotionalTemperature*.2,this.userState.interactionPattern==="contemplative"?e-=.2:this.userState.interactionPattern==="rapid"&&(e+=.3),Math.max(.1,Math.min(1,e))}calculateGenreConsciousnessShift(){if(!this.musicalState.genre)return .5;let i={ambient:.8,electronic:.7,classical:.6,jazz:.5,rock:.4,pop:.3,"hip-hop":.2}[this.musicalState.genre.toLowerCase()]||.5,n=0;return this.musicalState.valence>.7&&(n+=.1),this.musicalState.energy>.8&&(n+=.1),Math.max(.1,Math.min(1,i+n))}setupInteractionListeners(){let e,i=window.scrollY,n=Date.now();document.addEventListener("scroll",()=>{let s=Date.now(),o=window.scrollY,l=s-n,m=Math.abs(o-i);this.userState.scrollVelocity=l>0?m/l*1e3:0,this.scrollVelocityHistory.push(this.userState.scrollVelocity),this.scrollVelocityHistory.length>10&&this.scrollVelocityHistory.shift();let d=this.scrollVelocityHistory.reduce((h,p)=>h+p,0)/this.scrollVelocityHistory.length;d>2e3?(this.userState.interactionPattern="rapid",this.userState.currentMode="browsing"):d>500?(this.userState.interactionPattern="deliberate",this.userState.currentMode="exploring"):this.userState.interactionPattern="contemplative",this.userState.isScrolling=!0,this.userState.lastInteractionTime=s,i=o,n=s,clearTimeout(e),e=window.setTimeout(()=>{this.userState.isScrolling=!1,this.analyzeScrollingBehavior()},150),this.updateUserInteractionState()},{passive:!0}),this.contentAreas.forEach((s,o)=>{let l=0;o.addEventListener("mouseenter",()=>{l=Date.now(),this.userState.isHovering=!0,this.userState.interactionTarget=o,this.userState.lastInteractionTime=l,s.lastInteraction=l,this.dwellTimeTracker.set(o,l),this.userState.focusDepth=Math.min(this.userState.focusDepth+.1,1),s.type==="text"&&(this.userState.focusDepth=Math.min(this.userState.focusDepth+.2,1)),this.updateUserInteractionState()}),o.addEventListener("mouseleave",()=>{let d=Date.now()-l;if(this.userState.dwellTime=d,s.readingIntensity=Math.min(d/5e3,1),s.type==="text"&&d>1e3&&(this.userState.contentEngagement=Math.min(this.userState.contentEngagement+.1,1),s.contextualImportance=Math.min(s.contextualImportance+.05,1)),d>3e3){let h=this.adaptiveProtectionMap.get(o)||s.protectionLevel;this.adaptiveProtectionMap.set(o,Math.min(h+.05,.98))}this.userState.isHovering=!1,this.userState.interactionTarget=null,this.userState.focusDepth=Math.max(this.userState.focusDepth-.05,.1),this.updateUserInteractionState()})}),document.addEventListener("mousemove",()=>{clearTimeout(this.readingModeTimer),this.userState.readingModeActive=!1,this.userState.focusDepth>.7?this.userState.currentMode="reading":this.userState.scrollVelocity>1e3?this.userState.currentMode="browsing":this.userState.currentMode="exploring";let s=this.userState.currentMode==="reading"?1500:2e3;this.readingModeTimer=window.setTimeout(()=>{if(this.userState.interactionTarget&&this.contentAreas.has(this.userState.interactionTarget)){this.userState.readingModeActive=!0,this.userState.currentMode="reading",this.userState.focusDepth=Math.min(this.userState.focusDepth+.3,1);let o=this.contentAreas.get(this.userState.interactionTarget);if(o&&o.type==="text"){let l=this.adaptiveProtectionMap.get(this.userState.interactionTarget)||o.protectionLevel;this.adaptiveProtectionMap.set(this.userState.interactionTarget,Math.min(l+.1,.98))}this.updateUserInteractionState()}},s)});let r,a=()=>{clearTimeout(r),r=window.setTimeout(()=>{this.userState.currentMode="ambient",this.userState.focusDepth=Math.max(this.userState.focusDepth-.5,.1),this.updateUserInteractionState()},3e4)};["mousedown","mousemove","keydown","scroll","touchstart"].forEach(s=>{document.addEventListener(s,a,{passive:!0})}),a(),document.addEventListener("music-state-change",s=>{let o=s;o.detail&&this.syncWithMusic(o.detail)}),document.addEventListener("beat-detected",()=>{this.handleBeatPulse()})}initializeConsciousnessVariables(){let e={"--consciousness-system-active":"1","--content-protection-level":"0.95","--chrome-enhancement-level":"2.0","--consciousness-breath-rate":"4s","--musical-sync-intensity":"0.5","--reading-mode-active":"0","--user-interaction-detected":"0"};this.cssController.batchSetVariables("DepthConsciousnessController",e,"normal","consciousness-initialization")}startConsciousnessUpdate(){let e=()=>{if(!this.isActive)return;let i=performance.now();i-this.lastUpdate>=this.updateThreshold&&(this.updateConsciousnessState(),this.lastUpdate=i),requestAnimationFrame(e)};e()}updateConsciousnessState(){let e=document.documentElement,i=this.consciousnessIntensity,n=this.musicalState.energy*this.musicalState.musicSyncStrength*.3,r=this.calculateInteractionModifier(),a=this.calculateContextualModifier(),s=this.musicalState.emotionalTemperature*.2,l={"--consciousness-intensity":Math.max(.05,Math.min(1,i+n+r+a+s)).toString(),"--consciousness-level":this.consciousnessIntensity.toString(),"--awareness-level":this.userState.focusDepth.toString(),"--musical-sync-intensity":this.musicalState.energy.toString(),"--musical-sync-strength":this.musicalState.musicSyncStrength.toString(),"--emotional-temperature":this.musicalState.emotionalTemperature.toString(),"--reading-mode-active":this.userState.readingModeActive?"1":"0","--user-interaction-detected":this.userState.isScrolling||this.userState.isHovering?"1":"0","--current-interaction-mode":this.getModeNumericValue(this.userState.currentMode).toString(),"--focus-depth":this.userState.focusDepth.toString(),"--content-engagement":this.userState.contentEngagement.toString(),"--scroll-velocity":Math.min(this.userState.scrollVelocity/2e3,1).toString(),"--dwell-time-factor":Math.min(this.userState.dwellTime/5e3,1).toString(),"--interaction-pattern":this.getPatternNumericValue(this.userState.interactionPattern).toString(),"--temporal-flow-direction-x":(Math.sin(Date.now()*1e-4)*.5+.5).toString(),"--temporal-flow-direction-y":(Math.cos(Date.now()*1e-4)*.5+.5).toString(),"--memory-intensity":this.musicalState.musicalMemoryPatterns.toString(),"--membrane-fluidity-index":this.calculateMembraneFluidityIndex().toString(),"--genre-consciousness-shift":this.calculateGenreConsciousnessShift().toString()};this.cssController.batchSetVariables("DepthConsciousnessController",l,"normal","consciousness-state-update"),e.classList.remove("music-energy-high","music-energy-calm"),this.musicalState.energy>.7?e.classList.add("music-energy-high"):this.musicalState.energy<.3&&e.classList.add("music-energy-calm"),e.setAttribute("data-user-interacting",(this.userState.isScrolling||this.userState.isHovering).toString()),e.setAttribute("data-reading-mode",this.userState.readingModeActive.toString())}updateUserInteractionState(){this.updateConsciousnessState()}syncWithMusic(e){if(Object.assign(this.musicalState,e),e.tempo){let i=Math.max(2,Math.min(8,60/(e.tempo/60)*4));this.cssController.setVariable("DepthConsciousnessController","--consciousness-breath-rate",`${i}s`,"high","musical-tempo-sync")}this.updateConsciousnessState(),u?.debug?.log("DepthConsciousnessController",`Musical consciousness sync: energy=${e.energy}, tempo=${e.tempo}`)}handleBeatPulse(){if(this.userState.readingModeActive)return;let e=document.documentElement,i=parseFloat(e.style.getPropertyValue("--consciousness-intensity")||"0.5"),n=Math.min(1,i+.1);this.cssController.setVariable("DepthConsciousnessController","--consciousness-intensity",n.toString(),"high","beat-pulse"),setTimeout(()=>{this.isActive&&this.updateConsciousnessState()},100)}protectNewContent(e){if(this.contentAreas.has(e))return;let i={element:e,type:this.determineContentType(e),protectionLevel:this.calculateProtectionLevel(e),lastInteraction:0,consciousnessLevel:.5,readingIntensity:0,contextualImportance:this.calculateProtectionLevel(e),adaptiveProtection:.5};this.contentAreas.set(e,i),e.classList.add("content-sanctuary"),e.setAttribute("data-consciousness-protected","true"),e.setAttribute("data-content-type",i.type),u?.debug?.log("DepthConsciousnessController",`Protected new content element: ${e.tagName}.${e.className}`)}enhanceNewChrome(e){this.chromeAreas.has(e)||(this.chromeAreas.add(e),e.classList.add("ui-chrome-area"),e.setAttribute("data-consciousness-enhanced","true"),u?.debug?.log("DepthConsciousnessController",`Enhanced new chrome element: ${e.tagName}.${e.className}`))}forceReadingMode(e){this.userState.readingModeActive=e,this.updateUserInteractionState(),u?.debug?.log("DepthConsciousnessController",`Reading mode ${e?"activated":"deactivated"}`)}getConsciousnessMetrics(){return{contentAreas:this.contentAreas.size,chromeAreas:this.chromeAreas.size,consciousnessIntensity:parseFloat(document.documentElement.style.getPropertyValue("--consciousness-intensity")||"0.5"),readingModeActive:this.userState.readingModeActive,userInteracting:this.userState.isScrolling||this.userState.isHovering,musicalEnergy:this.musicalState.energy}}async healthCheck(){let e=this.getConsciousnessMetrics(),i=e.contentAreas>0&&e.chromeAreas>0;return{healthy:i,issues:i?[]:["Consciousness system not properly initialized"],metrics:{consciousnessLevel:e.contentAreas>0?1:0,protectedAreas:e.contentAreas,enhancedAreas:e.chromeAreas,musicalEnergy:e.musicalEnergy}}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),clearTimeout(this.readingModeTimer),clearTimeout(this.interactionTimer),this.contentAreas.forEach((n,r)=>{r.classList.remove("content-sanctuary"),r.removeAttribute("data-consciousness-protected"),r.removeAttribute("data-content-type")}),this.chromeAreas.forEach(n=>{n.classList.remove("ui-chrome-area"),n.removeAttribute("data-consciousness-enhanced")});let e={"--consciousness-system-active":"","--consciousness-intensity":"","--reading-mode-active":"","--user-interaction-detected":"","--consciousness-breath-rate":"","--musical-sync-intensity":"","--content-protection-level":"","--chrome-enhancement-level":""};this.cssController.batchSetVariables("DepthConsciousnessController",e,"critical","system-cleanup");let i=document.documentElement;i.classList.remove("music-energy-high","music-energy-calm"),i.removeAttribute("data-user-interacting"),i.removeAttribute("data-reading-mode"),u?.debug?.log("DepthConsciousnessController","Consciousness system deactivated")}}});var Eo={};ie(Eo,{DynamicCatppuccinBridge:()=>Vr});var Vr,Po=y(()=>{"use strict";U();D();N();A();K();ge();Vr=class extends Q{constructor(e=w,i=I,n=null,r=null,a=null){super(e,i,n,r,a);this.colorHarmonyEngine=null;this.depthConsciousnessController=null;this.dynamicColorState={currentAccentHex:"#675c8f",currentAccentRgb:"203,166,247",baseBackgroundHex:"#0d1117",baseBackgroundRgb:"13,17,23",lastUpdateTime:0,musicEnergy:.5,transitionInProgress:!1};this.integrationConfig={accentUpdateEnabled:!0,baseTransformationEnabled:!0,consciousnessIntegrationEnabled:!0,smoothTransitionDuration:800,energyResponseMultiplier:1.2};this.transitionTimer=0;this.lastTransitionStartTime=0;this.transitionFromAccent="";this.transitionToAccent=""}async _performSystemSpecificInitialization(){await super._performSystemSpecificInitialization();try{let e=globalThis.year3000System;this.cssController=e?.cssConsciousnessController||T(),this.setupColorExtractionListeners(),this.setupSettingsListeners(),this.initializeCurrentState();let i=this.checkDynamicAccentEnabled();this.integrationConfig.accentUpdateEnabled=i,i?u?.debug?.log("DynamicCatppuccinBridge","Dynamic accent enabled - bridge active"):u?.debug?.log("DynamicCatppuccinBridge","Dynamic accent disabled - bridge standby (will activate when enabled)"),u?.debug?.log("DynamicCatppuccinBridge","Color Extension Facade initialized successfully")}catch(e){u?.debug?.error("DynamicCatppuccinBridge","Failed to initialize facade:",e)}}checkDynamicAccentEnabled(){try{if(!this.settingsManager)return!1;let e=this.settingsManager.get("catppuccin-accentColor"),i=String(e)==="dynamic";return this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinBridge",`Accent setting: ${e}, Dynamic: ${i}`),i}catch(e){return u?.debug?.error("DynamicCatppuccinBridge","Error checking dynamic accent setting:",e),!1}}setupColorExtractionListeners(){g.subscribe("colors:extracted",e=>{e.rawColors&&this.handleExtractedColors(e.rawColors)},"DynamicCatppuccinBridge"),g.subscribe("colors:harmonized",e=>{e.processedColors&&this.handleHarmonizedColors(e.processedColors)},"DynamicCatppuccinBridge"),g.subscribe("colors:applied",e=>{e.cssVariables&&this.integrationConfig.accentUpdateEnabled&&this.handleCSSVariablesApplied(e.cssVariables,e.accentHex,e.accentRgb)},"DynamicCatppuccinBridge"),document.addEventListener("colors-extracted",e=>{let i=e;i.detail&&i.detail.extractedColors&&this.handleExtractedColors(i.detail.extractedColors)}),document.addEventListener("colors-harmonized",e=>{let i=e;i.detail&&i.detail.harmonizedColors&&this.handleHarmonizedColors(i.detail.harmonizedColors)}),document.addEventListener("music-state-change",e=>{let i=e;i.detail&&this.handleMusicStateChange(i.detail)}),document.addEventListener("spice-colors/update-request",e=>{let i=e;i.detail&&this.integrationConfig.accentUpdateEnabled&&this.handleSpiceColorUpdateRequest(i.detail)}),u?.debug?.log("DynamicCatppuccinBridge","Enhanced color extraction and coordination listeners setup complete (UnifiedEventBus + DOM)")}handleSpiceColorUpdateRequest(e){let{accentHex:i,primaryHex:n,secondaryHex:r,source:a}=e;this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinBridge",`Received spice color update request from ${a}:`,{accent:i,primary:n,secondary:r}),i&&i!==this.dynamicColorState.currentAccentHex&&this.scheduleSmoothAccentTransition(i),n&&this.updateLivingBaseBackground(n),document.dispatchEvent(new CustomEvent("spice-colors/updated",{detail:{source:"DynamicCatppuccinBridge",applied:{accent:i,primary:n,secondary:r},timestamp:Date.now()}}))}setupSettingsListeners(){document.addEventListener("year3000SystemSettingsChanged",e=>{let i=e,{key:n,value:r}=i.detail||{};if(n==="catppuccin-accentColor"){let a=String(r)==="dynamic";this.integrationConfig.accentUpdateEnabled=a,a&&!this.isActive?this.initialize():!a&&this.isActive&&this.destroy(),u?.debug?.log("DynamicCatppuccinBridge",`Accent setting changed to: ${r}, Bridge active: ${this.isActive}`)}})}initializeCurrentState(){let e=document.documentElement,i=getComputedStyle(e),n=i.getPropertyValue("--sn-accent-hex").trim()||i.getPropertyValue("--sn-musical-harmony-primary-hex").trim()||i.getPropertyValue("--sn-dynamic-accent-hex").trim()||i.getPropertyValue("--sn-cosmic-accent-hex").trim()||i.getPropertyValue("--spice-accent").trim();if(n){this.dynamicColorState.currentAccentHex=n;let s=this.utils.hexToRgb(n);s&&(this.dynamicColorState.currentAccentRgb=`${s.r},${s.g},${s.b}`)}let r=i.getPropertyValue("--sn-cosmic-base-hex").trim()||i.getPropertyValue("--spice-base").trim()||"#0d1117";this.dynamicColorState.baseBackgroundHex=r;let a=this.utils.hexToRgb(r);a&&(this.dynamicColorState.baseBackgroundRgb=`${a.r},${a.g},${a.b}`),this.dynamicColorState.lastUpdateTime=Date.now(),u?.debug?.log("DynamicCatppuccinBridge","Current state initialized:",{accent:this.dynamicColorState.currentAccentHex,base:this.dynamicColorState.baseBackgroundHex})}handleExtractedColors(e){if(this.integrationConfig.accentUpdateEnabled)try{let i=this.selectBestAccentColor(e);i&&i!==this.dynamicColorState.currentAccentHex&&this.scheduleSmoothAccentTransition(i),u?.debug?.log("DynamicCatppuccinBridge","Processed extracted colors:",{input:Object.keys(e),selectedAccent:i})}catch(i){u?.debug?.error("DynamicCatppuccinBridge","Error handling extracted colors:",i)}}handleHarmonizedColors(e){if(this.integrationConfig.accentUpdateEnabled)try{let i=e.VIBRANT||e.PROMINENT||e.VIBRANT_NON_ALARMING||e.LIGHT_VIBRANT||e.PRIMARY||Object.values(e)[0];i&&i!==this.dynamicColorState.currentAccentHex&&(this.config.enableDebug&&console.log("\u{1F3A8} [DynamicCatppuccinBridge] Applying harmonized accent color:",{from:this.dynamicColorState.currentAccentHex,to:i,source:"ColorHarmonyEngine harmonized colors"}),this.scheduleSmoothAccentTransition(i)),this.applyHarmonizedColorsToDynamicSystem(e)}catch(i){console.error("\u{1F3A8} [DynamicCatppuccinBridge] Error handling harmonized colors:",i)}}handleCSSVariablesApplied(e,i,n){if(this.integrationConfig.accentUpdateEnabled)try{i&&i!==this.dynamicColorState.currentAccentHex&&(this.dynamicColorState.currentAccentHex=i,this.dynamicColorState.currentAccentRgb=n,this.dynamicColorState.lastUpdateTime=Date.now());let r={},a=e["--sn-accent-hex"]||e["--spice-accent"]||i,s=e["--sn-accent-rgb"]||e["--spice-rgb-accent"]||n;a&&s&&(r["--sn-dynamic-accent-hex"]=a,r["--sn-dynamic-accent-rgb"]=s,r["--sn-dynamic-primary-hex"]=a,r["--sn-dynamic-primary-rgb"]=s,Object.keys(r).length>0&&this.cssController.batchSetVariables("DynamicCatppuccinBridge",r,"critical","css-variables-applied-enhancement")),u?.debug?.log("DynamicCatppuccinBridge","Processed colors:applied event:",{accentHex:a,accentRgb:s,variablesProcessed:Object.keys(e).length,enhancedVariables:Object.keys(r).length})}catch(r){u?.debug?.error("DynamicCatppuccinBridge","Error handling CSS variables applied:",r)}}handleMusicStateChange(e){e.energy!==void 0&&(this.dynamicColorState.musicEnergy=e.energy,this.integrationConfig.consciousnessIntegrationEnabled&&this.updateConsciousnessWithMusicEnergy(e.energy))}selectBestAccentColor(e){let i=["VIBRANT_NON_ALARMING","VIBRANT","LIGHT_VIBRANT","PROMINENT","PRIMARY","DARK_VIBRANT"];for(let n of i){let r=e[n];if(r&&this.utils.hexToRgb(r))return r}return null}scheduleSmoothAccentTransition(e){if(this.dynamicColorState.transitionInProgress){this.transitionToAccent=e;return}this.transitionFromAccent=this.dynamicColorState.currentAccentHex,this.transitionToAccent=e,this.dynamicColorState.transitionInProgress=!0,this.lastTransitionStartTime=Date.now(),this.animateAccentTransition(),u?.debug?.log("DynamicCatppuccinBridge",`Accent transition scheduled: ${this.transitionFromAccent} \u2192 ${e}`)}animateAccentTransition(){let e=()=>{if(!this.dynamicColorState.transitionInProgress)return;let i=Date.now()-this.lastTransitionStartTime,n=Math.min(i/this.integrationConfig.smoothTransitionDuration,1),r=1-Math.pow(1-n,3),a=this.interpolateColors(this.transitionFromAccent,this.transitionToAccent,r);if(a&&this.applyDynamicAccent(a),n>=1){this.dynamicColorState.transitionInProgress=!1,this.dynamicColorState.currentAccentHex=this.transitionToAccent,this.dynamicColorState.lastUpdateTime=Date.now();let s=this.utils.hexToRgb(this.transitionToAccent);s&&(this.dynamicColorState.currentAccentRgb=`${s.r},${s.g},${s.b}`),u?.debug?.log("DynamicCatppuccinBridge",`Accent transition complete: ${this.transitionToAccent}`)}else requestAnimationFrame(e)};requestAnimationFrame(e)}interpolateColors(e,i,n){let r=this.utils.hexToRgb(e),a=this.utils.hexToRgb(i);if(!r||!a)return null;let s=Math.round(r.r+(a.r-r.r)*n),o=Math.round(r.g+(a.g-r.g)*n),l=Math.round(r.b+(a.b-r.b)*n);return this.utils.rgbToHex(s,o,l)}applyDynamicAccent(e){console.log("\u{1F3A8} [DynamicCatppuccinBridge] Applying dynamic accent color:",{accentHex:e,previousAccent:this.dynamicColorState.currentAccentHex,timestamp:Date.now()});let i=document.documentElement,n=this.utils.hexToRgb(e);if(!n){console.error("\u{1F3A8} [DynamicCatppuccinBridge] Failed to convert accent hex to RGB:",e);return}let r=`${n.r},${n.g},${n.b}`,a={"--sn-dynamic-accent-hex":e,"--sn-dynamic-accent-rgb":r,"--sn-dynamic-primary-hex":e,"--sn-dynamic-primary-rgb":r,"--spice-accent":e,"--spice-button":e,"--spice-button-active":e,"--spice-rgb-accent":r,"--spice-rgb-button":r,"--sn-color-extracted-primary-rgb":r,"--sn-color-extracted-vibrant-rgb":r,"--sn-color-extracted-dominant-rgb":r};console.log("\u{1F3A8} [DynamicCatppuccinBridge] Setting CSS variables:",a),this.cssController.batchSetVariables("DynamicCatppuccinBridge",a,"critical","dynamic-accent-application"),this.integrationConfig.consciousnessIntegrationEnabled&&this.updateConsciousnessWithAccent(e,r),this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinBridge",`Applied gradient colors: --sn-bg-gradient-primary=${e}, --sn-bg-gradient-primary-rgb=${r}`)}applyHarmonizedColorsToDynamicSystem(e){let i=e.VIBRANT||e.PRIMARY;i&&this.integrationConfig.baseTransformationEnabled&&this.updateLivingBaseBackground(i)}updateConsciousnessWithAccent(e,i){let n=document.documentElement,r={"--organic-holographic-rgb":i,"--holographic-scanline-rgb":i,"--consciousness-intensity":`calc(0.5 + var(--musical-sync-intensity) * ${this.integrationConfig.energyResponseMultiplier})`};this.cssController.batchSetVariables("DynamicCatppuccinBridge",r,"high","consciousness-accent-update"),this.depthConsciousnessController&&u?.debug?.log("DynamicCatppuccinBridge","Notifying depth consciousness of accent change")}updateConsciousnessWithMusicEnergy(e){let i=document.documentElement,n=e*this.integrationConfig.energyResponseMultiplier,r={"--musical-sync-intensity":n.toString(),"--holographic-music-flicker-intensity":n.toString()};this.cssController.batchSetVariables("DynamicCatppuccinBridge",r,"high","musical-energy-update");let s=Math.max(.1,Math.min(1,.5+n*.3));this.cssController.setVariable("DynamicCatppuccinBridge","--consciousness-intensity",s.toString(),"high","consciousness-intensity-update")}updateLivingBaseBackground(e){let i=document.documentElement,n=this.utils.hexToRgb(e);if(!n)return;let r=`${n.r},${n.g},${n.b}`,a={"--sn-dynamic-secondary-hex":e,"--sn-dynamic-secondary-rgb":r,"--sn-color-extracted-secondary-rgb":r,"--sn-color-harmony-complementary-rgb":r};this.cssController.batchSetVariables("DynamicCatppuccinBridge",a,"high","secondary-color-update");let s=`
      linear-gradient(135deg,
        var(--spice-base) 0%,
        rgba(${r}, 0.08) 30%,
        var(--spice-base) 70%
      ),
      var(--spice-base)
    `,o={"--living-base-gradient":s,"--consciousness-base-gradient":s};this.cssController.batchSetVariables("DynamicCatppuccinBridge",o,"normal","living-gradient-update"),this.config.enableDebug&&u?.debug?.log("DynamicCatppuccinBridge",`Living base updated: --sn-bg-gradient-secondary=${e}, --sn-bg-gradient-secondary-rgb=${r}`)}linkWithColorHarmonyEngine(e){this.colorHarmonyEngine=e,u?.debug?.log("DynamicCatppuccinBridge","Linked with ColorHarmonyEngine")}linkWithDepthConsciousness(e){this.depthConsciousnessController=e,u?.debug?.log("DynamicCatppuccinBridge","Linked with DepthLayerController")}getDynamicColorState(){return{...this.dynamicColorState}}getFacadeVariableStatus(){let e=document.documentElement,i=getComputedStyle(e);return{spicetifyVars:{accent:i.getPropertyValue("--spice-accent").trim(),button:i.getPropertyValue("--spice-button").trim(),rgbAccent:i.getPropertyValue("--spice-rgb-accent").trim(),base:i.getPropertyValue("--spice-base").trim()},consciousnessVars:{gradientPrimary:i.getPropertyValue("--sn-bg-gradient-primary-rgb").trim(),accentHex:i.getPropertyValue("--sn-color-accent-hex").trim(),accentRgb:i.getPropertyValue("--sn-color-accent-rgb").trim(),extractedPrimary:i.getPropertyValue("--sn-color-extracted-primary-rgb").trim(),livingBaseGradient:i.getPropertyValue("--living-base-gradient").trim()},config:{dynamicAccentEnabled:this.checkDynamicAccentEnabled(),accentUpdateEnabled:this.integrationConfig.accentUpdateEnabled,consciousnessEnabled:this.integrationConfig.consciousnessIntegrationEnabled,isActive:this.isActive}}}updateConfig(e){this.integrationConfig={...this.integrationConfig,...e},u?.debug?.log("DynamicCatppuccinBridge","Configuration updated:",e)}async healthCheck(){let e=this.checkDynamicAccentEnabled(),i=Date.now()-this.dynamicColorState.lastUpdateTime<3e4;return{healthy:this.isActive&&e,issues:this.isActive&&!e?["Dynamic accent not enabled in settings"]:[],metrics:{dynamicAccentEnabled:e,currentAccent:this.dynamicColorState.currentAccentHex,lastUpdateAge:Date.now()-this.dynamicColorState.lastUpdateTime,hasRecentUpdate:i,transitionInProgress:this.dynamicColorState.transitionInProgress,musicEnergy:this.dynamicColorState.musicEnergy}}}_performSystemSpecificCleanup(){super._performSystemSpecificCleanup(),this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=0),this.dynamicColorState.transitionInProgress=!1,g.unsubscribeAll("DynamicCatppuccinBridge"),u?.debug?.log("DynamicCatppuccinBridge","Dynamic Catppuccin bridge cleaned up (including UnifiedEventBus subscriptions)")}}});var To={};ie(To,{CDFVariableBridge:()=>_r});var _r,xo=y(()=>{"use strict";D();_r=class{constructor(t){this.batcher=t;this.reduceMotionMQ=null;this._mqHandler=null;let e=g.subscribe("performance:frame",i=>{let n={deltaMs:i.deltaTime||16.67,timestamp:i.timestamp||Date.now(),performanceMode:"performance",frameBudget:16.67};this._handleFrame(n)},"CDFVariableBridge");if(this.unsubscribe=()=>g.unsubscribe(e),typeof window<"u"&&window.matchMedia){this.reduceMotionMQ=window.matchMedia("(prefers-reduced-motion: reduce)"),this._syncReducedMotion(this.reduceMotionMQ.matches),this._mqHandler=i=>{this._syncReducedMotion(i.matches)};try{this.reduceMotionMQ.addEventListener("change",this._mqHandler)}catch{this.reduceMotionMQ.addListener(this._mqHandler)}}}destroy(){if(this.unsubscribe?.(),this.reduceMotionMQ&&this._mqHandler)try{this.reduceMotionMQ.removeEventListener("change",this._mqHandler)}catch{this.reduceMotionMQ.removeListener(this._mqHandler)}}_handleFrame(t){if(typeof t.scrollRatio=="number"&&(this.batcher.queueCSSVariableUpdate("--sn-cdf-scroll-ratio",t.scrollRatio.toFixed(3)),this.batcher.queueCSSVariableUpdate("--sn-scroll-ratio",t.scrollRatio.toFixed(3))),typeof t.beatIntensity=="number"){let e=t.beatIntensity.toFixed(3);this.batcher.queueCSSVariableUpdate("--sn-cdf-energy",e),this.batcher.queueCSSVariableUpdate("--sn-beat-intensity",e)}}_syncReducedMotion(t){this.batcher.queueCSSVariableUpdate("--sn-cdf-enabled",t?"0":"1")}}});U();Mr();A();K();async function Ys(c=1e4,t=100){let e=Date.now();for(;Date.now()-e<c;){let i=window.Spicetify;if(i?.showNotification&&i?.Platform)return!0;await new Promise(n=>setTimeout(n,t))}return!1}N();var Ni=class{constructor(t,e=null){this.parent=t;this.y3k=e;this.gl=null;this.program=null;this.tex=null;this.strength=.4;this.rafId=null;this.frameStart=0;this._defaultSize=256;this._boundContextLost=t=>this._handleContextLost(t);this._boundContextRestored=()=>this._handleContextRestored();this.canvas=document.createElement("canvas"),this.canvas.width=this._defaultSize,this.canvas.height=this._defaultSize,this.canvas.style.width="100%",this.canvas.style.height="100%",Object.assign(this.canvas.style,{position:"absolute",inset:"0",pointerEvents:"none",mixBlendMode:"overlay",zIndex:"-1",opacity:"0.6"}),this.parent.appendChild(this.canvas),this.perf=e?.performanceAnalyzer??null,this.canvas.addEventListener("webglcontextlost",this._boundContextLost,!1),this.canvas.addEventListener("webglcontextrestored",this._boundContextRestored,!1),this._initGL()}_initGL(){let t=this.canvas.getContext("webgl",{premultipliedAlpha:!1,alpha:!0,antialias:!1});if(!t){console.warn("[AberrationCanvas] WebGL not available \u2013 effect disabled");return}this.gl=t;let e="attribute vec2 aPos; varying vec2 vUv; void main(){ vUv = (aPos+1.0)*0.5; gl_Position = vec4(aPos,0.0,1.0); }",i="precision mediump float; uniform sampler2D uTex; uniform float uStrength; uniform float uTime; varying vec2 vUv; void main(){ float freq = 8.0; vec2 offset = vec2(sin(vUv.y*freq+uTime)*uStrength, 0.0); vec4 c; c.r = texture2D(uTex, vUv + offset).r; c.g = texture2D(uTex, vUv).g; c.b = texture2D(uTex, vUv - offset).b; c.a = clamp(uStrength * 1.5, 0.0, 0.6); gl_FragColor = c; }",n=(h,p)=>{let b=t.createShader(h);return t.shaderSource(b,p),t.compileShader(b),b},r=n(t.VERTEX_SHADER,e),a=n(t.FRAGMENT_SHADER,i),s=t.createProgram();if(t.attachShader(s,r),t.attachShader(s,a),t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS)){console.error("[AberrationCanvas] Shader link failed");return}this.program=s,t.useProgram(s);let o=new Float32Array([-1,-1,1,-1,-1,1,1,1]),l=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,l),t.bufferData(t.ARRAY_BUFFER,o,t.STATIC_DRAW);let m=t.getAttribLocation(s,"aPos");t.enableVertexAttribArray(m),t.vertexAttribPointer(m,2,t.FLOAT,!1,0,0);let d=t.createTexture();t.bindTexture(t.TEXTURE_2D,d),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,0,0])),this.tex=d}setStrength(t){this.strength=t}updateSourceBitmap(t){if(!this.gl||!this.tex)return;let e=this.gl;e.bindTexture(e.TEXTURE_2D,this.tex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t)}render(t){if(!this.gl||!this.program)return;let e=this.gl;this.perf&&(this.frameStart=performance.now()),e.viewport(0,0,this.canvas.width,this.canvas.height),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT),e.useProgram(this.program);let i=e.getUniformLocation(this.program,"uTex"),n=e.getUniformLocation(this.program,"uStrength"),r=e.getUniformLocation(this.program,"uTime");if(e.uniform1i(i,0),e.uniform1f(n,this.strength),e.uniform1f(r,t*.001),e.drawArrays(e.TRIANGLE_STRIP,0,4),this.perf){let a=performance.now()-this.frameStart;a>.5&&console.warn(`[AberrationCanvas] Frame ${a.toFixed(2)} ms exceeds 0.5 ms budget`)}}destroy(){this.rafId&&cancelAnimationFrame(this.rafId),this.gl&&this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.canvas.removeEventListener("webglcontextlost",this._boundContextLost),this.canvas.removeEventListener("webglcontextrestored",this._boundContextRestored),this.canvas.remove()}setPixelSize(t){t!==this.canvas.width&&(this.canvas.width=t,this.canvas.height=t)}_handleContextLost(t){t.preventDefault(),console.warn("[AberrationCanvas] WebGL context lost \u2013 waiting for restore"),this.gl=null,this.program=null}_handleContextRestored(){console.info("[AberrationCanvas] WebGL context restored \u2013 re-initializing GL"),this._initGL()}};var $i=class{constructor(t,e){this.systemName="AberrationCanvas";this._elapsed=0;this._canvas=t,this._perf=e}onAnimate(t,e){this._elapsed+=t;let i=0;this._perf&&(i=this._perf.startTiming("AberrationVisualSystem")),this._canvas.render(this._elapsed),this._perf&&i&&this._perf.endTiming("AberrationVisualSystem",i)}onPerformanceModeChange(t){t==="performance"?(this._canvas.setPixelSize(128),this._canvas.setStrength(.25)):(this._canvas.setPixelSize(256),this._canvas.setStrength(.4))}destroy(){this._canvas.destroy()}};var Vc=[".main-view-container__scroll-node",".main-viewContainer-scrollNode",".main-viewContainer__scrollNode"].join(", ");function Ks(){return document.querySelector(Vc)}var Z=null,Wi=null;function wr(c){return(c||globalThis.year3000System)?.cssConsciousnessController||T()}function _c(){return!1}function Bt(c){if(!_c()){Ft(!1,c),Gt(!1,c);return}let t=Ks();t&&(Z&&Z.parent===t||(Z?.destroy(),Z=new Ni(t,c),window.__SN_DEBUG_ABERRATION&&console.log("[AberrationManager] canvas attached",t),Ft(!0,c),Gt(!0,c),c&&Z&&(Wi=new $i(Z,c.performanceAnalyzer||void 0),c?.registerVisualSystem?.(Wi,"critical"),console.log("[AberrationManager] AberrationCanvas attached"))))}function Ft(c,t){wr(t).setVariable("AberrationManager","--sn-nebula-noise-opacity",c?"0.03":"0","normal","nebula-noise-toggle")}function Gt(c,t){let e={"--aberration-webgl-active":c?"1":"0","--aberration-css-enabled":c?"1":"0","--aberration-hybrid-mode":c?"1":"0"};wr(t).batchSetVariables("AberrationManager",e,"normal","css-aberration-toggle")}function js(c=null){Bt(c),Z||(Ft(!1,c),Gt(!1,c));let t=window.Spicetify?.Platform?.History;t?.listen&&t.listen(()=>setTimeout(()=>Bt(c),0)),document.addEventListener("spicetify:appchange",()=>Bt(c));let e=new MutationObserver(()=>{Z?e.disconnect():(Bt(c),Z||(Ft(!1,c),Gt(!1,c)))});e.observe(document.documentElement,{childList:!0,subtree:!0}),document.addEventListener("year3000SystemSettingsChanged",i=>{let{key:n,value:r}=i.detail||{};if(n==="sn-enable-aberration"){let a=r==="true";a&&!Z?Bt(c):!a&&Z&&(Z.destroy(),Z=null,c?.unregisterAnimationSystem("AberrationCanvas"),Wi?.destroy(),Wi=null,console.log("[AberrationManager] AberrationCanvas detached")),Ft(a&&!!Z,c),Gt(a&&!!Z,c)}if(n==="sn-nebula-aberration-strength"){let a=parseFloat(r);!Number.isNaN(a)&&Z&&Z.setStrength(a),wr(c).setVariable("AberrationManager","--sn-nebula-aberration-strength",String(r),"normal","aberration-strength-update")}})}N();D();var Qs="sn_seen_genres_v1",qi=class{constructor(){let t=typeof localStorage<"u"?localStorage.getItem(Qs):null;this.seen=new Set(t?JSON.parse(t):[])}hasSeen(t){return this.seen.has(t.toLowerCase())}markSeen(t){let e=t.toLowerCase();this.seen.has(e)||(this.seen.add(e),this._persist())}_persist(){try{typeof localStorage<"u"&&localStorage.setItem(Qs,JSON.stringify([...this.seen]))}catch{}}};function Nc(c){if(!c.length)return 0;let t=[...c].sort((r,a)=>r-a),e=Math.floor(t.length/2);if(t.length%2!==0)return t[e]??0;let i=t[e-1]??0,n=t[e]??0;return(i+n)/2}var Ht=class Ht{constructor(t=null,e,i){this.perf=null;this.unsubscribers=[];this.frameDurations=[];this.enabled=!0;this.intensitySetting="balanced";this.intensityFactor=1;this.genreHistory=new qi;this.activeGlowTimeout=null;this.interactionOffHandler=null;this.year3000System=t,this.cssController=e??t?.cssConsciousnessController??T(),this.perf=i||(t?.performanceAnalyzer??null);let n=window.matchMedia("(prefers-reduced-motion: reduce)").matches,r=t?.deviceCapabilityDetector?.deviceCapabilities?.overall,a=t?.settingsManager;switch(a&&(this.intensitySetting=a.get("sn-gradient-intensity")??"balanced"),this.intensitySetting){case"disabled":this.enabled=!1;break;case"minimal":this.intensityFactor=.6;break;case"balanced":this.intensityFactor=1;break;case"intense":this.intensityFactor=1.4;break}(n||r==="low")&&(this.enabled=!1),this.enabled?this._subscribe():this.cssController.setVariable("AudioVisualController","--sn-nebula-beat-intensity","0","low","disabled-initialization")}_subscribe(){let t=[g.subscribe("music:beat",e=>{this._handleBeat({energy:e.intensity,bpm:e.bpm})},"AudioVisualController"),g.subscribe("music:track-changed",e=>{this._handleGenreChange({genre:"unknown"})},"AudioVisualController"),g.subscribe("user:scroll",e=>{this._handleScroll({velocity:e.velocity?.x||e.velocity?.y||0,direction:e.direction==="up"?"up":"down"})},"AudioVisualController")];this.unsubscribers=t.map(e=>()=>g.unsubscribe(e))}_handleBeat(t){let e=performance.now(),i=typeof t.energy=="number"?t.energy:.5,n=(.8+Math.min(Math.max(i,0),1)*.6)*this.intensityFactor;this._queueVar("--sn-nebula-beat-intensity",n.toFixed(3),"high","beat-sync");let r=(i*.6).toFixed(3);this._queueVar("--sn-nebula-aberration-strength",r,"normal","beat-aberration"),this._recordDuration(e)}_handleGenreChange(t){let e=performance.now();if(this.genreHistory.hasSeen(t.genre))return;this.genreHistory.markSeen(t.genre);let i=.18*this.intensityFactor;this._queueVar("--sn-nebula-layer-0-opacity",i.toFixed(3),"high","genre-discovery");let n=()=>{this.year3000System?.timerConsolidationSystem?this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer("AudioVisualController-glowTimeout"):this.activeGlowTimeout&&(clearTimeout(this.activeGlowTimeout),this.activeGlowTimeout=null),this._queueVar("--sn-nebula-layer-0-opacity","0.05","normal","genre-clear"),this.interactionOffHandler&&(document.removeEventListener("pointerdown",this.interactionOffHandler),document.removeEventListener("keydown",this.interactionOffHandler),this.interactionOffHandler=null)};this.year3000System?.timerConsolidationSystem?(this.year3000System.timerConsolidationSystem.registerConsolidatedTimer("AudioVisualController-glowTimeout",n,4e3,"normal"),this.activeGlowTimeout=null):this.activeGlowTimeout=setTimeout(n,4e3),this.interactionOffHandler=()=>n(),document.addEventListener("pointerdown",this.interactionOffHandler,{once:!0}),document.addEventListener("keydown",this.interactionOffHandler,{once:!0}),this._queueVar("--sn-nebula-ease-t","1","normal","ease-trigger"),this._recordDuration(e)}_handleScroll(t){let e=performance.now(),i=typeof t.velocity=="number"?t.velocity:0,r=Math.min(Math.abs(i),50)/50*2*this.intensityFactor;this._queueVar("--sn-nebula-layer-3-blur",`calc(var(--sn-depth-layer-3-blur) + ${r.toFixed(2)}px)`,"normal","scroll-blur");let a=150,o=Math.max(Math.min(t.velocity??0,50),-50)/50*50,l=Math.max(140,Math.min(200,a+o));this._queueVar("--sn-nebula-noise-scale-y",`${l.toFixed(1)}%`,"normal","scroll-noise"),this._recordDuration(e)}_queueVar(t,e,i="normal",n="audio-visual"){this.enabled&&this.cssController.setVariable("AudioVisualController",t,e,i,n)}_recordDuration(t){let e=performance.now()-t;if(this.frameDurations.push(e),this.frameDurations.length>Ht.FRAME_HISTORY&&this.frameDurations.shift(),this.frameDurations.length===Ht.FRAME_HISTORY){let i=Nc(this.frameDurations);i>2&&(console.warn(`[AudioVisualController] Median scripting cost ${i.toFixed(2)} ms exceeds 2 ms budget.`),this._queueVar("--sn-nebula-blend-mode","screen","critical","performance-fallback"))}}destroy(){this.year3000System?.timerConsolidationSystem&&this.year3000System.timerConsolidationSystem.unregisterConsolidatedTimer("AudioVisualController-glowTimeout"),this.activeGlowTimeout&&(clearTimeout(this.activeGlowTimeout),this.activeGlowTimeout=null),this.interactionOffHandler&&(document.removeEventListener("pointerdown",this.interactionOffHandler),document.removeEventListener("keydown",this.interactionOffHandler),this.interactionOffHandler=null),this.unsubscribers.forEach(t=>t()),this.unsubscribers=[]}};Ht.FRAME_HISTORY=120;var Er=Ht;function Xs(c=null){let t=globalThis;if(t.__SN_audioVisualController)return t.__SN_audioVisualController;let e=new Er(c);return t.__SN_audioVisualController=e,e}async function Ut(c,t=5e3){let e=Date.now(),i=null,n=0;for(;Date.now()-e<t;){n++;try{let s=c.split(".").reduce((o,l)=>o?.[l],window);if(s)return console.log(`\u2705 [StarryNight] API ${c} available after ${n} attempts (${Date.now()-e}ms)`),s}catch(s){i=s}await new Promise(s=>setTimeout(s,100))}console.warn(`\u274C [StarryNight] API ${c} timeout after ${t}ms (${n} attempts)`),i&&console.warn(`\u274C [StarryNight] Last error for ${c}:`,i.message);let r=c.split("."),a=window;for(let s=0;s<r.length;s++){let o=r[s];if(!o||!a||typeof a!="object"||a[o]===void 0){console.warn(`\u274C [StarryNight] API path ${c} breaks at '${o}' (step ${s+1}/${r.length})`);break}a=a[o]}return null}async function Sl(c,t=5e3){let e=Date.now(),i=0;for(;Date.now()-e<t;){i++;try{let n=document.querySelector(c);if(n)return console.log(`\u2705 [StarryNight] DOM element '${c}' found after ${i} attempts (${Date.now()-e}ms)`),n}catch(n){console.warn(`\u274C [StarryNight] DOM query error for '${c}':`,n)}await new Promise(n=>setTimeout(n,200))}return console.warn(`\u274C [StarryNight] DOM element '${c}' not found after ${t}ms (${i} attempts)`),null}async function vl(c=5e3){let t=Date.now();for(;Date.now()-t<c;){try{let e=getComputedStyle(document.documentElement),i=e.getPropertyValue("--spice-base").trim(),n=e.getPropertyValue("--spice-accent").trim(),r=e.getPropertyValue("--spice-text").trim(),a=s=>{let o=s.toLowerCase();return s&&!o.includes("#ffffff")&&!o.includes("#fff")&&!o.includes("white")&&o.match(/^#[0-9a-f]{6}$/i)};if(a(i)&&a(n)&&a(r))return console.log(`\u{1F3A8} [StarryNight] Catppuccin theme loaded: base=${i}, accent=${n}, text=${r}`),!0;console.log(`\u{1F3A8} [StarryNight] Waiting for Catppuccin theme... (base=${i}, accent=${n})`)}catch{}await new Promise(e=>setTimeout(e,200))}return console.warn(`\u{1F3A8} [StarryNight] Catppuccin theme not fully loaded after ${c}ms - proceeding with fallbacks`),!1}function Cl(){let c=globalThis;if(c.__STARLIGHT_REACT_SHIM__)return;let t=e=>{if(e==="react")return c.Spicetify?.React;if(e==="react-dom")return c.Spicetify?.ReactDOM;throw new Error(`[StarryNight shim] Module '${e}' not available`)};if(typeof c.require=="function"){let e=c.require.bind(c);c.require=i=>i==="react"||i==="react-dom"?t(i):e(i)}else c.require=t;c.__STARLIGHT_REACT_SHIM__=!0}Cl();(async function(){let t=Date.now();if(console.log("\u{1F31F} [Catppuccin StarryNight] Theme entry point starting..."),await Ys(1e4)?console.log("\u2705 [StarryNight] Spicetify platform fully ready"):(console.error("\u274C [StarryNight] CRITICAL: Spicetify not fully ready after 10s \u2013 proceeding with degraded visual-only mode."),console.error("\u274C [StarryNight] Available Spicetify objects:",{Spicetify:!!window.Spicetify,showNotification:!!window.Spicetify?.showNotification,Platform:!!window.Spicetify?.Platform})),await vl(8e3))console.log("\u2705 [StarryNight] Catppuccin theme fully loaded");else{console.error("\u274C [StarryNight] CRITICAL: Catppuccin theme not fully loaded after 8s \u2013 may experience color issues");let h=getComputedStyle(document.documentElement);console.error("\u274C [StarryNight] Current CSS variables:",{base:h.getPropertyValue("--spice-base").trim(),accent:h.getPropertyValue("--spice-accent").trim(),text:h.getPropertyValue("--spice-text").trim()})}let n={player:await Ut("Spicetify.Player",3e3),platform:await Ut("Spicetify.Platform",3e3),menu:await Ut("Spicetify.Menu",2e3),react:await Ut("Spicetify.React",2e3),reactDOM:await Ut("Spicetify.ReactDOM",2e3)},r=[".main-viewContainer-scrollNode",".main-view-container__scroll-node-child",".main-view-container",".main-container","#main","[data-testid='main-container']"],a=null;for(let h of r)if(a=await Sl(h,1e3),a){console.log(`\u2705 [StarryNight] Found main container using selector: ${h}`);break}a?console.log("\u2705 [StarryNight] Enhanced UI features initialized with DOM container"):(console.warn("\u26A0\uFE0F [StarryNight] No suitable main container found - enhanced UI features disabled"),console.warn("\u26A0\uFE0F [StarryNight] Tried selectors:",r.join(", ")),console.warn("\u26A0\uFE0F [StarryNight] Core functionality (music sync, color extraction) will still work"));let o=!(n.player&&n.platform);o?(console.error("\u274C [StarryNight] DEGRADED MODE: Initializing with limited functionality due to missing APIs"),console.error("\u274C [StarryNight] API availability status:",{player:!!n.player,platform:!!n.platform,menu:!!n.menu,react:!!n.react,reactDOM:!!n.reactDOM,mainContainer:!!a+" (optional)"}),console.error("\u274C [StarryNight] DEGRADED MODE limitations:"),console.error("  - Music synchronization disabled"),console.error("  - Advanced visual effects may not function"),console.error("  - UI integration features disabled"),console.error("  - Color extraction from album art disabled")):console.log("\u2705 [StarryNight] FULL MODE: All required APIs available - initializing complete functionality"),!0&&(w.enableDebug=!0,Promise.resolve().then(()=>(Js(),Zs)).then(h=>{h.enableDragCartography?.(),window.getDragMap=h.getDragMap}));let m=new Lt(w);try{if(o)await m.initializeWithAvailableAPIs({player:n.player,platform:n.platform,config:window.Spicetify?.Config,degradedMode:!0}),console.log("\u{1F31F} [StarryNight] Initialized in degraded mode - visual systems only"),Ml(m,n);else{await m.initializeAllSystems(),m.setupMusicAnalysisAndColorExtraction(),console.log("\u{1F31F} [StarryNight] Full initialization complete");try{Xs(m),js(m),Promise.resolve().then(()=>(ao(),ro)).then(h=>h.enableEnhancedDragPreview?.()),Promise.resolve().then(()=>(ho(),mo)).then(h=>h.enableQuickAddRadialMenu?.()),a&&Promise.resolve().then(()=>(bo(),po)).then(h=>h.initializePrismaticScrollSheen?.()),console.log("\u{1F31F} [StarryNight] UI controllers initialized successfully")}catch(h){console.error("[StarryNight] UI controller initialization failed:",h)}}}catch(h){console.error("[StarryNight] System initialization failed:",h)}try{n.react&&n.reactDOM?(await(await Promise.resolve().then(()=>(Or(),Hr))).initializeStarryNightSettings?.(),console.log("\u{1F31F} [StarryNight] Spicetify native settings with Year3000System integration initialized")):console.warn("\u{1F31F} [StarryNight] React APIs not available - continuing with CSS-only theme")}catch(h){console.error("[StarryNight] Failed to initialize native settings:",h),console.warn("\u{1F31F} [StarryNight] Continuing with CSS-only theme (no settings UI)")}w.enableDebug&&(window.Y3K={system:m,music:m.musicSyncService,settings:m.settingsManager,debug:u.debug,health:m.systemHealthMonitor,mode:o?"degraded":"full",availableAPIs:n});try{let{RightSidebarConsciousnessSystem:h}=await Promise.resolve().then(()=>(Co(),vo)),{SidebarPerformanceCoordinator:p}=await Promise.resolve().then(()=>(Ei(),ls));if(m.performanceAnalyzer){let b=p.getInstance({enableDebug:w.enableDebug,performanceAnalyzer:m.performanceAnalyzer,onFlushComplete:()=>{m.performanceAnalyzer?.emitTrace?.("[SidebarPerformanceCoordinator] Flush completed")}});b.setupDOMObservation();let v=new h(w,I,m.performanceAnalyzer,m.musicSyncService,m.settingsManager,m,b);await v.initialize(),m.rightSidebarConsciousnessSystem=v,m.rightSidebarCoordinator=b}}catch(h){console.error("[StarryNight] Failed to initialize RightSidebarConsciousnessSystem",h)}try{let{DepthConsciousnessController:h}=await Promise.resolve().then(()=>(wo(),Mo)),p=new h(w,I,m.performanceAnalyzer,m.musicSyncService,m.settingsManager);await p.initialize(),m.depthConsciousnessController=p,console.log("\u{1F30A} [StarryNight] Depth Consciousness Controller awakened")}catch(h){console.error("[StarryNight] Failed to initialize DepthConsciousnessController",h)}try{let{DynamicCatppuccinBridge:h}=await Promise.resolve().then(()=>(Po(),Eo)),p=new h(w,I,m.performanceAnalyzer,m.musicSyncService,m.settingsManager);await p.initialize(),m.colorHarmonyEngine&&p.linkWithColorHarmonyEngine(m.colorHarmonyEngine),m.depthConsciousnessController&&p.linkWithDepthConsciousness(m.depthConsciousnessController),m.dynamicCatppuccinBridge=p,console.log("\u{1F3A8} [StarryNight] Dynamic Catppuccin Bridge connected")}catch(h){console.error("[StarryNight] Failed to initialize DynamicCatppuccinBridge",h)}try{let{LivingGradientStrategy:h}=await Promise.resolve().then(()=>(In(),ka)),p=new h(w,I,m.performanceAnalyzer,m.musicSyncService,m.settingsManager);await p.initialize(),m.dynamicCatppuccinBridge&&console.log("\u{1F30A} [StarryNight] Consolidated Living Gradient System linked with Dynamic Catppuccin Bridge"),m.depthConsciousnessController&&console.log("\u{1F30A} [StarryNight] Consolidated Living Gradient System linked with Depth Consciousness"),m.livingGradientSystem=p,m.livingGradientStrategy=p,console.log("\u{1F30A} [StarryNight] Consolidated Living Gradient Strategy System awakened - unified color processing and visual system lifecycle with performance optimizations")}catch(h){console.error("[StarryNight] Failed to initialize Consolidated Living Gradient Strategy System",h)}try{let{CDFVariableBridge:h}=await Promise.resolve().then(()=>(xo(),To));m.cssConsciousnessController&&new h(m.cssConsciousnessController)}catch(h){console.error("[StarryNight] Failed to initialize CDFVariableBridge",h)}let d=Date.now()-t;console.log(`\u{1F30C} Catppuccin StarryNight Theme initialized in ${d}ms (${o?"degraded":"full"} mode). Welcome to the future of sound!`)})();function Ml(c,t){console.log("\u{1F504} [StarryNight] Setting up progressive enhancement monitoring...");let e=0,i=30,n=1e4,r=()=>{e++;let o={player:window.Spicetify?.Player,platform:window.Spicetify?.Platform,menu:window.Spicetify?.Menu,react:window.Spicetify?.React,reactDOM:window.Spicetify?.ReactDOM};if(o.player&&o.platform){console.log("\u2705 [StarryNight] Required APIs now available - upgrading to full mode!"),clearInterval(a),wl(c,o).then(()=>{console.log("\u{1F31F} [StarryNight] Successfully upgraded from degraded mode to full mode!"),window.Y3K&&(window.Y3K.mode="full",window.Y3K.availableAPIs=o)}).catch(m=>{console.error("\u274C [StarryNight] Failed to upgrade to full mode:",m)});return}if(e>=i){console.log(`\u23F0 [StarryNight] Progressive enhancement monitoring ended after ${e} attempts (${e*n/1e3}s)`),clearInterval(a);return}e%5===0&&(console.log(`\u{1F504} [StarryNight] Still monitoring for API availability... (attempt ${e}/${i})`),console.log("\u{1F504} [StarryNight] Current API status:",{player:!!o.player,platform:!!o.platform,menu:!!o.menu,react:!!o.react,reactDOM:!!o.reactDOM}))},a=setInterval(r,n),s=()=>{console.log("\u{1F3B5} [StarryNight] Spicetify ready event detected - checking for upgrade..."),r()};window.Spicetify&&window.Spicetify.Player&&window.Spicetify.Player.addEventListener?.("songchange",s),setTimeout(()=>{window.Spicetify?.Player&&window.Spicetify.Player.removeEventListener?.("songchange",s)},i*n)}async function wl(c,t){try{if(console.log("\u{1F680} [StarryNight] Beginning upgrade to full mode..."),!c)throw new Error("Year3000System instance not available");if(typeof c.upgradeToFullMode=="function")console.log("\u{1F527} [StarryNight] Using system's built-in upgrade method..."),await c.upgradeToFullMode({player:t.player,platform:t.platform,config:window.Spicetify?.Config,degradedMode:!1});else if(console.log("\u{1F527} [StarryNight] System upgrade method not available - attempting manual initialization..."),c.setupMusicAnalysisAndColorExtraction&&(console.log("\u{1F3B5} [StarryNight] Setting up music analysis and color extraction..."),await c.setupMusicAnalysisAndColorExtraction()),t.react&&t.reactDOM)try{console.log("\u2699\uFE0F [StarryNight] Initializing settings UI..."),await(await Promise.resolve().then(()=>(Or(),Hr))).initializeStarryNightSettings?.(),console.log("\u2705 [StarryNight] Settings UI initialized successfully")}catch(e){console.warn("\u26A0\uFE0F [StarryNight] Failed to initialize settings UI during upgrade:",e)}c.eventBus?.emitSync&&c.eventBus.emitSync("system:upgraded-to-full-mode",{timestamp:Date.now(),availableAPIs:{player:!!t.player,platform:!!t.platform,menu:!!t.menu,react:!!t.react,reactDOM:!!t.reactDOM}}),console.log("\u{1F31F} [StarryNight] Upgrade to full mode completed successfully!")}catch(e){throw console.error("\u274C [StarryNight] Upgrade to full mode failed:",e),e}}})();
